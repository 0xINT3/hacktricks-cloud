# 基本的なGithub情報

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出してください** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGithubリポジトリに

</details>

## 基本的な構造

大きな**企業**の基本的なGithub環境構造は、**エンタープライズ**が**複数の組織**を所有し、それぞれには**複数のリポジトリ**と**複数のチーム**が含まれることです。小規模な企業は、**1つの組織を所有せずに**済む場合もあります。

ユーザーの視点から見ると、**ユーザー**は**異なるエンタープライズと組織のメンバー**になることができます。それらの中で、ユーザーは**異なるエンタープライズ、組織、リポジトリの役割**を持つことができます。

さらに、ユーザーは**異なるチームの一員**となることができます。それぞれのチームには、エンタープライズ、組織、またはリポジトリの役割が異なる場合があります。

そして最後に、**リポジトリには特別な保護メカニズムが存在する**場合があります。

## 特権

### エンタープライズの役割

* **エンタープライズオーナー**: この役割を持つ人は、**管理者を管理し、エンタープライズ内の組織を管理し、エンタープライズの設定を管理し、組織全体にポリシーを適用**することができます。ただし、**組織の設定やコンテンツには直接アクセスできません**。組織のオーナーになるか、組織が所有するリポジトリへの直接アクセスが与えられない限り、アクセスすることはできません。
* **エンタープライズメンバー**: エンタープライズが所有する組織のメンバーは、**自動的にエンタープライズのメンバー**にもなります。

### 組織の役割

組織では、ユーザーにはさまざまな役割があります。

* **組織オーナー**: 組織オーナーは、**組織に完全な管理アクセス**を持っています。この役割は、組織内の少なくとも2人に制限されるべきです。
* **組織メンバー**: 組織の**デフォルトの非管理役割**は、組織メンバーです。デフォルトでは、組織メンバーには**いくつかの権限**があります。
* **請求管理者**: 請求管理者は、組織の**請求設定を管理**できるユーザーです。
* **セキュリティマネージャー**: これは組織のオーナーが組織内の任意のチームに割り当てることができる役割です。適用されると、チームのすべてのメンバーには、組織全体のセキュリティアラートと設定を**管理する権限**が与えられます。また、組織内のすべてのリポジトリに対する**読み取り権限**も与えられます。
* 組織にセキュリティチームがある場合、セキュリティマネージャーの役割を使用して、チームのメンバーに組織への必要最小限のアクセス権限を与えることができます。
* **Github Appマネージャー**: オーナーは、組織が所有するGitHub Appを**管理するための追加のユーザー**にGitHub Appマネージャーの権限を付与することができます。
* **外部コラボレーター**: 外部コラボレーターは、**1つ以上の組織のリポジトリにアクセス権限を持つが、明示的に組織のメンバーではない**人物です。

これらの役割の**権限を比較**することができるテーブルは、[https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles](https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles)にあります。

### メンバーの特権

_https://github.com/organizations/\<org\_name>/settings/member\_privileges_では、**組織のメンバーが組織の一員であるだけで持つ権限**を確認することができます。

ここで設定された設定によって、組織のメンバーの以下の権限が示されます:

* 組織のすべてのリポジトリに対する管理者、ライター、リーダー、または権限なし
* メンバーがプライベート、内部、またはパブリックリポジトリを作成できるかどうか
* リポジトリのフォークが可能かどうか
* 外部コラボレーターを招待できるかどうか
* パブリックまたはプライベートサイトを公開できるかどうか
* 管理者がリポジトリに対して持つ権限
* メンバーが新しいチームを作成できるかどうか

### リポジトリの役割

デフォルトでは、リポジトリの役割は次のように作成されます:

* **Read**: プロジェクトを表示または議論するための**非コード貢献者**に推奨されます
* **Triage**: 書き込みアクセス権限なしで**積極的に問題やプルリクエストを管理**する必要がある**コントリビューター**に推奨されます
* **Write**: プロジェクトに**積極的にプッシュ**する**コントリビューター**に推奨されます
* **Maintain**: **機密情報や破壊的なアクションへのアクセスなし**で**リポジトリを管理**する必要がある**プロジェクトマネージャー**に推奨されます
* **Admin**: **セキュリティの管理やリポジトリの削除などの機密情報や破壊的なアクション**を含む、**プロジェクトへの完全なアクセス**が必要な人に推奨されます

各役割の**権限を比較**することができるテーブルは、[https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role](https
#### **GPGキー**

これらのキーでユーザーをなりすますことはできませんが、使用しない場合は署名なしでコミットを送信することが可能であるため、発見される可能性があります。[ここで](https://docs.github.com/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits#about-vigilant-mode)、詳細な情報を確認してください。

### **パーソナルアクセストークン**

パーソナルアクセストークンを生成することで、アプリケーションにアカウントへのアクセス権限を与えることができます。パーソナルアクセストークンを作成する際には、ユーザーはトークンに与える権限を指定する必要があります。[https://github.com/settings/tokens](https://github.com/settings/tokens)

### Oauthアプリケーション

Oauthアプリケーションは、一部のGitHub情報にアクセスしたり、ユーザーをなりすますためにパーミッションを要求する場合があります。一般的な例としては、一部のプラットフォームで見つけることができる「GitHubでログイン」ボタンがあります。

* [https://github.com/settings/developers](https://github.com/settings/developers)で独自のOauthアプリケーションを作成できます。
* [https://github.com/settings/applications](https://github.com/settings/applications)でアカウントにアクセスできるOauthアプリケーションを確認できます。
* [https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)でOauthアプリケーションが要求できるスコープを確認できます。
* _https://github.com/organizations/\<org\_name>/settings/oauth\_application\_policy_で組織のサードパーティアクセスを確認できます。

いくつかのセキュリティの推奨事項:

* OAuthアプリケーションは常にGitHubの認証済みユーザーとして動作するべきです（たとえば、ユーザー通知を提供する場合など）し、指定されたスコープにのみアクセス権限を持つべきです。
* OAuthアプリケーションは、認証済みユーザーの「GitHubでログイン」を有効にすることで、アイデンティティプロバイダーとして使用することができます。
* アプリケーションが単一のリポジトリで動作する場合は、OAuthアプリケーションを作成しないでください。`repo` OAuthスコープを使用すると、OAuthアプリケーションは認証済みユーザーのすべてのリポジトリで動作することができます。
* チームや会社のアプリケーションとしてOAuthアプリケーションを作成しないでください。OAuthアプリケーションは単一のユーザーとして認証されるため、会社が使用するために1人がOAuthアプリケーションを作成し、その後その人が会社を去ると、他の誰もそれにアクセスできなくなります。
* [こちら](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-oauth-apps)で詳細を確認してください。

### Githubアプリケーション

Githubアプリケーションは、特定のリソース上で特定のアクションを実行するために、GitHub情報へのアクセスやユーザーのなりすましの許可を要求する場合があります。Githubアプリケーションでは、アプリがアクセスするリポジトリを指定する必要があります。

* GitHubアプリをインストールするには、組織のオーナーであるか、リポジトリで管理者権限を持っている必要があります。
* GitHubアプリは、個人アカウントまたは組織に接続する必要があります。
* [https://github.com/settings/apps](https://github.com/settings/apps)で独自のGithubアプリケーションを作成できます。
* [https://github.com/settings/apps/authorizations](https://github.com/settings/apps/authorizations)でアカウントにアクセスできるGithubアプリケーションを確認できます。
* これらは[GithubアプリケーションのAPIエンドポイント](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)です。アプリの権限に応じて、いくつかのエンドポイントにアクセスできます。
* _https://github.com/organizations/\<org\_name>/settings/installations_で組織内のインストール済みアプリを確認できます。

いくつかのセキュリティの推奨事項:

* GitHubアプリは、ユーザーに依存せずにアクションを実行するべきです（[ユーザーからサーバーへのリクエスト](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps#user-to-server-requests)トークンを使用している場合を除く）。ユーザーからサーバーへのアクセストークンをより安全に保つために、8時間後に期限切れになるアクセストークンと、新しいアクセストークンと交換できるリフレッシュトークンを使用することができます。詳細については、「[ユーザーからサーバーへのアクセストークンの更新](https://docs.github.com/en/apps/building-github-apps/refreshing-user-to-server-access-tokens)」を参照してください。
* GitHubアプリが特定のリポジトリと統合することを確認してください。
* GitHubアプリは、個人アカウントまたは組織に接続する必要があります。
* GitHubアプリに、ユーザーができることをすべて知っていて行うことを期待しないでください。
* 単に「GitHubでログイン」サービスが必要な場合は、GitHubアプリを使用しないでください。ただし、GitHubアプリは、ユーザー識別フローを使用してユーザーをログインさせることができ、他のことも行うことができます。
* GitHubユーザーとして動作し、ユーザーが行えるすべてのことを行いたい場合は、GitHubアプリを作成しないでください。
* アプリをGitHub Actionsと共に使用し、ワークフローファイルを変更する場合は、`workflow`スコープを含むOAuthトークンを使用してユーザーを代理して認証する必要があります。ユーザーは、ワークフローファイルを含むリポジトリに対して管理者または書き込み権限を持っている必要があります。詳細については、「[OAuthアプリのスコープの理解](https://docs.github.com/en/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/#available-scopes)」を参照してください。
* [こちら](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-github-apps)で詳細を確認してください。

### Github Actions

これはGitHubで認証する方法ではありませんが、悪意のあるGithub ActionはGitHubへの不正なアクセスを取得し、アクションに与えられた特権に応じてさまざまな攻撃を行うことができます。詳細は以下を参照してください。

## Git Actions

Git Actionsは、イベントが発生したときにコードの実行を自動化することができます。通常、実行されるコードはリポジトリのコードに関連しています（たとえば、DockerコンテナのビルドやPRにシークレットが含まれていないかのチェックなど）。

### 設定

_https://github.com/organizations/\<org\_name>/settings/actions_では、組織のGithub Actionsの設定を確認することができます。

Github Actionsの使用を完全に
### Gitの秘密情報

Githubアクションでは、通常、Githubやサードパーティのアプリケーションとのやり取りに秘密情報が必要です。これらの秘密情報をリポジトリ内で**平文で公開することを避けるために**、Githubでは**Secrets**として設定することができます。

これらの秘密情報は、**リポジトリまたは組織全体**に対して設定することができます。その後、**アクションが秘密情報にアクセスできるようにするために**、次のように宣言する必要があります：
```yaml
steps:
- name: Hello world action
with: # Set the secret as an input
super_secret: ${{ secrets.SuperSecret }}
env: # Or as an environment variable
super_secret: ${{ secrets.SuperSecret }}
```
#### Bashを使用した例 <a href="#example-using-bash" id="example-using-bash"></a>
```yaml
steps:
- shell: bash
env:
SUPER_SECRET: ${{ secrets.SuperSecret }}
run: |
example-command "$SUPER_SECRET"
```
{% hint style="warning" %}
シークレットは、それらが宣言されているGithub Actionsからのみアクセスできます。

リポジトリまたは組織で構成された後、githubのユーザーはそれらに再度アクセスすることはできませんが、それらを変更することはできます。
{% endhint %}

したがって、**Githubシークレットを盗む唯一の方法は、Githubアクションを実行しているマシンにアクセスできることです**（このシナリオでは、アクションのために宣言されたシークレットにのみアクセスできます）。

### Git環境

Githubでは、**環境**を作成してシークレットを保存することができます。その後、次のような方法で環境内のシークレットにGithubアクションへのアクセス権を与えることができます：
```yaml
jobs:
deployment:
runs-on: ubuntu-latest
environment: env_name
```
環境を**アクセス可能**にするように設定することができます。**すべてのブランチ**（デフォルト）、**保護されたブランチのみ**、または**特定のブランチ**がアクセスできるようにすることもできます。\
また、**アクション**を実行する前に必要なレビューの**数を設定**したり、デプロイを許可するまでの**時間を待機**することもできます。

### Git Action Runner

Github Actionは、Github環境内で実行されるか、ユーザーが設定した**サードパーティのインフラストラクチャ**で実行されることがあります。

多くの組織では、Github Actionを**サードパーティのインフラストラクチャ**で実行することができるため、**コストを抑える**ことができます。

組織の**セルフホストランナー**は、_https://github.com/organizations/\<org\_name>/settings/actions/runners_で確認することができます。

**Github Actionsが非Githubインフラストラクチャで実行されているかどうか**を確認する方法は、Github Actionの設定yamlで`runs-on: self-hosted`を検索することです。

異なる組織の**Github Actionを異なる組織のセルフホストボックスで実行することはできません**。なぜなら、ランナーがどの組織に所属しているかを知るために、ランナーの設定時に**一意のトークンが生成**されるからです。

カスタムの**Github RunnerがAWSやGCPのマシンに設定されている場合**、アクションはメタデータエンドポイントにアクセスでき、マシンで実行されているサービスアカウントのトークンを**盗む**ことができます。

### Git Actionの侵害

すべてのアクション（または悪意のあるアクション）が許可されている場合、ユーザーは**悪意のあるGithubアクション**を使用して、実行されている**コンテナ**を**侵害**することができます。

{% hint style="danger" %}
攻撃者は、**悪意のあるGithubアクション**を**悪用**して次のことができます：

* アクションがアクセスできる**すべてのシークレットを盗む**
* アクションが**サードパーティのインフラストラクチャ**で実行されている場合、マシンで実行されるSAトークンにアクセスできるため、**横方向に移動**することができる（おそらくメタデータサービスを介して）
* **ワークフロー**で使用されるトークンを**悪用**して、アクションが実行されているリポジトリのコードを**盗む**か、**変更**することさえできる。
{% endhint %}

## ブランチの保護

ブランチの保護は、ユーザーにリポジトリの**完全な制御権限を与えない**ように設計されています。目的は、**一部のブランチにコードを書く前にいくつかの保護手法を設ける**ことです。

リポジトリの**ブランチの保護**は、_https://github.com/\<orgname>/\<reponame>/settings/branches_で見つけることができます。

{% hint style="info" %}
**組織レベルでブランチの保護を設定することはできません**。したがって、それらはすべてのリポジトリで宣言する必要があります。
{% endhint %}

ブランチにはさまざまな保護が適用できます（たとえば、マスターに対して）：

* **マージする前にPRを要求**することができます（つまり、直接ブランチにコードをマージすることはできません）。これが選択された場合、他のさまざまな保護が適用される場合があります：
* **承認の数を要求**することができます。通常、PRを承認するために1人または2人以上の人の承認が必要です。単一のユーザーが直接コードをマージすることはできません。
* **新しいコミットがプッシュされた場合に承認を無効にする**ことができます。そうでない場合、ユーザーは正当なコードを承認し、その後に悪意のあるコードを追加してマージすることができます。
* **コード所有者からのレビューを要求**することができます。リポジトリの少なくとも1人のコード所有者がPRを承認する必要があります（「ランダム」なユーザーは承認できません）。
* **プルリクエストレビューを解除できる人を制限**することができます。プルリクエストレビューを解除できる人またはチームを指定することができます。
* **指定されたアクターがプルリクエストの要件をバイパスできるようにする**ことができます。これらのユーザーは前の制限をバイパスできます。
* **マージする前にステータスチェックをパスする必要がある**ことがあります。コミットをマージする前にいくつかのチェックがパスする必要があります（たとえば、クリアテキストのシークレットがないことをチェックするGithubアクションなど）。
* **マージする前に会話の解決を要求**することがあります。PRをマージする前に、コードに関するすべてのコメントを解決する必要があります。
* **署名されたコミットを要求**することができます。コミットは署名されている必要があります。
* **線形な履歴を要求**します。マージコミットが一致するブランチにプッシュされないようにします。
* **管理者を含める**ことができます。これが設定されていない場合、管理者は制限をバイパスできます。
* **一致するブランチにプッシュできる人を制限**することができます。プルリクエストを送信できる人を制限できます。

{% hint style="info" %}
見てわかるように、ユーザーの一部の資格情報を入手できたとしても、CI/CDパイプラインを侵害するためにマスターにコードをプッシュすることを防ぐために、**リポジトリは保護されている**場合があります。
{% endhint %}

## 参考文献

* [https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization)
* [https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)[https://docs.github.com/en/enterprise-server](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)
* [https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github](https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github)
* [https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards)
* [https://docs.github.com/en/actions/security-guides/encrypted-secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
