# 基本的Github信息

<details>

<summary><strong>支持HackTricks并获得好处！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks衣物**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>

## 基本结构

大型**公司**的基本Github环境结构是拥有一个**企业**，该企业拥有**多个组织**，每个组织可能包含**多个仓库**和**多个团队**。较小的公司可能只拥有一个组织而没有企业。

从用户的角度来看，**用户**可以是**不同企业和组织的成员**。在其中，用户可以拥有**不同的企业、组织和仓库角色**。

此外，用户可能是**不同团队的一部分**，具有不同的企业、组织或仓库角色。

最后，**仓库可能具有特殊的保护机制**。

## 权限

### 企业角色

* **企业所有者**：拥有此角色的人可以**管理管理员、管理企业内的组织、管理企业设置、在组织间强制执行策略**。但是，除非他们成为组织所有者或直接获得对组织拥有的仓库的访问权限，否则他们**无法访问组织设置或内容**。
* **企业成员**：您企业拥有的组织的成员也是**自动成为企业的成员**。

### 组织角色

在组织中，用户可以拥有不同的角色：

* **组织所有者**：组织所有者对您的组织拥有**完全的管理访问权限**。这个角色应该在您的组织中限制，但至少应有两个人。
* **组织成员**：**非管理员角色**的**组织成员**是组织中的默认角色。默认情况下，组织成员**具有多个权限**。
* **财务经理**：财务经理是可以**管理组织的财务设置**（如付款信息）的用户。
* **安全经理**：这是组织所有者可以分配给组织中的任何团队的角色。应用此角色后，团队的每个成员都具有**管理组织中的安全警报和设置的权限**，以及对组织中所有仓库的读取权限。
* 如果您的组织有一个安全团队，您可以使用安全经理角色为团队成员提供他们需要的最低访问权限。
* **Github应用程序管理员**：为了允许其他用户**管理组织拥有的GitHub应用程序**，所有者可以授予他们GitHub应用程序管理员权限。
* **外部合作者**：外部合作者是指**可以访问一个或多个组织仓库但不是组织成员**的人。

您可以在此表中**比较这些角色的权限**：[https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles](https://docs.github.com/en/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization#permissions-for-organization-roles)

### 成员权限

在_https://github.com/organizations/\<org\_name>/settings/member\_privileges_中，您可以查看**组织成员仅因为是组织成员而拥有的权限**。

在此处配置的设置将指示组织成员的以下权限：

* 对组织中所有仓库的管理者、编写者、读者或无权限。
* 成员是否可以创建私有、内部或公共仓库。
* 是否可以fork仓库。
* 是否可以邀请外部合作者。
* 是否可以发布公共或私有站点。
* 管理员对仓库的权限。
* 成员是否可以创建新团队。

### 仓库角色

默认情况下，创建以下仓库角色：

* **读取**：推荐给希望查看或讨论项目的**非代码贡献者**。
* **处理**：推荐给**需要主动管理问题和拉取请求**但没有写入权限的贡献者。
* **编写**：推荐给**积极推动项目的贡献者**。
* **维护**：推荐给**需要管理仓库但无权访问敏感或破坏性操作的项目经理**。
* **管理**：推荐给需要**完全访问项目**（包括管理安全或删除仓库等敏感和破坏性操作）的人。

您可以在此表中**比较每个角色的权限**：[https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization#permissions-for-each-role)

您还可以在_https://github.com/organizations/\<org\_name>/settings/roles_中**创建自己的角色**。

### 团队

您可以在_https://github.com/orgs/\<org\_name>/teams_中**列出组织中创建的团队**。请注意，要查看作为其他团队子级的团队，您需要访问每个父级团队。

### 用户

组织的用户可以在_https://github.com/orgs/\<org\_name>/people_中**列出**。

在每个用户的信息中，您可以看到用户是**团队的成员**，以及用户可以访问的**仓库**。

## Github身份验证

Github提供了不同的身份验证方式，以便您登录到您的帐户并代表您执行操作。

### 网页访问

访问**github.com**，您可以使用您的**用户名和密码**（以及可能的**2FA**）登录。

### **SSH密钥**

您可以配置您的帐户使用一个或多个公钥，允许相关的**私钥代表您执行操作**。[https://github.com/settings/keys](https://github.com/settings/keys)
#### **GPG 密钥**

使用这些密钥**无法冒充用户**，但如果不使用它，可能会**发现发送未签名提交**。了解有关[vigilant模式的更多信息](https://docs.github.com/en/authentication/managing-commit-signature-verification/displaying-verification-statuses-for-all-of-your-commits#about-vigilant-mode)。

### **个人访问令牌**

您可以生成个人访问令牌，以**授予应用程序访问您的帐户的权限**。创建个人访问令牌时，**用户**需要**指定**令牌将具有的**权限**。[https://github.com/settings/tokens](https://github.com/settings/tokens)

### Oauth 应用程序

Oauth 应用程序可能会要求您授予其**访问部分 GitHub 信息或冒充您**以执行某些操作的权限。一个常见的例子是您可能在某些平台上找到的**使用 GitHub 登录按钮**。

* 您可以在[https://github.com/settings/developers](https://github.com/settings/developers)上**创建**自己的**Oauth 应用程序**。
* 您可以在[https://github.com/settings/applications](https://github.com/settings/applications)上查看**访问您的帐户的 Oauth 应用程序**。
* 您可以在[https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)上查看**Oauth 应用程序可以请求的范围**。
* 您可以在_https://github.com/organizations/\<org\_name>/settings/oauth\_application\_policy_上查看**组织中应用程序的第三方访问**。

一些**安全建议**：

* **OAuth 应用程序**应始终**作为经过身份验证的 GitHub 用户在 GitHub 上执行所有操作**（例如，提供用户通知），并且只能访问指定的范围。
* 通过启用“使用 GitHub 登录”为经过身份验证的用户，OAuth 应用程序可以用作身份提供者。
* 如果您希望应用程序仅对**单个存储库**进行操作，请**不要**构建**OAuth 应用程序**。使用`repo` OAuth 范围，OAuth 应用程序可以**对经过身份验证的用户的所有存储库**进行操作。
* 请勿构建 OAuth 应用程序作为团队或公司的应用程序。OAuth 应用程序作为**单个用户**进行身份验证，因此如果有人为公司创建了 OAuth 应用程序并使用它，然后离开公司，其他人将无法访问该应用程序。
* **更多信息**请参见[此处](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-oauth-apps)。

### Github 应用程序

Github 应用程序可以请求权限**访问您的 GitHub 信息或冒充您**以执行特定资源上的特定操作。在 Github 应用程序中，您需要指定应用程序将访问的存储库。

* 要安装 GitHub 应用程序，您必须是**组织所有者或具有存储库的管理员权限**。
* GitHub 应用程序应**连接到个人帐户或组织**。
* 您可以在[https://github.com/settings/apps](https://github.com/settings/apps)上创建自己的 Github 应用程序。
* 您可以在[https://github.com/settings/apps/authorizations](https://github.com/settings/apps/authorizations)上查看**访问您的帐户的 Github 应用程序**。
* 这些是[GitHub 应用程序的 API 端点](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)。根据应用程序的权限，它将能够访问其中的一些端点。
* 您可以在_https://github.com/organizations/\<org\_name>/settings/installations_上查看组织中安装的应用程序。

一些安全建议：

* GitHub 应用程序应**独立于用户采取行动**（除非应用程序使用[user-to-server](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps#user-to-server-requests)令牌）。为了使 user-to-server 访问令牌更安全，您可以使用在 8 小时后过期的访问令牌和可以交换为新访问令牌的刷新令牌。有关更多信息，请参见"[刷新 user-to-server 访问令牌](https://docs.github.com/en/apps/building-github-apps/refreshing-user-to-server-access-tokens)"。
* 确保 GitHub 应用程序与**特定存储库**集成。
* GitHub 应用程序应**连接到个人帐户或组织**。
* 不要期望 GitHub 应用程序了解并执行用户的所有操作。
* 如果您只需要“使用 GitHub 登录”服务，请**不要使用 GitHub 应用程序**。但是，GitHub 应用程序可以使用[user identification flow](https://docs.github.com/en/apps/building-github-apps/identifying-and-authorizing-users-for-github-apps)来登录用户并执行其他操作。
* 如果您只想作为 GitHub 用户并执行用户可以执行的所有操作，请**不要构建 GitHub 应用程序**。
* 如果您正在使用应用程序与 GitHub Actions 并且想要修改工作流文件，则必须代表具有包含`workflow`范围的 OAuth 令牌的用户进行身份验证。用户必须对包含工作流文件的存储库具有管理员或写入权限。有关更多信息，请参见"[了解 OAuth 应用程序的范围](https://docs.github.com/en/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/#available-scopes)"。
* **更多信息**请参见[此处](https://docs.github.com/en/developers/apps/getting-started-with-apps/about-apps#about-github-apps)。

### Github Actions

这**不是在 GitHub 进行身份验证的方法**，但是恶意的 Github Action 可以获取**未经授权的访问权限**并根据分配给该 Action 的**特权**执行多种**不同的攻击**。有关更多信息，请参见下文。

## Git Actions

Git Actions 允许在发生事件时自动执行代码。通常，执行的代码与存储库的代码**有关**（例如构建 Docker 容器或检查 PR 是否包含机密信息）。

### 配置

在_https://github.com/organizations/\<org\_name>/settings/actions_中，可以查看组织的**Github Actions 配置**。

可以完全禁止使用 Github Actions，**允许所有 Github Actions**，或仅允许某些操作。

还可以配置**谁需要批准运行 Github Action**以及运行时 Github Action 的 GITHUB\_TOKEN 的**权限**。
### Git Secrets

Github Action通常需要一些秘密来与github或第三方应用程序进行交互。为了**避免将它们以明文形式放在存储库中**，github允许将它们作为**秘密**存储。

这些秘密可以为**存储库或整个组织**配置。然后，为了使**Action能够访问秘密**，您需要像这样声明它：
```yaml
steps:
- name: Hello world action
with: # Set the secret as an input
super_secret: ${{ secrets.SuperSecret }}
env: # Or as an environment variable
super_secret: ${{ secrets.SuperSecret }}
```
#### 使用Bash的示例 <a href="#example-using-bash" id="example-using-bash"></a>
```yaml
steps:
- shell: bash
env:
SUPER_SECRET: ${{ secrets.SuperSecret }}
run: |
example-command "$SUPER_SECRET"
```
{% hint style="warning" %}
只有在声明了的 Github Actions 中才能访问**secrets**。

一旦在仓库或组织中配置好，**github 用户将无法再次访问它们**，他们只能**更改它们**。
{% endhint %}

因此，**窃取 github secrets 的唯一方法是能够访问执行 Github Action 的机器**（在这种情况下，您只能访问为该 Action 声明的 secrets）。

### Git 环境

Github 允许创建**环境**，您可以在其中保存**secrets**。然后，您可以通过类似以下方式，使 github action 可以访问环境中的 secrets：
```yaml
jobs:
deployment:
runs-on: ubuntu-latest
environment: env_name
```
您可以配置一个环境，使其可以被所有分支（默认）、仅受保护的分支或指定的分支访问。\
还可以设置在执行操作之前需要进行一定数量的审查，或者在允许部署之前等待一段时间。

### Git Action Runner

Github Action可以在github环境中执行，也可以在用户配置的第三方基础设施中执行。

许多组织允许在第三方基础设施中运行Github Actions，因为这样更便宜。

您可以在_https://github.com/organizations/<org_name>/settings/actions/runners_中列出组织的自托管运行程序。

查找在非github基础设施中执行的Github Actions的方法是在Github Action配置yaml中搜索`runs-on: self-hosted`。

不可能在不同组织的自托管框中运行组织的Github Action，因为在配置时为Runner生成了唯一的令牌，以确定Runner所属的位置。

如果自定义的Github Runner配置在AWS或GCP中的机器上，该Action可能可以访问元数据端点并窃取机器正在运行的服务帐户的令牌。

### Git Action Compromise

如果允许所有操作（或恶意操作），用户可以使用一个恶意的Github Action来危害其正在执行的容器。

{% hint style="danger" %}
攻击者可以滥用恶意的Github Action来：

* 窃取Action可以访问的所有机密信息
* 如果Action在可以访问机器上运行的第三方基础设施中执行，则可以横向移动（可能通过元数据服务）
* 滥用工作流使用的令牌来窃取执行Action的仓库的代码，甚至修改代码。
{% endhint %}

## 分支保护

分支保护旨在不将对存储库的完全控制权交给用户。目标是在能够在某些分支中编写代码之前设置多种保护方法。

可以在_https://github.com/<orgname>/<reponame>/settings/branches_中找到存储库的分支保护设置。

{% hint style="info" %}
不可能在组织级别设置分支保护。因此，所有分支保护都必须在每个存储库中声明。
{% endhint %}

可以对分支应用不同的保护（例如对主分支）：

* 可以要求在合并之前进行PR（因此无法直接将代码合并到分支中）。如果选择此选项，可以设置其他不同的保护措施：
* 要求一定数量的批准。通常要求1或2个人批准您的PR，以便单个用户无法直接合并代码。
* 推送新提交时取消批准。如果不取消批准，用户可能会批准合法代码，然后用户可以添加恶意代码并合并它。
* 要求代码所有者进行审查。至少需要一个代码所有者批准PR（因此“随机”用户无法批准）。
* 限制可以取消拉取请求审查的人。可以指定允许取消拉取请求审查的人或团队。
* 允许指定的参与者绕过拉取请求要求。这些用户将能够绕过先前的限制。
* 要求在合并之前通过状态检查。在能够合并提交之前，需要通过一些检查（例如检查是否存在明文密码）。
* 要求在合并之前解决对话。必须解决代码上的所有评论，然后才能合并PR。
* 要求签名提交。提交必须经过签名。
* 要求线性历史。防止将合并提交推送到匹配的分支。
* 包括管理员。如果未设置此项，管理员可以绕过限制。
* 限制可以推送到匹配分支的人。限制可以发送PR的人。

{% hint style="info" %}
正如您所看到的，即使您成功获取了某个用户的某些凭据，也可能会受到保护，无法将代码直接推送到主分支等，以危害CI/CD流水线。
{% endhint %}

## 参考资料

* [https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization](https://docs.github.com/en/organizations/managing-access-to-your-organizations-repositories/repository-roles-for-an-organization)
* [https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)[https://docs.github.com/en/enterprise-server](https://docs.github.com/en/enterprise-server@3.3/admin/user-management/managing-users-in-your-enterprise/roles-in-an-enterprise)
* [https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github](https://docs.github.com/en/get-started/learning-about-github/access-permissions-on-github)
* [https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards](https://docs.github.com/en/account-and-profile/setting-up-and-managing-your-github-user-account/managing-user-account-settings/permission-levels-for-user-owned-project-boards)
* [https://docs.github.com/en/actions/security-guides/encrypted-secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
