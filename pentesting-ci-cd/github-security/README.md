# Github安全

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>

## 什么是Github

（来自[这里](https://kinsta.com/knowledgebase/what-is-github/)）从高层次上讲，**GitHub是一个帮助开发人员存储和管理代码，并跟踪和控制代码更改的网站和基于云的服务**。

### 基本信息

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 外部侦察

Github仓库可以配置为公开、私有和内部。

* **私有**表示**只有**组织的**成员**才能访问它们
* **内部**表示**只有**企业的**成员**（一个企业可能有多个组织）才能访问它
* **公开**表示**所有互联网**都可以访问它。

如果您知道您要攻击的**用户、仓库或组织**，您可以使用**github dorks**来查找敏感信息或搜索**每个仓库**中的**敏感信息泄露**。

### Github Dorks

Github允许**在用户、仓库或组织的范围内搜索某些内容**。因此，通过一个字符串列表，这些字符串将与敏感信息接近，您可以轻松地**搜索目标中的潜在敏感信息**。

工具（每个工具都包含其dorks列表）：

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker)（[Dorks列表](https://github.com/obheda12/GitDorker/tree/master/Dorks)）
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks)（[Dorks列表](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt)）
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber)（[Dorks列表](https://github.com/hisxo/gitGraber/tree/master/wordlists)）

### Github泄露

请注意，github dorks也用于使用github搜索选项搜索泄露。本节专门介绍那些将**下载每个仓库并在其中搜索敏感信息**（甚至检查一定深度的提交）的工具。

工具（每个工具都包含其正则表达式列表）：

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
当您在一个仓库中寻找泄露并运行类似`git log -p`的命令时，请不要忘记可能存在**包含机密信息的其他分支和提交**！
{% endhint %}

### 外部Forks

可以通过滥用拉取请求来**危害仓库**。要知道一个仓库是否容易受到攻击，您主要需要阅读Github Actions的yaml配置。[**有关此的更多信息请参见下文**](./#execution-from-a-external-fork)。

## 组织加固

### 成员权限

组织的成员可以被分配一些**默认权限**。这些权限可以从页面`https://github.com/organizations/<org_name>/settings/member_privileges`或[**组织API**](https://docs.github.com/en/rest/orgs/orgs)进行控制。

* **基本权限**：成员将对组织仓库拥有None/Read/Write/Admin权限。建议使用**None**或**Read**。
* **仓库分叉**：如果不必要，最好**不允许**成员分叉组织仓库。
* **创建页面**：如果不必要，最好**不允许**成员从组织仓库发布页面。如果需要，可以允许创建公开或私有页面。
* **集成访问请求**：启用此功能后，外部协作者将能够请求访问GitHub或OAuth应用程序以访问此组织及其资源。通常需要，但如果不需要，最好禁用它。
* _我在API响应中找不到这些信息，如果您找到了，请分享_
* **更改仓库可见性**：如果启用，具有**仓库**的**管理员**权限的**成员**将能够**更改其可见性**。如果禁用，只有组织所有者可以更改仓库的可见性。如果您**不希望**人们将事物**公开**，请确保此项**已禁用**。
* _我在API响应中找不到这些信息，如果您找到了，请分享_
* **删除和转移仓库**：如果启用，具有**仓库**的**管理员**权限的成员将能够**删除**或**转移**公开和私有**仓库**。
* _我在API响应中找不到这些信息，如果您找到了，请分享_
* **允许成员创建团队**：如果启用，组织的**任何成员**都可以**创建**新的**团队**。如果禁用，只有组织所有者可以创建新的团队。最好禁用此项。
* _我在API响应中找不到这些信息，如果您找到了，请分享_
* **此页面可以配置更多内容**，但前面的是与安全相关的内容。
### 操作设置

可以在页面`https://github.com/organizations/<org_name>/settings/actions`上配置几个与安全相关的设置。

{% hint style="info" %}
请注意，所有这些配置也可以在每个仓库上独立设置
{% endhint %}

* **Github actions策略**：它允许您指定哪些仓库可以运行工作流程，以及应该允许哪些工作流程。建议**指定允许的仓库**，而不是允许所有操作运行。
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **从外部协作者处派生拉取请求的工作流程**：建议**要求所有**外部协作者的批准。
* _我找不到包含此信息的API，请分享您的发现_
* **从派生的拉取请求中运行工作流程**：强烈**不建议从拉取请求中运行工作流程**，因为派生源的维护者将能够使用具有源仓库读取权限的令牌。
* _我找不到包含此信息的API，请分享您的发现_
* **工作流程权限**：强烈建议**仅授予读取仓库权限**。不建议授予写入和创建/批准拉取请求权限，以避免滥用运行工作流程时提供的GITHUB_TOKEN。
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### 集成

_如果您知道访问此信息的API端点，请告诉我！_

* **第三方应用访问策略**：建议限制对每个应用的访问，并仅允许所需的应用（在审核后）。
* **已安装的GitHub应用**：建议仅允许所需的应用（在审核后）。

## 侦察和滥用凭据的攻击

在这种情况下，我们假设您已经获得了某个GitHub帐户的访问权限。

### 使用用户凭据

如果您已经获得了组织中某个用户的凭据，您可以**直接登录**并检查您拥有的**企业和组织角色**，如果您是普通成员，请检查**普通成员的权限**，您所在的**组**，您对哪些**仓库拥有的权限**以及**仓库的保护方式**。

请注意，可能会使用**双因素身份验证（2FA）**，因此只有在您能够**通过该检查**时，才能访问此信息。

{% hint style="info" %}
请注意，如果您**成功窃取了`user_session` cookie**（当前配置为SameSite: Lax），您可以**完全冒充该用户**，而无需凭据或2FA。
{% endhint %}

如果有用的话，请查看下面关于[**分支保护绕过**](./#branch-protection-bypass)的部分。

### 使用用户SSH密钥

Github允许**用户**设置**SSH密钥**，该密钥将用作代表他们进行代码部署的**身份验证方法**（不应用2FA）。

使用此密钥，您可以对用户具有某些特权的**仓库进行更改**，但是您无法使用它访问github api以枚举环境。但是，您可以获取**枚举本地设置**以获取有关您访问的仓库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户将其用户名配置为其github用户名，则可以访问他在其帐户中设置的**公钥**，网址为_https://github.com/\<github\_username>.keys_，您可以检查此内容以确认您找到的私钥是否可用。

**SSH密钥**也可以设置在存储库中作为**部署密钥**。拥有此密钥的任何人都将能够从存储库中**启动项目**。通常，在具有不同部署密钥的服务器上，本地文件**`~/.ssh/config`**将为您提供与密钥相关的信息。

#### GPG密钥

如[**此处**](broken-reference/)所述，有时需要对提交进行签名，否则可能会被发现。

在本地检查当前用户是否有任何密钥：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的基本信息，请查看此处**](basic-github-information.md#personal-access-tokens)。

用户令牌可以用作Git通过HTTPS的密码替代，或者可以用于[**通过基本身份验证对API进行身份验证**](https://docs.github.com/v3/auth/#basic-authentication)。根据其附加的权限，您可能能够执行不同的操作。

用户令牌的格式如下：`ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### 使用Oauth应用程序

有关[**Github Oauth应用程序的基本信息，请查看此处**](basic-github-information.md#oauth-applications)。

攻击者可能会创建一个**恶意的Oauth应用程序**，以访问接受它们的用户的特权数据/操作，可能作为网络钓鱼活动的一部分。

这是Oauth应用程序可以请求的[范围](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)。在接受之前，应始终检查所请求的范围。

此外，如基本信息中所述，**组织可以授予/拒绝第三方应用程序**访问与该组织相关的信息/存储库/操作。

### 使用Github应用程序

有关[**Github应用程序的基本信息，请查看此处**](basic-github-information.md#github-applications)。

攻击者可能会创建一个**恶意的Github应用程序**，以访问接受它们的用户的特权数据/操作，可能作为网络钓鱼活动的一部分。

此外，如基本信息中所述，**组织可以授予/拒绝第三方应用程序**访问与该组织相关的信息/存储库/操作。

## 入侵和滥用Github Action

有几种技术可以入侵和滥用Github Action，请在此处查看：

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## 绕过分支保护

* **需要一定数量的批准**: 如果您入侵了多个帐户，您可以从其他帐户接受您的PR。如果您只有创建PR的帐户，则无法接受自己的PR。但是，如果您可以在存储库中使用**GITHUB\_TOKEN**访问Github Action环境，您可能能够**批准您的PR**并以此方式获得1个批准。
* _请注意，对于此项和Code Owners限制，通常用户无法批准自己的PR，但如果您可以，您可以滥用它来接受自己的PR。_
* **推送新提交时取消批准**: 如果未设置此项，您可以提交合法代码，等待某人批准，然后插入恶意代码并将其合并到受保护的分支中。
* **要求Code Owners进行审查**: 如果激活了此项并且您是Code Owner，您可以让**Github Action创建您的PR，然后自己批准**。
* 当**CODEOWNER文件配置错误**时，Github不会报错，但也不会使用它。因此，如果配置错误，则**不会应用Code Owners保护**。
* **允许指定的参与者绕过拉取请求要求**: 如果您是这些参与者之一，您可以绕过拉取请求的保护。
* **包括管理员**: 如果未设置此项且您是存储库的管理员，您可以绕过此分支保护。
* **PR劫持**: 您可以修改其他人的PR，添加恶意代码，自己批准生成的PR并合并所有内容。
* **移除分支保护**: 如果您是存储库的**管理员，您可以禁用保护**，合并您的PR并重新设置保护。
* **绕过推送保护**: 如果一个存储库**仅允许特定用户**在分支中发送推送（合并代码），则可以绕过推送保护（分支保护可能会保护所有使用通配符`*`指定的分支）。
* 如果您对存储库具有**写访问权限，但由于分支保护而无法推送代码**，您仍然可以**创建一个新分支**，并在其中创建一个在代码推送时触发的**github action**。由于**分支保护在创建之前不会保护分支**，因此对分支的第一次代码推送将**执行github action**。

## 绕过环境保护

有关[**Github环境的基本信息，请查看此处**](basic-github-information.md#git-environments)。

如果可以从所有分支**访问环境**，则它**没有受到保护**，您可以轻松访问环境中的密钥。请注意，您可能会发现所有分支都受到保护的存储库（通过指定其名称或使用`*`）在这种情况下，**找到一个可以推送代码的分支**，您可以通过创建一个新的github action（或修改一个）来**窃取**密钥。

请注意，您可能会遇到边缘情况，即所有分支都受到保护（通过通配符`*`）指定了**谁可以向分支推送代码**（_您可以在分支保护中指定_），而**您的用户没有权限**。您仍然可以运行自定义的github action，因为您可以创建一个分支并在其上使用推送触发器。**分支保护允许推送到新分支，因此将触发github action**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
请注意，在创建分支之后，分支保护将适用于新分支，您将无法修改它，但在此期间，您已经泄露了机密信息。

## 持久性

* 生成用户令牌
* 从机密中窃取GitHub令牌
* 删除工作流程结果和分支
* 给予组织中的所有人更多权限
* 创建用于窃取信息的Web钩子
* 邀请外部协作者
* 删除SIEM使用的Web钩子
* 创建/修改带有后门的Github Action
* 查找通过修改密钥值而进行命令注入的易受攻击的Github Action

### 冒名顶替的提交 - 通过仓库提交的后门

在Github上，可以从分叉中的仓库创建PR到一个仓库。即使PR未被接受，原始仓库中的一个提交ID也将为代码的分叉版本创建。因此，攻击者可以固定使用一个特定的提交，来自一个看似合法但并非仓库所有者创建的仓库。

就像[**这样**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e)：
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
更多信息请查看[https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想看到您的**公司在 HackTricks 中进行广告宣传**，或者如果您想访问**PEASS 的最新版本或下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
