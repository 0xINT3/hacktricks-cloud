# Seguran√ßa do Github

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## O que √© o Github

(De [aqui](https://kinsta.com/knowledgebase/what-is-github/)) Em um n√≠vel alto, **o GitHub √© um site e um servi√ßo baseado em nuvem que ajuda os desenvolvedores a armazenar e gerenciar seu c√≥digo, bem como rastrear e controlar as altera√ß√µes em seu c√≥digo**.

### Informa√ß√µes b√°sicas

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconhecimento externo

Os reposit√≥rios do Github podem ser configurados como p√∫blicos, privados e internos.

* **Privado** significa que **apenas** pessoas da **organiza√ß√£o** poder√£o acess√°-los
* **Interno** significa que **apenas** pessoas da **empresa** (uma empresa pode ter v√°rias organiza√ß√µes) poder√£o acess√°-lo
* **P√∫blico** significa que **toda a internet** poder√° acess√°-lo.

Caso voc√™ saiba o **usu√°rio, reposit√≥rio ou organiza√ß√£o que deseja atacar**, voc√™ pode usar **dorks do github** para encontrar informa√ß√µes sens√≠veis ou procurar **vazamentos de informa√ß√µes sens√≠veis** **em cada reposit√≥rio**.

### Dorks do Github

O Github permite **procurar algo especificando como escopo um usu√°rio, um reposit√≥rio ou uma organiza√ß√£o**. Portanto, com uma lista de strings que v√£o aparecer perto de informa√ß√µes sens√≠veis, voc√™ pode facilmente **procurar informa√ß√µes sens√≠veis potenciais em seu alvo**.

Ferramentas (cada ferramenta cont√©m sua lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de Dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de Dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de Dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Vazamentos do Github

Por favor, note que as dorks do github tamb√©m s√£o destinadas a procurar vazamentos usando op√ß√µes de pesquisa do github. Esta se√ß√£o √© dedicada √†s ferramentas que ir√£o **baixar cada reposit√≥rio e procurar informa√ß√µes sens√≠veis neles** (at√© mesmo verificando certa profundidade de commits).

Ferramentas (cada ferramenta cont√©m sua lista de regexes):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Quando voc√™ procura vazamentos em um reposit√≥rio e executa algo como `git log -p`, n√£o se esque√ßa de que pode haver **outras branches com outros commits** contendo segredos!
{% endhint %}

### Forks externos

√â poss√≠vel **comprometer reposit√≥rios abusando de pull requests**. Para saber se um reposit√≥rio √© vulner√°vel, voc√™ precisa principalmente ler as configura√ß√µes yaml do Github Actions. [**Mais informa√ß√µes sobre isso abaixo**](./#execution-from-a-external-fork).

## Fortalecimento da organiza√ß√£o

### Privil√©gios de membros

Existem alguns **privil√©gios padr√£o** que podem ser atribu√≠dos aos **membros** da organiza√ß√£o. Eles podem ser controlados a partir da p√°gina `https://github.com/organizations/<org_name>/settings/member_privileges` ou da [**API de Organiza√ß√µes**](https://docs.github.com/en/rest/orgs/orgs).

* **Permiss√µes b√°sicas**: Os membros ter√£o a permiss√£o Nenhuma/Leitura/Grava√ß√£o/Administra√ß√£o sobre os reposit√≥rios da organiza√ß√£o. O recomendado √© **Nenhuma** ou **Leitura**.
* **Fork de reposit√≥rio**: Se n√£o for necess√°rio, √© melhor **n√£o permitir** que os membros fa√ßam fork dos reposit√≥rios da organiza√ß√£o.
* **Cria√ß√£o de p√°ginas**: Se n√£o for necess√°rio, √© melhor **n√£o permitir** que os membros publiquem p√°ginas dos reposit√≥rios da organiza√ß√£o. Se necess√°rio, voc√™ pode permitir a cria√ß√£o de p√°ginas p√∫blicas ou privadas.
* **Solicita√ß√µes de acesso √† integra√ß√£o**: Com isso habilitado, colaboradores externos poder√£o solicitar acesso para aplicativos GitHub ou OAuth para acessar esta organiza√ß√£o e seus recursos. Geralmente √© necess√°rio, mas se n√£o for, √© melhor desabilit√°-lo.
  * _N√£o consegui encontrar esta informa√ß√£o na resposta da API, compartilhe se voc√™ encontrar_
* **Altera√ß√£o de visibilidade do reposit√≥rio**: Se habilitado, **membros** com permiss√µes de **administra√ß√£o** para o **reposit√≥rio** poder√£o **alterar sua visibilidade**. Se desabilitado, apenas os propriet√°rios da organiza√ß√£o podem alterar as visibilidades do reposit√≥rio. Se voc√™ **n√£o** quer que as pessoas tornem as coisas **p√∫blicas**, certifique-se de que isso est√° **desabilitado**.
  * _N√£o consegui encontrar esta informa√ß√£o na resposta da API, compartilhe se voc√™ encontrar_
* **Exclus√£o e transfer√™ncia de reposit√≥rios**: Se habilitado, membros com permiss√µes de **administra√ß√£o** para o reposit
### Com Chave SSH do Usu√°rio

O Github permite que **usu√°rios** configurem **chaves SSH** que ser√£o usadas como **m√©todo de autentica√ß√£o para implantar c√≥digo** em seu nome (sem aplica√ß√£o de 2FA).

Com essa chave, voc√™ pode realizar **altera√ß√µes em reposit√≥rios onde o usu√°rio tem alguns privil√©gios**, no entanto, voc√™ n√£o pode us√°-la para acessar a API do Github para enumerar o ambiente. No entanto, voc√™ pode **enumerar as configura√ß√µes locais** para obter informa√ß√µes sobre os reposit√≥rios e usu√°rios aos quais voc√™ tem acesso:

```bash
# V√° para a pasta do reposit√≥rio
# Obtenha a configura√ß√£o do reposit√≥rio e o nome e e-mail do usu√°rio atual
git config --list
```

Se o usu√°rio tiver configurado seu nome de usu√°rio como seu nome de usu√°rio do Github, voc√™ pode acessar as **chaves p√∫blicas que ele configurou** em sua conta em _https://github.com/\<github\_username>.keys_, voc√™ pode verificar isso para confirmar que a chave privada que voc√™ encontrou pode ser usada.

**Chaves SSH** tamb√©m podem ser definidas em reposit√≥rios como **chaves de implanta√ß√£o**. Qualquer pessoa com acesso a essa chave poder√° **lan√ßar projetos de um reposit√≥rio**. Geralmente, em um servidor com diferentes chaves de implanta√ß√£o, o arquivo local **`~/.ssh/config`** fornecer√° informa√ß√µes sobre qual chave est√° relacionada.

#### Chaves GPG

Como explicado [**aqui**](broken-reference/), √†s vezes √© necess√°rio assinar os commits ou voc√™ pode ser descoberto.

Verifique localmente se o usu√°rio atual tem alguma chave com:

```shell
gpg --list-secret-keys --keyid-format=long
```

### Com Token do Usu√°rio

Para uma introdu√ß√£o sobre [**Tokens de Usu√°rio, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#personal-access-tokens).

Um token de usu√°rio pode ser usado **em vez de uma senha** para Git sobre HTTPS, ou pode ser usado para [**autenticar na API sobre Autentica√ß√£o B√°sica**](https://docs.github.com/v3/auth/#basic-authentication). Dependendo dos privil√©gios anexados a ele, voc√™ pode ser capaz de realizar diferentes a√ß√µes.

Um token de usu√°rio se parece com isso: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Com Aplica√ß√£o Oauth

Para uma introdu√ß√£o sobre [**Aplica√ß√µes Oauth do Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#oauth-applications).

Um atacante pode criar uma **Aplica√ß√£o Oauth maliciosa** para acessar dados/a√ß√µes privilegiados dos usu√°rios que os aceitam, provavelmente como parte de uma campanha de phishing.

Esses s√£o os [escopos que uma aplica√ß√£o Oauth pode solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Voc√™ sempre deve verificar os escopos solicitados antes de aceit√°-los.

Al√©m disso, como explicado nas informa√ß√µes b√°sicas, **organiza√ß√µes podem conceder/negar acesso a aplicativos de terceiros** a informa√ß√µes/reposit√≥rios/a√ß√µes relacionadas √† organiza√ß√£o.

### Com Aplica√ß√£o Github

Para uma introdu√ß√£o sobre [**Aplica√ß√µes Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#github-applications).

Um atacante pode criar uma **Aplica√ß√£o Github maliciosa** para acessar dados/a√ß√µes privilegiados dos usu√°rios que os aceitam, provavelmente como parte de uma campanha de phishing.

Al√©m disso, como explicado nas informa√ß√µes b√°sicas, **organiza√ß√µes podem conceder/negar acesso a aplicativos de terceiros** a informa√ß√µes/reposit√≥rios/a√ß√µes relacionadas √† organiza√ß√£o.

## Abusando da A√ß√£o Github

Para uma introdu√ß√£o sobre [**A√ß√µes Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#github-actions).

No caso de voc√™ poder **executar a√ß√µes github arbitrariamente** em um **reposit√≥rio**, voc√™ pode **roubar os segredos desse reposit√≥rio**.

### Execu√ß√£o a partir da Cria√ß√£o do Reposit√≥rio

No caso de membros de uma organiza√ß√£o poderem **criar novos reposit√≥rios** e voc√™ poder executar a√ß√µes do github, voc√™ pode **criar um novo reposit√≥rio e roubar os segredos definidos no n√≠vel da organiza√ß√£o**.

### Execu√ß√£o a partir de um Novo Branch

Se voc√™ pode **criar um novo branch em um reposit√≥rio que j√° cont√©m uma A√ß√£o Github** configurada, voc√™ pode **modific√°-la**, **carregar** o conte√∫do e, em seguida, **executar essa a√ß√£o a partir do novo branch**. Dessa forma, voc√™ pode **exfiltrar segredos de n√≠vel de reposit√≥rio e organiza√ß√£o** (mas voc√™ precisa saber como eles s√£o chamados).

Voc√™ pode tornar a a√ß√£o modificada execut√°vel **manualmente**, quando um **PR √© criado** ou quando **algum c√≥digo √© enviado** (dependendo de qu√£o barulhento voc√™ deseja ser):

```yaml
on:
  workflow_dispatch: # Lan√ßar manualmente
  pull_request: # Executar quando um PR √© criado para um branch
    branches:
      - master
  push: # Executar quando um push √© feito para um branch
    branches:
      - current_branch_name

# Use '**' em vez de um nome de branch para acionar a a√ß√£o em todos os branches
```

### Execu√ß√£o a partir de um Fork Externo

Se um reposit√≥rio estiver usando a√ß√µes do github, um invasor poder√° **criar uma solicita√ß√£o pull de um reposit√≥rio bifurcado** injetando **c√≥digo malicioso** no **fluxo de trabalho** do github e ele pode ser capaz de **comprometer o reposit√≥rio do github** dessa maneira.

#### `pull_request`

O gatilho do fluxo de trabalho **`pull_request`** por padr√£o **impede permiss√µes de grava√ß√£o** e **acesso a segredos** ao reposit√≥rio de destino. Al√©m disso, por padr√£o, se for a **primeira vez** que voc√™ est√° **colaborando**, algum **mantenedor** precisar√° **aprovar** a **execu√ß√£o** do fluxo de trabalho:

<figure><img src="../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Como a **limita√ß√£o padr√£o** √© para **contribuidores de primeira vez**, voc√™ pode contribuir **corrigindo um bug v√°lido** e, em seguida, enviar **outras PRs para abusar de seus novos privil√©gios de `pull_request`**.

**Testei isso e n√£o funciona**: ~~Outra op√ß√£o seria criar uma conta com o nome de algu√©m que contribuiu para o projeto e excluiu sua conta.~~
{% endhint %}

No entanto, para **evitar** a **comprometimento** do **reposit√≥rio** via **`pull_request`**, isso √© mencionado na [**documenta√ß√£o**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Com exce√ß√£o de `GITHUB_TOKEN`, **os segredos n√£o s√£o passados para o runner** quando um fluxo de trabalho √© acionado a partir de um reposit√≥rio bifurcado. O **`GITHUB_TOKEN` tem permiss√µes somente leitura** em solicita√ß√µes pull **de reposit√≥rios bifurcados**.

Um invasor pode modificar a defini√ß√£o da A√ß√£o Github para executar coisas arbitr√°rias e anexar a√ß√µes arbitr√°rias. No entanto, ele n√£o poder√° roubar segredos ou sobrescrever o reposit√≥rio devido √†s limita√ß√µes mencionadas.

No entanto, mesmo que a a√ß√£o n√£o mencione Artefatos, ele pode ser capaz de modificar um Artefato do reposit√≥rio alterando a a√ß√£o?? (TODO).

{% hint style="danger" %}
**Sim, se o invasor alterar na PR a a√ß√£o do github que ser√° acionada, sua A√ß√£o Github ser√° a usada e n√£o a do reposit√≥rio de origem!**
{% endhint %}

_No entanto, enviar uma nova a√ß√£o que aciona o pull\_request n√£o ser√° acionada._

#### **`pull_request_target`**

No entanto, o gatilho do fluxo de trabalho **`pull_request_target`** tem **permiss√£o de grava√ß√£o
# INSEGURO. Fornecido apenas como exemplo.
on:
  pull_request_target

jobs:
  build:
    name: Construir e testar
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - uses: actions/setup-node@v1
    - run: |
        npm install
        npm build

    - uses: completely/fakeaction@v2
      with:
        arg1: ${{ secrets.supersecret }}

    - uses: fakerepo/comment-on-pr@v1
      with:
        message: |
          Obrigado!
```

O c√≥digo potencialmente **n√£o confi√°vel √© executado durante `npm install` ou `npm build`** como scripts de constru√ß√£o e pacotes referenciados s√£o controlados pelo autor do PR.

{% hint style="danger" %}
Se a a√ß√£o for executada em um runner auto-hospedado, o atacante pode ser capaz de compromet√™-lo ainda mais.
{% endhint %}

Um dork do Github para procurar a√ß√µes vulner√°veis √©: `event.pull_request pull_request_target extension:yml`, no entanto, existem diferentes maneiras de configurar os trabalhos para serem executados com seguran√ßa, mesmo que a a√ß√£o seja configurada de forma insegura (como usar condicionais sobre quem √© o ator que gera o PR).

### Inje√ß√£o/Backdoor de Github Action

Caso voc√™ de alguma forma tenha conseguido **infiltrar dentro de uma Github Action**, se voc√™ puder **escalar privil√©gios**, voc√™ pode **roubar segredos dos processos onde os segredos foram definidos**. Em alguns casos, voc√™ nem precisa escalar privil√©gios.

```bash
cat /proc/<proc_number>/environ
cat /proc/*/environ | grep -i secret #Supondo que o nome da vari√°vel de ambiente contenha "secret"
```

### Github Action acessando AWS e GCP via OIDC

Verifique as seguintes p√°ginas:

{% content-ref url="../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Informa√ß√µes sens√≠veis nos logs de Github Actions

Mesmo que o **Github** tente **detectar valores secretos** nos logs das a√ß√µes e **evite mostr√°-los**, **outras informa√ß√µes sens√≠veis** que podem ter sido geradas na execu√ß√£o da a√ß√£o n√£o ser√£o ocultadas. Por exemplo, um JWT assinado com um valor secreto n√£o ser√° ocultado, a menos que seja [especificamente configurado](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

### GITHUB\_TOKEN

Este "**segredo**" (vindo de `${{ secrets.GITHUB_TOKEN }}` e `${{ github.token }}`) √© fornecido quando o administrador habilita esta op√ß√£o:

<figure><img src="../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Este token √© o mesmo que um **Aplicativo Github usar√°**, ent√£o ele pode acessar os mesmos endpoints: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
O Github deve lan√ßar um [**fluxo**](https://github.com/github/roadmap/issues/74) que **permite acesso entre reposit√≥rios** dentro do Github, para que um reposit√≥rio possa acessar outros reposit√≥rios internos usando o `GITHUB_TOKEN`.
{% endhint %}

Voc√™ pode ver as poss√≠veis **permiss√µes** deste token em: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Observe que o token **expira ap√≥s a conclus√£o do trabalho**.\
Esses tokens se parecem com isso: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Algumas coisas interessantes que voc√™ pode fazer com este token:

```bash
# Merge PR
curl -X PUT \
    https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
    -H "Accept: application/vnd.github.v3+json" \
    --header "authorization: Bearer $GITHUB_TOKEN" \
    --header 'content-type: application/json' \
    -d '{"commit_title":"commit_title"}'

# Approve a PR
curl -X POST \
    https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
    -H "Accept: application/vnd.github.v3+json" \
    --header "authorization: Bearer $GITHUB_TOKEN" \
    --header 'content-type: application/json' \
    -d '{"event":"APPROVE"}'

# Create a PR
curl -X POST \
  -H "Accept: application/vnd.github.v3+json" \
  --header "authorization: Bearer $GITHUB_TOKEN" \
    --header 'content-type: application/json' \
  https://api.github.com/repos/<org_name>/<repo_name>/pulls \
  -d '{"head":"<branch_name>","base":"master", "title":"title"}'
```

{% hint style="danger" %}
Observe que em v√°rias ocasi√µes voc√™ poder√° encontrar **tokens de usu√°rio do Github dentro dos envs das A√ß√µes do Github ou nos segredos**. Esses tokens podem dar a voc√™ mais privil√©gios sobre o reposit√≥rio e a organiza√ß√£o.
{% endhint %}

#### Listar segredos na sa√≠da da Github Action

```yaml
name: list_env
on:
  workflow_dispatch: # Launch manually
  pull_request: #Run it when a PR is created to a branch
    branches:
      - '**'
  push: # Run it when a push is made to a branch
    branches:
      - '**'
jobs:     
  List_env:
    runs-on: ubuntu-latest
    steps:
      - name: List Env
        # Need to base64 encode or github will change the secret value for "***"
        run: sh -c 'env | grep "secret_" | base64 -w0'
        env:
          secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
### Envenenamento de Cache

Usando a a√ß√£o Git [**action/cache**](https://github.com/actions/cache) em qualquer lugar do CI, ser√£o executadas duas etapas: uma etapa ocorrer√° durante o processo de **execu√ß√£o** quando for chamado e a outra ocorrer√° ap√≥s o **fluxo de trabalho** (se a a√ß√£o de execu√ß√£o retornar uma falha de cache).

* **A√ß√£o de execu√ß√£o** - √© usada para pesquisar e recuperar o cache. A pesquisa √© feita usando a chave de cache, com o resultado sendo um cache-hit (sucesso, dados encontrados em cache) ou cache-miss. Se encontrado, os arquivos e diret√≥rios s√£o recuperados do cache para uso ativo. Se o resultado for cache-miss, os arquivos e diret√≥rios desejados s√£o baixados como se fosse a primeira vez que s√£o chamados.
* **A√ß√£o de fluxo de trabalho p√≥s** - usada para salvar o cache. Se o resultado da chamada de cache na a√ß√£o de execu√ß√£o retornar uma falha de cache, esta a√ß√£o salvar√° o estado atual dos diret√≥rios que desejamos armazenar em cache com a chave fornecida. Essa a√ß√£o acontece automaticamente e n√£o precisa ser chamada explicitamente.

As **restri√ß√µes de acesso** fornecem **isolamento de cache** e seguran√ßa criando um **limite l√≥gico entre diferentes branches** _(por exemplo: um cache criado para o branch **Feature-A** \[com a base principal] n√£o seria acess√≠vel a um pull request para o branch **Feature-B** \[com a base principal])_.

A a√ß√£o de cache primeiro procura por acertos de cache para uma chave e restaura as chaves no branch que cont√©m a **execu√ß√£o do fluxo de trabalho**. Se n√£o houver acertos no branch atual, a a√ß√£o de cache procura pela chave e restaura as chaves no branch pai e nos branches upstream.

O acesso a um cache √© limitado por branch (atual e pai), o que significa que o acesso √© fornecido a todos os **fluxos de trabalho** em todas as **execu√ß√µes** do referido branch.

Outra observa√ß√£o importante √© que o GitHub n√£o permite modifica√ß√µes uma vez que as entradas s√£o enviadas - as entradas de cache s√£o registros somente leitura.

Usamos um exemplo de CI que inclu√≠a dois fluxos de trabalho. Este exemplo mostra como um ataque pode se mover de um fluxo de trabalho de baixa permiss√£o para um de alta permiss√£o.

* Fluxo de trabalho de **teste de unidade** executando testes de unidade e ferramentas de cobertura de c√≥digo. Supomos que uma das ferramentas √© maliciosa ou vulner√°vel √† execu√ß√£o remota de c√≥digo. O fluxo de trabalho n√£o precisa usar a a√ß√£o Git **action/cache**. Qualquer fluxo de trabalho pode acessar o cache.
* Fluxo de trabalho de **lan√ßamento** constr√≥i e libera o artefato da aplica√ß√£o. Este fluxo de trabalho usa um cache para otimizar o uso das depend√™ncias Golang.

O fluxo de trabalho de **teste de unidade** usa uma a√ß√£o maliciosa que adiciona uma entrada de cache com conte√∫do malicioso, alterando uma biblioteca de registro Golang (**go.uber.org/zap@v1**) para adicionar a string 'BAD library' √† descri√ß√£o do artefato da aplica√ß√£o.

Em seguida, o fluxo de trabalho de **lan√ßamento** usa essa entrada de cache envenenada. Como resultado, o c√≥digo malicioso √© injetado no bin√°rio e imagem Golang constru√≠dos. O cache permanece envenenado at√© que a chave de entrada seja descartada (geralmente acionada por atualiza√ß√µes de depend√™ncia). O mesmo cache envenenado afetar√° qualquer outro **fluxo de trabalho**, **execu√ß√£o** e **branch filho** que use a mesma chave de cache.

No teste que realizamos, conseguimos injetar a string 'BAD library' na descri√ß√£o da imagem:

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

Isso foi na vers√£o 0.4.1. Em seguida, atualizamos a tag e reconstru√≠mos a imagem v√°rias vezes e observamos que 'Bad library' permaneceu na descri√ß√£o.

Essas t√©cnicas foram retiradas de [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

### Envenenamento de Artefato

Existem v√°rias a√ß√µes do Github que permitem **baixar artefatos de outros reposit√≥rios**. Esses outros reposit√≥rios geralmente ter√£o uma a√ß√£o do Github para **carregar o artefato** que ser√° posteriormente baixado.\
Se a **a√ß√£o do Github** do reposit√≥rio que carrega o artefato permitir o **`pull_request`** ou **`pull_request_target`** (usando o c√≥digo do atacante), um atacante poder√° acionar a A√ß√£o que carregar√° um Artefato criado a partir de seu c√≥digo, para que qualquer outro reposit√≥rio que baixe e execute o artefato mais recente seja comprometido.

{% hint style="info" %}
Como mencionado em uma se√ß√£o deste post, **`pull_requests`** geralmente exigir√£o uma **aprova√ß√£o manual** de um mantenedor do reposit√≥rio.
{% endhint %}

Exemplo de **download de artefato de um reposit√≥rio diferente**:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Como mencionado anteriormente, em um acionador de **`pull_request`**, a A√ß√£o definida no PR √© a que √© executada. Portanto, um **atacante** poderia **definir** **l√°** o **upload de artefato** que ele gostaria de comprometer.

Portanto, um atacante n√£o precisa atacar um acionador de **`pull_request`** na a√ß√£o de upload de artefato, mas apenas qualquer acionador de **`pull_request`**.
{% endhint %}

Para mais informa√ß√µes e op√ß√µes de defesa (como codificar o artefato a ser baixado) verifique [https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust](https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust)

### Sequestro de Reposit√≥rio de Namespace Exclu√≠do

Este √© um bom post de blog para ler sobre vulnerabilidades corrigidas que permitiriam a um atacante roubar um namespace exclu√≠do para roubar um reposit√≥rio famoso (potencialmente por causa de uma renomea√ß√£o do namespace): [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

### Registro de Imagens Docker do Github

√â poss√≠vel fazer a√ß√µes do Github que **compilam e armazenam uma imagem Docker dentro do Github**.\
Um exemplo pode ser encontrado no seguinte expans√≠vel:

<details>

<summary>A√ß√£o do Github para compilar e enviar uma imagem Docker</summary>

```yaml
[...]

- name: Set up Docker Buildx
  uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
  uses: docker/login-action@v1
  with:
    registry: ghcr.io
    username: ${{ github.repository_owner }}
    password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
  run: |
    sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
  uses: docker/build-push-action@v2
    with:
      context: .
      push: true
      tags: |
        ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
        ghcr.io/${{ github.repository_owner }}
## Bypassar Prote√ß√µes de Ambientes

Para uma introdu√ß√£o sobre o [**Github Environment, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#git-environments).

Caso um ambiente possa ser **acessado de todos os branches**, ele **n√£o est√° protegido** e voc√™ pode facilmente acessar os segredos dentro do ambiente. Note que voc√™ pode encontrar reposit√≥rios onde **todos os branches est√£o protegidos** (especificando seus nomes ou usando `*`) nesse cen√°rio, **encontre um branch onde voc√™ possa enviar c√≥digo** e voc√™ pode **exfiltrar** os segredos criando uma nova a√ß√£o do github (ou modificando uma).

Observe que voc√™ pode encontrar o caso extremo em que **todos os branches est√£o protegidos** (via wildcard `*`) e √© especificado **quem pode enviar c√≥digo para os branches** (_voc√™ pode especificar isso na prote√ß√£o do branch_) e **seu usu√°rio n√£o est√° autorizado**. Voc√™ ainda pode executar uma a√ß√£o personalizada do github porque pode criar um branch e usar o gatilho de envio sobre si mesmo. A **prote√ß√£o do branch permite o envio para um novo branch, ent√£o a a√ß√£o do github ser√° acionada**.

```yaml
  push: # Execute quando um envio √© feito para um branch
    branches:
      - current_branch_name #Use '**' para executar quando um envio √© feito para qualquer branch
```

Observe que **ap√≥s a cria√ß√£o** do branch, a **prote√ß√£o do branch ser√° aplicada ao novo branch** e voc√™ n√£o poder√° modific√°-lo, mas nesse tempo voc√™ j√° ter√° despejado os segredos.

## Persist√™ncia

* Gerar **token de usu√°rio**
* Roubar **tokens do github** de **segredos**
  * **Exclus√£o** de **resultados** e **branches** do fluxo de trabalho
* Dar **mais permiss√µes a toda a organiza√ß√£o**
* Criar **webhooks** para exfiltrar informa√ß√µes
* Convidar **colaboradores externos**
* **Remover** **webhooks** usados pelo **SIEM**
* Criar/modificar **Github Action** com uma **porta dos fundos**
* Encontrar uma **Github Action vulner√°vel √† inje√ß√£o de comando** via modifica√ß√£o do valor **secreto**

### Commits Impostores - Porta dos fundos via commits do reposit√≥rio

No Github, √© poss√≠vel **criar um PR para um reposit√≥rio a partir de um fork**. Mesmo que o PR n√£o seja **aceito**, um id de **commit** dentro do reposit√≥rio original ser√° criado para a vers√£o fork do c√≥digo. Portanto, um atacante **poderia fixar o uso de um commit espec√≠fico de um reposit√≥rio aparentemente leg√≠timo que n√£o foi criado pelo propriet√°rio do reposit√≥rio**.

Como [**este**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):

```yaml
name: example
on: [push]
jobs:
 commit:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
     - shell: bash
       run: |
         echo 'hello world!'
```

Para mais informa√ß√µes, verifique [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>