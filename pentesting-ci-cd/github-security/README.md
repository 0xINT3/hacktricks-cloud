# Github安全

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想在HackTricks中看到您的**公司广告**或**下载PDF版本的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 什么是Github

（来自[这里](https://kinsta.com/knowledgebase/what-is-github/)）在高层次上，**GitHub是一个网站和基于云的服务，帮助开发人员存储和管理他们的代码，以及跟踪和控制对他们的代码的更改**。

### 基本信息

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 外部侦察

Github仓库可以配置为公共、私有和内部。

- **私有**表示**只有**组织的**成员**才能访问它们
- **内部**表示**只有**企业的**员工**（一个企业可能有几个组织）才能访问它
- **公共**表示**所有互联网**都可以访问它。

如果您知道您想要攻击的**用户、仓库或组织**，您可以使用**github dorks**查找敏感信息或在**每个仓库**中搜索**敏感信息泄漏**。

### Github Dorks

Github允许**搜索指定用户、仓库或组织的范围**。因此，通过一组将出现在敏感信息附近的字符串，您可以轻松地**搜索目标中的潜在敏感信息**。

工具（每个工具都包含其dorks列表）：

- [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker)（[Dorks列表](https://github.com/obheda12/GitDorker/tree/master/Dorks)）
- [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks)（[Dorks列表](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt)）
- [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber)（[Dorks列表](https://github.com/hisxo/gitGraber/tree/master/wordlists)）

### Github泄漏

请注意，github dorks也用于使用github搜索选项搜索泄漏。本节专门介绍那些将**下载每个仓库并在其中搜索敏感信息**的工具（甚至检查一定深度的提交）。

工具（每个工具包含其正则表达式列表）：

- [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
- [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
- [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
- [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
- [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
- [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
- [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
当您在仓库中寻找泄漏并运行类似`git log -p`的命令时，请不要忘记可能存在**包含机密信息的其他分支和其他提交**！
{% endhint %}

### 外部分支

可以**利用拉取请求来妥协仓库**。要知道一个仓库是否容易受攻击，您主要需要阅读Github Actions的yaml配置。[**下面有更多信息**](./#execution-from-a-external-fork)。

## 组织加固

### 成员权限

组织的成员可以被分配一些**默认权限**。这些权限可以从页面`https://github.com/organizations/<org_name>/settings/member_privileges`或[**组织API**](https://docs.github.com/en/rest/orgs/orgs)进行控制。

- **基本权限**：成员将对组织仓库拥有None/Read/write/Admin权限。建议选择**None**或**Read**。
- **仓库分叉**：如果不必要，最好**不允许**成员分叉组织仓库。
- **页面创建**：如果不必要，最好**不允许**成员从组织仓库发布页面。如果需要，可以允许创建公共或私有页面。
- **集成访问请求**：启用此选项后，外部合作者将能够请求访问GitHub或OAuth应用程序以访问此组织及其资源。通常是必要的，但如果不需要，最好禁用它。
- _我在API响应中找不到这些信息，如果您找到了，请分享_
- **仓库可见性更改**：如果启用，具有**仓库**的**管理员**权限的**成员**将能够**更改其可见性**。如果禁用，只有组织所有者可以更改仓库的可见性。如果您**不希望**人们将事物**公开**，请确保此项**已禁用**。
- _我在API响应中找不到这些信息，如果您找到了，请分享_
- **仓库删除和转移**：如果启用，具有**仓库**的**管理员**权限的**成员**将能够**删除**或**转移**公共和私有**仓库**。
- _我在API响应中找不到这些信息，如果您找到了，请分享_
- **允许成员创建团队**：如果启用，组织的**任何成员**都可以**创建**新的**团队**。如果禁用，只有组织所有者可以创建新团队。最好将其禁用。
- _我在API响应中找不到这些信息，如果您找到了，请分享_
- 此页面中还可以配置**更多内容**，但上述内容与安全相关。

### 操作设置

可以为操作配置几个与安全相关的设置，从页面`https://github.com/organizations/<org_name>/settings/actions`开始。

{% hint style="info" %}
请注意，所有这些配置也可以在每个仓库中独立设置
{% endhint %}

- **Github操作策略**：它允许您指定哪些仓库可以运行工作流程，以及应允许哪些工作流程。建议**指定应允许的仓库**，而不是允许所有操作运行。
- [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
- **从外部合作者的分支拉取请求工作流程**：建议**要求所有**外部合作者的批准。
- _我找不到包含此信息的API，请分享您找到的信息_
- **从分支拉取请求运行工作流程**：强烈**不建议从拉取请求中运行工作流程**，因为分支源的维护者将有权使用具有对源仓库读取权限的令牌。
- _我找不到包含此信息的API，请分享您找到的信息_
- **工作流程权限**：强烈建议**仅授予读取仓库权限**。不鼓励授予写入和创建/批准拉取请求权限，以避免滥用提供给运行工作流程的GITHUB\_TOKEN。
- [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)
### 集成

_如果您知道访问此信息的API端点，请告诉我！_

* **第三方应用访问策略**：建议限制对每个应用程序的访问，并仅允许必要的应用程序（在审核后）。
* **已安装的 GitHub 应用**：建议仅允许必要的应用程序（在审核后）。

## 侦察和滥用凭据的攻击

对于这种情况，我们假设您已经获得了对 GitHub 帐户的某些访问权限。

### 使用用户凭据

如果您已经以某个组织中的用户的凭据登录，您可以**直接登录**并检查您拥有的**企业和组织角色**，如果您是普通成员，请检查**普通成员具有的权限**，您属于哪些**组**，您对哪些**存储库具有权限**，以及**存储库受到了怎样的保护**。

请注意，可能会使用**双因素身份验证**，因此只有在您能够**通过该检查**时才能访问这些信息。

{% hint style="info" %}
请注意，如果您**设法窃取`user_session` cookie**（当前配置为 SameSite: Lax），您可以**完全冒充用户**，而无需凭据或双因素身份验证。
{% endhint %}

查看下面关于[**分支保护绕过**](./#branch-protection-bypass)的部分，以确定其是否有用。

### 使用用户 SSH 密钥

Github允许**用户**设置**SSH密钥**，这将用作**部署代码的身份验证方法**（不适用双因素身份验证）。

使用此密钥，您可以在用户具有某些特权的存储库中执行更改，但是您无法使用它访问 GitHub API 来枚举环境。但是，您可以**枚举本地设置**以获取有关您可以访问的存储库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户已将其用户名配置为其github用户名，则可以访问他在其帐户中设置的**公钥**，您可以检查此内容以确认您找到的私钥是否可用。

**SSH密钥**也可以设置在存储库中作为**部署密钥**。任何拥有此密钥的人都将能够**从存储库启动项目**。通常在具有不同部署密钥的服务器上，本地文件**`~/.ssh/config`**将为您提供有关密钥相关的信息。

#### GPG密钥

如[**此处**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md)所解释的，有时需要对提交进行签名，否则可能会被发现。

在本地检查当前用户是否有任何密钥：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的基本信息，请查看基本信息**](basic-github-information.md#personal-access-tokens)。

用户令牌可用于代替密码进行Git的HTTPS访问，或用于[**通过基本身份验证对API进行身份验证**](https://docs.github.com/v3/auth/#basic-authentication)。根据附加的特权，您可能能够执行不同的操作。

用户令牌如下所示：`ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### 使用Oauth应用程序

有关[**Github Oauth应用程序的基本信息，请查看基本信息**](basic-github-information.md#oauth-applications)。

攻击者可能创建一个**恶意的Oauth应用程序**，以访问接受它们的用户的特权数据/操作，这可能是作为网络钓鱼活动的一部分。

这是[Oauth应用程序可以请求的范围](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)。在接受之前，应始终检查请求的范围。

此外，如基本信息中所述，**组织可以授予/拒绝对与组织相关的信息/存储库/操作的第三方应用程序的访问权限**。

### 使用Github应用程序

有关[**Github应用程序的基本信息，请查看基本信息**](basic-github-information.md#github-applications)。

攻击者可能创建一个**恶意的Github应用程序**，以访问接受它们的用户的特权数据/操作，这可能是作为网络钓鱼活动的一部分。

此外，如基本信息中所述，**组织可以授予/拒绝对与组织相关的信息/存储库/操作的第三方应用程序的访问权限**。

## 窃取和滥用Github操作

有几种技术可以窃取和滥用Github操作，请在此处查看：

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## 分支保护绕过

* **需要一定数量的批准**: 如果您入侵了多个帐户，您可能只需从其他帐户接受您的PR。如果您只有创建PR的帐户，则无法接受自己的PR。但是，如果您可以访问存储库内的**Github操作**环境，并使用**GITHUB_TOKEN**，则您可能能够**批准您的PR**，从而获得1个批准。
* _请注意，对于此项和通常用户无法批准自己的PR的代码所有者限制，但如果您可以，您可以滥用它来接受您的PR。_
* **在推送新提交时解除批准**: 如果未设置此项，您可以提交合法代码，等待某人批准，然后放入恶意代码并将其合并到受保护的分支中。
* **需要代码所有者审查**: 如果激活了此项且您是代码所有者，则可以让**Github操作创建您的PR，然后自行批准**。
* 当**CODEOWNER文件配置错误**时，Github不会报错，但也不会使用它。因此，如果配置错误，其**代码所有者保护不会生效**。
* **允许指定的操作者绕过拉取请求要求**: 如果您是这些操作者之一，则可以绕过拉取请求保护。
* **包括管理员**: 如果未设置此项且您是存储库的管理员，则可以绕过此分支保护。
* **PR劫持**: 您可能能够**修改其他人的PR**，添加恶意代码，自行批准生成的PR并合并所有内容。
* **移除分支保护**: 如果您是存储库的**管理员，可以禁用保护**，合并您的PR，然后重新设置保护。
* **绕过推送保护**: 如果存储库**仅允许特定用户**在分支中发送推送（合并代码），则可以绕过推送保护（分支保护可能会保护所有分支，指定通配符`*`）。
* 如果您对存储库具有**写入访问权限，但由于分支保护而无法推送代码**，您仍然可以**创建一个新分支**，并在其中创建一个**在推送代码时触发的Github操作**。由于**分支保护在创建分支之前不会保护分支**，因此对分支的第一次代码推送将**执行Github操作**。

## 绕过环境保护

有关[**Github环境的基本信息，请查看基本信息**](basic-github-information.md#git-environments)。

如果一个环境可以从**所有分支访问**，则它**没有受到保护**，您可以轻松访问环境中的机密信息。请注意，您可能会发现所有分支都受到保护的存储库（通过指定其名称或使用`*`）在这种情况下，**找到一个可以推送代码的分支**，您可以**窃取**环境中的机密信息，创建一个新的github操作（或修改一个）。

请注意，您可能会遇到一个边缘情况，即**所有分支都受到保护**（通过通配符`*`），指定了**谁可以向分支推送代码**（_您可以在分支保护中指定_），但**您的用户不被允许**。您仍然可以运行自定义的Github操作，因为您可以创建一个分支并在其上使用推送触发器。**分支保护允许向新分支推送代码，因此将触发Github操作**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
请注意，在分支创建后，分支保护将应用于新分支，您将无法修改它，但在那段时间内，您将已经窃取了机密。

## 持久性

* 生成用户令牌
* 从机密中窃取github令牌
* 删除工作流程结果和分支
* 为所有组织提供更多权限
* 创建用于外泄信息的webhook
* 邀请外部合作者
* 删除SIEM使用的webhook
* 创建/修改带后门的Github Action
* 查找通过秘密值修改实现命令注入的易受攻击的Github Action

### 冒牌提交 - 通过存储库提交的后门

在Github中，可以从分叉创建一个PR到存储库。即使PR未被接受，原始存储库中的提交ID也将为代码的分叉版本创建。因此，攻击者可以固定使用来自明显合法存储库的特定提交，而该存储库的所有者并非创建者。

像[**这样**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
了解更多信息，请查看[https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
