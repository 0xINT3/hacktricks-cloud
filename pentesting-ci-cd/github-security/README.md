# Githubセキュリティ

<details>

<summary><strong>HackTricksをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを楽しみましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出しましょう。

</details>

## Githubとは

([ここ](https://kinsta.com/knowledgebase/what-is-github/)から) **GitHubは、開発者がコードを保存・管理し、コードの変更を追跡・制御するのを支援するウェブサイトおよびクラウドベースのサービス**です。

### 基本情報

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 外部リコン

Githubリポジトリは、公開、非公開、内部の3つの設定で構成できます。

* **非公開**は、**組織のメンバーのみ**がアクセスできることを意味します
* **内部**は、**企業のメンバーのみ**がアクセスできることを意味します（企業には複数の組織がある場合があります）
* **公開**は、**インターネット上の誰でも**アクセスできることを意味します。

**ターゲットとするユーザー、リポジトリ、または組織がわかる場合**、**github dorks**を使用して機密情報を検索したり、**各リポジトリで機密情報の漏洩を検索**することができます。

### Github Dorks

Githubでは、**ユーザー、リポジトリ、または組織をスコープとして指定して検索**することができます。したがって、機密情報に近い文字列のリストを使用して、ターゲットで潜在的な機密情報を簡単に検索できます。

ツール（各ツールにはdorksのリストが含まれています）：

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker)（[Dorksリスト](https://github.com/obheda12/GitDorker/tree/master/Dorks)）
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks)（[Dorksリスト](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt)）
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber)（[Dorksリスト](https://github.com/hisxo/gitGraber/tree/master/wordlists)）

### Githubの漏洩

Github dorksは、githubの検索オプションを使用して漏洩を検索するためにも使用されることに注意してください。このセクションは、**各リポジトリをダウンロードし、それらの中で機密情報を検索する**ツールに dedicされています（特定のコミットの深さもチェックします）。

ツール（各ツールには正規表現のリストが含まれています）：

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
リポジトリで漏洩を探すときに `git log -p` のようなコマンドを実行する際には、**他のブランチにも他のコミットが含まれている可能性**があることを忘れないでください！
{% endhint %}

### 外部フォーク

**プルリクエストを悪用してリポジトリを侵害する**ことができます。リポジトリが脆弱かどうかを知るためには、主にGithub Actionsのyaml設定を読む必要があります。[**以下で詳細に説明します**](./#execution-from-a-external-fork)。

## 組織の強化

### メンバーの権限

組織のメンバーには、いくつかの**デフォルトの権限**が割り当てられることがあります。これらは、ページ `https://github.com/organizations/<org_name>/settings/member_privileges` または [**Organizations API**](https://docs.github.com/en/rest/orgs/orgs) から制御できます。

* **基本権限**: メンバーは、組織のリポジトリに対してNone/Read/write/Adminの権限を持ちます。**None**または**Read**が推奨されます。
* **リポジトリのフォーク**: 必要ない場合は、組織のリポジトリをメンバーがフォークできないようにする方が良いです。
* **ページの作成**: 必要ない場合は、組織のリポジトリからページを公開することをメンバーに許可しない方が良いです。必要な場合は、公開または非公開のページの作成を許可できます。
* **統合アクセスリクエスト**: これを有効にすると、外部の共同作業者がGitHubまたはOAuthアプリにアクセスするためにこの組織とそのリソースへのアクセスをリクエストできます。通常は必要ですが、必要ない場合は無効にする方が良いです。
* _APIのレスポンスにこの情報は見つかりませんでした。見つかった場合は共有してください_
* **リポジトリの可視性の変更**: 有効にすると、**リポジトリ**の**管理者**権限を持つ**メンバー**が**可視性を変更**できます。無効にすると、リポジトリの可視性を変更できるのは組織の所有者のみです。**公開**にしたくない場合は、これが**無効**になっていることを確認してください。
* _APIのレスポンスにこの情報は見つかりませんでした。見つかった場合は共有してください_
* **リポジトリの削除と移動**: 有効にすると、リポジトリの**管理者**権限を持つメンバーが公開および非公開のリポジトリを**削除**または**移動**できます。
* _APIのレスポンスにこの情報は見つかりませんでした。見つかった場合は共有してください_
* **メンバーがチームを作成できるよ
### アクション設定

アクションのセキュリティ関連の設定は、`https://github.com/organizations/<org_name>/settings/actions` ページから設定することができます。

{% hint style="info" %}
これらの設定は、各リポジトリごとに独立して設定することもできます。
{% endhint %}

* **Githubアクションポリシー**: ワークフローを実行できるリポジトリと許可されるワークフローを指定することができます。すべてのアクションを実行するのではなく、**許可されるリポジトリ**を指定することが推奨されます。
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **外部コラボレーターからのフォークプルリクエストワークフロー**: **すべての**外部コラボレーターに承認を要求することを推奨します。
* _この情報を取得するAPIが見つかりませんでした。分かる場合は共有してください。_
* **フォークプルリクエストからのワークフローの実行**: ワークフローをプルリクエストから実行することは非常に**推奨されません**。フォーク元のメンテナーは、ソースリポジトリの読み取り権限を持つトークンを使用する権限が与えられます。
* _この情報を取得するAPIが見つかりませんでした。分かる場合は共有してください。_
* **ワークフローの権限**: **読み取り専用のリポジトリ権限のみ**を与えることを強く推奨します。実行中のワークフローに与えられたGITHUB\_TOKENの乱用を防ぐため、書き込みおよびプルリクエストの作成/承認権限を与えることは推奨されません。
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### 統合

_この情報にアクセスするためのAPIエンドポイントが分かる場合は教えてください！_

* **サードパーティアプリケーションのアクセスポリシー**: すべてのアプリケーションへのアクセスを制限し、必要なもののみを許可することを推奨します（レビュー後）。
* **インストールされたGitHubアプリ**: 必要なもののみを許可することを推奨します（レビュー後）。

## 偵察と資格情報の悪用攻撃

このシナリオでは、GitHubアカウントへのアクセス権を取得したと仮定します。

### ユーザーの資格情報を使用する場合

組織内のユーザーの資格情報をすでに持っている場合、**ログイン**して、所属しているエンタープライズと組織の役割、自分が一般メンバーであるかどうか、一般メンバーに与えられる**権限**、所属している**グループ**、アクセス権を持つ**リポジトリ**、およびリポジトリの保護方法を確認できます。

**2FAが使用されている**場合、そのチェックをパスできる場合にのみ、この情報にアクセスできます。

{% hint style="info" %}
現在SameSite: Laxで構成されている`user_session`クッキーを**盗むことに成功**した場合、資格情報や2FAなしでユーザーを**完全になりすます**ことができます。
{% endhint %}

役立つ場合は、以下の[**ブランチ保護の回避方法**](./#branch-protection-bypass)に関するセクションを確認してください。

### ユーザーのSSHキーを使用する場合

Githubでは、ユーザーが**SSHキー**を設定することができます。これは、ユーザー自身の代わりにコードをデプロイするための**認証方法**として使用されます（2FAは適用されません）。

このキーを使用すると、ユーザーに特定の権限があるリポジトリで**変更を行う**ことができますが、github apiにアクセスして環境を列挙することはできません。ただし、アクセス権限があるリポジトリとユーザーに関する情報を取得するために、**ローカル設定を列挙**することはできます。
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
もしユーザーが自分のGitHubのユーザー名を設定している場合、彼のアカウントに設定されている**公開鍵にアクセス**することができます。これを確認することで、見つけた秘密鍵が使用できるかどうかを確認できます。

**SSHキー**は、リポジトリに**デプロイキー**として設定することもできます。このキーにアクセス権がある人は、リポジトリからプロジェクトを**起動**することができます。通常、異なるデプロイキーを持つサーバーでは、ローカルファイル**`~/.ssh/config`**に関連するキーの情報が記載されています。

#### GPGキー

[**こちら**](broken-reference/)で説明されているように、コミットに署名する必要がある場合や、発見される可能性があります。

現在のユーザーがローカルにキーを持っているかどうかを確認してください。
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用する場合

[**ユーザートークンに関する基本情報を確認する**](basic-github-information.md#personal-access-tokens)。

ユーザートークンは、Git over HTTPSのパスワードの代わりに使用することができます。または、[**Basic認証を使用してAPIに認証する**](https://docs.github.com/v3/auth/#basic-authentication)ために使用することもできます。それに付随する権限に応じて、さまざまなアクションを実行することができる場合があります。

ユーザートークンは次のようになります：`ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### OAuthアプリケーションを使用する場合

[**Github OAuthアプリケーションに関する基本情報を確認する**](basic-github-information.md#oauth-applications)。

攻撃者は、フィッシングキャンペーンの一環として、ユーザーの特権データ/アクションにアクセスするために、**悪意のあるOAuthアプリケーション**を作成する可能性があります。

これらは、[OAuthアプリケーションが要求できるスコープ](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)です。承認する前に要求されたスコープを常に確認する必要があります。

さらに、基本情報で説明されているように、**組織はサードパーティのアプリケーションに情報/リポジトリ/アクションへのアクセスを許可/拒否**することができます。

### Githubアプリケーションを使用する場合

[**Githubアプリケーションに関する基本情報を確認する**](basic-github-information.md#github-applications)。

攻撃者は、フィッシングキャンペーンの一環として、ユーザーの特権データ/アクションにアクセスするために、**悪意のあるGithubアプリケーション**を作成する可能性があります。

さらに、基本情報で説明されているように、**組織はサードパーティのアプリケーションに情報/リポジトリ/アクションへのアクセスを許可/拒否**することができます。

## Githubアクションの侵害と悪用

Githubアクションを侵害し悪用するためのいくつかのテクニックがあります。[こちらを確認してください](abusing-github-actions/)

## ブランチ保護のバイパス

* **承認の数を要求する**: 複数のアカウントを侵害した場合、他のアカウントから自分のPRを承認することができます。PRを作成したアカウントしか持っていない場合、自分自身のPRを承認することはできません。ただし、リポジトリ内の**Githubアクション**環境にアクセスできる場合、**GITHUB\_TOKEN**を使用して自分のPRを承認し、この方法で1つの承認を取得することができるかもしれません。
* _このテクニックとCode Ownersの制限については、通常、ユーザーは自分自身のPRを承認することはできませんが、許可されている場合は、自分のPRを受け入れるために悪用することができます。_
* **新しいコミットがプッシュされたときに承認を無効にする**: これが設定されていない場合、正当なコードを提出し、誰かが承認するのを待ってから、悪意のあるコードを追加して保護されたブランチにマージすることができます。
* **Code Ownersからのレビューを要求する**: これが有効になっており、Code Ownersである場合、**Githubアクションを使用して自分のPRを作成し、自分自身で承認する**ことができます。
* **CODEOWNERファイルが設定ミスされている場合**、Githubは警告を出さずに使用しません。したがって、設定ミスがある場合は、**Code Ownersの保護が適用されません**。
* **指定されたアクターがプルリクエストの要件をバイパスできるようにする**: これらのアクターの1人である場合、プルリクエストの保護をバイパスできます。
* **管理者を含める**: これが設定されていない場合、リポジトリの管理者である場合、このブランチの保護をバイパスできます。
* **PRハイジャック**: 他の人のPRを変更して悪意のあるコードを追加し、結果のPRを自分自身で承認し、すべてをマージすることができるかもしれません。
* **ブランチ保護の削除**: リポジトリの管理者である場合、保護を無効にし、自分のPRをマージし、保護を再設定することができます。
* **プッシュ保護のバイパス**: リポジトリが特定のユーザーのみにプッシュ（コードのマージ）を許可する場合（ブランチ保護がワイルドカード`*`を指定してすべてのブランチを保護している場合）、プッシュ保護をバイパスすることができます。
* リポジトリに**書き込みアクセス権があるが、ブランチ保護のためにコードをプッシュすることは許可されていない**場合、新しいブランチを作成し、その中に**コードがプッシュされたときにトリガーされるGithubアクション**を作成することができます。**ブランチが作成されるまでブランチ保護はブランチを保護しない**ため、最初のコードプッシュは**Githubアクションを実行**します。

## 環境保護のバイパス

[**Github環境に関する基本情報を確認する**](basic-github-information.md#git-environments)。

環境が**すべてのブランチからアクセス可能**である場合、それは**保護されていない**ため、環境内のシークレットに簡単にアクセスできます。すべてのブランチが保護されている場合（名前が指定されているか、ワイルドカード`*`を使用している場合）のリポジトリを見つけるかもしれませんが、**コードをプッシュできるブランチを見つけ**、新しいGithubアクションを作成（または変更）してシークレットを外部に持ち出すことができます。

なお、すべてのブランチが保護されている場合（ワイルドカード`*`を使用している場合）、**どのユーザーがブランチにコードをプッシュできるか**（ブランチ保護で指定できます）が指定されており、**ユーザーが許可されていない**場合でも、自己トリガーのためにカスタムGithubアクションを実行できます。**ブランチ保護は新しいブランチへのプッシュを許可するため、Githubアクションがトリガーされます**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
注意：ブランチの作成後、ブランチ保護が新しいブランチに適用され、変更できなくなりますが、その時点ですでにシークレットをダンプしています。

## 持続性

* ユーザートークンを生成する
* シークレットからGitHubトークンを盗む
* ワークフローの結果とブランチを削除する
* 組織全体により多くの権限を与える
* 情報を外部に持ち出すためにWebフックを作成する
* 外部の共同作業者を招待する
* SIEMが使用するWebフックを削除する
* バックドアを持つGithubアクションを作成/変更する
* シークレットの値の変更を介した脆弱なGithubアクションをコマンドインジェクションする

### インポスターコミット - リポジトリのコミットを介したバックドア

Githubでは、フォークからリポジトリへのPRを作成することが可能です。PRが受け入れられなくても、元のリポジトリのコミットIDがコードのフォークバージョンのために作成されます。したがって、攻撃者は、リポジトリの所有者によって作成されていない見かけのリポジトリから特定のコミットを使用することができます。

[**こちら**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e)のように。
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
詳細については、[https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)を参照してください。

<details>

<summary><strong>HackTricksをサポートして特典を受け取る！</strong></summary>

* **HackTricksの最新バージョンにアクセスしたい**場合や、**PEASSの最新バージョンをダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
