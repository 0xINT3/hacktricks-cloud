# Seguran√ßa do Github

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## O que √© o Github

(De [aqui](https://kinsta.com/knowledgebase/what-is-github/)) Em um n√≠vel alto, **o Github √© um site e um servi√ßo baseado em nuvem que ajuda os desenvolvedores a armazenar e gerenciar seu c√≥digo, al√©m de rastrear e controlar as altera√ß√µes feitas nele**.

### Informa√ß√µes b√°sicas

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconhecimento Externo

Os reposit√≥rios do Github podem ser configurados como p√∫blicos, privados e internos.

* **Privado** significa que **apenas** pessoas da **organiza√ß√£o** poder√£o acess√°-los.
* **Interno** significa que **apenas** pessoas da **empresa** (uma empresa pode ter v√°rias organiza√ß√µes) poder√£o acess√°-lo.
* **P√∫blico** significa que **toda a internet** poder√° acess√°-lo.

Caso voc√™ saiba o **usu√°rio, reposit√≥rio ou organiza√ß√£o que deseja atacar**, voc√™ pode usar **dorks do Github** para encontrar informa√ß√µes sens√≠veis ou procurar **vazamentos de informa√ß√µes sens√≠veis** **em cada reposit√≥rio**.

### Dorks do Github

O Github permite **pesquisar algo especificando como escopo um usu√°rio, um reposit√≥rio ou uma organiza√ß√£o**. Portanto, com uma lista de strings que v√£o aparecer pr√≥ximas a informa√ß√µes sens√≠veis, voc√™ pode facilmente **procurar por informa√ß√µes sens√≠veis potenciais em seu alvo**.

Ferramentas (cada ferramenta cont√©m sua lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Vazamentos do Github

Por favor, note que as dorks do Github tamb√©m s√£o destinadas a procurar vazamentos usando as op√ß√µes de pesquisa do Github. Esta se√ß√£o √© dedicada √†s ferramentas que ir√£o **baixar cada reposit√≥rio e procurar informa√ß√µes sens√≠veis neles** (at√© mesmo verificando uma certa profundidade de commits).

Ferramentas (cada ferramenta cont√©m sua lista de regexes):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Ao procurar vazamentos em um reposit√≥rio e executar algo como `git log -p`, n√£o se esque√ßa de que pode haver **outras branches com outros commits** contendo segredos!
{% endhint %}

### Forks Externos

√â poss√≠vel **comprometer reposit√≥rios abusando de pull requests**. Para saber se um reposit√≥rio √© vulner√°vel, voc√™ precisa ler principalmente as configura√ß√µes yaml do Github Actions. [**Mais informa√ß√µes sobre isso abaixo**](./#execution-from-a-external-fork).

## Refor√ßo da Organiza√ß√£o

### Privil√©gios dos Membros

Existem alguns **privil√©gios padr√£o** que podem ser atribu√≠dos aos **membros** da organiza√ß√£o. Eles podem ser controlados na p√°gina `https://github.com/organizations/<org_name>/settings/member_privileges` ou pela [**API de Organiza√ß√µes**](https://docs.github.com/en/rest/orgs/orgs).

* **Permiss√µes b√°sicas**: Os membros ter√£o permiss√£o Nenhuma/Leitura/Escrita/Administra√ß√£o sobre os reposit√≥rios da organiza√ß√£o. O recomendado √© **Nenhuma** ou **Leitura**.
* **Fork de reposit√≥rio**: Se n√£o for necess√°rio, √© melhor **n√£o permitir** que os membros fa√ßam fork dos reposit√≥rios da organiza√ß√£o.
* **Cria√ß√£o de p√°ginas**: Se n√£o for necess√°rio, √© melhor **n√£o permitir** que os membros publiquem p√°ginas a partir dos reposit√≥rios da organiza√ß√£o. Se necess√°rio, voc√™ pode permitir a cria√ß√£o de p√°ginas p√∫blicas ou privadas.
* **Solicita√ß√µes de acesso a integra√ß√µes**: Com isso ativado, colaboradores externos poder√£o solicitar acesso para aplicativos do GitHub ou OAuth para acessar esta organiza√ß√£o e seus recursos. Geralmente √© necess√°rio, mas se n√£o for, √© melhor desativ√°-lo.
* _N√£o consegui encontrar essa informa√ß√£o na resposta da API, compartilhe se voc√™ encontrar_
* **Altera√ß√£o de visibilidade do reposit√≥rio**: Se ativado, **membros** com permiss√µes de **administra√ß√£o** para o **reposit√≥rio** poder√£o **alterar sua visibilidade**. Se desativado, apenas os propriet√°rios da organiza√ß√£o podem alterar a visibilidade do reposit√≥rio. Se voc√™ **n√£o** quer que as coisas sejam **p√∫blicas**, certifique-se de que isso est√° **desativado**.
* _N√£o consegui encontrar essa informa√ß√£o na resposta da API, compartilhe se voc√™ encontrar_
* **Exclus√£o e transfer√™ncia de reposit√≥rios**: Se ativado, membros com permiss√µes de **administra√ß√£o** para o reposit√≥rio poder√£o **excluir** ou **transferir** reposit√≥rios **p√∫blicos e privados**.
* _N√£o consegui encontrar essa informa√ß√£o na resposta da API, compartilhe se voc√™ encontrar_
* **Permitir que os membros criem equipes**: Se ativado, qualquer **membro** da organiza√ß√£o poder√° **criar** novas **equipes**. Se desativado, apenas os propriet√°rios da organiza√ß√£o podem criar novas equipes. √â melhor ter isso desativado.
* _N√£o consegui encontrar essa informa√ß√£o na resposta da API, compartilhe se voc√™ encontrar_
* **Mais coisas podem ser configuradas** nesta p√°gina, mas as anteriores s√£o as mais relacionadas √† seguran√ßa.
### Configura√ß√µes de A√ß√µes

V√°rias configura√ß√µes relacionadas √† seguran√ßa podem ser configuradas para a√ß√µes na p√°gina `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Observe que todas essas configura√ß√µes tamb√©m podem ser definidas independentemente em cada reposit√≥rio.
{% endhint %}

* **Pol√≠ticas de a√ß√µes do Github**: Isso permite indicar quais reposit√≥rios podem executar fluxos de trabalho e quais fluxos de trabalho devem ser permitidos. √â recomendado **especificar quais reposit√≥rios** devem ser permitidos e n√£o permitir que todas as a√ß√µes sejam executadas.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Fluxos de trabalho de pull request de fork de colaboradores externos**: √â recomendado **exigir aprova√ß√£o para todos** os colaboradores externos.
* _N√£o encontrei uma API com essas informa√ß√µes, compartilhe se voc√™ encontrar_
* **Executar fluxos de trabalho de pull requests de fork**: √â altamente **desencorajado executar fluxos de trabalho de pull requests** pois os mantenedores da origem do fork ter√£o a capacidade de usar tokens com permiss√µes de leitura no reposit√≥rio de origem.
* _N√£o encontrei uma API com essas informa√ß√µes, compartilhe se voc√™ encontrar_
* **Permiss√µes de fluxo de trabalho**: √â altamente recomendado **dar apenas permiss√µes de leitura do reposit√≥rio**. √â desencorajado dar permiss√µes de escrita e criar/aprovar pull requests para evitar o abuso do GITHUB\_TOKEN fornecido para a execu√ß√£o de fluxos de trabalho.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integra√ß√µes

_Informe-me se voc√™ conhece o endpoint da API para acessar essas informa√ß√µes!_

* **Pol√≠tica de acesso de aplicativos de terceiros**: √â recomendado restringir o acesso a todos os aplicativos e permitir apenas os necess√°rios (ap√≥s revis√£o).
* **Aplicativos do GitHub instalados**: √â recomendado permitir apenas os necess√°rios (ap√≥s revis√£o).

## Reconhecimento e Ataques abusando de credenciais

Para este cen√°rio, vamos supor que voc√™ tenha obtido acesso a uma conta do GitHub.

### Com Credenciais de Usu√°rio

Se voc√™ de alguma forma j√° possui credenciais de um usu√°rio dentro de uma organiza√ß√£o, voc√™ pode **apenas fazer login** e verificar quais **fun√ß√µes de empresa e organiza√ß√£o voc√™ possui**, se voc√™ √© um membro comum, verifique quais **permiss√µes os membros comuns t√™m**, em quais **grupos** voc√™ est√°, quais **permiss√µes voc√™ tem** sobre quais **reposit√≥rios** e **como os reposit√≥rios est√£o protegidos**.

Observe que **a autentica√ß√£o de dois fatores (2FA) pode ser usada**, ent√£o voc√™ s√≥ poder√° acessar essas informa√ß√µes se tamb√©m conseguir **passar por essa verifica√ß√£o**.

{% hint style="info" %}
Observe que se voc√™ **conseguir roubar o cookie `user_session`** (atualmente configurado com SameSite: Lax), voc√™ pode **se passar completamente pelo usu√°rio** sem precisar de credenciais ou 2FA.
{% endhint %}

Verifique a se√ß√£o abaixo sobre [**burlas de prote√ß√£o de branch**](./#branch-protection-bypass) caso seja √∫til.

### Com Chave SSH de Usu√°rio

O Github permite que **usu√°rios** configurem **chaves SSH** que ser√£o usadas como **m√©todo de autentica√ß√£o para implantar c√≥digo** em seu nome (nenhum 2FA √© aplicado).

Com essa chave, voc√™ pode realizar **altera√ß√µes em reposit√≥rios onde o usu√°rio possui algumas permiss√µes**, no entanto, voc√™ n√£o pode us√°-la para acessar a API do GitHub para enumerar o ambiente. No entanto, voc√™ pode **enumerar as configura√ß√µes locais** para obter informa√ß√µes sobre os reposit√≥rios e usu√°rios aos quais voc√™ tem acesso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Se o usu√°rio tiver configurado seu nome de usu√°rio como seu nome de usu√°rio do GitHub, voc√™ pode acessar as **chaves p√∫blicas que ele definiu** em sua conta em _https://github.com/\<github\_username>.keys_, voc√™ pode verificar isso para confirmar se a chave privada que voc√™ encontrou pode ser usada.

As **chaves SSH** tamb√©m podem ser definidas em reposit√≥rios como **chaves de implanta√ß√£o**. Qualquer pessoa com acesso a essa chave poder√° **iniciar projetos a partir de um reposit√≥rio**. Geralmente, em um servidor com diferentes chaves de implanta√ß√£o, o arquivo local **`~/.ssh/config`** fornecer√° informa√ß√µes sobre qual chave est√° relacionada.

#### Chaves GPG

Conforme explicado [**aqui**](broken-reference/), √†s vezes √© necess√°rio assinar os commits ou voc√™ pode ser descoberto.

Verifique localmente se o usu√°rio atual possui alguma chave com:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Com Token de Usu√°rio

Para uma introdu√ß√£o sobre [**Tokens de Usu√°rio, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#personal-access-tokens).

Um token de usu√°rio pode ser usado **em vez de uma senha** para o Git via HTTPS, ou pode ser usado para [**autenticar na API usando Autentica√ß√£o B√°sica**](https://docs.github.com/v3/auth/#basic-authentication). Dependendo dos privil√©gios associados a ele, voc√™ pode ser capaz de realizar diferentes a√ß√µes.

Um token de usu√°rio se parece com isso: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Com Aplicativo Oauth

Para uma introdu√ß√£o sobre [**Aplicativos Oauth do Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#oauth-applications).

Um atacante pode criar um **Aplicativo Oauth malicioso** para acessar dados/a√ß√µes privilegiados dos usu√°rios que os aceitam, provavelmente como parte de uma campanha de phishing.

Esses s√£o os [escopos que um aplicativo Oauth pode solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Sempre verifique os escopos solicitados antes de aceit√°-los.

Al√©m disso, como explicado nas informa√ß√µes b√°sicas, **organiza√ß√µes podem conceder/negar acesso a aplicativos de terceiros** a informa√ß√µes/reposit√≥rios/a√ß√µes relacionadas √† organiza√ß√£o.

### Com Aplicativo Github

Para uma introdu√ß√£o sobre [**Aplicativos Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#github-applications).

Um atacante pode criar um **Aplicativo Github malicioso** para acessar dados/a√ß√µes privilegiados dos usu√°rios que os aceitam, provavelmente como parte de uma campanha de phishing.

Al√©m disso, como explicado nas informa√ß√µes b√°sicas, **organiza√ß√µes podem conceder/negar acesso a aplicativos de terceiros** a informa√ß√µes/reposit√≥rios/a√ß√µes relacionadas √† organiza√ß√£o.

## Comprometendo e Abusando da A√ß√£o do Github

Existem v√°rias t√©cnicas para comprometer e abusar de uma A√ß√£o do Github, verifique-as aqui:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Bypass de Prote√ß√£o de Branch

* **Exigir um n√∫mero de aprova√ß√µes**: Se voc√™ comprometeu v√°rias contas, pode simplesmente aceitar suas PRs de outras contas. Se voc√™ tiver apenas a conta da qual criou a PR, n√£o poder√° aceitar sua pr√≥pria PR. No entanto, se voc√™ tiver acesso a um ambiente de **A√ß√£o do Github** dentro do reposit√≥rio, usando o **GITHUB\_TOKEN**, voc√™ pode ser capaz de **aprovar sua PR** e obter 1 aprova√ß√£o dessa maneira.
* _Observa√ß√£o para esta e para a restri√ß√£o de propriet√°rios de c√≥digo, geralmente um usu√°rio n√£o poder√° aprovar suas pr√≥prias PRs, mas se voc√™ puder, pode abusar disso para aceitar suas PRs._
* **Ignorar aprova√ß√µes quando novos commits s√£o enviados**: Se isso n√£o estiver definido, voc√™ pode enviar c√≥digo leg√≠timo, aguardar at√© que algu√©m aprove, e colocar c√≥digo malicioso e mescl√°-lo no branch protegido.
* **Exigir revis√µes dos propriet√°rios de c√≥digo**: Se isso estiver ativado e voc√™ for um propriet√°rio de c√≥digo, voc√™ pode fazer com que uma **A√ß√£o do Github crie sua PR e, em seguida, a aprove voc√™ mesmo**.
* Quando um **arquivo CODEOWNER est√° mal configurado**, o Github n√£o reclama, mas tamb√©m n√£o o usa. Portanto, se estiver mal configurado, sua **prote√ß√£o de Propriet√°rios de C√≥digo n√£o ser√° aplicada**.
* **Permitir que atores especificados ignorem os requisitos de pull request**: Se voc√™ for um desses atores, poder√° ignorar as prote√ß√µes de pull request.
* **Incluir administradores**: Se isso n√£o estiver definido e voc√™ for administrador do reposit√≥rio, poder√° ignorar essas prote√ß√µes de branch.
* **Sequestro de PR**: Voc√™ pode ser capaz de **modificar a PR de outra pessoa** adicionando c√≥digo malicioso, aprovando a PR resultante voc√™ mesmo e mesclando tudo.
* **Removendo Prote√ß√µes de Branch**: Se voc√™ for um **administrador do reposit√≥rio, pode desativar as prote√ß√µes**, mesclar sua PR e redefinir as prote√ß√µes.
* **Burlando prote√ß√µes de push**: Se um reposit√≥rio **permite apenas que determinados usu√°rios** enviem push (mesclar c√≥digo) nos branches (a prote√ß√£o de branch pode estar protegendo todos os branches especificando o caractere curinga `*`).
* Se voc√™ tiver **acesso de grava√ß√£o ao reposit√≥rio, mas n√£o tiver permiss√£o para enviar c√≥digo** por causa da prote√ß√£o de branch, ainda poder√° **criar um novo branch** e dentro dele criar uma **a√ß√£o do github que √© acionada quando o c√≥digo √© enviado**. Como a **prote√ß√£o de branch n√£o proteger√° o branch at√© que ele seja criado**, esse primeiro envio de c√≥digo para o branch ir√° **executar a a√ß√£o do github**.

## Burlando Prote√ß√µes de Ambientes

Para uma introdu√ß√£o sobre [**Ambientes do Github, verifique as informa√ß√µes b√°sicas**](basic-github-information.md#git-environments).

Caso um ambiente possa ser **acessado de todos os branches**, ele **n√£o est√° protegido** e voc√™ pode acessar facilmente os segredos dentro do ambiente. Observe que voc√™ pode encontrar reposit√≥rios onde **todos os branches est√£o protegidos** (especificando seus nomes ou usando `*`) nesse cen√°rio, **encontre um branch onde voc√™ possa enviar c√≥digo** e voc√™ pode **extrair** os segredos criando uma nova a√ß√£o do github (ou modificando uma).

Observe que voc√™ pode encontrar o caso extremo em que **todos os branches est√£o protegidos** (via caractere curinga `*`) e √© especificado **quem pode enviar c√≥digo para os branches** (_voc√™ pode especificar isso na prote√ß√£o de branch_) e **seu usu√°rio n√£o tem permiss√£o**. Ainda √© poss√≠vel executar uma a√ß√£o personalizada do github porque voc√™ pode criar um branch e usar o gatilho de envio sobre si mesmo. A **prote√ß√£o de branch permite o envio para um novo branch, ent√£o a a√ß√£o do github ser√° acionada**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Note que **ap√≥s a cria√ß√£o** do branch, a **prote√ß√£o do branch ser√° aplicada ao novo branch** e voc√™ n√£o poder√° modific√°-lo, mas nesse momento voc√™ j√° ter√° extra√≠do as informa√ß√µes sigilosas.

## Persist√™ncia

* Gerar **token de usu√°rio**
* Roubar **tokens do Github** de **secrets**
* **Excluir** resultados de fluxo de trabalho e branches
* Dar **mais permiss√µes a toda a organiza√ß√£o**
* Criar **webhooks** para exfiltrar informa√ß√µes
* Convidar **colaboradores externos**
* **Remover** **webhooks** usados pelo **SIEM**
* Criar/modificar **Github Action** com uma **porta dos fundos**
* Encontrar **Github Action vulner√°vel para inje√ß√£o de comando** atrav√©s da modifica√ß√£o do valor do **secret**

### Commits Falsos - Porta dos fundos atrav√©s de commits no reposit√≥rio

No Github, √© poss√≠vel **criar um PR para um reposit√≥rio a partir de um fork**. Mesmo que o PR n√£o seja **aceito**, um ID de **commit** dentro do reposit√≥rio original ser√° criado para a vers√£o do c√≥digo do fork. Portanto, um atacante **poderia usar um commit espec√≠fico de um reposit√≥rio aparentemente leg√≠timo que n√£o foi criado pelo propriet√°rio do reposit√≥rio**.

Como [**este**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Para mais informa√ß√µes, verifique [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
