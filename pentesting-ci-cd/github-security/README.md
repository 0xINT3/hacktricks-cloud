# Seguridad en Github

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Qu√© es Github

(De [aqu√≠](https://kinsta.com/knowledgebase/what-is-github/)) A un nivel alto, **Github es un sitio web y servicio basado en la nube que ayuda a los desarrolladores a almacenar y gestionar su c√≥digo, as√≠ como a rastrear y controlar los cambios en su c√≥digo**.

### Informaci√≥n B√°sica

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconocimiento Externo

Los repositorios de Github pueden configurarse como p√∫blicos, privados e internos.

* **Privado** significa que **solo** las personas de la **organizaci√≥n** podr√°n acceder a ellos.
* **Interno** significa que **solo** las personas de la **empresa** (una empresa puede tener varias organizaciones) podr√°n acceder a √©l.
* **P√∫blico** significa que **todo internet** podr√° acceder a √©l.

En caso de que conozcas el **usuario, repositorio u organizaci√≥n que quieres atacar**, puedes usar **github dorks** para encontrar informaci√≥n sensible o buscar **fugas de informaci√≥n sensible** **en cada repositorio**.

### Github Dorks

Github permite **buscar algo especificando como √°mbito un usuario, un repositorio o una organizaci√≥n**. Por lo tanto, con una lista de cadenas que van a aparecer cerca de informaci√≥n sensible, puedes f√°cilmente **buscar informaci√≥n sensible potencial en tu objetivo**.

Herramientas (cada herramienta contiene su lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de Dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de Dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de Dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Fugas en Github

Por favor, ten en cuenta que los github dorks tambi√©n est√°n destinados a buscar fugas utilizando las opciones de b√∫squeda de github. Esta secci√≥n est√° dedicada a aquellas herramientas que **descargar√°n cada repositorio y buscar√°n informaci√≥n sensible en ellos** (incluso comprobando cierta profundidad de commits).

Herramientas (cada herramienta contiene su lista de expresiones regulares):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Cuando busques fugas en un repositorio y ejecutes algo como `git log -p`, no olvides que puede haber **otras ramas con otros commits** que contengan secretos.
{% endhint %}

### Forks Externos

Es posible **comprometer repositorios abusando de las pull requests**. Para saber si un repositorio es vulnerable, principalmente necesitas leer las configuraciones yaml de Github Actions. [**M√°s informaci√≥n sobre esto a continuaci√≥n**](./#execution-from-a-external-fork).

## Fortalecimiento de la Organizaci√≥n

### Privilegios de los Miembros

Hay algunos **privilegios predeterminados** que se pueden asignar a los **miembros** de la organizaci√≥n. Estos se pueden controlar desde la p√°gina `https://github.com/organizations/<org_name>/settings/member_privileges` o desde la [**API de Organizaciones**](https://docs.github.com/en/rest/orgs/orgs).

* **Permisos base**: Los miembros tendr√°n el permiso Ninguno/Lectura/Escritura/Admin sobre los repositorios de la org. Se recomienda **Ninguno** o **Lectura**.
* **Forking de repositorios**: Si no es necesario, es mejor **no permitir** a los miembros hacer fork de los repositorios de la organizaci√≥n.
* **Creaci√≥n de p√°ginas**: Si no es necesario, es mejor **no permitir** a los miembros publicar p√°ginas desde los repos de la org. Si es necesario, puedes permitir crear p√°ginas p√∫blicas o privadas.
* **Solicitudes de acceso a integraciones**: Con esto habilitado, los colaboradores externos podr√°n solicitar acceso para aplicaciones de GitHub o OAuth para acceder a esta organizaci√≥n y sus recursos. Por lo general, es necesario, pero si no, es mejor deshabilitarlo.
* _No pude encontrar esta informaci√≥n en la respuesta de las APIs, comparte si t√∫ s√≠_
* **Cambio de visibilidad del repositorio**: Si est√° habilitado, los **miembros** con permisos de **admin** para el **repositorio** podr√°n **cambiar su visibilidad**. Si est√° deshabilitado, solo los propietarios de la organizaci√≥n pueden cambiar las visibilidades de los repositorios. Si **no** quieres que la gente haga cosas **p√∫blicas**, aseg√∫rate de que esto est√© **deshabilitado**.
* _No pude encontrar esta informaci√≥n en la respuesta de las APIs, comparte si t√∫ s√≠_
* **Eliminaci√≥n y transferencia de repositorios**: Si est√° habilitado, los miembros con permisos de **admin** para el repositorio podr√°n **eliminar** o **transferir** repositorios **p√∫blicos y privados**.
* _No pude encontrar esta informaci√≥n en la respuesta de las APIs, comparte si t√∫ s√≠_
* **Permitir a los miembros crear equipos**: Si est√° habilitado, cualquier **miembro** de la organizaci√≥n podr√° **crear** nuevos **equipos**. Si est√° deshabilitado, solo los propietarios de la organizaci√≥n pueden crear nuevos equipos. Es mejor tener esto deshabilitado.
* _No pude encontrar esta informaci√≥n en la respuesta de las APIs, comparte si t√∫ s√≠_
* **Se pueden configurar m√°s cosas** en esta p√°gina, pero las anteriores son las m√°s relacionadas con la seguridad.
### Configuraciones de Actions

Varias configuraciones relacionadas con la seguridad pueden ser configuradas para actions desde la p√°gina `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Nota que todas estas configuraciones tambi√©n pueden ser establecidas en cada repositorio de manera independiente.
{% endhint %}

* **Pol√≠ticas de Github actions**: Te permite indicar qu√© repositorios pueden ejecutar workflows y qu√© workflows deben ser permitidos. Se recomienda **especificar qu√© repositorios** deben ser permitidos y no permitir que todas las actions se ejecuten.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Workflows de pull request de forks por colaboradores externos**: Se recomienda **requerir aprobaci√≥n para todos** los colaboradores externos.
* _No pude encontrar una API con esta informaci√≥n, comparte si la tienes_
* **Ejecutar workflows de pull requests de forks**: Es **altamente desaconsejado ejecutar workflows de pull requests** ya que los mantenedores del fork original se les dar√° la capacidad de usar tokens con permisos de lectura en el repositorio fuente.
* _No pude encontrar una API con esta informaci√≥n, comparte si la tienes_
* **Permisos de workflow**: Es altamente recomendado **dar solo permisos de lectura al repositorio**. Se desaconseja dar permisos de escritura y crear/aprobar pull requests para evitar el abuso del GITHUB\_TOKEN otorgado a los workflows en ejecuci√≥n.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integraciones

_¬°Hazme saber si conoces el punto de acceso API para esta informaci√≥n!_

* **Pol√≠tica de acceso a aplicaciones de terceros**: Se recomienda restringir el acceso a cada aplicaci√≥n y permitir solo las necesarias (despu√©s de revisarlas).
* **GitHub Apps instaladas**: Se recomienda permitir solo las necesarias (despu√©s de revisarlas).

## Reconocimiento y Ataques abusando de credenciales

Para este escenario vamos a suponer que has obtenido alg√∫n acceso a una cuenta de github.

### Con Credenciales de Usuario

Si de alguna manera ya tienes credenciales para un usuario dentro de una organizaci√≥n puedes **simplemente iniciar sesi√≥n** y verificar qu√© **roles de empresa y organizaci√≥n tienes**, si eres un miembro b√°sico, verifica qu√© **permisos tienen los miembros b√°sicos**, en qu√© **grupos** est√°s, qu√© **permisos tienes** sobre qu√© **repos,** y **c√≥mo est√°n protegidos los repos.**

Nota que **puede usarse 2FA** por lo que solo podr√°s acceder a esta informaci√≥n si tambi√©n puedes **superar esa verificaci√≥n**.

{% hint style="info" %}
Nota que si logras **robar la cookie `user_session`** (actualmente configurada con SameSite: Lax) puedes **impersonar completamente al usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

Revisa la secci√≥n de abajo sobre [**bypass de protecciones de branch**](./#branch-protection-bypass) en caso de que sea √∫til.

### Con Clave SSH de Usuario

Github permite a los **usuarios** configurar **claves SSH** que ser√°n usadas como **m√©todo de autenticaci√≥n para desplegar c√≥digo** en su nombre (no se aplica 2FA).

Con esta clave puedes realizar **cambios en repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la API de github para enumerar el entorno. No obstante, puedes **enumerar configuraciones locales** para obtener informaci√≥n sobre los repos y el usuario al que tienes acceso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si el usuario ha configurado su nombre de usuario como su nombre de usuario de github, puedes acceder a las **claves p√∫blicas que ha establecido** en su cuenta en _https://github.com/\<github\_username>.keys_, podr√≠as verificar esto para confirmar que la clave privada que encontraste se puede utilizar.

Las **claves SSH** tambi√©n pueden configurarse en los repositorios como **claves de despliegue**. Cualquiera con acceso a esta clave podr√° **lanzar proyectos desde un repositorio**. Usualmente en un servidor con diferentes claves de despliegue, el archivo local **`~/.ssh/config`** te dar√° informaci√≥n sobre qu√© clave est√° relacionada.

#### Claves GPG

Como se explica [**aqu√≠**](broken-reference/) a veces es necesario firmar los commits o podr√≠as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token de Usuario

Para una introducci√≥n sobre [**Tokens de Usuario consulta la informaci√≥n b√°sica**](basic-github-information.md#personal-access-tokens).

Un token de usuario puede ser utilizado **en lugar de una contrase√±a** para Git sobre HTTPS, o puede ser usado para [**autenticarse en la API mediante Autenticaci√≥n B√°sica**](https://docs.github.com/v3/auth/#basic-authentication). Dependiendo de los privilegios asociados, podr√≠as ser capaz de realizar diferentes acciones.

Un token de usuario se ve as√≠: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Con Aplicaci√≥n Oauth

Para una introducci√≥n sobre [**Aplicaciones Oauth de Github consulta la informaci√≥n b√°sica**](basic-github-information.md#oauth-applications).

Un atacante podr√≠a crear una **Aplicaci√≥n Oauth maliciosa** para acceder a datos/acciones privilegiadas de los usuarios que las acepten, probablemente como parte de una campa√±a de phishing.

Estos son los [alcances que una aplicaci√≥n Oauth puede solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Siempre se debe verificar los alcances solicitados antes de aceptarlos.

Adem√°s, como se explica en la informaci√≥n b√°sica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a informaci√≥n/repositorios/acciones relacionadas con la organizaci√≥n.

### Con Aplicaci√≥n de Github

Para una introducci√≥n sobre [**Aplicaciones de Github consulta la informaci√≥n b√°sica**](basic-github-information.md#github-applications).

Un atacante podr√≠a crear una **Aplicaci√≥n de Github maliciosa** para acceder a datos/acciones privilegiadas de los usuarios que las acepten, probablemente como parte de una campa√±a de phishing.

Adem√°s, como se explica en la informaci√≥n b√°sica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a informaci√≥n/repositorios/acciones relacionadas con la organizaci√≥n.

## Comprometer y Abusar de Github Action

Hay varias t√©cnicas para comprometer y abusar de una Github Action, rev√≠salas aqu√≠:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Eludir la Protecci√≥n de Ramas

* **Requerir un n√∫mero de aprobaciones**: Si has comprometido varias cuentas, podr√≠as simplemente aceptar tus PR desde otras cuentas. Si solo tienes la cuenta desde donde creaste el PR, no puedes aceptar tu propio PR. Sin embargo, si tienes acceso a un entorno de **Github Action** dentro del repositorio, utilizando el **GITHUB\_TOKEN** podr√≠as ser capaz de **aprobar tu PR** y obtener 1 aprobaci√≥n de esta manera.
* _Nota para esto y para la restricci√≥n de Propietarios de C√≥digo que usualmente un usuario no podr√° aprobar sus propios PRs, pero si puedes, puedes abusar de ello para aceptar tus PRs._
* **Descartar aprobaciones cuando se env√≠an nuevos commits**: Si esto no est√° configurado, puedes enviar c√≥digo leg√≠timo, esperar a que alguien lo apruebe, y luego agregar c√≥digo malicioso y fusionarlo en la rama protegida.
* **Requerir revisiones de Propietarios de C√≥digo**: Si esto est√° activado y eres un Propietario de C√≥digo, podr√≠as hacer que una **Github Action cree tu PR y luego aprobarlo t√∫ mismo**.
* Cuando un archivo **CODEOWNER est√° mal configurado** Github no se queja pero no lo utiliza. Por lo tanto, si est√° mal configurado, su protecci√≥n de **Propietarios de C√≥digo no se aplica**.
* **Permitir a actores especificados eludir los requisitos de pull request**: Si eres uno de estos actores puedes eludir las protecciones de pull request.
* **Incluir administradores**: Si esto no est√° configurado y eres administrador del repositorio, puedes eludir estas protecciones de rama.
* **Secuestro de PR**: Podr√≠as ser capaz de **modificar el PR de alguien m√°s** agregando c√≥digo malicioso, aprobando el PR resultante t√∫ mismo y fusionando todo.
* **Eliminar Protecciones de Rama**: Si eres un **administrador del repositorio puedes desactivar las protecciones**, fusionar tu PR y volver a establecer las protecciones.
* **Eludir protecciones de push**: Si un repositorio **solo permite a ciertos usuarios** enviar push (fusionar c√≥digo) en ramas (la protecci√≥n de rama podr√≠a estar protegiendo todas las ramas especificando el comod√≠n `*`).
* Si tienes **acceso de escritura sobre el repositorio pero no te est√° permitido enviar c√≥digo** debido a la protecci√≥n de rama, a√∫n puedes **crear una nueva rama** y dentro de ella crear una **github action que se active cuando se env√≠a c√≥digo**. Como la **protecci√≥n de rama no proteger√° la rama hasta que se cree**, este primer env√≠o de c√≥digo a la rama **ejecutar√° la github action**.

## Eludir Protecciones de Entornos

Para una introducci√≥n sobre [**Entornos de Github consulta la informaci√≥n b√°sica**](basic-github-information.md#git-environments).

En caso de que un entorno pueda ser **accedido desde todas las ramas**, **no est√° protegido** y puedes acceder f√°cilmente a los secretos dentro del entorno. Ten en cuenta que podr√≠as encontrar repositorios donde **todas las ramas est√°n protegidas** (especificando sus nombres o usando `*`) en ese escenario, **encuentra una rama donde puedas enviar c√≥digo** y puedes **exfiltrar** los secretos creando una nueva github action (o modificando una).

Nota que podr√≠as encontrar el caso l√≠mite donde **todas las ramas est√°n protegidas** (v√≠a comod√≠n `*`) se especifica **qui√©n puede enviar c√≥digo a las ramas** (_puedes especificar eso en la protecci√≥n de rama_) y **tu usuario no est√° permitido**. A√∫n puedes ejecutar una github action personalizada porque puedes crear una rama y usar el disparador de push sobre s√≠ misma. La **protecci√≥n de rama permite el push a una nueva rama por lo que la github action se activar√°**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Tenga en cuenta que **despu√©s de la creaci√≥n** de la rama, la **protecci√≥n de la rama se aplicar√° a la nueva rama** y no podr√° modificarla, pero para ese momento ya habr√° extra√≠do los secretos.

## Persistencia

* Generar **token de usuario**
* Robar **tokens de github** de **secrets**
* **Eliminaci√≥n** de **resultados** de workflow y **ramas**
* Dar **m√°s permisos a toda la org**
* Crear **webhooks** para exfiltrar informaci√≥n
* Invitar **colaboradores externos**
* **Eliminar** **webhooks** utilizados por el **SIEM**
* Crear/modificar **Github Action** con una **puerta trasera**
* Encontrar **Github Action vulnerable a inyecci√≥n de comandos** a trav√©s de la modificaci√≥n del valor de **secret**

### Imposter Commits - Puerta trasera a trav√©s de commits en el repositorio

En Github es posible **crear un PR a un repositorio desde un fork**. Incluso si el PR **no es aceptado**, se crear√° un id de **commit** dentro del repositorio original para la versi√≥n del c√≥digo del fork. Por lo tanto, un atacante **podr√≠a fijar el uso de un commit espec√≠fico de un repositorio aparentemente leg√≠timo que no fue creado por el propietario del repositorio**.

Como [**esto**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Para m√°s informaci√≥n, consulta [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
