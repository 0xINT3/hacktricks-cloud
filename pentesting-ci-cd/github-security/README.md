# Seguridad en Github

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en Github.

</details>

## ¿Qué es Github?

(De [aquí](https://kinsta.com/knowledgebase/what-is-github/)) A grandes rasgos, **Github es un sitio web y un servicio basado en la nube que ayuda a los desarrolladores a almacenar y gestionar su código, así como a realizar un seguimiento y controlar los cambios en su código**.

### Información básica

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconocimiento externo

Los repositorios de Github pueden configurarse como públicos, privados e internos.

* **Privado** significa que solo las personas de la **organización** podrán acceder a ellos.
* **Interno** significa que solo las personas de la **empresa** (una empresa puede tener varias organizaciones) podrán acceder a él.
* **Público** significa que **todo Internet** podrá acceder a él.

En caso de que conozcas el **usuario, repositorio u organización que deseas atacar**, puedes utilizar **dorks de Github** para encontrar información sensible o buscar **filtraciones de información sensible en cada repositorio**.

### Dorks de Github

Github permite **buscar algo especificando como alcance un usuario, un repositorio o una organización**. Por lo tanto, con una lista de cadenas que van a aparecer cerca de información sensible, puedes buscar fácilmente información sensible potencial en tu objetivo.

Herramientas (cada herramienta contiene su lista de dorks):

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Lista de dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Lista de dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Lista de dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Filtraciones de Github

Ten en cuenta que los dorks de Github también se utilizan para buscar filtraciones utilizando las opciones de búsqueda de Github. Esta sección está dedicada a las herramientas que **descargarán cada repositorio y buscarán información sensible en ellos** (incluso verificando cierta profundidad de commits).

Herramientas (cada herramienta contiene su lista de expresiones regulares):

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Cuando busques filtraciones en un repositorio y ejecutes algo como `git log -p`, ¡no olvides que puede haber **otras ramas con otros commits** que contengan secretos!
{% endhint %}

### Forks externos

Es posible **comprometer repositorios abusando de las solicitudes de extracción**. Para saber si un repositorio es vulnerable, en su mayoría necesitas leer las configuraciones yaml de las acciones de Github. [**Más información sobre esto a continuación**](./#execution-from-a-external-fork).

## Fortalecimiento de la organización

### Privilegios de los miembros

Existen algunos **privilegios predeterminados** que se pueden asignar a los **miembros** de la organización. Estos se pueden controlar desde la página `https://github.com/organizations/<org_name>/settings/member_privileges` o desde la [**API de Organizaciones**](https://docs.github.com/en/rest/orgs/orgs).

* **Permisos base**: Los miembros tendrán los permisos Ninguno/Lectura/Escritura/Administrador sobre los repositorios de la organización. Se recomienda utilizar **Ninguno** o **Lectura**.
* **Creación de repositorios bifurcados**: Si no es necesario, es mejor **no permitir** a los miembros bifurcar los repositorios de la organización.
* **Creación de páginas**: Si no es necesario, es mejor **no permitir** a los miembros publicar páginas desde los repositorios de la organización. Si es necesario, puedes permitir crear páginas públicas o privadas.
* **Solicitudes de acceso a integraciones**: Con esto habilitado, los colaboradores externos podrán solicitar acceso a aplicaciones de GitHub o OAuth para acceder a esta organización y sus recursos. Por lo general, es necesario, pero si no lo es, es mejor deshabilitarlo.
* _No pude encontrar esta información en la respuesta de las APIs, compártela si la encuentras_
* **Cambio de visibilidad del repositorio**: Si está habilitado, los **miembros** con permisos de **administrador** para el **repositorio** podrán **cambiar su visibilidad**. Si está deshabilitado, solo los propietarios de la organización pueden cambiar la visibilidad de los repositorios. Si **no** quieres que las personas hagan cosas **públicas**, asegúrate de que esto esté **deshabilitado**.
* _No pude encontrar esta información en la respuesta de las APIs, compártela si la encuentras_
* **Eliminación y transferencia de repositorios**: Si está habilitado, los miembros con permisos de **administrador** para el repositorio podrán **eliminar** o **transferir** repositorios **públicos** y **privados**.
* _No pude encontrar esta información en la respuesta de las APIs, compártela si la encuentras_
* **Permitir a los miembros crear equipos**: Si está habilitado, cualquier **miembro** de la organización podrá **crear** nuevos **equipos**. Si está deshabilitado, solo los propietarios de la organización pueden crear nuevos equipos. Es mejor tener esto deshabilitado.
* _No pude encontrar esta información en la respuesta de las APIs, compártela si la encuentras_
* **Se pueden configurar más cosas** en esta página, pero las anteriores son las más relacionadas con la seguridad.
### Configuración de acciones

Se pueden configurar varias opciones relacionadas con la seguridad para las acciones desde la página `https://github.com/organizations/<org_name>/settings/actions`.

{% hint style="info" %}
Ten en cuenta que todas estas configuraciones también se pueden establecer en cada repositorio de forma independiente.
{% endhint %}

* **Políticas de acciones de Github**: Te permite indicar qué repositorios pueden ejecutar flujos de trabajo y qué flujos de trabajo deben permitirse. Se recomienda **especificar qué repositorios** deben permitirse y no permitir que se ejecuten todas las acciones.
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **Flujos de trabajo de solicitudes de extracción de bifurcación de colaboradores externos**: Se recomienda **requerir aprobación para todos** los colaboradores externos.
* _No pude encontrar una API con esta información, compártela si la encuentras_
* **Ejecutar flujos de trabajo desde solicitudes de extracción de bifurcación**: Se desaconseja encarecidamente **ejecutar flujos de trabajo desde solicitudes de extracción** ya que los mantenedores del origen de la bifurcación podrán utilizar tokens con permisos de lectura en el repositorio fuente.
* _No pude encontrar una API con esta información, compártela si la encuentras_
* **Permisos de flujo de trabajo**: Se recomienda encarecidamente **solo dar permisos de lectura del repositorio**. Se desaconseja dar permisos de escritura y crear/aprobar solicitudes de extracción para evitar el abuso del GITHUB\_TOKEN otorgado a los flujos de trabajo en ejecución.
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### Integraciones

_¡Avísame si conoces el punto final de la API para acceder a esta información!_

* **Política de acceso de aplicaciones de terceros**: Se recomienda restringir el acceso a todas las aplicaciones y permitir solo las necesarias (después de revisarlas).
* **Aplicaciones de GitHub instaladas**: Se recomienda permitir solo las necesarias (después de revisarlas).

## Reconocimiento y ataques abusando de credenciales

Para este escenario, supongamos que has obtenido acceso a una cuenta de GitHub.

### Con credenciales de usuario

Si de alguna manera ya tienes las credenciales de un usuario dentro de una organización, simplemente puedes **iniciar sesión** y verificar qué **roles de empresa y organización tienes**, si eres un miembro normal, verifica qué **permisos tienen los miembros normales**, en qué **grupos** estás, qué **permisos tienes** sobre qué **repositorios** y **cómo están protegidos los repositorios**.

Ten en cuenta que se puede utilizar **autenticación de dos factores (2FA)**, por lo que solo podrás acceder a esta información si también puedes **superar esa verificación**.

{% hint style="info" %}
Ten en cuenta que si logras robar la cookie `user_session` (actualmente configurada con SameSite: Lax), puedes **hacerte pasar completamente por el usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

Consulta la sección a continuación sobre [**bypass de protecciones de rama**](./#bypass-de-protecciones-de-rama) en caso de que sea útil.

### Con clave SSH de usuario

Github permite a los **usuarios** configurar **claves SSH** que se utilizarán como **método de autenticación para implementar código** en su nombre (no se aplica 2FA).

Con esta clave, puedes realizar **cambios en los repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la API de GitHub para enumerar el entorno. Sin embargo, puedes **enumerar la configuración local** para obtener información sobre los repositorios y el usuario a los que tienes acceso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si el usuario ha configurado su nombre de usuario como su nombre de usuario de GitHub, puedes acceder a las **claves públicas que ha configurado** en su cuenta en _https://github.com/\<github\_username>.keys_, puedes verificar esto para confirmar que la clave privada que encontraste se puede utilizar.

Las **claves SSH** también se pueden configurar en los repositorios como **claves de implementación**. Cualquier persona con acceso a esta clave podrá **lanzar proyectos desde un repositorio**. Por lo general, en un servidor con diferentes claves de implementación, el archivo local **`~/.ssh/config`** te dará información sobre qué clave está relacionada.

#### Claves GPG

Como se explica [**aquí**](broken-reference/), a veces es necesario firmar los commits o podrías ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token de Usuario

Para obtener una introducción sobre [**Tokens de Usuario, consulta la información básica**](basic-github-information.md#personal-access-tokens).

Un token de usuario se puede utilizar **en lugar de una contraseña** para Git a través de HTTPS, o se puede utilizar para [**autenticarse en la API mediante autenticación básica**](https://docs.github.com/v3/auth/#basic-authentication). Dependiendo de los privilegios asociados a él, es posible realizar diferentes acciones.

Un token de usuario se ve así: `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Con Aplicación Oauth

Para obtener una introducción sobre [**Aplicaciones Oauth de Github, consulta la información básica**](basic-github-information.md#oauth-applications).

Un atacante podría crear una **Aplicación Oauth maliciosa** para acceder a datos/acciones privilegiados de los usuarios que los acepten, probablemente como parte de una campaña de phishing.

Estos son los [alcances que una aplicación Oauth puede solicitar](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Siempre se debe verificar los alcances solicitados antes de aceptarlos.

Además, como se explica en la información básica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a información/repositorios/acciones relacionadas con la organización.

### Con Aplicación de Github

Para obtener una introducción sobre [**Aplicaciones de Github, consulta la información básica**](basic-github-information.md#github-applications).

Un atacante podría crear una **Aplicación de Github maliciosa** para acceder a datos/acciones privilegiados de los usuarios que los acepten, probablemente como parte de una campaña de phishing.

Además, como se explica en la información básica, **las organizaciones pueden otorgar/denegar acceso a aplicaciones de terceros** a información/repositorios/acciones relacionadas con la organización.

## Compromiso y Abuso de Acciones de Github

Existen varias técnicas para comprometer y abusar de una Acción de Github, revísalas aquí:

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## Bypass de Protección de Ramas

* **Requerir un número de aprobaciones**: Si comprometes varias cuentas, puedes aceptar tus PR desde otras cuentas. Si solo tienes acceso a la cuenta desde la cual creaste el PR, no puedes aceptar tu propio PR. Sin embargo, si tienes acceso a un entorno de **Acción de Github** dentro del repositorio, utilizando el **GITHUB\_TOKEN**, es posible **aprobar tu PR** y obtener una aprobación de esta manera.
* _Nota para esto y para la restricción de Propietarios de Código, por lo general un usuario no podrá aprobar sus propios PR, pero si puedes, puedes abusar de ello para aceptar tus PR._
* **Descartar aprobaciones cuando se envían nuevos commits**: Si esto no está configurado, puedes enviar código legítimo, esperar a que alguien lo apruebe y luego agregar código malicioso y fusionarlo en la rama protegida.
* **Requerir revisiones de los Propietarios de Código**: Si esto está activado y eres un Propietario de Código, podrías hacer que una **Acción de Github cree tu PR y luego lo apruebes tú mismo**.
* Cuando un archivo **CODEOWNER está mal configurado**, Github no se queja pero no lo utiliza. Por lo tanto, si está mal configurado, su **protección de Propietarios de Código no se aplica**.
* **Permitir que actores especificados eviten los requisitos de pull request**: Si eres uno de estos actores, puedes evitar las protecciones de pull request.
* **Incluir administradores**: Si esto no está configurado y eres administrador del repositorio, puedes evitar estas protecciones de rama.
* **Secuestro de PR**: Podrías ser capaz de **modificar el PR de otra persona** agregando código malicioso, aprobando el PR resultante tú mismo y fusionando todo.
* **Eliminar Protecciones de Rama**: Si eres un **administrador del repositorio, puedes desactivar las protecciones**, fusionar tu PR y restablecer las protecciones.
* **Bypass de protecciones de push**: Si un repositorio **solo permite que ciertos usuarios** envíen push (fusionar código) en ramas (la protección de rama podría estar protegiendo todas las ramas especificando el comodín `*`).
* Si tienes **permisos de escritura en el repositorio pero no se te permite enviar código** debido a la protección de rama, aún puedes **crear una nueva rama** y dentro de ella crear una **acción de Github que se active cuando se envía código**. Como la **protección de rama no protegerá la rama hasta que se cree**, este primer envío de código a la rama **ejecutará la acción de Github**.

## Bypass de Protecciones de Entornos

Para obtener una introducción sobre [**Entornos de Github, consulta la información básica**](basic-github-information.md#git-environments).

En caso de que se pueda **acceder a un entorno desde todas las ramas**, no está **protegido** y puedes acceder fácilmente a los secretos dentro del entorno. Ten en cuenta que es posible encontrar repositorios donde **todas las ramas están protegidas** (especificando sus nombres o utilizando `*`), en ese escenario, **encuentra una rama donde puedas enviar código** y puedes **filtrar** los secretos creando una nueva acción de Github (o modificando una existente).

Ten en cuenta que podrías encontrar el caso especial donde **todas las ramas están protegidas** (mediante el comodín `*`) y se especifica **quién puede enviar código a las ramas** (_puedes especificarlo en la protección de la rama_) y **tu usuario no está permitido**. Aún puedes ejecutar una acción personalizada de Github porque puedes crear una rama y usar el disparador de envío sobre sí misma. La **protección de rama permite el envío a una nueva rama, por lo que se activará la acción de Github**.
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
Ten en cuenta que **después de la creación** de la rama, la **protección de la rama se aplicará a la nueva rama** y no podrás modificarla, pero para ese momento ya habrás filtrado las contraseñas.

## Persistencia

* Generar **token de usuario**
* Robar **tokens de Github** de **secretos**
* **Eliminar** los **resultados** y las **ramas** del flujo de trabajo
* Dar **más permisos a toda la organización**
* Crear **webhooks** para exfiltrar información
* Invitar a **colaboradores externos**
* **Eliminar** los **webhooks** utilizados por el **SIEM**
* Crear/modificar una **Acción de Github** con una **puerta trasera**
* Encontrar una **Acción de Github vulnerable a la inyección de comandos** mediante la modificación del valor del **secreto**

### Commits de impostores - Puerta trasera a través de commits del repositorio

En Github es posible **crear una solicitud de extracción (PR) a un repositorio desde un fork**. Incluso si la PR no es **aceptada**, se creará un identificador de **commit** en el repositorio original para la versión del código del fork. Por lo tanto, un atacante **podría fijarse en utilizar un commit específico de un repositorio aparentemente legítimo que no fue creado por el propietario del repositorio**.

Como [**este**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
Para obtener más información, consulta [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si deseas ver tu **empresa anunciada en HackTricks** o si deseas acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
