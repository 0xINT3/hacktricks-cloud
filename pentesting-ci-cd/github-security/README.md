# Github 安全性

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 什么是 Github

(来自[这里](https://kinsta.com/knowledgebase/what-is-github/)) 从高层次来看，**GitHub 是一个网站和基于云的服务，帮助开发者存储和管理他们的代码，以及跟踪和控制代码的变更**。

### 基本信息

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 外部侦察

Github 仓库可以配置为公开、私有和内部。

* **私有**意味着**只有**该**组织**的人才能访问它们
* **内部**意味着**只有**该**企业**（一个企业可能有多个组织）的人才能访问它
* **公开**意味着**所有互联网**都将能够访问它。

如果您知道您想要针对的**用户、仓库或组织**，您可以使用**github dorks**来查找敏感信息或在**每个仓库**中搜索**敏感信息泄露**。

### Github Dorks

Github 允许**指定用户、仓库或组织作为范围来搜索某些内容**。因此，通过一系列可能出现在敏感信息附近的字符串列表，您可以轻松地**在目标中搜索潜在的敏感信息**。

工具（每个工具包含其 dorks 列表）：

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Dorks 列表](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Dorks 列表](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Dorks 列表](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github 泄露

请注意，github dorks 也旨在使用 github 搜索选项来搜索泄露。本节专门介绍那些将**下载每个仓库并在其中搜索敏感信息**的工具（甚至检查某些提交的深度）。

工具（每个工具包含其正则表达式列表）：

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
当您在仓库中寻找泄露并运行类似 `git log -p` 的命令时，不要忘记可能有**其他分支包含其他提交**含有秘密信息！
{% endhint %}

### 外部 Forks

通过滥用拉取请求，有可能**危害仓库**。要知道一个仓库是否容易受到攻击，您主要需要阅读 Github Actions yaml 配置。[**更多信息在下面**](./#execution-from-a-external-fork)。

## 组织加固

### 成员权限

组织的**成员**可以被分配一些**默认权限**。这些可以从页面 `https://github.com/organizations/<org_name>/settings/member_privileges` 或 [**组织 API**](https://docs.github.com/en/rest/orgs/orgs) 控制。

* **基本权限**：成员将拥有对组织仓库的 None/Read/write/Admin 权限。推荐是**None**或**Read**。
* **仓库 Forking**：如果不必要，最好**不允许**成员 Fork 组织仓库。
* **页面创建**：如果不必要，最好**不允许**成员从组织仓库发布页面。如果必要，您可以允许创建公共或私有页面。
* **集成访问请求**：启用此功能后，外部合作者将能够请求访问 GitHub 或 OAuth 应用以访问该组织及其资源。通常是需要的，但如果不需要，最好禁用它。
* _我在 API 响应中找不到这个信息，如果你找到了请分享_
* **仓库可见性变更**：如果启用，拥有**仓库** **管理员**权限的**成员**将能够**更改其可见性**。如果禁用，只有组织所有者可以更改仓库可见性。如果您**不**希望人们将东西公开，确保这是**禁用**的。
* _我在 API 响应中找不到这个信息，如果你找到了请分享_
* **仓库删除和转移**：如果启用，拥有仓库**管理员**权限的成员将能够**删除**或**转移**公共和私有**仓库**。
* _我在 API 响应中找不到这个信息，如果你找到了请分享_
* **允许成员创建团队**：如果启用，任何组织的**成员**都将能够**创建**新的**团队**。如果禁用，只有组织所有者可以创建新团队。最好禁用此功能。
* _我在 API 响应中找不到这个信息，如果你找到了请分享_
* **更多的配置可以在这个页面上进行**，但上述是与安全性更相关的。
### Actions 设置

可以在页面 `https://github.com/organizations/<org_name>/settings/actions` 为 actions 配置多个与安全相关的设置。

{% hint style="info" %}
请注意，所有这些配置也可以在每个仓库中独立设置
{% endhint %}

* **Github actions 策略**：它允许您指定哪些仓库可以运行工作流，以及应该允许哪些工作流。建议**指定哪些仓库**应被允许，而不是允许所有 actions 运行。
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **来自外部合作者的 Fork 拉取请求工作流**：建议**要求批准所有**外部合作者。
* _我找不到这方面的 API，如果你找到了请分享_
* **从 Fork 拉取请求运行工作流**：强烈**不建议从拉取请求运行工作流**，因为 Fork 源的维护者将获得使用具有读取权限的令牌在源仓库上的能力。
* _我找不到这方面的 API，如果你找到了请分享_
* **工作流权限**：强烈建议**只授予读取仓库权限**。不建议授予写入和创建/批准拉取请求权限，以避免滥用赋予运行工作流的 GITHUB\_TOKEN。
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### 集成

_如果你知道访问这些信息的 API 端点，请告诉我！_

* **第三方应用程序访问策略**：建议限制对每个应用程序的访问，并且只允许所需的应用程序（在审查之后）。
* **已安装的 GitHub Apps**：建议只允许所需的应用程序（在审查之后）。

## Recon & 利用凭证进行攻击

在这个场景中，我们假设您已经获得了对某个 github 账户的一些访问权限。

### 使用用户凭证

如果您以某种方式已经拥有组织内某个用户的凭证，您可以**直接登录**并检查您拥有哪些**企业和组织角色**，如果您是一个普通成员，检查普通成员拥有哪些**权限**，您在哪些**组**中，您对哪些**仓库**拥有哪些**权限**，以及**仓库是如何被保护的**。

请注意，可能会使用**双因素认证**，所以如果您能够通过这个检查，您才能访问这些信息。

{% hint style="info" %}
请注意，如果您**设法窃取了 `user_session` cookie**（当前配置为 SameSite: Lax），您可以**完全冒充该用户**，无需凭证或双因素认证。
{% endhint %}

如果有用，请查看下面关于[**分支保护绕过**](./#branch-protection-bypass)的部分。

### 使用用户 SSH 密钥

Github 允许**用户**设置**SSH 密钥**，这将被用作**部署代码的认证方法**（不适用双因素认证）。

使用这个密钥，您可以在用户拥有某些权限的仓库中执行**更改**，但是您不能使用它来访问 github api 来枚举环境。不过，您可以获取**枚举本地设置**以获取有关您可以访问的仓库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户将其用户名配置为其github用户名，您可以访问他在 _https://github.com/\<github\_username>.keys_ 中设置的**公钥**，您可以检查这个来确认您找到的私钥是否可用。

**SSH密钥**也可以设置在仓库中作为**部署密钥**。任何拥有此密钥的人都将能够**从仓库启动项目**。通常在一个服务器上有不同的部署密钥，本地文件**`~/.ssh/config`** 将为您提供与密钥相关的信息。

#### GPG密钥

如[**此处**](broken-reference/)所解释的，有时需要签署提交，否则您可能会被发现。

检查当前用户是否有任何密钥，使用：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的基本信息，请查看基础信息**](basic-github-information.md#personal-access-tokens)。

用户令牌可以**代替密码**用于 Git over HTTPS，或者用于[**通过基本认证对 API 进行认证**](https://docs.github.com/v3/auth/#basic-authentication)。根据附加的权限，你可能能够执行不同的操作。

用户令牌看起来像这样：`ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### 使用 Oauth 应用程序

有关[**Github Oauth 应用程序的基本信息，请查看基础信息**](basic-github-information.md#oauth-applications)。

攻击者可能会创建一个**恶意的 Oauth 应用程序**，以访问接受它们的用户的特权数据/操作，这可能是钓鱼活动的一部分。

这些是[Oauth 应用程序可以请求的权限范围](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)。用户在接受之前应始终检查请求的权限范围。

此外，如基础信息中所解释的，**组织可以授予/拒绝第三方应用程序**访问与组织相关的信息/仓库/操作。

### 使用 Github 应用程序

有关[**Github 应用程序的基本信息，请查看基础信息**](basic-github-information.md#github-applications)。

攻击者可能会创建一个**恶意的 Github 应用程序**，以访问接受它们的用户的特权数据/操作，这可能是钓鱼活动的一部分。

此外，如基础信息中所解释的，**组织可以授予/拒绝第三方应用程序**访问与组织相关的信息/仓库/操作。

## 危害和滥用 Github Action

有几种技术可以危害和滥用 Github Action，请在这里查看：

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## 绕过分支保护

* **要求一定数量的审批**：如果你危害了几个账户，你可能只需从其他账户接受你的 PR。如果你只有创建 PR 的账户，你不能接受自己的 PR。然而，如果你可以访问仓库内的**Github Action**环境，使用**GITHUB\_TOKEN**，你可能能够**批准你的 PR**，以这种方式获得 1 个批准。
* _请注意，对于代码所有者的限制，通常用户无法批准自己的 PR，但如果可以，你可以滥用它来接受你的 PR。_
* **当推送新提交时撤销批准**：如果没有设置，你可以提交合法代码，等待有人批准，然后放入恶意代码并将其合并到受保护的分支中。
* **要求代码所有者审查**：如果启用此功能，且你是代码所有者，你可以让**Github Action 创建你的 PR 然后自己批准**。
* 当**CODEOWNER 文件配置错误**时，Github 不会抱怨，但它不会使用它。因此，如果配置错误，**代码所有者保护不会应用。**
* **允许特定参与者绕过拉取请求要求**：如果你是这些参与者之一，你可以绕过拉取请求保护。
* **包括管理员**：如果没有设置，且你是仓库的管理员，你可以绕过这些分支保护。
* **PR 劫持**：你可以修改其他人的 PR，添加恶意代码，自己批准结果 PR 并合并所有内容。
* **移除分支保护**：如果你是仓库的**管理员，你可以禁用保护**，合并你的 PR 然后重新设置保护。
* **绕过推送保护**：如果一个仓库**只允许特定用户**推送（合并代码）到分支（分支保护可能保护所有分支，指定通配符 `*`）。
* 如果你对仓库有**写入权限，但由于分支保护不允许推送代码**，你仍然可以**创建一个新分支**，并在其中创建一个**触发代码推送时触发的 github action**。由于**分支保护不会保护分支，直到它被创建**，因此对分支的第一次代码推送将**执行 github action**。

## 绕过环境保护

有关[**Github 环境的基本信息，请查看基础信息**](basic-github-information.md#git-environments)。

如果一个环境可以**从所有分支访问**，它**没有受到保护**，你可以轻松访问环境内的秘密。请注意，你可能会发现**所有分支都受到保护**的仓库（通过指定它们的名称或使用 `*`），在这种情况下，**找到一个你可以推送代码的分支**，你可以通过创建一个新的 github action（或修改一个现有的）来**泄露**秘密。

请注意，你可能会遇到边缘情况，即**所有分支都受到保护**（通过通配符 `*`），并且指定了**谁可以向分支推送代码**（_你可以在分支保护中指定_），并且**不允许你的用户**。你仍然可以运行自定义 github action，因为你可以创建一个分支并使用推送触发器。**分支保护允许向新分支推送，因此将触发 github action**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
请注意，在创建分支后，**分支保护将适用于新分支**，您将无法修改它，但在那时，您已经导出了秘密。

## 持久性

* 生成**用户令牌**
* 从**秘密**中窃取**github 令牌**
* 删除工作流**结果**和**分支**
* 给予组织中所有人**更多权限**
* 创建**webhooks**以外泄信息
* 邀请**外部合作者**
* 删除**SIEM**使用的**webhooks**
* 创建/修改带有**后门**的**Github Action**
* 通过修改**秘密**值，找到易受**命令注入攻击**的**Github Action**

### 冒名提交 - 通过仓库提交的后门

在Github中，可以**从一个分支创建PR到仓库**。即使PR**未被接受**，在原始仓库中也会为分支版本的代码创建一个**提交**id。因此，攻击者**可以指定使用来自看似合法仓库的特定提交，而该提交并非仓库所有者创建**。

就像[**这样**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e)：
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
```markdown
有关更多信息，请查看 [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客技术！</strong></summary>

其他支持HackTricks的方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
```
