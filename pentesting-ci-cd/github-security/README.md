# S√©curit√© Github

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

## Qu'est-ce que Github

(De [ici](https://kinsta.com/knowledgebase/what-is-github/)) √Ä un niveau √©lev√©, **GitHub est un site web et un service bas√© sur le cloud qui aide les d√©veloppeurs √† stocker et g√©rer leur code, ainsi qu'√† suivre et contr√¥ler les modifications apport√©es √† leur code**.

### Informations de base

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## Reconnaissance externe

Les d√©p√¥ts Github peuvent √™tre configur√©s comme publics, priv√©s et internes.

* **Priv√©** signifie que seules les personnes de l'**organisation** pourront y acc√©der
* **Interne** signifie que seules les personnes de l'**entreprise** (une entreprise peut avoir plusieurs organisations) pourront y acc√©der
* **Public** signifie que **tout internet** pourra y acc√©der.

Dans le cas o√π vous connaissez l'**utilisateur, le d√©p√¥t ou l'organisation que vous souhaitez cibler**, vous pouvez utiliser des **dorks Github** pour trouver des informations sensibles ou rechercher des **fuites d'informations sensibles sur chaque d√©p√¥t**.

### Dorks Github

Github permet de **rechercher quelque chose en sp√©cifiant comme port√©e un utilisateur, un d√©p√¥t ou une organisation**. Par cons√©quent, avec une liste de cha√Ænes qui vont appara√Ætre √† proximit√© d'informations sensibles, vous pouvez facilement **rechercher des informations sensibles potentielles dans votre cible**.

Outils (chaque outil contient sa liste de dorks) :

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([liste de Dorks](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([liste de Dorks](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([liste de Dorks](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Fuites Github

Veuillez noter que les dorks Github sont √©galement destin√©s √† rechercher des fuites en utilisant les options de recherche de Github. Cette section est d√©di√©e aux outils qui vont **t√©l√©charger chaque d√©p√¥t et rechercher des informations sensibles** en eux (m√™me en v√©rifiant une certaine profondeur de commits).

Outils (chaque outil contient sa liste de regexes) :

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
Lorsque vous recherchez des fuites dans un d√©p√¥t et que vous ex√©cutez quelque chose comme `git log -p`, n'oubliez pas qu'il peut y avoir **d'autres branches avec d'autres commits** contenant des secrets !
{% endhint %}

### Forks externes

Il est possible de **compromettre des d√©p√¥ts en abusant des demandes de pull**. Pour savoir si un d√©p√¥t est vuln√©rable, vous devez principalement lire les configurations yaml de Github Actions. [**Plus d'informations √† ce sujet ci-dessous**](./#execution-from-a-external-fork).

## Renforcement de l'organisation

### Privil√®ges des membres

Il existe certains **privil√®ges par d√©faut** qui peuvent √™tre attribu√©s aux **membres** de l'organisation. Ces derniers peuvent √™tre contr√¥l√©s √† partir de la page `https://github.com/organizations/<org_name>/settings/member_privileges` ou de l'[**API des organisations**](https://docs.github.com/en/rest/orgs/orgs).

* **Permissions de base** : Les membres auront la permission Aucune/Lecture/√©criture/Admin sur les d√©p√¥ts de l'organisation. Il est recommand√© de choisir **Aucune** ou **Lecture**.
* **Fork de d√©p√¥t** : S'il n'est pas n√©cessaire, il est pr√©f√©rable de **ne pas autoriser** les membres √† forker les d√©p√¥ts de l'organisation.
* **Cr√©ation de pages** : S'il n'est pas n√©cessaire, il est pr√©f√©rable de **ne pas autoriser** les membres √† publier des pages √† partir des d√©p√¥ts de l'organisation. Si n√©cessaire, vous pouvez autoriser la cr√©ation de pages publiques ou priv√©es.
* **Demandes d'acc√®s aux int√©grations** : Avec cette option activ√©e, les collaborateurs externes pourront demander l'acc√®s aux applications GitHub ou OAuth pour acc√©der √† cette organisation et √† ses ressources. C'est g√©n√©ralement n√©cessaire, mais s'il ne l'est pas, il est pr√©f√©rable de le d√©sactiver.
  * _Je n'ai pas pu trouver cette information dans la r√©ponse de l'API, partagez-la si vous la trouvez_
* **Changement de visibilit√© du d√©p√¥t** : S'il est activ√©, les **membres** ayant des **permissions d'administrateur** pour le **d√©p√¥t** pourront **changer sa visibilit√©**. S'il est d√©sactiv√©, seuls les propri√©taires de l'organisation peuvent changer les visibilit√©s des d√©p√¥ts. Si vous ne voulez
### Avec la cl√© SSH de l'utilisateur

Github permet aux **utilisateurs** de d√©finir des **cl√©s SSH** qui seront utilis√©es comme **m√©thode d'authentification pour d√©ployer du code** en leur nom (aucune 2FA n'est appliqu√©e).

Avec cette cl√©, vous pouvez effectuer des **changements dans les d√©p√¥ts o√π l'utilisateur a certains privil√®ges**, mais vous ne pouvez pas l'utiliser pour acc√©der √† l'API Github pour √©num√©rer l'environnement. Cependant, vous pouvez **√©num√©rer les param√®tres locaux** pour obtenir des informations sur les d√©p√¥ts et les utilisateurs auxquels vous avez acc√®s :

```bash
# Aller dans le dossier du d√©p√¥t
# Obtenir la configuration du d√©p√¥t et le nom et l'e-mail de l'utilisateur actuel
git config --list
```

Si l'utilisateur a configur√© son nom d'utilisateur comme son nom d'utilisateur Github, vous pouvez acc√©der aux **cl√©s publiques qu'il a d√©finies** dans son compte sur _https://github.com/\<github\_username>.keys_, vous pouvez v√©rifier cela pour confirmer que la cl√© priv√©e que vous avez trouv√©e peut √™tre utilis√©e.

Les **cl√©s SSH** peuvent √©galement √™tre d√©finies dans les d√©p√¥ts en tant que **cl√©s de d√©ploiement**. Toute personne ayant acc√®s √† cette cl√© pourra **lancer des projets √† partir d'un d√©p√¥t**. Habituellement, sur un serveur avec diff√©rentes cl√©s de d√©ploiement, le fichier local **`~/.ssh/config`** vous donnera des informations sur la cl√© associ√©e.

#### Cl√©s GPG

Comme expliqu√© [**ici**](broken-reference/), il est parfois n√©cessaire de signer les commits ou vous pourriez √™tre d√©couvert.

V√©rifiez localement si l'utilisateur actuel poss√®de une cl√© avec :

```shell
gpg --list-secret-keys --keyid-format=long
```

### Avec le jeton utilisateur

Pour une introduction aux [**jetons d'utilisateur, consultez les informations de base**](basic-github-information.md#personal-access-tokens).

Un jeton utilisateur peut √™tre utilis√© **au lieu d'un mot de passe** pour Git sur HTTPS, ou peut √™tre utilis√© pour [**s'authentifier √† l'API via l'authentification de base**](https://docs.github.com/v3/auth/#basic-authentication). Selon les privil√®ges qui y sont attach√©s, vous pourrez peut-√™tre effectuer diff√©rentes actions.

Un jeton utilisateur ressemble √† ceci : `ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Avec une application Oauth

Pour une introduction aux [**applications Oauth de Github, consultez les informations de base**](basic-github-information.md#oauth-applications).

Un attaquant peut cr√©er une **application Oauth malveillante** pour acc√©der aux donn√©es/actions privil√©gi√©es des utilisateurs qui les acceptent probablement dans le cadre d'une campagne de phishing.

Voici les [port√©es qu'une application Oauth peut demander](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps). Vous devriez toujours v√©rifier les port√©es demand√©es avant de les accepter.

De plus, comme expliqu√© dans les informations de base, **les organisations peuvent donner/refuser l'acc√®s aux applications tierces** aux informations/d√©p√¥ts/actions li√©es √† l'organisation.

### Avec une application Github

Pour une introduction aux [**applications Github, consultez les informations de base**](basic-github-information.md#github-applications).

Un attaquant peut cr√©er une **application Github malveillante** pour acc√©der aux donn√©es/actions privil√©gi√©es des utilisateurs qui les acceptent probablement dans le cadre d'une campagne de phishing.

De plus, comme expliqu√© dans les informations de base, **les organisations peuvent donner/refuser l'acc√®s aux applications tierces** aux informations/d√©p√¥ts/actions li√©es √† l'organisation.

## Abus de Github Action

Pour une introduction aux [**actions Github, consultez les informations de base**](basic-github-information.md#github-actions).

Dans le cas o√π vous pouvez **ex√©cuter des actions Github arbitraires** dans un **d√©p√¥t**, vous pouvez **voler les secrets de ce d√©p√¥t**.

### Ex√©cution √† partir de la cr√©ation de d√©p√¥t

Dans le cas o√π les membres d'une organisation peuvent **cr√©er de nouveaux d√©p√¥ts** et que vous pouvez ex√©cuter des actions Github, vous pouvez **cr√©er un nouveau d√©p√¥t et voler les secrets d√©finis au niveau de l'organisation**.

### Ex√©cution √† partir d'une nouvelle branche

Si vous pouvez **cr√©er une nouvelle branche dans un d√©p√¥t qui contient d√©j√† une action Github** configur√©e, vous pouvez la **modifier**, **t√©l√©charger** le contenu, puis **ex√©cuter cette action √† partir de la nouvelle branche**. De cette fa√ßon, vous pouvez **exfiltrer les secrets du d√©p√¥t et de l'organisation** (mais vous devez savoir comment ils sont appel√©s).

Vous pouvez rendre l'action modifi√©e ex√©cutable **manuellement**, lorsqu'une **PR est cr√©√©e** ou lorsqu'un **code est pouss√©** (selon le niveau de bruit que vous souhaitez faire) :

```yaml
on:
  workflow_dispatch: # Lancer manuellement
  pull_request: # L'ex√©cuter lorsqu'une PR est cr√©√©e vers une branche
    branches:
      - master
  push: # L'ex√©cuter lorsqu'un push est effectu√© vers une branche
    branches:
      - current_branch_name

# Utilisez '**' au lieu d'un nom de branche pour d√©clencher l'action dans toutes les branches
```

### Ex√©cution √† partir d'une fourche externe

Si un d√©p√¥t utilise des actions Github, un attaquant pourrait √™tre en mesure de **cr√©er une demande de tirage √† partir d'un d√©p√¥t fork√©** en injectant du **code malveillant** dans le **flux de travail** Github, et il pourrait √™tre en mesure de **compromettre le d√©p√¥t Github** de cette mani√®re.

#### `pull_request`

Le d√©clencheur de flux de travail **`pull_request`** par d√©faut **emp√™che les autorisations d'√©criture** et **l'acc√®s aux secrets** au d√©p√¥t cible. De plus, par d√©faut, si c'est la **premi√®re fois** que vous **collaborez**, un **mainteneur** devra **approuver** l'**ex√©cution** du flux de travail :

<figure><img src="../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Comme la **limitation par d√©faut** est pour les contributeurs **premi√®re fois**, vous pourriez contribuer en **corrigeant un bogue valide** et ensuite envoyer **d'autres PR pour abuser de vos nouveaux privil√®ges de `pull_request`**.

**J'ai test√© cela et cela ne fonctionne pas** : ~~Une autre option serait de cr√©er un compte avec le nom de quelqu'un qui a contribu√© au projet et a supprim√© son compte.~~
{% endhint %}

Cependant, afin de **pr√©venir** la **compromission** du **d√©p√¥t** via **`pull_request`**, cela est mentionn√© dans la [**documentation**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories) :

> √Ä l'exception de `GITHUB_TOKEN`, **les secrets ne sont pas transmis √† l'ex√©cuteur** lorsqu'un flux de travail est d√©clench√© √† partir d'un d√©p√¥t fork√©. Le **`GITHUB_TOKEN` a des autorisations en lecture seule** dans les demandes de tirage **√† partir de d√©p√¥ts fork√©s**.

Un attaquant pourrait modifier la d√©finition de l'action Github afin d'ex√©cuter des choses arbitraires et d'ajouter des actions arbitraires. Cependant, il ne pourra pas voler de secrets ou √©craser le d√©p√¥t en raison des limitations mentionn√©es.

Cependant, m√™me si l'action ne mentionne pas les artefacts, il pourrait √™tre en mesure de modifier un artefact de d√©p√¥t en changeant l'action ?? (TODO).

{% hint style="danger" %}
**Oui, si l'attaquant change dans la PR l'action Github qui sera d√©clench√©e, son action Github sera celle utilis√©e et non celle du d√©p√¥t d'origine !**
{% endhint %}

_Cependant, l'envoi d'une nouvelle action qui d√©
# INSECURE. Fourni uniquement √† titre d'exemple.
on:
  pull_request_target

jobs:
  build:
    name: Build et test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - uses: actions/setup-node@v1
    - run: |
        npm install
        npm build

    - uses: completely/fakeaction@v2
      with:
        arg1: ${{ secrets.supersecret }}

    - uses: fakerepo/comment-on-pr@v1
      with:
        message: |
          Merci!

```

Le code potentiellement **non fiable est ex√©cut√© pendant `npm install` ou `npm build`** car les scripts de construction et les **packages r√©f√©renc√©s sont contr√¥l√©s par l'auteur de la PR**.

{% hint style="danger" %}
Si l'action est ex√©cut√©e dans un runner auto-h√©berg√©, l'attaquant pourrait √™tre en mesure de compromettre encore plus l'environnement.
{% endhint %}

Un dork Github pour rechercher des actions vuln√©rables est : `event.pull_request pull_request_target extension:yml` cependant, il existe diff√©rentes fa√ßons de configurer les jobs pour qu'ils soient ex√©cut√©s de mani√®re s√©curis√©e m√™me si l'action est configur√©e de mani√®re non s√©curis√©e (comme l'utilisation de conditionnels sur l'acteur qui g√©n√®re la PR).

### Injection/Backdoor d'actions Github

Dans le cas o√π vous avez r√©ussi √† **infiltrer une action Github**, si vous pouvez **escalader les privil√®ges**, vous pouvez **voler des secrets des processus o√π les secrets ont √©t√© d√©finis**. Dans certains cas, vous n'avez m√™me pas besoin d'escalader les privil√®ges.

```bash
cat /proc/<proc_number>/environ
cat /proc/*/environ | grep -i secret #En supposant que le nom de la variable d'environnement contient "secret"
```

### Acc√®s √† AWS et GCP via OIDC dans Github Action

V√©rifiez les pages suivantes :

{% content-ref url="../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Informations sensibles dans les logs des actions Github

M√™me si **Github** essaie de **d√©tecter les valeurs secr√®tes** dans les logs des actions et de **les masquer**, **d'autres donn√©es sensibles** qui pourraient avoir √©t√© g√©n√©r√©es lors de l'ex√©cution de l'action ne seront pas cach√©es. Par exemple, un JWT sign√© avec une valeur secr√®te ne sera pas cach√© √† moins qu'il ne soit [sp√©cifiquement configur√©](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

### GITHUB\_TOKEN

Ce "**secret**" (provenant de `${{ secrets.GITHUB_TOKEN }}` et `${{ github.token }}`) est donn√© lorsque l'administrateur active cette option :

<figure><img src="../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Ce jeton est le m√™me qu'un **Github Application utilisera**, donc il peut acc√©der aux m√™mes points de terminaison : [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github devrait publier un [**flux**](https://github.com/github/roadmap/issues/74) qui **permet l'acc√®s inter-d√©p√¥t** au sein de GitHub, afin qu'un d√©p√¥t puisse acc√©der √† d'autres d√©p√¥ts internes en utilisant le `GITHUB_TOKEN`.
{% endhint %}

Vous pouvez voir les **permissions** possibles de ce jeton dans : [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Notez que le jeton **expire apr√®s que le travail est termin√©**.\
Ces jetons ressemblent √† ceci : `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Certaines choses int√©ressantes que vous pouvez faire avec ce jeton :

```bash
# Fusionner une PR
curl -X PUT \
    https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
    -H "Accept: application/vnd.github.v3+json" \
    --header "authorization: Bearer $GITHUB_TOKEN" \
    --header 'content-type: application/json' \
    -d '{"commit_title":"commit_title"}'

# Approuver une PR
curl -X POST \
    https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
    -H "Accept: application/vnd.github.v3+json" \
    --header "authorization: Bearer $GITHUB_TOKEN" \
    --header 'content-type: application/json' \
    -d '{"event":"APPROVE"}'

# Cr√©er une PR
curl -X POST \
  -H "Accept: application/vnd.github.v3+json" \
  --header "authorization: Bearer $GITHUB_TOKEN" \
    --header 'content-type: application/json' \
  https://api.github.com/repos/<org_name>/<repo_name>/pulls \
  -d '{"head":"<branch_name>","base":"master", "title":"title"}'
```

{% hint style="danger" %}
Notez que dans plusieurs occasions, vous pourrez trouver des **jetons d'utilisateur Github dans les envs des actions Github ou dans les secrets**. Ces jetons peuvent vous donner plus de privil√®ges sur le d√©p√¥t et l'organisation.
{% endhint %}

#### Liste des secrets dans la sortie de l'action Github

```yaml
name: list_env
on:
  workflow_dispatch: # Lancer manuellement
  pull_request: #L'ex√©cuter lorsqu'une PR est cr√©√©e sur une branche
    branches:
      - '**'
  push: # L'ex√©cuter lorsqu'un push est effectu√© sur une branche
    branches:
      - '**'
jobs:     
  List_env:
    runs-on: ubuntu-latest
### Poisoning de Cache

L'utilisation de l'action Git [**action/cache**](https://github.com/actions/cache) n'importe o√π dans le CI ex√©cutera deux √©tapes: une √©tape aura lieu pendant le processus **run** lorsqu'elle est appel√©e et l'autre aura lieu apr√®s le **workflow** (si l'action run a retourn√© un cache-miss).

* **Action run** - est utilis√©e pour rechercher et r√©cup√©rer le cache. La recherche est effectu√©e √† l'aide de la cl√© de cache, le r√©sultat √©tant soit un cache-hit (succ√®s, donn√©es trouv√©es dans le cache) ou un cache-miss. Si trouv√©, les fichiers et r√©pertoires sont r√©cup√©r√©s √† partir du cache pour une utilisation active. Si le r√©sultat est un cache-miss, les fichiers et r√©pertoires souhait√©s sont t√©l√©charg√©s comme s'il s'agissait de la premi√®re fois qu'ils sont appel√©s.
* **Action post workflow** - utilis√©e pour enregistrer le cache. Si le r√©sultat de l'appel de cache dans l'action run retourne un cache-miss, cette action enregistrera l'√©tat actuel des r√©pertoires que nous voulons mettre en cache avec la cl√© fournie. Cette action se produit automatiquement et n'a pas besoin d'√™tre explicitement appel√©e.

Les **restrictions d'acc√®s** fournissent une **isolation de cache** et une s√©curit√© en cr√©ant une **fronti√®re logique entre les diff√©rentes branches** _(par exemple: un cache cr√©√© pour la branche **Feature-A** \[avec la base principale] ne serait pas accessible √† une demande de tirage pour la branche **Feature-B** \[avec la base principale])_.

L'action de cache recherche d'abord les hits de cache pour une cl√© et restaure les cl√©s dans la branche contenant l'ex√©cution du **workflow**. S'il n'y a pas de hits dans la branche actuelle, l'action de cache recherche la cl√© et restaure les cl√©s dans la branche parente et les branches en amont.

L'acc√®s √† un cache est limit√© par branche (actuelle et parente), ce qui signifie que l'acc√®s est fourni √† tous les **workflows** √† travers les **runs** de ladite branche.

Une autre note importante est que GitHub n'autorise pas les modifications une fois que les entr√©es sont pouss√©es - les entr√©es de cache sont des enregistrements en lecture seule.

Nous avons utilis√© un exemple de CI qui comprenait deux workflows. Cet exemple montre comment une attaque peut pivoter d'un workflow √† faible autorisation √† un workflow √† haute autorisation.

* Le workflow **Unit-test** ex√©cute des outils de test unitaire et de couverture de code. Nous supposons que l'un des outils est malveillant ou vuln√©rable √† l'ex√©cution de code √† distance. Le workflow n'a pas besoin d'utiliser l'action Git **action/cache**. Tout workflow peut acc√©der au cache.
* Le workflow **Release** construit et publie l'artefact d'application. Ce workflow utilise un cache pour optimiser l'utilisation des d√©pendances Golang.

Le workflow **unit-test** utilise une action malveillante qui ajoute une entr√©e de cache avec un contenu malveillant en modifiant une biblioth√®que de journalisation Golang (**go.uber.org/zap@v1**) pour ajouter la cha√Æne "BAD library" √† la description de l'artefact d'application.

Ensuite, le workflow **release** utilise cette entr√©e de cache empoisonn√©e. En cons√©quence, le code malveillant est inject√© dans le binaire et l'image Golang construits. Le cache reste empoisonn√© jusqu'√† ce que la cl√© d'entr√©e soit supprim√©e (g√©n√©ralement d√©clench√©e par des mises √† jour de d√©pendances). Le m√™me cache empoisonn√© affectera tout autre **workflow**, **run** et **branche enfant** utilisant la m√™me cl√© de cache.

Dans le test que nous avons effectu√©, nous avons r√©ussi √† injecter la cha√Æne "BAD library" dans la description de l'image :

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

C'√©tait dans la version 0.4.1. Ensuite, nous avons mis √† jour l'√©tiquette et reconstruit l'image plusieurs fois et avons observ√© que "Bad library" restait dans la description.

Cette technique a √©t√© prise sur [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

### Poisoning d'artefact

Il existe plusieurs actions Github qui permettent de **t√©l√©charger des artefacts √† partir d'autres r√©f√©rentiels**. Ces autres r√©f√©rentiels auront g√©n√©ralement une action Github pour **t√©l√©charger l'artefact** qui sera ensuite t√©l√©charg√©.\
Si l'**action Github** du r√©f√©rentiel qui t√©l√©charge l'artefact permet le **`pull_request`** ou **`pull_request_target`** (en utilisant le code de l'attaquant), un attaquant pourra d√©clencher l'action qui t√©l√©chargera un artefact cr√©√© √† partir de son code, de sorte que tout autre r√©f√©rentiel t√©l√©chargeant et ex√©cutant le dernier artefact sera compromis.

{% hint style="info" %}
Comme mentionn√© dans une section de ce post, les **`pull_requests`** n√©cessitent g√©n√©ralement une **approbation manuelle** d'un mainteneur du r√©f√©rentiel.
{% endhint %}

Exemple de **t√©l√©chargement d'artefact √† partir d'un r√©f√©rentiel diff√©rent** :

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Comme cela a √©t√© mentionn√© pr√©c√©demment, dans un d√©clencheur **`pull_request`**, l'action d√©finie dans la PR est celle qui est ex√©cut√©e. Ainsi, un **attaquant** pourrait **d√©finir** dans **celle-ci** l'**upload d'artefact** qu'il souhaite compromettre.

Par cons√©quent, un attaquant n'a pas besoin d'attaquer un d√©clencheur d'**upload d'artefact**, mais simplement n'importe quel d√©clencheur de **`pull_request`**.
{% endhint %}

Pour plus d'informations et d'options de d√©fense (comme le codage en dur de l'artefact √† t√©l√©charger), consultez [https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust](https://www.legitsecurity.com/blog/artifact-poisoning-vulnerability-discovered-in-rust)

### Hijacking de repo de namespace supprim√©

Il s'agit d'un bon article de blog √† lire sur les vuln√©rabilit√©s corrig√©es qui permettraient √† un attaquant de voler un espace de noms supprim√© pour voler un r√©f√©rentiel c√©l√®bre (potentiellement en raison d'un renommage de l'espace de noms) : [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

### Registre d'images Docker Github

Il est possible de cr√©er des actions Github qui **construiront et stockeront une image Docker √† l'int√©rieur de Github**.\
Un exemple peut √™tre trouv√© dans l'expansion suivante :

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>

```yaml
[...]

- name: Set up Docker Buildx
  uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
  uses: docker/login-action@v1
  with:
    registry: ghcr.io
    username: ${{ github.repository_owner }}
    password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download
## Contourner les protections d'environnement

Pour une introduction sur [**Github Environment, consultez les informations de base**](basic-github-information.md#git-environments).

Dans le cas o√π un environnement peut √™tre **acc√©d√© depuis toutes les branches**, il **n'est pas prot√©g√©** et vous pouvez facilement acc√©der aux secrets √† l'int√©rieur de l'environnement. Notez que vous pourriez trouver des d√©p√¥ts o√π **toutes les branches sont prot√©g√©es** (en sp√©cifiant leurs noms ou en utilisant `*`) dans ce sc√©nario, **trouvez une branche o√π vous pouvez pousser du code** et vous pouvez **exfiltrer** les secrets en cr√©ant une nouvelle action github (ou en en modifiant une).

Notez que vous pourriez trouver le cas limite o√π **toutes les branches sont prot√©g√©es** (via le joker `*`) et qu'il est sp√©cifi√© **qui peut pousser du code sur les branches** (_vous pouvez le sp√©cifier dans la protection de la branche_) et que **votre utilisateur n'est pas autoris√©**. Vous pouvez toujours ex√©cuter une action github personnalis√©e car vous pouvez cr√©er une branche et utiliser le d√©clencheur de pouss√©e sur elle-m√™me. La **protection de la branche permet la pouss√©e vers une nouvelle branche, de sorte que l'action github sera d√©clench√©e**.

```yaml
  push: # Ex√©cuter lorsque du code est pouss√© sur une branche
    branches:
      - current_branch_name #Utilisez '**' pour l'ex√©cuter lorsque du code est pouss√© sur n'importe quelle branche
```

Notez qu'**apr√®s la cr√©ation** de la branche, la **protection de la branche s'appliquera √† la nouvelle branche** et vous ne pourrez pas la modifier, mais pendant ce temps, vous aurez d√©j√† extrait les secrets.

## Persistance

* G√©n√©rer un **jeton utilisateur**
* Voler les **jetons github** des **secrets**
  * **Suppression** des **r√©sultats** et des **branches** du workflow
* Donner **plus de permissions √† toute l'organisation**
* Cr√©er des **webhooks** pour exfiltrer des informations
* Inviter des **collaborateurs externes**
* **Supprimer** les **webhooks** utilis√©s par le **SIEM**
* Cr√©er/modifier une **Github Action** avec une **backdoor**
* Trouver une **Github Action vuln√©rable √† l'injection de commande** via la modification de la valeur **secret**

### Commits d'imposteurs - Backdoor via les commits du d√©p√¥t

Sur Github, il est possible de **cr√©er une PR vers un d√©p√¥t √† partir d'un fork**. M√™me si la PR n'est **pas accept√©e**, un identifiant de **commit** √† l'int√©rieur du d√©p√¥t orginal va √™tre cr√©√© pour la version fork du code. Par cons√©quent, un attaquant **pourrait √©pingler pour utiliser un commit sp√©cifique d'un d√©p√¥t apparemment l√©gitime qui n'a pas √©t√© cr√©√© par le propri√©taire du d√©p√¥t**.

Comme [**ceci**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e):

```yaml
name: example
on: [push]
jobs:
 commit:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
     - shell: bash
       run: |
         echo 'hello world!'
```

Pour plus d'informations, consultez [https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>