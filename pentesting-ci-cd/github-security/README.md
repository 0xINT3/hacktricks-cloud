# Github セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Githubとは

(こちらから[here](https://kinsta.com/knowledgebase/what-is-github/)) 高いレベルで言えば、**GitHubは開発者がコードを保存・管理し、コードの変更を追跡・制御するのを助けるウェブサイトおよびクラウドベースのサービスです**。

### 基本情報

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 外部リコン

Githubリポジトリは、public、private、internalとして設定できます。

* **Private** は、**組織**の人だけがアクセスできることを意味します
* **Internal** は、**企業**（企業には複数の組織があるかもしれません）の人だけがアクセスできることを意味します
* **Public** は、**インターネット全体**がアクセスできることを意味します。

ターゲットにしたい**ユーザー、リポジトリ、または組織を知っている**場合は、**github dorks**を使用して機密情報を見つけたり、**各リポジトリでの機密情報の漏洩**を検索できます。

### Github Dorks

Githubでは、**ユーザー、リポジトリ、または組織をスコープとして指定して何かを検索**することができます。したがって、機密情報に近い文字列のリストを持っていれば、ターゲット内で**潜在的な機密情報を簡単に検索**できます。

ツール（各ツールにはそのリストのdorksが含まれています）:

* [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker) ([Dorks list](https://github.com/obheda12/GitDorker/tree/master/Dorks))
* [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks) ([Dorks list](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt))
* [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber) ([Dorks list](https://github.com/hisxo/gitGraber/tree/master/wordlists))

### Github Leaks

github dorksは、githubの検索オプションを使用して漏洩を検索するためにも意図されていることに注意してください。このセクションは、**各リポジトリをダウンロードしてそれらの中で機密情報を検索する**ツール（コミットの特定の深さをチェックすることもあります）に専念しています。

ツール（各ツールにはそのリストのregexesが含まれています）:

* [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
* [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
* [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
* [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
* [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
* [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
* [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
リポジトリで漏洩を探して`git log -p`のようなものを実行するときは、秘密を含む**他のブランチや他のコミット**があるかもしれないことを忘れないでください！
{% endhint %}

### 外部フォーク

プルリクエストを悪用してリポジトリを**侵害する**ことが可能です。リポジトリが脆弱かどうかを知るには、主にGithub Actions yaml設定を読む必要があります。[**以下で詳細情報**](./#execution-from-a-external-fork)。

## 組織の強化

### メンバー権限

組織の**メンバー**に割り当てることができる**デフォルトの権限**がいくつかあります。これらは`https://github.com/organizations/<org_name>/settings/member_privileges`のページまたは[**Organizations API**](https://docs.github.com/en/rest/orgs/orgs)から制御できます。

* **基本権限**: メンバーは組織のリポジトリに対してNone/Read/write/Adminの権限を持ちます。推奨されるのは**None**または**Read**です。
* **リポジトリのフォーク**: 必要ない場合は、メンバーが組織のリポジトリをフォークすることを**許可しない**方が良いです。
* **ページの作成**: 必要ない場合は、メンバーが組織のリポジトリからページを公開することを**許可しない**方が良いです。必要な場合は、公開または非公開のページを作成できるように許可できます。
* **統合アクセスリクエスト**: これを有効にすると、外部のコラボレーターがこの組織とそのリソースにアクセスするためにGitHubまたはOAuthアプリのアクセスを要求できるようになります。通常は必要ですが、必要ない場合は無効にする方が良いです。
* _この情報はAPIのレスポンスに見つけられませんでした。見つけたら共有してください_
* **リポジトリの可視性の変更**: 有効にすると、**リポジトリ**に**管理者**権限を持つ**メンバー**がその**可視性を変更**できるようになります。無効にすると、リポジトリの可視性を変更できるのは組織の所有者だけです。ものを**公開**したくない場合は、これを**無効**にしてください。
* _この情報はAPIのレスポンスに見つけられませんでした。見つけたら共有してください_
* **リポジトリの削除と転送**: 有効にすると、リポジトリに**管理者**権限を持つメンバーが公開および非公開の**リポジトリを削除**または**転送**できるようになります。
* _この情報はAPIのレスポンスに見つけられませんでした。見つけたら共有してください_
* **メンバーがチームを作成することを許可する**: 有効にすると、組織の任意の**メンバー**が新しい**チーム**を**作成**できるようになります。無効にすると、新しいチームを作成できるのは組織の所有者だけです。これを無効にしておく方が良いです。
* _この情報はAPIのレスポンスに見つけられませんでした。見つけたら共有してください_
* **このページで設定できるものは他にもあります**が、上記のものがセキュリティに関連するものです。
### Actionsの設定

ページ `https://github.com/organizations/<org_name>/settings/actions` からActionsに関するいくつかのセキュリティ関連の設定を行うことができます。

{% hint style="info" %}
これらの設定は各リポジトリに対しても独立して設定することができることに注意してください。
{% endhint %}

* **Github actionsポリシー**: どのリポジトリがワークフローを実行できるか、どのワークフローを許可するかを指定することができます。**指定されたリポジトリのみ**を許可し、すべてのActionsの実行を許可しないことが推奨されます。
* [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
* **外部コラボレーターからのフォークプルリクエストワークフロー**: すべての外部コラボレーターに対して**承認を要求する**ことが推奨されます。
* _この情報に関するAPIを見つけることができませんでした。もしご存知であれば共有してください。_
* **フォークプルリクエストからのワークフロー実行**: プルリクエストからワークフローを実行することは**強く非推奨**です。フォーク元のメンテナーがソースリポジトリの読み取り権限を持つトークンを使用する能力を与えられるためです。
* _この情報に関するAPIを見つけることができませんでした。もしご存知であれば共有してください。_
* **ワークフローの権限**: リポジトリの読み取り権限のみを与えることが強く推奨されます。実行中のワークフローに与えられるGITHUB\_TOKENを悪用することを避けるため、書き込み権限やプルリクエストの作成/承認権限を与えることは非推奨です。
* [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)

### インテグレーション

_この情報にアクセスするAPIエンドポイントをご存知であれば教えてください！_

* **サードパーティアプリケーションアクセスポリシー**: 必要なアプリケーションのみにアクセスを制限し、レビュー後にのみ許可することが推奨されます。
* **インストールされたGitHub Apps**: レビュー後に必要なもののみを許可することが推奨されます。

## Recon & 資格情報を悪用した攻撃

このシナリオでは、あなたがgithubアカウントへのある程度のアクセスを得たと仮定します。

### ユーザー資格情報を持っている場合

組織内のユーザーの資格情報を何らかの方法で既に持っている場合、**ログインするだけ**で、どのような**エンタープライズおよび組織の役割**を持っているか、単なるメンバーであれば、どのような**権限を持っているか**、どの**グループ**に属しているか、どの**リポジトリ**に対してどのような**権限**を持っているか、そして**リポジトリがどのように保護されているか**を確認することができます。

**2FAが使用されている**可能性があるため、そのチェックを**通過することができる**場合にのみ、この情報にアクセスできます。

{% hint style="info" %}
`user_session`クッキー（現在SameSite: Laxで設定されています）を**盗むことに成功した場合**、資格情報や2FAなしで**完全にユーザーを偽装する**ことができることに注意してください。
{% endhint %}

下記の[**ブランチ保護のバイパス**](./#branch-protection-bypass)セクションも参照してください。

### ユーザーのSSHキーを持っている場合

Githubでは、**ユーザー**が**SSHキー**を設定することを許可しており、これは彼らに代わってコードをデプロイするための**認証方法**として使用されます（2FAは適用されません）。

このキーを使用して、ユーザーが特定の権限を持つリポジトリで**変更を行う**ことができますが、環境を列挙するためにgithub apiにアクセスすることはできません。しかし、アクセス可能なリポジトリとユーザーに関する情報を得るために**ローカル設定を列挙する**ことができます。
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーがGitHubのユーザー名をユーザー名として設定している場合、_https://github.com/\<github\_username>.keys_ で**公開鍵を設定**していることが確認できます。見つけた秘密鍵が使用できるかどうかを確認するためにこれをチェックできます。

**SSH鍵**は、**デプロイ鍵**としてリポジトリにも設定できます。この鍵にアクセスできる人は誰でも**リポジトリからプロジェクトを起動**できます。通常、異なるデプロイ鍵があるサーバーでは、ローカルファイル**`~/.ssh/config`**が関連する鍵についての情報を提供します。

#### GPG鍵

[**こちら**](broken-reference/)で説明されているように、コミットに署名する必要がある場合や、発見されるかもしれない場合があります。

現在のユーザーが以下のコマンドで任意の鍵を持っているかローカルで確認します：
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用した場合

[**ユーザートークンの基本情報についてはこちらをご覧ください**](basic-github-information.md#personal-access-tokens)。

ユーザートークンは、HTTPS経由のGitでの**パスワードの代わり**に使用することができます。また、[**Basic認証を介してAPIに認証するために使用することもできます**](https://docs.github.com/v3/auth/#basic-authentication)。権限に応じて、異なるアクションを実行できる可能性があります。

ユーザートークンは次のようになります：`ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### Oauthアプリケーションを使用した場合

[**Github Oauthアプリケーションの基本情報についてはこちらをご覧ください**](basic-github-information.md#oauth-applications)。

攻撃者は、フィッシングキャンペーンの一環として、**悪意のあるOauthアプリケーション**を作成して、それを受け入れたユーザーの権限のあるデータやアクションにアクセスする可能性があります。

これらは、[Oauthアプリケーションが要求できるスコープ](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)です。ユーザーは、それらを受け入れる前に要求されたスコープを常に確認するべきです。

さらに、基本情報で説明されているように、**組織は第三者アプリケーションに対して、組織に関連する情報/リポジトリ/アクションへのアクセスを許可/拒否することができます**。

### Githubアプリケーションを使用した場合

[**Githubアプリケーションの基本情報についてはこちらをご覧ください**](basic-github-information.md#github-applications)。

攻撃者は、フィッシングキャンペーンの一環として、**悪意のあるGithubアプリケーション**を作成して、それを受け入れたユーザーの権限のあるデータやアクションにアクセスする可能性があります。

さらに、基本情報で説明されているように、**組織は第三者アプリケーションに対して、組織に関連する情報/リポジトリ/アクションへのアクセスを許可/拒否することができます**。

## Githubアクションの妥協と悪用

Githubアクションを妥協し悪用するいくつかの技術があります。こちらで確認してください：

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## ブランチ保護のバイパス

* **承認が必要な数を設定する**：複数のアカウントを妥協している場合、他のアカウントから自分のPRを承認することができます。PRを作成したアカウントしか持っていない場合、自分のPRを承認することはできません。しかし、リポジトリ内の**Githubアクション**環境にアクセスできる場合、**GITHUB\_TOKEN**を使用して**自分のPRを承認**し、この方法で1つの承認を得ることができます。
* _この点とコードオーナーの制限についての注意：通常、ユーザーは自分のPRを承認することはできませんが、できる場合はそれを悪用して自分のPRを承認することができます。_
* **新しいコミットがプッシュされたときに承認を無視する**：これが設定されていない場合、正当なコードを提出し、誰かがそれを承認するのを待ってから、悪意のあるコードを入れて保護されたブランチにマージすることができます。
* **コードオーナーからのレビューが必要**：これが有効になっている場合、コードオーナーであれば、**Githubアクションを作成して自分のPRを承認することができます**。
* **CODEOWNERファイルが誤って設定されている場合**、Githubは不満を言いませんが、それを使用しません。したがって、誤って設定されている場合は、**コードオーナーの保護が適用されません。**
* **特定のアクターにプルリクエスト要件のバイパスを許可する**：これらのアクターの1人であれば、プルリクエストの保護をバイパスできます。
* **管理者を含む**：これが設定されておらず、リポジトリの管理者である場合、このブランチの保護をバイパスできます。
* **PRハイジャック**：他人のPRを**変更して**悪意のあるコードを追加し、結果として出たPRを自分で承認し、すべてをマージすることができます。
* **ブランチ保護の削除**：リポジトリの**管理者であれば、保護を無効にし**、PRをマージしてから保護を元に戻すことができます。
* **プッシュ保護のバイパス**：リポジトリが**特定のユーザーのみ**にプッシュ（コードのマージ）を許可している場合（ブランチ保護はワイルドカード`*`を指定してすべてのブランチを保護しているかもしれません）。
* リポジトリに**書き込みアクセス権があるが、ブランチ保護のためにコードをプッシュすることが許可されていない**場合でも、**新しいブランチを作成**し、その中でコードがプッシュされたときにトリガーされる**githubアクションを作成**することができます。**ブランチ保護はブランチが作成されるまでブランチを保護しない**ため、この最初のコードプッシュは**githubアクションを実行します**。

## 環境保護のバイパス

[**Github環境の基本情報についてはこちらをご覧ください**](basic-github-information.md#git-environments)。

環境が**すべてのブランチからアクセス可能**である場合、それは**保護されていない**と考えられ、環境内のシークレットに簡単にアクセスできます。**すべてのブランチが保護されている**（名前を指定するか`*`を使用することによって）リポジトリを見つけるかもしれませんが、そのシナリオでは、**コードをプッシュできるブランチを見つけ**、新しいgithubアクションを作成する（または既存のものを変更する）ことでシークレットを**抽出**できます。

また、**すべてのブランチが保護されている**（ワイルドカード`*`を介して）、**ブランチにコードをプッシュできる人が指定されている**（_ブランチ保護で指定できます_）というエッジケースに遭遇するかもしれませんが、**自分のユーザーが許可されていない**場合でも、カスタムgithubアクションを実行できます。新しいブランチを作成し、それ自体に対するプッシュトリガーを使用できます。**ブランチ保護は新しいブランチへのプッシュを許可するため、githubアクションがトリガーされます**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
**ブランチ作成後**には、**ブランチ保護が新しいブランチに適用され**、変更ができなくなりますが、その時点で既にシークレットをダンプしているでしょう。

## 持続性

* **ユーザートークン**の生成
* **シークレット**から**githubトークン**を盗む
* ワークフローの**結果**と**ブランチ**の**削除**
* 全ての組織に**より多くの権限を与える**
* 情報を外部に流出させるための**ウェブフック**の作成
* **外部コラボレーター**の招待
* **SIEM**が使用する**ウェブフック**の**削除**
* **バックドア**を持つ**Githubアクション**の作成/変更
* **シークレット**値の変更を介して**コマンドインジェクションに対して脆弱なGithubアクション**を見つける

### インポスターコミット - リポジトリコミットを通じたバックドア

Githubでは、フォークからリポジトリに**PRを作成する**ことが可能です。PRが**受け入れられなくても**、元のリポジトリ内にフォーク版のコードに対する**コミットID**が作成されます。したがって、攻撃者は、リポジトリの所有者によって作成されなかった見かけ上正当なリポジトリから、特定のコミットを使用するように**指定することができます**。

[**これ**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e)のように：
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
詳細については、[https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)をご覧ください。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**、または**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* 独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)を含む[**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
