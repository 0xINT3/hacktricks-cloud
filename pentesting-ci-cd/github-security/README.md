# Githubセキュリティ

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見つける
- **Discordグループ**に**参加**する💬（https://discord.gg/hRep4RUj7f）または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**🐦で**フォロー**する[**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- **ハッキングトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに提出してください。

</details>

## Githubとは

（[こちら](https://kinsta.com/knowledgebase/what-is-github/)から）**GitHubは、開発者がコードを保存および管理し、コードの変更を追跡および制御するのを支援するウェブサイトおよびクラウドベースのサービス**です。

### 基本情報

{% content-ref url="basic-github-information.md" %}
[basic-github-information.md](basic-github-information.md)
{% endcontent-ref %}

## 外部リコン

Githubリポジトリは、公開、非公開、内部の設定ができます。

- **非公開**は、**組織の人々だけ**がアクセスできることを意味します
- **内部**は、**企業の人々だけ**がアクセスできることを意味します（企業には複数の組織がある場合があります）
- **公開**は、**インターネット全体**がアクセスできることを意味します。

**ユーザー、リポジトリ、またはターゲットとしたい組織**を知っている場合は、**github dorks**を使用して機密情報を見つけたり、**各リポジトリで機密情報の漏洩を検索**することができます。

### Github Dorks

Githubでは、**ユーザー、リポジトリ、または組織をスコープとして指定して検索**することができます。したがって、機密情報に近い文字列のリストを使用して、**ターゲットで潜在的な機密情報を簡単に検索**できます。

ツール（各ツールにはそれぞれのdorksリストが含まれています）：

- [https://github.com/obheda12/GitDorker](https://github.com/obheda12/GitDorker)（[Dorksリスト](https://github.com/obheda12/GitDorker/tree/master/Dorks)）
- [https://github.com/techgaun/github-dorks](https://github.com/techgaun/github-dorks)（[Dorksリスト](https://github.com/techgaun/github-dorks/blob/master/github-dorks.txt)）
- [https://github.com/hisxo/gitGraber](https://github.com/hisxo/gitGraber)（[Dorksリスト](https://github.com/hisxo/gitGraber/tree/master/wordlists)）

### Githubの漏洩

Github dorksは、githubの検索オプションを使用して漏洩を検索するためにも意図されています。このセクションは、これらのツールに**各リポジトリをダウンロードし、それらの中で機密情報を検索**するために捧げられています（一定のコミットの深さをチェックすることもあります）。

ツール（各ツールにはそれぞれの正規表現のリストが含まれています）：

- [https://github.com/zricethezav/gitleaks](https://github.com/zricethezav/gitleaks)
- [https://github.com/trufflesecurity/truffleHog](https://github.com/trufflesecurity/truffleHog)
- [https://github.com/eth0izzle/shhgit](https://github.com/eth0izzle/shhgit)
- [https://github.com/michenriksen/gitrob](https://github.com/michenriksen/gitrob)
- [https://github.com/anshumanbh/git-all-secrets](https://github.com/anshumanbh/git-all-secrets)
- [https://github.com/kootenpv/gittyleaks](https://github.com/kootenpv/gittyleaks)
- [https://github.com/awslabs/git-secrets](https://github.com/awslabs/git-secrets)

{% hint style="warning" %}
リポジトリで漏洩を探すときに`git log -p`などを実行する際には、**他のコミットを含む他のブランチ**にも秘密が含まれている可能性があることを忘れないでください！
{% endhint %}

### 外部フォーク

**プルリクエストを悪用してリポジトリを侵害することができます**。リポジトリが脆弱かどうかを知るためには、主にGithub Actionsのyaml構成を読む必要があります。[**詳細は以下を参照**](./#execution-from-a-external-fork)。

## 組織の強化

### メンバー権限

組織の**メンバー**に割り当てることができる**デフォルト権限**がいくつかあります。これらは、ページ`https://github.com/organizations/<org_name>/settings/member_privileges`からまたは[**Organizations API**](https://docs.github.com/en/rest/orgs/orgs)から制御できます。

- **ベース権限**：メンバーは、組織のリポジトリに対して権限なし/読み取り/書き込み/管理の権限を持ちます。推奨されるのは**権限なし**または**読み取り**です。
- **リポジトリのフォーク**：必要ない場合は、組織のリポジトリをメンバーがフォークすることを**許可しない**方が良いです。
- **ページの作成**：必要ない場合は、組織のリポジトリからページを公開することを**許可しない**方が良いです。必要な場合は、公開または非公開のページを作成することができます。
- **統合アクセスリクエスト**：これを有効にすると、外部コラボレーターがこの組織とそのリソースにアクセスするためにGitHubまたはOAuthアプリのアクセスをリクエストできます。通常は必要ですが、必要ない場合は無効にする方が良いです。
- _APIのレスポンスにこの情報が見つかりませんでした。見つけた場合は共有してください_
- **リポジトリの可視性の変更**：有効にすると、**リポジトリ**の**管理者**権限を持つ**メンバー**が**可視性を変更**できます。無効にすると、リポジトリの可視性を変更できるのは組織の所有者だけです。**公開**を避けたい場合は、これが**無効**になっていることを確認してください。
- _APIのレスポンスにこの情報が見つかりませんでした。見つけた場合は共有してください_
- **リポジトリの削除と移動**：有効にすると、リポジトリの**管理者**権限を持つメンバーが公開および非公開の**リポジトリを削除**または**移動**できます。
- _APIのレスポンスにこの情報が見つかりませんでした。見つけた場合は共有してください_
- **メンバーがチームを作成できるようにする**：有効にすると、組織の**メンバー**は新しい**チーム**を作成できます。無効にすると、チームを作成できるのは組織の所有者だけです。無効にしておく方が良いです。
- _APIのレスポンスにこの情報が見つかりませんでした。見つけた場合は共有してください_
- このページで**設定できるものは他にもたくさんあります**が、前述のものがセキュリティに関連するものです。

### アクションの設定

アクションに関連するいくつかのセキュリティ関連の設定をページ`https://github.com/organizations/<org_name>/settings/actions`から設定できます。

{% hint style="info" %}
これらの設定は、すべてのリポジトリで独立して設定することもできることに注意してください
{% endhint %}

- **Githubアクションポリシー**：どのリポジトリでワークフローを実行できるか、どのワークフローを許可するかを指定できます。**許可するリポジトリ**を指定し、すべてのアクションを実行しないようにすることが推奨されます。
- [**API-1**](https://docs.github.com/en/rest/actions/permissions#get-allowed-actions-and-reusable-workflows-for-an-organization)**,** [**API-2**](https://docs.github.com/en/rest/actions/permissions#list-selected-repositories-enabled-for-github-actions-in-an-organization)
- **外部コラボレーターからのフォークプルリクエストワークフロー**：すべての**外部コラボレーターに承認を要求する**ことが推奨されます。
- _この情報を含むAPIが見つかりませんでした。見つけた場合は共有してください_
- **フォークプルリクエストからのワークフローの実行**：フォーク元のメンテナーに、ソースリポジトリの読み取り権限を持つトークンを使用する権限が与えられるため、**フォークプルリクエストからのワークフローの実行は強く推奨されません**。
- _この情報を含むAPIが見つかりませんでした。見つけた場合は共有してください_
- **ワークフローの権限**：**読み取りリポジトリ権限のみを与える**ことを強く推奨します。GITHUB\_TOKENの悪用を避けるために、書き込みおよび作成/承認プルリクエスト権限を与えることは避けることが推奨されます。
- [**API**](https://docs.github.com/en/rest/actions/permissions#get-default-workflow-permissions-for-an-organization)
### 統合

_この情報にアクセスするAPIエンドポイントを知っている場合は教えてください！_

* **サードパーティーアプリケーションアクセスポリシー**：すべてのアプリケーションへのアクセスを制限し、必要なもののみ許可することが推奨されています（レビュー後）。
* **インストールされたGitHubアプリ**：必要なもののみを許可することが推奨されています（レビュー後）。

## 偵察と資格情報を悪用した攻撃

このシナリオでは、GitHubアカウントへのアクセス権を取得したと仮定します。

### ユーザー資格情報を使用する場合

何らかの方法で組織内のユーザーの資格情報をすでに取得している場合、**ログイン**して、どの**エンタープライズおよび組織の役割**を持っているか、生のメンバーである場合は、**生のメンバーが持つ権限**を確認し、どの**グループ**に所属しているか、どの**リポジトリに対する権限**を持っているか、そして**リポジトリがどのように保護されているか**を確認できます。

**2段階認証（2FA）が使用されている**場合があるため、そのチェックをパスできる場合にのみこの情報にアクセスできます。

{% hint style="info" %}
**`user_session`クッキーを盗むことに成功**した場合（現在はSameSite: Laxで構成されています）、資格情報や2FAを必要とせずに**ユーザーを完全になりすます**ことができます。
{% endhint %}

役立つ場合は、以下の[**ブランチ保護のバイパス**](./#branch-protection-bypass)に関するセクションを確認してください。

### ユーザーSSHキーを使用する場合

Githubは**ユーザーが設定したSSHキー**を使用して、**コードをデプロイする認証方法**として使用できます（2FAは適用されません）。

このキーを使用すると、**ユーザーが特定の権限を持つリポジトリで変更を行う**ことができますが、これを使用してgithub apiにアクセスして環境を列挙することはできません。ただし、**ローカル設定を列挙**して、アクセスできるリポジトリとユーザーに関する情報を取得することができます：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーがユーザー名をgithubのユーザー名として構成している場合、彼がアカウントで設定した**公開鍵**にアクセスできます。これを確認して、見つけたプライベートキーを使用できるかどうかを確認できます。

**SSH鍵**はリポジトリにも**デプロイ鍵**として設定できます。この鍵にアクセス権がある人は、リポジトリからプロジェクトを**起動**できます。通常、異なるデプロイ鍵を持つサーバーでは、ローカルファイル**`~/.ssh/config`**が関連する鍵に関する情報を提供します。

#### GPG鍵

[**こちら**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/github-security/broken-reference/README.md)で説明されているように、時にはコミットに署名する必要があるかもしれません。そうしないと発見されるかもしれません。

現在のユーザーがどのような鍵を持っているかをローカルで確認するには、以下をチェックしてください：
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用する場合

[**ユーザートークンに関する基本情報を確認する**](basic-github-information.md#personal-access-tokens)。

ユーザートークンは、Git over HTTPSのパスワードの代わりとして使用することができるか、[**Basic Authenticationを介してAPIに認証するために使用**](https://docs.github.com/v3/auth/#basic-authentication)できます。それに付随する権限に応じて、さまざまなアクションを実行できるかもしれません。

ユーザートークンは次のように見えます：`ghp_EfHnQFcFHX6fGIu5mpduvRiYR584kK0dX123`

### OAuthアプリケーションを使用する場合

[**Github OAuthアプリケーションに関する基本情報を確認する**](basic-github-information.md#oauth-applications)。

攻撃者は、特権データ/アクションにアクセスするために**悪意のあるOAuthアプリケーション**を作成し、それをおそらくフィッシングキャンペーンの一環として受け入れるユーザーの特権データ/アクションにアクセスするかもしれません。

これらは[OAuthアプリケーションがリクエストできるスコープ](https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps)です。受け入れる前にリクエストされたスコープを常に確認する必要があります。

さらに、基本情報で説明されているように、**組織はサードパーティーアプリケーションに情報/リポジトリ/アクションへのアクセスを許可/拒否**することができます。

### Githubアプリケーションを使用する場合

[**Githubアプリケーションに関する基本情報を確認する**](basic-github-information.md#github-applications)。

攻撃者は、特権データ/アクションにアクセスするために**悪意のあるGithubアプリケーション**を作成し、それをおそらくフィッシングキャンペーンの一環として受け入れるユーザーの特権データ/アクションにアクセスするかもしれません。

さらに、基本情報で説明されているように、**組織はサードパーティーアプリケーションに情報/リポジトリ/アクションへのアクセスを許可/拒否**することができます。

## Githubアクションの侵害と悪用

Githubアクションを侵害および悪用するためのいくつかのテクニックがあります。こちらをチェックしてください：

{% content-ref url="abusing-github-actions/" %}
[abusing-github-actions](abusing-github-actions/)
{% endcontent-ref %}

## ブランチ保護のバイパス

* **承認数を要求する**: 複数のアカウントを侵害した場合、他のアカウントからのPRを承認することができます。PRを作成したアカウントしか持っていない場合、自分のPRを承認することはできません。ただし、リポジトリ内の**Githubアクション**環境にアクセスできる場合、**GITHUB\_TOKEN**を使用して自分のPRを承認し、この方法で1つの承認を取得することができるかもしれません。
* _この点と通常、ユーザーは自分自身のPRを承認できないというコード所有者の制限について、自分のPRを承認することはできませんが、できる場合は、自分のPRを受け入れるために悪用することができます。_
* **新しいコミットがプッシュされると承認を取り消す**: これが設定されていない場合、正当なコードを提出し、誰かが承認するのを待ってから悪意のあるコードを追加し、保護されたブランチにマージすることができます。
* **Code Ownersからのレビューを要求する**: これが有効になっており、Code Ownersである場合、**Githubアクションを作成して自分のPRを作成し、自分で承認する**ことができます。
* **CODEOWNERファイルが誤構成されている場合**、Githubは警告を出しませんが、それを使用しません。したがって、誤構成されている場合、**Code Ownersの保護が適用されません**。
* **指定されたアクターがプルリクエスト要件をバイパスできるようにする**: これらのアクターの1人である場合、プルリクエストの保護をバイパスできます。
* **管理者を含める**: これが設定されていない場合、リポジトリの管理者である場合、このブランチ保護をバイパスできます。
* **PRハイジャック**: 他の誰かのPRを**変更して悪意のあるコードを追加**し、結果のPRを自分で承認してすべてをマージすることができるかもしれません。
* **ブランチ保護の削除**: リポジトリの**管理者である場合、保護を無効にでき**、自分のPRをマージしてから保護を再設定できます。
* **プッシュ保護をバイパスする**: リポジトリが**特定のユーザーのみにプッシュを許可**している場合（ブランチ保護がワイルドカード`*`を指定してすべてのブランチを保護しているかもしれません）。
* リポジトリに**書き込みアクセス権があるが、ブランチ保護のためにコードをプッシュすることができない**場合、新しいブランチを作成し、その中で**コードがプッシュされるとトリガーされるgithubアクションを作成**することができます。**ブランチ保護は作成されるまでブランチを保護しない**ため、最初のコードプッシュがブランチに対して**githubアクションを実行**します。

## 環境保護のバイパス

[**Github環境に関する基本情報を確認する**](basic-github-information.md#git-environments)。

環境が**すべてのブランチからアクセス可能**である場合、それは**保護されていない**ため、環境内のシークレットに簡単にアクセスできます。すべてのブランチが保護されている可能性があることに注意してください（その名前を指定するか、`*`を使用しているか）。その場合、コードをプッシュできるブランチを見つけて、新しいgithubアクションを作成（または変更）してシークレットを外部に出すことができます。

すべてのブランチが保護されている可能性があるエッジケースがあるかもしれません（ワイルドカード`*`を使用して）、**誰がブランチにコードをプッシュできるかが指定されている**（_これをブランチ保護で指定できます_）が、**あなたのユーザーは許可されていない**かもしれません。それでも、カスタムgithubアクションを実行できます。新しいブランチを作成し、自分自身にプッシュトリガーを使用できるためです。**ブランチ保護は新しいブランチへのプッシュを許可するため、githubアクションがトリガーされます**。
```yaml
push: # Run it when a push is made to a branch
branches:
- current_branch_name #Use '**' to run when a push is made to any branch
```
注意：**ブランチの作成後**、**ブランチ保護が新しいブランチに適用**され、変更できなくなりますが、その時点ですでにシークレットをダンプしています。

## 持続性

* **ユーザートークン**を生成する
* **シークレット**から**GitHubトークン**を盗む
* ワークフローの**結果**と**ブランチ**を**削除**する
* 組織全体に**より多くの権限を与える**
* 情報を外部に持ち出すための**Webhook**を作成する
* **外部コラボレーター**を招待する
* **SIEM**によって使用されている**Webhook**を**削除**する
* **バックドア**を持つ**Github Action**を作成/変更する
* **シークレット**値の変更を介した**コマンドインジェクション**に対する**脆弱なGithub Action**を見つける

### インポスターコミット - リポジトリコミットを介したバックドア

Githubでは、**フォークからリポジトリにPRを作成**することが可能です。PRが**受け入れられなくても**、元のリポジトリ内にはフォークバージョンのコードの**コミットID**が作成されます。したがって、攻撃者は、リポジトリの所有者によって作成されていないように見えるリポジトリから**特定のコミットを使用する**ことができます。

[**こちら**](https://github.com/actions/checkout/commit/c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e)のように
```yaml
name: example
on: [push]
jobs:
commit:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@c7d749a2d57b4b375d1ebcd17cfbfb60c676f18e
- shell: bash
run: |
echo 'hello world!'
```
詳細については、[こちら](https://www.chainguard.dev/unchained/what-the-fork-imposter-commits-in-github-actions-and-ci-cd)をチェックしてください。

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)**</strong>を使用して、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する
- **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
