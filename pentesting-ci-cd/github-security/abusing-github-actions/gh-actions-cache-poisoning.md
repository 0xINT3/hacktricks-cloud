# GH Actions - 缓存投毒

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks**中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## 缓存投毒

在CI中的任何地方使用[**action/cache**](https://github.com/actions/cache) Git操作将运行两个步骤：一个步骤将在调用时的**运行**过程中发生，另一个将在**工作流**后发生（如果运行操作返回了缓存未命中）。

* **运行操作** - 用于搜索和检索缓存。搜索是使用缓存键进行的，结果要么是缓存命中（成功，数据在缓存中找到）要么是缓存未命中。如果找到，文件和目录将从缓存中检索出来以供活动使用。如果结果是缓存未命中，所需的文件和目录将被下载，就像是第一次调用它们一样。
* **工作流后操作** - 用于保存缓存。如果运行操作中的缓存调用结果返回了缓存未命中，此操作将使用提供的键保存我们想要缓存的目录的当前状态。这个操作会自动发生，不需要显式调用。

**访问限制**通过在不同分支之间创建逻辑**边界**提供**缓存隔离**和安全性 _(例如：为分支**Feature-A**创建的缓存\[基于main]将无法被分支**Feature-B**的拉取请求访问\[基于main])_。

缓存操作首先搜索分支中包含**工作流运行**的键和恢复键的缓存命中。如果当前分支中没有命中，缓存操作会搜索父分支和上游分支中的键并恢复键。

访问缓存是按分支（当前和父级）限定的，这意味着提供对所述分支的所有**工作流**跨**运行**的访问。

另一个重要的注意事项是，GitHub不允许一旦条目被推送就进行修改 - 缓存条目是只读记录。

我们使用了一个包含两个工作流的示例CI。这个例子展示了如何从一个低权限工作流转移到一个高权限工作流的攻击。

* **单元测试**工作流运行单元测试和代码覆盖率工具。我们假设其中一个工具是恶意的或容易受到远程代码执行的攻击。工作流不需要使用**action/cache** Git操作。任何工作流都可以访问缓存。
* **发布**工作流构建和发布应用程序工件。此工作流使用缓存来优化使用Golang依赖项。

**单元测试**工作流使用一个恶意操作，通过更改Golang日志库（**go.uber.org/zap@v1**）添加字符串‘BAD library’到应用程序工件描述中，添加了一个带有恶意内容的缓存条目。

接下来，**发布**工作流使用这个被投毒的缓存条目。结果，恶意代码被注入到构建的Golang二进制文件和镜像中。缓存保持被投毒状态，直到丢弃条目键（通常由依赖项更新触发）。使用相同缓存键的任何其他**工作流**、**运行**和**子分支**都会受到同样的投毒缓存的影响。

在我们进行的测试中，我们成功地将字符串‘BAD library’注入到镜像描述中：

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

这是在0.4.1版本中。接下来，我们更新了标签并多次重建镜像，观察到‘Bad library’仍然存在于描述中。

这个技术取自[https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks**中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
