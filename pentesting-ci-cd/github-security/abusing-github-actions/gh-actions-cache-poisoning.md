# GH Actions - Envenenamento de Cache

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

## Envenenamento de Cache

Usando a a√ß√£o [**action/cache**](https://github.com/actions/cache) do Git em qualquer lugar do CI, ser√£o executadas duas etapas: uma etapa ocorrer√° durante o processo de **execu√ß√£o** quando for chamada e a outra ocorrer√° ap√≥s o **fluxo de trabalho** (se a a√ß√£o de execu√ß√£o retornar uma falha de cache).

* **A√ß√£o de execu√ß√£o** - √© usada para pesquisar e recuperar o cache. A pesquisa √© feita usando a chave do cache, com o resultado sendo um cache-hit (sucesso, dados encontrados no cache) ou cache-miss. Se encontrado, os arquivos e diret√≥rios s√£o recuperados do cache para uso ativo. Se o resultado for cache-miss, os arquivos e diret√≥rios desejados s√£o baixados como se fosse a primeira vez que s√£o chamados.
* **A√ß√£o p√≥s fluxo de trabalho** - usada para salvar o cache. Se o resultado da chamada de cache na a√ß√£o de execu√ß√£o retornar uma falha de cache, esta a√ß√£o salvar√° o estado atual dos diret√≥rios que desejamos armazenar em cache com a chave fornecida. Essa a√ß√£o acontece automaticamente e n√£o precisa ser chamada explicitamente.

As **restri√ß√µes de acesso** fornecem **isolamento de cache** e seguran√ßa, criando um **limite l√≥gico entre diferentes branches** _(por exemplo: um cache criado para a branch **Feature-A** \[com a base main] n√£o seria acess√≠vel a uma pull request para a branch **Feature-B** \[com a base main])_.

A a√ß√£o de cache primeiro procura por acertos de cache para uma chave e restaura as chaves no branch que cont√©m a **execu√ß√£o do fluxo de trabalho**. Se n√£o houver acertos no branch atual, a a√ß√£o de cache procura pela chave e restaura as chaves no branch pai e nos branches upstream.

O acesso a um cache √© limitado por branch (atual e pai), o que significa que o acesso √© fornecido a todos os **fluxos de trabalho** em todas as **execu√ß√µes** desse branch.

Outra observa√ß√£o importante √© que o GitHub n√£o permite modifica√ß√µes uma vez que as entradas s√£o enviadas - as entradas de cache s√£o registros somente leitura.

Usamos um exemplo de CI que inclu√≠a dois fluxos de trabalho. Este exemplo mostra como um ataque pode se mover de um fluxo de trabalho de baixa permiss√£o para um de alta permiss√£o.

* Fluxo de trabalho **Unit-test** executando testes de unidade e ferramentas de cobertura de c√≥digo. Supomos que uma das ferramentas seja maliciosa ou vulner√°vel a execu√ß√£o remota de c√≥digo. O fluxo de trabalho n√£o precisa usar a a√ß√£o **action/cache** do Git. Qualquer fluxo de trabalho pode acessar o cache.
* Fluxo de trabalho **Release** constr√≥i e libera o artefato da aplica√ß√£o. Este fluxo de trabalho usa um cache para otimizar o uso das depend√™ncias do Golang.

O fluxo de trabalho **unit-test** usa uma a√ß√£o maliciosa que adiciona uma entrada de cache com conte√∫do malicioso, alterando uma biblioteca de registro do Golang (**go.uber.org/zap@v1**) para adicionar a string 'BAD library' √† descri√ß√£o do artefato da aplica√ß√£o.

Em seguida, o fluxo de trabalho **release** usa essa entrada de cache envenenada. Como resultado, o c√≥digo malicioso √© injetado no bin√°rio e na imagem do Golang constru√≠dos. O cache permanece envenenado at√© que a chave da entrada seja descartada (geralmente acionada por atualiza√ß√µes de depend√™ncia). O mesmo cache envenenado afetar√° qualquer outro **fluxo de trabalho**, **execu√ß√£o** e **branch filho** que use a mesma chave de cache.

No teste que realizamos, conseguimos injetar a string 'BAD library' na descri√ß√£o da imagem:

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

Isso foi na vers√£o 0.4.1. Em seguida, atualizamos a tag e reconstru√≠mos a imagem v√°rias vezes e observamos que 'Bad library' permaneceu na descri√ß√£o.

Essas t√©cnicas foram retiradas de [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
