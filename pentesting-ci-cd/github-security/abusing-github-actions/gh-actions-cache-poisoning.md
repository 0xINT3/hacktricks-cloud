# GH Actions - キャッシュの汚染

<details>

<summary><strong>HackTricksをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## キャッシュの汚染

CIのどこでも[**action/cache**](https://github.com/actions/cache) Gitアクションを使用すると、2つのステップが実行されます。1つは**run**プロセスが呼び出されるときに行われ、もう1つは**workflow**の後に行われます（runアクションがキャッシュミスを返した場合）。

* **Runアクション** - キャッシュを検索して取得するために使用されます。キャッシュキーを使用して検索が行われ、結果はキャッシュヒット（成功、キャッシュ内のデータが見つかった）またはキャッシュミスです。見つかった場合、ファイルとディレクトリはキャッシュからアクティブに使用するために取得されます。結果がキャッシュミスの場合、必要なファイルとディレクトリは初めて呼び出されたかのようにダウンロードされます。
* **Post workflowアクション** - キャッシュを保存するために使用されます。runアクションでのキャッシュ呼び出しの結果がキャッシュミスの場合、このアクションは指定されたキーでキャッシュしたいディレクトリの現在の状態を保存します。このアクションは自動的に実行され、明示的に呼び出す必要はありません。

**アクセス制限**により、キャッシュの分離とセキュリティが提供され、異なるブランチ間に論理的な**境界**が作成されます（たとえば、ベースがmainのブランチ**Feature-A**のキャッシュは、ベースがmainのブランチのプルリクエストからアクセスできません）。

キャッシュアクションは、まずキーのキャッシュヒットを検索し、**ワークフローの実行**を含むブランチにキーを復元します。現在のブランチにヒットがない場合、キャッシュアクションは親ブランチと上流ブランチでキーを検索し、キーを復元します。

キャッシュへのアクセスはブランチ（現在のブランチと親ブランチ）でスコープが制限されるため、そのブランチの**ワークフロー**全体にわたって**実行**ごとにアクセスが提供されます。

もう1つの重要なポイントは、GitHubではエントリがプッシュされた後に変更を許可していないことです-キャッシュエントリは読み取り専用のレコードです。

私たちは、2つのワークフローを含む例のCIを使用しました。この例では、低い権限のワークフローから高い権限のワークフローに攻撃が移行する方法を示しています。

* **Unit-test**ワークフローはユニットテストとコードカバレッジツールを実行します。ツールの1つが悪意のあるコードまたはリモートコード実行の脆弱性を持っていると想定しています。このワークフローは**action/cache** Gitアクションを使用する必要はありません。どのワークフローでもキャッシュにアクセスできます。
* **Release**ワークフローはアプリケーションのアーティファクトをビルドしてリリースします。このワークフローはGolangの依存関係を最適化するためにキャッシュを使用します。

**unit-test**ワークフローは、悪意のあるアクションを使用してキャッシュエントリを追加し、Golangのロギングライブラリ（**go.uber.org/zap@v1**）を変更してアプリケーションのアーティファクトの説明に文字列「BAD library」を追加します。

次に、**release**ワークフローはこの汚染されたキャッシュエントリを使用します。その結果、悪意のあるコードがビルドされたGolangバイナリとイメージに注入されます。エントリキーが破棄されるまで、キャッシュは汚染されたままです（通常は依存関係の更新によってトリガされます）。同じ汚染されたキャッシュは、同じキャッシュキーを使用する他の**ワークフロー**、**実行**、および**子ブランチ**に影響を与えます。

私たちが行ったテストでは、文字列「BAD library」をイメージの説明に注入することに成功しました：

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

これはバージョン0.4.1で行われました。次に、タグを更新してイメージを何度も再ビルドしましたが、「Bad library」が説明に残っていることがわかりました。

この技術は[https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)から取得されました。

<details>

<summary><strong>HackTricksをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
