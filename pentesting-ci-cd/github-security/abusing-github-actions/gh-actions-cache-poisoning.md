# GH Actions - Cache Poisoning

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cache Poisoning

Usar la acci√≥n de Git [**action/cache**](https://github.com/actions/cache) en cualquier parte del CI ejecutar√° dos pasos: un paso tendr√° lugar durante el proceso de **ejecuci√≥n** cuando se llama y el otro tendr√° lugar despu√©s del **workflow** (si la acci√≥n de ejecuci√≥n devolvi√≥ un cache-miss).

* **Acci√≥n de ejecuci√≥n** ‚Äì se utiliza para buscar y recuperar la cach√©. La b√∫squeda se realiza utilizando la clave de cach√©, con el resultado siendo un cache-hit (√©xito, datos encontrados en cach√©) o cache-miss. Si se encuentra, los archivos y directorios se recuperan de la cach√© para su uso activo. Si el resultado es cache-miss, los archivos y directorios deseados se descargan como si fuera la primera vez que se llaman.
* **Acci√≥n post workflow** ‚Äì se utiliza para guardar la cach√©. Si el resultado de la llamada a la cach√© en la acci√≥n de ejecuci√≥n devuelve un cache-miss, esta acci√≥n guardar√° el estado actual de los directorios que queremos cachear con la clave proporcionada. Esta acci√≥n ocurre autom√°ticamente y no necesita ser llamada expl√≠citamente.

Las **restricciones de acceso** proporcionan **aislamiento de cach√©** y seguridad al crear un **l√≠mite l√≥gico entre diferentes ramas** _(por ejemplo: una cach√© creada para la rama **Feature-A** \[con la base principal] no ser√≠a accesible para un pull request para la rama **Feature-B** \[con la base principal])_.

La acci√≥n de cach√© primero busca aciertos de cach√© para una clave y restaura claves en la rama que contiene la **ejecuci√≥n del workflow**. Si no hay aciertos en la rama actual, la acci√≥n de cach√© busca la clave y restaura claves en la rama padre y ramas ascendentes.

El acceso a una cach√© est√° limitado por rama (actual y padre), lo que significa que se proporciona acceso a todos los **workflows** a trav√©s de **ejecuciones** de dicha rama.

Otra nota importante es que GitHub no permite modificaciones una vez que las entradas son empujadas ‚Äì las entradas de cach√© son registros de solo lectura.

Usamos un ejemplo de CI que inclu√≠a dos workflows. Este ejemplo muestra c√≥mo un ataque puede pivotar de un workflow de permisos bajos a uno de permisos altos.

* **Workflow de unit-test** ejecutando herramientas de pruebas unitarias y cobertura de c√≥digo. Suponemos que una de las herramientas es maliciosa o vulnerable a la ejecuci√≥n de c√≥digo remoto. El workflow no necesita usar la acci√≥n de Git **action/cache**. Cualquier workflow puede acceder a la cach√©.
* **Workflow de release** construye y libera el artefacto de la aplicaci√≥n. Este workflow utiliza una cach√© para optimizar el uso de las dependencias de Golang.

El **workflow de unit-test** utiliza una acci√≥n maliciosa que a√±ade una entrada de cach√© con contenido malicioso cambiando una biblioteca de registro de Golang (**go.uber.org/zap@v1**) para a√±adir la cadena, 'BAD library' a la descripci√≥n del artefacto de la aplicaci√≥n.

A continuaci√≥n, el **workflow de release** utiliza esta entrada de cach√© envenenada. Como resultado, el c√≥digo malicioso se inyecta en el binario de Golang construido y en la imagen. La cach√© permanece envenenada hasta que se descarta la clave de entrada (normalmente desencadenado por actualizaciones de dependencias). La misma cach√© envenenada afectar√° a cualquier otro **workflow**, **ejecuci√≥n** y **rama hija** que utilice la misma clave de cach√©.

En la prueba que realizamos, logramos inyectar la cadena 'BAD library' en la descripci√≥n de la imagen:

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

Esto fue en la versi√≥n 0.4.1. A continuaci√≥n, actualizamos la etiqueta y reconstruimos la imagen varias veces, y observamos que 'Bad library' permanec√≠a en la descripci√≥n.

Esta t√©cnica fue tomada de [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
