# GH Actions - 缓存污染

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问最新版本的 PEASS 或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## 缓存污染

在 CI 中使用 [**action/cache**](https://github.com/actions/cache) Git 操作将运行两个步骤：一个步骤将在调用时发生在 **run** 过程中，另一个步骤将在 **workflow** 后发生（如果运行操作返回了缓存未命中）。

* **运行操作** - 用于搜索和检索缓存。使用缓存键进行搜索，结果可能是缓存命中（成功，在缓存中找到数据）或缓存未命中。如果找到，文件和目录将从缓存中检索以供活动使用。如果结果是缓存未命中，则会像第一次调用时那样下载所需的文件和目录。
* **后续工作流操作** - 用于保存缓存。如果运行操作中的缓存调用结果返回了缓存未命中，此操作将保存我们想要使用提供的键缓存的目录的当前状态。此操作会自动发生，无需显式调用。

**访问限制**通过在不同分支之间创建逻辑**边界**（例如：为基于主分支的分支 **Feature-A** 创建的缓存将无法被基于主分支的分支 **Feature-B** 的拉取请求访问）来提供**缓存隔离**和安全性。

缓存操作首先在包含**工作流运行**的分支中搜索缓存命中并恢复键。如果当前分支中没有命中，则缓存操作会在父分支和上游分支中搜索缓存命中并恢复键。

对缓存的访问范围是按分支（当前和父级）进行的，这意味着在该分支的所有**工作流**和**运行**中提供访问。

另一个重要的注意事项是，GitHub 不允许在推送条目后进行修改 - 缓存条目是只读记录。

我们使用了一个包含两个工作流的示例 CI。此示例展示了如何从具有低权限的工作流转移到具有高权限的工作流。

* **Unit-test** 工作流运行单元测试和代码覆盖工具。我们假设其中一个工具存在恶意代码或远程代码执行漏洞。该工作流不需要使用 **action/cache** Git 操作。任何工作流都可以访问缓存。
* **Release** 工作流构建并发布应用程序构件。该工作流使用缓存来优化使用 Golang 依赖项。

**unit-test** 工作流使用恶意操作，通过更改 Golang 日志库（**go.uber.org/zap@v1**）添加了一个带有恶意内容的缓存条目，将字符串“BAD library”添加到应用程序构件描述中。

接下来，**release** 工作流使用了这个被污染的缓存条目。结果是，恶意代码被注入到构建的 Golang 二进制文件和镜像中。直到丢弃条目键（通常由依赖项更新触发），缓存仍然被污染。相同的污染缓存将影响使用相同缓存键的任何其他**工作流**、**运行**和**子分支**。

在我们进行的测试中，我们成功将字符串“BAD library”注入到图像描述中：

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

这是在版本 0.4.1 中发生的。接下来，我们更新了标签并多次重新构建了图像，并观察到“Bad library”仍然存在于描述中。

这个技术来自于 [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问最新版本的 PEASS 或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
