# GH Actions - Cache Poisoning

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cache Poisoning

Usar a a√ß√£o Git [**action/cache**](https://github.com/actions/cache) em qualquer lugar no CI executar√° dois passos: um passo ocorrer√° durante o processo de **execu√ß√£o** quando for chamado e o outro ocorrer√° ap√≥s o **workflow** (se a a√ß√£o de execu√ß√£o retornar um cache-miss).

* **A√ß√£o de execu√ß√£o** ‚Äì √© usada para procurar e recuperar o cache. A busca √© feita usando a chave de cache, com o resultado sendo um cache-hit (sucesso, dados encontrados no cache) ou cache-miss. Se encontrado, os arquivos e diret√≥rios s√£o recuperados do cache para uso ativo. Se o resultado for cache-miss, os arquivos e diret√≥rios desejados s√£o baixados como se fosse a primeira vez que s√£o chamados.
* **A√ß√£o p√≥s workflow** ‚Äì usada para salvar o cache. Se o resultado da chamada de cache na a√ß√£o de execu√ß√£o retornar um cache-miss, essa a√ß√£o salvar√° o estado atual dos diret√≥rios que queremos armazenar em cache com a chave fornecida. Essa a√ß√£o acontece automaticamente e n√£o precisa ser explicitamente chamada.

**Restri√ß√µes de acesso** fornecem **isolamento de cache** e seguran√ßa criando um **limite l√≥gico entre diferentes branches** _(por exemplo: um cache criado para a branch **Feature-A** \[com a base principal] n√£o seria acess√≠vel a um pull request para a branch **Feature-B** \[com a base principal])_.

A a√ß√£o de cache primeiro procura por cache hits para uma chave e restaura chaves no branch que cont√©m a **execu√ß√£o do workflow**. Se n√£o houver hits no branch atual, a a√ß√£o de cache procura pela chave e restaura chaves no branch pai e branches upstream.

O acesso a um cache √© limitado por branch (atual e pai), significando que o acesso √© fornecido a todos os **workflows** atrav√©s das **execu√ß√µes** do branch mencionado.

Outra nota importante √© que o GitHub n√£o permite modifica√ß√µes uma vez que as entradas s√£o enviadas ‚Äì entradas de cache s√£o registros somente leitura.

Usamos um exemplo de CI que inclu√≠a dois workflows. Este exemplo mostra como um ataque pode pivotar de um workflow de baixa permiss√£o para um de alta permiss√£o.

* **Workflow de unit-test** executando ferramentas de teste unit√°rio e cobertura de c√≥digo. Supomos que uma das ferramentas seja maliciosa ou vulner√°vel √† execu√ß√£o remota de c√≥digo. O workflow n√£o precisa usar a a√ß√£o Git **action/cache**. Qualquer workflow pode acessar o cache.
* **Workflow de release** constr√≥i e libera o artefato da aplica√ß√£o. Este workflow usa um cache para otimizar o uso das depend√™ncias do Golang.

O workflow de **unit-test** usa uma a√ß√£o maliciosa que adiciona uma entrada de cache com conte√∫do malicioso alterando uma biblioteca de logging do Golang (**go.uber.org/zap@v1**) para adicionar a string 'BAD library' √† descri√ß√£o do artefato da aplica√ß√£o.

Em seguida, o workflow de **release** usa essa entrada de cache envenenada. Como resultado, o c√≥digo malicioso √© injetado no bin√°rio Golang constru√≠do e na imagem. O cache permanece envenenado at√© que a chave de entrada seja descartada (geralmente acionada por atualiza√ß√µes de depend√™ncia). O mesmo cache envenenado afetar√° qualquer outro **workflow**, **execu√ß√£o** e **branch filho** que use a mesma chave de cache.

No teste que realizamos, conseguimos injetar a string 'BAD library' na descri√ß√£o da imagem:

![BAD library](https://scribesecurity.com/wp-content/uploads/2022/02/BAD-library-2-300x79.jpg)

Isso foi na vers√£o 0.4.1. Em seguida, atualizamos a tag e reconstru√≠mos a imagem v√°rias vezes, e observamos que 'Bad library' permaneceu na descri√ß√£o.

Esta t√©cnica foi retirada de [https://scribesecurity.com/blog/github-cache-poisoning/](https://scribesecurity.com/blog/github-cache-poisoning/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
