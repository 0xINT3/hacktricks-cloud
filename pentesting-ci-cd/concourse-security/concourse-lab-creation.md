# Cria√ß√£o de Laborat√≥rio Concourse

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me no** **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Ambiente de Teste

### Executando o Concourse

#### Com Docker-Compose

Este arquivo docker-compose simplifica a instala√ß√£o para fazer alguns testes com o Concourse:

```bash
wget https://raw.githubusercontent.com/starkandwayne/concourse-tutorial/master/docker-compose.yml
docker-compose up -d
```

Voc√™ pode baixar o comando `fly` para o seu sistema operacional na web em `127.0.0.1:8080`

#### Com Kubernetes (Recomendado)

Voc√™ pode facilmente implantar o Concourse no **Kubernetes** (no **minikube**, por exemplo) usando o helm-chart: [**concourse-chart**](https://github.com/concourse/concourse-chart).

```bash
brew install helm
helm repo add concourse https://concourse-charts.storage.googleapis.com/
helm install concourse-release concourse/concourse
# concourse-release ser√° o nome prefixo para os elementos do concourse no k8s
# Ap√≥s a instala√ß√£o, voc√™ encontrar√° as indica√ß√µes para se conectar a ele no console

# Se voc√™ precisar exclu√≠-lo
helm delete concourse-release
```

Depois de gerar o ambiente do Concourse, voc√™ pode gerar um segredo e dar acesso ao SA em execu√ß√£o no Concourse Web para acessar os segredos do K8s:

```yaml
echo 'apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: read-secrets
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]

---

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-secrets-concourse
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: read-secrets
subjects:
- kind: ServiceAccount
  name: concourse-release-web
  namespace: default
  
---

apiVersion: v1
kind: Secret
metadata:
  name: super
  namespace: concourse-release-main
type: Opaque
data:
  secret: MWYyZDFlMmU2N2Rm

' | kubectl apply -f -
```

### Criar Pipeline

Um pipeline √© composto por uma lista de [Jobs](https://concourse-ci.org/jobs.html) que cont√©m uma lista ordenada de [Steps](https://concourse-ci.org/steps.html).

### Steps

V√°rios tipos diferentes de etapas podem ser usados:

* **a** [**etapa `task`**](https://concourse-ci.org/task-step.html) **executa uma** [**tarefa**](https://concourse-ci.org/tasks.html)
* a etapa [`get`](https://concourse-ci.org/get-step.html) busca um [recurso](https://concourse-ci.org/resources.html)
* a etapa [`put`](https://concourse-ci.org/put-step.html) atualiza um [recurso](https://concourse-ci.org/resources.html)
* a etapa [`set_pipeline`](https://concourse-ci.org/set-pipeline-step.html) configura um [pipeline](https://concourse-ci.org/pipelines.html)
* a etapa [`load_var`](https://concourse-ci.org/load-var-step.html) carrega um valor em uma [var local](https://concourse-ci.org/vars.html#local-vars)
* a etapa [`in_parallel`](https://concourse-ci.org/in-parallel-step.html) executa etapas em paralelo
* a etapa [`do`](https://concourse-ci.org/do-step.html) executa etapas em sequ√™ncia
* o modificador de etapa [`across`](https://concourse-ci.org/across-step.html#schema.across) executa uma etapa v√°rias vezes; uma vez para cada combina√ß√£o de valores de vari√°veis
* a etapa [`try`](https://concourse-ci.org/try-step.html) tenta executar uma etapa e tem sucesso mesmo se a etapa falhar

Cada [etapa](https://concourse-ci.org/steps.html) em um [plano de trabalho](https://concourse-ci.org/jobs.html#schema.job.plan) √© executada em seu **pr√≥prio cont√™iner**. Voc√™ pode executar qualquer coisa que quiser dentro do cont√™iner _(ou seja, executar meus testes, executar este script bash, construir esta imagem, etc.)_. Portanto, se voc√™ tiver um trabalho com cinco etapas, o Concourse criar√° cinco cont√™ineres, um para cada etapa.

Portanto, √© poss√≠vel indicar o tipo de cont√™iner em que cada etapa precisa ser executada.

### Exemplo de Pipeline Simples

```yaml
jobs:
- name: simple
  plan:
  - task: simple-task
    privileged: true
    config:
      # Indica ao Concourse em qual tipo de worker essa tarefa deve ser executada
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: busybox # as imagens s√£o puxadas do docker hub por padr√£o
      run:
        path: sh
        args:
        - -cx
        - |
          sleep 1000
          echo "$SUPER_SECRET"
      params:
        SUPER_SECRET: ((super.secret))
```

```bash
fly -t tutorial set-pipeline -p pipe-name -c hello-world.yml
# os pipelines s√£o pausados quando criados pela primeira vez
fly -t tutorial unpause-pipeline -p pipe-name
# acione o trabalho e observe-o ser executado at√© a conclus√£o
fly -t tutorial trigger-job --job pipe-name/simple --watch
# De outro console
fly -t tutorial intercept --job pipe-name/simple
```

Verifique **127.0.0.1:8080** para ver o fluxo do pipeline.

### Script Bash com pipeline de entrada/sa√≠da

√â poss√≠vel **salvar os resultados de uma tarefa em um arquivo** e indicar que √© uma sa√≠da e, em seguida, indicar a entrada da pr√≥xima tarefa como a sa√≠da da tarefa anterior. O que o Concourse faz √© **montar o diret√≥rio da tarefa anterior na nova tarefa, onde voc√™ pode acessar os arquivos criados pela tarefa anterior**.

### Triggers

Voc√™ n√£o precisa acionar os trabalhos manualmente toda vez que precisar execut√°-los, tamb√©m pode program√°-los para serem executados sempre que:

* Algum tempo passa: [Recurso de tempo](https://github.com/concourse/time-resource/)
* Em novos commits no branch principal: [Recurso Git](https://github.com/concourse/git-resource)
* Novos PRs: [Recurso Github-PR](https://github.com/telia-oss/github-pr-resource)
* Buscar ou enviar a √∫ltima imagem do seu aplicativo: [Recurso de imagem do registro](https://github.com/concourse/registry-image-resource/)

Confira um exemplo de pipeline YAML que √© acionado em novos commits no master em [https://concourse-ci.org/tutorial-resources.html](https://concourse-ci.org/tutorial-resources.html)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, confira os [