# Cloudflareセキュリティ

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**する。
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>

Cloudflareアカウントには、設定できる**一般的な設定とサービス**があります。このページでは、各セクションの**セキュリティ関連設定**を分析します。

<figure><img src="../../.gitbook/assets/image (117).png" alt=""><figcaption></figcaption></figure>

## ウェブサイト

以下を確認してください：

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

### ドメイン登録

* **`Transfer Domains`**で、どのドメインも転送できないことを確認してください。

以下を確認してください：

{% content-ref url="cloudflare-domains.md" %}
[cloudflare-domains.md](cloudflare-domains.md)
{% endcontent-ref %}

## アナリティクス

_構成セキュリティレビューのためのチェック項目が見つかりませんでした。_

## ページ

各Cloudflareのページで：

* **`Build log`**に**機密情報**がないかを確認してください。
* ページに割り当てられた**Githubリポジトリ**に**機密情報**がないかを確認してください。
* **ワークフローコマンドインジェクション**や`pull_request_target`の妥協を通じて**潜在的なgithubリポジトリの侵害**をチェックしてください。詳細は[**Githubセキュリティページ**](../github-security/)を参照してください。
* `/fuctions`ディレクトリ（あれば）の**脆弱な機能**、`_redirects`ファイル（あれば）の**リダイレクト**、`_headers`ファイル（あれば）の**設定ミス**をチェックしてください。
* **Webページ**の**脆弱性**を、コードに**アクセスできる**場合は**blackbox**または**whitebox**でチェックしてください。
* 各ページの詳細`/<page_id>/pages/view/blocklist/settings/functions`で、**`Environment variables`**に**機密情報**がないかを確認してください。
* 詳細ページで**ビルドコマンド**と**ルートディレクトリ**をチェックし、ページを妥協させるための**潜在的なインジェクション**を確認してください。

## **ワーカー**

各Cloudflareのワーカーで以下をチェックしてください：

* トリガー：ワーカーをトリガーするものは何ですか？**ユーザーが送信したデータ**がワーカーによって**使用**される可能性がありますか？
* **`Settings`**で、**機密情報**を含む**`Variables`**をチェックしてください。
* ワーカーのコードをチェックし、**脆弱性**を検索してください（特にユーザーが入力を管理できる場所）。
* 制御できる指定されたページを返すSSRFをチェックしてください
* SVG画像内でJSを実行するXSSをチェックしてください

{% hint style="warning" %}
デフォルトでは、**ワーカーには** `<worker-name>.<account>.workers.dev` **などのURL**が割り当てられます。ユーザーは**サブドメイン**に設定できますが、その**元のURL**を知っていれば常にアクセスできます。
{% endhint %}

## R2

TODO

## Stream

TODO

## 画像

TODO

## セキュリティセンター

* 可能であれば、**`Security Insights`** **スキャン**と**`Infrastructure`** **スキャン**を実行してください。これにより、セキュリティに関連する興味深い情報が**強調**されます。
* セキュリティのミス構成と興味深い情報を確認してください

## Turnstile

TODO

## **ゼロトラスト**

{% content-ref url="cloudflare-zero-trust-network.md" %}
[cloudflare-zero-trust-network.md](cloudflare-zero-trust-network.md)
{% endcontent-ref %}

## 一括リダイレクト

{% hint style="info" %}
[**Bulk Redirects**](https://developers.cloudflare.com/rules/url-forwarding/bulk-redirects/)は、[Dynamic Redirects](https://developers.cloudflare.com/rules/url-forwarding/dynamic-redirects/)とは異なり、基本的に静的です。**文字列の置換**操作や正規表現をサポートしません。ただし、URLリダイレクトパラメータを構成して、URLの一致動作とランタイム動作に影響を与えることができます。
{% endhint %}

* リダイレクトの**式**と**要件**が**適切**かを確認してください。
* 興味深い情報を含む**機密な隠されたエンドポイント**もチェックしてください。

## 通知

* **通知**をチェックしてください。これらの通知はセキュリティ上推奨されます：
* `Usage Based Billing`
* `HTTP DDoS Attack Alert`
* `Layer 3/4 DDoS Attack Alert`
* `Advanced HTTP DDoS Attack Alert`
* `Advanced Layer 3/4 DDoS Attack Alert`
* `Flow-based Monitoring: Volumetric Attack`
* `Route Leak Detection Alert`
* `Access mTLS Certificate Expiration Alert`
* `SSL for SaaS Custom Hostnames Alert`
* `Universal SSL Alert`
* `Script Monitor New Code Change Detection Alert`
* `Script Monitor New Domain Alert`
* `Script Monitor New Malicious Domain Alert`
* `Script Monitor New Malicious Script Alert`
* `Script Monitor New Malicious URL Alert`
* `Script Monitor New Scripts Alert`
* `Script Monitor New Script Exceeds Max URL Length Alert`
* `Advanced Security Events Alert`
* `Security Events Alert`
* **すべての宛先**をチェックしてください。Webhook URLに**機密情報**（基本的なhttp認証）が含まれている可能性があります。Webhook URLが**HTTPS**を使用していることも確認してください。
* 追加のチェックとして、**クラウドフレア通知を第三者になりすます**ことができます。何か**危険なものを注入**する方法があるかもしれません。

## アカウントの管理

* **`Billing` -> `Payment info`**で、**クレジットカードの最後の4桁**、**有効期限**、**請求先住所**を確認できます。
* **`Billing` -> `Subscriptions`**で、アカウントで使用されている**プランタイプ**を確認できます。
* **`Members`**では、アカウントのすべてのメンバーとその**役割**を確認できます。プランタイプがエンタープライズでない場合、管理者とスーパー管理者の2つの役割しか存在しません。ただし、使用されている**プランがエンタープライズ**の場合、[**さらに多くの役割**](https://developers.cloudflare.com/fundamentals/account-and-billing/account-setup/account-roles/)を使用して最小特権の原則に従うことができます。
* したがって、可能な限り**エンタープライズプラン**を使用することが**推奨**されます。
* Membersで、どの**メンバー**が**2要素認証**を有効にしているかを確認できます。**すべて**のユーザーに有効にしてください。

{% hint style="info" %}
幸いなことに、**`Administrator`**の役割はメンバーシップの管理権限を与えません（特権の昇格や新しいメンバーの招待はできません）
{% endhint %}
## DDoS調査

[この部分をチェックしてください](cloudflare-domains.md#cloudflare-ddos-protection)。
