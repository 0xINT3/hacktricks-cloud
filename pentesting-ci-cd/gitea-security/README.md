# Gitea 安全性

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 什么是 Gitea

**Gitea** 是一个 **自托管的社区管理的轻量级代码托管** 解决方案，使用 Go 语言编写。

![](<../../.gitbook/assets/image (5) (1) (1) (1) (1).png>)

### 基本信息

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## 实验室

要在本地运行 Gitea 实例，您可以直接运行一个 docker 容器：
```bash
docker run -p 3000:3000 gitea/gitea
```
连接到端口3000以访问网页。

您也可以使用kubernetes运行它：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 未经认证的枚举

* 公共仓库：[http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 注册用户：[http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 注册组织：[http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

请注意，默认情况下 Gitea 允许新用户注册。这不会给新用户提供对其他组织/用户仓库的特别有趣的访问权限，但是**登录用户**可能能够**查看更多仓库或组织**。

## 内部利用

在这个场景中，我们假设你已经获得了某个 github 账户的一些访问权限。

### 使用用户凭证/网络 Cookie

如果你以某种方式已经拥有组织内某个用户的凭证（或者你窃取了会话 cookie），你可以**直接登录**并检查你对哪些**仓库**拥有哪些**权限**，你在**哪些团队**中，**列出其他用户**，以及**仓库是如何被保护的**。

请注意，可能会使用**两因素认证**，所以你只有在能够**通过该检查**时才能访问这些信息。

{% hint style="info" %}
请注意，如果你**设法窃取了 `i_like_gitea` cookie**（当前配置为 SameSite: Lax），你可以**完全冒充该用户**，无需凭证或两因素认证。
{% endhint %}

### 使用用户 SSH 密钥

Gitea 允许**用户**设置**SSH 密钥**，这将被用作**代表他们部署代码的认证方法**（不适用两因素认证）。

有了这个密钥，你可以对用户有一定权限的**仓库进行更改**，但是你不能使用它来访问 gitea api 来枚举环境。然而，你可以**枚举本地设置**以获取有关你所能访问的仓库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户将其用户名配置为他的gitea用户名，您可以访问他在 _https://github.com/\<gitea\_username>.keys_ 中设置的**公钥**，您可以检查这个来确认您找到的私钥是否可用。

**SSH密钥**也可以设置在仓库中作为**部署密钥**。任何拥有此密钥的人都将能够**从仓库启动项目**。通常在一个服务器上有不同的部署密钥，本地文件**`~/.ssh/config`** 将为您提供与密钥相关的信息。

#### GPG密钥

如[**此处**](broken-reference/)所解释的，有时需要签署提交，否则您可能会被发现。

检查当前用户是否有任何密钥，使用：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的基本信息，请查看基础信息**](basic-gitea-information.md#personal-access-tokens)。

用户令牌可以**代替密码**用于**认证**Gitea服务器[**通过API**](https://try.gitea.io/api/swagger#/)，它将拥有对用户的**完全访问权限**。

### 使用Oauth应用程序

有关[**Gitea Oauth应用程序的基本信息，请查看基础信息**](./#with-oauth-application)。

攻击者可能会创建一个**恶意的Oauth应用程序**来访问接受它们的用户的特权数据/操作，这可能是钓鱼活动的一部分。

如基础信息中所解释的，应用程序将拥有**对用户账户的完全访问权限**。

### 分支保护绕过

在Github中，我们有**github actions**，它默认获得一个**具有写权限的令牌**，可以用来**绕过分支保护**。在这种情况下**不存在**此类令牌，因此绕过的方法更有限。但让我们看看可以做什么：

* **启用推送**：如果任何拥有写权限的人都可以推送到分支，那么直接推送。
* **白名单限制推送**：同样，如果你在这个列表中，推送到分支。
* **启用合并白名单**：如果有合并白名单，你需要在其中。
* **要求审批大于0**：那么...你需要妥协另一个用户。
* **限制审批到白名单用户**：如果只有白名单用户可以批准...你需要妥协列表中的另一个用户。
* **驳回过时的审批**：如果新提交不会移除审批，你可以劫持一个已经批准的PR来注入你的代码并合并PR。

请注意，**如果你是组织/仓库管理员**，你可以绕过这些保护。

### 枚举Webhooks

**Webhooks**能够**将特定的gitea信息发送到某些地方**。你可能能够**利用该通信**。\
然而，通常会在**webhook**中设置一个**秘密**，你**无法检索**，这将**防止**知道webhook URL但不知道秘密的外部用户**利用该webhook**。\
但在某些情况下，人们没有在其位置设置**秘密**，而是将其作为参数**设置在URL中**，因此**检查URL**可能会让你**发现秘密**和其他你可以进一步利用的地方。

Webhooks可以在**仓库和组织级别**设置。

## 后期利用

### 服务器内部

如果你设法进入运行gitea的服务器内部，你应该搜索gitea配置文件。默认位置是`/data/gitea/conf/app.ini`

在这个文件中，你可以找到**密钥**和**密码**。

在gitea路径中（默认：/data/gitea），你还可以找到像下面这样的有趣信息：

* **sqlite**数据库：如果gitea没有使用外部数据库，它将使用sqlite数据库。
* **sessions**文件夹内的会话：运行`cat sessions/*/*/*`，你可以看到已登录用户的用户名（gitea也可能将会话保存在数据库中）。
* **jwt私钥**在jwt文件夹内。
* 更多**敏感信息**可能在这个文件夹中找到。

如果你在服务器内部，你也可以**使用`gitea`二进制文件**来访问/修改信息：

* `gitea dump`将转储gitea并生成一个.zip文件。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`将生成指定类型的令牌（持久性）。
* `gitea admin user change-password --username admin --password newpassword`更改密码。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token`创建新的管理员用户并获取访问令牌。

<details>

<summary><strong>从零到英雄学习AWS黑客攻击，使用</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks中看到你的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。

</details>
