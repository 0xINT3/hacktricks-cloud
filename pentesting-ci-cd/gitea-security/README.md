# Gitea安全

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 什么是Gitea

**Gitea**是一个用Go编写的**自托管的社区管理的轻量级代码托管**解决方案。

![](<../../.gitbook/assets/image (5) (1) (1) (1).png>)

### 基本信息

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## 实验

要在本地运行Gitea实例，您只需运行一个Docker容器：
```bash
docker run -p 3000:3000 gitea/gitea
```
连接到端口3000以访问网页。

您还可以使用Kubernetes运行它：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 未经身份验证的枚举

* 公共仓库：[http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 注册用户：[http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 注册组织：[http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

请注意，默认情况下，Gitea允许新用户注册。这不会给新用户特别有趣的访问权限，但是已登录的用户可能能够查看更多的仓库或组织。

## 内部利用

在这种情况下，我们假设您已经获得了某个github账户的访问权限。

### 使用用户凭据/网页Cookie

如果您已经以某个组织内的用户的凭据登录（或者您窃取了一个会话Cookie），您可以直接登录并检查您对哪些仓库拥有哪些权限，您在哪些团队中，列出其他用户，并查看仓库的保护方式。

请注意，可能使用了2FA，因此只有在您能够通过该检查时，您才能访问这些信息。

{% hint style="info" %}
请注意，如果您设法窃取了`i_like_gitea` cookie（当前配置为SameSite: Lax），您可以完全冒充该用户，而无需凭据或2FA。
{% endhint %}

### 使用用户SSH密钥

Gitea允许用户设置SSH密钥，该密钥将用作代表用户进行代码部署的身份验证方法（不应用2FA）。

使用此密钥，您可以对用户具有某些权限的仓库进行更改，但是您无法使用它访问gitea api以枚举环境。但是，您可以枚举本地设置以获取有关您可以访问的仓库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户将其用户名配置为其gitea用户名，则可以访问他在其帐户中设置的**公钥**，网址为_https://github.com/\<gitea\_username>.keys_，您可以检查此内容以确认您找到的私钥是否可用。

**SSH密钥**也可以设置在存储库中作为**部署密钥**。拥有此密钥的任何人都将能够从存储库中**启动项目**。通常，在具有不同部署密钥的服务器上，本地文件**`~/.ssh/config`**将为您提供与密钥相关的信息。

#### GPG密钥

如[**此处**](broken-reference/)所述，有时需要对提交进行签名，否则可能会被发现。

在本地检查当前用户是否有任何密钥：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的基本信息，请查看此处**](basic-gitea-information.md#personal-access-tokens)。

用户令牌可以用来**代替密码**对Gitea服务器进行**API身份验证**，它将对用户具有**完全访问权限**。

### 使用Oauth应用程序

有关[**Gitea Oauth应用程序的基本信息，请查看此处**](./#with-oauth-application)。

攻击者可能创建一个**恶意的Oauth应用程序**，以访问接受它们的用户的特权数据/操作，可能作为网络钓鱼活动的一部分。

如基本信息中所述，该应用程序将对用户帐户具有**完全访问权限**。

### 分支保护绕过

在Github中，我们有**github actions**，默认情况下会获得对仓库的**具有写入权限的令牌**，可以用于**绕过分支保护**。在这种情况下，这种绕过方法更加有限。但是让我们看看可以做什么：

* **启用推送**：如果任何具有写入访问权限的人都可以推送到分支，只需推送即可。
* **白名单限制推送**：同样，如果您在此列表中，则可以推送到分支。
* **启用合并白名单**：如果存在合并白名单，则需要在其中。
* **需要的批准数大于0**：然后...您需要入侵另一个用户。
* **将批准限制为白名单**：如果只有白名单用户可以批准...您需要入侵另一个在该列表中的用户。
* **解除过时的批准**：如果批准未随新提交而删除，您可以劫持已经批准的PR以注入您的代码并合并PR。

请注意，**如果您是组织/仓库管理员**，则可以绕过这些保护措施。

### 枚举Webhooks

**Webhooks**能够将特定的Gitea信息发送到某些地方。您可能能够**利用该通信**。\
然而，通常在**webhook**中设置了一个您无法检索的**秘密**，该秘密将**防止**知道webhook URL但不知道秘密的外部用户**利用该webhook**。\
但是在某些情况下，人们不是将**秘密**设置在其位置，而是将其作为参数设置在URL中，因此**检查URL**可能允许您**找到秘密**和其他您可以进一步利用的地方。

Webhooks可以在**仓库和组织级别**上设置。

## 后渗透

### 在服务器内部

如果您设法进入运行Gitea的服务器内部，您应该搜索Gitea配置文件。默认情况下，它位于`/data/gitea/conf/app.ini`。

在此文件中，您可以找到**密钥**和**密码**。

在Gitea路径中（默认为：/data/gitea），您还可以找到有趣的信息，例如：

* **sqlite**数据库：如果Gitea未使用外部数据库，则将使用sqlite数据库。
* 会话文件夹中的**会话**：运行`cat sessions/*/*/*`，您可以看到已登录用户的用户名（Gitea也可以将会话保存在数据库中）。
* jwt文件夹中的**jwt私钥**。
* 此文件夹中可能还包含更多**敏感信息**。

如果您在服务器内部，还可以使用`gitea`二进制文件访问/修改信息：

* `gitea dump`将转储Gitea并生成.zip文件。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`将生成指定类型（持久性）的令牌。
* `gitea admin user change-password --username admin --password newpassword`更改密码。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token`创建新的管理员用户并获取访问令牌。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向**[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>
