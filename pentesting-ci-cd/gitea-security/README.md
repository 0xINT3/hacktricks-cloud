# Seguran√ßa do Gitea

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## O que √© o Gitea

**Gitea** √© uma **solu√ß√£o de hospedagem de c√≥digo leve, gerenciada pela comunidade e auto-hospedada** escrita em Go.

![](<../../.gitbook/assets/image (160).png>)

### Informa√ß√µes B√°sicas

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laborat√≥rio

Para executar uma inst√¢ncia do Gitea localmente, voc√™ pode simplesmente executar um cont√™iner docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
Conecte √† porta 3000 para acessar a p√°gina web.

Voc√™ tamb√©m pode execut√°-lo com o Kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Enumera√ß√£o n√£o autenticada

* Reposit√≥rios p√∫blicos: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Usu√°rios registrados: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organiza√ß√µes registradas: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Observe que por **padr√£o o Gitea permite que novos usu√°rios se registrem**. Isso n√£o dar√° acesso especialmente interessante aos novos usu√°rios sobre os reposit√≥rios de outras organiza√ß√µes/usu√°rios, mas um **usu√°rio logado** pode ser capaz de **visualizar mais reposit√≥rios ou organiza√ß√µes**.

## Explora√ß√£o Interna

Para este cen√°rio, vamos supor que voc√™ obteve algum acesso a uma conta do github.

### Com Credenciais de Usu√°rio/Cookie da Web

Se de alguma forma voc√™ j√° possui credenciais de um usu√°rio dentro de uma organiza√ß√£o (ou voc√™ roubou um cookie de sess√£o) voc√™ pode **apenas fazer login** e verificar quais **permiss√µes voc√™ tem** sobre quais **reposit√≥rios**, em **quais equipes** voc√™ est√°, **listar outros usu√°rios**, e **como os reposit√≥rios est√£o protegidos**.

Observe que **a autentica√ß√£o de dois fatores (2FA) pode ser usada**, ent√£o voc√™ s√≥ poder√° acessar essas informa√ß√µes se tamb√©m **passar por essa verifica√ß√£o**.

{% hint style="info" %}
Observe que se voc√™ **conseguir roubar o cookie `i_like_gitea`** (atualmente configurado com SameSite: Lax) voc√™ pode **se passar completamente pelo usu√°rio** sem precisar de credenciais ou 2FA.
{% endhint %}

### Com Chave SSH do Usu√°rio

O Gitea permite que **usu√°rios** configurem **chaves SSH** que ser√£o usadas como **m√©todo de autentica√ß√£o para implantar c√≥digo** em seu nome (nenhum 2FA √© aplicado).

Com essa chave, voc√™ pode fazer **altera√ß√µes nos reposit√≥rios onde o usu√°rio tem alguns privil√©gios**, no entanto, voc√™ n√£o pode us√°-la para acessar a API do gitea para enumerar o ambiente. No entanto, voc√™ pode **enumerar as configura√ß√µes locais** para obter informa√ß√µes sobre os reposit√≥rios e usu√°rios aos quais voc√™ tem acesso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Se o usu√°rio tiver configurado seu nome de usu√°rio como seu nome de usu√°rio do gitea, voc√™ pode acessar as **chaves p√∫blicas que ele definiu** em sua conta em _https://github.com/\<gitea\_username>.keys_, voc√™ pode verificar isso para confirmar se a chave privada que voc√™ encontrou pode ser usada.

As **chaves SSH** tamb√©m podem ser definidas em reposit√≥rios como **chaves de implanta√ß√£o**. Qualquer pessoa com acesso a essa chave poder√° **iniciar projetos a partir de um reposit√≥rio**. Geralmente, em um servidor com diferentes chaves de implanta√ß√£o, o arquivo local **`~/.ssh/config`** fornecer√° informa√ß√µes sobre qual chave est√° relacionada.

#### Chaves GPG

Conforme explicado [**aqui**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md) √†s vezes √© necess√°rio assinar os commits ou voc√™ pode ser descoberto.

Verifique localmente se o usu√°rio atual possui alguma chave com:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Com Token de Usu√°rio

Para uma introdu√ß√£o sobre [**Tokens de Usu√°rio, confira as informa√ß√µes b√°sicas**](basic-gitea-information.md#personal-access-tokens).

Um token de usu√°rio pode ser usado **em vez de uma senha** para **autenticar** contra o servidor Gitea [**via API**](https://try.gitea.io/api/swagger#/). Ele ter√° **acesso completo** sobre o usu√°rio.

### Com Aplicativo Oauth

Para uma introdu√ß√£o sobre [**Aplicativos Oauth do Gitea, confira as informa√ß√µes b√°sicas**](./#with-oauth-application).

Um atacante pode criar um **Aplicativo Oauth malicioso** para acessar dados/a√ß√µes privilegiados dos usu√°rios que os aceitam, provavelmente como parte de uma campanha de phishing.

Conforme explicado nas informa√ß√µes b√°sicas, o aplicativo ter√° **acesso total √† conta do usu√°rio**.

### Bypass de Prote√ß√£o de Branch

No Github, temos **a√ß√µes do github** que por padr√£o obt√™m um **token com acesso de grava√ß√£o** sobre o reposit√≥rio que pode ser usado para **burlar as prote√ß√µes de branch**. Neste caso que **n√£o existe**, ent√£o os bypasses s√£o mais limitados. Mas vamos ver o que pode ser feito:

* **Habilitar Push**: Se qualquer pessoa com acesso de grava√ß√£o puder fazer push para o branch, basta fazer push para ele.
* **Whitelist de Push Restrito**: Da mesma forma, se voc√™ fizer parte desta lista, fa√ßa push para o branch.
* **Habilitar Lista Branca de Merge**: Se houver uma lista branca de merge, voc√™ precisa estar dentro dela.
* **Exigir aprova√ß√µes maiores que 0**: Ent√£o... voc√™ precisa comprometer outro usu√°rio.
* **Restringir aprova√ß√µes a usu√°rios da lista branca**: Se apenas usu√°rios da lista branca puderem aprovar... voc√™ precisa comprometer outro usu√°rio que esteja dentro dessa lista.
* **Ignorar aprova√ß√µes obsoletas**: Se as aprova√ß√µes n√£o forem removidas com novos commits, voc√™ poderia se apropriar de um PR j√° aprovado para injetar seu c√≥digo e mesclar o PR.

Observe que **se voc√™ for um administrador de org/repo** voc√™ pode burlar as prote√ß√µes.

### Enumerar Webhooks

**Webhooks** s√£o capazes de **enviar informa√ß√µes espec√≠ficas do gitea para alguns lugares**. Voc√™ pode ser capaz de **explorar essa comunica√ß√£o**.\
No entanto, geralmente um **segredo** que voc√™ **n√£o pode recuperar** √© definido no **webhook** que ir√° **impedir** usu√°rios externos que conhecem a URL do webhook, mas n√£o o segredo, de **explorar esse webhook**.\
Mas em algumas ocasi√µes, as pessoas, em vez de definir o **segredo** em seu lugar, o **definem na URL** como um par√¢metro, ent√£o **verificar as URLs** poderia permitir que voc√™ **encontre segredos** e outros lugares que voc√™ poderia explorar ainda mais.

Os webhooks podem ser configurados no **n√≠vel do reposit√≥rio e da organiza√ß√£o**.

## P√≥s-Explora√ß√£o

### Dentro do servidor

Se de alguma forma voc√™ conseguiu acessar o servidor onde o gitea est√° sendo executado, voc√™ deve procurar pelo arquivo de configura√ß√£o do gitea. Por padr√£o, ele est√° localizado em `/data/gitea/conf/app.ini`

Neste arquivo, voc√™ pode encontrar **chaves** e **senhas**.

No caminho do gitea (por padr√£o: /data/gitea), voc√™ tamb√©m pode encontrar informa√ß√µes interessantes como:

* O **DB sqlite**: Se o gitea n√£o estiver usando um db externo, ele usar√° um db sqlite
* As **sess√µes** dentro da pasta de sess√µes: Executando `cat sessions/*/*/*` voc√™ pode ver os nomes de usu√°rio dos usu√°rios logados (o gitea tamb√©m pode salvar as sess√µes dentro do DB).
* A **chave privada jwt** dentro da pasta jwt
* Mais **informa√ß√µes sens√≠veis** podem ser encontradas nesta pasta

Se voc√™ estiver dentro do servidor, tamb√©m pode **usar o bin√°rio `gitea`** para acessar/modificar informa√ß√µes:

* `gitea dump` ir√° fazer dump do gitea e gerar um arquivo .zip
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` ir√° gerar um token do tipo indicado (persist√™ncia)
* `gitea admin user change-password --username admin --password novasenha` Alterar a senha
* `gitea admin user create --username novousuario --password superpassword --email user@user.user --admin --access-token` Criar novo usu√°rio administrador e obter um token de acesso
