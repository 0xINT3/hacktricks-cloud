# S√©curit√© de Gitea

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Qu'est-ce que Gitea

**Gitea** est une **solution d'h√©bergement de code l√©g√®re auto-h√©berg√©e g√©r√©e par la communaut√©** √©crite en Go.

![](<../../.gitbook/assets/image (160).png>)

### Informations de base

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laboratoire

Pour ex√©cuter une instance Gitea localement, vous pouvez simplement ex√©cuter un conteneur docker :
```bash
docker run -p 3000:3000 gitea/gitea
```
Connectez-vous au port 3000 pour acc√©der √† la page web.

Vous pouvez √©galement l'ex√©cuter avec Kubernetes :
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## √ânum√©ration non authentifi√©e

* D√©p√¥ts publics : [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Utilisateurs enregistr√©s : [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organisations enregistr√©es : [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Notez que par **d√©faut, Gitea permet aux nouveaux utilisateurs de s'inscrire**. Cela ne donnera pas un acc√®s particuli√®rement int√©ressant aux nouveaux utilisateurs par rapport aux d√©p√¥ts d'autres organisations/utilisateurs, mais un **utilisateur connect√©** pourrait √™tre en mesure de **visualiser plus de d√©p√¥ts ou d'organisations**.

## Exploitation interne

Pour ce sc√©nario, nous allons supposer que vous avez obtenu un certain acc√®s √† un compte github.

### Avec les identifiants de l'utilisateur/le cookie Web

Si vous avez d'une mani√®re ou d'une autre d√©j√† les identifiants d'un utilisateur au sein d'une organisation (ou si vous avez vol√© un cookie de session), vous pouvez **simplement vous connecter** et v√©rifier quels **permissions vous avez** sur quels **d√©p√¥ts**, dans **quelles √©quipes** vous √™tes, **listez d'autres utilisateurs**, et **comment les d√©p√¥ts sont prot√©g√©s**.

Notez que **l'authentification √† deux facteurs (2FA) peut √™tre utilis√©e**, donc vous ne pourrez acc√©der √† ces informations que si vous pouvez √©galement **passer cette v√©rification**.

{% hint style="info" %}
Notez que si vous **parvenez √† voler le cookie `i_like_gitea`** (actuellement configur√© avec SameSite: Lax), vous pouvez **compl√®tement usurper l'identit√© de l'utilisateur** sans avoir besoin d'identifiants ou de 2FA.
{% endhint %}

### Avec la cl√© SSH de l'utilisateur

Gitea permet aux **utilisateurs** de d√©finir des **cl√©s SSH** qui seront utilis√©es comme **m√©thode d'authentification pour d√©ployer du code** en leur nom (aucun 2FA n'est appliqu√©).

Avec cette cl√©, vous pouvez effectuer des **modifications dans les d√©p√¥ts o√π l'utilisateur a certains privil√®ges**, cependant vous ne pouvez pas l'utiliser pour acc√©der √† l'API de Gitea pour √©num√©rer l'environnement. Cependant, vous pouvez **√©num√©rer les param√®tres locaux** pour obtenir des informations sur les d√©p√¥ts et l'utilisateur auxquels vous avez acc√®s :
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si l'utilisateur a configur√© son nom d'utilisateur comme son nom d'utilisateur gitea, vous pouvez acc√©der aux **cl√©s publiques qu'il a d√©finies** dans son compte sur _https://github.com/\<gitea\_username>.keys_, vous pourriez v√©rifier cela pour confirmer que la cl√© priv√©e que vous avez trouv√©e peut √™tre utilis√©e.

Les **cl√©s SSH** peuvent √©galement √™tre d√©finies dans les d√©p√¥ts en tant que **cl√©s de d√©ploiement**. Toute personne ayant acc√®s √† cette cl√© pourra **lancer des projets √† partir d'un d√©p√¥t**. Habituellement, sur un serveur avec diff√©rentes cl√©s de d√©ploiement, le fichier local **`~/.ssh/config`** vous donnera des informations sur la cl√© concern√©e.

#### Cl√©s GPG

Comme expliqu√© [**ici**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md) parfois il est n√©cessaire de signer les commits ou vous pourriez √™tre d√©couvert.

V√©rifiez localement si l'utilisateur actuel a une cl√© avec :
```shell
gpg --list-secret-keys --keyid-format=long
```
### Avec un jeton utilisateur

Pour une introduction sur les [**Jetons Utilisateurs, consultez les informations de base**](basic-gitea-information.md#personal-access-tokens).

Un jeton utilisateur peut √™tre utilis√© **√† la place d'un mot de passe** pour **s'authentifier** contre le serveur Gitea [**via API**](https://try.gitea.io/api/swagger#/). Il aura un **acc√®s complet** sur l'utilisateur.

### Avec une Application Oauth

Pour une introduction sur les [**Applications Oauth Gitea, consultez les informations de base**](./#with-oauth-application).

Un attaquant pourrait cr√©er une **Application Oauth malveillante** pour acc√©der aux donn√©es/actions privil√©gi√©es des utilisateurs qui les acceptent probablement dans le cadre d'une campagne de phishing.

Comme expliqu√© dans les informations de base, l'application aura un **acc√®s complet sur le compte utilisateur**.

### Contournement de la Protection de Branche

Sur Github, nous avons des **actions github** qui obtiennent par d√©faut un **jeton avec acc√®s en √©criture** sur le d√©p√¥t qui peut √™tre utilis√© pour **contourner les protections de branche**. Dans ce cas, cela **n'existe pas**, donc les contournements sont plus limit√©s. Mais voyons ce qui peut √™tre fait :

* **Activer la Pouss√©e** : Si n'importe qui avec un acc√®s en √©criture peut pousser sur la branche, il suffit de pousser dessus.
* **Liste blanche de Pouss√©e Restreinte** : De la m√™me mani√®re, si vous faites partie de cette liste, poussez sur la branche.
* **Activer la Liste Blanche de Fusion** : Si une liste blanche de fusion existe, vous devez en faire partie.
* **Exiger des approbations sup√©rieures √† 0** : Alors... vous devez compromettre un autre utilisateur.
* **Restreindre les approbations aux utilisateurs autoris√©s** : Si seuls les utilisateurs autoris√©s peuvent approuver... vous devez compromettre un autre utilisateur qui est dans cette liste.
* **Rejeter les approbations p√©rim√©es** : Si les approbations ne sont pas supprim√©es avec de nouveaux commits, vous pourriez d√©tourner une PR d√©j√† approuv√©e pour injecter votre code et fusionner la PR.

Notez que **si vous √™tes un admin d'org/d√©p√¥t**, vous pouvez contourner les protections.

### √ânum√©rer les Webhooks

Les **Webhooks** sont capables d'**envoyer des informations sp√©cifiques de Gitea √† certains endroits**. Vous pourriez √™tre en mesure d'**exploiter cette communication**.\
Cependant, g√©n√©ralement un **secret** que vous ne pouvez **pas r√©cup√©rer** est d√©fini dans le **webhook** qui **emp√™chera** les utilisateurs externes qui connaissent l'URL du webhook mais pas le secret d'**exploiter ce webhook**.\
Mais dans certaines occasions, au lieu de d√©finir le **secret** √† sa place, ils le **d√©finissent dans l'URL** en tant que param√®tre, donc **v√©rifier les URLs** pourrait vous permettre de **trouver des secrets** et d'autres endroits que vous pourriez exploiter davantage.

Les webhooks peuvent √™tre d√©finis au **niveau du d√©p√¥t et de l'org**.

## Post Exploitation

### √Ä l'int√©rieur du serveur

Si d'une mani√®re ou d'une autre vous avez r√©ussi √† acc√©der au serveur o√π Gitea est en cours d'ex√©cution, vous devriez rechercher le fichier de configuration de Gitea. Par d√©faut, il se trouve dans `/data/gitea/conf/app.ini`

Dans ce fichier, vous pouvez trouver des **cl√©s** et des **mots de passe**.

Dans le chemin de Gitea (par d√©faut : /data/gitea), vous pouvez √©galement trouver des informations int√©ressantes comme :

* La **base de donn√©es sqlite** : Si Gitea n'utilise pas une base de donn√©es externe, il utilisera une base de donn√©es sqlite
* Les **sessions** √† l'int√©rieur du dossier des sessions : En ex√©cutant `cat sessions/*/*/*`, vous pouvez voir les noms d'utilisateur des utilisateurs connect√©s (Gitea pourrait √©galement sauvegarder les sessions dans la base de donn√©es).
* La **cl√© priv√©e jwt** √† l'int√©rieur du dossier jwt
* D'autres **informations sensibles** pourraient √™tre trouv√©es dans ce dossier

Si vous √™tes √† l'int√©rieur du serveur, vous pouvez √©galement **utiliser le binaire `gitea`** pour acc√©der/modifier des informations :

* `gitea dump` va sauvegarder Gitea et g√©n√©rer un fichier .zip
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` va g√©n√©rer un jeton du type indiqu√© (persistant)
* `gitea admin user change-password --username admin --password newpassword` Changer le mot de passe
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Cr√©er un nouvel utilisateur admin et obtenir un jeton d'acc√®s
