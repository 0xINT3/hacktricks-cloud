# Gitea セキュリティ

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)**</strong> で **ゼロからヒーローまでAWSハッキングを学ぶ**！</summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする
- **ハッキングテクニックを共有するためにPRを送信して** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリに貢献する

</details>

## Gitea とは

**Gitea** は、Goで書かれた **自己ホスト型のコミュニティ管理された軽量なコードホスティング** ソリューションです。

![](<../../.gitbook/assets/image (160).png>)

### 基本情報

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## ラボ

ローカルで Gitea インスタンスを実行するには、単に Docker コンテナを実行すればよいです:
```bash
docker run -p 3000:3000 gitea/gitea
```
ポート3000に接続してウェブページにアクセスします。

また、Kubernetesで実行することもできます：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 認証されていない列挙

* パブリックリポジトリ：[http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 登録ユーザー：[http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 登録組織：[http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

**デフォルトでは、Giteaは新しいユーザーの登録を許可**しています。これにより、新しいユーザーは他の組織/ユーザーのリポジトリに比べて特に興味深いアクセス権を得ることはできませんが、**ログインしたユーザー**は**より多くのリポジトリや組織を視覚化**できるかもしれません。

## 内部悪用

このシナリオでは、GitHubアカウントへのアクセス権を取得したと仮定します。

### ユーザー資格情報/ Web Cookieを使用

もし組織内のユーザーの資格情報をすでに持っている場合（またはセッションCookieを盗んだ場合）、**ログイン**して、**どのような** **権限**を持っているか、**どのリポジトリ**に対して、**どのチーム**に所属しているか、**他のユーザーをリスト**し、**リポジトリがどのように保護されているか**を確認できます。

**2FAが使用されている**場合があるため、そのチェックを**パス**できる場合にのみこの情報にアクセスできます。

{% hint style="info" %}
**`i_like_gitea` cookieを盗む**ことに成功した場合（現在はSameSite: Laxで構成されています）、資格情報や2FAを必要とせずに**ユーザーを完全になりすます**ことができます。
{% endhint %}

### ユーザーSSHキーを使用

Giteaは**ユーザーがSSHキーを設定**できるようにしており、これは**コードをデプロイするための認証方法**として使用されます（2FAは適用されません）。

このキーを使用すると、**ユーザーが特定の権限を持つリポジトリで変更を行う**ことができますが、これを使用してgitea apiにアクセスして環境を列挙することはできません。ただし、**ローカル設定を列挙**して、アクセス権を持つリポジトリとユーザーに関する情報を取得することができます。
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーが自分のgiteaユーザー名を設定している場合、彼がアカウントで設定した**公開鍵**にアクセスできます。_https://github.com/\<gitea\_username>.keys_で、見つけたプライベートキーが使用できるか確認できます。

**SSHキー**は**デプロイキー**としてリポジトリに設定することもできます。このキーにアクセス権限がある人は、リポジトリからプロジェクトを**起動**できます。通常、異なるデプロイキーを持つサーバーでは、ローカルファイル**`~/.ssh/config`**が関連するキーに関する情報を提供します。

#### GPGキー

[**こちら**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md)で説明されているように、時にはコミットに署名する必要があるか、発見される可能性があります。

現在のユーザーが持っているキーをローカルで確認するには、以下をチェックしてください：
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用する場合

[**ユーザートークンに関する基本情報を確認する**](basic-gitea-information.md#personal-access-tokens)。

ユーザートークンは、Giteaサーバーに対して**API経由で認証**するために、**パスワードの代わりに**使用できます。これにより、ユーザートークンはユーザーに**完全なアクセス権**を与えます。

### OAuthアプリケーションを使用する場合

[**Gitea OAuthアプリケーションに関する基本情報を確認する**](./#with-oauth-application)。

攻撃者は、**悪意のあるOAuthアプリケーション**を作成して、ユーザーの特権データ/アクションにアクセスし、おそらくフィッシングキャンペーンの一環としてそれらを受け入れるユーザーの特権データ/アクションにアクセスする可能性があります。

基本情報で説明されているように、このアプリケーションはユーザーアカウントに対して**完全なアクセス権**を持ちます。

### ブランチ保護のバイパス

Githubには、デフォルトでリポジトリに対して**書き込みアクセス権を持つトークン**を取得する**github actions**があり、これを使用して**ブランチ保護をバイパス**できます。この場合、それが存在しないため、バイパスはより制限されています。しかし、以下のことができるかどうかを見てみましょう：

- **プッシュを有効にする**：書き込みアクセス権を持つ人がブランチにプッシュできる場合、単にプッシュします。
- **ホワイトリスト制限プッシュ**：同様に、このリストの一部であれば、ブランチにプッシュできます。
- **マージホワイトリストを有効にする**：マージホワイトリストがある場合、そのリストに含まれている必要があります。
- **承認が0より大きい場合**：その場合... 別のユーザーを妥協させる必要があります。
- **承認をホワイトリストに制限する**：ホワイトリストされたユーザーのみが承認できる場合... そのリストに含まれる別のユーザーを妥協させる必要があります。
- **ステール承認を無視する**：承認が新しいコミットで削除されない場合、既に承認されたPRを乗っ取ってコードを注入し、PRをマージできます。

**組織/リポジトリの管理者**であれば、保護をバイパスできることに注意してください。

### Webhookの列挙

**Webhook**は、特定のGitea情報を一部の場所に**送信**できます。その通信を**悪用**する可能性があります。\
ただし、通常、**webhook**には**取得できない秘密**が設定されており、その秘密を知っているがURLを知らない外部ユーザーが**webhookを悪用**するのを**防ぐ**でしょう。\
ただし、一部の場合、人々は**秘密**をその場所に設定する代わりに、URLのパラメータとして**設定**します。そのため、URLを**チェック**すると、**秘密**やさらに悪用できる場所を見つけることができるかもしれません。

Webhookは**リポジトリと組織レベル**で設定できます。

## ポストエクスプロイテーション

### サーバー内部

何らかの方法でGiteaが実行されているサーバー内部に侵入できた場合、Gitea構成ファイルを検索する必要があります。デフォルトでは、それは`/data/gitea/conf/app.ini`にあります。

このファイルには**キー**や**パスワード**が含まれています。

Giteaパス（デフォルト：/data/gitea）には、次のような興味深い情報も含まれています：

- **sqlite** DB：Giteaが外部DBを使用していない場合、sqlite DBを使用します
- セッションフォルダ内の**セッション**：`cat sessions/*/*/*`を実行すると、ログインユーザーのユーザー名を確認できます（GiteaはセッションをDB内に保存することもあります）。
- jwtフォルダ内の**jwtプライベートキー**
- このフォルダにはより多くの**機密情報**が含まれている可能性があります

サーバー内部にいる場合、`gitea`バイナリを使用して情報にアクセス/変更することもできます：

- `gitea dump`はGiteaをダンプし、.zipファイルを生成します
- `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`は、指定されたタイプのトークン（永続性）を生成します
- `gitea admin user change-password --username admin --password newpassword` パスワードを変更します
- `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` 新しい管理者ユーザーを作成し、アクセストークンを取得します
