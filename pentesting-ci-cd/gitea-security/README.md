# Gitea セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## Giteaとは

**Gitea**は、Goで書かれた**自己ホスト型のコミュニティ管理軽量コードホスティング**ソリューションです。

![](<../../.gitbook/assets/image (5) (1) (1) (1) (1) (1).png>)

### 基本情報

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## ラボ

ローカルでGiteaインスタンスを実行するには、dockerコンテナを実行するだけです：
```bash
docker run -p 3000:3000 gitea/gitea
```
```
ポート3000に接続して、ウェブページにアクセスします。

また、kubernetesを使って実行することもできます：
```
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 認証されていない列挙

* 公開リポジトリ: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 登録ユーザー: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 登録組織: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

**デフォルトではGiteaは新規ユーザーの登録を許可しています**。これにより新規ユーザーが他の組織/ユーザーのリポジトリに対して特に興味深いアクセスを得ることはありませんが、**ログインしたユーザー**は**より多くのリポジトリや組織を視覚化できる**可能性があります。

## 内部悪用

このシナリオでは、あなたがgithubアカウントへのある程度のアクセスを得たと仮定します。

### ユーザーの資格情報/ウェブクッキーを持っている場合

組織内のユーザーの資格情報を何らかの方法で既に持っている場合（またはセッションクッキーを盗んだ場合）、**ログインするだけで**、どの**リポジトリ**に対してどのような**権限を持っているか**、**どのチーム**にいるか、**他のユーザーをリスト**し、**リポジトリがどのように保護されているか**を確認できます。

**2FAが使用される可能性がある**ことに注意してください。そのため、この情報にアクセスするには、そのチェックも**通過できる必要があります**。

{% hint style="info" %}
**`i_like_gitea`クッキーを盗むことに成功した場合**（現在SameSite: Laxで設定されています）、資格情報や2FAがなくても**完全にユーザーを偽装できる**ことに注意してください。
{% endhint %}

### ユーザーのSSHキーを持っている場合

Giteaでは、**ユーザー**が**SSHキー**を設定でき、これが彼らに代わってコードをデプロイするための**認証方法として使用されます**（2FAは適用されません）。

このキーを使用して、ユーザーが特権を持っているリポジトリで**変更を行うことができます**が、環境を列挙するためにgitea apiにアクセスするためには使用できません。ただし、アクセス可能なリポジトリやユーザーに関する情報を取得するために**ローカル設定を列挙する**ことはできます。
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーが自分のgiteaユーザー名をユーザー名として設定している場合、_https://github.com/\<gitea\_username>.keys_ で**公開鍵**にアクセスできます。見つけた秘密鍵が使用できるかを確認するためにこれをチェックできます。

**SSH鍵**は、**デプロイ鍵**としてリポジトリにも設定できます。この鍵にアクセスできる人は誰でも**リポジトリからプロジェクトを起動**できます。通常、異なるデプロイ鍵があるサーバーでは、ローカルファイル**`~/.ssh/config`**が関連する鍵についての情報を提供します。

#### GPG鍵

[**こちら**](broken-reference/)で説明されているように、コミットに署名する必要がある場合があります。そうでないと発見されるかもしれません。

現在のユーザーに関連する鍵があるかローカルで確認してください：
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用した場合

[**ユーザートークンの基本情報についてはこちらをご覧ください**](basic-gitea-information.md#personal-access-tokens)。

ユーザートークンは、パスワードの代わりに使用して、[**API 経由で**](https://try.gitea.io/api/swagger#/) Gitea サーバーに**認証**することができます。これにより、ユーザーに対して**完全なアクセス権**を持つことになります。

### Oauth アプリケーションを使用した場合

[**Gitea Oauth アプリケーションの基本情報についてはこちらをご覧ください**](./#with-oauth-application)。

攻撃者は、**悪意のある Oauth アプリケーション**を作成して、それを受け入れたユーザーの権限のあるデータやアクションにアクセスする可能性があります。これはおそらくフィッシングキャンペーンの一環として行われます。

基本情報で説明されているように、アプリケーションは**ユーザーアカウントに対する完全なアクセス権**を持ちます。

### ブランチ保護のバイパス

Github では、**github actions** がデフォルトでリポジトリに対する**書き込みアクセス権を持つトークン**を取得します。これを使用して**ブランチ保護をバイパス**することができます。この場合、そのようなものは**存在しない**ため、バイパスはより限定されます。しかし、何ができるか見てみましょう：

* **プッシュを有効にする**：書き込みアクセス権を持つ人なら誰でもブランチにプッシュできます。
* **制限されたプッシュのホワイトリスト**：このリストに含まれている場合は、ブランチにプッシュします。
* **マージホワイトリストを有効にする**：マージホワイトリストがある場合、その中にいる必要があります。
* **承認が0より大きい必要がある**：その場合は...他のユーザーを侵害する必要があります。
* **承認をホワイトリストに制限する**：ホワイトリストに含まれるユーザーのみが承認できる場合...そのリスト内の他のユーザーを侵害する必要があります。
* **古い承認を無視する**：新しいコミットで承認が削除されない場合、既に承認された PR をハイジャックしてコードを注入し、PR をマージすることができます。

**組織/リポジトリの管理者である場合**、保護をバイパスできることに注意してください。

### Webhooks の列挙

**Webhooks** は、特定の gitea 情報を特定の場所に**送信**することができます。この通信を**悪用**することができるかもしれません。\
しかし、通常は**秘密**が設定されており、Webhook の URL を知っている外部ユーザーがその秘密を知らない限り、**その webhook を悪用することを防ぐ**ことができます。\
しかし、時には人々は**秘密**をその場所に設定する代わりに、URL のパラメータとして設定することがあります。そのため、**URL をチェックする**ことで、秘密を**見つけたり**、さらに悪用できる場所を見つけることができるかもしれません。

Webhooks は、**リポジトリと組織レベル**で設定できます。

## 侵害後の対応

### サーバー内部

何らかの方法で gitea が実行されているサーバー内部に侵入した場合、gitea の設定ファイルを探す必要があります。デフォルトでは `/data/gitea/conf/app.ini` にあります。

このファイルには、**キー**と**パスワード**が見つかります。

gitea のパス（デフォルト：/data/gitea）では、以下のような興味深い情報も見つかります：

* **sqlite** DB：gitea が外部の db を使用していない場合、sqlite db を使用します。
* セッションフォルダ内の**セッション**：`cat sessions/*/*/*` を実行すると、ログインしているユーザーのユーザー名を見ることができます（gitea はセッションを DB 内に保存することもあります）。
* jwt フォルダ内の**jwt 私有鍵**
* このフォルダには、より多くの**機密情報**が見つかる可能性があります

サーバー内部にいる場合は、`gitea` バイナリも使用して情報にアクセスしたり変更したりすることができます：

* `gitea dump` は gitea をダンプし、.zip ファイルを生成します。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` は指定されたタイプのトークンを生成します（永続性）。
* `gitea admin user change-password --username admin --password newpassword` パスワードを変更します。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` 新しい管理ユーザーを作成し、アクセス トークンを取得します。

<details>

<summary><strong>AWS のハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks に広告を掲載したい**、または**HackTricks を PDF でダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。これは独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegram グループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを共有してください。

</details>
