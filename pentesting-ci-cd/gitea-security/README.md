# Giteaのセキュリティ

<details>

<summary><strong>HackTricksをサポートして特典を得る！</strong></summary>

* **HackTricksの最新バージョンを入手したい**場合や、**PEASSをダウンロードしたい**場合、または**会社をHackTricksで宣伝したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加する**

</details>

## Giteaとは

**Gitea**は、Goで書かれた**セルフホスト型のコミュニティ管理型軽量コードホスティング**ソリューションです。

![](<../../.gitbook/assets/image (5) (1) (1) (1).png>)

### 基本情報

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## ラボ

Giteaインスタンスをローカルで実行するには、単にDockerコンテナを実行するだけです。
```bash
docker run -p 3000:3000 gitea/gitea
```
ポート3000に接続してウェブページにアクセスします。

また、Kubernetesで実行することもできます：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 認証されていない列挙

* 公開リポジトリ：[http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 登録ユーザー：[http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 登録組織：[http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

デフォルトでは、Giteaは新しいユーザーの登録を許可しています。これにより、新しいユーザーは他の組織/ユーザーのリポジトリに比べて特に興味深いアクセス権を得ることはありませんが、ログインしているユーザーはより多くのリポジトリや組織を表示できる場合があります。

## 内部攻撃

このシナリオでは、GitHubアカウントへのアクセス権を取得したと仮定します。

### ユーザーの資格情報/ウェブクッキーを使用する場合

すでに組織内のユーザーの資格情報を持っている場合（またはセッションクッキーを盗んだ場合）、単にログインして、どのリポジトリにどの権限があるか、どのチームに所属しているか、他のユーザーをリストアップし、リポジトリがどのように保護されているかを確認できます。

2FAが使用されている場合、そのチェックをパスできる場合にのみ、この情報にアクセスできることに注意してください。

{% hint style="info" %}
現在SameSite: Laxで構成されている`i_like_gitea`クッキーを盗むことに成功した場合、資格情報や2FAを必要とせずにユーザーを完全になりすますことができます。
{% endhint %}

### ユーザーのSSHキーを使用する場合

Giteaでは、ユーザーがSSHキーを設定できます。このキーは、コードをデプロイするための認証方法として使用されます（2FAは適用されません）。

このキーを使用すると、ユーザーが特権を持つリポジトリで変更を行うことができますが、環境を列挙するためにgitea apiにアクセスすることはできません。ただし、アクセス権があるリポジトリとユーザーに関する情報を取得するために、ローカル設定を列挙することはできます。
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
もしユーザーが自分のgiteaのユーザー名を設定している場合、彼がアカウントに設定した**公開鍵にアクセス**することができます。これを確認して、見つけた秘密鍵が使用できるかどうかを確認できます。

**SSH鍵**は、リポジトリ内で**デプロイ鍵**として設定することもできます。この鍵にアクセス権がある人は、リポジトリからプロジェクトを**起動**することができます。通常、異なるデプロイ鍵を持つサーバーでは、ローカルファイル**`~/.ssh/config`**に関連する鍵の情報が記載されています。

#### GPG鍵

[**ここ**](broken-reference/)で説明されているように、コミットに署名する必要がある場合や、発見される可能性があります。

現在のユーザーに関連する鍵があるかどうかは、ローカルで確認してください。
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用する場合

[**ユーザートークンに関する基本情報を確認する**](basic-gitea-information.md#personal-access-tokens)。

ユーザートークンは、Giteaサーバーに対して[**API経由で認証**](https://try.gitea.io/api/swagger#/するために、**パスワードの代わりに**使用することができます。これにより、ユーザーに対して**完全なアクセス権限**が与えられます。

### Oauthアプリケーションを使用する場合

[**Gitea Oauthアプリケーションに関する基本情報を確認する**](./#with-oauth-application)。

攻撃者は、**悪意のあるOauthアプリケーション**を作成して、おそらくフィッシングキャンペーンの一環としてそれらを受け入れるユーザーの特権データ/アクションにアクセスすることができます。

基本情報で説明されているように、アプリケーションはユーザーアカウントに対して**完全なアクセス権限**を持ちます。

### ブランチ保護のバイパス

Githubでは、デフォルトでリポジトリに対して**書き込みアクセス権限を持つトークン**を取得する**github actions**があり、これを使用して**ブランチ保護をバイパス**することができます。しかし、この場合は存在しないため、バイパスの範囲はより限定されています。しかし、以下のことができます：

* **プッシュを有効にする**：書き込みアクセス権限を持つ人は、ブランチにプッシュするだけです。
* **ホワイトリスト制限付きプッシュ**：同様に、このリストの一部であれば、ブランチにプッシュできます。
* **マージホワイトリストを有効にする**：マージホワイトリストがある場合、そのリストに含まれている必要があります。
* **承認が0より大きい場合**：その場合...他のユーザーを侵害する必要があります。
* **承認をホワイトリストに制限する**：ホワイトリストに含まれるユーザーのみが承認できる場合...そのリストに含まれる他のユーザーを侵害する必要があります。
* **古い承認を無効にする**：承認が新しいコミットで削除されない場合、既に承認されたPRを乗っ取り、コードを注入してPRをマージすることができます。

なお、**組織/リポジトリの管理者であれば**、保護をバイパスすることができます。

### Webフックの列挙

**Webフック**は、特定のGitea情報をいくつかの場所に**送信**することができます。これを**悪用**することができるかもしれません。\
ただし、通常、**取得できないシークレット**が**Webフック**に設定されており、WebフックのURLは知っているがシークレットは知らない外部ユーザーが**Webフックを悪用**することを防ぎます。\
しかし、一部の場合では、人々はシークレットをその場所に設定する代わりに、URLのパラメータとして設定します。そのため、URLをチェックすることで、シークレットや他の悪用できる場所を見つけることができます。

Webフックは、**リポジトリと組織のレベルで設定**できます。

## ポストエクスプロイテーション

### サーバー内部

何らかの方法でGiteaが実行されているサーバーに侵入できた場合、Giteaの設定ファイルを検索する必要があります。デフォルトでは、それは`/data/gitea/conf/app.ini`にあります。

このファイルには、**キー**や**パスワード**が記載されています。

Giteaのパス（デフォルトでは：/data/gitea）には、次のような興味深い情報もあります：

* **sqlite** DB：Giteaが外部DBを使用していない場合、sqlite DBを使用します。
* セッションフォルダ内の**セッション**：`cat sessions/*/*/*`を実行すると、ログインしたユーザーのユーザー名が表示されます（GiteaはセッションをDB内に保存することもあります）。
* jwtフォルダ内の**jwtプライベートキー**
* このフォルダには、より**機密性の高い情報**が含まれている場合があります。

サーバー内部にいる場合、`gitea`バイナリを使用して情報にアクセス/変更することもできます：

* `gitea dump`はGiteaをダンプし、.zipファイルを生成します。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`は、指定されたタイプのトークン（永続性）を生成します。
* `gitea admin user change-password --username admin --password newpassword` パスワードを変更します。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` 新しい管理者ユーザーを作成し、アクセストークンを取得します。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝**したい場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
