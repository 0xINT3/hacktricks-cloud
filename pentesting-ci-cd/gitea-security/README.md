# Seguridad de Gitea

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## ¬øQu√© es Gitea

**Gitea** es una **soluci√≥n de alojamiento de c√≥digo ligera autohospedada y gestionada por la comunidad** escrita en Go.

![](<../../.gitbook/assets/image (160).png>)

### Informaci√≥n B√°sica

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## Laboratorio

Para ejecutar una instancia de Gitea localmente, simplemente puedes ejecutar un contenedor de docker:
```bash
docker run -p 3000:3000 gitea/gitea
```
Con√©ctese al puerto 3000 para acceder a la p√°gina web.

Tambi√©n puede ejecutarlo con Kubernetes:
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## Enumeraci√≥n sin autenticaci√≥n

* Repositorios p√∫blicos: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* Usuarios registrados: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* Organizaciones registradas: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

Tenga en cuenta que por **defecto Gitea permite que los nuevos usuarios se registren**. Esto no dar√° acceso especialmente interesante a los nuevos usuarios sobre otros repositorios de organizaciones/usuarios, pero un **usuario conectado** podr√≠a ser capaz de **visualizar m√°s repositorios u organizaciones**.

## Explotaci√≥n interna

Para este escenario vamos a suponer que has obtenido acceso a una cuenta de github.

### Con Credenciales de Usuario/Cookie Web

Si de alguna manera ya tienes credenciales para un usuario dentro de una organizaci√≥n (o robaste una cookie de sesi√≥n) puedes **simplemente iniciar sesi√≥n** y verificar qu√© **permisos tienes** sobre qu√© **repositorios**, en **qu√© equipos** est√°s, **listar otros usuarios**, y **c√≥mo est√°n protegidos los repositorios**.

Tenga en cuenta que **puede usarse la autenticaci√≥n de dos factores (2FA)**, por lo que solo podr√°s acceder a esta informaci√≥n si tambi√©n puedes **superar esa verificaci√≥n**.

{% hint style="info" %}
Tenga en cuenta que si **logras robar la cookie `i_like_gitea`** (actualmente configurada con SameSite: Lax) puedes **hacerte pasar completamente por el usuario** sin necesidad de credenciales o 2FA.
{% endhint %}

### Con Clave SSH de Usuario

Gitea permite a los **usuarios** configurar **claves SSH** que se utilizar√°n como **m√©todo de autenticaci√≥n para implementar c√≥digo** en su nombre (no se aplica 2FA).

Con esta clave puedes realizar **cambios en repositorios donde el usuario tiene algunos privilegios**, sin embargo, no puedes usarla para acceder a la API de gitea para enumerar el entorno. Sin embargo, puedes **enumerar configuraciones locales** para obtener informaci√≥n sobre los repositorios y usuarios a los que tienes acceso:
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
Si el usuario ha configurado su nombre de usuario como su nombre de usuario de gitea, puedes acceder a las **claves p√∫blicas que ha establecido** en su cuenta en _https://github.com/\<gitea\_username>.keys_, podr√≠as verificar esto para confirmar que la clave privada que encontraste se puede usar.

Las **claves SSH** tambi√©n se pueden configurar en los repositorios como **claves de despliegue**. Cualquier persona con acceso a esta clave podr√° **lanzar proyectos desde un repositorio**. Por lo general, en un servidor con diferentes claves de despliegue, el archivo local **`~/.ssh/config`** te dar√° informaci√≥n sobre qu√© clave est√° relacionada.

#### Claves GPG

Como se explica [**aqu√≠**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md) a veces es necesario firmar los commits o podr√≠as ser descubierto.

Verifica localmente si el usuario actual tiene alguna clave con:
```shell
gpg --list-secret-keys --keyid-format=long
```
### Con Token de Usuario

Para obtener una introducci√≥n sobre [**Tokens de Usuario, revisa la informaci√≥n b√°sica**](basic-gitea-information.md#personal-access-tokens).

Un token de usuario puede ser utilizado **en lugar de una contrase√±a** para **autenticarse** contra el servidor de Gitea [**a trav√©s de la API**](https://try.gitea.io/api/swagger#/). Tendr√° **acceso completo** sobre el usuario.

### Con Aplicaci√≥n Oauth

Para obtener una introducci√≥n sobre [**Aplicaciones Oauth de Gitea, revisa la informaci√≥n b√°sica**](./#with-oauth-application).

Un atacante podr√≠a crear una **Aplicaci√≥n Oauth maliciosa** para acceder a datos/acciones privilegiados de los usuarios que los aceptan, probablemente como parte de una campa√±a de phishing.

Como se explica en la informaci√≥n b√°sica, la aplicaci√≥n tendr√° **acceso total a la cuenta del usuario**.

### Bypass de Protecci√≥n de Ramas

En Github tenemos **acciones de Github** que por defecto obtienen un **token con acceso de escritura** sobre el repositorio que puede ser utilizado para **burlar las protecciones de rama**. En este caso que **no existe**, por lo que los bypasses son m√°s limitados. Pero veamos qu√© se puede hacer:

* **Habilitar Push**: Si alguien con acceso de escritura puede hacer push a la rama, simplemente haz push a ella.
* **Lista blanca de Push restringidos**: De la misma manera, si eres parte de esta lista haz push a la rama.
* **Habilitar Lista blanca de Merge**: Si hay una lista blanca de merge, necesitas estar dentro de ella.
* **Requerir aprobaciones es mayor que 0**: Entonces... necesitas comprometer a otro usuario.
* **Restringir aprobaciones a usuarios de la lista blanca**: Si solo los usuarios de la lista blanca pueden aprobar... necesitas comprometer a otro usuario que est√© dentro de esa lista.
* **Descartar aprobaciones obsoletas**: Si las aprobaciones no se eliminan con nuevos commits, podr√≠as secuestrar un PR ya aprobado para inyectar tu c√≥digo y fusionar el PR.

Ten en cuenta que **si eres un administrador de la org/repositorio** puedes burlar las protecciones.

### Enumerar Webhooks

Los **Webhooks** pueden **enviar informaci√≥n espec√≠fica de Gitea a algunos lugares**. Es posible que puedas **explotar esa comunicaci√≥n**.\
Sin embargo, generalmente se establece un **secreto** en el **webhook** que no se puede recuperar, lo cual evitar√° que los usuarios externos que conozcan la URL del webhook pero no el secreto **exploten ese webhook**.\
Pero en algunas ocasiones, en lugar de configurar el **secreto** en su lugar, lo **configuran en la URL** como un par√°metro, por lo que **verificar las URLs** podr√≠a permitirte **encontrar secretos** y otros lugares que podr√≠as explotar a√∫n m√°s.

Los webhooks se pueden configurar a nivel de **repositorio y a nivel de org**.

## Post Explotaci√≥n

### Dentro del servidor

Si de alguna manera lograste acceder al servidor donde se est√° ejecutando Gitea, debes buscar el archivo de configuraci√≥n de Gitea. Por defecto, se encuentra en `/data/gitea/conf/app.ini`

En este archivo puedes encontrar **claves** y **contrase√±as**.

En la ruta de Gitea (por defecto: /data/gitea) tambi√©n puedes encontrar informaci√≥n interesante como:

* La **base de datos sqlite**: Si Gitea no est√° utilizando una base de datos externa, utilizar√° una base de datos sqlite.
* Las **sesiones** dentro de la carpeta de sesiones: Ejecutando `cat sessions/*/*/*` puedes ver los nombres de usuario de los usuarios conectados (Gitea tambi√©n podr√≠a guardar las sesiones dentro de la base de datos).
* La **clave privada jwt** dentro de la carpeta jwt.
* Se podr√≠a encontrar m√°s **informaci√≥n sensible** en esta carpeta.

Si est√°s dentro del servidor, tambi√©n puedes **utilizar el binario `gitea`** para acceder/modificar informaci√≥n:

* `gitea dump` volcar√° Gitea y generar√° un archivo .zip.
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` generar√° un token del tipo indicado (persistencia).
* `gitea admin user change-password --username admin --password newpassword` Cambiar la contrase√±a.
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` Crear un nuevo usuario administrador y obtener un token de acceso.
