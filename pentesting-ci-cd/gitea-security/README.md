# Gitea セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## Giteaとは

**Gitea**は、Go言語で書かれた**自己ホスト型のコミュニティ管理軽量コードホスティング**ソリューションです。

![](<../../.gitbook/assets/image (5) (1) (1) (1) (1).png>)

### 基本情報

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## ラボ

ローカルでGiteaインスタンスを実行するには、dockerコンテナを実行するだけです：
```bash
docker run -p 3000:3000 gitea/gitea
```
ポート3000に接続して、ウェブページにアクセスします。

また、kubernetesを使って実行することもできます：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 認証されていない列挙

* 公開リポジトリ: [http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
* 登録ユーザー: [http://localhost:3000/explore/users](http://localhost:3000/explore/users)
* 登録組織: [http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

**デフォルトでGiteaは新規ユーザーの登録を許可しています**。これは新規ユーザーに他の組織/ユーザーのリポジトリに対して特に興味深いアクセスを与えるわけではありませんが、**ログインしたユーザー**は**より多くのリポジトリや組織を視覚化できる**可能性があります。

## 内部悪用

このシナリオでは、あなたがgithubアカウントへのある程度のアクセスを得たと仮定します。

### ユーザーの資格情報/ウェブクッキーを持っている場合

組織内のユーザーの資格情報を何らかの方法で既に持っている場合（またはセッションクッキーを盗んだ場合）、**ログインするだけで**、どの**リポジトリ**に対してどのような**権限を持っているか**、**どのチーム**にいるか、**他のユーザーをリスト**し、**リポジトリがどのように保護されているか**を確認できます。

**2FAが使用される可能性がある**ことに注意してください。そのチェックを**通過できる場合にのみ**、この情報にアクセスできます。

{% hint style="info" %}
**`i_like_gitea`クッキーを盗むことに成功した場合**（現在SameSite: Laxで設定されています）、資格情報や2FAがなくても**完全にユーザーを偽装できる**ことに注意してください。
{% endhint %}

### ユーザーのSSHキーを持っている場合

Giteaは**ユーザー**が**SSHキー**を設定することを許可しており、これは彼らに代わってコードをデプロイするための**認証方法として使用されます**（2FAは適用されません）。

このキーを使って、ユーザーが特定の権限を持っているリポジトリで**変更を行う**ことができますが、環境を列挙するためにgitea apiにアクセスするためには使用できません。しかし、アクセス可能なリポジトリやユーザーに関する情報を得るために**ローカル設定を列挙する**ことができます。
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
ユーザーが自分のgiteaユーザー名をユーザー名として設定している場合、_https://github.com/\<gitea\_username>.keys_ で**公開鍵**にアクセスできます。見つけた秘密鍵が使用できるかを確認するためにこれをチェックできます。

**SSH鍵**は、**デプロイ鍵**としてリポジトリにも設定できます。この鍵にアクセスできる人は誰でも**リポジトリからプロジェクトを起動**できます。通常、異なるデプロイ鍵を持つサーバーでは、ローカルファイル**`~/.ssh/config`**が関連する鍵についての情報を提供します。

#### GPG鍵

[**こちら**](broken-reference/)で説明されているように、コミットに署名する必要がある場合があります。そうでないと発見されるかもしれません。

現在のユーザーがどの鍵を持っているかをローカルで確認します：
```shell
gpg --list-secret-keys --keyid-format=long
```
### ユーザートークンを使用した場合

[**ユーザートークンの基本情報についてはこちらをご覧ください**](basic-gitea-information.md#personal-access-tokens)。

ユーザートークンは、パスワードの代わりにGiteaサーバーに[**API経由で認証するために使用できます**](https://try.gitea.io/api/swagger#/)。ユーザーに対して**完全なアクセス権**を持ちます。

### Oauthアプリケーションを使用した場合

[**Gitea Oauthアプリケーションの基本情報についてはこちらをご覧ください**](./#with-oauth-application)。

攻撃者は、フィッシングキャンペーンの一環として、**悪意のあるOauthアプリケーション**を作成して、それを受け入れたユーザーの権限のあるデータやアクションにアクセスする可能性があります。

基本情報で説明されているように、アプリケーションは**ユーザーアカウントに対する完全なアクセス権**を持ちます。

### ブランチ保護のバイパス

Githubでは、**github actions**がデフォルトでリポジトリに対する**書き込み権限を持つトークン**を取得し、**ブランチ保護をバイパス**するために使用できます。この場合、そのようなものは**存在しない**ため、バイパスはより限定されます。しかし、以下のようなことが可能です：

* **プッシュを有効にする**: 書き込み権限を持つ人がブランチにプッシュできる場合、そのままプッシュします。
* **制限されたプッシュのホワイトリスト**: 同様に、このリストに含まれている場合はブランチにプッシュします。
* **マージホワイトリストを有効にする**: マージホワイトリストがある場合、その中にいる必要があります。
* **承認が0より大きい必要がある**: その場合は...他のユーザーを侵害する必要があります。
* **承認をホワイトリストに限定する**: 承認できるのがホワイトリストに載っているユーザーのみの場合...そのリスト内の他のユーザーを侵害する必要があります。
* **古い承認を無視する**: 承認が新しいコミットで削除されない場合、既に承認されたPRをハイジャックしてコードを注入し、PRをマージすることができます。

組織/リポジトリの管理者であれば、保護をバイパスできることに注意してください。

### Webhooksの列挙

**Webhooks**は特定のgitea情報を特定の場所に**送信することができます**。その通信を**悪用する可能性**があります。\
しかし、通常は**秘密のキー**が**webhook**に設定されており、その秘密を知らない外部ユーザーがwebhookのURLを知っていても**そのwebhookを悪用することを防ぎます**。\
しかし、時には人々が**秘密のキー**をその場所に設定する代わりに、URLのパラメータとして設定することがありますので、**URLをチェックする**ことで**秘密**を見つけたり、さらに悪用できる場所を見つけることができるかもしれません。

Webhooksは**リポジトリレベルと組織レベル**で設定できます。

## 侵害後の対応

### サーバー内部

何らかの方法でgiteaが動作しているサーバー内部に侵入した場合、giteaの設定ファイルを探すべきです。デフォルトでは`/data/gitea/conf/app.ini`にあります。

このファイルには**キー**と**パスワード**が見つかるかもしれません。

giteaのパス（デフォルト：/data/gitea）には、以下のような興味深い情報が見つかるかもしれません：

* **sqlite** DB：giteaが外部DBを使用していない場合、sqlite DBを使用します。
* **セッション**フォルダ内のセッション：`cat sessions/*/*/*`を実行すると、ログインしているユーザーのユーザー名が表示されます（giteaはセッションをDB内に保存することもあります）。
* **jwtプライベートキー**がjwtフォルダ内にあります。
* このフォルダには、より多くの**機密情報**が見つかるかもしれません。

サーバー内部にいる場合は、`gitea`バイナリを使用して情報にアクセスしたり変更したりすることもできます：

* `gitea dump`はgiteaをダンプし、.zipファイルを生成します。
* `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET`は指定されたタイプのトークンを生成します（永続性）。
* `gitea admin user change-password --username admin --password newpassword` パスワードを変更します。
* `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` 新しい管理ユーザーを作成し、アクセストークンを取得します。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTコレクション**](https://opensea.io/collection/the-peass-family)です。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* **HackTricks**の[**githubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
