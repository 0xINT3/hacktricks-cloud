# Gitea安全性

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 什么是Gitea

**Gitea**是一个用Go语言编写的**自托管的社区管理的轻量级代码托管**解决方案。

![](<../../.gitbook/assets/image (160).png>)

### 基本信息

{% content-ref url="basic-gitea-information.md" %}
[basic-gitea-information.md](basic-gitea-information.md)
{% endcontent-ref %}

## 实验

要在本地运行Gitea实例，只需运行一个docker容器：
```bash
docker run -p 3000:3000 gitea/gitea
```
连接到端口3000以访问网页。

您也可以在Kubernetes中运行它：
```
helm repo add gitea-charts https://dl.gitea.io/charts/
helm install gitea gitea-charts/gitea
```
## 未经身份验证的枚举

- 公共存储库：[http://localhost:3000/explore/repos](http://localhost:3000/explore/repos)
- 注册用户：[http://localhost:3000/explore/users](http://localhost:3000/explore/users)
- 注册组织：[http://localhost:3000/explore/organizations](http://localhost:3000/explore/organizations)

请注意，**默认情况下，Gitea允许新用户注册**。这不会给新用户特别有趣的访问权限，但**已登录用户**可能能够**查看更多存储库或组织**。

## 内部利用

对于这种情况，我们假设您已经获得了对GitHub帐户的某些访问权限。

### 使用用户凭据/ Web Cookie

如果您已经以某个组织中的用户的凭据（或者您窃取了会话cookie）的方式获得了凭据，您可以**直接登录**并检查您对哪些**存储库**拥有哪些**权限**，您属于哪些**团队**，**列出其他用户**，以及**存储库受到何种保护**。

请注意，可能会使用**双因素认证**，因此只有在您能够**通过该检查**时才能访问这些信息。

{% hint style="info" %}
请注意，如果您**设法窃取`i_like_gitea` cookie**（当前配置为SameSite: Lax），您可以**完全冒充用户**，而无需凭据或双因素认证。
{% endhint %}

### 使用用户SSH密钥

Gitea允许**用户**设置**SSH密钥**，这将用作**部署代码的身份验证方法**（不适用双因素认证）。

使用此密钥，您可以对用户具有某些特权的存储库执行**更改**，但您无法使用它访问gitea api以枚举环境。但是，您可以**枚举本地设置**以获取有关您可以访问的存储库和用户的信息：
```bash
# Go to the the repository folder
# Get repo config and current user name and email
git config --list
```
如果用户已将其用户名配置为他的gitea用户名，则可以访问他在账户中设置的**公钥**，网址为_https://github.com/<gitea_username>.keys_，您可以检查这一点以确认您找到的私钥是否可用。

**SSH密钥**也可以设置在存储库中作为**部署密钥**。任何拥有此密钥的人都将能够**从存储库启动项目**。通常在具有不同部署密钥的服务器上，本地文件**`~/.ssh/config`**将为您提供有关密钥相关的信息。

#### GPG密钥

如[**这里**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-ci-cd/gitea-security/broken-reference/README.md)所述，有时需要对提交进行签名，否则可能会被发现。

在本地检查当前用户是否有任何密钥：
```shell
gpg --list-secret-keys --keyid-format=long
```
### 使用用户令牌

有关[**用户令牌的基本信息，请查看基本信息**](basic-gitea-information.md#personal-access-tokens)。

用户令牌可用于**代替密码**对Gitea服务器进行**身份验证**[**通过 API**](https://try.gitea.io/api/swagger#/)，它将具有对用户的**完全访问权限**。

### 使用 Oauth 应用程序

有关[**Gitea Oauth 应用程序的基本信息，请查看基本信息**](./#with-oauth-application)。

攻击者可能创建一个**恶意的 Oauth 应用程序**，以访问接受它们的用户的特权数据/操作，可能作为网络钓鱼活动的一部分。

如基本信息中所述，该应用程序将对用户帐户具有**完全访问权限**。

### 分支保护绕过

在 Github 中，我们有**github actions**，默认情况下会获得对存储库的**具有写入访问权限的令牌**，可用于**绕过分支保护**。在这种情况下**不存在**，因此绕过更受限制。但让我们看看可以做什么：

- **启用推送**：如果任何具有写入访问权限的人都可以推送到分支，则只需推送即可。
- **白名单受限推送**：同样，如果您在此列表中，则推送到分支。
- **启用合并白名单**：如果存在合并白名单，则需要在其中
- **需要批准大于 0**：然后... 您需要妥协另一个用户
- **将批准限制为白名单**：如果只有白名单用户可以批准... 您需要妥协另一个在该列表中的用户
- **解除过时的批准**：如果批准不随新提交而删除，则您可以劫持已批准的 PR 来注入您的代码并合并 PR。

请注意，**如果您是组织/存储库管理员**，则可以绕过保护措施。

### 枚举 Webhooks

**Webhooks**能够**将特定的 Gitea 信息发送到某些位置**。您可能能够**利用该通信**。\
但通常在**webhook**中设置了**无法检索的密钥**，该密钥将**防止**知道 webhook URL 但不知道密钥的外部用户**利用该 webhook**。\
但在某些情况下，人们不是将**密钥**设置在其位置，而是**将其设置在 URL 中**作为参数，因此**检查 URL**可能会让您**找到密钥**和其他您可以进一步利用的地方。

Webhooks 可以在**存储库和组织级别**设置。

## 后渗透

### 在服务器内部

如果以某种方式成功进入运行 Gitea 的服务器，则应搜索 Gitea 配置文件。默认情况下，它位于 `/data/gitea/conf/app.ini`

在此文件中，您可以找到**密钥**和**密码**。

在 Gitea 路径中（默认情况下：/data/gitea），您还可以找到有趣的信息，例如：

- **sqlite** 数据库：如果 Gitea 未使用外部数据库，则将使用 sqlite 数据库
- 会话**sessions**位于 sessions 文件夹内：运行 `cat sessions/*/*/*` 您可以看到已登录用户的用户名（Gitea 也可能将会话保存在数据库中）。
- jwt 文件夹内的**jwt 私钥**
- 此文件夹中可能包含更多**敏感信息**

如果您在服务器内部，还可以使用`gitea`二进制文件来访问/修改信息：

- `gitea dump` 将转储 Gitea 并生成一个 .zip 文件
- `gitea generate secret INTERNAL_TOKEN/JWT_SECRET/SECRET_KEY/LFS_JWT_SECRET` 将生成指定类型的令牌（持久性）
- `gitea admin user change-password --username admin --password newpassword` 更改密码
- `gitea admin user create --username newuser --password superpassword --email user@user.user --admin --access-token` 创建新的管理员用户并获取访问令牌

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

- 如果您想在 HackTricks 中看到您的**公司广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
- 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
- **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
- 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
