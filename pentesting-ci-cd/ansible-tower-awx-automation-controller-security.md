# Ansible Tower / AWX / 自动化控制器安全

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## 基本信息

**Ansible Tower** 或其开源版本 [**AWX**](https://github.com/ansible/awx) 也被称为 **Ansible 的用户界面、仪表盘和 REST API**。通过**基于角色的访问控制**、作业调度和图形化库存管理，您可以通过现代化的用户界面管理 Ansible 基础架构。Tower 的 REST API 和命令行界面使其可以轻松地集成到当前的工具和工作流中。

**自动化控制器是 Ansible Tower 的新版本**，具有更多功能。

### 差异

根据[**这篇文章**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00)，Ansible Tower 和 AWX 的主要区别在于受到的支持以及 Ansible Tower 具有额外的功能，如基于角色的访问控制、支持自定义 API 和用户定义的工作流程。

### 技术栈

* **Web 接口**：这是用户可以管理库存、凭据、模板和作业的图形界面。它被设计成直观的，并提供可视化功能，以帮助理解自动化作业的状态和结果。
* **REST API**：您可以通过 REST API 执行 Web 接口中的所有操作。这意味着您可以将 AWX/Tower 与其他系统集成，或者脚本化通常在界面中执行的操作。
* **数据库**：AWX/Tower 使用数据库（通常是 PostgreSQL）来存储其配置、作业结果和其他必要的运行数据。
* **RabbitMQ**：这是 AWX/Tower 用于在不同组件之间进行通信的消息系统，特别是在 Web 服务和任务运行程序之间。
* **Redis**：Redis 用作缓存和任务队列的后端。

### 逻辑组件

* **库存**：库存是一组主机（或节点），可以对其运行作业（Ansible playbook）。AWX/Tower 允许您定义和分组库存，并支持动态库存，可以从其他系统（如 AWS、Azure 等）获取主机列表。
* **项目**：项目实质上是从版本控制系统（如 Git）中获取的一组 Ansible playbook，以在需要时拉取最新的 playbook。
* **模板**：作业模板定义了特定 playbook 的运行方式，指定了作业的库存、凭据和其他参数。
* **凭据**：AWX/Tower 提供了一种安全的方式来管理和存储密钥，如 SSH 密钥、密码和 API 令牌。这些凭据可以与作业模板关联，以便在运行时 playbook 具有必要的访问权限。
* **任务引擎**：这是魔法发生的地方。任务引擎基于 Ansible 构建，负责运行 playbook。作业被分派给任务引擎，然后使用指定的凭据针对指定的库存运行 Ansible playbook。
* **调度器和回调**：这些是 AWX/Tower 中的高级功能，允许安排作业在特定时间运行或由外部事件触发。
* **通知**：AWX/Tower 可以根据作业的成功或失败发送通知。它支持各种通知方式，如电子邮件、Slack 消息、Webhooks 等。
* **Ansible Playbook**：Ansible playbook 是配置、部署和编排工具。它们以自动化、可重复的方式描述系统的期望状态。Playbook 使用 Ansible 的声明性自动化语言来描述配置、任务和需要执行的步骤。

### 作业执行流程

1. **用户交互**：用户可以通过 **Web 接口** 或 **REST API** 与 AWX/Tower 进行交互。这些提供了对 AWX/Tower 提供的所有功能的前端访问。
2. **作业启动**：
* 用户通过 Web 接口或 API 基于 **作业模板** 启动作业。
* 作业模板包括对 **库存**、**项目**（包含 playbook）和 **凭据** 的引用。
* 在启动作业时，向 AWX/Tower 后端发送请求将作业排队等待执行。
3. **作业排队**：
* **RabbitMQ** 处理 Web 组件和任务运行程序之间的消息传递。一旦作业启动，就会使用 RabbitMQ 将消息发送到任务引擎。
* **Redis** 作为任务队列的后端，管理等待执行的作业。
4. **作业执行**：
* 任务引擎接收到排队的作业。它从数据库中检索有关作业关联 playbook、库存和凭据的必要信息。
* 使用关联 **项目** 中检索到的 Ansible playbook，任务引擎使用提供的 **凭据** 对指定的 **库存** 节点运行 playbook。
* 当 playbook 运行时，其执行输出（日志、事实等）被捕获并存储在数据库中。
5. **作业结果**：
* 一旦 playbook 运行完成，结果（成功、失败、日志）将保存到数据库中。
* 用户可以通过 Web 接口查看结果，或通过 REST API 查询结果。
* 根据作业结果，可以发送 **通知** 来通知用户或外部系统作业的状态。通知可以是电子邮件、Slack 消息、Webhooks 等。
6. **外部系统集成**：
* **库存** 可以从外部系统动态获取，允许 AWX/Tower 从 AWS、Azure、VMware 等来源获取主机。
* **项目**（playbook）可以从版本控制系统获取，确保在作业执行期间使用最新的 playbook。
* **调度器和回调** 可用于与其他系统或工具集成，使 AWX/Tower 对外部触发器做出反应或在预定时间运行作业。
### 用于测试的AWX实验室创建

[**按照文档**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md)可以使用docker-compose来运行AWX：

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
{% endcode %}

## RBAC

### 支持的角色

最高权限的角色称为**系统管理员**。拥有此角色的用户可以**修改任何内容**。

从**白盒安全**的角度来看，您需要**系统审计员角色**，该角色允许**查看所有系统数据**，但不能进行任何更改。另一个选择是获取**组织审计员角色**，但最好选择前一个角色。

<details>

<summary>展开以获取可用角色的详细描述</summary>

1. **系统管理员**：
* 这是超级用户角色，具有访问和修改系统中任何资源的权限。
* 他们可以管理所有组织、团队、项目、清单、作业模板等。
2. **系统审计员**：
* 拥有此角色的用户可以查看所有系统数据，但不能进行任何更改。
* 此角色用于合规性和监督。
3. **组织角色**：
* **管理员**：对组织资源拥有完全控制权限。
* **审计员**：只能查看组织资源。
* **成员**：作为组织的基本成员，没有特定权限。
* **执行**：可以在组织内运行作业模板。
* **读取**：可以查看组织的资源。
4. **项目角色**：
* **管理员**：可以管理和修改项目。
* **使用**：可以在作业模板中使用项目。
* **更新**：可以使用源代码管理（SCM）更新项目。
5. **清单角色**：
* **管理员**：可以管理和修改清单。
* **即席**：可以在清单上运行即席命令。
* **更新**：可以更新清单源。
* **使用**：可以在作业模板中使用清单。
* **读取**：只读访问权限。
6. **作业模板角色**：
* **管理员**：可以管理和修改作业模板。
* **执行**：可以运行作业。
* **读取**：只读访问权限。
7. **凭据角色**：
* **管理员**：可以管理和修改凭据。
* **使用**：可以在作业模板或其他相关资源中使用凭据。
* **读取**：只读访问权限。
8. **团队角色**：
* **成员**：团队成员，没有特定权限。
* **管理员**：可以管理团队成员和相关资源。
9. **工作流角色**：
* **管理员**：可以管理和修改工作流。
* **执行**：可以运行工作流。
* **读取**：只读访问权限。

</details>

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您希望在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
