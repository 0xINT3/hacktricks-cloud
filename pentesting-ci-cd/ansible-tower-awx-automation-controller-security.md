# S√©curit√© d'Ansible Tower / AWX / Automation controller

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

**Ansible Tower** ou sa version open source [**AWX**](https://github.com/ansible/awx) est √©galement connu sous le nom d'**interface utilisateur, tableau de bord et API REST d'Ansible**. Avec un contr√¥le d'acc√®s bas√© sur les r√¥les, une planification des t√¢ches et une gestion graphique des inventaires, vous pouvez g√©rer votre infrastructure Ansible √† partir d'une interface moderne. L'API REST et l'interface en ligne de commande de Tower permettent de l'int√©grer facilement dans les outils et flux de travail actuels.

**Automation Controller est une version plus r√©cente** d'Ansible Tower avec plus de fonctionnalit√©s.

### Diff√©rences

Selon [**ceci**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00), les principales diff√©rences entre Ansible Tower et AWS sont le support re√ßu et le fait qu'Ansible Tower dispose de fonctionnalit√©s suppl√©mentaires telles que le contr√¥le d'acc√®s bas√© sur les r√¥les, la prise en charge des API personnalis√©es et des flux de travail d√©finis par l'utilisateur.

### Stack technologique

* **Interface Web** : Il s'agit de l'interface graphique o√π les utilisateurs peuvent g√©rer les inventaires, les informations d'identification, les mod√®les et les t√¢ches. Elle est con√ßue pour √™tre intuitive et fournit des visualisations pour faciliter la compr√©hension de l'√©tat et des r√©sultats de vos t√¢ches d'automatisation.
* **API REST** : Tout ce que vous pouvez faire dans l'interface Web, vous pouvez √©galement le faire via l'API REST. Cela signifie que vous pouvez int√©grer AWX/Tower avec d'autres syst√®mes ou scripter des actions que vous effectueriez normalement dans l'interface.
* **Base de donn√©es** : AWX/Tower utilise une base de donn√©es (g√©n√©ralement PostgreSQL) pour stocker sa configuration, les r√©sultats des t√¢ches et d'autres donn√©es op√©rationnelles n√©cessaires.
* **RabbitMQ** : Il s'agit du syst√®me de messagerie utilis√© par AWX/Tower pour communiquer entre les diff√©rents composants, en particulier entre le service Web et les ex√©cuteurs de t√¢ches.
* **Redis** : Redis sert de cache et de backend pour la file d'attente des t√¢ches.

### Composants logiques

* **Inventaires** : Un inventaire est une **collection d'h√¥tes (ou de n≈ìuds)** sur lesquels des **t√¢ches** (playbooks Ansible) peuvent √™tre **ex√©cut√©es**. AWX/Tower vous permet de d√©finir et de regrouper vos inventaires et prend √©galement en charge les inventaires dynamiques qui peuvent **r√©cup√©rer des listes d'h√¥tes √† partir d'autres syst√®mes** tels que AWS, Azure, etc.
* **Projets** : Un projet est essentiellement une **collection de playbooks Ansible** provenant d'un **syst√®me de contr√¥le de version** (comme Git) pour extraire les derniers playbooks lorsque cela est n√©cessaire.
* **Mod√®les** : Les mod√®les de t√¢ches d√©finissent **comment un playbook particulier sera ex√©cut√©**, en sp√©cifiant l'**inventaire**, les **informations d'identification** et d'autres **param√®tres** pour la t√¢che.
* **Informations d'identification** : AWX/Tower fournit un moyen s√©curis√© de **g√©rer et stocker des secrets, tels que les cl√©s SSH, les mots de passe et les jetons API**. Ces informations d'identification peuvent √™tre associ√©es √† des mod√®les de t√¢ches afin que les playbooks aient l'acc√®s n√©cessaire lors de leur ex√©cution.
* **Moteur de t√¢ches** : C'est l√† que la magie op√®re. Le moteur de t√¢ches est bas√© sur Ansible et est responsable de l'**ex√©cution des playbooks**. Les t√¢ches sont envoy√©es au moteur de t√¢ches, qui ex√©cute ensuite les playbooks Ansible sur l'inventaire d√©sign√© en utilisant les informations d'identification sp√©cifi√©es.
* **Planificateurs et rappels** : Il s'agit de fonctionnalit√©s avanc√©es dans AWX/Tower qui permettent de **planifier l'ex√©cution des t√¢ches** √† des moments sp√©cifiques ou de les d√©clencher par des √©v√©nements externes.
* **Notifications** : AWX/Tower peut envoyer des notifications en fonction de la r√©ussite ou de l'√©chec des t√¢ches. Il prend en charge divers moyens de notification tels que les e-mails, les messages Slack, les webhooks, etc.
* **Playbooks Ansible** : Les playbooks Ansible sont des outils de configuration, de d√©ploiement et d'orchestration. Ils d√©crivent l'√©tat souhait√© des syst√®mes de mani√®re automatis√©e et reproductible. R√©dig√©s en YAML, les playbooks utilisent le langage d'automatisation d√©claratif d'Ansible pour d√©crire les configurations, les t√¢ches et les √©tapes √† ex√©cuter.

### Flux d'ex√©cution des t√¢ches

1. **Interaction de l'utilisateur** : Un utilisateur peut interagir avec AWX/Tower soit via l'**interface Web**, soit via l'**API REST**. Ces interfaces permettent d'acc√©der √† toutes les fonctionnalit√©s offertes par AWX/Tower.
2. **Initiation de la t√¢che** :
* L'utilisateur, via l'interface Web ou l'API, lance une t√¢che bas√©e sur un **mod√®le de t√¢che**.
* Le mod√®le de t√¢che inclut des r√©f√©rences √† l'**inventaire**, au **projet** (contenant le playbook) et aux **informations d'identification**.
* Lors du lancement de la t√¢che, une demande est envoy√©e au backend d'AWX/Tower pour mettre la t√¢che en file d'attente pour son ex√©cution.
3. **Mise en file d'attente de la t√¢che** :
* **RabbitMQ** g√®re la messagerie entre le composant Web et les ex√©cuteurs de t√¢ches. Une fois qu'une t√¢che est lanc√©e, un message est envoy√© au moteur de t√¢ches en utilisant RabbitMQ.
* **Redis** sert de backend pour la file d'attente des t√¢ches, g√©rant les t√¢ches en attente d'ex√©cution.
4. **Ex√©cution de la t√¢che** :
* Le **moteur de t√¢ches** r√©cup√®re la t√¢che en file d'attente. Il r√©cup√®re les informations n√©cessaires de la **base de donn√©es** concernant le playbook, l'inventaire et les informations d'identification associ√©s √† la t√¢che.
* √Ä l'aide du playbook Ansible r√©cup√©r√© √† partir du **projet** associ√©, le moteur de t√¢ches ex√©cute le playbook sur les n≈ìuds de l'**inventaire** sp√©cifi√© en utilisant les **informations d'identification** fournies.
* Pendant l'ex√©cution du playbook, sa sortie d'ex√©cution (journaux, faits, etc.) est captur√©e et stock√©e dans la **base de donn√©es**.
5. **R√©sultats de la t√¢che** :
* Une fois que le playbook a termin√© son ex√©cution, les r√©sultats (succ√®s, √©chec, journaux) sont enregistr√©s dans la **base de donn√©es**.
* Les utilisateurs peuvent ensuite consulter les r√©sultats via l'interface Web ou les interroger via l'API REST.
* En fonction des r√©sultats de la t√¢che, des **notifications** peuvent √™tre envoy√©es pour informer les utilisateurs ou les syst√®mes externes de l'√©tat de la t√¢che. Les notifications peuvent √™tre des e-mails, des messages Slack, des webhooks, etc.
6. **Int√©gration avec des syst√®mes externes** :
* Les **inventaires** peuvent √™tre dynamiquement r√©cup√©r√©s √† partir de syst√®mes externes, permettant √† AWX/Tower de r√©cup√©rer des h√¥tes √† partir de sources telles que AWS, Azure, VMware, etc.
* Les **projets** (playbooks) peuvent √™tre r√©cup√©r√©s √† partir de syst√®mes de contr√¥le de version, garantissant l'utilisation de playbooks √† jour lors de l'ex√©cution des t√¢ches.
* Les **planificateurs et rappels** peuvent √™tre utilis√©s pour s'int√©grer √† d'autres syst√®mes ou outils, permettant √† AWX/Tower de r√©agir √† des d√©clencheurs externes ou d'ex√©cuter des t√¢ches √† des moments pr√©d√©termin√©s.
### Cr√©ation d'un laboratoire AWX pour les tests

[**En suivant la documentation**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md), il est possible d'utiliser docker-compose pour ex√©cuter AWX :

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
{% endcode %}

## RBAC

### R√¥les pris en charge

Le r√¥le le plus privil√©gi√© est appel√© **Administrateur syst√®me**. Toute personne ayant ce r√¥le peut **modifier n'importe quoi**.

Dans le cadre d'un examen de s√©curit√© **white box**, vous auriez besoin du r√¥le d'**Auditeur syst√®me**, qui permet de **visualiser toutes les donn√©es du syst√®me** mais ne peut apporter aucune modification. Une autre option serait d'obtenir le r√¥le d'**Auditeur d'organisation**, mais il serait pr√©f√©rable d'obtenir l'autre.

<details>

<summary>D√©veloppez ceci pour obtenir une description d√©taill√©e des r√¥les disponibles</summary>

1. **Administrateur syst√®me** :
* Il s'agit du r√¥le superutilisateur avec des autorisations d'acc√®s et de modification de toutes les ressources du syst√®me.
* Ils peuvent g√©rer toutes les organisations, √©quipes, projets, inventaires, mod√®les de t√¢ches, etc.
2. **Auditeur syst√®me** :
* Les utilisateurs ayant ce r√¥le peuvent visualiser toutes les donn√©es du syst√®me mais ne peuvent apporter aucune modification.
* Ce r√¥le est con√ßu pour la conformit√© et la surveillance.
3. **R√¥les d'organisation** :
* **Admin** : Contr√¥le total sur les ressources de l'organisation.
* **Auditeur** : Acc√®s en lecture seule aux ressources de l'organisation.
* **Membre** : Adh√©sion de base √† une organisation sans autorisations sp√©cifiques.
* **Ex√©cuter** : Peut ex√©cuter des mod√®les de t√¢ches au sein de l'organisation.
* **Lire** : Peut visualiser les ressources de l'organisation.
4. **R√¥les de projet** :
* **Admin** : Peut g√©rer et modifier le projet.
* **Utiliser** : Peut utiliser le projet dans un mod√®le de t√¢che.
* **Mettre √† jour** : Peut mettre √† jour le projet en utilisant le SCM (contr√¥le de source).
5. **R√¥les d'inventaire** :
* **Admin** : Peut g√©rer et modifier l'inventaire.
* **Ad hoc** : Peut ex√©cuter des commandes ad hoc sur l'inventaire.
* **Mettre √† jour** : Peut mettre √† jour la source de l'inventaire.
* **Utiliser** : Peut utiliser l'inventaire dans un mod√®le de t√¢che.
* **Lire** : Acc√®s en lecture seule.
6. **R√¥les de mod√®le de t√¢che** :
* **Admin** : Peut g√©rer et modifier le mod√®le de t√¢che.
* **Ex√©cuter** : Peut ex√©cuter la t√¢che.
* **Lire** : Acc√®s en lecture seule.
7. **R√¥les de certificat** :
* **Admin** : Peut g√©rer et modifier les certificats.
* **Utiliser** : Peut utiliser les certificats dans des mod√®les de t√¢ches ou d'autres ressources pertinentes.
* **Lire** : Acc√®s en lecture seule.
8. **R√¥les d'√©quipe** :
* **Membre** : Fait partie de l'√©quipe mais sans autorisations sp√©cifiques.
* **Admin** : Peut g√©rer les membres de l'√©quipe et les ressources associ√©es.
9. **R√¥les de flux de travail** :
* **Admin** : Peut g√©rer et modifier le flux de travail.
* **Ex√©cuter** : Peut ex√©cuter le flux de travail.
* **Lire** : Acc√®s en lecture seule.

</details>

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
