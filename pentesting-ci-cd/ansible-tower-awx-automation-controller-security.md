# Ansible Tower / AWX / Automation controller セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

**Ansible Tower**またはそのオープンソースバージョンの[**AWX**](https://github.com/ansible/awx)は、**Ansibleのユーザーインターフェース、ダッシュボード、およびREST API**としても知られています。**ロールベースのアクセス制御**、ジョブスケジューリング、グラフィカルなインベントリ管理を備えており、モダンなUIからAnsibleインフラを管理できます。TowerのREST APIとコマンドラインインターフェースにより、既存のツールやワークフローに簡単に統合できます。

**Automation Controllerは、**より多くの機能を備えたAnsible Towerの新しいバージョンです。

### 違い

[**こちら**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00)によると、Ansible TowerとAWXの主な違いは、受けられるサポートと、Ansible Towerにはロールベースのアクセス制御、カスタムAPIのサポート、ユーザー定義のワークフローなどの追加機能があることです。

### テックスタック

* **Webインターフェース**: ユーザーは、インベントリ、資格情報、テンプレート、およびジョブを管理できるグラフィカルインターフェースです。直感的に設計されており、自動化ジョブの状態と結果を理解するのに役立つ視覚化を提供します。
* **REST API**: Webインターフェースでできることは、REST APIを介しても実行できます。これにより、AWX/Towerを他のシステムに統合したり、インターフェースで通常行うアクションをスクリプト化したりできます。
* **データベース**: AWX/Towerは、設定、ジョブ結果、その他の必要な運用データを保存するためにデータベース（通常はPostgreSQL）を使用します。
* **RabbitMQ**: AWX/Towerが異なるコンポーネント間、特にWebサービスとタスクランナー間で通信するために使用するメッセージングシステムです。
* **Redis**: Redisはキャッシュとして機能し、タスクキューのバックエンドとしても使用されます。

### 論理コンポーネント

* **インベントリ**: インベントリは、**ジョブ**（Ansibleプレイブック）を**実行**できる**ホスト（またはノード）のコレクション**です。AWX/Towerでは、インベントリを定義してグループ化できるだけでなく、AWS、Azureなどの他のシステムからホストリストを**取得**できる動的インベントリもサポートしています。
* **プロジェクト**: プロジェクトは、必要に応じて最新のプレイブックをプルするために**バージョン管理システム**（Gitなど）から取得される**Ansibleプレイブックのコレクション**です。
* **テンプレート**: ジョブテンプレートは、特定のプレイブックがどのように実行されるかを定義し、ジョブの**インベントリ**、**資格情報**、およびその他の**パラメーター**を指定します。
* **資格情報**: AWX/Towerは、SSHキー、パスワード、APIトークンなどの秘密を**管理および保存**する安全な方法を提供します。これらの資格情報はジョブテンプレートに関連付けられ、プレイブックが実行されるときに必要なアクセスを提供できます。
* **タスクエンジン**: ここで魔法が起こります。タスクエンジンはAnsibleに基づいて構築されており、**プレイブックの実行**を担当しています。ジョブはタスクエンジンに送信され、指定された資格情報を使用して指定されたインベントリに対してAnsibleプレイブックを実行します。
* **スケジューラーとコールバック**: これらはAWX/Towerの高度な機能であり、**ジョブを特定の時間にスケジュール**したり、外部イベントによってトリガーされるようにすることができます。
* **通知**: AWX/Towerは、ジョブの成功または失敗に基づいて通知を送信できます。通知の手段には、電子メール、Slackメッセージ、Webhookなどがあります。
* **Ansibleプレイブック**: Ansibleプレイブックは、設定、デプロイメント、およびオーケストレーションツールです。自動化された繰り返し可能な方法でシステムの望ましい状態を記述します。YAMLで記述されたプレイブックは、設定、タスク、および実行する必要のあるステップをAnsibleの宣言型自動化言語を使用して記述します。

### ジョブ実行フロー

1. **ユーザーインタラクション**: ユーザーは、**Webインターフェース**または**REST API**を通じてAWX/Towerと対話できます。これらはAWX/Towerが提供するすべての機能へのフロントエンドアクセスを提供します。
2. **ジョブの開始**:
* ユーザーは、WebインターフェースまたはAPIを介して、**ジョブテンプレート**に基づいてジョブを開始します。
* ジョブテンプレートには、**インベントリ**、**プロジェクト**（プレイブックを含む）、および**資格情報**への参照が含まれています。
* ジョブを開始すると、ジョブを実行キューに入れるためのリクエストがAWX/Towerのバックエンドに送信されます。
3. **ジョブキューイング**:
* **RabbitMQ**は、Webコンポーネントとタスクランナー間のメッセージングを処理します。ジョブが開始されると、RabbitMQを使用してタスクエンジンにメッセージが送信されます。
* **Redis**は、実行を待機しているキューに入れられたジョブを管理するタスクキューのバックエンドとして機能します。
4. **ジョブの実行**:
* **タスクエンジン**はキューに入れられたジョブを取り上げます。ジョブに関連するプレイブック、インベントリ、および資格情報についての必要な情報を**データベース**から取得します。
* 関連する**プロジェクト**から取得したAnsibleプレイブックを使用して、タスクエンジンは指定された**資格情報**を使用して指定された**インベントリ**ノードに対してプレイブックを実行します。
* プレイブックが実行されると、その実行出力（ログ、ファクトなど）がキャプチャされ、**データベース**に保存されます。
5. **ジョブ結果**:
* プレイブックの実行が終了すると、結果（成功、失敗、ログ）が**データベース**に保存されます。
* ユーザーはその後、Webインターフェースを通じて結果を表示したり、REST APIを介してそれらを照会したりできます。
* ジョブの結果に基づいて、**通知**がユーザーや外部システムにジョブの状態を知らせるために送信されることがあります。通知には、電子メール、Slackメッセージ、Webhookなどが含まれることがあります。
6. **外部システムとの統合**:
* **インベントリ**は外部システムから動的に取得でき、AWX/TowerがAWS、Azure、VMwareなどのソースからホストを取り込むことを可能にします。
* **プロジェクト**（プレイブック）はバージョン管理システムから取得でき、ジョブ実行中に最新のプレイブックを使用することを保証します。
* **スケジューラーとコールバック**は、他のシステムやツールと統合するために使用でき、AWX/Towerが外部トリガーに反応したり、予定された時間にジョブを実行したりすることができます。
### AWXラボの作成とテスト

[**ドキュメントに従って**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md)、docker-composeを使用してAWXを実行することができます：

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
```markdown
{% endcode %}

## RBAC

### サポートされるロール

最も特権的なロールは **System Administrator** と呼ばれます。このロールを持つ人は**何でも変更できます**。

**ホワイトボックスセキュリティ**レビューからは、**System Auditor ロール**が必要になります。これにより**システムデータを全て閲覧できます**が、変更はできません。別の選択肢として **Organization Auditor ロール**を取得することもできますが、他のロールを取得する方が良いでしょう。

<details>

<summary>利用可能なロールの詳細な説明を得るには、これを展開してください</summary>

1. **System Administrator**:
* システム内の任意のリソースにアクセスし、変更できるスーパーユーザーロールです。
* すべての組織、チーム、プロジェクト、インベントリ、ジョブテンプレートなどを管理できます。
2. **System Auditor**:
* このロールを持つユーザーは、システムデータを全て閲覧できますが、変更はできません。
* このロールはコンプライアンスと監視のために設計されています。
3. **Organization Roles**:
* **Admin**: 組織のリソースに対する完全なコントロール。
* **Auditor**: 組織のリソースに対する閲覧専用アクセス。
* **Member**: 特定の権限なしに組織に所属する基本的なメンバーシップ。
* **Execute**: 組織内でジョブテンプレートを実行できます。
* **Read**: 組織のリソースを閲覧できます。
4. **Project Roles**:
* **Admin**: プロジェクトを管理し、変更できます。
* **Use**: ジョブテンプレートでプロジェクトを使用できます。
* **Update**: SCM（ソースコントロール）を使用してプロジェクトを更新できます。
5. **Inventory Roles**:
* **Admin**: インベントリを管理し、変更できます。
* **Ad Hoc**: インベントリでアドホックコマンドを実行できます。
* **Update**: インベントリソースを更新できます。
* **Use**: ジョブテンプレートでインベントリを使用できます。
* **Read**: 閲覧専用アクセス。
6. **Job Template Roles**:
* **Admin**: ジョブテンプレートを管理し、変更できます。
* **Execute**: ジョブを実行できます。
* **Read**: 閲覧専用アクセス。
7. **Credential Roles**:
* **Admin**: 資格情報を管理し、変更できます。
* **Use**: ジョブテンプレートや他の関連リソースで資格情報を使用できます。
* **Read**: 閲覧専用アクセス。
8. **Team Roles**:
* **Member**: 特定の権限なしにチームの一部。
* **Admin**: チームのメンバーと関連リソースを管理できます。
9. **Workflow Roles**:
* **Admin**: ワークフローを管理し、変更できます。
* **Execute**: ワークフローを実行できます。
* **Read**: 閲覧専用アクセス。

</details>

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWS ハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式の PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションです。
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)や [**telegram グループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを**共有してください**。

</details>
```
