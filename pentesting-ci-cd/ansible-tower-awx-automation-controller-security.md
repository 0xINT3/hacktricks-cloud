# S√©curit√© d'Ansible Tower / AWX / Automation Controller

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

**Ansible Tower** ou sa version open source [**AWX**](https://github.com/ansible/awx) est √©galement connue comme **l'interface utilisateur, le tableau de bord et l'API REST d'Ansible**. Avec le **contr√¥le d'acc√®s bas√© sur les r√¥les**, la planification des t√¢ches et la gestion graphique des inventaires, vous pouvez g√©rer votre infrastructure Ansible depuis une interface moderne. L'API REST et l'interface en ligne de commande de Tower facilitent son int√©gration dans les outils et les flux de travail existants.

**Automation Controller est une version plus r√©cente** d'Ansible Tower avec plus de capacit√©s.

### Diff√©rences

Selon [**ceci**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00), les principales diff√©rences entre Ansible Tower et AWS sont le support re√ßu et le fait qu'Ansible Tower dispose de fonctionnalit√©s suppl√©mentaires telles que le contr√¥le d'acc√®s bas√© sur les r√¥les, le support pour les API personnalis√©es et les workflows d√©finis par l'utilisateur.

### Pile technologique

* **Interface Web** : C'est l'interface graphique o√π les utilisateurs peuvent g√©rer les inventaires, les identifiants, les mod√®les et les t√¢ches. Elle est con√ßue pour √™tre intuitive et fournit des visualisations pour aider √† comprendre l'√©tat et les r√©sultats de vos t√¢ches d'automatisation.
* **API REST** : Tout ce que vous pouvez faire dans l'interface web, vous pouvez √©galement le faire via l'API REST. Cela signifie que vous pouvez int√©grer AWX/Tower avec d'autres syst√®mes ou scripter des actions que vous effectueriez normalement dans l'interface.
* **Base de donn√©es** : AWX/Tower utilise une base de donn√©es (typiquement PostgreSQL) pour stocker sa configuration, les r√©sultats des t√¢ches et d'autres donn√©es op√©rationnelles n√©cessaires.
* **RabbitMQ** : C'est le syst√®me de messagerie utilis√© par AWX/Tower pour communiquer entre les diff√©rents composants, en particulier entre le service web et les ex√©cutants de t√¢ches.
* **Redis** : Redis sert de cache et de backend pour la file d'attente des t√¢ches.

### Composants logiques

* **Inventaires** : Un inventaire est une **collection d'h√¥tes (ou de n≈ìuds)** contre lesquels des **t√¢ches** (playbooks Ansible) peuvent √™tre **ex√©cut√©es**. AWX/Tower vous permet de d√©finir et de grouper vos inventaires et prend √©galement en charge les inventaires dynamiques qui peuvent **r√©cup√©rer des listes d'h√¥tes √† partir d'autres syst√®mes** comme AWS, Azure, etc.
* **Projets** : Un projet est essentiellement une **collection de playbooks Ansible** provenant d'un **syst√®me de contr√¥le de version** (comme Git) pour tirer les derniers playbooks lorsque n√©cessaire.
* **Mod√®les** : Les mod√®les de t√¢ches d√©finissent **comment un playbook particulier sera ex√©cut√©**, en sp√©cifiant l'**inventaire**, les **identifiants** et d'autres **param√®tres** pour la t√¢che.
* **Identifiants** : AWX/Tower fournit un moyen s√©curis√© de **g√©rer et stocker des secrets, tels que des cl√©s SSH, des mots de passe et des jetons d'API**. Ces identifiants peuvent √™tre associ√©s √† des mod√®les de t√¢ches afin que les playbooks aient l'acc√®s n√©cessaire lorsqu'ils s'ex√©cutent.
* **Moteur de t√¢ches** : C'est l√† que la magie op√®re. Le moteur de t√¢ches est construit sur Ansible et est responsable de **l'ex√©cution des playbooks**. Les t√¢ches sont envoy√©es au moteur de t√¢ches, qui ex√©cute ensuite les playbooks Ansible contre l'inventaire d√©sign√© en utilisant les identifiants sp√©cifi√©s.
* **Planificateurs et Callbacks** : Ce sont des fonctionnalit√©s avanc√©es dans AWX/Tower qui permettent **de planifier des t√¢ches** pour qu'elles s'ex√©cutent √† des moments sp√©cifiques ou d√©clench√©es par des √©v√©nements externes.
* **Notifications** : AWX/Tower peut envoyer des notifications bas√©es sur le succ√®s ou l'√©chec des t√¢ches. Il prend en charge divers moyens de notifications tels que les emails, les messages Slack, les webhooks, etc.
* **Playbooks Ansible** : Les playbooks Ansible sont des outils de configuration, de d√©ploiement et d'orchestration. Ils d√©crivent l'√©tat souhait√© des syst√®mes de mani√®re automatis√©e et r√©p√©table. √âcrits en YAML, les playbooks utilisent le langage d'automatisation d√©claratif d'Ansible pour d√©crire les configurations, les t√¢ches et les √©tapes √† ex√©cuter.

### Flux d'ex√©cution des t√¢ches

1. **Interaction utilisateur** : Un utilisateur peut interagir avec AWX/Tower soit via l'**Interface Web** soit via l'**API REST**. Celles-ci fournissent un acc√®s frontal √† toutes les fonctionnalit√©s offertes par AWX/Tower.
2. **Initiation de la t√¢che** :
* L'utilisateur, via l'Interface Web ou l'API, initie une t√¢che bas√©e sur un **Mod√®le de t√¢che**.
* Le Mod√®le de t√¢che inclut des r√©f√©rences √† l'**Inventaire**, au **Projet** (contenant le playbook) et aux **Identifiants**.
* Lors de l'initiation de la t√¢che, une demande est envoy√©e au backend AWX/Tower pour mettre la t√¢che en file d'attente pour ex√©cution.
3. **Mise en file d'attente de la t√¢che** :
* **RabbitMQ** g√®re la messagerie entre le composant web et les ex√©cutants de t√¢ches. Une fois une t√¢che initi√©e, un message est envoy√© au moteur de t√¢ches en utilisant RabbitMQ.
* **Redis** agit comme le backend pour la file d'attente des t√¢ches, g√©rant les t√¢ches en attente d'ex√©cution.
4. **Ex√©cution de la t√¢che** :
* Le **Moteur de t√¢ches** prend en charge la t√¢che en file d'attente. Il r√©cup√®re les informations n√©cessaires de la **Base de donn√©es** sur le playbook associ√© √† la t√¢che, l'inventaire et les identifiants.
* En utilisant le playbook Ansible r√©cup√©r√© du **Projet** associ√©, le Moteur de t√¢ches ex√©cute le playbook contre les n≈ìuds de l'**Inventaire** sp√©cifi√© en utilisant les **Identifiants** fournis.
* Pendant l'ex√©cution du playbook, sa sortie (logs, faits, etc.) est captur√©e et stock√©e dans la **Base de donn√©es**.
5. **R√©sultats de la t√¢che** :
* Une fois le playbook termin√©, les r√©sultats (succ√®s, √©chec, logs) sont sauvegard√©s dans la **Base de donn√©es**.
* Les utilisateurs peuvent ensuite visualiser les r√©sultats via l'Interface Web ou les interroger via l'API REST.
* En fonction des r√©sultats des t√¢ches, des **Notifications** peuvent √™tre envoy√©es pour informer les utilisateurs ou les syst√®mes externes sur le statut de la t√¢che. Les notifications pourraient √™tre des emails, des messages Slack, des webhooks, etc.
6. **Int√©gration avec les syst√®mes externes** :
* Les **Inventaires** peuvent √™tre source√©s dynamiquement √† partir de syst√®mes externes, permettant √† AWX/Tower de tirer des h√¥tes de sources comme AWS, Azure, VMware et plus encore.
* Les **Projets** (playbooks) peuvent √™tre r√©cup√©r√©s √† partir de syst√®mes de contr√¥le de version, assurant l'utilisation de playbooks √† jour lors de l'ex√©cution des t√¢ches.
* Les **Planificateurs et Callbacks** peuvent √™tre utilis√©s pour s'int√©grer avec d'autres syst√®mes ou outils, rendant AWX/Tower r√©actif √† des d√©clencheurs externes ou ex√©cutant des t√¢ches √† des moments pr√©d√©termin√©s.
### Cr√©ation d'un laboratoire AWX pour les tests

[**Suivant la documentation**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md), il est possible d'utiliser docker-compose pour ex√©cuter AWX :

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
```markdown
{% endcode %}

## RBAC

### R√¥les pris en charge

Le r√¥le le plus privil√©gi√© est appel√© **Administrateur Syst√®me**. Quiconque ayant ce r√¥le peut **modifier n'importe quoi**.

Pour une revue de s√©curit√© **bo√Æte blanche**, vous auriez besoin du r√¥le **Auditeur Syst√®me**, qui permet de **voir toutes les donn√©es du syst√®me** mais ne peut faire aucun changement. Une autre option serait d'obtenir le r√¥le **Auditeur Organisation**, mais il serait pr√©f√©rable d'obtenir l'autre.

<details>

<summary>D√©veloppez ceci pour obtenir une description d√©taill√©e des r√¥les disponibles</summary>

1. **Administrateur Syst√®me** :
* C'est le r√¥le superutilisateur avec des permissions pour acc√©der et modifier toute ressource dans le syst√®me.
* Ils peuvent g√©rer toutes les organisations, √©quipes, projets, inventaires, mod√®les de travaux, etc.
2. **Auditeur Syst√®me** :
* Les utilisateurs avec ce r√¥le peuvent voir toutes les donn√©es du syst√®me mais ne peuvent faire aucun changement.
* Ce r√¥le est con√ßu pour la conformit√© et la supervision.
3. **R√¥les d'Organisation** :
* **Admin** : Contr√¥le total sur les ressources de l'organisation.
* **Auditeur** : Acc√®s en lecture seule aux ressources de l'organisation.
* **Membre** : Adh√©sion de base dans une organisation sans permissions sp√©cifiques.
* **Ex√©cuter** : Peut lancer des mod√®les de travaux au sein de l'organisation.
* **Lire** : Peut voir les ressources de l‚Äôorganisation.
4. **R√¥les de Projet** :
* **Admin** : Peut g√©rer et modifier le projet.
* **Utiliser** : Peut utiliser le projet dans un mod√®le de travail.
* **Mettre √† jour** : Peut mettre √† jour le projet en utilisant SCM (gestion de source).
5. **R√¥les d'Inventaire** :
* **Admin** : Peut g√©rer et modifier l'inventaire.
* **Ad Hoc** : Peut lancer des commandes ad hoc sur l'inventaire.
* **Mettre √† jour** : Peut mettre √† jour la source de l'inventaire.
* **Utiliser** : Peut utiliser l'inventaire dans un mod√®le de travail.
* **Lire** : Acc√®s en lecture seule.
6. **R√¥les de Mod√®le de Travail** :
* **Admin** : Peut g√©rer et modifier le mod√®le de travail.
* **Ex√©cuter** : Peut lancer le travail.
* **Lire** : Acc√®s en lecture seule.
7. **R√¥les de Justificatifs** :
* **Admin** : Peut g√©rer et modifier les justificatifs.
* **Utiliser** : Peut utiliser les justificatifs dans des mod√®les de travaux ou d'autres ressources pertinentes.
* **Lire** : Acc√®s en lecture seule.
8. **R√¥les d'√âquipe** :
* **Membre** : Fait partie de l'√©quipe mais sans permissions sp√©cifiques.
* **Admin** : Peut g√©rer les membres de l'√©quipe et les ressources associ√©es.
9. **R√¥les de Flux de Travail** :
* **Admin** : Peut g√©rer et modifier le flux de travail.
* **Ex√©cuter** : Peut lancer le flux de travail.
* **Lire** : Acc√®s en lecture seule.

</details>

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
