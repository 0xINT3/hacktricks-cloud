# Seguran√ßa do Ansible Tower / AWX / Controlador de Automa√ß√£o

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

**Ansible Tower** ou sua vers√£o de c√≥digo aberto [**AWX**](https://github.com/ansible/awx) tamb√©m √© conhecido como **interface de usu√°rio do Ansible, painel e API REST**. Com **controle de acesso baseado em fun√ß√µes**, agendamento de tarefas e gerenciamento gr√°fico de invent√°rio, voc√™ pode gerenciar sua infraestrutura Ansible a partir de uma UI moderna. A API REST e a interface de linha de comando do Tower tornam simples integr√°-lo √†s ferramentas e fluxos de trabalho atuais.

**O Controlador de Automa√ß√£o √© uma vers√£o mais recente** do Ansible Tower com mais capacidades.

### Diferen√ßas

De acordo com [**este**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00), as principais diferen√ßas entre o Ansible Tower e o AWX s√£o o suporte recebido e o Ansible Tower possui recursos adicionais, como controle de acesso baseado em fun√ß√µes, suporte para APIs personalizadas e fluxos de trabalho definidos pelo usu√°rio.

### Pilha Tecnol√≥gica

* **Interface Web**: Esta √© a interface gr√°fica onde os usu√°rios podem gerenciar invent√°rios, credenciais, modelos e tarefas. √â projetada para ser intuitiva e fornece visualiza√ß√µes para ajudar a entender o estado e os resultados de suas tarefas de automa√ß√£o.
* **API REST**: Tudo o que voc√™ pode fazer na interface web, tamb√©m pode ser feito via API REST. Isso significa que voc√™ pode integrar o AWX/Tower com outros sistemas ou automatizar a√ß√µes que normalmente seriam realizadas na interface.
* **Banco de Dados**: O AWX/Tower usa um banco de dados (tipicamente PostgreSQL) para armazenar sua configura√ß√£o, resultados de tarefas e outros dados operacionais necess√°rios.
* **RabbitMQ**: Este √© o sistema de mensagens usado pelo AWX/Tower para se comunicar entre os diferentes componentes, especialmente entre o servi√ßo web e os executores de tarefas.
* **Redis**: O Redis atua como um cache e um backend para a fila de tarefas.

### Componentes L√≥gicos

* **Invent√°rios**: Um invent√°rio √© uma **cole√ß√£o de hosts (ou n√≥s)** nos quais as **tarefas** (playbooks Ansible) podem ser **executadas**. O AWX/Tower permite que voc√™ defina e agrupe seus invent√°rios e tamb√©m suporta invent√°rios din√¢micos que podem **buscar listas de hosts de outros sistemas** como AWS, Azure, etc.
* **Projetos**: Um projeto √© essencialmente uma **cole√ß√£o de playbooks Ansible** provenientes de um **sistema de controle de vers√£o** (como Git) para buscar os playbooks mais recentes quando necess√°rio.
* **Modelos**: Os modelos de tarefas definem **como um playbook espec√≠fico ser√° executado**, especificando o **invent√°rio**, **credenciais** e outros **par√¢metros** para a tarefa.
* **Credenciais**: O AWX/Tower fornece uma maneira segura de **gerenciar e armazenar segredos, como chaves SSH, senhas e tokens de API**. Essas credenciais podem ser associadas aos modelos de tarefas para que os playbooks tenham o acesso necess√°rio quando s√£o executados.
* **Motor de Tarefas**: Aqui √© onde a m√°gica acontece. O motor de tarefas √© constru√≠do no Ansible e √© respons√°vel por **executar os playbooks**. As tarefas s√£o despachadas para o motor de tarefas, que ent√£o executa os playbooks Ansible no invent√°rio designado usando as credenciais especificadas.
* **Agendadores e Callbacks**: Estes s√£o recursos avan√ßados no AWX/Tower que permitem **agendar tarefas** para serem executadas em hor√°rios espec√≠ficos ou acionadas por eventos externos.
* **Notifica√ß√µes**: O AWX/Tower pode enviar notifica√ß√µes com base no sucesso ou falha das tarefas. Ele suporta v√°rios meios de notifica√ß√£o, como e-mails, mensagens no Slack, webhooks, etc.
* **Playbooks Ansible**: Os playbooks Ansible s√£o ferramentas de configura√ß√£o, implanta√ß√£o e orquestra√ß√£o. Eles descrevem o estado desejado dos sistemas de forma automatizada e repet√≠vel. Escritos em YAML, os playbooks usam a linguagem de automa√ß√£o declarativa do Ansible para descrever configura√ß√µes, tarefas e etapas que precisam ser executadas.

### Fluxo de Execu√ß√£o de Tarefas

1. **Intera√ß√£o do Usu√°rio**: Um usu√°rio pode interagir com o AWX/Tower atrav√©s da **Interface Web** ou da **API REST**. Estas fornecem acesso frontal a todas as funcionalidades oferecidas pelo AWX/Tower.
2. **Inicializa√ß√£o da Tarefa**:
* O usu√°rio, via Interface Web ou API, inicia uma tarefa com base em um **Modelo de Tarefa**.
* O Modelo de Tarefa inclui refer√™ncias ao **Invent√°rio**, **Projeto** (contendo o playbook) e **Credenciais**.
* Ap√≥s a inicializa√ß√£o da tarefa, √© enviada uma solicita√ß√£o ao backend do AWX/Tower para enfileirar a tarefa para execu√ß√£o.
3. **Enfileiramento da Tarefa**:
* O **RabbitMQ** lida com a comunica√ß√£o entre o componente web e os executores de tarefas. Uma vez que uma tarefa √© iniciada, uma mensagem √© despachada para o motor de tarefas usando o RabbitMQ.
* O **Redis** atua como o backend para a fila de tarefas, gerenciando tarefas enfileiradas aguardando execu√ß√£o.
4. **Execu√ß√£o da Tarefa**:
* O **Motor de Tarefas** pega a tarefa enfileirada. Ele recupera as informa√ß√µes necess√°rias do **Banco de Dados** sobre o playbook associado √† tarefa, invent√°rio e credenciais.
* Usando o playbook Ansible recuperado do **Projeto** associado, o Motor de Tarefas executa o playbook nos n√≥s do **Invent√°rio** especificado usando as **Credenciais** fornecidas.
* Conforme o playbook √© executado, sua sa√≠da de execu√ß√£o (logs, fatos, etc.) √© capturada e armazenada no **Banco de Dados**.
5. **Resultados da Tarefa**:
* Uma vez que o playbook termina de ser executado, os resultados (sucesso, falha, logs) s√£o salvos no **Banco de Dados**.
* Os usu√°rios podem ent√£o visualizar os resultados atrav√©s da Interface Web ou consult√°-los via API REST.
* Com base nos resultados da tarefa, **Notifica√ß√µes** podem ser despachadas para informar os usu√°rios ou sistemas externos sobre o status da tarefa. As notifica√ß√µes podem ser e-mails, mensagens no Slack, webhooks, etc.
6. **Integra√ß√£o com Sistemas Externos**:
* **Invent√°rios** podem ser obtidos dinamicamente de sistemas externos, permitindo que o AWX/Tower traga hosts de fontes como AWS, Azure, VMware e outros.
* **Projetos** (playbooks) podem ser obtidos de sistemas de controle de vers√£o, garantindo o uso de playbooks atualizados durante a execu√ß√£o das tarefas.
* **Agendadores e Callbacks** podem ser usados para integrar com outros sistemas ou ferramentas, fazendo com que o AWX/Tower reaja a gatilhos externos ou execute tarefas em hor√°rios predeterminados.

### Cria√ß√£o de laborat√≥rio AWX para testes

[**Seguindo a documenta√ß√£o**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md) √© poss√≠vel usar o docker-compose para executar o AWX:

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
{% endcode %}

## RBAC

### Fun√ß√µes Suportadas

A fun√ß√£o mais privilegiada √© chamada de **Administrador do Sistema**. Qualquer pessoa com essa fun√ß√£o pode **modificar qualquer coisa**.

De uma revis√£o de seguran√ßa de **caixa branca**, voc√™ precisaria da fun√ß√£o de **Auditor do Sistema**, que permite **visualizar todos os dados do sistema** mas n√£o pode fazer altera√ß√µes. Outra op√ß√£o seria obter a fun√ß√£o de **Auditor da Organiza√ß√£o**, mas seria melhor obter a outra.

<details>

<summary>Expanda para obter uma descri√ß√£o detalhada das fun√ß√µes dispon√≠veis</summary>

1. **Administrador do Sistema**:
* Esta √© a fun√ß√£o de superusu√°rio com permiss√µes para acessar e modificar qualquer recurso no sistema.
* Eles podem gerenciar todas as organiza√ß√µes, equipes, projetos, invent√°rios, modelos de trabalho, etc.
2. **Auditor do Sistema**:
* Usu√°rios com esta fun√ß√£o podem visualizar todos os dados do sistema, mas n√£o podem fazer altera√ß√µes.
* Esta fun√ß√£o √© projetada para conformidade e supervis√£o.
3. **Fun√ß√µes da Organiza√ß√£o**:
* **Admin**: Controle total sobre os recursos da organiza√ß√£o.
* **Auditor**: Acesso somente leitura aos recursos da organiza√ß√£o.
* **Membro**: Associa√ß√£o b√°sica em uma organiza√ß√£o sem permiss√µes espec√≠ficas.
* **Executar**: Pode executar modelos de trabalho dentro da organiza√ß√£o.
* **Ler**: Pode visualizar os recursos da organiza√ß√£o.
4. **Fun√ß√µes do Projeto**:
* **Admin**: Pode gerenciar e modificar o projeto.
* **Usar**: Pode usar o projeto em um modelo de trabalho.
* **Atualizar**: Pode atualizar o projeto usando SCM (controle de origem).
5. **Fun√ß√µes do Invent√°rio**:
* **Admin**: Pode gerenciar e modificar o invent√°rio.
* **Ad Hoc**: Pode executar comandos ad hoc no invent√°rio.
* **Atualizar**: Pode atualizar a origem do invent√°rio.
* **Usar**: Pode usar o invent√°rio em um modelo de trabalho.
* **Ler**: Acesso somente leitura.
6. **Fun√ß√µes do Modelo de Trabalho**:
* **Admin**: Pode gerenciar e modificar o modelo de trabalho.
* **Executar**: Pode executar o trabalho.
* **Ler**: Acesso somente leitura.
7. **Fun√ß√µes de Credencial**:
* **Admin**: Pode gerenciar e modificar as credenciais.
* **Usar**: Pode usar as credenciais em modelos de trabalho ou outros recursos relevantes.
* **Ler**: Acesso somente leitura.
8. **Fun√ß√µes da Equipe**:
* **Membro**: Parte da equipe, mas sem permiss√µes espec√≠ficas.
* **Admin**: Pode gerenciar os membros da equipe e os recursos associados.
9. **Fun√ß√µes do Fluxo de Trabalho**:
* **Admin**: Pode gerenciar e modificar o fluxo de trabalho.
* **Executar**: Pode executar o fluxo de trabalho.
* **Ler**: Acesso somente leitura.

</details>
