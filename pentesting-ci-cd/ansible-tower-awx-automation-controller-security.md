# Ansible Tower / AWX / 自动化控制器 安全性

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## 基本信息

**Ansible Tower** 或其开源版本 [**AWX**](https://github.com/ansible/awx) 也被称为 **Ansible的用户界面、仪表板和REST API**。通过**基于角色的访问控制**、作业调度和图形化库存管理，您可以从现代UI管理您的Ansible基础设施。Tower的REST API和命令行界面使其易于集成到现有工具和工作流程中。

**自动化控制器是Ansible Tower的更新**版本，具有更多功能。

### 差异

根据[**这篇文章**](https://blog.devops.dev/ansible-tower-vs-awx-under-the-hood-65cfec78db00)，Ansible Tower和AWX之间的主要区别在于所接收的支持，以及Ansible Tower具有额外的功能，如基于角色的访问控制、对自定义API的支持和用户定义的工作流程。

### 技术栈

* **Web界面**：这是用户可以管理库存、凭证、模板和作业的图形界面。它设计直观，并提供可视化帮助，以便理解自动化作业的状态和结果。
* **REST API**：您在Web界面中可以做的所有事情，也可以通过REST API完成。这意味着您可以将AWX/Tower与其他系统集成，或者编写脚本来执行通常在界面中进行的操作。
* **数据库**：AWX/Tower使用数据库（通常是PostgreSQL）来存储其配置、作业结果和其他必要的运营数据。
* **RabbitMQ**：这是AWX/Tower用来在不同组件之间通信的消息系统，特别是在Web服务和任务运行器之间。
* **Redis**：Redis用作缓存和任务队列的后端。

### 逻辑组件

* **库存**：库存是**主机（或节点）的集合**，可以在其上**运行** **作业**（Ansible剧本）。AWX/Tower允许您定义和分组您的库存，并且还支持动态库存，可以**从其他系统获取主机列表**，如AWS、Azure等。
* **项目**：项目本质上是**Ansible剧本的集合**，源自**版本控制系统**（如Git），以便在需要时拉取最新的剧本。
* **模板**：作业模板定义了**特定剧本将如何运行**，指定了作业的**库存**、**凭证**和其他**参数**。
* **凭证**：AWX/Tower提供了一种安全的方式来**管理和存储秘密，如SSH密钥、密码和API令牌**。这些凭证可以与作业模板关联，以便剧本在运行时具有必要的访问权限。
* **任务引擎**：这是魔法发生的地方。任务引擎基于Ansible构建，负责**运行剧本**。作业被派发到任务引擎，然后任务引擎使用指定的凭证针对指定的库存运行Ansible剧本。
* **调度器和回调**：这些是AWX/Tower中的高级功能，允许**作业被安排**在特定时间运行或由外部事件触发。
* **通知**：AWX/Tower可以根据作业的成功或失败发送通知。它支持各种通知方式，如电子邮件、Slack消息、Webhooks等。
* **Ansible剧本**：Ansible剧本是配置、部署和编排工具。它们以自动化、可重复的方式描述了系统的期望状态。剧本用YAML编写，使用Ansible的声明式自动化语言来描述配置、任务和需要执行的步骤。

### 作业执行流程

1. **用户交互**：用户可以通过**Web界面**或**REST API**与AWX/Tower交互。这些提供了对AWX/Tower提供的所有功能的前端访问。
2. **作业启动**：
* 用户通过Web界面或API，基于**作业模板**启动作业。
* 作业模板包括对**库存**、**项目**（包含剧本）和**凭证**的引用。
* 作业启动时，将向AWX/Tower后端发送请求，将作业排队等待执行。
3. **作业排队**：
* **RabbitMQ**处理Web组件和任务运行器之间的消息传递。一旦作业启动，就会使用RabbitMQ向任务引擎派发消息。
* **Redis**作为任务队列的后端，管理等待执行的排队作业。
4. **作业执行**：
* **任务引擎**接手排队的作业。它从**数据库**中检索有关作业相关剧本、库存和凭证的必要信息。
* 使用从相关**项目**中检索的Ansible剧本，任务引擎使用提供的**凭证**针对指定的**库存**节点运行剧本。
* 剧本运行时，其执行输出（日志、事实等）被捕获并存储在**数据库**中。
5. **作业结果**：
* 一旦剧本完成运行，结果（成功、失败、日志）被保存到**数据库**中。
* 用户可以通过Web界面查看结果或通过REST API查询结果。
* 根据作业结果，可以派发**通知**以通知用户或外部系统作业的状态。通知可以是电子邮件、Slack消息、Webhooks等。
6. **外部系统集成**：
* **库存**可以从外部系统动态获取，允许AWX/Tower从AWS、Azure、VMware等来源拉取主机。
* **项目**（剧本）可以从版本控制系统获取，确保在作业执行期间使用最新的剧本。
* **调度器和回调**可以用来与其他系统或工具集成，使AWX/Tower对外部触发器做出反应或在预定时间运行作业。
### 创建AWX实验室进行测试

[**遵循文档**](https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md) 可以使用docker-compose来运行AWX：

{% code overflow="wrap" %}
```bash
git clone -b x.y.z https://github.com/ansible/awx.git # Get in x.y.z the latest release version

cd awx

# Build
make docker-compose-build

# Run
make docker-compose

# Or to create a more complex env
MAIN_NODE_TYPE=control EXECUTION_NODE_COUNT=2 COMPOSE_TAG=devel make docker-compose

# Clean and build the UI
docker exec tools_awx_1 make clean-ui ui-devel

# Once migrations are completed and the UI is built, you can begin using AWX. The UI can be reached in your browser at https://localhost:8043/#/home, and the API can be found at https://localhost:8043/api/v2.

# Create an admin user
docker exec -ti tools_awx_1 awx-manage createsuperuser

# Load demo data
docker exec tools_awx_1 awx-manage create_preload_data
```
```markdown
{% endcode %}

## RBAC

### 支持的角色

最高权限的角色称为**系统管理员**。拥有此角色的用户可以**修改任何内容**。

从**白盒安全**审查的角度，您需要**系统审计员角色**，该角色允许**查看所有系统数据**但不能进行任何更改。另一个选择是获取**组织审计员角色**，但最好是获得前者。

<details>

<summary>展开以获取可用角色的详细描述</summary>

1. **系统管理员**：
* 这是超级用户角色，拥有访问和修改系统中任何资源的权限。
* 他们可以管理所有组织、团队、项目、库存、作业模板等。
2. **系统审计员**：
* 拥有此角色的用户可以查看所有系统数据但不能进行任何更改。
* 该角色旨在用于合规性和监督。
3. **组织角色**：
* **管理员**：对组织资源的完全控制。
* **审计员**：对组织资源的只读访问。
* **成员**：在组织中的基本成员资格，没有任何特定权限。
* **执行**：可以在组织内运行作业模板。
* **读取**：可以查看组织的资源。
4. **项目角色**：
* **管理员**：可以管理和修改项目。
* **使用**：可以在作业模板中使用项目。
* **更新**：可以使用SCM（源代码管理）更新项目。
5. **库存角色**：
* **管理员**：可以管理和修改库存。
* **即席**：可以在库存上运行即席命令。
* **更新**：可以更新库存来源。
* **使用**：可以在作业模板中使用库存。
* **读取**：只读访问。
6. **作业模板角色**：
* **管理员**：可以管理和修改作业模板。
* **执行**：可以运行作业。
* **读取**：只读访问。
7. **凭证角色**：
* **管理员**：可以管理和修改凭证。
* **使用**：可以在作业模板或其他相关资源中使用凭证。
* **读取**：只读访问。
8. **团队角色**：
* **成员**：是团队的一部分，但没有任何特定权限。
* **管理员**：可以管理团队成员和相关资源。
9. **工作流角色**：
* **管理员**：可以管理和修改工作流。
* **执行**：可以运行工作流。
* **读取**：只读访问。

</details>

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
```
