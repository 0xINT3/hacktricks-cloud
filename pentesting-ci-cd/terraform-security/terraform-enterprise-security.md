# Terraform企业安全

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 基本信息

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) 是HashiCorp自托管的[Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs)分发版本。它为企业提供了一个**私有的Terraform Cloud应用实例**，没有资源限制，并且具有额外的企业级架构功能，如审计日志和SAML单点登录。

"默认情况下，Terraform Enterprise**不会阻止Terraform操作访问实例元数据服务**，该服务可能包含IAM凭证或其他敏感数据"（[来源](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)）

{% hint style="info" %}
尽管本文的重点是针对元数据服务进行攻击，但值得注意的是，在Terraform运行中获得代码执行权限可能会提供其他攻击途径。例如，可能会泄漏包含敏感凭据的环境变量。
{% endhint %}

## 远程Terraform执行 <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloud默认在其自己的云基础设施中运行Terraform的**一次性虚拟机**。您可以利用[Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents)在**您自己的隔离、私有或本地基础设施**上运行Terraform。远程Terraform执行有时也被称为"远程操作"。

因此，通过使用API密钥联系Terraform Enterprise，可以在云中的容器中**执行任意代码**。

[**Terraform API令牌**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens)可以通过**`.atlasv1.`子字符串**进行识别。它们通常位于`~/.terraform.d/`，但在攻击CI/CD平台和云平台时，您可能会在密钥或环境变量中找到它们。

您可以使用此令牌来**查找组织：**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
并使用这些信息找到工作区：
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
现在您需要创建一个配置文件来与Terraform Enterprise后端进行通信。只需获取[此示例](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf)并**添加一个`hostname`**，其中包含Terraform Enterprise实例的主机名：

{% code title="backend_config.tf" %}
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
{% endcode %}

初始化您的terraform以使用Terraform Enterprise令牌
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
现在，您已经**配置了Terraform以与Enterprise后端进行通信**，您只需按照[**Terraform中的RCE**](./#rce-in-terraform)一节的步骤进行操作：

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### 枢纽

正如先前提到的，Terrafomr Enterprise Infra可以在任何机器/云提供商上使用代理运行。因此，如果您可以在此机器上执行代码，您可以从元数据端点（[IAM，用户数据...](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)）中获取**云凭据**。\
此外，检查**文件系统**和**环境变量**以查找其他潜在的秘密和API密钥。\
还要记得检查机器所在的**网络**。

## 保护措施

{% hint style="info" %}
#### 禁用远程操作 <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Terraform Cloud的许多功能依赖于远程执行，在使用本地操作时不可用。这包括Sentinel策略执行、成本估算和通知等功能。

您可以通过将工作区的[执行模式](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode)更改为**本地**来禁用远程操作。这将使工作区仅充当Terraform状态的远程后端，所有执行都在您自己的工作站或持续集成工作器上进行。
{% endhint %}

{% hint style="info" %}
**限制Terraform构建工作器的元数据访问**

默认情况下，Terraform Enterprise不会阻止Terraform操作访问实例元数据服务，该服务可能包含IAM凭据或其他敏感数据。有关此服务的更多信息，请参阅[AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)、[Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows)或[Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata)文档。
{% endhint %}

## 参考资料

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>
