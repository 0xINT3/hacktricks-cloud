# Terraform Enterpriseのセキュリティ

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## 基本情報

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise)は、[Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs)のHashiCorpが自己ホストされたディストリビューションです。これは、エンタープライズに**Terraform Cloudアプリケーションのプライベートインスタンス**を提供し、リソース制限なしで、監査ログやSAMLシングルサインオンなどの追加のエンタープライズグレードのアーキテクチャ機能を備えています。

「デフォルトでは、Terraform Enterpriseは、IAM資格情報やその他の機密データを含む可能性のあるインスタンスメタデータサービスへのTerraform操作のアクセスを制限しません」（[出典](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)）

{% hint style="info" %}
この記事の焦点はメタデータサービスへの攻撃ですが、Terraformの実行内でコードの実行を取得することは、他の攻撃経路を提供する可能性があることに注意してください。たとえば、環境変数には機密情報が含まれている場合があります。
{% endhint %}

## リモートTerraform実行 <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloudは、デフォルトで**独自のクラウドインフラストラクチャ内の使い捨て仮想マシンでTerraformを実行**します。[Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents)を利用すると、Terraformを**独自の分離された、プライベート、またはオンプレミスのインフラストラクチャ上で実行**することができます。リモートTerraform実行は、時には「リモートオペレーション」とも呼ばれます。

したがって、Terraform Enterpriseに連絡するためのAPIキーを使用すると、クラウド内のコンテナで**任意のコードを実行**することができます。

[**Terraform APIトークン**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens)は、**`.atlasv1.`サブストリング**で識別できます。通常、`~/.terraform.d/`に配置されていますが、CI/CDプラットフォームやクラウドを攻撃すると、シークレットや環境変数に見つけることができるかもしれません。

このトークンを使用して、**組織を見つけることができます:**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
そして、この情報を使用してWorkspaceを見つけます：
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
今、Terraform Enterpriseバックエンドとの通信のための設定を作成する必要があります。[この例](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf)を取得し、Terraform Enterpriseインスタンスのホスト名を指定して**`hostname`を追加**してください。

{% code title="backend_config.tf" %}
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
{% endcode %}

Terraformを初期化してTerraform Enterpriseトークンを使用するように設定します。
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
**TerraformがEnterpriseバックエンドに接続するように設定された**ので、次に、セクション[**TerraformでのRCE**](./#rce-in-terraform)に従うだけです:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### ピボット

以前に述べたように、Terraform Enterprise Infraはエージェントを使用して任意のマシン/クラウドプロバイダで実行される場合があります。したがって、このマシンでコードを実行できれば、**メタデータエンドポイント（[IAM、ユーザーデータなど](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**）から**クラウドの資格情報を収集**することができます。\
さらに、他の潜在的な秘密やAPIキーを見つけるために、**ファイルシステム**と**環境変数**をチェックしてください。\
また、マシンが配置されている**ネットワーク**もチェックすることを忘れないでください。

## 保護

{% hint style="info" %}
#### リモート操作の無効化 <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Terraform Cloudの多くの機能はリモート実行に依存しており、ローカル操作を使用する場合は利用できません。これには、Sentinelポリシーの強制、コストの見積もり、通知などの機能が含まれます。

[実行モード](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode)を**ローカル**に変更することで、任意のワークスペースでリモート操作を無効にすることができます。これにより、ワークスペースはTerraformの状態のリモートバックエンドとしてのみ機能し、すべての実行は自分自身のワークステーションまたは継続的インテグレーションワーカーで行われます。
{% endhint %}

{% hint style="info" %}
**Terraformビルドワーカーのメタデータアクセスの制限**

デフォルトでは、Terraform EnterpriseはインスタンスメタデータサービスへのTerraform操作のアクセスを制限しません。このサービスにはIAMの資格情報やその他の機密データが含まれる場合があります。このサービスについての詳細については、[AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)、[Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows)、または[Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata)のドキュメントを参照してください。
{% endhint %}

## 参考文献

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>ハックトリックをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**PEASSの最新バージョンを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のgithubリポジトリに提出してください。**

</details>
