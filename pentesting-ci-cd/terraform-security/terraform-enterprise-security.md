# Seguran√ßa do Terraform Enterprise

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## Informa√ß√µes b√°sicas

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) √© a distribui√ß√£o auto-hospedada da Hashicorp do [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs). Ele oferece √†s empresas uma **inst√¢ncia privada da aplica√ß√£o Terraform Cloud**, sem limites de recursos e com recursos arquitet√¥nicos adicionais de n√≠vel empresarial, como registro de auditoria e SAML single sign-on.

"Por padr√£o, o Terraform Enterprise **n√£o impede que as opera√ß√µes do Terraform acessem o servi√ßo de metadados da inst√¢ncia**, que pode conter credenciais IAM ou outros dados confidenciais" ([fonte](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
Embora o foco deste artigo seja direcionado ao servi√ßo de metadados, vale ressaltar que a obten√ß√£o de execu√ß√£o de c√≥digo dentro de uma execu√ß√£o do Terraform pode fornecer outras formas de ataque. Por exemplo, vari√°veis de ambiente podem ser vazadas, o que pode conter credenciais confidenciais.
{% endhint %}

## Execu√ß√£o remota do Terraform <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

O Terraform Cloud executa o Terraform em **m√°quinas virtuais descart√°veis em sua pr√≥pria infraestrutura em nuvem** por padr√£o. Voc√™ pode aproveitar os [Agentes do Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs/agents) para executar o Terraform em **sua pr√≥pria infraestrutura isolada, privada ou local**. A execu√ß√£o remota do Terraform √© √†s vezes referida como "opera√ß√µes remotas".

Portanto, com uma chave de API para entrar em contato com o Terraform Enterprise, √© poss√≠vel **executar c√≥digo arbitr√°rio em um cont√™iner na nuvem**.

[**Tokens da API do Terraform**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) podem ser identificados pela **substring `.atlasv1.`**. Eles geralmente est√£o localizados em `~/.terraform.d/`, mas atacando plataformas CI/CD e nuvens, voc√™ pode encontr√°-los em segredos ou vari√°veis de ambiente.

Voc√™ pode usar esse token para **encontrar a organiza√ß√£o:**

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```

e com essas informa√ß√µes encontrar o espa√ßo de trabalho:

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```

Agora voc√™ precisa criar uma configura√ß√£o para se comunicar com o backend do Terraform Enterprise. Basta obter [este exemplo](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) e **adicionar um `hostname`** com o nome do host da inst√¢ncia do Terraform Enterprise:

{% code title="backend_config.tf" %}
```json
terraform {
  backend "remote" {
    hostname = "{{TFE_HOSTNAME}}"
    organization = "{{ORGANIZATION_NAME}}"

    workspaces {
      name = "{{WORKSPACE_NAME}}"
    }
  }
}
```
{% endcode %}

Inicialize seu terraform para usar o token do Terraform Enterprise

```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Verifique se foi inicializado corretamente
terraform state list
```

Agora que voc√™ tem o **Terraform configurado para entrar em contato com o backend do Enterprise**, basta seguir a se√ß√£o [**RCE no Terraform**](./#rce-in-terraform) em:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivoting

Como mencionado anteriormente, a infraestrutura do Terraform Enterprise pode ser executada em qualquer m√°quina/nuvem usando agentes. Portanto, se voc√™ puder executar c√≥digo nesta m√°quina, poder√° coletar **credenciais em nuvem do endpoint de metadados (**[**IAM, dados do usu√°rio...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
Al√©m disso, verifique o **sistema de arquivos** e as **vari√°veis de ambiente** em busca de outros segredos e chaves de API potenciais.\
Tamb√©m n√£o se esque√ßa de **verificar a rede** onde a m√°quina est√° localizada.

## Prote√ß√µes

{% hint style="info" %}
#### Desativando opera√ß√µes remotas <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Muitos recursos do Terraform Cloud dependem da execu√ß√£o remota e n√£o est√£o dispon√≠veis ao usar opera√ß√µes locais. Isso inclui recursos como a aplica√ß√£o de pol√≠ticas Sentinel, estimativa de custos e notifica√ß√µes.

Voc√™ pode desativar as opera√ß√µes remotas para qualquer espa√ßo de trabalho alterando seu [Modo de execu√ß√£o](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) para **Local**. Isso faz com que o espa√ßo de trabalho atue apenas como um backend remoto para o estado do Terraform, com toda a execu√ß√£o ocorrendo em suas pr√≥prias esta√ß√µes de trabalho ou trabalhadores de integra√ß√£o cont√≠nua.
{% endhint %}

{% hint style="info" %}
**Restringir o acesso aos metadados do Terraform Build Worker**

Por padr√£o, o Terraform Enterprise n√£o impede que as opera√ß√µes do Terraform acessem o servi√ßo de metadados da inst√¢ncia, que pode conter credenciais IAM ou outros dados confidenciais. Consulte a documenta√ß√£o da [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows) ou [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) para obter mais informa√ß√µes sobre este servi√ßo.
{% endhint %}

## Refer√™ncias

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Ob