# S√©curit√© de Terraform Enterprise

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Informations de base

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) est la distribution auto-h√©berg√©e de Hashicorp de [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs). Il offre aux entreprises une **instance priv√©e de l'application Terraform Cloud**, sans limite de ressources et avec des fonctionnalit√©s architecturales suppl√©mentaires de qualit√© entreprise telles que l'audit logging et la connexion unique SAML.

"Par d√©faut, Terraform Enterprise **ne pr√©vient pas les op√©rations Terraform d'acc√©der au service de m√©tadonn√©es de l'instance**, qui peut contenir des informations d'identification IAM ou d'autres donn√©es sensibles" ([source](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
Bien que l'accent de cet article soit mis sur le ciblage du service de m√©tadonn√©es, il convient de noter que l'obtention d'une ex√©cution de code √† l'int√©rieur d'une ex√©cution Terraform peut fournir d'autres voies d'attaque. Par exemple, des variables d'environnement pourraient √™tre divulgu√©es, qui peuvent contenir des informations d'identification sensibles.
{% endhint %}

## Ex√©cution distante de Terraform <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloud ex√©cute Terraform sur des **machines virtuelles jetables dans son infrastructure cloud** par d√©faut. Vous pouvez utiliser les [agents Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs/agents) pour ex√©cuter Terraform sur **votre propre infrastructure isol√©e, priv√©e ou sur site**. L'ex√©cution distante de Terraform est parfois appel√©e "op√©rations √† distance".

Par cons√©quent, avec une cl√© API pour contacter Terraform Enterprise, il est possible d'**ex√©cuter du code arbitraire dans un conteneur dans le cloud**.

Les [**jetons d'API Terraform**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) peuvent √™tre identifi√©s par la sous-cha√Æne **`.atlasv1.`**. Ils se trouvent g√©n√©ralement dans `~/.terraform.d/`, mais en attaquant les plateformes CI/CD et les clouds, vous pourriez les trouver dans des secrets ou des variables d'environnement.

Vous pouvez utiliser ce jeton pour **trouver l'organisation :**

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```

et avec ces informations, trouver l'espace de travail :

```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```

Maintenant, vous devez cr√©er une configuration pour communiquer avec la backend de Terraform Enterprise. Il suffit de prendre [cet exemple](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) et **d'ajouter un `hostname`** avec le nom d'h√¥te de l'instance Terraform Enterprise :

{% code title="backend_config.tf" %}
```json
terraform {
  backend "remote" {
    hostname = "{{TFE_HOSTNAME}}"
    organization = "{{ORGANIZATION_NAME}}"

    workspaces {
      name = "{{WORKSPACE_NAME}}"
    }
  }
}
```
{% endcode %}

Initialisez votre terraform pour utiliser le jeton Terraform Enterprise

```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# V√©rifiez si l'initialisation a √©t√© correctement effectu√©e
terraform state list
```

Maintenant que vous avez **configur√© Terraform pour contacter le backend Enterprise**, vous pouvez simplement suivre la section [**RCE in Terraform**](./#rce-in-terraform) de :

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivoting

Comme cela a √©t√© mentionn√© pr√©c√©demment, l'infrastructure Terrafomr Enterprise peut s'ex√©cuter sur n'importe quelle machine/cloud fournie en utilisant des agents. Par cons√©quent, si vous pouvez ex√©cuter du code sur cette machine, vous pouvez collecter des **informations d'identification cloud √† partir du point de terminaison de m√©tadonn√©es (**[**IAM, donn√©es utilisateur...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
De plus, v√©rifiez le **syst√®me de fichiers** et les **variables d'environnement** pour d'autres secrets et cl√©s API potentiels.\
N'oubliez pas de **v√©rifier le r√©seau** o√π se trouve la machine.

## Protections

{% hint style="info" %}
#### D√©sactiver les op√©rations √† distance <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

De nombreuses fonctionnalit√©s de Terraform Cloud reposent sur l'ex√©cution √† distance et ne sont pas disponibles lors de l'utilisation d'op√©rations locales. Cela inclut des fonctionnalit√©s telles que l'application des politiques Sentinel, l'estimation des co√ªts et les notifications.

Vous pouvez d√©sactiver les op√©rations √† distance pour n'importe quel espace de travail en modifiant son [mode d'ex√©cution](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) en **Local**. Cela fait que l'espace de travail ne fonctionne que comme un backend distant pour l'√©tat Terraform, avec toute l'ex√©cution se produisant sur vos propres postes de travail ou vos travailleurs d'int√©gration continue.
{% endhint %}

{% hint style="info" %}
**Restreindre l'acc√®s aux m√©tadonn√©es des travailleurs de construction Terraform**

Par d√©faut, Terraform Enterprise ne pr√©vient pas les op√©rations Terraform d'acc√©der au service de m√©tadonn√©es de l'instance, qui peut contenir des informations d'identification IAM ou d'autres donn√©es sensibles. Consultez la documentation [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows) ou [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) pour plus d'informations sur ce service.
{% endhint %}

## R√©f√©rences

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PL