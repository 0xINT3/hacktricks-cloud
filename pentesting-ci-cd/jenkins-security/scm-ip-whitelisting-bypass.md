# Bypass de Whitelisting de IP do SCM

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

Esta p√°gina foi copiada de [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Introdu√ß√£o

Muitas organiza√ß√µes combinam sistemas de gerenciamento de controle de origem (SCM) baseados em SaaS (como GitHub ou GitLab) com uma solu√ß√£o de CI interna auto-hospedada (por exemplo, Jenkins, TeamCity), permitindo que esses sistemas de CI recebam eventos de webhook dos fornecedores de controle de origem SaaS, com o simples prop√≥sito de acionar trabalhos de pipeline.

Portanto, as organiza√ß√µes colocam em uma lista branca os intervalos de IP do SCM permitindo que eles alcancem o sistema CI interno com webhooks. No entanto, observe como **qualquer pessoa** pode criar uma conta no GitHub ou Gitlab e faz√™-la **acionar um webhook** que poderia enviar uma solicita√ß√£o para esse sistema CI interno.

Al√©m disso, observe que, embora o intervalo de IP do servi√ßo de webhook do fornecedor SCM tenha sido aberto no firewall da organiza√ß√£o para **permitir que as solicita√ß√µes de webhook acionem pipelines**, isso **n√£o significa** que as solicita√ß√µes de webhook n√£o possam ser **direcionadas para outros endpoints de CI**, al√©m dos que normalmente ouvem eventos de webhook. Podemos tentar acessar esses endpoints para **visualizar dados valiosos como usu√°rios**, **pipelines**, **sa√≠da do console** de trabalhos de pipeline ou, se tivermos sorte o suficiente para cair em uma inst√¢ncia que concede privil√©gios de administrador a usu√°rios n√£o autenticados (sim, isso acontece), podemos acessar as se√ß√µes de **configura√ß√µes e credenciais**.

### Cen√°rio

Imagine um servi√ßo **Jenkins** que s√≥ **permite que** os IPs do **GitHub** e do **GitLab** o alcancem **externamente**.

Nesse cen√°rio, um invasor acionar√° webhooks arbitr√°rios no GitHub e no GitLab para fazer login no Jenkins e extrair informa√ß√µes.

### Limita√ß√µes Comuns de Webhooks

* **Somente solicita√ß√µes POST**: os webhooks geralmente permitem que voc√™ envie apenas solicita√ß√µes POST, no entanto, alguns **endpoints** com informa√ß√µes **interessantes** precisam ser acessados por meio de solicita√ß√µes **GET**.
  * Se o Post for **respondido com um redirecionamento**, ele pode segui-lo.
  * Alguns CIs (Jenkins) permitem ter um **par√¢metro GET indicando para onde redirecionar o cliente** assim que ele conseguir fazer login, voc√™ pode us√°-lo para redirecion√°-lo para uma p√°gina espec√≠fica com um Get.
* **N√£o √© poss√≠vel controlar o corpo da solicita√ß√£o POST**: se voc√™ precisar enviar dados espec√≠ficos no corpo do POST, n√£o poder√°.
* **Tokens CSRF**: se o endpoint interessante estiver esperando tokens CSRF, voc√™ n√£o poder√° extra√≠-los e fornec√™-los.

## Webhooks do GitHub

### Abusando do login do Jenkins

O login requer o envio de uma **solicita√ß√£o POST**. Escolher como alvo o endpoint de login resolve o desafio de manter os tokens CSRF, pois essa solicita√ß√£o espec√≠fica n√£o requer isso. Mas ainda enfrentamos o outro desafio, pois nossas habilidades para **modificar o corpo da solicita√ß√£o permanecem limitadas**.

Uma solicita√ß√£o de login do Jenkins √© assim:

```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```

Precisamos **enviar as credenciais que for√ßamos por for√ßa bruta de alguma forma**.\
Felizmente, o endpoint de login do Jenkins **aceita** uma solicita√ß√£o POST com os **campos enviados como par√¢metros de consulta**:

```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[json do webhook no corpo da solicita√ß√£o]
```

Ent√£o, como podemos faz√™-lo funcionar? Podemos **criar um novo webhook no GitHub**, definindo a **URL da solicita√ß√£o de login do Jenkins como a URL do payload**. Podemos ent√£o criar uma automa√ß√£o usando a API do GitHub para **for√ßar a senha da conta de usu√°rio**, modificando o campo de senha, acionando o webhook e inspecionando a resposta no log de eventos de webhook do reposit√≥rio.

```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```

<figure><img src="../../.gitbook