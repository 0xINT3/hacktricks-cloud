# SCM IPホワイトリストバイパス

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

このページは[https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)からコピーされました。

## はじめに

多くの組織は**SaaSベースのソースコントロール管理(SCM)システム**（GitHubやGitLabなど）と**内部**の自己ホスト型**CI**ソリューション（例：Jenkins、TeamCity）を組み合わせて使用し、これらのCIシステムがSaaSソースコントロールベンダーからの**webhookイベントを受信**し、パイプラインジョブをトリガーするための単純な目的で使用しています。

そのため、組織は**SCM**の**IP**範囲を**ホワイトリスト**に登録し、それらが**webhook**を介して**内部**CIシステムにアクセスできるようにしています。しかし、**誰でも**GithubやGitlabに**アカウント**を作成し、それを使って**webhookをトリガー**し、その**内部CIシステム**にリクエストを送信することができることに注意してください。

さらに、SCMベンダーのwebhookサービスのIP範囲が組織のファイアウォールで開かれているのは、**webhookリクエストがパイプラインをトリガーすることを許可するため**ですが、これはwebhookリクエストが**他のCIエンドポイントに向けられないという意味ではありません**。webhookイベントを定期的にリッスンするもの以外のエンドポイントにアクセスしようとすることができます。これらのエンドポイントから**ユーザー**、**パイプライン**、パイプラインジョブの**コンソール出力**などの貴重なデータを**閲覧**することができますし、認証されていないユーザーに管理者権限を付与するインスタンスに偶然当たると（はい、それが起こることがあります）、**設定**や**認証情報のセクション**にアクセスすることができます。

### シナリオ

**Jenkins**サービスが**外部**からのアクセスを**GitHub**と**GitLab**のIPのみに**許可**していると想像してください。

このシナリオでは、攻撃者はGitHubとGitLabで任意のwebhookをトリガーしてJenkinsにログインし、情報を抽出します。

### 一般的なWebhooksの制限

* **POSTリクエストのみ**: Webhooksは通常、POSTリクエストの送信のみを許可しますが、**興味深い**情報にアクセスするためには**GETリクエスト**を介してアクセスする必要がある**エンドポイント**もあります。
* POSTが**リダイレクトで応答された場合**、それに従う可能性があります。
* 一部のCI（Jenkins）では、クライアントがログインに成功したらどこにリダイレクトするかを示す**GETパラメータ**を持つことができ、これを使用してクライアントを特定のページにGetでリダイレクトすることができます。
* **POSTリクエストのボディを制御できない**: POSTボディに特定のデータを送信したい場合、できません。
* **CSRFトークン**: 興味深いエンドポイントがCSRFトークンを期待している場合、それらを抽出して提供することはできません。

## GitHub Webhooks

### Jenkinsログインの悪用

ログインには**POSTリクエスト**の送信が必要です。ログインエンドポイントをターゲットにすることで、CSRFトークンを保持するという課題を解決します。なぜなら、この特定のリクエストにはそれが必要ないからです。しかし、リクエストのボディを**変更する能力は限られている**という他の課題に直面しています。

Jenkinsのログインリクエストは以下のようになります：
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
**何らかの方法でブルートフォースした資格情報を送信する必要があります**。\
幸いなことに、Jenkinsのログインエンドポイントは、**クエリパラメータとして送信されたフィールド**を含むPOSTリクエストを**受け入れます**：
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
GitHubで**新しいwebhookを作成**し、**JenkinsログインリクエストURLをペイロードURLとして設定**します。次に、GitHub APIを使用して自動化を作成し、パスワードフィールドを変更してwebhookをトリガーし、リポジトリwebhookイベントログで応答を検査することで、**ユーザーアカウントのパスワードをブルートフォース**します。
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
```markdown
<figure><img src="../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

ウェブフックを発火させ、結果を見ます。すべてのSCMベンダーは、ウェブフックを通じて送信されたHTTPリクエストとレスポンスをUIで表示します。
ログイン試行が失敗すると、ログインエラーページにリダイレクトされます。

<figure><img src="../../.gitbook/assets/image (6) (1) (2).png" alt=""><figcaption></figcaption></figure>

しかし、**ログインが成功する**と、メインのJenkinsページにリダイレクトされ、**セッションクッキーが設定されます**。

<figure><img src="../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

したがって、**Jenkinsの資格情報をブルートフォースしてセッションクッキーを取得できます！**
ただし、少し制限があります - **一度にステートレスリクエストを1つだけ送信でき**、**クッキーをリクエストに添付することはできません**。なぜなら、ヘッダーを制御できないからです。

別のオプションは、**Jenkinsアクセストークン**を取得しようとすることです。これはURLに添付でき、CSRFトークンを追加することなくJenkinsにPOSTリクエストを送信するために使用できます。このオプションは、攻撃者が何らかの方法でSCMのIP範囲からのみアクセス可能な自己ホスト型CIを見つけ、そのCIに有効なアクセストークンを取得する必要があるため、少し複雑です。したがって、当面はより実用的なシナリオに焦点を当てます。

## GitLabウェブフック

### Jenkinsログインの悪用

同じリクエストを送ってみましょうが、今回はGitLabを通じて行います。同じ制限があるため、**クエリパラメータとして資格情報を追加した同じPOSTリクエストを送信します**。

<figure><img src="../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

リクエストをトリガーしますが、GitHubとは異なり、レスポンスは200です。前の例と同様に、**GitLabのウェブフックサービスを使用してユーザーをブルートフォースし、セッションクッキーを取得しました**が、今回はJenkinsからのレスポンスの内容がGitLab UIにリレーされ、**Jenkinsメインページの完全な内容を提供しました。**
これは、**GitLabがリダイレクトに従い**、リクエストに**Cookie**を追加したためです：

<figure><img src="../../.gitbook/assets/image (4) (1) (2).png" alt=""><figcaption></figcaption></figure>

これは、私たちができることを意味します：

1. ユーザーをブルートフォースして有効な資格情報を発見する、
2. 有効な資格情報をログインページに対して使用し、成功裏にログインする、
3. 内部Jenkinsメインページの内容を取得する。

### Jenkins内部データの取得

Jenkinsの**ログインはリダイレクションパラメータ** - "_from_"を受け入れます。元々は、**ログイン後にユーザーが到達しようとしたページにリダイレクトするために使用されます**が、私たちの場合は、選択した内部Jenkinsページにセッションクッキーを添付したGETリクエストを送信するために悪用できる機能です。どのようにするか見てみましょう：

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

1. 次のURLを持つウェブフックを設定します：
```
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
POSTリクエストがJenkinsに送信され、認証に成功します。

* 302リダイレクトレスポンス、セッションクッキー、およびジョブコンソール出力ページへのリダイレクションを取得します。
* GitLab webhookサービスは自動的にリダイレクションを追跡し、リクエストに追加されたセッションクッキーと共にジョブコンソール出力ページにGETリクエストを送信します。
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* Job console output は攻撃者の GitLab webhook イベントログに送り返され、表示されます。

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

ここで重要なのは、Jenkins は**認証なしで内部コンポーネントへのアクセスを許可するように設定することも、認証されたユーザーのみが内部コンポーネントにアクセスできるように設定することもできる**という点です。これは私たちにどのような影響を与えるのでしょうか？

* **認証が設定されていない**場合、**GitLab webhook サービスを使って CI の任意の内部ページにアクセスし**、そのレスポンスをキャプチャして私たちに表示することができます。
* 認証が設定されている場合、ユーザーをブルートフォースしてから、その資格情報を使用して任意の内部ページにアクセスすることができます（上記の箇条書きのように）。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で AWS ハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong></strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) コレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegram グループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを**共有する**。

</details>
