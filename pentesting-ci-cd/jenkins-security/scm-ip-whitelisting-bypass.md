# Contournement de la liste blanche des adresses IP SCM

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Cette page a √©t√© copi√©e depuis [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Introduction

De nombreuses organisations combinent des **syst√®mes de gestion de contr√¥le de source (SCM) bas√©s sur SaaS** (comme GitHub ou GitLab) avec une solution **CI** interne auto-h√©berg√©e (par exemple, Jenkins, TeamCity) permettant √† ces syst√®mes CI de **recevoir des √©v√©nements de webhook** des fournisseurs de contr√¥le de source SaaS, dans le simple but de d√©clencher des travaux de pipeline.

Par cons√©quent, les organisations **autorisent** les plages d'adresses **IP** du **SCM** √† atteindre le syst√®me CI **interne** avec des webhooks. Cependant, notez comment **n'importe qui** peut cr√©er un **compte** sur GitHub ou GitLab et le configurer pour **d√©clencher un webhook** qui pourrait envoyer une requ√™te √† ce syst√®me CI **interne**.

De plus, notez que si la plage d'adresses IP du service de webhook du fournisseur SCM a √©t√© ouverte dans le pare-feu de l'organisation pour **autoriser les requ√™tes de webhook √† d√©clencher des pipelines**, cela ne signifie pas que les requ√™tes de webhook ne peuvent pas √™tre **dirig√©es vers d'autres points d'extr√©mit√© CI**, en dehors de ceux qui √©coutent r√©guli√®rement les √©v√©nements de webhook. Nous pouvons essayer d'acc√©der √† ces points d'extr√©mit√© pour **afficher des donn√©es pr√©cieuses telles que les utilisateurs**, les **pipelines**, la **sortie de la console** des travaux de pipeline, ou si nous avons la chance de tomber sur une instance qui accorde des privil√®ges d'administrateur aux utilisateurs non authentifi√©s (oui, cela arrive), nous pouvons acc√©der aux **configurations et aux sections des informations d'identification**.

### Sc√©nario

Imaginez un service **Jenkins** qui n'autorise que les adresses IP de **GitHub** et **GitLab** √† le joindre **de l'ext√©rieur**.

Dans ce sc√©nario, un attaquant d√©clenchera des webhooks arbitraires dans GitHub et GitLab pour se connecter √† Jenkins et extraire des informations.

### Limitations courantes des webhooks

* **Uniquement des requ√™tes POST** : Les webhooks permettent g√©n√©ralement d'envoyer uniquement des requ√™tes POST, cependant, certains **points d'extr√©mit√©** avec des informations **int√©ressantes** doivent √™tre accessibles via des requ√™tes GET.
* Si la r√©ponse √† la requ√™te POST est **redirig√©e**, elle peut √™tre suivie.
* Certaines CI (Jenkins) permettent d'avoir un **param√®tre GET indiquant o√π rediriger le client** une fois qu'il a r√©ussi √† se connecter, vous pouvez l'utiliser pour le rediriger vers une page sp√©cifique avec un GET.
* **Impossible de contr√¥ler le corps de la requ√™te POST** : Si vous devez envoyer des donn√©es sp√©cifiques dans le corps de la requ√™te POST, vous ne pouvez pas le faire.
* **Jetons CSRF** : Si le point d'extr√©mit√© int√©ressant attend des jetons CSRF, vous ne pourrez pas les extraire et les fournir.

## Webhooks GitHub

### Abus de la connexion Jenkins

La connexion n√©cessite l'envoi d'une **requ√™te POST**. En choisissant de cibler le point d'extr√©mit√© de connexion, nous r√©solvons le probl√®me de la d√©tention des jetons CSRF, car cette requ√™te sp√©cifique ne le n√©cessite pas. Mais nous sommes toujours confront√©s √† l'autre d√©fi, car nos capacit√©s √† **modifier le corps de la requ√™te restent limit√©es**.

Une requ√™te de connexion Jenkins ressemble √† ceci :
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
Nous devons **envoyer les informations d'identification que nous avons forc√©es d'une mani√®re ou d'une autre**.\
Heureusement, le point de terminaison de connexion de Jenkins **accepte** une requ√™te POST avec les **champs envoy√©s en tant que param√®tres de requ√™te** :
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
Alors, comment pouvons-nous le faire fonctionner ? Nous pouvons **cr√©er un nouveau webhook dans GitHub**, en d√©finissant l'URL de demande de connexion de Jenkins comme URL de payload. Ensuite, nous pouvons cr√©er une automatisation en utilisant l'API GitHub pour **forcer le mot de passe du compte utilisateur** en modifiant le champ du mot de passe, en d√©clenchant le webhook et en inspectant la r√©ponse dans le journal des √©v√©nements du webhook du r√©f√©rentiel.
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
<figure><img src="../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

Nous d√©clenchons le webhook et observons les r√©sultats. Tous les fournisseurs SCM affichent la requ√™te HTTP et la r√©ponse envoy√©es via le webhook dans leur interface utilisateur.\
Si la tentative de connexion √©choue, nous sommes redirig√©s vers la page d'erreur de connexion.

<figure><img src="../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Mais si la **connexion r√©ussit**, nous sommes redirig√©s vers la page principale de Jenkins et un **cookie de session est d√©fini**.

<figure><img src="../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

Ainsi, nous pouvons **forcer les identifiants Jenkins par force brute et obtenir un cookie de session**.\
Cependant, nous sommes un peu limit√©s - nous ne pouvons envoyer qu'une seule requ√™te sans √©tat √† chaque fois et le **cookie ne peut pas √™tre attach√©** √† notre requ√™te, car nous ne pouvons pas contr√¥ler les en-t√™tes.

Une autre option serait d'essayer d'obtenir un **jeton d'acc√®s Jenkins**, qui peut √™tre attach√© √† l'URL et utilis√© pour envoyer des requ√™tes POST √† Jenkins sans avoir besoin d'ajouter un jeton CSRF. Cette option est un peu plus complexe car elle n√©cessite qu'un attaquant trouve √† la fois un CI auto-h√©berg√© accessible uniquement √† partir des plages d'adresses IP SCM et obtienne √©galement un jeton d'acc√®s valide √† ce CI. Donc pour le moment, nous nous concentrerons sur des sc√©narios plus pratiques.

## Webhooks GitLab

### Abus de la connexion Jenkins

Essayons d'envoyer la m√™me requ√™te, mais cette fois via GitLab. En raison des m√™mes limitations, nous envoyons la **m√™me requ√™te POST exacte, en ajoutant les identifiants en tant que param√®tres de requ√™te**.

<figure><img src="../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

Nous d√©clenchons la requ√™te, mais contrairement √† GitHub, la r√©ponse est 200. Comme dans le dernier exemple, nous avons utilis√© le service de webhook de GitLab pour forcer les identifiants d'un utilisateur et obtenir un cookie de session, mais cette fois-ci, le contenu de la r√©ponse de Jenkins a √©t√© renvoy√© vers l'interface utilisateur de GitLab, nous fournissant essentiellement le **contenu complet de la page principale de Jenkins**.\
Cela est d√ª au fait que **GitLab a suivi la redirection** en ajoutant le **cookie** √† la requ√™te :

<figure><img src="../../.gitbook/assets/image (4) (1) (2).png" alt=""><figcaption></figcaption></figure>

Cela signifie que nous pouvons :

1. forcer les utilisateurs par force brute et d√©couvrir des identifiants valides,
2. utiliser les identifiants valides sur la page de connexion pour vous connecter avec succ√®s,
3. obtenir le contenu de la page principale interne de Jenkins.

### Obtenir des donn√©es internes de Jenkins

La **connexion Jenkins accepte un param√®tre de redirection** - "_from_". √Ä l'origine utilis√© pour **rediriger les utilisateurs vers la page √† laquelle ils souhaitaient acc√©der apr√®s leur connexion**, mais dans notre cas, une fonctionnalit√© que nous pouvons exploiter pour envoyer une requ√™te GET attach√©e avec un cookie de session vers une page interne de Jenkins de notre choix. Voyons comment :

<figure><img src="../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

1. D√©finissez un webhook avec l'URL suivante :
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
Une requ√™te POST est envoy√©e √† Jenkins et l'authentification r√©ussit.

* Nous recevons une r√©ponse de redirection 302, avec un cookie de session et une redirection vers la page de sortie de la console du travail.
* Le service de webhook GitLab suit automatiquement la redirection avec une requ√™te GET envoy√©e √† la page de sortie de la console du travail, avec le cookie de session ajout√© √† la requ√™te :
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* La sortie de la console du travail est renvoy√©e et pr√©sent√©e dans le journal des √©v√©nements du webhook GitLab de l'attaquant.

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

Il est important de mentionner ici que Jenkins peut √™tre configur√© soit pour permettre l'acc√®s aux composants internes sans authentification, soit de mani√®re √† ce que seuls les utilisateurs authentifi√©s puissent acc√©der aux composants internes. Comment cela nous affecte-t-il ?

* S'il n'y a pas d'authentification configur√©e, nous pouvons faire en sorte que le service de webhook GitLab acc√®de √† n'importe quelle page interne de l'IC, capturer la r√©ponse et nous la pr√©senter.
* Si l'authentification est configur√©e, nous pouvons essayer de forcer l'acc√®s √† un utilisateur, puis utiliser les identifiants pour acc√©der √† n'importe quelle page interne (comme dans le point pr√©c√©dent).

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre entreprise annonc√©e dans HackTricks ou si vous souhaitez acc√©der √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF, consultez les [PLANS D'ABONNEMENT](https://github.com/sponsors/carlospolop) !
* Obtenez le [swag officiel PEASS & HackTricks](https://peass.creator-spring.com)
* D√©couvrez [La famille PEASS](https://opensea.io/collection/the-peass-family), notre collection exclusive de [NFT](https://opensea.io/collection/the-peass-family)
* Rejoignez le üí¨ [groupe Discord](https://discord.gg/hRep4RUj7f) ou le [groupe Telegram](https://t.me/peass) ou suivez-moi sur Twitter üê¶ [@carlospolopm](https://twitter.com/carlospolopm).
* Partagez vos astuces de piratage en soumettant des PR aux r√©f√©rentiels GitHub [HackTricks](https://github.com/carlospolop/hacktricks) et [HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud).

</details>
