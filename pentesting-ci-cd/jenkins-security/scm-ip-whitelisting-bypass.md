# SCM IP白名单绕过

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

此页面的内容来自[https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## 简介

许多组织将**基于SaaS的源代码管理（SCM）系统**（如GitHub或GitLab）与**内部**的自托管**CI**解决方案（如Jenkins、TeamCity）结合使用，以便这些CI系统可以接收来自SaaS源代码管理供应商的Webhook事件，仅用于触发流水线作业。

因此，组织会将**SCM的IP范围**列入白名单，以允许它们通过Webhook访问**内部**CI系统。然而，请注意，**任何人**都可以在GitHub或GitLab上创建一个帐户，并使其触发一个Webhook，该Webhook可以向**内部CI系统**发送请求。

此外，请注意，尽管SCM供应商Webhook服务的IP范围已在组织的防火墙中打开，以**允许Webhook请求触发流水线**，但这并不意味着Webhook请求不能被**定向到其他CI端点**，而不仅仅是定期监听Webhook事件的端点。我们可以尝试访问这些端点，以查看有价值的数据，如用户、流水线、流水线作业的控制台输出，或者如果我们足够幸运地遇到一个允许未经身份验证的用户拥有管理员权限的实例（是的，这种情况确实存在），我们可以访问配置和凭据部分。

### 场景

想象一个**Jenkins**服务，它只允许**GitHub**和**GitLab**的IP地址从外部访问。

在这种情况下，攻击者将在GitHub和GitLab中触发任意Webhook，以登录Jenkins并提取信息。

### 常见Webhook限制

* **仅支持POST请求**：Webhook通常只允许您发送POST请求，但是，一些需要通过GET请求访问的**包含有趣信息的端点**可能无法访问。
* 如果POST请求**被重定向**，它可能会跟随重定向。
* 一些CI（如Jenkins）允许使用GET参数指示客户端成功登录后重定向到何处，您可以使用此功能将其重定向到具体页面并使用GET请求。
* **无法控制POST请求的正文**：如果您需要在POST请求的正文中发送特定数据，则无法实现。
* **CSRF令牌**：如果有趣的端点需要CSRF令牌，您将无法提取并提供它们。

## GitHub Webhooks

### 滥用Jenkins登录

登录需要发送**POST请求**。选择目标登录端点解决了持有CSRF令牌的挑战，因为此特定请求不需要CSRF令牌。但我们仍然面临另一个挑战，即我们对**请求正文的修改能力仍然有限**。

Jenkins登录请求如下所示：
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
我们需要以某种方式发送我们暴力破解的凭据。\
幸运的是，Jenkins登录端点接受一个带有作为查询参数发送的字段的POST请求：
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
所以我们如何让它工作起来呢？我们可以在GitHub中**创建一个新的Webhook**，将**Jenkins登录请求URL设置为负载URL**。然后，我们可以使用GitHub API创建一个自动化程序，通过修改密码字段、触发Webhook并检查存储库Webhook事件日志中的响应来**暴力破解用户帐户的密码**。
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
<figure><img src="../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

我们触发了webhook，并查看结果。所有的SCM供应商都会在其用户界面中显示通过webhook发送的HTTP请求和响应。\
如果登录尝试失败，我们将被重定向到登录错误页面。

<figure><img src="../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

但是，如果**登录成功**，我们将被重定向到主要的Jenkins页面，并设置一个**会话cookie**。

<figure><img src="../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

因此，我们可以**暴力破解Jenkins凭据并获取会话cookie**。\
然而，我们有一些限制 - 我们每次只能**发送一个无状态请求**，并且**无法附加cookie**到我们的请求中，因为我们无法控制头部。

另一个选项是尝试获取**Jenkins访问令牌**，该令牌可以附加在URL中，并用于向Jenkins发送POST请求，而无需添加CSRF令牌。这个选项稍微复杂一些，因为它要求攻击者找到一个只能从SCM IP范围访问的自托管CI，并获得有效的访问令牌。因此，我们将暂时专注于更实际的场景。

## GitLab Webhooks

### 滥用Jenkins登录

让我们尝试发送相同的请求，但这次通过GitLab发送。由于相同的限制，我们发送**完全相同的POST请求，将凭据添加为查询参数**。

<figure><img src="../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

我们触发了请求，但与GitHub不同 - 响应是200。与上一个示例一样，我们使用**GitLab的webhook服务来暴力破解用户并获取会话cookie**，但这次 - Jenkins的响应内容被传递回GitLab用户界面，从而为我们提供了**Jenkins主页面的完整内容**。\
这是因为**GitLab遵循了重定向**，并将**Cookie**添加到请求中：

<figure><img src="../../.gitbook/assets/image (4) (1) (2).png" alt=""><figcaption></figcaption></figure>

这意味着我们可以：

1. 暴力破解用户并发现有效凭据，
2. 使用有效凭据登录页面成功登录，
3. 获取内部Jenkins主页面的内容。

### 获取Jenkins内部数据

Jenkins的**登录接受一个重定向参数** - "_from_"。最初用于**在用户登录后将用户重定向到他们想要访问的页面**，但在我们的情况下 - 这是一个我们可以滥用的功能，用于发送附带会话cookie的GET请求到我们选择的内部Jenkins页面。让我们看看如何操作：

<figure><img src="../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

1. 设置一个webhook，URL如下：
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
向Jenkins发送了一个POST请求，并且认证成功。

* 我们收到一个302重定向响应，其中包含一个会话cookie，并且重定向到作业控制台输出页面。
* GitLab webhook服务自动跟随重定向，向作业控制台输出页面发送了一个GET请求，同时携带了会话cookie，该cookie被添加到请求中：
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* 作业控制台输出被发送回并显示在攻击者的GitLab webhook事件日志中。

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

这里需要提到的是，Jenkins可以配置为**允许无需身份验证访问内部组件**，或者以一种只允许经过身份验证的用户访问内部组件的方式进行配置。这对我们有什么影响呢？

* 如果没有配置身份验证，我们可以使**GitLab webhook服务访问CI中的任何内部页面**，捕获响应并呈现给我们。
* 如果配置了身份验证，我们可以尝试暴力破解用户，然后使用凭据访问任何内部页面（就像上面的项目符号中所述）。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
