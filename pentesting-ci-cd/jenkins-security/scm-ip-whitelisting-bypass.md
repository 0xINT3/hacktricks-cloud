# SCM IPホワイトリストバイパス

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**でフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

このページは、[https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)からコピーされました。

## はじめに

多くの組織は、**GitHub**や**GitLab**などの**SaaSベースのソースコントロール管理（SCM）システム**と、**Jenkins**や**TeamCity**などの**内部の自己ホスト型CIソリューション**を組み合わせて使用しており、これによりCIシステムはSaaSソースコントロールベンダーからのウェブフックイベントを受け取ることができます。これは、パイプラインジョブをトリガーするための単純な目的です。

したがって、組織は**SCMのIP範囲をホワイトリスト**に登録し、ウェブフックを介して**内部のCIシステムに到達**できるようにします。しかし、**誰でも**GitHubやGitLabでアカウントを作成し、**ウェブフックをトリガー**して**内部のCIシステム**にリクエストを送信することができます。

さらに、SCMベンダーのウェブフックサービスのIP範囲が組織のファイアウォールで開かれているため、ウェブフックリクエストがパイプラインをトリガーすることができるようになっているとしても、ウェブフックリクエストが**通常のウェブフックイベントをリッスンしている以外のCIエンドポイントに向けられない**とは限りません。これらのエンドポイントにアクセスして、ユーザー、パイプライン、パイプラインジョブのコンソール出力などの**貴重なデータを表示**することができます。また、認証されていないユーザーに管理者特権を付与するインスタンスに偶然当たることができれば（はい、これは起こります）、**設定と認証情報のセクションにアクセス**することができます。

### シナリオ

外部から**GitHub**と**GitLab**のIPのみがアクセスできるようになっている**Jenkins**サービスを想像してください。

このシナリオでは、攻撃者はGitHubとGitLabで任意のウェブフックをトリガーしてJenkinsにログインし、情報を抽出します。

### 一般的なウェブフックの制限事項

* **POSTリクエストのみ**：ウェブフックは通常、POSTリクエストの送信のみを許可しますが、**GETリクエスト**でアクセスする必要がある**興味深い**情報を持つ**エンドポイント**もあります。
* POSTが**リダイレクトで応答**される場合、それに従うことがあります。
* 一部のCI（Jenkins）では、クライアントがログインに成功した後にリダイレクトする場所を示す**GETパラメータ**を持つことができます。これを使用して、Getを使用して特定のページにリダイレクトすることができます。
* **POSTリクエストのボディを制御できない**：POSTリクエストのボディに特定のデータを送信する場合、それはできません。
* **CSRFトークン**：興味深いエンドポイントがCSRFトークンを必要としている場合、それを抽出して提供することはできません。

## GitHubウェブフック

### Jenkinsのログインの乱用

ログインには**POSTリクエスト**を送信する必要があります。ログインエンドポイントをターゲットにすることで、CSRFトークンを保持するという課題は解決されます。なぜなら、この特定のリクエストではそれが必要とされていないからです。ただし、他の課題に直面することになります。なぜなら、リクエストのボディを**制限されたまま変更する能力**を持っているからです。

Jenkinsのログインリクエストは次のようになります：
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
私たちは何らかの方法でブルートフォースした資格情報を送信する必要があります。\
幸いなことに、Jenkinsのログインエンドポイントは、クエリパラメータとして送信されるフィールドを含むPOSTリクエストを受け付けます。
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
それでは、どのようにしてそれを動作させることができるのでしょうか？GitHubで**新しいウェブフックを作成**し、**JenkinsのログインリクエストURLをペイロードURL**として設定します。次に、GitHub APIを使用して自動化を作成し、パスワードフィールドを変更してウェブフックをトリガーし、リポジトリのウェブフックイベントログでレスポンスを検査することで、ユーザーアカウントのパスワードを**ブルートフォース**することができます。
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
<figure><img src="../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

ウェブフックを発火させ、結果を確認します。すべてのSCMベンダーは、ウェブフックを介して送信されたHTTPリクエストとレスポンスをUIに表示します。\
ログイン試行が失敗した場合、ログインエラーページにリダイレクトされます。

<figure><img src="../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

しかし、**ログインが成功した場合**、メインのJenkinsページにリダイレクトされ、**セッションクッキーが設定されます**。

<figure><img src="../../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

したがって、Jenkinsの資格情報を**ブルートフォースしてセッションクッキーを取得することができます**。\
ただし、制限があります - **1回のステートレスリクエストしか送信できず**、ヘッダーを制御できないため、**クッキーをリクエストに添付することはできません**。

別のオプションは、**Jenkinsアクセストークン**を取得しようとすることです。これはURLに添付でき、CSRFトークンを追加する必要なくJenkinsにPOSTリクエストを送信するために使用できます。このオプションは少し複雑で、攻撃者はSCM IP範囲からのみアクセス可能なセルフホストCIと有効なアクセストークンの両方を見つける必要があります。したがって、当面はより実用的なシナリオに焦点を当てます。

## GitLabウェブフック

### Jenkinsログインの乱用

同じ制限のため、GitLabを介して同じリクエストを送信してみましょう。クレデンシャルをクエリパラメータとして追加した**同じPOSTリクエストを送信**します。

<figure><img src="../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

リクエストをトリガーしますが、GitHubとは異なり、レスポンスは200です。前の例と同様に、**GitLabのウェブフックサービスを使用してユーザーをブルートフォースし、セッションクッキーを取得**しますが、今回はJenkinsからのレスポンスの内容がGitLabのUIに中継され、実質的に**Jenkinsメインページの全内容が提供されます**。\
これは、GitLabがリダイレクトに従い、リクエストに**クッキー**を追加したためです：

<figure><img src="../../.gitbook/assets/image (4) (1) (2).png" alt=""><figcaption></figcaption></figure>

これは次のことを意味します：

1. ユーザーをブルートフォースして有効な資格情報を特定します。
2. 有効な資格情報をログインページで使用して正常にログインします。
3. 内部のJenkinsメインページの内容を取得します。

### Jenkinsの内部データの取得

Jenkinsの**ログインはリダイレクションパラメータ**「_from_」を受け入れます。元々はユーザーをログイン後に到達しようとしたページにリダイレクトするために使用されましたが、私たちの場合は、セッションクッキーが添付されたGETリクエストを内部のJenkinsページに送信するために乱用できる機能です。次のようにしてみましょう：

<figure><img src="../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

1. 次のURLでウェブフックを設定します：
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
JenkinsにPOSTリクエストが送信され、認証が成功します。

* 302リダイレクトレスポンスが返され、セッションクッキーとジョブコンソール出力ページへのリダイレクトが含まれています。
* GitLabのWebhookサービスは自動的にリダイレクトに従い、セッションクッキーを含むGETリクエストをジョブコンソール出力ページに送信します。
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* ジョブのコンソール出力は、攻撃者のGitLabウェブフックイベントログに送信されて表示されます。

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

ここで重要なのは、Jenkinsは**認証なしで内部コンポーネントへのアクセスを許可するように設定することもできます**が、認証されたユーザーのみが内部コンポーネントにアクセスできるように強制する方法もあります。これが私たちにどのような影響を与えるのでしょうか？

* 認証が**設定されていない**場合、私たちは**GitLabウェブフックサービスがCI内の任意の内部ページにアクセスし、レスポンスをキャプチャして表示する**ことができます。
* 認証が設定されている場合、ユーザーをブルートフォース攻撃して、その資格情報を使用して内部ページにアクセスすることができます（上記の項目と同様）。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
