# SCM IPホワイトリストバイパス

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

このページは[https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)からコピーされました。

## はじめに

多くの組織は**SaaSベースのソースコントロール管理(SCM)システム**（GitHubやGitLabなど）と**内部**の自己ホスト型**CI**ソリューション（例：Jenkins、TeamCity）を組み合わせて使用し、これらのCIシステムがSaaSソースコントロールベンダーからの**ウェブフックイベントを受信**し、パイプラインジョブをトリガーするための単純な目的で使用しています。

そのため、組織は**ウェブフック**を介して**内部**CIシステムに到達できるように**SCM**の**IP**範囲を**ホワイトリスト**に登録します。しかし、**誰でも**GithubやGitlabに**アカウントを作成**し、その**内部CIシステム**にリクエストを送信する**ウェブフックをトリガー**することができることに注意してください。

さらに、組織のファイアウォールでSCMベンダーのウェブフックサービスのIP範囲が開放されていると、**ウェブフックリクエストがパイプラインをトリガーすることを許可**することになりますが、これはウェブフックリクエストが**他のCIエンドポイントに向けられない**という意味では**ありません**。通常ウェブフックイベントをリッスンするエンドポイント以外のものにアクセスしようとすることができます。**ユーザー**、**パイプライン**、パイプラインジョブの**コンソール出力**などの貴重なデータを**閲覧**するためにこれらのエンドポイントにアクセスすることができますし、認証されていないユーザーに管理権限を付与するインスタンスに偶然当たると（はい、それが起こることがあります）、**設定と資格情報のセクション**にアクセスすることができます。

### シナリオ

**Jenkins**サービスが**外部**からのアクセスを**GitHub**と**GitLab**のIPのみに**許可**していると想像してください。

このシナリオでは、攻撃者はGitHubとGitLabで任意のウェブフックをトリガーしてJenkinsにログインし、情報を抽出します。

### 一般的なウェブフックの制限

* **POSTリクエストのみ**: ウェブフックは通常、POSTリクエストの送信のみを許可しますが、**興味深い**情報にアクセスするためには**GETリクエスト**を介してアクセスする必要がある**エンドポイント**もあります。
* POSTが**リダイレクトで応答された場合**、それに従う可能性があります。
* 一部のCI（Jenkins）では、クライアントがログインに成功したらどこにリダイレクトするかを示す**GETパラメータ**を持つことができ、これを使用してクライアントをGetで特定のページにリダイレクトすることができます。
* **POSTリクエストのボディを制御できない**: POSTボディに特定のデータを送信したい場合、できません。
* **CSRFトークン**: 興味深いエンドポイントがCSRFトークンを期待している場合、それらを抽出して提供することはできません。

## GitHubウェブフック

### Jenkinsログインの悪用

ログインには**POSTリクエスト**の送信が必要です。ログインエンドポイントをターゲットにすることで、CSRFトークンを保持するという課題を解決しますが、リクエストのボディを**変更する能力は限られたまま**です。

Jenkinsのログインリクエストは次のようになります：
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
**何らかの方法でブルートフォースした資格情報を送信する必要があります**。\
幸いなことに、Jenkinsのログインエンドポイントは、**クエリパラメータとして送信されたフィールド**を含むPOSTリクエストを**受け入れます**：
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
では、どのようにして機能させることができるのでしょうか？ **GitHubに新しいwebhookを作成し**、**ペイロードURLとしてJenkinsのログインリクエストURLを設定**します。次に、GitHub APIを使用して自動化を作成し、パスワードフィールドを変更してwebhookをトリガーし、リポジトリのwebhookイベントログでレスポンスを検査することで、**ユーザーアカウントのパスワードをブルートフォース**します。
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
```markdown
ウェブフックを発火させ、結果を見ます。すべてのSCMベンダーは、ウェブフックを通じて送信されたHTTPリクエストとレスポンスをUIで表示します。
ログイン試行が失敗すると、ログインエラーページにリダイレクトされます。

しかし、**ログインが成功する**と、メインのJenkinsページにリダイレクトされ、**セッションクッキーが設定されます**。

したがって、**Jenkinsの資格情報をブルートフォースし、セッションクッキーを取得できます！**
ただし、少し制限があります - **一度にステートレスリクエストを一つだけ送信できる**だけで、**クッキーをリクエストに添付することはできません**。なぜなら、ヘッダーを制御できないからです。

別の選択肢としては、**Jenkinsアクセストークン**を取得しようとすることです。これはURLに添付でき、CSRFトークンを追加する必要なくJenkinsにPOSTリクエストを送信するために使用できます。この選択肢は、攻撃者がなんとかしてSCMのIP範囲からのみアクセス可能な自己ホスト型CIを見つけ、そのCIに対する有効なアクセストークンを取得する必要があるため、少し複雑です。したがって、当面は – より実践的なシナリオに焦点を当てます。

## GitLabウェブフック

### Jenkinsログインの悪用

同じリクエストを送ってみましょうが、今回はGitLabを通じて行います。同じ制限があるため、**クエリパラメータとして資格情報を追加した同じPOSTリクエスト**を正確に送信します。

リクエストをトリガーしますが、GitHubとは異なり、レスポンスは200です。前の例と同様に、**GitLabのウェブフックサービスを使用してユーザーをブルートフォースし、セッションクッキーを取得しました**が、今回は – Jenkinsからのレスポンスの内容がGitLab UIにリレーされ、実質的に**Jenkinsメインページの全内容を提供しています。**
これは、**GitLabがリダイレクトに従い**、**Cookie**をリクエストに追加したためです：

これは、私たちが以下を行えることを意味します：

1. ユーザーをブルートフォースし、有効な資格情報を発見する、
2. ログインページに対して有効な資格情報を使用し、成功裏にログインする、
3. 内部Jenkinsメインページの内容を取得する。

### Jenkins内部データの取得

Jenkins **ログインはリダイレクションパラメータ** – “_from_”を受け入れます。元々は、**ログイン後に目指していたページにユーザーをリダイレクトするために使用されていました**が、私たちの場合 – 選択した内部Jenkinsページにセッションクッキーを添付したGETリクエストを送信するために悪用できる機能です。どのように行うか見てみましょう：

1. 次のURLを持つウェブフックを設定します：
```
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
POSTリクエストがJenkinsに送信され、認証に成功します。

* 302リダイレクトレスポンス、セッションクッキー、およびジョブコンソール出力ページへのリダイレクションを取得します。
* GitLab webhookサービスは自動的にリダイレクションを追跡し、セッションクッキーがリクエストに追加された状態でジョブコンソール出力ページにGETリクエストを送信します。
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* ジョブコンソールの出力が攻撃者のGitLab webhookイベントログに送信され、表示されます。

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

ここで重要なのは、Jenkinsは**認証なしで内部コンポーネントへのアクセスを許可するように設定することも、認証されたユーザーのみが内部コンポーネントにアクセスできるように設定することもできる**という点です。これが私たちにどのような影響を与えるのでしょうか？

* **認証が設定されていない**場合、**GitLab webhookサービスを使ってCIの任意の内部ページにアクセスし**、そのレスポンスをキャプチャして私たちに表示することができます。
* 認証が設定されている場合、ユーザーをブルートフォース攻撃してから、その資格情報を使用して任意の内部ページにアクセスすることができます（上記の箇条書きのように）。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
