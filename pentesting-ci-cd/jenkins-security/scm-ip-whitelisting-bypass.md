# Contournement de la liste blanche IP SCM

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

Cette page a √©t√© copi√©e depuis [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Introduction

De nombreuses organisations combinent des **syst√®mes de gestion de contr√¥le de source (SCM) bas√©s sur SaaS** (comme GitHub ou GitLab) avec une solution **CI** interne auto-h√©berg√©e (par exemple, Jenkins, TeamCity) permettant √† ces syst√®mes CI de **recevoir des √©v√©nements de webhook** des fournisseurs de contr√¥le de source SaaS, dans le simple but de d√©clencher des travaux de pipeline.

Par cons√©quent, les organisations **mettent sur liste blanche** les **plages d'adresses IP du SCM** leur permettant d'atteindre le syst√®me CI **interne avec des webhooks**. Cependant, notez comment **n'importe qui** peut cr√©er un **compte** sur Github ou Gitlab et le faire **d√©clencher un webhook** qui pourrait envoyer une demande √† ce **syst√®me CI interne**.

De plus, notez que bien que la plage d'adresses IP du service de webhook du fournisseur SCM ait √©t√© ouverte dans le pare-feu de l'organisation pour **permettre aux demandes de webhook de d√©clencher des pipelines** - cela ne signifie **pas** que les demandes de webhook ne peuvent pas √™tre **dirig√©es vers d'autres points de terminaison CI**, en plus de ceux qui √©coutent r√©guli√®rement les √©v√©nements de webhook. Nous pouvons essayer d'acc√©der √† ces points de terminaison pour **visualiser des donn√©es pr√©cieuses telles que les utilisateurs**, les **pipelines**, la **sortie de console** des travaux de pipeline, ou si nous avons la chance de tomber sur une instance qui accorde des privil√®ges d'administrateur aux utilisateurs non authentifi√©s (oui, cela arrive), nous pouvons acc√©der aux **sections de configurations et de cr√©dentials**.

### Sc√©nario

Imaginez un service **Jenkins** qui ne permet **qu'aux adresses IP de GitHub et GitLab** de l'atteindre **de mani√®re externe**.

Dans ce sc√©nario, un attaquant d√©clenchera des webhooks arbitraires dans GitHub et GitLab pour se connecter √† l'int√©rieur de Jenkins et extraire des informations.

### Limitations courantes des webhooks

* **Seules les demandes POST** : Les webhooks ne vous permettent g√©n√©ralement d'envoyer que des demandes POST, cependant, certains **points de terminaison** avec des informations **int√©ressantes** doivent √™tre accessibles via des demandes **GET**.
  * Si le POST est **r√©pondu par une redirection**, il peut la suivre.
  * Certains CI (Jenkins) permettent d'avoir un **param√®tre GET indiquant o√π rediriger le client** une fois qu'il a r√©ussi √† se connecter, vous pouvez l'utiliser pour le rediriger vers une page sp√©cifique avec un Get.
* **Impossible de contr√¥ler le corps de la demande POST** : Si vous devez envoyer des donn√©es sp√©cifiques dans le corps de la demande POST, vous ne pouvez pas le faire.
* **Jetons CSRF** : Si le point de terminaison int√©ressant attend des jetons CSRF, vous ne pourrez pas les extraire et les fournir.

## Webhooks GitHub

### Abus de la connexion Jenkins

La connexion n√©cessite l'envoi d'une **demande POST**. En choisissant de cibler le point de terminaison de connexion, nous r√©solvons le d√©fi de la d√©tention de jetons CSRF, car cette demande sp√©cifique ne le n√©cessite pas. Mais nous sommes toujours confront√©s √† l'autre d√©fi, car nos capacit√©s √† **modifier le corps de la demande restent limit√©es**.

Une demande de connexion Jenkins ressemble √† ceci :

```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```

Nous devons **envoyer les informations d'identification que nous avons forc√©es par bruteforce d'une mani√®re ou d'une autre**.\
Heureusement, le point de terminaison de connexion Jenkins **accepte** une demande POST avec les **champs envoy√©s en tant que param√®tres de requ√™te** :

```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```

Alors comment pouvons-nous le faire fonctionner ? Nous pouvons **cr√©er un nouveau webhook dans GitHub**, en d√©finissant l'URL de demande de connexion Jenkins comme URL