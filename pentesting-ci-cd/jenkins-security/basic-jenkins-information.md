# Jenkinsの基本情報

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**のPRを[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリに提出して、あなたのハッキングのコツを共有する。

</details>

## アクセス

### ユーザー名 + パスワード

Jenkinsにログインする最も一般的な方法は、ユーザー名またはパスワードを使用することです。

### Cookie

**承認されたCookieが盗まれた場合**、それを使用してユーザーのセッションにアクセスすることができます。Cookieは通常`JSESSIONID.*`と呼ばれます。（ユーザーはすべてのセッションを終了させることができますが、まずCookieが盗まれたことを知る必要があります）。

### SSO/プラグイン

Jenkinsはプラグインを使用して設定し、**サードパーティのSSOを介してアクセス可能**にすることができます。

### トークン

**ユーザーはトークンを生成**して、CLIまたはREST APIを介してアプリケーションが自分を偽装するためのアクセスを与えることができます。

### SSHキー

このコンポーネントはJenkins用の組み込みSSHサーバーを提供します。これは[Jenkins CLI](https://www.jenkins.io/doc/book/managing/cli/)の代替インターフェースであり、任意のSSHクライアントを使用してこの方法でコマンドを呼び出すことができます。（[ドキュメント](https://plugins.jenkins.io/sshd/)より）

## 認可

`/configureSecurity`では、**Jenkinsの認可方法を設定**することができます。いくつかのオプションがあります：

* **誰でも何でもできる**: 匿名アクセスでもサーバーを管理できます
* **レガシーモード**: Jenkins <1.164と同じです。**"admin"ロール**を持っている場合は、システム全体を**完全に制御**する権限が与えられ、**それ以外**（**匿名**ユーザーを含む）は**読み取り**アクセスのみが与えられます。
* **ログインしたユーザーは何でもできる**: このモードでは、**ログインしたすべてのユーザーがJenkinsの完全な制御権を持ちます**。唯一完全な制御権を持たないのは**匿名ユーザー**で、**読み取りアクセスのみ**が与えられます。
* **マトリックスベースのセキュリティ**: テーブルで**誰が何をできるかを設定**できます。各**列**は**権限**を表し、各**行**は**ユーザーまたはグループ/ロール**を表します。これには、**認証されていないユーザー**を表す特別なユーザー「**anonymous**」や、**すべての認証されたユーザー**を表す「**authenticated**」が含まれます。

![](<../../.gitbook/assets/image (40).png>)

* **プロジェクトベースのマトリックス認可戦略:** これは「**マトリックスベースのセキュリティ**」に**追加**されたモードで、各プロジェクトごとに追加のACLマトリックスを**個別に定義**することができます。
* **ロールベースの戦略:** **ロールベースの戦略**を使用して認可を定義することができます。`/role-strategy`でロールを管理します。

## **セキュリティレルム**

`/configureSecurity`では、**セキュリティレルムを設定**することができます。デフォルトでは、Jenkinsはいくつかの異なるセキュリティレルムをサポートしています：

* **サーブレットコンテナに委任**: **Jenkinsコントローラーを実行しているサーブレットコンテナーに認証を委任**するために使用します。例えば[Jetty](https://www.eclipse.org/jetty/)などです。
* **Jenkins自身のユーザーデータベース**: 外部システムに委任する代わりに、**Jenkins自身の組み込みユーザーデータストア**を使用して認証します。これはデフォルトで有効になっています。
* **LDAP**: すべての認証を設定されたLDAPサーバーに委任します。これにはユーザーとグループの両方が含まれます。
* **Unixユーザー/グループデータベース**: **認証をJenkinsコントローラー上のUnix OSレベルのユーザーデータベースに委任**します。このモードでは、Unixグループを認可に再利用することもできます。

プラグインは、Jenkinsを既存のIDシステムに組み込むのに役立つ追加のセキュリティレルムを提供することができます。例えば：

* [Active Directory](https://plugins.jenkins.io/active-directory)
* [GitHub Authentication](https://plugins.jenkins.io/github-oauth)
* [Atlassian Crowd 2](https://plugins.jenkins.io/crowd2)

## Jenkinsノード、エージェント、およびエグゼキューター

[ドキュメント](https://www.jenkins.io/doc/book/managing/nodes/)からの定義：

**ノード**はビルド**エージェントが実行されるマシン**です。Jenkinsは各接続されたノードをディスクスペース、一時スペースの空き容量、スワップの空き容量、時計の時間/同期、および応答時間について監視します。これらの値のいずれかが設定されたしきい値を超えると、ノードはオフラインになります。

**エージェント**は**エグゼキューターを使用して**Jenkinsコントローラーに代わって**タスク実行を管理**します。エージェントはJavaをサポートする任意のオペレーティングシステムを使用できます。ビルドやテストに必要なツールは、エージェントが実行されるノードにインストールされます。これらは**直接またはコンテナー**（DockerまたはKubernetes）にインストールすることができます。各**エージェントは、ホストマシン上で独自のPIDを持つプロセスです**。

**エグゼキューター**はタスクの実行のための**スロット**です。実質的には、それは**エージェント内のスレッド**です。ノード上の**エグゼキューターの数**は、そのノードで一度に実行できる**同時タスクの数**を定義します。言い換えれば、これはそのノードで一度に実行できる**同時パイプライン`stages`の数**を決定します。

## Jenkinsのシークレット

### シークレットとクレデンシャルの暗号化

[ドキュメント](https://www.jenkins.io/doc/developer/security/secrets/#encryption-of-secrets-and-credentials)からの定義：
Jenkinsは**AESを使用してシークレット、クレデンシャル、およびそれらの暗号化キーを暗号化して保護**します。これらの暗号化キーは`$JENKINS_HOME/secrets/`に保存され、そこには言及されたキーを保護するためのマスターキーも保存されます。このディレクトリは、Jenkinsコントローラーが実行されているオペレーティングシステムユーザーのみがこのディレクトリに対する読み書きアクセス権を持つように設定されるべきです（つまり、`chmod`の値が`0700`であるか、適切なファイル属性を使用します）。**マスターキー**（暗号用語で「キー暗号化キー」と呼ばれることもあります）は、**`$JENKINS_HOME/secrets/master.key`**に**暗号化されていない状態**でJenkinsコントローラーファイルシステムに保存されており、そのファイルへの直接アクセスを持つ攻撃者からは保護されません。ほとんどのユーザーや開発者は、[Secret](https://javadoc.jenkins.io/byShortName/Secret) APIを通じて一般的な秘密データを暗号化するか、またはクレデンシャルAPIを通じてこれらの暗号化キーを間接的に使用します。暗号に興味がある人のために、JenkinsはAESを暗号ブロック連鎖（CBC）モードでPKCS#5パディングとランダムIVを使用して[CryptoConfidentialKey](https://javadoc.jenkins.io/byShortName/CryptoConfidentialKey)のインスタンスを暗号化し、それらは`$JENKINS_HOME/secrets/`に、それらの`CryptoConfidentialKey` idに対応するファイル名で保存されます。一般的なキーidには以下が含まれます：

* `hudson.util.Secret`: 一般的なシークレットに使用されます；
* `com.cloudbees.plugins.credentials.SecretBytes.KEY`: いくつかのクレデンシャルタイプに使用されます；
* `jenkins.model.Jenkins.crumbSalt`: [CSRF保護メカニズム](https://www.jenkins.io/doc/book/managing/security/#cross-site-request-forgery)に使用されます；

### クレデンシャルアクセス

クレデンシャルは、任意のプロジェクトが設定された**グローバルプロバイダー**(`/credentials/`)にスコープされるか、**特定のプロジェクト**(`/job/<project-name>/configure`)にスコープされ、したがって特定のプロジェクトからのみアクセス可能です。

[**ドキュメント**](https://www.jenkins.io/blog/2019/02/21/credentials-masking/)によると：スコープ内にあるクレデンシャルは、制限なしにパイプラインに利用可能になります。**ビルドログでの偶発的な露出を防ぐために**、クレデンシャルは通常の出力から**マスクされます**。そのため、`env`（Linux）や`set`（Windows）の呼び出し、または環境やパラメータを印刷するプログラムは、クレデンシャルをビルドログに**表示しない**ようになっています。これは、クレデンシャルにアクセスできないユーザーに対してです。

**そのため、攻撃者がクレデンシャルを盗み出すためには、例えば、それらをbase64でエンコードする必要があります。**

## 参考文献

* [https://www.jenkins.io/doc/book/security/managing-security/](https://www.jenkins.io/doc/book/security/managing-security/)
* [https://www.jenkins.io/doc/book/managing/nodes/](https://www.jenkins.io/doc/book/managing/nodes/)
* [https://www.jenkins.io/doc/developer/security/secrets/](https://www.jenkins.io/doc/developer/security/secrets/)
* [https://www.jenkins.io/blog/2019/02/21/credentials-masking/](https://www.jenkins.io/blog/2019/02/21/credentials-masking/)
* [https://www.jenkins.io/doc/book/managing/security/#cross-site-request-forgery](https://www.jenkins.io/doc/book/managing/security/#cross-site-request-forgery)
* [https://www.jenkins.io/doc/developer/security/secrets/#encryption-of-secrets-and-credentials](https://www.jenkins.io/doc/developer/security/secrets/#encryption-of-secrets-and-credentials)
* [https://www.jenkins.io/doc/book/managing/nodes/](https://www.jenkins.io/doc/book/managing/nodes/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**
