# Seguridad de Apache Airflow

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n b치sica

[**Apache Airflow**](https://airflow.apache.org) se utiliza para la **programaci칩n y orquestaci칩n de tuber칤as o flujos de datos**. La orquestaci칩n de tuber칤as de datos se refiere a la secuenciaci칩n, coordinaci칩n, programaci칩n y gesti칩n de **tuber칤as de datos complejas de diversas fuentes**. Estas tuber칤as de datos entregan conjuntos de datos que est치n listos para su consumo por aplicaciones de inteligencia empresarial y ciencia de datos, modelos de aprendizaje autom치tico que admiten aplicaciones de big data.

B치sicamente, Apache Airflow le permitir치 **programar la ejecuci칩n de c칩digo cuando algo** (evento, cron) **suceda**.

## Laboratorio local

### Docker-Compose

Puede utilizar el **archivo de configuraci칩n de docker-compose** de [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) para lanzar un entorno completo de Apache Airflow en Docker. (Si est치 en MacOS, aseg칰rese de dar al menos 6 GB de RAM a la VM de Docker).

### Minikube

Una forma sencilla de **ejecutar Apache Airflow** es ejecutarlo **con minikube**:

```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Algunas informaciones sobre c칩mo acceder a la consola web aparecer치n despu칠s de este comando

# Use este comando para eliminarlo
helm delete airflow-release
```

## Configuraci칩n de Airflow

Airflow puede almacenar **informaci칩n confidencial** en su configuraci칩n o puede encontrar configuraciones d칠biles en su lugar:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Antes de comenzar a atacar Airflow, debe comprender **c칩mo funcionan los permisos**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Ataques

### Enumeraci칩n de la consola web

Si tiene **acceso a la consola web**, es posible que pueda acceder a alguna o todas las siguientes informaciones:

* **Variables** (La informaci칩n confidencial personalizada podr칤a almacenarse aqu칤)
* **Conexiones** (La informaci칩n confidencial personalizada podr칤a almacenarse aqu칤)
  * Acceda a ellas en `http://<airflow>/connection/list/`
* [**Configuraci칩n**](./#airflow-configuration) (La informaci칩n confidencial como la **`secret_key`** y las contrase침as podr칤an almacenarse aqu칤)
* Lista de **usuarios y roles**
* **C칩digo de cada DAG** (que podr칤a contener informaci칩n interesante)

### Recuperar valores de variables

Las variables se pueden almacenar en Airflow para que los **DAG** puedan **acceder** a sus valores. Es similar a los secretos de otras plataformas. Si tiene **permisos suficientes**, puede acceder a ellas en la GUI en `http://<airflow>/variable/list/`.\
Por defecto, Airflow mostrar치 el valor de la variable en la GUI, sin embargo, seg칰n [**esto**](https://marclamberti.com/blog/variables-with-apache-airflow/) es posible establecer una **lista de variables** cuyo **valor** aparecer치 como **asteriscos** en la **GUI**.

![](<../../.gitbook/assets/image (79).png>)

Sin embargo, estos **valores** a칰n se pueden **recuperar** a trav칠s de **CLI** (necesita tener acceso a la base de datos), **ejecuci칩n arbitraria de DAG**, **API** accediendo al punto final de variables (la API debe estar activada) e **incluso la GUI en s칤**.\
Para acceder a esos valores desde la GUI, simplemente **selecciona las variables** a las que deseas acceder y **haz clic en Acciones -> Exportar**.\
Otra forma es realizar una **fuerza bruta** al **valor oculto** utilizando el **filtrado de b칰squeda** hasta que lo obtenga:

![](<../../.gitbook/assets/image (30).png>)

### Escalada de privilegios

Si la configuraci칩n de **`expose_config`** est치 configurada en **True**, desde el **rol de usuario** y **superior** se puede **leer** la **configuraci칩n en la web**. En esta configuraci칩n, aparece la **`secret_key`**, lo que significa que cualquier usuario con esta clave v치lida puede **crear su propia cookie firmada para hacerse pasar por cualquier otra cuenta de usuario**.

```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef