# Seguran√ßa do Apache Airflow

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informa√ß√µes b√°sicas

[**Apache Airflow**](https://airflow.apache.org) √© usado para a **programa√ß√£o e orquestra√ß√£o de pipelines ou fluxos de trabalho de dados**. A orquestra√ß√£o de pipelines de dados refere-se √† sequ√™ncia, coordena√ß√£o, programa√ß√£o e gerenciamento de **pipelines de dados complexos de diversas fontes**. Esses pipelines de dados fornecem conjuntos de dados prontos para consumo por aplicativos de intelig√™ncia empresarial e ci√™ncia de dados, modelos de aprendizado de m√°quina que suportam aplicativos de big data.

Basicamente, o Apache Airflow permitir√° que voc√™ **agende a execu√ß√£o de c√≥digo quando algo** (evento, cron) **acontece**.

## Laborat√≥rio local

### Docker-Compose

Voc√™ pode usar o **arquivo de configura√ß√£o docker-compose de** [**https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml**](https://raw.githubusercontent.com/apache/airflow/main/docs/apache-airflow/start/docker-compose.yaml) para lan√ßar um ambiente completo do docker do apache airflow. (Se voc√™ estiver no MacOS, certifique-se de dar pelo menos 6 GB de RAM para a VM do docker).

### Minikube

Uma maneira f√°cil de **executar o apache airflow** √© execut√°-lo **com o minikube**:

```bash
helm repo add airflow-stable https://airflow-helm.github.io/charts
helm repo update
helm install airflow-release airflow-stable/airflow
# Algumas informa√ß√µes sobre como acessar o console da web aparecer√£o ap√≥s este comando

# Use este comando para exclu√≠-lo
helm delete airflow-release
```

## Configura√ß√£o do Airflow

O Airflow pode armazenar **informa√ß√µes confidenciais** em sua configura√ß√£o ou voc√™ pode encontrar configura√ß√µes fracas em vigor:

{% content-ref url="airflow-configuration.md" %}
[airflow-configuration.md](airflow-configuration.md)
{% endcontent-ref %}

## Airflow RBAC

Antes de come√ßar a atacar o Airflow, voc√™ deve entender **como funcionam as permiss√µes**:

{% content-ref url="airflow-rbac.md" %}
[airflow-rbac.md](airflow-rbac.md)
{% endcontent-ref %}

## Ataques

### Enumera√ß√£o do console da web

Se voc√™ tiver **acesso ao console da web**, poder√° acessar algumas ou todas as seguintes informa√ß√µes:

* **Vari√°veis** (informa√ß√µes confidenciais personalizadas podem ser armazenadas aqui)
* **Conex√µes** (informa√ß√µes confidenciais personalizadas podem ser armazenadas aqui)
  * Acesse-os em `http://<airflow>/connection/list/`
* [**Configura√ß√£o**](./#airflow-configuration) (Informa√ß√µes confidenciais como a **`secret_key`** e senhas podem ser armazenadas aqui)
* Listar **usu√°rios e fun√ß√µes**
* **C√≥digo de cada DAG** (que pode conter informa√ß√µes interessantes)

### Recuperar valores de vari√°veis

As vari√°veis podem ser armazenadas no Airflow para que os **DAGs** possam **acessar** seus valores. √â semelhante aos segredos de outras plataformas. Se voc√™ tiver **permiss√µes suficientes**, poder√° acess√°-los na GUI em `http://<airflow>/variable/list/`.\
O Airflow, por padr√£o, mostrar√° o valor da vari√°vel na GUI, no entanto, de acordo com [**este**](https://marclamberti.com/blog/variables-with-apache-airflow/) √© poss√≠vel definir uma **lista de vari√°veis** cujo **valor** aparecer√° como **asteriscos** na **GUI**.

![](<../../.gitbook/assets/image (79).png>)

No entanto, esses **valores** ainda podem ser **recuperados** via **CLI** (voc√™ precisa ter acesso ao DB), **execu√ß√£o arbitr√°ria de DAG**, **API** acessando o endpoint de vari√°veis (a API precisa ser ativada) e **at√© mesmo a GUI em si!**\
Para acessar esses valores da GUI, basta **selecionar as vari√°veis** que voc√™ deseja acessar e **clicar em A√ß√µes -> Exportar**.\
Outra maneira √© realizar uma **for√ßa bruta** para o **valor oculto** usando o **filtro de pesquisa** at√© obt√™-lo:

![](<../../.gitbook/assets/image (30).png>)

### Escala√ß√£o de privil√©gios

Se a configura√ß√£o **`expose_config`** estiver definida como **True**, a partir do **papel de usu√°rio** e **acima**, √© poss√≠vel **ler** a **configura√ß√£o na web**. Nesta configura√ß√£o, a **`secret_key`** aparece, o que significa que qualquer usu√°rio com esta chave v√°lida pode **criar seu pr√≥prio cookie assinado para se pass