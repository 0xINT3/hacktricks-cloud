# CI/CD 渗透测试方法论

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧**。

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## 简介

开发环境已成为当今攻击面的重要组成部分。其中，最有价值的资产是负责构建、测试和部署代码的 CI 和 CD 系统，通常拥有组织中最关键资产的**机密信息和访问权限**。因此，攻击者自然而然地不断寻找获取这些系统访问权限的新方法。

### VCS

VCS 代表**版本控制系统**，这些系统允许开发人员**管理其源代码**。最常见的是 **git**，您通常会发现公司在以下**平台**之一上使用它：

* Github
* Gitlab
* Bitbucket
* Gitea
* 云服务提供商（它们提供自己的 VCS 平台）

### 流水线

流水线允许开发人员在某些操作发生后**自动执行代码**（用于构建、测试、部署等目的）。它们对于**自动化从开发到生产的所有步骤**非常有用。

然而，这些系统需要在**某个地方执行**，通常需要使用**特权凭据来部署代码**。

## VCS 渗透测试方法论

{% hint style="info" %}
即使某些 VCS 平台允许为此部分创建流水线，我们仅分析对源代码控制的潜在攻击。
{% endhint %}

包含项目源代码的平台包含敏感信息，人们在此平台上授予的权限必须非常小心。以下是攻击者可能滥用的 VCS 平台上的一些常见问题：

* **泄漏**：如果您的代码在提交中包含泄漏，并且攻击者可以访问存储库（因为它是公开的或者他有访问权限），他可以发现这些泄漏。
* **访问**：如果攻击者可以**访问 VCS 平台内的帐户**，他可以获得**更多的可见性和权限**。
* **注册**：某些平台只允许外部用户创建帐户。
* **SSO**：某些平台不允许用户注册，但允许任何人使用有效的 SSO 访问（因此攻击者可以使用他的 github 帐户进行访问）。
* **凭据**：用户名+密码、个人令牌、ssh 密钥、Oauth 令牌、cookies... 用户可以窃取多种类型的令牌以某种方式访问存储库。
* **Webhooks**：VCS 平台允许生成 Webhooks。如果它们**没有受到保护**，攻击者可以滥用它们。
* 如果没有设置密钥，攻击者可以滥用第三方平台的 Webhook
* 如果密钥在 URL 中，情况也是如此，攻击者也拥有密钥
* **代码被篡改**：如果恶意行为者对存储库具有某种**写入**访问权限，他可以尝试**注入恶意代码**。为了成功，他可能需要**绕过分支保护**。这些操作可以具有不同的目标：
* 篡改主分支以**破坏生产环境**。
* 篡改主分支（或其他分支）以**破坏开发人员的机器**（因为他们通常在其机器上执行测试、terraform 或其他操作）。
* **篡改流水线**（请参阅下一节）

## 流水线渗透测试方法论

定义流水线的最常见方式是使用**托管在存储库中的 CI 配置文件**。该文件描述了执行作业的顺序、影响流程的条件以及构建环境设置。\
这些文件通常具有一致的名称和格式，例如 Jenkinsfile（Jenkins）、.gitlab-ci.yml（GitLab）、.circleci/config.yml（CircleCI）以及位于 .github/workflows 下的 GitHub Actions YAML 文件。当触发流水线作业时，它会从所选源（例如提交/分支）**拉取代码**，并根据 CI 配置文件中指定的代码**运行指定的命令**。

因此，攻击者的最终目标是以某种方式**篡改这些配置文件**或**执行的命令**。

### PPE - 毒化流水线执行

毒化流水线执行（PPE）向量**滥用 SCM 存储库的权限**，以导致 CI 流水线执行恶意命令。具有权限**操作 CI 配置文件或 CI 流水线作业所依赖的其他文件**的用户可以修改这些文件，使其包含**恶意命令**，最终“毒化”执行这些命令的 CI 流水线。

要成功执行 PPE 攻击，恶意行为者需要能够：

* 具有**写入 VCS 平台的权限**，因为通常在执行推送或拉取请求时触发流水线。（请参阅 VCS 渗透测试方法论以获取获取访问权限的摘要）。
* 请注意，有时**外部 PR 也算作“写入权限”**。
* 即使他具有写入权限，他也需要确保自己可以**修改 CI 配置文件或配置所依赖的其他文件**。
* 为此，他可能需要能够**绕过分支保护**。

有 3 种 PPE 变体：

* **D-PPE**：**直接 PPE** 攻击发生在攻击者**修改将要执行的 CI 配置**文件时。
* **I-DDE**：**间接 PPE** 攻击发生在攻击者**修改**了**CI 配置文件所依赖的文件**（如 make 文件或 terraform 配置）。
* **公共 PPE 或 3PE**：在某些情况下，流水线可以由**没有写入存储库权限**的用户触发（甚至可能不是组织的一部分），因为他们可以发送 PR。
* **3PE 命令注入**：通常，CI/CD 流水线将使用**有关 PR 的信息**设置环境变量。如果该值可以被攻击者控制（如 PR 的标题）并且在**危险位置**（如执行**sh 命令**）中使用，攻击者可能会在其中**注入命令**。
### 攻击利益

了解了污染流水线的三种方式后，让我们看看攻击者在成功攻击后可以获得什么：

- **秘密信息**：正如之前提到的，流水线需要作业的**权限**（检索代码、构建代码、部署代码...），而这些权限通常以**秘密信息**的形式授予。这些秘密信息通常可以通过**环境变量或系统内的文件**进行访问。因此，攻击者将尽可能多地窃取秘密信息。
- 根据流水线平台的不同，攻击者**可能需要在配置中指定秘密信息**。这意味着如果攻击者无法修改CI配置流水线（例如I-PPE），他只能**窃取该流水线所拥有的秘密信息**。
- **计算**：代码在某个地方执行，根据执行的位置，攻击者可能能够进一步进行操作。
- **本地部署**：如果流水线在本地部署，攻击者可能会进入一个**具有更多资源访问权限的内部网络**。
- **云端**：攻击者可以访问云中的**其他机器**，还可以从中**窃取**IAM角色/服务账户**令牌**，以获取**在云中进一步访问**的权限。
- **平台机器**：有时作业将在**流水线平台机器**内执行，这些机器通常位于**无法进一步访问的云中**。
- **选择性**：有时**流水线平台将配置多台机器**，如果您可以**修改CI配置文件**，则可以**指示在哪台机器上运行恶意代码**。在这种情况下，攻击者可能会在每台可能的机器上运行一个反向 shell，以尝试进一步利用它。
- **危害生产环境**：如果您在流水线内部，并且最终版本是从流水线构建和部署的，您可以**危害即将在生产环境中运行的代码**。

## 更多相关信息

### 工具和CIS基准

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench) 是一个开源工具，用于根据新的[**CIS软件供应链基准**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf)对软件供应链堆栈进行安全合规性审计。审计重点是整个SDLC过程，可以揭示从代码时间到部署时间的风险。

### CI/CD安全风险前十

查看这篇有关Cider根据CIS的前十个CI/CD风险的有趣文章：[https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### 实验室

- 在每个可以在本地运行的平台上，您将找到如何在本地启动它的说明，以便您可以根据需要进行配置和测试。
- Gitea + Jenkins 实验室：[https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### 自动化工具

- [**Checkov**](https://github.com/bridgecrewio/checkov)：**Checkov** 是一种用于基础设施即代码的静态代码分析工具。

## 参考资料

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

- 如果您希望在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
- 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧**。

</details>
