# Pentesting CI/CD Methodology

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**githubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## はじめに

開発環境は、今日の攻撃対象となる主要な部分となっています。その中でも、**CIとCD** — コードをビルド、テスト、デプロイするシステム — は組織の最も重要な資産への**秘密とアクセス**を通常持っているため、最も有益な資産です。そのため、攻撃者はこれらのシステムへのアクセスを得るための新しい方法を絶えず探しています。

### VCS

VCSは**バージョン管理システム**を意味し、開発者が**ソースコードを管理する**ことを可能にします。最も一般的なのは**git**で、通常、以下の**プラットフォーム**のいずれかで企業が使用しているのを見つけることができます：

* Github
* Gitlab
* Bitbucket
* Gitea
* クラウドプロバイダー（独自のVCSプラットフォームを提供しています）

### パイプライン

パイプラインは、特定のアクションが発生した後（プッシュ、PR、cronなど）コードの**実行を自動化する**（ビルド、テスト、デプロイなどの目的で）ことを開発者に可能にします。これらは、開発から本番までのすべてのステップを**自動化する**ために非常に役立ちます。

ただし、これらのシステムは**どこかで実行される**必要があり、通常はコードをデプロイするための**特権クレデンシャル**を持っています。

## VCS Pentesting Methodology

{% hint style="info" %}
一部のVCSプラットフォームはパイプラインを作成することを許可していますが、このセクションではソースコードの管理への潜在的な攻撃のみを分析します。
{% endhint %}

プロジェクトのソースコードを含むプラットフォームには機密情報が含まれており、このプラットフォーム内で付与される権限には非常に注意が必要です。これらは、攻撃者が悪用できるVCSプラットフォーム全体の一般的な問題です：

* **リーク**: コミットにリークが含まれていて、攻撃者がリポジトリにアクセスできる場合（公開されているか、アクセス権がある場合）、リークを発見する可能性があります。
* **アクセス**: 攻撃者が**VCSプラットフォーム内のアカウントにアクセスできる**場合、**より多くの可視性と権限**を得ることができます。
* **登録**: 一部のプラットフォームは外部ユーザーがアカウントを作成することを許可します。
* **SSO**: 一部のプラットフォームはユーザーの登録を許可しませんが、有効なSSOでのアクセスは許可します（したがって、攻撃者は例えば彼のgithubアカウントを使用して入ることができます）。
* **クレデンシャル**: ユーザー名+パスワード、個人トークン、sshキー、Oauthトークン、クッキー... ユーザーがリポジトリに何らかの方法でアクセスするために盗む可能性のあるトークンの種類はいくつかあります。
* **Webhooks**: VCSプラットフォームはwebhooksを生成することを許可します。それらが**保護されていない**場合、**攻撃者が悪用する**可能性があります。
* シークレットが設定されていない場合、攻撃者は第三者プラットフォームのwebhookを悪用することができます
* シークレットがURLにある場合、同じことが起こり、攻撃者もシークレットを持っています
* **コードの妥協:** 悪意のあるアクターがリポジトリに対して何らかの**書き込み**アクセスを持っている場合、**悪意のあるコードを注入**しようとするかもしれません。成功するためには、**ブランチ保護をバイパスする**必要があるかもしれません。これらの行動は、異なる目的で実行されることがあります：
* 本番環境を**妥協する**ためにメインブランチを妥協する。
* 開発者のマシンを**妥協する**ためにメイン（または他のブランチ）を妥協する（彼らは通常、テスト、terraform、またはリポジトリ内の他のものを彼らのマシンで実行します）。
* **パイプラインを妥協する**（次のセクションをチェック）

## Pipelines Pentesting Methodology

パイプラインを定義する最も一般的な方法は、パイプラインがビルドするリポジトリにホストされている**CI設定ファイル**を使用することです。このファイルは、実行されるジョブの順序、フローに影響を与える条件、およびビルド環境の設定を記述しています。\
これらのファイルには通常、一貫した名前と形式があります。例えば - Jenkinsfile（Jenkins）、.gitlab-ci.yml（GitLab）、.circleci/config.yml（CircleCI）、および.github/workflowsの下に位置するGitHub Actions YAMLファイルです。トリガーされると、パイプラインジョブは選択されたソース（例：コミット/ブランチ）から**コードをプル**し、そのコードに対してCI設定ファイルで指定された**コマンドを実行します**。

したがって、攻撃者の究極の目標は、何らかの方法で**これらの設定ファイルを妥協する**か、または**実行するコマンドを妥協する**ことです。

### PPE - Poisoned Pipeline Execution

Poisoned Pipeline Execution（PPE）ベクターは、SCMリポジトリに対する権限を**悪用し**、CIパイプラインが悪意のあるコマンドを実行するようにします。CI設定ファイルを**操作する権限を持つユーザー**、またはCIパイプラインジョブが依存する他のファイルは、それらを変更して**悪意のあるコマンド**を含むようにすることができ、最終的にこれらのコマンドを実行するCIパイプラインを“毒する”ことができます。

PPE攻撃を成功させるためには、悪意のあるアクターは以下が可能である必要があります：

* プッシュまたはプルリクエストが実行されると通常パイプラインがトリガーされるため、**VCSプラットフォームへの書き込みアクセス**を持っている。
* 書き込み権限を持っていても、**CI設定ファイルまたは設定が依存している他のファイルを変更できる**ことを確認する必要があります。
* これには、**ブランチ保護をバイパスする**ことが必要になるかもしれません。

PPEには3つのフレーバーがあります：

* **D-PPE**: **直接PPE**攻撃は、アクターが実行されるCI設定ファイルを**変更する**ときに発生します。
* **I-DDE**: **間接PPE**攻撃は、アクターが実行されるCI設定ファイルが**依存するファイル**（makeファイルやterraform設定など）を**変更する**ときに発生します。
* **Public PPEまたは3PE**: 場合によっては、パイプラインがリポジトリ内で書き込みアクセスを持たないユーザーによって**トリガーされる**ことがあります（そして、そのユーザーは組織の一部でさえないかもしれません）なぜなら彼らはPRを送ることができるからです。
* **3PEコマンドインジェクション**: 通常、CI/CDパイプラインはPRに関する情報を含む**環境変数**を**設定します**。その値が攻撃者によって制御可能である（PRのタイトルのように）場合、そしてそれが**危険な場所で使用される**場合（**shコマンドを実行する**ような）、攻撃者はそこにコマンドを**注入する**可能性があります。
### 悪用の利点

パイプラインを汚染する3つの方法を知ったところで、攻撃者が成功した悪用後に得られる可能性のあるものを見てみましょう：

* **シークレット**: 前述の通り、パイプラインはジョブのために**権限**（コードの取得、ビルド、デプロイなど）を必要とし、これらの権限は通常**シークレットで付与されます**。これらのシークレットは、通常、**環境変数やシステム内のファイル経由でアクセス可能**です。したがって、攻撃者は可能な限り多くのシークレットを抽出しようとします。
* パイプラインプラットフォームによっては、攻撃者が**設定でシークレットを指定する必要がある**かもしれません。つまり、攻撃者がCI設定パイプラインを変更できない場合（**I-PPE**など）、**パイプラインが持っているシークレットのみを抽出することができます**。
* **計算**: コードはどこかで実行されますが、どこで実行されるかによって、攻撃者はさらにピボットする可能性があります。
* **オンプレミス**: パイプラインがオンプレミスで実行されている場合、攻撃者は**内部ネットワークにアクセスし、より多くのリソースにアクセスできる**かもしれません。
* **クラウド**: 攻撃者は**クラウド内の他のマシンにアクセス**することができますが、**クラウド内でさらにアクセスを得るために**IAMロール/サービスアカウントの**トークンを抽出**することもできます。
* **プラットフォームのマシン**: 時々、ジョブは**パイプラインプラットフォームのマシン内で実行される**ことがあり、通常は**これ以上のアクセスがない**クラウド内にあります。
* **選択する**: 時々、**パイプラインプラットフォームは複数のマシンを設定している**ことがあり、CI設定ファイルを**変更できる場合**、**悪意のあるコードを実行したい場所を指示する**ことができます。この状況では、攻撃者はさらなる悪用を試みるために、可能な限りのマシンでリバースシェルを実行するでしょう。
* **本番環境の妥協**: パイプライン内にいて、最終バージョンがそこからビルドおよびデプロイされる場合、**本番で実行されるコードを妥協させる**ことができます。

## より関連する情報

### ツール & CISベンチマーク

* \*\*\*\*[**Chain-bench**](https://github.com/aquasecurity/chain-bench)は、新しい[**CISソフトウェアサプライチェーンベンチマーク**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf)に基づいて、セキュリティコンプライアンスのためのソフトウェアサプライチェーンスタックを監査するオープンソースツールです。監査はSDLCプロセス全体に焦点を当て、コード時間からデプロイ時間に至るまでのリスクを明らかにします。

### トップ10 CI/CDセキュリティリスク

Ciderによるトップ10のCI/CDリスクについての興味深い記事をチェックしてください: [https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### ラボ

* ローカルで実行できる各プラットフォームについて、ローカルで起動する方法と、テストするために好きなように設定する方法が見つかります
* Gitea + Jenkinsラボ: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### 自動ツール

* \*\*\*\*[**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov**はインフラストラクチャ・アズ・コードのための静的コード分析ツールです。

## 参考文献

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
