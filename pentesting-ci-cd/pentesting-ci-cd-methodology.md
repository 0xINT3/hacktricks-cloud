# Pentesting CI/CD Methodology

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS steht f√ºr **Versionskontrollsystem**, diese Systeme erm√∂glichen es Entwicklern, **ihren Quellcode zu verwalten**. Das g√§ngigste ist **git** und Sie werden Unternehmen in der Regel eine der folgenden **Plattformen** verwenden sehen:

* Github
* Gitlab
* Bitbucket
* Gitea
* Cloud-Anbieter (sie bieten ihre eigenen VCS-Plattformen an)

## Pipelines

Pipelines erm√∂glichen es Entwicklern, die **Ausf√ºhrung von Code zu automatisieren** (f√ºr Bau-, Test-, Bereitstellungs... Zwecke), nachdem bestimmte Aktionen erfolgt sind: Ein Push, ein PR, cron... Sie sind sehr n√ºtzlich, um alle Schritte von der Entwicklung bis zur Produktion zu **automatisieren**.

Diese Systeme m√ºssen jedoch **irgendwo ausgef√ºhrt werden** und in der Regel mit **privilegierten Anmeldeinformationen zum Bereitstellen von Code**.

## VCS-Pentesting-Methodik

{% hint style="info" %}
Auch wenn einige VCS-Plattformen das Erstellen von Pipelines erm√∂glichen, werden wir in diesem Abschnitt nur potenzielle Angriffe auf die Kontrolle des Quellcodes analysieren.
{% endhint %}

Plattformen, die den Quellcode Ihres Projekts enthalten, enthalten sensible Informationen, und Personen m√ºssen sehr vorsichtig mit den gew√§hrten Berechtigungen innerhalb dieser Plattform sein. Dies sind einige h√§ufige Probleme bei VCS-Plattformen, die ein Angreifer ausnutzen k√∂nnte:

* **Lecks**: Wenn Ihr Code Lecks in den Commits enth√§lt und der Angreifer auf das Repository zugreifen kann (weil es √∂ffentlich ist oder weil er Zugriff hat), k√∂nnte er die Lecks entdecken.
* **Zugriff**: Wenn ein Angreifer **Zugriff auf ein Konto innerhalb der VCS-Plattform** erlangen kann, k√∂nnte er **mehr Sichtbarkeit und Berechtigungen** erlangen.
* **Registrierung**: Einige Plattformen erlauben nur externen Benutzern, ein Konto zu erstellen.
* **SSO**: Einige Plattformen erlauben Benutzern nicht, sich zu registrieren, gestatten jedoch jedem, mit einem g√ºltigen SSO zuzugreifen (so k√∂nnte ein Angreifer beispielsweise sein Github-Konto verwenden, um einzutreten).
* **Anmeldeinformationen**: Benutzername+Passwort, pers√∂nliche Tokens, SSH-Schl√ºssel, OAuth-Tokens, Cookies... es gibt verschiedene Arten von Tokens, die ein Benutzer stehlen k√∂nnte, um auf irgendeine Weise auf ein Repository zuzugreifen.
* **Webhooks**: VCS-Plattformen erm√∂glichen das Generieren von Webhooks. Wenn sie **nicht mit nicht sichtbaren Geheimnissen gesch√ºtzt sind**, k√∂nnte ein **Angreifer sie ausnutzen**.
* Wenn kein Geheimnis vorhanden ist, k√∂nnte der Angreifer den Webhook der Drittanbieterplattform ausnutzen
* Wenn das Geheimnis in der URL steht, passiert dasselbe und der Angreifer hat auch das Geheimnis
* **Code-Kompromittierung:** Wenn ein b√∂sartiger Akteur irgendeine Art von **Schreibzugriff auf die Repos** hat, k√∂nnte er versuchen, **b√∂sartigen Code einzuschleusen**. Um erfolgreich zu sein, m√ºsste er m√∂glicherweise **Branch-Schutzmechanismen umgehen**. Diese Aktionen k√∂nnen mit unterschiedlichen Zielen durchgef√ºhrt werden:
* Kompromittierung des Hauptzweigs, um die **Produktion zu kompromittieren**.
* Kompromittierung des Hauptzweigs (oder anderer Zweige), um die **Entwicklermaschinen zu kompromittieren** (da sie normalerweise Tests, Terraform oder andere Dinge im Repository auf ihren Maschinen ausf√ºhren).
* **Kompromittierung der Pipeline** (siehe n√§chster Abschnitt)

## Pipelines-Pentesting-Methodik

Der h√§ufigste Weg, eine Pipeline zu definieren, besteht darin, eine **CI-Konfigurationsdatei im Repository** zu hosten, das die Pipeline erstellt. Diese Datei beschreibt die Reihenfolge der ausgef√ºhrten Jobs, Bedingungen, die den Ablauf beeinflussen, und Einstellungen der Build-Umgebung.\
Diese Dateien haben in der Regel einen konsistenten Namen und ein Format, zum Beispiel ‚Äî Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) und die GitHub Actions YAML-Dateien unter .github/workflows. Wenn die Pipeline ausgel√∂st wird, **zieht der Pipeline-Job den Code** aus der ausgew√§hlten Quelle (z.B. Commit / Branch) und **f√ºhrt die im CI-Konfigurationsfile angegebenen Befehle** gegen diesen Code aus.

Daher ist das ultimative Ziel des Angreifers, diese Konfigurationsdateien oder die **ausgef√ºhrten Befehle** auf irgendeine Weise zu **kompromittieren**.

### PPE - Vergiftete Pipeline-Ausf√ºhrung

Der Pfad der vergifteten Pipeline-Ausf√ºhrung (PPE) nutzt Berechtigungen in einem SCM-Repository aus, um eine CI-Pipeline zu manipulieren und sch√§dliche Befehle auszuf√ºhren. Benutzer mit den erforderlichen Berechtigungen k√∂nnen CI-Konfigurationsdateien oder andere Dateien, die vom Pipeline-Job verwendet werden, manipulieren, um sch√§dliche Befehle einzuschlie√üen. Dies "vergiftet" die CI-Pipeline und f√ºhrt zur Ausf√ºhrung dieser sch√§dlichen Befehle.

Damit ein b√∂sartiger Akteur erfolgreich einen PPE-Angriff durchf√ºhren kann, muss er in der Lage sein:

* **Schreibzugriff auf die VCS-Plattform** zu haben, da Pipelines normalerweise ausgel√∂st werden, wenn ein Push oder ein Pull-Request durchgef√ºhrt wird. (√úberpr√ºfen Sie die VCS-Pentesting-Methodik f√ºr eine Zusammenfassung der M√∂glichkeiten, Zugriff zu erhalten).
* Beachten Sie, dass manchmal ein **externer PR als "Schreibzugriff" z√§hlt**.
* Selbst wenn er Schreibberechtigungen hat, muss er sicherstellen, dass er die **CI-Konfigurationsdatei oder andere Dateien, auf die die Konfiguration angewiesen ist, √§ndern kann**.
* Daf√ºr muss er m√∂glicherweise in der Lage sein, **Branch-Schutzmechanismen zu umgehen**.

Es gibt 3 PPE-Varianten:

* **D-PPE**: Ein **Direkter PPE**-Angriff tritt auf, wenn der Akteur die **CI-Konfigurationsdatei √§ndert**, die ausgef√ºhrt werden soll.
* **I-DDE**: Ein **Indirekter PPE**-Angriff tritt auf, wenn der Akteur eine **Datei √§ndert**, auf die die CI-Konfigurationsdatei, die ausgef√ºhrt werden soll, **angewiesen ist** (wie eine Make-Datei oder eine Terraform-Konfiguration).
* **√ñffentliche PPE oder 3PE**: In einigen F√§llen k√∂nnen die Pipelines von Benutzern ausgel√∂st werden, die **keinen Schreibzugriff im Repository haben** (und m√∂glicherweise nicht einmal Teil der Organisation sind), da sie einen PR senden k√∂nnen.
* **3PE-Befehlsinjektion**: Normalerweise werden CI/CD-Pipelines **Umgebungsvariablen** mit **Informationen √ºber den PR** setzen. Wenn dieser Wert von einem Angreifer kontrolliert werden kann (wie der Titel des PR) und an einer **gef√§hrlichen Stelle** verwendet wird (wie das Ausf√ºhren von **sh-Befehlen**), k√∂nnte ein Angreifer **Befehle einschleusen**.

### Ausnutzungsvorteile

Nachdem die 3 Varianten zum Vergiften einer Pipeline bekannt sind, schauen wir uns an, was ein Angreifer nach einer erfolgreichen Ausnutzung erhalten k√∂nnte:

* **Geheimnisse**: Wie bereits erw√§hnt, erfordern Pipelines **Berechtigungen** f√ºr ihre Jobs (den Code abrufen, erstellen, bereitstellen...) und diese Berechtigungen werden normalerweise in Geheimnissen **erteilt**. Diese Geheimnisse sind normalerweise √ºber **Umgebungsvariablen oder Dateien im System** zug√§nglich. Daher wird ein Angreifer immer versuchen, so viele Geheimnisse wie m√∂glich zu exfiltrieren.
* Je nach Pipeline-Plattform **muss der Angreifer die Geheimnisse in der Konfiguration angeben**. Das bedeutet, dass, wenn der Angreifer die CI-Konfigurationspipeline nicht √§ndern kann (**I-PPE** zum Beispiel), er **nur die Geheimnisse exfiltrieren kann, die die Pipeline hat**.
* **Berechnung**: Der Code wird irgendwo ausgef√ºhrt, je nachdem, wo er ausgef√ºhrt wird, k√∂nnte ein Angreifer weiter pivotieren.
* **On-Premises**: Wenn die Pipelines vor Ort ausgef√ºhrt werden, k√∂nnte ein Angreifer in einem **internen Netzwerk mit Zugriff auf mehr Ressourcen** enden.
* **Cloud**: Der Angreifer k√∂nnte auf **andere Maschinen in der Cloud** zugreifen, aber auch IAM-Rollen/Servicekonten **Tokens exfiltrieren**, um **weiteren Zugriff innerhalb der Cloud** zu erhalten.
* **Plattformmaschine**: Manchmal werden die Jobs innerhalb der **Plattformmaschinen der Pipelines** ausgef√ºhrt, die normalerweise in einer Cloud ohne weiteren Zugriff sind.
* **Ausw√§hlen**: Manchmal wird die **Pipelines-Plattform mehrere Maschinen konfiguriert haben**, und wenn Sie **die CI-Konfigurationsdatei √§ndern k√∂nnen**, k√∂nnen Sie **angeben, wo Sie den b√∂sartigen Code ausf√ºhren m√∂chten**. In dieser Situation wird ein Angreifer wahrscheinlich auf jeder m√∂glichen Maschine eine Reverse-Shell ausf√ºhren, um versuchen, sie weiter auszunutzen.
* **Produktionskompromittierung**: Wenn Sie sich in der Pipeline befinden und die endg√ºltige Version erstellt und von dort bereitgestellt wird, k√∂nnten Sie **den Code kompromittieren, der letztendlich in der Produktion ausgef√ºhrt wird**.
## Weitere relevante Informationen

### Tools & CIS Benchmark

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) ist ein Open-Source-Tool zur √úberpr√ºfung Ihres Software-Lieferketten-Stacks auf Sicherheitskonformit√§t basierend auf einem neuen [**CIS Software Supply Chain Benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). Die √úberpr√ºfung konzentriert sich auf den gesamten SDLC-Prozess, bei dem Risiken von der Codierungszeit bis zur Bereitstellungszeit aufgedeckt werden k√∂nnen.

### Top 10 CI/CD Sicherheitsrisiken

Lesen Sie diesen interessanten Artikel √ºber die Top 10 CI/CD-Risiken gem√§√ü Cider: [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

* Auf jeder Plattform, die Sie lokal ausf√ºhren k√∂nnen, finden Sie Anleitungen zur lokalen Ausf√ºhrung, damit Sie sie nach Ihren W√ºnschen konfigurieren und testen k√∂nnen.
* Gitea + Jenkins Lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Automatische Tools

* [**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** ist ein statisches Code-Analysetool f√ºr Infrastruktur als Code.

## Referenzen

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben** oder **HackTricks im PDF-Format herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
