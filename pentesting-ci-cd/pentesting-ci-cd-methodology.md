# Pentesting CI/CD 方法论

<details>

<summary><strong>从零开始学习 AWS 黑客攻防直到成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF** 版本，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## 引言

开发环境已成为当今攻击面的重要组成部分。在这些环境中，最有价值的资产是负责 **CI 和 CD** 的系统——构建、测试和部署代码的系统——它们通常拥有对组织最关键资产的 **秘密和访问权限**。因此，攻击者自然会不断寻找新方法来获取这些系统的访问权限。

### VCS

VCS 代表 **版本控制系统**，这些系统允许开发者 **管理他们的源代码**。最常见的是 **git**，你通常会发现公司在以下 **平台** 中使用它：

* Github
* Gitlab
* Bitbucket
* Gitea
* 云服务提供商（他们提供自己的 VCS 平台）

### Pipelines

Pipelines 允许开发者 **自动执行代码**（用于构建、测试、部署等目的）在某些操作发生后：一个推送、一个 PR、cron... 它们对于 **自动化从开发到生产的所有步骤** 非常有用。

然而，这些系统需要在 **某个地方执行**，通常需要 **具有部署代码的特权凭证**。

## VCS 渗透测试方法论

{% hint style="info" %}
即使一些 VCS 平台允许创建 pipelines，但在本节中，我们将仅分析对源代码控制的潜在攻击。
{% endhint %}

包含项目源代码的平台包含敏感信息，人们需要非常小心在这个平台内授予的权限。这些是 VCS 平台中常见的问题，攻击者可以滥用：

* **泄露**：如果您的代码在提交中包含泄露，并且攻击者可以访问仓库（因为它是公开的或者他有访问权限），他可以发现泄露。
* **访问**：如果攻击者可以 **访问 VCS 平台内的账户**，他可以获得 **更多的可见性和权限**。
* **注册**：一些平台将允许外部用户创建账户。
* **SSO**：一些平台不允许用户注册，但允许任何人使用有效的 SSO 访问（因此攻击者可以使用他的 github 账户进入，例如）。
* **凭证**：用户名+密码、个人令牌、ssh 密钥、Oauth 令牌、cookies... 用户可以窃取几种类型的令牌以某种方式访问仓库。
* **Webhooks**：VCS 平台允许生成 webhooks。如果它们 **没有用不可见的秘密保护**，**攻击者可以滥用它们**。
* 如果没有设置秘密，攻击者可以滥用第三方平台的 webhook
* 如果秘密在 URL 中，情况也是如此，攻击者还拥有秘密
* **代码妥协**：如果恶意行为者有某种 **写** 访问权限在仓库上，他可以尝试 **注入恶意代码**。为了成功，他可能需要 **绕过分支保护**。这些行动可以出于不同的目标而执行：
* 妥协主分支以 **妥协生产**。
* 妥协主分支（或其他分支）以 **妥协开发者的机器**（因为他们通常在他们的机器上执行测试、terraform 或仓库内的其他事情）。
* **妥协 pipeline**（查看下一节）

## Pipelines 渗透测试方法论

定义 pipeline 的最常见方式是使用 **CI 配置文件托管在仓库中**，pipeline 构建。这个文件描述了执行作业的顺序、影响流程的条件和构建环境设置。\
这些文件通常有一个一致的名称和格式，例如 — Jenkinsfile（Jenkins）、.gitlab-ci.yml（GitLab）、.circleci/config.yml（CircleCI）以及位于 .github/workflows 下的 GitHub Actions YAML 文件。当触发时，pipeline 作业 **拉取代码** 从选定的源（例如提交 / 分支），并 **运行 CI 配置文件中指定的命令** 针对那些代码。

因此，攻击者的终极目标是以某种方式 **妥协这些配置文件** 或他们执行的 **命令**。

### PPE - 毒化 Pipeline 执行

毒化 Pipeline 执行（PPE）向量 **滥用对 SCM 仓库的权限**，以一种导致 CI pipeline 执行恶意命令的方式。拥有权限 **操纵 CI 配置文件，或其他 CI pipeline 作业依赖的文件** 的用户，可以修改它们以包含 **恶意命令**，最终“毒化”执行这些命令的 CI pipeline。

为了成功执行 PPE 攻击，恶意行为者需要能够：

* 拥有 **对 VCS 平台的写访问权限**，因为通常当执行推送或拉取请求时会触发 pipelines。（检查 VCS 渗透测试方法论以获取访问方式的摘要）。
* 请注意，有时 **外部 PR 计为“写访问权限”**。
* 即使他拥有写权限，他也需要确保他可以 **修改 CI 配置文件或配置依赖的其他文件**。
* 为此，他可能需要能够 **绕过分支保护**。

有 3 种 PPE 口味：

* **D-PPE**：**直接 PPE** 攻击发生在行为者 **修改将要执行的 CI 配置** 文件时。
* **I-DDE**：**间接 PPE** 攻击发生在行为者 **修改** 一个 CI 配置文件将要执行 **依赖的文件** 时（如 make 文件或 terraform 配置）。
* **公共 PPE 或 3PE**：在某些情况下，pipelines 可以由 **没有在仓库中拥有写访问权限的用户触发**（他们甚至可能不是组织的一部分），因为他们可以发送 PR。
* **3PE 命令注入**：通常，CI/CD pipelines 会 **设置环境变量** 与 **关于 PR 的信息**。如果攻击者可以控制该值（如 PR 的标题）并且在 **危险的地方使用**（如执行 **sh 命令**），攻击者可能 **在那里注入命令**。
### 利用的好处

了解了三种污染管道的方式，让我们看看攻击者在成功利用后能获得什么：

* **秘密**：如前所述，管道需要**权限**来执行它们的工作（检索代码，构建它，部署它...），这些权限通常是**以秘密的形式授予的**。这些秘密通常可以通过**系统内的环境变量或文件**访问。因此，攻击者将始终尝试尽可能多地泄露秘密。
* 根据管道平台，攻击者**可能需要在配置中指定秘密**。这意味着如果攻击者不能修改CI配置管道（例如**I-PPE**），他只能**泄露管道拥有的秘密**。
* **计算资源**：代码在某处执行，根据执行地点，攻击者可能能够进一步渗透。
* **本地部署**：如果管道在本地执行，攻击者可能会结束在**内部网络中，可以访问更多资源**。
* **云**：攻击者可以访问**云中的其他机器**，但也可以**泄露**IAM角色/服务账户**令牌**，以在云内获得**进一步的访问权限**。
* **平台机器**：有时工作将在**管道平台机器内**执行，这些机器通常位于一个**没有更多访问权限的云中**。
* **选择它**：有时**管道平台会配置多台机器**，如果你可以**修改CI配置文件**，你可以**指示你想在哪里运行恶意代码**。在这种情况下，攻击者可能会在每台可能的机器上运行反向Shell，以尝试进一步利用它。
* **危害生产环境**：如果你在管道内部，最终版本是从中构建和部署的，你可以**危害最终将在生产环境中运行的代码**。

## 更多相关信息

### 工具 & CIS 基准

* \*\*\*\*[**Chain-bench**](https://github.com/aquasecurity/chain-bench) 是一个开源工具，用于根据新的[**CIS 软件供应链基准**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf)对你的软件供应链堆栈进行安全合规性审计。审计关注整个SDLC过程，可以揭示从代码时间到部署时间的风险。

### CI/CD 安全风险前十

查看这篇关于Cider按照的前10个CI/CD风险的有趣文章：[https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### 实验室

* 在每个你可以在本地运行的平台上，你会发现如何在本地启动它，这样你就可以根据你的需要配置它进行测试
* Gitea + Jenkins 实验室：[https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### 自动化工具

* \*\*\*\*[**Checkov**](https://github.com/bridgecrewio/checkov)：**Checkov** 是一个用于基础设施即代码的静态代码分析工具。

## 参考资料

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks中看到你的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。**

</details>
