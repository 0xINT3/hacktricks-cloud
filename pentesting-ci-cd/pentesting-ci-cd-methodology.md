# Pentesting CI/CD Methodology

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい**場合や、**PEASS の最新バージョンを入手したい**場合、または HackTricks を PDF でダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを楽しみましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに **PR を提出**することで、自分のハッキングテクニックを共有しましょう。

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## はじめに

開発環境は、現代の攻撃対象の主要な部分となっています。そして、その中でも最も収益性の高い資産は、コードのビルド、テスト、デプロイを担当するシステムであり、通常は組織の最も重要な資産へのアクセス権限を持っています。そのため、攻撃者はこれらのシステムへのアクセス手段を常に探し続けています。

### VCS

VCS は **Version Control System** の略で、開発者が **ソースコードを管理**するためのシステムです。最も一般的なものは **git** であり、以下のいずれかの **プラットフォーム** を使用している企業が一般的です。

* Github
* Gitlab
* Bitbucket
* Gitea
* クラウドプロバイダ（独自の VCS プラットフォームを提供している）

### パイプライン

パイプラインは、開発者がコードの実行を **自動化する**ためのものです（ビルド、テスト、デプロイなどの目的で）。特定のアクションが発生した後に、コードの実行を自動化するために使用されます。例えば、プッシュ、PR、cron などです。これらのシステムは、通常、コードをデプロイするための **特権のある資格情報** で **どこかで実行する必要があります**。

## VCS ペンテスト方法論

{% hint style="info" %}
一部の VCS プラットフォームでは、このセクションでパイプラインを作成できる場合がありますが、ここではソースコードの制御に対する潜在的な攻撃のみを分析します。
{% endhint %}

プロジェクトのソースコードを含むプラットフォームには、機密情報が含まれており、このプラットフォーム内で許可される権限には非常に注意する必要があります。攻撃者が悪用できる可能性のある VCS プラットフォーム全般の一般的な問題は次のとおりです。

* **情報漏洩**: コードに情報漏洩が含まれており、攻撃者がリポジトリにアクセスできる場合（公開されているか、アクセス権限を持っている場合）、情報漏洩を発見することができます。
* **アクセス**: 攻撃者が **VCS プラットフォーム内のアカウントにアクセス**できる場合、**より多くの可視性と権限**を得ることができます。
* **登録**: 一部のプラットフォームでは、外部ユーザーがアカウントを作成できるようになっています。
* **SSO**: 一部のプラットフォームでは、ユーザーが登録できない場合でも、有効な SSO でアクセスできるようになっています（たとえば、GitHub アカウントを使用してアクセスできる場合など）。
* **資格情報**: ユーザーが盗むことができるユーザー名+パスワード、パーソナルトークン、SSH キー、OAuth トークン、クッキーなど、さまざまな種類のトークンがあります。これらのトークンを盗んでリポジトリにあるいくつかの方法でアクセスすることができます。
* **Webhook**: VCS プラットフォームでは、Webhook を生成することができます。これらが **非表示のシークレットで保護されていない**場合、**攻撃者はこれらを悪用**することができます。
* シークレットが設定されていない場合、攻撃者はサードパーティプラットフォームの Webhook を悪用することができます。
* シークレットが URL に含まれている場合、同じことが起こり、攻撃者はシークレットも持っています。
* **コードの侵害**: 悪意のあるアクターがリポジトリ上である種の **書き込み** アクセス権を持っている場合、悪意のあるコードを **注入** しようとすることができます。成功するためには、通常は **ブランチの保護をバイパス** する必要があります。これらのアクションは、さまざまな目的で実行できます。
* メインブランチを **侵害して本番環境を侵害**する。
* メインブランチ（または他のブランチ）を **侵害して開発者のマシンを侵害**する（通常、開発者はリポジトリ内でテスト、Terraform などを実行します）。
* パイプラインを **侵害する**（次のセクションを参照）

## パイプラインのペンテスト方法論

パイプラインを定義する最も一般的な方法は、パイプラインをビルドするリポジトリにホストされている **CI 設定ファイルを使用する**ことです。このファイルは、実行されるジョブの順序、フローに影響を与える条件、およびビルド環境の設定を記述します。\
これらのファイルには、一貫した名前と形式があります。たとえば、Jenkinsfile（Jenkins）、.gitlab-ci.yml（GitLab）、.circleci/config.yml（CircleCI）、および .github/workflows 内にある GitHub Actions の YAML ファイルです。パイプラインジョブがトリガーされると、パイプラインは選択したソース（コミット/ブランチなど）からコードを **取得** し、CI 設定ファイルで指定されたコマンドをそのコードに対して実行します。

したがって、攻撃者の究極の目標は、これらの設定ファイルをいかにして **侵害するか**、または **実行されるコマンドを侵害するか** です
### Exploitation Benefits

3つのパイプラインを汚染する方法を知ったら、攻撃者が成功した後に得られるものを確認しましょう：

- **シークレット**：前述のように、パイプラインはジョブのために**特権**を必要とします（コードの取得、ビルド、デプロイなど）。そして、これらの特権は通常、**シークレット**で与えられます。これらのシークレットは通常、**環境変数やシステム内のファイル**を介してアクセス可能です。したがって、攻撃者はできるだけ多くのシークレットを外部に持ち出そうとします。
- パイプラインプラットフォームによっては、攻撃者が**設定ファイルでシークレットを指定する必要がある**場合があります。これは、攻撃者がCI構成パイプライン（たとえばI-PPE）を変更できない場合、そのパイプラインにあるシークレットのみを外部に持ち出すことができることを意味します。
- **計算**：コードはどこかで実行されますが、実行される場所によっては、攻撃者がさらに進行することができるかもしれません。
- **オンプレミス**：パイプラインがオンプレミスで実行される場合、攻撃者は**より多くのリソースにアクセスできる内部ネットワーク**に入る可能性があります。
- **クラウド**：攻撃者は**クラウド内の他のマシン**にアクセスできるだけでなく、IAMロール/サービスアカウント**トークン**を**クラウド内でさらなるアクセスを得るために外部に持ち出す**こともできます。
- **プラットフォームのマシン**：ジョブは**パイプラインプラットフォームのマシン**で実行されることがあり、通常は**それ以上のアクセス権限はありません**。
- **選択する**：**パイプラインプラットフォームには複数のマシンが設定されている**場合があり、CI構成ファイルを**変更できる場合は、悪意のあるコードを実行する場所を指定**することができます。この状況では、攻撃者はおそらく各可能なマシンで逆シェルを実行してさらなる攻撃を試みるでしょう。
- **本番環境の侵害**：パイプライン内にいて、最終バージョンがビルドされ、本番環境で実行されるコードを**侵害する**ことができます。

## より関連性の高い情報

### ツールとCISベンチマーク

- [**Chain-bench**](https://github.com/aquasecurity/chain-bench)は、新しい[**CISソフトウェアサプライチェーンベンチマーク**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf)に基づいて、ソフトウェアサプライチェーンスタックのセキュリティコンプライアンスを監査するためのオープンソースツールです。監査は、コードの時間からデプロイの時間までのSDLCプロセス全体に焦点を当ててリスクを明らかにすることができます。

### Top 10 CI/CDセキュリティリスク

Ciderによると、次の記事にはCI/CDのトップ10のセキュリティリスクについて興味深い情報があります：[https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### ラボ

- ローカルで実行できる各プラットフォームについては、テストするために自分で構成できるようにする方法が記載されています。
- Gitea + Jenkinsラボ：[https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### 自動ツール

- [**Checkov**](https://github.com/bridgecrewio/checkov)：**Checkov**は、インフラストラクチャコードの静的コード解析ツールです。

## 参考文献

- [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

- **HackTricksで会社を宣伝**したい場合や、**最新バージョンのPEASSを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください。
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
