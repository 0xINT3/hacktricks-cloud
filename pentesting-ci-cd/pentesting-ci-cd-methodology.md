# M√©thodologie de Pentesting CI/CD

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux repos github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## VCS

VCS signifie **Version Control System**, ces syst√®mes permettent aux d√©veloppeurs de **g√©rer leur code source**. Le plus courant est **git** et vous trouverez g√©n√©ralement des entreprises qui l'utilisent sur l'une des **plateformes** suivantes :

* Github
* Gitlab
* Bitbucket
* Gitea
* Fournisseurs de cloud (ils offrent leurs propres plateformes VCS)

## Pipelines

Les pipelines permettent aux d√©veloppeurs d'**automatiser l'ex√©cution du code** (pour la construction, les tests, le d√©ploiement...) apr√®s certaines actions : un push, une PR, un cron... Ils sont extr√™mement utiles pour **automatiser toutes les √©tapes du d√©veloppement √† la production**.

Cependant, ces syst√®mes doivent √™tre **ex√©cut√©s quelque part** et g√©n√©ralement avec des **identifiants privil√©gi√©s pour d√©ployer le code**.

## M√©thodologie de Pentesting VCS

{% hint style="info" %}
M√™me si certaines plateformes VCS permettent de cr√©er des pipelines, pour cette section, nous allons analyser uniquement les attaques potentielles sur le contr√¥le du code source.
{% endhint %}

Les plateformes qui contiennent le code source de votre projet contiennent des informations sensibles et il faut √™tre tr√®s prudent avec les permissions accord√©es √† l'int√©rieur de cette plateforme. Voici quelques probl√®mes courants sur les plateformes VCS que les attaquants pourraient exploiter :

* **Fuites** : Si votre code contient des fuites dans les commits et que l'attaquant peut acc√©der au d√©p√¥t (parce qu'il est public ou parce qu'il y a acc√®s), il pourrait d√©couvrir les fuites.
* **Acc√®s** : Si un attaquant peut **acc√©der √† un compte √† l'int√©rieur de la plateforme VCS**, il pourrait obtenir **plus de visibilit√© et de permissions**.
* **Inscription** : Certaines plateformes permettront simplement aux utilisateurs externes de cr√©er un compte.
* **SSO** : Certaines plateformes n'autoriseront pas les utilisateurs √† s'inscrire, mais permettront √† quiconque d'acc√©der avec un SSO valide (donc un attaquant pourrait utiliser son compte github pour entrer par exemple).
* **Identifiants** : Nom d'utilisateur+Mot de passe, tokens personnels, cl√©s ssh, tokens Oauth, cookies... il existe plusieurs types de tokens qu'un utilisateur pourrait voler pour acc√©der d'une mani√®re ou d'une autre √† un d√©p√¥t.
* **Webhooks** : Les plateformes VCS permettent de g√©n√©rer des webhooks. S'ils ne sont **pas prot√©g√©s** par des secrets non visibles, un **attaquant pourrait en abuser**.
* Si aucun secret n'est en place, l'attaquant pourrait abuser du webhook de la plateforme tierce
* Si le secret est dans l'URL, la m√™me chose se produit et l'attaquant a aussi le secret
* **Compromission du code** : Si un acteur malveillant a un certain type d'acc√®s en **√©criture** sur les d√©p√¥ts, il pourrait essayer d'**injecter du code malveillant**. Pour r√©ussir, il pourrait avoir besoin de **contourner les protections de branche**. Ces actions peuvent √™tre effectu√©es avec diff√©rents objectifs en t√™te :
* Compromettre la branche principale pour **compromettre la production**.
* Compromettre la branche principale (ou d'autres branches) pour **compromettre les machines des d√©veloppeurs** (car ils ex√©cutent g√©n√©ralement des tests, terraform ou d'autres choses √† l'int√©rieur du d√©p√¥t sur leurs machines).
* **Compromettre le pipeline** (voir la section suivante)

## M√©thodologie de Pentesting des Pipelines

La mani√®re la plus courante de d√©finir un pipeline est d'utiliser un **fichier de configuration CI h√©berg√© dans le d√©p√¥t** que le pipeline construit. Ce fichier d√©crit l'ordre des t√¢ches ex√©cut√©es, les conditions qui affectent le flux et les param√®tres de l'environnement de construction.\
Ces fichiers ont g√©n√©ralement un nom et un format coh√©rents, par exemple ‚Äî Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), et les fichiers YAML de GitHub Actions situ√©s sous .github/workflows. Lorsqu'il est d√©clench√©, le travail du pipeline **r√©cup√®re le code** de la source s√©lectionn√©e (par exemple, commit / branche), et **ex√©cute les commandes sp√©cifi√©es dans le fichier de configuration CI** contre ce code.

Par cons√©quent, l'objectif ultime de l'attaquant est de compromettre d'une mani√®re ou d'une autre **ces fichiers de configuration** ou les **commandes qu'ils ex√©cutent**.

### PPE - Ex√©cution de Pipeline Empoisonn√©

Le chemin d'Ex√©cution de Pipeline Empoisonn√© (PPE) exploite les permissions dans un d√©p√¥t SCM pour manipuler un pipeline CI et ex√©cuter des commandes nuisibles. Les utilisateurs disposant des permissions n√©cessaires peuvent modifier les fichiers de configuration CI ou d'autres fichiers utilis√©s par le travail du pipeline pour inclure des commandes malveillantes. Cela "empoisonne" le pipeline CI, conduisant √† l'ex√©cution de ces commandes malveillantes.

Pour qu'un acteur malveillant r√©ussisse une attaque PPE, il doit √™tre capable de :

* Avoir **un acc√®s en √©criture √† la plateforme VCS**, car g√©n√©ralement les pipelines sont d√©clench√©s lorsqu'un push ou une pull request est effectu√©. (Voir la m√©thodologie de pentesting VCS pour un r√©sum√© des moyens d'obtenir l'acc√®s).
* Notez que parfois, une **PR externe compte comme un "acc√®s en √©criture"**.
* M√™me s'il a des permissions d'√©criture, il doit √™tre s√ªr de pouvoir **modifier le fichier de configuration CI ou d'autres fichiers sur lesquels la configuration repose**.
* Pour cela, il pourrait avoir besoin de pouvoir **contourner les protections de branche**.

Il existe 3 saveurs de PPE :

* **D-PPE** : Une attaque PPE **Directe** se produit lorsque l'acteur **modifie le fichier de configuration CI** qui va √™tre ex√©cut√©.
* **I-DDE** : Une attaque PPE **Indirecte** se produit lorsque l'acteur **modifie** un **fichier** sur lequel le fichier de configuration CI qui va √™tre ex√©cut√© **repose** (comme un fichier make ou une configuration terraform).
* **PPE Public ou 3PE** : Dans certains cas, les pipelines peuvent √™tre **d√©clench√©s par des utilisateurs qui n'ont pas d'acc√®s en √©criture dans le d√©p√¥t** (et qui pourraient m√™me ne pas faire partie de l'organisation) parce qu'ils peuvent envoyer une PR.
* **Injection de Commande 3PE** : Habituellement, les pipelines CI/CD vont **d√©finir des variables d'environnement** avec des **informations sur la PR**. Si cette valeur peut √™tre contr√¥l√©e par un attaquant (comme le titre de la PR) et est **utilis√©e** dans un **endroit dangereux** (comme l'ex√©cution de **commandes sh**), un attaquant pourrait **injecter des commandes l√†-dedans**.

### Avantages de l'Exploitation

Connaissant les 3 saveurs pour empoisonner un pipeline, examinons ce qu'un attaquant pourrait obtenir apr√®s une exploitation r√©ussie :

* **Secrets** : Comme mentionn√© pr√©c√©demment, les pipelines n√©cessitent des **privil√®ges** pour leurs t√¢ches (r√©cup√©rer le code, le construire, le d√©ployer...) et ces privil√®ges sont g√©n√©ralement **accord√©s dans des secrets**. Ces secrets sont g√©n√©ralement accessibles via des **variables d'environnement ou des fichiers √† l'int√©rieur du syst√®me**. Par cons√©quent, un attaquant essaiera toujours d'exfiltrer autant de secrets que possible.
* Selon la plateforme de pipeline, l'attaquant **pourrait avoir besoin de sp√©cifier les secrets dans la configuration**. Cela signifie que si l'attaquant ne peut pas modifier la configuration du pipeline CI (**I-PPE** par exemple), il pourrait **seulement exfiltrer les secrets que ce pipeline poss√®de**.
* **Calcul** : Le code est ex√©cut√© quelque part, selon l'endroit o√π il est ex√©cut√©, un attaquant pourrait √™tre en mesure de pivoter davantage.
* **Sur site** : Si les pipelines sont ex√©cut√©s sur site, un attaquant pourrait se retrouver dans un **r√©seau interne avec acc√®s √† plus de ressources**.
* **Cloud** : L'attaquant pourrait acc√©der √† **d'autres machines dans le cloud** mais pourrait √©galement **exfiltrer** des tokens de r√¥les IAM/comptes de service **√† partir de celui-ci pour obtenir un acc√®s plus approfondi dans le cloud**.
* **Machine de la plateforme** : Parfois, les t√¢ches seront ex√©cut√©es √† l'int√©rieur des **machines de la plateforme de pipelines**, qui sont g√©n√©ralement dans un cloud avec **pas plus d'acc√®s**.
* **S√©lectionnez-le** : Parfois, la **plateforme de pipelines aura configur√© plusieurs machines** et si vous pouvez **modifier le fichier de configuration CI**, vous pouvez **indiquer o√π vous voulez ex√©cuter le code malveillant**. Dans cette situation, un attaquant ex√©cutera probablement un shell invers√© sur chaque machine possible pour essayer de l'exploiter davantage.
* **Compromettre la production** : Si vous √™tes √† l'int√©rieur du pipeline et que la version finale est construite et d√©ploy√©e √† partir de celui-ci, vous pourriez **compromettre le code qui va finir par s'ex√©cuter en production**.

## Plus d'infos pertinentes

### Outils & Benchmark CIS

* [**Chain-bench**](https://github.com/aquasecurity/chain-bench) est un outil open-source pour auditer votre pile de cha√Æne d'approvisionnement logicielle pour la conformit√© √† la s√©curit√© bas√©e sur un nouveau [**benchmark CIS Software Supply Chain**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). L'audit se concentre sur l'ensemble du processus SDLC, o√π il peut r√©v√©ler des risques du temps de code au temps de d√©ploiement.

### Top 10 des Risques de S√©curit√© CI/CD

Consultez cet article int√©ressant sur les 10 principaux risques CI/CD selon Cider : [**https://www.cidersecurity.io/top-10-cicd-security-risks/**](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

* Sur chaque plateforme que vous pouvez ex√©cuter localement, vous trouverez comment la lancer localement afin de pouvoir la configurer comme vous le souhaitez pour la tester
* Gitea + Jenkins lab : [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Outils Automatiques

* [**Checkov**](https://github.com/bridgecrewio/checkov) : **Checkov** est un outil d'analyse statique de code pour l'infrastructure en tant que code.

## R√©f√©rences

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux repos github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
