---
description: >-
  En la metodolog칤a de pentesting CI/CD de HackTricks, encontrar치 c칩mo pentestear la infraestructura relacionada con las actividades de CI/CD.
---

# Metodolog칤a de Pentesting CI/CD

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, 춰consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Introducci칩n

Los entornos de desarrollo se han convertido en una parte importante de la superficie de ataque actual. Y dentro de ellos, los activos m치s lucrativos son los sistemas responsables de **CI y CD** - aquellos que construyen, prueban y despliegan c칩digo - y que t칤picamente poseen los **secretos y el acceso** a los activos m치s cr칤ticos de la organizaci칩n. Por lo tanto, es natural que los atacantes est칠n continuamente buscando nuevas formas de acceder a estos sistemas.

### VCS

VCS significa **Version Control System**, estos sistemas permiten a los desarrolladores **gestionar su c칩digo fuente**. El m치s com칰n es **git** y normalmente encontrar치s empresas que lo utilizan en una de las siguientes **plataformas**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Proveedores de la nube (ofrecen sus propias plataformas VCS)

### Pipelines

Los pipelines permiten a los desarrolladores **automatizar la ejecuci칩n de c칩digo** (para fines de construcci칩n, prueba, despliegue, etc.) despu칠s de que ocurren ciertas acciones: un push, una PR, cron... Son muy 칰tiles para **automatizar todos los pasos desde el desarrollo hasta la producci칩n**.

Sin embargo, estos sistemas necesitan ser **ejecutados en alg칰n lugar** y normalmente con **credenciales privilegiadas para desplegar c칩digo**.

## Metodolog칤a de Pentesting VCS

{% hint style="info" %}
Incluso si algunas plataformas VCS permiten crear pipelines para esta secci칩n, vamos a analizar s칩lo los posibles ataques al control del c칩digo fuente.
{% endhint %}

Las plataformas que contienen el c칩digo fuente de su proyecto contienen informaci칩n sensible y las personas deben ser muy cuidadosas con los permisos concedidos dentro de esta plataforma. Estos son algunos problemas comunes en las plataformas VCS que un atacante podr칤a aprovechar:

* **Fugas**: Si su c칩digo contiene fugas en los commits y el atacante puede acceder al repositorio (porque es p칰blico o porque tiene acceso), podr칤a descubrir las fugas.
* **Acceso**: Si un atacante puede **acceder a una cuenta dentro de la plataforma VCS**, podr칤a obtener **m치s visibilidad y permisos**.
  * **Registro**: Algunas plataformas permitir치n a los usuarios externos crear una cuenta.
  * **SSO**: Algunas plataformas no permitir치n a los usuarios registrarse, pero permitir치n a cualquiera acceder con un SSO v치lido (por lo que un atacante podr칤a usar su cuenta de github para entrar, por ejemplo).
  * **Credenciales**: Nombre de usuario + contrase침a, tokens personales, claves ssh, tokens Oauth, cookies... hay varios tipos de tokens que un usuario podr칤a robar para acceder de alguna manera a un repositorio.
* **Webhooks**: Las plataformas VCS permiten generar webhooks. Si no est치n **protegidos** con secretos no visibles, un **atacante podr칤a abusar de ellos**.
  * Si no hay secreto en su lugar, el atacante podr칤a abusar del webhook de la plataforma de terceros.
  * Si el secreto est치 en la URL, lo mismo sucede y el atacante tambi칠n tiene el secreto.
* **Compromiso del c칩digo**: Si un actor malintencionado tiene alg칰n tipo de acceso de **escritura** sobre los repositorios, podr칤a intentar **inyectar c칩digo malicioso**. Para tener 칠xito, podr칤a necesitar **burlar las protecciones de la rama**. Estas acciones se pueden realizar con diferentes objetivos en mente:
  * Comprometer la rama principal para **comprometer la producci칩n**.
  * Comprometer la rama principal (u otras ramas) para **comprometer las m치quinas de los desarrolladores** (ya que suelen ejecutar pruebas, terraform o otras cosas dentro del repositorio en sus m치quinas).
  * **Comprometer el pipeline** (ver siguiente secci칩n)

## Metodolog칤a de Pentesting Pipelines

La forma m치s com칰n de definir un pipeline es mediante el uso de un **archivo de configuraci칩n de CI alojado en el repositorio** que construye el pipeline. Este archivo describe el orden de los trabajos ejecutados, las condiciones que afectan al flujo y la configuraci칩n del entorno de construcci칩n.\
Estos archivos suelen tener un nombre y formato consistentes, por ejemplo - Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), y los archivos YAML de GitHub Actions ubicados en .github/workflows. Cuando se activa, el trabajo del pipeline **extrae el c칩digo** de la fuente seleccionada (por ejemplo, commit / rama) y **ejecuta los comandos especificados en el archivo de configuraci칩n de CI** contra ese c칩digo.

Por lo tanto, el objetivo final del atacante es de alguna manera **comprometer esos archivos de configuraci칩n** o los **comandos que ejecutan**.

### PPE - Ejecuci칩n de Pipeline Envenenado

El vector de Ejecuci칩n de Pipeline Envenenado (PPE) **abusa de los permisos contra un repositorio SCM**, de tal manera que hace que un pipeline de CI ejecute comandos maliciosos. Los usuarios que tienen permisos para **manipular los archivos de configuraci칩n de CI, u otros archivos en los que el trabajo del pipeline de CI depende**, pueden modificarlos para contener **comandos maliciosos**, en 칰ltima instancia "envenenando" el pipeline de CI que ejecuta estos comandos.

Para que un actor malintencionado tenga 칠xito realizando un ataque PPE, necesita ser capaz de:

* Tener **acceso de escritura a la plataforma VCS**, ya que normalmente los pipelines se activan cuando se realiza un push o una solicitud de extracci칩n. (Consulte la metodolog칤a de pentesting VCS para obtener un resumen de las formas de obtener acceso).
  * Tenga en cuenta que a veces una **PR externa cuenta como "acceso de escritura"**.
* Incluso si tiene permisos de escritura, necesita estar seguro de que puede **modificar el archivo de configuraci칩n de CI o otros archivos en los que se basa la configuraci칩n**.
  * Para ello, puede necesitar ser capaz de **burlar las protecciones de la rama**.

Hay 3 sabores de PPE:

* **D-PPE**: Un ataque **Direct PPE** ocurre cuando el actor **modifica el archivo de configuraci칩n de CI** que se va a ejecutar.
* **I-DDE**: Un ataque **Indirect PPE** ocurre cuando el actor **modifica** un **archivo** en el que el archivo de configuraci칩n de CI que se va a ejecutar **depende** (como un archivo make o una configuraci칩n de terraform).
* **PPE p칰blico o 3PE**: En algunos casos, los pipelines pueden ser **activados por usuarios que no tienen acceso de escritura en el repositorio** (y que quiz치s ni siquiera formen parte de la organizaci칩n) porque pueden enviar una PR.
  * **Inyecci칩n de comandos 3PE**: Por lo general, los pipelines de CI/CD **establecer치n variables de entorno** con **informaci칩n sobre la PR**. Si ese valor puede ser controlado por un atacante (como el t칤tulo de la PR) y se **utiliza** en un **lugar peligroso** (como la ejecuci칩n de **comandos sh**), un atacante podr칤a **inyectar comandos all칤**.
### Beneficios de la explotaci칩n

Conociendo los 3 m칠todos para envenenar un pipeline, veamos lo que un atacante podr칤a obtener despu칠s de una explotaci칩n exitosa:

* **Secretos**: Como se mencion칩 anteriormente, los pipelines requieren **privilegios** para sus trabajos (recuperar el c칩digo, construirlo, implementarlo...) y estos privilegios suelen ser **concedidos en secretos**. Estos secretos suelen ser accesibles a trav칠s de **variables de entorno o archivos dentro del sistema**. Por lo tanto, un atacante siempre intentar치 extraer tantos secretos como sea posible.
  * Dependiendo de la plataforma del pipeline, el atacante **podr칤a necesitar especificar los secretos en la configuraci칩n**. Esto significa que si el atacante no puede modificar la configuraci칩n del pipeline de CI (**I-PPE**, por ejemplo), solo podr칤a **extraer los secretos que tiene ese pipeline**.
* **C칩mputo**: El c칩digo se ejecuta en alg칰n lugar, dependiendo de d칩nde se ejecute, un atacante podr칤a ser capaz de pivotar a칰n m치s.
  * **On-Premises**: Si los pipelines se ejecutan en las instalaciones, un atacante podr칤a terminar en una **red interna con acceso a m치s recursos**.
  * **Cloud**: El atacante podr칤a acceder a **otras m치quinas en la nube**, pero tambi칠n podr칤a **extraer** roles IAM/cuentas de servicio **tokens** de ella para obtener **acceso adicional dentro de la nube**.
  * **M치quinas de la plataforma**: A veces, los trabajos se ejecutar치n dentro de las **m치quinas de la plataforma de pipelines**, que suelen estar dentro de una nube sin **m치s acceso**.
  * **Seleccionarlo:** A veces, la **plataforma de pipelines tendr치 varias m치quinas configuradas** y si se puede **modificar el archivo de configuraci칩n de CI**, se puede **indicar d칩nde se desea ejecutar el c칩digo malicioso**. En esta situaci칩n, un atacante probablemente ejecutar치 un shell inverso en cada m치quina posible para intentar explotarla a칰n m치s.
* **Comprometer la producci칩n**: Si est치s dentro del pipeline y la versi칩n final se construye e implementa desde 칠l, podr칤as **comprometer el c칩digo que va a terminar ejecut치ndose en producci칩n**.

## M치s informaci칩n relevante

### Herramientas y CIS Benchmark

* ****[**Chain-bench**](https://github.com/aquasecurity/chain-bench) es una herramienta de c칩digo abierto para auditar su pila de cadena de suministro de software para el cumplimiento de seguridad basado en un nuevo [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). La auditor칤a se centra en todo el proceso de SDLC, donde puede revelar riesgos desde el tiempo de c칩digo hasta el tiempo de implementaci칩n.

### Los 10 principales riesgos de seguridad de CI/CD

Consulte este interesante art칤culo sobre los 10 principales riesgos de CI/CD seg칰n Cider: [https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratorios

* En cada plataforma que se pueda ejecutar localmente, encontrar치 c칩mo lanzarla localmente para que pueda configurarla como desee para probarla.
* Laboratorio de Gitea + Jenkins: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Herramientas autom치ticas

* ****[**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** es una herramienta de an치lisis de c칩digo est치tico para infraestructura como c칩digo.&#x20;

## Referencias

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, 춰consulte los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>