# Metodolog√≠a de Pentesting CI/CD

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## Introducci√≥n

Los entornos de desarrollo se han convertido en una parte importante de la superficie de ataque actual. Dentro de ellos, los activos m√°s lucrativos son los sistemas responsables de **CI y CD** ‚Äî aquellos que construyen, prueban y despliegan c√≥digo ‚Äî y t√≠picamente poseen los **secretos y accesos** a los activos m√°s cr√≠ticos de la organizaci√≥n. Por lo tanto, es natural que los atacantes est√©n continuamente buscando nuevas formas de acceder a estos sistemas.

### VCS

VCS significa **Sistema de Control de Versiones**, estos sistemas permiten a los desarrolladores **gestionar su c√≥digo fuente**. El m√°s com√∫n es **git** y normalmente encontrar√°s empresas que lo utilizan en una de las siguientes **plataformas**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Proveedores de la nube (ofrecen sus propias plataformas VCS)

### Pipelines

Los pipelines permiten a los desarrolladores **automatizar la ejecuci√≥n de c√≥digo** (para construir, probar, desplegar... prop√≥sitos) despu√©s de que ciertas acciones ocurren: Un push, un PR, cron... Son extremadamente √∫tiles para **automatizar todos los pasos desde el desarrollo hasta la producci√≥n**.

Sin embargo, estos sistemas necesitan ser **ejecutados en alg√∫n lugar** y usualmente con **credenciales privilegiadas para desplegar c√≥digo**.

## Metodolog√≠a de Pentesting VCS

{% hint style="info" %}
Aunque algunas plataformas VCS permiten crear pipelines, en esta secci√≥n vamos a analizar solo posibles ataques al control del c√≥digo fuente.
{% endhint %}

Las plataformas que contienen el c√≥digo fuente de tu proyecto contienen informaci√≥n sensible y la gente necesita ser muy cuidadosa con los permisos otorgados dentro de esta plataforma. Estos son algunos problemas comunes en las plataformas VCS que un atacante podr√≠a abusar:

* **Leaks**: Si tu c√≥digo contiene leaks en los commits y el atacante puede acceder al repositorio (porque es p√∫blico o porque tiene acceso), podr√≠a descubrir los leaks.
* **Acceso**: Si un atacante puede **acceder a una cuenta dentro de la plataforma VCS** podr√≠a obtener **m√°s visibilidad y permisos**.
* **Registro**: Algunas plataformas simplemente permiten a usuarios externos crear una cuenta.
* **SSO**: Algunas plataformas no permiten a los usuarios registrarse, pero permiten a cualquiera acceder con un SSO v√°lido (as√≠ que un atacante podr√≠a usar su cuenta de github para entrar, por ejemplo).
* **Credenciales**: Nombre de usuario+Contrase√±a, tokens personales, claves ssh, tokens Oauth, cookies... hay varios tipos de tokens que un usuario podr√≠a robar para acceder de alguna manera a un repositorio.
* **Webhooks**: Las plataformas VCS permiten generar webhooks. Si **no est√°n protegidos** con secretos no visibles un **atacante podr√≠a abusar de ellos**.
* Si no hay un secreto en su lugar, el atacante podr√≠a abusar del webhook de la plataforma de terceros
* Si el secreto est√° en la URL, ocurre lo mismo y el atacante tambi√©n tiene el secreto
* **Compromiso del c√≥digo:** Si un actor malicioso tiene alg√∫n tipo de acceso de **escritura** sobre los repositorios, podr√≠a intentar **inyectar c√≥digo malicioso**. Para tener √©xito podr√≠a necesitar **burlar las protecciones de rama**. Estas acciones pueden realizarse con diferentes objetivos en mente:
* Comprometer la rama principal para **comprometer la producci√≥n**.
* Comprometer la rama principal (u otras ramas) para **comprometer las m√°quinas de los desarrolladores** (ya que suelen ejecutar pruebas, terraform u otras cosas dentro del repositorio en sus m√°quinas).
* **Comprometer el pipeline** (ver la siguiente secci√≥n)

## Metodolog√≠a de Pentesting de Pipelines

La forma m√°s com√∫n de definir un pipeline es utilizando un **archivo de configuraci√≥n CI alojado en el repositorio** que el pipeline construye. Este archivo describe el orden de los trabajos ejecutados, las condiciones que afectan el flujo y la configuraci√≥n del entorno de construcci√≥n.\
Estos archivos t√≠picamente tienen un nombre y formato consistentes, por ejemplo ‚Äî Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), y los archivos YAML de GitHub Actions ubicados bajo .github/workflows. Cuando se activa, el trabajo del pipeline **extrae el c√≥digo** de la fuente seleccionada (por ejemplo, commit / rama), y **ejecuta los comandos especificados en el archivo de configuraci√≥n CI** contra ese c√≥digo.

Por lo tanto, el objetivo final del atacante es de alguna manera **comprometer esos archivos de configuraci√≥n** o los **comandos que ejecutan**.

### PPE - Ejecuci√≥n de Pipeline Envenenado

El vector de Ejecuci√≥n de Pipeline Envenenado (PPE) **abusa de los permisos contra un repositorio SCM**, de una manera que causa que un pipeline CI ejecute comandos maliciosos. Los usuarios que tienen permisos para **manipular los archivos de configuraci√≥n CI, u otros archivos en los que se basa el trabajo del pipeline CI**, pueden modificarlos para contener **comandos maliciosos**, en √∫ltima instancia "envenenando" el pipeline CI que ejecuta estos comandos.

Para que un actor malicioso tenga √©xito realizando un ataque PPE necesita poder:

* Tener **acceso de escritura a la plataforma VCS**, ya que normalmente los pipelines se activan cuando se realiza un push o un pull request. (Consulta la metodolog√≠a de pentesting VCS para un resumen de formas de obtener acceso).
* Tener en cuenta que a veces un **PR externo cuenta como "acceso de escritura"**.
* Incluso si tiene permisos de escritura, necesita estar seguro de que puede **modificar el archivo de configuraci√≥n CI u otros archivos en los que se basa la configuraci√≥n**.
* Para esto, podr√≠a necesitar ser capaz de **burlar las protecciones de rama**.

Hay 3 sabores de PPE:

* **D-PPE**: Un ataque **PPE Directo** ocurre cuando el actor **modifica el archivo de configuraci√≥n CI** que va a ser ejecutado.
* **I-DDE**: Un ataque **PPE Indirecto** ocurre cuando el actor **modifica** un **archivo** en el que se basa el archivo de configuraci√≥n CI que va a ser ejecutado (como un archivo make o una configuraci√≥n de terraform).
* **PPE P√∫blico o 3PE**: En algunos casos los pipelines pueden ser **activados por usuarios que no tienen acceso de escritura en el repositorio** (y que incluso podr√≠an no ser parte de la organizaci√≥n) porque pueden enviar un PR.
* **Inyecci√≥n de Comandos 3PE**: Normalmente, los pipelines CI/CD **establecer√°n variables de entorno** con **informaci√≥n sobre el PR**. Si ese valor puede ser controlado por un atacante (como el t√≠tulo del PR) y se **utiliza** en un lugar **peligroso** (como ejecutar **comandos sh**), un atacante podr√≠a **inyectar comandos all√≠**.
### Beneficios de la Explotaci√≥n

Conociendo los 3 sabores para envenenar un pipeline, veamos qu√© podr√≠a obtener un atacante despu√©s de una explotaci√≥n exitosa:

* **Secretos**: Como se mencion√≥ anteriormente, los pipelines requieren **privilegios** para sus trabajos (recuperar el c√≥digo, construirlo, desplegarlo...) y estos privilegios suelen **otorgarse en secretos**. Estos secretos suelen ser accesibles a trav√©s de **variables de entorno o archivos dentro del sistema**. Por lo tanto, un atacante siempre intentar√° exfiltrar tantos secretos como sea posible.
* Dependiendo de la plataforma del pipeline, el atacante **podr√≠a necesitar especificar los secretos en la configuraci√≥n**. Esto significa que si el atacante no puede modificar la configuraci√≥n del CI (**I-PPE** por ejemplo), podr√≠a **solo exfiltrar los secretos que ese pipeline tiene**.
* **Computaci√≥n**: El c√≥digo se ejecuta en alg√∫n lugar, dependiendo de d√≥nde se ejecute, un atacante podr√≠a ser capaz de pivotar a√∫n m√°s.
* **On-Premises**: Si los pipelines se ejecutan localmente, un atacante podr√≠a terminar en una **red interna con acceso a m√°s recursos**.
* **Cloud**: El atacante podr√≠a acceder a **otras m√°quinas en la nube** pero tambi√©n podr√≠a **exfiltrar** tokens de roles de IAM/cuentas de servicio **de ella para obtener** **m√°s acceso dentro de la nube**.
* **M√°quinas de la plataforma**: A veces los trabajos se ejecutar√°n dentro de las **m√°quinas de la plataforma de pipelines**, que generalmente est√°n dentro de una nube con **sin m√°s acceso**.
* **Seleccionarlo**: A veces, la **plataforma de pipelines tendr√° configuradas varias m√°quinas** y si puedes **modificar el archivo de configuraci√≥n de CI** puedes **indicar d√≥nde quieres ejecutar el c√≥digo malicioso**. En esta situaci√≥n, un atacante probablemente ejecutar√° un reverse shell en cada m√°quina posible para intentar explotarla a√∫n m√°s.
* **Comprometer la producci√≥n**: Si est√°s dentro del pipeline y la versi√≥n final se construye y despliega desde √©l, podr√≠as **comprometer el c√≥digo que terminar√° ejecut√°ndose en producci√≥n**.

## M√°s informaci√≥n relevante

### Herramientas y CIS Benchmark

* \*\*\*\*[**Chain-bench**](https://github.com/aquasecurity/chain-bench) es una herramienta de c√≥digo abierto para auditar tu pila de suministro de software para cumplimiento de seguridad basado en un nuevo [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). La auditor√≠a se centra en todo el proceso de SDLC, donde puede revelar riesgos desde el tiempo de c√≥digo hasta el tiempo de despliegue.

### Top 10 Riesgos de Seguridad en CI/CD

Consulta este interesante art√≠culo sobre los 10 principales riesgos de CI/CD seg√∫n Cider: [https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Labs

* En cada plataforma que puedas ejecutar localmente encontrar√°s c√≥mo lanzarla localmente para que puedas configurarla como quieras para probarla
* Gitea + Jenkins lab: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Herramientas Autom√°ticas

* \*\*\*\*[**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** es una herramienta de an√°lisis de c√≥digo est√°tico para infraestructura como c√≥digo.

## Referencias

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
