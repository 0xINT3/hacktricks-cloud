# M√©thodologie de test d'intrusion CI/CD

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## Introduction

Les environnements de d√©veloppement sont devenus une partie importante de la surface d'attaque d'aujourd'hui. Et parmi eux, les actifs les plus lucratifs sont les syst√®mes responsables de **CI et CD** - ceux qui construisent, testent et d√©ploient du code - et qui poss√®dent g√©n√©ralement les **secrets et les acc√®s** aux actifs les plus critiques de l'organisation. Il est donc naturel que les attaquants soient constamment √† la recherche de nouvelles fa√ßons d'acc√©der √† ces syst√®mes.

### VCS

VCS signifie **Version Control System**, ces syst√®mes permettent aux d√©veloppeurs de **g√©rer leur code source**. Le plus courant est **git** et vous trouverez g√©n√©ralement des entreprises l'utilisant sur l'une des **plateformes** suivantes :

* Github
* Gitlab
* Bitbucket
* Gitea
* Fournisseurs de services cloud (ils proposent leurs propres plateformes VCS)

### Pipelines

Les pipelines permettent aux d√©veloppeurs d'**automatiser l'ex√©cution du code** (pour la construction, les tests, le d√©ploiement...). Ils sont tr√®s utiles pour **automatiser toutes les √©tapes du d√©veloppement √† la production**.

Cependant, ces syst√®mes doivent √™tre **ex√©cut√©s quelque part** et g√©n√©ralement avec des **informations d'identification privil√©gi√©es pour d√©ployer du code**.

## M√©thodologie de test d'intrusion VCS

{% hint style="info" %}
M√™me si certaines plateformes VCS permettent de cr√©er des pipelines, dans cette section, nous allons analyser uniquement les attaques potentielles sur le contr√¥le du code source.
{% endhint %}

Les plateformes qui contiennent le code source de votre projet contiennent des informations sensibles et les personnes doivent √™tre tr√®s prudentes quant aux autorisations accord√©es sur cette plateforme. Voici quelques probl√®mes courants sur les plateformes VCS que les attaquants pourraient exploiter :

* **Fuites** : Si votre code contient des fuites dans les commits et que l'attaquant peut acc√©der au d√©p√¥t (car il est public ou parce qu'il a acc√®s), il pourrait d√©couvrir les fuites.
* **Acc√®s** : Si un attaquant peut **acc√©der √† un compte sur la plateforme VCS**, il pourrait obtenir **plus de visibilit√© et d'autorisations**.
* **Enregistrement** : Certaines plateformes permettent uniquement aux utilisateurs externes de cr√©er un compte.
* **SSO** : Certaines plateformes n'autorisent pas les utilisateurs √† s'inscrire, mais permettent √† n'importe qui d'acc√©der avec un SSO valide (ainsi, un attaquant pourrait utiliser son compte GitHub pour entrer, par exemple).
* **Informations d'identification** : Nom d'utilisateur + mot de passe, jetons personnels, cl√©s SSH, jetons OAuth, cookies... il existe plusieurs types de jetons qu'un utilisateur pourrait voler pour acc√©der d'une mani√®re ou d'une autre √† un d√©p√¥t.
* **Webhooks** : Les plateformes VCS permettent de g√©n√©rer des webhooks. Si ceux-ci ne sont pas prot√©g√©s par des secrets invisibles, un **attaquant pourrait les exploiter**.
* Si aucun secret n'est en place, l'attaquant pourrait exploiter le webhook de la plateforme tierce.
* Si le secret est dans l'URL, il en va de m√™me et l'attaquant a √©galement le secret.
* **Compromission du code** : Si un acteur malveillant dispose d'un certain type d'acc√®s en **√©criture** sur les d√©p√¥ts, il pourrait essayer d'**injecter un code malveillant**. Pour r√©ussir, il pourrait avoir besoin de **contourner les protections de branche**. Ces actions peuvent √™tre effectu√©es avec diff√©rents objectifs en t√™te :
* Compromettre la branche principale pour **compromettre la production**.
* Compromettre la branche principale (ou d'autres branches) pour **compromettre les machines des d√©veloppeurs** (car ils ex√©cutent g√©n√©ralement des tests, du terraform ou d'autres choses √† l'int√©rieur du d√©p√¥t sur leurs machines).
* **Compromettre le pipeline** (voir la section suivante)

## M√©thodologie de test d'intrusion des pipelines

La fa√ßon la plus courante de d√©finir un pipeline est d'utiliser un **fichier de configuration CI h√©berg√© dans le d√©p√¥t** sur lequel le pipeline est construit. Ce fichier d√©crit l'ordre des t√¢ches ex√©cut√©es, les conditions qui affectent le flux et les param√®tres de l'environnement de construction.\
Ces fichiers ont g√©n√©ralement un nom et un format coh√©rents, par exemple - Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI), et les fichiers YAML des actions GitHub situ√©s sous .github/workflows. Lorsqu'il est d√©clench√©, le travail du pipeline **r√©cup√®re le code** √† partir de la source s√©lectionn√©e (par exemple - commit / branche) et **ex√©cute les commandes sp√©cifi√©es dans le fichier de configuration CI** sur ce code.

Par cons√©quent, l'objectif ultime de l'attaquant est de **compromettre d'une mani√®re ou d'une autre ces fichiers de configuration** ou les **commandes qu'ils ex√©cutent**.

### PPE - Poisoned Pipeline Execution

Le vecteur d'ex√©cution de pipeline empoisonn√© (PPE) **exploite les autorisations contre un r√©f√©rentiel SCM**, de mani√®re √† ce qu'un pipeline CI ex√©cute des commandes malveillantes. Les utilisateurs qui ont les autorisations pour **manipuler les fichiers de configuration CI ou d'autres fichiers sur lesquels le travail du pipeline CI repose** peuvent les modifier pour y inclure des commandes malveillantes, "empoisonnant" ainsi le pipeline CI en ex√©cutant ces commandes.

Pour qu'un acteur malveillant r√©ussisse √† effectuer une attaque PPE, il doit √™tre capable de :

* Avoir **un acc√®s en √©criture √† la plateforme VCS**, car les pipelines sont g√©n√©ralement d√©clench√©s lorsqu'une pouss√©e ou une demande de tirage est effectu√©e. (Consultez la m√©thodologie de test d'intrusion VCS pour un r√©sum√© des moyens d'obtenir l'acc√®s).
* Notez que parfois, une **demande de tirage externe compte comme un "acc√®s en √©criture"**.
* M√™me s'il dispose des autorisations d'√©criture, il doit √™tre s√ªr de pouvoir **modifier le fichier de configuration CI ou d'autres fichiers sur lesquels la configuration repose**.
* Pour cela, il pourrait avoir besoin de pouvoir **contourner les protections de branche**.

Il existe 3 variantes de PPE :

* **D-PPE** : Une attaque **Direct PPE** se produit lorsque l'acteur **modifie le fichier de configuration CI** qui va √™tre ex√©cut√©.
* **I-DDE** : Une attaque **Indirect PPE** se produit lorsque l'acteur **modifie un fichier** sur lequel le fichier de configuration CI qui va √™tre ex√©cut√© **repose** (comme un fichier make ou une configuration terraform).
* **PPE public ou 3PE** : Dans certains cas, les pipelines peuvent √™tre **d√©clench√©s par des utilisateurs qui n'ont pas d'acc√®s en √©criture dans le d√©p√¥t** (et qui pourraient ne pas faire partie de l'organisation) car ils peuvent envoyer une demande de tirage.
* **Injection de commande 3PE** : G√©n√©ralement, les pipelines CI/CD **d√©finiront des variables d'environnement** avec des **informations sur la demande de tirage**. Si cette valeur peut √™tre contr√¥l√©e par un attaquant (comme le titre de la demande de tirage) et est **utilis√©e** √† un **endroit dangereux** (comme l'ex√©cution de **commandes sh**), un attaquant pourrait **injecter des commandes** √† cet endroit.
### Avantages de l'exploitation

En connaissant les 3 m√©thodes pour empoisonner un pipeline, voyons ce qu'un attaquant pourrait obtenir apr√®s une exploitation r√©ussie :

* **Secrets** : Comme mentionn√© pr√©c√©demment, les pipelines n√©cessitent des **privil√®ges** pour leurs t√¢ches (r√©cup√©rer le code, le construire, le d√©ployer...) et ces privil√®ges sont g√©n√©ralement accord√©s dans des **secrets**. Ces secrets sont g√©n√©ralement accessibles via des **variables d'environnement ou des fichiers dans le syst√®me**. Par cons√©quent, un attaquant essaiera toujours d'exfiltrer autant de secrets que possible.
* Selon la plateforme du pipeline, l'attaquant **pourrait avoir besoin de sp√©cifier les secrets dans la configuration**. Cela signifie que si l'attaquant ne peut pas modifier la configuration du pipeline CI (par exemple, I-PPE), il ne pourra **exfiltrer que les secrets que ce pipeline poss√®de**.
* **Calcul** : Le code est ex√©cut√© quelque part, selon l'endroit o√π il est ex√©cut√©, un attaquant pourrait √™tre en mesure de pivoter davantage.
* **Sur site** : Si les pipelines sont ex√©cut√©s sur site, un attaquant pourrait se retrouver dans un **r√©seau interne avec acc√®s √† plus de ressources**.
* **Cloud** : L'attaquant pourrait acc√©der √† **d'autres machines dans le cloud**, mais il pourrait √©galement **exfiltrer** des **jetons de r√¥les IAM/comptes de service** √† partir de celui-ci pour obtenir **un acc√®s suppl√©mentaire √† l'int√©rieur du cloud**.
* **Machine de la plateforme** : Parfois, les t√¢ches seront ex√©cut√©es √† l'int√©rieur des **machines de la plateforme des pipelines**, qui se trouvent g√©n√©ralement dans un cloud sans **autre acc√®s**.
* **S√©lectionner** : Parfois, la **plateforme des pipelines sera configur√©e avec plusieurs machines** et si vous pouvez **modifier le fichier de configuration CI**, vous pouvez **indiquer o√π vous souhaitez ex√©cuter le code malveillant**. Dans cette situation, un attaquant ex√©cutera probablement un shell invers√© sur chaque machine possible pour essayer de l'exploiter davantage.
* **Compromettre la production** : Si vous √™tes √† l'int√©rieur du pipeline et que la version finale est construite et d√©ploy√©e √† partir de celui-ci, vous pourriez **compromettre le code qui va finir par s'ex√©cuter en production**.

## Informations suppl√©mentaires pertinentes

### Outils et r√©f√©rentiel CIS

* \*\*\*\*[**Chain-bench**](https://github.com/aquasecurity/chain-bench) est un outil open source pour auditer votre pile de cha√Æne d'approvisionnement logicielle en mati√®re de conformit√© de s√©curit√©, bas√© sur un nouveau [**r√©f√©rentiel CIS pour la cha√Æne d'approvisionnement logicielle**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). L'audit se concentre sur l'ensemble du processus du cycle de vie du d√©veloppement logiciel, o√π il peut r√©v√©ler les risques depuis le moment du code jusqu'au d√©ploiement.

### Top 10 des risques de s√©curit√© CI/CD

Consultez cet article int√©ressant sur les 10 principaux risques CI/CD selon Cider : [https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laboratoires

* Sur chaque plateforme que vous pouvez ex√©cuter localement, vous trouverez comment le lancer localement afin de pouvoir le configurer comme vous le souhaitez pour le tester.
* Laboratoire Gitea + Jenkins : [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Outils automatiques

* \*\*\*\*[**Checkov**](https://github.com/bridgecrewio/checkov) : **Checkov** est un outil d'analyse de code statique pour l'infrastructure en tant que code.

## R√©f√©rences

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**d√©p√¥ts GitHub de HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
