# Metodologia de Pentesting CI/CD

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## Introdu√ß√£o

Os ambientes de desenvolvimento se tornaram uma parte importante da superf√≠cie de ataque atual. E dentro deles, os ativos mais lucrativos s√£o os sistemas respons√°veis pelo **CI e CD** - aqueles que constroem, testam e implantam c√≥digo - e geralmente possuem os **segredos e acesso** aos ativos mais cr√≠ticos da organiza√ß√£o. Portanto, √© natural que os atacantes estejam constantemente procurando maneiras novas de obter acesso a esses sistemas.

### VCS

VCS significa **Version Control System** (Sistema de Controle de Vers√£o), esses sistemas permitem que os desenvolvedores **gerenciem seu c√≥digo-fonte**. O mais comum √© o **git** e voc√™ geralmente encontrar√° empresas usando-o em uma das seguintes **plataformas**:

* Github
* Gitlab
* Bitbucket
* Gitea
* Provedores de nuvem (eles oferecem suas pr√≥prias plataformas VCS)

### Pipelines

As pipelines permitem que os desenvolvedores **automatizem a execu√ß√£o de c√≥digo** (para constru√ß√£o, teste, implanta√ß√£o...). Elas s√£o extremamente √∫teis para **automatizar todas as etapas do desenvolvimento √† produ√ß√£o**.

No entanto, esses sistemas precisam ser **executados em algum lugar** e geralmente com **credenciais privilegiadas para implantar c√≥digo**.

## Metodologia de Pentesting VCS

{% hint style="info" %}
Mesmo que algumas plataformas VCS permitam criar pipelines, nesta se√ß√£o vamos analisar apenas ataques potenciais ao controle do c√≥digo-fonte.
{% endhint %}

As plataformas que cont√™m o c√≥digo-fonte do seu projeto cont√™m informa√ß√µes sens√≠veis e as pessoas precisam ter muito cuidado com as permiss√µes concedidas dentro dessa plataforma. Esses s√£o alguns problemas comuns em plataformas VCS que um atacante pode abusar:

* **Vazamentos**: Se o seu c√≥digo cont√©m vazamentos nos commits e o atacante pode acessar o reposit√≥rio (porque √© p√∫blico ou porque ele tem acesso), ele pode descobrir os vazamentos.
* **Acesso**: Se um atacante pode **acessar uma conta dentro da plataforma VCS**, ele pode obter **mais visibilidade e permiss√µes**.
* **Registro**: Algumas plataformas permitem que apenas usu√°rios externos criem uma conta.
* **SSO**: Algumas plataformas n√£o permitem que os usu√°rios se registrem, mas permitem que qualquer pessoa acesse com um SSO v√°lido (ent√£o um atacante pode usar sua conta do GitHub, por exemplo).
* **Credenciais**: Nome de usu√°rio + senha, tokens pessoais, chaves ssh, tokens Oauth, cookies... existem v√°rios tipos de tokens que um usu√°rio pode roubar para acessar de alguma forma um reposit√≥rio.
* **Webhooks**: As plataformas VCS permitem gerar webhooks. Se eles n√£o estiverem **protegidos** com segredos n√£o vis√≠veis, um **atacante pode abusar deles**.
* Se nenhum segredo estiver em vigor, o atacante pode abusar do webhook da plataforma de terceiros.
* Se o segredo estiver na URL, o mesmo acontece e o atacante tamb√©m tem o segredo.
* **Comprometimento de c√≥digo**: Se um ator malicioso tiver algum tipo de acesso de **escrita** nos reposit√≥rios, ele pode tentar **injetar c√≥digo malicioso**. Para ter sucesso, ele pode precisar **burlar as prote√ß√µes de branch**. Essas a√ß√µes podem ser realizadas com diferentes objetivos em mente:
* Comprometer o branch principal para **comprometer a produ√ß√£o**.
* Comprometer o branch principal (ou outros branches) para **comprometer as m√°quinas dos desenvolvedores** (pois eles geralmente executam testes, terraform ou outras coisas dentro do reposit√≥rio em suas m√°quinas).
* **Comprometer a pipeline** (verifique a pr√≥xima se√ß√£o)

## Metodologia de Pentesting de Pipelines

A maneira mais comum de definir uma pipeline √© usando um **arquivo de configura√ß√£o de CI hospedado no reposit√≥rio** em que a pipeline √© constru√≠da. Este arquivo descreve a ordem dos jobs executados, as condi√ß√µes que afetam o fluxo e as configura√ß√µes do ambiente de constru√ß√£o.\
Esses arquivos geralmente t√™m um nome e formato consistentes, por exemplo - Jenkinsfile (Jenkins), .gitlab-ci.yml (GitLab), .circleci/config.yml (CircleCI) e os arquivos YAML do GitHub Actions localizados em .github/workflows. Quando acionada, a tarefa da pipeline **extrai o c√≥digo** da origem selecionada (por exemplo, commit / branch) e **executa os comandos especificados no arquivo de configura√ß√£o de CI** contra esse c√≥digo.

Portanto, o objetivo final do atacante √© de alguma forma **comprometer esses arquivos de configura√ß√£o** ou os **comandos que eles executam**.

### PPE - Execu√ß√£o de Pipeline Envenenada

O vetor de Execu√ß√£o de Pipeline Envenenada (PPE) **abusa das permiss√µes em um reposit√≥rio SCM**, de forma que faz com que uma pipeline de CI execute comandos maliciosos. Usu√°rios que t√™m permiss√µes para **manipular os arquivos de configura√ß√£o de CI ou outros arquivos nos quais a tarefa da pipeline de CI depende**, podem modific√°-los para conter **comandos maliciosos**, "envenenando" assim a pipeline de CI que executa esses comandos.

Para que um ator malicioso tenha sucesso em realizar um ataque PPE, ele precisa ser capaz de:

* Ter **acesso de escrita √† plataforma VCS**, pois as pipelines geralmente s√£o acionadas quando um push ou uma pull request √© feita. (Verifique a metodologia de pentesting VCS para um resumo das maneiras de obter acesso).
* Observe que √†s vezes um **PR externo conta como "acesso de escrita"**.
* Mesmo que ele tenha permiss√µes de escrita, ele precisa ter certeza de que pode **modificar o arquivo de configura√ß√£o de CI ou outros arquivos nos quais a configura√ß√£o depende**.
* Para isso, ele pode precisar ser capaz de **burlar as prote√ß√µes de branch**.

Existem 3 sabores de PPE:

* **D-PPE**: Um ataque **Direto PPE** ocorre quando o ator **modifica o arquivo de configura√ß√£o de CI** que ser√° executado.
* **I-DDE**: Um ataque **Indireto PPE** ocorre quando o ator **modifica um arquivo** no qual o arquivo de configura√ß√£o de CI que ser√° executado **depende** (como um arquivo make ou uma configura√ß√£o terraform).
* **PPE P√∫blico ou 3PE**: Em alguns casos, as pipelines podem ser **acionadas por usu√°rios que n√£o t√™m acesso de escrita no reposit√≥rio** (e que podem nem fazer parte da organiza√ß√£o) porque eles podem enviar um PR.
* **Inje√ß√£o de Comando 3PE**: Geralmente, as pipelines CI/CD ir√£o **definir vari√°veis de ambiente** com **informa√ß√µes sobre o PR**. Se esse valor puder ser controlado por um atacante (como o t√≠tulo do PR) e for **usado** em um **local perigoso** (como a execu√ß√£o de **comandos sh**), um atacante pode **injetar comandos l√°**.
### Benef√≠cios da Explora√ß√£o

Conhecendo as 3 formas de envenenar um pipeline, vamos verificar o que um atacante poderia obter ap√≥s uma explora√ß√£o bem-sucedida:

* **Segredos**: Como mencionado anteriormente, os pipelines requerem **privil√©gios** para suas tarefas (recuperar o c√≥digo, constru√≠-lo, implant√°-lo...) e esses privil√©gios geralmente s√£o **concedidos em segredos**. Esses segredos geralmente s√£o acess√≠veis por meio de **vari√°veis de ambiente ou arquivos dentro do sistema**. Portanto, um atacante sempre tentar√° extrair o m√°ximo de segredos poss√≠vel.
* Dependendo da plataforma do pipeline, o atacante **pode precisar especificar os segredos na configura√ß√£o**. Isso significa que, se o atacante n√£o puder modificar a configura√ß√£o do pipeline CI (**I-PPE**, por exemplo), ele poder√° **apenas extrair os segredos que o pipeline possui**.
* **Computa√ß√£o**: O c√≥digo √© executado em algum lugar, dependendo de onde √© executado, um atacante pode ser capaz de avan√ßar ainda mais.
* **Local**: Se os pipelines forem executados localmente, um atacante pode acabar em uma **rede interna com acesso a mais recursos**.
* **Nuvem**: O atacante pode acessar **outras m√°quinas na nuvem**, mas tamb√©m pode **extrair** tokens de **fun√ß√µes IAM/contas de servi√ßo** dela para obter **acesso adicional dentro da nuvem**.
* **M√°quinas da plataforma**: √Äs vezes, as tarefas ser√£o executadas dentro das **m√°quinas da plataforma de pipelines**, que geralmente est√£o em uma nuvem sem **mais acesso**.
* **Selecionar**: √Äs vezes, a **plataforma de pipelines ter√° v√°rias m√°quinas configuradas** e, se voc√™ puder **modificar o arquivo de configura√ß√£o do CI**, poder√° **indicar onde deseja executar o c√≥digo malicioso**. Nessa situa√ß√£o, um atacante provavelmente executar√° um shell reverso em cada m√°quina poss√≠vel para tentar explor√°-la ainda mais.
* **Comprometer a produ√ß√£o**: Se voc√™ estiver dentro do pipeline e a vers√£o final for constru√≠da e implantada a partir dele, voc√™ poder√° **comprometer o c√≥digo que ser√° executado na produ√ß√£o**.

## Mais informa√ß√µes relevantes

### Ferramentas e CIS Benchmark

* \*\*\*\*[**Chain-bench**](https://github.com/aquasecurity/chain-bench) √© uma ferramenta de c√≥digo aberto para auditoria da pilha de cadeia de suprimentos de software em conformidade com a seguran√ßa com base em um novo [**CIS Software Supply Chain benchmark**](https://github.com/aquasecurity/chain-bench/blob/main/docs/CIS-Software-Supply-Chain-Security-Guide-v1.0.pdf). A auditoria se concentra em todo o processo do SDLC, onde pode revelar riscos desde o tempo de c√≥digo at√© o tempo de implanta√ß√£o.

### Principais 10 Riscos de Seguran√ßa do CI/CD

Confira este artigo interessante sobre os 10 principais riscos do CI/CD de acordo com a Cider: [https://www.cidersecurity.io/top-10-cicd-security-risks/](https://www.cidersecurity.io/top-10-cicd-security-risks/)

### Laborat√≥rios

* Em cada plataforma que voc√™ pode executar localmente, voc√™ encontrar√° como inici√°-la localmente para poder configur√°-la como desejar para test√°-la.
* Laborat√≥rio Gitea + Jenkins: [https://github.com/cider-security-research/cicd-goat](https://github.com/cider-security-research/cicd-goat)

### Ferramentas Autom√°ticas

* \*\*\*\*[**Checkov**](https://github.com/bridgecrewio/checkov): **Checkov** √© uma ferramenta de an√°lise de c√≥digo est√°tico para infraestrutura como c√≥digo.

## Refer√™ncias

* [https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422](https://www.cidersecurity.io/blog/research/ppe-poisoned-pipeline-execution/?utm\_source=github\&utm\_medium=github\_page\&utm\_campaign=ci%2fcd%20goat\_060422)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
