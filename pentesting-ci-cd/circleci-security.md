# S√©curit√© de CircleCI

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts github.**

</details>

## Informations de base

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) est une plateforme d'int√©gration continue o√π vous pouvez **d√©finir des mod√®les** indiquant ce que vous voulez qu'il fasse avec du code et quand le faire. De cette fa√ßon, vous pouvez **automatiser les tests** ou les **d√©ploiements** directement **√† partir de la branche principale de votre r√©f√©rentiel**, par exemple.

## Autorisations

**CircleCI** **h√©rite des autorisations** de github et bitbucket li√©es au **compte** qui se connecte.\
Dans mes tests, j'ai v√©rifi√© que tant que vous avez des **autorisations d'√©criture sur le r√©f√©rentiel dans github**, vous pourrez **g√©rer ses param√®tres de projet dans CircleCI** (d√©finir de nouvelles cl√©s ssh, obtenir des cl√©s d'API de projet, cr√©er de nouvelles branches avec de nouvelles configurations CircleCI...).

Cependant, vous devez √™tre un **administrateur de r√©f√©rentiel** pour **convertir le r√©f√©rentiel en un projet CircleCI**.

## Variables d'environnement et secrets

Selon [**la documentation**](https://circleci.com/docs/2.0/env-vars/), il existe diff√©rentes fa√ßons de **charger des valeurs dans des variables d'environnement** √† l'int√©rieur d'un flux de travail.

### Variables d'environnement int√©gr√©es

Chaque conteneur ex√©cut√© par CircleCI aura toujours des [**variables d'environnement sp√©cifiques d√©finies dans la documentation**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) comme `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ou `CIRCLE_USERNAME`.

### Texte clair

Vous pouvez les d√©clarer en texte clair √† l'int√©rieur d'une **commande** :

```yaml
- run:
    name: "set and echo"
    command: |
        SECRET="Un secret"
        echo $SECRET
```

Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement d'ex√©cution** :

```yaml
- run:
    name: "set and echo"
    command: echo $SECRET
    environment:
        SECRET: Un secret
```

Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement de travail** :

```yaml
jobs:
    build-job:
        docker:
            - image: cimg/base:2020.01
    environment:
        SECRET: Un secret
```

Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement d'un conteneur** :

```yaml
jobs:
    build-job:
        docker:
            - image: cimg/base:2020.01
                environment:
                    SECRET: Un secret
```

### Secrets de projet

Ce sont des **secrets** qui ne seront accessibles que par le **projet** (par **n'importe quelle branche**).\
Vous pouvez les voir **d√©clar√©s dans** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
La fonctionnalit√© "**Import Variables**" permet d'**importer des variables d'autres projets** vers celui-ci.
{% endhint %}

### Secrets de contexte

Ce sont des secrets qui sont **propres √† l'organisation**. Par **d√©faut, n'importe quel r√©f√©rentiel** pourra **acc√©der √† n'importe quel secret** stock√© ici :

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Cependant, notez qu'un groupe diff√©rent (au lieu de tous les membres) peut √™tre **s√©lectionn√© pour ne donner acc√®s aux secrets qu'√† des personnes sp√©cifiques**.\
C'est actuellement l'un des meilleurs moyens d'**augmenter la s√©curit√© des secrets**, pour ne pas permettre √† tout le monde d'y acc√©der mais seulement √† certaines personnes.
{% endhint %}

## Attaques

### Recherche de secrets en texte clair

Si vous avez **acc√®s au VCS** (comme github), v√©rifiez le fichier `.circleci/config.yml` de **chaque r√©f√©rentiel sur chaque branche** et **recherchez** les **secrets en texte clair** potentiellement stock√©s l√†-dedans.

### √ânum√©ration des variables d'environnement secr√®tes et de contexte

En v√©rifiant le code, vous pouvez trouver **tous les noms de secrets** qui sont **utilis√©s** dans chaque fichier `.circleci/config.yml`. Vous pouvez √©galement obtenir les **noms de contexte** √† partir de ces fichiers ou les v√©rifier dans la console web : _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltration de secrets de projet

{% hint style="warning" %}
Pour **exfiltrer TOUS** les secrets de projet et de contexte, vous avez juste besoin d'avoir un acc√®s en **√âCRITURE** √† **un seul r√©f√©rentiel** dans toute l'organisation github (_et votre compte doit avoir acc√®s aux contextes mais par d√©faut, tout le monde peut acc√©der √† chaque contexte_).
{% endhint %}

{% hint style="danger" %}
La fonctionnalit√© "**Import Variables**" permet d'**importer des variables d'autres projets** vers celui-ci. Par cons√©quent, un attaquant pourrait **importer toutes les variables de projet de tous les r√©f√©rentiels** et ensuite **les exfiltrer toutes ensemble**.
{% endhint %}

Tous les secrets de projet sont toujours d√©finis dans l'environnement des travaux, donc en appelant env et en
### Persistence

* Il est possible de **cr√©er des jetons d'utilisateur dans CircleCI** pour acc√©der aux points d'API avec l'acc√®s de l'utilisateur.
  * _https://app.circleci.com/settings/user/tokens_
* Il est possible de **cr√©er des jetons de projet** pour acc√©der au projet avec les autorisations donn√©es au jeton.
  * _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Il est possible d'**ajouter des cl√©s SSH** aux projets.
  * _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Il est possible de **cr√©er une t√¢che cron dans une branche cach√©e** dans un projet inattendu qui **fuit** toutes les variables d'environnement de contexte tous les jours.
  * Ou m√™me cr√©er dans une branche / modifier une t√¢che connue qui **fuit** tous les contextes et les **secrets de projets** tous les jours.
* Si vous √™tes propri√©taire de Github, vous pouvez **autoriser les orbes non v√©rifi√©s** et en configurer un dans une t√¢che comme **porte d√©rob√©e**
* Vous pouvez trouver une **vuln√©rabilit√© d'injection de commande** dans certaines t√¢ches et **injecter des commandes** via un **secret** en modifiant sa valeur

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>