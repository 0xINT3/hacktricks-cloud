# Seguran√ßa do CircleCI

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes b√°sicas

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) √© uma plataforma de Integra√ß√£o Cont√≠nua onde voc√™ pode **definir modelos** indicando o que deseja que ele fa√ßa com algum c√≥digo e quando faz√™-lo. Dessa forma, voc√™ pode **automatizar testes** ou **implanta√ß√µes** diretamente **a partir do branch principal do seu reposit√≥rio**, por exemplo.

## Permiss√µes

**CircleCI** **herda as permiss√µes** do github e bitbucket relacionadas √† **conta** que faz login.\
Nos meus testes, verifiquei que, desde que voc√™ tenha **permiss√µes de grava√ß√£o sobre o reposit√≥rio no github**, voc√™ poder√° **gerenciar suas configura√ß√µes de projeto no CircleCI** (definir novas chaves ssh, obter chaves de api do projeto, criar novos branches com novas configura√ß√µes do CircleCI...).

No entanto, voc√™ precisa ser um **administrador do reposit√≥rio** para **converter o reposit√≥rio em um projeto CircleCI**.

## Vari√°veis de ambiente e segredos

De acordo com [**a documenta√ß√£o**](https://circleci.com/docs/2.0/env-vars/), existem diferentes maneiras de **carregar valores em vari√°veis de ambiente** dentro de um fluxo de trabalho.

### Vari√°veis de ambiente integradas

Cada cont√™iner executado pelo CircleCI sempre ter√° [**vari√°veis de ambiente espec√≠ficas definidas na documenta√ß√£o**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) como `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ou `CIRCLE_USERNAME`.

### Texto claro

Voc√™ pode declar√°-los em texto claro dentro de um **comando**:

```yaml
- run:
    name: "set and echo"
    command: |
        SECRET="Um segredo"
        echo $SECRET
```

Voc√™ pode declar√°-los em texto claro dentro do **ambiente de execu√ß√£o**:

```yaml
- run:
    name: "set and echo"
    command: echo $SECRET
    environment:
        SECRET: Um segredo
```

Voc√™ pode declar√°-los em texto claro dentro do **ambiente de trabalho de compila√ß√£o**:

```yaml
jobs:
    build-job:
        docker:
            - image: cimg/base:2020.01
    environment:
        SECRET: Um segredo
```

Voc√™ pode declar√°-los em texto claro dentro do **ambiente de um cont√™iner**:

```yaml
jobs:
    build-job:
        docker:
            - image: cimg/base:2020.01
                environment:
                    SECRET: Um segredo
```

### Segredos do projeto

Estes s√£o **segredos** que s√≥ v√£o ser **acess√≠veis** pelo **projeto** (por **qualquer branch**).\
Voc√™ pode v√™-los **declarados em** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
A funcionalidade "**Importar Vari√°veis**" permite **importar vari√°veis de outros projetos** para este.
{% endhint %}

### Segredos de contexto

Estes s√£o segredos que s√£o **da organiza√ß√£o inteira**. Por **padr√£o, qualquer reposit√≥rio** poder√° **acessar qualquer segredo** armazenado aqui:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
No entanto, observe que um grupo diferente (em vez de Todos os membros) pode ser **selecionado para dar acesso aos segredos apenas a pessoas espec√≠ficas**.\
Esta √© atualmente uma das melhores maneiras de **aumentar a seguran√ßa dos segredos**, para n√£o permitir que todos os acessem, mas apenas algumas pessoas.
{% endhint %}

## Ataques

### Buscar segredos em texto claro

Se voc√™ tem **acesso ao VCS** (como o github), verifique o arquivo `.circleci/config.yml` de **cada reposit√≥rio em cada branch** e **procure** por potenciais **segredos em texto claro** armazenados l√°.

### Enumera√ß√£o de vari√°veis de ambiente e contexto secretos

Verificando o c√≥digo, voc√™ pode encontrar **todos os nomes de segredos** que est√£o sendo **usados** em cada arquivo `.circleci/config.yml`. Voc√™ tamb√©m pode obter os **nomes de contexto** desses arquivos ou verific√°-los no console da web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltrar segredos do projeto

{% hint style="warning" %}
Para **exfiltrar TODOS** os **segredos do projeto e do contexto**, voc√™ s√≥ precisa ter **acesso de ESCRITA** a **apenas 1 reposit√≥rio** em toda a organiza√ß√£o do github (_e sua conta deve ter acesso aos contextos, mas por padr√£o, todos podem acessar todos os contextos_).
{% endhint %}

{% hint style="danger" %}
A funcionalidade "**Importar Vari√°veis**" permite **importar vari√°veis de outros projetos** para este. Portanto, um invasor poderia **importar todas as vari√°veis do projeto de todos os reposit√≥rios** e, em seguida, **exfiltrar todas juntas**.
{% endhint %}

Todos os segredos do projeto sempre s√£o definidos no ambiente dos trabalhos, ent√£o apenas chamando env e ofuscando em base64 exfiltrar√° os segredos no **console de log da web dos fluxos de trabalho**:

```yaml
version: 2.1

jobs:
  exfil-env:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: "Exfil env"
### Persist√™ncia

* √â poss√≠vel **criar tokens de usu√°rio no CircleCI** para acessar os pontos de extremidade da API com o acesso do usu√°rio.
  * _https://app.circleci.com/settings/user/tokens_
* √â poss√≠vel **criar tokens de projetos** para acessar o projeto com as permiss√µes concedidas ao token.
  * _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* √â poss√≠vel **adicionar chaves SSH** aos projetos.
  * _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* √â poss√≠vel **criar um trabalho cron em um branch oculto** em um projeto inesperado que est√° **vazando** todas as **vari√°veis de ambiente de contexto** todos os dias.
  * Ou at√© mesmo criar em um branch / modificar um trabalho conhecido que ir√° **vazar** todos os contextos e **segredos de projetos** todos os dias.
* Se voc√™ √© propriet√°rio do Github, pode **permitir orbs n√£o verificados** e configurar um em um trabalho como **backdoor**
* Voc√™ pode encontrar uma **vulnerabilidade de inje√ß√£o de comando** em alguma tarefa e **injetar comandos** via um **segredo** modificando seu valor

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>