# Seguran√ßa do Okta

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

[Okta, Inc.](https://www.okta.com/) √© reconhecida no setor de gerenciamento de identidade e acesso por suas solu√ß√µes de software baseadas em nuvem. Essas solu√ß√µes s√£o projetadas para simplificar e proteger a autentica√ß√£o do usu√°rio em v√°rias aplica√ß√µes modernas. Elas atendem n√£o apenas a empresas que visam proteger seus dados sens√≠veis, mas tamb√©m a desenvolvedores interessados em integrar controles de identidade em aplicativos, servi√ßos da web e dispositivos.

A oferta principal da Okta √© a **Okta Identity Cloud**. Esta plataforma engloba uma s√©rie de produtos, incluindo, mas n√£o se limitando a:

- **Single Sign-On (SSO)**: Simplifica o acesso do usu√°rio permitindo um conjunto de credenciais de login em v√°rias aplica√ß√µes.
- **Autentica√ß√£o Multifator (MFA)**: Aumenta a seguran√ßa exigindo m√∫ltiplas formas de verifica√ß√£o.
- **Gerenciamento de Ciclo de Vida**: Automatiza os processos de cria√ß√£o, atualiza√ß√£o e desativa√ß√£o de contas de usu√°rio.
- **Diret√≥rio Universal**: Permite o gerenciamento centralizado de usu√°rios, grupos e dispositivos.
- **Gerenciamento de Acesso a API**: Protege e gerencia o acesso √†s APIs.

Esses servi√ßos t√™m como objetivo fortalecer a prote√ß√£o de dados e simplificar o acesso do usu√°rio, aprimorando tanto a seguran√ßa quanto a conveni√™ncia. A versatilidade das solu√ß√µes da Okta as torna uma escolha popular em v√°rias ind√∫strias, beneficiando grandes empresas, pequenas empresas e desenvolvedores individuais. At√© a √∫ltima atualiza√ß√£o em setembro de 2021, a Okta √© reconhecida como uma entidade proeminente no campo de Gerenciamento de Identidade e Acesso (IAM).

{% hint style="danger" %}
O principal objetivo da Okta √© configurar o acesso de diferentes usu√°rios e grupos a aplica√ß√µes externas. Se voc√™ conseguir **comprometer privil√©gios de administrador em um ambiente Okta**, √© altamente prov√°vel que consiga **comprometer todas as outras plataformas que a empresa est√° usando**.
{% endhint %}

{% hint style="success" %}
Para realizar uma revis√£o de seguran√ßa de um ambiente Okta, voc√™ deve solicitar **acesso somente leitura de administrador**.
{% endhint %}

### Resumo

Existem **usu√°rios** (que podem ser **armazenados no Okta**, logados a partir de **Provedores de Identidade** configurados ou autenticados via **Active Directory** ou LDAP).\
Esses usu√°rios podem estar dentro de **grupos**.\
Existem tamb√©m **autenticadores**: diferentes op√ß√µes de autentica√ß√£o como senha e v√°rias formas de autentica√ß√£o em duas etapas como WebAuthn, e-mail, telefone, okta verify (podem estar habilitados ou desabilitados)...

Em seguida, existem **aplica√ß√µes** sincronizadas com o Okta. Cada aplica√ß√£o ter√° um **mapeamento com o Okta** para compartilhar informa√ß√µes (como endere√ßos de e-mail, nomes...). Al√©m disso, cada aplica√ß√£o deve estar dentro de uma **Pol√≠tica de Autentica√ß√£o**, que indica os **autenticadores necess√°rios** para um usu√°rio **acessar** a aplica√ß√£o.

{% hint style="danger" %}
O papel mais poderoso √© o de **Super Administrador**.

Se um atacante comprometer o Okta com acesso de Administrador, todas as **aplica√ß√µes que confiam no Okta** provavelmente ser√£o **comprometidas**.
{% endhint %}

## Ataques

### Localizando o Portal do Okta

Normalmente, o portal de uma empresa estar√° localizado em **nomedaempresa.okta.com**. Se n√£o, tente **varia√ß√µes simples** de **nomedaempresa**. Se n√£o conseguir encontrar, tamb√©m √© poss√≠vel que a organiza√ß√£o tenha um registro **CNAME** como **`okta.nomedaempresa.com`** apontando para o **portal do Okta**.

### Login no Okta via Kerberos

Se **`nomedaempresa.kerberos.okta.com`** estiver ativo, o **Kerberos √© usado para acesso ao Okta**, geralmente contornando a **MFA** para usu√°rios do **Windows**. Para encontrar usu√°rios do Okta autenticados pelo Kerberos no AD, execute **`getST.py`** com **par√¢metros apropriados**. Ao obter um **ticket de usu√°rio AD**, **injete-o em um host controlado usando ferramentas como Rubeus ou Mimikatz**, garantindo que **`nomedocliente.kerberos.okta.com` esteja na zona "Intranet" das "Op√ß√µes da Internet"**. Acesso a uma URL espec√≠fica deve retornar uma resposta JSON "OK", indicando a aceita√ß√£o do ticket Kerberos e concedendo acesso ao painel do Okta.

Comprometer a **conta de servi√ßo do Okta com a SPN de delega√ß√£o permite um ataque de Silver Ticket**. No entanto, o uso do Okta do **AES** para criptografia de ticket requer possuir a chave AES ou a senha em texto simples. Use **`ticketer.py` para gerar um ticket para o usu√°rio v√≠tima** e entregue-o via navegador para autenticar com o Okta.

**Verifique o ataque em [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Sequestro do Agente AD do Okta

Essa t√©cnica envolve **acessar o Agente AD do Okta em um servidor**, que **sincroniza usu√°rios e lida com a autentica√ß√£o**. Ao examinar e descriptografar configura√ß√µes em **`OktaAgentService.exe.config`**, especialmente o AgentToken usando **DPAPI**, um atacante pode potencialmente **interceptar e manipular dados de autentica√ß√£o**. Isso permite n√£o apenas **monitorar** e **capturar credenciais de usu√°rio** em texto simples durante o processo de autentica√ß√£o do Okta, mas tamb√©m **responder √†s tentativas de autentica√ß√£o**, permitindo assim acesso n√£o autorizado ou fornecendo autentica√ß√£o universal por meio do Okta (semelhante a uma 'chave mestra').

**Verifique o ataque em [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Sequestro do AD como Administrador

Essa t√©cnica envolve sequestrar um Agente AD do Okta obtendo primeiro um C√≥digo OAuth, e em seguida solicitando um token de API. O token est√° associado a um dom√≠nio AD, e um **conector √© nomeado para estabelecer um agente AD falso**. A inicializa√ß√£o permite que o agente **processar tentativas de autentica√ß√£o**, capturando credenciais via API do Okta. Ferramentas de automa√ß√£o est√£o dispon√≠veis para simplificar esse processo, oferecendo um m√©todo cont√≠nuo para interceptar e lidar com dados de autentica√ß√£o dentro do ambiente Okta.

**Verifique o ataque em [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Provedor SAML Falso do Okta

**Verifique o ataque em [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

A t√©cnica envolve **implantar um provedor SAML falso**. Ao integrar um Provedor de Identidade externo (IdP) dentro do framework do Okta usando uma conta privilegiada, os atacantes podem **controlar o IdP, aprovando qualquer solicita√ß√£o de autentica√ß√£o √† vontade**. O processo envolve configurar um IdP SAML 2.0 no Okta, manipular a URL de Logon √önico do IdP para redirecionamento via arquivo hosts local, gerar um certificado autoassinado e configurar as configura√ß√µes do Okta para corresponder ao nome de usu√°rio ou e-mail. Executar com sucesso essas etapas permite a autentica√ß√£o como qualquer usu√°rio do Okta, contornando a necessidade de credenciais individuais do usu√°rio, elevando significativamente o controle de acesso de forma potencialmente impercept√≠vel.

### Phishing no Portal do Okta com Evilgnix

Neste [**post de blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) √© explicado como preparar uma campanha de phishing contra um portal do Okta.

### Ataque de Impersona√ß√£o de Colega

Os **atributos que cada usu√°rio pode ter e modificar** (como e-mail ou primeiro nome) podem ser configurados no Okta. Se uma **aplica√ß√£o** est√° **confiando** em um **atributo** que o usu√°rio pode **modificar**, ele poder√° **impersonar outros usu√°rios naquela plataforma**.

Portanto, se a aplica√ß√£o est√° confiando no campo **`userName`**, provavelmente voc√™ n√£o poder√° alter√°-lo (porque geralmente n√£o pode alterar esse campo), mas se estiver confiando, por exemplo, em **`primaryEmail`**, voc√™ pode ser capaz de **alter√°-lo para o endere√ßo de e-mail de um colega** e se passar por ele (voc√™ precisar√° ter acesso ao e-mail e aceitar a altera√ß√£o).

Observe que essa impersona√ß√£o depende de como cada aplica√ß√£o foi configurada. Apenas aquelas que confiam no campo que voc√™ modificou e aceitam atualiza√ß√µes ser√£o comprometidas.\
Portanto, a aplica√ß√£o deve ter esse campo habilitado se ele existir:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Tamb√©m vi outras aplica√ß√µes vulner√°veis que n√£o tinham esse campo nas configura√ß√µes do Okta (no final, diferentes aplica√ß√µes s√£o configuradas de maneira diferente).

A melhor maneira de descobrir se voc√™ poderia se passar por algu√©m em cada aplica√ß√£o seria tentar!

## Evitando pol√≠ticas de detec√ß√£o comportamental <a href="#id-9fde" id="id-9fde"></a>

As pol√≠ticas de detec√ß√£o comportamental no Okta podem ser desconhecidas at√© encontradas, mas **burl√°-las** pode ser alcan√ßado **direcionando-se diretamente √†s aplica√ß√µes do Okta**, evitando o painel principal do Okta. Com um **token de acesso do Okta**, replique o token no **URL espec√≠fico da aplica√ß√£o do Okta** em vez da p√°gina de login principal.

Recomenda√ß√µes-chave incluem:

* **Evitar o uso de** proxies anonimizadores populares e servi√ßos VPN ao reproduzir tokens de acesso capturados.
* Garantir **cadeias de agente de usu√°rio consistentes** entre o cliente e os tokens de acesso reproduzidos.
* **Abster-se de reproduzir** tokens de diferentes usu√°rios do mesmo endere√ßo IP.
* Ter cautela ao reproduzir tokens no painel do Okta.
* Se ciente dos endere√ßos IP da empresa v√≠tima, **restringir o tr√°fego** para esses IPs ou sua faixa, bloqueando todo o tr√°fego restante.

## Refor√ßo do Okta

O Okta possui muitas configura√ß√µes poss√≠veis, nesta p√°gina voc√™ encontrar√° como revis√°-las para que sejam o mais seguras poss√≠vel:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
