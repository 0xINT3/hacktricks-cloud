# Okta安全

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

[Okta, Inc.](https://www.okta.com/)在身份和访问管理领域以其基于云的软件解决方案而闻名。这些解决方案旨在简化和保护用户在各种现代应用程序中的身份验证。它们不仅适用于希望保护敏感数据的公司，还适用于有兴趣将身份控制集成到应用程序、网络服务和设备中的开发人员。

Okta的旗舰产品是**Okta Identity Cloud**。该平台包括一套产品，包括但不限于：

* **单点登录（SSO）**：通过允许在多个应用程序之间使用一组登录凭据来简化用户访问。
* **多因素身份验证（MFA）**：通过要求多种验证形式来增强安全性。
* **生命周期管理**：自动化用户帐户创建、更新和停用过程。
* **通用目录**：实现对用户、组和设备的集中管理。
* **API访问管理**：保护和管理对API的访问。

这些服务共同旨在加强数据保护并简化用户访问，提高安全性和便利性。Okta解决方案的多功能性使其成为各行业的热门选择，对大型企业、小公司和个人开发人员都有益。截至2021年9月的最新更新，Okta被认为是身份和访问管理（IAM）领域的重要实体。

{% hint style="danger" %}
Okta的主要目标是配置对外部应用程序的不同用户和组的访问。如果您设法在Okta环境中** compromis管理员权限**，您很可能能够**compromise公司正在使用的所有其他平台**。
{% endhint %}

{% hint style="success" %}
要对Okta环境进行安全审查，您应该请求**管理员只读访问权限**。
{% endhint %}

### 摘要

有**用户**（可以**存储在Okta中**，从配置的**身份提供者**登录，或通过**Active Directory**或LDAP进行身份验证）。\
这些用户可以位于**组**中。\
还有**认证器**：不同的身份验证选项，如密码，以及几种2FA，如WebAuthn、电子邮件、电话、okta verify（它们可以启用或禁用）...

然后，有与Okta同步的**应用程序**。每个应用程序将与Okta有一些**映射**以共享信息（如电子邮件地址、名字...）。此外，每个应用程序必须位于一个**身份验证策略**中，该策略指示用户访问应用程序所需的**认证器**。

{% hint style="danger" %}
最强大的角色是**超级管理员**。

如果攻击者以管理员访问权限compromise Okta，所有**信任Okta**的应用程序很可能会被**compromise**。
{% endhint %}

## 攻击

### 定位Okta门户

通常公司的门户位于**companyname.okta.com**。如果不是，请尝试简单的**companyname**的**变体**。如果找不到，组织可能有一个像**`okta.companyname.com`**这样指向**Okta门户**的**CNAME**记录。

### 通过Kerberos登录Okta

如果**`companyname.kerberos.okta.com`**是活动的，通常会使用**Kerberos来访问Okta**，通常绕过**Windows**用户的**MFA**。要在AD中查找使用Kerberos身份验证的Okta用户，请使用**适当的参数运行`getST.py`**。在获得**AD用户票证**后，使用Rubeus或Mimikatz等工具将其注入到受控主机中，确保**`clientname.kerberos.okta.com`在Internet选项的“Intranet”区域**中。访问特定URL应返回JSON“OK”响应，表示Kerberos票证已被接受，并授予访问Okta仪表板的权限。

通过**委派SPN启用Silver Ticket攻击来compromise Okta服务帐户**。然而，Okta对于票证加密使用AES需要拥有AES密钥或明文密码。使用**`ticketer.py`为受害用户生成一个票证**，并通过浏览器传递以与Okta进行身份验证。

**在** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**中检查攻击。**

### 劫持Okta AD代理

这种技术涉及**访问在服务器上的Okta AD代理**，该代理**同步用户并处理身份验证**。通过检查和解密**`OktaAgentService.exe.config`**中的配置，特别是使用**DPAPI**的AgentToken，攻击者可能会**拦截和操纵身份验证数据**。这不仅允许在Okta身份验证过程中以明文形式**监视**和**捕获用户凭据**，还允许**响应身份验证尝试**，从而实现未经授权访问或通过Okta提供通用身份验证（类似于“骷髅钥匙”）。

**在** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**中检查攻击。**

### 作为管理员劫持AD

这种技术涉及首先获取OAuth代码，然后请求API令牌来劫持Okta AD代理。该令牌与AD域关联，并命名**连接器以建立一个虚假的AD代理**。初始化允许代理**处理身份验证尝试**，通过Okta API捕获凭据。有自动化工具可简化此过程，提供一种无缝的方法来拦截和处理Okta环境中的身份验证数据。

**在** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**中检查攻击。**

### Okta虚假SAML提供者

**在** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**中检查攻击。**

该技术涉及**部署虚假SAML提供者**。通过使用特权帐户在Okta框架中集成外部身份提供者（IdP），攻击者可以**控制IdP，随意批准任何身份验证请求**。该过程包括在Okta中设置SAML 2.0 IdP，通过本地hosts文件重定向IdP单点登录URL，生成自签名证书，并配置Okta设置以匹配用户名或电子邮件。成功执行这些步骤允许作为任何Okta用户进行身份验证，绕过对个人用户凭据的需求，显着提升访问控制，可能以不被注意的方式。
### 用 Evilgnix 对 Okta 门户进行钓鱼攻击

在[**这篇博客文章**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)中解释了如何准备针对 Okta 门户的钓鱼活动。

### 同事冒充攻击

**每个用户可以拥有和修改的属性**（如电子邮件或名字）可以在 Okta 中配置。如果一个**应用程序**将一个用户可以**修改**的**属性**作为 ID 进行**信任**，那么他将能够**冒充该平台上的其他用户**。

因此，如果应用程序信任字段**`userName`**，您可能无法更改它（因为通常无法更改该字段），但如果它信任例如**`primaryEmail`**，您可能能够**将其更改为同事的电子邮件地址**并冒充它（您需要访问该电子邮件并接受更改）。

请注意，这种冒充取决于每个应用程序的配置。只有信任您修改的字段并接受更新的应用程序才会受到影响。\
因此，如果存在该字段，应用程序应该启用此字段：

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

我还看到其他一些应用程序存在漏洞，但在 Okta 设置中没有该字段（最终不同的应用程序配置不同）。

找出您是否可以在每个应用程序上冒充任何人的最佳方法是尝试一下！

## 规避行为检测策略 <a href="#id-9fde" id="id-9fde"></a>

在 Okta 中的行为检测策略可能在遇到之前是未知的，但可以通过直接**针对 Okta 应用程序**，避开主要的 Okta 仪表板来**绕过**它们。使用**Okta 访问令牌**，在**特定于应用程序的 Okta URL**上重放令牌，而不是在主登录页面上。

关键建议包括：

* **避免使用**流行的匿名代理和 VPN 服务来重放捕获的访问令牌。
* 确保客户端和重放的访问令牌之间的**用户代理字符串一致**。
* **避免**从同一 IP 地址重放不同用户的令牌。
* 在针对 Okta 仪表板重放令牌时要小心。
* 如果知道受害公司的 IP 地址，将流量**限制**在这些 IP 或其范围内，阻止所有其他流量。

## Okta 强化

Okta 有很多可能的配置，在这个页面中，您将找到如何审查它们，以便使它们尽可能安全：

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## 参考资料

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
