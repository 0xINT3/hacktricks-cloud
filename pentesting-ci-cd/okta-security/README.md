# Seguridad de Okta

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información Básica

[Okta, Inc.](https://www.okta.com/) es reconocida en el sector de gestión de identidad y acceso por sus soluciones de software basadas en la nube. Estas soluciones están diseñadas para agilizar y asegurar la autenticación de usuarios en diversas aplicaciones modernas. No solo se dirigen a empresas que buscan proteger sus datos sensibles, sino también a desarrolladores interesados en integrar controles de identidad en aplicaciones, servicios web y dispositivos.

La oferta principal de Okta es la **Okta Identity Cloud**. Esta plataforma abarca una serie de productos, que incluyen pero no se limitan a:

- **Inicio de Sesión Único (SSO)**: Simplifica el acceso de usuarios al permitir un conjunto de credenciales de inicio de sesión en múltiples aplicaciones.
- **Autenticación Multifactor (MFA)**: Mejora la seguridad al requerir múltiples formas de verificación.
- **Gestión del Ciclo de Vida**: Automatiza los procesos de creación, actualización y desactivación de cuentas de usuario.
- **Directorio Universal**: Permite la gestión centralizada de usuarios, grupos y dispositivos.
- **Gestión de Acceso a API**: Asegura y gestiona el acceso a las APIs.

Estos servicios tienen como objetivo fortalecer la protección de datos y agilizar el acceso de usuarios, mejorando tanto la seguridad como la conveniencia. La versatilidad de las soluciones de Okta las convierte en una opción popular en diversas industrias, beneficiando tanto a grandes empresas como a pequeñas compañías y desarrolladores individuales. Hasta la última actualización en septiembre de 2021, Okta es reconocida como una entidad prominente en el ámbito de Gestión de Identidad y Acceso (IAM).

{% hint style="danger" %}
El objetivo principal de Okta es configurar el acceso de diferentes usuarios y grupos a aplicaciones externas. Si logras **comprometer privilegios de administrador en un entorno de Okta**, es muy probable que puedas **comprometer todas las demás plataformas que la empresa esté utilizando**.
{% endhint %}

{% hint style="success" %}
Para realizar una revisión de seguridad de un entorno de Okta, debes solicitar **acceso de solo lectura de administrador**.
{% endhint %}

### Resumen

Existen **usuarios** (que pueden estar **almacenados en Okta**, iniciados desde **Proveedores de Identidad** configurados o autenticados a través de **Active Directory** o LDAP).\
Estos usuarios pueden estar dentro de **grupos**.\
También existen **autenticadores**: diferentes opciones para autenticar como contraseña, y varios métodos de autenticación de dos factores como WebAuthn, correo electrónico, teléfono, Okta Verify (pueden estar habilitados o deshabilitados)...

Luego, hay **aplicaciones** sincronizadas con Okta. Cada aplicación tendrá un **mapeo con Okta** para compartir información (como direcciones de correo electrónico, nombres...). Además, cada aplicación debe estar dentro de una **Política de Autenticación**, que indica los **autenticadores necesarios** para que un usuario **acceda** a la aplicación.

{% hint style="danger" %}
El rol más poderoso es el de **Super Administrador**.

Si un atacante compromete Okta con acceso de Administrador, es muy probable que todas las **aplicaciones que confían en Okta** sean comprometidas.
{% endhint %}

## Ataques

### Localización del Portal de Okta

Por lo general, el portal de una empresa estará ubicado en **nombredelaempresa.okta.com**. Si no es así, prueba con **variaciones** simples de **nombredelaempresa**. Si no puedes encontrarlo, también es posible que la organización tenga un registro **CNAME** como **`okta.nombredelaempresa.com`** apuntando al **portal de Okta**.

### Inicio de Sesión en Okta a través de Kerberos

Si **`nombredelaempresa.kerberos.okta.com`** está activo, se utiliza **Kerberos para el acceso a Okta**, generalmente evitando la **MFA** para los usuarios de **Windows**. Para encontrar usuarios de Okta autenticados con Kerberos en AD, ejecuta **`getST.py`** con los **parámetros apropiados**. Al obtener un **ticket de usuario de AD**, **inýectalo** en un host controlado usando herramientas como Rubeus o Mimikatz, asegurándote de que **`clientname.kerberos.okta.com` esté en la zona "Intranet" de las "Opciones de Internet"**. Al acceder a una URL específica, debería devolver una respuesta JSON "OK", indicando la aceptación del ticket de Kerberos y otorgando acceso al panel de control de Okta.

Comprometer la **cuenta de servicio de Okta con el SPN de delegación habilitado permite un ataque de Silver Ticket**. Sin embargo, el uso de **AES** por parte de Okta para la encriptación de tickets requiere poseer la clave AES o la contraseña en texto plano. Utiliza **`ticketer.py` para generar un ticket para el usuario víctima** y entrégalo a través del navegador para autenticarte con Okta.

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Secuestro del Agente de AD de Okta

Esta técnica implica **acceder al Agente de AD de Okta en un servidor**, que **sincroniza usuarios y maneja la autenticación**. Al examinar y descifrar configuraciones en **`OktaAgentService.exe.config`**, especialmente el AgentToken utilizando **DPAPI**, un atacante potencialmente puede **interceptar y manipular datos de autenticación**. Esto permite no solo **monitorear** y **capturar credenciales de usuario** en texto plano durante el proceso de autenticación de Okta, sino también **responder a intentos de autenticación**, lo que permite el acceso no autorizado o proporciona autenticación universal a través de Okta (similar a una 'llave maestra').

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Secuestro de AD como Administrador

Esta técnica implica secuestrar un Agente de AD de Okta obteniendo primero un Código OAuth, y luego solicitando un token de API. El token está asociado con un dominio AD, y se nombra un **conector para establecer un agente de AD falso**. La inicialización permite que el agente **procese intentos de autenticación**, capturando credenciales a través de la API de Okta. Hay herramientas de automatización disponibles para agilizar este proceso, ofreciendo un método fluido para interceptar y manejar datos de autenticación dentro del entorno de Okta.

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Proveedor SAML Falso de Okta

**Verifica el ataque en [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

La técnica implica **implementar un proveedor SAML falso**. Al integrar un Proveedor de Identidad externo (IdP) dentro del marco de Okta utilizando una cuenta privilegiada, los atacantes pueden **controlar el IdP, aprobando cualquier solicitud de autenticación a voluntad**. El proceso implica configurar un IdP SAML 2.0 en Okta, manipular la URL de Inicio de Sesión Único del IdP para redirigir a través del archivo de hosts local, generar un certificado autofirmado y configurar los ajustes de Okta para que coincidan con el nombre de usuario o correo electrónico. Al ejecutar con éxito estos pasos, se permite la autenticación como cualquier usuario de Okta, evitando la necesidad de credenciales de usuario individuales, elevando significativamente el control de acceso de manera potencialmente desapercibida.

### Phishing al Portal de Okta con Evilgnix

En [**esta publicación de blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) se explica cómo preparar una campaña de phishing contra un portal de Okta.

### Ataque de Suplantación de Colega

Los **atributos que cada usuario puede tener y modificar** (como correo electrónico o nombre) se pueden configurar en Okta. Si una **aplicación** confía como ID en un **atributo** que el usuario puede **modificar**, podrá **suplantar a otros usuarios en esa plataforma**.

Por lo tanto, si la aplicación confía en el campo **`userName`**, probablemente no podrás cambiarlo (porque generalmente no puedes cambiar ese campo), pero si confía, por ejemplo, en **`primaryEmail`**, podrías ser capaz de **cambiarlo por la dirección de correo electrónico de un colega** e impersonarlo (necesitarás tener acceso al correo electrónico y aceptar el cambio).

Ten en cuenta que esta suplantación depende de cómo se configuró cada aplicación. Solo las que confíen en el campo que modificaste y acepten actualizaciones serán comprometidas.\
Por lo tanto, la aplicación debe tener este campo habilitado si existe:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

También he visto otras aplicaciones vulnerables pero que no tenían ese campo en la configuración de Okta (al final, las diferentes aplicaciones se configuran de manera diferente).

La mejor manera de averiguar si podrías suplantar a alguien en cada aplicación sería ¡intentarlo!

## Evadir políticas de detección de comportamiento <a href="#id-9fde" id="id-9fde"></a>

Las políticas de detección de comportamiento en Okta pueden ser desconocidas hasta que se encuentran, pero **burlarlas** se puede lograr **dirigiéndose directamente a las aplicaciones de Okta**, evitando el panel principal de Okta. Con un **token de acceso de Okta**, reproduce el token en la **URL específica de la aplicación de Okta** en lugar de la página principal de inicio de sesión.

Las recomendaciones clave incluyen:

* **Evitar el uso de** proxies anonimizadores populares y servicios VPN al reproducir tokens de acceso capturados.
* Asegurar **cadenas de agente de usuario consistentes** entre el cliente y los tokens de acceso reproducidos.
* **Abstenerse de reproducir** tokens de diferentes usuarios desde la misma dirección IP.
* Tener precaución al reproducir tokens contra el panel de control de Okta.
* Si se conocen las direcciones IP de la empresa víctima, **restringir el tráfico** a esas IPs o su rango, bloqueando todo otro tráfico.

## Fortalecimiento de Okta

Okta tiene muchas configuraciones posibles, en esta página encontrarás cómo revisarlas para que sean lo más seguras posible:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Referencias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
