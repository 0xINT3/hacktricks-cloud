# Oktaセキュリティ

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
- **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

## 基本情報

[Okta, Inc.](https://www.okta.com/)は、クラウドベースのソフトウェアソリューションで知られるアイデンティティおよびアクセス管理セクターで認識されています。これらのソリューションは、さまざまなモダンアプリケーションでのユーザー認証を効率化し、セキュリティを確保するために設計されています。これらは、機密データを保護しようとする企業だけでなく、アイデンティティコントロールをアプリケーション、Webサービス、およびデバイスに統合したい開発者にも対応しています。

Oktaの主力製品は**Okta Identity Cloud**です。このプラットフォームには、次の製品などが含まれています。

- **シングルサインオン（SSO）**：複数のアプリケーションで1つのログイン資格情報を使用してユーザーアクセスを簡素化します。
- **マルチファクタ認証（MFA）**：複数の検証形式を要求することでセキュリティを強化します。
- **ライフサイクル管理**：ユーザーアカウントの作成、更新、無効化プロセスを自動化します。
- **ユニバーサルディレクトリ**：ユーザー、グループ、およびデバイスの中央管理を可能にします。
- **APIアクセス管理**：APIへのアクセスを保護し管理します。

これらのサービスは、データ保護を強化し、ユーザーアクセスを効率化し、セキュリティと利便性の両方を向上させることを目指しています。Oktaのソリューションの柔軟性により、大企業、中小企業、個々の開発者にとっても人気のある選択肢となっています。2021年9月の最新情報によると、Oktaはアイデンティティおよびアクセス管理（IAM）分野で著名な存在として認識されています。

{% hint style="danger" %}
Oktaの主な目標は、異なるユーザーやグループへの外部アプリケーションへのアクセスを構成することです。Oktaの**管理者特権を侵害**すると、おそらく企業が使用している他のプラットフォームも**侵害**される可能性が非常に高くなります。
{% endhint %}

{% hint style="success" %}
Okta環境のセキュリティレビューを実行するには、**管理者用の読み取り専用アクセス**を要求する必要があります。
{% endhint %}

### 概要

**ユーザー**（Oktaに**保存されている可能性がある**、構成された**アイデンティティプロバイダー**からログインしたり、**Active Directory**またはLDAPを介して認証されたりする）が存在します。\
これらのユーザーは**グループ**に所属することができます。\
**認証器**もあります：パスワードなどの認証方法やWebAuthn、電子メール、電話、okta verifyなどの複数の2要素認証が有効または無効になっている可能性があります...

次に、Oktaと同期された**アプリケーション**があります。各アプリケーションは、情報を共有するためにOktaとの**マッピング**を持つ必要があります（電子メールアドレス、名前など）。さらに、各アプリケーションは、ユーザーがアプリケーションに**アクセス**するために**必要な認証器**を示す**認証ポリシー**内に配置されている必要があります。

{% hint style="danger" %}
最も強力な役割は**スーパー管理者**です。

攻撃者が管理者アクセスでOktaを侵害すると、Oktaを信頼するすべての**アプリケーションが高い確率で侵害**される可能性があります。
{% endhint %}

## 攻撃

### Oktaポータルの特定

通常、企業のポータルは**companyname.okta.com**にあります。そうでない場合は、**companyname**の単純な**バリエーション**を試してみてください。見つけられない場合は、組織が**Oktaポータル**を指す**`okta.companyname.com`**のような**CNAME**レコードを持っている可能性もあります。

### Kerberosを介したOktaへのログイン

**`companyname.kerberos.okta.com`**がアクティブである場合、**KerberosがOktaアクセスに使用**され、通常は**Windows**ユーザーの**MFA**をバイパスします。ADでKerberos認証されたOktaユーザーを見つけるには、**`getST.py`**を適切なパラメータで実行します。**ADユーザーチケット**を取得したら、RubeusやMimikatzなどのツールを使用して制御されたホストに**注入**し、**`clientname.kerberos.okta.com`がInternet Optionsの"Intranet"ゾーンにあることを確認**します。特定のURLにアクセスすると、Kerberosチケットが受け入れられ、Oktaダッシュボードへのアクセスが許可されることを示すJSONの「OK」応答が返されます。

**Oktaサービスアカウントを委任SPNで侵害すると、Silver Ticket攻撃が可能になります。**ただし、Oktaがチケット暗号化に**AES**を使用しているため、AESキーまたは平文パスワードを所有する必要があります。**`ticketer.py`を使用して被害者ユーザーのためのチケットを生成**し、ブラウザを介して配信してOktaで認証することができます。

**攻撃を確認する** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**。**

### Okta ADエージェントのハイジャック

この技術は、ユーザーを同期し認証を処理する**Okta ADエージェントにアクセス**することを含みます。**`OktaAgentService.exe.config`**で構成を調査し、特にDPAPIを使用してAgentTokenを復号化することで、攻撃者は潜在的に**認証データを傍受および操作**することができます。これにより、Okta認証プロセス中にユーザーの資格情報を平文で**監視**および**キャプチャ**するだけでなく、認証試行に**応答**することも可能になり、未承認のアクセスを可能にしたり、Oktaを介した普遍的な認証を提供したりすることができます（「スケルトンキー」と同様）。

**攻撃を確認する** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**。**

### 管理者としてADのハイジャック

この技術は、最初にOAuthコードを取得し、次にAPIトークンを要求することで、Okta ADエージェントをハイジャックすることを含みます。トークンはADドメインに関連付けられ、**コネクタが偽のADエージェントを確立するように名前が付けられます**。初期化により、エージェントは**認証試行を処理**し、Okta APIを介して資格情報をキャプチャすることができます。このプロセスを効率化するための自動化ツールが利用可能であり、Okta環境内で認証データを傍受および処理するシームレスな方法を提供し、Okta環境内で認証データを処理する方法を提供します。

**攻撃を確認する** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**。**

### OktaフェイクSAMLプロバイダ

**攻撃を確認する** [**https://trustedsec.com/blog/okta-for-red-teamers**](https://trustedsec.com/blog/okta-for-red-teamers)**。**

この技術は、**偽のSAMLプロバイダを展開**することを含みます。特権アカウントを使用してOktaのフレームワークに外部アイデンティティプロバイダ（IdP）を統合することで、攻撃者は**IdPを制御し、任意の認証リクエストを承認**することができます。このプロセスには、OktaにSAML 2.0 IdPを設定し、ローカルホストファイルを介してリダイレクトするためのIdPシングルサインオンURLを操作し、自己署名証明書を生成し、Okta設定をユーザー名または電子メールに一致するように構成することが含まれます。これらの手順を成功裏に実行すると、個々のユーザー資格情報が不要となり、個々のユーザー資格情報が不要となり、Oktaユーザーとして認証することが可能になり、アクセス制御が大幅に向上し、潜在的に気づかれない方法でアクセス制御が向上します。
### Evilgnixを使用したOktaポータルのフィッシング

[**このブログ投稿**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)では、Oktaポータルに対するフィッシングキャンペーンの準備方法が説明されています。

### 同僚のなりすまし攻撃

各ユーザーが持つことができ、変更できる**属性**（例：メールアドレスや名前）はOktaで構成できます。ユーザーが**変更できる属性**をIDとして**信頼しているアプリケーション**がある場合、そのプラットフォームで**他のユーザーをなりすます**ことができます。

したがって、アプリケーションが**`userName`**フィールドを信頼している場合、通常そのフィールドを変更することはできませんが、たとえば**`primaryEmail`**を信頼している場合、**同僚のメールアドレスに変更**してなりすますことができるかもしれません（メールにアクセスして変更を承認する必要があります）。

このなりすましは、各アプリケーションがどのように構成されているかに依存します。変更したフィールドを信頼し、更新を受け入れるアプリケーションのみが危険にさらされます。\
したがって、そのフィールドが存在する場合、アプリケーションはこのフィールドを有効にしている必要があります：

<figure><img src="../../.gitbook/assets/image (175).png" alt=""><figcaption></figcaption></figure>

私は、Oktaの設定にそのフィールドがないが脆弱な他のアプリケーションも見てきました（最終的に異なるアプリケーションは異なる方法で構成されています）。

各アプリで誰でもなりすますことができるかどうかを確認する最良の方法は、試してみることです！

## 行動検知ポリシーの回避 <a href="#id-9fde" id="id-9fde"></a>

Oktaの行動検知ポリシーは遭遇するまで不明かもしれませんが、それらを**バイパス**することは、**主要なOktaダッシュボードを回避**し、**Oktaアプリケーションを直接ターゲット**することで達成できます。**Oktaアクセストークン**を使用して、メインのログインページではなく**アプリケーション固有のOkta URL**でトークンを再生します。

主な推奨事項は次のとおりです：

* キャプチャされたアクセストークンを再生する際に、一般的な匿名化プロキシやVPNサービスを**使用しない**こと。
* クライアントと再生されたアクセストークンの間で**一貫したユーザーエージェント文字列**を確保すること。
* 同じIPアドレスから異なるユーザーのトークンを再生することを**控える**こと。
* Oktaダッシュボードに対してトークンを再生する際は注意を払うこと。
* 被害企業のIPアドレスを把握している場合は、そのIPまたはその範囲にトラフィックを**制限**し、他のすべてのトラフィックをブロックすること。

## Oktaの強化

Oktaには多くの可能な構成があります。このページでは、それらをできるだけ安全にする方法について説明します：

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## 参考文献

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
