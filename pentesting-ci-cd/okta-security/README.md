# Okta 보안

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 **PR을 제출**하여 자신의 해킹 기법을 공유하세요.

</details>

## 기본 정보

[Okta, Inc.](https://www.okta.com/)는 클라우드 기반 소프트웨어 솔루션을 통해 신원 및 접근 관리 부문에서 인정받고 있습니다. 이러한 솔루션은 다양한 현대 애플리케이션에서 사용자 인증을 간소화하고 보안하는 데 사용됩니다. 이는 민감한 데이터를 보호하려는 기업뿐만 아니라 신원 제어를 애플리케이션, 웹 서비스 및 장치에 통합하려는 개발자들에게도 도움이 됩니다.

Okta의 주요 제품인 **Okta Identity Cloud**는 여러 제품으로 구성된 플랫폼입니다. 이에는 다음과 같은 제품들이 포함됩니다.

- **단일 로그인 (SSO)**: 여러 애플리케이션에서 하나의 로그인 자격 증명 세트를 사용하여 사용자 액세스를 간소화합니다.
- **다중 요소 인증 (MFA)**: 다중 형식의 인증을 요구하여 보안을 강화합니다.
- **수명 주기 관리**: 사용자 계정 생성, 업데이트 및 비활성화 프로세스를 자동화합니다.
- **통합 디렉터리**: 사용자, 그룹 및 장치의 중앙 관리를 가능하게 합니다.
- **API 액세스 관리**: API 액세스를 보호하고 관리합니다.

이러한 서비스는 데이터 보호를 강화하고 사용자 액세스를 간소화하여 보안과 편의성을 모두 향상시키기 위해 함께 작동합니다. Okta의 솔루션의 다양성은 대기업, 소기업 및 개별 개발자에게 모두 인기가 있습니다. 2021년 9월의 최신 업데이트를 기준으로 Okta는 신원 및 접근 관리 (IAM) 분야에서 주요한 기업으로 인정받고 있습니다.

{% hint style="danger" %}
Okta의 주요 목표는 다른 사용자 및 그룹에 대한 외부 애플리케이션의 액세스를 구성하는 것입니다. 만약 Okta에서 관리자 권한을 **침해**한다면, 회사가 사용하는 **다른 모든 플랫폼을 침해**할 수 있을 가능성이 매우 높습니다.
{% endhint %}

{% hint style="success" %}
Okta 환경의 보안 검토를 수행하려면 **관리자 읽기 전용 액세스**를 요청해야 합니다.
{% endhint %}

### 요약

**사용자**는 **Okta에 저장**될 수 있으며, 구성된 **Identity Providers**에서 로그인하거나 **Active Directory** 또는 LDAP를 통해 인증될 수 있습니다.\
이러한 사용자는 **그룹**에 속할 수 있습니다.\
또한 **인증자**도 있습니다. 비밀번호와 WebAuthn, 이메일, 전화, okta verify와 같은 여러 2FA와 같은 다양한 인증 옵션이 있습니다(활성화 또는 비활성화 될 수 있음)...

그런 다음, Okta와 동기화된 **애플리케이션**이 있습니다. 각 애플리케이션은 정보를 공유하기 위해 Okta와 **매핑**을 가져야 합니다(예: 이메일 주소, 이름 등). 게다가, 각 애플리케이션은 사용자가 애플리케이션에 **액세스**하기 위해 필요한 **인증자**를 나타내는 **인증 정책** 내에 있어야 합니다.

{% hint style="danger" %}
가장 강력한 역할은 **슈퍼 관리자**입니다.

공격자가 관리자 액세스로 Okta를 침해하면, Okta를 신뢰하는 **모든 앱이 침해**될 가능성이 매우 높습니다.
{% endhint %}

## 공격

### Okta 포털 찾기

일반적으로 회사의 포털은 **companyname.okta.com**에 위치합니다. 그렇지 않은 경우, **companyname**의 간단한 **변형**을 시도해보세요. 찾을 수 없는 경우, 조직이 **Okta 포털**을 가리키는 **`okta.companyname.com`**과 같은 **CNAME** 레코드를 가질 수도 있습니다.

### Kerberos를 통한 Okta 로그인

**`companyname.kerberos.okta.com`**이 활성화되어 있다면, Okta 액세스에 **Kerberos가 사용**됩니다. 일반적으로 **Windows** 사용자의 경우 **MFA**를 우회합니다. AD에서 Kerberos로 인증된 Okta 사용자를 찾으려면 **`getST.py`**를 적절한 매개변수와 함께 실행하세요. **AD 사용자 티켓**을 얻은 후, Rubeus 또는 Mimikatz와 같은 도구를 사용하여 제어된 호스트에 **주입**하세요. 이때 **`clientname.kerberos.okta.com`이 인터넷 옵션의 "Intranet" 영역에 포함**되어 있어야 합니다. 특정 URL에 액세스하면 JSON "OK" 응답이 반환되어 Kerberos 티켓이 수락되고 Okta 대시보드에 액세스할 수 있음을 나타냅니다.

**Okta 서비스 계정을 위임 SPN과 함께 침해하면 Silver Ticket 공격을 수행할 수 있습니다.** 그러나 Okta는 티켓 암호화에 AES를 사용하기 때문에 AES 키 또는 평문 암호를 소유해야 합니다. **`ticketer.py`**를 사용하여 피해자 사용자를 위한 티켓을 생성하고 브라우저를 통해 Okta와 인증하기 위해 전달하세요.

**[https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)**에서 공격을 확인하세요.

### Okta AD 에이전트 탈취

이 기술은 사용자를 동기화하고 인증을 처리하는 Okta AD 에이전트에 **액세스하는 것**을 포함합니다. **`OktaAgentService.exe.config`**에서 구성을 검사하고 복호화하여 AgentToken을 **DPAPI**
### Evilgnix를 사용하여 Okta 포털을 피싱하기

[**이 블로그 포스트**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)에서 Okta 포털에 대한 피싱 캠페인을 준비하는 방법이 설명되어 있습니다.

### 동료 사칭 공격

Okta에서는 각 사용자가 가질 수 있고 수정할 수 있는 **속성**(예: 이메일 또는 이름)을 구성할 수 있습니다. 사용자가 수정할 수 있는 **속성**을 ID로 신뢰하는 **애플리케이션**이 있다면 해당 플랫폼에서 **다른 사용자를 사칭**할 수 있습니다.

따라서, 앱이 **`userName`** 필드를 신뢰한다면 (일반적으로 해당 필드를 변경할 수 없기 때문에) 변경할 수 없을 것입니다. 그러나, 예를 들어 **`primaryEmail`**을 신뢰한다면 동료의 이메일 주소로 변경하여 사칭할 수 있습니다 (해당 이메일에 액세스하고 변경을 수락해야 합니다).

이 사칭은 각 애플리케이션이 어떻게 구성되었는지에 따라 달라집니다. 수정한 필드를 신뢰하고 업데이트를 수락하는 앱만이 영향을 받을 것입니다.\
따라서, 해당 필드가 있는 경우 앱은 이 필드를 활성화해야 합니다:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Okta 설정에 해당 필드가 없는 취약한 앱도 본 적이 있습니다 (결국 다른 앱은 서로 다르게 구성됩니다).

각 앱에서 누구든 사칭할 수 있는지 확인하는 가장 좋은 방법은 시도해 보는 것입니다!

## 행위 감지 정책 회피 <a href="#id-9fde" id="id-9fde"></a>

Okta의 행위 감지 정책은 만날 때까지 알 수 없지만, 이를 우회하는 것은 **Okta 애플리케이션을 직접 대상으로 공격**하여 달성할 수 있습니다. **Okta 액세스 토큰**을 사용하여 주요 Okta 대시보드가 아닌 **애플리케이션별 Okta URL**에서 토큰을 재생합니다.

주요 권장 사항은 다음과 같습니다:

* 캡처된 액세스 토큰을 재생할 때 **인기 있는 익명화 프록시 및 VPN 서비스를 사용하지 않습니다**.
* 클라이언트와 재생된 액세스 토큰 사이에서 **일관된 사용자 에이전트 문자열**을 보장합니다.
* 동일한 IP 주소에서 다른 사용자의 토큰을 재생하지 않도록 **주의**합니다.
* Okta 대시보드에 대한 토큰을 재생할 때 주의합니다.
* 피해 회사의 IP 주소를 알고 있다면, 해당 IP 또는 해당 범위로의 트래픽을 **제한**하고 다른 모든 트래픽을 차단합니다.

## Okta 강화

Okta에는 많은 가능한 구성이 있으며, 이 페이지에서는 가능한 한 안전한 상태로 검토하는 방법을 찾을 수 있습니다:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## 참고 자료

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter**에서 **팔로우**하세요 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **자신의 해킹 기법을 공유**하세요.

</details>
