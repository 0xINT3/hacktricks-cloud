# Oktaセキュリティ

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする。

</details>

## 基本情報

[Okta, Inc.](https://www.okta.com/)は、クラウドベースのソフトウェアソリューションを提供することで、アイデンティティおよびアクセス管理セクターで認知されています。これらのソリューションは、さまざまなモダンアプリケーション全体でユーザー認証を効率化し、セキュリティを確保するよう設計されています。これらは、機密データを保護しようとする企業だけでなく、アイデンティティコントロールをアプリケーション、Webサービス、およびデバイスに統合したい開発者にも対応しています。

Oktaの主力製品は**Okta Identity Cloud**です。このプラットフォームには、次の製品などが含まれます。

- **シングルサインオン（SSO）**：複数のアプリケーション全体で1つのログイン資格情報を許可することで、ユーザーアクセスを簡素化します。
- **マルチファクタ認証（MFA）**：複数の検証形式を要求することでセキュリティを強化します。
- **ライフサイクル管理**：ユーザーアカウントの作成、更新、無効化プロセスを自動化します。
- **ユニバーサルディレクトリ**：ユーザー、グループ、デバイスの中央管理を可能にします。
- **APIアクセス管理**：APIへのアクセスを保護し管理します。

これらのサービスは、データ保護を強化し、ユーザーアクセスを簡素化することで、セキュリティと利便性の両方を向上させることを目指しています。Oktaのソリューションの多様性は、大企業、中小企業、個々の開発者にとっても人気のある選択肢となっており、2021年9月の最新情報によると、Oktaはアイデンティティおよびアクセス管理（IAM）分野で著名な存在として認識されています。

{% hint style="danger" %}
Oktaの主な目標は、異なるユーザーやグループに対する外部アプリケーションへのアクセスを構成することです。Oktaの環境で**管理者特権を侵害**することができれば、おそらく会社が使用している他のプラットフォームを**すべて侵害**することができるでしょう。
{% endhint %}

{% hint style="success" %}
Okta環境のセキュリティレビューを実行するには、**管理者の読み取り専用アクセス**を要求する必要があります。
{% endhint %}

### 概要

**ユーザー**（Oktaに**保存されている**、構成された**アイデンティティプロバイダー**からログインされる、または**Active Directory**やLDAPを介して認証されることができる）が存在します。\
これらのユーザーは**グループ**に所属することができます。\
**認証子**も存在します：パスワードなどの認証方法やWebAuthn、メール、電話、okta verifyなどのさまざまな2要素認証が有効または無効になっている可能性があります...

次に、Oktaと同期された**アプリケーション**があります。各アプリケーションはOktaとの**マッピング**を持ち、情報（電子メールアドレス、名前など）を共有します。さらに、各アプリケーションは、ユーザーがアプリケーションに**アクセス**するために**必要な認証子**を示す**認証ポリシー**内に配置されている必要があります。

{% hint style="danger" %}
最も強力な役割は**スーパー管理者**です。

攻撃者が管理者アクセスでOktaを侵害すると、Oktaを信頼する**すべてのアプリケーションがおそらく侵害**されるでしょう。
{% endhint %}

## 攻撃

### Oktaポータルの特定

通常、企業のポータルは**companyname.okta.com**に位置しています。見つからない場合は、**companyname.**の単純な**バリエーション**を試してみてください。見つからない場合は、組織が**`okta.companyname.com`**のような**CNAME**レコードを持っている可能性もあり、これは**Oktaポータル**を指しています。

### Kerberosを介したOktaへのログイン

**`companyname.kerberos.okta.com`**がアクティブである場合、**KerberosがOktaアクセスに使用**され、通常は**Windows**ユーザーの**MFA**をバイパスします。ADでKerberos認証されたOktaユーザーを見つけるには、**`getST.py`**を**適切なパラメータ**で実行します。**ADユーザーチケット**を取得したら、RubeusやMimikatzなどのツールを使用して**制御されたホストに注入**し、**`clientname.kerberos.okta.com`がInternet Optionsの「Intranet」ゾーンにあることを確認**します。特定のURLにアクセスすると、JSONの「OK」応答が返され、Kerberosチケットが受け入れられ、Oktaダッシュボードにアクセスできることが示されます。

**Oktaサービスアカウントを委任SPNで侵害すると、Silver Ticket攻撃が可能になります。**ただし、Oktaがチケット暗号化に**AES**を使用しているため、AESキーまたは平文パスワードを所有する必要があります。**`ticketer.py`を使用して被害者ユーザーのためのチケットを生成**し、ブラウザを介して配信してOktaで認証することができます。

**攻撃内容は[https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)で確認できます。**

### Okta ADエージェントのハイジャック

この技術は、ユーザーを同期し、認証を処理する**Okta ADエージェントにアクセス**することを含みます。**`OktaAgentService.exe.config`**で構成を調査し、AgentTokenを**DPAPI**を使用して復号化することで、攻撃者は潜在的に**認証データを傍受および操作**することができます。これにより、Okta認証プロセス中に平文でユーザー資格情報を**監視**および**キャプチャ**するだけでなく、認証試行に**応答**することが可能となり、不正アクセスを可能にしたり、Oktaを介して普遍的な認証を提供したりすることができます（「スケルトンキー」と同様）。

**攻撃内容は[https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)で確認できます。**

### 管理者としてADのハイジャック

この技術は、最初にOAuthコードを取得し、次にAPIトークンを要求することで、Okta ADエージェントをハイジャックすることを含みます。トークンはADドメインに関連付けられ、**コネクタが偽のADエージェントを確立するために名前が付けられます**。初期化により、エージェントは**認証試行を処理**し、Okta APIを介して資格情報をキャプチャすることが可能となります。このプロセスを効率化するための自動化ツールが利用可能であり、Okta環境内で認証データを傍受および処理するシームレスな方法を提供します。

**攻撃内容は[https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)で確認できます。**

### OktaフェイクSAMLプロバイダ

**攻撃内容は[https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)で確認できます。**

この技術は、**フェイクSAMLプロバイダを展開**することを含みます。特権アカウントを使用してOktaのフレームワーク内に外部アイデンティティプロバイダ（IdP）を統合することで、攻撃者は**IdPを制御し、任意の認証リクエストを承認**することができます。このプロセスには、OktaにSAML 2.0 IdPを設定し、IdPシングルサインオンURLをローカルホストファイルを介したリダイレクトに操作し、自己署名証明書を生成し、Okta設定をユーザー名またはメールアドレスに一致するように構成することが含まれます。これらの手順を成功裏に実行することで、個々のユーザー資格情報が不要となり、個々のユーザー資格情報が不要となり、アクセス制御が大幅に向上し、潜在的に気づかれない方法でOktaユーザーとして認証することが可能となります。

### Evilgnixを使用したOktaポータルのフィッシング

[**このブログ記事**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)では、Oktaポータルに対するフィッシングキャンペーンの準備方法が説明されています。

### 同僚のなりすまし攻撃

各ユーザーが持つおよび変更できる**属性**（電子メールや名前など）は、Oktaで構成できます。**アプリケーション**が**IDとして信頼**している**属性**をユーザーが**変更**できる場合、そのプラットフォームで**他のユーザーをなりすます**ことができます。

したがって、アプリケーションが**`userName`**フィールドを信頼している場合、おそらく変更できない可能性があります（通常、そのフィールドを変更することはできません）、しかし、たとえば**`primaryEmail`**を信頼している場合、同僚のメールアドレスに変更してなりすますことができるかもしれません（メールにアクセスして変更を承認する必要があります）。

このなりすましは、各アプリケーションがどのように構成されているかに依存します。変更したフィールドを信頼し、更新を受け入れるアプリケーションのみが侵害されます。\
したがって、そのフィールドが存在する場合、アプリケーションはこのフィールドを有効にしている必要があります：

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

他のアプリケーションも脆弱であるが、Oktaの設定にそのフィールドがない場合も見られました（最終的に異なるアプリケーションは異なる方法で構成されています）。

各アプリケーションで誰かをなりすますことができるかどうかを確認する最良の方法は、試してみることです！

## 行動検出ポリシーの回避 <a href="#id-9fde" id="id-9fde"></a>

Oktaの行動検出ポリシーは遭遇するまで不明かもしれませんが、それらを**バイパス**することは、主要なOktaダッシュボードを回避して**Ok
