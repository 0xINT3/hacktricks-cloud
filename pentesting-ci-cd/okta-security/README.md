# Sicurezza di Okta

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>

## Informazioni di base

[Okta, Inc.](https://www.okta.com/) √® riconosciuta nel settore della gestione delle identit√† e degli accessi per le sue soluzioni software basate su cloud. Queste soluzioni sono progettate per semplificare e proteggere l'autenticazione degli utenti su diverse applicazioni moderne. Si rivolgono non solo alle aziende che vogliono proteggere i loro dati sensibili, ma anche agli sviluppatori interessati ad integrare i controlli di identit√† nelle applicazioni, nei servizi web e nei dispositivi.

L'offerta principale di Okta √® l'**Okta Identity Cloud**. Questa piattaforma comprende una serie di prodotti, tra cui:

- **Single Sign-On (SSO)**: Semplifica l'accesso dell'utente consentendo un unico set di credenziali di accesso su pi√π applicazioni.
- **Multi-Factor Authentication (MFA)**: Migliora la sicurezza richiedendo pi√π forme di verifica.
- **Gestione del ciclo di vita**: Automatizza i processi di creazione, aggiornamento e disattivazione degli account utente.
- **Directory universale**: Consente la gestione centralizzata di utenti, gruppi e dispositivi.
- **Gestione dell'accesso alle API**: Protegge e gestisce l'accesso alle API.

Questi servizi mirano collettivamente a rafforzare la protezione dei dati e semplificare l'accesso degli utenti, migliorando sia la sicurezza che la comodit√†. La versatilit√† delle soluzioni di Okta le rende una scelta popolare in diversi settori, vantaggiose per grandi aziende, piccole imprese e sviluppatori individuali. Alla data dell'ultimo aggiornamento nel settembre 2021, Okta √® riconosciuta come un'entit√† di spicco nell'ambito della gestione delle identit√† e degli accessi (IAM).

{% hint style="danger" %}
L'obiettivo principale di Okta √® configurare l'accesso di diversi utenti e gruppi ad applicazioni esterne. Se riesci a **compromettere i privilegi di amministratore in un ambiente Okta**, molto probabilmente sarai in grado di **compromettere tutte le altre piattaforme utilizzate dall'azienda**.
{% endhint %}

{% hint style="success" %}
Per effettuare una revisione di sicurezza di un ambiente Okta, dovresti richiedere l'accesso **solo in lettura per gli amministratori**.
{% endhint %}

### Riassunto

Ci sono **utenti** (che possono essere **archiviati in Okta**, acceduti da **Identity Providers** configurati o autenticati tramite **Active Directory** o LDAP).\
Questi utenti possono essere all'interno di **gruppi**.\
Ci sono anche **autenticatori**: diverse opzioni per l'autenticazione come la password e diverse forme di autenticazione a due fattori come WebAuthn, email, telefono, okta verify (possono essere abilitati o disabilitati)...

Poi, ci sono **applicazioni** sincronizzate con Okta. Ogni applicazione avr√† una qualche **corrispondenza con Okta** per condividere informazioni (come gli indirizzi email, i nomi...). Inoltre, ogni applicazione deve essere all'interno di una **Policy di Autenticazione**, che indica gli **autenticatori necessari** per un utente per **accedere** all'applicazione.

{% hint style="danger" %}
Il ruolo pi√π potente √® quello di **Super Amministratore**.

Se un attaccante compromette Okta con l'accesso di amministratore, tutte le **app che si fidano di Okta** saranno molto probabilmente **compromesse**.
{% endhint %}

## Attacchi

### Localizzazione del portale di Okta

Di solito il portale di un'azienda si trova in **companyname.okta.com**. Se non √® cos√¨, prova semplici **variazioni** di **companyname**. Se non riesci a trovarlo, √® anche possibile che l'organizzazione abbia un record **CNAME** come **`okta.companyname.com`** che punta al **portale Okta**.

### Accesso a Okta tramite Kerberos

Se **`companyname.kerberos.okta.com`** √® attivo, viene utilizzato **Kerberos per l'accesso a Okta**, bypassando tipicamente l'**MFA** per gli utenti **Windows**. Per trovare gli utenti Okta autenticati tramite Kerberos in AD, esegui **`getST.py`** con i **parametri appropriati**. Una volta ottenuto un **ticket utente AD**, **iniettalo** in un host controllato utilizzando strumenti come Rubeus o Mimikatz, assicurandoti che **`clientname.kerberos.okta.com` sia nella zona "Intranet" delle Opzioni Internet**. L'accesso a un URL specifico dovrebbe restituire una risposta JSON "OK", indicando l'accettazione del ticket Kerberos e concedendo l'accesso alla dashboard di Okta.

La compromissione dell'**account di servizio Okta con l'abilitazione di delega SPN consente un attacco Silver Ticket**. Tuttavia, l'uso di Okta di **AES** per la crittografia dei ticket richiede il possesso della chiave AES o della password in chiaro. Utilizza **`ticketer.py` per generare un ticket per l'utente vittima** e consegnalo tramite il browser per autenticarsi con Okta.

**Controlla l'attacco su [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Dirottamento dell'Agente Okta AD

Questa tecnica prevede l'**accesso all'Agente Okta AD su un server**, che **sincronizza gli utenti e gestisce l'autenticazione**. Esaminando e decrittando le configurazioni in **`OktaAgentService.exe.config`**, in particolare l'AgentToken utilizzando **DPAPI**, un attaccante pu√≤ potenzialmente **intercettare e manipolare i dati di autenticazione**. Ci√≤ consente non solo di **monitorare** e **catturare le credenziali degli utenti** in chiaro durante il processo di autenticazione di Okta, ma anche di **rispondere ai tentativi di autenticazione**, consentendo cos√¨ l'accesso non autorizzato o fornendo un'autenticazione universale tramite Okta (simile ad una "chiave universale").

**Controlla l'attacco su [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Dirottamento di AD come amministratore

Questa tecnica prevede il dirottamento di un Agente Okta AD ottenendo prima un Codice OAuth, quindi richiedendo un token API. Il token √® associato a un dominio AD e viene nominato un **connettore per stabilire un falso agente AD**. L'inizializzazione consente all'agente di **elaborare i tentativi di autenticazione**, catturando le credenziali tramite l'API di Okta. Sono disponibili strumenti di automazione per semplificare questo processo, offrendo un metodo senza soluzione di continuit√† per intercettare e gestire i dati di autenticazione all'interno dell'ambiente Okta.

**Controlla l'attacco su [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers).**

### Provider SAML falso di Ok
### Phishing del portale Okta con Evilgnix

In [**questo post del blog**](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23) viene spiegato come preparare una campagna di phishing contro un portale Okta.

### Attacco di impersonificazione di un collega

Gli **attributi che ogni utente pu√≤ avere e modificare** (come l'email o il nome) possono essere configurati in Okta. Se un **applicazione** sta **fidando** su un **attributo** che l'utente pu√≤ **modificare**, sar√† in grado di **impersonare altri utenti in quella piattaforma**.

Pertanto, se l'applicazione sta fidando del campo **`userName`**, probabilmente non sarai in grado di cambiarlo (perch√© di solito non puoi modificare quel campo), ma se sta fidando ad esempio del campo **`primaryEmail`** potresti essere in grado di **modificarlo con l'indirizzo email di un collega** e impersonarlo (dovrai avere accesso all'email e accettare la modifica).

Si noti che questa impersonificazione dipende da come √® stata configurata ogni applicazione. Solo quelle che si fidano del campo che hai modificato e accettano gli aggiornamenti saranno compromesse.\
Pertanto, l'applicazione dovrebbe avere questo campo abilitato se esiste:

<figure><img src="../../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Ho anche visto altre applicazioni che erano vulnerabili ma non avevano quel campo nelle impostazioni di Okta (alla fine le diverse applicazioni sono configurate in modo diverso).

Il modo migliore per scoprire se puoi impersonare qualcuno su ogni app sarebbe provarci!

## Eludere le politiche di rilevamento comportamentale <a href="#id-9fde" id="id-9fde"></a>

Le politiche di rilevamento comportamentale in Okta potrebbero essere sconosciute fino a quando non vengono incontrate, ma √® possibile **eluderle** prendendo di mira direttamente le applicazioni di Okta, evitando la dashboard principale di Okta. Con un **token di accesso Okta**, riprodurre il token all'URL specifico dell'applicazione di Okta anzich√© alla pagina di accesso principale.

Le principali raccomandazioni includono:

* **Evitare di utilizzare** proxy anonimizzatori popolari e servizi VPN durante la riproduzione dei token di accesso catturati.
* Assicurarsi che gli **user-agent strings** siano coerenti tra il client e i token di accesso riprodotti.
* **Evitare di riprodurre** token di utenti diversi dallo stesso indirizzo IP.
* Fare attenzione quando si riproducono token sulla dashboard di Okta.
* Se si conoscono gli indirizzi IP dell'azienda vittima, **limitare il traffico** a quegli IP o al loro intervallo, bloccando tutto il resto del traffico.

## Rafforzamento di Okta

Okta ha molte possibili configurazioni, in questa pagina troverai come esaminarle per renderle il pi√π sicure possibile:

{% content-ref url="okta-hardening.md" %}
[okta-hardening.md](okta-hardening.md)
{% endcontent-ref %}

## Riferimenti

* [https://trustedsec.com/blog/okta-for-red-teamers](https://trustedsec.com/blog/okta-for-red-teamers)
* [https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23](https://medium.com/nickvangilder/okta-for-red-teamers-perimeter-edition-c60cb8d53f23)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
