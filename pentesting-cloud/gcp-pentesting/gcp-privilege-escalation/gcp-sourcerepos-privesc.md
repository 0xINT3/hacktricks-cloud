# GCP - Sourcerepos Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## ソースリポジトリ

ソースリポジトリについての詳細は以下をチェックしてください:

{% content-ref url="../../gcp-security/gcp-services/gcp-source-repositories-enum.md" %}
[gcp-source-repositories-enum.md](../../gcp-security/gcp-services/gcp-source-repositories-enum.md)
{% endcontent-ref %}

### `source.repos.get`

この権限を持っていると、リポジトリをローカルにダウンロードすることが可能です:
```bash
gcloud source repos clone <repo-name> --project=<project-uniq-name>
```
### `source.repos.update`

この権限を持つプリンシパルは、`gcloud source repos clone <repo>`でクローンしたリポジトリ内でコードを**書き込むことができます**。ただし、この権限はカスタムロールには添付できないため、以下のような事前定義されたロールを通じて与える必要があります：

* オーナー
* エディター
* ソースリポジトリ管理者 (`roles/source.admin`)
* ソースリポジトリライター (`roles/source.writer`)

書き込むには、通常の**`git push`**を実行します。

### `source.repos.setIamPolicy`

この権限を持つ攻撃者は、自分自身に前述の権限を付与することができます。

### シークレットアクセス

攻撃者がトークンが保存されている**シークレットへのアクセス権**を持っている場合、それらを盗むことができます。シークレットにアクセスする方法の詳細については、以下を確認してください：

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-secretmanager-privesc.md" %}
[gcp-secretmanager-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-secretmanager-privesc.md)
{% endcontent-ref %}

### SSHキーの追加

Webコンソールで**ソースリポジトリプロジェクトにsshキーを追加する**ことが可能です。これは**`/v1/sshKeys:add`**に対してPOSTリクエストを行い、[https://source.cloud.google.com/user/ssh\_keys](https://source.cloud.google.com/user/ssh\_keys)で設定できます。

SSHキーが設定されると、以下の方法でリポジトリにアクセスできます：

{% code overflow="wrap" %}
```bash
git clone ssh://username@domain.com@source.developers.google.com:2022/p/<proj-name>/r/<repo-name>
```
{% endcode %}

そして、通常通り**`git`** コマンドを使用します。

### 手動での認証情報

Source Repositoriesにアクセスするための手動での認証情報を作成することが可能です：

<figure><img src="../../../.gitbook/assets/image (135).png" alt=""><figcaption></figcaption></figure>

最初のリンクをクリックすると、[https://source.developers.google.com/auth/start?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform\&state\&authuser=3](https://source.developers.google.com/auth/start?scopes=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-platform\&state\&authuser=3) にリダイレクトされます。

これにより、**Google Cloud Development** へのアクセスを許可するための **Oauth認証プロンプト** が表示されます。したがって、**ユーザーの認証情報** または **ブラウザでのオープンセッション** が必要になります。

これにより、**`$HOME/.gitcookies`** にgitクッキーを設定するための **bashスクリプトを実行する** ページに送られます。

<figure><img src="../../../.gitbook/assets/image (134).png" alt=""><figcaption></figcaption></figure>

スクリプトを実行した後、git clone、pushなどを使用することができ、それが機能します。

### `source.repos.updateProjectConfig`

この権限を持っていると、プライベートキーを含むコードをアップロードしないようにするSource Repositoriesのデフォルト保護を無効にすることが可能です：
```bash
gcloud source project-configs update --disable-pushblock
```
```
また、異なるpub/subトピックを設定するか、完全に無効にすることもできます:
```
```bash
gcloud source project-configs update --remove-topic=REMOVE_TOPIC
gcloud source project-configs update --remove-topic=UPDATE_TOPIC
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**、または**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
