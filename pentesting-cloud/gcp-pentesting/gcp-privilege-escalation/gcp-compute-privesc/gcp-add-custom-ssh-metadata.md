# GCP - Agregar metadatos SSH personalizados

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Modificando los metadatos <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Si puedes **modificar los metadatos de la instancia**, hay numerosas formas de escalar privilegios localmente. Hay algunos escenarios que pueden llevar a una cuenta de servicio con este permiso:

_**Cuenta de servicio predeterminada**_\
Si el **alcance** de acceso de la cuenta de servicio se establece en **acceso completo** o al menos se permite expl√≠citamente **el acceso a la API de c√≥mputo**, entonces esta configuraci√≥n es **vulnerable** a la escalada. El **alcance** **predeterminado** no es **vulnerable**.

_**Cuenta de servicio personalizada**_\
Al utilizar una cuenta de servicio personalizada, **se necesita** **uno** de los siguientes permisos IAM para escalar privilegios:

* `compute.instances.setMetadata` (para afectar a una sola instancia)
* `compute.projects.setCommonInstanceMetadata` (para afectar a todas las instancias del proyecto)

Aunque Google [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#associating\_a\_service\_account\_to\_an\_instance) no utilizar alcances de acceso para cuentas de servicio personalizadas, todav√≠a es posible hacerlo. Necesitar√°s uno de los siguientes **alcances de acceso**:

* `https://www.googleapis.com/auth/compute`
* `https://www.googleapis.com/auth/cloud-platform`

### **Agregar claves SSH a los metadatos personalizados**

Los sistemas **Linux** en GCP normalmente ejecutar√°n scripts de [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Uno de estos es el [daemon de cuentas](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), que **peri√≥dicamente**