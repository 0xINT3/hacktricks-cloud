# GCP - 计算机权限提升

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## compute

### `compute.projects.setCommonInstanceMetadata`

通过此权限，您可以**修改**实例的**元数据**信息，并更改用户的**授权密钥**，或者**创建**一个具有 sudo 权限的**新用户**。因此，您将能够通过 SSH 在任何 VM 实例中执行操作，并窃取实例正在运行的 GCP 服务帐户。\
限制：

* 请注意，默认情况下在 VM 实例中运行的 GCP 服务帐户的**范围非常有限**
* 您需要**能够联系 SSH** 服务器以登录

有关如何利用此权限的更多信息，请查看：

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

此权限提供了与上一个权限相同的特权，但仅适用于特定实例，而不是整个项目。**与上一节相同的漏洞利用和限制适用**。

### `compute.instances.setIamPolicy`

此类权限将允许您**授予自己具有先前权限的角色**，并滥用它们来提升权限。

### **`compute.instances.osLogin`**

如果**实例中启用了 OSLogin**，使用此权限，您只需运行**`gcloud compute ssh [INSTANCE]`**即可连接到实例。您**不会在实例内部拥有 root 权限**。

### **`compute.instances.osAdminLogin`**

如果**实例中启用了 OSLogin**，使用此权限，您只需运行**`gcloud compute ssh [INSTANCE]`**即可连接到实例。您将在实例内部拥有**root 权限**。

### `compute.instances.create`,`iam.serviceAccounts.actAs`

此方法**使用指定的服务帐户创建新的 Compute Engine 实例**，然后将属于该服务帐户的令牌发送到**外部服务器**。

此方法需要以下附加**权限**：

* _compute.disks.create_
* _compute.instances.create_
* _compute.instances.setMetadata_
* _compute.instances.setServiceAccount_
* _compute.subnetworks.use_
* _compute.subnetworks.useExternalIp_
* _iam.serviceAccounts.actAs_

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image9-750x594.png)

此方法的漏洞脚本可以在[此处](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py)找到。

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

如果您具有**`osconfig.patchDeployments.create`**或**`osconfig.patchJobs.exec`**权限，您可以创建一个[**补丁作业或部署**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)。这将使您能够在项目中的所有计算实例上进行横向移动并获得代码执行权限。

如果要手动利用此功能，您需要创建一个[补丁作业](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json)或[部署](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json)来运行补丁作业：

`gcloud compute os-config patch-jobs execute --file=patch.json`

要部署补丁部署：

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

存在自动化工具，如[patchy](https://github.com/rek7/patchy)，用于检测宽松的权限并自动进行横向移动。

**您还可以滥用此功能以实现持久性。**

### `compute.machineImages.get`, (`compute.machineImages.create`)

（未经测试）使用第一个权限，可以**下载机器映像**。使用第二个权限，您可以**创建实例的映像并下载它**。\
下载机器映像的目的是**在其中搜索敏感信息**。

### `compute.machineImages.setIamPolicy`

使用此权限来**获取先前的权限**。

### `compute.snapshots.get`, (`compute.disks.createSnapshot`,`compute.snapshots.create`)

（未经测试）使用第一个权限，可以**下载快照**。使用第二个权限，您可以**创建磁盘的快照并下载它**。\
下载快照的目的是**在其中搜索敏感信息**。

TODO：检查授予权限的是哪个权限。

### `compute.snapshots.setIamPolicy`

使用此权限来**获取先前的权限**。

### `compute.disks.use`, `compute.disks.useReadOnly`

`TOOD`

### `compute.disks.setIamPolicy`

`TODO`

### `compute.disks.addResourcePolicies`

`TODO`

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
