# GCP - Escala√ß√£o de Privil√©gios no Compute

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## compute

### `compute.projects.setCommonInstanceMetadata`

Com essa permiss√£o, voc√™ pode **modificar** as informa√ß√µes de **metadados** de uma **inst√¢ncia** e alterar as **chaves autorizadas de um usu√°rio**, ou **criar** um **novo usu√°rio com permiss√µes de sudo**. Portanto, voc√™ poder√° executar via SSH em qualquer inst√¢ncia VM e roubar a Conta de Servi√ßo do GCP com a qual a Inst√¢ncia est√° sendo executada.\
Limita√ß√µes:

* Observe que as Contas de Servi√ßo do GCP em execu√ß√£o em inst√¢ncias VM por padr√£o t√™m um **escopo muito limitado**
* Voc√™ precisar√° ser **capaz de entrar em contato com o servidor SSH** para fazer login

Para obter mais informa√ß√µes sobre como explorar essa permiss√£o, consulte:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

Essa permiss√£o concede os **mesmos privil√©gios da permiss√£o anterior**, mas em uma inst√¢ncia espec√≠fica em vez de um projeto inteiro. As **mesmas explora√ß√µes e limita√ß√µes da se√ß√£o anterior se aplicam**.

### `compute.instances.setIamPolicy`

Esse tipo de permiss√£o permitir√° que voc√™ **conceda a si mesmo uma fun√ß√£o com as permiss√µes anteriores** e eleve os privil√©gios abusando delas.

### **`compute.instances.osLogin`**

Se o **OSLogin estiver habilitado na inst√¢ncia**, com essa permiss√£o, voc√™ pode simplesmente executar **`gcloud compute ssh [INST√ÇNCIA]`** e se conectar √† inst√¢ncia. Voc√™ **n√£o ter√° privil√©gios de root** dentro da inst√¢ncia.

### **`compute.instances.osAdminLogin`**

Se o **OSLogin estiver habilitado na inst√¢ncia**, com essa permiss√£o, voc√™ pode simplesmente executar **`gcloud compute ssh [INST√ÇNCIA]`** e se conectar √† inst√¢ncia. Voc√™ ter√° **privil√©gios de root** dentro da inst√¢ncia.

### `compute.instances.create`,`iam.serviceAccounts.actAs`

Este m√©todo **cria uma nova inst√¢ncia do Compute Engine com uma Conta de Servi√ßo especificada**, em seguida, **envia o token** pertencente a essa Conta de Servi√ßo para um **servidor externo**.

As seguintes permiss√µes adicionais s√£o necess√°rias para este m√©todo:

* _compute.disks.create_
* _compute.instances.create_
* _compute.instances.setMetadata_
* _compute.instances.setServiceAccount_
* _compute.subnetworks.use_
* _compute.subnetworks.useExternalIp_
* _iam.serviceAccounts.actAs_

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image9-750x594.png)

O script de explora√ß√£o para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Se voc√™ tiver as permiss√µes **`osconfig.patchDeployments.create`** ou **`osconfig.patchJobs.exec`**, poder√° criar um [**trabalho ou implanta√ß√£o de patch**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Isso permitir√° que voc√™ se mova lateralmente no ambiente e obtenha a execu√ß√£o de c√≥digo em todas as inst√¢ncias de computa√ß√£o dentro de um projeto.

Se voc√™ quiser explorar isso manualmente, precisar√° criar um [trabalho de patch](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) ou [implanta√ß√£o](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) para um trabalho de patch executado:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Para implantar uma implanta√ß√£o de patch:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Existem ferramentas automatizadas, como [patchy](https://github.com/rek7/patchy), para detectar permiss√µes laxas e mover-se automaticamente lateralmente.

**Voc√™ tamb√©m pode abusar disso para persist√™ncia.**

### `compute.machineImages.get`, (`compute.machineImages.create`)

(n√£o testado) Com a primeira permiss√£o, √© poss√≠vel **baixar uma imagem de m√°quina**. Com a segunda, voc√™ poderia **criar uma imagem de uma inst√¢ncia e baix√°-la**.\
O objetivo de baixar imagens de m√°quinas √© **procurar informa√ß√µes confidenciais nelas**.

### `compute.machineImages.setIamPolicy`

Use esta permiss√£o para **obter as permiss√µes anteriores**.

### `compute.snapshots.get`, (`compute.disks.createSnapshot`,`compute.snapshots.create`)

(n√£o testado) Com a primeira permiss√£o, √© poss√≠vel **baixar o snapshot**. Com a segunda, voc√™ poderia **criar um snapshot de um disco e baix√°-lo**.\
O objetivo de baixar snapshots √© **procurar informa√ß√µes confidenciais neles**.

TODO: Verifique qual permiss√£o √© aquela que concede permiss√µes para criar snapshots.

### `compute.snapshots.setIamPolicy`

Use esta permiss√£o para **obter as permiss√µes anteriores**.

### `compute.disks.use`, `compute.disks.useReadOnly`

`TOOD`

### `compute.disks.setIamPolicy`

`TODO`

### `compute.disks.addResourcePolicies`

`TODO`

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>