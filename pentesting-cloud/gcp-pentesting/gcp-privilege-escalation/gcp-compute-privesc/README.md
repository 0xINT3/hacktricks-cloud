# GCP - Escalada de Privil√©gios em Compute

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Compute

Para mais informa√ß√µes sobre Compute e VPC (rede) no GCP, confira:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### `compute.projects.setCommonInstanceMetadata`

Com essa permiss√£o, voc√™ pode **modificar** as informa√ß√µes de **metadados** de uma **inst√¢ncia** e alterar as **chaves autorizadas de um usu√°rio**, ou **criar** um **novo usu√°rio com permiss√µes de sudo**. Assim, voc√™ poder√° executar via SSH em qualquer inst√¢ncia de VM e roubar a Conta de Servi√ßo GCP que a Inst√¢ncia est√° utilizando.\
Limita√ß√µes:

* Note que as Contas de Servi√ßo GCP executadas em inst√¢ncias de VM por padr√£o t√™m um **escopo muito limitado**
* Voc√™ precisar√° ser **capaz de contatar o servidor SSH** para fazer login

Para mais informa√ß√µes sobre como explorar essa permiss√£o, confira:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

Esta permiss√£o concede os **mesmos privil√©gios da permiss√£o anterior**, mas sobre inst√¢ncias espec√≠ficas em vez de um projeto inteiro. As **mesmas explora√ß√µes e limita√ß√µes da se√ß√£o anterior se aplicam**.

### `compute.instances.setIamPolicy`

Este tipo de permiss√£o permitir√° que voc√™ **conceda a si mesmo um papel com as permiss√µes anteriores** e escale privil√©gios abusando delas.

### **`compute.instances.osLogin`**

Se o **OSLogin estiver habilitado na inst√¢ncia**, com esta permiss√£o voc√™ pode simplesmente executar **`gcloud compute ssh [INSTANCE]`** e conectar-se √† inst√¢ncia. Voc√™ **n√£o ter√° privil√©gios de root** dentro da inst√¢ncia.

### **`compute.instances.osAdminLogin`**

Se o **OSLogin estiver habilitado na inst√¢ncia**, com esta permiss√£o voc√™ pode simplesmente executar **`gcloud compute ssh [INSTANCE]`** e conectar-se √† inst√¢ncia. Voc√™ ter√° **privil√©gios de root** dentro da inst√¢ncia.

### `compute.instances.create`,`iam.serviceAccounts.actAs, compute.disks.create`, `compute.instances.create`, `compute.instances.setMetadata`, `compute.instances.setServiceAccount`, `compute.subnetworks.use`, `compute.subnetworks.useExternalIp`

√â poss√≠vel **criar uma m√°quina virtual com uma Conta de Servi√ßo atribu√≠da e roubar o token** da conta de servi√ßo acessando os metadados para escalar privil√©gios para ela.

O script de explora√ß√£o para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py).

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

Se voc√™ tiver as permiss√µes **`osconfig.patchDeployments.create`** ou **`osconfig.patchJobs.exec`**, voc√™ pode criar um [**trabalho de corre√ß√£o ou implanta√ß√£o**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching). Isso permitir√° que voc√™ se mova lateralmente no ambiente e obtenha execu√ß√£o de c√≥digo em todas as inst√¢ncias de computa√ß√£o dentro de um projeto.

Se voc√™ quiser explorar isso manualmente, precisar√° criar um [trabalho de corre√ß√£o](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json) ou [implanta√ß√£o](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json) para uma execu√ß√£o de trabalho de corre√ß√£o:

`gcloud compute os-config patch-jobs execute --file=patch.json`

Para implantar uma implanta√ß√£o de corre√ß√£o:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

Ferramentas automatizadas como [patchy](https://github.com/rek7/patchy) existem para detectar permiss√µes frouxas e mover-se lateralmente automaticamente.

**Voc√™ tamb√©m pode abusar disso para persist√™ncia.**

### `compute.machineImages.setIamPolicy`

**Conceda a si mesmo permiss√µes extras** para a Imagem de computa√ß√£o.

### `compute.snapshots.setIamPolicy`

**Conceda a si mesmo permiss√µes extras** para um snapshot de disco.

### `compute.disks.setIamPolicy`

**Conceda a si mesmo permiss√µes extras** para um disco.

### Bypass de Escopos de Acesso

Seguindo este link, voc√™ encontrar√° algumas [**ideias para tentar contornar os escopos de acesso**](../../../gcp-security/gcp-privilege-escalation/).

### Escalada de Privil√©gios Locais em Inst√¢ncia de Compute do GCP

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
