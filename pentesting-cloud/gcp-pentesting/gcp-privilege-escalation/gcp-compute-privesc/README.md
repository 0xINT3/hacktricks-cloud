# GCP - コンピュート特権昇格

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに送信してください。**

</details>

## compute

### `compute.projects.setCommonInstanceMetadata`

この権限を使用すると、**インスタンスのメタデータ情報を変更**し、**ユーザーの認証キーを変更**したり、**sudo権限を持つ新しいユーザーを作成**したりできます。したがって、SSH経由で任意のVMインスタンスに接続し、インスタンスが実行されているGCPサービスアカウントを盗むことができます。\
制限事項：

* デフォルトでVMインスタンスで実行されるGCPサービスアカウントは、**非常に限られたスコープ**を持っています
* SSHサーバーにログインできる必要があります

この権限を悪用する方法の詳細については、次を参照してください：

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

この権限は、前の権限と同じ特権を持ちますが、プロジェクト全体ではなく特定のインスタンスに対して適用されます。前のセクションと同じ攻撃手法と制限が適用されます。

### `compute.instances.setIamPolicy`

この種類の権限を使用すると、**前の権限を持つロールを自分自身に付与**し、それらを悪用して特権を昇格させることができます。

### **`compute.instances.osLogin`**

インスタンスで**OSLoginが有効になっている場合**、この権限を使用すると、単に**`gcloud compute ssh [INSTANCE]`**を実行してインスタンスに接続できます。インスタンス内では**ルート権限を持ちません**。

### **`compute.instances.osAdminLogin`**

インスタンスで**OSLoginが有効になっている場合**、この権限を使用すると、単に**`gcloud compute ssh [INSTANCE]`**を実行してインスタンスに接続できます。インスタンス内では**ルート権限を持ちます**。

### `compute.instances.create`,`iam.serviceAccounts.actAs`

このメソッドは、指定されたサービスアカウントを使用して新しいCompute Engineインスタンスを作成し、そのサービスアカウントに属するトークンを**外部サーバーに送信**します。

このメソッドには以下の追加の**権限が必要**です：

* _compute.disks.create_
* _compute.instances.create_
* _compute.instances.setMetadata_
* _compute.instances.setServiceAccount_
* _compute.subnetworks.use_
* _compute.subnetworks.useExternalIp_
* _iam.serviceAccounts.actAs_

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image9-750x594.png)

このメソッドのエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py)で見つけることができます。

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

**`osconfig.patchDeployments.create`**または**`osconfig.patchJobs.exec`**の権限がある場合、[**パッチジョブまたはデプロイメント**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)を作成できます。これにより、プロジェクト内のすべてのコンピュートインスタンスでコードを実行し、環境内を横断することができます。

手動でこれを悪用するには、[パッチジョブ](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json)または[デプロイメント](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json)を作成する必要があります。パッチジョブを実行するには：

`gcloud compute os-config patch-jobs execute --file=patch.json`

パッチデプロイメントを展開するには：

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

[patchy](https://github.com/rek7/patchy)などの自動化ツールを使用すると、緩い権限を検出して自動的に横断移動することができます。

**これを永続化のためにも悪用することができます。**

### `compute.machineImages.get`, (`compute.machineImages.create`)

(未検証)最初の権限では、**マシンイメージをダウンロード**することができます。2番目の権限では、**インスタンスのイメージを作成してダウンロード**することができます。\
マシンイメージをダウンロードする目的は、それらに**機密情報を検索**することです。

### `compute.machineImages.setIamPolicy`

この権限を使用して、**前の権限を取得**します。

### `compute.snapshots.get`, (`compute.disks.createSnapshot`,`compute.snapshots.create`)

(未検証)最初の権限では、**スナップショットをダウンロード**することができます。2番目の権限では、**ディスクのスナップショットを作成してダウンロード**することができます。\
スナップショットをダウンロードする目的は、それらに**機密情報を検索**することです。

TODO: スナップショットを作成する権限はどれですか。

### `compute.snapshots.setIamPolicy`

この権限を使用して、**前の権限を取得**します。

### `compute.disks.use`, `compute.disks.useReadOnly`

`TOOD`

### `compute.disks.setIamPolicy`

`TODO`

### `compute.disks.addResourcePolicies`

`TODO`

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
*
