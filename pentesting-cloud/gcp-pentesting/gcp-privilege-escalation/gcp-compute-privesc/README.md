# GCP - Compute Privesc

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## compute

### `compute.projects.setCommonInstanceMetadata`

この権限を持っていると、**インスタンス**の**メタデータ**情報を**変更**し、ユーザーの**認証キーを変更**するか、**sudo権限を持つ新しいユーザーを作成**することができます。したがって、任意のVMインスタンスにSSH経由で実行し、インスタンスが実行されているGCPサービスアカウントを盗むことができます。\
制限事項:

* VMインスタンスでデフォルトで実行されているGCPサービスアカウントは、**非常に限定されたスコープ**を持っていることに注意してください。
* SSHサーバーに**接触できる必要があります**。

この権限を悪用する方法の詳細は以下をチェックしてください:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

この権限は**前の権限と同じ特権を与えます**が、特定のインスタンスに対してのみです。**前のセクションと同じ悪用と制限が適用されます**。

### `compute.instances.setIamPolicy`

この種の権限を持っていると、**自分自身に前述の権限を持つ役割を付与**し、それらを悪用して権限を昇格させることができます。

### **`compute.instances.osLogin`**

**OSLoginがインスタンスで有効になっている場合**、この権限を持っていると、**`gcloud compute ssh [INSTANCE]`** を実行してインスタンスに接続することができます。インスタンス内で**root権限は持ちません**。

### **`compute.instances.osAdminLogin`**

**OSLoginがインスタンスで有効になっている場合**、この権限を持っていると、**`gcloud compute ssh [INSTANCE]`** を実行してインスタンスに接続することができます。インスタンス内で**root権限を持ちます**。

### `compute.instances.create`,`iam.serviceAccounts.actAs`

この方法は、指定されたサービスアカウントを持つ新しいCompute Engineインスタンスを**作成し**、そのサービスアカウントに属する**トークンを外部サーバーに送信します**。

この方法には以下の追加の**権限が必要です**:

* _compute.disks.create_
* _compute.instances.create_
* _compute.instances.setMetadata_
* _compute.instances.setServiceAccount_
* _compute.subnetworks.use_
* _compute.subnetworks.useExternalIp_
* _iam.serviceAccounts.actAs_

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image9-750x594.png)

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py)で見つけることができます。

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

**`osconfig.patchDeployments.create`** または **`osconfig.patchJobs.exec`** の権限を持っている場合、[**パッチジョブまたはデプロイメント**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)を作成することができます。これにより、環境内を横断して移動し、プロジェクト内のすべてのコンピュートインスタンスでコード実行を行うことができます。

手動でこれを悪用する場合は、パッチジョブ用の[patch job](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json)またはデプロイメント用の[deployment](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json)を作成する必要があります:

`gcloud compute os-config patch-jobs execute --file=patch.json`

パッチデプロイメントをデプロイするには:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

[patchy](https://github.com/rek7/patchy)のような自動ツールは、緩い権限を検出し、自動的に横断して移動するために存在します。

**また、これを永続性のために悪用することもできます。**

### `compute.machineImages.get`, (`compute.machineImages.create`)

(未テスト) 最初の権限では、**マシンイメージをダウンロード**することが可能です。2番目の権限では、インスタンスのイメージを**作成してダウンロードする**ことができます。\
マシンイメージをダウンロードする目的は、それらに含まれる**機密情報を探す**ことです。

### `compute.machineImages.setIamPolicy`

この権限を使用して、**前述の権限を取得します。**

### `compute.snapshots.get`, (`compute.disks.createSnapshot`,`compute.snapshots.create`)

(未テスト) 最初の権限では、**スナップショットをダウンロード**することが可能です。2番目の権限では、ディスクのスナップショットを**作成してダウンロードする**ことができます。\
スナップショットをダウンロードする目的は、それらに含まれる**機密情報を探す**ことです。

TODO: スナップショットを作成する権限を付与する権限を確認する。

### `compute.snapshots.setIamPolicy`

この権限を使用して、**前述の権限を取得します。**

### `compute.disks.use`, `compute.disks.useReadOnly`

`TOOD`

### `compute.disks.setIamPolicy`

`TODO`

### `compute.disks.addResourcePolicies`

`TODO`

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
