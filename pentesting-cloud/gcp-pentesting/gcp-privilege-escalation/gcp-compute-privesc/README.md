# GCP - Compute Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Compute

GCPのComputeとVPC（ネットワーク）についての詳細は以下をチェックしてください:

{% content-ref url="../../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### `compute.projects.setCommonInstanceMetadata`

この権限を持っていると、**インスタンス**の**メタデータ**情報を**変更**し、ユーザーの**認証キーを変更**するか、**sudo権限を持つ新しいユーザーを作成**することができます。したがって、任意のVMインスタンスにSSH経由で実行し、インスタンスが実行中のGCPサービスアカウントを盗むことができます。\
制限事項:

* VMインスタンスでデフォルトで実行されているGCPサービスアカウントは、**非常に限定されたスコープ**を持っていることに注意してください。
* ログインするためには、SSHサーバーに**接触できる必要があります**。

この権限を悪用する方法についての詳細は以下をチェックしてください:

{% content-ref url="gcp-add-custom-ssh-metadata.md" %}
[gcp-add-custom-ssh-metadata.md](gcp-add-custom-ssh-metadata.md)
{% endcontent-ref %}

### `compute.instances.setMetadata`

この権限は、特定のインスタンスに対して前の権限と**同じ特権を与えます**が、プロジェクト全体ではなく。**前のセクションと同じ悪用と制限が適用されます**。

### `compute.instances.setIamPolicy`

この種の権限を持っていると、**自分自身に前の権限を持つロールを付与**し、それらを悪用して権限を昇格させることができます。

### **`compute.instances.osLogin`**

インスタンスで**OSLoginが有効になっている場合**、この権限を持っていると、**`gcloud compute ssh [INSTANCE]`** を実行してインスタンスに接続することができます。インスタンス内で**root権限は持っていません**。

### **`compute.instances.osAdminLogin`**

インスタンスで**OSLoginが有効になっている場合**、この権限を持っていると、**`gcloud compute ssh [INSTANCE]`** を実行してインスタンスに接続することができます。インスタンス内で**root権限を持っています**。

### `compute.instances.create`,`iam.serviceAccounts.actAs`

この方法は、指定されたサービスアカウントを持つ新しいCompute Engineインスタンスを**作成し**、そのサービスアカウントに属する**トークンを外部サーバーに送信します**。

この方法には以下の**追加の権限が必要です**:

* _compute.disks.create_
* _compute.instances.create_
* _compute.instances.setMetadata_
* _compute.instances.setServiceAccount_
* _compute.subnetworks.use_
* _compute.subnetworks.useExternalIp_
* _iam.serviceAccounts.actAs_

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image9-750x594.png)

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/compute.instances.create.py)で見つけることができます。

### `osconfig.patchDeployments.create` | `osconfig.patchJobs.exec`

**`osconfig.patchDeployments.create`** または **`osconfig.patchJobs.exec`** の権限を持っている場合、[**パッチジョブまたはデプロイメント**](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)を作成することができます。これにより、環境内を横断して、プロジェクト内のすべてのコンピュートインスタンスでコード実行を得ることができます。

手動でこれを悪用する場合は、パッチジョブの[patch job](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_job.json)または[deployment](https://github.com/rek7/patchy/blob/main/pkg/engine/patches/patch\_deployment.json)を作成する必要があります:

`gcloud compute os-config patch-jobs execute --file=patch.json`

パッチデプロイメントをデプロイするには:

`gcloud compute os-config patch-deployments create my-update --file=patch.json`

[patchy](https://github.com/rek7/patchy)のような自動ツールが存在し、緩い権限を検出し、自動的に横断移動します。

**これを永続性のために悪用することもできます。**

### `compute.machineImages.setIamPolicy`

**自分自身に追加の権限を付与**するためにcomputeイメージ。

### `compute.snapshots.setIamPolicy`

**自分自身に追加の権限を付与**するためにディスクスナップショット。

### `compute.disks.setIamPolicy`

**自分自身に追加の権限を付与**するためにディスク。

### アクセススコープをバイパスする

このリンクに従うと、アクセススコープをバイパスしようとするいくつかの[**アイデア**](../../../gcp-security/gcp-privilege-escalation/)が見つかります。

### GCP Computeインスタンスでのローカル権限昇格

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
