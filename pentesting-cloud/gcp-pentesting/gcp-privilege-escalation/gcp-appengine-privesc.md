# GCP - AppEngine 特権昇格

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で **フォロー**する
* **ハッキングトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## App Engine

App Engineに関する詳細情報は次をチェックしてください:

{% content-ref url="../gcp-services/gcp-app-engine-enum.md" %}
[gcp-app-engine-enum.md](../gcp-services/gcp-app-engine-enum.md)
{% endcontent-ref %}

### `appengine.applications.get`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.operations.list`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.create`, `appengine.versions.get`, `appengine.versions.list`, `cloudbuild.builds.get`,`iam.serviceAccounts.actAs`, `resourcemanager.projects.get`, `storage.objects.create`, `storage.objects.list`

これらは **`gcloud` cli を使用してアプリをデプロイするために必要な権限** です。おそらく **`get`** と **`list`** は **回避** できるかもしれません。

Pythonのコード例は[https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine](https://github.com/GoogleCloudPlatform/python-docs-samples/tree/main/appengine)で見つけることができます。

デフォルトでは、Appサービスの名前は **`default`** になり、同じ名前のインスタンスは1つしか存在しません。\
これを変更して2番目のAppを作成するには、**`app.yaml`** でルートキーの値を **`service: my-second-app`** のように変更してください。
```bash
cd python-docs-samples/appengine/flexible/hello_world
gcloud app deploy #Upload and start application inside the folder
```
Give it at least 10-15分、うまくいかない場合は**数回デプロイし直して**数分待ちます。

{% hint style="info" %}
**使用するサービスアカウントを指定することが可能**ですが、デフォルトではApp EngineのデフォルトSAが使用されます。
{% endhint %}

アプリケーションのURLは、`https://<proj-name>.oa.r.appspot.com/`または`https://<service_name>-dot-<proj-name>.oa.r.appspot.com`のようなものです。

### `appengine.instances.enableDebug`, `appengine.instances.get`, `appengine.instances.list`, `appengine.operations.get`, `appengine.services.get`, `appengine.services.list`, `appengine.versions.get`, `appengine.versions.list`, `compute.projects.get`

これらの権限を持つと、**柔軟な**タイプのApp Engineインスタンスに**SSH経由でログイン**することが可能です（標準ではありません）。**`list`**および**`get`**権限の一部は**実際には必要ない**場合があります。
```bash
gcloud app instances ssh --service <app-name> --version <version-id> <ID>
```
### `appengine.applications.update`, `appengine.operations.get`

これはおそらく、アプリケーションをセットアップする際にGoogleが使用するバックグラウンドSAを変更するだけだと思いますので、これを悪用してサービスアカウントを盗むことはできないと思います。

{% code overflow="wrap" %}
```bash
gcloud app update --service-account=<sa_email>
```
{% endcode %}

### `appengine.versions.getFileContents`, `appengine.versions.update`

これらの権限の使用方法や有用性はわかりません（コードを変更すると新しいバージョンが作成されるため、単にコードを更新するか、IAMロールを更新できるかどうかはわかりませんが、おそらくできるはずです。おそらくバケット内のコードを変更することができるかもしれませんか？）。

### バケット上の書き込みアクセス

ソースコードが格納されているバケットに対する書き込みアクセス権があっても、**ソースコードと `manifest.json` を変更して任意のコードを実行することはできませんでした**。\
新しいバージョンが作成され、ソースコードとマニフェストがアップロードされるタイミングを検出し、それらを変更して新しいバージョンがバックドア付きのものを使用するようにすることができれば、可能かもしれません。

コンテナレイヤーもバケットに保存されているようですが、これらを変更することもできるかもしれませんか？
