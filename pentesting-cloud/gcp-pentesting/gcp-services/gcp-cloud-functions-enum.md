# GCP - Enumera√ß√£o de Fun√ß√µes na Nuvem

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Fun√ß√µes na Nuvem <a href="#reviewing-cloud-functions" id="reviewing-cloud-functions"></a>

As [Fun√ß√µes na Nuvem](https://cloud.google.com/functions/) do Google permitem que voc√™ hospede c√≥digo que √© executado quando um evento √© acionado, sem a necessidade de gerenciar um sistema operacional host. Essas fun√ß√µes tamb√©m podem armazenar vari√°veis de ambiente para serem usadas pelo c√≥digo.

### Enumera√ß√£o

```bash
# Listar fun√ß√µes
gcloud functions list
gcloud functions describe <nome_da_fun√ß√£o> # Verifique os gatilhos para ver como essa fun√ß√£o √© invocada
gcloud functions get-iam-policy <nome_da_fun√ß√£o>

# Obter logs de execu√ß√µes anteriores. Por padr√£o, limita a 10 linhas
gcloud functions logs read <nome_da_fun√ß√£o> --limit [N√öMERO]

# Chamar uma fun√ß√£o
curl https://<regi√£o>-<projeto>.cloudfunctions.net/<nome_da_fun√ß√£o>
gcloud functions call <nome_da_fun√ß√£o> --data='{"message": "Ol√°, mundo!"}'

# Se voc√™ conhece o nome dos projetos, pode tentar for√ßar nomes de fun√ß√µes na nuvem

# Obter eventos que podem ser usados para acionar uma fun√ß√£o na nuvem
gcloud functions event-types list

# Acessar a fun√ß√£o com autentica√ß√£o
curl -X POST https://<regi√£o>-<projeto>.cloudfunctions.net/<nome_da_fun√ß√£o> \
-H "Authorization: bearer $(gcloud auth print-identity-token)" \
-H "Content-Type: application/json" \
-d '{}'
```

### Armazenamento

O c√≥digo das Fun√ß√µes na Nuvem **√© armazenado no GCP Storage**. Portanto, qualquer pessoa com **acesso de leitura aos buckets** no GCP poder√° **ler o c√≥digo das Fun√ß√µes na Nuvem**.\
O c√≥digo √© armazenado em um bucket como:

`gcf-sources-<n√∫mero>-<regi√£o>/<nome_da_fun√ß√£o>-<uuid>/version-<n>/function-source.zip` \
por exemplo:\
`gcf-sources-645468741258-us-central1/function-1-003dcbdf-32e1-430f-a5ff-785a6e238c76/version-4/function-source.zip`

{% hint style="warning" %}
Qualquer usu√°rio com **privil√©gios de grava√ß√£o sobre o bucket** que armazena a Fun√ß√£o na Nuvem pode **sobrescrever o c√≥digo executado**.
{% endhint %}

### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes de fun√ß√£o na nuvem para escalar privil√©gios**:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudfunctions-privesc.md" %}
[gcp-cloudfunctions-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudfunctions-privesc.md)
{% endcontent-ref %}

### Roubar Requisi√ß√µes de Fun√ß√µes na Nuvem

Assim como voc√™ pode fazer com as fun√ß√µes AWS lambdas, voc√™ tamb√©m pode persistir nas Fun√ß√µes na Nuvem do GCP e roubar informa√ß√µes confidenciais da solicita√ß√£o enviada para a lambda modificando o fluxo da fun√ß√£o na nuvem com algo como [https://github.com/Djkusik/serverless\_persistency\_poc/tree/master/gcp](https://github.com/Djkusik/serverless\_persistency\_poc/tree/master/gcp)

### Enumerar Fun√ß√µes na Nuvem Abertas

Com o seguinte c√≥digo [retirado daqui](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_functions.sh), voc√™ pode encontrar Fun√ß√µes na Nuvem que permitem invoca√ß√µes n√£o autenticadas.

```bash
#!/bin/bash

############################
# Execute esta ferramenta para encontrar Fun√ß√µes na Nuvem que permitem invoca√ß√µes n√£o autenticadas
# em qualquer lugar em sua organiza√ß√£o GCP.
# Aproveite!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
    echo "[*] raspando projeto $proj"

    enabled=$(gcloud services list --project "$proj" | grep "Cloud Functions API")

    if [ -z "$enabled" ]; then
	continue
    fi


    for func_region in $(gcloud functions list --quiet --project "$proj" --format="value[separator=','](NAME,REGION)"); do
        # drop substring from first occurence of "," to end of string.
        func="${func_region%%,*}"
        # drop substring from start of string up to last occurence of ","
        region="${func_region##*,}"
        ACL="$(gcloud functions get-iam-policy "$func" --project "$proj" --region "$region")"

        all_users="$(echo "$ACL" | grep allUsers)"
        all_auth="$(echo "$ACL" | grep allAuthenticatedUsers)"

        if [ -z "$all_users" ]
        then
              :
        else
              echo "[!] Aberto para todos os usu√°rios: $proj: $func"
        fi

        if [ -z "$all_auth" ]
        then
              :
        else
              echo "[!] Aberto para todos os usu√°rios autenticados: $proj: $func"
        fi
    done
done
```

## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>