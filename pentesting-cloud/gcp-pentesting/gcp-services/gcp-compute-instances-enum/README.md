# GCP - √ânum√©ration de Compute

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GCP VPC & R√©seau

Apprenez comment cela fonctionne dans :

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Vous pouvez facilement trouver des instances de calcul avec des r√®gles de pare-feu ouvertes avec [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instances de calcul

C'est la mani√®re dont vous pouvez **ex√©cuter des machines virtuelles √† l'int√©rieur de GCP.** Consultez cette page pour plus d'informations :

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### √ânum√©ration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Pour plus d'informations sur comment **SSH** ou **modifier les m√©tadonn√©es** d'une instance pour **escalader les privil√®ges,** consultez cette page :

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Escalade de Privil√®ges

Dans la page suivante, vous pouvez v√©rifier comment **abuser des permissions de calcul pour escalader les privil√®ges** :

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Journaux de la Console S√©rie

Les journaux de la console s√©rie de Compute Engine sont une fonctionnalit√© qui vous permet de **voir et diagnostiquer les journaux de d√©marrage et du syst√®me d'exploitation** de vos instances de machine virtuelle.

Les journaux de la console s√©rie fournissent une **vue d√©taill√©e du processus de d√©marrage de l'instance**, y compris les messages du noyau, les scripts d'initialisation et d'autres √©v√©nements syst√®me qui se produisent pendant le d√©marrage. Cela peut √™tre utile pour d√©boguer des probl√®mes de d√©marrage, identifier des mauvaises configurations ou des erreurs logicielles, ou pour r√©soudre des probl√®mes de connectivit√© r√©seau.

Ces journaux **peuvent exposer des informations sensibles** des journaux syst√®me que les utilisateurs √† faibles privil√®ges ne voient g√©n√©ralement pas, mais avec les permissions IAM appropri√©es, vous pourriez √™tre en mesure de les lire.

Vous pouvez utiliser la [commande gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) suivante pour interroger les journaux du port s√©rie (la permission requise est `compute.instances.getSerialPortOutput`) :
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Gestionnaire de configuration OS

Vous pouvez utiliser le service de gestion de configuration OS pour **d√©ployer, interroger et maintenir des configurations coh√©rentes** (√©tat souhait√© et logiciels) pour votre instance de machine virtuelle (VM). Sur Compute Engine, vous devez utiliser les [politiques invit√©es](https://cloud.google.com/compute/docs/os-config-management#guest-policy) pour maintenir des configurations logicielles coh√©rentes sur une VM.

La fonctionnalit√© de gestion de configuration OS vous permet de d√©finir des politiques de configuration qui sp√©cifient quels paquets logiciels doivent √™tre install√©s, quels services doivent √™tre activ√©s et quels fichiers ou configurations doivent √™tre pr√©sents sur vos VMs. Vous pouvez utiliser une approche d√©clarative pour g√©rer la configuration logicielle de vos VMs, ce qui vous permet d'automatiser et d'augmenter plus facilement votre processus de gestion de configuration.

Cela permet √©galement de se connecter aux instances via les permissions IAM, ce qui est tr√®s **utile pour l'√©l√©vation de privil√®ges et le pivotement**.

{% hint style="warning" %}
Pour **activer os-config dans un projet entier ou dans une instance**, vous devez simplement d√©finir la cl√© de **m√©tadonn√©es** **`enable-oslogin`** sur **`true`** au niveau souhait√©.\
De plus, vous pouvez d√©finir la m√©tadonn√©e **`enable-oslogin-2fa`** sur **`true`** pour activer l'authentification √† deux facteurs (2fa).

Lorsque vous l'activez lors de la cr√©ation d'une instance, les cl√©s de m√©tadonn√©es seront automatiquement d√©finies.
{% endhint %}

Plus d'informations sur **l'authentification √† deux facteurs dans OS-config**, **cela s'applique uniquement si l'utilisateur est un utilisateur**, si c'est un compte de service (comme le compte de service compute), cela ne n√©cessitera rien de plus.

### √ânum√©ration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Images personnalis√©es

**Les images de calcul personnalis√©es peuvent contenir des d√©tails sensibles** ou d'autres configurations vuln√©rables que vous pouvez exploiter.

Lorsqu'une image est cr√©√©e, vous pouvez choisir **3 types de chiffrement** : Utiliser **une cl√© g√©r√©e par Google** (par d√©faut), une **cl√© de KMS**, ou une **cl√© brute** fournie par le client.

#### √ânum√©ration

Vous pouvez interroger la liste des images non standard dans un projet avec la commande suivante :

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
```markdown
Vous pouvez ensuite [**exporter**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **les disques virtuels** de n'importe quelle image dans plusieurs formats. La commande suivante exporterait l'image `test-image` au format qcow2, vous permettant de t√©l√©charger le fichier et de cr√©er une VM localement pour une investigation plus approfondie :
```
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### √âl√©vation de privil√®ges

Consultez la section sur l'√©l√©vation de privil√®ges des instances de calcul.

### Mod√®les d'instances personnalis√©s

Un [**mod√®le d'instance**](https://cloud.google.com/compute/docs/instance-templates/) **d√©finit les propri√©t√©s d'une instance** pour aider √† d√©ployer des configurations coh√©rentes. Ils peuvent contenir les m√™mes types de donn√©es sensibles que les m√©tadonn√©es personnalis√©es d'une instance en cours d'ex√©cution. Vous pouvez utiliser les commandes suivantes pour enqu√™ter :
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Il pourrait √™tre int√©ressant de savoir quel disque de nouvelles images est utilis√©, mais ces mod√®les n'auront g√©n√©ralement pas d'informations sensibles.

## Instantan√©s

Les **instantan√©s sont des sauvegardes de disques**. Notez que cela n'est pas la m√™me chose que le clonage d'un disque (une autre fonctionnalit√© disponible).\
L'**instantan√©** utilisera le **m√™me chiffrement que le disque** dont il provient.

### √ânum√©ration
```
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### √âl√©vation de privil√®ges

V√©rifiez la section sur l'√©l√©vation de privil√®ges des instances Compute.

## R√©f√©rences

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
