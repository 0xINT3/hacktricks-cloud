# GCP - Compute Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## GCP VPC & ネットワーキング

これがどのように機能するかについては、以下を参照してください:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### 列挙

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

オープンなファイアウォールルールを持つコンピュートインスタンスを簡単に見つけることができます。[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## コンピュートインスタンス

これは、**GCP内で仮想マシンを実行する方法**です。詳細については、このページを確認してください：

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### 列挙
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
インスタンスの**SSH**接続やメタデータの**変更**を行い、**権限昇格**をする方法については、このページをご覧ください：

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### 権限昇格

以下のページでは、**コンピュート権限を悪用して権限を昇格させる**方法について確認できます：

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### 認証なしの列挙

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### 永続性

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## シリアルコンソールログ

Compute Engine シリアルコンソールログは、仮想マシンインスタンスのブートとオペレーティングシステムのログを**閲覧および診断する**機能です。

シリアルコンソールログは、カーネルメッセージ、初期化スクリプト、ブートアップ中に発生するその他のシステムイベントを含む、インスタンスのブートプロセスの**低レベルビュー**を提供します。これは、ブートの問題のデバッグ、誤設定やソフトウェアエラーの特定、ネットワーク接続の問題のトラブルシューティングに役立ちます。

これらのログは、通常は低権限ユーザーが見ることのないシステムログから**機密情報を露出する可能性**がありますが、適切なIAM権限を持っていれば読むことができるかもしれません。

シリアルポートログを照会するには、以下の[gcloudコマンド](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output)を使用できます（必要な権限は`compute.instances.getSerialPortOutput`です）：
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## OS構成マネージャ

OS構成管理サービスを使用して、VMインスタンス（VM）の**一貫した構成（望ましい状態とソフトウェア）をデプロイ、クエリ、維持する**ことができます。Compute Engineでは、VM上で一貫したソフトウェア構成を維持するために[ゲストポリシー](https://cloud.google.com/compute/docs/os-config-management#guest-policy)を使用する必要があります。

OS構成管理機能を使用すると、インストールするソフトウェアパッケージ、有効にするサービス、VMに存在するファイルや構成を指定する構成ポリシーを定義できます。VMのソフトウェア構成を宣言的に管理することで、構成管理プロセスをより簡単に自動化し、スケールアップすることができます。

これにより、IAM権限を介してインスタンスにログインすることも可能になるため、**権限昇格やピボットに非常に役立ちます**。

{% hint style="warning" %}
プロジェクト全体またはインスタンスで**os-configを有効にする**には、メタデータキー**`enable-oslogin`**を望ましいレベルで**`true`**に設定するだけです。\
さらに、2faを有効にするためにメタデータ**`enable-oslogin-2fa`**を**`true`**に設定することができます。

インスタンスの作成時に有効にすると、メタデータキーが自動的に設定されます。
{% endhint %}

**OS-configの2faについて**、**ユーザーがユーザーの場合にのみ適用され**、SA（compute SAのような）の場合は、追加の要件はありません。

### 列挙
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## イメージ

### カスタムイメージ

**カスタムコンピュートイメージには機密情報**や他の脆弱な設定が含まれている可能性があり、それを利用できるかもしれません。

イメージを作成する際には、**3種類の暗号化**を選択できます: **Google管理キー**（デフォルト）、**KMSからのキー**、またはクライアントが提供する**生のキー**。

#### 列挙

以下のコマンドでプロジェクト内の非標準イメージのリストを照会できます:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

その後、任意のイメージから**仮想ディスク**を複数の形式で[**エクスポート**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export)することができます。次のコマンドは、イメージ`test-image`をqcow2形式でエクスポートし、ファイルをダウンロードしてローカルでVMを構築し、さらに調査を行うことができます：
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### 権限昇格

Compute Instancesの権限昇格セクションを確認してください。

### カスタムインスタンステンプレート

[**インスタンステンプレート**](https://cloud.google.com/compute/docs/instance-templates/)は、一貫した設定をデプロイするためのインスタンスプロパティを**定義します**。これらには、実行中のインスタンスのカスタムメタデータと同じタイプの機密データが含まれる可能性があります。調査するために、以下のコマンドを使用できます：
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
ディスクが新しいイメージを使用しているかどうかを知ることは興味深いかもしれませんが、これらのテンプレートには通常、機密情報は含まれていません。

## スナップショット

**スナップショットはディスクのバックアップです**。これはディスクのクローニング（別の利用可能な機能）と同じではないことに注意してください。\
**スナップショット**は、取得元の**ディスクと同じ暗号化を使用します**。

### 列挙
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### 権限昇格

Compute Instancesの権限昇格セクションを確認してください。

## 参考文献

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
