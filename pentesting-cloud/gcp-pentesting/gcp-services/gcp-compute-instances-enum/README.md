# GCP - Compute Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つける、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するには、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加してください。**

</details>

## GCP VPC＆ネットワーキング

これがどのように機能するかについては、次を参照してください：

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### 列挙

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)を使用して、オープンなファイアウォールルールを持つコンピュートインスタンスを簡単に見つけることができます。

## コンピュートインスタンス

これらは、**GCP内で仮想マシンを実行する方法**です。

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### 列挙
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
詳細な情報については、次のページを参照してください。インスタンスのSSHまたはメタデータの変更による特権のエスカレーションについては、次のページを参照してください：

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### 特権のエスカレーション

次のページでは、**コンピュートの権限を悪用して特権をエスカレーションする方法**について確認できます：

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### シリアルコンソールログ

Compute Engineシリアルコンソールログは、仮想マシンインスタンスのブートおよびオペレーティングシステムログを**表示および診断する**機能です。

シリアルコンソールログは、カーネルメッセージ、イニシャルスクリプト、およびブート時に発生するその他のシステムイベントなど、インスタンスのブートプロセスの**低レベルビュー**を提供します。これは、ブートの問題のデバッグ、ミス構成やソフトウェアエラーの特定、ネットワーク接続のトラブルシューティングなどに役立ちます。

これらのログには、通常は低特権ユーザーが見ることができないシステムログからの**機密情報が公開される場合があります**が、適切なIAM権限を持っていれば、それらを読むことができるかもしれません。

次の[gcloudコマンド](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output)を使用して、シリアルポートログをクエリできます（必要な権限は`compute.instances.getSerialPortOutput`です）：
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## OS設定マネージャー

OS設定管理サービスを使用して、VMインスタンス（VM）の一貫した設定（望ましい状態とソフトウェア）を**展開、クエリ、維持**することができます。Compute Engineでは、VM上の一貫したソフトウェア設定を維持するために、[ゲストポリシー](https://cloud.google.com/compute/docs/os-config-management#guest-policy)を使用する必要があります。

OS設定管理機能を使用すると、VMのソフトウェア構成を定義する設定ポリシーを作成できます。これにより、インストールするソフトウェアパッケージ、有効にするサービス、およびVMに存在するファイルや設定を指定できます。VMのソフトウェア構成を宣言的に管理することで、設定管理プロセスをより簡単に自動化し、スケーリングすることができます。

これにより、IAM権限を使用してインスタンスにログインすることも可能であり、特権昇格やピボットに非常に**便利**です。

{% hint style="warning" %}
プロジェクト全体またはインスタンス全体でos-configを**有効にするには**、望ましいレベルで**メタデータ**キー**`enable-oslogin`**を**`true`**に設定するだけです。\
さらに、メタデータ**`enable-oslogin-2fa`**を**`true`**に設定すると、2要素認証を有効にすることができます。

インスタンスを作成する際に有効にすると、メタデータキーが自動的に設定されます。
{% endhint %}

**OS-configでの2要素認証について**、**ユーザーの場合のみ適用**されます。コンピュートSAのようなSAの場合は、追加の設定は必要ありません。

### 列挙
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## イメージ

### カスタムイメージ

**カスタムコンピュートイメージには、機密情報や他の脆弱な設定が含まれている場合があります**。これらは攻撃の対象になります。

イメージを作成する際には、**3種類の暗号化**を選択できます: **Googleが管理するキー**（デフォルト）、**KMSからのキー**、またはクライアントから提供される**生のキー**。

#### 列挙

次のコマンドを使用して、プロジェクト内の非標準イメージのリストをクエリできます:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

次に、任意のイメージから[**仮想ディスク**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export)を複数の形式で**エクスポート**することができます。次のコマンドは、イメージ `test-image` を qcow2 形式でエクスポートし、ファイルをダウンロードしてさらなる調査のためにローカルで VM を構築することができます。
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### 特権エスカレーション

Compute Instancesの特権エスカレーションセクションを確認してください。

### カスタムインスタンステンプレート

[**インスタンステンプレート**](https://cloud.google.com/compute/docs/instance-templates/)は、一貫した設定を展開するためにインスタンスのプロパティを定義します。これには、実行中のインスタンスのカスタムメタデータと同じタイプの機密データが含まれる場合があります。以下のコマンドを使用して調査できます：
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
## スナップショット

**スナップショットはディスクのバックアップ**です。ただし、これはディスクのクローン（別の利用可能な機能）とは異なります。\
**スナップショット**は、元のディスクと**同じ暗号化**を使用します。

### 列挙
```
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### 特権昇格

Compute Instancesの特権昇格セクションを確認してください。

## 参考文献

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社の宣伝をHackTricksで見たい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
