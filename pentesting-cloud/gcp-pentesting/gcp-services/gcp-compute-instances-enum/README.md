# GCP - Enumeraci칩n de Compute

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GCP VPC & Redes

Aprende c칩mo funciona esto en:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeraci칩n

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

Puede encontrar f치cilmente instancias de c칩mputo con reglas de firewall abiertas con [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)

## Instancias de c칩mputo

Esta es la manera en que puede **ejecutar m치quinas virtuales dentro de GCP.** Consulte esta p치gina para m치s informaci칩n:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeraci칩n
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
Para obtener m치s informaci칩n sobre c칩mo **SSH** o **modificar los metadatos** de una instancia para **escalar privilegios,** consulta esta p치gina:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### Escalada de Privilegios

En la siguiente p치gina, puedes verificar c칩mo **abusar de los permisos de computaci칩n para escalar privilegios**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Registros de la Consola Serial

Los registros de la Consola Serial de Compute Engine son una caracter칤stica que te permite **ver y diagnosticar los registros de arranque y del sistema operativo** de tus instancias de m치quinas virtuales.

Los registros de la Consola Serial proporcionan una **vista a bajo nivel del proceso de arranque de la instancia**, incluyendo mensajes del kernel, scripts de inicio y otros eventos del sistema que ocurren durante el arranque. Esto puede ser 칰til para depurar problemas de arranque, identificar configuraciones err칩neas o errores de software, o solucionar problemas de conectividad de red.

Estos registros **pueden exponer informaci칩n sensible** de los registros del sistema que un usuario con bajos privilegios normalmente no ver칤a, pero con los permisos de IAM adecuados podr칤as ser capaz de leerlos.

Puedes usar el siguiente [comando de gcloud](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) para consultar los registros del puerto serial (el permiso requerido es `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## Administrador de Configuraci칩n del SO

Puedes utilizar el servicio de administraci칩n de configuraci칩n del SO para **desplegar, consultar y mantener configuraciones consistentes** (estado deseado y software) para tu instancia de m치quina virtual (VM). En Compute Engine, debes usar [pol칤ticas de invitado](https://cloud.google.com/compute/docs/os-config-management#guest-policy) para mantener configuraciones de software consistentes en una VM.

La caracter칤stica de administraci칩n de configuraci칩n del SO te permite definir pol칤ticas de configuraci칩n que especifican qu칠 paquetes de software deben estar instalados, qu칠 servicios deben estar habilitados y qu칠 archivos o configuraciones deben estar presentes en tus VMs. Puedes usar un enfoque declarativo para gestionar la configuraci칩n de software de tus VMs, lo que te permite automatizar y escalar tu proceso de gesti칩n de configuraci칩n m치s f치cilmente.

Esto tambi칠n permite iniciar sesi칩n en instancias a trav칠s de permisos de IAM, por lo que es muy **칰til para privesc y pivoting**.

{% hint style="warning" %}
Para **habilitar os-config en todo un proyecto o en una instancia** solo necesitas establecer la clave de **metadata** **`enable-oslogin`** en **`true`** en el nivel deseado.\
Adem치s, puedes establecer la metadata **`enable-oslogin-2fa`** en **`true`** para habilitar el 2fa.

Cuando lo habilitas al crear una instancia, las claves de metadata se configurar치n autom치ticamente.
{% endhint %}

M치s sobre **2fa en OS-config**, **solo se aplica si el usuario es un usuario**, si es un SA (como el SA de compute) no requerir치 nada extra.

### Enumeraci칩n
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Im치genes

### Im치genes Personalizadas

**Las im치genes de computaci칩n personalizadas pueden contener detalles sensibles** u otras configuraciones vulnerables que puedes explotar.

Cuando se crea una imagen, puedes elegir **3 tipos de cifrado**: Usar **clave gestionada por Google** (predeterminado), una **clave de KMS**, o una **clave cruda** proporcionada por el cliente.

#### Enumeraci칩n

Puedes consultar la lista de im치genes no est치ndar en un proyecto con el siguiente comando:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

Luego puedes [**exportar**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **los discos virtuales** de cualquier imagen en m칰ltiples formatos. El siguiente comando exportar칤a la imagen `test-image` en formato qcow2, permiti칠ndote descargar el archivo y crear una VM localmente para una investigaci칩n m치s profunda:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Escalaci칩n de Privilegios

Consulta la secci칩n de escalamiento de privilegios de Instancias de Computaci칩n.

### Plantillas de Instancias Personalizadas

Una [**plantilla de instancia**](https://cloud.google.com/compute/docs/instance-templates/) **define las propiedades de la instancia** para ayudar a desplegar configuraciones consistentes. Estas pueden contener el mismo tipo de datos sensibles que los metadatos personalizados de una instancia en ejecuci칩n. Puedes utilizar los siguientes comandos para investigar:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
Podr칤a ser interesante saber qu칠 disco est치n utilizando las nuevas im치genes, pero estas plantillas normalmente no tendr치n informaci칩n sensible.

## Instant치neas

Las **instant치neas son copias de seguridad de discos**. Ten en cuenta que esto no es lo mismo que clonar un disco (otra caracter칤stica disponible).\
La **instant치nea** utilizar치 la **misma encriptaci칩n que el disco** del que se tom칩.

### Enumeraci칩n
```
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Escalada de Privilegios

Revisa la secci칩n de escalada de privilegios de las Instancias de Compute.

## Referencias

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
