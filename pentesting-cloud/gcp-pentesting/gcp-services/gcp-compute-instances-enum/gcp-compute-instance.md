# GCP - Compute Instance

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つける、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**でフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

### 機密VM

機密VMは、最新世代のAMD EPYCプロセッサが提供するハードウェアベースのセキュリティ機能を使用しています。これにはメモリの暗号化と安全な暗号化仮想化が含まれます。これらの機能により、VMはホストオペレーティングシステムとハイパーバイザーさえも保護し、それら内で処理および保存されるデータを保護することができます。

機密VMを実行するには、**マシンのタイプ**、**ネットワークインターフェース**、**ブートディスクイメージ**などを変更する必要がある場合があります。

### ディスクとディスクの暗号化

使用するディスクを**選択する**か、**新しいディスクを作成する**ことができます。新しいディスクを選択する場合、以下のオプションを設定できます。

* ディスクの**サイズ**を選択する
* **OS**を選択する
* インスタンスが削除されたときにディスクを削除するかどうかを指定する
* **暗号化**: デフォルトでは**Googleが管理するキー**が使用されますが、KMSからキーを選択するか、**使用する生のキー**を指定することもできます。

### コンテナのデプロイ

作成した仮想マシン内にコンテナをデプロイし、特権で実行したり、stdinや疑似TTYを設定したりすることができます。

### サービスアカウント

デフォルトでは、**Compute Engineのデフォルトサービスアカウント**が使用されます。このSAのメールアドレスは次のようになります：`<proj-num>-compute@developer.gserviceaccount.com`\
このサービスアカウントは、**プロジェクト全体に対してEditorの役割（高い特権）**を持っています。

また、**デフォルトのアクセススコープ**は次のとおりです：

* **https://www.googleapis.com/auth/devstorage.read\_only** -- バケットへの読み取りアクセス :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

ただし、**クリックで`cloud-platform`を付与する**か、**カスタムのスコープを指定する**ことも可能です。

### ファイアウォール

HTTPおよびHTTPSトラフィックを許可することができます。

### IPフォワーディング

インスタンスの作成時に**IPフォワーディングを有効にする**ことができます。

### 追加のセキュリティ

以下のオプションは、VMのセキュリティを**向上させる**ために推奨されます。

* **セキュアブート**
* **vTPMの有効化**
* **整合性監視**

### VMへのアクセス

VMへのアクセスを有効にする一般的な方法は、特定のSSH公開鍵を許可することです。\
ただし、IAMを使用してVMへのアクセスを**`os-config`サービスを介して有効にする**ことも可能です。さらに、このサービスを使用してVMへのアクセスに2要素認証を有効にすることもできます。\
この**サービスが有効になると、SSHキーによるアクセスは無効になります。**

### メタデータ

**ユーザーデータ**を定義することができます。これは、マシンが起動または再起動するたびに実行される**シェルコマンド**です。

また、メタデータエンドポイントからアクセス可能な**追加のメタデータキーと値**を追加することもできます。この情報は、環境変数や起動/シャットダウンスクリプトによく使用されます。これは、列挙セクションのコマンドの**`describe`メソッド**を使用して取得できますが、インスタンス内部からもメタデータエンドポイントにアクセスして取得することもできます。
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
さらに、**添付されたサービスアカウントの認証トークン**や、インスタンス、ネットワーク、プロジェクトの**一般的な情報**も**メタデータエンドポイント**から利用可能になります。詳細については、以下を参照してください：&#x20;

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし、**あなたの会社をHackTricksで宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
