# GCP - Compute Instances

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>

## 基本情報

Google Cloud Compute Instancesは、Googleのクラウドインフラストラクチャ上の**カスタマイズ可能な仮想マシン**であり、幅広いアプリケーションに対してスケーラブルでオンデマンドのコンピューティングパワーを提供します。グローバルデプロイメント、永続的なストレージ、柔軟なOS選択、強力なネットワーキングとセキュリティ統合などの機能を提供し、クラウド内で効率的にウェブサイトをホスティングしたり、データを処理したり、アプリケーションを実行するための多用途な選択肢となっています。

### Confidential VM

Confidential VMは、AMD EPYCプロセッサの最新世代が提供する**ハードウェアベースのセキュリティ機能**を使用します。これにはメモリ暗号化と安全な暗号化仮想化が含まれます。これらの機能により、VMはホストオペレーティングシステムやハイパーバイザーでさえも、その内部で処理および保存されるデータを保護することができます。

Confidential VMを実行するには、**マシンのタイプ**、ネットワーク**インターフェース**、**ブートディスクイメージ**などを**変更**する必要があるかもしれません。

### ディスク & ディスク暗号化

使用するディスクを**選択する**か、**新しいものを作成する**ことができます。新しいものを選択した場合、以下を行うことができます:

* ディスクの**サイズ**を選択する
* **OS**を選択する
* インスタンスが削除されたときにディスクを**削除するかどうか**を指定する
* **暗号化**: **デフォルト**では**Google管理のキー**が使用されますが、KMSからキーを**選択する**か、使用する**生のキー**を指定することもできます。

### コンテナのデプロイ

仮想マシン内に**コンテナ**をデプロイすることができます。\
使用する**イメージ**を設定し、内部で実行する**コマンド**、**引数**を設定し、**ボリューム**をマウントし、**環境変数**（機密情報？）を設定し、**特権**で実行する、stdinおよび擬似TTYなど、このコンテナのいくつかのオプションを設定することができます。

### サービスアカウント

デフォルトでは、**Compute Engineデフォルトサービスアカウント**が使用されます。このSAのメールは次のようになります: `<proj-num>-compute@developer.gserviceaccount.com`\
このサービスアカウントには、プロジェクト全体に対する**Editorロール（高い権限）**があります。

そして、**デフォルトのアクセススコープ**は以下の通りです:

* **https://www.googleapis.com/auth/devstorage.read\_only** -- バケットへの読み取りアクセス :)
* https://www.googleapis.com/auth/logging.write
* https://www.googleapis.com/auth/monitoring.write
* https://www.googleapis.com/auth/servicecontrol
* https://www.googleapis.com/auth/service.management.readonly
* https://www.googleapis.com/auth/trace.append

ただし、**`cloud-platform`をクリックで付与する**ことも、**カスタムスコープを指定する**ことも可能です。

<figure><img src="../../../../.gitbook/assets/image (138).png" alt=""><figcaption></figcaption></figure>

### ファイアウォール

HTTPおよびHTTPSトラフィックを許可することができます。

<figure><img src="../../../../.gitbook/assets/image (137).png" alt=""><figcaption></figcaption></figure>

### ネットワーキング

* **IPフォワーディング**: インスタンスの作成時にIPフォワーディングを**有効にする**ことができます。
* **ホスト名**: インスタンスに永続的なホスト名を付けることができます。
* **インターフェース**: ネットワークインターフェースを追加することができます。

### 追加のセキュリティ

これらのオプションはVMのセキュリティを**強化**し、推奨されます:

* **セキュアブート**: セキュアブートは、ブートレベルおよびカーネルレベルのマルウェアやルートキットからVMインスタンスを保護するのに役立ちます。
* **vTPMの有効化**: 仮想Trusted Platform Module (vTPM)は、ゲストVMのプレブートおよびブートの整合性を検証し、キー生成と保護を提供します。
* **整合性監視**: 整合性監視を使用すると、Stackdriverレポートを使用して、シールドされたVMインスタンスのランタイムブートの整合性を監視および検証できます。vTPMが有効になっている必要があります。

### VMアクセス

VMへのアクセスを有効にする一般的な方法は、特定のSSH公開鍵がVMにアクセスできるように**許可する**ことです。\
しかし、IAMを使用して`os-config`サービスを介してVMへのアクセスを**有効にする**ことも可能です。さらに、このサービスを使用してVMへのアクセスに2FAを有効にすることも可能です。\
この**サービス**が**有効**になると、**SSHキーによるアクセスは無効になります。**

<figure><img src="../../../../.gitbook/assets/image (139).png" alt=""><figcaption></figcaption></figure>

### メタデータ

**自動化**（AWSのuserdata）を定義することができます。これは、マシンがオンになるか再起動するたびに実行される**シェルコマンド**です。

また、メタデータエンドポイントからアクセス可能な**追加のメタデータキー値ペア**を追加することも可能です。この情報は、環境変数や起動/シャットダウンスクリプトに一般的に使用されます。これは、列挙セクションのコマンドの**`describe`メソッド**を使用して取得することができますが、インスタンス内部からメタデータエンドポイントにアクセスして取得することも可能です。
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
以下は、インスタンス、ネットワーク、プロジェクトに関する**一般情報**と、関連付けられたサービスアカウントの**認証トークン**も、**メタデータエンドポイント**から入手可能です。詳細は以下をチェックしてください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### 暗号化

デフォルトではGoogleが管理する暗号化キーが使用されますが、顧客管理暗号化キー（CMEK）を設定することもできます。使用しているCMEFが取り消された場合の対応も設定できます：何もしないか、VMをシャットダウンします。

<figure><img src="../../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
