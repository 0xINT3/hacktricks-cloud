# GCP - Compute Instances

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で**フォロー**する：[**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
- **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>

## 基本情報

Google Cloud Compute Instancesは、Googleのクラウドインフラストラクチャ上の**カスタマイズ可能な仮想マシン**であり、幅広いアプリケーションに対してスケーラブルでオンデマンドのコンピューティングパワーを提供します。グローバル展開、永続的なストレージ、柔軟なOSの選択肢、強力なネットワーキングおよびセキュリティ統合などの機能を提供し、ウェブサイトのホスティング、データ処理、およびクラウドでの効率的なアプリケーション実行に適した選択肢となっています。

### 機密VM

機密VMは、最新世代のAMD EPYCプロセッサが提供する**ハードウェアベースのセキュリティ機能**を利用しており、メモリ暗号化やセキュアな暗号化仮想化などが含まれています。これらの機能により、VMは、ホストオペレーティングシステムやハイパーバイザーさえもからデータを保護し、処理および保存されるデータを保護します。

機密VMを実行するには、**マシンのタイプ**、ネットワーク**インターフェース**、**ブートディスクイメージ**などを変更する必要がある場合があります。

### ディスク＆ディスク暗号化

使用するディスクを**選択**するか、**新しいディスクを作成**することが可能です。新しいディスクを選択する場合、以下の操作ができます：

- ディスクの**サイズ**を選択
- **OS**を選択
- インスタンスが削除されるときにディスクを**削除する**かどうかを指定
- **暗号化**：**デフォルト**では**Googleが管理するキー**が使用されますが、**KMSからキーを選択**するか、**使用するローカルキー**を指定することもできます。

### コンテナのデプロイ

仮想マシン内に**コンテナ**をデプロイすることが可能です。\
使用する**イメージ**を構成し、内部で実行する**コマンド**、**引数**、**ボリューム**をマウントし、**環境変数**（機密情報？）を設定し、このコンテナに対して**特権で実行**するか、stdinおよび擬似TTYを設定するなど、複数のオプションを構成することが可能です。

### サービスアカウント

デフォルトで、**Compute Engineデフォルトサービスアカウント**が使用されます。このSAのメールアドレスは次のようになります：`<proj-num>-compute@developer.gserviceaccount.com`\
このサービスアカウントには、プロジェクト全体で**Editorロール（高い権限）**が付与されています。

また、**デフォルトのアクセススコープ**は以下の通りです：

- **https://www.googleapis.com/auth/devstorage.read\_only** -- バケットへの読み取りアクセス :)
- https://www.googleapis.com/auth/logging.write
- https://www.googleapis.com/auth/monitoring.write
- https://www.googleapis.com/auth/servicecontrol
- https://www.googleapis.com/auth/service.management.readonly
- https://www.googleapis.com/auth/trace.append

ただし、**1クリックで`cloud-platform`を付与**するか、**カスタムのスコープを指定**することも可能です。

<figure><img src="../../../../.gitbook/assets/image (138).png" alt=""><figcaption></figcaption></figure>

### ファイアウォール

HTTPおよびHTTPSトラフィックを許可することが可能です。

<figure><img src="../../../../.gitbook/assets/image (137).png" alt=""><figcaption></figcaption></figure>

### ネットワーキング

- **IPフォワーディング**：インスタンスの作成時に**IPフォワーディングを有効にする**ことが可能です。
- **ホスト名**：インスタンスに永続的なホスト名を付与することが可能です。
- **インターフェース**：ネットワークインターフェースを追加することが可能です。

### 追加のセキュリティ

これらのオプションはVMのセキュリティを**向上**させ、推奨されています：

- **セキュアブート**：セキュアブートは、VMインスタンスをブートレベルおよびカーネルレベルのマルウェアやルートキットから保護します。
- **vTPMの有効化**：Virtual Trusted Platform Module（vTPM）は、ゲストVMのプリブートおよびブートの整合性を検証し、キーの生成と保護を提供します。
- **整合性監視**：整合性監視により、Stackdriverレポートを使用して、vTPMが有効になっている場合に、シールドされたVMインスタンスのランタイムブート整合性を監視および検証できます。

### VMアクセス

VMへのアクセスを有効にする一般的な方法は、特定のSSH公開鍵を許可することです。\
ただし、IAMを使用して`os-config`サービスを介してVMへのアクセスを有効にすることも可能です。さらに、このサービスを使用してVMへのアクセスに2要素認証を有効にすることも可能です。\
この**サービス**が**有効**になると、**SSHキーを介したアクセスが無効**になります。

<figure><img src="../../../../.gitbook/assets/image (139).png" alt=""><figcaption></figcaption></figure>

### メタデータ

毎回マシンがオンになるか再起動するたびに実行される**シェルコマンド**である**自動化**（AWSのuserdata）を定義することが可能です。

また、メタデータエンドポイントからアクセス可能な**追加のメタデータキー値**を定義することも可能です。この情報は環境変数や起動/シャットダウンスクリプトに使用されることが一般的です。これは列挙セクションのコマンドの**`describe`メソッド**を使用して取得できますが、インスタンス内部からメタデータエンドポイントにアクセスして取得することも可能です。
```bash
# view project metadata
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# view instance metadata
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
さらに、**添付されたサービスアカウントの認証トークン**と**インスタンス、ネットワーク、プロジェクトに関する一般情報**も**メタデータエンドポイント**から利用可能になります。詳細は以下を参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### 暗号化

デフォルトではGoogleが管理する暗号化キーが使用されますが、顧客管理型暗号化キー（CMEK）を構成することもできます。また、使用されているCMEFが取り消された場合の対処方法も構成できます：何もしないかVMをシャットダウンするか。

<figure><img src="../../../../.gitbook/assets/image (140).png" alt=""><figcaption></figcaption></figure>

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使用して、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手してください
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローしてください**
* **ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください**

</details>
