# GCP - VPC & ネットワーキング

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい**場合や、**PEASS の最新バージョンを入手したい**場合、または HackTricks を PDF でダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを見つけましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **HackTricks** と **HackTricks Cloud** の GitHub リポジトリに **PR を提出**して、自分のハッキングテクニックを共有しましょう。

</details>

## **GCP Compute Networking の概要**

**VPC** には、VPC への着信トラフィックを許可するための **ファイアウォール** ルールが含まれています。VPC にはまた、**仮想マシン** が **接続されるサブネット** も含まれています。\
AWS と比較すると、**ファイアウォール** は **セキュリティグループ** に最も近いものですが、この場合は **VPC に定義** されており、各インスタンスには定義されていません。

## **GCP における VPC、サブネット、およびファイアウォール**

Compute インスタンスは、**VPC**（[Virtual Private Cloud](https://cloud.google.com/vpc/docs/vpc)）の一部である **サブネット** に接続されます。GCP ではセキュリティグループは存在せず、[**VPC ファイアウォール**](https://cloud.google.com/vpc/docs/firewalls) があり、これらはネットワークレベルで定義されたルールが各 VM インスタンスに適用されます。

### サブネット

**VPC** には **複数のサブネット** を持つことができます。各 **サブネットは 1 つのリージョン**にあります。

### ファイアウォール

デフォルトでは、すべてのネットワークには2つの[**暗黙のファイアウォールルール**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)があります：**アウトバウンドを許可**し、**インバウンドを拒否**します。

GCP プロジェクトが作成されると、**`default`** という名前の VPC が作成され、次のファイアウォールルールが適用されます：

* **default-allow-internal:** `default` ネットワーク上の他のインスタンスからのすべてのトラフィックを許可します
* **default-allow-ssh:** どこからでも 22 番を許可します
* **default-allow-rdp:** どこからでも 3389 番を許可します
* **default-allow-icmp:** どこからでも ping を許可します

{% hint style="warning" %}
ご覧の通り、**ファイアウォールルール** は **内部 IP アドレス** に対しては **より許可的** になります。デフォルトの VPC では、Compute インスタンス間のすべてのトラフィックが許可されます。
{% endhint %}

デフォルトの VPC または新しい VPC のために、さらに **ファイアウォールルール** を作成することができます。[**ファイアウォールルール**](https://cloud.google.com/vpc/docs/firewalls) は、次の **方法**でインスタンスに適用することができます：

* [**ネットワークタグ**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**サービスアカウント**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC 内のすべてのインスタンス**

残念ながら、インターネット上のオープンポートを持つすべての Compute インスタンスを一覧表示するための簡単な `gcloud` コマンドはありません。ファイアウォールルール、ネットワークタグ、サービスアカウント、およびインスタンスの間の関連を把握する必要があります。

このプロセスは、[この Python スクリプト](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)を使用して自動化され、次の情報がエクスポートされます：

* インスタンス、パブリック IP、許可された TCP、許可された UDP を示す CSV ファイル
* パブリックインターネット（0.0.0.0/0）からのすべてのインスタンスを対象とする nmap スキャン
* パブリックインターネット（0.0.0.0/0）からすべての TCP ポートを許可するインスタンスの全 TCP レンジを対象とする masscan

### 階層型ファイアウォールポリシー <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_階層型ファイアウォールポリシー_ を使用すると、組織全体または個々の **フォルダ** に対して一貫したファイアウォールポリシーを作成して **強制する**ことができます。これらのポリシーには、接続を明示的に拒否または許可するルールが含まれています。

ファイアウォールポリシーは、別々のステップとして作成および適用します。ファイアウォールポリシーは、[**リソース階層**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)の **組織またはフォルダノード**で作成および適用できます。ファイアウォールポリシールールは、接続をブロック、接続を許可、または VPC ネットワークで定義された VPC ファイアウォールルールの評価を下位のフォルダまたは VPC に委任することができます。

デフォルトでは、階層型ファイアウォールポリシールールは、ポリシーが関連付けられている組織またはフォルダのすべてのプロジェクトのすべての VM に適用されます。ただし、[ターゲットネットワークまたはターゲットサービスアカウント](https://cloud.google.com/vpc/docs/firewall-policies#targets)を指定することで、特定の VM に対して特定のルールを適用することもできます。

[**階層型ファイアウォールポリシーの作成方法**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)については、こちらをご覧ください。

### ファイアウォールルールの評価

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## リージョナルファイアウォールポリシー

これらは **リージョンに割り当てられたファイアウォールルール** です。

## VPC ネットワークピアリング

2 つの Virtual Private Cloud (VPC) ネットワークを接続し、各ネットワークのリソースが互いに通信できるようにします。\
ピアリングされた VPC ネットワークは、同じプロジェクト、同じ組織の異なるプロジェクト、または異なる組織の異なるプロジェクトに存在することができます。

必要な権限は次のとおりです：

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `
## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社をハックトリックで宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れる
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
