# GCP - VPC & 网络

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## **GCP计算网络简介**

**VPCs** 包含**防火墙**规则，允许流量进入VPC。VPCs还包含**子网**，**虚拟机**将会**连接**到这些子网。\
与AWS相比，**防火墙**与**安全组**最为**相似**，但在这种情况下，防火墙规则是在**VPC中定义**的，而不是在每个实例中定义。

## **GCP中的VPC、子网和防火墙**

计算实例连接到**子网**，这些子网是**VPCs**（[虚拟私有云](https://cloud.google.com/vpc/docs/vpc)）的一部分。在GCP中没有安全组，有的是[**VPC防火墙**](https://cloud.google.com/vpc/docs/firewalls)，规则在网络级别定义，但应用于每个VM实例。

### 子网

一个**VPC**可以有**几个子网**。每个**子网位于1个区域**。

### 防火墙

默认情况下，每个网络都有两个[**隐含的防火墙规则**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules)：**允许出站**和**拒绝入站**。

当创建GCP项目时，也会创建一个名为**`default`**的VPC，其中包含以下防火墙规则：

* **default-allow-internal:** 允许来自`default`网络上其他实例的所有流量
* **default-allow-ssh:** 允许来自任何地方的22端口
* **default-allow-rdp:** 允许来自任何地方的3389端口
* **default-allow-icmp:** 允许来自任何地方的ping

{% hint style="warning" %}
如您所见，**防火墙规则**对**内部IP地址**往往**更宽松**。默认VPC允许计算实例之间的所有流量。
{% endhint %}

可以为默认VPC或新VPC创建更多**防火墙规则**。[**防火墙规则**](https://cloud.google.com/vpc/docs/firewalls)可以通过以下**方法**应用于实例：

* [**网络标签**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**服务账户**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC内的所有实例**

遗憾的是，没有一个简单的`gcloud`命令可以输出所有开放端口在互联网上的计算实例。您必须连接防火墙规则、网络标签、服务账户和实例之间的点。

这个过程使用[这个python脚本](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum)自动化，它将导出以下内容：

* 显示实例、公共IP、允许的TCP、允许的UDP的CSV文件
* nmap扫描针对所有实例的端口，这些端口从公共互联网（0.0.0.0/0）允许入站
* masscan针对那些允许来自公共互联网（0.0.0.0/0）的所有TCP端口的实例的完整TCP范围进行扫描

### 分层防火墙策略 <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_分层防火墙策略_ 让您可以在整个组织中创建和**执行一致的防火墙策略**。您可以将**分层防火墙策略分配给整个组织**或单个**文件夹**。这些策略包含可以明确拒绝或允许连接的规则。

您可以分别创建和应用防火墙策略。您可以在[**资源层次结构**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)的**组织或文件夹节点**创建和应用防火墙策略。防火墙策略规则可以**阻止连接、允许连接，或将防火墙规则评估推迟**到下级文件夹或在VPC网络中定义的VPC防火墙规则。

默认情况下，所有分层防火墙策略规则适用于组织或文件夹下所有项目中的所有VM。然而，您可以通过指定[目标网络或目标服务账户](https://cloud.google.com/vpc/docs/firewall-policies#targets)来**限制哪些VM获得给定规则**。

您可以在这里阅读如何[**创建分层防火墙策略**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)。

### 防火墙规则评估

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## 区域性防火墙策略

这些是**分配给一个区域的防火墙规则**。

## VPC网络对等连接

允许连接两个虚拟私有云（VPC）网络，以便**每个网络中的资源可以相互通信**。\
对等连接的VPC网络可以在同一个项目中，同一个组织的不同项目中，或**不同组织的不同项目中**。

这些是所需的权限：

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**更多信息请查阅文档**](https://cloud.google.com/vpc/docs/vpc-peering)。
## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客技术！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
