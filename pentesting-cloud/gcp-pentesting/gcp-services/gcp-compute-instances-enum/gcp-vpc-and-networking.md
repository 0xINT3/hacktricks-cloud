# GCP - VPC y Networking

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **GCP Compute Networking en pocas palabras**

Las **VPC** contienen reglas de **Firewall** para permitir el tr√°fico entrante a la VPC. Las VPC tambi√©n contienen **subredes** donde se van a conectar las **m√°quinas virtuales**.\
Comparando con AWS, el **Firewall** ser√≠a lo m√°s parecido a los **Security Groups**, pero en este caso estos est√°n **definidos en la VPC** y no en cada instancia.

## **VPC, Subredes y Firewalls en GCP**

Las instancias de c√≥mputo est√°n conectadas a **subredes** que son parte de las **VPC** ([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)). En GCP no hay grupos de seguridad, hay [**Firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) con reglas definidas en este nivel de red pero aplicadas a cada instancia de VM.

### Subredes

Una **VPC** puede tener **varias subredes**. Cada **subred est√° en 1 regi√≥n**.

### Firewalls

Por defecto, cada red tiene dos [**reglas de firewall impl√≠citas**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **permitir salida** y **denegar entrada**.

Cuando se crea un proyecto de GCP, se crea una VPC llamada **`default`**, con las siguientes reglas de firewall:

* **default-allow-internal:** permitir todo el tr√°fico de otras instancias en la red `default`
* **default-allow-ssh:** permitir 22 desde cualquier lugar
* **default-allow-rdp:** permitir 3389 desde cualquier lugar
* **default-allow-icmp:** permitir ping desde cualquier lugar

{% hint style="warning" %}
Como se puede ver, las **reglas de firewall** tienden a ser **m√°s permisivas** para las **direcciones IP internas**. La VPC predeterminada permite todo el tr√°fico entre las instancias de c√≥mputo.
{% endhint %}

Se pueden crear m√°s **reglas de firewall** para la VPC predeterminada o para nuevas VPC. Las [**reglas de firewall**](https://cloud.google.com/vpc/docs/firewalls) se pueden aplicar a las instancias a trav√©s de los siguientes **m√©todos**:

* [**Etiquetas de red**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Cuentas de servicio**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas las instancias dentro de una VPC**

Desafortunadamente, no hay un comando `gcloud` simple para mostrar todas las instancias de c√≥mputo con puertos abiertos en Internet. Hay que conectar los puntos entre las reglas de firewall, las etiquetas de red, las cuentas de servicio y las instancias.

Este proceso se automatiz√≥ utilizando [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) que exportar√° lo siguiente:

* Archivo CSV que muestra la instancia, la IP p√∫blica, el TCP permitido, el UDP permitido
* Escaneo de nmap para apuntar a todas las instancias en los puertos de ingreso permitidos desde Internet p√∫blico (0.0.0.0/0)
* Masscan para apuntar al rango TCP completo de aquellas instancias que permiten TODOS los puertos TCP desde Internet p√∫blico (0.0.0.0/0)

### Pol√≠ticas de Firewall Jer√°rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Las _pol√≠ticas de firewall jer√°rquicas_ le permiten crear y **aplicar una pol√≠tica de firewall consistente en toda su organizaci√≥n**. Puede asignar **pol√≠ticas de firewall jer√°rquicas a la organizaci√≥n** en su conjunto o a **carpetas** individuales. Estas pol√≠ticas contienen reglas que pueden denegar o permitir conexiones expl√≠citamente.

Crea y aplica pol√≠ticas de firewall como pasos separados. Puede crear y aplicar pol√≠ticas de firewall en los **nodos de organizaci√≥n o carpeta** de la [**jerarqu√≠a de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regla de pol√≠tica de firewall puede **bloquear conexiones, permitir conexiones o diferir la evaluaci√≥n de reglas de firewall** a carpetas de nivel inferior o reglas de firewall de VPC definidas en redes VPC.

Por defecto, todas las reglas de pol√≠tica de firewall jer√°rquicas se aplican a todas las VM en todos los proyectos bajo la organizaci√≥n o carpeta donde se asocia la pol√≠tica. Sin embargo, puede **restringir qu√© VM obtiene una regla dada** especificando [redes de destino o cuentas de servicio de destino](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Puede leer aqu√≠ c√≥mo [**crear una pol√≠tica de firewall jer√°rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluaci√≥n de Reglas de Firewall

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Pol√≠ticas de Firewall Regionales

Estas son **reglas de firewall asignadas a una regi√≥n**.

## VPC Network Peering

Permite conectar dos redes de Virtual Private Cloud (VPC) para que **los recursos de cada red puedan comunicarse** entre s√≠.\
Las redes VPC emparejadas pueden estar en el mismo proyecto, en diferentes proyectos de la misma organizaci√≥n o en **diferentes proyectos de diferentes organizaciones**.

Estos son los permisos necesarios:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[M√°s en la documentaci√≥n](https://cloud.google.com/vpc/docs/vpc-peering).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>