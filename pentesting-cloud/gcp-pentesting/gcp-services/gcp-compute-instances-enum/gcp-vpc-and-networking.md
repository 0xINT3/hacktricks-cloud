# GCP - VPC & Networking

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** repository [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## **GCP Compute Networking in breve**

**VPC** contiene regole di **Firewall** per consentire il traffico in ingresso alla VPC. Le VPC contengono anche **sottoreti** in cui saranno **collegate** le **macchine virtuali**.\
Rispetto ad AWS, il **Firewall** sarebbe la cosa pi√π **simile** a **AWS Security Groups e NACLs**, ma in questo caso sono **definiti nella VPC** e non in ogni istanza.

## **VPC, Sottoreti e Firewall in GCP**

Le istanze di calcolo sono collegate a **sottoreti** che fanno parte delle **VPC** ([Virtual Private Cloud](https://cloud.google.com/vpc/docs/vpc) di Google). In GCP non ci sono gruppi di sicurezza, ma ci sono [**firewall VPC**](https://cloud.google.com/vpc/docs/firewalls) con regole definite a livello di rete ma applicate a ogni istanza di VM.

### Sottoreti

Una **VPC** pu√≤ avere **diverse sottoreti**. Ogni **sottorete √® in una regione**.

### Firewall

Per impostazione predefinita, ogni rete ha due [**regole di firewall implicite**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **consenti in uscita** e **negare in ingresso**.

Quando viene creato un progetto GCP, viene creato anche una VPC chiamata **`default`**, con le seguenti regole di firewall:

* **default-allow-internal:** consente tutto il traffico da altre istanze sulla rete `default`
* **default-allow-ssh:** consente la porta 22 da qualsiasi posizione
* **default-allow-rdp:** consente la porta 3389 da qualsiasi posizione
* **default-allow-icmp:** consente il ping da qualsiasi posizione

{% hint style="warning" %}
Come puoi vedere, le **regole di firewall** tendono ad essere **pi√π permissive** per gli **indirizzi IP interni**. La VPC predefinita consente tutto il traffico tra le istanze di calcolo.
{% endhint %}

√à possibile creare ulteriori **regole di firewall** per la VPC predefinita o per nuove VPC. Le [**regole di firewall**](https://cloud.google.com/vpc/docs/firewalls) possono essere applicate alle istanze tramite i seguenti **metodi**:

* [**Tag di rete**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Account di servizio**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Tutte le istanze all'interno di una VPC**

Sfortunatamente, non esiste un semplice comando `gcloud` per visualizzare tutte le istanze di calcolo con porte aperte su Internet. √à necessario collegare le regole di firewall, i tag di rete, gli account di servizio e le istanze.

Questo processo √® stato automatizzato utilizzando [questo script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) che esporter√† quanto segue:

* File CSV che mostra l'istanza, l'IP pubblico, TCP consentito, UDP consentito
* Scansione nmap per indirizzare tutte le istanze sulle porte ingress consentite da Internet pubblico (0.0.0.0/0)
* Scansione masscan per indirizzare l'intero intervallo TCP di quelle istanze che consentono tutte le porte TCP da Internet pubblico (0.0.0.0/0)

### Politiche di firewall gerarchiche <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Le _politiche di firewall gerarchiche_ consentono di creare e **applicare una politica di firewall coerente in tutta l'organizzazione**. √à possibile assegnare **politiche di firewall gerarchiche all'organizzazione** nel suo complesso o a singole **cartelle**. Queste politiche contengono regole che possono esplicitamente negare o consentire connessioni.

La creazione e l'applicazione delle politiche di firewall avvengono come passaggi separati. √à possibile creare e applicare politiche di firewall ai **nodi dell'organizzazione o delle cartelle** della [**gerarchia delle risorse**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regola di politica di firewall pu√≤ **bloccare connessioni, consentire connessioni o differire la valutazione delle regole di firewall** a cartelle di livello inferiore o regole di firewall VPC definite nelle reti VPC.

Per impostazione predefinita, tutte le regole di politica di firewall gerarchiche si applicano a tutte le VM in tutti i progetti nell'organizzazione o nella cartella in cui √® associata la politica. Tuttavia, √® possibile **limitare quali VM ottengono una determinata regola** specificando [reti di destinazione o account di servizio di destinazione](https://cloud.google.com/vpc/docs/firewall-policies#targets).

√à possibile leggere qui come [**creare una politica di firewall gerarchica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Valutazione delle regole di firewall

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Politiche di firewall regionali

Queste sono **regole di firewall assegnate a una regione**.

## VPC Network Peering

Consente di collegare due reti Virtual Private Cloud (VPC) in modo che **le risorse in ciascuna rete possano comunicare** tra loro.\
Le reti VPC collegate possono essere nello stesso progetto, in progetti diversi della stessa organizzazione o in **progetti diversi di organizzazioni diverse**.

Queste sono le autorizzazioni necessarie:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Ulteriori informazioni nella documentazione**](https://cloud.google.com/vpc/docs/vpc-peering).

## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblic
