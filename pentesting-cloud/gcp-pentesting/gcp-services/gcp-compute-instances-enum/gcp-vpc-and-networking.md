# GCP - VPC和网络

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向**[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>

## **GCP计算机网络简介**

**VPC**包含用于允许流入VPC的流量的**防火墙**规则。VPC还包含**子网**，虚拟机将连接到这些子网上。\
与AWS相比，**防火墙**是与**安全组**最接近的东西，但在这种情况下，它们是在VPC中定义的，而不是在每个实例中定义的。

## **GCP中的VPC、子网和防火墙**

计算实例连接到**子网**，子网是**VPC**（[Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)）的一部分。在GCP中，没有安全组，而是具有在此网络级别定义但应用于每个VM实例的[**VPC防火墙**](https://cloud.google.com/vpc/docs/firewalls)。

### 子网

一个**VPC**可以有**多个子网**。每个**子网位于一个区域**。

### 防火墙

默认情况下，每个网络都有两个[**隐含的防火墙规则**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)：**允许出站**和**拒绝入站**。

当创建一个GCP项目时，还会创建一个名为**`default`**的VPC，其中包含以下防火墙规则：

* **default-allow-internal：**允许来自`default`网络上其他实例的所有流量
* **default-allow-ssh：**允许来自任何地方的22端口
* **default-allow-rdp：**允许来自任何地方的3389端口
* **default-allow-icmp：**允许来自任何地方的ping

{% hint style="warning" %}
正如您所看到的，**防火墙规则**对于**内部IP地址**往往更加**宽松**。默认的VPC允许计算实例之间的所有流量。
{% endhint %}

可以为默认VPC或新VPC创建更多的**防火墙规则**。[**防火墙规则**](https://cloud.google.com/vpc/docs/firewalls)可以通过以下**方法**应用于实例：

* [**网络标签**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**服务帐号**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC中的所有实例**

不幸的是，没有一个简单的`gcloud`命令可以列出所有在互联网上开放端口的计算实例。您必须将防火墙规则、网络标签、服务帐号和实例联系起来。

使用[此Python脚本](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)自动化了这个过程，它将导出以下内容：

* CSV文件显示实例、公共IP、允许的TCP、允许的UDP
* 针对从公共互联网（0.0.0.0/0）允许入口的所有实例进行的nmap扫描
* 针对从公共互联网（0.0.0.0/0）允许所有TCP端口的这些实例的完整TCP范围进行的masscan扫描

### 分层防火墙策略 <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_分层防火墙策略_允许您在整个组织中创建和**强制执行一致的防火墙策略**。您可以将**分层防火墙策略分配给组织**作为整体或个别**文件夹**。这些策略包含可以明确拒绝或允许连接的规则。

您可以将防火墙策略的创建和应用作为单独的步骤。您可以在**资源层次结构**（[**resource hierarchy**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)）的**组织或文件夹节点**上创建和应用防火墙策略。防火墙策略规则可以**阻止连接、允许连接或将防火墙规则评估推迟**到较低级别的文件夹或在VPC网络中定义的VPC防火墙规则。

默认情况下，所有分层防火墙策略规则都适用于与策略关联的组织或文件夹下的所有项目中的所有VM。但是，您可以通过指定[目标网络或目标服务帐号](https://cloud.google.com/vpc/docs/firewall-policies#targets)来**限制哪些VM获得特定规则**。

您可以在这里阅读如何[**创建分层防火墙策略**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)。

### 防火墙规则评估

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## 区域防火墙策略

这些是**分配给区域的防火墙规则**。

## VPC网络对等连接

允许连接两个虚拟专用云（VPC）网络，以便**每个网络中的资源可以彼此通信**。\
对等VPC网络可以位于同一个项目、同一组织的不同项目，或者**不同组织的不同项目**中。

需要以下权限：

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**更多信息请参阅文档**](https://cloud.google.com/vpc/docs/vpc-peering)。
## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来 **分享您的黑客技巧**。

</details>
