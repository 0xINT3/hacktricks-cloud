# GCP - VPC et R√©seautage

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**d√©p√¥ts Github HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **R√©seautage GCP Compute en un coup d'≈ìil**

Les **VPC** contiennent des r√®gles de **pare-feu** pour permettre le trafic entrant dans le VPC. Les VPC contiennent √©galement des **sous-r√©seaux** o√π les **machines virtuelles** vont √™tre **connect√©es**.\
En comparaison avec AWS, le **pare-feu** serait la chose la plus proche des **groupes de s√©curit√©**, mais dans ce cas, ceux-ci sont **d√©finis dans le VPC** et non dans chaque instance.

## **VPC, Sous-r√©seaux et Pare-feu dans GCP**

Les instances de calcul sont connect√©es √† des **sous-r√©seaux** qui font partie des **VPC** ([Clouds priv√©s virtuels](https://cloud.google.com/vpc/docs/vpc)). Dans GCP, il n'y a pas de groupes de s√©curit√©, il y a des [**pare-feu VPC**](https://cloud.google.com/vpc/docs/firewalls) avec des r√®gles d√©finies √† ce niveau de r√©seau mais appliqu√©es √† chaque instance VM.

### Sous-r√©seaux

Un **VPC** peut avoir **plusieurs sous-r√©seaux**. Chaque **sous-r√©seau est dans une r√©gion**.

### Pare-feu

Par d√©faut, chaque r√©seau dispose de deux [**r√®gles de pare-feu implicites**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules) : **autoriser les sorties** et **interdire les entr√©es**.

Lorsqu'un projet GCP est cr√©√©, un VPC appel√© **`default`** est √©galement cr√©√©, avec les r√®gles de pare-feu suivantes :

* **default-allow-internal :** autoriser tout le trafic provenant d'autres instances sur le r√©seau `default`
* **default-allow-ssh :** autoriser le port 22 depuis n'importe o√π
* **default-allow-rdp :** autoriser le port 3389 depuis n'importe o√π
* **default-allow-icmp :** autoriser le ping depuis n'importe o√π

{% hint style="warning" %}
Comme vous pouvez le voir, les **r√®gles de pare-feu** ont tendance √† √™tre **plus permissives** pour les **adresses IP internes**. Le VPC par d√©faut permet tout le trafic entre les instances de calcul.
{% endhint %}

Plus de **r√®gles de pare-feu** peuvent √™tre cr√©√©es pour le VPC par d√©faut ou pour de nouveaux VPC. Les [**r√®gles de pare-feu**](https://cloud.google.com/vpc/docs/firewalls) peuvent √™tre appliqu√©es aux instances via les **m√©thodes** suivantes :

* [**Balises r√©seau**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Comptes de service**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Toutes les instances dans un VPC**

Malheureusement, il n'y a pas de commande `gcloud` simple pour afficher toutes les instances de calcul avec des ports ouverts sur Internet. Vous devez connecter les points entre les r√®gles de pare-feu, les balises r√©seau, les comptes de service et les instances.

Ce processus a √©t√© automatis√© √† l'aide de [ce script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum) qui exportera ce qui suit :

* Fichier CSV montrant l'instance, l'adresse IP publique, les ports TCP autoris√©s, les ports UDP autoris√©s
* Scan nmap pour cibler toutes les instances sur les ports d'entr√©e autoris√©s depuis Internet public (0.0.0.0/0)
* Masscan pour cibler la plage TCP compl√®te de ces instances qui autorisent TOUS les ports TCP depuis Internet public (0.0.0.0/0)

### Politiques de pare-feu hi√©rarchiques <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

Les _politiques de pare-feu hi√©rarchiques_ vous permettent de cr√©er et d'**appliquer une politique de pare-feu coh√©rente dans toute votre organisation**. Vous pouvez attribuer des **politiques de pare-feu hi√©rarchiques √† l'organisation** dans son ensemble ou √† des **dossiers** individuels. Ces politiques contiennent des r√®gles qui peuvent explicitement refuser ou autoriser des connexions.

Vous cr√©ez et appliquez des politiques de pare-feu en deux √©tapes distinctes. Vous pouvez cr√©er et appliquer des politiques de pare-feu aux **n≈ìuds d'organisation ou de dossier** de la [**hi√©rarchie des ressources**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Une r√®gle de politique de pare-feu peut **bloquer des connexions, autoriser des connexions ou diff√©rer l'√©valuation des r√®gles de pare-feu** aux r√®gles de pare-feu VPC d√©finies dans les r√©seaux VPC.

Par d√©faut, toutes les r√®gles de politique de pare-feu hi√©rarchique s'appliquent √† toutes les VM de tous les projets sous l'organisation ou le dossier o√π la politique est associ√©e. Cependant, vous pouvez **restreindre les VM qui re√ßoivent une r√®gle donn√©e** en sp√©cifiant des [r√©seaux cibles ou des comptes de service cibles](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Vous pouvez lire ici comment [**cr√©er une politique de pare-feu hi√©rarchique**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### √âvaluation des r√®gles de pare-feu

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Politiques de pare-feu r√©gionales

Il s'agit de **r√®gles de pare-feu attribu√©es √† une r√©gion**.

## Interconnexion de r√©seaux VPC

Permet de connecter deux r√©seaux de cloud priv√© virtuel (VPC) de sorte que les **ressources de chaque r√©seau puissent communiquer** entre elles.\
Les r√©seaux VPC interconnect√©s peuvent √™tre dans le m√™me projet, dans des projets diff√©rents de la m√™me organisation ou dans **des projets diff√©rents de diff√©rentes organisations**.

Voici les autorisations n√©cessaires :

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Plus dans la documentation**](https://cloud.google.com/vpc/docs/vpc-peering).

## R√©f√©rences

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**N