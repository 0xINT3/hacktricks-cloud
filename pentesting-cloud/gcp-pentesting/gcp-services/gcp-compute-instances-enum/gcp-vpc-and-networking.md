# GCP - VPC & Networking

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **GCP Compute Networking w skrócie**

**VPC** zawiera reguły **Firewalla**, które pozwalają na przychodzący ruch do VPC. VPC zawiera również **podsieci**, w których będą **połączone maszyny wirtualne**.\
W porównaniu do AWS, **Firewall** byłby najbliższą rzeczą do **Grup Zabezpieczeń AWS i NACL**, ale w tym przypadku są one **zdefiniowane w VPC**, a nie w każdej instancji.

## **VPC, Subsieci i Firewalle w GCP**

Instancje obliczeniowe są połączone z **podsiecią**, która jest częścią **VPC** ([Virtual Private Cloud](https://cloud.google.com/vpc/docs/vpc)). W GCP nie ma grup zabezpieczeń, są [**firewalle VPC**](https://cloud.google.com/vpc/docs/firewalls) z regułami zdefiniowanymi na tym poziomie sieci, ale stosowanymi do każdej instancji VM.

### Subsieci

**VPC** może mieć **kilka podsieci**. Każda **podsieć znajduje się w jednym regionie**.

### Firewalle

Domyślnie każda sieć ma dwie [**domyślne reguły firewalla**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules): **allow outbound** i **deny inbound**.

Po utworzeniu projektu GCP, tworzona jest również VPC o nazwie **`default`**, z następującymi regułami firewalla:

* **default-allow-internal:** zezwalaj na cały ruch z innych instancji w sieci `default`
* **default-allow-ssh:** zezwalaj na port 22 z dowolnego miejsca
* **default-allow-rdp:** zezwalaj na port 3389 z dowolnego miejsca
* **default-allow-icmp:** zezwalaj na ping z dowolnego miejsca

{% hint style="warning" %}
Jak widać, **reguły firewalla** mają tendencję do bycia **bardziej liberalnymi** dla **adresów IP wewnętrznych**. Domyślna VPC zezwala na cały ruch między instancjami obliczeniowymi.
{% endhint %}

Można utworzyć więcej **reguł firewalla** dla domyślnej VPC lub dla nowych VPC. [**Reguły firewalla**](https://cloud.google.com/vpc/docs/firewalls) mogą być stosowane do instancji za pomocą następujących **metod**:

* [**Tagi sieciowe**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Konta usług**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Wszystkie instancje w ramach VPC**

Niestety, nie ma prostego polecenia `gcloud`, które wyświetliłoby wszystkie instancje obliczeniowe z otwartymi portami w Internecie. Musisz połączyć kropki między regułami firewalla, tagami sieciowymi, kontami usług i instancjami.

Ten proces został zautomatyzowany za pomocą [tego skryptu pythonowego](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum), który wyeksportuje następujące dane:

* Plik CSV pokazujący instancję, publiczny adres IP, dozwolone porty TCP, dozwolone porty UDP
* Skan nmap, aby zlokalizować wszystkie instancje na portach, z których można przyjmować ruch z publicznego Internetu (0.0.0.0/0)
* Skan masscan, aby zlokalizować wszystkie instancje, które pozwalają na dostęp do wszystkich portów TCP z publicznego Internetu (0.0.0.0/0)

### Hierarchiczne polityki firewalla <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Hierarchiczne polityki firewalla_ pozwalają na **tworzenie i egzekwowanie spójnej polityki firewalla w całej organizacji**. Można przypisać **hierarchiczne polityki firewalla do organizacji** jako całości lub do poszczególnych **folderów**. Polityki te zawierają reguły, które mogą jawnie blokować lub zezwalać na połączenia.

Tworzenie i stosowanie polityk firewalla odbywa się w osobnych krokach. Można tworzyć i stosować polityki firewalla na **węzłach organizacji lub folderów** w [**hierarchii zasobów**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Reguła polityki firewalla może **blokować połączenia, zezwalać na połączenia lub przekazywać ocenę reguł firewalla** do folderów niższego poziomu lub reguł firewalla VPC zdefiniowanych w sieciach VPC.

Domyślnie wszystkie reguły hierarchicznej polityki firewalla dotyczą wszystkich maszyn wirtualnych we wszystkich projektach w ramach organizacji lub folderu, w którym polityka jest powiązana. Jednak można **ograniczyć, które maszyny wirtualne otrzymują daną regułę** przez określenie [sieci docelowych lub kont usług docelowych](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Tutaj możesz przeczytać, jak [**utworzyć hierarchiczną politykę firewalla**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Ocena reguł firewalla

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Regionalne polityki firewalla

Są to **reguły firewalla przypisane do regionu**.

## VPC Network Peering

Pozwala na połączenie dwóch sieci Virtual Private Cloud (VPC), dzięki czemu **zasoby w każdej sieci mogą komunikować się** między sobą.\
Połączone sieci VPC mogą znajdować się w tym samym projekcie, różnych projektach tej samej organizacji lub **różnych projektach różnych organizacji**.

Oto wymagane uprawnienia:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Więcej w dokumentacji**](https://cloud.google.com/vpc/docs/vpc-peering).

## Odwoł
