# GCP - VPC 및 네트워킹

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)을 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 **PR을 제출**하여 해킹 기법을 공유하세요.

</details>

## **GCP Compute Networking 요약**

**VPC**에는 VPC로 들어오는 트래픽을 허용하는 **방화벽** 규칙이 포함되어 있습니다. VPC에는 또한 **가상 머신**이 연결될 **서브네트워크**도 포함되어 있습니다.\
AWS와 비교하면, **방화벽**은 **AWS 보안 그룹 및 NACL**에 가장 가까운 것이지만, 이 경우에는 **VPC에 정의**되며 각 인스턴스에 정의되지 않습니다.

## **GCP의 VPC, 서브네트워크 및 방화벽**

Compute 인스턴스는 **VPC**([Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc))의 일부인 **서브네트워크**에 연결됩니다. GCP에서는 보안 그룹이 없고, 각 VM 인스턴스에 적용되는 이 네트워크 수준의 [**VPC 방화벽**](https://cloud.google.com/vpc/docs/firewalls)이 있습니다.

### 서브네트워크

**VPC**에는 **여러 개의 서브네트워크**가 있을 수 있습니다. 각 **서브네트워크는 1개의 리전**에 있습니다.

### 방화벽

기본적으로 모든 네트워크에는 두 개의 [**기본 방화벽 규칙**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)이 있습니다: **아웃바운드 허용** 및 **인바운드 거부**.

GCP 프로젝트가 생성되면, 다음과 같은 방화벽 규칙이 있는 **`default`**라는 VPC가 생성됩니다:

* **default-allow-internal:** `default` 네트워크의 다른 인스턴스에서 모든 트래픽 허용
* **default-allow-ssh:** 모든 곳에서 22 허용
* **default-allow-rdp:** 모든 곳에서 3389 허용
* **default-allow-icmp:** 모든 곳에서 핑 허용

{% hint style="warning" %}
보시다시피, **방화벽 규칙**은 **내부 IP 주소**에 대해 **더 허용적**입니다. 기본 VPC는 Compute 인스턴스 간의 모든 트래픽을 허용합니다.
{% endhint %}

기본 VPC 또는 새 VPC에 대해 더 많은 **방화벽 규칙**을 생성할 수 있습니다. [**방화벽 규칙**](https://cloud.google.com/vpc/docs/firewalls)은 다음 **방법**을 통해 인스턴스에 적용될 수 있습니다:

* [**네트워크 태그**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**서비스 계정**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **VPC 내의 모든 인스턴스**

불행히도, 인터넷에서 열린 포트를 가진 모든 Compute 인스턴스를 간단한 `gcloud` 명령으로 확인할 수는 없습니다. 방화벽 규칙, 네트워크 태그, 서비스 계정 및 인스턴스 간의 관계를 파악해야 합니다.

이 프로세스는 [이 파이썬 스크립트](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)를 사용하여 자동화되며, 다음을 내보냅니다:

* 인스턴스, 공용 IP, 허용된 TCP, 허용된 UDP를 보여주는 CSV 파일
* 공용 인터넷(0.0.0.0/0)에서 허용된 포트로 모든 인스턴스를 대상으로 하는 nmap 스캔
* 공용 인터넷(0.0.0.0/0)에서 모든 TCP 포트를 허용하는 인스턴스의 전체 TCP 범위를 대상으로 하는 masscan

### 계층적 방화벽 정책 <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_계층적 방화벽 정책_을 사용하면 조직 전체에 **일관된 방화벽 정책을 생성하고 적용**할 수 있습니다. 계층적 방화벽 정책을 **조직 전체 또는 개별 폴더**에 할당할 수 있습니다. 이 정책에는 연결을 명시적으로 거부하거나 허용하는 규칙이 포함되어 있습니다.

방화벽 정책은 별도의 단계로 생성하고 적용합니다. 방화벽 정책은 [**리소스 계층 구조**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)의 **조직 또는 폴더 노드**에서 생성하고 적용할 수 있습니다. 방화벽 정책 규칙은 연결을 차단하거나 허용하거나 VPC 네트워크에서 정의된 VPC 방화벽 규칙에 방화벽 규칙 평가를 **미룰 수 있습니다**.

기본적으로 계층적 방화벽 정책 규칙은 정책이 연결된 조직 또는 폴더 아래의 모든 프로젝트의 모든 VM에 적용됩니다. 그러나 [대상 네트워크 또는 대상 서비스 계정](https://cloud.google.com/vpc/docs/firewall-policies#targets)을 지정하여 특정 규칙을 받는 VM을 제한할 수 있습니다.

[**계층적 방화벽 정책을 생성하는 방법**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud)은 여기에서 확인할 수 있습니다.

### 방화벽 규칙 평가

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## 지
