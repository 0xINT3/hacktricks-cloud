# GCP - VPC & Networking

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Rede de Computa√ß√£o GCP em Poucas Palavras**

**VPCs** cont√™m regras de **Firewall** para permitir tr√°fego de entrada para a VPC. VPCs tamb√©m cont√™m **sub-redes** onde **m√°quinas virtuais** ser√£o **conectadas**.\
Comparando com a AWS, **Firewall** seria o mais pr√≥ximo de **Security Groups**, mas neste caso, estas s√£o **definidas na VPC** e n√£o em cada inst√¢ncia.

## **VPC, Sub-redes & Firewalls no GCP**

Inst√¢ncias de Computa√ß√£o s√£o conectadas a **sub-redes** que fazem parte de **VPCs** ([Nuvens Privadas Virtuais](https://cloud.google.com/vpc/docs/vpc)). No GCP n√£o existem security groups, existem [**firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) com regras definidas neste n√≠vel de rede, mas aplicadas a cada Inst√¢ncia VM.

### Sub-redes

Uma **VPC** pode ter **v√°rias sub-redes**. Cada **sub-rede est√° em 1 regi√£o**.

### Firewalls

Por padr√£o, toda rede tem duas [**regras de firewall impl√≠citas**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules): **permitir sa√≠da** e **negar entrada**.

Quando um projeto GCP √© criado, uma VPC chamada **`default`** tamb√©m √© criada, com as seguintes regras de firewall:

* **default-allow-internal:** permite todo o tr√°fego de outras inst√¢ncias na rede `default`
* **default-allow-ssh:** permite 22 de qualquer lugar
* **default-allow-rdp:** permite 3389 de qualquer lugar
* **default-allow-icmp:** permite ping de qualquer lugar

{% hint style="warning" %}
Como voc√™ pode ver, as **regras de firewall** tendem a ser **mais permissivas** para **endere√ßos IP internos**. A VPC padr√£o permite todo o tr√°fego entre Inst√¢ncias de Computa√ß√£o.
{% endhint %}

Mais **regras de Firewall** podem ser criadas para a VPC padr√£o ou para novas VPCs. [**Regras de Firewall**](https://cloud.google.com/vpc/docs/firewalls) podem ser aplicadas a inst√¢ncias atrav√©s dos seguintes **m√©todos**:

* [**Tags de rede**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Contas de servi√ßo**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas as inst√¢ncias dentro de uma VPC**

Infelizmente, n√£o existe um comando `gcloud` simples para listar todas as Inst√¢ncias de Computa√ß√£o com portas abertas na internet. Voc√™ tem que conectar os pontos entre regras de firewall, tags de rede, contas de servi√ßos e inst√¢ncias.

Este processo foi automatizado usando [este script python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum) que exportar√° o seguinte:

* Arquivo CSV mostrando inst√¢ncia, IP p√∫blico, TCP permitido, UDP permitido
* Varredura nmap para alvejar todas as inst√¢ncias em portas permitidas de entrada do p√∫blico da internet (0.0.0.0/0)
* masscan para alvejar a gama completa de portas TCP daquelas inst√¢ncias que permitem TODAS as portas TCP do p√∫blico da internet (0.0.0.0/0)

### Pol√≠ticas de Firewall Hier√°rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Pol√≠ticas de firewall hier√°rquicas_ permitem criar e **aplicar uma pol√≠tica de firewall consistente em toda a sua organiza√ß√£o**. Voc√™ pode atribuir **pol√≠ticas de firewall hier√°rquicas √† organiza√ß√£o** como um todo ou a **pastas** individuais. Estas pol√≠ticas cont√™m regras que podem negar ou permitir explicitamente conex√µes.

Voc√™ cria e aplica pol√≠ticas de firewall como etapas separadas. Voc√™ pode criar e aplicar pol√≠ticas de firewall nos **n√≥s da organiza√ß√£o ou pastas da** [**hierarquia de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Uma regra de pol√≠tica de firewall pode **bloquear conex√µes, permitir conex√µes ou adiar a avalia√ß√£o da regra de firewall** para pastas de n√≠vel inferior ou regras de firewall de VPC definidas em redes VPC.

Por padr√£o, todas as regras de pol√≠tica de firewall hier√°rquica aplicam-se a todas as VMs em todos os projetos sob a organiza√ß√£o ou pasta onde a pol√≠tica est√° associada. No entanto, voc√™ pode **restringir quais VMs recebem uma determinada regra** especificando [redes alvo ou contas de servi√ßo alvo](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Voc√™ pode ler aqui como [**criar uma Pol√≠tica de Firewall Hier√°rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Avalia√ß√£o de Regras de Firewall

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Pol√≠ticas de Firewall Regionais

Estas s√£o **regras de Firewall atribu√≠das a uma regi√£o**.

## VPC Network Peering

Permite conectar duas redes Virtual Private Cloud (VPC) para que **recursos em cada rede possam se comunicar** entre si.\
Redes VPC emparelhadas podem estar no mesmo projeto, projetos diferentes da mesma organiza√ß√£o ou **projetos diferentes de organiza√ß√µes diferentes**.

Estas s√£o as permiss√µes necess√°rias:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**Mais na documenta√ß√£o**](https://cloud.google.com/vpc/docs/vpc-peering).
## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
