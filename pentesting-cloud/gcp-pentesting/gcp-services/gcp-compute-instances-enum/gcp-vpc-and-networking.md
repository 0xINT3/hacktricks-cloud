# GCP - VPC y Redes

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Redes de Compute en GCP en Resumen**

**VPCs** contienen reglas de **Firewall** para permitir tr치fico entrante a la VPC. Las VPCs tambi칠n contienen **subredes** donde las **m치quinas virtuales** van a estar **conectadas**.\
Comparado con AWS, **Firewall** ser칤a lo **m치s parecido** a **Security Groups**, pero en este caso estas est치n **definidas en la VPC** y no en cada instancia.

## **VPC, Subredes y Firewalls en GCP**

Las Instancias de Compute est치n conectadas a **subredes** que son parte de **VPCs** ([Nubes Privadas Virtuales](https://cloud.google.com/vpc/docs/vpc)). En GCP no hay grupos de seguridad, hay [**firewalls de VPC**](https://cloud.google.com/vpc/docs/firewalls) con reglas definidas a este nivel de red pero aplicadas a cada Instancia VM.

### Subredes

Una **VPC** puede tener **varias subredes**. Cada **subred est치 en 1 regi칩n**.

### Firewalls

Por defecto, cada red tiene dos [**reglas de firewall impl칤citas**](https://cloud.google.com/vpc/docs/firewalls#default_firewall_rules): **permitir salida** y **denegar entrada**.

Cuando se crea un proyecto de GCP, tambi칠n se crea una VPC llamada **`default`** con las siguientes reglas de firewall:

* **default-allow-internal:** permite todo el tr치fico de otras instancias en la red `default`
* **default-allow-ssh:** permite el puerto 22 desde cualquier lugar
* **default-allow-rdp:** permite el puerto 3389 desde cualquier lugar
* **default-allow-icmp:** permite ping desde cualquier lugar

{% hint style="warning" %}
Como puedes ver, las **reglas de firewall** tienden a ser **m치s permisivas** para **direcciones IP internas**. La VPC por defecto permite todo el tr치fico entre Instancias de Compute.
{% endhint %}

Se pueden crear m치s **reglas de Firewall** para la VPC por defecto o para nuevas VPCs. [**Reglas de Firewall**](https://cloud.google.com/vpc/docs/firewalls) pueden ser aplicadas a instancias mediante los siguientes **m칠todos**:

* [**Etiquetas de red**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
* [**Cuentas de servicio**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
* **Todas las instancias dentro de una VPC**

Desafortunadamente, no hay un simple comando `gcloud` para mostrar todas las Instancias de Compute con puertos abiertos en internet. Tienes que conectar los puntos entre reglas de firewall, etiquetas de red, cuentas de servicios e instancias.

Este proceso fue automatizado usando [este script de python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_firewall_enum) que exportar치 lo siguiente:

* Archivo CSV mostrando instancia, IP p칰blica, TCP permitido, UDP permitido
* Escaneo nmap para dirigirse a todas las instancias en puertos de ingreso permitidos desde internet p칰blico (0.0.0.0/0)
* Escaneo masscan para dirigirse al rango completo de TCP de aquellas instancias que permiten TODOS los puertos TCP desde internet p칰blico (0.0.0.0/0)

### Pol칤ticas de Firewall Jer치rquicas <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_Las pol칤ticas de firewall jer치rquicas_ te permiten crear y **hacer cumplir una pol칤tica de firewall consistente a trav칠s de tu organizaci칩n**. Puedes asignar **pol칤ticas de firewall jer치rquicas a la organizaci칩n** en su totalidad o a **carpetas** individuales. Estas pol칤ticas contienen reglas que pueden denegar o permitir expl칤citamente conexiones.

Creas y aplicas pol칤ticas de firewall en pasos separados. Puedes crear y aplicar pol칤ticas de firewall en los **nodos de organizaci칩n o carpetas de la** [**jerarqu칤a de recursos**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy). Una regla de pol칤tica de firewall puede **bloquear conexiones, permitir conexiones, o diferir la evaluaci칩n de reglas de firewall** a carpetas de nivel inferior o reglas de firewall de VPC definidas en redes VPC.

Por defecto, todas las reglas de pol칤ticas de firewall jer치rquicas se aplican a todas las VMs en todos los proyectos bajo la organizaci칩n o carpeta donde la pol칤tica est치 asociada. Sin embargo, puedes **restringir qu칠 VMs reciben una regla dada** especificando [redes objetivo o cuentas de servicio objetivo](https://cloud.google.com/vpc/docs/firewall-policies#targets).

Puedes leer aqu칤 c칩mo [**crear una Pol칤tica de Firewall Jer치rquica**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud).

### Evaluaci칩n de Reglas de Firewall

<figure><img src="../../../../.gitbook/assets/image (4) (5).png" alt=""><figcaption></figcaption></figure>

## Pol칤ticas de Firewall Regionales

Estas son **reglas de Firewall asignadas a una regi칩n**.

## Emparejamiento de Redes VPC

Permite conectar dos redes de Nube Privada Virtual (VPC) de modo que **los recursos en cada red puedan comunicarse** entre s칤.\
Las redes VPC emparejadas pueden estar en el mismo proyecto, proyectos diferentes de la misma organizaci칩n, o **proyectos diferentes de distintas organizaciones**.

Estos son los permisos necesarios:

* `compute.networks.addPeering`
* `compute.networks.updatePeering`
* `compute.networks.removePeering`
* `compute.networks.listPeeringRoutes`

[**M치s en la documentaci칩n**](https://cloud.google.com/vpc/docs/vpc-peering).
## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
