# GCP - Cloud Run Enum

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

## Cloud Run <a href="#reviewing-cloud-run-configurations" id="reviewing-cloud-run-configurations"></a>

Google [Cloud Run](https://cloud.google.com/run) est une autre offre serverless o√π vous pouvez rechercher des variables d'environnement. Cloud Run cr√©e un petit serveur web, fonctionnant sur le port 8080, qui attend une requ√™te HTTP. Lorsque la requ√™te est re√ßue, un travail est ex√©cut√© et le journal du travail est renvoy√© via une r√©ponse HTTP.

Par **d√©faut**, l'**acc√®s** au serveur web est **public**, mais il peut √©galement √™tre **limit√© au trafic interne** (VPC...). De plus, l'**authentification** pour contacter le serveur web peut √™tre **autoriser tout** ou **exiger une authentification via IAM**.

Par d√©faut, le **chiffrement** utilise une **cl√© g√©r√©e par Google**, mais une **cl√© de chiffrement g√©r√©e par le client (CMEK)** de **KMS** peut √©galement √™tre **choisie**.

Par d√©faut, le compte de service utilis√© est le compte par d√©faut de Compute Engine et il a la port√©e `cloud-platform`.

Il est possible de d√©finir des **variables d'environnement en clair** pour l'ex√©cution, et m√™me de **monter des secrets cloud** ou d'**ajouter des secrets cloud aux variables d'environnement**.

Il est √©galement possible d'**ajouter des connexions avec Cloud SQL**.

Les **URL** des services d√©ploy√©s sont similaires √† `https://<svc-name>-<random>.a.run.app`

### √ânum√©ration

```bash
# Liste des services
gcloud run services list
gcloud run services list --platform=managed
gcloud run services list --platform=gke

# Obtenir des informations sur un service
gcloud run services describe --region <region> <svc-name> 

# Obtenir des informations sur tous les services ensemble
gcloud run services list --format=yaml
gcloud run services list --platform=managed --format=json
gcloud run services list --platform=gke --format=json

# Obtenir la politique
gcloud run services get-iam-policy --region <region> <svc-name>

# Obtenir les r√©visions
gcloud run revisions list --region <region>
gcloud run revisions describe --region <region> <revision>

# Obtenir les domaines
gcloud run domain-mappings list
gcloud run domain-mappings describe <name>

# Tenter de d√©clencher un travail non authentifi√©
curl <url>

# Tenter de d√©clencher un travail avec votre autorisation gcloud actuelle
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" <url>
```

### √âl√©vation de privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations de cloud run pour √©lever les privil√®ges** :

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md" %}
[gcp-run-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md)
{% endcontent-ref %}

### √ânum√©rer Open Cloud Run

Avec le code suivant [pris √† partir d'ici](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_cloudrun.sh), vous pouvez trouver des services Cloud Run qui permettent des invocations non authentifi√©es.

```bash
#!/bin/bash

############################
# Ex√©cutez cet outil pour trouver des services Cloud Run qui permettent des invocations non authentifi√©es n'importe o√π dans votre organisation GCP.
# Profitez-en !
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
    echo "[*] scraping project $proj"

    enabled=$(gcloud services list --project "$proj" | grep "Cloud Run API")

    if [ -z "$enabled" ]; then
	continue
    fi


    for run in $(gcloud run services list --platform managed --quiet --project $proj --format="get(name)"); do
        ACL="$(gcloud run services get-iam-policy $run --platform managed --project $proj)"

        all_users="$(echo $ACL | grep allUsers)"
        all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

        if [ -z "$all_users" ]
        then
              :
        else
              echo "[!] Ouvert √† tous les utilisateurs : $proj: $run"
        fi

        if [ -z "$all_auth" ]
        then
              :
        else
              echo "[!] Ouvert √† tous les utilisateurs authentifi√©s : $proj: $run"
        fi
    done
done
```

## Cloud Run Jobs

Les jobs Cloud Run sont plus adapt√©s pour les **conteneurs qui s'ex√©cutent jusqu'√† leur ach√®vement et ne r√©pondent pas aux demandes**. Les jobs n'ont pas la capacit√© de r√©pondre aux demandes ou d'√©couter sur un port. Cela signifie que contrairement aux services Cloud Run, les jobs ne doivent pas inclure de serveur web. Au lieu de cela, les conteneurs de jobs doivent se terminer lorsqu'ils ont termin√©.

### √ânum√©ration

```bash
gcloud beta run jobs list
gcloud beta run jobs describe --region <region> <job-name>
gcloud beta run jobs get-iam-policy --region <region> <job-name>
```

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>