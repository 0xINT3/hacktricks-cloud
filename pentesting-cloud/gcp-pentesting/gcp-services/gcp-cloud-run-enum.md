# GCP - Enumeración de Cloud Run

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cloud Run <a href="#reviewing-cloud-run-configurations" id="reviewing-cloud-run-configurations"></a>

Google [Cloud Run](https://cloud.google.com/run) es otra oferta sin servidor donde también se pueden buscar variables de entorno. Cloud Run crea un pequeño servidor web, que se ejecuta en el puerto 8080, que espera una solicitud HTTP GET. Cuando se recibe la solicitud, se ejecuta un trabajo y el registro del trabajo se muestra a través de una respuesta HTTP.

Por **defecto**, el **acceso** al servidor web es **público**, pero también se puede **limitar al tráfico interno** (VPC...)\
Además, la **autenticación** para contactar con el servidor web puede ser **permitiendo todo** o **requiriendo autenticación a través de IAM**.

Por defecto, el **cifrado** utiliza una **clave administrada por Google**, pero también se puede **elegir una clave de cifrado gestionada por el cliente (CMEK)** de **KMS**.

Por defecto, la cuenta de servicio utilizada es la **predeterminada de Compute Engine** y tiene el **ámbito `cloud-platform`.**

Es posible definir **variables de entorno en texto claro** para la ejecución, e incluso **montar secretos en la nube** o **añadir secretos en la nube a las variables de entorno.**

También es posible **añadir conexiones con Cloud SQL**.

Las **URLs** de los servicios desplegados son similares a `https://<svc-name>-<random>.a.run.app`

### Enumeración

```bash
# Listar servicios
gcloud run services list
gcloud run services list --platform=managed
gcloud run services list --platform=gke

# Obtener información de un servicio
gcloud run services describe --region <region> <svc-name> 

# Obtener información de todos los servicios juntos
gcloud run services list --format=yaml
gcloud run services list --platform=managed --format=json
gcloud run services list --platform=gke --format=json

# Obtener la política
gcloud run services get-iam-policy --region <region> <svc-name>

# Obtener revisiones
gcloud run revisions list --region <region>
gcloud run revisions describe --region <region> <revision>

# Obtener dominios
gcloud run domain-mappings list
gcloud run domain-mappings describe <name>

# Intentar desencadenar un trabajo sin autenticación
curl <url>

# Intentar desencadenar un trabajo con la autorización actual de gcloud
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" <url>
```

### Escalada de privilegios

En la siguiente página, puedes comprobar cómo **abusar de los permisos de Cloud Run para escalar privilegios**:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md" %}
[gcp-run-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-run-privesc.md)
{% endcontent-ref %}

### Enumerar Open Cloud Run

Con el siguiente código [tomado de aquí](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_cloudrun.sh) puedes encontrar servicios de Cloud Run que permiten invocaciones no autenticadas.

```bash
#!/bin/bash

############################
# Ejecute esta herramienta para encontrar servicios de Cloud Run que permitan invocaciones no autenticadas en cualquier lugar de su organización de GCP.
# ¡Disfruta!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
    echo "[*] raspando el proyecto $proj"

    enabled=$(gcloud services list --project "$proj" | grep "Cloud Run API")

    if [ -z "$enabled" ]; then
	continue
    fi


    for run in $(gcloud run services list --platform managed --quiet --project $proj --format="get(name)"); do
        ACL="$(gcloud run services get-iam-policy $run --platform managed --project $proj)"

        all_users="$(echo $ACL | grep allUsers)"
        all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

        if [ -z "$all_users" ]
        then
              :
        else
              echo "[!] Abierto a todos los usuarios: $proj: $run"
        fi

        if [ -z "$all_auth" ]
        then
              :
        else
              echo "[!] Abierto a todos los usuarios autenticados: $proj: $run"
        fi
    done
done
```

## Trabajos de Cloud Run

Los trabajos de Cloud Run son una mejor opción para **contenedores que se ejecutan hasta su finalización y no sirven solicitudes**. Los trabajos no tienen la capacidad de servir solicitudes o escuchar en un puerto. Esto significa que, a diferencia de los servicios de Cloud Run, los trabajos no deben incluir un servidor web. En su lugar, los contenedores de trabajos deben salir cuando hayan terminado.

### Enumeración

```bash
gcloud beta run jobs list
gcloud beta run jobs describe --region <region> <job-name>
gcloud beta run jobs get-iam-policy --region <region> <job-name>
```

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>