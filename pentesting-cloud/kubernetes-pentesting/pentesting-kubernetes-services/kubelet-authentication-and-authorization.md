# Kubeletの認証と認可

<details>

<summary><strong>HackTricksをサポートして特典を得る！</strong></summary>

* **HackTricksのスポンサーになって会社を宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのテクニックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## Kubeletの認証 <a href="#kubelet-authentication" id="kubelet-authentication"></a>

デフォルトでは、他の設定された認証方法で拒否されない場合、kubeletのHTTPSエンドポイントへのリクエストは匿名リクエストとして扱われ、**ユーザー名は `system:anonymous`** 、**グループは `system:unauthenticated`** となります。

3つの認証方法は次のとおりです。

* **匿名**（デフォルト）：パラメータ **`--anonymous-auth=true`** または設定で **`--anonymous-auth=true`** を使用します。
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: これにより、kubectlのAPIベアラートークンが認証として有効になります（有効なトークンはすべて有効です）。次の設定を使用して許可します：
* APIサーバーで`authentication.k8s.io/v1beta1` APIグループが有効になっていることを確認します
* kubeletを**`--authentication-token-webhook`**と**`--kubeconfig`**フラグで起動するか、次の設定を使用します：
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
kubeletは、構成されたAPIサーバー上の**`TokenReview` API**を呼び出して、ベアラートークンから**ユーザー情報を特定**します。
{% endhint %}

* **X509クライアント証明書：** X509クライアント証明書を使用して認証することができます。
* 詳細については、[apiserverの認証ドキュメント](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs)を参照してください。
* `--client-ca-file`フラグを使用してkubeletを起動し、クライアント証明書を検証するためのCAバンドルを提供するか、または構成ファイルで設定します。
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubeletの認証 <a href="#kubelet-authentication" id="kubelet-authentication"></a>

認証に成功したリクエスト（匿名リクエストを含む）は、その後に**認可**されます。**デフォルトの**認可モードは**`AlwaysAllow`**で、**すべてのリクエストを許可**します。

ただし、他の可能な値は**`webhook`**です（これが**主に見つかる**ものです）。このモードでは、認証されたユーザーの権限をチェックして、アクションを許可または拒否します。

{% hint style="warning" %}
匿名認証が有効になっている場合でも、**匿名アクセス**にはアクションを実行するための権限がない場合があります。
{% endhint %}

Webhookを介した認可は、**`--authorization-mode=Webhook`**パラメータを使用して構成するか、設定ファイルを介して行うことができます。
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
kubeletは、各リクエストが**許可されているかどうか**を判断するために、設定されたAPIサーバー上の**`SubjectAccessReview`** APIを呼び出します。

kubeletは、apiserverと同じ[リクエスト属性](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes)のアプローチを使用してAPIリクエストを承認します。

* **アクション**

| HTTP動詞 | リクエスト動詞                                                                                                                                                 |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get（個々のリソース用）、list（コレクション用、オブジェクトの完全なコンテンツを含む）、watch（個々のリソースまたはリソースのコレクションの監視用） |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete（個々のリソース用）、deletecollection（コレクション用）                                                                                                 |

* Kubelet APIでKubeletに話しかける**リソース**は常に**nodes**であり、**サブリソース**は受信リクエストのパスから**決定**されます。

| Kubelet API  | リソース | サブリソース |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _その他すべて_ | nodes    | proxy       |

たとえば、次のリクエストは、許可なくkubeletのポッド情報にアクセスしようとしました。
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* **Forbidden**を受け取ったため、リクエストは**認証チェックに合格しました**。そうでなければ、単に`Unauthorised`のメッセージが表示されます。
* **ユーザー名**（この場合はトークンから）が表示されます。
* **リソース**が**nodes**であり、**サブリソース**が**proxy**であることがわかります（前の情報と一致しています）

## 参考文献

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksの広告を掲載したい場合**や、**最新バージョンのPEASSにアクセスしたい場合**、または**HackTricksをPDFでダウンロードしたい場合**は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
