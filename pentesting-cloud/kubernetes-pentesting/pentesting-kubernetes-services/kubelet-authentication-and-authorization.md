# Autentica√ß√£o e Autoriza√ß√£o do Kubelet

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## Autentica√ß√£o do Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Por padr√£o, as solicita√ß√µes ao endpoint HTTPS do kubelet que n√£o s√£o rejeitadas por outros m√©todos de autentica√ß√£o configurados s√£o tratadas como solicita√ß√µes an√¥nimas e recebem um **nome de usu√°rio `system:anonymous`** e um **grupo `system:unauthenticated`**.

Os **3** m√©todos de autentica√ß√£o s√£o:

* **An√¥nimo** (padr√£o): Use a configura√ß√£o **`--anonymous-auth=true` ou o arquivo de configura√ß√£o:**

```json
"authentication": {
    "anonymous": {
      "enabled": true
    },
```

* **Webhook**: Isso **habilitar√°** os **tokens de portador da API kubectl** como autoriza√ß√£o (qualquer token v√°lido ser√° v√°lido). Permita-o com:
  * certifique-se de que o grupo de API `authentication.k8s.io/v1beta1` esteja habilitado no servidor de API
  * inicie o kubelet com as flags **`--authentication-token-webhook`** e **`--kubeconfig`** ou use a seguinte configura√ß√£o:

```json
"authentication": {
    "webhook": {
      "cacheTTL": "2m0s",
      "enabled": true
    },
```

{% hint style="info" %}
O kubelet chama a API **`TokenReview`** no servidor de API configurado para **determinar as informa√ß√µes do usu√°rio** a partir dos tokens de portador.
{% endhint %}

* **Certificados de cliente X509:** Permitem autenticar via certificados de cliente X509
  * consulte a documenta√ß√£o de autentica√ß√£o do apiserver para obter mais detalhes
  * inicie o kubelet com a flag `--client-ca-file`, fornecendo um conjunto de CA para verificar os certificados do cliente. Ou com a configura√ß√£o:

```json
"authentication": {
    "x509": {
      "clientCAFile": "/etc/kubernetes/pki/ca.crt"
    }
}
```

## Autoriza√ß√£o do Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Qualquer solicita√ß√£o que seja autenticada com sucesso (incluindo uma solicita√ß√£o an√¥nima) **√© ent√£o autorizada**. O modo de autoriza√ß√£o padr√£o √© **`AlwaysAllow`**, que **permite todas as solicita√ß√µes**.

No entanto, o outro valor poss√≠vel √© **`webhook`** (que √© o que voc√™ **encontrar√° principalmente por a√≠**). Este modo ir√° **verificar as permiss√µes do usu√°rio autenticado** para permitir ou negar uma a√ß√£o.

{% hint style="warning" %}
Observe que mesmo que a **autentica√ß√£o an√¥nima esteja habilitada**, o **acesso an√¥nimo** pode **n√£o ter permiss√µes** para executar nenhuma a√ß√£o.
{% endhint %}

A autoriza√ß√£o via webhook pode ser configurada usando o **par√¢metro `--authorization-mode=Webhook`** ou via arquivo de configura√ß√£o com:

```json
"authorization": {
    "mode": "Webhook",
    "webhook": {
      "cacheAuthorizedTTL": "5m0s",
      "cacheUnauthorizedTTL": "30s"
    }
},
```

O kubelet chama a API **`SubjectAccessReview`** no servidor de API configurado para **determinar** se cada solicita√ß√£o est√° **autorizada.**

O kubelet autoriza solicita√ß√µes de API usando a mesma abordagem de [atributos de solicita√ß√£o](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) que o apiserver:

* **A√ß√£o**

| Verbo HTTP | verbo de solicita√ß√£o                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (para recursos individuais), list (para cole√ß√µes, incluindo o conte√∫do completo do objeto), watch (para assistir a um recurso individual ou cole√ß√£o de recursos) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (para recursos individuais), deletecollection (para cole√ß√µes)                                                                                         |

* O **recurso** que fala com a API do Kubelet √© **sempre** **nodes** e o **subrecurso** √© **determinado** a partir do caminho da solicita√ß√£o recebida:

| Kubelet API  | recurso | subrecurso |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _todos os outros_ | nodes    | proxy       |

Por exemplo, a seguinte solicita√ß√£o tentou acessar as informa√ß√µes dos pods do kubelet sem permiss√£o:

```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```

* Recebemos um **Forbidden**, ent√£o a solicita√ß√£o **passou na verifica√ß√£o de autentica√ß√£o**. Caso contr√°rio, ter√≠amos recebido apenas uma mensagem de `N√£o autorizado`.
* Podemos ver o **nome de usu√°rio** (neste caso, do token)
* Verifique como o **recurso** era **nodes** e o **subrecurso** era **proxy** (o que faz sentido com as informa√ß√µes anteriores)

## Refer√™ncias

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>