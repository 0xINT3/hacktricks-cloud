# Autenticazione e autorizzazione di Kubelet

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Autenticazione di Kubelet <a href="#autenticazione-di-kubelet" id="autenticazione-di-kubelet"></a>

**[Dalla documentazione:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Per impostazione predefinita, le richieste all'endpoint HTTPS di kubelet che non vengono respinte da altri metodi di autenticazione configurati vengono trattate come richieste anonime e vengono assegnati un **nome utente `system:anonymous`** e un **gruppo `system:unauthenticated`**.

I **3** metodi di autenticazione sono:

* **Anonimo** (predefinito): Utilizza l'impostazione **`--anonymous-auth=true` o la configurazione:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Ci√≤ abiliter√† i token di autorizzazione dell'API kubectl come bearer (qualsiasi token valido sar√† accettato). Consentilo con:
* assicurati che il gruppo API `authentication.k8s.io/v1beta1` sia abilitato nel server API
* avvia il kubelet con i flag **`--authentication-token-webhook`** e **`--kubeconfig`** o utilizza la seguente configurazione:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Il kubelet chiama l'API **`TokenReview`** sul server API configurato per **determinare le informazioni dell'utente** dai token di autenticazione
{% endhint %}

* **Certificati client X509:** Consentono l'autenticazione tramite certificati client X509
* consulta la [documentazione sull'autenticazione del server API](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) per ulteriori dettagli
* avvia il kubelet con il flag `--client-ca-file`, fornendo un pacchetto CA per verificare i certificati client. Oppure con la configurazione:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Autorizzazione di Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Qualsiasi richiesta che viene autenticata con successo (inclusa una richiesta anonima) **viene quindi autorizzata**. La modalit√† di autorizzazione **predefinita** √® **`AlwaysAllow`**, che **consente tutte le richieste**.

Tuttavia, l'altro valore possibile √® **`webhook`** (che √® quello che **troverai principalmente**). Questa modalit√† **verificher√† i permessi dell'utente autenticato** per consentire o negare un'azione.

{% hint style="warning" %}
Nota che anche se l'**autenticazione anonima √® abilitata**, l'**accesso anonimo** potrebbe **non avere alcun permesso** per eseguire alcuna azione.
{% endhint %}

L'autorizzazione tramite webhook pu√≤ essere configurata utilizzando il parametro **`--authorization-mode=Webhook`** o tramite il file di configurazione con:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Il kubelet chiama l'API **`SubjectAccessReview`** sul server API configurato per **determinare** se ogni richiesta √® **autorizzata**.

Il kubelet autorizza le richieste API utilizzando lo stesso approccio degli [attributi di richiesta](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) come l'apiserver:

* **Azione**

| Verbo HTTP | verbo di richiesta                                                                                                                                             |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (per risorse individuali), list (per collezioni, inclusi i contenuti completi degli oggetti), watch (per monitorare una risorsa individuale o una collezione di risorse) |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (per risorse individuali), deletecollection (per collezioni)                                                                                         |

* La **risorsa** che comunica con l'API Kubelet √® **sempre** **nodes** e la **sotto-risorsa** √® **determinata** dal percorso della richiesta in arrivo:

| Kubelet API  | risorsa | sotto-risorsa |
| ------------ | ------- | ------------- |
| /stats/\*    | nodes   | stats         |
| /metrics/\*  | nodes   | metrics       |
| /logs/\*     | nodes   | log           |
| /spec/\*     | nodes   | spec          |
| _tutti gli altri_ | nodes   | proxy         |

Ad esempio, la seguente richiesta ha cercato di accedere alle informazioni dei pod di kubelet senza autorizzazione:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Abbiamo ricevuto un **Forbidden**, quindi la richiesta ha **superato il controllo di autenticazione**. In caso contrario, avremmo ricevuto solo un messaggio `Non autorizzato`.
* Possiamo vedere il **nome utente** (in questo caso dal token)
* Verifica come **risorsa** era **nodes** e la **sotto-risorsa** **proxy** (che ha senso con le informazioni precedenti)

## Riferimenti

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
