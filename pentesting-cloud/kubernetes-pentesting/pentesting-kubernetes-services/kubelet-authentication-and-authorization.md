# Authentification et autorisation de Kubelet

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

## Authentification de Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Par d√©faut, les demandes √† l'endpoint HTTPS de kubelet qui ne sont pas rejet√©es par d'autres m√©thodes d'authentification configur√©es sont trait√©es comme des demandes anonymes et re√ßoivent un **nom d'utilisateur de `system:anonymous`** et un **groupe de `system:unauthenticated`**.

Les **3** m√©thodes d'authentification sont :

* **Anonyme** (par d√©faut) : Utilisez le param√®tre **`--anonymous-auth=true` ou la configuration :**

```json
"authentication": {
    "anonymous": {
      "enabled": true
    },
```

* **Webhook** : Cela permettra d'utiliser les **jetons d'API kubectl** comme autorisation (tout jeton valide sera valide). Autorisez-le avec :
  * assurez-vous que le groupe API `authentication.k8s.io/v1beta1` est activ√© dans le serveur API
  * d√©marrez kubelet avec les indicateurs **`--authentication-token-webhook`** et **`--kubeconfig`** ou utilisez le param√®tre suivant :

```json
"authentication": {
    "webhook": {
      "cacheTTL": "2m0s",
      "enabled": true
    },
```

{% hint style="info" %}
Kubelet appelle l'API **`TokenReview`** sur le serveur API configur√© pour **d√©terminer les informations de l'utilisateur** √† partir des jetons porteurs.
{% endhint %}

* **Certificats client X509** : Permettent de s'authentifier via des certificats client X509
  * voir la documentation d'authentification [apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) pour plus de d√©tails
  * d√©marrez kubelet avec le param√®tre `--client-ca-file`, en fournissant un bundle CA pour v√©rifier les certificats clients. Ou avec la configuration :

```json
"authentication": {
    "x509": {
      "clientCAFile": "/etc/kubernetes/pki/ca.crt"
    }
}
```

## Autorisation de Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Toute demande qui est authentifi√©e avec succ√®s (y compris une demande anonyme) est ensuite autoris√©e. Le mode d'autorisation par d√©faut est **`AlwaysAllow`**, qui autorise toutes les demandes.

Cependant, la valeur possible est **`webhook`** (ce que vous trouverez **surtout l√†-bas**). Ce mode v√©rifiera les autorisations de l'utilisateur authentifi√© pour autoriser ou refuser une action.

{% hint style="warning" %}
Notez que m√™me si l'**authentification anonyme est activ√©e**, l'acc√®s **anonyme** pourrait **ne pas avoir les autorisations** n√©cessaires pour effectuer une action.
{% endhint %}

L'autorisation via webhook peut √™tre configur√©e en utilisant le param√®tre **`--authorization-mode=Webhook`** ou via le fichier de configuration avec :

```json
"authorization": {
    "mode": "Webhook",
    "webhook": {
      "cacheAuthorizedTTL": "5m0s",
      "cacheUnauthorizedTTL": "30s"
    }
},
```

Kubelet appelle l'API **`SubjectAccessReview`** sur le serveur API configur√© pour **d√©terminer si chaque demande est autoris√©e.**

Kubelet autorise les demandes d'API en utilisant la m√™me approche d'attributs de demande que l'apiserver :

* **Action**

| Verbe HTTP | Verbe de demande                                                                                                                                               |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (pour les ressources individuelles), list (pour les collections, y compris le contenu complet de l'objet), watch (pour regarder une ressource individuelle ou une collection de ressources) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (pour les ressources individuelles), deletecollection (pour les collections)                                                                                         |

* La **ressource** qui parle √† l'API Kubelet est **toujours** **nodes** et la **sous-ressource** est **d√©termin√©e** √† partir du chemin de la demande entrante :

| Kubelet API  | Ressource | Sous-ressource |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _tous les autres_ | nodes    | proxy       |

Par exemple, la demande suivante a tent√© d'acc√©der aux informations des pods de kubelet sans autorisation :

```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```

* Nous avons obtenu un **Forbidden**, donc la demande a **pass√© la v√©rification d'authentification**. Sinon, nous aurions simplement obtenu un message `Unauthorised`.
* Nous pouvons voir le **nom d'utilisateur** (dans ce cas, √† partir du jeton)
* V√©rifiez comment la **ressource** √©tait **nodes** et la **sous-ressource** **proxy** (ce qui est logique avec les informations pr√©c√©dentes)

## R√©f√©rences

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>