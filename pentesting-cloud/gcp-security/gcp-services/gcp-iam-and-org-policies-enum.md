# GCP - Enumera√ß√£o de IAM, Ppals e Pol√≠ticas de Org

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Contas de Servi√ßo

Para uma introdu√ß√£o sobre o que √© uma conta de servi√ßo, verifique:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumera√ß√£o

Uma conta de servi√ßo sempre pertence a um projeto:

```bash
gcloud iam service-accounts list --project <project>
```

## Usu√°rios e Grupos

Para uma introdu√ß√£o sobre como Usu√°rios e Grupos funcionam no GCP, verifique:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumera√ß√£o

Com as permiss√µes **`serviceusage.services.enable`** e **`serviceusage.services.use`**, √© poss√≠vel **ativar servi√ßos** em um projeto e us√°-los.

Se voc√™ pode **ativar o servi√ßo `admin`** e se seu usu√°rio tem **privil√©gios suficientes no workspace**, voc√™ pode **enumerar todos os grupos e usu√°rios** com as seguintes linhas.\
Mesmo que diga **`identity groups`**, ele tamb√©m retorna **usu√°rios sem nenhum grupo**:

```bash
# Ativar admin
gcloud services enable admin.googleapis.com
# Listar todos os usu√°rios e grupos
gcloud organizations list #O DIRECTORY_CUSTOMER_ID √© o ID do Workspace
gcloud beta identity groups preview --customer <workspace-id>
## Membros do grupo
gcloud identity groups memberships search-transitive-memberships --group-email=email@group.com
```

Mesmo com o servi√ßo de administra√ß√£o ativado, √© poss√≠vel que voc√™ obtenha um erro ao enumer√°-los porque o usu√°rio do seu workspace comprometido n√£o tem privil√©gios suficientes:

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Se voc√™ pode ativar o servi√ßo **`cloudidentity.googleapli.com`** se estiver desativado, voc√™ pode us√°-lo para **enumerar grupos** (como √© feito no PurplePanda em [aqui](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)):

```
gcloud services enable cloudidentity.googleapis.com
```

## IAM

Verifique [**isto para informa√ß√µes b√°sicas sobre IAM**](../gcp-basic-information.md#iam-roles).

### Permiss√µes padr√£o

Dos [**documentos**](https://cloud.google.com/resource-manager/docs/default-access-control): Quando um recurso da organiza√ß√£o √© criado, todos os usu√°rios em seu dom√≠nio recebem as fun√ß√µes de **Criador de Conta de Faturamento** e **Criador de Projeto** por padr√£o. Essas fun√ß√µes padr√£o permitem que seus usu√°rios comecem a usar o Google Cloud imediatamente, mas n√£o s√£o destinadas ao uso na opera√ß√£o regular do recurso da organiza√ß√£o.

Essas **fun√ß√µes** concedem as **permiss√µes**:

* `billing.accounts.create` e `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` e `resourcemanager.projects.create`

{% hint style="danger" %}
O privil√©gio mais alto em uma Organiza√ß√£o GCP √© a fun√ß√£o de **Administrador da Organiza√ß√£o**.
{% endhint %}

### Enumera√ß√£o

```bash
# Fun√ß√µes
## Listar fun√ß√µes
gcloud iam roles list --project $PROJECT_ID # Listar apenas fun√ß√µes personalizadas
gcloud iam roles list --filter='etag:AA=='

## Obter permiss√µes e descri√ß√£o da fun√ß√£o
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Pol√≠ticas
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Permiss√µes test√°veis no recurso
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Fun√ß√µes conced√≠veis a um recurso
gcloud iam list-grantable-roles <project URL>
```

#### Enumera√ß√£o via cloudasset

Existem diferentes maneiras de verificar todas as permiss√µes de um usu√°rio em diferentes recursos (como organiza√ß√µes