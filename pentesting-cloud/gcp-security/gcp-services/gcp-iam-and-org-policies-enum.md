# GCP - IAM、プリンシパル & 組織ポリシー列挙

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## サービスアカウント

サービスアカウントについてのイントロは以下をチェックしてください:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 列挙

サービスアカウントは常にプロジェクトに属しています：
```bash
gcloud iam service-accounts list --project <project>
```
## ユーザーとグループ

GCPのユーザーとグループの動作についての導入は、以下を確認してください：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 列挙

**`serviceusage.services.enable`** と **`serviceusage.services.use`** の権限を持っていると、プロジェクト内で**サービスを有効に**し、それらを使用することができます。

{% hint style="danger" %}
デフォルトでは、Workspaceユーザーには**プロジェクト作成者**の役割が付与されており、**新しいプロジェクトを作成する**アクセス権があります。ユーザーがプロジェクトを作成すると、そのプロジェクトに対して**`owner`** の役割が付与されます。したがって、**Workspaceを列挙するためにプロジェクト上でこれらのサービスを有効にする**ことができます。
{% endhint %}

**`admin` サービスを有効に**でき、かつユーザーがWorkspaceで**十分な権限を持っている**場合、以下の行を使用して**すべてのグループとユーザーを列挙**することができます。
**`identity groups`** と表示されていても、**グループに属していないユーザー**も返されます：

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
前の例ではパラメータ `--labels` が必要ですが、一般的な値が使用されています（[**PurplePandaがここで行っているように**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)直接APIを使用する場合は必要ありません）。
{% endhint %}

管理サービスを有効にしても、侵害されたWorkspaceユーザーの権限が不十分であるため、列挙中にエラーが発生する可能性があります：

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

IAMに関する基本情報については[**こちらを確認してください**](../gcp-basic-information.md#iam-roles)。

### デフォルトの権限

[**ドキュメント**](https://cloud.google.com/resource-manager/docs/default-access-control)によると、組織リソースが作成されると、ドメイン内のすべてのユーザーにデフォルトで**Billing Account Creator**および**Project Creator**の役割が付与されます。これらのデフォルトの役割により、ユーザーはすぐにGoogle Cloudの使用を開始できますが、組織リソースの通常の運用には意図されていません。

これらの**役割**は以下の**権限**を付与します：

* `billing.accounts.create` と `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` と `resourcemanager.projects.create`

さらに、ユーザーがプロジェクトを作成すると、[**ドキュメント**](https://cloud.google.com/resource-manager/docs/access-control-proj)によると、そのプロジェクトの**自動的に所有者になります**。したがって、デフォルトでは、ユーザーはプロジェクトを作成し、それに任意のサービス（マイナー？Workspace列挙？...）を実行することができます。

{% hint style="danger" %}
GCP組織で最も高い権限は**Organization Administrator**の役割です。
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

ほとんどのサービスでは、**`add-iam-policy-binding`** メソッドまたは **`set-iam-policy`** を使用してリソースの権限を変更できます。主な違いは、**`add-iam-policy-binding`** が既存のIAMポリシーに新しい役割バインディングを**追加する**ことであり、**`set-iam-policy`** は以前に**付与された権限を削除し**、コマンドで指定されたもののみを**設定します**。

### 列挙
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### cloudasset を通じた列挙

このサービスを使用して、さまざまなリソース（組織、フォルダ、プロジェクトなど）内のユーザーのすべての権限を確認する方法はいくつかあります。

* 権限 **`cloudasset.assets.searchAllIamPolicies`** はリソース内の**すべての iam ポリシー**を要求できます。
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* 権限 **`cloudasset.assets.analyzeIamPolicy`** は、リソース内のプリンシパルの**すべてのiamポリシー**を要求できます。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* 権限 **`cloudasset.assets.searchAllResources`** は、組織、フォルダ、またはプロジェクトのすべてのリソースをリストすることを可能にします。IAM 関連リソース（ロールなど）も含まれます。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* パーミッション **`cloudasset.assets.analyzeMove`** は、プロジェクトのようなリソースに影響を与えるポリシーを取得するのにも役立つかもしれません
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* パーミッション **`cloudasset.assets.queryIamPolicy`** は、プリンシパルのパーミッションを見つけるためのアクセスも提供する可能性があります。
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
前述の方法を使用してIAM情報に**アクセスできない場合**、Red Teamにいる場合は、[**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) のツールを使用して、現在の権限を**ブルートフォースすることができます。**
{% endhint %}

### 権限昇格

以下のページでは、IAM権限を悪用して**権限を昇格させる方法**について確認できます：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### 攻撃後の活動 <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### 持続性

高い権限を持っている場合、以下のことができます：

* 新しいSAs（またはWorkspace内のユーザー）を作成する
* 自分が管理するプリンシパルにさらに権限を与える
* 脆弱なSAsにさらに権限を与える（vm内のSSRF、脆弱なCloud Functionなど）
* …

## 組織ポリシー

組織ポリシーについてのイントロは、以下を確認してください：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAMポリシーは、ロールを介してリソースに対するプリンシパルの権限を示します。これらのロールには細かい権限が割り当てられています。組織ポリシーは、これらのサービスの使用方法を**制限したり、無効にされる機能がどれかを指定します**。これは、GCP環境内の各リソースの最小権限を向上させるために役立ちます。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

以下のページでは、**組織ポリシーの権限を悪用して権限を昇格させる方法**について確認できます：

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
