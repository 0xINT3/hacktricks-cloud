# GCP - IAM、Ppals 和组织策略枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 服务账户

关于服务账户是什么的介绍，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 枚举

服务账户总是属于一个项目：
```bash
gcloud iam service-accounts list --project <project>
```
## 用户与组

有关 GCP 中用户与组如何工作的介绍，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 枚举

拥有 **`serviceusage.services.enable`** 和 **`serviceusage.services.use`** 权限可以在项目中**启用服务**并使用它们。

如果你能够**启用 `admin` 服务**，并且你的用户在 workspace 中拥有**足够的权限**，你可以使用以下代码**枚举所有组和用户**。\
即使它显示为 **`identity groups`**，它也会返回**没有任何组的用户**：
```bash
# Enable admin
gcloud services enable admin.googleapis.com
# List all users & groups
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>
## Group Members
gcloud identity groups memberships search-transitive-memberships --group-email=email@group.com
```
即使启用了管理员服务，如果您的受损Workspace用户权限不足，您在枚举时可能会遇到错误：

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

如果您能够启用服务 **`cloudidentity.googleapli.com`**（如果已禁用），您可以使用它来**枚举群组**（就像在PurplePanda的[这里](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py)所做的那样）：
```
gcloud services enable cloudidentity.googleapis.com
```
## IAM

查看[**这里获取有关IAM的基本信息**](../gcp-basic-information.md#iam-roles)。

### 默认权限

根据[**文档**](https://cloud.google.com/resource-manager/docs/default-access-control)：当创建组织资源时，默认情况下，您域中的所有用户都会被授予**计费账户创建者**和**项目创建者**角色。这些默认角色允许您的用户立即开始使用Google Cloud，但并不适用于组织资源的常规操作。

这些**角色**授予以下**权限**：

* `billing.accounts.create` 和 `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` 和 `resourcemanager.projects.create`

{% hint style="danger" %}
在GCP组织中最高权限是**组织管理员**角色。
{% endhint %}

### 枚举
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### 通过 cloudasset 枚举

使用此服务，有不同的方法可以检查用户在不同资源（如组织、文件夹、项目等）中的所有权限。

* 权限 **`cloudasset.assets.searchAllIamPolicies`** 可以请求资源内的**所有 iam 策略**。
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* 权限 **`cloudasset.assets.analyzeIamPolicy`** 可以请求资源内主体的**所有iam策略**。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* 权限 **`cloudasset.assets.searchAllResources`** 允许列出组织、文件夹或项目的所有资源。包括与IAM相关的资源（如角色）。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* 权限 **`cloudasset.assets.analyzeMove`** 也可以用来检索影响资源（如项目）的策略
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* 我认为权限 **`cloudasset.assets.queryIamPolicy`** 也可能允许查找主体的权限
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
如果您**无法使用前述方法访问 IAM 信息**，并且您在红队中。您可以**使用工具** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **来暴力破解您当前的权限。**
{% endhint %}

### 权限提升

在以下页面中，您可以查看如何**滥用 IAM 权限来提升权限**：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### 服务账户模拟 <a href="#service-account-impersonation" id="service-account-impersonation"></a>

模拟服务账户可以非常有用，以**获得新的和更好的权限**。

您可以通过以下三种方式[模拟另一个服务账户](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account)：

* 使用 RSA 私钥进行**认证**（上文已覆盖）
* 使用 Cloud IAM 策略进行**授权**（此处覆盖）
* **在 GCP 服务上部署作业**（更适用于用户账户的妥协）

### 授予访问管理控制台的权限 <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

访问 [GCP 管理控制台](https://console.cloud.google.com) 是**提供给用户账户，而不是服务账户**。要登录到网络界面，您可以**授予您控制的 Google 账户访问权限**。这可以是一个通用的 "**@gmail.com**" 账户，它**不必是目标组织的成员**。

然而，要**授予**一个通用 "@gmail.com" 账户**Owner**的原始角色，您需要**使用网络控制台**。如果您尝试授予高于编辑者的权限，`gcloud` 会出错。

您可以使用以下命令**授予用户对您现有项目的编辑者原始角色**：
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
如果您在这里成功了，尝试**访问网络界面**并从那里探索。

这是您使用gcloud工具可以分配的**最高级别**。

## 组织策略

要了解组织策略是什么，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAM策略指示了主体通过角色对资源的权限，这些角色被分配了细粒度权限。组织策略**限制了这些服务的使用方式或哪些功能被禁用**。这有助于改善GCP环境中每个资源的最小权限。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### 权限提升

在以下页面中，您可以查看如何**滥用组织策略权限来提升权限**：

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

其他支持 HackTricks 的方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧。

</details>
