# GCP - IAM、プリンシパル & 組織ポリシーの列挙

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## サービスアカウント

サービスアカウントについてのイントロは以下をチェックしてください:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 列挙

サービスアカウントは常にプロジェクトに属しています：
```bash
gcloud iam service-accounts list --project <project>
```
## ユーザーとグループ

GCPのユーザーとグループの動作についての導入は、以下を確認してください：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 列挙

**`serviceusage.services.enable`** と **`serviceusage.services.use`** の権限を持っていると、プロジェクト内で**サービスを有効にし**、それらを**使用することが可能です**。

{% hint style="danger" %}
デフォルトでは、Workspaceユーザーには**プロジェクト作成者**の役割が付与されており、**新しいプロジェクトを作成する**アクセス権を持っています。ユーザーがプロジェクトを作成すると、そのプロジェクトに対して**`owner`** 役割が付与されます。したがって、**Workspaceを列挙するためにプロジェクト上でこれらのサービスを有効にする**ことができます。
{% endhint %}

**`admin` サービスを有効にすることができ**、かつあなたのユーザーがWorkspaceで**十分な権限を持っている場合**、以下の行を使用して**すべてのグループとユーザーを列挙する**ことができます。
**`identity groups`** と表示されていても、**グループに属していないユーザーも返されます**：

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
前の例ではパラメータ `--labels` が必要ですが、一般的な値が使用されています（[**PurplePandaがここで行っているように**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)直接APIを使用する場合は必要ありません）。
{% endhint %}

管理サービスを有効にしても、侵害されたWorkspaceユーザーに十分な権限がないため、列挙中にエラーが発生する可能性があります：

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

IAMに関する基本情報については[**こちらを確認してください**](../gcp-basic-information.md#iam-roles)。

### デフォルトの権限

[**ドキュメント**](https://cloud.google.com/resource-manager/docs/default-access-control)によると、組織リソースが作成されると、ドメイン内のすべてのユーザーにデフォルトで**Billing Account Creator**と**Project Creator**の役割が付与されます。これらのデフォルトの役割により、ユーザーはすぐにGoogle Cloudの使用を開始できますが、組織リソースの通常の運用には意図されていません。

これらの**役割**は以下の**権限**を付与します：

* `billing.accounts.create` と `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` と `resourcemanager.projects.create`

さらに、ユーザーがプロジェクトを作成すると、[ドキュメント](https://cloud.google.com/resource-manager/docs/access-control-proj)によると、そのプロジェクトの**自動的に所有者になります**。したがって、デフォルトでは、ユーザーはプロジェクトを作成し、それに任意のサービス（マイナー？Workspace列挙？...）を実行することができます。

{% hint style="danger" %}
GCP組織で最も高い権限は**Organization Administrator**の役割です。
{% endhint %}

### 列挙
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### cloudasset を通じた列挙

このサービスを使用して、さまざまなリソース（組織、フォルダ、プロジェクトなど）内のユーザーのすべての権限を確認する方法がいくつかあります。

* 権限 **`cloudasset.assets.searchAllIamPolicies`** は、リソース内の**すべての iam ポリシー**を要求できます。
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* 権限 **`cloudasset.assets.analyzeIamPolicy`** は、リソース内のプリンシパルの**すべてのIAMポリシー**を要求できます。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* 権限 **`cloudasset.assets.searchAllResources`** は、組織、フォルダ、またはプロジェクトのすべてのリソースをリストすることを許可します。IAM 関連リソース（ロールなど）も含まれます。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* パーミッション **`cloudasset.assets.analyzeMove`** は、プロジェクトのようなリソースに影響を与えるポリシーを取得するのにも役立つ場合があります
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* 権限 **`cloudasset.assets.queryIamPolicy`** は、プリンシパルの権限を見つけるためにもアクセスを与える可能性があります
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
前述の方法でIAM情報に**アクセスできない場合**、Red Teamの一員であれば、現在の権限をブルートフォースするためにツール [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) を**使用することができます。**
{% endhint %}

### Privesc

以下のページでは、IAM権限を悪用して権限を昇格する方法について確認できます：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### サービスアカウントのなりすまし <a href="#service-account-impersonation" id="service-account-impersonation"></a>

サービスアカウントをなりすますことは、**新しく、より良い権限を取得する**ために非常に有用です。

[他のサービスアカウントをなりすます](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account)方法は3つあります：

* **RSAプライベートキーを使用した認証**（上記で説明）
* **Cloud IAMポリシーを使用した認可**（ここで説明）
* **GCPサービス上でのジョブのデプロイ**（ユーザーアカウントの妥協により適用される）

### 管理コンソールへのアクセス権の付与 <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

[GCP管理コンソール](https://console.cloud.google.com)へのアクセスは、**サービスアカウントではなくユーザーアカウントに提供されます**。ウェブインターフェースにログインするには、制御下にある**Googleアカウントにアクセス権を付与**できます。これは一般的な"**@gmail.com**"アカウントであり、**対象組織のメンバーである必要はありません**。

ただし、一般的な"@gmail.com"アカウントに**Owner**のプリミティブロールを**付与**するには、**ウェブコンソールを使用**する必要があります。`gcloud`は、Editor以上の権限を付与しようとするとエラーになります。

以下のコマンドを使用して、既存のプロジェクトに対してユーザーに**Editor**のプリミティブロールを**付与**できます：
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
成功したら、**ウェブインターフェースにアクセスして**、そこから探索してみてください。

これは、gcloudツールを使用して割り当てることができる**最高レベルです**。

## 組織ポリシー

組織ポリシーについての導入は、以下を確認してください：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAMポリシーは、役割を介してリソースに対するプリンシパルの権限を示します。これらの役割には、細かい権限が割り当てられています。組織ポリシーは、**サービスの使用方法を制限したり、無効になっている機能を指定したりします**。これにより、GCP環境内の各リソースの最小権限の向上に役立ちます。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

以下のページで、**組織ポリシーの権限を悪用して権限を昇格する方法**について確認できます：

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>
