# GCP - IAM, Κύριοι & Πολιτικές Οργανισμού Enum

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Λογαριασμοί Υπηρεσιών

Για μια εισαγωγή σχετικά με το τι είναι ένας λογαριασμός υπηρεσίας, ελέγξτε:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Απαρίθμηση

Ένας λογαριασμός υπηρεσίας ανήκει πάντα σε ένα έργο:
```bash
gcloud iam service-accounts list --project <project>
```
## Χρήστες & Ομάδες

Για μια εισαγωγή σχετικά με το πώς λειτουργούν οι Χρήστες & Ομάδες στο GCP, ανατρέξτε στο:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Απαρίθμηση

Με τις άδειες **`serviceusage.services.enable`** και **`serviceusage.services.use`** είναι δυνατόν να **ενεργοποιηθούν υπηρεσίες** σε ένα έργο και να χρησιμοποιηθούν.

{% hint style="danger" %}
Σημειώστε ότι από προεπιλογή, οι χρήστες του Workspace αποκτούν τον ρόλο **Δημιουργού Έργου**, που τους δίνει πρόσβαση για **δημιουργία νέων έργων**. Όταν ένας χρήστης δημιουργεί ένα έργο, του απονέμεται ο ρόλος **`owner`** πάνω του. Έτσι, μπορεί να **ενεργοποιήσει αυτές τις υπηρεσίες στο έργο για να μπορεί να απαριθμήσει το Workspace**.

Ωστόσο, παρατηρήστε ότι απαιτείται επίσης να έχετε **αρκετές άδειες στο Workspace** για να μπορείτε να καλέσετε αυτές τις διεπαφές προγραμματισμού εφαρμογών (APIs).
{% endhint %}

Εάν μπορείτε να **ενεργοποιήσετε την υπηρεσία `admin`** και εάν ο χρήστης σας έχει **αρκετά προνόμια στο workspace**, μπορείτε να **απαριθμήσετε όλες τις ομάδες και τους χρήστες** με τις παρακάτω γραμμές.\
Ακόμη κι αν λέει **`identity groups`**, επιστρέφει επίσης **χρήστες χωρίς καμία ομάδα**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Στα προηγούμενα παραδείγματα, η παράμετρος `--labels` είναι υποχρεωτική, οπότε χρησιμοποιείται μια γενική τιμή (δεν είναι απαραίτητη εάν χρησιμοποιήσατε το API απευθείας όπως κάνει ο [**PurplePanda εδώ**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Ακόμα και με την ενεργοποίηση της υπηρεσίας διαχειριστή, είναι δυνατόν να λάβετε ένα σφάλμα κατά την απαρίθμησή τους επειδή ο χρήστης του χώρου εργασίας που έχετε παραβιάσει δεν έχει αρκετές άδειες:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Ελέγξτε [**αυτό για βασικές πληροφορίες σχετικά με το IAM**](../gcp-basic-information.md#iam-roles).

### Προεπιλεγμένες Άδειες

Από τα [**έγγραφα**](https://cloud.google.com/resource-manager/docs/default-access-control): Όταν δημιουργείται ένας πόρος οργανισμού, όλοι οι χρήστες στον τομέα σας αποκτούν αυτόματα τους ρόλους **Billing Account Creator** και **Project Creator**. Αυτοί οι προεπιλεγμένοι ρόλοι επιτρέπουν στους χρήστες σας να αρχίσουν να χρησιμοποιούν αμέσως το Google Cloud, αλλά δεν προορίζονται για χρήση στην κανονική λειτουργία του πόρου του οργανισμού σας.

Αυτοί οι **ρόλοι** χορηγούν τις **άδειες**:

* `billing.accounts.create` και `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` και `resourcemanager.projects.create`

Επιπλέον, όταν ένας χρήστης δημιουργεί ένα έργο, του απονέμεται αυτόματα ο ιδιοκτήτης του έργου σύμφωνα με τα [έγγραφα](https://cloud.google.com/resource-manager/docs/access-control-proj). Επομένως, από προεπιλογή, ένας χρήστης θα μπορεί να δημιουργήσει ένα έργο και να εκτελέσει οποιαδήποτε υπηρεσία σε αυτό (αναντιρρήτως; απαρίθμηση Workspace; ...)

{% hint style="danger" %}
Η υψηλότερη προνομιούχα θέση σε έναν οργανισμό GCP είναι ο ρόλος **Διαχειριστής Οργανισμού**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

Στις περισσότερες υπηρεσίες θα μπορείτε να αλλάξετε τις άδειες ενός πόρου χρησιμοποιώντας τη μέθοδο **`add-iam-policy-binding`** ή **`set-iam-policy`**. Η κύρια διαφορά είναι ότι η **`add-iam-policy-binding` προσθέτει μια νέα δέσμευση ρόλου** στην υπάρχουσα πολιτική IAM, ενώ η **`set-iam-policy`** θα **διαγράψει τις προηγούμενα** χορηγημένες άδειες και θα **ορίσει μόνο τις** που υποδεικνύονται στην εντολή.

### Απαρίθμηση
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### Απαρίθμηση μέσω του cloudasset

Υπάρχουν διάφοροι τρόποι για να ελέγξετε όλα τα δικαιώματα ενός χρήστη σε διάφορους πόρους (όπως οργανισμοί, φάκελοι, έργα...) χρησιμοποιώντας αυτήν την υπηρεσία.

* Το δικαίωμα **`cloudasset.assets.searchAllIamPolicies`** μπορεί να ζητήσει **όλες τις πολιτικές iam** μέσα σε έναν πόρο.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Η άδεια **`cloudasset.assets.analyzeIamPolicy`** μπορεί να ζητήσει **όλες τις πολιτικές iam** ενός κύριου μέσα σε ένα πόρο.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Η άδεια **`cloudasset.assets.searchAllResources`** επιτρέπει την καταγραφή όλων των πόρων μιας οργάνωσης, φακέλου ή έργου. Συμπεριλαμβάνονται οι σχετικοί πόροι IAM (όπως οι ρόλοι).
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Η άδεια **`cloudasset.assets.analyzeMove`** μπορεί να είναι χρήσιμη για να ανακτήσετε επίσης πολιτικές που επηρεάζουν ένα πόρο όπως ένα έργο.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Υποθέτω ότι η άδεια **`cloudasset.assets.queryIamPolicy`** μπορεί επίσης να παρέχει πρόσβαση για την εύρεση των δικαιωμάτων των αρχών.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
Εάν **δεν μπορείτε να έχετε πρόσβαση στις πληροφορίες IAM** χρησιμοποιώντας τις προηγούμενες μεθόδους και είστε σε ομάδα Red Team, μπορείτε **να χρησιμοποιήσετε το εργαλείο** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **για να εκτελέσετε brute-force στα τρέχοντα δικαιώματά σας**.
{% endhint %}

### Privesc

Στην ακόλουθη σελίδα μπορείτε να ελέγξετε πώς να **καταχραστείτε τα δικαιώματα IAM για να αναβαθμίσετε τα προνόμια**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Unauthenticated Enum <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistence

Εάν έχετε υψηλά προνόμια, μπορείτε:

* Δημιουργήστε νέα Λογαριασμια Υπηρεσίας (ή χρήστες αν είστε στο Workspace)
* Δώστε στους δικαιούχους που ελέγχετε περισσότερα δικαιώματα
* Δώστε περισσότερα προνόμια σε ευάλωτα Λογαριασμια Υπηρεσίας (SSRF σε vm, ευπάθεια στην Cloud Function...)
* ...

## Org Policies

Για μια εισαγωγή σχετικά με το τι είναι οι Org Policies, ελέγξτε:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

Οι πολιτικές IAM υποδεικνύουν τα δικαιώματα που έχουν οι δικαιούχοι σε πόρους μέσω ρόλων, οι οποίοι έχουν ανατεθεί διακριτά δικαιώματα. Οι πολιτικές οργανισμού **περιορίζουν τον τρόπο με τον οποίο μπορούν να χρησιμοποιηθούν αυτές οι υπηρεσίες ή ποιες λειτουργίες είναι απενεργοποιημένες**. Αυτό βοηθά για να βελτιωθεί η αρχή του ελάχιστου προνομίου για κάθε πόρο στο περιβάλλον GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Ανέβασμα Προνομίων

Στην ακόλουθη σελίδα μπορείτε να ελέγξετε πώς να **καταχραστείτε τα δικαιώματα των πολιτικών οργανισμού για να αναβαθμίσετε τα προνόμια**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
