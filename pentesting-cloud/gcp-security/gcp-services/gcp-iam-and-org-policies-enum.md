# GCP - IAM, Principais & Enumera√ß√£o de Pol√≠ticas Organizacionais

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Contas de Servi√ßo

Para uma introdu√ß√£o sobre o que √© uma conta de servi√ßo, confira:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumera√ß√£o

Uma conta de servi√ßo sempre pertence a um projeto:
```bash
gcloud iam service-accounts list --project <project>
```
## Usu√°rios & Grupos

Para uma introdu√ß√£o sobre como Usu√°rios & Grupos funcionam no GCP, confira:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumera√ß√£o

Com as permiss√µes **`serviceusage.services.enable`** e **`serviceusage.services.use`**, √© poss√≠vel **ativar servi√ßos** em um projeto e us√°-los.

{% hint style="danger" %}
Note que, por padr√£o, os usu√°rios do Workspace recebem a fun√ß√£o **Criador de Projeto**, dando-lhes acesso para **criar novos projetos**. Quando um usu√°rio cria um projeto, ele recebe a fun√ß√£o de **`propriet√°rio`** sobre ele. Assim, ele poderia **ativar esses servi√ßos no projeto para poder enumerar o Workspace**.
{% endhint %}

Se voc√™ conseguir **ativar o servi√ßo `admin`** e se o seu usu√°rio tiver **privil√©gios suficientes no workspace,** voc√™ poder√° **enumerar todos os grupos e usu√°rios** com as seguintes linhas.\
Mesmo que diga **`identity groups`**, tamb√©m retorna **usu√°rios sem nenhum grupo**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Nos exemplos anteriores, o par√¢metro `--labels` √© necess√°rio, ent√£o um valor gen√©rico √© usado (n√£o √© necess√°rio se voc√™ usar a API diretamente como [**PurplePanda faz aqui**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py).
{% endhint %}

Mesmo com o servi√ßo de administra√ß√£o habilitado, √© poss√≠vel que voc√™ receba um erro ao enumer√°-los porque seu usu√°rio comprometido do Workspace n√£o tem permiss√µes suficientes:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Verifique [**isto para informa√ß√µes b√°sicas sobre IAM**](../gcp-basic-information.md#iam-roles).

### Permiss√µes Padr√£o

De acordo com a [**documenta√ß√£o**](https://cloud.google.com/resource-manager/docs/default-access-control): Quando um recurso de organiza√ß√£o √© criado, todos os usu√°rios do seu dom√≠nio recebem por padr√£o os pap√©is de **Criador de Conta de Faturamento** e **Criador de Projeto**. Esses pap√©is padr√£o permitem que seus usu√°rios comecem a usar o Google Cloud imediatamente, mas n√£o s√£o destinados para uso regular do recurso da sua organiza√ß√£o.

Esses **pap√©is** concedem as **permiss√µes**:

* `billing.accounts.create` e `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` e `resourcemanager.projects.create`

Al√©m disso, quando um usu√°rio cria um projeto, ele √© **automaticamente concedido como propriet√°rio desse projeto** de acordo com a [documenta√ß√£o](https://cloud.google.com/resource-manager/docs/access-control-proj). Portanto, por padr√£o, um usu√°rio poder√° criar um projeto e executar qualquer servi√ßo nele (minera√ß√£o? Enumera√ß√£o do Workspace? ...)

{% hint style="danger" %}
O privil√©gio mais alto em uma Organiza√ß√£o GCP √© o papel de **Administrador da Organiza√ß√£o**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

Na maioria dos servi√ßos, voc√™ poder√° alterar as permiss√µes sobre um recurso usando o m√©todo **`add-iam-policy-binding`** ou **`set-iam-policy`**. A principal diferen√ßa √© que **`add-iam-policy-binding` adiciona uma nova vincula√ß√£o de papel** √† pol√≠tica IAM existente, enquanto **`set-iam-policy`** ir√° **deletar as permiss√µes previamente** concedidas e **definir apenas as** indicadas no comando.

### Enumera√ß√£o
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### Enumera√ß√£o via cloudasset

Existem diferentes maneiras de verificar todas as permiss√µes de um usu√°rio em diferentes recursos (como organiza√ß√µes, pastas, projetos...) utilizando este servi√ßo.

* A permiss√£o **`cloudasset.assets.searchAllIamPolicies`** pode solicitar **todas as pol√≠ticas iam** dentro de um recurso.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* A permiss√£o **`cloudasset.assets.analyzeIamPolicy`** pode solicitar **todas as pol√≠ticas iam** de um principal dentro de um recurso.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* A permiss√£o **`cloudasset.assets.searchAllResources`** permite listar todos os recursos de uma organiza√ß√£o, pasta ou projeto. Recursos relacionados ao IAM (como fun√ß√µes) inclu√≠dos.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* A permiss√£o **`cloudasset.assets.analyzeMove`** pode ser √∫til para tamb√©m recuperar pol√≠ticas que afetam um recurso como um projeto
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Suponho que a permiss√£o **`cloudasset.assets.queryIamPolicy`** tamb√©m possa dar acesso para encontrar permiss√µes de principais
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
Se voc√™ **n√£o consegue acessar informa√ß√µes do IAM** usando os m√©todos anteriores e est√° em um Red Team, voc√™ poderia **usar a ferramenta** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **para for√ßar bruscamente suas permiss√µes atuais.**
{% endhint %}

### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do IAM para escalar privil√©gios**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Enumera√ß√£o N√£o Autenticada <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

Se voc√™ tem privil√©gios elevados, voc√™ poderia:

* Criar novos SAs (ou usu√°rios, se no Workspace)
* Dar a principais controlados por voc√™ mais permiss√µes
* Dar mais privil√©gios a SAs vulner√°veis (SSRF em vm, Cloud Function vulner√°vel‚Ä¶)
* ‚Ä¶

## Pol√≠ticas de Organiza√ß√£o

Para uma introdu√ß√£o sobre o que s√£o Pol√≠ticas de Organiza√ß√£o, confira:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

As pol√≠ticas do IAM indicam as permiss√µes que os principais t√™m sobre os recursos por meio de pap√©is, que s√£o atribu√≠dos permiss√µes granulares. Pol√≠ticas de organiza√ß√£o **restringem como esses servi√ßos podem ser usados ou quais recursos est√£o desabilitados**. Isso ajuda a melhorar o princ√≠pio do menor privil√©gio de cada recurso no ambiente GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes de pol√≠ticas organizacionais para escalar privil√©gios**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
