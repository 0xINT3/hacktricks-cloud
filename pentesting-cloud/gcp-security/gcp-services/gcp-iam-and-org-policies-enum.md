# GCP - IAM, Podmioty i Polityki Org Enumeracja

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>

## Konta usług

Aby dowiedzieć się, czym jest konto usługi, sprawdź:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeracja

Konto usługi zawsze należy do projektu:
```bash
gcloud iam service-accounts list --project <project>
```
## Użytkownicy i grupy

Aby uzyskać wprowadzenie do tego, jak działają użytkownicy i grupy w GCP, sprawdź:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Wyliczanie

Z uprawnieniami **`serviceusage.services.enable`** i **`serviceusage.services.use`** można **włączać usługi** w projekcie i z nich korzystać.

{% hint style="danger" %}
Należy pamiętać, że domyślnie użytkownicy Workspace otrzymują rolę **Twórca projektu**, co daje im dostęp do **tworzenia nowych projektów**. Gdy użytkownik tworzy projekt, otrzymuje rolę **`owner`** nad nim. Może więc **włączyć te usługi w projekcie, aby móc wyliczać Workspace**.

Należy jednak zauważyć, że konieczne jest również posiadanie **wystarczających uprawnień w Workspace**, aby móc wywoływać te interfejsy API.
{% endhint %}

Jeśli możesz **włączyć usługę `admin`** i jeśli twoje konto ma **wystarczające uprawnienia w Workspace**, możesz **wyliczyć wszystkie grupy i użytkowników** za pomocą poniższych linii.\
Nawet jeśli jest napisane **`identity groups`**, zwraca również **użytkowników bez żadnych grup**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
W poprzednich przykładach parametr `--labels` jest wymagany, więc używana jest ogólna wartość (nie jest wymagany, jeśli używasz API bezpośrednio, tak jak [**PurplePanda robi tutaj**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

Nawet jeśli usługa admin jest włączona, istnieje możliwość, że otrzymasz błąd podczas ich wyliczania, ponieważ skompromitowany użytkownik przestrzeni roboczej nie ma wystarczających uprawnień:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Sprawdź [**to dla podstawowych informacji o IAM**](../gcp-basic-information.md#iam-roles).

### Domyślne uprawnienia

Z [**dokumentacji**](https://cloud.google.com/resource-manager/docs/default-access-control): Po utworzeniu zasobu organizacji, wszyscy użytkownicy w Twojej domenie otrzymują domyślnie role **Twórca konta rozliczeniowego** i **Twórca projektu**. Te domyślne role pozwalają Twoim użytkownikom na natychmiastowe korzystanie z Google Cloud, ale nie są przeznaczone do regularnego użytku w ramach zasobu organizacji.

Te **role** przyznają **uprawnienia**:

* `billing.accounts.create` i `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` i `resourcemanager.projects.create`

Ponadto, gdy użytkownik tworzy projekt, automatycznie **otrzymuje uprawnienia właściciela tego projektu** zgodnie z [dokumentacją](https://cloud.google.com/resource-manager/docs/access-control-proj). Dlatego domyślnie użytkownik będzie mógł tworzyć projekt i uruchamiać na nim dowolną usługę (koparki? Wyliczanie przestrzeni roboczej? ...)

{% hint style="danger" %}
Najwyższą uprawnieniem w organizacji GCP jest rola **Administratora organizacji**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

W większości usług będziesz mógł zmieniać uprawnienia dla zasobu za pomocą metody **`add-iam-policy-binding`** lub **`set-iam-policy`**. Główna różnica polega na tym, że **`add-iam-policy-binding` dodaje nowe powiązanie ról** do istniejącej polityki IAM, podczas gdy **`set-iam-policy`** **usunie wcześniej** przyznane uprawnienia i **ustawi tylko te** wskazane w poleceniu.

### Wyliczanie
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### Wyliczanie za pomocą cloudasset

Istnieje wiele sposobów na sprawdzenie wszystkich uprawnień użytkownika w różnych zasobach (takich jak organizacje, foldery, projekty...) za pomocą tej usługi.

* Uprawnienie **`cloudasset.assets.searchAllIamPolicies`** pozwala na żądanie **wszystkich polityk IAM** wewnątrz zasobu.
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* Uprawnienie **`cloudasset.assets.analyzeIamPolicy`** umożliwia żądanie **wszystkich polityk IAM** dla podmiotu w zasobie.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* Uprawnienie **`cloudasset.assets.searchAllResources`** umożliwia wyświetlanie wszystkich zasobów organizacji, folderu lub projektu, w tym zasobów związanych z IAM (takich jak role).
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* Uprawnienie **`cloudasset.assets.analyzeMove`** może być przydatne do pobrania również polityk dotyczących zasobu, takiego jak projekt.
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Przypuszczam, że uprawnienie **`cloudasset.assets.queryIamPolicy`** również może umożliwiać dostęp do wyszukiwania uprawnień podmiotów.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
Jeśli **nie możesz uzyskać dostępu do informacji IAM** za pomocą wcześniejszych metod i jesteś w Red Team. Możesz **użyć narzędzia** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **do próby siłowej swoich obecnych uprawnień.**
{% endhint %}

### Privesc

Na następnej stronie możesz sprawdzić, jak **nadużywać uprawnień IAM w celu eskalacji uprawnień**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Nieuwierzytelniona enumeracja <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Trwałość

Jeśli masz wysokie uprawnienia, możesz:

* Tworzyć nowe konta usług (lub użytkowników, jeśli jesteś w Workspace)
* Przyznawać kontrolowane przez siebie podmioty większe uprawnienia
* Przyznawać większe uprawnienia podatnym kontom usług (SSRF w maszynie wirtualnej, podatna funkcja Cloud...)
* ...

## Polityki organizacji

Aby uzyskać wprowadzenie do tego, czym są polityki organizacji, sprawdź:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

Polityki IAM wskazują, jakie uprawnienia mają podmioty wobec zasobów za pomocą ról, które są przypisywane uprawnienia granularne. Polityki organizacji **ograniczają sposób korzystania z tych usług lub wyłączają niektóre funkcje**. Pomaga to poprawić zasadę najmniejszych uprawnień dla każdego zasobu w środowisku GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Przywileje

Na następnej stronie możesz sprawdzić, jak **wykorzystać uprawnienia polityk organizacji do eskalacji uprawnień**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
