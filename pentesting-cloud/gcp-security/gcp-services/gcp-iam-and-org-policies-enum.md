# GCP - IAM、主体和组织策略枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 服务账户

关于服务账户是什么的介绍，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 枚举

服务账户总是属于一个项目：
```bash
gcloud iam service-accounts list --project <project>
```
## 用户和组

有关 GCP 中用户和组如何工作的介绍，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 枚举

拥有 **`serviceusage.services.enable`** 和 **`serviceusage.services.use`** 权限可以在项目中**启用服务**并使用它们。

{% hint style="danger" %}
请注意，默认情况下，Workspace 用户被授予 **项目创建者** 角色，允许他们**创建新项目**。当用户创建项目时，他将被授予该项目的 **`owner`** 角色。因此，他可以**在项目上启用这些服务以便能够枚举 Workspace**。
{% endhint %}

如果你可以**启用 `admin` 服务**，并且你的用户在 workspace 中拥有**足够的权限**，你可以使用以下代码**枚举所有组和用户**。\
即使它显示为 **`identity groups`**，它也会返回**没有任何组的用户**：

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
在前面的例子中，参数 `--labels` 是必需的，因此使用了一个通用值（如果你直接像 [**PurplePanda 在这里做的那样**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py) 使用 API，则不需要）。
{% endhint %}

即使启用了管理员服务，如果你的受损 Workspace 用户权限不足，你也可能在枚举时遇到错误：

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

查看 [**这里的基础信息关于 IAM**](../gcp-basic-information.md#iam-roles)。

### 默认权限

根据 [**文档**](https://cloud.google.com/resource-manager/docs/default-access-control)：当创建组织资源时，默认会授予你的域中所有用户 **Billing Account Creator** 和 **Project Creator** 角色。这些默认角色允许用户立即开始使用 Google Cloud，但不适用于组织资源的常规操作。

这些 **角色** 授予 **权限**：

* `billing.accounts.create` 和 `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` 和 `resourcemanager.projects.create`

此外，当用户创建项目时，根据 [文档](https://cloud.google.com/resource-manager/docs/access-control-proj)，他会 **自动被授予该项目的所有者**。因此，默认情况下，用户将能够创建项目并在其上运行任何服务（挖矿？Workspace 枚举？...）

{% hint style="danger" %}
在 GCP 组织中最高权限是 **Organization Administrator** 角色。
{% endhint %}

### set-iam-policy 与 add-iam-policy-binding

在大多数服务中，你将能够使用 **`add-iam-policy-binding`** 或 **`set-iam-policy`** 方法更改对资源的权限。主要区别在于 **`add-iam-policy-binding` 添加一个新的角色绑定** 到现有的 IAM 策略，而 **`set-iam-policy`** 将 **删除以前** 授予的权限，并 **仅设置** 命令中指示的权限。

### 枚举
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### 通过 cloudasset 进行枚举

使用此服务，有不同的方法可以检查用户在不同资源（如组织、文件夹、项目等）中的所有权限。

* 权限 **`cloudasset.assets.searchAllIamPolicies`** 可以请求资源内的**所有 iam 策略**。
```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```
* 权限 **`cloudasset.assets.analyzeIamPolicy`** 可以请求资源内主体的**所有iam策略**。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```
* 权限 **`cloudasset.assets.searchAllResources`** 允许列出组织、文件夹或项目的所有资源。包括与IAM相关的资源（如角色）。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* 权限 **`cloudasset.assets.analyzeMove`** 也可以用来检索影响资源（如项目）的策略
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* 我认为权限 **`cloudasset.assets.queryIamPolicy`** 也可能允许查找主体的权限
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
如果您**无法使用前述方法访问IAM信息**，并且您在红队中。您可以**使用工具** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **来暴力破解您当前的权限。**
{% endhint %}

### 权限提升

在以下页面中，您可以查看如何**滥用IAM权限来提升权限**：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### 后期利用 <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### 持久性

如果您拥有高权限，您可以：

* 创建新的SAs（或者如果在Workspace中的用户）
* 给予您自己控制的主体更多权限
* 给予有漏洞的SAs更多权限（vm中的SSRF，有漏洞的Cloud Function…）
* …

## 组织策略

关于组织策略是什么的介绍，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAM策略通过分配细粒度权限的角色，指示主体对资源的权限。组织策略**限制了这些服务的使用方式或哪些功能被禁用**。这有助于改善GCP环境中每个资源的最小权限。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### 权限提升

在以下页面中，您可以查看如何**滥用组织策略权限来提升权限**：

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客技术！</strong></summary>

其他支持 HackTricks 的方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。**

</details>
