# GCP - IAM、Ppals＆Orgポリシーの列挙

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## サービスアカウント

サービスアカウントについての紹介は次を参照してください：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 列挙

サービスアカウントは常にプロジェクトに所属しています：
```bash
gcloud iam service-accounts list --project <project>
```
## ユーザーとグループ

GCPでのユーザーとグループの動作についての紹介は以下を参照してください：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 列挙

権限 **`serviceusage.services.enable`** と **`serviceusage.services.use`** を持っている場合、プロジェクトでサービスを有効化し使用することができます。

`admin` サービスを有効化でき、ユーザーがワークスペースで十分な特権を持っている場合、以下のコマンドですべてのグループとユーザーを列挙することができます。\
**`identity groups`** と表示されているが、グループに属さないユーザーも返されます：
```bash
# Enable admin
gcloud services enable admin.googleapis.com
# List all users & groups
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>
## Group Members
gcloud identity groups memberships search-transitive-memberships --group-email=email@group.com
```
管理者サービスが有効になっていても、侵害されたワークスペースのユーザーに十分な権限がないため、それらを列挙する際にエラーが発生する可能性があります。

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

無効になっている場合、サービス **`cloudidentity.googleapli.com`** を有効にすることができれば、それを使用して **グループを列挙** することができます（[ここ](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py)のPurplePandaで行われているように）。
```
gcloud services enable cloudidentity.googleapis.com
```
## IAM

[**こちら**](../gcp-basic-information.md#iam-roles)を参照してIAMの基本情報を確認してください。

### デフォルトの権限

[**ドキュメント**](https://cloud.google.com/resource-manager/docs/default-access-control)によると、組織リソースが作成されると、デフォルトでドメイン内のすべてのユーザーには**Billing Account Creator**および**Project Creator**の役割が付与されます。これらのデフォルトの役割は、Google Cloudをすぐに使用できるようにするためのものですが、組織リソースの通常の運用には使用されません。

これらの**役割**は以下の**権限**を付与します：

- `billing.accounts.create`と`resourcemanager.organizations.get`
- `resourcemanager.organizations.get`と`resourcemanager.projects.create`

{% hint style="danger" %}
GCP組織で最も高い特権は**Organization Administrator**の役割です。
{% endhint %}

### 列挙
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### cloudassetを使用した列挙

このサービスを使用して、組織、フォルダ、プロジェクトなどのさまざまなリソースでユーザーのすべての権限を確認する方法はいくつかあります。

* 権限 **`cloudasset.assets.searchAllIamPolicies`** は、リソース内の**すべてのIAMポリシー**をリクエストすることができます。
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* パーミッション **`cloudasset.assets.analyzeIamPolicy`** は、リソース内のプリンシパルの **すべての IAM ポリシー** をリクエストすることができます。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* パーミッション **`cloudasset.assets.searchAllResources`** は、組織、フォルダ、またはプロジェクトのすべてのリソースをリストすることを許可します。IAM 関連のリソース（ロールなど）も含まれます。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* パーミッション **`cloudasset.assets.analyzeMove`** は、プロジェクトのようなリソースに影響を与えるポリシーを取得するのにも役立つかもしれません。
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* 私は、権限**`cloudasset.assets.queryIamPolicy`**も、プリンシパルの権限を検索するためのアクセスを提供する可能性があると考えています。
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
前の方法でIAM情報にアクセスできない場合、Red Teamにいる場合は、[https://github.com/carlospolop/my_gcp_perms](https://github.com/carlospolop/my_gcp_perms)というツールを使用して、現在の権限をブルートフォースすることができます。
{% endhint %}

### 特権昇格

次のページでは、IAM権限を悪用して特権を昇格させる方法を確認できます：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### サービスアカウントのなりすまし <a href="#service-account-impersonation" id="service-account-impersonation"></a>

サービスアカウントのなりすましは、新しい特権を取得するために非常に便利です。

[別のサービスアカウントになりすます](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating_a_service_account)方法は3つあります：

- RSAプライベートキーを使用した認証（上記で説明済み）
- Cloud IAMポリシーを使用した認可（ここで説明）
- GCPサービス上でのジョブの展開（ユーザーアカウントの侵害により適用される）

### 管理コンソールへのアクセスの付与 <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

[GCP管理コンソール](https://console.cloud.google.com)へのアクセスは、サービスアカウントではなくユーザーアカウントに提供されます。Webインターフェースにログインするために、制御しているGoogleアカウントにアクセスを付与できます。これは一般的な「@gmail.com」アカウントである必要があり、対象の組織のメンバーである必要はありません。

既存のプロジェクトに対してユーザーに**Editorの原始的な役割を付与**するために、次のコマンドを使用できます：
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
もし成功したら、**ウェブインターフェースにアクセス**して、そこから探索してみてください。

これは、gcloudツールを使用して割り当てることができる**最高レベル**です。

## 組織ポリシー

組織ポリシーについての紹介は以下を参照してください：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAMポリシーは、役割を通じてリソースに対する主体の権限を示し、細かい権限が割り当てられます。組織ポリシーは、**どのようにサービスを使用できるか、またはどの機能が無効化されるかを制限**します。これにより、GCP環境の各リソースの最小特権を向上させるのに役立ちます。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

以下のページでは、**組織ポリシーの権限を悪用して特権を昇格させる方法**を確認することができます:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>HackTricksをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を入手する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
