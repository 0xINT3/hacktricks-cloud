# GCP - IAM, Principales y Enumeración de Políticas de Organización

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cuentas de Servicio

Para una introducción sobre qué es una cuenta de servicio, consulta:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeración

Una cuenta de servicio siempre pertenece a un proyecto:
```bash
gcloud iam service-accounts list --project <project>
```
## Usuarios y Grupos

Para una introducción sobre cómo funcionan los Usuarios y Grupos en GCP, consulta:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### Enumeración

Con los permisos **`serviceusage.services.enable`** y **`serviceusage.services.use`**, es posible **habilitar servicios** en un proyecto y usarlos.

Si puedes **habilitar el servicio `admin`** y si tu usuario tiene **suficientes privilegios en Workspace,** podrías **enumerar todos los grupos y usuarios** con las siguientes líneas.\
Aunque diga **`identity groups`**, también devuelve **usuarios sin ningún grupo**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
En los ejemplos anteriores, el parámetro `--labels` es obligatorio, por lo que se utiliza un valor genérico (no es necesario si utilizas la API directamente como [**PurplePanda lo hace aquí**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py)).
{% endhint %}

Incluso con el servicio de administración habilitado, es posible que obtengas un error al enumerarlos porque tu usuario de Workspace comprometido no tiene suficientes permisos:

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Consulta [**esto para información básica sobre IAM**](../gcp-basic-information.md#iam-roles).

### Permisos Predeterminados

Según la [**documentación**](https://cloud.google.com/resource-manager/docs/default-access-control): Cuando se crea un recurso de organización, todos los usuarios de tu dominio reciben por defecto los roles de **Creador de Cuentas de Facturación** y **Creador de Proyectos**. Estos roles predeterminados permiten a tus usuarios comenzar a usar Google Cloud de inmediato, pero no están destinados para ser utilizados en la operación regular de tu recurso de organización.

Estos **roles** otorgan los **permisos**:

* `billing.accounts.create` y `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` y `resourcemanager.projects.create`

{% hint style="danger" %}
El privilegio más alto en una Organización de GCP es el rol de **Administrador de la Organización**.
{% endhint %}

### Enumeración
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### Enumeración a través de cloudasset

Existen diferentes formas de verificar todos los permisos de un usuario en diferentes recursos (como organizaciones, carpetas, proyectos...) utilizando este servicio.

* El permiso **`cloudasset.assets.searchAllIamPolicies`** puede solicitar **todas las políticas iam** dentro de un recurso.
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* El permiso **`cloudasset.assets.analyzeIamPolicy`** puede solicitar **todas las políticas de iam** de un principal dentro de un recurso.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* El permiso **`cloudasset.assets.searchAllResources`** permite listar todos los recursos de una organización, carpeta o proyecto. Incluye recursos relacionados con IAM (como roles).
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* El permiso **`cloudasset.assets.analyzeMove`** puede ser útil también para recuperar políticas que afectan a un recurso como un proyecto
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Supongo que el permiso **`cloudasset.assets.queryIamPolicy`** también podría dar acceso para encontrar los permisos de los principales.
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
Si **no puedes acceder a la información de IAM** utilizando los métodos anteriores y estás en un Red Team, podrías **usar la herramienta** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **para forzar bruscamente tus permisos actuales.**
{% endhint %}

### Privesc

En la siguiente página puedes verificar cómo **abusar de los permisos de IAM para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Suplantación de cuenta de servicio <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Suplantar una cuenta de servicio puede ser muy útil para **obtener nuevos y mejores privilegios**.

Hay tres maneras en las que puedes [suplantar otra cuenta de servicio](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account):

* Autenticación **usando claves privadas RSA** (cubierto anteriormente)
* Autorización **usando políticas de Cloud IAM** (cubierto aquí)
* **Desplegando trabajos en servicios de GCP** (más aplicable al compromiso de una cuenta de usuario)

### Otorgando acceso a la consola de gestión <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

El acceso a la [consola de gestión de GCP](https://console.cloud.google.com) se **proporciona a cuentas de usuario, no a cuentas de servicio**. Para iniciar sesión en la interfaz web, puedes **otorgar acceso a una cuenta de Google** que controles. Puede ser una cuenta genérica "**@gmail.com**", **no necesita ser miembro de la organización objetivo**.

Para **otorgar** el rol primitivo de **Owner** a una cuenta "@gmail.com" genérica, sin embargo, necesitarás **usar la consola web**. `gcloud` dará un error si intentas otorgarle un permiso por encima de Editor.

Puedes usar el siguiente comando para **otorgar a un usuario el rol primitivo de Editor** en tu proyecto existente:
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
Si tuviste éxito aquí, intenta **acceder a la interfaz web** y explorar desde allí.

Este es el **nivel más alto que puedes asignar usando la herramienta gcloud**.

## Políticas de Organización

Para una introducción sobre qué son las Políticas de Organización, consulta:

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

Las políticas de IAM indican los permisos que los principales tienen sobre los recursos a través de roles, a los cuales se les asignan permisos granulares. Las políticas de organización **restringen cómo se pueden usar esos servicios o qué características están deshabilitadas**. Esto ayuda a mejorar el principio de mínimo privilegio de cada recurso en el entorno de GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### Privesc

En la siguiente página puedes verificar cómo **abusar de los permisos de políticas de organización para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
