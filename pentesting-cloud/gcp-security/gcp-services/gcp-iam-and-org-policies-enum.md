# GCP - IAM, Principals & Org Policies Enum

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Comptes de Service

Pour une introduction sur ce qu'est un compte de service, consultez :

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### √ânum√©ration

Un compte de service appartient toujours √† un projet :

```bash
gcloud iam service-accounts list --project <project>
```

## Utilisateurs & Groupes

Pour une introduction sur le fonctionnement des Utilisateurs & Groupes dans GCP, consultez :

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

### √ânum√©ration

Avec les autorisations **`serviceusage.services.enable`** et **`serviceusage.services.use`**, il est possible de **activer des services** dans un projet et de les utiliser.

{% hint style="danger" %}
Notez qu'en g√©n√©ral, les utilisateurs de Workspace se voient accorder le r√¥le de **Cr√©ateur de projet**, leur donnant acc√®s √† la **cr√©ation de nouveaux projets**. Lorsqu'un utilisateur cr√©e un projet, il se voit attribuer le r√¥le de **`propri√©taire`**. Ainsi, il pourrait **activer ces services sur le projet pour pouvoir √©num√©rer Workspace**.

Cependant, il est √©galement n√©cessaire d'avoir **suffisamment d'autorisations dans Workspace** pour pouvoir appeler ces API.
{% endhint %}

Si vous pouvez **activer le service `admin`** et si votre utilisateur a **suffisamment de privil√®ges dans Workspace**, vous pourriez **√©num√©rer tous les groupes et utilisateurs** avec les lignes suivantes.\
M√™me si cela indique **`groupes d'identit√©`**, cela renvoie √©galement **des utilisateurs sans aucun groupe**:

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user (you can list at least the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members (you can list at least the groups you belong to)
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Dans les exemples pr√©c√©dents, le param√®tre `--labels` est requis, donc une valeur g√©n√©rique est utilis√©e (il n'est pas n√©cessaire si vous utilisez l'API directement comme [**PurplePanda le fait ici**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc\_groups\_users.py).
{% endhint %}

M√™me avec le service administrateur activ√©, il est possible que vous rencontriez une erreur lors de l'√©num√©ration car votre utilisateur de l'espace de travail compromis n'a pas suffisamment de permissions :

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Consultez [**ceci pour des informations de base sur IAM**](../gcp-basic-information/#iam-roles).

### Autorisations par d√©faut

D'apr√®s les [**docs**](https://cloud.google.com/resource-manager/docs/default-access-control) : Lorsqu'une ressource d'organisation est cr√©√©e, tous les utilisateurs de votre domaine se voient accorder les r√¥les de **Cr√©ateur de compte de facturation** et de **Cr√©ateur de projet** par d√©faut. Ces r√¥les par d√©faut permettent √† vos utilisateurs de commencer √† utiliser Google Cloud imm√©diatement, mais ne sont pas destin√©s √† √™tre utilis√©s dans le fonctionnement r√©gulier de votre ressource d'organisation.

Ces **r√¥les** accordent les **autorisations** :

* `billing.accounts.create` et `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` et `resourcemanager.projects.create`

De plus, lorsqu'un utilisateur cr√©e un projet, il se voit **automatiquement attribuer le r√¥le de propri√©taire de ce projet** selon les [docs](https://cloud.google.com/resource-manager/docs/access-control-proj). Par cons√©quent, par d√©faut, un utilisateur pourra cr√©er un projet et ex√©cuter n'importe quel service dessus (miners ? √ânum√©ration de l'espace de travail ? ...)

{% hint style="danger" %}
Le plus haut privil√®ge dans une Organisation GCP est le r√¥le d'**Administrateur de l'organisation**.
{% endhint %}

### set-iam-policy vs add-iam-policy-binding

Dans la plupart des services, vous pourrez modifier les autorisations sur une ressource en utilisant la m√©thode **`add-iam-policy-binding`** ou **`set-iam-policy`**. La principale diff√©rence est que **`add-iam-policy-binding` ajoute un nouveau lien de r√¥le** √† la strat√©gie IAM existante tandis que **`set-iam-policy`** va **supprimer les autorisations pr√©c√©demment** accord√©es et **d√©finir uniquement celles** indiqu√©es dans la commande.

### √ânum√©ration

```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get perms and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```

### Enum√©ration IAM cloudasset

Il existe diff√©rentes fa√ßons de v√©rifier toutes les autorisations d'un utilisateur dans diff√©rentes ressources (telles que les organisations, les dossiers, les projets...) en utilisant ce service.

* La permission **`cloudasset.assets.searchAllIamPolicies`** peut demander **toutes les politiques IAM** √† l'int√©rieur d'une ressource.

```bash
gcloud asset search-all-iam-policies #By default uses current configured project
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
gcloud asset search-all-iam-policies --scope projects/project-id-123123
```

* La permission **`cloudasset.assets.analyzeIamPolicy`** peut demander **toutes les politiques IAM** d'un principal √† l'int√©rieur d'une ressource.

```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:email@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:email@hacktricks.xyz'
```

* La permission **`cloudasset.assets.searchAllResources`** permet de r√©pertorier tous les ressources d'une organisation, d'un dossier ou d'un projet. Les ressources li√©es √† l'IAM (comme les r√¥les) sont incluses.

```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```

* La permission **`cloudasset.assets.analyzeMove`** peut √©galement √™tre utile pour r√©cup√©rer les politiques affectant une ressource comme un projet

```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```

* Je suppose que l'autorisation **`cloudasset.assets.queryIamPolicy`** pourrait √©galement donner acc√®s √† la recherche des autorisations des principaux

```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```

### √ânum√©ration des autorisations testIamPermissions

{% hint style="danger" %}
Si vous **ne pouvez pas acc√©der aux informations IAM** en utilisant les m√©thodes pr√©c√©dentes et que vous √™tes dans une √©quipe Red, vous pourriez **utiliser l'outil** [**https://github.com/carlospolop/bf\_my\_gcp\_perms**](https://github.com/carlospolop/bf\_my\_gcp\_perms) **pour forcer vos autorisations actuelles.**

Cependant, notez que le service **`cloudresourcemanager.googleapis.com`** doit √™tre activ√©.
{% endhint %}

### √âl√©vation de privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations IAM pour escalader les privil√®ges** :

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### √ânum√©ration non authentifi√©e <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md" %}
[gcp-iam-principals-and-org-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-iam-principals-and-org-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-exploitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

{% content-ref url="../gcp-post-exploitation/gcp-iam-post-exploitation.md" %}
[gcp-iam-post-exploitation.md](../gcp-post-exploitation/gcp-iam-post-exploitation.md)
{% endcontent-ref %}

### Persistance

Si vous avez des privil√®ges √©lev√©s, vous pourriez :

* Cr√©er de nouveaux SA (ou utilisateurs si dans Workspace)
* Donner plus de permissions aux principaux contr√¥l√©s par vous-m√™me
* Accorder plus de privil√®ges aux SA vuln√©rables (SSRF dans vm, vuln Cloud Function‚Ä¶)
* ...

## Politiques d'organisation

Pour une introduction sur ce que sont les politiques d'organisation, consultez :

{% content-ref url="../gcp-basic-information/" %}
[gcp-basic-information](../gcp-basic-information/)
{% endcontent-ref %}

Les politiques IAM indiquent les autorisations que les principaux ont sur les ressources via des r√¥les, qui sont des autorisations granulaires attribu√©es. Les politiques d'organisation **restreignent la mani√®re dont ces services peuvent √™tre utilis√©s ou quelles fonctionnalit√©s sont d√©sactiv√©es**. Cela aide √† am√©liorer le principe du moindre privil√®ge de chaque ressource dans l'environnement GCP.

```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```

### √âl√©vation de privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations des politiques d'organisation pour escalader les privil√®ges**:

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}
