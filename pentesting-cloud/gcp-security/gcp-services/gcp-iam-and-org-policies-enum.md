# GCP - IAM, Principaux & √ânum√©ration des Politiques d'Organisation

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Comptes de Service

Pour une introduction √† ce qu'est un compte de service, consultez :

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### √ânum√©ration

Un compte de service appartient toujours √† un projet :
```bash
gcloud iam service-accounts list --project <project>
```
## Utilisateurs & Groupes

Pour une introduction sur le fonctionnement des Utilisateurs & Groupes dans GCP, consultez :

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### √ânum√©ration

Avec les permissions **`serviceusage.services.enable`** et **`serviceusage.services.use`**, il est possible **d'activer des services** dans un projet et de les utiliser.

Si vous pouvez **activer le service `admin`** et si votre utilisateur dispose de **privil√®ges suffisants dans Workspace**, vous pourriez **√©num√©rer tous les groupes & utilisateurs** avec les lignes suivantes.\
M√™me si cela indique **`identity groups`**, cela retourne aussi les **utilisateurs sans aucun groupe** :

{% code overflow="wrap" %}
```bash
# Enable admin
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com

# Using admin.googleapis.com
## List all users
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>

# Using cloudidentity.googleapis.com
## List groups of a user
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

## List Group Members
gcloud identity groups memberships list --group-email=<email>
### Make it transitive
gcloud identity groups memberships search-transitive-memberships --group-email=<email>

## Get a graph (if you have enough permissions)
gcloud identity groups memberships get-membership-graph --member-email=<email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
```
{% endcode %}

{% hint style="success" %}
Dans les exemples pr√©c√©dents, le param√®tre `--labels` est requis, donc une valeur g√©n√©rique est utilis√©e (ce n'est pas n√©cessaire si vous utilisez l'API directement comme [**PurplePanda le fait ici**](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py).
{% endhint %}

M√™me avec le service admin activ√©, il est possible que vous obteniez une erreur lors de l'√©num√©ration car votre utilisateur Workspace compromis n'a pas suffisamment de permissions :

<figure><img src="../../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

## IAM

Consultez [**ceci pour des informations de base sur IAM**](../gcp-basic-information.md#iam-roles).

### Permissions par D√©faut

D'apr√®s la [**documentation**](https://cloud.google.com/resource-manager/docs/default-access-control) : Lorsqu'une ressource d'organisation est cr√©√©e, tous les utilisateurs de votre domaine se voient attribuer par d√©faut les r√¥les de **Cr√©ateur de Compte de Facturation** et de **Cr√©ateur de Projet**. Ces r√¥les par d√©faut permettent √† vos utilisateurs de commencer √† utiliser Google Cloud imm√©diatement, mais ne sont pas destin√©s √† √™tre utilis√©s dans l'exploitation r√©guli√®re de votre ressource d'organisation.

Ces **r√¥les** accordent les **permissions** :

* `billing.accounts.create` et `resourcemanager.organizations.get`
* `resourcemanager.organizations.get` et `resourcemanager.projects.create`

{% hint style="danger" %}
Le privil√®ge le plus √©lev√© dans une Organisation GCP est le r√¥le d'**Administrateur de l'Organisation**.
{% endhint %}

### √ânum√©ration
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### √ânum√©ration via cloudasset

Il existe diff√©rentes mani√®res de v√©rifier toutes les permissions d'un utilisateur dans diff√©rentes ressources (telles que les organisations, dossiers, projets...) en utilisant ce service.

* La permission **`cloudasset.assets.searchAllIamPolicies`** peut demander **toutes les politiques iam** √† l'int√©rieur d'une ressource.
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* La permission **`cloudasset.assets.analyzeIamPolicy`** peut demander **toutes les politiques IAM** d'un principal √† l'int√©rieur d'une ressource.
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* La permission **`cloudasset.assets.searchAllResources`** permet de lister toutes les ressources d'une organisation, d'un dossier ou d'un projet. Les ressources li√©es √† IAM (comme les r√¥les) sont incluses.
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* La permission **`cloudasset.assets.analyzeMove`** peut √™tre utile pour r√©cup√©rer √©galement les politiques affectant une ressource comme un projet
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* Je suppose que la permission **`cloudasset.assets.queryIamPolicy`** pourrait √©galement donner acc√®s pour trouver les permissions des principaux
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
Si vous **ne pouvez pas acc√©der aux informations IAM** en utilisant les m√©thodes pr√©c√©dentes et que vous √™tes dans une √©quipe Red Team, vous pourriez **utiliser l'outil** [**https://github.com/carlospolop/my\_gcp\_perms**](https://github.com/carlospolop/my\_gcp\_perms) **pour forcer brutalement vos permissions actuelles.**
{% endhint %}

### Privesc

Dans la page suivante, vous pouvez v√©rifier comment **abuser des permissions IAM pour escalader les privil√®ges** :

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### Impersonation de compte de service <a href="#service-account-impersonation" id="service-account-impersonation"></a>

L'impersonation d'un compte de service peut √™tre tr√®s utile pour **obtenir de nouveaux et meilleurs privil√®ges**.

Il existe trois mani√®res d'[impersoner un autre compte de service](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account) :

* Authentification **en utilisant des cl√©s priv√©es RSA** (couvert ci-dessus)
* Autorisation **en utilisant des politiques Cloud IAM** (couvert ici)
* **D√©ploiement de jobs sur les services GCP** (plus applicable √† la compromission d'un compte utilisateur)

### Octroi d'acc√®s √† la console de gestion <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

L'acc√®s √† la [console de gestion GCP](https://console.cloud.google.com) est **fourni aux comptes utilisateurs, pas aux comptes de service**. Pour vous connecter √† l'interface web, vous pouvez **octroyer l'acc√®s √† un compte Google** que vous contr√¥lez. Cela peut √™tre un compte g√©n√©rique "**@gmail.com**", il **n'a pas besoin d'√™tre membre de l'organisation cible**.

Pour **octroyer** le r√¥le primitif de **Propri√©taire** √† un compte "@gmail.com" g√©n√©rique, cependant, vous devrez **utiliser la console web**. `gcloud` renverra une erreur si vous essayez de lui octroyer une permission sup√©rieure √† √âditeur.

Vous pouvez utiliser la commande suivante pour **octroyer √† un utilisateur le r√¥le primitif d'√âditeur** sur votre projet existant :
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
Si vous avez r√©ussi ici, essayez **d'acc√©der √† l'interface web** et explorez √† partir de l√†.

C'est le **niveau le plus √©lev√© que vous pouvez attribuer en utilisant l'outil gcloud**.

## Politiques d'organisation

Pour une introduction sur ce que sont les politiques d'organisation, consultez :

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

Les politiques IAM indiquent les permissions que les principaux ont sur les ressources via des r√¥les, auxquels sont attribu√©es des permissions granulaires. Les politiques d'organisation **restreignent la mani√®re dont ces services peuvent √™tre utilis√©s ou quelles fonctionnalit√©s sont d√©sactiv√©es**. Cela aide √† am√©liorer le principe du moindre privil√®ge pour chaque ressource dans l'environnement GCP.
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### √âl√©vation de privil√®ges

Dans la page suivante, vous pouvez v√©rifier comment **abuser des permissions des politiques d'organisation pour escalader les privil√®ges** :

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
