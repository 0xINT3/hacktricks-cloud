# GCP - IAM, Ppals & Org Policies Enum

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 服务账号

关于什么是服务账号的介绍，请参考：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 枚举

服务账号始终属于一个项目：
```bash
gcloud iam service-accounts list --project <project>
```
## 用户和组

有关GCP中用户和组如何工作的介绍，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

### 枚举

使用权限 **`serviceusage.services.enable`** 和 **`serviceusage.services.use`**，可以在项目中**启用服务**并使用它们。

如果您可以**启用`admin`服务**并且您的用户在工作区中具有**足够的权限**，您可以使用以下命令**枚举所有组和用户**。\
即使它说是**`identity groups`**，它也会返回**没有任何组的用户**：
```bash
# Enable admin
gcloud services enable admin.googleapis.com
# List all users & groups
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud beta identity groups preview --customer <workspace-id>
## Group Members
gcloud identity groups memberships search-transitive-memberships --group-email=email@group.com
```
即使启用了管理员服务，由于您受损的工作区用户权限不足，可能会在枚举时遇到错误：

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

如果可以启用被禁用的服务 **`cloudidentity.googleapli.com`**，您可以使用它来**枚举组**（就像在[PurplePanda](https://github.com/carlospolop/PurplePanda/blob/master/intel/google/discovery/disc_groups_users.py)中所做的那样）：
```
gcloud services enable cloudidentity.googleapis.com
```
## IAM

查看[**这里的IAM基本信息**](../gcp-basic-information.md#iam-roles)。

### 默认权限

根据[**文档**](https://cloud.google.com/resource-manager/docs/default-access-control)：当创建组织资源时，默认情况下，您的域中的所有用户都被授予**Billing Account Creator**和**Project Creator**角色。这些默认角色允许您的用户立即开始使用Google Cloud，但不适用于组织资源的常规操作。

这些**角色**授予以下**权限**：

* `billing.accounts.create`和`resourcemanager.organizations.get`
* `resourcemanager.organizations.get`和`resourcemanager.projects.create`

{% hint style="danger" %}
GCP组织中的最高权限是**组织管理员**角色。
{% endhint %}

### 枚举
```bash
# Roles
## List roles
gcloud iam roles list --project $PROJECT_ID # List only custom roles
gcloud iam roles list --filter='etag:AA=='

## Get permis and description of role
gcloud iam roles describe roles/container.admin
gcloud iam roles describe --project <proj-name> <role-name>

# Policies
gcloud organizations get-iam-policy <org_id>
gcloud resource-manager folders get-iam-policy <folder-id>
gcloud projects get-iam-policy <project-id>

# MISC
## Testable permissions in resource
gcloud iam list-testable-permissions --filter "NOT apiDisabled: true" <resource>
## Grantable roles to a resource
gcloud iam list-grantable-roles <project URL>
```
#### 通过cloudasset进行枚举

有多种方法可以使用此服务检查用户在不同资源（如组织、文件夹、项目等）中的所有权限。

* 权限**`cloudasset.assets.searchAllIamPolicies`**可以请求在资源内部的**所有iam策略**。
```bash
gcloud asset search-all-iam-policies #By default uses current configured folder
gcloud asset search-all-iam-policies --scope folders/1234567
gcloud asset search-all-iam-policies --scope organizations/123456
```
* 权限 **`cloudasset.assets.analyzeIamPolicy`** 可以请求资源内特定主体的**所有 IAM 策略**。
```bash
# Needs perm "cloudasset.assets.analyzeIamPolicy" over the asset
gcloud asset analyze-iam-policy --organization=<org-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --folder=<folder-id> \
--identity='user:carlos.polop@hacktricks.xyz'
gcloud asset analyze-iam-policy --project=<project-name> \
--identity='user:carlos.polop@hacktricks.xyz'
```
* 权限 **`cloudasset.assets.searchAllResources`** 允许列出组织、文件夹或项目的所有资源，包括与IAM相关的资源（如角色）。
```bash
gcloud asset search-all-resources --scope projects/<proj-name>
gcloud asset search-all-resources --scope folders/1234567
gcloud asset search-all-resources --scope organizations/123456
```
* 权限 **`cloudasset.assets.analyzeMove`** 可用于检索影响项目等资源的策略。
```bash
gcloud asset analyze-move --project=<proj-name> \
--destination-organization=609216679593
```
* 我认为权限 **`cloudasset.assets.queryIamPolicy`** 也可以让用户查找主体的权限
```bash
# But, when running something like this
gcloud asset query --project=<proj> --statement='SELECT * FROM compute_googleapis_com_Instance'
# I get the error
ERROR: (gcloud.asset.query) UNAUTHENTICATED: QueryAssets API is only supported for SCC premium customers. See https://cloud.google.com/security-command-center/pricing
```
{% hint style="danger" %}
如果您无法使用先前的方法访问IAM信息，并且您是红队成员。您可以使用工具[https://github.com/carlospolop/my\_gcp\_perms](https://github.com/carlospolop/my\_gcp\_perms)来暴力破解您当前的权限。
{% endhint %}

### 提权

您可以在以下页面中查看如何滥用IAM权限以提升特权：

{% content-ref url="../gcp-privilege-escalation/gcp-iam-privesc.md" %}
[gcp-iam-privesc.md](../gcp-privilege-escalation/gcp-iam-privesc.md)
{% endcontent-ref %}

### 服务账号冒充 <a href="#service-account-impersonation" id="service-account-impersonation"></a>

冒充服务账号可以非常有用，以获得新的和更好的特权。

有三种方式可以[冒充另一个服务账号](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account)：

* 使用RSA私钥进行身份验证（上面已涵盖）
* 使用Cloud IAM策略进行授权（在此处涵盖）
* 在GCP服务上部署作业（更适用于用户账号的妥协）

### 授予对管理控制台的访问权限 <a href="#granting-access-to-management-console" id="granting-access-to-management-console"></a>

对于GCP管理控制台的访问权限是提供给用户账号而不是服务账号的。要登录到Web界面，您可以授予您控制的Google账号访问权限。这可以是一个通用的“@gmail.com”账号，它不必是目标组织的成员。

要将通用的“@gmail.com”账号授予原始角色“Owner”，您需要使用Web控制台。如果您尝试授予它高于Editor的权限，`gcloud`将报错。

您可以使用以下命令将用户授予现有项目的原始角色“Editor”：
```bash
gcloud projects add-iam-policy-binding [PROJECT] --member user:[EMAIL] --role roles/editor
```
如果你在这里成功了，尝试**访问Web界面**并从那里进行探索。

这是使用gcloud工具可以分配的**最高级别**。

## 组织策略

关于组织策略的介绍，请查看：

{% content-ref url="../gcp-basic-information.md" %}
[gcp-basic-information.md](../gcp-basic-information.md)
{% endcontent-ref %}

IAM策略指示了主体对资源拥有的权限，通过角色分配了细粒度的权限。组织策略**限制了这些服务的使用方式或禁用了哪些功能**。这有助于提高GCP环境中每个资源的最小特权。
```bash
gcloud resource-manager org-policies list --organization=ORGANIZATION_ID
gcloud resource-manager org-policies list --folder=FOLDER_ID
gcloud resource-manager org-policies list --project=PROJECT_ID
```
### 提权

在下面的页面中，您可以查看如何**滥用组织策略权限以提升特权**：

{% content-ref url="../gcp-privilege-escalation/gcp-orgpolicy-privesc.md" %}
[gcp-orgpolicy-privesc.md](../gcp-privilege-escalation/gcp-orgpolicy-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS 的最新版本或下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
