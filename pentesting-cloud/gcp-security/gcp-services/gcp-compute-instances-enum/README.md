# GCP - Compute Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## GCP VPC 및 네트워킹

이 작업 방식에 대해 알아보세요:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### 열거

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum)에서 열린 방화벽 규칙을 가진 컴퓨팅 인스턴스를 쉽게 찾을 수 있습니다.

## 컴퓨팅 인스턴스

이것은 **GCP 내에서 가상 머신을 실행하는 방법**입니다. 자세한 정보는 다음 페이지를 확인하세요:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### 열거
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
자세한 내용은 다음 페이지에서 **SSH** 또는 인스턴스의 **메타데이터 수정**을 통해 **권한 상승**을 어떻게 할 수 있는지 확인할 수 있습니다:

{% content-ref url="../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](../../../gcp-security/gcp-privilege-escalation/gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

### 권한 상승

다음 페이지에서 **컴퓨트 권한을 남용하여 권한을 상승**하는 방법을 확인할 수 있습니다:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### 인증되지 않은 열거

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### 후반 공격

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### 지속성

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## 시리얼 콘솔 로그

Compute Engine 시리얼 콘솔 로그는 가상 머신 인스턴스의 부팅 및 운영 체제 로그를 **보고 진단**할 수 있는 기능입니다.

시리얼 콘솔 로그는 인스턴스의 부팅 프로세스를 **저수준으로 보여줍니다**. 이는 부팅 문제의 디버깅, 잘못된 구성 또는 소프트웨어 오류의 식별, 또는 네트워크 연결 문제의 문제 해결에 유용할 수 있습니다.

이 로그는 일반적으로 저수준 사용자가 볼 수 없는 시스템 로그에서 **민감한 정보를 노출**할 수 있지만, 적절한 IAM 권한을 가지고 있다면 이를 읽을 수 있을 수도 있습니다.

다음 [gcloud 명령](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output)을 사용하여 시리얼 포트 로그를 조회할 수 있습니다 (`compute.instances.getSerialPortOutput` 권한이 필요합니다):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## OS 구성 관리자

OS 구성 관리 서비스를 사용하여 VM 인스턴스(VM)에 일관된 구성(원하는 상태 및 소프트웨어)를 배포, 조회 및 유지할 수 있습니다. Compute Engine에서는 VM에서 일관된 소프트웨어 구성을 유지하기 위해 [게스트 정책](https://cloud.google.com/compute/docs/os-config-management#guest-policy)을 사용해야 합니다.

OS 구성 관리 기능을 사용하면 설치해야 할 소프트웨어 패키지, 활성화해야 할 서비스, VM에 있어야 할 파일 또는 구성을 지정하는 구성 정책을 정의할 수 있습니다. VM의 소프트웨어 구성을 선언적으로 관리할 수 있으므로 구성 관리 프로세스를 자동화하고 확장하기 쉽습니다.

또한 IAM 권한을 통해 인스턴스에 로그인할 수 있으므로 **권한 상승 및 피벗에 매우 유용**합니다.

{% hint style="warning" %}
전체 프로젝트 또는 인스턴스에서 **os-config를 활성화**하려면 원하는 수준에서 **메타데이터** 키 **`enable-oslogin`**을 **`true`**로 설정하기만 하면 됩니다.\
또한, 2fa를 활성화하려면 메타데이터 **`enable-oslogin-2fa`**를 **`true`**로 설정할 수 있습니다.

인스턴스를 생성할 때 활성화하면 메타데이터 키가 자동으로 설정됩니다.
{% endhint %}

**OS-config에서의 2fa에 대해 더 알아보면**, **사용자인 경우에만 적용**되며, 컴퓨트 SA와 같은 SA인 경우 추가로 아무것도 필요하지 않습니다.

### 열거
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## 이미지

### 사용자 정의 이미지

**사용자 정의 컴퓨팅 이미지에는 민감한 세부 정보**나 다른 취약한 구성이 포함될 수 있습니다. 

이미지를 생성할 때는 **Google 관리 키**(기본값), **KMS에서 가져온 키**, 또는 클라이언트가 제공한 **원시 키** 중에서 **3 종류의 암호화**를 선택할 수 있습니다.

#### 열거

다음 명령을 사용하여 프로젝트에서 표준이 아닌 이미지 목록을 조회할 수 있습니다:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

그런 다음 [**가상 디스크**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export)를 여러 형식으로 **내보낼 수** 있습니다. 다음 명령은 `test-image` 이미지를 qcow2 형식으로 내보내어 파일을 다운로드하고 추가 조사를 위해 로컬에서 VM을 빌드할 수 있도록 합니다:
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### 권한 상승

Compute Instances 권한 상승 섹션을 확인하세요.

### 사용자 정의 인스턴스 템플릿

[**인스턴스 템플릿**](https://cloud.google.com/compute/docs/instance-templates/)은 일관된 구성을 배포하는 데 도움이 되는 **인스턴스 속성을 정의**합니다. 이들은 실행 중인 인스턴스의 사용자 정의 메타데이터와 동일한 유형의 민감한 데이터를 포함할 수 있습니다. 다음 명령을 사용하여 조사할 수 있습니다:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
이미지를 사용하는 새로운 디스크를 알아내는 것은 흥미로울 수 있지만, 이러한 템플릿에는 일반적으로 민감한 정보가 포함되어 있지 않습니다.

## 스냅샷

**스냅샷은 디스크의 백업**입니다. 디스크를 복제하는 것과는 다른 기능입니다.\
**스냅샷**은 **디스크와 동일한 암호화를 사용**합니다.

### 열거
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### 권한 상승

Compute Instances 권한 상승 섹션을 확인하세요.

## 참고 자료

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹을 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기교를 공유하세요.

</details>
