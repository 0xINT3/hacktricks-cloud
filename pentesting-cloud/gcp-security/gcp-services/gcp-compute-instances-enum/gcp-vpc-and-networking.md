# GCP - VPC & ネットワーキング

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **Discordグループ**に **参加**💬(https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
- **HackTricks**（https://github.com/carlospolop/hacktricks）と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する。

</details>

## **GCP Compute Networkingの要点**

**VPC** には **Firewall** ルールが含まれ、VPCへの着信トラフィックを許可します。VPCには **サブネットワーク** も含まれ、**仮想マシン** が **接続** されます。\
AWSと比較すると、**Firewall** は **AWSのセキュリティグループとNACL** に **最も近い**ものですが、この場合、これらは **VPC** に **定義** されており、各インスタンスにはありません。

## **GCPのVPC、サブネットワーク、およびファイアウォール**

Compute Instances は **VPC** に接続された **サブネットワーク** であり、これらは **VPCs**（[Virtual Private Clouds](https://cloud.google.com/vpc/docs/vpc)）の一部です。GCPにはセキュリティグループはなく、[**VPCファイアウォール**](https://cloud.google.com/vpc/docs/firewalls) があり、これらはこのネットワークレベルで定義されますが、各VMインスタンスに適用されます。

### サブネットワーク

1つの **VPC** には **複数のサブネットワーク** を持つことができます。各 **サブネットワークは1つのリージョン**にあります。

### ファイアウォール

デフォルトでは、すべてのネットワークには2つの[**暗黙のファイアウォールルール**](https://cloud.google.com/vpc/docs/firewalls#default\_firewall\_rules)があります: **アウトバウンドを許可** および **インバウンドを拒否**。

GCPプロジェクトが作成されると、**`default`** という名前のVPCが作成され、次のファイアウォールルールが適用されます:

- **default-allow-internal:** `default` ネットワーク上の他のインスタンスからのすべてのトラフィックを許可
- **default-allow-ssh:** どこからでも22番ポートを許可
- **default-allow-rdp:** どこからでも3389番ポートを許可
- **default-allow-icmp:** どこからでもpingを許可

{% hint style="warning" %}
**ファイアウォールルール**は **内部IPアドレス**に対して **より許可的** になる傾向があることがわかります。デフォルトのVPCでは、Compute Instances 間のすべてのトラフィックが許可されます。
{% endhint %}

デフォルトのVPCまたは新しいVPCに対して **追加のファイアウォールルール** を作成できます。[**ファイアウォールルール**](https://cloud.google.com/vpc/docs/firewalls)は、以下の **方法**でインスタンスに適用できます:

- [**ネットワークタグ**](https://cloud.google.com/vpc/docs/add-remove-network-tags)
- [**サービスアカウント**](https://cloud.google.com/vpc/docs/firewalls#serviceaccounts)
- **VPC内のすべてのインスタンス**

残念ながら、インターネット上のオープンポートを持つすべてのCompute Instancesを一括で出力するための簡単な `gcloud` コマンドはありません。ファイアウォールルール、ネットワークタグ、サービスアカウント、およびインスタンスの間の関連付けを行う必要があります。

このプロセスは、[このPythonスクリプト](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_firewall\_enum)を使用して自動化され、以下をエクスポートします:

- インスタンス、パブリックIP、許可されたTCP、許可されたUDPを示すCSVファイル
- インターネットからのすべてのインスタンスに対して許可されたポートに対するnmapスキャン（0.0.0.0/0）
- インターネットからのすべてのTCPポートを許可するインスタンスのすべてのTCP範囲を対象とするmasscan

### 階層型ファイアウォールポリシー <a href="#hierarchical-firewall-policies" id="hierarchical-firewall-policies"></a>

_階層型ファイアウォールポリシー_ を使用すると、組織全体で一貫したファイアウォールポリシーを作成および **強制** できます。これらのポリシーを組織全体または個々の **フォルダ** に割り当てることができます。これらのポリシーには、接続を明示的に拒否または許可するルールが含まれます。

ファイアウォールポリシーは別々のステップとして作成および適用できます。[**リソース階層**](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)の **組織またはフォルダノード**でファイアウォールポリシーを作成および適用できます。ファイアウォールポリシールールは、接続をブロック、接続を許可、またはVPCネットワークで定義されたVPCファイアウォールルールにファイアウォールルール評価を **遅延** することができます。

デフォルトでは、階層型ファイアウォールポリシールールは、ポリシーが関連付けられている組織またはフォルダの下のすべてのプロジェクトのすべてのVMに適用されます。ただし、[ターゲットネットワークまたはターゲットサービスアカウント](https://cloud.google.com/vpc/docs/firewall-policies#targets)を指定することで、特定のVMにルールを適用できます。

ここで [**階層型ファイアウォールポリシーを作成**](https://cloud.google.com/vpc/docs/using-firewall-policies#gcloud) する方法を読むことができます。

### ファイアウォールルールの評価

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. 組織: 組織に割り当てられたファイアウォールポリシー
2. フォルダ: フォルダに割り当てられたファイアウォールポリシー
3. VPC: VPCに割り当てられたファイアウォールルール
4. グローバル: VPCに割り当てられた別のタイプのファイアウォールルール
5. リージョナル: VMのNICとVMのリージョンに関連付けられたVPCネットワークのファイアウォールルール

## VPCネットワークピアリング

2つのVirtual Private Cloud（VPC）ネットワークを接続し、**各ネットワークのリソースが互いに通信**できるようにします。\
ピアリングされたVPCネットワークは、同じプロジェクト内、同じ組織の異なるプロジェクト内、または **異なる組織の異なるプロジェクト内** に配置できます。

必要な権限は次のとおりです:

- `compute.networks.addPeering`
- `compute.networks.updatePeering`
- `compute.networks.removePeering`
- `compute.networks.listPeeringRoutes`

[**詳細はドキュメントを参照**](https://cloud.google.com/vpc/docs/vpc-peering).

## 参考文献

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation](https://cloud.google.com/vpc/docs/firewall-policies-overview#rule-evaluation)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **Discordグループ**に **参加**💬(https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
- **HackTricks**（https://github.com/carlospolop/hacktricks）と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する。

</details>
