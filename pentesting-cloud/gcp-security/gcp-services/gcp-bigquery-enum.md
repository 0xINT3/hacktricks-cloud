# GCP - Bigquery Enum

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* &#x20;github repos.

</details>

## Basiese Inligting

Google Cloud BigQuery word beskryf as 'n **volledig-bestuurde, serverlose ondernemingsdatawarehouse**, wat vermo√´ns bied vir **analise oor petabytes** van data, en sodoende groot-skaalse datasets doeltreffend hanteer. As 'n Platform as a Service (PaaS) bied dit gebruikers infrastruktuur en gereedskap om datahantering te fasiliteer sonder die noodsaak vir handmatige toesig.

### Versleuteling

Standaard word 'n **deur Google bestuurde versleutelingssleutel** gebruik, alhoewel dit moontlik is om 'n **Klant-bestuurde versleutelingssleutel (CMEK)** te konfigureer. Dit is moontlik om die versleutelingssleutel per dataset en per tabel binne 'n dataset aan te dui.

### Verval

Dit is moontlik om 'n **vervaltyd in die dataset** aan te dui, sodat enige nuwe tabel wat in hierdie dataset geskep word, die gespesifiseerde aantal dae na skepping **outomaties uitgevee** sal word.

### Eksterne Bronne

Bigquery is diep ge√Øntegreer met ander Google-diens. Dit is moontlik om data te laai vanuit emmers, pub/sub, Google Drive, RDS-databasisse...

### Dataset ACL's

Wanneer 'n dataset geskep word, word **ACL's geheg** om toegang daartoe te gee. Standaard word **Eienaar-privileges** gegee aan die **gebruiker wat die dataset geskep het**, en dan **Eienaar** aan die groep **projectOwners** (Eienaars van die projek), **Skrywer** aan die groep **projectWriters**, en **Leser** aan die groep **projectReaders**:
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### Tabelry Rye Beheer Toegang

Dit is moontlik om **die rye wat 'n hoofpersoon toegang tot 'n tabel het te beheer** met behulp van rytoegangsbeleide. Hierdie beleide word binne die tabel gedefinieer deur gebruik te maak van [**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create\_row\_access\_policy\_statement).\
Die toegangsbeleid definieer 'n filter en **slegs die rye wat ooreenstem met daardie filter** sal toeganklik wees vir die aangeduide hoofpersone.
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### Kolom Toegangsbeheer

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Om de toegang tot gegevens op kolomniveau te beperken:

1. **Definieer een taxonomie en beleidstags**. Maak en beheer een taxonomie en beleidstags voor uw gegevens. [https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. Optioneel: Verleen de **Data Catalogus Fijnmazige Lezer rol aan √©√©n of meer principes** op √©√©n of meer van de beleidstags die u heeft gemaakt.
3. **Wijs beleidstags toe aan uw BigQuery-kolommen**. Gebruik in BigQuery schema-annotaties om een beleidstag toe te wijzen aan elke kolom waar u de toegang wilt beperken.
4. **Handhaaf toegangsbeheer op de taxonomie**. Het handhaven van toegangsbeheer zorgt ervoor dat de toegangsbeperkingen die zijn gedefinieerd voor alle beleidstags in de taxonomie worden toegepast.
5. **Beheer toegang tot de beleidstags**. Gebruik [Identity and Access Management](https://cloud.google.com/iam) (IAM) beleidsregels om de toegang tot elke beleidstag te beperken. Het beleid is van kracht voor elke kolom die toebehoort aan de beleidstag.

Wanneer een gebruiker probeert toegang te krijgen tot kolomgegevens tijdens een query, controleert BigQuery **de beleidstag van de kolom en het beleid om te zien of de gebruiker gemachtigd is om toegang te krijgen tot de gegevens**.

{% hint style="success" %}
Als samenvatting, om de toegang tot bepaalde kolommen voor bepaalde gebruikers te beperken, kunt u **een tag toevoegen aan de kolom in het schema en de toegang van de gebruikers beperken** tot de tag door toegangsbeheer af te dwingen op de taxonomie van de tag.
{% endhint %}

Om toegangsbeheer op de taxonomie af te dwingen, moet de service worden ingeschakeld:
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
Dit is moontlik om die etikette van kolomme te sien met:

{% code overflow="wrap" %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### Opname

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### BigQuery SQL-injeksie

[https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac)

### Bevoorregte Eskalasie & Post Exploitation

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### Volharding

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## Verwysings

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* &#x20;github-repos.

</details>
