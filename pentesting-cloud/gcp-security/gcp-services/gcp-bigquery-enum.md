# Απαρίθμηση Bigquery του GCP

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Ερυθρού Συνεργείου HackTricks AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης των HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στα HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* αποθετήρια github.

</details>

## Βασικές Πληροφορίες

Το Google Cloud BigQuery είναι μια **πλήρως διαχειριζόμενη, serverless αποθήκη δεδομένων επιχειρήσεων**, προσφέροντας δυνατότητες για **ανάλυση πάνω από petabytes** δεδομένων, χειριζόμενος αποτελεσματικά μεγάλους όγκους συνόλων δεδομένων. Ως Υπηρεσία ως Πλατφόρμα (PaaS), παρέχει στους χρήστες υποδομή και εργαλεία για τη διευκόλυνση της διαχείρισης δεδομένων χωρίς την ανάγκη χειροκίνητης επίβλεψης.

Υποστηρίζει το ερώτημα χρησιμοποιώντας **ANSI SQL**. Τα κύρια αντικείμενα είναι **σύνολα δεδομένων** που περιέχουν **πίνακες** που περιέχουν δεδομένα **SQL**.

### Κρυπτογράφηση

Από προεπιλογή χρησιμοποιείται ένα **κλειδί κρυπτογράφησης που διαχειρίζεται η Google**, αν και είναι δυνατό να διαμορφωθεί ένα **κλειδί κρυπτογράφησης που διαχειρίζεται ο πελάτης (CMEK)**. Είναι δυνατό να υποδείξετε το κλειδί κρυπτογράφησης ανά σύνολο δεδομένων και ανά πίνακα μέσα σε ένα σύνολο δεδομένων.

### Λήξη

Είναι δυνατό να υποδείξετε ένα **χρόνο λήξης στο σύνολο δεδομένων** έτσι ώστε οποιοδήποτε νέος πίνακας που δημιουργείται σε αυτό το σύνολο δεδομένων θα διαγραφεί **αυτόματα** τον καθορισμένο αριθμό ημερών μετά τη δημιουργία.

### Εξωτερικές Πηγές

Το Bigquery είναι βαθιά ενσωματωμένο με άλλες υπηρεσίες της Google. Είναι δυνατό να φορτώσετε δεδομένα από κάδους, pub/sub, google drive, βάσεις δεδομένων RDS...

### ACLs Συνόλου Δεδομένων

Όταν δημιουργείται ένα σύνολο δεδομένων, προσαρτώνται **ACLs** για να δοθεί πρόσβαση σε αυτό. Από προεπιλογή δίνονται δικαιώματα **Κάτοχου** στον **χρήστη που δημιούργησε** το σύνολο δεδομένων και στη συνέχεια **Κάτοχου** στην ομάδα **projectOwners** (Κάτοχοι του έργου), **Συγγραφέα** στην ομάδα **projectWriters,** και **Αναγνώστη** στην ομάδα **projectReaders**:
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### Έλεγχος Πρόσβασης στις Γραμμές του Πίνακα

Είναι δυνατόν να **ελέγχετε τις γραμμές στις οποίες ένας κύριος θα έχει πρόσβαση μέσα σε έναν πίνακα** με τις πολιτικές πρόσβασης στις γραμμές. Αυτές ορίζονται μέσα στον πίνακα χρησιμοποιώντας [**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create\_row\_access\_policy\_statement).\
Η πολιτική πρόσβασης ορίζει ένα φίλτρο και **μόνο οι γραμμές που ταιριάζουν** με αυτό το φίλτρο θα είναι **προσβάσιμες** από τους καθορισμένους κύριους.
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### Έλεγχος Πρόσβασης στις Στήλες

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Για να περιορίσετε την πρόσβαση στα δεδομένα στο επίπεδο της στήλης:

1. **Ορίστε μια ταξινομία και ετικέτες πολιτικής**. Δημιουργήστε και διαχειριστείτε μια ταξινομία και ετικέτες πολιτικής για τα δεδομένα σας. [https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. Προαιρετικά: Χορηγήστε τον ρόλο **Data Catalog Fine-Grained Reader σε έναν ή περισσότερους αρχές** σε μία ή περισσότερες από τις ετικέτες πολιτικής που δημιουργήσατε.
3. **Αντιστοιχίστε ετικέτες πολιτικής στις στήλες του BigQuery**. Στο BigQuery, χρησιμοποιήστε σχόλια σχήματος για να αντιστοιχίσετε μια ετικέτα πολιτικής σε κάθε στήλη όπου θέλετε να περιορίσετε την πρόσβαση.
4. **Επιβάλλετε τον έλεγχο πρόσβασης στην ταξινομία**. Ο επιβολή του ελέγχου πρόσβασης έχει ως αποτέλεσμα οι περιορισμοί πρόσβασης που έχουν οριστεί για όλες τις ετικέτες πολιτικής στην ταξινομία να εφαρμοστοών.
5. **Διαχειριστείτε την πρόσβαση στις ετικέτες πολιτικής**. Χρησιμοποιήστε τις [Πολιτικές Ταυτότητας και Πρόσβασης](https://cloud.google.com/iam) (IAM) για να περιορίσετε την πρόσβαση σε κάθε ετικέτα πολιτικής. Η πολιτική ισχύει για κάθε στήλη που ανήκει στην ετικέτα πολιτικής.

Όταν ένας χρήστης προσπαθεί να έχει πρόσβαση στα δεδομένα της στήλης κατά την εκτέλεση ερωτήματος, το BigQuery **ελέγχει την ετικέτα πολιτικής της στήλης και την πολιτική της για να δει εάν ο χρήστης έχει εξουσιοδοτηθεί να έχει πρόσβαση στα δεδομένα**.

{% hint style="success" %}
Ως περίληψη, για να περιορίσετε την πρόσβαση σε μερικές στήλες σε μερικούς χρήστες, μπορείτε **να προσθέσετε μια ετικέτα στη στήλη στο σχήμα και να περιορίσετε την πρόσβαση** των χρηστών στην ετικέτα επιβάλλοντας τον έλεγχο πρόσβασης στην ταξινομία της ετικέτας.
{% endhint %}

Για να επιβάλετε τον έλεγχο πρόσβασης στην ταξινομία, απαιτείται η ενεργοποίηση της υπηρεσίας:
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
Είναι δυνατόν να δείτε τις ετικέτες των στηλών με:

{% code overflow="wrap" %}
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### Απαρίθμηση

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### Ενσωμάτωση SQL στο BigQuery

[https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac)

### Ανόρθωση Προνομίων & Μετά-Εκμετάλλευση

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### Διατήρηση

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## Αναφορές

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* αποθετήρια github.

</details>
