# GCP - Uchambuzi wa Bigquery

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* repos za github.

</details>

## Taarifa Msingi

Google Cloud BigQuery ni **ghala la data la biashara lililosimamiwa kabisa, lisilo na seva**, linalotoa uwezo wa **uchambuzi wa data za petabytes**, hivyo kushughulikia seti kubwa za data kwa ufanisi. Kama Jukwaa kama Huduma (PaaS), hutoa watumiaji na miundombinu na zana za kurahisisha usimamizi wa data bila hitaji la uangalizi wa kawaida.

Inasaidia kuuliza kutumia **ANSI SQL**. Vitu kuu ni **seti za data** zinazo **meza** zinazo data za **SQL**.

### Ufichaji

Kwa chaguo-msingi **ufunguo wa kufichua uliosimamiwa na Google** hutumiwa ingawa niwezekanavyo kusanidi **ufunguo wa kufichua uliosimamiwa na Mteja (CMEK)**. Niwezekanavyo kuonyesha ufunguo wa kufichua kwa kila seti ya data na kwa kila meza ndani ya seti ya data.

### Muda wa Kufutwa

Niwezekanavyo kuonyesha **muda wa kufutwa kwenye seti ya data** ili meza mpya inayoundwa kwenye seti hii ya data itafutwa **kiotomatiki** idadi iliyowekwa ya siku baada ya kuundwa.

### Vyanzo Vya Nje

Bigquery imeunganishwa sana na huduma zingine za Google. Niwezekanavyo kupakia data kutoka kwa vikasha, pub/sub, google drive, databases za RDS...

### ACLs za Seti ya Data

Wakati seti ya data inapoundwa **ACLs zinaambatishwa** kutoa ufikiaji juu yake. Kwa chaguo-msingi, inapewa **mamlaka ya Mmiliki** kwa **mtumiaji aliyeanzisha** seti ya data na kisha **Mmiliki** kwa kikundi **projectOwners** (Wamiliki wa mradi), **Mwandishi** kwa kikundi **projectWriters,** na **Mkusanyaji** kwa kikundi **projectReaders**:
```bash
bq show --format=prettyjson <proj>:<dataset>

...
"access": [
{
"role": "WRITER",
"specialGroup": "projectWriters"
},
{
"role": "OWNER",
"specialGroup": "projectOwners"
},
{
"role": "OWNER",
"userByEmail": "gcp-admin@hacktricks.xyz"
},
{
"role": "OWNER",
"userByEmail": "support@hacktricks.xyz"
},
{
"role": "READER",
"specialGroup": "projectReaders"
}
],
...
```
### Kudhibiti Upatikanaji wa Safu za Jedwali

Inawezekana **kudhibiti safu ambazo mwakilishi ataweza kupata ndani ya jedwali** kwa kutumia sera za upatikanaji wa safu. Hizi huanzishwa ndani ya jedwali kwa kutumia [**DDL**](https://cloud.google.com/bigquery/docs/reference/standard-sql/data-definition-language#create\_row\_access\_policy\_statement).\
Sera ya upatikanaji inaainisha kichujio na **safu zinazolingana** na kichujio hicho ndizo zitakazokuwa **zinafikika** na wawakilishi waliotajwa.
```sql
# Create
CREATE ROW ACCESS POLICY apac_filter
ON project.dataset.my_table
GRANT TO ('user:abc@example.com')
FILTER USING (region = 'APAC');

# Update
CREATE OR REPLACE ROW ACCESS POLICY
CREATE ROW ACCESS POLICY sales_us_filter
ON project.dataset.my_table
GRANT TO ('user:john@example.com',
'group:sales-us@example.com',
'group:sales-managers@example.com')
FILTER USING (region = 'US');

# Check the Post Exploitation tricks to see how to call this from the cli
```

```bash
# Enumerate row policies on a table
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies
```
### Udhibiti wa Upatikanaji wa Safu za Safu

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

Ili kuzuia upatikanaji wa data kwa kiwango cha safu:

1. **Tambua taksonomia na vitambulisho vya sera**. Unda na usimamie taksonomia na vitambulisho vya sera kwa data yako. [https://console.cloud.google.com/bigquery/policy-tags](https://console.cloud.google.com/bigquery/policy-tags)
2. Hiari: Mpe jukumu la **Msomaji Mdogo wa Katalogi ya Data kwa mmoja au zaidi wa mabwana** kwenye moja au zaidi ya vitambulisho vya sera ulivyoiumba.
3. **Weka vitambulisho vya sera kwenye safu zako za BigQuery**. Katika BigQuery, tumia maandishi ya schema kuweka kila safu ya sera kwa safu ambapo unataka kuzuia upatikanaji.
4. **Tekeleza udhibiti wa upatikanaji kwenye taksonomia**. Kutekeleza udhibiti wa upatikanaji husababisha vikwazo vya upatikanaji vilivyoelezwa kwa ajili ya vitambulisho vyote vya sera katika taksonomia kutumika.
5. **Simamia upatikanaji kwenye vitambulisho vya sera**. Tumia [Utambulisho na Usimamizi wa Upatikanaji](https://cloud.google.com/iam) (IAM) sera ili kuzuia upatikanaji wa kila vitambulisho vya sera. Sera ina athari kwa kila safu inayomilikiwa na vitambulisho vya sera.

Wakati mtumiaji anajaribu kupata data ya safu wakati wa kuuliza, BigQuery **huchunguza vitambulisho vya sera vya safu na sera yake kuona ikiwa mtumiaji ana ruhusa ya kupata data**.

{% hint style="success" %}
Kama muhtasari, ili kuzuia upatikanaji wa safu fulani kwa watumiaji fulani, unaweza **kuongeza lebo kwenye safu katika schema na kuzuia upatikanaji** wa watumiaji kwa lebo kwa kutekeleza udhibiti wa upatikanaji kwenye taksonomia ya lebo.
{% endhint %}

Ili kutekeleza udhibiti wa upatikanaji kwenye taksonomia, ni muhimu kuwezesha huduma:
```bash
gcloud services enable bigquerydatapolicy.googleapis.com
```
Inawezekana kuona vitambulisho vya nguzo kwa:
```bash
bq show --schema <proj>:<dataset>.<table>

[{"name":"username","type":"STRING","mode":"NULLABLE","policyTags":{"names":["projects/.../locations/us/taxonomies/2030629149897327804/policyTags/7703453142914142277"]},"maxLength":"20"},{"name":"age","type":"INTEGER","mode":"NULLABLE"}]
```
### Uchambuzi

{% code overflow="wrap" %}
```bash
# Dataset info
bq ls # List datasets
bq ls -a # List all datasets (even hidden)
bq ls <proj>:<dataset> # List tables in a dataset
bq show --format=prettyjson <proj>:<dataset> # Get info about the dataset (like ACLs)

# Tables info
bq show --format=prettyjson <proj>:<dataset>.<table> # Get table info
bq show --schema <proj>:<dataset>.<table>  # Get schema of a table

# Get entries from the table
bq head <dataset>.<table>
bq query --nouse_legacy_sql 'SELECT * FROM `<proj>.<dataset>.<table-name>` LIMIT 1000'
bq extract <dataset>.<table> "gs://<bucket>/table*.csv" # Use the * so it can dump everything in different files

# Insert data
bq query --nouse_legacy_sql 'INSERT INTO `digital-bonfire-410512.importeddataset.tabletest` (rank, refresh_date, dma_name, dma_id, term, week, score) VALUES (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2019-10-13", 62), (22, "2023-12-28", "Baltimore MD", 512, "Ms", "2020-05-24", 67)'
bq insert dataset.table /tmp/mydata.json

# Get permissions
bq get-iam-policy <proj>:<dataset> # Get dataset IAM policy
bq show --format=prettyjson <proj>:<dataset> # Get dataset ACLs
bq get-iam-policy <proj>:<dataset>.<table> # Get table IAM policy
bq ls --row_access_policies <proj>:<dataset>.<table> # Get row policies

# Taxonomies (Get the IDs from the shemas of the tables)
gcloud data-catalog taxonomies describe <taxonomi-ID> --location=<location>
gcloud data-catalog taxonomies list --location <location> #Find more
gcloud data-catalog taxonomies get-iam-policy <taxonomi-ID> --location=<location>

# Misc
bq show --encryption_service_account # Get encryption service account
```
{% endcode %}

### Uingizaji wa SQL wa BigQuery

[https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac](https://ozguralp.medium.com/bigquery-sql-injection-cheat-sheet-65ad70e11eac)

### Kupanda Hadhi & Baada ya Kudukua

{% content-ref url="../gcp-privilege-escalation/gcp-bigquery-privesc.md" %}
[gcp-bigquery-privesc.md](../gcp-privilege-escalation/gcp-bigquery-privesc.md)
{% endcontent-ref %}

### Uimara

{% content-ref url="../gcp-persistence/gcp-bigquery-persistence.md" %}
[gcp-bigquery-persistence.md](../gcp-persistence/gcp-bigquery-persistence.md)
{% endcontent-ref %}

## Marejeo

* [https://cloud.google.com/bigquery/docs/column-level-security-intro](https://cloud.google.com/bigquery/docs/column-level-security-intro)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
* repos za github.

</details>
