# GCP - 容器、GKE 和 Composer 枚举

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧。

</details>

## 容器

在 GCP 容器中，您可以找到 GCP 提供的大多数基于容器的服务，在这里您可以看到如何枚举最常见的服务：
```bash
gcloud container images list
gcloud container images list --repository us.gcr.io/<project-name> #Search in other subdomains repositories
gcloud container images describe <name>
gcloud container subnets list-usable
gcloud container clusters list
gcloud container clusters describe <name>
gcloud container clusters get-credentials [NAME]

# Run a container locally
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh

# Login & Download
sudo docker login -u oauth2accesstoken -p $(gcloud auth print-access-token) https://HOSTNAME
## where HOSTNAME is gcr.io, us.gcr.io, eu.gcr.io, or asia.gcr.io.
sudo docker pull HOSTNAME/<project-name>/<image-name>
```
### 权限提升

在以下页面中，您可以查看如何**滥用容器权限来提升权限**：

{% content-ref url="../gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

## 节点池

这些是构成kubernetes集群的机器（节点）池。
```bash
# Pool of machines used by the cluster
gcloud container node-pools list --zone <zone> --cluster <cluster>
gcloud container node-pools describe --cluster <cluster> --zone <zone> <node-pool>
```
## Composer

这是GCP管理的**Airflow**版本。
```bash
gcloud composer environments list --locations <loc>
gcloud composer environments describe --location <loc> <environment>s
```
### 权限提升

在以下页面中，您可以查看如何**滥用 composer 权限来提升权限**：

{% content-ref url="../gcp-privilege-escalation/gcp-composer-privesc.md" %}
[gcp-composer-privesc.md](../gcp-privilege-escalation/gcp-composer-privesc.md)
{% endcontent-ref %}

## Kubernetes

有关 Kubernetes 是什么的信息，请查看此页面：

{% content-ref url="../../kubernetes-security/" %}
[kubernetes-security](../../kubernetes-security/)
{% endcontent-ref %}

首先，您可以检查您的项目中是否存在任何 Kubernetes 集群。
```
gcloud container clusters list
```
如果您确实有一个集群，您可以让 `gcloud` 自动配置您的 `~/.kube/config` 文件。当您使用 [kubectl](https://kubernetes.io/docs/reference/kubectl/overview/)（用于与 K8s 集群交互的原生 CLI）时，这个文件用于认证您的身份。尝试这个命令。
```
gcloud container clusters get-credentials [CLUSTER NAME] --region [REGION]
```
```markdown
然后，查看 `~/.kube/config` 文件以查看生成的凭据。此文件将用于基于您当前 `gcloud` 会话正在使用的相同身份自动刷新访问令牌。当然，这需要适当的权限。

一旦设置完成，您可以尝试以下命令来获取集群配置。
```
```
kubectl cluster-info
```
您可以在[此处](https://cloud.google.com/sdk/gcloud/reference/container/)了解更多关于`gcloud`用于容器的信息。

这是一个简单的脚本，用于枚举GCP中的kubernetes：[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum)

### TLS引导权限提升

最初，这种权限提升技术允许在GKE集群**内部进行权限提升**，有效地允许攻击者**完全占据它**。

这是因为GKE在元数据中提供了[TLS引导凭证](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)，仅通过**占据一个pod**就可以**被任何人访问**。

使用的技术在以下帖子中解释：

* [https://www.4armed.com/blog/hacking-kubelet-on-gke/](https://www.4armed.com/blog/hacking-kubelet-on-gke/)
* [https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/](https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/)
* [https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)

此工具被创建用于自动化该过程：[https://github.com/4ARMED/kubeletmein](https://github.com/4ARMED/kubeletmein)

然而，这种技术滥用了这样一个事实：**使用元数据凭证**可以**生成一个CSR**（证书签名请求）用于**新节点**，这个请求会被**自动批准**。\
在我的测试中，我检查到**这些请求不再被自动批准**，所以我不确定这项技术是否仍然有效。

### Kubelet API中的秘密 <a href="#the-kubelet-api-git-secrets-redux" id="the-kubelet-api-git-secrets-redux"></a>

在[**这篇帖子**](https://blog.assetnote.io/2022/05/06/cloudflare-pages-pt3/)中，发现了一个从GKE中的pod内部可以访问的Kubelet API地址，它提供了正在运行的pods的详细信息：
```
curl -v -k http://10.124.200.1:10255/pods
```
即使 API **不允许修改资源**，在响应中也可能找到**敏感信息**。使用 [**Kiterunner**](https://github.com/assetnote/kiterunner) 发现了端点 /pods。

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
