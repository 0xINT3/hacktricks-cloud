# GCP - 容器，GKE和Composer枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 容器

在GCP容器中，您可以找到GCP提供的大多数基于容器的服务，这里您可以了解如何枚举最常见的服务：
```bash
gcloud container images list
gcloud container images list --repository us.gcr.io/<project-name> #Search in other subdomains repositories
gcloud container images describe <name>
gcloud container subnets list-usable
gcloud container clusters list
gcloud container clusters describe <name>
gcloud container clusters get-credentials [NAME]

# Run a container locally
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh

# Login & Download
sudo docker login -u oauth2accesstoken -p $(gcloud auth print-access-token) https://HOSTNAME
## where HOSTNAME is gcr.io, us.gcr.io, eu.gcr.io, or asia.gcr.io.
sudo docker pull HOSTNAME/<project-name>/<image-name>
```
### 提权

在下面的页面中，您可以查看如何滥用容器权限以提升特权：

{% content-ref url="../gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

## 节点池

这些是形成 Kubernetes 集群的机器（节点）的池。
```bash
# Pool of machines used by the cluster
gcloud container node-pools list --zone <zone> --cluster <cluster>
gcloud container node-pools describe --cluster <cluster> --zone <zone> <node-pool>
```
## Composer

这是GCP的托管版本的**Airflow**。
```bash
gcloud composer environments list --locations <loc>
gcloud composer environments describe --location <loc> <environment>s
```
### 提权

在下面的页面中，您可以查看如何滥用composer权限以提升特权：

{% content-ref url="../gcp-privilege-escalation/gcp-composer-privesc.md" %}
[gcp-composer-privesc.md](../gcp-privilege-escalation/gcp-composer-privesc.md)
{% endcontent-ref %}

## Kubernetes

有关Kubernetes是什么的信息，请查看此页面：

{% content-ref url="../../kubernetes-security/" %}
[kubernetes-security](../../kubernetes-security/)
{% endcontent-ref %}

首先，您可以检查项目中是否存在任何Kubernetes集群。
```
gcloud container clusters list
```
如果您有一个集群，您可以让`gcloud`自动配置您的`~/.kube/config`文件。该文件用于在使用[kubectl](https://kubernetes.io/docs/reference/kubectl/overview/)时对您进行身份验证，kubectl是与K8s集群交互的本机CLI。尝试运行以下命令。
```
gcloud container clusters get-credentials [CLUSTER NAME] --region [REGION]
```
然后，查看`~/.kube/config`文件以查看生成的凭据。该文件将用于根据与您的活动`gcloud`会话使用的相同身份自动刷新访问令牌。当然，这需要正确的权限。

设置完成后，您可以尝试以下命令来获取集群配置。
```
kubectl cluster-info
```
您可以在此处阅读有关`gcloud`用于容器的更多信息：[https://cloud.google.com/sdk/gcloud/reference/container/](https://cloud.google.com/sdk/gcloud/reference/container/)。

这是一个简单的脚本，用于枚举GCP中的Kubernetes：[https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum)

### TLS引导特权升级

最初，此特权升级技术允许在GKE集群内进行**特权升级**，从而使攻击者能够**完全控制**该集群。

这是因为GKE在元数据中提供了[TLS引导凭据](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/)，而**任何人只要入侵一个Pod就可以访问**这些凭据。

所使用的技术在以下文章中有详细解释：

* [https://www.4armed.com/blog/hacking-kubelet-on-gke/](https://www.4armed.com/blog/hacking-kubelet-on-gke/)
* [https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/](https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/)
* [https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)

而这个工具是为了自动化这个过程而创建的：[https://github.com/4ARMED/kubeletmein](https://github.com/4ARMED/kubeletmein)

然而，该技术滥用了**使用元数据凭据**可以为**新节点生成CSR**（证书签名请求），而这些请求会**自动批准**的事实。\
在我的测试中，我发现**这些请求不再自动批准**，所以我不确定这个技术是否仍然有效。

### Kubelet API中的机密信息 <a href="#the-kubelet-api-git-secrets-redux" id="the-kubelet-api-git-secrets-redux"></a>

在[**这篇文章**](https://blog.assetnote.io/2022/05/06/cloudflare-pages-pt3/)中发现了一个可以从GKE内的Pod中访问的Kubelet API地址，提供了正在运行的Pod的详细信息：
```
curl -v -k http://10.124.200.1:10255/pods
```
即使API**不允许修改资源**，仍然有可能在响应中找到**敏感信息**。使用[Kiterunner](https://github.com/assetnote/kiterunner)发现了端点/pods。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
