# GCP - Enumeraci√≥n de Contenedores, GKE y Composer

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si deseas ver a **tu empresa anunciada en HackTricks** o si deseas acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Contenedores

En los contenedores de GCP, puedes encontrar la mayor√≠a de los servicios basados en contenedores que ofrece GCP. Aqu√≠ puedes ver c√≥mo enumerar los m√°s comunes:

```bash
gcloud container images list
gcloud container images list --repository us.gcr.io/<project-name> #Buscar en otros repositorios de subdominios
gcloud container images describe <name>
gcloud container subnets list-usable
gcloud container clusters list
gcloud container clusters describe <name>
gcloud container clusters get-credentials [NAME]

# Ejecutar un contenedor localmente
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh

# Iniciar sesi√≥n y descargar
sudo docker login -u oauth2accesstoken -p $(gcloud auth print-access-token) https://HOSTNAME
## donde HOSTNAME es gcr.io, us.gcr.io, eu.gcr.io o asia.gcr.io.
sudo docker pull HOSTNAME/<project-name>/<image-name>
```

### Privesc

En la siguiente p√°gina, puedes ver c√≥mo **abuso de los permisos del contenedor para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-container-privesc.md" %}
[gcp-container-privesc.md](../gcp-privilege-escalation/gcp-container-privesc.md)
{% endcontent-ref %}

## Pools de nodos

Estos son los grupos de m√°quinas (nodos) que forman los cl√∫steres de Kubernetes.

```bash
# Grupo de m√°quinas utilizado por el cl√∫ster
gcloud container node-pools list --zone <zone> --cluster <cluster>
gcloud container node-pools describe --cluster <cluster> --zone <zone> <node-pool>
```

## Composer

Esta es la versi√≥n administrada de **Airflow** de GCP.

```bash
gcloud composer environments list --locations <loc>
gcloud composer environments describe --location <loc> <environment>s
```

### Privesc

En la siguiente p√°gina, puedes ver c√≥mo **abuso de los permisos de Composer para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-composer-privesc.md" %}
[gcp-composer-privesc.md](../gcp-privilege-escalation/gcp-composer-privesc.md)
{% endcontent-ref %}

## Kubernetes

Para obtener informaci√≥n sobre qu√© es Kubernetes, consulta esta p√°gina:

{% content-ref url="../../kubernetes-security/" %}
[kubernetes-security](../../kubernetes-security/)
{% endcontent-ref %}

En primer lugar, puedes comprobar si existen cl√∫steres de Kubernetes en tu proyecto.

```
gcloud container clusters list
```

Si tienes un cl√∫ster, puedes hacer que `gcloud` configure autom√°ticamente tu archivo `~/.kube/config`. Este archivo se utiliza para autenticarte cuando usas [kubectl](https://kubernetes.io/docs/reference/kubectl/overview/), la CLI nativa para interactuar con los cl√∫steres K8s. Prueba este comando.

```
gcloud container clusters get-credentials [CLUSTER NAME] --region [REGION]
```

Luego, echa un vistazo al archivo `~/.kube/config` para ver las credenciales generadas. Este archivo se utilizar√° para actualizar autom√°ticamente los tokens de acceso en funci√≥n de la misma identidad que est√° utilizando tu sesi√≥n activa de `gcloud`. Esto, por supuesto, requiere los permisos correctos.

Una vez configurado esto, puedes probar el siguiente comando para obtener la configuraci√≥n del cl√∫ster.

```
kubectl cluster-info
```

Puedes leer m√°s sobre `gcloud` para contenedores [aqu√≠](https://cloud.google.com/sdk/gcloud/reference/container/).

Este es un script sencillo para enumerar Kubernetes en GCP: [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_k8s\_enum)

### Escalada de privilegios de TLS Boostrap

Inicialmente, esta t√©cnica de escalada de privilegios permit√≠a **escalar privilegios dentro del cl√∫ster GKE**, lo que permit√≠a a un atacante **comprometerlo por completo**.

Esto se debe a que GKE proporciona credenciales de [TLS Bootstrap](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/) en los metadatos, que es **accesible por cualquier persona que comprometa un pod**.

La t√©cnica utilizada se explica en las siguientes publicaciones:

* [https://www.4armed.com/blog/hacking-kubelet-on-gke/](https://www.4armed.com/blog/hacking-kubelet-on-gke/)
* [https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/](https://www.4armed.com/blog/kubeletmein-kubelet-hacking-tool/)
* [https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/](https://rhinosecuritylabs.com/cloud-security/kubelet-tls-bootstrap-privilege-escalation/)

Y esta herramienta se cre√≥ para automatizar el proceso: [https://github.com/4ARMED/kubeletmein](https://github.com/4ARMED/kubeletmein)

Sin embargo, la t√©cnica abusaba del hecho de que **con las credenciales de los metadatos** era posible **generar una CSR** (solicitud de firma de certificado) para un **nuevo nodo**, que era **aprobado autom√°ticamente**.\
En mi prueba, comprob√© que **esas solicitudes ya no se aprueban autom√°ticamente**, as√≠ que no estoy seguro de si esta t√©cnica sigue siendo v√°lida.

### Secretos en la API de Kubelet <a href="#the-kubelet-api-git-secrets-redux" id="the-kubelet-api-git-secrets-redux"></a>

En [**esta publicaci√≥n**](https://blog.assetnote.io/2022/05/06/cloudflare-pages-pt3/) se descubri√≥ una direcci√≥n de API de Kubelet accesible desde dentro de un pod en GKE que proporciona los detalles de los pods en ejecuci√≥n:

```
curl -v -k http://10.124.200.1:10255/pods
```

Incluso si la API **no permite modificar recursos**, podr√≠a ser posible encontrar **informaci√≥n sensible** en la respuesta. El punto final /pods se encontr√≥ utilizando [**Kiterunner**](https://github.com/assetnote/kiterunner).