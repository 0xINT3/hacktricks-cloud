# GCP - 存储枚举

<details>

<summary><strong>从零到英雄学习AWS黑客技术，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## 存储

Google Cloud Platform (GCP) 存储是一种**基于云的存储解决方案**，为非结构化数据提供高度耐用和可用的对象存储。它提供基于性能、可用性和成本的**多种存储类别**，包括标准、近线、冷线和归档。GCP存储还提供高级功能，如**生命周期策略、版本控制和访问控制**，以有效管理和保护数据。

存储桶可以存储在一个区域、两个区域或**多区域（默认）**。

### 存储类型

* **标准存储**：这是默认的存储选项，**提供对频繁访问数据的高性能、低延迟访问**。适用于广泛的用例，包括提供网站内容、流媒体和托管数据分析管道。
* **近线存储**：这个存储类别提供**较低的存储成本**和**略高的访问成本**。它针对不常访问的数据进行了优化，最短存储期限为30天。它非常适合备份和存档目的。
* **冷线存储**：这个存储类别针对**长期存储不常访问的数据**进行了优化，最短存储期限为90天。它提供比近线存储**更低的存储成本**，但**访问成本更高**。
* **归档存储**：这个存储类别设计用于**非常不常访问的冷数据**，最短存储期限为365天。它提供了所有GCP存储选项中**最低的存储成本**，但**访问成本最高**。它适用于需要因合规或监管原因而长期保留的数据。
* **自动分类**：如果您**不知道将要访问数据的频率**，可以选择自动分类，GCP将**自动为您更改存储类型以最小化成本**。

### 访问控制

**默认情况下**，建议通过**IAM**控制访问，但也可以**启用ACLs的使用**。\
如果您选择仅使用IAM（默认），并且**过去了90天**，您**将无法为存储桶启用ACLs**。

### 版本控制

可以启用版本控制，这将**在存储桶内保存文件的旧版本**。可以配置**您想要保留的版本数量**，甚至**非当前版本（旧版本）的存活时间**。建议**标准类型为7天**。

**非当前版本的元数据被保留**。此外，**非当前版本的ACLs也被保留**，因此旧版本可能具有与当前版本不同的ACLs。

在[**文档**](https://cloud.google.com/storage/docs/object-versioning)中了解更多。

### 保留策略

指明您希望**禁止在存储桶内删除对象的时间长度**（至少对于合规性非常有用）。\
**版本控制或保留策略只能同时启用一个**。

### 加密

默认情况下，对象使用Google管理的密钥进行**加密**，但您也可以使用**来自KMS的密钥**。

### HMAC密钥

HMAC密钥是一种_凭证_类型，可以**与云存储中的服务账户或用户账户关联**。您使用HMAC密钥创建_签名_，然后将其包含在对云存储的请求中。签名表明**给定请求由用户或服务账户授权**。

HMAC密钥有两个主要部分，一个_访问ID_和一个_秘密_。

*   **访问ID**：与特定服务或用户账户关联的字母数字字符串。当链接到服务账户时，字符串长度为61个字符，当链接到用户账户时，字符串长度为24个字符。以下是访问ID的一个示例：

`GOOGTS7C7FUP3AIRVJTE2BCDKINBTES3HC2GY5CBFJDCQ2SYHV6A6XXVTJFSA`
*   **秘密**：一个40字符的Base-64编码字符串，与特定的访问ID关联。秘密是一个预共享密钥，只有您和云存储知道。您使用您的秘密作为认证过程的一部分来创建签名。以下是一个秘密的示例：

`bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ`

**访问ID和秘密唯一地识别一个HMAC密钥**，但秘密是更敏感的信息，因为它用于**创建签名**。

### 枚举
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -

# Enumerate HMAC keys
gsutil hmac list
```
```markdown
如果在列出存储桶时遇到权限拒绝错误，您可能仍然可以访问内容。因此，现在您知道了存储桶的命名规则，您可以生成一系列可能的名称并尝试访问它们：
```
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### 公共访问

可以允许外部用户（无论是否登录GCP）访问存储桶内容。然而，默认情况下，存储桶将禁用公开暴露存储桶的选项：
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
如果您尝试给**禁用了ACLs的存储桶分配ACLs**，您会遇到这个错误：`ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access`

要通过浏览器访问开放的存储桶，请访问URL `https://<bucket_name>.storage.googleapis.com/` 或 `https://<bucket_name>.storage.googleapis.com/<object_name>`

### 权限提升

在以下页面中，您可以检查如何**滥用存储权限来提升权限**：

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### 在当前账户中搜索开放的存储桶

使用以下[从这里收集的](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_buckets.sh)脚本，您可以找到所有开放的存储桶：
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>从零到英雄学习AWS黑客技术，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
