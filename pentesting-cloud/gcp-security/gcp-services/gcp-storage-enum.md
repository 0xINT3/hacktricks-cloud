# GCP - √ânum√©ration du stockage

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Stockage

Le stockage Google Cloud Platform (GCP) est une **solution de stockage bas√©e sur le cloud** qui fournit un stockage d'objets hautement durable et disponible pour les donn√©es non structur√©es. Il offre **diverses classes de stockage** bas√©es sur la performance, la disponibilit√© et le co√ªt, y compris Standard, Nearline, Coldline et Archive. Le stockage GCP propose √©galement des fonctionnalit√©s avanc√©es telles que **les politiques de cycle de vie, le versioning et le contr√¥le d'acc√®s** pour g√©rer et s√©curiser efficacement les donn√©es.

Le bucket peut √™tre stock√© dans une r√©gion, dans 2 r√©gions ou en **multi-r√©gion (par d√©faut)**.

### Types de stockage

* **Stockage Standard** : C'est l'option de stockage par d√©faut qui **offre un acc√®s haute performance et √† faible latence aux donn√©es fr√©quemment consult√©es**. Il convient √† une large gamme de cas d'utilisation, y compris le contenu de sites Web, le streaming multim√©dia et l'h√©bergement de pipelines d'analyse de donn√©es.
* **Stockage Nearline** : Cette classe de stockage offre **des co√ªts de stockage inf√©rieurs** et **des co√ªts d'acc√®s l√©g√®rement plus √©lev√©s** que le Stockage Standard. Il est optimis√© pour les donn√©es consult√©es occasionnellement, avec une dur√©e de stockage minimale de 30 jours. Il est id√©al pour la sauvegarde et l'archivage.
* **Stockage Coldline** : Cette classe de stockage est optimis√©e pour **le stockage √† long terme de donn√©es rarement consult√©es**, avec une dur√©e de stockage minimale de 90 jours. Il offre **des co√ªts de stockage inf√©rieurs** au Stockage Nearline, mais avec **des co√ªts d'acc√®s plus √©lev√©s**.
* **Stockage Archive** : Cette classe de stockage est con√ßue pour les donn√©es froides qui sont **tr√®s rarement consult√©es**, avec une dur√©e de stockage minimale de 365 jours. Il offre **les co√ªts de stockage les plus bas de toutes les options de stockage GCP** mais avec **les co√ªts d'acc√®s les plus √©lev√©s**. Il convient pour la conservation √† long terme des donn√©es qui doivent √™tre stock√©es pour des raisons de conformit√© ou r√©glementaires.
* **Autoclass** : Si vous **ne savez pas √† quelle fr√©quence vous allez acc√©der** aux donn√©es, vous pouvez s√©lectionner Autoclass et GCP **changera automatiquement le type de stockage pour vous afin de minimiser les co√ªts**.

### Contr√¥le d'acc√®s

Par **d√©faut**, il est **recommand√©** de contr√¥ler l'acc√®s via **IAM**, mais il est √©galement possible **d'activer l'utilisation des ACL**.\
Si vous choisissez d'utiliser uniquement IAM (par d√©faut) et que **90 jours passent**, vous **ne pourrez plus activer les ACL** pour le bucket.

### Protection des objets de stockage

### Versioning

Il est possible d'activer le versioning, cela **sauvegardera les anciennes versions du fichier dans le bucket**. Il est possible de configurer **le nombre de versions que vous souhaitez conserver** et m√™me **combien de temps** vous voulez que les versions **non actuelles** (anciennes versions) soient conserv√©es. Il est recommand√© de **7 jours pour le type Standard**.

**Les m√©tadonn√©es d'une version non actuelle sont conserv√©es**. De plus, **les ACL des versions non actuelles sont √©galement conserv√©es**, donc la version actuelle pourrait avoir des ACL diff√©rentes de la version courante.&#x20;

En savoir plus dans la [**documentation**](https://cloud.google.com/storage/docs/object-versioning).

### Politique de r√©tention

Indiquez **combien de temps** vous souhaitez **interdire la suppression d'objets √† l'int√©rieur du bucket** (tr√®s utile pour la conformit√© au moins).\
Seule l'une des options **versioning ou politique de r√©tention peut √™tre activ√©e √† la fois**.

### Chiffrement

Par d√©faut, les objets sont **chiffr√©s √† l'aide de cl√©s g√©r√©es par Google**, mais vous pourriez √©galement utiliser une **cl√© de KMS**.

### √ânum√©ration
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -
```
Si vous recevez un message d'erreur de permission refus√©e lors de la liste des seaux, vous pouvez toujours avoir acc√®s au contenu. Donc, maintenant que vous connaissez la convention de nommage des seaux, vous pouvez g√©n√©rer une liste de noms possibles et essayer d'y acc√©der :
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### Acc√®s Public

Il est possible de donner √† des utilisateurs externes (connect√©s √† GCP ou non) l'acc√®s au contenu des compartiments. Cependant, par d√©faut, l'option permettant d'exposer publiquement un compartiment sera d√©sactiv√©e :
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
Si vous essayez de donner des **ACLs √† un bucket avec les ACLs d√©sactiv√©s**, vous rencontrerez cette erreur : `ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access`

Pour acc√©der aux buckets ouverts via un navigateur, acc√©dez √† l'URL `https://<nom_du_bucket>.storage.googleapis.com/` ou `https://<nom_du_bucket>.storage.googleapis.com/<nom_de_l'objet>`

### √âl√©vation de Privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des permissions de stockage pour √©lever les privil√®ges** :

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Rechercher des Buckets Ouverts dans le Compte Actuel

Avec le script suivant [r√©cup√©r√© ici](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_misc/-/blob/master/find_open_buckets.sh), vous pouvez trouver tous les buckets ouverts :
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
