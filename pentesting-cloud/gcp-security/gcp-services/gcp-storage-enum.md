# GCP - 存储枚举

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## 存储

Google Cloud Platform (GCP) 存储是一种基于云的存储解决方案，为非结构化数据提供高度耐用和可用的对象存储。它提供基于性能、可用性和成本的各种存储类别，包括标准、Nearline、Coldline 和 Archive。GCP 存储还提供高级功能，如生命周期策略、版本控制和访问控制，以有效地管理和保护数据。

存储桶可以存储在一个区域、两个区域或**多个区域（默认）**。

### 存储类型

* **标准存储**：这是默认的存储选项，**提供对频繁访问数据的高性能、低延迟访问**。适用于各种用例，包括提供网站内容、流媒体和托管数据分析流水线。
* **Nearline 存储**：此存储类别的存储成本较低，访问成本略高于标准存储。它针对不经常访问的数据进行了优化，最低存储持续时间为 30 天。非常适合备份和归档目的。
* **Coldline 存储**：此存储类别针对**不经常访问的长期存储数据**进行了优化，最低存储持续时间为 90 天。它提供比 Nearline 存储更低的存储成本，但访问成本较高。
* **Archive 存储**：此存储类别专为**非常不经常访问的冷数据**设计，最低存储持续时间为 365 天。它是所有 GCP 存储选项中存储成本最低的，但访问成本最高。适用于需要长期保留需要符合合规性或监管要求的数据。
* **自动分类**：如果您**不知道将访问多少数据**，可以选择自动分类，GCP 将**自动更改存储类型以最小化成本**。

### 访问控制

**默认情况下**，建议通过**IAM**控制访问，但也可以**启用 ACL 的使用**。\
如果选择仅使用 IAM（默认）并且**90 天过去**，则**无法为存储桶启用 ACL**。

### 存储对象保护

### 版本控制

可以启用版本控制，这将**在存储桶内保存文件的旧版本**。可以配置**要保留的版本数量**，甚至可以配置**非当前版本（旧版本）的存活时间**。建议为**标准类型设置 7 天**。

**非当前版本的元数据将被保留**。此外，**非当前版本的 ACL 也将被保留**，因此当前版本可能与当前版本具有不同的 ACL。&#x20;

在[**文档**](https://cloud.google.com/storage/docs/object-versioning)中了解更多信息。

### 保留策略

指定您希望**禁止删除存储桶内对象的时间**（至少对合规性非常有用）。\
**只能同时启用版本控制或保留策略中的一个**。

### 加密

默认情况下，对象使用**Google 托管密钥进行加密**，但您也可以使用**KMS 中的密钥**。

### 枚举
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -
```
如果您在列出存储桶时遇到权限被拒绝的错误，可能仍然可以访问其内容。因此，现在您已经了解了存储桶的命名约定，可以生成可能的名称列表并尝试访问它们：
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### 公开访问

可以将外部用户（无论是否登录GCP）授予访问存储桶内容的权限。然而，默认情况下，存储桶将禁用公开访问选项：
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
如果您尝试为已禁用ACL的存储桶提供ACL，则会出现以下错误：`ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access`

要通过浏览器访问公开的存储桶，请访问以下URL：`https://<bucket_name>.storage.googleapis.com/` 或 `https://<bucket_name>.storage.googleapis.com/<object_name>`

### 特权升级

您可以在以下页面中查看如何滥用存储权限以提升特权：

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### 在当前账户中搜索公开的存储桶

使用以下脚本[从这里获取](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_buckets.sh)，您可以找到所有公开的存储桶：
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>支持HackTricks并获得好处！</strong></summary>

* 如果您想看到您的**公司在HackTricks中进行广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或者 [**Telegram群组**](https://t.me/peass)，或者在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
