# GCP - Enumera√ß√£o de Armazenamento

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Armazenamento

O Armazenamento do Google Cloud Platform (GCP) √© uma **solu√ß√£o de armazenamento baseada na nuvem** que fornece armazenamento de objetos altamente dur√°vel e dispon√≠vel para dados n√£o estruturados. Oferece **v√°rias classes de armazenamento** baseadas em desempenho, disponibilidade e custo, incluindo Standard, Nearline, Coldline e Arquivo. O Armazenamento GCP tamb√©m fornece recursos avan√ßados como **pol√≠ticas de ciclo de vida, versionamento e controle de acesso** para gerenciar e proteger dados de forma eficaz.

O bucket pode ser armazenado em uma regi√£o, em 2 regi√µes ou **multi-regi√£o (padr√£o)**.

### Tipos de Armazenamento

* **Armazenamento Padr√£o**: Esta √© a op√ß√£o de armazenamento padr√£o que **oferece acesso de alta performance e baixa lat√™ncia a dados frequentemente acessados**. √â adequado para uma ampla gama de casos de uso, incluindo conte√∫do de sites, m√≠dia de streaming e hospedagem de pipelines de an√°lise de dados.
* **Armazenamento Nearline**: Esta classe de armazenamento oferece **custos de armazenamento mais baixos** e **custos de acesso um pouco mais altos** do que o Armazenamento Padr√£o. √â otimizado para dados acessados ‚Äã‚Äãcom pouca frequ√™ncia, com uma dura√ß√£o m√≠nima de armazenamento de 30 dias. √â ideal para backup e fins de arquivamento.
* **Armazenamento Coldline**: Esta classe de armazenamento √© otimizada para **armazenamento de longo prazo de dados acessados ‚Äã‚Äãcom pouca frequ√™ncia**, com uma dura√ß√£o m√≠nima de armazenamento de 90 dias. Oferece **custos de armazenamento mais baixos** do que o Armazenamento Nearline, mas com **custos de acesso mais altos**.
* **Armazenamento de Arquivo**: Esta classe de armazenamento √© projetada para dados frios que s√£o acessados ‚Äã‚Äã**muito raramente**, com uma dura√ß√£o m√≠nima de armazenamento de 365 dias. Oferece os **custos de armazenamento mais baixos de todas as op√ß√µes de armazenamento do GCP**, mas com os **custos de acesso mais altos**. √â adequado para a reten√ß√£o de longo prazo de dados que precisam ser armazenados por motivos de conformidade ou regulamentares.
* **Autoclass**: Se voc√™ **n√£o sabe quanto vai acessar** os dados, voc√™ pode selecionar Autoclass e o GCP **mudar√° automaticamente o tipo de armazenamento para voc√™ para minimizar custos**.

### Controle de Acesso

Por **padr√£o**, √© **recomendado** controlar o acesso via **IAM**, mas tamb√©m √© poss√≠vel **habilitar o uso de ACLs**.\
Se voc√™ optar por usar apenas o IAM (padr√£o) e **90 dias se passarem**, voc√™ **n√£o poder√° habilitar ACLs** para o bucket.

### Prote√ß√£o de Objetos de Armazenamento

### Versionamento

√â poss√≠vel habilitar o versionamento, isso **salvar√° vers√µes antigas do arquivo dentro do bucket**. √â poss√≠vel configurar o **n√∫mero de vers√µes que voc√™ deseja manter** e at√© mesmo **por quanto tempo** voc√™ quer que as vers√µes **n√£o atuais** (antigas) permane√ßam. Recomenda-se **7 dias para o tipo Padr√£o**.

O **metadado de uma vers√£o n√£o atual √© mantido**. Al√©m disso, **ACLs de vers√µes n√£o atuais tamb√©m s√£o mantidas**, ent√£o a vers√£o atual pode ter ACLs diferentes da vers√£o atual.&#x20;

Saiba mais nos [**documentos**](https://cloud.google.com/storage/docs/object-versioning).

### Pol√≠tica de Reten√ß√£o

Indique por **quanto tempo** voc√™ deseja **proibir a exclus√£o de Objetos dentro do bucket** (muito √∫til para conformidade pelo menos).\
Apenas um entre **versionamento ou pol√≠tica de reten√ß√£o pode ser habilitado por vez**.

### Criptografia

Por padr√£o, os objetos s√£o **criptografados usando chaves gerenciadas pelo Google**, mas voc√™ tamb√©m pode usar uma **chave do KMS**.

### Enumera√ß√£o
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -
```
Se voc√™ receber um erro de permiss√£o negada ao listar buckets, ainda pode ter acesso ao conte√∫do. Ent√£o, agora que voc√™ sabe sobre a conven√ß√£o de nomes dos buckets, voc√™ pode gerar uma lista de nomes poss√≠veis e tentar acess√°-los:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### Acesso P√∫blico

√â poss√≠vel conceder a usu√°rios externos (autenticados no GCP ou n√£o) acesso ao conte√∫do dos buckets. No entanto, por padr√£o, a op√ß√£o de expor publicamente um bucket estar√° desativada:
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
Se voc√™ tentar dar **ACLs a um bucket com ACLs desativados**, encontrar√° este erro: `ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Leia mais em https://cloud.google.com/storage/docs/uniform-bucket-level-access`

Para acessar buckets abertos via navegador, acesse a URL `https://<nome_do_bucket>.storage.googleapis.com/` ou `https://<nome_do_bucket>.storage.googleapis.com/<nome_do_objeto>`

### Escalonamento de Privil√©gios

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes de armazenamento para escalar privil√©gios**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Procurar Buckets Abertos na Conta Atual

Com o seguinte script [obtido daqui](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp_misc/-/blob/master/find_open_buckets.sh), voc√™ pode encontrar todos os buckets abertos:
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
