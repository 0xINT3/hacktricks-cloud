# GCP - Enumeraci칩n de Almacenamiento

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Almacenamiento

Google Cloud Platform (GCP) Storage es una **soluci칩n de almacenamiento basada en la nube** que proporciona almacenamiento de objetos altamente duradero y disponible para datos no estructurados. Ofrece **varias clases de almacenamiento** basadas en rendimiento, disponibilidad y costo, incluyendo Est치ndar, Nearline, Coldline y Archivo. GCP Storage tambi칠n proporciona caracter칤sticas avanzadas como **pol칤ticas de ciclo de vida, versionado y control de acceso** para gestionar y asegurar los datos de manera efectiva.

El bucket puede almacenarse en una regi칩n, en 2 regiones o **multi-regi칩n (predeterminado)**.

### Tipos de Almacenamiento

* **Almacenamiento Est치ndar**: Esta es la opci칩n de almacenamiento predeterminada que **ofrece acceso de alto rendimiento y baja latencia a datos frecuentemente accedidos**. Es adecuado para una amplia gama de casos de uso, incluyendo el contenido de sitios web, transmisi칩n de medios y alojamiento de tuber칤as de an치lisis de datos.
* **Almacenamiento Nearline**: Esta clase de almacenamiento ofrece **costos de almacenamiento m치s bajos** y **costos de acceso ligeramente m치s altos** que el Almacenamiento Est치ndar. Est치 optimizado para datos accedidos infrecuentemente, con una duraci칩n m칤nima de almacenamiento de 30 d칤as. Es ideal para prop칩sitos de respaldo y archivo.
* **Almacenamiento Coldline**: Esta clase de almacenamiento est치 optimizada para **almacenamiento a largo plazo de datos accedidos infrecuentemente**, con una duraci칩n m칤nima de almacenamiento de 90 d칤as. Ofrece **costos de almacenamiento m치s bajos** que el Almacenamiento Nearline, pero con **costos de acceso m치s altos**.
* **Almacenamiento de Archivo**: Esta clase de almacenamiento est치 dise침ada para datos fr칤os que se acceden **muy infrecuentemente**, con una duraci칩n m칤nima de almacenamiento de 365 d칤as. Ofrece **los costos de almacenamiento m치s bajos de todas las opciones de almacenamiento de GCP** pero con **los costos de acceso m치s altos**. Es adecuado para la retenci칩n a largo plazo de datos que deben almacenarse por razones de cumplimiento o regulaciones.
* **Autoclass**: Si **no sabes cu치nto vas a acceder** a los datos, puedes seleccionar Autoclass y GCP **cambiar치 autom치ticamente el tipo de almacenamiento por ti para minimizar costos**.

### Control de Acceso

Por **defecto** se **recomienda** controlar el acceso a trav칠s de **IAM**, pero tambi칠n es posible **habilitar el uso de ACLs**.\
Si eliges usar solo IAM (predeterminado) y pasan **90 d칤as**, **no podr치s habilitar ACLs** para el bucket.

### Protecci칩n de Objetos de Almacenamiento

### Versionado

Es posible habilitar el versionado, esto **guardar치 versiones antiguas del archivo dentro del bucket**. Es posible configurar **el n칰mero de versiones que deseas mantener** e incluso **cu치nto tiempo** deseas que vivan las versiones **no actuales** (versiones antiguas). Se recomienda **7 d칤as para el tipo Est치ndar**.

Se **mantiene la metadata de una versi칩n no actual**. Adem치s, **las ACLs de las versiones no actuales tambi칠n se mantienen**, por lo que la versi칩n viva podr칤a tener diferentes ACLs de la versi칩n actual.&#x20;

Aprende m치s en la [**documentaci칩n**](https://cloud.google.com/storage/docs/object-versioning).

### Pol칤tica de Retenci칩n

Indica cu치nto tiempo quieres **prohibir la eliminaci칩n de Objetos dentro del bucket** (muy 칰til para cumplimiento al menos).\
Solo se puede habilitar **versionado o pol칤tica de retenci칩n al mismo tiempo**.

### Encriptaci칩n

Por defecto, los objetos est치n **encriptados usando claves gestionadas por Google**, pero tambi칠n podr칤as usar una **clave de KMS**.

### Enumeraci칩n
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -
```
Si recibes un error de permiso denegado al listar buckets, a칰n podr칤as tener acceso al contenido. Entonces, ahora que conoces la convenci칩n de nombres de los buckets, puedes generar una lista de nombres posibles e intentar acceder a ellos:
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### Acceso P칰blico

Es posible otorgar a usuarios externos (con o sin sesi칩n en GCP) acceso al contenido de los buckets. Sin embargo, por defecto, los buckets tendr치n desactivada la opci칩n de exponer p칰blicamente un bucket:
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
Si intentas dar **ACLs a un bucket con ACLs deshabilitadas** encontrar치s este error: `ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access`

Para acceder a buckets abiertos a trav칠s del navegador, accede a la URL `https://<nombre_del_bucket>.storage.googleapis.com/` o `https://<nombre_del_bucket>.storage.googleapis.com/<nombre_del_objeto>`

### Escalada de Privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de almacenamiento para escalar privilegios**:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### Buscar Buckets Abiertos en la Cuenta Actual

Con el siguiente script [recopilado de aqu칤](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_buckets.sh) puedes encontrar todos los buckets abiertos:
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
