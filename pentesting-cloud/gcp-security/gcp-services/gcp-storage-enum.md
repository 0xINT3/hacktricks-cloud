# GCP - ストレージの列挙

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい**場合や、**PEASS の最新バージョンにアクセスしたい**場合、または **HackTricks を PDF でダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけてください。これは私たちの独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションです
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしてください。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## ストレージ

Google Cloud Platform (GCP) ストレージは、非構造化データのための高い耐久性と可用性を提供する、**クラウドベースのストレージソリューション**です。パフォーマンス、可用性、コストに基づいたさまざまなストレージクラス（Standard、Nearline、Coldline、Archive）を提供しています。GCP ストレージは、**ライフサイクルポリシー、バージョン管理、アクセス制御**などの高度な機能も提供しており、データを効果的に管理および保護することができます。

バケットは、リージョン、2つのリージョン、または**マルチリージョン（デフォルト）**に保存することができます。

### ストレージの種類

* **Standard Storage**: これは、**頻繁にアクセスされるデータに対して高性能で低遅延のアクセス**を提供するデフォルトのストレージオプションです。ウェブサイトのコンテンツの提供、メディアのストリーミング、データ分析パイプラインのホスティングなど、さまざまなユースケースに適しています。
* **Nearline Storage**: このストレージクラスは、Standard Storage よりも**低いストレージコスト**と**わずかに高いアクセスコスト**を提供します。最低ストレージ期間は30日で、頻繁にアクセスされないデータに最適です。バックアップやアーカイブ目的に適しています。
* **Coldline Storage**: このストレージクラスは、**頻繁にアクセスされないデータの長期保存**に最適化されており、最低ストレージ期間は90日です。Nearline Storage よりも低いストレージコストを提供しますが、**アクセスコストは高くなります**。
* **Archive Storage**: このストレージクラスは、非常にまれにアクセスされる**冷たいデータ**に対して設計されており、最低ストレージ期間は365日です。GCP ストレージオプションの中で最も低いストレージコストを提供しますが、**アクセスコストは最も高くなります**。コンプライアンスや規制のために保存する必要があるデータの長期保持に適しています。
* **Autoclass**: データへのアクセス量がわからない場合は、Autoclass を選択し、GCP が**ストレージの種類を自動的に変更してコストを最小限に抑えます**。

### アクセス制御

**デフォルトでは**、アクセスは**IAM**を使用して制御することが**推奨**されていますが、**ACL の使用を有効にする**ことも可能です。\
IAM のみを使用することを選択し、**90回以上のパス**がある場合、バケットの ACL を有効にすることはできません。

### ストレージオブジェクトの保護

### バージョニング

バージョニングを有効にすることができます。これにより、バケット内のファイルの**古いバージョンが保存されます**。**保持するバージョンの数**や、**非現行バージョン（古いバージョン）の寿命**を**どのくらい長く**するかを設定することも可能です。**Standard タイプの場合は 7 日**が推奨されています。

**非現行バージョンのメタデータは保持されます**。さらに、**非現行バージョンの ACL も保持されます**ので、ライブバージョンと現在のバージョンでは異なる ACL を持つ場合があります。&#x20;

詳細は[**ドキュメント**](https://cloud.google.com/storage/docs/object-versioning)を参照してください。

### 保持ポリシー

バケット内のオブジェクトの削除を**禁止する期間**を指定します（コンプライアンスに非常に便利です）。\
**バージョニングまたは保持ポリシーのいずれか一方しか同時に有効にできません**。

### 暗号化

デフォルトでは、オブジェクトは**Google 管理キーを使用して暗号化**されますが、**KMS のキー**を使用することもできます。

### 列挙
```bash
# List all storage buckets in project
gsutil ls

# Get each bucket configuration (protections, CLs, times, configs...)
gsutil ls -L

# List contents of a specific bucket
gsutil ls gs://bucket-name/
gsutil ls -r gs://bucket-name/ # Recursive
gsutil ls -a gs://bucket-name/ # Get ALL versions of objects

# Cat the context of a file without copying it locally
gsutil cat 'gs://bucket-name/folder/object'
gsutil cat 'gs://bucket-name/folder/object#<num>' # cat specific version

# Copy an object from the bucket to your local storage for review
gsutil cp gs://bucket-name/folder/object ~/

# List using a raw OAuth token
## Useful because "CLOUDSDK_AUTH_ACCESS_TOKEN" and "gcloud config set auth/access_token_file" doesn't work with gsutil
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/<storage-name>/o"
# Download file content from bucket
curl -H "Authorization: Bearer $TOKEN" "https://storage.googleapis.com/storage/v1/b/supportstorage-58249/o/flag.txt?alt=media" --output -
```
アクセス権が拒否されたエラーが表示された場合でも、コンテンツにアクセスできる可能性があります。したがって、バケットの名前規則について知っているのであれば、可能な名前のリストを生成し、それらにアクセスを試みることができます。
```bash
for i in $(cat wordlist.txt); do gsutil ls -r gs://"$i"; done
```
### 公開アクセス

外部ユーザー（GCPにログインしているかどうかに関係なく）にバケットのコンテンツへのアクセスを許可することが可能です。ただし、デフォルトではバケットの公開オプションは無効になっています。
```bash
# Disable public prevention
gcloud storage buckets update gs://BUCKET_NAME --no-public-access-prevention

# Make all objects in a bucket public
gcloud storage buckets add-iam-policy-binding gs://BUCKET_NAME --member=allUsers --role=roles/storage.objectViewer
## I don't think you can make specific objects public just with IAM

# Make a bucket or object public (via ACL)
gcloud storage buckets update gs://BUCKET_NAME --add-acl-grant=entity=AllUsers,role=READER
gcloud storage objects update gs://BUCKET_NAME/OBJECT_NAME --add-acl-grant=entity=AllUsers,role=READER
```
もし**無効化されたACLを持つバケットにACLを設定しようとすると**、次のエラーが表示されます: `ERROR: HTTPError 400: Cannot use ACL API to update bucket policy when uniform bucket-level access is enabled. Read more at https://cloud.google.com/storage/docs/uniform-bucket-level-access`

ブラウザ経由でオープンなバケットにアクセスするには、URL `https://<bucket_name>.storage.googleapis.com/` または `https://<bucket_name>.storage.googleapis.com/<object_name>` にアクセスしてください。

### 特権昇格

次のページでは、**ストレージの権限を悪用して特権を昇格させる**方法を確認できます:

{% content-ref url="../gcp-privilege-escalation/gcp-storage-privesc.md" %}
[gcp-storage-privesc.md](../gcp-privilege-escalation/gcp-storage-privesc.md)
{% endcontent-ref %}

### 現在のアカウントでオープンなバケットを検索する

次のスクリプトを使用して、[ここから入手できる](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_misc/-/blob/master/find\_open\_buckets.sh)すべてのオープンなバケットを検索できます:
```bash
#!/bin/bash

############################
# Run this tool to find buckets that are open to the public anywhere
# in your GCP organization.
#
# Enjoy!
############################

for proj in $(gcloud projects list --format="get(projectId)"); do
echo "[*] scraping project $proj"
for bucket in $(gsutil ls -p $proj); do
echo "    $bucket"
ACL="$(gsutil iam get $bucket)"

all_users="$(echo $ACL | grep allUsers)"
all_auth="$(echo $ACL | grep allAuthenticatedUsers)"

if [ -z "$all_users" ]
then
:
else
echo "[!] Open to all users: $bucket"
fi

if [ -z "$all_auth" ]
then
:
else
echo "[!] Open to all authenticated users: $bucket"
fi
done
done
```
<details>

<summary><strong>Support HackTricksと特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**し、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**をフォロー**する。
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出**してください。

</details>
