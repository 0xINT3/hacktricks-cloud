# GCP - KMS 枚举

<details>

<summary><strong>从零到英雄学习 AWS 黑客技术，参加</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) 是一个存储加密密钥的仓库，例如用于 **加密和解密敏感文件** 的密钥。单个密钥存储在密钥环中，并且可以在任一级别应用精细的权限。

KMS 密钥环默认创建为全球性的，这意味着该密钥环内的密钥可以从任何地区访问。然而，可以在 **特定地区** 创建特定的密钥环。

### 密钥保护级别

* **软件密钥**：软件密钥完全由 KMS 在软件中 **创建和管理**。这些密钥 **没有通过任何硬件安全模块 (HSM) 保护**，可用于 **测试和开发目的**。软件密钥 **不推荐用于生产**，因为它们提供的安全性低，容易受到攻击。
* **云托管密钥**：云托管密钥由 KMS 在云中使用高可用性和可靠的基础设施 **创建和管理**。这些密钥 **受 HSM 保护**，但 HSM **不专用于特定客户**。云托管密钥适用于大多数生产用例。
* **外部密钥**：外部密钥在 KMS 外部 **创建和管理**，并导入到 KMS 中用于加密操作。外部密钥 **可以存储在硬件安全模块 (HSM) 或软件库中，具体取决于客户的偏好**。

### 密钥用途

* **对称加密/解密**：使用单个密钥进行数据的 **加密和解密**。对称密钥在加密和解密大量数据时快速且高效。
* **支持**：[cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **非对称签名**：用于在不共享密钥的情况下两方之间的安全通信。非对称密钥成对出现，包括 **公钥和私钥**。公钥与他人共享，而私钥保密。
* **支持**：[cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **非对称解密**：用于验证消息或数据的真实性。使用私钥创建数字签名，并可以使用相应的公钥进行验证。
* **支持**：[cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC 签名**：通过使用秘密密钥创建消息认证码 (MAC) 来确保 **数据的完整性和真实性**。HMAC 常用于网络协议和软件应用中的消息认证。
* **支持**：[cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### 旋转周期 & 计划销毁周期

默认情况下，每 **90 天**，但可以 **轻松** 且 **完全自定义**。

"计划销毁" 周期是从用户请求删除密钥到密钥被 **删除** 的 **时间**。创建密钥后不能更改（默认 1 天）。

### 主要版本

每个 KMS 密钥可以有多个版本，其中一个必须是 **默认** 版本，当与 KMS 密钥交互时如果 **没有指定版本**，将使用这个版本。

### 枚举

拥有 **列出密钥的权限**，您可以这样访问它们：
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### 权限提升

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

### 后期利用

{% content-ref url="../gcp-post-exploitation/gcp-kms-post-exploitation.md" %}
[gcp-kms-post-exploitation.md](../gcp-post-exploitation/gcp-kms-post-exploitation.md)
{% endcontent-ref %}

## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
