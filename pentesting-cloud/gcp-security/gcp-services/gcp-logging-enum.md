# GCP - ロギング列挙

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

このサービスは、GCPからの**ログデータとイベント**を保存、検索、分析、監視、およびアラートすることをユーザーに可能にします。

Cloud Loggingは他のGCPサービスと完全に統合されており、GCPリソースからのログのための一元化されたリポジトリを提供します。App Engine、Compute Engine、Cloud FunctionsなどのさまざまなGCPサービスから**自動的にログを収集します**。また、Cloud LoggingエージェントまたはAPIを使用して、オンプレミスまたは他のクラウドで実行されているアプリケーションに対してCloud Loggingを使用することもできます。

主な特徴:

* **ログデータの一元化:** さまざまなソースからのログデータを集約し、アプリケーションとインフラストラクチャの包括的なビューを提供します。
* **リアルタイムログ管理:** リアルタイムでログをストリーミングし、即時の分析と対応を可能にします。
* **強力なデータ分析:** 高度なフィルタリングと検索機能を使用して、大量のログデータを迅速に精査します。
* **BigQueryとの統合:** ログをBigQueryにエクスポートして、詳細な分析とクエリを行います。
* **ログベースのメトリクス:** ログデータからカスタムメトリクスを作成し、監視とアラートに使用します。

### ログの流れ

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

基本的には、シンクとログベースのメトリクスがログが保存される場所を決定します。

### GCP Loggingによってサポートされる設定

Cloud Loggingは、多様な運用ニーズに合わせて高度に設定可能です:

1. **ログバケット (ウェブ上のログストレージ):** Cloud Loggingでバケットを定義し、**ログ保持**を管理し、ログエントリが保持される期間を制御します。
* デフォルトでは、バケット`_Default`と`_Required`が作成されます（一方が他方がログしないものをログします）。
*   **\_Required** は以下の通りです:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* データの**保持期間**はバケットごとに設定され、**最低1日**でなければなりません。ただし、**\_Requiredの保持期間は400日**で、変更することはできません。
* ログバケットは**Cloud Storageでは見えない**ことに注意してください。
2. **ログシンク (ウェブ上のログルーター):** **フィルター**に基づいてログエントリをPub/Sub、BigQuery、またはCloud Storageなどのさまざまな宛先に**エクスポートする**シンクを作成します。
* **デフォルト**では、バケット`_Default`と`_Required`のシンクが作成されます:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **除外フィルター:** 特定のログエントリが取り込まれないように**除外を設定する**ことが可能で、コストを節約し、不要なノイズを減らすことができます。
3. **ログベースのメトリクス:** ログの内容に基づいた**カスタムメトリクス**を設定し、ログデータに基づいてアラートと監視を行います。
4. **ログビュー:** ログビューは、ログバケット内のログへのアクセスを制御するための高度で**詳細な制御を提供します**。&#x20;
* Cloud Loggingは、すべてのバケットに対して`_AllLogs`ビューを**自動的に作成します**。これにより、すべてのログが表示されます。Cloud Loggingはまた、`_Default`バケットに対して`_Default`というビューを作成します。`_Default`バケットの`_Default`ビューは、データアクセス監査ログを除くすべてのログを表示します。`_AllLogs`と`_Default`のビューは編集できません。



特定のログビューのみを使用するようにプリンシパルを許可することが可能です。IAMポリシーは次のようになります:
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
### 列挙

`gcloud` コマンドラインツールはGCPエコシステムの不可欠な部分であり、リソースとサービスを管理することができます。以下は、`gcloud` を使用してログ設定を管理し、ログにアクセスする方法です。

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

**`cloudresourcemanager`** のログを確認する例（BF権限に使用される）: [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

**`testIamPermissions`** のログはありません：

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### 悪用後の活動

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### 持続性

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## 参考文献

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で AWS ハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) コレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**テレグラムグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを**共有する**。

</details>
