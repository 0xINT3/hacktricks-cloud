# GCP - Uorodheshaji wa Kuingiza

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Huduma hii inaruhusu watumiaji kuhifadhi, kutafuta, kuchambua, kufuatilia, na kutoa **data za logi na matukio** kutoka GCP.

Uorodheshaji wa Buluu umejumuishwa kabisa na huduma zingine za GCP, ikitoa hifadhi ya kati kwa logi kutoka kwa rasilimali zako zote za GCP. **Inakusanya logi moja kwa moja kutoka kwa huduma mbalimbali za GCP** kama App Engine, Compute Engine, na Cloud Functions. Unaweza pia kutumia Uorodheshaji wa Buluu kwa maombi yanayoendesha kwenye tovuti au katika mawingu mengine kwa kutumia wakala au API ya Uorodheshaji wa Buluu.

Vipengele muhimu:

* **Ukuzaji wa Data za Logi:** Unganisha data za logi kutoka vyanzo mbalimbali, kutoa mtazamo wa kina wa maombi na miundombinu yako.
* **Usimamizi wa Logi Halisi:** Pasha logi kwa wakati halisi kwa uchambuzi na majibu ya haraka.
* **Uchambuzi wa Data wenye Nguvu:** Tumia uwezo wa kuchuja na kutafuta kwa ustadi kupitia kiasi kikubwa cha data za logi haraka.
* **Uingiliano na BigQuery:** Toa logi kwa BigQuery kwa uchambuzi na uulizaji wa kina.
* **Vipimo vya Logi kulingana na Logi:** Unda vipimo vya desturi kutoka kwa data za logi zako kwa ufuatiliaji na kutuma arifa.

### Mchakato wa Logi

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Kimsingi, visima na vipimo vya logi vitafanya uamuzi wa wapi logi inapaswa kuhifadhiwa.

### Vipimo Vinavyoungwa Mkono na Uorodheshaji wa Buluu wa GCP

Uorodheshaji wa Buluu unaweza kubadilishwa kwa kiasi kikubwa ili kukidhi mahitaji mbalimbali ya uendeshaji:

1. **Maboksi ya Logi (Uhifadhi wa Logi kwenye wavuti):** Taja maboksi katika Uorodheshaji wa Buluu kusimamia **uhifadhi wa logi**, kutoa udhibiti juu ya muda gani kumbukumbu zako za logi zitahifadhiwa.
* Kwa chaguo-msingi maboksi `_Default` na `_Required` hujengwa (moja inalogi kile nyingine haifanyi).
*   **\_Required** ni:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* **Kipindi cha uhifadhi** wa data huwekwa kwa kila sanduku na lazima kiwe **sio chini ya siku 1.** Hata hivyo, **kipindi cha uhifadhi cha \_Required ni siku 400** na hakiwezi kubadilishwa.
* Tafadhali kumbuka kuwa Maboksi ya Logi **hayapo wazi katika Uhifadhi wa Buluu.**
2. **Visima vya Logi (Mwongozaji wa Logi kwenye wavuti):** Unda visima kutoa **kuingiza kumbukumbu za logi** kwenye vituo mbalimbali kama Pub/Sub, BigQuery, au Uhifadhi wa Buluu kulingana na **kichujio**.
* Kwa **chaguo-msingi** visima kwa maboksi `_Default` na `_Required` hujengwa:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Vichujio vya Kutenga:** Inawezekana kuweka **kutenga kuzuia kuingizwa kwa kumbukumbu za logi maalum**, kupunguza gharama, na kupunguza kelele isiyo ya lazima.
3. **Vipimo vya Logi kulingana na Logi:** Weka **vipimo vya desturi** kulingana na maudhui ya logi, kuruhusu arifa na ufuatiliaji kulingana na data za logi.
4. **Maoni ya Logi:** Maoni ya logi hutoa udhibiti wa juu na **wa kina juu ya nani anaye na upatikanaji** wa logi ndani ya maboksi yako ya logi.&#x20;
* Uorodheshaji wa Buluu **unajenga moja kwa moja maoni ya `_AllLogs` kwa kila sanduku**, ambayo inaonyesha logi zote. Uorodheshaji wa Buluu pia hujenga maoni kwa sanduku la `_Default` linaloitwa `_Default`. Maoni ya `_Default` kwa sanduku la `_Default` inaonyesha logi zote isipokuwa logi za ukaguzi wa Upatikanaji wa Data. Maoni ya `_AllLogs` na `_Default` hayawezi kuhaririwa.



Inawezekana kuruhusu msingi **kutumia maoni maalum ya Logi** na sera ya IAM kama:
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
### Kumbukumbu za Kawaida

Kwa chaguo-msingi, operesheni za **Andika Msimamizi** (zinaitwa pia kama kumbukumbu za ukaguzi wa Shughuli za Msimamizi) ndizo zinazorekodiwa (andika metadata au maelezo ya usanidi) na **hazitaweza kuzimwa**.

Kisha, mtumiaji anaweza kuwezesha **Kumbukumbu za Ukaguzi wa Upatikanaji wa Data**, hizi ni **Soma ya Msimamizi, Andika Data na Soma ya Data**.

Unaweza kupata habari zaidi kuhusu kila aina ya kumbukumbu katika nyaraka: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Hata hivyo, elewa kwamba hii inamaanisha kwamba kwa chaguo-msingi vitendo vya **`GetIamPolicy`** na vitendo vingine vya kusoma **havirekodiwi**. Kwa hiyo, kwa chaguo-msingi, mshambuliaji anayejaribu kutambua mazingira hatachukuliwa hatua ikiwa msimamizi wa mfumo hajaweza kusanidi kuzalisha kumbukumbu zaidi.

Ili kuwezesha kumbukumbu zaidi kwenye konsoli, msimamizi wa mfumo anahitaji kwenda [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) na kuziwezesha. Kuna chaguo 2 tofauti:

* **Usanidi wa Kawaida**: Inawezekana kuunda usanidi wa kawaida na kurekodi kumbukumbu zote za Soma ya Msimamizi na/au Soma ya Data na/au Andika Data na hata kuongeza mabwana waliopewa msamaha:

<figure><img src="../../../.gitbook/assets/image (149).png" alt=""><figcaption></figcaption></figure>

* **Chagua huduma**: Au tu **chagua huduma** unazotaka kuzalisha kumbukumbu na aina ya kumbukumbu na bwana aliye na msamaha kwa huduma hiyo maalum.

Pia elewa kwamba kwa chaguo-msingi kumbukumbu hizo pekee zinazalishwa kwa sababu kuzalisha kumbukumbu zaidi kutasababisha ongezeko la gharama.

### Urambazaji

Zana ya amri ya `gcloud` ni sehemu muhimu ya mfumo wa GCP, ikiruhusu kusimamia rasilimali na huduma zako. Hapa ndio jinsi unavyoweza kutumia `gcloud` kusimamia usanidi wako wa kumbukumbu na kupata kumbukumbu za ufikiaji.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Mfano wa kuangalia logs za **`cloudresourcemanager`** (ile inayotumiwa kwa BF permissions): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Hakuna logs za **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### Baada ya Uvamizi

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Uimara

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Marejeo

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
