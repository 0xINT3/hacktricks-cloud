# GCP - Kuchunguza Kuingia

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalam wa juu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya HackTricks AWS)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Huduma hii inaruhusu watumiaji kuhifadhi, kutafuta, kuchambua, kufuatilia, na kutoa tahadhari kuhusu **data za kuingia na matukio** kutoka GCP.

Kuingia kwa Cloud imejumuishwa kabisa na huduma zingine za GCP, ikitoa hifadhi ya kati ya kuingia kutoka kwa rasilimali zako zote za GCP. **Inakusanya kiotomatiki kuingia kutoka kwa huduma mbalimbali za GCP** kama App Engine, Compute Engine, na Cloud Functions. Unaweza pia kutumia Kuingia kwa Cloud kwa maombi yanayoendeshwa kwenye tovuti au kwenye mawingu mengine kwa kutumia wakala au API ya Kuingia kwa Cloud.

Vipengele muhimu:

* **Ukuzaji wa Data za Kuingia:** Unganisha data za kuingia kutoka vyanzo mbalimbali, kutoa mtazamo wa kina wa maombi na miundombinu yako.
* **Usimamizi wa Kuingia wa Wakati Halisi:** Toa data za kuingia kwa wakati halisi kwa uchambuzi na majibu ya haraka.
* **Uchambuzi wenye Nguvu wa Data:** Tumia uwezo wa kuchuja na kutafuta wa juu kuchuja data kubwa za kuingia haraka.
* **Unganisho na BigQuery:** Toa data za kuingia kwa BigQuery kwa uchambuzi na uulizaji wa kina.
* **Vipimo vya Kulingana na Kuingia:** Unda vipimo vya desturi kutoka kwa data yako ya kuingia kwa ufuatiliaji na kutuma tahadhari.

### Mchakato wa Kuingia

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Kimsingi, visima na vipimo vya kulingana na kuingia vitachagua wapi kuingia inapaswa kuhifadhiwa.

### Vipimo Vinavyoungwa Mkono na Kuingia kwa GCP

Kuingia kwa Cloud inaweza kubadilishwa kwa kiasi kikubwa ili kukidhi mahitaji mbalimbali ya uendeshaji:

1. **Maboksi ya Kuingia (Hifadhi ya Kuingia kwenye wavuti):** Taja maboksi katika Kuingia kwa Cloud kusimamia **kutunza kuingia**, kutoa udhibiti juu ya muda gani matokeo yako ya kuingia yanahifadhiwa.
* Kwa chaguo-msingi maboksi `_Default` na `_Required` hujengwa (moja inaingia kile ambacho kingine hakifanyi hivyo).
*   **\_Required** ni:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* **Muda wa kutunza** data unaweza kubadilishwa kwa kila boksi na lazima uwe **angalau siku 1.** Hata hivyo, **muda wa kutunza wa \_Required ni siku 400** na hauwezi kubadilishwa.
* Tafadhali kumbuka kuwa Maboksi ya Kuingia **hayapo wazi katika Uhifadhi wa Cloud.**
2. **Visima vya Kuingia (Mwongozaji wa Kuingia kwenye wavuti):** Unda visima kutoa **kuingiza matokeo ya kuingia** kwenye vituo mbalimbali kama Pub/Sub, BigQuery, au Uhifadhi wa Cloud kulingana na **kichujio**.
* Kwa **chaguo-msingi** visima kwa maboksi `_Default` na `_Required` hujengwa:
* ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Vichujio vya Kutenga:** Inawezekana kuweka **kutenga kuzuia matokeo maalum ya kuingia** kuingizwa, kuokoa gharama, na kupunguza kelele isiyo ya lazima.
3. **Vipimo vya Kulingana na Kuingia:** Sanidi **vipimo vya desturi** kulingana na maudhui ya kuingia, kuruhusu tahadhari na ufuatiliaji kulingana na data ya kuingia.
4. **Maoni ya Kuingia:** Maoni ya kuingia hutoa udhibiti wa juu na **wa kina juu ya nani anaye na upatikanaji** wa kuingia ndani ya maboksi yako ya kuingia.&#x20;
* Kuingia kwa Cloud **kwa kiotomatiki hujenga maoni ya `_AllLogs` kwa kila boksi**, ambayo inaonyesha kila kuingia. Kuingia kwa Cloud pia hujenga maoni kwa boksi ya `_Default` inayoitwa `_Default`. Maoni ya `_Default` kwa boksi ya `_Default` inaonyesha kila kuingia isipokuwa kuingia za ukaguzi wa Upatikanaji wa Data. Maoni ya `_AllLogs` na `_Default` hayawezi kuhaririwa.



Inawezekana kuruhusu mwandishi **atumie maoni maalum ya Kuingia** tu na sera ya IAM kama:
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
### Kumbukumbu za Kimsingi

Kwa chaguo-msingi, operesheni za **Andmin Write** (zinazoitwa pia kama kumbukumbu za ukaguzi wa shughuli za Admin) ndizo zinazorekodiwa (kuandika metadata au maelezo ya usanidi) na **hazitaweza kuzimwa**.

Kisha, mtumiaji anaweza kuwezesha **Kumbukumbu za Ukaguzi wa Upatikanaji wa Data**, hizi ni **Admin Read, Data Write na Data Write**.

Unaweza kupata maelezo zaidi kuhusu kila aina ya kumbukumbu katika nyaraka: [https://cloud.google.com/iam/docs/audit-logging](https://cloud.google.com/iam/docs/audit-logging)

Hata hivyo, elewa kwamba hii inamaanisha kwamba kwa chaguo-msingi vitendo vya **`GetIamPolicy`** na vitendo vingine vya kusoma **havirekodiwi**. Kwa hivyo, kwa chaguo-msingi, mshambuliaji anayejaribu kutambua mazingira hatachukuliwa hatua ikiwa msimamizi wa mfumo hajaweza kusanidi kuzalisha kumbukumbu zaidi.

Ili kuwezesha kumbukumbu zaidi kwenye konsoli, msimamizi wa mfumo anahitaji kwenda kwenye [https://console.cloud.google.com/iam-admin/audit](https://console.cloud.google.com/iam-admin/audit) na kuziwezesha. Kuna chaguo 2 tofauti:

* **Usanidi wa Kimsingi**: Inawezekana kuunda usanidi wa kimsingi na kurekodi kumbukumbu zote za Admin Read na/au Data Read na/au Data Write na hata kuongeza mabwana waliopewa msamaha:

<figure><img src="../../../.gitbook/assets/image (149).png" alt=""><figcaption></figcaption></figure>

* **Chagua Huduma**: Au tu **chagua huduma** unazotaka kuzalisha kumbukumbu na aina ya kumbukumbu na mabwana waliopewa msamaha kwa huduma hiyo maalum.

Pia elewa kwamba kwa chaguo-msingi kumbukumbu hizo pekee zinazalishwa kwa sababu kuzalisha kumbukumbu zaidi kutasababisha ongezeko la gharama.

### Uchambuzi

Zana ya amri ya mstari wa `gcloud` ni sehemu muhimu ya mfumo wa GCP, ikiruhusu kusimamia rasilimali na huduma zako. Hapa ndio jinsi unavyoweza kutumia `gcloud` kusimamia usanidi wako wa kumbukumbu na kupata kumbukumbu za ufikiaji.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
Example ya kuangalia logs za **`cloudresourcemanager`** (ile inayotumika kwa BF permissions): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Hakuna logs za **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### Baada ya Uvamizi

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Uthabiti

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Marejeo

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
