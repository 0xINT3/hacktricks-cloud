# GCP - Enumeraci√≥n de Logging

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

Este servicio permite a los usuarios almacenar, buscar, analizar, monitorear y alertar sobre **datos de logs y eventos** de GCP.

Cloud Logging est√° completamente integrado con otros servicios de GCP, proporcionando un repositorio centralizado para logs de todos tus recursos de GCP. **Recopila autom√°ticamente logs de varios servicios de GCP** como App Engine, Compute Engine y Cloud Functions. Tambi√©n puedes usar Cloud Logging para aplicaciones que se ejecutan en las instalaciones o en otras nubes utilizando el agente de Cloud Logging o la API.

Caracter√≠sticas Clave:

* **Centralizaci√≥n de Datos de Logs:** Agrega datos de logs de varias fuentes, ofreciendo una visi√≥n integral de tus aplicaciones e infraestructura.
* **Gesti√≥n de Logs en Tiempo Real:** Transmite logs en tiempo real para an√°lisis y respuesta inmediatos.
* **An√°lisis de Datos Potente:** Utiliza capacidades avanzadas de filtrado y b√∫squeda para examinar r√°pidamente grandes vol√∫menes de datos de logs.
* **Integraci√≥n con BigQuery:** Exporta logs a BigQuery para an√°lisis detallado y consultas.
* **M√©tricas Basadas en Logs:** Crea m√©tricas personalizadas a partir de tus datos de logs para monitoreo y alertas.

### Flujo de Logs

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

B√°sicamente, los sinks y las m√©tricas basadas en logs decidir√°n d√≥nde se debe almacenar un log.

### Configuraciones Soportadas por GCP Logging

Cloud Logging es altamente configurable para adaptarse a diversas necesidades operativas:

1. **Log Buckets (Almacenamiento de logs en la web):** Define buckets en Cloud Logging para gestionar la **retenci√≥n de logs**, proporcionando control sobre cu√°nto tiempo se retienen tus entradas de logs.
   * Por defecto se crean los buckets `_Default` y `_Required` (uno registra lo que el otro no).
   * **\_Required** es:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
   * El **periodo de retenci√≥n** de los datos se configura por bucket y debe ser **al menos de 1 d√≠a.** Sin embargo, el **periodo de retenci√≥n de \_Required es de 400 d√≠as** y no se puede modificar.
   * Ten en cuenta que los Log Buckets **no son visibles en Cloud Storage.**
2. **Log Sinks (Router de logs en la web):** Crea sinks para **exportar entradas de logs** a varios destinos como Pub/Sub, BigQuery o Cloud Storage bas√°ndose en un **filtro**.
   * Por **defecto** se crean sinks para los buckets `_Default` y `_Required`:
   * ```bash
_Required  logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<proj-name>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
   * **Filtros de Exclusi√≥n:** Es posible configurar **exclusiones para prevenir entradas de logs espec√≠ficas** de ser ingestadas, ahorrando costos y reduciendo ruido innecesario.
3. **M√©tricas Basadas en Logs:** Configura **m√©tricas personalizadas** basadas en el contenido de los logs, permitiendo alertas y monitoreo basado en datos de logs.
4. **Vistas de Logs:** Las vistas de logs ofrecen control avanzado y **granular sobre qui√©n tiene acceso** a los logs dentro de tus buckets de logs.&#x20;
   * Cloud Logging **crea autom√°ticamente la vista `_AllLogs` para cada bucket**, que muestra todos los logs. Cloud Logging tambi√©n crea una vista para el bucket `_Default` llamada `_Default`. La vista `_Default` para el bucket `_Default` muestra todos los logs excepto los logs de auditor√≠a de Acceso a Datos. Las vistas `_AllLogs` y `_Default` no son editables.

Es posible permitir que un principal **solo use una vista de Log espec√≠fica** con una pol√≠tica de IAM como:
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
### Enumeraci√≥n

La herramienta de l√≠nea de comandos `gcloud` es una parte integral del ecosistema de GCP, que te permite gestionar tus recursos y servicios. Aqu√≠ te mostramos c√≥mo puedes usar `gcloud` para gestionar tus configuraciones de registro y acceder a los registros.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
### Post Explotaci√≥n

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
