# GCP - Enumerazione dei registri

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

Questo servizio consente agli utenti di archiviare, cercare, analizzare, monitorare e segnalare **dati di registro ed eventi** da GCP.

Cloud Logging √® completamente integrato con altri servizi GCP, fornendo un repository centralizzato per i registri di tutte le risorse GCP. Raccoglie automaticamente i registri da vari servizi GCP come App Engine, Compute Engine e Cloud Functions. √à anche possibile utilizzare Cloud Logging per le applicazioni in esecuzione in locale o in altri cloud utilizzando l'agente o l'API di Cloud Logging.

Funzionalit√† chiave:

* **Centralizzazione dei dati di registro:** Aggrega i dati di registro da varie fonti, offrendo una visione olistica delle tue applicazioni e infrastrutture.
* **Gestione dei registri in tempo reale:** Trasmetti i registri in tempo reale per un'analisi e una risposta immediate.
* **Potente analisi dei dati:** Utilizza filtri avanzati e capacit√† di ricerca per selezionare rapidamente grandi volumi di dati di registro.
* **Integrazione con BigQuery:** Esporta i registri in BigQuery per un'analisi e una query dettagliate.
* **Metriche basate sui registri:** Crea metriche personalizzate dai dati di registro per il monitoraggio e l'allerta.

### Flusso dei registri

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption><p><a href="https://betterstack.com/community/guides/logging/gcp-logging/">https://betterstack.com/community/guides/logging/gcp-logging/</a></p></figcaption></figure>

Fondamentalmente, i sink e le metriche basate sui registri determinano dove un registro dovrebbe essere archiviato.

### Configurazioni supportate da GCP Logging

Cloud Logging √® altamente configurabile per soddisfare diverse esigenze operative:

1. **Secchi dei registri (Archiviazione dei registri nel web):** Definisci secchi in Cloud Logging per gestire la **conservazione dei registri**, fornendo un controllo sulla durata della conservazione delle voci di registro.
* Per impostazione predefinita vengono creati i secchi `_Default` e `_Required` (uno registra ci√≤ che l'altro non registra).
*   **\_Required** √®:

{% code overflow="wrap" %}
```bash
LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
```
{% endcode %}
* Il **periodo di conservazione** dei dati √® configurato per secchio e deve essere **almeno di 1 giorno**. Tuttavia, il periodo di conservazione di \_Required √® di 400 giorni e non pu√≤ essere modificato.
* Nota che i secchi dei registri **non sono visibili in Cloud Storage**.
2. **Sink dei registri (Router dei registri nel web):** Crea sink per **esportare le voci di registro** verso diverse destinazioni come Pub/Sub, BigQuery o Cloud Storage in base a un **filtro**.
* Per impostazione **predefinita** vengono creati sink per i secchi `_Default` e `_Required`:
* ```bash
_Required  logging.googleapis.com/projects/<nome-progetto>/locations/global/buckets/_Required  LOG_ID("cloudaudit.googleapis.com/activity") OR LOG_ID("externalaudit.googleapis.com/activity") OR LOG_ID("cloudaudit.googleapis.com/system_event") OR LOG_ID("externalaudit.googleapis.com/system_event") OR LOG_ID("cloudaudit.googleapis.com/access_transparency") OR LOG_ID("externalaudit.googleapis.com/access_transparency")
_Default   logging.googleapis.com/projects/<nome-progetto>/locations/global/buckets/_Default   NOT LOG_ID("cloudaudit.googleapis.com/activity") AND NOT LOG_ID("externalaudit.googleapis.com/activity") AND NOT LOG_ID("cloudaudit.googleapis.com/system_event") AND NOT LOG_ID("externalaudit.googleapis.com/system_event") AND NOT LOG_ID("cloudaudit.googleapis.com/access_transparency") AND NOT LOG_ID("externalaudit.googleapis.com/access_transparency")
```
* **Filtri di esclusione:** √à possibile configurare **esclusioni per impedire l'ingestione di voci di registro specifiche**, risparmiando costi e riducendo il rumore superfluo.
3. **Metriche basate sui registri:** Configura **metriche personalizzate** basate sul contenuto dei registri, consentendo l'allerta e il monitoraggio basati sui dati di registro.
4. **Visualizzazioni dei registri:** Le visualizzazioni dei registri offrono un controllo avanzato e **granulare su chi ha accesso** ai registri all'interno dei secchi dei registri.&#x20;
* Cloud Logging crea automaticamente la visualizzazione `_AllLogs` per ogni secchio, che mostra tutti i registri. Cloud Logging crea anche una visualizzazione per il secchio `_Default` chiamata `_Default`. La visualizzazione `_Default` per il secchio `_Default` mostra tutti i registri tranne i registri di accesso ai dati. Le visualizzazioni `_AllLogs` e `_Default` non sono modificabili.

√à possibile consentire a un principale **di utilizzare solo una visualizzazione specifica dei registri** con una policy IAM come:
```json
{
"bindings": [
{
"members": [
"user:username@gmail.com"
],
"role": "roles/logging.viewAccessor",
"condition": {
"title": "Bucket reader condition example",
"description": "Grants logging.viewAccessor role to user username@gmail.com for the VIEW_ID log view.",
"expression":
"resource.name == \"projects/PROJECT_ID/locations/LOCATION/buckets/BUCKET_NAME/views/VIEW_ID\""
}
}
],
"etag": "BwWd_6eERR4=",
"version": 3
}
```
### Enumerazione

Lo strumento da riga di comando `gcloud` √® una parte integrante dell'ecosistema GCP, che ti consente di gestire le tue risorse e servizi. Ecco come puoi utilizzare `gcloud` per gestire le tue configurazioni di registrazione e accedere ai log.

{% code overflow="wrap" %}
```bash
# List buckets
gcloud logging buckets list
gcloud logging buckets describe <bucket-name> --location <location>

# List log entries: only logs that contain log entries are listed.
gcloud logging logs list

# Get log metrics
gcloud logging metrics list
gcloud logging metrics describe <metric-name>

# Get log sinks
gcloud logging sinks list
gcloud logging sinks describe <sink-name>

# Get log views
gcloud logging views list --bucket <bucket> --location global
gcloud logging views describe --bucket <bucket> --location global <view-id> # view-id is usually the same as the bucket name

# Get log links
gcloud logging links list --bucket _Default --location global
gcloud logging links describe <link-id> --bucket _Default --location global
```
{% endcode %}

Esempio per controllare i registri di **`cloudresourcemanager`** (quello utilizzato per BF le autorizzazioni): [https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512](https://console.cloud.google.com/logs/query;query=protoPayload.serviceName%3D%22cloudresourcemanager.googleapis.com%22;summaryFields=:false:32:beginning;cursorTimestamp=2024-01-20T00:07:14.482809Z;startTime=2024-01-01T11:12:26.062Z;endTime=2024-02-02T17:12:26.062Z?authuser=2\&project=digital-bonfire-410512)

Non ci sono registri di **`testIamPermissions`**:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### Post Esploitation

{% content-ref url="../gcp-post-exploitation/gcp-logging-post-exploitation.md" %}
[gcp-logging-post-exploitation.md](../gcp-post-exploitation/gcp-logging-post-exploitation.md)
{% endcontent-ref %}

### Persistenza

{% content-ref url="../gcp-persistence/gcp-logging-persistence.md" %}
[gcp-logging-persistence.md](../gcp-persistence/gcp-logging-persistence.md)
{% endcontent-ref %}

## Riferimenti

* [https://cloud.google.com/logging/docs/logs-views#gcloud](https://cloud.google.com/logging/docs/logs-views#gcloud)
* [https://betterstack.com/community/guides/logging/gcp-logging/](https://betterstack.com/community/guides/logging/gcp-logging/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
