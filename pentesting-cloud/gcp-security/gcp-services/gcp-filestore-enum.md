# GCP - Enumera√ß√£o do Filestore

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

O Google Cloud Filestore √© um **servi√ßo de armazenamento de arquivos gerenciado** projetado para aplicativos que precisam de **uma interface de sistema de arquivos e um sistema de arquivos compartilhado para dados**. Este servi√ßo se destaca por oferecer compartilhamento de arquivos de alto desempenho, que podem ser integrados com v√°rios servi√ßos do GCP. Sua utilidade brilha em cen√°rios onde interfaces e sem√¢nticas de sistema de arquivos tradicionais s√£o cruciais, como no processamento de m√≠dia, gerenciamento de conte√∫do e backup de bancos de dados.

Voc√™ pode pensar nisso como qualquer outro **reposit√≥rio de documentos compartilhados NFS** - uma fonte potencial de informa√ß√µes sens√≠veis.

### Conex√µes

Ao criar uma inst√¢ncia do Filestore, √© poss√≠vel **selecionar a rede onde ela ser√° acess√≠vel**.

Al√©m disso, por **padr√£o, todos os clientes na rede VPC e regi√£o selecionadas poder√£o acess√°-la**, no entanto, √© poss√≠vel **restringir o acesso tamb√©m por endere√ßo IP** ou intervalo e indicar o privil√©gio de acesso (Administrador, Visualizador de Administrador, Editor, Visualizador) que o cliente vai obter **dependendo do endere√ßo IP**.

Tamb√©m pode ser acess√≠vel por meio de uma **Conex√£o de Acesso a Servi√ßos Privados:**

* S√£o por rede VPC e podem ser usados em todos os servi√ßos gerenciados, como Memorystore, Tensorflow e SQL.
* S√£o **entre sua rede VPC e a rede de propriedade do Google usando um VPC peering**, permitindo que suas inst√¢ncias e servi√ßos se comuniquem exclusivamente **usando endere√ßos IP internos**.
* Cria um projeto isolado para voc√™ no lado do produtor de servi√ßos, o que significa que nenhum outro cliente o compartilha. Voc√™ ser√° cobrado apenas pelos recursos que provisionar.
* O VPC peering importar√° novas rotas para sua VPC

### Backups

√â poss√≠vel criar **backups dos compartilhamentos de arquivos**. Estes podem ser posteriormente **restaurados na origem** da nova inst√¢ncia de Fileshare ou em **novas**.

### Criptografia

Por padr√£o, uma **chave de criptografia gerenciada pelo Google** ser√° usada para criptografar os dados, mas √© poss√≠vel selecionar uma **chave de criptografia gerenciada pelo cliente (CMEK)**.

### Enumera√ß√£o

Se voc√™ encontrar um filestore dispon√≠vel no projeto, voc√™ pode **mont√°-lo** de dentro da sua Inst√¢ncia de Computa√ß√£o comprometida. Use o seguinte comando para ver se algum existe.

{% code overflow="wrap" %}
```bash
# Instances
gcloud filestore instances list # Check the IP address
gcloud filestore instances describe --zone <zone> <name> # Check IP and access restrictions

# Backups
gcloud filestore backups list
gcloud filestore backups describe --region <region> <backup>

# Search for NFS shares in a VPC subnet
sudo nmap -n -T5 -Pn -p 2049 --min-parallelism 100 --min-rate 1000 --open 10.99.160.2/20
```
{% endcode %}

{% hint style="danger" %}
Note que um servi√ßo de armazenamento de arquivos pode estar em uma **sub-rede completamente nova criada para ele** (dentro de uma Conex√£o de Acesso a Servi√ßos Privados, que √© um **peer VPC**).\
Portanto, pode ser necess√°rio **enumerar os peers VPC** para tamb√©m executar o nmap nessas faixas de rede.

{% code overflow="wrap" %}
```bash
# Get peerings
gcloud compute networks peerings list
# Get routes imported from a peering
gcloud compute networks peerings list-routes <peering-name> --network=<network-name> --region=<region> --direction=INCOMING
```
### Escala√ß√£o de Privil√©gios e P√≥s-Explora√ß√£o

N√£o h√° maneiras de escalar privil√©gios no GCP abusando diretamente deste servi√ßo, mas usando alguns truques de **P√≥s-Explora√ß√£o √© poss√≠vel acessar os dados** e talvez voc√™ consiga encontrar algumas credenciais para escalar privil√©gios:

{% content-ref url="../gcp-post-exploitation/gcp-filestore-post-exploitation.md" %}
[gcp-filestore-post-exploitation.md](../gcp-post-exploitation/gcp-filestore-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../gcp-persistence/gcp-filestore-persistence.md" %}
[gcp-filestore-persistence.md](../gcp-persistence/gcp-filestore-persistence.md)
{% endcontent-ref %}
