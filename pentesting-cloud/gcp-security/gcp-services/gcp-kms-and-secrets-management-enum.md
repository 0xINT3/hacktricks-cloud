# GCP - KMS 管理员枚举

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/) 是一个用于**存储加密密钥**的存储库，例如用于**加密和解密敏感文件**的密钥。单个密钥存储在密钥环中，并且可以在任何级别应用细粒度权限。

KMS 密钥环默认为全局创建，这意味着该密钥环中的密钥可以从任何区域访问。但是，可以在特定区域创建特定的密钥环。

### 密钥保护级别

* **软件密钥**：软件密钥完全由 KMS 在软件中创建和管理。这些密钥**不受任何硬件安全模块 (HSM) 保护**，可以用于测试和开发目的。由于提供的安全性较低且容易受到攻击，不建议在生产环境中使用软件密钥。
* **云托管密钥**：云托管密钥由 KMS 在云中使用高可用性和可靠性的基础设施创建和管理。这些密钥受到 HSM 的保护，但 HSM 并不专门为特定客户而设。云托管密钥适用于大多数生产用例。
* **外部密钥**：外部密钥在 KMS 之外创建和管理，并导入到 KMS 用于加密操作。外部密钥可以存储在硬件安全模块 (HSM) 或软件库中，具体取决于客户的偏好。

### 密钥用途

* **对称加密/解密**：用于使用单个密钥进行数据加密和解密的操作。对称密钥适用于加密和解密大量数据的快速高效操作。
* **支持的操作**：[cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt)，[cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **非对称签名**：用于两个参与方之间的安全通信，而无需共享密钥。非对称密钥由一对公钥和私钥组成。公钥与他人共享，而私钥保密。
* **支持的操作**：[cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign)，[cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **非对称解密**：用于验证消息或数据的真实性。使用私钥创建数字签名，可以使用相应的公钥进行验证。
* **支持的操作**：[cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt)，[cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC 签名**：使用秘密密钥创建消息认证码 (MAC) 来确保数据的完整性和真实性。HMAC 在网络协议和软件应用程序中常用于消息认证。
* **支持的操作**：[cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign)，[cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### 旋转周期和销毁计划周期

默认情况下，每个密钥的旋转周期为**90天**，但可以**轻松**和**完全自定义**。

"销毁计划"周期是用户要求删除密钥的时间，直到密钥被删除为止。在密钥创建后无法更改（默认为1天）。

### 枚举

如果**具有列出密钥的权限**，可以按以下方式访问它们：
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### 提权

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问最新版本的 PEASS 或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
