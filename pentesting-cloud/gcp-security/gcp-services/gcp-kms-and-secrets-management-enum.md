# GCP - KMS Manager Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/)は、**暗号キーを保存するためのリポジトリ**であり、**機密ファイルの暗号化と復号化に使用されるキー**などが格納されます。個々のキーはキーリングに保存され、両方のレベルで細かい権限を適用することができます。

KMSキーリングは、**デフォルトでグローバルに作成**されるため、そのキーリング内のキーはどのリージョンからでもアクセスできます。ただし、**特定のリージョン**に特定のキーリングを作成することも可能です。

### キーの保護レベル

* **ソフトウェアキー**：ソフトウェアキーは、KMSによって完全にソフトウェアで作成および管理されます。これらのキーは**ハードウェアセキュリティモジュール（HSM）で保護されていません**が、**テストおよび開発目的**に使用することができます。ソフトウェアキーは、セキュリティが低く攻撃に対して脆弱なため、**本番環境では推奨されていません**。
* **クラウドホストキー**：クラウドホストキーは、高可用性かつ信頼性の高いインフラストラクチャを使用して、KMSによってクラウドで作成および管理されます。これらのキーは**HSMによって保護されています**が、HSMは**特定の顧客に専用ではありません**。クラウドホストキーは、ほとんどの本番環境で使用できます。
* **外部キー**：外部キーは、KMSの外部で作成および管理され、暗号操作で使用するためにKMSにインポートされます。外部キーは、**顧客の選択に応じてハードウェアセキュリティモジュール（HSM）またはソフトウェアライブラリに保存**することができます。

### キーの目的

* **対称暗号化/復号化**：単一のキーを使用してデータを暗号化および復号化するために使用されます。対称キーは、大量のデータの暗号化および復号化に対して高速かつ効率的です。
* **サポートされている**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **非対称署名**：キーを共有せずに2つのパーティ間で安全な通信に使用されます。非対称キーは、**公開キーと秘密キー**のペアで構成されます。公開キーは他の人と共有され、秘密キーは秘密に保持されます。
* **サポートされている**: [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **非対称復号化**：メッセージまたはデータの正当性を検証するために使用されます。デジタル署名は、秘密キーを使用して作成され、対応する公開キーを使用して検証することができます。
* **サポートされている**: [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC署名**：秘密キーを使用してメッセージ認証コード（MAC）を作成することで、データの整合性と正当性を確保するために使用されます。HMACは、ネットワークプロトコルやソフトウェアアプリケーションでメッセージ認証に一般的に使用されます。
* **サポートされている**: [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### 回転期間と破棄プログラムの期間

デフォルトでは、**90日ごと**ですが、**簡単に**完全にカスタマイズすることができます。

「破棄プログラムの期間」は、ユーザーがキーの削除を要求してからキーが**削除**されるまでの時間です。キーが作成された後は変更できません（デフォルトは1日）。

### 列挙

キーをリストする**権限**を持っている場合、以下の方法でアクセスできます：
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### 特権昇格

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社をハックトリックで宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れる
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>
