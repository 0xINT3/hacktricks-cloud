# GCP <--> Workspace Pivoting

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## **从GCP到GWS**

### **域范围委托基础知识**

Google Workspace的域范围委托允许一个身份对象，可以是来自Google Workspace Marketplace的**外部应用**或内部的**GCP服务账号**，**代表用户访问**Workspace上的数据。

{% hint style="info" %}
这基本上意味着组织中GCP项目中的**服务账号**可能能够**冒充**同一组织（甚至来自不同组织的）**Workspace用户**。
{% endhint %}

有关此工作原理的更多信息，请查看：

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### 妥协现有委托

如果攻击者**入侵了GCP的某些访问权限**并**知道了公司的有效Workspace用户电子邮件**（最好是**超级管理员**），他可以**枚举所有项目**，他可以访问的**枚举所有SAs**，检查他可以访问的**服务账号**，并**重复**所有这些步骤以冒充每个可以冒充的SA。\
有了他可以访问的**所有服务账号列表**和**Workspace** **电子邮件**列表，攻击者可以尝试使用每个服务账号**冒充用户**。

{% hint style="danger" %}
请注意，在配置域范围委托时不需要Workspace用户，因此只需知道**一个有效用户足以进行冒充**。\
但是，将使用**被冒充用户的权限**，因此如果是超级管理员，则可以访问所有内容。如果没有任何访问权限，则这将是无用的。
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

这是一个可以执行以下步骤的工具：

1. 使用资源管理器API**枚举GCP项目**。
2. 遍历每个项目资源，并使用_GetIAMPolicy_**枚举初始IAM用户有访问权限的GCP服务账号资源**。
3. 遍历**每个服务账号角色**，并查找具有目标服务账号资源上的_**serviceAccountKeys.create**_权限的内置、基本和自定义角色。值得注意的是，编辑器角色固有地具有此权限。
4. 为在IAM策略中找到具有相关权限的每个服务账号资源创建一个**新的`KEY_ALG_RSA_2048`**私钥。
5. 遍历**每个新服务账号并为其创建一个`JWT`** **对象**，该对象由SA私钥凭据和OAuth范围组成。创建新的_JWT_对象的过程将**遍历所有现有的OAuth范围**组合列表**oauth\_scopes.txt**，以查找所有委托可能性。列表**oauth\_scopes.txt**已更新为我们发现与滥用Workspace身份相关的所有OAuth范围。
6. `_make_authorization_grant_assertion`方法揭示了声明**目标Workspace用户**（称为_subject_）的必要性，用于在DWD下生成JWT。虽然这似乎需要特定用户，但重要的是要意识到**DWD影响域内的每个身份**。因此，为**任何域用户**创建JWT会影响该域中的所有身份，与我们的组合枚举检查一致。简而言之，一个有效的Workspace用户足以继续。\
可以在DeleFriend的_config.yaml_文件中定义此用户。如果目标Workspace用户尚未知晓，则该工具通过扫描在GCP项目上具有角色的域用户来自动识别有效的Workspace用户。需要注意的是（再次），JWT是特定于域的，不是为每个用户生成的；因此，自动过程针对每个域的单个唯一身份。
7. **枚举并为每个JWT创建一个新的承载访问令牌**，并针对tokeninfo API验证令牌。

#### [Gitlab的Python脚本](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab创建了[此Python脚本](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)，可以执行两项操作 - 列出用户目录并创建一个新的管理帐户，同时指示具有SA凭据和要冒充的用户的json。以下是如何使用它：
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### 创建新委托（持久性）

可以在[https://admin.google.com/u/1/ac/owl/domainwidedelegation](https://admin.google.com/u/1/ac/owl/domainwidedelegation)中**检查域范围委托**。

拥有在GCP项目中**创建服务账号**和**GWS超级管理员特权**的攻击者可以创建新委托，允许服务账号冒充一些GWS用户：

1. **生成新服务账号和相应的密钥对：** 在GCP上，可以通过控制台交互式地创建新服务账号资源，也可以使用直接API调用和CLI工具进行编程生成。这需要**角色`iam.serviceAccountAdmin`**或任何配备**`iam.serviceAccounts.create`权限**的自定义角色。一旦创建了服务账号，我们将继续生成**相关的密钥对**（**`iam.serviceAccountKeys.create`权限**）。
2. **创建新委托：** 重要的是要理解，**只有超级管理员角色具有在Google Workspace中设置全局域委托的能力**，域委托**不能通过编程方式设置**，只能通过Google Workspace**控制台**手动创建和调整。
   * 规则的创建可以在页面**API控制 → 在Google Workspace管理控制台中管理域委托**下找到。
3. **附加OAuth范围权限：** 在配置新委托时，Google只需要2个参数，即客户端ID，即**GCP服务账号**资源的OAuth ID，以及定义委托需要的**OAuth范围**。
   * 可以在[**这里**](https://developers.google.com/identity/protocols/oauth2/scopes)找到**完整的OAuth范围列表**，但这里有一个建议：`https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **代表目标身份行事：** 此时，在GWS中有一个正常运行的委托对象。现在，**使用GCP服务账号私钥，我们可以执行API调用**（在OAuth范围参数中定义的范围内）来触发它，并**代表Google Workspace中存在的任何身份行事**。正如我们所了解的，服务账号将根据其需要生成访问令牌，并根据其对REST API应用程序的权限进行操作。
   * 检查**前一节**以了解一些**工具**来使用此委托。

#### 跨组织委托

OAuth SA ID是全局的，可用于**跨组织委托**。尚未实施任何限制以防止跨全局委托。简单来说，**来自不同GCP组织的服务账号可以用于在其他Workspace组织上配置域委托**。这将导致**只需要对Workspace具有超级管理员访问权限**，而不需要访问相同的GCP账户，因为对手可以在其个人控制的GCP账户上创建服务账号和私钥。

### 创建用于枚举Workspace的项目

**默认情况下**，Workspace**用户**具有**创建新项目**的权限，当创建新项目时，**创建者将获得Owner角色**。

因此，用户可以**创建一个项目**，**启用**API以在其新项目中枚举Workspace并尝试**枚举**它。

{% hint style="danger" %}
为了使用户能够枚举Workspace，他还需要足够的Workspace权限（并非每个用户都能够枚举目录）。
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

检查**更多枚举**：

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### 滥用 Gcloud

您可以在以下找到有关`gcloud`登录流程的更多信息：

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

如上所述，gcloud 可以请求范围 `https://www.googleapis.com/auth/drive`，这将允许用户访问用户的驱动器。\
作为攻击者，如果您已经**物理**入侵了用户的计算机且**用户仍然登录**，您可以生成一个具有访问驱动器权限的令牌进行登录：
```bash
gcloud auth login --enable-gdrive-access
```
如果攻击者入侵了用户的计算机，他还可以修改文件 `google-cloud-sdk/lib/googlecloudsdk/core/config.py`，在 **`CLOUDSDK_SCOPES`** 中添加作用域 **`'https://www.googleapis.com/auth/drive'`**：

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
因此，下次用户登录时，他将创建一个具有访问驱动器权限的令牌，攻击者可以利用该令牌访问驱动器。显然，浏览器将指示生成的令牌将具有访问驱动器的权限，但由于用户将调用 **`gcloud auth login`**，他可能 **不会怀疑任何事情。**

列出驱动器文件：**`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## 从 GWS 到 GCP

### 访问特权的 GCP 用户

如果攻击者完全控制了 GWS，他将能够访问具有对 GCP 或甚至用户的特权访问权限的组，因此从 GWS 到 GCP 的移动通常更加 "简单"，因为 **GWS 中的用户对 GCP 有高权限**。&#x20;

### Google 组特权升级

默认情况下，用户可以 **自由加入组织的 Workspace 组**，这些组 **可能被分配了 GCP 权限**（检查您的组在 [https://groups.google.com/](https://groups.google.com/)）。

通过滥用 **google groups privesc**，您可能能够升级到具有某种特权访问权限的 GCP 组。

### 参考资料

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的 **公司在 HackTricks 中做广告** 或 **下载 PDF 版本的 HackTricks**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) 上 **关注** 我。
* 通过向 **HackTricks** 和 **HackTricks Cloud** github 仓库提交 PR 来 **分享您的黑客技巧**。

</details>
