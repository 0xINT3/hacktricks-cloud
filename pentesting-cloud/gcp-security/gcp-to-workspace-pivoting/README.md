# GCP <--> Workspace ピボット

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学びましょう</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** または [telegramグループ](https://t.me/peass) に **参加** または **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォロー** してください。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出してください。

</details>

## **GCP から GWS へ**

### **ドメインワイドデリゲーションの基礎**

Google Workspace のドメインワイドデリゲーションは、**Google Workspace Marketplace** の **外部アプリ** または内部の **GCPサービスアカウント** が、**ユーザーを代表してワークスペース全体のデータにアクセス**できるようにする。

{% hint style="info" %}
これは基本的に、組織のGCPプロジェクト内の **サービスアカウント** が、同じ組織のワークスペースユーザー（別の組織からでも可能）を **偽装** できる可能性があることを意味します。
{% endhint %}

これが具体的にどのように機能するかの詳細については、次を確認してください:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### 既存のデリゲーションの妥協

攻撃者が **GCP上でアクセスを妥協** し、会社の **有効なワークスペースユーザーのメールアドレス**（できれば **スーパーアドミン**）を知っている場合、彼はアクセス可能な **すべてのプロジェクトを列挙** し、プロジェクトの **すべてのサービスアカウントを列挙** し、どの **サービスアカウントにアクセスできるか** を確認し、それぞれのSAでこれらの手順を **繰り返す** ことができます。\
アクセス可能な **すべてのサービスアカウントのリスト** と **ワークスペースのメールアドレスのリスト** を持っていると、攻撃者は **各サービスアカウントでユーザーを偽装** しようとすることができます。

{% hint style="danger" %}
ドメインワイドデリゲーションを構成する際には、ワークスペースユーザーは必要ありません。したがって、**1つの有効なユーザーがあれば十分であり、偽装に必要です**。\
ただし、**偽装されたユーザーの権限が使用されます**。つまり、スーパーアドミンであればすべてにアクセスできます。アクセス権がない場合は無意味です。
{% endhint %}

#### [GCP Generate Delegation Token](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

このシンプルなスクリプトは、**委任されたユーザーとしてOAuthトークンを生成**し、その後、`gcloud` を使用して他のGoogle API にアクセスするために使用できます。
```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```
#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

これは、以下の手順に従って攻撃を実行できるツールです：

1. リソースマネージャ APIを使用して、**GCPプロジェクトを列挙**します。
2. 各プロジェクトリソースを繰り返し、初期IAMユーザーがアクセス権限を持つ**GCPサービスアカウントリソースを列挙**します。これは、_GetIAMPolicy_を使用します。
3. **各サービスアカウントロール**を繰り返し、対象のサービスアカウントリソースで _**serviceAccountKeys.create**_ 権限を持つ組み込み、基本、およびカスタムロールを見つけます。エディターロールは、この権限を元々持っていることに注意してください。
4. IAMポリシーで関連する権限を持つ各サービスアカウントリソースに、**新しい `KEY_ALG_RSA_2048`** 秘密鍵を作成します。
5. **各新しいサービスアカウントを繰り返し、`JWT`** **オブジェクト**を作成します。これは、SAプライベートキー資格情報とOAuthスコープで構成され、既存のOAuthスコープの組み合わせをすべて列挙するために、**oauth\_scopes.txt**リストからすべての組み合わせを繰り返します。リスト**oauth\_scopes.txt** は、Workspaceアイデンティティを悪用するために関連性のあるすべてのOAuthスコープが見つかった場合に更新されます。
6. `_make_authorization_grant_assertion`メソッドは、DWDの下でJWTを生成するために**ターゲットのワークスペースユーザー**（_subject_として参照）を宣言する必要性を明らかにします。これは特定のユーザーを必要とするように見えるかもしれませんが、重要なのは**DWDがドメイン内のすべてのアイデンティティに影響を与える**ということです。したがって、**任意のドメインユーザー**のためにJWTを作成することは、そのドメイン内のすべてのアイデンティティに影響を与えます。単純に言えば、1つの有効なWorkspaceユーザーが十分です。\
このユーザーはDeleFriendの _config.yaml_ ファイルで定義できます。対象のワークスペースユーザーが既知でない場合、ツールはGCPプロジェクトにロールを持つドメインユーザーをスキャンして有効なワークスペースユーザーを自動的に特定する機能を提供します。再度注意するが、JWTはドメイン固有であり、すべてのユーザーに対して生成されるわけではないため、自動プロセスはドメインごとに1つのユニークなアイデンティティを対象とします。
7. 各JWTに対して**新しいベアラーアクセストークンを列挙および作成**し、tokeninfo APIでトークンを検証します。

#### [GitlabのPythonスクリプト](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlabは、ユーザーディレクトリをリストアップし、SA資格情報となりすましユーザーを示すjsonを指定して新しい管理アカウントを作成できる[このPythonスクリプト](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)を作成しました。以下は、その使用方法です：
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### 新しい委任の作成（永続性）

[**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**で** **ドメイン全体の委任を確認**することが可能です。

**GCPプロジェクトでサービスアカウントを作成**し、**GWSにスーパー管理者権限がある攻撃者は、SAsが一部のGWSユーザーを偽装する新しい委任を作成できます。**

1. **新しいサービスアカウントと対応するキーペアの生成:** GCPでは、新しいサービスアカウントリソースは、コンソールを介して対話的に作成するか、直接API呼び出しやCLIツールを使用してプログラムで生成できます。これには**`iam.serviceAccountAdmin`ロール**または**`iam.serviceAccounts.create`権限**を備えた任意のカスタムロールが必要です。サービスアカウントが作成されたら、**関連するキーペア**（**`iam.serviceAccountKeys.create`権限**）を生成します。
2. **新しい委任の作成**: **スーパー管理者ロールのみがGoogle Workspaceでグローバルドメイン全体の委任を設定できる能力を持っていること**を理解することが重要です。ドメイン全体の委任は**プログラムで設定できず**、Google Workspaceの**コンソール**を介して**手動**でのみ作成および調整できます。
* ルールの作成は、ページ**APIコントロール → Google Workspace管理コンソールでのドメイン全体の委任の管理**で見つけることができます。
3. **OAuthスコープ権限の添付**: 新しい委任を構成する際、Googleは**クライアントID**（GCPサービスアカウントの**OAuth ID**リソース）と、委任に必要な**OAuthスコープ**の2つのパラメータのみが必要です。
* **OAuthスコープの完全なリスト**は[**こちら**](https://developers.google.com/identity/protocols/oauth2/scopes)で見つけることができますが、ここでは推奨されるものを示します: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`
4. **対象アイデンティティの代理として行動する:** この時点で、GWSに機能する委任オブジェクトがあります。今、**GCPサービスアカウントの秘密キーを使用して、API呼び出し**（OAuthスコープパラメータで定義されたスコープ内）を実行し、Google Workspaceに存在する任意のアイデンティティの代理として**行動**できます。サービスアカウントは、必要に応じてアクセス許可に基づいてREST APIアプリケーションに対してアクセストークンを生成します。
* この委任を使用するための**ツール**については、**前のセクション**を確認してください。

#### 組織間委任

OAuth SA IDはグローバルであり、**組織間委任**に使用できます。クロスグローバル委任を防ぐための制限は実装されていません。単純に言えば、**異なるGCP組織のサービスアカウントを使用して、他のWorkspace組織でドメイン全体の委任を構成できます**。これにより、**Workspaceへのスーパー管理者アクセスのみが必要**となり、同じGCPアカウントへのアクセスは必要ありません。攻撃者は、自身が制御するGCPアカウントでサービスアカウントと秘密キーを作成できます。

### Workspaceを列挙するプロジェクトの作成

**デフォルト**では、Workspaceの**ユーザー**は**新しいプロジェクトを作成**する権限を持ち、新しいプロジェクトが作成されると**作成者はそれに所有者ロール**を持ちます。

したがって、ユーザーは**プロジェクトを作成**し、新しいプロジェクトでWorkspaceを列挙するための**APIを有効に**し、それを**列挙**しようとすることができます。

{% hint style="danger" %}
ユーザーがWorkspaceを列挙できるようにするには、十分なWorkspace権限が必要です（すべてのユーザーがディレクトリを列挙できるわけではありません）。
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

**さらなる列挙を確認する**：

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Gcloudの悪用

`gcloud` フローに関する詳細情報は以下で見つけることができます：

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

そこで説明されているように、gcloudは`https://www.googleapis.com/auth/drive`スコープをリクエストすることができ、これによりユーザーがユーザーのドライブにアクセスできるようになります。\
攻撃者として、ユーザーのコンピューターを**物理的に**侵害し、かつユーザーがまだ自分のアカウントでログインしている場合、ドライブへのアクセス権を持つトークンを生成してログインすることができます。
```bash
gcloud auth login --enable-gdrive-access
```
攻撃者がユーザーのコンピュータを侵害した場合、`google-cloud-sdk/lib/googlecloudsdk/core/config.py` ファイルを変更して **`CLOUDSDK_SCOPES`** にスコープ **`'https://www.googleapis.com/auth/drive'`** を追加する可能性があります：

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
したがって、次回ユーザーがログインすると、攻撃者はドライブへのアクセス権を持つ **トークン** を作成し、それを悪用してドライブにアクセスできる可能性があります。明らかに、ブラウザは生成されたトークンがドライブへのアクセス権を持つことを示しますが、ユーザーが **`gcloud auth login`** を呼び出すため、おそらく **何も疑わない** でしょう。

ドライブファイルをリストするには：**`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## GWS から GCP へ

### 特権のある GCP ユーザーへのアクセス

攻撃者が GWS に完全アクセス権を持っている場合、GCP 上で特権アクセス権を持つグループやユーザーにアクセスできるため、GWS から GCP への移行は通常よりも「簡単」です。なぜなら、**GWS のユーザーは GCP 上で高い特権を持っている** からです。

### Google グループ特権昇格

デフォルトでは、ユーザーは **組織の Workspace グループに自由に参加** でき、これらのグループには割り当てられた **GCP 権限** があるかもしれません（[https://groups.google.com/](https://groups.google.com/) でグループを確認してください）。

**google groups privesc** を悪用することで、GCP への特権アクセスを持つグループに昇格することができるかもしれません。

### 参考文献

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> で **ゼロからヒーローまでの AWS ハッキングを学ぶ**</summary>

HackTricks をサポートする他の方法：

* **HackTricks で企業を宣伝したい** または **HackTricks を PDF でダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式 PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローする
* **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出する

</details>
