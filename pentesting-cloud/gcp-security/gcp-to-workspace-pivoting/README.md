# GCP <--> Workspace 之间的转换

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## **从GCP到GWS**

### **域范围委派基础**

Google Workspace的域范围委派允许一个身份对象，无论是来自Google Workspace市场的**外部应用**还是内部的**GCP服务账户**，代表用户**访问Workspace中的数据**。

{% hint style="info" %}
这基本上意味着GCP项目或组织内的**服务账户**可能能够**冒充**同一组织（甚至不同组织）的Workspace用户。
{% endhint %}

要了解这是如何工作的更多信息，请查看：

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### 危害现有委派

如果攻击者危害了对GCP的某些访问权限，并且有公司有效Workspace用户的列表，他可以**枚举**他有权访问的所有**项目**，**枚举**所有项目的**服务账户(SAs)**，**尝试** **冒充**每个**服务账户**，并**重复**所有这些**步骤**对于他能冒充的**每个SA**。\
拥有他可以**访问**的**所有服务账户列表**和**Workspace** **邮箱**列表，攻击者可以尝试**用每个服务账户冒充每个用户**。

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

这是一个可以按照以下步骤执行攻击的工具：

1. 使用资源管理器API **枚举GCP项目**。
2. 在每个项目资源上迭代，并使用_GetIAMPolicy_ **枚举**初始IAM用户有权访问的**GCP服务账户资源**。
3. 在**每个服务账户角色**上迭代，并找到具有_**serviceAccountKeys.create**_权限的内置、基本和自定义角色在目标服务账户资源上。应该注意的是，编辑者角色本质上拥有这个权限。
4. 为在IAM策略中找到具有相关权限的每个服务账户资源创建一个**新的`KEY_ALG_RSA_2048`**私钥。
5. 在**每个新服务账户上迭代并创建一个`JWT`** **对象**，它由SA私钥凭据和OAuth范围组成。创建新的_JWT_对象的过程将**迭代所有现有的OAuth范围组合**从**oauth\_scopes.txt**列表中，以找到所有的委派可能性。列表**oauth\_scopes.txt**更新了我们发现的所有相关的OAuth范围，用于滥用Workspace身份。
6. `_make_authorization_grant_assertion`方法揭示了需要声明一个**目标workspace用户**，称为_主题_，以在DWD下生成JWTs。虽然这似乎需要一个特定的用户，但重要的是要意识到**DWD影响域内的每个身份**。因此，为**任何域用户**创建JWT会影响该域中的所有身份，这与我们的组合枚举检查一致。简而言之，一个有效的Workspace用户就足以继续前进。\
这个用户可以在DeleFriend的_config.yaml_文件中定义。如果目标workspace用户尚未知晓，该工具通过扫描在GCP项目上有角色的域用户来自动识别有效的workspace用户。关键要注意的是（再次），JWTs是特定于域的，并不是为每个用户生成的；因此，自动过程针对每个域的单一独特身份。
7. **枚举并为每个JWT创建一个新的承载访问令牌**，并使用tokeninfo API验证令牌。

#### [Gitlab的Python脚本](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab创建了[这个Python脚本](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)，它可以做两件事 - 列出用户目录和创建一个新的管理账户，同时指示一个带有SA凭据和要冒充的用户的json。以下是您将如何使用它：
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### 创建新的委派（持久性）

具有在GCP项目中**创建服务账户**和对GWS具有**超级管理员权限**的攻击者可以创建一个新的委派，允许SA模拟一些GWS用户：

1. **生成新的服务账户和相应的密钥对：** 在GCP上，可以通过控制台交互式地或使用直接API调用和CLI工具以编程方式生成新的服务账户资源。这需要**角色`iam.serviceAccountAdmin`**或配备了**`iam.serviceAccounts.create`** **权限**的任何自定义角色。创建服务账户后，我们将继续生成一个**相关的密钥对**（**`iam.serviceAccountKeys.create`**权限）。
2. **创建新的委派：** 在拥有相关的身份对象和一个相关的私钥（允许使用Google API进行身份验证）之后，我们需要在Google Workspace内为服务账户资源**建立一个新的委派规则**。这个委派规则将使我们能够在Workspace REST API应用程序上执行Google API活动。重要的是要理解，**只有超级管理员角色具备在Google Workspace设置全局域范围委派的能力**，而且域范围委派**不能以编程方式设置，**它只能通过Google Workspace**控制台**手动创建和调整。

规则的创建可以在**API控制 → 在Google Workspace管理控制台管理域范围委派**页面下找到。
3. **附加OAuth作用域权限：** 在配置新的委派时，Google只需要2个参数，客户端ID，即GCP服务账户资源的**OAuth ID**，以及定义委派需要哪些API调用的**OAuth作用域**。\
**完整的OAuth作用域列表**可以在[**这里**](https://developers.google.com/identity/protocols/oauth2/scopes)找到。
4. **代表目标身份行事：** 此时，我们在GWS中有一个功能正常的委派对象。现在，**使用GCP服务账户的私钥，我们可以执行API调用**（在OAuth作用域参数定义的范围内）来触发它并**代表Google Workspace中存在的任何身份行事**。正如我们所了解的，服务账户将根据其需要以及对REST API应用程序的权限生成访问令牌。

#### 跨组织委派

OAuth服务账户ID是全局的，可以用于**跨组织委派**。尚未实施任何限制以防止跨全球委派。简单来说，**不同GCP组织的服务账户可以用来在其他Workspace组织上配置域范围委派**。这将导致**只需要对Workspace的超级管理员访问权限**，而不需要访问相同的GCP账户，因为对手可以在他个人控制的GCP账户上创建服务账户和私钥。

### 创建项目以枚举Workspace

**默认情况下**，Workspace**用户**有权限**创建新项目**，并且当创建新项目时，**创建者将获得对其的所有者角色**。

因此，用户可以**创建一个项目**，**启用**新项目中的**API**来枚举Workspace，并尝试**枚举**它。

{% hint style="danger" %}
为了使用户能够枚举Workspace，他还需要足够的Workspace权限（并非每个用户都能枚举目录）。
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer C01cr71rl
```
```markdown
{% endcode %}

查看**更多枚举**：

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## 从 GWS 到 GCP

### 访问具有特权的 GCP 用户

如果攻击者完全控制了 GWS，他将能够访问具有 GCP 特权访问权限的群组或甚至用户，因此从 GWS 到 GCP 的移动通常更加“简单”，仅仅因为 **GWS 中的用户对 GCP 拥有高权限**。

### Google Groups 权限提升

默认情况下，用户可以自由加入组织的 Workspace 群组，而这些群组可能被分配了 GCP 权限。

通过滥用 **google groups privesc**，你可能能够提升到一个对 GCP 有某种特权访问权限的群组。

### 参考资料

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> 从零开始学习 AWS 黑客攻击！</strong></summary>

其他支持 HackTricks 的方式：

* 如果你想在 HackTricks 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享你的黑客技巧**。

</details>
```
