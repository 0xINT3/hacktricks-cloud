# GCP <--> Workspace Pivoting

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Do GCP para o GWS**

### **B√°sicos da Delega√ß√£o de Dom√≠nio Amplo**

A delega√ß√£o de dom√≠nio amplo do Google Workspace permite que um objeto de identidade, seja um **aplicativo externo** do Google Workspace Marketplace ou uma **Conta de Servi√ßo GCP** interna, **acesse dados em todo o Workspace em nome dos usu√°rios**.

{% hint style="info" %}
Isso basicamente significa que **contas de servi√ßo** dentro de projetos GCP ou de uma organiza√ß√£o podem ser capazes de **impersonar usu√°rios do Workspace** da mesma organiza√ß√£o (ou at√© de uma diferente).
{% endhint %}

Para mais informa√ß√µes sobre como isso funciona exatamente, confira:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Comprometer delega√ß√£o existente

Se um atacante comprometeu algum acesso ao GCP e tem uma lista de usu√°rios v√°lidos do Workspace da empresa, ele poderia **enumerar** todos os **projetos** aos quais tem acesso, **enumerar** todas as **Contas de Servi√ßo (SAs)** dos projetos, **tentar** **impersonar** cada **conta de servi√ßo**, e **repetir** todos esses **passos** com **cada SA** que ele pode impersonar.\
Com uma **lista de todas as contas de servi√ßo** √†s quais ele tem **acesso** e a lista de **emails do Workspace**, o atacante poderia tentar **impersonar cada usu√°rio com cada conta de servi√ßo**.

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Esta √© uma ferramenta que pode realizar o ataque seguindo estes passos:

1. **Enumerar Projetos GCP** usando a API do Gerenciador de Recursos.
2. Iterar em cada recurso do projeto e **enumerar recursos de Conta de Servi√ßo GCP** aos quais o usu√°rio IAM inicial tem acesso usando _GetIAMPolicy_.
3. Iterar em **cada papel da conta de servi√ßo**, e encontrar pap√©is integrados, b√°sicos e personalizados com permiss√£o _**serviceAccountKeys.create**_ no recurso da conta de servi√ßo alvo. Deve-se notar que o papel de Editor possui inerentemente esta permiss√£o.
4. Criar uma **nova chave privada `KEY_ALG_RSA_2048`** para cada recurso de conta de servi√ßo que for encontrado com permiss√£o relevante na pol√≠tica IAM.
5. Iterar em **cada nova conta de servi√ßo e criar um objeto `JWT`** para ela que √© composto pelas credenciais da chave privada da SA e um escopo OAuth. O processo de cria√ß√£o de um novo objeto _JWT_ ir√° **iterar em todas as combina√ß√µes existentes de escopos OAuth** da lista **oauth\_scopes.txt**, a fim de encontrar todas as possibilidades de delega√ß√£o. A lista **oauth\_scopes.txt** √© atualizada com todos os escopos OAuth que encontramos serem relevantes para abusar das identidades do Workspace.
6. O m√©todo `_make_authorization_grant_assertion` revela a necessidade de declarar um **usu√°rio do workspace alvo**, referido como _subject_, para gerar JWTs sob DWD. Embora isso possa parecer exigir um usu√°rio espec√≠fico, √© importante perceber que **DWD influencia todas as identidades dentro de um dom√≠nio**. Consequentemente, criar um JWT para **qualquer usu√°rio do dom√≠nio** afeta todas as identidades naquele dom√≠nio, consistente com nossa verifica√ß√£o de enumera√ß√£o de combina√ß√µes. Simplificando, um usu√°rio v√°lido do Workspace √© suficiente para avan√ßar.\
Este usu√°rio pode ser definido no arquivo _config.yaml_ do DeleFriend. Se um usu√°rio do workspace alvo j√° n√£o for conhecido, a ferramenta facilita a identifica√ß√£o autom√°tica de usu√°rios v√°lidos do workspace, escaneando usu√°rios de dom√≠nio com pap√©is em projetos GCP. √â chave notar (novamente) que os JWTs s√£o espec√≠ficos do dom√≠nio e n√£o s√£o gerados para cada usu√°rio; portanto, o processo autom√°tico visa uma identidade √∫nica por dom√≠nio.
7. **Enumerar e criar um novo token de acesso bearer** para cada JWT e validar o token contra a API tokeninfo.

#### [Script Python do Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

O Gitlab criou [este script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que pode fazer duas coisas - listar o diret√≥rio de usu√°rios e criar uma nova conta administrativa enquanto indica um json com credenciais de SA e o usu√°rio a ser impersonado. Aqui est√° como voc√™ usaria isso:
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Criar uma nova delega√ß√£o (Persist√™ncia)

Um atacante com a capacidade de **criar contas de servi√ßo em um projeto GCP** e **privil√©gio de super administrador no GWS poderia criar uma nova delega√ß√£o permitindo que SAs se passassem por alguns usu√°rios do GWS:**

1. **Gerando uma Nova Conta de Servi√ßo e Par de Chaves Correspondente:** No GCP, novos recursos de conta de servi√ßo podem ser produzidos interativamente atrav√©s do console ou programaticamente usando chamadas diretas de API e ferramentas de CLI. Isso requer a **fun√ß√£o `iam.serviceAccountAdmin`** ou qualquer fun√ß√£o personalizada equipada com a **permiss√£o `iam.serviceAccounts.create`**. Uma vez que a conta de servi√ßo √© criada, prosseguiremos para gerar um **par de chaves relacionado** (**permiss√£o `iam.serviceAccountKeys.create`**).
2. **Cria√ß√£o de nova delega√ß√£o**: Ap√≥s ter um objeto de identidade relevante e uma chave privada relacionada que permite a autentica√ß√£o com as APIs do Google, precisamos **estabelecer uma nova regra de delega√ß√£o para o recurso de conta de servi√ßo dentro do Google Workspace**. Esta regra de delega√ß√£o nos permitir√° realizar a atividade das APIs do Google em aplica√ß√µes da API REST do Workspace. √â importante entender que **apenas o papel de Super Admin possui a capacidade de configurar a delega√ß√£o global de Dom√≠nio no Google Workspace** e a delega√ß√£o de Dom√≠nio **n√£o pode ser configurada programaticamente,** s√≥ pode ser criada e ajustada **manualmente** atrav√©s do **console** do Google Workspace.

A cria√ß√£o da regra pode ser encontrada na p√°gina **Controles de API ‚Üí Gerenciar Delega√ß√£o de Dom√≠nio no console de Administra√ß√£o do Google Workspace**.
3. **Anexando privil√©gio de escopos OAuth**: Ao configurar uma nova delega√ß√£o, o Google exige apenas 2 par√¢metros, o ID do Cliente, que √© o **ID OAuth da Conta de Servi√ßo GCP** recurso, e **escopos OAuth** que definem quais chamadas de API a delega√ß√£o requer.\
A **lista completa de escopos OAuth** pode ser encontrada [**aqui**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Agindo em nome da identidade alvo:** Neste ponto, temos um objeto delegado funcionando no GWS. Agora, **usando a chave privada da Conta de Servi√ßo GCP, podemos realizar chamadas de API** (no escopo definido no par√¢metro de escopo OAuth) para ativ√°-lo e **agir em nome de qualquer identidade que exista no Google Workspace**. Como aprendemos, a conta de servi√ßo gerar√° tokens de acesso conforme suas necessidades e de acordo com a permiss√£o que tem para aplica√ß√µes da API REST.

#### Delega√ß√£o Interorganizacional

O ID do SA OAuth √© global e pode ser usado para **delega√ß√£o interorganizacional**. N√£o foi implementada nenhuma restri√ß√£o para impedir a delega√ß√£o global cruzada. Em termos simples, **contas de servi√ßo de diferentes organiza√ß√µes GCP podem ser usadas para configurar delega√ß√£o de dom√≠nio em outras organiza√ß√µes do Workspace**. Isso resultaria em **apenas precisar de acesso de Super Admin ao Workspace**, e n√£o acesso √† mesma conta GCP, j√° que o advers√°rio pode criar Contas de Servi√ßo e chaves privadas em sua conta GCP controlada pessoalmente.

### Criando um Projeto para enumerar o Workspace

Por **padr√£o**, os **usu√°rios** do Workspace t√™m permiss√£o para **criar novos projetos**, e quando um novo projeto √© criado, o **criador obt√©m a fun√ß√£o de Propriet√°rio** sobre ele.

Portanto, um usu√°rio pode **criar um projeto**, **habilitar** as **APIs** para enumerar o Workspace em seu novo projeto e tentar **enumer√°-lo**.

{% hint style="danger" %}
Para que um usu√°rio possa enumerar o Workspace, ele tamb√©m precisa de permiss√µes suficientes no Workspace (nem todo usu√°rio ser√° capaz de enumerar o diret√≥rio).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer C01cr71rl
```
```markdown
{% endcode %}

Verifique **mais enumera√ß√£o em**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## De GWS para GCP

### Acesso a usu√°rios privilegiados do GCP

Se um atacante tem acesso completo ao GWS, ele poder√° acessar grupos com acesso privilegiado ao GCP ou at√© mesmo usu√°rios, portanto, a transi√ß√£o do GWS para o GCP geralmente √© mais "simples" apenas porque **usu√°rios no GWS t√™m altos privil√©gios sobre o GCP**.

### Escalonamento de Privil√©gios em Google Groups

Por padr√£o, usu√°rios podem se juntar livremente a grupos do Workspace da Organiza√ß√£o e esses grupos podem ter permiss√µes do GCP atribu√≠das.

Abusando do **google groups privesc**, voc√™ pode ser capaz de escalar para um grupo com algum tipo de acesso privilegiado ao GCP.

### Refer√™ncias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
