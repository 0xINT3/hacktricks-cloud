# GCP <--> Workspace Pivoting

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **De GCP a GWS**

### **Conceptos b√°sicos de la Delegaci√≥n de Dominio Amplio**

La delegaci√≥n de dominio amplio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci√≥n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio de GCP** interna, **acceda a datos en todo el Workspace en nombre de los usuarios**.

{% hint style="info" %}
Esto b√°sicamente significa que las **cuentas de servicio** dentro de proyectos de GCP o una organizaci√≥n podr√≠an ser capaces de **impersonar a usuarios de Workspace** de la misma organizaci√≥n (o incluso de una diferente).
{% endhint %}

Para m√°s informaci√≥n sobre c√≥mo funciona esto exactamente, consulta:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Comprometer una delegaci√≥n existente

Si un atacante comprometi√≥ alg√∫n acceso sobre GCP y tiene una lista de usuarios v√°lidos de Workspace de la empresa, podr√≠a **enumerar** todos los **proyectos** a los que tiene acceso, **enumerar** todas las **Cuentas de Servicio (SAs)** de los proyectos, **intentar** **impersonar** cada **cuenta de servicio**, y **repetir** todos estos **pasos** con **cada SA** que pueda impersonar.\
Con una **lista de todas las cuentas de servicio** a las que tiene **acceso** y la lista de **correos electr√≥nicos de Workspace**, el atacante podr√≠a intentar **impersonar a cada usuario con cada cuenta de servicio**.

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Esta es una herramienta que puede realizar el ataque siguiendo estos pasos:

1. **Enumerar Proyectos de GCP** usando la API de Resource Manager.
2. Iterar en cada recurso de proyecto y **enumerar recursos de Cuenta de Servicio de GCP** a los que el usuario IAM inicial tiene acceso usando _GetIAMPolicy_.
3. Iterar en **cada rol de cuenta de servicio**, y encontrar roles integrados, b√°sicos y personalizados con permiso de _**serviceAccountKeys.create**_ en el recurso de cuenta de servicio objetivo. Cabe destacar que el rol de Editor posee inherentemente este permiso.
4. Crear una **nueva clave privada `KEY_ALG_RSA_2048`** para cada recurso de cuenta de servicio que se encuentre con permiso relevante en la pol√≠tica IAM.
5. Iterar en **cada nueva cuenta de servicio y crear un objeto `JWT`** para ella que est√© compuesto por las credenciales de la clave privada de SA y un alcance de OAuth. El proceso de crear un nuevo objeto _JWT_ **iterar√° en todas las combinaciones existentes de alcances de OAuth** de la lista **oauth\_scopes.txt**, para encontrar todas las posibilidades de delegaci√≥n. La lista **oauth\_scopes.txt** se actualiza con todos los alcances de OAuth que hemos encontrado relevantes para abusar de las identidades de Workspace.
6. El m√©todo `_make_authorization_grant_assertion` revela la necesidad de declarar un **usuario de Workspace objetivo**, referido como _subject_, para generar JWTs bajo DWD. Aunque esto puede parecer que requiere un usuario espec√≠fico, es importante darse cuenta de que **DWD influye en cada identidad dentro de un dominio**. En consecuencia, crear un JWT para **cualquier usuario del dominio** afecta a todas las identidades en ese dominio, consistente con nuestra verificaci√≥n de enumeraci√≥n de combinaciones. En pocas palabras, un usuario v√°lido de Workspace es suficiente para avanzar.\
Este usuario se puede definir en el archivo _config.yaml_ de DeleFriend. Si no se conoce ya un usuario de Workspace objetivo, la herramienta facilita la identificaci√≥n autom√°tica de usuarios v√°lidos de Workspace escaneando usuarios de dominio con roles en proyectos de GCP. Es clave notar (de nuevo) que los JWTs son espec√≠ficos del dominio y no se generan para cada usuario; por lo tanto, el proceso autom√°tico se dirige a una identidad √∫nica por dominio.
7. **Enumerar y crear un nuevo token de acceso bearer** para cada JWT y validar el token contra la API de tokeninfo.

#### [Script de Python de Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab ha creado [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que puede hacer dos cosas: listar el directorio de usuarios y crear una nueva cuenta administrativa indicando un json con credenciales de SA y el usuario a impersonar. Aqu√≠ te mostramos c√≥mo usarlo:
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Crear una nueva delegaci√≥n (Persistencia)

Un atacante con la capacidad de **crear cuentas de servicio en un proyecto de GCP** y **privilegio de super administrador en GWS podr√≠a crear una nueva delegaci√≥n que permita a las SAs suplantar a algunos usuarios de GWS:**

1. **Generaci√≥n de una Nueva Cuenta de Servicio y Par de Claves Correspondiente:** En GCP, se pueden producir nuevos recursos de cuenta de servicio de manera interactiva a trav√©s de la consola o program√°ticamente utilizando llamadas directas a la API y herramientas de CLI. Esto requiere el **rol `iam.serviceAccountAdmin`** o cualquier rol personalizado equipado con el **permiso `iam.serviceAccounts.create`**. Una vez creada la cuenta de servicio, procederemos a generar un **par de claves relacionado** (**permiso `iam.serviceAccountKeys.create`**).
2. **Creaci√≥n de nueva delegaci√≥n**: Despu√©s de tener un objeto de identidad relevante y una clave privada relacionada que permite la autenticaci√≥n con las APIs de Google, necesitamos **establecer una nueva regla de delegaci√≥n para el recurso de cuenta de servicio dentro de Google Workspace**. Esta regla de delegaci√≥n nos permitir√° realizar la actividad de las APIs de Google en aplicaciones de la API REST de Workspace. Es importante entender que **solo el rol de Super Admin posee la capacidad de configurar la delegaci√≥n de Dominio Global en Google Workspace** y la delegaci√≥n de Dominio Global **no se puede configurar program√°ticamente,** solo se puede crear y ajustar **manualmente** a trav√©s de la consola de **Google Workspace**.

La creaci√≥n de la regla se puede encontrar en la p√°gina **Controles de API ‚Üí Administrar la delegaci√≥n de Dominio Global en la consola de administraci√≥n de Google Workspace**.
3. **Adjuntar privilegio de alcances OAuth**: Al configurar una nueva delegaci√≥n, Google requiere solo 2 par√°metros, el ID del Cliente, que es el **ID de OAuth de la Cuenta de Servicio de GCP**, y **alcances OAuth** que definen qu√© llamadas a la API requiere la delegaci√≥n.\
La **lista completa de alcances OAuth** se puede encontrar [**aqu√≠**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Actuar en nombre de la identidad objetivo:** En este punto, tenemos un objeto delegado funcional en GWS. Ahora, **usando la clave privada de la Cuenta de Servicio de GCP, podemos realizar llamadas a la API** (en el alcance definido en el par√°metro de alcance OAuth) para activarlo y **actuar en nombre de cualquier identidad que exista en Google Workspace**. Como aprendimos, la cuenta de servicio generar√° tokens de acceso seg√∫n sus necesidades y de acuerdo con el permiso que tiene para aplicaciones de la API REST.

#### Delegaci√≥n entre organizaciones

El ID de SA de OAuth es global y se puede utilizar para **delegaci√≥n entre organizaciones**. No se ha implementado ninguna restricci√≥n para prevenir la delegaci√≥n global cruzada. En t√©rminos simples, **las cuentas de servicio de diferentes organizaciones de GCP se pueden utilizar para configurar la delegaci√≥n de dominio global en otras organizaciones de Workspace**. Esto resultar√≠a en **solo necesitar acceso de Super Admin a Workspace**, y no acceso a la misma cuenta de GCP, ya que el adversario puede crear Cuentas de Servicio y claves privadas en su cuenta de GCP controlada personalmente.

### Crear un Proyecto para enumerar Workspace

Por **defecto**, los **usuarios** de Workspace tienen permiso para **crear nuevos proyectos**, y cuando se crea un nuevo proyecto el **creador obtiene el rol de Propietario** sobre √©l.

Por lo tanto, un usuario puede **crear un proyecto**, **habilitar** las **APIs** para enumerar Workspace en su nuevo proyecto e intentar **enumerarlo**.

{% hint style="danger" %}
Para que un usuario pueda enumerar Workspace tambi√©n necesita suficientes permisos de Workspace (no todos los usuarios podr√°n enumerar el directorio).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer C01cr71rl
```
```markdown
{% endcode %}

Consulta **m√°s enumeraci√≥n en**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## De GWS a GCP

### Acceso a usuarios privilegiados de GCP

Si un atacante tiene acceso completo sobre GWS, podr√° acceder a grupos con acceso privilegiado sobre GCP o incluso usuarios, por lo tanto, pasar de GWS a GCP suele ser m√°s "sencillo" simplemente porque **los usuarios en GWS tienen altos privilegios sobre GCP**.

### Escalada de Privilegios en Google Groups

Por defecto, los usuarios pueden unirse libremente a grupos de Workspace de la Organizaci√≥n y esos grupos podr√≠an tener permisos de GCP asignados.

Abusando del **google groups privesc**, podr√≠as escalar a un grupo con alg√∫n tipo de acceso privilegiado a GCP.

### Referencias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
