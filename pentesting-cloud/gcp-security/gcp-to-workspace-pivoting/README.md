# GCP <--> Pivoting Workspace

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakowania, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## **Z GCP do GWS**

### **Podstawy Delegacji na Poziomie Domeny**

Delegacja na poziomie domeny Google Workspace pozwala obiektowi tożsamości, czy to **zewnętrznej aplikacji** z Google Workspace Marketplace, czy wewnętrznemu **Kontu Usługi GCP**, na **dostęp do danych w całym Workspace w imieniu użytkowników**.

{% hint style="info" %}
Oznacza to w zasadzie, że **konta usług** w projektach GCP organizacji mogą **podawać się za użytkowników Workspace** tej samej organizacji (lub nawet z innej).
{% endhint %}

Aby uzyskać więcej informacji na temat tego, jak dokładnie to działa, sprawdź:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Skompromitowanie istniejącej delegacji

Jeśli atakujący **skompromituje dostęp do GCP** i **zna prawidłowy adres e-mail użytkownika Workspace** (najlepiej **super administratora**) firmy, może **wyliczyć wszystkie projekty**, do których ma dostęp, **wyliczyć wszystkie Konta Usług** w projektach, sprawdzić, do których **kont usług ma dostęp**, i **powtarzać** te kroki z każdym kontem usługi, które może podawać się za użytkownika.\
Dzięki **listy wszystkich kont usług**, do których ma **dostęp**, i listy **adresów e-mail Workspace**, atakujący mógłby próbować **podawać się za użytkownika z każdym kontem usługi**.

{% hint style="danger" %}
Zauważ, że podczas konfigurowania delegacji na poziomie domeny nie jest wymagany użytkownik Workspace, dlatego wystarczy znać **jednego prawidłowego, co jest konieczne do podawania się za niego**.\
Jednak **uprawnienia podawanego użytkownika będą wykorzystane**, więc jeśli jest to Super Administrator, będziesz mógł uzyskać dostęp do wszystkiego. Jeśli nie ma żadnego dostępu, będzie to bezużyteczne.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

To narzędzie może przeprowadzić atak, wykonując następujące kroki:

1. **Wylicz projekty GCP** za pomocą interfejsu API Resource Manager.
2. Iteruj na każdym zasobie projektu i **wylicz zasoby Kont Usługi GCP**, do których początkowy użytkownik IAM ma dostęp, korzystając z _GetIAMPolicy_.
3. Iteruj na **każdej roli konta usługi**, i znajdź wbudowane, podstawowe i niestandardowe role z uprawnieniem _**serviceAccountKeys.create**_ na docelowym zasobie konta usługi. Należy zauważyć, że rola Edytora posiada to uprawnienie w sposób wbudowany.
4. Utwórz nowy **prywatny klucz `KEY_ALG_RSA_2048`** dla każdego zasobu konta usługi, który został znaleziony z odpowiednim uprawnieniem w polityce IAM.
5. Iteruj na **każdym nowym koncie usługi i utwórz `JWT`** **obiekt** dla niego, który składa się z poświadczeń prywatnego klucza konta usługi i zakresu OAuth. Proces tworzenia nowego obiektu _JWT_ będzie **iterował po wszystkich istniejących kombinacjach zakresów OAuth** z listy **oauth\_scopes.txt**, aby znaleźć wszystkie możliwości delegacji. Lista **oauth\_scopes.txt** jest aktualizowana o wszystkie zakresy OAuth, które uznaliśmy za istotne do nadużywania tożsamości Workspace.
6. Metoda `_make_authorization_grant_assertion` ujawnia konieczność zadeklarowania **docelowego użytkownika Workspace**, określanego jako _subject_, do generowania JWT w ramach DWD. Chociaż może się wydawać, że wymaga to określonego użytkownika, ważne jest zrozumienie, że **DWD wpływa na każdą tożsamość w domenie**. W rezultacie tworzenie JWT dla **dowolnego użytkownika domeny** wpływa na wszystkie tożsamości w tej domenie, zgodnie z naszą kontrolą enumeracji kombinacji. Po prostu mówiąc, jedno prawidłowe konto użytkownika Workspace jest wystarczające do kontynuacji.\
Ten użytkownik może być zdefiniowany w pliku _config.yaml_ DeleFriend. Jeśli docelowy użytkownik Workspace nie jest jeszcze znany, narzędzie ułatwia automatyczne identyfikowanie prawidłowych użytkowników Workspace poprzez skanowanie użytkowników domeny z rolami w projektach GCP. Warto zauważyć (ponownie), że JWT są specyficzne dla domeny i nie są generowane dla każdego użytkownika; dlatego proces automatyczny kieruje się w stronę jednej unikalnej tożsamości na domenę.
7. **Wylicz i utwórz nowy token dostępu typu bearer** dla każdego JWT i zweryfikuj token za pomocą interfejsu API tokeninfo.

#### [Skrypt Pythona Gitlaba](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab stworzył [ten skrypt Pythona](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py), który może wykonać dwie rzeczy - wyświetlić katalog użytkowników i utworzyć nowe konto administracyjne, wskazując plik json z poświadczeniami SA i użytkownikiem do podania się za niego. Oto jak go użyć:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Utwórz nową delegację (Trwałość)

Możliwe jest **sprawdzenie Delegacji na Poziomie Domeny w** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Atakujący mający zdolność **tworzenia kont usługowych w projekcie GCP** oraz **uprawnienia super administratora w GWS mógłby utworzyć nową delegację umożliwiającą kontom usługowym udawanie niektórych użytkowników GWS:**

1. **Generowanie nowego konta usługowego i odpowiadającej pary kluczy:** Na platformie GCP, nowe zasoby kont usługowych mogą być tworzone interaktywnie za pomocą konsoli lub programistycznie przy użyciu bezpośrednich wywołań interfejsu API i narzędzi CLI. Wymaga to roli **`iam.serviceAccountAdmin`** lub dowolnej niestandardowej roli wyposażonej w uprawnienie **`iam.serviceAccounts.create`**. Po utworzeniu konta usługowego przejdziemy do wygenerowania **powiązanej pary kluczy** (uprawnienie **`iam.serviceAccountKeys.create`**).
2. **Utworzenie nowej delegacji**: Ważne jest zrozumienie, że **tylko rola Super Administratora posiada zdolność do ustawienia globalnej delegacji na Poziomie Domeny w Google Workspace** i delegację na Poziomie Domeny **nie można skonfigurować programistycznie,** Można ją jedynie utworzyć i dostosować **ręcznie** za pomocą konsoli Google Workspace.
* Utworzenie reguły można znaleźć na stronie **Kontrole API → Zarządzaj Delegacją na Poziomie Domeny w konsoli administratora Google Workspace**.
3. **Przywileje dołączania zakresów OAuth**: Podczas konfigurowania nowej delegacji, Google wymaga tylko 2 parametrów, identyfikatora klienta (Client ID), który jest **ID OAuth zasobu Konta Usługowego GCP**, oraz **zakresów OAuth**, które określają, jakie wywołania API są wymagane przez delegację.
* **Pełną listę zakresów OAuth** można znaleźć [**tutaj**](https://developers.google.com/identity/protocols/oauth2/scopes), ale oto rekomendacja: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Działanie w imieniu docelowej tożsamości:** W tym momencie mamy działającą obiekt delegowany w GWS. Teraz, **korzystając z prywatnego klucza konta usługowego GCP, możemy wykonywać wywołania API** (w zakresie określonym w parametrze zakresu OAuth) w celu jego uruchomienia i **działania w imieniu dowolnej tożsamości istniejącej w Google Workspace**. Jak się dowiedzieliśmy, konto usługowe będzie generować tokeny dostępu zgodnie z własnymi potrzebami i zgodnie z uprawnieniami, jakie ma do aplikacji REST API.
* Sprawdź **poprzednią sekcję** w celu uzyskania **narzędzi** do korzystania z tej delegacji.

#### Delegacja Międzyorganizacyjna

ID OAuth konta usługowego jest globalne i może być używane do **delegacji międzyorganizacyjnej**. Nie zostało wprowadzone żadne ograniczenie uniemożliwiające delegację międzyglobalną. W prostych słowach, **konta usługowe z różnych organizacji GCP mogą być używane do konfigurowania delegacji na poziomie domeny w innych organizacjach Workspace**. Spowoduje to, że **wystarczy dostęp Super Administratora do Workspace**, a nie dostęp do tego samego konta GCP, ponieważ przeciwnik może tworzyć konta usługowe i klucze prywatne w swoim kontrolowanym osobiście koncie GCP.

### Tworzenie projektu w celu wyliczenia Workspace

Domyślnie **użytkownicy** Workspace mają uprawnienia do **tworzenia nowych projektów**, a gdy tworzony jest nowy projekt, **twórca otrzymuje rolę Właściciela** nad nim.

Dlatego użytkownik może **utworzyć projekt**, **włączyć** interfejsy **API** do wyliczenia Workspace w swoim nowym projekcie i spróbować go **wyliczyć**.

{% hint style="danger" %}
Aby użytkownik mógł wyliczyć Workspace, potrzebuje również wystarczających uprawnień Workspace (nie każdy użytkownik będzie w stanie wyliczyć katalog).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Sprawdź **więcej wyliczeń w**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Nadużycie Gcloud

Możesz znaleźć dalsze informacje na temat przepływu `gcloud` do logowania się w:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Jak wyjaśniono tam, gcloud może żądać zakresu `https://www.googleapis.com/auth/drive`, co pozwoliłoby użytkownikowi uzyskać dostęp do dysku użytkownika.\
Jako atakujący, jeśli skompromitowałeś **fizycznie** komputer użytkownika i **użytkownik nadal jest zalogowany** na swoje konto, możesz zalogować się, generując token z dostępem do dysku za pomocą:
```bash
gcloud auth login --enable-gdrive-access
```
Jeśli atakujący przejmie komputer użytkownika, może również zmodyfikować plik `google-cloud-sdk/lib/googlecloudsdk/core/config.py` i dodać do **`CLOUDSDK_SCOPES`** zakres **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
W związku z tym, następnym razem, gdy użytkownik się zaloguje, utworzy **token z dostępem do dysku**, który atakujący mógłby wykorzystać do uzyskania dostępu do dysku. Oczywiście, przeglądarka wskaże, że wygenerowany token będzie miał dostęp do dysku, ale ponieważ użytkownik wywoła polecenie **`gcloud auth login`**, prawdopodobnie **nie podejrzewa niczego.**

Aby wyświetlić pliki dysku: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Z GWS do GCP

### Dostęp do uprzywilejowanych użytkowników GCP

Jeśli atakujący ma pełny dostęp do GWS, będzie mógł uzyskać dostęp do grup z uprzywilejowanym dostępem do GCP lub nawet użytkowników, dlatego przechodzenie z GWS do GCP jest zazwyczaj bardziej "proste", ponieważ **użytkownicy w GWS mają wysokie uprawnienia w GCP**.&#x20;

### Eskalacja uprawnień w grupach Google

Domyślnie użytkownicy mogą **swobodnie dołączać do grup Workspace w Organizacji**, a te grupy **mogą mieć przypisane uprawnienia GCP** (sprawdź swoje grupy na [https://groups.google.com/](https://groups.google.com/)).

Wykorzystując **google groups privesc**, możesz być w stanie eskalować do grupy z pewnym rodzajem uprzywilejowanego dostępu do GCP.

### Odnośniki

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
