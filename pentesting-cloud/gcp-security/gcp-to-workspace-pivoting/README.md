# GCP <--> Μετάβαση στο Workspace

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## **Από το GCP στο GWS**

### **Βασικές έννοιες της Πλήρους Εξουσιοδότησης του Domain**

Η Πλήρης Εξουσιοδότηση του Domain του Google Workspace επιτρέπει σε ένα αντικείμενο ταυτότητας, είτε μια **εξωτερική εφαρμογή** από την αγορά του Google Workspace είτε ένα **Λογαριασμό Υπηρεσίας GCP**, να **έχει πρόσβαση σε δεδομένα σε όλο το Workspace εκ μέρους των χρηστών**.

{% hint style="info" %}
Αυτό σημαίνει βασικά ότι οι **λογαριασμοί υπηρεσίας** μέσα στα έργα GCP μιας οργάνωσης μπορεί να **προσποιηθούν τους χρήστες του Workspace** της ίδιας οργάνωσης (ή ακόμα και από μια διαφορετική).
{% endhint %}

Για περισσότερες πληροφορίες σχετικά με το πώς ακριβώς λειτουργεί αυτό, ελέγξτε:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Παραβίαση υπάρχουσας εξουσιοδότησης

Εάν ένας επιτιθέμενος **παραβίασε κάποια πρόσβαση στο GCP** και **γνωρίζει ένα έγκυρο email χρήστη του Workspace** (προτιμητέο **υπερδιαχειριστή**), μπορεί να **απαριθμήσει όλα τα έργα** στα οποία έχει πρόσβαση, **απαριθμήσει όλους τους λογαριασμούς υπηρεσίας** των έργων, να ελέγξει σε ποιους **λογαριασμούς υπηρεσίας έχει πρόσβαση** και να **επαναλάβει** όλα αυτά τα βήματα με κάθε λογαριασμό υπηρεσίας που μπορεί να προσποιηθεί.\
Με μια **λίστα όλων των λογαριασμών υπηρεσίας** στους οποίους έχει **πρόσβαση** και τη λίστα των **email του Workspace**, ο επιτιθέμενος μπορεί να προσπαθήσει να **προσποιηθεί τον χρήστη με κάθε λογαριασμό υπηρεσίας**.

{% hint style="danger" %}
Σημειώστε ότι κατά την ρύθμιση της πλήρους εξουσιοδότησης του domain δεν απαιτείται χρήστης του Workspace, επομένως αρκεί να γνωρίζετε **έναν έγκυρο χρήστη** και αυτός είναι απαραίτητος για την προσποίηση.\
Ωστόσο, θα χρησιμοποιηθούν οι **προνόμια του προσποιηθέντος χρήστη**, οπότε αν είναι υπερδιαχειριστής θα έχετε πρόσβαση σε όλα. Αν δεν έχει καμία πρόσβαση, αυτό θα είναι άχρηστο.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Αυτό είναι ένα εργαλείο που μπορεί να εκτελέσει την επίθεση ακολουθώντας αυτά τα βήματα:

1. **Απαριθμήστε τα Έργα GCP** χρησιμοποιώντας το Resource Manager API.
2. Επαναλάβετε για κάθε πόρο έργου, και **απαριθμήστε τους λογαριασμούς υπηρεσίας GCP** στους οποίους ο αρχικός χρήστης IAM έχει πρόσβαση χρησιμοποιώντας το _GetIAMPolicy_.
3. Επαναλάβετε για κάθε ρόλο λογαριασμού υπηρεσίας, και βρείτε ενσωματωμένους, βασικούς και προσαρμοσμένους ρόλους με άδεια _**serviceAccountKeys.create**_ στοχείου στον προορισμένο πόρο του λογαριασμού υπηρεσίας. Σημειώνεται ότι ο ρόλος του Επεξεργαστή διαθέτει αυτήν την ά
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Δημιουργία νέας ανάθεσης (Μόνιμη)

Είναι δυνατόν να **ελέγξετε τις ολοκληρωμένες αναθέσεις του τομέα** στο [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Ένας επιτιθέμενος με τη δυνατότητα **δημιουργίας λογαριασμών υπηρεσίας σε ένα έργο GCP** και **υπερδιαχειριστικά δικαιώματα στο GWS μπορεί να δημιουργήσει μια νέα ανάθεση που επιτρέπει στους λογαριασμούς υπηρεσίας να προσομοιώνουν ορισμένους χρήστες GWS:**

1. **Δημιουργία νέου λογαριασμού υπηρεσίας και αντίστοιχου ζεύγους κλειδιών:** Στο GCP, νέοι πόροι λογαριασμού υπηρεσίας μπορούν να παραχθούν είτε αλληλεπιδραστικά μέσω της κονσόλας είτε προγραμματιστικά χρησιμοποιώντας άμεσες κλήσεις API και εργαλεία CLI. Αυτό απαιτεί τον ρόλο `iam.serviceAccountAdmin` ή οποιονδήποτε προσαρμοσμένο ρόλο εξοπλισμένο με την άδεια `iam.serviceAccounts.create`. Αφού δημιουργηθεί ο λογαριασμός υπηρεσίας, θα προχωρήσουμε στη δημιουργία ενός σχετικού ζεύγους κλειδιών (`iam.serviceAccountKeys.create` άδεια).
2. **Δημιουργία νέας ανάθεσης**: Είναι σημαντικό να κατανοήσουμε ότι **μόνο ο ρόλος Super Admin έχει τη δυνατότητα να δημιουργήσει παγκόσμια ανάθεση σε όλο τον τομέα στο Google Workspace** και η παγκόσμια ανάθεση στον τομέα **δεν μπορεί να δημιουργηθεί προγραμματιστικά,** μπορεί μόνο να δημιουργηθεί και να προσαρμοστεί **χειροκίνητα** μέσω της κονσόλας του Google Workspace.
* Η δημιουργία του κανόνα μπορεί να βρεθεί στη σελίδα **API controls → Manage Domain-Wide delegation in Google Workspace Admin console**.
3. **Προσάρτηση προνομίων OAuth scopes**: Κατά τη διαμόρφωση μιας νέας ανάθεσης, η Google απαιτεί μόνο 2 παραμέτρους, τον Αναγνωριστικό πελάτη, που είναι το **OAuth ID του πόρου λογαριασμού υπηρεσίας GCP**, και τα **OAuth scopes** που καθορίζουν ποιες κλήσεις API απαιτεί η ανάθεση.
* Η **πλήρης λίστα των OAuth scopes** μπορεί να βρεθεί [**εδώ**](https://developers.google.com/identity/protocols/oauth2/scopes), αλλά εδώ υπάρχει μια σύσταση: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Ενεργώντας εκ μέρους της στόχου ταυτότητας:** Σε αυτό το σημείο, έχουμε ένα λειτουργικό ανατεθειμένο αντικείμενο στο GWS. Τώρα, **χρησιμοποιώντας το ιδιωτικό κλειδί του λογαριασμού υπηρεσίας GCP, μπορούμε να πραγματοποιήσουμε κλήσεις API** (στο πεδίο που καθορίζεται από την παράμετρο OAuth scope) για να το ενεργοποιήσουμε και να **ενεργούμε εκ μέρους οποιασδήποτε ταυτότητας υπάρχει στο Google Workspace**. Όπως μάθαμε, ο λογαριασμός υπηρεσίας θα δημιουργήσει διακριτικά πρόσβασης ανάλογα με τις ανάγκες του και σύμφωνα με την άδεια που έχει για εφαρμογές REST API.
* Ελέγξτε την **προηγούμενη ενότητα** για μερικά **εργαλεία** που χρησιμοποιούν αυτήν την ανάθεση.

#### Διασυνοριακή ανάθεση

Το ID του OAuth SA είναι παγκόσμιο και μπορεί να χρησιμοποιηθεί για **διασυνοριακή ανάθεση**. Δεν έχει εφαρμοστεί καμία περιοριστική διάταξη για να αποτραπεί η διασυνοριακή ανάθεση. Απλά, **οι λογαριασμοί υπηρεσίας από διάφορες οργανώσεις GCP μπορούν να χρησιμοποιηθούν για να διαμορφώσουν παγκόσμια ανάθεση σε άλλες οργανώσεις Workspace**. Αυτό θα οδηγήσει στο να χρειάζεται μόνο πρόσβαση Super Admin στο Workspace, και όχι πρόσβαση στον ίδιο λογαριασμό GCP, καθώς ο αντίπαλος μπορεί να δημιουργήσει λογαριασμούς υπηρεσίας και ιδιωτικά κλειδιά στον προσωπικά ελεγχόμενο λογαριασμό GCP του.

### Δημιουργία έργου για απαρίθμηση Workspace

Από προεπιλογή, οι χρήστες του Workspace έχουν την άδεια να **δημιουργούν νέα έργα**, και όταν δημιουργείται ένα νέο έργο, ο **δημιουργός αποκτά τον ρόλο Κάτοχος** πάνω του.

Επομένως, ένας χρήστης μπορεί να **δημιουργήσει ένα έργο**, να **ενεργοποιήσει τις APIs** για να απαριθμήσει το Workspace στο νέο έργο του και να προσπαθήσει να το **απαριθμήσει**.

{% hint style="danger" %}
Για να μπορεί ένας χρήστης να απαριθμήσει το Workspace, χρειάζεται επαρκή δικαιώματα στο Workspace (όχι όλοι οι χρήστες θα μπορούν να απαριθμήσουν τον κατάλογο).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Ελέγξτε **περισσότερες απαρίθμησης στο**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Από το GWS στο GCP

### Πρόσβαση σε προνομιούχους χρήστες GCP

Εάν ένας επιτιθέμενος έχει πλήρη πρόσβαση στο GWS, θα μπορεί να έχει πρόσβαση σε ομάδες με προνομιούχη πρόσβαση στο GCP ή ακόμα και σε χρήστες, επομένως η μετάβαση από το GWS στο GCP είναι συνήθως πιο "απλή" απλά επειδή **οι χρήστες στο GWS έχουν υψηλά προνόμια στο GCP**.

### Ανέβασμα Προνομιούχων Ομάδων της Google

Από προεπιλογή, οι χρήστες μπορούν **ελεύθερα να εγγραφούν σε ομάδες Workspace του Οργανισμού** και αυτές οι ομάδες **μπορεί να έχουν ανατεθεί δικαιώματα GCP** (ελέγξτε τις ομάδες σας στο [https://groups.google.com/](https://groups.google.com/)).

Εκμεταλλευόμενος το **google groups privesc** μπορείτε να ανέβετε σε μια ομάδα με κάποιο είδος προνομιούχη πρόσβαση στο GCP.

### Αναφορές

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
