# GCP <--> Workspace Pivoting

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitteru** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Od GCP-a do GWS-a**

### **Osnove Delegacije na Nivou Domena**

Delegacija na nivou domena u Google Workspace-u omogućava objektu identiteta, bilo da je to **spoljni aplikacija** sa Google Workspace Marketplace-a ili interni **GCP Servisni Nalog**, da **pristupi podacima širom Workspace-a u ime korisnika**.

{% hint style="info" %}
Ovo u osnovi znači da **servisni nalozi** unutar GCP projekata organizacije mogu **impersonirati korisnike Workspace-a** iste organizacije (ili čak iz druge).
{% endhint %}

Za više informacija o tome kako tačno funkcioniše, pogledajte:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromitovanje postojeće delegacije

Ako napadač **kompromituje neki pristup preko GCP-a** i **pozna validnu email adresu korisnika Workspace-a** (po mogućstvu **super admina**) kompanije, mogao bi **enumerisati sve projekte** do kojih ima pristup, **enumerisati sve servisne naloge** projekata, proveriti na koje **servisne naloge ima pristup**, i **ponoviti** sve ove korake sa svakim SA-om kojeg može impersonirati.\
Sa **listom svih servisnih naloga** do kojih ima **pristup** i listom **email adresa Workspace-a**, napadač bi mogao pokušati da **impersonira korisnika sa svakim servisnim nalogom**.

{% hint style="danger" %}
Imajte na umu da prilikom konfigurisanja delegacije na nivou domena nije potreban korisnik Workspace-a, stoga je dovoljno znati **jednog validnog i potrebnog korisnika za impersonaciju**.\
Međutim, **privilegije impersoniranog korisnika će biti korišćene**, pa ako je to Super Admin, bićete u mogućnosti pristupiti svemu. Ako nema nikakav pristup, ovo će biti beskorisno.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Ovo je alat koji može izvršiti napad prateći ove korake:

1. **Enumeracija GCP Projekata** korišćenjem Resource Manager API-ja.
2. Iteriranje kroz svaki resurs projekta, i **enumeracija resursa GCP Servisnih naloga** do kojih početni IAM korisnik ima pristup korišćenjem _GetIAMPolicy_.
3. Iteriranje kroz **svaku ulogu servisnog naloga**, i pronalaženje ugrađenih, osnovnih i prilagođenih uloga sa dozvolom _**serviceAccountKeys.create**_ na ciljnom resursu servisnog naloga. Treba napomenuti da uloga Editor inherentno poseduje ovu dozvolu.
4. Kreiranje **novog `KEY_ALG_RSA_2048`** privatnog ključa za svaki resurs servisnog naloga koji je pronađen sa relevantnom dozvolom u IAM politici.
5. Iteriranje kroz **svaki novi servisni nalog i kreiranje `JWT`** **objekta** za njega koji se sastoji od kredencijala privatnog ključa SA i OAuth opsega. Proces kreiranja novog _JWT_ objekta će **iterirati kroz sve postojeće kombinacije OAuth opsega** iz **oauth\_scopes.txt** liste, kako bi pronašao sve mogućnosti delegacije. Lista **oauth\_scopes.txt** je ažurirana sa svim OAuth opsezima koje smo smatrali relevantnim za zloupotrebu identiteta Workspace-a.
6. Metoda `_make_authorization_grant_assertion` otkriva potrebu za deklarisanjem **ciljnog korisnika Workspace-a**, nazvanog _subject_, za generisanje JWT-ova u okviru DWD. Iako se može činiti da je potreban određeni korisnik, važno je shvatiti da **DWD utiče na svaki identitet unutar domena**. Stoga, kreiranje JWT-a za **bilo kog korisnika domena** utiče na sve identitete u tom domenu, u skladu sa našom proverom kombinacija. Jednostavno rečeno, jedan validan korisnik Workspace-a je dovoljan za nastavak.\
Ovaj korisnik može biti definisan u _config.yaml_ fajlu DeleFriend-a. Ako ciljni korisnik Workspace-a već nije poznat, alat omogućava automatsko identifikovanje validnih korisnika Workspace-a skeniranjem korisnika domena sa ulogama na GCP projektima. Važno je napomenuti (ponovo) da su JWT-ovi specifični za domen i nisu generisani za svakog korisnika; stoga, automatski proces cilja na jedinstveni identitet po domenu.
7. **Enumeracija i kreiranje novog bearer pristupnog tokena** za svaki JWT i validacija tokena protiv tokeninfo API-ja.

#### [Gitlab-ov Python skript](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab je kreirao [ovu Python skriptu](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) koja može uraditi dve stvari - listati korisnički direktorijum i kreirati novi administratorski nalog uz navođenje json-a sa SA kredencijalima i korisnikom za impersonaciju. Evo kako biste je koristili:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Kreiranje nove delegacije (Održivost)

Moguće je **proveriti Delegacije na nivou domena** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Napadač sa mogućnošću **kreiranja servisnih naloga u GCP projektu** i **super admin privilegijama u GWS može kreirati novu delegaciju koja omogućava servisnim nalozima da se predstavljaju kao neki GWS korisnici:**

1. **Generisanje novog servisnog naloga i odgovarajućeg para ključeva:** Na GCP-u, nove resurse servisnih naloga možemo proizvesti interaktivno putem konzole ili programatski korišćenjem direktnih API poziva i CLI alata. Za ovo je potrebna **uloga `iam.serviceAccountAdmin`** ili bilo koja prilagođena uloga opremljena sa dozvolom **`iam.serviceAccounts.create`**. Kada je servisni nalog kreiran, nastavljamo sa generisanjem **povezanog para ključeva** (dozvola **`iam.serviceAccountKeys.create`**).
2. **Kreiranje nove delegacije**: Važno je razumeti da **samo uloga Super Admin poseduje sposobnost postavljanja globalne Delegacije na nivou domena u Google Workspace-u** i Delegacija na nivou domena **ne može biti postavljena programatski,** Može se samo kreirati i prilagoditi **ručno** putem Google Workspace **konzole**.
* Pravilo za kreiranje može se naći na stranici **API kontrole → Upravljanje Delegacijom na nivou domena u Google Workspace Admin konzoli**.
3. **Povezivanje privilegija OAuth opsega**: Prilikom konfigurisanja nove delegacije, Google zahteva samo 2 parametra, Client ID, koji je **OAuth ID GCP Servisnog naloga** resursa, i **OAuth opsege** koji definišu koje API pozive delegacija zahteva.
* **Puna lista OAuth opsega** može se naći [**ovde**](https://developers.google.com/identity/protocols/oauth2/scopes), ali evo preporuke: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Delovanje u ime ciljnog identiteta:** U ovom trenutku, imamo funkcionalni delegirani objekat u GWS. Sada, **korišćenjem privatnog ključa GCP Servisnog naloga, možemo izvršiti API pozive** (u opsegu definisanom u OAuth opsegu parametra) da ga pokrenemo i **delujemo u ime bilo kog identiteta koji postoji u Google Workspace-u**. Kao što smo naučili, servisni nalog će generisati pristupne tokene prema svojim potrebama i u skladu sa dozvolama koje ima za REST API aplikacije.
* Proverite **prethodni odeljak** za neke **alate** za korišćenje ove delegacije.

#### Delegacija preko organizacija

OAuth SA ID je globalan i može se koristiti za **delegaciju preko organizacija**. Nije implementirana nikakva restrikcija koja sprečava prekograničnu delegaciju. Jednostavno rečeno, **servisni nalozi iz različitih GCP organizacija mogu se koristiti za konfigurisanje delegacije na nivou domena u drugim organizacijama Workspace-a**. To bi rezultiralo u tome da je **potrebno samo Super Admin pristup Workspace-u**, a ne pristup istom GCP nalogu, jer napadač može kreirati Servisne naloge i privatne ključeve na svom lično kontrolisanom GCP nalogu.

### Kreiranje projekta radi enumeracije Workspace-a

Po **podrazumevanim podešavanjima**, korisnici Workspace-a imaju dozvolu da **kreiraju nove projekte**, i kada se novi projekat kreira, **kreator dobija ulogu Vlasnika** nad njim.

Stoga, korisnik može **kreirati projekat**, **omogućiti** **API-je** radi enumeracije Workspace-a u svom novom projektu i pokušati ga **enumerisati**.

{% hint style="opasnost" %}
Da bi korisnik mogao da enumeriše Workspace, takođe mu je potrebno dovoljno Workspace privilegija (neće svaki korisnik moći da enumeriše direktorijum).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Proverite **više enumeracije u**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Zloupotreba Gcloud-a

Možete pronaći dodatne informacije o toku `gcloud` za prijavljivanje u:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Kao što je objašnjeno tamo, gcloud može zatražiti opseg `https://www.googleapis.com/auth/drive` što bi omogućilo korisniku pristup drajvu korisnika.\
Kao napadač, ako ste fizički kompromitovali računar korisnika i korisnik je i dalje prijavljen na svoj nalog, možete se prijaviti generisanjem tokena sa pristupom drajvu korišćenjem:
```bash
gcloud auth login --enable-gdrive-access
```
Ako napadač kompromituje računar korisnika, takođe može izmeniti datoteku `google-cloud-sdk/lib/googlecloudsdk/core/config.py` i dodati u **`CLOUDSDK_SCOPES`** opseg **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Stoga, sledeći put kada se korisnik prijavi, kreiraće **token sa pristupom drajvu** koji napadač može zloupotrebiti da pristupi drajvu. Očigledno je da će pretraživač naznačiti da će generisani token imati pristup drajvu, ali kako će korisnik sam pozvati **`gcloud auth login`**, verovatno **neće posumnjati ništa.**

Za prikazivanje drajv fajlova: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Od GWS do GCP

### Pristup privilegovanim GCP korisnicima

Ako napadač ima potpuni pristup nad GWS-om, moći će da pristupi grupama sa privilegovanim pristupom nad GCP-om ili čak korisnicima, stoga prelazak sa GWS-a na GCP je obično "jednostavniji" jer **korisnici u GWS-u imaju visoke privilegije nad GCP-om**.&#x20;

### Eskalacija privilegija Google grupa

Podrazumevano, korisnici mogu **slobodno pristupiti Workspace grupama Organizacije** i te grupe **mogu imati dodeljene GCP dozvole** (proverite svoje grupe na [https://groups.google.com/](https://groups.google.com/)).

Zloupotrebom **google grupne eskalacije privilegija** možda ćete moći da pređete na grupu sa nekom vrstom privilegovanog pristupa GCP-u.

### Reference

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
