# Εναλλαγή μεταξύ GCP <--> Workspace

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Ερυθρού Συνεργείου HackTricks AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## **Από το GCP στο GWS**

### **Βασικά για την ανάθεση σε όλο τον τομέα**

Η ανάθεση σε όλο τον τομέα του Google Workspace επιτρέπει σε ένα αντικείμενο ταυτότητας, είτε μια **εξωτερική εφαρμογή** από την αγορά του Google Workspace είτε ένα εσωτερικό **Λογαριασμό Υπηρεσίας του GCP**, να **έχει πρόσβαση σε δεδομένα σε όλο το Workspace εκ μέρους των χρηστών**.

{% hint style="info" %}
Αυτό σημαίνει βασικά ότι οι **λογαριασμοί υπηρεσίας** μέσα στα έργα του GCP μιας οργάνωσης μπορεί να **υποκαταστήσουν τους χρήστες του Workspace** της ίδιας οργάνωσης (ή ακόμα και από μια διαφορετική).
{% endhint %}

Για περισσότερες πληροφορίες σχετικά με το πώς ακριβώς λειτουργεί αυτό, ελέγξτε:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Παραβίαση υπάρχουσας ανάθεσης

Αν ένας επιτιθέμενος **έχει παραβιάσει κάποια πρόσβαση στο GCP** και **γνωρίζει ένα έγκυρο email χρήστη του Workspace** (επιθυμητότερα **υπερδιαχειριστής**), μπορεί να **απαριθμήσει όλα τα έργα** στα οποία έχει πρόσβαση, **να απαριθμήσει όλους τους λογαριασμούς υπηρεσίας** των έργων, να ελέγξει σε ποιους **λογαριασμούς υπηρεσίας έχει πρόσβαση**, και **να επαναλάβει** όλα αυτά τα βήματα με κάθε λογαριασμό υπηρεσίας που μπορεί να υποκαταστήσει.\
Με μια **λίστα όλων των λογαριασμών υπηρεσίας** στους οποίους έχει **πρόσβαση** και τη λίστα των **email του Workspace**, ο επιτιθέμενος μπορεί να δοκιμάσει να **υποκαταστήσει τον χρήστη με κάθε λογαριασμό υπηρεσίας**.

{% hint style="danger" %}
Σημειώστε ότι κατά τη διαμόρφωση της ανάθεσης σε όλο τον τομέα δεν απαιτείται χρήστης του Workspace, επομένως αρκεί να γνωρίζετε **έναν έγκυρο χρήστη** και αυτό είναι απαραίτητο για την υποκατάσταση.\
Ωστόσο, οι **προνομιούχοι του υποκατασταθέντος χρήστη θα χρησιμοποιηθούν**, οπότε αν είναι Υπερδιαχειριστής θα μπορείτε να έχετε πρόσβαση σε όλα. Αν δεν έχει καμία πρόσβαση, αυτό θα είναι άχρηστο.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Αυτό είναι ένα εργαλείο που μπορεί να εκτελέσει την επίθεση ακολουθώντας αυτά τα βήματα:

1. **Απαρίθμηση Έργων GCP** χρησιμοποιώντας το Resource Manager API.
2. Επανάληψη σε κάθε πόρο έργου και **απαρίθμηση των πόρων λογαριασμών υπηρεσίας του GCP** στους οποίους ο αρχικός χρήστης IAM έχει πρόσβαση χρησιμοποιώντας το _GetIAMPolicy_.
3. Επανάληψη σε **κάθε ρόλο λογαριασμού υπηρεσίας**, και εύρεση ενσωματωμένων, βασικών και προσαρμοσμένων ρόλων με άδεια _**serviceAccountKeys.create**_ στον προορισμό του πόρου λογαριασμού υπηρεσίας. Να σημειωθεί ότι ο ρόλος του Επεξεργαστή περιλαμβάνει ενσωματωμένα αυτή την άδεια.
4. Δημιουργία ενός **νέου ιδιωτικού κλειδιού `KEY_ALG_RSA_2048`** για κάθε πόρο λογαριασμού υπηρεσίας που βρέθηκε με τη σχετική άδεια στην πολιτική IAM.
5. Επανάληψη σε **κάθε νέο λογαριασμό υπηρεσίας και δημιουργία ενός `JWT`** **αντικειμένου** γι' αυτόν που αποτελείται από τα διαπιστευτήρια του ιδιωτικού κλειδιού SA και ένα εύρος OAuth. Η διαδικασία δημιουργίας ενός νέου _JWT_ αντικειμένου θα **επαναληφθεί σε όλους τους υπάρχοντες συνδυασμούς εύρων OAuth** από τη λίστα **oauth\_scopes.txt**, προκειμένου να βρεθούν όλες οι δυνατότητες ανάθεσης. Η λίστα **oauth\_scopes.txt** ενημερώνεται με όλα τα εύρη OAuth που έχουμε βρει ως σημαντικά για την κατάχρηση ταυτοτήτων Workspace.
6. Η μέθοδος `_make_authorization_grant_assertion` αποκαλύπτει την ανάγκη να δηλωθεί ένας **στόχος χρήστης Workspace**, αναφερόμενος ως _subject_, για τη δημιουργία JWT κάτω από την DWD. Αν και αυτό μπορεί να φαίνεται ότι απαιτεί ένα συγκεκριμένο χρήστη, είναι σημαντικό να συνειδητοποιήσετε ότι η **DWD επηρεάζει κάθε ταυτότητα εντός ενός τομέα**. Συνεπώς, η δημιουργία ενός JWT για **οποιονδήποτε χρήστη του τομέα** επηρεάζει όλες τις ταυτότητες σε αυτόν τον τομέα, σύμφωνα με τον έλεγχο συνδυασμού μας. Απλά, ένας έγκυρος χρήστης του Workspace είναι επαρκής για να προχωρήσει.\
Αυτός ο χρήστης μπορεί να καθοριστεί στο αρχείο _config.yaml_ του DeleFriend. Αν ένας στόχος χρήστη Workspace δεν είναι ήδη γνωστός, το εργαλείο διευκολύνει την αυτόματη εντοπισμό των έγκυρων χρηστών Workspace σάρωσης των χρηστών του τομέα με ρόλους σε έργα GCP. Είναι σημαντικό να σημειωθεί (ξανά) ότι τα JWT είναι ειδικά για τον τομέα και δεν δημιουργούνται για κάθε χρήστη· επομένως, η αυτόματη διαδικασία στοχεύει σε μια μοναδική ταυτότητα ανά τομέα.
7. **Απαρίθμηση και δημιουργία νέου διακριτικού πρόσβασης bearer** για κάθε JWT και επικ
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Δημιουργία νέας εξουσιοδότησης (Μόνιμη)

Είναι δυνατόν να **ελέγξετε τις Εξουσιοδοτήσεις Παγκόσμιας Εντολής τομέα σε** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Ένας επιτιθέμενος με τη δυνατότητα **δημιουργίας λογαριασμών υπηρεσιών σε ένα έργο GCP** και **υπερδιαχειριστικά προνόμια στο GWS μπορεί να δημιουργήσει μια νέα εξουσιοδότηση επιτρέποντας στους λογαριασμούς υπηρεσιών να προσωποποιούν μερικούς χρήστες GWS:**

1. **Δημιουργία Νέου Λογαριασμού Υπηρεσίας και Αντίστοιχου Ζεύγους Κλειδιών:** Στο GCP, νέοι πόροι λογαριασμού υπηρεσίας μπορούν να παραχθούν είτε αλληλεπιδραστικά μέσω της κονσόλας είτε προγραμματιστικά χρησιμοποιώντας άμεσες κλήσεις API και εργαλεία CLI. Αυτό απαιτεί τον **ρόλο `iam.serviceAccountAdmin`** ή οποιονδήποτε προσαρμοσμένο ρόλο εξοπλισμένο με την άδεια **`iam.serviceAccounts.create`**. Αφού δημιουργηθεί ο λογαριασμός υπηρεσίας, θα προχωρήσουμε στη δημιουργία ενός **σχετικού ζεύγους κλειδιών** (**άδεια `iam.serviceAccountKeys.create`**).
2. **Δημιουργία νέας εξουσιοδότησης**: Είναι σημαντικό να κατανοήσουμε ότι **μόνο ο ρόλος Super Admin διαθέτει τη δυνατότητα να δημιουργήσει παγκόσμια εξουσιοδότηση Παγκόσμιας Εντολής στο Google Workspace** και η εξουσιοδότηση Παγκόσμιας Εντολής **δεν μπορεί να δημιουργηθεί προγραμματικά,** Μπορεί μόνο να δημιουργηθεί και να προσαρμοστεί **χειροκίνητα** μέσω της κονσόλας του Google Workspace.
* Η δημιουργία του κανόνα μπορεί να βρεθεί στη σελίδα **Ελέγχους API → Διαχείριση Παγκόσμιας Εξουσιοδότησης στην κονσόλα Διαχείρισης Google Workspace**.
3. **Επισύναψη προνομίων OAuth scopes**: Κατά τη διαμόρφωση μιας νέας εξουσιοδότησης, το Google απαιτεί μόνο 2 παραμέτρους, τον Αναγνωριστικό Πελάτη, που είναι το **ID OAuth του Λογαριασμού Υπηρεσίας GCP** και τα **OAuth scopes** που καθορίζουν ποιες κλήσεις API απαιτεί η εξουσιοδότηση.
* Η **πλήρης λίστα των OAuth scopes** μπορεί να βρεθεί [**εδώ**](https://developers.google.com/identity/protocols/oauth2/scopes), αλλά εδώ είναι μια πρόταση: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Ενεργώντας εκ μέρους της στόχος ταυτότητας:** Σε αυτό το σημείο, έχουμε ένα λειτουργικό αντικείμενο που έχει εξουσιοδοτηθεί στο GWS. Τώρα, **χρησιμοποιώντας το ιδιωτικό κλειδί του Λογαριασμού Υπηρεσίας GCP, μπορούμε να πραγματοποιήσουμε κλήσεις API** (στο εύρος που καθορίζεται στην παράμετρο OAuth scope) για να το ενεργοποιήσουμε και **να ενεργήσουμε εκ μέρους οποιασδήποτε ταυτότητας υπάρχει στο Google Workspace**. Όπως μάθαμε, ο λογαριασμός υπηρεσίας θα δημιουργήσει διακριτικά πρόσβασης ανάλογα με τις ανάγκες του και σύμφωνα με την άδεια που έχει σε εφαρμογές REST API.
* Ελέγξτε τη **προηγούμενη ενότητα** για μερικά **εργαλεία** που χρησιμοποιούν αυτήν την εξουσιοδότηση.

#### Διασυνδεσμική εξουσιοδότηση Οργανισμών

Το ID OAuth του Λογαριασμού Υπηρεσίας είναι παγκόσμιο και μπορεί να χρησιμοποιηθεί για **διασυνδεσμική εξουσιοδότηση**. Δεν έχει εφαρμοστεί καμία περιοριστική μέτρηση για να αποτρέψει τη διασυνδεσμική εξουσιοδότηση. Απλά, **οι λογαριασμοί υπηρεσιών από διαφορετικούς οργανισμούς GCP μπορούν να χρησιμοποιηθούν για τη διαμόρφωση παγκόσμιας εξουσιοδότησης Παγκόσμιας Εντολής σε άλλους οργανισμούς του Workspace**. Αυτό θα οδηγήσει στο **χρειάζεται μόνο πρόσβαση Super Admin στο Workspace**, και όχι πρόσβαση στον ίδιο λογαριασμό GCP, καθώς ο εχθρός μπορεί να δημιουργήσει Λογαριασμούς Υπηρεσιών και ιδιωτικά κλειδιά στον προσωπικά ελεγχόμενο λογαριασμό GCP του. 

### Δημιουργία Έργου για απαρίθμηση Workspace

Από **προεπιλογή** οι **χρήστες του Workspace** έχουν την άδεια να **δημιουργήσουν νέα έργα**, και όταν δημιουργείται ένα νέο έργο ο **δημιουργός αποκτά τον ρόλο Κάτοχος** πάνω σε αυτό.

Συνεπώς, ένας χρήστης μπορεί να **δημιουργήσει ένα έργο**, **ενεργοποιήσει** τις **APIs** για απαρίθμηση του Workspace στο νέο του έργο και να προσπαθήσει να το **απαριθμήσει**.

{% hint style="danger" %}
Για να μπορεί ένας χρήστης να απαριθμήσει το Workspace, χρειάζεται επαρκή δικαιώματα στο Workspace (όχι όλοι οι χρήστες θα μπορούν να απαριθμήσουν τον κατάλογο).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Ελέγξτε **περισσότερη απαρίθμηση στο**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Κατάχρηση του Gcloud

Μπορείτε να βρείτε περισσότερες πληροφορίες σχετικά με τη ροή του `gcloud` για σύνδεση στο:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Όπως εξηγείται εκεί, το gcloud μπορεί να ζητήσει την εμβέλεια `https://www.googleapis.com/auth/drive` η οποία θα επιτρέψει σε έναν χρήστη να έχει πρόσβαση στον φάκελο του χρήστη.\
Ως επιτιθέμενος, αν έχετε διαρρήξει **φυσικά** τον υπολογιστή ενός χρήστη και ο **χρήστης είναι ακόμα συνδεδεμένος** με τον λογαριασμό του, μπορείτε να συνδεθείτε δημιουργώντας ένα τεκμήριο με πρόσβαση στον φάκελο χρήσης χρησιμοποιώντας:
```bash
gcloud auth login --enable-gdrive-access
```
Αν ένας επιτιθέμενος αφού διαρρεύσει τον υπολογιστή ενός χρήστη, μπορεί επίσης να τροποποιήσει το αρχείο `google-cloud-sdk/lib/googlecloudsdk/core/config.py` και να προσθέσει στο **`CLOUDSDK_SCOPES`** το scope **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Έτσι, την επόμενη φορά που ο χρήστης θα συνδεθεί, θα δημιουργήσει ένα **token με πρόσβαση στο drive** που ο επιτιθέμενος θα μπορούσε να καταχραστεί για πρόσβαση στο drive. Φυσικά, ο περιηγητής θα υποδείξει ότι το δημιουργημένο token θα έχει πρόσβαση στο drive, αλλά καθώς ο χρήστης θα καλέσει ο ίδιος την εντολή **`gcloud auth login`**, πιθανόν **δεν θα υποψιάζεται τίποτα.**

Για να εμφανιστούν οι αρχεία του drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Από GWS σε GCP

### Πρόσβαση σε προνομιούχους χρήστες GCP

Αν ένας επιτιθέμενος έχει πλήρη πρόσβαση στο GWS, θα μπορεί να έχει πρόσβαση σε ομάδες με προνομιούχη πρόσβαση στο GCP ή ακόμη και σε χρήστες, επομένως η μετάβαση από το GWS στο GCP είναι συνήθως πιο "απλή" απλά επειδή **οι χρήστες στο GWS έχουν υψηλά προνόμια στο GCP.**

### Ανάδειξη προνομιούχων μελών Google Groups

Από προεπιλογή, οι χρήστες μπορούν **ελεύθερα να εγγραφούν σε ομάδες Workspace του Οργανισμού** και αυτές οι ομάδες **ενδέχεται να έχουν ανατεθεί δικαιώματα GCP** (ελέγξτε τις ομάδες σας στο [https://groups.google.com/](https://groups.google.com/)).

Χρησιμοποιώντας την **ανάδειξη προνομιούχων μελών Google**, μπορείτε να αναβαθμίσετε σε μια ομάδα με κάποιο είδος προνομιούχης πρόσβασης στο GCP.

### Αναφορές

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)
