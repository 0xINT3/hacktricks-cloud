# GCP <--> Workspace Pivoting

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**offisi√´le PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## **Van GCP na GWS**

### **Basiese beginsels van domeinwye delegasie**

Google Workspace se Domeinwye delegasie maak dit moontlik vir 'n identiteitsobjek, √≥f 'n **eksterne app** van die Google Workspace-markplek √≥f 'n interne **GCP-diensrekening**, om **toegang tot data regoor die Workspace namens gebruikers** te verkry.

{% hint style="info" %}
Dit beteken basies dat **diensrekeninge** binne GCP-projekte van 'n organisasie moontlik in staat sal wees om Workspace-gebruikers van dieselfde organisasie (of selfs van 'n ander organisasie) te **verpersoonlik**.
{% endhint %}

Vir meer inligting oor hoe dit presies werk, kyk na:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromitteer bestaande delegasie

As 'n aanvaller **toegang tot GCP gekry het** en 'n geldige Workspace-gebruiker se e-posadres (verkieslik **super-admin**) van die maatskappy ken, kan hy **alle projekte opnoem** waarop hy toegang het, **alle diensrekeninge opnoem**, nagaan tot watter **diensrekeninge hy toegang het**, en hierdie stappe met elke diensrekening herhaal.\
Met 'n **lys van al die diensrekeninge** waarop hy **toegang** het en die lys van **Workspace-e-posse**, kan die aanvaller probeer om **gebruiker te verpersoonlik met elke diensrekening**.

{% hint style="danger" %}
Let daarop dat wanneer die domeinwye delegasie gekonfigureer word, geen Workspace-gebruiker benodig word nie. Daarom is dit genoeg om net **een geldige gebruiker te ken en dit is nodig vir die verpersoonliking**.\
Die **bevoegdhede van die verpersoonlikte gebruiker sal egter gebruik word**, so as dit 'n Super Admin is, sal jy toegang tot alles h√™. As dit geen toegang het nie, sal dit nutteloos wees.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Dit is 'n instrument wat die aanval kan uitvoer deur hierdie stappe te volg:

1. **Noem GCP-projekte op** deur die Resource Manager API te gebruik.
2. Gaan voort met elke projekbron en **noem GCP-diensrekeningbronne op** waarop die aanvanklike IAM-gebruiker toegang het deur _GetIAMPolicy_ te gebruik.
3. Gaan voort met **elke diensrekeningrol** en vind ingeboude, basiese en aangepaste rolle met _**serviceAccountKeys.create**_-toestemming op die teikendiensrekeningbron. Dit moet opgemerk word dat die Editor-rol hierdie toestemming inherent besit.
4. Skep 'n **nuwe `KEY_ALG_RSA_2048`** privaat sleutel vir elke diensrekeningbron wat gevind word met relevante toestemming in die IAM-beleid.
5. Gaan voort met **elke nuwe diensrekening en skep 'n `JWT`-voorwerp** daarvoor wat bestaan uit die SA privaat sleutel-legitimasie en 'n OAuth-skoop. Die proses om 'n nuwe _JWT_-voorwerp te skep, sal **alle bestaande kombinasies van OAuth-skopes** uit die lys **oauth\_scopes.txt** deurloop om al die moontlikhede vir delegasie te vind. Die lys **oauth\_scopes.txt** word opgedateer met al die relevante OAuth-skopes wat ons gevind het vir die misbruik van Workspace-identiteite.
6. Die metode `_make_authorization_grant_assertion` onthul die noodsaaklikheid om 'n t**eikengebruiker van die werkspasie te verklaar**, bekend as _subject_, vir die generering van JWT's onder DWD. Alhoewel dit mag lyk asof 'n spesifieke gebruiker vereis word, is dit belangrik om te besef dat **DWD elke identiteit binne 'n domein be√Ønvloed**. Gevolglik be√Ønvloed die skepping van 'n JWT vir **enige domeingebruiker** alle identiteite in daardie domein, in ooreenstemming met ons kombinasie-opnoemkontrole. Met ander woorde, een geldige Workspace-gebruiker is voldoende om voort te gaan.\
Hierdie gebruiker kan in DeleFriend se _config.yaml_-l√™er gedefinieer word. As 'n teikengebruiker van die werkspasie nog nie bekend is nie, fasiliteer die instrument die outomatiese identifikasie van geldige werkspasiegebruikers deur domeingebruikers met rolle op GCP-projekte te skandeer. Dit is belangrik om (weer) daarop te let dat JWT's domeinspesifiek is en nie vir elke gebruiker gegenereer word nie; dus teiken die outomatiese proses 'n enkele unieke identiteit per domein.
7. Noem op en skep 'n nuwe draer-toegangsteken vir elke JWT en valideer die teken teen die tokeninfo API.

#### [Gitlab se Python-skrip](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab het [hierdie Python-skrip](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) geskep wat twee dinge kan doen - die gebruikersgids lys en 'n nuwe administratiewe rekening skep terwyl 'n json met SA-legitimasie en die gebruiker om te verpersoonlik aangedui word. Hier is hoe jy dit sou gebruik:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Skep 'n nuwe delegasie (Volharding)

Dit is moontlik om **Domeinwye Delegasies te kontroleer in** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

'n Aanvaller met die vermo√´ om **diensrekeninge in 'n GCP-projek te skep** en **super-admin-voorregte vir GWS te h√™, kan 'n nuwe delegasie skep wat SAs in staat stel om as sommige GWS-gebruikers op te tree:**

1. **Die skep van 'n nuwe diensrekening en ooreenstemmende sleutelpaar:** Op GCP kan nuwe diensrekeningbronne √≥f interaktief via die konsole geproduseer word, √≥f programmaties deur middel van direkte API-oproepe en CLI-hulpmiddels. Dit vereis die **rol `iam.serviceAccountAdmin`** of enige aangepaste rol wat toegerus is met die **`iam.serviceAccounts.create`-toestemming**. Sodra die diensrekening geskep is, sal ons voortgaan om 'n **verwante sleutelpaar** te genereer (**`iam.serviceAccountKeys.create`-toestemming**).
2. **Die skep van 'n nuwe delegasie**: Dit is belangrik om te verstaan dat **slegs die Super Admin-rol die vermo√´ besit om globale Domeinwye delegasie in Google Workspace op te stel** en Domeinwye delegasie **nie programmaties opgestel kan word nie,** Dit kan slegs **handmatig** deur die Google Workspace **konsole** geskep en aangepas word.
* Die skepping van die re√´l kan gevind word onder die bladsy **API-beheer ‚Üí Bestuur van Domeinwye delegasie in die Google Workspace Admin-konsole**.
3. **Die toekenning van OAuth-skoopvoorregte**: Wanneer 'n nuwe delegasie gekonfigureer word, vereis Google slegs 2 parameters, die Kli√´nt-ID, wat die **OAuth-ID van die GCP-diensrekening**-bron is, en **OAuth-skoopvoorregte** wat bepaal watter API-oproepe die delegasie vereis.
* Die **volledige lys van OAuth-skoopvoorregte** kan [**hier**](https://developers.google.com/identity/protocols/oauth2/scopes) gevind word, maar hier is 'n aanbeveling: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Optrede namens die teikenidentiteit:** Op hierdie punt het ons 'n funksionerende gedelegeerde objek in GWS. Nou kan ons, **deur die gebruik van die GCP-diensrekening se privaatsleutel, API-oproepe uitvoer** (binne die omvang wat in die OAuth-skoopparameter gedefinieer is) om dit te aktiveer en **namens enige identiteit wat in Google Workspace bestaan, optree**. Soos ons geleer het, sal die diensrekening toegangstokens genereer volgens sy behoeftes en volgens die toestemming wat hy het vir REST API-toepassings.
* Kyk na die **vorige afdeling** vir 'n paar **hulpmiddels** om hierdie delegasie te gebruik.

#### Kruisorganisasie-delegasie

OAuth SA ID is globaal en kan gebruik word vir **kruisorganisasie-delegasie**. Daar is geen beperking ge√Ømplementeer om kruis-globale delegasie te voorkom nie. In eenvoudige terme kan **diensrekeninge van verskillende GCP-organisasies gebruik word om domeinwye delegasie op ander Workspace-organisasies te konfigureer**. Dit sou daartoe lei dat daar slegs Super Admin-toegang tot Workspace benodig word, en nie toegang tot dieselfde GCP-rekening nie, aangesien die teenstander diensrekeninge en privaatsleutels op sy persoonlik beheerde GCP-rekening kan skep.

### Die skep van 'n projek om Workspace te ondersoek

By **standaard** het Workspace-**gebruikers** die toestemming om **nuwe projekte te skep**, en wanneer 'n nuwe projek geskep word, kry die **skepper die Eienaar-rol** daaroor.

Daarom kan 'n gebruiker 'n projek **skep**, die **API's aktiveer** om Workspace in sy nuwe projek te ondersoek en probeer om dit te **ondersoek**.

{% hint style="danger" %}
Om in staat te wees om Workspace te ondersoek, moet 'n gebruiker ook genoeg Workspace-toestemmings h√™ (nie elke gebruiker sal die gids kan ondersoek nie).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Kyk **meer opsporing in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Van GWS na GCP

### Toegang tot bevoorregte GCP-gebruikers

As 'n aanvaller volledige toegang het tot GWS, sal hy in staat wees om toegang te verkry tot groepe met bevoorregte toegang tot GCP of selfs gebruikers, daarom is die oorgang van GWS na GCP gewoonlik meer "eenvoudig" omdat **gebruikers in GWS ho√´ voorregte het oor GCP**.&#x20;

### Google Groups Voorregverhoging

Standaard kan gebruikers **vrylik by Workspace-groepe van die Organisasie aansluit** en daardie groepe **mag GCP-toestemmings** toegewys h√™ (kontroleer jou groepe by [https://groups.google.com/](https://groups.google.com/)).

Deur die **google groups privesc** te misbruik, kan jy dalk opklim na 'n groep met 'n vorm van bevoorregte toegang tot GCP.

### Verwysings

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
