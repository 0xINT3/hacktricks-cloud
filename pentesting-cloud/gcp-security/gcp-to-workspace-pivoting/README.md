# GCP <--> Workspace Pivoting

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **De GCP √† GWS**

### **Bases de la d√©l√©gation de domaine**

La d√©l√©gation de domaine de Google Workspace permet √† un objet identit√©, soit une **application externe** du Google Workspace Marketplace soit un **compte de service GCP interne**, d'**acc√©der aux donn√©es de l'ensemble du Workspace au nom des utilisateurs**.

{% hint style="info" %}
Cela signifie essentiellement que les **comptes de service** √† l'int√©rieur des projets GCP ou d'une organisation pourraient √™tre capables d'**usurper l'identit√© des utilisateurs de Workspace** de la m√™me organisation (ou m√™me d'une autre).
{% endhint %}

Pour plus d'informations sur le fonctionnement exact, consultez :

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromettre une d√©l√©gation existante

Si un attaquant a compromis un acc√®s sur GCP et dispose d'une liste d'utilisateurs Workspace valides de l'entreprise, il pourrait **√©num√©rer** tous les **projets** auxquels il a acc√®s, **√©num√©rer** tous les **comptes de service (SAs)** des projets, **essayer** d'**usurper l'identit√©** de chaque **compte de service**, et **r√©p√©ter** toutes ces **√©tapes** avec **chaque SA** qu'il peut usurper.\
Avec une **liste de tous les comptes de service** auxquels il a **acc√®s** et la liste des **emails Workspace**, l'attaquant pourrait essayer d'**usurper l'identit√© de chaque utilisateur avec chaque compte de service**.

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

C'est un outil qui peut effectuer l'attaque en suivant ces √©tapes :

1. **√ânum√©rer les projets GCP** en utilisant l'API Resource Manager.
2. It√©rer sur chaque ressource de projet et **√©num√©rer les ressources de compte de service GCP** auxquelles l'utilisateur IAM initial a acc√®s en utilisant _GetIAMPolicy_.
3. It√©rer sur **chaque r√¥le de compte de service**, et trouver des r√¥les int√©gr√©s, de base et personnalis√©s avec la permission _**serviceAccountKeys.create**_ sur la ressource de compte de service cible. Il convient de noter que le r√¥le d'√âditeur poss√®de intrins√®quement cette permission.
4. Cr√©er une **nouvelle cl√© priv√©e `KEY_ALG_RSA_2048`** pour chaque ressource de compte de service trouv√©e avec la permission pertinente dans la politique IAM.
5. It√©rer sur **chaque nouveau compte de service et cr√©er un objet `JWT`** pour celui-ci qui est compos√© des informations d'identification de la cl√© priv√©e du SA et d'une port√©e OAuth. Le processus de cr√©ation d'un nouvel objet _JWT_ va **it√©rer sur toutes les combinaisons existantes de port√©es OAuth** √† partir de la liste **oauth\_scopes.txt**, afin de trouver toutes les possibilit√©s de d√©l√©gation. La liste **oauth\_scopes.txt** est mise √† jour avec toutes les port√©es OAuth que nous avons trouv√©es pertinentes pour abuser des identit√©s Workspace.
6. La m√©thode `_make_authorization_grant_assertion` r√©v√®le la n√©cessit√© de d√©clarer un **utilisateur cible de Workspace**, appel√© _subject_, pour g√©n√©rer des JWT sous DWD. Bien que cela puisse sembler n√©cessiter un utilisateur sp√©cifique, il est important de r√©aliser que **DWD influence chaque identit√© au sein d'un domaine**. Par cons√©quent, cr√©er un JWT pour **n'importe quel utilisateur de domaine** affecte toutes les identit√©s de ce domaine, conforme √† notre v√©rification d'√©num√©ration de combinaisons. En d'autres termes, un utilisateur Workspace valide est suffisant pour avancer.\
Cet utilisateur peut √™tre d√©fini dans le fichier _config.yaml_ de DeleFriend. Si un utilisateur cible de Workspace n'est pas d√©j√† connu, l'outil facilite l'identification automatique des utilisateurs de Workspace valides en scannant les utilisateurs de domaine avec des r√¥les sur les projets GCP. Il est cl√© de noter (encore une fois) que les JWT sont sp√©cifiques au domaine et ne sont pas g√©n√©r√©s pour chaque utilisateur ; par cons√©quent, le processus automatique cible une identit√© unique par domaine.
7. **√ânum√©rer et cr√©er un nouveau jeton d'acc√®s bearer** pour chaque JWT et valider le jeton contre l'API tokeninfo.

#### [Script Python de Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab a cr√©√© [ce script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) qui peut faire deux choses - lister le r√©pertoire des utilisateurs et cr√©er un nouveau compte administratif tout en indiquant un json avec les informations d'identification du SA et l'utilisateur √† usurper. Voici comment vous l'utiliseriez :
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Cr√©er une nouvelle d√©l√©gation (Persistance)

Un attaquant avec la capacit√© de **cr√©er des comptes de service dans un projet GCP** et **le privil√®ge de super administrateur pour GWS pourrait cr√©er une nouvelle d√©l√©gation permettant aux SAs d'usurper certains utilisateurs de GWS :**

1. **G√©n√©ration d'un nouveau compte de service et d'une paire de cl√©s correspondante :** Sur GCP, de nouvelles ressources de compte de service peuvent √™tre produites soit de mani√®re interactive via la console, soit de mani√®re programmatique en utilisant des appels API directs et des outils CLI. Cela n√©cessite le **r√¥le `iam.serviceAccountAdmin`** ou tout r√¥le personnalis√© √©quip√© de la **permission `iam.serviceAccounts.create`**. Une fois le compte de service cr√©√©, nous proc√©derons √† la g√©n√©ration d'une **paire de cl√©s associ√©e** (permission **`iam.serviceAccountKeys.create`**).
2. **Cr√©ation d'une nouvelle d√©l√©gation :** Apr√®s avoir obtenu un objet d'identit√© pertinent et une cl√© priv√©e associ√©e qui permet l'authentification avec les API Google, nous devons **√©tablir une nouvelle r√®gle de d√©l√©gation pour la ressource de compte de service au sein de Google Workspace**. Cette r√®gle de d√©l√©gation nous permettra d'effectuer l'activit√© des API Google sur les applications de l'API REST de Workspace. Il est important de comprendre que **seul le r√¥le de Super Admin poss√®de la capacit√© de configurer une d√©l√©gation globale de domaine dans Google Workspace** et la d√©l√©gation de domaine **ne peut pas √™tre configur√©e de mani√®re programmatique,** elle ne peut √™tre cr√©√©e et ajust√©e que **manuellement** via la **console** de Google Workspace.

La cr√©ation de la r√®gle peut √™tre trouv√©e sous la page **Contr√¥les d'API ‚Üí G√©rer la d√©l√©gation de domaine dans la console d'administration de Google Workspace**.
3. **Attribution des privil√®ges de port√©e OAuth :** Lors de la configuration d'une nouvelle d√©l√©gation, Google ne demande que 2 param√®tres, l'ID client, qui est l'**ID OAuth de la ressource de compte de service GCP**, et les **port√©es OAuth** qui d√©finissent quels appels API la d√©l√©gation n√©cessite.\
La **liste compl√®te des port√©es OAuth** peut √™tre trouv√©e [**ici**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Agir au nom de l'identit√© cible :** √Ä ce stade, nous avons un objet d√©l√©gu√© fonctionnel dans GWS. Maintenant, **en utilisant la cl√© priv√©e du compte de service GCP, nous pouvons effectuer des appels API** (dans la port√©e d√©finie dans le param√®tre de port√©e OAuth) pour l'activer et **agir au nom de toute identit√© existant dans Google Workspace**. Comme nous l'avons appris, le compte de service g√©n√©rera des jetons d'acc√®s selon ses besoins et en fonction de la permission qu'il a pour les applications de l'API REST.

#### D√©l√©gation inter-organisationnelle

L'ID SA OAuth est global et peut √™tre utilis√© pour une **d√©l√©gation inter-organisationnelle**. Aucune restriction n'a √©t√© mise en ≈ìuvre pour emp√™cher la d√©l√©gation globale. En termes simples, **les comptes de service de diff√©rentes organisations GCP peuvent √™tre utilis√©s pour configurer une d√©l√©gation de domaine sur d'autres organisations Workspace**. Cela se traduirait par le besoin **uniquement d'un acc√®s Super Admin √† Workspace**, et non d'un acc√®s au m√™me compte GCP, car l'adversaire peut cr√©er des comptes de service et des cl√©s priv√©es sur son compte GCP personnellement contr√¥l√©.

### Cr√©er un projet pour √©num√©rer Workspace

Par **d√©faut**, les **utilisateurs** de Workspace ont la permission de **cr√©er de nouveaux projets**, et lorsque un nouveau projet est cr√©√©, le **cr√©ateur obtient le r√¥le de propri√©taire** dessus.

Par cons√©quent, un utilisateur peut **cr√©er un projet**, **activer** les **APIs** pour √©num√©rer Workspace dans son nouveau projet et essayer de **l'√©num√©rer**.

{% hint style="danger" %}
Pour qu'un utilisateur puisse √©num√©rer Workspace, il a √©galement besoin de suffisamment de permissions Workspace (tous les utilisateurs ne pourront pas √©num√©rer l'annuaire).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer C01cr71rl
```
```markdown
{% endcode %}

V√©rifiez **plus d'√©num√©ration dans** :

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## De GWS √† GCP

### Acc√©der aux utilisateurs GCP privil√©gi√©s

Si un attaquant a un acc√®s complet sur GWS, il pourra acc√©der √† des groupes avec un acc√®s privil√©gi√© sur GCP ou m√™me √† des utilisateurs, donc passer de GWS √† GCP est g√©n√©ralement plus "simple" simplement parce que **les utilisateurs dans GWS ont des privil√®ges √©lev√©s sur GCP**.

### Escalade de privil√®ges Google Groups

Par d√©faut, les utilisateurs peuvent librement rejoindre les groupes Workspace de l'Organisation et ces groupes peuvent avoir des permissions GCP assign√©es.

En abusant de l'**escalade de privil√®ges google groups**, vous pourriez √™tre capable d'escalader vers un groupe avec un certain type d'acc√®s privil√©gi√© √† GCP.

### R√©f√©rences

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
