# GCP <--> Pivoting di Workspace

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Da GCP a GWS**

### **Concetti di Delega a livello di dominio**

La delega a livello di dominio di Google Workspace consente a un oggetto di identit√†, sia un **app esterna** dal Google Workspace Marketplace che un **Service Account GCP** interno, di **accedere ai dati in tutto il Workspace per conto degli utenti**.

{% hint style="info" %}
Questo significa essenzialmente che gli **account di servizio** all'interno dei progetti GCP di un'organizzazione potrebbero essere in grado di **impersonare gli utenti di Workspace** della stessa organizzazione (o anche di un'altra).
{% endhint %}

Per ulteriori informazioni su come funziona esattamente, consulta:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromettere una delega esistente

Se un attaccante **ha compromesso l'accesso a GCP** e **conosce un'email valida di un utente di Workspace** (preferibilmente **super amministratore**) dell'azienda, potrebbe **enumerare tutti i progetti** a cui ha accesso, **enumerare tutti gli account di servizio** dei progetti, verificare a quali **account di servizio ha accesso**, e **ripetere** tutti questi passaggi con ciascun account di servizio che pu√≤ impersonare.\
Con un **elenco di tutti gli account di servizio** a cui ha **accesso** e l'elenco delle **email di Workspace**, l'attaccante potrebbe cercare di **impersonare l'utente con ciascun account di servizio**.

{% hint style="danger" %}
Nota che quando si configura la delega a livello di dominio non √® necessario un utente di Workspace, quindi basta conoscere **uno valido √® sufficiente e necessario per l'impersonazione**.\
Tuttavia, verranno utilizzati i **privilegi dell'utente impersonato**, quindi se √® un Super Amministratore sar√† possibile accedere a tutto. Se non ha alcun accesso, ci√≤ sar√† inutile.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Questo √® uno strumento che pu√≤ eseguire l'attacco seguendo questi passaggi:

1. **Enumerare i progetti GCP** utilizzando l'API del Resource Manager.
2. Iterare su ogni risorsa del progetto e **enumerare le risorse degli account di servizio GCP** a cui l'utente IAM iniziale ha accesso utilizzando _GetIAMPolicy_.
3. Iterare su **ciascun ruolo dell'account di servizio** e trovare ruoli incorporati, di base e personalizzati con il permesso _**serviceAccountKeys.create**_ sulla risorsa dell'account di servizio di destinazione. Va notato che il ruolo di Editor possiede inherentemente questo permesso.
4. Creare una **nuova chiave privata `KEY_ALG_RSA_2048`** per ciascuna risorsa dell'account di servizio trovata con il permesso pertinente nella policy IAM.
5. Iterare su **ciascun nuovo account di servizio e creare un `JWT`** **oggetto** per esso che √® composto dalle credenziali della chiave privata SA e da uno scope OAuth. Il processo di creazione di un nuovo oggetto _JWT_ **iterer√† su tutte le combinazioni esistenti di scope OAuth** dalla lista **oauth\_scopes.txt**, al fine di trovare tutte le possibilit√† di delega. La lista **oauth\_scopes.txt** viene aggiornata con tutti gli scope OAuth che abbiamo trovato rilevanti per l'abuso delle identit√† di Workspace.
6. Il metodo `_make_authorization_grant_assertion` rivela la necessit√† di dichiarare un **utente di Workspace di destinazione**, indicato come _subject_, per generare JWT in DWD. Sebbene possa sembrare necessario un utente specifico, √® importante capire che **DWD influenza ogni identit√† all'interno di un dominio**. Di conseguenza, la creazione di un JWT per **qualsiasi utente di dominio** influisce su tutte le identit√† in quel dominio, in conformit√† con il nostro controllo di enumerazione delle combinazioni. In poche parole, un utente di Workspace valido √® sufficiente per procedere.\
Questo utente pu√≤ essere definito nel file _config.yaml_ di DeleFriend. Se non si conosce gi√† un utente di Workspace di destinazione, lo strumento facilita l'identificazione automatica di utenti di Workspace validi scansionando gli utenti di dominio con ruoli nei progetti GCP. √à importante notare (ancora una volta) che i JWT sono specifici per dominio e non vengono generati per ogni utente; quindi, il processo automatico si rivolge a un'unica identit√† univoca per dominio.
7. **Enumerare e creare un nuovo token di accesso bearer** per ciascun JWT e convalidare il token tramite l'API tokeninfo.

#### [Script Python di Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab ha creato [questo script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) che pu√≤ fare due cose: elencare la directory degli utenti e creare un nuovo account amministrativo indicando un json con le credenziali SA e l'utente da impersonare. Ecco come si utilizza:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Creare una nuova delega (Persistenza)

√à possibile **verificare le Deleghe a livello di dominio** in [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Un attaccante con la capacit√† di **creare account di servizio in un progetto GCP** e **privilegi di super amministratore su GWS potrebbe creare una nuova delega che consente agli account di servizio di impersonare alcuni utenti di GWS:**

1. **Generazione di un nuovo account di servizio e coppia di chiavi corrispondente:** Su GCP, le nuove risorse degli account di servizio possono essere prodotte in modo interattivo tramite la console o in modo programmato utilizzando chiamate API dirette e strumenti CLI. Ci√≤ richiede il ruolo **`iam.serviceAccountAdmin`** o qualsiasi ruolo personalizzato dotato del permesso **`iam.serviceAccounts.create`**. Una volta creato l'account di servizio, procederemo a generare una **coppia di chiavi correlata** (permesso **`iam.serviceAccountKeys.create`**).
2. **Creazione di una nuova delega**: √à importante capire che **solo il ruolo di Super Amministratore possiede la capacit√† di configurare la delega globale a livello di dominio in Google Workspace** e la delega a livello di dominio **non pu√≤ essere configurata in modo programmato**, pu√≤ solo essere creata e regolata **manualmente** tramite la **console** di Google Workspace.
* La creazione della regola pu√≤ essere trovata nella pagina **API controls ‚Üí Manage Domain-Wide delegation nella console di amministrazione di Google Workspace**.
3. **Privilegio di allegare ambiti OAuth**: Durante la configurazione di una nuova delega, Google richiede solo 2 parametri, l'ID client, che √® l'**ID OAuth della risorsa dell'account di servizio GCP**, e gli **ambiti OAuth** che definiscono quali chiamate API richiede la delega.
* L'**elenco completo degli ambiti OAuth** pu√≤ essere trovato [**qui**](https://developers.google.com/identity/protocols/oauth2/scopes), ma ecco una raccomandazione: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Agire per conto dell'identit√† target**: A questo punto, abbiamo un oggetto delegato funzionante in GWS. Ora, **utilizzando la chiave privata dell'account di servizio GCP, possiamo effettuare chiamate API** (nell'ambito definito nel parametro ambito OAuth) per attivarlo e **agire per conto di qualsiasi identit√† presente in Google Workspace**. Come abbiamo appreso, l'account di servizio generer√† token di accesso secondo le sue esigenze e in base ai permessi che ha per le applicazioni REST API.
* Controlla la **sezione precedente** per alcuni **strumenti** per utilizzare questa delega.

#### Delega tra organizzazioni

L'ID OAuth dell'account di servizio √® globale e pu√≤ essere utilizzato per **deleghe tra organizzazioni**. Non √® stata implementata alcuna restrizione per impedire la delega tra organizzazioni globali. In parole semplici, **gli account di servizio di diverse organizzazioni GCP possono essere utilizzati per configurare la delega a livello di dominio su altre organizzazioni di Workspace**. Ci√≤ comporterebbe la necessit√† di **solo l'accesso di Super Amministratore a Workspace**, e non l'accesso allo stesso account GCP, poich√© l'avversario pu√≤ creare account di servizio e chiavi private nel suo account GCP personalmente controllato.

### Creazione di un progetto per enumerare Workspace

Per **impostazione predefinita**, gli **utenti di Workspace** hanno il permesso di **creare nuovi progetti**, e quando viene creato un nuovo progetto, il **creatore ottiene il ruolo di Proprietario** su di esso.

Pertanto, un utente pu√≤ **creare un progetto**, **abilitare** le **API** per enumerare Workspace nel suo nuovo progetto e provare a **enumerarlo**.

{% hint style="danger" %}
Affinch√© un utente possa enumerare Workspace, ha anche bisogno di abbastanza permessi di Workspace (non tutti gli utenti saranno in grado di enumerare la directory).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Controlla **ulteriori enumerazioni in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Da GWS a GCP

### Accesso agli utenti privilegiati di GCP

Se un attaccante ha completo accesso a GWS, sar√† in grado di accedere a gruppi con accesso privilegiato a GCP o addirittura agli utenti, quindi il passaggio da GWS a GCP √® di solito pi√π "semplice" semplicemente perch√© **gli utenti in GWS hanno privilegi elevati su GCP**.&#x20;

### Escalation dei privilegi di Google Groups

Per impostazione predefinita, gli utenti possono **unirsi liberamente ai gruppi di Workspace dell'Organizzazione** e quei gruppi **potrebbero avere assegnati permessi GCP** (controlla i tuoi gruppi su [https://groups.google.com/](https://groups.google.com/)).

Sfruttando la **privesc di google groups**, potresti essere in grado di scalare a un gruppo con qualche tipo di accesso privilegiato a GCP.

### Riferimenti

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
