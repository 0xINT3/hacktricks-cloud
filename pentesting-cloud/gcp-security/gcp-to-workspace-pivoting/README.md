# GCP <--> Workspace ピボット

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## **GCPからGWSへ**

### **ドメイン全体委任の基本**

Google Workspaceのドメイン全体委任は、Google Workspace Marketplaceの**外部アプリ**または内部の**GCPサービスアカウント**などのアイデンティティオブジェクトが、ユーザーに代わってWorkspace全体のデータに**アクセスする**ことを可能にします。

{% hint style="info" %}
これは基本的に、組織のGCPプロジェクト内の**サービスアカウント**が、同じ組織（または異なる組織）のWorkspaceユーザーを**なりすます**ことができることを意味します。
{% endhint %}

この仕組みがどのように機能するかの詳細については、以下をチェックしてください:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### 既存の委任の妥協

攻撃者が**GCPへのアクセスを何らかの形で侵害し**、かつ**有効なWorkspaceユーザーのメール**（できれば**スーパーアドミン**）を知っている場合、彼はアクセス可能な**すべてのプロジェクトを列挙し**、プロジェクトの**すべてのSAsを列挙し**、アクセス可能な**サービスアカウントをチェックし**、自分がなりすますことができる各SAでこれらのステップを**繰り返す**ことができます。\
**アクセス可能なすべてのサービスアカウントのリスト**と**Workspaceのメールのリスト**を持っている攻撃者は、各サービスアカウントで**ユーザーをなりすます**ことを試みることができます。

{% hint style="danger" %}
ドメイン全体委任を設定する際にはWorkspaceユーザーは必要ないため、**有効な1人を知っているだけで十分であり、なりすましに必要です**。\
ただし、**なりすましたユーザーの権限が使用される**ため、スーパーアドミンであればすべてにアクセスできます。アクセス権がなければこれは無意味です。
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

このツールは、以下のステップに従って攻撃を実行できます:

1. Resource Manager APIを使用して**GCPプロジェクトを列挙する**。
2. 各プロジェクトリソースを反復し、_GetIAMPolicy_を使用して初期IAMユーザーがアクセスできる**GCPサービスアカウントリソースを列挙する**。
3. **各サービスアカウントの役割を反復し**、対象のサービスアカウントリソースに対して_**serviceAccountKeys.create**_権限を持つ組み込み、基本、カスタムの役割を見つける。エディターの役割がこの権限を本来持っていることに注意する必要があります。
4. IAMポリシーで関連する権限が見つかった各サービスアカウントリソースに対して、**新しい`KEY_ALG_RSA_2048`**プライベートキーを作成する。
5. **各新しいサービスアカウントに対して`JWT`オブジェクトを作成し**、SAプライベートキーの資格情報とOAuthスコープを含む。新しい_JWT_オブジェクトの作成プロセスは、**oauth\_scopes.txt**リストからのOAuthスコープのすべての既存の組み合わせを反復し、すべての委任の可能性を見つけるために行われます。リスト**oauth\_scopes.txt**は、Workspaceのアイデンティティを悪用するために関連性があると判断されたすべてのOAuthスコープで更新されます。
6. `_make_authorization_grant_assertion`メソッドは、JWTを生成するためにDWDの下で**ターゲットWorkspaceユーザー**を宣言する必要があることを明らかにします。これは特定のユーザーが必要であるように思えるかもしれませんが、**DWDはドメイン内のすべてのアイデンティティに影響を与える**ことを理解することが重要です。したがって、**ドメインの任意のユーザー**に対してJWTを作成することは、そのドメインのすべてのアイデンティティに影響を与えます。これは、組み合わせの列挙チェックと一致しています。簡単に言うと、1人の有効なWorkspaceユーザーで前進するのに十分です。\
このユーザーはDeleFriendの_config.yaml_ファイルで定義できます。ターゲットWorkspaceユーザーが既に知られていない場合、ツールはGCPプロジェクトの役割を持つドメインユーザーをスキャンして有効なWorkspaceユーザーを自動的に特定する機能を提供します。再度重要なことですが、JWTはドメイン固有であり、すべてのユーザーに対して生成されるわけではないため、自動プロセスはドメインごとに単一のユニークなアイデンティティを対象とします。
7. **各JWTに対して新しいbearerアクセストークンを列挙し、作成し**、tokeninfo APIに対してトークンを検証する。

#### [GitlabのPythonスクリプト](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlabは[このPythonスクリプト](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)を作成しました。これは2つのことができます - ユーザーディレクトリをリストアップし、SAの資格情報となりすますユーザーを示すjsonを指定しながら新しい管理アカウントを作成します。使用方法は次のとおりです：
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### 新しい委任の作成（永続性）

**ドメイン全体の委任を確認することができます** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**。**

攻撃者は、**GCPプロジェクト内でサービスアカウントを作成する能力**と**GWSのスーパー管理者権限**を持っていれば、SAsがGWSユーザーの一部を偽装する新しい委任を作成することができます：

1. **新しいサービスアカウントと対応するキーペアの生成：** GCPでは、新しいサービスアカウントリソースは、コンソールを介して対話的に、または直接API呼び出しやCLIツールを使用してプログラム的に生成することができます。これには、**役割 `iam.serviceAccountAdmin`** または **`iam.serviceAccounts.create`** **権限**を備えたカスタム役割が必要です。サービスアカウントが作成されたら、関連する**キーペア**を生成する手順に進みます（**`iam.serviceAccountKeys.create`** 権限）。
2. **新しい委任の作成：** **Google Workspaceでグローバルドメイン全体の委任を設定できるのはスーパー管理者役割のみであることを理解することが重要です**。ドメイン全体の委任は**プログラム的に設定することはできず**、Google Workspaceの**コンソール**を通じて**手動で**のみ作成および調整することができます。
* ルールの作成は、**APIコントロール → Google Workspace管理コンソールでドメイン全体の委任を管理**のページで見つけることができます。
3. **OAuthスコープ権限の添付：** 新しい委任を設定する際、GoogleはクライアントID（GCPサービスアカウントリソースの**OAuth ID**）と委任が必要とするAPI呼び出しを定義する**OAuthスコープ**の2つのパラメータのみを要求します。
* **OAuthスコープの完全なリスト**は[**こちら**](https://developers.google.com/identity/protocols/oauth2/scopes)で見つけることができますが、こちらがおすすめです：`https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **対象のアイデンティティに代わって行動する：** この時点で、GWSに機能する委任オブジェクトがあります。今、**GCPサービスアカウントのプライベートキーを使用して、API呼び出しを行い**（OAuthスコープパラメータで定義された範囲内で）、Google Workspaceに存在する任意のアイデンティティに代わって**行動することができます**。学んだように、サービスアカウントは、REST APIアプリケーションへの権限に応じて、必要に応じてアクセストークンを生成します。
* この委任を使用するための**ツール**については、**前のセクション**を確認してください。

#### 組織間委任

OAuth SA IDはグローバルであり、**組織間委任**に使用することができます。クロスグローバル委任を防ぐための制限は実装されていません。簡単に言うと、**異なるGCP組織のサービスアカウントを使用して、他のWorkspace組織でドメイン全体の委任を設定することができます**。これにより、同じGCPアカウントへのアクセスではなく、Workspaceへのスーパー管理者アクセスのみが必要になります。なぜなら、敵は個人的に管理しているGCPアカウントでサービスアカウントとプライベートキーを作成することができるからです。

### Workspaceを列挙するためのプロジェクトの作成

**デフォルトでは** Workspaceの**ユーザー**は**新しいプロジェクトを作成する権限**を持っており、新しいプロジェクトが作成されると、**作成者はそれに対する所有者の役割を得ます**。

したがって、ユーザーは**プロジェクトを作成し**、新しいプロジェクトで**APIを有効にして**、Workspaceを**列挙しようとする**ことができます。

{% hint style="danger" %}
ユーザーがWorkspaceを列挙できるようにするためには、十分なWorkspace権限も必要です（すべてのユーザーがディレクトリを列挙できるわけではありません）。
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

**より多くの列挙については以下をチェックしてください**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## GWSからGCPへ

### 特権を持つGCPユーザーへのアクセス

攻撃者がGWSを完全に制御している場合、GCPに特権アクセスを持つグループやユーザーにアクセスできるため、GWSからGCPへの移動は通常、「単純」です。なぜなら**GWSのユーザーはGCPに対して高い権限を持っている**からです。

### Googleグループの権限昇格

デフォルトでは、ユーザーは**組織のWorkspaceグループに自由に参加でき**、それらのグループには**GCPの権限が割り当てられている可能性があります**（[https://groups.google.com/](https://groups.google.com/)でグループをチェックしてください）。

**googleグループの権限昇格**を悪用することで、GCPへの特権アクセスを持つグループに昇格することができるかもしれません。

### 参考文献

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加するか**、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>
