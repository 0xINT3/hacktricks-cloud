# GCP <--> Workspace Pivoting

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalamu wa Timu Nyekundu ya HackTricks AWS)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## **Kutoka GCP kwenda GWS**

### **Misingi ya Uteuzi wa Upanuzi wa Kikoa**

Uteuzi wa Upanuzi wa Kikoa wa Google Workspace unaruhusu kitu cha kitambulisho, iwe ni **programu ya nje** kutoka Soko la Google Workspace au akaunti ya huduma ya ndani ya **GCP**, kupata **data kote kwenye Workspace kwa niaba ya watumiaji**.

{% hint style="info" %}
Hii kimsingi inamaanisha kwamba **akaunti za huduma** ndani ya miradi ya GCP ya shirika linaweza kuwa na uwezo wa **kujifanya kuwa watumiaji wa Workspace** wa shirika hilo (au hata kutoka shirika lingine).
{% endhint %}

Kwa habari zaidi kuhusu jinsi hii inavyofanya kazi angalia:

{% content-ref url="https://github.com/carlospolop/hacktricks-cloud/blob/sw/pentesting-cloud/gcp-security/gcp-to-workspace-pivoting/gcp-kuelewa-uteuzi-wa-upanuzi-wa-kikoa.md" %}
[https://github.com/carlospolop/hacktricks-cloud/blob/sw/pentesting-cloud/gcp-security/gcp-to-workspace-pivoting/gcp-kuelewa-uteuzi-wa-upanuzi-wa-kikoa.md](https://github.com/carlospolop/hacktricks-cloud/blob/sw/pentesting-cloud/gcp-security/gcp-to-workspace-pivoting/gcp-kuelewa-uteuzi-wa-upanuzi-wa-kikoa.md)
{% endcontent-ref %}

### Kudukua uteuzi uliopo

Ikiwa mshambuliaji **amefanikiwa kudukua ufikiaji fulani kwenye GCP** na **anajua barua pepe halali ya mtumiaji wa Workspace** (bora **msimamizi wa juu**), anaweza **kuorodhesha miradi yote** anayo ufikiaji, **kuorodhesha akaunti zote za huduma** za miradi, kuchunguza ni kwa akaunti za huduma zipi anazo ufikiaji, na **kurudia** hatua hizi zote kwa kila akaunti ya huduma anayoweza kujifanya kuwa.

{% hint style="danger" %}
Tambua kwamba wakati wa kusanidi uteuzi wa upanuzi wa kikoa hakuna haja ya mtumiaji wa Workspace, kwa hivyo kujua **mmoja halali ni wa kutosha na ni lazima kwa kujifanya kuwa**.\
Hata hivyo, **madaraka ya mtumiaji aliyejifanya yatatumiwa**, kwa hivyo ikiwa ni Msimamizi wa Juu utaweza kupata kila kitu. Ikiwa hana ufikiaji wowote hii itakuwa bure.
{% endhint %}

#### [GCP Kuzalisha Kitufe cha Uteuzi](https://github.com/carlospolop/gcp\_gen\_delegation\_token)

Skripti hii rahisi ita **zalisha kitufe cha OAuth kama mtumiaji aliyejifanya** ambacho unaweza kutumia kisha kupata APIs zingine za Google na au bila `gcloud`:

```bash
# Impersonate indicated user
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file>

# Impersonate indicated user and add additional scopes
python3 gen_delegation_token.py --user-email <user-email> --key-file <path-to-key-file> --scopes "https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid"
```

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Hii ni chombo kinachoweza kutekeleza shambulizi kwa kufuata hatua hizi:

1. **Kutambua Miradi ya GCP** kwa kutumia API ya Meneja wa Rasilmali.
2. Endelea kila rasilimali ya mradi, na **kutambua rasilimali za akaunti za Huduma za GCP** ambazo mtumiaji wa IAM wa awali ana ufikiaji kwa kutumia _GetIAMPolicy_.
3. Endelea kwenye **kila jukumu la akaunti ya huduma**, na kupata jukumu zilizojengwa, za msingi, na za desturi zenye ruhusa ya _**serviceAccountKeys.create**_ kwenye rasilimali ya akaunti ya huduma ya lengo. Ni muhimu kutambua kuwa jukumu la Mhariri linamiliki ruhusa hii kiasili.
4. Unda **ufunguo wa kibinafsi wa `KEY_ALG_RSA_2048`** mpya kwa kila rasilimali ya akaunti ya huduma ambayo imepatikana na ruhusa inayofaa kwenye sera ya IAM.
5. Endelea kwenye **kila akaunti mpya ya huduma na unda `JWT`** **kitu** kwa hiyo ambayo inajumuisha sifa za ufunguo wa kibinafsi wa SA na wigo wa OAuth. Mchakato wa kuunda kitu cha _JWT_ kipya utaendelea kwenye mchanganyiko wote uliopo wa viwango vya OAuth kutoka kwenye orodha ya **oauth\_scopes.txt**, ili kupata uwezekano wote wa kupeleka. Orodha **oauth\_scopes.txt** inasasishwa na viwango vyote vya OAuth ambavyo tumegundua kuwa muhimu kwa kutumia vibaya utambulisho wa Workspace.
6. Mbinu ya `_make_authorization_grant_assertion` inaonyesha umuhimu wa kutangaza **mtumiaji wa nafasi ya kazi ya lengo**, inayojulikana kama _subject_, kwa kuzalisha JWT chini ya DWD. Ingawa inaweza kuonekana kuwa inahitaji mtumiaji maalum, ni muhimu kuelewa kuwa **DWD inaathiri kila utambulisho ndani ya kikoa**. Kwa hivyo, kuunda JWT kwa **mtumiaji yeyote wa kikoa** kuathiri utambulisho wote katika kikoa hicho, kulingana na ukaguzi wetu wa mchanganyiko. Kwa ufupi, mtumiaji mmoja sahihi wa Workspace ni wa kutosha kuendelea mbele.\
   Mtumiaji huyu anaweza kutajwa kwenye faili ya _config.yaml_ ya DeleFriend. Ikiwa mtumiaji wa nafasi ya kazi ya lengo hajulikani tayari, chombo hicho kinasaidia kutambua moja kwa moja watumiaji sahihi wa nafasi ya kazi kwa kutafuta watumiaji wa kikoa wenye majukumu kwenye miradi ya GCP. Ni muhimu kutambua (tena) kuwa JWTs ni maalum kwa kikoa na sio kwa kila mtumiaji; hivyo, mchakato wa moja kwa moja unalenga utambulisho mmoja wa kipekee kwa kila kikoa.
7. **Tambua na unda tokeni mpya ya ufikiaji wa mwavuli** kwa kila JWT na thibitisha tokeni dhidi ya API ya tokeninfo.

#### [Skripti ya Python ya Gitlab](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab wameunda [skripti hii ya Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) ambayo inaweza kufanya mambo mawili - kuorodhesha saraka ya mtumiaji na kuunda akaunti mpya ya utawala wakati inaonyesha json na sifa za SA na mtumiaji wa kujifanya. Hapa ndio jinsi unavyoweza kutumia:

```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```

### Undelegation Mpya (Uthabiti)

Inawezekana **kuangalia Uteuzi wa Upanuzi wa Kikoa** katika [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Mshambuliaji mwenye uwezo wa **kuunda akaunti za huduma katika mradi wa GCP** na **mamlaka ya super admin kwa GWS anaweza kuunda undelegation mpya kuruhusu SAs kujifanya kuwa baadhi ya watumiaji wa GWS:**

1. **Kuzalisha Akaunti Mpya ya Huduma na Jozi ya Muhimu Inayolingana:** Kwenye GCP, rasilimali mpya za akaunti ya huduma zinaweza kuzalishwa kwa njia ya mwingiliano kupitia kiolesura au kwa kutumia wito wa API moja kwa moja na zana za CLI. Hii inahitaji **jukumu la `iam.serviceAccountAdmin`** au jukumu lolote la desturi lenye **`ruhusa ya` iam.serviceAccounts.create`**. Mara akaunti ya huduma inapoundwa, tutasonga mbele kuzalisha **jozi ya muhimu inayohusiana** (**ruhusa ya` iam.serviceAccountKeys.create\`**).
2. **Uundaji wa undelegation mpya**: Ni muhimu kuelewa kwamba **jukumu la Super Admin pekee lina uwezo wa kuanzisha undelegation ya kikoa ya ulimwengu katika Google Workspace** na undelegation ya kikoa ya ulimwengu **haiwezi kuanzishwa kwa njia ya programu,** Inaweza tu kuundwa na kurekebishwa **kwa mikono** kupitia **konsoli ya Google Workspace**.

* Uundaji wa sheria unaweza kupatikana chini ya ukurasa **Mikontrola ya API ‚Üí Simamia Undelegation ya Kikoa katika konsoli ya Usimamizi wa Google Workspace**.

3. **Kuambatanisha ruhusa za OAuth scopes**: Wakati wa kusanidi undelegation mpya, Google inahitaji vigezo 2 tu, Kitambulisho cha Mteja, ambacho ni **Kitambulisho cha OAuth cha Rasilimali ya Akaunti ya Huduma ya GCP** na **OAuth scopes** ambazo hufafanua wito wa API undelegation inahitaji.

* **Orodha kamili ya OAuth scopes** inaweza kupatikana [**hapa**](https://developers.google.com/identity/protocols/oauth2/scopes), lakini hapa kuna mapendekezo: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, https://mail.google.com/, https://www.googleapis.com/auth/drive, openid`

4. **Kutenda kwa niaba ya kitambulisho cha lengo:** Kufikia hatua hii, tuna kitu kilichoundwa kwa niaba katika GWS. Sasa, **kwa kutumia muhimu ya faragha ya Akaunti ya Huduma ya GCP, tunaweza kufanya wito wa API** (katika wigo uliofafanuliwa katika vigezo vya OAuth scope) kuziruhusu na **kutenda kwa niaba ya kitambulisho chochote kilichopo katika Google Workspace**. Kama tulivyojifunza, akaunti ya huduma itazalisha vivuli vya ufikiaji kulingana na mahitaji yake na kulingana na ruhusa anayo kwa maombi ya REST API.

* Angalia **sehemu iliyopita** kwa baadhi ya **zana** za kutumia undelegation hii.

#### Undelegation wa Msalaba wa Shirika

Kitambulisho cha OAuth SA ni cha ulimwengu na kinaweza kutumika kwa **undelegation ya msalaba wa shirika**. Hakuna kizuizi kilichotekelezwa kuzuia undelegation ya msalaba wa ulimwengu. Kwa maneno rahisi, **akaunti za huduma kutoka kwa mashirika tofauti ya GCP zinaweza kutumika kusanidi undelegation ya kikoa kwenye mashirika mengine ya Workspace**. Hii itasababisha **kuhitaji ufikiaji wa Super Admin tu kwa Workspace**, na sio ufikiaji wa akaunti sawa ya GCP, kwani adui anaweza kuunda Akaunti za Huduma na muhimu za faragha kwenye akaunti yake ya GCP inayodhibitiwa kibinafsi.

### Kuunda Mradi wa Kuhesabu Workspace

Kwa **chaguo-msingi** watumiaji wa Workspace **wanayo ruhusa ya** **kuunda miradi mipya**, na wakati mradi mpya unapoanzishwa **mjenzi anapata jukumu la Mmiliki** juu yake.

Hivyo basi, mtumiaji anaweza **kuunda mradi**, **kuwezesha** **APIs** kuhesabu Workspace katika mradi wake mpya na kujaribu **kuhesabu**.

{% hint style="danger" %}
Ili mtumiaji aweze kuhesabu Workspace pia anahitaji ruhusa za kutosha za Workspace (si kila mtumiaji ataweza kuhesabu saraka).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups (at least you can check the groups and members of the groups you belong to)
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum
gcloud identity groups memberships list --group-email=g<group-email>

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Angalia **uchambuzi zaidi katika**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Kutumia Gcloud

Unaweza kupata habari zaidi kuhusu mchakato wa `gcloud` kuingia katika:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Kama ilivyoelezwa hapo, gcloud inaweza kuomba wigo wa `https://www.googleapis.com/auth/drive` ambao ungekuruhusu mtumiaji kupata ufikivu wa diski ya mtumiaji.\
Kama muhalifu, ikiwa umefanikiwa **kimwili** kompyuta ya mtumiaji na **mtumiaji bado ameingia** kwenye akaunti yake unaweza kuingia kwa kutengeneza token na ufikivu wa diski kwa kutumia:

```bash
gcloud auth login --enable-gdrive-access
```

Ikiwa mshambuliaji anachukua udhibiti wa kompyuta ya mtumiaji, anaweza pia kuhariri faili `google-cloud-sdk/lib/googlecloudsdk/core/config.py` na kuongeza kwenye **`CLOUDSDK_SCOPES`** wigo wa **`'https://www.googleapis.com/auth/drive'`**:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Hivyo, wakati mtumiaji atakapoingia tena, atatengeneza **token yenye ufikiaji wa drive** ambao mshambuliaji anaweza kutumia kufikia drive. Kwa dhahiri, kivinjari kitabainisha kuwa token uliotengenezwa utakuwa na ufikiaji wa drive, lakini kwa kuwa mtumiaji ataita **`gcloud auth login`**, labda **hatafahamu chochote.**

Kutaja faili za drive: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## Kutoka GWS kwenda GCP

### Kupata watumiaji walio na upendeleo wa GCP

Ikiwa mshambuliaji ana ufikiaji kamili juu ya GWS ataweza kupata vikundi vyenye ufikiaji wa upendeleo juu ya GCP au hata watumiaji, hivyo kuhamia kutoka GWS kwenda GCP kawaida ni "rahisi" zaidi kwa sababu **watumiaji katika GWS wana mamlaka makubwa juu ya GCP**.

### Kupanda Daraja la Upendeleo la Vikundi vya Google

Kwa chaguo-msingi, watumiaji wanaweza **kujiunga kwa hiari na vikundi vya Workspace vya Shirika** na vikundi hivyo **vinaweza kuwa na ruhusa za GCP** zilizopewa (angalia vikundi vyako katika [https://groups.google.com/](https://groups.google.com/)).

Kwa kutumia **google groups privesc** unaweza kuweza kupanda daraja hadi kikundi chenye aina fulani ya ufikiaji wa upendeleo kwa GCP.

### Marejeo

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
