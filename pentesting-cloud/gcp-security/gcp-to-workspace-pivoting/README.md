# GCP <--> Workspace Pivoting

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## **Von GCP zu GWS**

### **Grundlagen der Domain-weiten Delegation**

Die Domain-weite Delegation von Google Workspace erm√∂glicht einem Identit√§tsobjekt, entweder einer **externen App** aus dem Google Workspace Marketplace oder einem internen **GCP-Servicekonto**, auf **Daten im gesamten Workspace im Namen von Benutzern zuzugreifen**.

{% hint style="info" %}
Dies bedeutet im Wesentlichen, dass **Servicekonten** innerhalb von GCP-Projekten einer Organisation in der Lage sein k√∂nnten, **Workspace-Benutzer** derselben Organisation (oder sogar einer anderen) zu **imitieren**.
{% endhint %}

F√ºr weitere Informationen dar√ºber, wie dies genau funktioniert, siehe:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Kompromittierung bestehender Delegation

Wenn ein Angreifer **einen gewissen Zugriff auf GCP kompromittiert hat** und die E-Mail-Adresse eines g√ºltigen Workspace-Benutzers kennt (vorzugsweise **Super-Admin**) des Unternehmens, k√∂nnte er **alle Projekte auflisten**, auf die er Zugriff hat, **alle SAs** der Projekte auflisten, √ºberpr√ºfen, auf welche **Servicekonten er Zugriff hat**, und **alle diese Schritte mit jedem SA wiederholen**, den er imitieren kann.\
Mit einer **Liste aller Servicekonten**, auf die er **Zugriff hat**, und der Liste der **Workspace-E-Mails** k√∂nnte der Angreifer versuchen, **jeden Benutzer mit jedem Servicekonto zu imitieren**.

{% hint style="danger" %}
Beachten Sie, dass bei der Konfiguration der domainweiten Delegation kein Workspace-Benutzer erforderlich ist, daher reicht es aus, **einen g√ºltigen Benutzer zu kennen, der f√ºr die Imitation erforderlich ist**.\
Die **Berechtigungen des imitierten Benutzers werden jedoch verwendet**, daher k√∂nnen Sie bei einem Super-Admin auf alles zugreifen. Wenn er keine Berechtigungen hat, ist dies nutzlos.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Dies ist ein Tool, das den Angriff gem√§√ü folgender Schritte durchf√ºhren kann:

1. **Auflisten von GCP-Projekten** unter Verwendung der Resource Manager API.
2. Iterieren Sie √ºber jeden Projektressourcen und **listen Sie GCP-Servicekontorressourcen auf**, auf die der anf√§ngliche IAM-Benutzer Zugriff hat, unter Verwendung von _GetIAMPolicy_.
3. Iterieren Sie √ºber **jede Servicekontorolle** und finden Sie integrierte, grundlegende und benutzerdefinierte Rollen mit der Berechtigung _**serviceAccountKeys.create**_ auf der Ziel-Servicekontorressource. Es sollte beachtet werden, dass die Editor-Rolle diese Berechtigung von Natur aus besitzt.
4. Erstellen Sie einen **neuen privaten Schl√ºssel vom Typ `KEY_ALG_RSA_2048`** f√ºr jede Servicekontorressource, die mit der relevanten Berechtigung in der IAM-Richtlinie gefunden wurde.
5. Iterieren Sie √ºber **jedes neue Servicekonto und erstellen Sie ein `JWT`-Objekt** daf√ºr, das aus den Anmeldeinformationen des SA-Privatschl√ºssels und einem OAuth-Bereich besteht. Der Prozess der Erstellung eines neuen _JWT_-Objekts wird **alle vorhandenen Kombinationen von OAuth-Bereichen** aus der Liste **oauth\_scopes.txt** durchlaufen, um alle Delegationsm√∂glichkeiten zu finden. Die Liste **oauth\_scopes.txt** wird mit allen von uns als relevant f√ºr den Missbrauch von Workspace-Identit√§ten gefundenen OAuth-Bereichen aktualisiert.
6. Die Methode `_make_authorization_grant_assertion` zeigt die Notwendigkeit auf, einen **Ziel-Workspace-Benutzer** zu deklarieren, der als _subject_ bezeichnet wird, um JWTs unter DWD zu generieren. Obwohl dies zun√§chst einen bestimmten Benutzer zu erfordern scheint, ist es wichtig zu erkennen, dass **DWD jede Identit√§t in einer Dom√§ne beeinflusst**. Folglich beeinflusst das Erstellen eines JWT f√ºr **einen beliebigen Dom√§nenbenutzer** alle Identit√§ten in dieser Dom√§ne, im Einklang mit unserer Kombinationsenumerationspr√ºfung. Einfach ausgedr√ºckt, ein g√ºltiger Workspace-Benutzer reicht aus, um fortzufahren.\
Dieser Benutzer kann in der Datei _config.yaml_ von DeleFriend definiert werden. Wenn ein Ziel-Workspace-Benutzer noch nicht bekannt ist, erleichtert das Tool die automatische Identifizierung g√ºltiger Workspace-Benutzer durch Scannen von Dom√§nenbenutzern mit Rollen in GCP-Projekten. Es ist wichtig zu beachten (erneut), dass JWTs dom√§nenspezifisch sind und nicht f√ºr jeden Benutzer generiert werden; daher zielt der automatische Prozess auf eine einzelne eindeutige Identit√§t pro Dom√§ne ab.
7. **Auflisten und Erstellen eines neuen Bearer-Zugriffstokens** f√ºr jedes JWT und Validieren des Tokens gegen die tokeninfo-API.

#### [Gitlabs Python-Skript](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab hat [dieses Python-Skript](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) erstellt, das zwei Dinge kann - das Benutzerverzeichnis auflisten und ein neues Administratorkonto erstellen, w√§hrend ein JSON mit SA-Anmeldeinformationen und dem zu imitierenden Benutzer angegeben wird. So w√ºrden Sie es verwenden:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Erstellen einer neuen Delegation (Persistenz)

Es ist m√∂glich, **Domain-weite Delegationen unter** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** zu √ºberpr√ºfen**.

Ein Angreifer mit der F√§higkeit, **Service-Konten in einem GCP-Projekt zu erstellen** und **Super-Admin-Berechtigungen f√ºr GWS zu haben, k√∂nnte eine neue Delegation erstellen, die es Service-Konten erm√∂glicht, einige GWS-Benutzer zu impersonieren**:

1. **Generierung eines neuen Service-Kontos und entsprechendem Schl√ºsselpaar:** Auf GCP k√∂nnen neue Ressourcen f√ºr Service-Konten entweder interaktiv √ºber die Konsole oder programmgesteuert √ºber direkte API-Aufrufe und CLI-Tools erstellt werden. Hierf√ºr ist die **Rolle `iam.serviceAccountAdmin`** oder eine benutzerdefinierte Rolle mit der **`iam.serviceAccounts.create`** **Berechtigung** erforderlich. Sobald das Service-Konto erstellt ist, fahren wir fort, ein **zugeh√∂riges Schl√ºsselpaar** zu generieren (**`iam.serviceAccountKeys.create`** Berechtigung).
2. **Erstellung einer neuen Delegation**: Es ist wichtig zu verstehen, dass **nur die Rolle des Super-Admin die F√§higkeit besitzt, eine globale Domain-weite Delegation in Google Workspace einzurichten** und Domain-weite Delegation **nicht programmgesteuert eingerichtet werden kann**. Sie kann nur **manuell** √ºber die Google Workspace **Konsole** erstellt und angepasst werden.
* Die Erstellung der Regel findet sich auf der Seite **API-Steuerungen ‚Üí Verwalten der Domain-weiten Delegation in der Google Workspace Admin-Konsole**.
3. **Zuweisen von OAuth-Berechtigungen**: Bei der Konfiguration einer neuen Delegation erfordert Google nur 2 Parameter, die Client-ID, die die **OAuth-ID des GCP-Service-Konto**-Ressource ist, und **OAuth-Berechtigungen**, die definieren, welche API-Aufrufe die Delegation erfordert.
* Die **vollst√§ndige Liste der OAuth-Berechtigungen** finden Sie [**hier**](https://developers.google.com/identity/protocols/oauth2/scopes), aber hier ist eine Empfehlung: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Im Namen der Zielidentit√§t handeln:** Zu diesem Zeitpunkt haben wir ein funktionierendes delegiertes Objekt in GWS. Jetzt k√∂nnen wir **unter Verwendung des privaten Schl√ºssels des GCP-Service-Kontos API-Aufrufe** (im Umfang, der im OAuth-Bereichsparameter definiert ist) durchf√ºhren, um es auszul√∂sen und **im Namen einer beliebigen Identit√§t, die in Google Workspace existiert, zu handeln**. Wie wir gelernt haben, wird das Service-Konto Zugriffstoken gem√§√ü seinen Anforderungen generieren und gem√§√ü den Berechtigungen, die es f√ºr REST-API-Anwendungen hat.
* √úberpr√ºfen Sie den **vorherigen Abschnitt** f√ºr einige **Tools**, um diese Delegation zu nutzen.

#### Delegation zwischen Organisationen

Die OAuth SA-ID ist global und kann f√ºr **delegierte Handlungen zwischen Organisationen** verwendet werden. Es wurde keine Einschr√§nkung implementiert, um eine globale Delegation zu verhindern. Einfach ausgedr√ºckt k√∂nnen **Service-Konten aus verschiedenen GCP-Organisationen verwendet werden, um domainweite Delegationen in anderen Workspace-Organisationen zu konfigurieren**. Dies w√ºrde bedeuten, dass **nur Super-Admin-Zugriff auf Workspace** erforderlich ist und nicht Zugriff auf dasselbe GCP-Konto, da der Angreifer Service-Konten und private Schl√ºssel in seinem pers√∂nlich kontrollierten GCP-Konto erstellen kann.

### Erstellen eines Projekts zur Auflistung von Workspace

Standardm√§√üig haben **Workspace-Benutzer** die Berechtigung, **neue Projekte zu erstellen**, und wenn ein neues Projekt erstellt wird, erh√§lt der **Ersteller die Eigent√ºmerrolle** dar√ºber.

Daher kann ein Benutzer ein Projekt **erstellen**, die **APIs aktivieren**, um Workspace in seinem neuen Projekt aufzulisten und versuchen, **es aufzulisten**.

{% hint style="danger" %}
Damit ein Benutzer Workspace auflisten kann, ben√∂tigt er auch ausreichende Workspace-Berechtigungen (nicht jeder Benutzer wird in der Lage sein, das Verzeichnis aufzulisten).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

√úberpr√ºfen Sie **weitere Enumerationen in**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Von GWS zu GCP

### Zugriff auf privilegierte GCP-Benutzer

Wenn ein Angreifer vollst√§ndigen Zugriff auf GWS hat, kann er auf Gruppen mit privilegiertem Zugriff auf GCP oder sogar Benutzer zugreifen, weshalb der √úbergang von GWS zu GCP in der Regel "einfacher" ist, einfach weil **Benutzer in GWS hohe Berechtigungen √ºber GCP haben**.&#x20;

### Google Groups Privilege Escalation

Standardm√§√üig k√∂nnen Benutzer **frei Workspace-Gruppen der Organisation beitreten** und diese Gruppen **k√∂nnen GCP-Berechtigungen** zugewiesen haben (√ºberpr√ºfen Sie Ihre Gruppen unter [https://groups.google.com/](https://groups.google.com/)).

Durch Ausnutzen der **google groups privesc** k√∂nnten Sie m√∂glicherweise zu einer Gruppe mit bestimmten privilegierten Zugriffen auf GCP eskalieren.

### Referenzen

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Weitere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
