# GCP <--> Workspace Pivoting

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahramana kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na(https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**'ı takip edin**.
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## **GCP'den GWS'ye**

### **Alan Geniş Yetkilendirme temelleri**

Google Workspace'in Alan Geniş Yetkilendirme özelliği, bir **harici uygulama** (Google Workspace Marketplace'den) veya iç **GCP Hizmet Hesabı**nın, **kullanıcılar adına Workspace üzerindeki verilere erişmesine izin verir**.

{% hint style="info" %}
Bu temelde, bir organizasyonun GCP projelerindeki **hizmet hesapları**, aynı organizasyonun (veya farklı bir organizasyonun) Workspace kullanıcılarını **taklit edebilir**.
{% endhint %}

Bu nasıl çalıştığı hakkında daha fazla bilgi için şuraya bakın:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Mevcut yetkilendirmeyi tehlikeye atma

Eğer bir saldırgan **GCP üzerinde bazı erişimleri ele geçirdiyse** ve şirketin **geçerli bir Workspace kullanıcı e-postasını** (tercihen **süper yönetici**) bildiği durumda, **erişimi olan tüm projeleri sıralayabilir**, projelerin **tüm hizmet hesaplarını sıralayabilir**, hangi **hizmet hesaplarına erişimi olduğunu** kontrol edebilir ve her bir hizmet hesabı ile bu adımları **tekrarlayabilir**.\
Erişime sahip olduğu **tüm hizmet hesapları listesi** ve **Workspace e-postaları** listesi ile saldırgan, her bir hizmet hesabı ile kullanıcıyı **taklit etmeyi deneyebilir**.

{% hint style="danger" %}
Alan geniş yetkilendirme yapılandırılırken bir Workspace kullanıcısına ihtiyaç duyulmaz, bu nedenle sadece **geçerli bir tanesini bilmek yeterlidir ve taklit için gereklidir**.\
Ancak, taklit edilen kullanıcının **yetkileri kullanılacaktır**, bu nedenle Süper Yönetici ise her şeye erişebilirsiniz. Eğer hiçbir erişimi yoksa bu işe yaramaz olacaktır.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Bu, aşağıdaki adımları takip ederek saldırıyı gerçekleştirebilen bir araçtır:

1. Kaynak Yöneticisi API'sını kullanarak **GCP Projelerini sıralayın**.
2. Her proje kaynağında döngü oluşturun ve başlangıçtaki IAM kullanıcısının erişimi olan **GCP Hizmet hesabı kaynaklarını sıralayın**.
3. **Her hizmet hesabı rolü** üzerinde döngü oluşturun ve _GetIAMPolicy_ kullanarak hedef hizmet hesabı kaynağında _**serviceAccountKeys.create**_ iznine sahip yerleşik, temel ve özel rolleri bulun. Editör rolünün bu izne sahip olduğu doğal olarak bilinmelidir.
4. IAM politikasında ilgili izne sahip **her hizmet hesabı kaynağı için yeni bir `KEY_ALG_RSA_2048`** özel anahtarı oluşturun.
5. **Her yeni hizmet hesabı üzerinde döngü oluşturun ve onun için bir `JWT`** **nesnesi** oluşturun. Bu, SA özel anahtar kimlik bilgileri ve bir OAuth kapsamından oluşan bir JWT nesnesi oluşturma sürecidir. Yeni bir _JWT_ nesnesi oluşturma süreci, tüm var olan OAuth kapsamı kombinasyonları üzerinde döngü oluşturacak ve Workspace kimliklerini kötüye kullanmak için ilgili olan tüm yetkilendirme olasılıklarını bulmak için **oauth\_scopes.txt** listesinden geçecektir. **oauth\_scopes.txt** listesi, Workspace kimliklerini kötüye kullanmak için ilgili bulduğumuz tüm OAuth kapsamları ile güncellenmiştir.
6. `_make_authorization_grant_assertion` yöntemi, DWD altında JWT'ler oluşturmak için bir _hedef workspace kullanıcısını_ belirtme gerekliliğini ortaya koymaktadır. Bu belirli bir kullanıcı gibi görünse de, önemli olan **DWD'nin bir alan içindeki her kimliği etkilemesidir**. Sonuç olarak, herhangi bir alan kullanıcısı için bir JWT oluşturmak, o alanın tüm kimliklerini etkiler, kombinasyon sıralama kontrolümüzle tutarlıdır. Basitçe söylemek gerekirse, ilerlemek için geçerli bir Workspace kullanıcısı yeterlidir.\
Bu kullanıcı, DeleFriend'in _config.yaml_ dosyasında tanımlanabilir. Eğer hedef workspace kullanıcısı zaten bilinmiyorsa, araç, GCP projelerinde rolleri olan alan kullanıcılarını tarayarak geçerli workspace kullanıcılarını otomatik olarak tanımlamayı kolaylaştırır. (Tekrar belirtmek gerekirse) JWT'ler alan özgül olup her kullanıcı için oluşturulmaz; bu nedenle otomatik süreç, her alan için tek bir benzersiz kimliği hedef alır.
7. **Her JWT için yeni bir taşıyıcı erişim belirteci oluşturun** ve belirteci tokeninfo API'sine karşı doğrulayın.

#### [Gitlab'ın Python betiği](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab, [bu Python betiğini](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) oluşturdu. Bu betik, kullanıcı dizinini listeler ve bir json ile belirtilen SA kimlik bilgileri ve taklit edilecek kullanıcı ile yeni bir yönetici hesabı oluşturabilir. İşte nasıl kullanılır:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Yeni bir yetkilendirme oluşturun (Kalıcılık)

**Domain Geniş Yetkilendirmeleri kontrol edilebilir** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.**

Bir saldırgan, bir GCP projesinde **hizmet hesapları oluşturma yeteneğine** ve **GWS'de süper yönetici ayrıcalığına** sahip olarak, SAs'nin bazı GWS kullanıcılarını taklit etmelerine izin veren yeni bir yetkilendirme oluşturabilir:

1. **Yeni bir Hizmet Hesabı ve İlgili Anahtar Çifti Oluşturma:** GCP'de, yeni hizmet hesabı kaynakları ya konsol aracılığıyla etkileşimli olarak ya da doğrudan API çağrıları ve CLI araçları kullanılarak programatik olarak üretilebilir. Bu, **rol `iam.serviceAccountAdmin`** veya **`iam.serviceAccounts.create`** **izinini** içeren herhangi bir özel rol gerektirir. Hizmet hesabı oluşturulduktan sonra, ilgili bir **anahtar çifti oluşturacağız** (**`iam.serviceAccountKeys.create`** izni).
2. **Yeni yetkilendirme oluşturma**: **Yalnızca Süper Yönetici rolünün Google Workspace'te genel Domain Geniş yetkilendirme kurma yeteneğine sahip olduğunu** ve Domain Geniş yetkilendirmenin **programatik olarak yapılandırılamayacağını**, yalnızca Google Workspace **konsolu** aracılığıyla **manuel olarak** oluşturulabileceğini anlamak önemlidir.
* Kuralın oluşturulması, **API kontrolleri → Google Workspace Yönetici konsolunda Domain Geniş yetkilendirmeyi Yönet** sayfasında bulunabilir.
3. **OAuth kapsam ayrıcalıklarını eklemek**: Yeni bir yetkilendirme yapılandırılırken, Google yalnızca 2 parametre gerektirir, GCP Hizmet Hesabının **OAuth Kimliği** ve yetkilendirmenin hangi API çağrılarını gerektirdiğini tanımlayan **OAuth kapsamları**.
* **OAuth kapsamlarının tam listesi** [**burada**](https://developers.google.com/identity/protocols/oauth2/scopes) bulunabilir, ancak burada bir öneri: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Hedef kimlik adına hareket etme:** Bu noktada, GWS'de işlevsel bir yetkilendirilmiş nesnemiz var. Şimdi, **GCP Hizmet Hesabı özel anahtarı kullanarak API çağrıları yapabiliriz** (OAuth kapsam parametresinde tanımlanan kapsamda) ve **Google Workspace'de var olan herhangi bir kimlik adına hareket edebiliriz**. Hizmet hesabının REST API uygulamaları için ihtiyaçlarına göre erişim belirteçleri oluşturacağını ve izinlerine göre hareket edeceğini öğrendik.
* Bu yetkilendirmeyi kullanmak için bazı **araçlar** için **önceki bölüme** bakın.

#### Kurumsal Çapta Yetkilendirme

OAuth SA Kimliği küreseldir ve **kurumsal çapta yetkilendirme** için kullanılabilir. Çapraz-global yetkilendirme engellemek için herhangi bir kısıtlama uygulanmamıştır. Basitçe ifade etmek gerekirse, **farklı GCP organizasyonlarından hizmet hesapları, diğer Workspace organizasyonlarında alan geniş yetkilendirme yapılandırabilir**. Bu, yalnızca Workspace'e Süper Yönetici erişimine ihtiyaç duyulacağı anlamına gelir ve saldırgan, Hizmet Hesapları ve özel anahtarlarını kendi kontrol ettiği GCP hesabında oluşturabilir.

### Workspace'ı numaralandırmak için bir Proje oluşturma

**Varsayılan olarak** Workspace **kullanıcıları**, **yeni projeler oluşturma iznine** sahiptir ve yeni bir proje oluşturulduğunda **oluşturucu üzerinde Sahip rolü** alır.

Bu nedenle, bir kullanıcı bir proje **oluşturabilir**, yeni projesinde Workspace'ı numaralandırmak için **API'leri etkinleştirebilir** ve onu **numaralandırmaya** çalışabilir.

{% hint style="danger" %}
Bir kullanıcının Workspace'ı numaralandırabilmesi için yeterli Workspace iznine de ihtiyacı vardır (her kullanıcı dizini numaralandıramayabilir).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

**Daha fazla numaralandırma için kontrol edin**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### Gcloud Kötüye Kullanımı

`gcloud` akışı hakkında daha fazla bilgiyi aşağıdaki bağlantıda bulabilirsiniz:

{% content-ref url="../gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

Orada açıklandığı gibi, gcloud, kullanıcının sürücüsüne erişim sağlayacak olan `https://www.googleapis.com/auth/drive` kapsamını isteyebilir.\
Bir saldırgan olarak, bir kullanıcının bilgisayarını **fiziksel olarak** ele geçirdiyseniz ve **kullanıcı hala oturum açık** ise, kullanıcı hesabıyla sürücüye erişime izin veren bir belge oluşturarak oturum açabilirsiniz:
```bash
gcloud auth login --enable-gdrive-access
```
Eğer bir saldırgan bir kullanıcının bilgisayarını ele geçirirse, `google-cloud-sdk/lib/googlecloudsdk/core/config.py` dosyasını değiştirip **`CLOUDSDK_SCOPES`** içine **`'https://www.googleapis.com/auth/drive'`** kapsamını ekleyebilir:

<figure><img src="../../../.gitbook/assets/image (153).png" alt="" width="563"><figcaption></figcaption></figure>

{% hint style="warning" %}
Bu nedenle, kullanıcı bir sonraki oturum açtığında, saldırganın sürücüye erişim sağlayabileceği bir **jeton oluşturacak**. Açıkçası, tarayıcı oluşturulan jetonun sürücüye erişim sağlayacağını belirtecektir, ancak kullanıcı **`gcloud auth login`** komutunu kendisi çağıracağından dolayı **muhtemelen şüphelenmeyecektir.**

Sürücü dosyalarını listelemek için: **`curl -H "Authorization: Bearer $(gcloud auth print-access-token)" "https://www.googleapis.com/drive/v3/files"`**
{% endhint %}

## GWS'den GCP'ye

### Ayrıcalıklı GCP kullanıcılarına erişim

Bir saldırganın GWS üzerinde tam erişimi varsa, genellikle **GWS'deki kullanıcılar GCP üzerinde yüksek ayrıcalıklara sahip olduklarından dolayı** GWS'den GCP'ye geçmek daha "basit" olacaktır.&#x20;

### Google Grupları Ayrıcalık Yükseltme

Varsayılan olarak kullanıcılar **Kuruluşun Workspace gruplarına serbestçe katılabilir** ve bu gruplar **GCP izinleri** atamış olabilir (gruplarınızı [https://groups.google.com/](https://groups.google.com/) adresinden kontrol edin).

**Google grupları ayrıcalık yükseltme**yi kötüye kullanarak GCP'ye ayrıcalıklı erişime sahip bir gruba yükseltme yapabilirsiniz.

### Referanslar

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahraman olmaya kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya beni **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
