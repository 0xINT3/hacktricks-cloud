# GCP <--> Workspace Pivoting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> adlı <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki özel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

## **GCP'den GWS'ye**

### **Domain Geniş Yetkilendirme Temelleri**

Google Workspace'in Domain Geniş Yetkilendirme özelliği, bir **harici uygulama** (Google Workspace Marketplace'den) veya bir **GCP Hizmet Hesabı** olmak üzere bir kimlik nesnesinin, kullanıcılar adına Workspace üzerindeki verilere **erişmesine olanak tanır**.

{% hint style="info" %}
Bu temel olarak, bir organizasyonun GCP projelerindeki **hizmet hesaplarının**, aynı organizasyonun (veya farklı bir organizasyonun) Workspace kullanıcılarını **taklit edebilme** yeteneğine sahip olabileceği anlamına gelir.
{% endhint %}

Bu konuyla ilgili daha fazla bilgi için şu adrese bakın:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Varolan yetkilendirmeyi ele geçirme

Bir saldırgan, **GCP üzerinde bazı erişimleri ele geçirdiyse** ve şirketin bir **Geçerli Workspace kullanıcı e-posta adresini** (tercihen **süper yönetici**) bildiğinde, erişime sahip olduğu **tüm projeleri sıralayabilir**, projelerin **tüm hizmet hesaplarını sıralayabilir**, hangi **hizmet hesaplarına erişimi olduğunu** kontrol edebilir ve her bir hizmet hesabıyla bu adımları **tekrarlayabilir**.\
**Erişime sahip olduğu tüm hizmet hesaplarının listesi** ve **Workspace e-postalarının listesi** ile saldırgan, her bir hizmet hesabıyla kullanıcıyı **taklit etmeyi deneyebilir**.

{% hint style="danger" %}
Domain geniş yetkilendirme yapılandırılırken bir Workspace kullanıcısına ihtiyaç duyulmadığını unutmayın, bu nedenle **geçerli bir tane bilmeniz, taklit için yeterli ve gereklidir**.\
Ancak, taklit edilen kullanıcının **yetkileri kullanılacaktır**, bu nedenle Süper Yönetici ise her şeye erişebilirsiniz. Erişimi yoksa bu işe yaramaz.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

Bu, saldırıyı aşağıdaki adımları izleyerek gerçekleştirebilen bir araçtır:

1. Kaynak Yöneticisi API'sını kullanarak **GCP Projelerini sıralayın**.
2. Her proje kaynağı üzerinde döngü oluşturun ve başlangıç IAM kullanıcısının erişimi olan **GCP Hizmet hesabı kaynaklarını sıralayın**.
3. **Her hizmet hesabı rolü üzerinde döngü oluşturun** ve hedef hizmet hesabı kaynağında _**serviceAccountKeys.create**_ iznine sahip olan yerleşik, temel ve özel rolleri bulun. Editör rolünün bu izne sahip olduğu unutulmamalıdır.
4. IAM politikasında ilgili izne sahip bulunan **her hizmet hesabı kaynağına yeni bir `KEY_ALG_RSA_2048` özel anahtarı oluşturun**.
5. **Her yeni hizmet hesabı için bir `JWT` nesnesi oluşturun**. Bu, SA özel anahtar kimlik bilgileri ve bir OAuth kapsamından oluşur. Yeni bir _JWT_ nesnesi oluşturma işlemi, mevcut OAuth kapsamlarının tüm kombinasyonlarını bulmak için **oauth\_scopes.txt** listesindeki tüm OAuth kapsamlarının üzerinde döner. **oauth\_scopes.txt** listesi, Workspace kimliklerini kötüye kullanmak için ilgili olduğunu tespit ettiğimiz tüm OAuth kapsamlarıyla güncellenir.
6. `_make_authorization_grant_assertion` yöntemi, DWD altında JWT'lerin oluşturulması için bir **hedef workspace kullanıcısının** (subject) belirtilmesi gerekliliğini ortaya koyar. Bu, belirli bir kullanıcı gerektiriyor gibi görünebilir, ancak DWD'nin bir alan içindeki her kimliği etkilediğini anlamak önemlidir. Sonuç olarak, herhangi bir alan kullanıcısı için bir JWT oluşturmak, bu alandaki tüm kimlikleri etkiler ve kombinasyon numaralaması kontrolümüzle tutarlıdır. Basitçe söylemek gerekirse, ilerlemek için geçerli bir Workspace kullanıcısı yeterlidir.\
Bu kullanıcı, DeleFriend'ün _config.yaml_ dosyasında tanımlanabilir. Hedef bir workspace kullanıcısı zaten bilinmiyorsa, araç, GCP projelerinde rolleri olan alan kullanıcılarını taramak suretiyle geçerli workspace kullanıcılarının otomatik olarak tanımlanmasını kolaylaştırır. (Tekrar belirtmek gerekirse) JWT'ler alan özgüdür ve her kullanıcı için oluşturulmaz; bu nedenle, otomatik süreç, her alan için tek bir benzersiz kimliği hedefler.
7. Her JWT için yeni bir taşıyıcı erişim belirteci **sıralayın ve oluşturun** ve belirteci tokeninfo API'sine karşı doğrulayın.

#### [Gitlab'ın Python betiği](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab, kullanıcı dizinini listelemek ve bir json ile belirtilen SA kimlik bilgileri ve taklit edilecek kullanıcıyı göstererek yeni bir yönetici hesabı oluşturmak için [bu Python betiğini](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) oluşturdu. İşte nasıl kullanacağınız:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Yeni bir yetkilendirme oluşturma (Kalıcılık)

[**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)** adresindeki** **Domain Wide Delegations** kontrol edilebilir.

Bir saldırgan, bir GCP projesinde **hizmet hesapları oluşturma yeteneğine** ve **GWS'ye süper yönetici ayrıcalığına** sahipse, SAs'ın bazı GWS kullanıcılarını taklit etmelerine izin veren yeni bir yetkilendirme oluşturabilir:

1. **Yeni bir Hizmet Hesabı ve İlgili Anahtar Çifti Oluşturma:** GCP'de, yeni hizmet hesabı kaynakları, ya konsol aracılığıyla etkileşimli olarak veya doğrudan API çağrıları ve CLI araçları kullanılarak programlı olarak üretilebilir. Bunun için **`iam.serviceAccountAdmin`** rolü veya **`iam.serviceAccounts.create`** **izinini** içeren herhangi bir özel rol gereklidir. Hizmet hesabı oluşturulduktan sonra, ilgili bir anahtar çifti oluşturmak için **`iam.serviceAccountKeys.create`** izni kullanılır.
2. **Yeni bir yetkilendirme oluşturma**: Google Workspace'de, **yalnızca Süper Yönetici rolünün** **global Domain-Wide yetkilendirmeyi** kurma yeteneğine sahip olduğu ve Domain-Wide yetkilendirmenin **programlı olarak kurulamayacağı,** yalnızca Google Workspace **konsolu** üzerinden **manuel olarak** oluşturulup ayarlanabileceği önemlidir.
* Kural oluşturma, **API kontrolleri → Google Workspace Yönetici konsolunda Domain-Wide yetkilendirmeyi Yönet** sayfasında bulunabilir.
3. **OAuth kapsamları ayrıcalığını eklemek**: Yeni bir yetkilendirme yapılandırılırken, Google yalnızca 2 parametre gerektirir: İstemci Kimliği, yani GCP Hizmet Hesabı kaynağının **OAuth Kimliği** ve yetkilendirmenin hangi API çağlarını gerektirdiğini tanımlayan **OAuth kapsamları**.
* **OAuth kapsamlarının tam listesi** [**burada**](https://developers.google.com/identity/protocols/oauth2/scopes) bulunabilir, ancak burada bir öneri: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **Hedef kimliği adına hareket etme:** Bu noktada, GWS'de işlevsel bir yetkilendirilmiş nesnemiz var. Şimdi, GCP Hizmet Hesabı özel anahtarını kullanarak (OAuth kapsam parametresinde tanımlanan kapsamda) API çağrıları yapabilir ve Google Workspace'de var olan herhangi bir kimlik adına hareket edebiliriz. Hizmet hesabı, ihtiyaçlarına göre erişim belirteçleri oluşturacak ve REST API uygulamalarına sahip olduğu izinlere göre hareket edecektir.
* Bu yetkilendirmeyi kullanmak için bazı **araçlar** için **önceki bölüme** bakın.

#### Kuruluşlararası yetkilendirme

OAuth SA Kimliği küreseldir ve **kuruluşlararası yetkilendirme** için kullanılabilir. Küresel çapta yetkilendirme yapmak için herhangi bir kısıtlama uygulanmamıştır. Basit bir ifadeyle, **farklı GCP kuruluşlarından hizmet hesapları, diğer Workspace kuruluşlarında domain-wide yetkilendirme yapılandırması için kullanılabilir**. Bu, yalnızca Süper Yönetici erişimine ihtiyaç duyulan Workspace'e erişim sağlar ve saldırgan, kendi kontrolünde olan GCP hesabında Hizmet Hesapları ve özel anahtarlar oluşturabilir.

### Workspace'yi numaralandırmak için bir Proje oluşturma

Varsayılan olarak, Workspace **kullanıcıları**, **yeni projeler oluşturma iznine** sahiptir ve yeni bir proje oluşturulduğunda **oluşturucu üzerinde Sahip rolü** alır.

Bu nedenle, bir kullanıcı bir proje oluşturabilir, yeni projesinde Workspace'yi numaralandırmak için **API'leri etkinleştirebilir** ve onu **numaralandırmaya** çalışabilir.

{% hint style="danger" %}
Bir kullanıcının Workspace'yi numaralandırabilmesi için yeterli Workspace iznine de ihtiyacı vardır (her kullanıcı dizini numaralandıramaz).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

Daha fazla numaralandırmayı kontrol et:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## GWS'den GCP'ye

### Ayrıcalıklı GCP kullanıcılarına erişim

Bir saldırganın GWS üzerinde tam erişimi varsa, GCP üzerinde ayrıcalıklı erişime sahip gruplara veya hatta kullanıcılara erişebilir, bu nedenle GWS'den GCP'ye geçmek genellikle daha "basit" olabilir çünkü **GWS'deki kullanıcılar GCP üzerinde yüksek ayrıcalıklara sahiptir**.

### Google Grupları Ayrıcalık Yükseltme

Varsayılan olarak, kullanıcılar **Organizasyonun Workspace gruplarına serbestçe katılabilir** ve bu gruplara **GCP izinleri** atanmış olabilir (gruplarınızı [https://groups.google.com/](https://groups.google.com/) adresinde kontrol edin).

**Google grupları ayrıcalık yükseltmesini** kötüye kullanarak, GCP'ye bazı ayrıcalıklı erişimi olan bir gruba yükseltme yapabilirsiniz.

### Referanslar

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmaya kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**'u takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR göndererek paylaşın.

</details>
