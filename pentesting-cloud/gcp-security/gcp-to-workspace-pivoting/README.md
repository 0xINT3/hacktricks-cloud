# GCP <--> Workspace Pivoting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter**에서 **팔로우**하세요. 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks)와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## **GCP에서 GWS로**

### **도메인 와이드 위임 기본 사항**

Google Workspace의 도메인 와이드 위임은 Google Workspace Marketplace의 **외부 앱** 또는 내부 **GCP 서비스 계정**을 통해 사용자를 대신하여 Workspace 전체의 데이터에 액세스할 수 있게 합니다.

{% hint style="info" %}
이는 기본적으로 GCP 프로젝트 내의 **서비스 계정**이 동일한 조직의 Workspace 사용자를 **가장할 수 있는** 것을 의미합니다(또는 다른 조직에서도 가능).
{% endhint %}

이에 대한 자세한 정보는 다음을 확인하세요:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### 기존 위임 침해

공격자가 GCP에 대한 **일부 액세스를 침해**하고 회사의 **유효한 Workspace 사용자 이메일**(특히 **슈퍼 관리자**)을 알고 있다면, 그는 액세스할 수 있는 **모든 프로젝트를 열거**하고, 프로젝트의 **모든 서비스 계정을 열거**하고, 어떤 **서비스 계정에 액세스할 수 있는지 확인**하고, 각 서비스 계정으로 이러한 단계를 **반복**할 수 있습니다.\
**모든 서비스 계정 목록**과 **Workspace 이메일 목록**을 가지고 있으면, 공격자는 각 서비스 계정으로 **사용자를 가장할 수** 있습니다.

{% hint style="danger" %}
도메인 와이드 위임을 구성할 때 Workspace 사용자가 필요하지 않으므로, **하나의 유효한 사용자만 알고 있다면 가장할 수 있는 데로 충분**합니다.\
그러나, 가장한 사용자의 **권한이 사용**될 것이므로, 슈퍼 관리자인 경우 모든 것에 액세스할 수 있습니다. 액세스 권한이 없는 경우 이는 쓸모없을 것입니다.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

이 도구는 다음 단계를 따라 공격을 수행할 수 있는 도구입니다:

1. 리소스 관리자 API를 사용하여 **GCP 프로젝트를 열거**합니다.
2. 각 프로젝트 리소스에서 반복하고, 초기 IAM 사용자가 액세스할 수 있는 **GCP 서비스 계정 리소스를 열거**합니다. 이는 _GetIAMPolicy_를 사용합니다.
3. **각 서비스 계정 역할**을 반복하고, 대상 서비스 계정 리소스에서 _**serviceAccountKeys.create**_ 권한을 가진 내장, 기본 및 사용자 정의 역할을 찾습니다. 이 권한은 기본적으로 Editor 역할에 속해 있습니다.
4. IAM 정책에서 해당 권한을 가진 서비스 계정 리소스를 찾아 **새로운 `KEY_ALG_RSA_2048`** 개인 키를 생성합니다.
5. **각 새로운 서비스 계정에 대해 `JWT`** **객체**를 생성합니다. 이 객체는 SA 개인 키 자격 증명과 OAuth 범위로 구성됩니다. 새로운 _JWT_ 객체를 생성하는 과정에서는 **oauth\_scopes.txt** 목록의 모든 OAuth 범위 조합을 반복하여 모든 위임 가능성을 찾습니다. 목록 **oauth\_scopes.txt**은 Workspace 신원 남용에 관련된 OAuth 범위를 모두 찾아 업데이트됩니다.
6. `_make_authorization_grant_assertion` 메서드는 DWD 아래에서 JWT를 생성하기 위해 **대상 Workspace 사용자**(subject로 참조)를 선언해야 함을 보여줍니다. 이는 특정 사용자를 필요로 하는 것처럼 보일 수 있지만, DWD는 도메인 내의 모든 신원에 영향을 미칩니다. 따라서, **도메인 사용자 중 하나의 유효한 Workspace 사용자**를 앞으로 나아가기에 충분합니다.\
이 사용자는 DeleFriend의 _config.yaml_ 파일에서 정의할 수 있습니다. 대상 Workspace 사용자가 이미 알려져 있지 않은 경우, 이 도구는 GCP 프로젝트에 역할이 있는 도메인 사용자를 스캔하여 유효한 Workspace 사용자를 자동으로 식별하는 기능을 제공합니다. (다시 한 번) JWT는 도메인별로 생성되는 것이 아니라 도메인 사용자마다 생성되지 않으므로, 자동 프로세스는 도메인당 단일 고유 신원을 대상으로 합니다.
7. 각 JWT에 대해 **새로운 베어러 액세스 토큰을 열거하고 생성**하고, 토큰을 tokeninfo API에 대해 유효성을 검사합니다.

#### [Gitlab의 Python 스크립트](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab은 [이 Python 스크립트](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py)를 만들었으며, 이 스크립트를 사용하여 사용자 디렉토리를 나열하고 SA 자격 증명과 가장할 사용자를 지정하는 json을 사용하여 새로운 관리 계정을 만들 수 있습니다. 사용 방법은 다음과 같습니다:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### 새로운 위임 생성 (지속성)

[https://admin.google.com/u/1/ac/owl/domainwidedelegation](https://admin.google.com/u/1/ac/owl/domainwidedelegation)에서 **도메인 전체 위임을 확인할 수 있습니다**.

GCP 프로젝트에서 **서비스 계정을 생성**하고 **GWS에 대한 슈퍼 관리자 권한**이 있는 공격자는 새로운 위임을 생성하여 SAs가 일부 GWS 사용자를 가장할 수 있도록 할 수 있습니다:

1. **새로운 서비스 계정 및 해당 키 쌍 생성**: GCP에서는 새로운 서비스 계정 리소스를 콘솔을 통해 대화식으로 생성하거나 API 호출 및 CLI 도구를 사용하여 프로그래밍 방식으로 생성할 수 있습니다. 이를 위해서는 **`iam.serviceAccountAdmin`** 역할 또는 **`iam.serviceAccounts.create`** **권한**이 부여된 사용자 정의 역할이 필요합니다. 서비스 계정이 생성되면 관련 키 쌍을 생성하기 위해 **`iam.serviceAccountKeys.create`** **권한**을 사용합니다.
2. **새로운 위임 생성**: **슈퍼 관리자 역할만이 Google Workspace에서 전역 도메인 위임을 설정할 수 있는 능력**을 가지고 있으며, 도메인 전체 위임은 **프로그래밍 방식으로 설정할 수 없으며** Google Workspace **콘솔**을 통해 **수동으로**만 생성 및 조정할 수 있습니다.
* 규칙 생성은 **API 제어 → Google Workspace 관리자 콘솔에서 도메인 전체 위임 관리** 페이지에서 찾을 수 있습니다.
3. **OAuth 스코프 권한 연결**: 새로운 위임을 구성할 때 Google은 **OAuth ID**가 **GCP 서비스 계정** 리소스의 **OAuth ID**이고, 위임이 필요로 하는 **OAuth 스코프**를 정의하는 **2개의 매개변수**만 필요합니다.
* **OAuth 스코프의 전체 목록**은 [여기](https://developers.google.com/identity/protocols/oauth2/scopes)에서 찾을 수 있지만, 다음을 권장합니다: `https://www.googleapis.com/auth/userinfo.email, https://www.googleapis.com/auth/cloud-platform, https://www.googleapis.com/auth/admin.directory.group, https://www.googleapis.com/auth/admin.directory.user, https://www.googleapis.com/auth/admin.directory.domain, openid`
4. **대상 ID를 대신하여 작동**: 이 시점에서 GWS에 기능이 있는 위임된 개체가 있습니다. 이제 **GCP 서비스 계정 개인 키를 사용하여 API 호출**을 수행할 수 있습니다(위임된 개체의 OAuth 스코프 매개변수에서 정의된 범위 내에서). 알다시피 서비스 계정은 REST API 응용 프로그램에 대한 권한에 따라 필요에 따라 액세스 토큰을 생성합니다.
* 이 위임을 사용하기 위한 **도구**에 대해서는 **이전 섹션**을 확인하세요.

#### 조직 간 위임

OAuth SA ID는 전역적이며 **조직 간 위임**에 사용될 수 있습니다. 국제적인 위임을 방지하기 위한 제한이 구현되지 않았습니다. 간단히 말해, **다른 GCP 조직의 서비스 계정을 사용하여 다른 Workspace 조직에서 도메인 전체 위임을 구성**할 수 있습니다. 이로 인해 **Workspace에 대한 슈퍼 관리자 액세스만 필요**하며, 동일한 GCP 계정에 대한 액세스는 필요하지 않습니다. 공격자는 개인적으로 제어하는 GCP 계정에서 서비스 계정과 개인 키를 생성할 수 있습니다.

### Workspace 열거를 위한 프로젝트 생성

**기본적으로** Workspace **사용자**는 **새로운 프로젝트를 생성**할 수 있는 권한을 가지며, 새로운 프로젝트가 생성되면 **생성자는 Owner 역할**을 얻습니다.

따라서 사용자는 **프로젝트를 생성**하고, 자신의 새 프로젝트에서 Workspace를 열거하기 위해 **API를 활성화**하고 **열거**를 시도할 수 있습니다.

{% hint style="danger" %}
Workspace를 열거할 수 있는 사용자는 충분한 Workspace 권한도 필요합니다(모든 사용자가 디렉터리를 열거할 수 있는 것은 아닙니다).
{% endhint %}

{% code overflow="wrap" %}
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

더 많은 열거를 확인하려면 다음을 확인하십시오:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## GWS에서 GCP로

### 특권이 있는 GCP 사용자에게 접근

공격자가 GWS에 완전한 액세스 권한을 가지고 있다면 GCP에 특권 액세스를 가진 그룹 또는 사용자에게 액세스할 수 있으므로 GWS에서 GCP로 이동하는 것은 일반적으로 더 "간단"합니다.&#x20;

### Google 그룹 특권 상승

기본적으로 사용자는 조직의 Workspace 그룹에 자유롭게 가입할 수 있으며 해당 그룹에는 GCP 권한이 할당될 수 있습니다([https://groups.google.com/](https://groups.google.com/)에서 그룹을 확인하세요).

**Google 그룹 특권 상승(google groups privesc)**을 악용하여 GCP에 특권 액세스를 가진 그룹으로 상승할 수 있습니다.

### 참고 자료

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 PDF로 HackTricks를 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**을** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
