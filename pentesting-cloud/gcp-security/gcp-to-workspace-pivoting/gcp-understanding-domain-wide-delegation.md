# GCP - Razumevanje delegacije na nivou domena

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

Ovaj post je uvod u [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) koji se može pristupiti za više detalja.

## **Razumevanje delegacije na nivou domena**

Delegacija na nivou domena u Google Workspace-u omogućava objektu identiteta, bilo da je to **spoljni aplikacija** sa Google Workspace Marketplace-a ili interni **GCP Service Account**, da **pristupi podacima u okviru Workspace-a u ime korisnika**. Ova funkcionalnost, koja je ključna za aplikacije koje komuniciraju sa Google API-jima ili uslugama koje zahtevaju impersonaciju korisnika, poboljšava efikasnost i smanjuje ljudske greške automatizacijom zadataka. Korišćenjem OAuth 2.0, razvijači aplikacija i administratori mogu dati ovim servisnim nalozima pristup korisničkim podacima bez pojedinačne saglasnosti korisnika.\
\
Google Workspace omogućava kreiranje dve glavne vrste globalnih delegiranih objektnih identiteta:

* **GWS aplikacije:** Aplikacije sa Workspace Marketplace-a mogu biti podešene kao delegirani identitet. Pre nego što postanu dostupne na tržištu, svaka aplikacija Workspace-a prolazi kroz pregled od strane Google-a kako bi se smanjila mogućnost zloupotrebe. Iako to ne eliminiše potpuno rizik od zloupotrebe, značajno povećava težinu takvih incidenata.
* **GCP Service Account:** Saznajte više o [**GCP Service Account-ima ovde**](../gcp-basic-information.md#service-accounts).

### **Delegacija na nivou domena: Iza kulisa**

Ovako GCP Service Account može pristupiti Google API-jima u ime drugih identiteta u Google Workspace-u:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **Identitet kreira JWT:** Identitet koristi privatni ključ servisnog naloga (deo JSON ključnog para datoteke) da potpiše JWT. Ovaj JWT sadrži tvrdnje o servisnom nalogu, ciljnom korisniku za impersonaciju i OAuth opsezi pristupa REST API-ju koji se zahteva.
2. **Identitet koristi JWT za zahtevanje pristupnog tokena:** Aplikacija/korisnik koristi JWT za zahtevanje pristupnog tokena od Google-ovog OAuth 2.0 servisa. Zahtev takođe uključuje ciljnog korisnika za impersonaciju (e-poštu korisnika Workspace-a) i opsege za koje se zahteva pristup.
3. **Google-ov OAuth 2.0 servis vraća pristupni token:** Pristupni token predstavlja ovlašćenje servisnog naloga da deluje u ime korisnika za određene opsege. Ovaj token je obično kratkotrajan i mora se periodično osvežavati (prema potrebi aplikacije). Važno je razumeti da OAuth opsezi navedeni u JWT tokenu imaju važnost i uticaj na rezultirajući pristupni token. Na primer, pristupni tokeni koji poseduju više opsega važe za brojne REST API aplikacije.
4. **Identitet koristi pristupni token za pozivanje Google API-ja**: Sada sa relevantnim pristupnim tokenom, servis može pristupiti potrebnom REST API-ju. Aplikacija koristi ovaj pristupni token u zaglavlju "Authorization" svojih HTTP zahteva namenjenih Google API-jima. Ovi API-ji koriste token da bi potvrdili impersonirani identitet i potvrdili da ima neophodnu autorizaciju.
5. **Google API-ji vraćaju tražene podatke**: Ako je pristupni token validan i servisni nalog ima odgovarajuću autorizaciju, Google API-ji vraćaju tražene podatke. Na primer, na sledećoj slici smo iskoristili metodu _users.messages.list_ da bismo izlistali sve ID-ove Gmail poruka povezane sa ciljnim korisnikom Workspace-a.
