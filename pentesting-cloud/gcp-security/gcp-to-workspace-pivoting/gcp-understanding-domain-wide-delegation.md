# GCP - Verst√§ndnis der dom√§nenweiten Delegation

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys senden.

</details>

Dieser Beitrag ist die Einf√ºhrung von [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover), auf den f√ºr weitere Details zugegriffen werden kann.

## **Verst√§ndnis der dom√§nenweiten Delegation**

Die dom√§nenweite Delegation von Google Workspace erm√∂glicht es einem Identit√§tsobjekt, entweder einer **externen App** aus dem Google Workspace Marketplace oder einem internen **GCP-Servicekonto**, **Daten im gesamten Workspace im Namen von Benutzern zuzugreifen**. Diese Funktion, die f√ºr Apps, die mit Google-APIs interagieren oder Benutzerimitation ben√∂tigen, entscheidend ist, verbessert die Effizienz und minimiert menschliche Fehler durch Automatisierung von Aufgaben. Mit OAuth 2.0 k√∂nnen App-Entwickler und Administratoren diesen Dienstkonten Zugriff auf Benutzerdaten ohne individuelle Benutzerzustimmung geben.\
\
Google Workspace erm√∂glicht die Erstellung von zwei Haupttypen globaler delegierter Objektidentit√§ten:

* **GWS-Anwendungen:** Anwendungen aus dem Workspace Marketplace k√∂nnen als delegierte Identit√§t eingerichtet werden. Bevor sie im Marketplace verf√ºgbar gemacht werden, durchl√§uft jede Workspace-Anwendung eine √úberpr√ºfung durch Google, um potenziellen Missbrauch zu minimieren. Obwohl dies das Risiko von Missbrauch nicht vollst√§ndig beseitigt, erh√∂ht es die Schwierigkeit erheblich, dass solche Vorf√§lle auftreten.
* **GCP-Servicekonto:** Erfahren Sie mehr √ºber [**GCP-Servicekonten hier**](../gcp-basic-information.md#service-accounts).

### **Dom√§nenweite Delegation: Unter der Haube**

So kann ein GCP-Servicekonto im Namen anderer Identit√§ten in Google Workspace auf Google-APIs zugreifen:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **Identit√§t erstellt ein JWT:** Die Identit√§t verwendet den privaten Schl√ºssel des Servicekontos (Teil des JSON-Schl√ºsselpaars) zum Signieren eines JWT. Dieses JWT enth√§lt Anspr√ºche √ºber das Servicekonto, den Zielbenutzer zur Imitation und die OAuth-Bereiche des Zugriffs auf die angeforderte REST-API.
2. **Die Identit√§t verwendet das JWT, um ein Zugriffstoken anzufordern:** Die Anwendung/der Benutzer verwendet das JWT, um ein Zugriffstoken vom OAuth 2.0-Dienst von Google anzufordern. Die Anfrage enth√§lt auch den Zielbenutzer zur Imitation (die E-Mail des Workspace-Benutzers) und die Bereiche, f√ºr die Zugriff angefordert wird.
3. **Der OAuth 2.0-Dienst von Google gibt ein Zugriffstoken zur√ºck:** Das Zugriffstoken repr√§sentiert die Autorit√§t des Servicekontos, im Namen des Benutzers f√ºr die angegebenen Bereiche zu handeln. Dieses Token ist in der Regel kurzlebig und muss periodisch erneuert werden (je nach Bedarf der Anwendung). Es ist wichtig zu verstehen, dass die im JWT-Token angegebenen OAuth-Bereiche G√ºltigkeit haben und Auswirkungen auf das resultierende Zugriffstoken haben. Beispielsweise besitzen Zugriffstoken mit mehreren Bereichen G√ºltigkeit f√ºr zahlreiche REST-API-Anwendungen.
4. **Die Identit√§t verwendet das Zugriffstoken, um auf Google-APIs zuzugreifen**: Nun kann die Anwendung mit einem relevanten Zugriffstoken auf die erforderliche REST-API zugreifen. Die Anwendung verwendet dieses Zugriffstoken im "Authorization"-Header ihrer HTTP-Anfragen, die f√ºr Google-APIs bestimmt sind. Diese APIs verwenden das Token, um die imitierte Identit√§t zu √ºberpr√ºfen und zu best√§tigen, dass sie die erforderliche Autorisierung besitzt.
5. **Google-APIs geben die angeforderten Daten zur√ºck**: Wenn das Zugriffstoken g√ºltig ist und das Servicekonto √ºber die entsprechende Autorisierung verf√ºgt, geben die Google-APIs die angeforderten Daten zur√ºck. Zum Beispiel haben wir in dem folgenden Bild die Methode _users.messages.list_ genutzt, um alle Gmail-Nachrichten-IDs eines Ziel-Workspace-Benutzers aufzulisten.
