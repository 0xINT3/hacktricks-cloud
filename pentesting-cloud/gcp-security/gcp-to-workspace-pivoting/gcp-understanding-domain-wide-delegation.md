# GCP - 理解域委托

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

这篇文章是[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)的介绍，可以访问获取更多详细信息。

## **理解域委托**

Google Workspace的域委托允许一个身份对象，无论是来自Google Workspace Marketplace的**外部应用**还是内部的**GCP服务账号**，代表用户**跨Workspace访问数据**。这个功能对于与Google API交互的应用或需要用户模拟的服务至关重要，通过自动化任务提高效率并减少人为错误。使用OAuth 2.0，应用开发人员和管理员可以为这些服务账号授予对用户数据的访问权限，而无需单独用户同意。

Google Workspace允许创建两种主要类型的全局委托对象身份：

* **GWS应用程序：** Workspace Marketplace中的应用程序可以设置为委托身份。在上架市场之前，每个Workspace应用程序都经过Google的审核，以最小化潜在的滥用。虽然这并不能完全消除滥用的风险，但显著增加了此类事件发生的难度。
* **GCP服务账号：** 了解更多关于[**GCP服务账号请点击这里**](../gcp-basic-information/#service-accounts)。

### **域委托：内部原理**

这是GCP服务账号如何代表Google Workspace中的其他身份访问Google API的方式：

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **身份创建JWT：** 身份使用服务账号的私钥（JSON密钥对文件的一部分）签署JWT。此JWT包含有关服务账号、要模拟的目标用户以及正在请求的REST API的OAuth访问范围的声明。
2. **身份使用JWT请求访问令牌：** 应用程序/用户使用JWT从Google的OAuth 2.0服务请求访问令牌。请求还包括要模拟的目标用户（用户的Workspace电子邮件）和请求访问权限的范围。
3. **Google的OAuth 2.0服务返回访问令牌：** 访问令牌代表服务账号代表用户执行指定范围操作的权限。此令牌通常是短暂的，必须根据应用程序的需要定期刷新。重要的是要理解JWT令牌中指定的OAuth访问范围对生成的访问令牌的有效性和影响。例如，具有多个范围的访问令牌将对多个REST API应用程序具有有效性。
4. **身份使用访问令牌调用Google API：** 现在具有相关访问令牌，服务可以访问所需的REST API。应用程序在其HTTP请求的“Authorization”标头中使用此访问令牌，该请求将发送到Google API。这些API利用令牌验证被模拟的身份并确认其具有必要的授权。
5. **Google API返回请求的数据：** 如果访问令牌有效且服务账号具有适当的授权，Google API将返回请求的数据。例如，在下图中，我们利用了_users.messages.list_方法列出与目标Workspace用户关联的所有Gmail消息ID。
