# GCP - ドメイン全体委任の理解

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **HackTricks**のGitHubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

この投稿は、より詳細な情報については[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)でアクセスできるものの要約です。

## **ドメイン全体委任の理解**

Google Workspaceのドメイン全体委任は、**外部アプリ**（Google Workspace Marketplaceから）または内部の**GCPサービスアカウント**を含むアイデンティティオブジェクトが、ユーザーに代わってWorkspace全体のデータに**アクセスする**ことを可能にします。この機能は、Google APIやユーザーのなりすましを必要とするサービスと対話するアプリにとって重要であり、タスクを自動化することで効率を向上させ、人為的なエラーを最小限に抑えます。OAuth 2.0を使用して、アプリ開発者と管理者は、個々のユーザーの同意なしにこれらのサービスアカウントにユーザーデータへのアクセスを許可することができます。\
\
Google Workspaceでは、2つの主要なタイプのグローバル委任オブジェクトアイデンティティを作成できます：

* **GWSアプリケーション：** Workspace Marketplaceのアプリケーションは、委任されたアイデンティティとして設定できます。マーケットプレイスで利用可能になる前に、各Workspaceアプリケーションは潜在的な悪用を最小限に抑えるためにGoogleによってレビューされます。これにより、乱用のリスクが完全に排除されるわけではありませんが、そのような事件が発生する難易度は大幅に高まります。
* **GCPサービスアカウント：** [**GCPサービスアカウントについてはこちら**](../gcp-basic-information.md#service-accounts)をご覧ください。

### **ドメイン全体委任：内部の仕組み**

これは、GCPサービスアカウントがGoogle Workspace内の他のアイデンティティに代わってGoogle APIにアクセスする方法です：

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **アイデンティティがJWTを作成する：** アイデンティティは、サービスアカウントのプライベートキー（JSONキーペアファイルの一部）を使用してJWTに署名します。このJWTには、サービスアカウントに関するクレーム、なりすまし対象のユーザー、および要求されているREST APIへのアクセススコープが含まれています。
2. **アイデンティティがJWTを使用してアクセストークンを要求する：** アプリケーション/ユーザーはJWTを使用して、GoogleのOAuth 2.0サービスからアクセストークンを要求します。この要求には、なりすまし対象のユーザー（ユーザーのWorkspaceメール）と、アクセスが要求されるスコープも含まれます。
3. **GoogleのOAuth 2.0サービスがアクセストークンを返す：** アクセストークンは、指定されたスコープに対してユーザーに代わって行動するサービスアカウントの権限を表します。このトークンは通常、短命であり、定期的に更新する必要があります（アプリケーションのニーズに応じて）。JWTトークンに指定されたOAuthスコープが有効であり、結果として得られるアクセストークンに影響を与えることを理解することが重要です。たとえば、複数のスコープを持つアクセストークンは、複数のREST APIアプリケーションに対して有効性を持ちます。
4. **アイデンティティがアクセストークンを使用してGoogle APIを呼び出す：** 関連するアクセストークンを持つサービスは、必要なREST APIにアクセスできます。アプリケーションは、Google API宛てのHTTPリクエストの「Authorization」ヘッダーにこのアクセストークンを使用します。これらのAPIは、トークンを使用してなりすましアイデンティティを検証し、必要な承認を持っていることを確認します。
5. **Google APIが要求されたデータを返す：** アクセストークンが有効であり、サービスアカウントが適切な承認を持っている場合、Google APIは要求されたデータを返します。たとえば、以下の画像では、_users.messages.list_ メソッドを利用して、対象のWorkspaceユーザーに関連するすべてのGmailメッセージIDをリストしています。





<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **HackTricks**のGitHubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>
