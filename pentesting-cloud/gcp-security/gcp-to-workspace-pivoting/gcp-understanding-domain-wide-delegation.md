# GCP - Comprendre la D√©l√©gation √† l'√âchelle du Domaine

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √âquipe Rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

Ce post est l'introduction de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) auquel vous pouvez acc√©der pour plus de d√©tails.

## **Comprendre la D√©l√©gation √† l'√âchelle du Domaine**

La d√©l√©gation √† l'√©chelle du domaine de Google Workspace permet √† un objet d'identit√©, qu'il s'agisse d'une **application externe** du Google Workspace Marketplace ou d'un **compte de service GCP** interne, d'**acc√©der aux donn√©es √† travers le Workspace au nom des utilisateurs**. Cette fonctionnalit√©, cruciale pour les applications interagissant avec les API Google ou les services n√©cessitant une impersonation d'utilisateur, am√©liore l'efficacit√© et r√©duit les erreurs humaines en automatisant les t√¢ches. En utilisant OAuth 2.0, les d√©veloppeurs d'applications et les administrateurs peuvent donner √† ces comptes de service l'acc√®s aux donn√©es utilisateur sans le consentement individuel de l'utilisateur.

Google Workspace permet la cr√©ation de deux principaux types d'identit√©s d'objets d√©l√©gu√©s globaux :

* **Applications GWS :** Les applications du Workspace Marketplace peuvent √™tre configur√©es en tant qu'identit√© d√©l√©gu√©e. Avant d'√™tre disponibles sur le march√©, chaque application Workspace est examin√©e par Google pour minimiser les abus potentiels. Bien que cela n'√©limine pas enti√®rement le risque d'abus, cela rend consid√©rablement plus difficile que de tels incidents se produisent.
* **Compte de Service GCP :** En savoir plus sur les [**Comptes de Service GCP ici**](../gcp-basic-information/#service-accounts).

### **D√©l√©gation √† l'√âchelle du Domaine : Sous le Capot**

Voici comment un compte de service GCP peut acc√©der aux API Google au nom d'autres identit√©s dans Google Workspace :

<figure><img src="../../../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

1. **L'identit√© cr√©e un JWT :** L'identit√© utilise la cl√© priv√©e du compte de service (partie du fichier de paire de cl√©s JSON) pour signer un JWT. Ce JWT contient des revendications sur le compte de service, l'utilisateur cible √† impersonner et les √©tendues OAuth d'acc√®s √† l'API REST demand√©e.
2. **L'identit√© utilise le JWT pour demander un jeton d'acc√®s :** L'application/l'utilisateur utilise le JWT pour demander un jeton d'acc√®s aupr√®s du service OAuth 2.0 de Google. La demande inclut √©galement l'utilisateur cible √† impersonner (l'e-mail de l'utilisateur Workspace) et les √©tendues pour lesquelles l'acc√®s est demand√©.
3. **Le service OAuth 2.0 de Google renvoie un jeton d'acc√®s :** Le jeton d'acc√®s repr√©sente l'autorit√© du compte de service √† agir au nom de l'utilisateur pour les √©tendues sp√©cifi√©es. Ce jeton est g√©n√©ralement de courte dur√©e et doit √™tre rafra√Æchi p√©riodiquement (selon les besoins de l'application). Il est essentiel de comprendre que les √©tendues OAuth sp√©cifi√©es dans le jeton JWT ont une validit√© et un impact sur le jeton d'acc√®s r√©sultant. Par exemple, les jetons d'acc√®s poss√©dant plusieurs √©tendues auront une validit√© pour de nombreuses applications API REST.
4. **L'identit√© utilise le jeton d'acc√®s pour appeler les API Google :** Maintenant avec un jeton d'acc√®s pertinent, le service peut acc√©der √† l API REST requise. L'application utilise ce jeton d'acc√®s dans l'en-t√™te "Autorisation" de ses requ√™tes HTTP destin√©es aux API Google. Ces API utilisent le jeton pour v√©rifier l'identit√© impersonn√©e et confirmer qu'elle a l'autorisation n√©cessaire.
5. **Les API Google renvoient les donn√©es demand√©es :** Si le jeton d'acc√®s est valide et que le compte de service a l'autorisation appropri√©e, les API Google renvoient les donn√©es demand√©es. Par exemple, dans l'image suivante, nous avons utilis√© la m√©thode _users.messages.list_ pour lister tous les identifiants de messages Gmail associ√©s √† un utilisateur Workspace cible.

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √âquipe Rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
