# GCP - 도메인 전체 위임 이해하기

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)을 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

이 게시물은 [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)의 소개입니다. 자세한 내용은 해당 링크에서 확인할 수 있습니다.

## **도메인 전체 위임 이해하기**

Google Workspace의 도메인 전체 위임은 Google Workspace Marketplace의 **외부 앱** 또는 내부 **GCP 서비스 계정**과 같은 신원 객체가 사용자를 대신하여 Workspace 전체의 데이터에 **액세스할 수 있도록**합니다. 이 기능은 Google API와 상호 작용하는 앱이나 사용자 위장이 필요한 서비스에서 중요하며, 작업을 자동화하여 인간 오류를 최소화하고 효율성을 향상시킵니다. OAuth 2.0을 사용하여 앱 개발자와 관리자는 이러한 서비스 계정에 개별 사용자 동의 없이 사용자 데이터에 액세스 권한을 부여할 수 있습니다.\
\
Google Workspace에서는 두 가지 주요 전역 위임 객체 신원을 생성할 수 있습니다:

* **GWS 애플리케이션:** Workspace Marketplace의 애플리케이션을 위임 신원으로 설정할 수 있습니다. Workspace 애플리케이션은 잠재적인 오용을 최소화하기 위해 Google에 의해 검토됩니다. 이로 인해 오용 사례가 발생할 가능성은 완전히 제거되지 않지만, 그 발생을 상당히 어렵게 만듭니다.
* **GCP 서비스 계정:** [**GCP 서비스 계정에 대해 자세히 알아보세요**](../gcp-basic-information.md#service-accounts).

### **도메인 전체 위임: 내부 동작**

GCP 서비스 계정이 Google Workspace의 다른 신원을 대신하여 Google API에 액세스하는 방법은 다음과 같습니다:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **신원이 JWT를 생성합니다:** 신원은 서비스 계정의 개인 키 (JSON 키 쌍 파일의 일부)를 사용하여 JWT를 서명합니다. 이 JWT에는 서비스 계정, 위장할 대상 사용자 및 요청 중인 REST API에 대한 OAuth 스코프에 대한 클레임이 포함됩니다.
2. **신원이 액세스 토큰을 요청하기 위해 JWT를 사용합니다:** 애플리케이션/사용자는 JWT를 사용하여 Google의 OAuth 2.0 서비스에서 액세스 토큰을 요청합니다. 요청에는 위장할 대상 사용자 (사용자의 Workspace 이메일) 및 액세스가 요청되는 스코프도 포함됩니다.
3. **Google의 OAuth 2.0 서비스가 액세스 토큰을 반환합니다:** 액세스 토큰은 서비스 계정이 지정된 스코프에 대해 사용자를 대신하여 작업을 수행할 권한을 나타냅니다. 이 토큰은 일반적으로 수명이 짧으며 주기적으로 갱신해야 합니다 (애플리케이션의 요구에 따라). JWT 토큰에 지정된 OAuth 스코프가 유효하며 결과적인 액세스 토큰에 영향을 미침을 이해하는 것이 중요합니다. 예를 들어, 여러 스코프를 가진 액세스 토큰은 여러 REST API 애플리케이션에 대해 유효합니다.
4. **신원이 액세스 토큰을 사용하여 Google API를 호출합니다**: 관련 액세스 토큰을 사용하여 서비스는 필요한 REST API에 액세스할 수 있습니다. 애플리케이션은 Google API에 대한 HTTP 요청의 "Authorization" 헤더에 이 액세스 토큰을 사용합니다. 이러한 API는 토큰을 사용하여 위장된 신원을 확인하고 필요한 권한이 있는지 확인합니다.
5. **Google API가 요청된 데이터를 반환합니다**: 액세스 토큰이 유효하고 서비스 계정에 적절한 권한이 있는 경우, Google API는 요청된 데이터를 반환합니다. 예를 들어, 다음 그림에서는 _users.messages.list_ 메서드를 사용하여 대상 Workspace 사용자와 관련된 모든 Gmail 메시지 ID를 나열했습니다.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)을 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
