# GCP - 理解域范围委派

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

本文是从[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)总结而来的，您可以访问该链接获取更多详情。

## **理解域范围委派**

Google Workspace的域范围委派允许一个身份对象，无论是来自Google Workspace市场的**外部应用**还是内部的**GCP服务账户**，代表用户**访问Workspace中的数据**。这个功能对于与Google API交互的应用程序或需要用户模拟的服务至关重要，它通过自动化任务提高效率并减少人为错误。使用OAuth 2.0，应用开发者和管理员可以授权这些服务账户访问用户数据，无需单独用户同意。\
\
Google Workspace允许创建两种主要类型的全局委派身份对象：

* **GWS应用程序：** 来自Workspace市场的应用程序可以设置为委派身份。每个Workspace应用程序在市场上提供之前都要经过Google的审核，以尽量减少潜在的滥用风险。虽然这并不能完全消除滥用的可能性，但它显著增加了此类事件发生的难度。
* **GCP服务账户：** 了解更多关于[**GCP服务账户**](../gcp-basic-information.md#service-accounts)。

### **域范围委派：内部原理**

以下是GCP服务账户代表Google Workspace中其他身份访问Google API的方式：

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **身份创建JWT：** 身份使用服务账户的私钥（JSON密钥对文件的一部分）签署JWT。这个JWT包含关于服务账户、要模拟的目标用户以及请求的REST API访问范围的声明。
2. **身份使用JWT请求访问令牌：** 应用程序/用户使用JWT向Google的OAuth 2.0服务请求访问令牌。请求还包括要模拟的目标用户（用户的Workspace电子邮件）和请求访问的范围。
3. **Google的OAuth 2.0服务返回访问令牌：** 访问令牌代表服务账户代表用户行事的权限，适用于指定的范围。这个令牌通常是短期的，需要定期刷新（根据应用程序的需要）。理解JWT令牌中指定的OAuth范围的有效性和影响对于结果访问令牌至关重要。例如，拥有多个范围的访问令牌将对多个REST API应用程序有效。
4. **身份使用访问令牌调用Google API：** 现在有了相关的访问令牌，服务可以访问所需的REST API。应用程序在其发送给Google API的HTTP请求的"Authorization"头部中使用这个访问令牌。这些API使用令牌来验证模拟的身份，并确认它具有必要的授权。
5. **Google API返回请求的数据：** 如果访问令牌有效且服务账户具有适当的授权，Google API将返回请求的数据。例如，在下图中，我们利用了_users.messages.list_方法列出了与目标Workspace用户相关的所有Gmail消息ID。





<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
