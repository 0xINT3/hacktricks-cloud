# GCP - Entendendo a Delega√ß√£o em √Çmbito de Dom√≠nio

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

Este post √© a introdu√ß√£o de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) que pode ser acessado para mais detalhes.

## **Entendendo a Delega√ß√£o em √Çmbito de Dom√≠nio**

A delega√ß√£o em √¢mbito de dom√≠nio do Google Workspace permite que um objeto de identidade, seja um **aplicativo externo** do Marketplace do Google Workspace ou uma **Conta de Servi√ßo GCP** interna, **acesse dados em todo o Workspace em nome dos usu√°rios**. Essa funcionalidade, crucial para aplicativos que interagem com APIs do Google ou servi√ßos que precisam de personifica√ß√£o de usu√°rio, aumenta a efici√™ncia e minimiza erros humanos automatizando tarefas. Usando OAuth 2.0, desenvolvedores de aplicativos e administradores podem dar a essas contas de servi√ßo acesso aos dados do usu√°rio sem consentimento individual.\
\
O Google Workspace permite a cria√ß√£o de dois principais tipos de identidades de objeto delegado global:

* **Aplica√ß√µes GWS:** Aplica√ß√µes do Marketplace do Workspace podem ser configuradas como uma identidade delegada. Antes de serem disponibilizadas no marketplace, cada aplica√ß√£o do Workspace passa por uma revis√£o do Google para minimizar o potencial de uso indevido. Embora isso n√£o elimine completamente o risco de abuso, aumenta significativamente a dificuldade para que tais incidentes ocorram.
* **Conta de Servi√ßo GCP:** Saiba mais sobre [**Contas de Servi√ßo GCP aqui**](../gcp-basic-information.md#service-accounts).

### **Delega√ß√£o em √Çmbito de Dom√≠nio: Por Dentro do Processo**

Veja como uma Conta de Servi√ßo GCP pode acessar APIs do Google em nome de outras identidades no Google Workspace:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **A Identidade cria um JWT:** A Identidade usa a chave privada da conta de servi√ßo (parte do arquivo de par de chaves JSON) para assinar um JWT. Este JWT cont√©m declara√ß√µes sobre a conta de servi√ßo, o usu√°rio alvo a ser personificado e os escopos OAuth de acesso √† API REST que est√° sendo solicitada.
2. **A Identidade usa o JWT para solicitar um token de acesso:** O aplicativo/usu√°rio usa o JWT para solicitar um token de acesso do servi√ßo OAuth 2.0 do Google. A solicita√ß√£o tamb√©m inclui o usu√°rio alvo a ser personificado (o email do Workspace do usu√°rio) e os escopos para os quais o acesso √© solicitado.
3. **O servi√ßo OAuth 2.0 do Google retorna um token de acesso:** O token de acesso representa a autoridade da conta de servi√ßo para agir em nome do usu√°rio para os escopos especificados. Este token geralmente tem vida curta e deve ser atualizado periodicamente (conforme a necessidade do aplicativo). √â essencial entender que os escopos OAuth especificados no token JWT t√™m validade e impacto no token de acesso resultante. Por exemplo, tokens de acesso com m√∫ltiplos escopos ter√£o validade para v√°rias aplica√ß√µes de API REST.
4. **A Identidade usa o token de acesso para chamar APIs do Google**: Agora com um token de acesso relevante, o servi√ßo pode acessar a API REST necess√°ria. O aplicativo usa esse token de acesso no cabe√ßalho "Authorization" de suas solicita√ß√µes HTTP destinadas √†s APIs do Google. Essas APIs utilizam o token para verificar a identidade personificada e confirmar se ela tem a autoriza√ß√£o necess√°ria.
5. **As APIs do Google retornam os dados solicitados**: Se o token de acesso for v√°lido e a conta de servi√ßo tiver autoriza√ß√£o apropriada, as APIs do Google retornam os dados solicitados. Por exemplo, na imagem a seguir, utilizamos o m√©todo _users.messages.list_ para listar todos os IDs de mensagens do Gmail associados a um usu√°rio alvo do Workspace.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
