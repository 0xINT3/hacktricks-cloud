# GCP - Comprensione della Delega a livello di dominio

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) di GitHub.

</details>

Questo post √® l'introduzione di [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) a cui √® possibile accedere per ulteriori dettagli.

## **Comprensione della Delega a livello di dominio**

La delega a livello di dominio di Google Workspace consente a un oggetto di identit√†, sia un **app esterna** dal Google Workspace Marketplace che un **Account del servizio GCP** interno, di **accedere ai dati in tutto il Workspace per conto degli utenti**. Questa funzionalit√†, fondamentale per le app che interagiscono con le API di Google o i servizi che richiedono l'impersonificazione dell'utente, migliora l'efficienza e riduce gli errori umani automatizzando le attivit√†. Utilizzando OAuth 2.0, gli sviluppatori di app e gli amministratori possono concedere a questi account di servizio l'accesso ai dati degli utenti senza il consenso individuale dell'utente.\
\
Google Workspace consente la creazione di due tipi principali di identit√† oggetto delegato globale:

* **App GWS:** Le applicazioni del Marketplace di Workspace possono essere configurate come identit√† delegate. Prima di essere disponibile nel marketplace, ogni applicazione di Workspace viene sottoposta a una revisione da parte di Google per ridurre al minimo possibili abusi. Sebbene ci√≤ non elimini completamente il rischio di abusi, aumenta significativamente la difficolt√† che tali incidenti si verifichino.
* **Account del servizio GCP:** Per saperne di pi√π sugli [**Account del servizio GCP qui**](../gcp-basic-information.md#service-accounts).

### **Delega a livello di dominio: Sotto il cofano**

Ecco come un Account del servizio GCP pu√≤ accedere alle API di Google per conto di altre identit√† in Google Workspace:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **L'identit√† crea un JWT:** L'identit√† utilizza la chiave privata dell'account di servizio (parte del file di coppia di chiavi JSON) per firmare un JWT. Questo JWT contiene informazioni sull'account di servizio, sull'utente di destinazione da impersonare e sulle autorizzazioni OAuth di accesso all'API REST richiesta.
2. **L'identit√† utilizza il JWT per richiedere un token di accesso:** L'applicazione/l'utente utilizza il JWT per richiedere un token di accesso dal servizio OAuth 2.0 di Google. La richiesta include anche l'utente di destinazione da impersonare (l'email dell'utente di Workspace) e le autorizzazioni per le quali viene richiesto l'accesso.
3. **Il servizio OAuth 2.0 di Google restituisce un token di accesso:** Il token di accesso rappresenta l'autorit√† dell'account di servizio di agire per conto dell'utente per le autorizzazioni specificate. Questo token di solito ha una durata limitata e deve essere aggiornato periodicamente (in base alle esigenze dell'applicazione). √à importante comprendere che le autorizzazioni OAuth specificate nel token JWT hanno validit√† e impatto sul token di accesso risultante. Ad esempio, i token di accesso che possiedono pi√π autorizzazioni avranno validit√† per numerose applicazioni API REST.
4. **L'identit√† utilizza il token di accesso per chiamare le API di Google**: Ora, con un token di accesso pertinente, il servizio pu√≤ accedere all'API REST richiesta. L'applicazione utilizza questo token di accesso nell'intestazione "Authorization" delle sue richieste HTTP destinate alle API di Google. Queste API utilizzano il token per verificare l'identit√† impersonata e confermare che abbia l'autorizzazione necessaria.
5. **Le API di Google restituiscono i dati richiesti**: Se il token di accesso √® valido e l'account di servizio ha l'autorizzazione appropriata, le API di Google restituiscono i dati richiesti. Ad esempio, nell'immagine seguente, abbiamo sfruttato il metodo _users.messages.list_ per elencare tutti gli ID dei messaggi di Gmail associati a un utente di Workspace di destinazione.

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) di GitHub.

</details>
