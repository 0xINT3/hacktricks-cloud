# GCP - Zrozumienie pełnomocnictwa na poziomie domeny

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Ten post jest wprowadzeniem do [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover), gdzie można znaleźć więcej szczegółów.

## **Zrozumienie pełnomocnictwa na poziomie domeny**

Pełnomocnictwo na poziomie domeny w Google Workspace umożliwia obiektowi tożsamości, czy to **zewnętrznej aplikacji** z Google Workspace Marketplace, czy wewnętrznemu **kontu usługi GCP**, **dostęp do danych w całym Workspace w imieniu użytkowników**. Ta funkcja, która jest kluczowa dla aplikacji współpracujących z interfejsami API Google lub usługami wymagającymi podmiany tożsamości użytkownika, zwiększa wydajność i minimalizuje błędy ludzkie poprzez automatyzację zadań. Za pomocą OAuth 2.0, deweloperzy aplikacji i administratorzy mogą udzielić tym kontom usługi dostępu do danych użytkownika bez indywidualnej zgody użytkownika.\
\
Google Workspace umożliwia tworzenie dwóch głównych typów globalnych tożsamości obiektów pełnomocnictwa:

* **Aplikacje GWS:** Aplikacje z Marketplace Workspace mogą być skonfigurowane jako tożsamość pełnomocnictwa. Przed udostępnieniem w markecie każda aplikacja Workspace przechodzi proces przeglądu przez Google w celu zminimalizowania potencjalnego nadużycia. Choć to nie eliminuje całkowicie ryzyka nadużycia, znacznie utrudnia wystąpienie takich incydentów.
* **Konto usługi GCP:** Dowiedz się więcej na temat [**kont usługi GCP tutaj**](../gcp-basic-information.md#service-accounts).

### **Pełnomocnictwo na poziomie domeny: Kulisy**

Tak GCP Konto usługi może uzyskać dostęp do interfejsów API Google w imieniu innych tożsamości w Google Workspace:

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **Tożsamość tworzy JWT:** Tożsamość używa klucza prywatnego konta usługi (część pliku pary kluczy JSON) do podpisania JWT. Ten JWT zawiera informacje o koncie usługi, użytkowniku docelowemu do podmiany tożsamości oraz zakresach OAuth dostępu do żądanego interfejsu API REST.
2. **Tożsamość używa JWT do żądania tokena dostępu:** Aplikacja/użytkownik używa JWT do żądania tokenu dostępu od usługi OAuth 2.0 Google. Żądanie zawiera również użytkownika docelowego do podmiany tożsamości (adres e-mail użytkownika Workspace) oraz zakresy, dla których żądany jest dostęp.
3. **Usługa OAuth 2.0 Google zwraca token dostępu:** Token dostępu reprezentuje uprawnienia konta usługi do działania w imieniu użytkownika dla określonych zakresów. Ten token jest zazwyczaj krótkotrwały i musi być regularnie odświeżany (zgodnie z potrzebami aplikacji). Ważne jest zrozumienie, że zakresy OAuth określone w tokenie JWT mają ważność i wpływ na wynikowy token dostępu. Na przykład tokeny dostępu posiadające wiele zakresów będą miały ważność dla licznych aplikacji interfejsu API REST.
4. **Tożsamość używa tokenu dostępu do wywołania interfejsów API Google**: Teraz, posiadając odpowiedni token dostępu, usługa może uzyskać dostęp do wymaganego interfejsu API REST. Aplikacja używa tego tokenu dostępu w nagłówku "Authorization" swoich żądań HTTP kierowanych do interfejsów API Google. Te interfejsy API wykorzystują token do weryfikacji podmienionej tożsamości i potwierdzenia, czy ma ona odpowiednie uprawnienia.
5. **Interfejsy API Google zwracają żądane dane**: Jeśli token dostępu jest ważny, a konto usługi ma odpowiednie uprawnienia, interfejsy API Google zwracają żądane dane. Na przykład, na poniższym obrazku wykorzystaliśmy metodę _users.messages.list_, aby wyświetlić listę identyfikatorów wiadomości Gmail powiązanych z użytkownikiem docelowym w Workspace.

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
