# GCP - パブリックバケットの特権エスカレーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし **HackTricks で会社を宣伝したい**場合や、**PEASS の最新バージョンを見たい**場合や、HackTricks を **PDF でダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **ハッキングのトリックを共有するために、PR を** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **の GitHub リポジトリに提出してください。**

</details>

## バケットの特権エスカレーション

もしバケットポリシーが「allUsers」または「allAuthenticatedUsers」に対して「バケットポリシーの書き込み」（**storage.buckets.setIamPolicy** 権限）を許可している場合、誰でもバケットポリシーを変更し、自分自身に完全アクセス権を付与することができます。

### 権限の確認

バケットの権限を確認する方法は2つあります。最初の方法は、`https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam` にリクエストを送信するか、`gsutil iam get gs://BUCKET_NAME` を実行して権限を要求することです。

ただし、ユーザー（おそらく allUsers または allAuthenticatedUsers に所属する可能性がある）がバケットの iam ポリシーを読み取る権限（storage.buckets.getIamPolicy）を持っていない場合、これは機能しません。

常に機能するもう一つのオプションは、バケットの testPermissions エンドポイントを使用して指定された権限を持っているかどうかを確認することです。たとえば、次のようにアクセスします：`https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam/testPermissions?permissions=storage.buckets.delete&permissions=storage.buckets.get&permissions=storage.buckets.getIamPolicy&permissions=storage.buckets.setIamPolicy&permissions=storage.buckets.update&permissions=storage.objects.create&permissions=storage.objects.delete&permissions=storage.objects.get&permissions=storage.objects.list&permissions=storage.objects.update`

### エスカレーション

「gsutil」Google Storage CLI プログラムを使用して、次のコマンドを実行することで、「allAuthenticatedUsers」に「Storage Admin」ロールへのアクセス権を付与し、したがって、バケットに付与された特権をエスカレーションすることができます：
```
gsutil iam ch group:allAuthenticatedUsers:admin gs://BUCKET_NAME
```
LegacyBucketOwnerからStorage Adminに昇格することの主な魅力は、「storage.buckets.delete」特権を使用できることです。理論上、特権を昇格させた後にバケットを削除し、自分のアカウントでバケットを作成して名前を盗むことができます。

## 参考文献

* [https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/](https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
