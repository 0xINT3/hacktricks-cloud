# GCP - 渗透测试所需的权限

如果您想对 GCP 环境进行渗透测试，您需要请求足够的权限来检查在 GCP 中使用的所有或大部分服务。理想情况下，您应该要求客户执行以下操作：

* 在项目中**创建**一个新的**项目**
* 在该项目中**创建**一个**服务帐号**（获取**json凭据**）
* 在组织中为**服务帐号**授予本文后面提到的**权限**
* 在创建的项目中**启用**本文后面提到的**API**

**权限集**用于使用后面提出的工具：
```bash
roles/bigquery.metadataViewer
roles/composer.user
roles/compute.viewer
roles/container.clusterViewer
roles/iam.securityReviewer
roles/resourcemanager.folderViewer
roles/resourcemanager.organizationViewer
roles/resourcemanager.tagViewer
roles/secretmanager.viewer
roles/serviceusage.serviceUsageConsumer

# The following one can only be assigned if a service account is created
roles/websecurityscanner.serviceAgent

# The role roles/serviceusage.serviceUsageConsumer is needed to use gcloud asset
```
启用的API（来自starbase）：
```
gcloud services enable \
serviceusage.googleapis.com \
cloudfunctions.googleapis.com \
storage.googleapis.com \
iam.googleapis.com \
cloudresourcemanager.googleapis.com \
compute.googleapis.com \
cloudkms.googleapis.com \
sqladmin.googleapis.com \
bigquery.googleapis.com \
container.googleapis.com \
dns.googleapis.com \
logging.googleapis.com \
monitoring.googleapis.com \
binaryauthorization.googleapis.com \
pubsub.googleapis.com \
appengine.googleapis.com \
run.googleapis.com \
redis.googleapis.com \
memcache.googleapis.com \
apigateway.googleapis.com \
spanner.googleapis.com \
privateca.googleapis.com \
cloudasset.googleapis.com \
accesscontextmanager.googleapis.com
```
## 单个工具的权限

### [PurplePanda](https://github.com/carlospolop/PurplePanda/tree/master/intel/google)
```
From https://github.com/carlospolop/PurplePanda/tree/master/intel/google#permissions-configuration

roles/bigquery.metadataViewer
roles/composer.user
roles/compute.viewer
roles/container.clusterViewer
roles/iam.securityReviewer
roles/resourcemanager.folderViewer
roles/resourcemanager.organizationViewer
roles/secretmanager.viewer
```
### [ScoutSuite](https://github.com/nccgroup/ScoutSuite/wiki/Google-Cloud-Platform#permissions)

### ScoutSuite

ScoutSuite is a security auditing tool for cloud environments. It allows you to assess the security posture of your Google Cloud Platform (GCP) infrastructure. ScoutSuite provides a comprehensive analysis of the permissions assigned to different entities within your GCP environment.

ScoutSuite can help you identify potential security vulnerabilities and misconfigurations in your GCP infrastructure. By analyzing the permissions assigned to various entities, you can gain insights into the potential risks and take appropriate actions to mitigate them.

To use ScoutSuite, you need to have appropriate permissions within your GCP environment. The tool requires read-only access to your GCP resources, including Compute Engine, Cloud Storage, and IAM policies.

By running ScoutSuite, you can generate detailed reports that highlight any security issues or vulnerabilities in your GCP infrastructure. These reports can be used to guide your security remediation efforts and ensure the overall security of your GCP environment.

For more information on how to use ScoutSuite and its capabilities, refer to the [official documentation](https://github.com/nccgroup/ScoutSuite/wiki/Google-Cloud-Platform#permissions).
```
From https://github.com/nccgroup/ScoutSuite/wiki/Google-Cloud-Platform#permissions

roles/Viewer
roles/iam.securityReviewer
roles/stackdriver.accounts.viewer
```
### [CloudSploit](https://github.com/aquasecurity/cloudsploit/blob/master/docs/gcp.md#cloud-provider-configuration)

CloudSploit是一款用于云安全评估的开源工具。它提供了一系列的规则和检查项，用于检测Google Cloud Platform（GCP）中的安全配置问题。您可以使用CloudSploit来评估GCP环境中的权限设置、网络配置、存储配置等方面的安全性。
```
From https://github.com/aquasecurity/cloudsploit/blob/master/docs/gcp.md#cloud-provider-configuration

includedPermissions:
- cloudasset.assets.listResource
- cloudkms.cryptoKeys.list
- cloudkms.keyRings.list
- cloudsql.instances.list
- cloudsql.users.list
- compute.autoscalers.list
- compute.backendServices.list
- compute.disks.list
- compute.firewalls.list
- compute.healthChecks.list
- compute.instanceGroups.list
- compute.instances.getIamPolicy
- compute.instances.list
- compute.networks.list
- compute.projects.get
- compute.securityPolicies.list
- compute.subnetworks.list
- compute.targetHttpProxies.list
- container.clusters.list
- dns.managedZones.list
- iam.serviceAccountKeys.list
- iam.serviceAccounts.list
- logging.logMetrics.list
- logging.sinks.list
- monitoring.alertPolicies.list
- resourcemanager.folders.get
- resourcemanager.folders.getIamPolicy
- resourcemanager.folders.list
- resourcemanager.hierarchyNodes.listTagBindings
- resourcemanager.organizations.get
- resourcemanager.organizations.getIamPolicy
- resourcemanager.projects.get
- resourcemanager.projects.getIamPolicy
- resourcemanager.projects.list
- resourcemanager.resourceTagBindings.list
- resourcemanager.tagKeys.get
- resourcemanager.tagKeys.getIamPolicy
- resourcemanager.tagKeys.list
- resourcemanager.tagValues.get
- resourcemanager.tagValues.getIamPolicy
- resourcemanager.tagValues.list
- storage.buckets.getIamPolicy
- storage.buckets.list
```
### [地图绘制](https://lyft.github.io/cartography/modules/gcp/config.html)
```
From https://lyft.github.io/cartography/modules/gcp/config.html

roles/iam.securityReviewer
roles/resourcemanager.organizationViewer
roles/resourcemanager.folderViewer
```
### [Starbase](https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md)
```
From https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md

roles/iam.securityReviewer
roles/iam.organizationRoleViewer
roles/bigquery.metadataViewer
```

