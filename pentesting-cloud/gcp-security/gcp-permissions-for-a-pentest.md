# GCP - ペンテストのための権限

GCP環境のペンテストを行う場合、GCPで使用されている**すべてまたはほとんどのサービス**をチェックするために十分な権限を要求する必要があります。理想的には、クライアントに以下の作業を依頼してください：

* 新しいプロジェクトを**作成**する
* そのプロジェクト内に**サービスアカウント**を**作成**する（**JSON認証情報**を取得する）
* この投稿で後述する**権限**を**サービスアカウント**に与える（ORGANIZATION上で）
* 作成したプロジェクトで後述する**API**を**有効化**する

後述するツールを使用するための**権限セット**：
```bash
roles/bigquery.metadataViewer
roles/composer.user
roles/compute.viewer
roles/container.clusterViewer
roles/iam.securityReviewer
roles/resourcemanager.folderViewer
roles/resourcemanager.organizationViewer
roles/resourcemanager.tagViewer
roles/secretmanager.viewer
roles/serviceusage.serviceUsageConsumer

# The following one can only be assigned if a service account is created
roles/websecurityscanner.serviceAgent

# The role roles/serviceusage.serviceUsageConsumer is needed to use gcloud asset
```
APIを有効にする（スターベースから）：
```
gcloud services enable \
serviceusage.googleapis.com \
cloudfunctions.googleapis.com \
storage.googleapis.com \
iam.googleapis.com \
cloudresourcemanager.googleapis.com \
compute.googleapis.com \
cloudkms.googleapis.com \
sqladmin.googleapis.com \
bigquery.googleapis.com \
container.googleapis.com \
dns.googleapis.com \
logging.googleapis.com \
monitoring.googleapis.com \
binaryauthorization.googleapis.com \
pubsub.googleapis.com \
appengine.googleapis.com \
run.googleapis.com \
redis.googleapis.com \
memcache.googleapis.com \
apigateway.googleapis.com \
spanner.googleapis.com \
privateca.googleapis.com \
cloudasset.googleapis.com \
accesscontextmanager.googleapis.com
```
## 個別のツールの権限

### [PurplePanda](https://github.com/carlospolop/PurplePanda/tree/master/intel/google)
```
From https://github.com/carlospolop/PurplePanda/tree/master/intel/google#permissions-configuration

roles/bigquery.metadataViewer
roles/composer.user
roles/compute.viewer
roles/container.clusterViewer
roles/iam.securityReviewer
roles/resourcemanager.folderViewer
roles/resourcemanager.organizationViewer
roles/secretmanager.viewer
```
### [ScoutSuite](https://github.com/nccgroup/ScoutSuite/wiki/Google-Cloud-Platform#permissions)

ScoutSuite is a security auditing tool for Google Cloud Platform (GCP) that helps identify potential vulnerabilities and misconfigurations. It analyzes the permissions assigned to various GCP resources and provides insights into the security posture of the cloud environment.

To use ScoutSuite, you need to have the necessary permissions in GCP. The following are the minimum permissions required for a successful ScoutSuite scan:

- `compute.instances.list` - Required to list compute instances.
- `compute.disks.list` - Required to list compute disks.
- `compute.firewalls.list` - Required to list compute firewalls.
- `compute.networks.list` - Required to list compute networks.
- `compute.subnetworks.list` - Required to list compute subnetworks.
- `compute.zones.list` - Required to list compute zones.
- `iam.serviceAccounts.list` - Required to list service accounts.
- `resourcemanager.projects.get` - Required to get project details.
- `resourcemanager.projects.list` - Required to list projects.
- `storage.buckets.list` - Required to list storage buckets.

Make sure the user or service account used for ScoutSuite has these permissions assigned.
```
From https://github.com/nccgroup/ScoutSuite/wiki/Google-Cloud-Platform#permissions

roles/Viewer
roles/iam.securityReviewer
roles/stackdriver.accounts.viewer
```
### [CloudSploit](https://github.com/aquasecurity/cloudsploit/blob/master/docs/gcp.md#cloud-provider-configuration)

CloudSploitは、GCPのセキュリティ診断ツールです。このツールは、GCPの設定と構成に関する問題を特定し、セキュリティの脆弱性を検出するために使用されます。CloudSploitは、GCPの各サービスに対して特定の設定をチェックし、セキュリティ上の問題を報告します。このツールを使用することで、GCP環境のセキュリティを向上させることができます。
```
From https://github.com/aquasecurity/cloudsploit/blob/master/docs/gcp.md#cloud-provider-configuration

includedPermissions:
- cloudasset.assets.listResource
- cloudkms.cryptoKeys.list
- cloudkms.keyRings.list
- cloudsql.instances.list
- cloudsql.users.list
- compute.autoscalers.list
- compute.backendServices.list
- compute.disks.list
- compute.firewalls.list
- compute.healthChecks.list
- compute.instanceGroups.list
- compute.instances.getIamPolicy
- compute.instances.list
- compute.networks.list
- compute.projects.get
- compute.securityPolicies.list
- compute.subnetworks.list
- compute.targetHttpProxies.list
- container.clusters.list
- dns.managedZones.list
- iam.serviceAccountKeys.list
- iam.serviceAccounts.list
- logging.logMetrics.list
- logging.sinks.list
- monitoring.alertPolicies.list
- resourcemanager.folders.get
- resourcemanager.folders.getIamPolicy
- resourcemanager.folders.list
- resourcemanager.hierarchyNodes.listTagBindings
- resourcemanager.organizations.get
- resourcemanager.organizations.getIamPolicy
- resourcemanager.projects.get
- resourcemanager.projects.getIamPolicy
- resourcemanager.projects.list
- resourcemanager.resourceTagBindings.list
- resourcemanager.tagKeys.get
- resourcemanager.tagKeys.getIamPolicy
- resourcemanager.tagKeys.list
- resourcemanager.tagValues.get
- resourcemanager.tagValues.getIamPolicy
- resourcemanager.tagValues.list
- storage.buckets.getIamPolicy
- storage.buckets.list
```
### [Cartography](https://lyft.github.io/cartography/modules/gcp/config.html)

### カルトグラフィー

Cartographyは、GCPの設定を調査し、セキュリティ上の問題を特定するためのツールです。このツールを使用すると、GCPのリソース、アクセス権、および設定に関する情報を収集できます。これにより、ペンテスト中にセキュリティの脆弱性や潜在的なリスクを特定することができます。

Cartographyは、GCPの設定ファイルを解析し、リソースの依存関係を可視化することができます。これにより、セキュリティ上の問題を特定するための洞察を得ることができます。また、Cartographyは、GCPの設定に関するドキュメントを生成することもできます。

Cartographyを使用すると、GCPの設定に関する情報を収集し、セキュリティ上の問題を特定することができます。これにより、ペンテスト中にGCPのセキュリティを向上させるための対策を講じることができます。

Cartographyは、GCPの設定を調査し、セキュリティ上の問題を特定するための強力なツールです。ペンテスト中に使用することで、GCPのセキュリティを向上させるための洞察を得ることができます。
```
From https://lyft.github.io/cartography/modules/gcp/config.html

roles/iam.securityReviewer
roles/resourcemanager.organizationViewer
roles/resourcemanager.folderViewer
```
### [Starbase](https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md)
```
From https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md

roles/iam.securityReviewer
roles/iam.organizationRoleViewer
roles/bigquery.metadataViewer
```

