# GCPからWorkspaceへのピボット

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* 自分のハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

この記事は、[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)からの要約です。詳細については、リンク先を参照してください。

## **ドメインワイドデリゲーションの理解**

Google Workspaceのドメインワイドデリゲーションは、Google Workspace Marketplaceの**外部アプリ**または内部の**GCPサービスアカウント**のいずれかを使用して、ユーザーを代表してWorkspace全体のデータにアクセスすることができます。この機能は、Google APIと対話するアプリやユーザーのなりすましを必要とするサービスがタスクを自動化することで、効率を向上させ、人為的なエラーを最小限に抑えることができます。OAuth 2.0を使用して、アプリの開発者や管理者はこれらのサービスアカウントに個別のユーザーの同意なしでユーザーデータへのアクセス権を与えることができます。\
\
Google Workspaceでは、2つの主要なグローバルデリゲートオブジェクトアイデンティティを作成できます。

* **GWSアプリケーション:** Workspace Marketplaceのアプリケーションは、委任されたアイデンティティとして設定することができます。Workspaceアプリケーションは、潜在的な誤用を最小限に抑えるために、Googleによるレビューを経てマーケットプレイスで利用可能になる前に、各アプリケーションが行われます。これにより、悪用のリスクは完全には排除されませんが、そのような事例が発生する難易度は大幅に増加します。
* **GCPサービスアカウント:** [**こちら**](gcp-basic-information.md#service-accounts)でGCPサービスアカウントについて詳しく説明しています。

### **ドメインワイドデリゲーション：内部構造**

GCPサービスアカウントがGoogle Workspace内の他のアイデンティティを代表してGoogle APIにアクセスする方法は次のとおりです：

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. **アイデンティティがJWTを作成する:** アイデンティティは、サービスアカウントの秘密鍵（JSONキーペアファイルの一部）を使用してJWTに署名します。このJWTには、サービスアカウントに関する情報、なりすまし対象のユーザー、リクエストされているREST APIへのアクセスのOAuthスコープに関するクレームが含まれています。
2. **アイデンティティがアクセストークンを要求するためにJWTを使用する:** アプリケーション/ユーザーは、JWTを使用してGoogleのOAuth 2.0サービスからアクセストークンを要求します。リクエストには、なりすまし対象のユーザー（ユーザーのWorkspaceメール）と、アクセスが要求されるスコープが含まれます。
3. **GoogleのOAuth 2.0サービスがアクセストークンを返す:** アクセストークンは、サービスアカウントが指定されたスコープに基づいてユーザーを代表してアクションを実行する権限を表します。このトークンは通常、有効期間が短く、定期的に更新する必要があります（アプリケーションの要件に応じて）。JWTトークンで指定されたOAuthスコープは、有効期間と結果のアクセストークンに影響を与えることが重要です。たとえば、複数のスコープを持つアクセストークンは、複数のREST APIアプリケーションに対して有効です。
4. **アイデンティティがアクセストークンを使用してGoogle APIを呼び出す:** 関連するアクセストークンを持つことで、サービスは必要なREST APIにアクセスできます。アプリケーションは、Google APIへのHTTPリクエストの「Authorization」ヘッダーにこのアクセストークンを使用します。これらのAPIは、トークンを使用してなりすましのアイデンティティを検証し、必要な権限を持っていることを確認します。
5. **Google APIが要求されたデータを返す:** アクセストークンが有効であり、サービスアカウントに適切な権限がある場合、Google APIは要求されたデータを返します。たとえば、次の図では、_users.messages.list_メソッドを使用して、対象のWorkspaceユーザーに関連付けられたすべてのGmailメッセージIDをリストしています。

## インタラクティブなGWSアクセスを伴う新しいデリゲーション

最初のシナリオでは、攻撃者は通常、IAMアイデンティティに初期アクセス権を持ち、GCPプロジェクトで**サービスアカウントを作成する能力**を持っています。さらに、彼はGWSに対して**スーパーアドミン特権**を持っています。

**攻撃手順:**

1. **新しいサービスアカウントと対応するキーペアの生成:** GCPでは、新しいサービスアカウントリソースを、コンソールを介して対話的に作成するか、API呼び出しとCLIツールを使用してプログラムで生成することができます。これには、**`iam.serviceAccountAdmin`**の役割または**`iam.serviceAccounts.create`**の**権限**を備えたカスタムロールが必要です。サービスアカウントが作成されたら、関連するキーペア（**`iam.serviceAccountKeys.create`**の権限）を生成します。
2. **新しいデリゲーションの作成**: 関連するアイデンティティオブジェクトとGoogle APIとの認証を可能にする関連する秘密鍵を持っている場合、Google Workspace内のサービスアカウントリソースに対して**新しいデリゲーションルールを
### 組織間の委任

OAuth SA IDはグローバルであり、**組織間の委任**に使用することができます。クロスグローバルの委任を防止するための制限は実装されていません。簡単に言えば、**異なるGCP組織のサービスアカウントを使用して、他のWorkspace組織でドメイン全体の委任を設定することができます**。これにより、**Workspaceへのスーパーアドミンアクセスのみが必要**となり、同じGCPアカウントへのアクセスは必要ありません。攻撃者は自身が制御するGCPアカウントでサービスアカウントと秘密キーを作成することができます。

## 既存の委任の侵害 - DeleFriend

関連するGCPサービスアカウントリソースへのアクセス権がある場合、IAMポリシー内に**既存のドメイン全体の委任**がある場合、新しいキーを作成し、すべての既存のJWTの可能性を列挙し、その既存の委任を使用してドメイン内の他のアイデンティティの代わりにGoogle Workspaceに対してAPI呼び出しを実行することを阻止するものはありません。

{% hint style="danger" %}
GCP組織/プロジェクトに何らかの方法で侵入した後、攻撃者はどのGCPサービスアカウントで**jsonキーを作成できるかを確認**し、それらを作成し、**SAが他のアイデンティティの代わりにWorkspace OAuthスコープにアクセスできるかを確認**することができます。
{% endhint %}

具体的な手順は以下の通りです：

1. リソースマネージャAPIを使用して、GCPプロジェクトを列挙します。
2. 初期IAMユーザーがアクセス権を持つ各プロジェクトリソースに対して、_GetIAMPolicy_を使用して**GCPサービスアカウントリソースを列挙**します。
3. 各サービスアカウントロールを繰り返し処理し、IAMポリシーの対象サービスアカウントリソースに対して**serviceAccountKeys.create**権限を持つ組み込み、基本、およびカスタムロールを見つけます。エディタロールには、この権限が元々備わっています。
4. IAMポリシーで関連する権限を持つ各サービスアカウントリソースに対して、**新しい**_**KEY\_ALG\_RSA\_2048**_**秘密キーを作成**します。
5. 各新しいサービスアカウントに対して、SAの秘密キー資格情報とOAuthスコープから構成される**JWTオブジェクト**を作成します。新しい_JWT_オブジェクトの作成プロセスでは、OAuthスコープの組み合わせを列挙するために、**oauth\_scopes.txt**リストのすべての既存の組み合わせを繰り返し処理します。リスト**oauth\_scopes.txt**は、Workspaceアイデンティティの乱用に関連するOAuthスコープを見つけるために見つけたすべてのOAuthスコープで更新されます。
6. _\_make\_authorization\_grant\_assertion_メソッドでは、DWDの下でJWTを生成するために**ターゲットのWorkspaceユーザー**（_subject_と呼ばれる）を宣言する必要があることがわかります。これは特定のユーザーを必要とするように思われるかもしれませんが、DWDはドメイン内のすべてのアイデンティティに影響を与えることを理解することが重要です。したがって、**ドメインの任意のユーザー**のためにJWTを作成することは、そのドメインのすべてのアイデンティティに影響を与えます。単純に言えば、1つの有効なWorkspaceユーザーが十分です。\
このユーザーはDeleFriendの_config.yaml_ファイルで定義することができます。ターゲットのWorkspaceユーザーが既にわかっていない場合、このツールはGCPプロジェクトにロールを持つドメインユーザーをスキャンして有効なWorkspaceユーザーを自動的に特定することをサポートします。再度強調しますが、JWTはドメイン固有であり、すべてのユーザーに対して生成されるわけではないため、自動プロセスはドメインごとに単一のユニークなアイデンティティを対象とします。
7. 各JWTに対して新しいベアラーアクセストークンを列挙し、トークンをtokeninfo APIで検証します。

この攻撃を自動的に実行するツールは、[DeleFriend](https://github.com/axon-git/DeleFriend)で見つけることができます。

## 参考文献

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**PEASSの最新バージョンにアクセス**したい場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、私たちの独占的な[NFT](https://opensea.io/collection/the-peass-family)コレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有**するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
