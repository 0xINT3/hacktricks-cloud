# GCPからWorkspaceへのピボット

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**のGitHubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

この投稿は、詳細については[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)でアクセスできるものの要約です。

## **ドメイン全体委任の理解**

Google Workspaceのドメイン全体委任は、Google Workspace Marketplaceの**外部アプリ**または内部の**GCPサービスアカウント**などのアイデンティティオブジェクトが、ユーザーに代わってWorkspace全体のデータに**アクセスする**ことを可能にします。この機能は、Google APIやユーザーのなりすましを必要とするサービスと対話するアプリにとって重要であり、タスクを自動化することで効率を向上させ、人為的なエラーを最小限に抑えます。OAuth 2.0を使用して、アプリ開発者と管理者は、個々のユーザーの同意なしにこれらのサービスアカウントにユーザーデータへのアクセスを許可することができます。\
\
Google Workspaceでは、2つの主要なタイプのグローバル委任オブジェクトアイデンティティを作成できます：

* **GWSアプリケーション：** Workspace Marketplaceのアプリケーションは、委任されたアイデンティティとして設定できます。マーケットプレイスで利用可能になる前に、各Workspaceアプリケーションは潜在的な悪用を最小限に抑えるためにGoogleによってレビューされます。これにより、リスクが完全に排除されるわけではありませんが、そのような事件が発生する難易度が大幅に高まります。
* **GCPサービスアカウント：** [**GCPサービスアカウントについてはこちら**](gcp-basic-information.md#service-accounts)をご覧ください。

### **ドメイン全体委任の内部**

これは、GCPサービスアカウントがGoogle Workspace内の他のアイデンティティに代わってGoogle APIにアクセスする方法です：

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **アイデンティティがJWTを作成する：** アイデンティティは、サービスアカウントの秘密鍵（JSONキーペアファイルの一部）を使用してJWTに署名します。このJWTには、サービスアカウント、なりすまし対象のユーザー、および要求されているREST APIへのアクセスのOAuthスコープに関するクレームが含まれています。
2. **アイデンティティがJWTを使用してアクセストークンを要求する：** アプリケーション/ユーザーはJWTを使用して、GoogleのOAuth 2.0サービスからアクセストークンを要求します。この要求には、なりすまし対象のユーザー（ユーザーのWorkspaceメール）、およびアクセスが要求されるスコープも含まれます。
3. **GoogleのOAuth 2.0サービスがアクセストークンを返す：** アクセストークンは、指定されたスコープに対してユーザーに代わって行動するサービスアカウントの権限を表します。このトークンは通常、短命であり、定期的に更新する必要があります（アプリケーションのニーズに応じて）。JWTトークンに指定されたOAuthスコープが有効であり、結果として得られるアクセストークンに影響を与えることを理解することが重要です。たとえば、複数のスコープを持つアクセストークンは、複数のREST APIアプリケーションに対して有効です。
4. **アイデンティティがアクセストークンを使用してGoogle APIを呼び出す：** 関連するアクセストークンを持つサービスは、必要なREST APIにアクセスできます。アプリケーションは、このアクセストークンをHTTPリクエストの「Authorization」ヘッダーに使用して、Google APIに送信します。これらのAPIは、トークンを使用してなりすましアイデンティティを検証し、必要な承認を持っていることを確認します。
5. **Google APIが要求されたデータを返す：** アクセストークンが有効であり、サービスアカウントが適切な承認を持っている場合、Google APIは要求されたデータを返します。たとえば、次の画像では、_users.messages.list_メソッドを使用して、対象のWorkspaceユーザーに関連付けられているすべてのGmailメッセージIDをリストしています。

## 対話型GWSアクセスを使用した新しい委任

最初のシナリオでは、アクターは通常、GCPプロジェクト内で**サービスアカウントを作成する**機能を持つIAMアイデンティティへの初期アクセスを獲得します。さらに、彼は今やGWSの**スーパーアドミン権限**を持っています。

**攻撃手順：**

1. **新しいサービスアカウントと対応するキーペアの生成：** GCPでは、新しいサービスアカウントリソースは、コンソールを介して対話的に、または直接のAPI呼び出しとCLIツールを使用してプログラム的に生成できます。これには、**ロール`iam.serviceAccountAdmin`**または**`iam.serviceAccounts.create`** **権限**を備えたカスタムロールが必要です。サービスアカウントが作成されたら、関連する**キーペア**（**`iam.serviceAccountKeys.create`**権限）の生成に進みます。
2. **新しい委任の作成：** 関連するアイデンティティオブジェクトとGoogle APIで認証を可能にする関連する秘密鍵を持っているため、Google Workspace内でサービスアカウントリソースの新しい委任ルールを**確立する必要があります**。この委任ルールにより、Workspace REST APIアプリケーションでGoogle APIのアクティビティを実行できるようになります。Google Workspaceでグローバルドメイン全体委任を設定できるのは**スーパーアドミンロールのみ**であり、ドメイン全体委任は**プログラム的に設定することはできず**、Google Workspaceの**コンソール**を通じて**手動で**のみ作成および調整できることを理解することが重要です。

ルールの作成は、Google Workspace管理コンソールの**APIコントロール→ドメイン全体委任の管理**ページで見つけることができます。
3. **OAuthスコープ特権の添付：** 新しい委任を設定する際、GoogleはクライアントID（GCPサービスアカウントリソースの**OAuth ID**）と、委任が必要とするAPI呼び出しを定義する**OAuthスコープ**の2つのパラメータのみを要求します。\
**OAuthスコープの完全なリスト**は[**こちら**](https://developers.google.com/identity/protocols/oauth2/scopes)で見つけることができます。
4. **対象アイデンティティの代わりに行動する：** この時点で、私たちはGWSで機能する委任されたオブジェクトを持っています。これで、**GCPサービスアカウントの秘密鍵を使用してAPI呼び出しを実行する**ことができます（OAuthスコープパラメータで定義されたスコープ内で）し、Google Workspace内の任意のアイデンティティに代わって行動することができます。学んだように、サービスアカウントは、REST APIアプリケーションへのアクセス権限に応じて、必要に応じてアクセストークンを生成します。

### 組織間委任

OAuth SA IDはグローバルであり、**組織間委任**に使用できます。クロスグローバル委任を防ぐための制限は実装されていません。簡単に言うと、**異なるGCP組織のサービスアカウントを使用して、他のWorkspace組織でドメイン全体委任を設定することができます**。これにより、同じGCPアカウントへのアクセスではなく、Workspaceへのスーパーアドミンアクセスのみが必要になります。敵対者は、個人的に管理しているGCPアカウントでサービスアカウントと秘密鍵を作成することができます。

## 既存の委任の妥協 - DeleFriend

IAMポリシー内で**既存のドメイン全体委任**を持つ関連するGCPサービスアカウントリソースにアクセスできる場合、新しいキーを作成し、すべての既存のJWTの可能性を列挙し、その既存の委任を使用して、ドメイン内の他のアイデンティティに代わってGoogle WorkspaceへのAPI呼び出しを実行することは何も止めません。

{% hint style="danger" %}
何らかの方法でGCP組織/プロジェクトを妥協した後、攻撃者は**jsonキー**を作成できるGCPサービスアカウントをチェックし、それらを作成し、**SAがWorkspace OAuthスコープの他のアイデンティティに代わってアクセスできるかどうかを確認する**ことができます。
{% endhint %}

これらが正確な手順です：

1. リソースマネージャAPIを使用して**GCPプロジェクトを列挙する**。
2. 各プロジェクトリソースに対して繰り返し、_GetIAMPolicy_を使用して初期IAMユーザーがアクセスできる**GCPサービスアカウントリソースを列挙する**。
3. **各サービスアカウントの役割を繰り返し**、対象のサービスアカウントリソースで_**serviceAccountKeys.create**_権限を持つ組み込み、基本、およびカスタムロールを見つける。エディターロールはこの権限を本来持っていることに注意する必要があります。
4. IAMポリシーで関連する権限が見つかった各サービスアカウントリソースに対して、**新しい\_KEY\_ALG\_RSA\_2048**\_\*\*秘密鍵を作成する\*\*。
5. **各新しいサービスアカウントに対して\_JWT**\_\*\*オブジェクトを作成し\*\*、SAの秘密鍵の資格情報とOAuthスコープを含む。新しい_JWT_オブジェクトの作成プロセスは、**oauth\_scopes.txt**リストから**すべての既存のOAuthスコープの組み合わせを繰り返し**、すべての委任の可能性を見つけるために行われます。リスト**oauth\_scopes.txt**は、Workspaceアイデンティティを悪用するために関連性があると判断されたすべてのOAuthスコープで更新されます。
6. _\_make\_authorization\_grant\_assertion_メソッドは、JWTを生成するために**対象のworkspaceユーザー**を宣言する必要性を明らかにします。これは_subject_として参照されます。これは特定のユーザーが必要であるように見えるかもしれませんが、**DWDはドメイン内のす
