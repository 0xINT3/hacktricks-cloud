# GCP a Workspace Pivoting

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

Este post es un resumen del art√≠culo de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) al que se puede acceder para obtener m√°s detalles.

## **Comprendiendo la Delegaci√≥n a Nivel de Dominio**

La delegaci√≥n a nivel de dominio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci√≥n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio de GCP** interna, **acceda a datos en todo el Workspace en nombre de los usuarios**. Esta caracter√≠stica, que es crucial para las aplicaciones que interact√∫an con las API de Google o los servicios que necesitan la suplantaci√≥n de identidad de usuario, mejora la eficiencia y minimiza los errores humanos al automatizar tareas. Mediante OAuth 2.0, los desarrolladores de aplicaciones y los administradores pueden dar a estas cuentas de servicio acceso a los datos de los usuarios sin el consentimiento individual de cada usuario.\
\
Google Workspace permite la creaci√≥n de dos tipos principales de identidades delegadas globales:

* **Aplicaciones de GWS:** Las aplicaciones del Marketplace de Workspace se pueden configurar como una identidad delegada. Antes de estar disponibles en el marketplace, cada aplicaci√≥n de Workspace pasa por una revisi√≥n de Google para minimizar posibles abusos. Si bien esto no elimina por completo el riesgo de abuso, aumenta significativamente la dificultad para que ocurran incidentes de este tipo.
* **Cuenta de Servicio de GCP:** Obt√©n m√°s informaci√≥n sobre las [**Cuentas de Servicio de GCP aqu√≠**](gcp-basic-information.md#service-accounts).

### **Delegaci√≥n a Nivel de Dominio: Detr√°s de Escena**

As√≠ es como una Cuenta de Servicio de GCP puede acceder a las API de Google en nombre de otras identidades en Google Workspace:

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. &#x20;**La identidad crea un JWT:** La identidad utiliza la clave privada de la cuenta de servicio (parte del archivo de par de claves JSON) para firmar un JWT. Este JWT contiene informaci√≥n sobre la cuenta de servicio, el usuario objetivo a suplantar y los √°mbitos de OAuth de acceso a la API REST que se est√° solicitando.
2. &#x20;**La identidad utiliza el JWT para solicitar un token de acceso:** La aplicaci√≥n/usuario utiliza el JWT para solicitar un token de acceso del servicio OAuth 2.0 de Google. La solicitud tambi√©n incluye el usuario objetivo a suplantar (el correo electr√≥nico del usuario en Workspace) y los √°mbitos para los que se solicita acceso.
3. **El servicio OAuth 2.0 de Google devuelve un token de acceso:** El token de acceso representa la autoridad de la cuenta de servicio para actuar en nombre del usuario en los √°mbitos especificados. Este token suele tener una duraci√≥n limitada y debe actualizarse peri√≥dicamente seg√∫n las necesidades de la aplicaci√≥n. Es importante entender que los √°mbitos de OAuth especificados en el token JWT tienen validez y afectan al token de acceso resultante. Por ejemplo, los tokens de acceso que poseen m√∫ltiples √°mbitos tendr√°n validez para numerosas aplicaciones de API REST.
4. **La identidad utiliza el token de acceso para llamar a las API de Google**: Ahora, con un token de acceso relevante, el servicio puede acceder a la API REST requerida. La aplicaci√≥n utiliza este token de acceso en el encabezado "Authorization" de sus solicitudes HTTP destinadas a las API de Google. Estas API utilizan el token para verificar la identidad suplantada y confirmar que tiene la autorizaci√≥n necesaria.&#x20;
5. **Las API de Google devuelven los datos solicitados**: Si el token de acceso es v√°lido y la cuenta de servicio tiene la autorizaci√≥n adecuada, las API de Google devuelven los datos solicitados. Por ejemplo, en la siguiente imagen, hemos utilizado el m√©todo _users.messages.list_ para listar todos los ID de mensajes de Gmail asociados con un usuario objetivo de Workspace.&#x20;

## Nueva delegaci√≥n con acceso interactivo a GWS

En el primer escenario, un actor generalmente obtiene acceso inicial a una identidad IAM, con la capacidad de **crear cuentas de servicio en un proyecto de GCP**. Adem√°s, ahora tiene un **privilegio de superadministrador en GWS**.

**Pasos del ataque:**

1. **Generaci√≥n de una nueva cuenta de servicio y par de claves correspondiente:** En GCP, se pueden crear nuevos recursos de cuentas de servicio de forma interactiva a trav√©s de la consola o program√°ticamente utilizando llamadas directas a la API y herramientas de l√≠nea de comandos (CLI). Esto requiere el **rol `iam.serviceAccountAdmin`** o cualquier rol personalizado equipado con el **permiso `iam.serviceAccounts.create`**. Una vez creada la cuenta de servicio, procederemos a generar un **par de claves relacionadas** (permiso **`iam.serviceAccountKeys.create`**).
2. **Creaci√≥n de una nueva delegaci√≥n**: Despu√©s de tener un objeto de identidad relevante y una clave privada relacionada que permite la autenticaci√≥n con las API de Google, debemos **establecer una nueva regla de delegaci√≥n para el recurso de la cuenta de servicio dentro de Google Workspace**. Esta regla de delegaci√≥n nos permitir√° realizar la actividad de las API de Google en las aplicaciones de la API REST de Workspace. Es importante entender que **solo el rol de Super Administrador tiene la capacidad de configurar la delegaci√≥n global a nivel de dominio en Google Workspace** y la delegaci√≥n a nivel de dominio **no se puede configurar program√°ticamente**, solo se puede crear y ajustar **manualmente** a trav√©s de la **consola** de Google Workspace.

La creaci√≥n de la regla se puede encontrar en la p√°gina **Controles de API ‚Üí Administrar la delegaci√≥n a nivel de dominio en la consola de administraci√≥n de Google Workspace**.
3. **Asignaci√≥n del privilegio de √°mbitos de OAuth**: Al configurar una nueva delegaci√≥n, Google requiere solo 2 par√°metros, el ID de cliente, que es el **ID de OAuth de la cuenta de servicio de GCP**, y los **√°mbitos de OAuth** que definen las llamadas a la API que requiere la delegaci√≥n.\
La **lista completa de √°mbitos de OAuth** se puede encontrar [**aqu√≠**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Actuar en nombre de la identidad objetivo**: En este punto, tenemos un objeto delegado funcional en GWS. Ahora, **usando la clave privada de la cuenta de servicio de GCP, podemos realizar llamadas a la API** (en el √°mbito definido en el par√°metro de √°mbito de OAuth) para activarlo y **actuar en nombre de cualquier identidad que exista en Google Workspace**. Como aprendimos, la cuenta de servicio generar√° tokens de acceso seg√∫n sus necesidades y de acuerdo con los permisos que tenga para las aplicaciones de API REST.
### Delegaci√≥n interorganizacional

El ID de OAuth SA es global y se puede utilizar para la **delegaci√≥n interorganizacional**. No se ha implementado ninguna restricci√≥n para evitar la delegaci√≥n interglobal. En t√©rminos simples, **las cuentas de servicio de diferentes organizaciones de GCP se pueden utilizar para configurar la delegaci√≥n a nivel de dominio en otras organizaciones de Workspace**. Esto resultar√≠a en que solo se necesite acceso de Super Administrador a Workspace, y no acceso a la misma cuenta de GCP, ya que el adversario puede crear cuentas de servicio y claves privadas en su cuenta de GCP controlada personalmente.

## Compromiso de la delegaci√≥n existente - DeleFriend

En caso de que tengamos acceso a un recurso relevante de cuenta de servicio de GCP con **delegaci√≥n a nivel de dominio existente** dentro de la Pol√≠tica de IAM, nada nos impide crear una nueva clave, enumerar todas las posibilidades existentes de JWT y utilizar esa delegaci√≥n existente para realizar llamadas a la API de Google Workspace en nombre de otras identidades en el dominio.

{% hint style="danger" %}
Despu√©s de comprometer de alguna manera una organizaci√≥n/proyecto de GCP, un atacante podr√≠a verificar a qu√© cuentas de servicio de GCP puede crear **claves json**, crearlas y verificar si la **cuenta de servicio tiene acceso en nombre de otras identidades a algunos √°mbitos de OAuth de Workspace**.
{% endhint %}

Estos son los pasos exactos:

1. Enumerar los **proyectos de GCP** utilizando la API de Resource Manager.
2. Iterar en cada recurso de proyecto y **enumerar los recursos de cuenta de servicio de GCP** a los que el usuario IAM inicial tiene acceso utilizando _GetIAMPolicy_.
3. Iterar en **cada rol de cuenta de servicio** y encontrar roles integrados, b√°sicos y personalizados con el permiso _**serviceAccountKeys.create**_ en el recurso de cuenta de servicio objetivo. Cabe destacar que el rol de Editor posee inherentemente este permiso.
4. Crear una **nueva clave privada** _**KEY\_ALG\_RSA\_2048**_ para cada recurso de cuenta de servicio que se encuentre con el permiso relevante en la pol√≠tica de IAM.
5. Iterar en **cada nueva cuenta de servicio y crear un objeto JWT** para ella que est√© compuesto por las credenciales de clave privada de la cuenta de servicio y un √°mbito de OAuth. El proceso de creaci√≥n de un nuevo objeto _JWT_ iterar√° en todas las combinaciones existentes de √°mbitos de OAuth de la lista **oauth\_scopes.txt**, con el fin de encontrar todas las posibilidades de delegaci√≥n. La lista **oauth\_scopes.txt** se actualiza con todos los √°mbitos de OAuth que hemos encontrado relevantes para abusar de las identidades de Workspace.
6. El m√©todo _\_make\_authorization\_grant\_assertion_ revela la necesidad de declarar un **usuario de Workspace objetivo**, al que se hace referencia como _subject_, para generar JWT bajo DWD. Si bien esto puede parecer que requiere un usuario espec√≠fico, es importante darse cuenta de que **DWD influye en todas las identidades dentro de un dominio**. En consecuencia, crear un JWT para **cualquier usuario de dominio** afecta a todas las identidades en ese dominio, de acuerdo con nuestra verificaci√≥n de enumeraci√≥n de combinaciones. En pocas palabras, un usuario v√°lido de Workspace es suficiente para avanzar.\
Este usuario se puede definir en el archivo _config.yaml_ de DeleFriend. Si a√∫n no se conoce un usuario de Workspace objetivo, la herramienta facilita la identificaci√≥n autom√°tica de usuarios de Workspace v√°lidos mediante el escaneo de usuarios de dominio con roles en proyectos de GCP. Es importante tener en cuenta (nuevamente) que los JWT son espec√≠ficos del dominio y no se generan para cada usuario; por lo tanto, el proceso autom√°tico se dirige a una √∫nica identidad √∫nica por dominio.
7. Enumerar y crear un **nuevo token de acceso de portador** para cada JWT y validar el token frente a la API de tokeninfo.

**Puedes encontrar la herramienta para realizar este ataque autom√°ticamente en:** [**DeleFriend**](https://github.com/axon-git/DeleFriend)

## Referencias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
