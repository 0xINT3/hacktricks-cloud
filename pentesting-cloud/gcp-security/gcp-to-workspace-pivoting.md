# GCP a Workspace Pivoting

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Este post es un resumen del que se encuentra en [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) al cual se puede acceder para m√°s detalles.

## **Entendiendo la Delegaci√≥n a Nivel de Dominio**

La delegaci√≥n a nivel de dominio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci√≥n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio de GCP**, **acceda a datos a trav√©s de Workspace en nombre de los usuarios**. Esta caracter√≠stica, crucial para aplicaciones que interact√∫an con APIs de Google o servicios que necesitan suplantaci√≥n de usuario, mejora la eficiencia y minimiza errores humanos automatizando tareas. Utilizando OAuth 2.0, desarrolladores de aplicaciones y administradores pueden dar a estas cuentas de servicio acceso a datos de usuario sin consentimiento individual.
\
Google Workspace permite la creaci√≥n de dos tipos principales de identidades delegadas globales:

* **Aplicaciones GWS:** Aplicaciones del Marketplace de Workspace pueden configurarse como una identidad delegada. Antes de estar disponibles en el marketplace, cada aplicaci√≥n de Workspace pasa por una revisi√≥n de Google para minimizar el posible mal uso. Aunque esto no elimina completamente el riesgo de abuso, aumenta significativamente la dificultad para que ocurran tales incidentes.
* **Cuenta de Servicio de GCP:** Aprende m√°s sobre [**Cuentas de Servicio de GCP aqu√≠**](gcp-basic-information.md#service-accounts).

### **Delegaci√≥n a Nivel de Dominio: Detr√°s de las Escenas**

As√≠ es como una Cuenta de Servicio de GCP puede acceder a APIs de Google en nombre de otras identidades en Google Workspace:

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. **La Identidad crea un JWT:** La Identidad usa la clave privada de la cuenta de servicio (parte del archivo de par de claves JSON) para firmar un JWT. Este JWT contiene afirmaciones sobre la cuenta de servicio, el usuario objetivo a suplantar y los alcances de OAuth para el acceso a la API REST que se est√° solicitando.
2. **La Identidad usa el JWT para solicitar un token de acceso:** La aplicaci√≥n/usuario usa el JWT para solicitar un token de acceso del servicio OAuth 2.0 de Google. La solicitud tambi√©n incluye el usuario objetivo a suplantar (el correo electr√≥nico de Workspace del usuario) y los alcances para los cuales se solicita acceso.
3. **El servicio OAuth 2.0 de Google devuelve un token de acceso:** El token de acceso representa la autoridad de la cuenta de servicio para actuar en nombre del usuario para los alcances especificados. Este token generalmente tiene una vida corta y debe actualizarse peri√≥dicamente (seg√∫n la necesidad de la aplicaci√≥n). Es esencial entender que los alcances de OAuth especificados en el token JWT tienen validez e impacto en el token de acceso resultante. Por ejemplo, los tokens de acceso que poseen m√∫ltiples alcances tendr√°n validez para numerosas aplicaciones de API REST.
4. **La Identidad usa el token de acceso para llamar a APIs de Google**: Ahora con un token de acceso relevante, el servicio puede acceder a la API REST requerida. La aplicaci√≥n utiliza este token de acceso en el encabezado "Authorization" de sus solicitudes HTTP destinadas a APIs de Google. Estas APIs utilizan el token para verificar la identidad suplantada y confirmar que tiene la autorizaci√≥n necesaria.
5. **Las APIs de Google devuelven los datos solicitados**: Si el token de acceso es v√°lido y la cuenta de servicio tiene la autorizaci√≥n adecuada, las APIs de Google devuelven los datos solicitados. Por ejemplo, en la siguiente imagen, hemos utilizado el m√©todo _users.messages.list_ para listar todos los IDs de mensajes de Gmail asociados con un usuario objetivo de Workspace.

## Nueva delegaci√≥n con acceso interactivo a GWS

En el primer escenario, un actor generalmente obtiene acceso inicial a una identidad de IAM, con la capacidad de **crear cuentas de servicio en un proyecto de GCP.** Adem√°s, ahora posee un **privilegio de super administrador en GWS.**

**Pasos del ataque:**

1. **Generando una Nueva Cuenta de Servicio y Par de Claves Correspondiente:** En GCP, se pueden producir nuevos recursos de cuenta de servicio de manera interactiva a trav√©s de la consola o program√°ticamente utilizando llamadas directas a la API y herramientas de CLI. Esto requiere el **rol `iam.serviceAccountAdmin`** o cualquier rol personalizado equipado con el **permiso `iam.serviceAccounts.create`**. Una vez creada la cuenta de servicio, procederemos a generar un **par de claves relacionado** (**permiso `iam.serviceAccountKeys.create`**).
2. **Creaci√≥n de nueva delegaci√≥n**: Despu√©s de tener un objeto de identidad relevante y una clave privada relacionada que permite la autenticaci√≥n con APIs de Google, necesitamos **establecer una nueva regla de delegaci√≥n para el recurso de cuenta de servicio dentro de Google Workspace**. Esta regla de delegaci√≥n nos permitir√° realizar la actividad de APIs de Google en aplicaciones de API REST de Workspace. Es importante entender que **solo el rol de Super Administrador posee la capacidad de configurar la delegaci√≥n global a Nivel de Dominio en Google Workspace** y la delegaci√≥n a Nivel de Dominio **no se puede configurar program√°ticamente,** solo se puede crear y ajustar **manualmente** a trav√©s de la consola de **Google Workspace**.

La creaci√≥n de la regla se puede encontrar en la p√°gina **Controles de API ‚Üí Administrar la Delegaci√≥n a Nivel de Dominio en la consola de administraci√≥n de Google Workspace**.
3. **Adjuntando privilegio de alcances OAuth**: Al configurar una nueva delegaci√≥n, Google solo requiere 2 par√°metros, el ID de Cliente, que es el **ID de OAuth de la Cuenta de Servicio de GCP** y los **alcances de OAuth** que definen qu√© llamadas a la API requiere la delegaci√≥n.\
La **lista completa de alcances de OAuth** se puede encontrar [**aqu√≠**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Actuando en nombre de la identidad objetivo:** En este punto, tenemos un objeto delegado funcional en GWS. Ahora, **usando la clave privada de la Cuenta de Servicio de GCP, podemos realizar llamadas a la API** (en el alcance definido en el par√°metro de alcance de OAuth) para activarlo y **actuar en nombre de cualquier identidad que exista en Google Workspace**. Como aprendimos, la cuenta de servicio generar√° tokens de acceso seg√∫n sus necesidades y de acuerdo con el permiso que tiene para aplicaciones de API REST.
### Delegaci√≥n entre organizaciones

El ID de SA OAuth es global y puede ser utilizado para **delegaci√≥n entre organizaciones**. No se ha implementado ninguna restricci√≥n para prevenir la delegaci√≥n global cruzada. En t√©rminos simples, **cuentas de servicio de diferentes organizaciones de GCP pueden ser utilizadas para configurar delegaci√≥n a nivel de dominio en otras organizaciones de Workspace**. Esto resultar√≠a en **solo necesitar acceso de Super Admin a Workspace**, y no acceso a la misma cuenta de GCP, ya que el adversario puede crear Cuentas de Servicio y claves privadas en su cuenta de GCP controlada personalmente.

## Comprometer delegaci√≥n existente - DeleFriend

En caso de que tengamos acceso a un recurso de cuenta de servicio de GCP relevante con **delegaci√≥n a nivel de dominio existente** dentro de la Pol√≠tica IAM, nada nos impide crear una nueva clave, enumerar todas las posibilidades de JWT existentes y usar esa delegaci√≥n existente para realizar llamadas API a Google Workspace en nombre de otras identidades en el dominio.

{% hint style="danger" %}
Despu√©s de comprometer de alguna manera una organizaci√≥n/proyecto de GCP, un atacante podr√≠a verificar a qu√© Cuentas de Servicio de GCP puede crear **claves json**, crearlas y verificar si la **SA tiene acceso en nombre de otras identidades a algunos √°mbitos OAuth de Workspace**.
{% endhint %}

Estos son los pasos exactos:

1. **Enumerar Proyectos de GCP** usando la API de Resource Manager.
2. Iterar en cada recurso de proyecto y **enumerar recursos de cuenta de servicio de GCP** a los que el usuario IAM inicial tiene acceso usando _GetIAMPolicy_.
3. Iterar en **cada rol de cuenta de servicio**, y encontrar roles integrados, b√°sicos y personalizados con permiso _**serviceAccountKeys.create**_ en el recurso de cuenta de servicio objetivo. Se debe notar que el rol de Editor posee inherentemente este permiso.
4. Crear una **nueva clave privada **_**KEY\_ALG\_RSA\_2048**_** para cada recurso de cuenta de servicio** que se encuentre con permiso relevante en la pol√≠tica IAM.
5. Iterar en **cada nueva cuenta de servicio y crear un objeto **_**JWT**_** para ella** que est√© compuesto por las credenciales de clave privada de la SA y un √°mbito OAuth. El proceso de crear un nuevo objeto _JWT_ **iterar√° en todas las combinaciones existentes de √°mbitos OAuth** de la lista **oauth\_scopes.txt**, para encontrar todas las posibilidades de delegaci√≥n. La lista **oauth\_scopes.txt** se actualiza con todos los √°mbitos OAuth que hemos encontrado relevantes para abusar de las identidades de Workspace.
6. El m√©todo _\_make\_authorization\_grant\_assertion_ revela la necesidad de declarar un **usuario de workspace objetivo**, referido como _subject_, para generar JWTs bajo DWD. Aunque esto puede parecer que requiere un usuario espec√≠fico, es importante darse cuenta de que **DWD influye en cada identidad dentro de un dominio**. Consecuentemente, crear un JWT para **cualquier usuario del dominio** afecta a todas las identidades en ese dominio, consistente con nuestra verificaci√≥n de enumeraci√≥n de combinaciones. En pocas palabras, un usuario v√°lido de Workspace es suficiente para avanzar.\
Este usuario puede ser definido en el archivo _config.yaml_ de DeleFriend. Si un usuario de workspace objetivo no es ya conocido, la herramienta facilita la identificaci√≥n autom√°tica de usuarios v√°lidos de workspace escaneando usuarios de dominio con roles en proyectos de GCP. Es clave notar (de nuevo) que los JWTs son espec√≠ficos del dominio y no se generan para cada usuario; por lo tanto, el proceso autom√°tico se dirige a una identidad √∫nica por dominio.
7. **Enumerar y crear un nuevo token de acceso bearer** para cada JWT y validar el token contra la API de tokeninfo.

**Puedes encontrar la herramienta para realizar este ataque autom√°ticamente en:** [**DeleFriend**](https://github.com/axon-git/DeleFriend)

## Referencias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
