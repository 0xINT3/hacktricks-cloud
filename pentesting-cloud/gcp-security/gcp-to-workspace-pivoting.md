# GCP para Pivoting do Workspace

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

Este post √© um resumo do post de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) que pode ser acessado para mais detalhes.

## **Compreendendo a Delega√ß√£o em Todo o Dom√≠nio**

A delega√ß√£o em todo o dom√≠nio do Google Workspace permite que um objeto de identidade, seja um **aplicativo externo** do Google Workspace Marketplace ou uma **Conta de Servi√ßo GCP** interna, acesse dados em todo o Workspace em nome dos usu√°rios. Essa funcionalidade, que √© crucial para aplicativos que interagem com APIs do Google ou servi√ßos que precisam de impersona√ß√£o de usu√°rio, melhora a efici√™ncia e minimiza erros humanos automatizando tarefas. Usando o OAuth 2.0, desenvolvedores de aplicativos e administradores podem dar a essas contas de servi√ßo acesso aos dados do usu√°rio sem o consentimento individual do usu√°rio.\
\
O Google Workspace permite a cria√ß√£o de dois principais tipos de identidades de objeto delegadas globais:

* **Aplicativos GWS:** Aplicativos do Workspace Marketplace podem ser configurados como uma identidade delegada. Antes de serem disponibilizados no marketplace, cada aplicativo do Workspace passa por uma revis√£o do Google para minimizar poss√≠veis abusos. Embora isso n√£o elimine completamente o risco de abuso, aumenta significativamente a dificuldade para que tais incidentes ocorram.
* **Conta de Servi√ßo GCP:** Saiba mais sobre [**Contas de Servi√ßo GCP aqui**](gcp-basic-information.md#service-accounts).

### **Delega√ß√£o em Todo o Dom√≠nio: Por Dentro**

Assim √© como uma Conta de Servi√ßo GCP pode acessar APIs do Google em nome de outras identidades no Google Workspace:

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. &#x20;**A identidade cria um JWT:** A identidade usa a chave privada da conta de servi√ßo (parte do arquivo de par de chaves JSON) para assinar um JWT. Este JWT cont√©m informa√ß√µes sobre a conta de servi√ßo, o usu√°rio alvo para se passar e os escopos OAuth de acesso √† API REST que est√° sendo solicitada.
2. &#x20;**A identidade usa o JWT para solicitar um token de acesso:** O aplicativo/usu√°rio usa o JWT para solicitar um token de acesso do servi√ßo OAuth 2.0 do Google. A solicita√ß√£o tamb√©m inclui o usu√°rio alvo para se passar (o e-mail do Workspace do usu√°rio) e os escopos para os quais o acesso √© solicitado.
3. **O servi√ßo OAuth 2.0 do Google retorna um token de acesso:** O token de acesso representa a autoridade da conta de servi√ßo para agir em nome do usu√°rio nos escopos especificados. Esse token geralmente tem curta dura√ß√£o e deve ser atualizado periodicamente (conforme a necessidade do aplicativo). √â essencial entender que os escopos OAuth especificados no token JWT t√™m validade e impacto no token de acesso resultante. Por exemplo, tokens de acesso com v√°rios escopos ter√£o validade para v√°rias aplica√ß√µes de API REST.
4. **A identidade usa o token de acesso para chamar APIs do Google**: Agora, com um token de acesso relevante, o servi√ßo pode acessar a API REST necess√°ria. O aplicativo usa esse token de acesso no cabe√ßalho "Authorization" de suas solicita√ß√µes HTTP destinadas √†s APIs do Google. Essas APIs utilizam o token para verificar a identidade que est√° sendo passada e confirmar se ela tem a autoriza√ß√£o necess√°ria.&#x20;
5. **As APIs do Google retornam os dados solicitados**: Se o token de acesso for v√°lido e a conta de servi√ßo tiver a autoriza√ß√£o apropriada, as APIs do Google retornar√£o os dados solicitados. Por exemplo, na imagem a seguir, aproveitamos o m√©todo _users.messages.list_ para listar todos os IDs de mensagens do Gmail associados a um usu√°rio alvo do Workspace.&#x20;

## Nova delega√ß√£o com acesso interativo do GWS

No primeiro cen√°rio, um ator geralmente obt√©m acesso inicial a uma identidade IAM, com a capacidade de **criar contas de servi√ßo em um projeto GCP**. Al√©m disso, ele agora possui um **privil√©gio de super administrador para o GWS**.

**Passos do ataque:**

1. **Gerando uma Nova Conta de Servi√ßo e Par de Chaves Correspondente:** No GCP, novos recursos de conta de servi√ßo podem ser produzidos de forma interativa via console ou programaticamente usando chamadas de API diretas e ferramentas de linha de comando (CLI). Isso requer a **fun√ß√£o `iam.serviceAccountAdmin`** ou qualquer fun√ß√£o personalizada equipada com a **permiss√£o `iam.serviceAccounts.create`**. Uma vez que a conta de servi√ßo √© criada, procederemos para gerar um **par de chaves relacionado** (permiss√£o **`iam.serviceAccountKeys.create`**).
2.  **Cria√ß√£o de nova delega√ß√£o**: Depois de ter um objeto de identidade relevante e uma chave privada relacionada que permite a autentica√ß√£o com APIs do Google, precisamos **estabelecer uma nova regra de delega√ß√£o para o recurso da conta de servi√ßo dentro do Google Workspace**. Essa regra de delega√ß√£o nos permitir√° realizar a atividade das APIs do Google em aplicativos da API REST do Workspace. √â importante entender que **apenas a fun√ß√£o de Super Administrador possui a capacidade de configurar a delega√ß√£o em todo o dom√≠nio global no Google Workspace** e a delega√ß√£o em todo o dom√≠nio **n√£o pode ser configurada programaticamente**, ela s√≥ pode ser criada e ajustada **manualmente** atrav√©s do **console** do Google Workspace.

A cria√ß√£o da regra pode ser encontrada na p√°gina **Controles da API ‚Üí Gerenciar a delega√ß√£o em todo o dom√≠nio no console de administra√ß√£o do Google Workspace**.
3. **Anexando o privil√©gio de escopos OAuth**: Ao configurar uma nova delega√ß√£o, o Google requer apenas 2 par√¢metros, o ID do Cliente, que √© o **ID OAuth da Conta de Servi√ßo GCP**, e os **escopos OAuth** que definem quais chamadas de API a delega√ß√£o requer.\
A **lista completa de escopos OAuth** pode ser encontrada [**aqui**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Atuando em nome da identidade alvo:** Neste ponto, temos um objeto delegado funcional no GWS. Agora, **usando a chave privada da Conta de Servi√ßo GCP, podemos fazer chamadas de API** (no escopo definido no par√¢metro de escopo OAuth) para ativ√°-la e **atuar em nome de qualquer identidade que exista no Google Workspace**. Como aprendemos, a conta de servi√ßo gerar√° tokens de acesso de acordo com suas necessidades e de acordo com a permiss√£o que ela tem para aplicativos de API REST.
### Delega√ß√£o entre organiza√ß√µes

O ID do OAuth SA √© global e pode ser usado para **delega√ß√£o entre organiza√ß√µes**. N√£o h√° restri√ß√£o implementada para impedir a delega√ß√£o global. Em termos simples, **contas de servi√ßo de diferentes organiza√ß√µes do GCP podem ser usadas para configurar a delega√ß√£o em toda a organiza√ß√£o em outras organiza√ß√µes do Workspace**. Isso resultaria em **apenas precisar de acesso de Super Admin ao Workspace**, e n√£o acesso √† mesma conta do GCP, pois o advers√°rio pode criar Contas de Servi√ßo e chaves privadas em sua conta do GCP controlada pessoalmente.

## Comprometer a delega√ß√£o existente - DeleFriend

Caso tenhamos acesso a um recurso relevante da conta de servi√ßo do GCP com **delega√ß√£o em toda a organiza√ß√£o existente** na Pol√≠tica do IAM, nada nos impede de criar uma nova chave, enumerar todas as possibilidades existentes de JWT e usar essa delega√ß√£o existente para realizar chamadas de API para o Google Workspace em nome de outras identidades no dom√≠nio.

{% hint style="danger" %}
Ap√≥s comprometer de alguma forma uma organiza√ß√£o/projeto do GCP, um invasor poderia verificar para quais Contas de Servi√ßo do GCP ele pode criar **chaves json**, cri√°-las e verificar se a **CS tem acesso em nome de outras identidades a alguns escopos OAuth do Workspace**.
{% endhint %}

Estes s√£o os passos exatos:

1. **Enumerar os projetos do GCP** usando a API do Resource Manager.
2. Iterar em cada recurso do projeto e **enumerar os recursos da conta de servi√ßo do GCP** aos quais o usu√°rio IAM inicial tem acesso usando _GetIAMPolicy_.
3. Iterar em **cada fun√ß√£o da conta de servi√ßo** e encontrar fun√ß√µes internas, b√°sicas e personalizadas com permiss√£o _**serviceAccountKeys.create**_ no recurso da conta de servi√ßo de destino. Deve-se observar que a fun√ß√£o Editor possui essa permiss√£o inerentemente.
4. Criar uma **nova chave privada do tipo** _**KEY\_ALG\_RSA\_2048**_** para cada recurso da conta de servi√ßo** encontrado com permiss√£o relevante na pol√≠tica do IAM.
5. Iterar em **cada nova conta de servi√ßo e criar um objeto** _**JWT**_** para ela**, que √© composto pelas credenciais da chave privada da CS e um escopo OAuth. O processo de cria√ß√£o de um novo objeto _JWT_ ir√° **iterar em todas as combina√ß√µes existentes de escopos OAuth** da lista **oauth\_scopes.txt**, a fim de encontrar todas as possibilidades de delega√ß√£o. A lista **oauth\_scopes.txt** √© atualizada com todos os escopos OAuth que encontramos relevantes para abusar das identidades do Workspace.
6. O m√©todo _\_make\_authorization\_grant\_assertion_ revela a necessidade de declarar um **usu√°rio de destino do Workspace**, referido como _subject_, para gerar JWTs sob DWD. Embora isso possa parecer exigir um usu√°rio espec√≠fico, √© importante perceber que **DWD influencia todas as identidades dentro de um dom√≠nio**. Consequentemente, criar um JWT para **qualquer usu√°rio do dom√≠nio** afeta todas as identidades desse dom√≠nio, de acordo com nossa verifica√ß√£o de enumera√ß√£o de combina√ß√µes. Simplificando, um √∫nico usu√°rio v√°lido do Workspace √© adequado para avan√ßar.\
Esse usu√°rio pode ser definido no arquivo _config.yaml_ do DeleFriend. Se um usu√°rio de destino do Workspace ainda n√£o for conhecido, a ferramenta facilita a identifica√ß√£o autom√°tica de usu√°rios v√°lidos do Workspace escaneando os usu√°rios do dom√≠nio com fun√ß√µes em projetos do GCP. √â importante observar (novamente) que os JWTs s√£o espec√≠ficos do dom√≠nio e n√£o s√£o gerados para cada usu√°rio; portanto, o processo autom√°tico visa uma √∫nica identidade exclusiva por dom√≠nio.
7. **Enumerar e criar um novo token de acesso de portador** para cada JWT e validar o token em rela√ß√£o √† API tokeninfo.

**Voc√™ pode encontrar a ferramenta para realizar esse ataque automaticamente em:** [**DeleFriend**](https://github.com/axon-git/DeleFriend)

## Refer√™ncias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
