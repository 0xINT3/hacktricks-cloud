# GCP到Workspace的转向

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks的衣物**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向**[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

本文是根据[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)的总结，可以访问该链接获取更多详细信息。

## **理解域范围委派**

Google Workspace的域范围委派允许一个身份对象，可以是来自Google Workspace Marketplace的**外部应用**或内部的**GCP服务帐号**，代表用户访问Workspace上的数据。这个功能对于与Google API交互的应用程序或需要用户模拟的服务非常重要，通过自动化任务提高效率并减少人为错误。使用OAuth 2.0，应用程序开发人员和管理员可以为这些服务帐号提供对用户数据的访问权限，而无需个别用户的同意。\
\
Google Workspace允许创建两种主要类型的全局委派对象身份：

* **GWS应用程序：** Workspace Marketplace中的应用程序可以设置为委派身份。在上市之前，每个Workspace应用程序都经过Google的审核，以最大程度地减少潜在的滥用。虽然这并不能完全消除滥用的风险，但它显著增加了发生此类事件的难度。
* **GCP服务帐号：** 在[**这里**](gcp-basic-information.md#service-accounts)了解更多关于GCP服务帐号的信息。

### **域范围委派：内部原理**

这是GCP服务帐号如何代表Google Workspace中的其他身份访问Google API的方式：

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. **身份创建JWT：** 身份使用服务帐号的私钥（JSON密钥对文件的一部分）对JWT进行签名。此JWT包含有关服务帐号、要模拟的目标用户以及正在请求的REST API的OAuth访问范围的声明。
2. **身份使用JWT请求访问令牌：** 应用程序/用户使用JWT向Google的OAuth 2.0服务请求访问令牌。请求还包括要模拟的目标用户（用户的Workspace电子邮件）和请求访问权限的范围。
3. **Google的OAuth 2.0服务返回访问令牌：** 访问令牌表示服务帐号代表用户在指定范围内执行操作的权限。该令牌通常具有短暂的生命周期，并且必须定期刷新（根据应用程序的需要）。重要的是要理解JWT令牌中指定的OAuth访问范围的有效性和影响对应的访问令牌。例如，具有多个范围的访问令牌将对多个REST API应用程序具有有效性。
4. **身份使用访问令牌调用Google API：** 现在具有相关访问令牌，服务可以访问所需的REST API。应用程序在其发送到Google API的HTTP请求的“Authorization”标头中使用此访问令牌。这些API使用令牌验证模拟的身份并确认其具有必要的授权。
5. **Google API返回请求的数据：** 如果访问令牌有效且服务帐号具有适当的授权，则Google API将返回请求的数据。例如，在下图中，我们利用了_users.messages.list_方法来列出与目标Workspace用户关联的所有Gmail消息ID。

## 使用交互式GWS访问的新委派

在第一种情况下，攻击者通常获得对IAM身份的初始访问权限，可以在GCP项目中**创建服务帐号**。此外，他现在拥有对GWS的**超级管理员特权**。

**攻击步骤：**

1. **生成新的服务帐号和相应的密钥对：** 在GCP上，可以通过控制台交互方式或使用直接API调用和CLI工具编程方式生成新的服务帐号资源。这需要**角色`iam.serviceAccountAdmin`**或任何具有**`iam.serviceAccounts.create`**权限的自定义角色。创建服务帐号后，我们将继续生成相关的密钥对（**`iam.serviceAccountKeys.create`**权限）。
2. **创建新的委派：** 在拥有相关身份对象和用于与Google API进行身份验证的相关私钥后，我们需要在Google Workspace中为服务帐号资源**建立新的委派规则**。这个委派规则将使我们能够在Workspace REST API应用程序上执行Google API活动。重要的是要理解，**只有超级管理员角色具有在Google Workspace中设置全局域范围委派的能力**，而域范围委派**无法通过编程方式设置**，只能通过Google Workspace**控制台**进行**手动**创建和调整。

可以在Google Workspace管理控制台的**API控制 → 在Google Workspace管理控制台中管理域范围委派**页面找到创建规则的位置。
3. **附加OAuth访问权限范围：** 在配置新的委派时，Google只需要2个参数，即客户端ID（即GCP服务帐号资源的OAuth ID）和定义委派所需的OAuth访问权限范围。\
完整的OAuth访问权限范围列表可以在[**这里**](https://developers.google.com/identity/protocols/oauth2/scopes)找到。
4. **代表目标身份行事：** 此时，我们在GWS中有一个正常工作的委派对象。现在，**使用GCP服务帐号的私钥，我们可以执行API调用**（在OAuth访问权限范围参数中定义的范围内）来触发它，并**代表Google Workspace中存在的任何身份行事**。正如我们所了解的，服务帐号将根据其需要生成访问令牌，并根据其对REST API应用程序的权限进行操作。
### 跨组织委派

OAuth SA ID 是全局的，可以用于**跨组织委派**。目前还没有实施限制来防止跨全局委派。简单来说，**来自不同 GCP 组织的服务帐号可以用于配置其他 Workspace 组织的域范围委派**。这将导致**只需要超级管理员访问 Workspace**，而不需要访问相同的 GCP 帐户，因为攻击者可以在他个人控制的 GCP 帐户上创建服务帐号和私钥。

## 损害现有委派 - DeleFriend

如果我们可以访问具有**现有域范围委派**的相关 GCP 服务帐号资源，并且在 IAM 策略中，那么我们可以创建一个新的密钥，枚举所有现有的 JWT 可能性，并使用该现有委派代表域中的其他身份执行对 Google Workspace 的 API 调用。

{% hint style="danger" %}
在某种方式下入侵了 GCP 组织/项目后，攻击者可以检查他可以创建哪些**json 密钥的 GCP 服务帐号**，创建它们，并检查 SA 是否可以代表其他身份访问某些 Workspace OAuth 范围。
{% endhint %}

以下是具体步骤：

1. 使用资源管理器 API **枚举 GCP 项目**。
2. 遍历每个项目资源，并使用 _GetIAMPolicy_ **枚举初始 IAM 用户可以访问的 GCP 服务帐号资源**。
3. 遍历**每个服务帐号角色**，并查找具有目标服务帐号资源上 _**serviceAccountKeys.create**_ 权限的内置、基本和自定义角色。需要注意的是，编辑器角色本身具有此权限。
4. 为在 IAM 策略中找到具有相关权限的**每个服务帐号资源创建一个新的**_**KEY\_ALG\_RSA\_2048**_**私钥**。
5. 遍历**每个新的服务帐号并为其创建一个**_**JWT**_**对象**，该对象由 SA 私钥凭据和 OAuth 范围组成。创建新的 _JWT_ 对象的过程将**枚举 oauth\_scopes.txt 列表中的所有现有 OAuth 范围的组合**，以找到所有的委派可能性。列表 **oauth\_scopes.txt** 包含了我们发现与滥用 Workspace 身份相关的所有 OAuth 范围。
6. _\_make\_authorization\_grant\_assertion_ 方法显示了声明一个**目标 Workspace 用户**（称为 _subject_）以在 DWD 下生成 JWT 的必要性。虽然这可能需要一个特定的用户，但重要的是要意识到**DWD 影响域内的每个身份**。因此，为**任何域用户**创建 JWT 将影响该域中的所有身份，与我们的组合枚举检查一致。简而言之，一个有效的 Workspace 用户就足够继续进行操作。\
可以在 DeleFriend 的 _config.yaml_ 文件中定义此用户。如果目标 Workspace 用户尚未知晓，该工具可以通过扫描在 GCP 项目上具有角色的域用户来自动识别有效的 Workspace 用户。需要注意的是（再次强调），JWT 是特定于域的，而不是为每个用户生成；因此，自动过程针对每个域目标一个唯一的身份。
7. 遍历并为每个 JWT 创建一个新的承载访问令牌，并使用 tokeninfo API 验证令牌。

**您可以在以下位置找到执行此攻击的工具：**[**DeleFriend**](https://github.com/axon-git/DeleFriend)

## 参考资料

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您希望在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS 的最新版本或下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上关注我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
