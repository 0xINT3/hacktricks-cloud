# GCPからWorkspaceへのピボット

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

この投稿は、より詳細な情報については[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)でアクセスできるものの要約です。

## **ドメイン全体委任の理解**

Google Workspaceのドメイン全体委任は、Google Workspace Marketplaceの**外部アプリ**または内部の**GCPサービスアカウント**などのアイデンティティオブジェクトが、ユーザーに代わってWorkspace全体のデータに**アクセスする**ことを可能にします。この機能は、Google APIやユーザーのなりすましを必要とするサービスと対話するアプリにとって重要であり、タスクを自動化することで効率を向上させ、人為的なエラーを最小限に抑えます。OAuth 2.0を使用して、アプリ開発者と管理者は、個々のユーザーの同意なしにこれらのサービスアカウントにユーザーデータへのアクセスを許可することができます。\
\
Google Workspaceでは、2種類のグローバル委任オブジェクトアイデンティティを作成できます：

* **GWSアプリケーション：** Workspace Marketplaceのアプリケーションは、委任アイデンティティとして設定できます。マーケットプレイスで利用可能になる前に、各WorkspaceアプリケーションはGoogleによるレビューを受け、潜在的な悪用を最小限に抑えます。これにより、悪用のリスクは完全には排除されませんが、そのような事件が発生する難易度は大幅に高まります。
* **GCPサービスアカウント：** [**GCPサービスアカウントについてはこちら**](gcp-basic-information.md#service-accounts)をご覧ください。

### **ドメイン全体委任の内部**

これは、GCPサービスアカウントがGoogle Workspace内の他のアイデンティティに代わってGoogle APIにアクセスする方法です：

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. **アイデンティティがJWTを作成します：** アイデンティティは、サービスアカウントの秘密鍵（JSONキーペアファイルの一部）を使用してJWTを署名します。このJWTには、サービスアカウント、なりすまし対象のユーザー、および要求されているREST APIへのアクセススコープに関するクレームが含まれています。
2. **アイデンティティがJWTを使用してアクセストークンを要求します：** アプリケーション/ユーザーはJWTを使用して、GoogleのOAuth 2.0サービスからアクセストークンを要求します。要求には、なりすまし対象のユーザー（ユーザーのWorkspaceメール）と、アクセスが要求されるスコープも含まれます。
3. **GoogleのOAuth 2.0サービスがアクセストークンを返します：** アクセストークンは、指定されたスコープに対してユーザーに代わって行動するサービスアカウントの権限を表します。このトークンは通常、短命であり、定期的に更新する必要があります（アプリケーションのニーズに応じて）。JWTトークンに指定されたOAuthスコープが有効であり、結果として得られるアクセストークンに影響を与えることを理解することが重要です。たとえば、複数のスコープを持つアクセストークンは、複数のREST APIアプリケーションに対して有効です。
4. **アイデンティティがアクセストークンを使用してGoogle APIを呼び出します：** 関連するアクセストークンを持つサービスは、必要なREST APIにアクセスできます。アプリケーションは、Google API宛てのHTTPリクエストの「Authorization」ヘッダーにこのアクセストークンを使用します。これらのAPIは、トークンを使用してなりすましアイデンティティを検証し、必要な承認を持っていることを確認します。
5. **Google APIが要求されたデータを返します：** アクセストークンが有効であり、サービスアカウントが適切な承認を持っている場合、Google APIは要求されたデータを返します。たとえば、以下の画像では、_users.messages.list_ メソッドを利用して、対象のWorkspaceユーザーに関連するすべてのGmailメッセージIDをリストしています。

## 新しい委任と対話型GWSアクセス

最初のシナリオでは、アクターは通常、**GCPプロジェクト内でサービスアカウントを作成する能力を持つIAMアイデンティティへの初期アクセスを獲得します。** さらに、彼は現在**GWSのスーパーアドミン権限を持っています。**

**攻撃ステップ：**

1. **新しいサービスアカウントと対応するキーペアの生成：** GCPでは、新しいサービスアカウントリソースは、コンソールを介して対話的に、または直接API呼び出しやCLIツールを使用してプログラム的に生成できます。これには、**ロール`iam.serviceAccountAdmin`**または**`iam.serviceAccounts.create`** **権限**を備えたカスタムロールが必要です。サービスアカウントが作成されたら、関連する**キーペア**（**`iam.serviceAccountKeys.create`**権限）の生成に進みます。
2. **新しい委任の作成：** 関連するアイデンティティオブジェクトとGoogle APIで認証を可能にする関連する秘密鍵を持っているため、Google Workspace内のサービスアカウントリソースに対する新しい委任ルールを**確立する必要があります**。この委任ルールにより、Workspace REST APIアプリケーションでGoogle APIのアクティビティを実行できるようになります。Google Workspaceでグローバルドメイン全体委任を設定できるのは**スーパーアドミンロールのみ**であり、ドメイン全体委任は**プログラム的に設定することはできず**、Google Workspaceの**コンソール**を通じてのみ**手動で**作成および調整できることを理解することが重要です。

ルールの作成は、Google Workspace管理コンソールの**APIコントロール → ドメイン全体委任の管理**ページで見つけることができます。
3. **OAuthスコープ権限の添付：** 新しい委任を設定する際、GoogleはクライアントID（GCPサービスアカウントリソースのOAuth ID）と、委任が必要とするAPI呼び出しを定義する**OAuthスコープ**の2つのパラメータのみを要求します。\
**OAuthスコープの完全なリスト**は[**こちら**](https://developers.google.com/identity/protocols/oauth2/scopes)で見つけることができます。
4. **対象アイデンティティに代わって行動する：** この時点で、GWSに機能する委任オブジェクトがあります。今、**GCPサービスアカウントの秘密鍵を使用してAPI呼び出しを実行することができます**（OAuthスコープパラメータで定義された範囲内で）し、Google Workspace内に存在する任意のアイデンティティに代わって**行動することができます**。学んだように、サービスアカウントは、REST APIアプリケーションへのアクセス権限に応じて、必要に応じてアクセストークンを生成します。
### クロス組織委任

OAuth SA IDはグローバルであり、**クロス組織委任**に使用できます。クロスグローバル委任を防ぐための制限は実装されていません。簡単に言うと、**異なるGCP組織のサービスアカウントを使用して、他のWorkspace組織でドメイン全体の委任を設定することができます**。これにより、同じGCPアカウントへのアクセスではなく、**Workspaceへのスーパー管理者アクセスのみが必要**になります。なぜなら、敵対者は個人的に管理しているGCPアカウント上でサービスアカウントと秘密鍵を作成できるからです。

## 既存の委任の妥協 - DeleFriend

IAMポリシー内で**既存のドメイン全体の委任**を持つ関連するGCPサービスアカウントリソースへのアクセスがある場合、新しい鍵を作成し、すべての既存のJWTの可能性を列挙し、その既存の委任を使用して、ドメイン内の他のアイデンティティに代わってGoogle WorkspaceへのAPI呼び出しを実行することを妨げるものはありません。

{% hint style="danger" %}
GCP組織/プロジェクトを何らかの方法で妥協した後、攻撃者は**json鍵**を作成できるGCPサービスアカウントをチェックし、それらを作成し、**SAが他のアイデンティティに代わってWorkspaceのOAuthスコープにアクセスできるかどうか**を確認できます。
{% endhint %}

これが正確な手順です：

1. Resource Manager APIを使用して**GCPプロジェクトを列挙**します。
2. 各プロジェクトリソースを反復し、_GetIAMPolicy_を使用して初期IAMユーザーがアクセスできる**GCPサービスアカウントリソースを列挙**します。
3. **各サービスアカウントの役割を反復し**、対象のサービスアカウントリソースに_**serviceAccountKeys.create**_権限を持つ組み込み、基本、カスタムの役割を見つけます。エディターの役割がこの権限を本質的に持っていることに注意する必要があります。
4. IAMポリシーで関連する権限が見つかった各サービスアカウントリソースに対して、**新しい**_**KEY\_ALG\_RSA\_2048**_**秘密鍵を作成**します。
5. **各新しいサービスアカウントを反復し、**_**JWT**_**オブジェクトを作成**します。これはSAの秘密鍵の資格情報とOAuthスコープで構成されています。新しい_JWT_オブジェクトを作成するプロセスは、**oauth\_scopes.txt**リストから**すべての既存のOAuthスコープの組み合わせを反復し**、すべての委任の可能性を見つけます。リスト**oauth\_scopes.txt**は、Workspaceのアイデンティティを悪用するために関連性があると判断されたすべてのOAuthスコープで更新されます。
6. _\_make\_authorization\_grant\_assertion_メソッドは、JWTをDWDの下で生成するために**ターゲットworkspaceユーザー**を宣言する必要性を明らかにします。これは特定のユーザーが必要であるように思えるかもしれませんが、**DWDはドメイン内のすべてのアイデンティティに影響を与える**ことを理解することが重要です。結果として、**任意のドメインユーザー**に対してJWTを作成することは、そのドメイン内のすべてのアイデンティティに影響を与えます。これは、組み合わせ列挙チェックと一致しています。簡単に言うと、有効なWorkspaceユーザーが1人いれば前進するのに十分です。\
このユーザーはDeleFriendの_config.yaml_ファイルで定義できます。ターゲットworkspaceユーザーが既に知られていない場合、ツールはGCPプロジェクトの役割を持つドメインユーザーをスキャンすることで有効なworkspaceユーザーを自動的に特定する機能を提供します。再度重要なことですが、JWTはドメイン固有であり、すべてのユーザーに対して生成されるわけではありません。したがって、自動プロセスはドメインごとに単一のユニークなアイデンティティを対象とします。
7. **各JWTに対して新しいbearerアクセストークンを列挙および作成し**、tokeninfo APIに対してトークンを検証します。

**この攻撃を自動的に実行するツールはこちらで見つけることができます：** [**DeleFriend**](https://github.com/axon-git/DeleFriend)

## 参考文献

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加するか**、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* **HackTricks**の[**githubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
