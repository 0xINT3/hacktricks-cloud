# GCP 到 Workspace 的转换

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直到成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

本文是对 [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) 文章的总结，您可以访问该链接以获取更多详情。

## **理解域范围委派**

Google Workspace 的域范围委派允许一个身份对象，无论是来自 Google Workspace 市场的**外部应用**还是内部的**GCP 服务账户**，代表用户**访问 Workspace 中的数据**。这个功能对于与 Google API 交互的应用程序或需要用户模拟的服务来说至关重要，它通过自动化任务提高了效率并减少了人为错误。使用 OAuth 2.0，应用开发者和管理员可以授权这些服务账户访问用户数据，而无需单独的用户同意。\
\
Google Workspace 允许创建两种主要类型的全局委派身份对象：

* **GWS 应用程序：** 来自 Workspace 市场的应用程序可以设置为委派身份。每个 Workspace 应用程序在市场上提供之前都要经过 Google 的审核，以尽量减少潜在的滥用风险。虽然这并不能完全消除滥用的风险，但它显著增加了此类事件发生的难度。
* **GCP 服务账户：** 了解更多关于[**GCP 服务账户**](gcp-basic-information.md#service-accounts)。

### **域范围委派：内幕**

以下是 GCP 服务账户如何代表 Google Workspace 中的其他身份访问 Google API：

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **身份创建 JWT：** 身份使用服务账户的私钥（JSON 密钥对文件的一部分）签署 JWT。这个 JWT 包含关于服务账户、要模拟的目标用户以及请求的 REST API 访问范围的声明。
2. **身份使用 JWT 请求访问令牌：** 应用程序/用户使用 JWT 向 Google 的 OAuth 2.0 服务请求访问令牌。请求还包括要模拟的目标用户（用户的 Workspace 邮箱）和请求访问的范围。
3. **Google 的 OAuth 2.0 服务返回访问令牌：** 访问令牌代表服务账户代表用户行事的权限，适用于指定的范围。这个令牌通常是短期的，必须定期刷新（根据应用程序的需要）。理解 JWT 令牌中指定的 OAuth 范围的有效性和对结果访问令牌的影响至关重要。例如，拥有多个范围的访问令牌将对多个 REST API 应用程序有效。
4. **身份使用访问令牌调用 Google API：** 现在有了相关的访问令牌，服务可以访问所需的 REST API。应用程序在其发送到 Google API 的 HTTP 请求的 "Authorization" 头中使用这个访问令牌。这些 API 使用令牌来验证被模拟的身份，并确认它具有必要的授权。
5. **Google API 返回请求的数据：** 如果访问令牌有效且服务账户具有适当的授权，则 Google API 返回请求的数据。例如，在下图中，我们利用 _users.messages.list_ 方法列出了与目标 Workspace 用户关联的所有 Gmail 消息 ID。

## 使用交互式 GWS 访问的新委派

在第一个场景中，行动者通常获得对 IAM 身份的初始访问权限，具有在 GCP 项目中**创建服务账户的能力。** 此外，他现在拥有 GWS 的**超级管理员权限。**

**攻击步骤：**

1. **生成新的服务账户和相应的密钥对：** 在 GCP 上，可以通过控制台交互式地或使用直接 API 调用和 CLI 工具以编程方式生成新的服务账户资源。这需要**角色 `iam.serviceAccountAdmin`** 或任何配备了**`iam.serviceAccounts.create`** **权限**的自定义角色。创建服务账户后，我们将继续生成一个**相关的密钥对**（**`iam.serviceAccountKeys.create`** 权限）。
2. **创建新的委派：** 拥有相关的身份对象和相关的私钥，使得可以使用 Google API 进行身份验证后，我们需要在 Google Workspace 中**为服务账户资源建立新的委派规则**。这个委派规则将使我们能够在 Workspace REST API 应用程序上执行 Google API 活动。重要的是要理解，**只有超级管理员角色具有在 Google Workspace 中设置全局域范围委派的能力**，而且域范围委派**不能以编程方式设置，** 它只能通过 Google Workspace **控制台**手动创建和调整。

规则的创建可以在 Google Workspace 管理控制台的页面 **API 控制 → 管理域范围委派** 下找到。
3. **附加 OAuth 范围权限：** 在配置新的委派时，Google 只需要两个参数，客户端 ID，即 GCP 服务账户资源的 **OAuth ID**，以及定义委派需要的 API 调用的 **OAuth 范围**。\
可以在[**这里**](https://developers.google.com/identity/protocols/oauth2/scopes)找到**完整的 OAuth 范围列表**。
4. **代表目标身份行事：** 此时，我们在 GWS 中有一个功能正常的委派对象。现在，**使用 GCP 服务账户的私钥，我们可以执行 API 调用**（在 OAuth 范围参数中定义的范围内）来触发它并**代表 Google Workspace 中存在的任何身份行事**。正如我们所学的，服务账户将根据其需要和对 REST API 应用程序的权限生成访问令牌。

### 跨组织委派

OAuth SA ID 是全球性的，可以用于**跨组织委派**。尚未实施任何限制以防止跨全球委派。简单来说，**不同 GCP 组织的服务账户可以用于在其他 Workspace 组织上配置域范围委派**。这将导致**只需要访问 Workspace 的超级管理员权限**，而不需要访问同一个 GCP 账户，因为对手可以在他个人控制的 GCP 账户上创建服务账户和私钥。

## 危害现有委派 - DeleFriend

如果我们可以访问具有**现有域范围委派**的相关 GCP 服务账户资源，则没有什么可以阻止我们创建新的密钥，枚举所有现有的 JWT 可能性，并使用该现有委派代表域中的其他身份对 Google Workspace 执行 API 调用。

{% hint style="danger" %}
在某种程度上危害了 GCP 组织/项目后，攻击者可以检查他可以为哪些 GCP 服务账户创建**json 密钥**，创建它们并检查**SA 是否有权代表其他身份访问某些 Workspace OAuth 范围**。
{% endhint %}

这些是确切的步骤：

1. 使用资源管理器 API **枚举 GCP 项目**。
2. 迭代每个项目资源，并使用 _GetIAMPolicy_ **枚举初始 IAM 用户有权访问的 GCP 服务账户资源**。
3. 迭代**每个服务账户角色**，并找到具有 _**serviceAccountKeys.create**_ 权限的内置、基本和自定义角色，适用于目标服务账户资源。应该注意的是，编辑者角色本质上拥有这个权限。
4. 为 IAM 策略中找到具有相关权限的每个服务账户资源创建一个**新的 \_KEY\_ALG\_RSA\_2048**\_\*\* 私钥\*\*。
5. 迭代**每个新服务账户并为其创建一个 \_JWT**\_\*\* 对象\*\*，该对象由 SA 私钥凭据和 OAuth 范围组成。创建新的 _JWT_ 对象的过程将**迭代所有现有的 OAuth 范围组合**，从 **oauth\_scopes.txt** 列表中找到所有委派的可能性。列表 **oauth\_scopes.txt** 更新了我们发现的所有与滥用 Workspace 身份相关的 OAuth 范围。
6. _\_make\_authorization\_grant\_assertion_ 方法揭示了声明一个**目标 workspace 用户**的必要性，称为 _subject_，用于在 DWD 下生成 JWT。虽然这似乎需要一个特定的用户，但重要的是要意识到**DWD 影响域中的每个身份**。因此，为**任何域用户**创建 JWT 会影响该域中的所有身份，这与我们的组合枚举检查一致。简而言之，一个有效的 Workspace 用户就足以继续前进。\
如果目标 workspace 用户尚未知晓，该工具通过扫描在 GCP 项目上具有角色的域用户来自动识别有效的 workspace 用户。关键是要注意（再次），JWT 是特定于域的，不是为每个用户生成的；因此，自动过程针对每个域的单一唯一身份。
7. **枚举并为每个 JWT 创建一个新的持有者访问令牌**，并使用 tokeninfo API 验证令牌。

**您可以在以下位置找到自动执行此攻击的工具：** [**DeleFriend**](https://github.com/axon-git/DeleFriend)

## 参考资料

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直到成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
