# Pentesting GCP

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas dicas de hacking enviando PRs para** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos.**

</details>

## Informa√ß√µes b√°sicas

**Antes de come√ßar a pentestear** um ambiente **GCP**, h√° algumas **coisas b√°sicas que voc√™ precisa saber** sobre como ele funciona para ajud√°-lo a entender o que precisa fazer, como encontrar m√°s configura√ß√µes e como explor√°-las.

Conceitos como hierarquia de **organiza√ß√£o**, **permiss√µes** e outros conceitos b√°sicos s√£o explicados em:

{% content-ref url="gcp-basic-information.md" %}
[gcp-basic-information.md](gcp-basic-information.md)
{% endcontent-ref %}

## Laborat√≥rios para aprender

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## Metodologia de Pentester/Red Team GCP

Para auditar um ambiente GCP, √© muito importante saber: quais **servi√ßos est√£o sendo usados**, o que est√° **sendo exposto**, quem tem **acesso** a qu√™ e como os servi√ßos internos do GCP e os **servi√ßos externos** est√£o conectados.

Do ponto de vista do Red Team, o **primeiro passo para comprometer um ambiente GCP** √© conseguir obter algumas **credenciais**. Aqui est√£o algumas ideias sobre como fazer isso:

* **Vazamentos** no github (ou similar) - OSINT
* **Engenharia** social (verifique a p√°gina [**Workspace Security**](../workspace-security.md))
* **Reutiliza√ß√£o** de senhas (vazamentos de senhas)
* Vulnerabilidades em Aplica√ß√µes Hospedadas no GCP
  * [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) com acesso ao endpoint de metadados
  * **Leitura de Arquivo Local**
    * `/home/USERNAME/.config/gcloud/*`
    * `C:\Users\USERNAME\.config\gcloud\*`
* 3¬™ partes **invadidas**
* **Funcion√°rio** interno

Ou comprometendo um servi√ßo **n√£o autenticado** exposto:

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

Ou se voc√™ estiver fazendo uma **revis√£o**, voc√™ pode simplesmente **solicitar credenciais** com essas fun√ß√µes:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Depois de conseguir obter credenciais, voc√™ precisa saber **para quem essas credenciais pertencem** e **o que elas t√™m acesso**, ent√£o voc√™ precisa realizar alguma enumera√ß√£o b√°sica:
{% endhint %}

## Enumera√ß√£o B√°sica

### **SSRF**

Para obter mais informa√ß√µes sobre como **enumerar metadados do GCP**, verifique a seguinte p√°gina do hacktricks:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

No GCP, voc√™ pode tentar v√°rias op√ß√µes para tentar adivinhar quem voc√™ √©:

```bash
#Se voc√™ estiver dentro de uma m√°quina comprometida
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Obtenha informa√ß√µes do token

#Se voc√™ comprometeu um token de metadados ou de alguma forma encontrou um token OAuth
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```

### Enumera√ß√£o de Organiza√ß√£o

```bash
# Obter organiza√ß√µes
gcloud organizations list #O DIRECTORY_CUSTOMER_ID √© o ID do Workspace
gcloud resource-manager folders list --organization <org_number> # Obter pastas
gcloud projects list # Obter projetos
```

### Enumera√ß√£o de Principais e IAM

Se voc√™ tiver privil√©gios suficientes, **verificar os privil√©gios de cada entidade dentro da conta GCP** ajudar√° voc√™ a entender o que voc√™ e outras identidades podem fazer e como **escalar privil√©gios**.

Se voc√™ n√£o tiver privil√©gios suficientes para enumerar o IAM, pode **roub√°-los por for√ßa bruta** para descobri-los.\
Verifique **como fazer a enumera√ß√£o e a for√ßa bruta** em:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam
# Se voc√™ n√£o quiser desativar completamente a valida√ß√£o SSL, use:
gcloud config set core/custom_ca_certs_file cert.pem

# De volta ao normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```

## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>