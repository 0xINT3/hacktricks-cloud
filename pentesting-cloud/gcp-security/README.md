# Pentesting de GCP

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Información básica

**Antes de comenzar el pentesting** de un entorno de **GCP**, hay algunas **cosas básicas que debes saber** sobre cómo funciona para ayudarte a entender lo que necesitas hacer, cómo encontrar configuraciones incorrectas y cómo explotarlas.

Conceptos como la jerarquía de **organización**, **permisos** y otros conceptos básicos se explican en:

{% content-ref url="gcp-basic-information.md" %}
[gcp-basic-information.md](gcp-basic-information.md)
{% endcontent-ref %}

## Laboratorios para aprender

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## Metodología de pentesting de GCP/Red Team

Para auditar un entorno de GCP, es muy importante saber: qué **servicios se están utilizando**, qué se está **exponiendo**, quién tiene **acceso** a qué y cómo están conectados los servicios internos de GCP con los servicios **externos**.

Desde el punto de vista de un Red Team, el **primer paso para comprometer un entorno de GCP** es lograr obtener algunas **credenciales**. Aquí tienes algunas ideas sobre cómo hacerlo:

* **Fugas** en GitHub (u otros) - OSINT
* **Ingeniería** social (Consulta la página [**Seguridad de Workspace**](../workspace-security.md))
* Reutilización de **contraseñas** (fugas de contraseñas)
* Vulnerabilidades en aplicaciones alojadas en GCP
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) con acceso al punto de conexión de metadatos
* **Lectura de archivos locales**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* **Brechas** de terceros
* Empleado **interno**

O comprometiendo un servicio sin autenticación expuesto:

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

O si estás haciendo una **revisión**, simplemente puedes **solicitar credenciales** con estos roles:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Después de haber logrado obtener credenciales, necesitas saber **a quién pertenecen esas credenciales** y **a qué tienen acceso**, por lo que debes realizar una enumeración básica:
{% endhint %}

## Enumeración básica

### **SSRF**

Para obtener más información sobre cómo **enumerar metadatos de GCP**, consulta la siguiente página de hacktricks:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

En GCP, puedes probar varias opciones para intentar adivinar quién eres:
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
### Enumeración de la Organización

#### Descripción

La enumeración de la organización es el proceso de recopilar información sobre la estructura y los recursos de una organización en la plataforma de la nube. Esto incluye identificar los proyectos, carpetas, cuentas de servicio y otros elementos que forman parte de la organización en Google Cloud Platform (GCP).

#### Técnicas de Enumeración

A continuación se presentan algunas técnicas comunes utilizadas para enumerar una organización en GCP:

1. **Enumeración de proyectos**: Identificar los proyectos existentes en la organización utilizando comandos como `gcloud projects list` o consultando la API de GCP.

2. **Enumeración de carpetas**: Identificar las carpetas en la organización utilizando comandos como `gcloud resource-manager folders list` o consultando la API de GCP.

3. **Enumeración de cuentas de servicio**: Identificar las cuentas de servicio en la organización utilizando comandos como `gcloud iam service-accounts list` o consultando la API de GCP.

4. **Enumeración de políticas de IAM**: Obtener información sobre las políticas de control de acceso en la organización utilizando comandos como `gcloud organizations get-iam-policy` o consultando la API de GCP.

#### Recomendaciones de Seguridad

Para proteger la organización en GCP, se recomienda seguir estas mejores prácticas:

1. Limitar los privilegios de las cuentas de servicio y asignar solo los permisos necesarios.

2. Regularmente revisar y auditar las políticas de IAM para asegurarse de que solo los usuarios y servicios autorizados tengan acceso a los recursos.

3. Implementar medidas de seguridad adicionales, como la autenticación de dos factores y el monitoreo de registros, para detectar y prevenir actividades sospechosas.

4. Mantenerse actualizado sobre las últimas actualizaciones de seguridad y parches proporcionados por GCP.

#### Conclusiones

La enumeración de la organización es un paso importante en el proceso de pentesting en la nube. Proporciona información valiosa sobre la estructura y los recursos de una organización en GCP, lo que ayuda a identificar posibles puntos débiles y mejorar la seguridad en la plataforma. Al seguir las mejores prácticas de seguridad, se puede mitigar el riesgo de posibles ataques y filtraciones de datos.
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### Enumeración de Principales e IAM

Si tienes suficientes permisos, **verificar los privilegios de cada entidad dentro de la cuenta de GCP** te ayudará a entender lo que tú y otras identidades pueden hacer y cómo **elevar privilegios**.

Si no tienes suficientes permisos para enumerar IAM, puedes **robarlos por fuerza bruta** para descubrirlos.\
Consulta **cómo hacer la enumeración y fuerza bruta** en:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
Ahora que **tienes información sobre tus credenciales** (y si eres un equipo rojo, esperemos que **no hayas sido detectado**), es hora de descubrir qué servicios se están utilizando en el entorno.\
En la siguiente sección puedes consultar algunas formas de **enumerar algunos servicios comunes**.
{% endhint %}

## Enumeración de Servicios, Post-Explotación y Persistencia

GCP tiene una cantidad asombrosa de servicios, en la siguiente página encontrarás **información básica, hojas de trucos de enumeración**, cómo **evitar la detección**, obtener **persistencia** y otros trucos de **post-explotación** sobre algunos de ellos:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

{% content-ref url="gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](gcp-non-svc-persistance.md)
{% endcontent-ref %}

Ten en cuenta que **no** necesitas realizar todo el trabajo **manualmente**, más adelante en esta publicación puedes encontrar una **sección sobre** [**herramientas automáticas**](./#automatic-tools).

Además, en esta etapa es posible que hayas descubierto **más servicios expuestos a usuarios no autenticados**, es posible que puedas explotarlos:

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

## Escalada de Privilegios

La forma más común una vez que has obtenido algunas credenciales de la nube o has comprometido algún servicio que se ejecuta dentro de una nube es **abusar de los privilegios mal configurados** que la cuenta comprometida pueda tener. Por lo tanto, lo primero que debes hacer es enumerar tus privilegios.

Además, durante esta enumeración, recuerda que los **permisos se pueden establecer en el nivel más alto de "Organización"** también.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

## Servicios Expuestos Públicamente

Mientras enumeras los servicios de GCP, es posible que hayas encontrado algunos de ellos **exponiendo elementos a Internet** (puertos de VM/contenedores, bases de datos o servicios de cola, instantáneas o buckets...).\
Como pentester/equipo rojo, siempre debes verificar si puedes encontrar **información sensible/vulnerabilidades** en ellos, ya que podrían proporcionarte **acceso adicional a la cuenta de GCP**.

En este libro encontrarás **información** sobre cómo encontrar **servicios expuestos de GCP y cómo verificarlos**. Sobre cómo encontrar **vulnerabilidades en servicios de red expuestos**, te recomendaría **buscar** el **servicio** específico en:

{% embed url="https://book.hacktricks.xyz/" %}

## Herramientas Automáticas

* En la **consola de GCloud**, en [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard) puedes ver los recursos y IAM que se utilizan en el proyecto.
* Aquí puedes ver los activos admitidos por esta API: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* Consulta las **herramientas** que se pueden [**utilizar en varias nubes aquí**](../pentesting-cloud-methodology.md).
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner): Este es un escáner de recursos de GCP que puede ayudar a determinar qué **nivel de acceso tienen ciertas credenciales** en GCP.
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): Script de Bash para enumerar un entorno de GCP utilizando la interfaz de línea de comandos de gcloud y guardar los resultados en un archivo.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): Scripts para enumerar privilegios IAM elevados y para escalar privilegios en GCP abusando de ellos (no pude hacer funcionar el script de enumeración).

## Configuración y depuración de gcloud
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### Captura de red de gcloud, gsutil...

Recuerda que puedes utilizar el **parámetro** **`--log-http`** con la herramienta **`gcloud`** cli para **imprimir** las **solicitudes** que realiza la herramienta. Si no deseas que los registros oculten el valor del token, utiliza `gcloud config set log_http_redact_token false`

Además, para interceptar la comunicación:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
