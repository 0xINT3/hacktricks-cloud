# GCP渗透测试

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 基本信息

在开始渗透测试GCP环境之前，有一些基本知识需要了解，以帮助您理解需要做什么，如何查找配置错误以及如何利用它们。

有关组织层次结构、权限和其他基本概念的解释，请参阅：

{% content-ref url="gcp-basic-information.md" %}
[gcp-basic-information.md](gcp-basic-information.md)
{% endcontent-ref %}

## 学习实验

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP渗透测试/红队方法论

为了审计GCP环境，了解以下信息非常重要：使用了哪些**服务**，**暴露了什么**，谁有**访问权限**，以及内部GCP服务和**外部服务**如何连接。

从红队的角度来看，**入侵GCP环境的第一步**是设法获得一些**凭据**。以下是一些关于如何做到这一点的想法：

* 在github（或类似网站）上的**泄漏** - OSINT
* **社交**工程（查看页面[**Workspace安全**](../workspace-security.md)）
* **密码**重用（密码泄漏）
* GCP托管应用程序中的漏洞
* [**服务器端请求伪造（SSRF）**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)并访问元数据端点
* **本地文件读取**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 第三方**遭到入侵**
* **内部**员工

或通过**入侵未经身份验证的服务**：

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

或者如果您正在进行**审查**，您可以直接使用以下角色**要求凭据**：

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
在成功获得凭据后，您需要知道这些凭据属于**谁**，以及他们有访问权限的**内容**，因此您需要执行一些基本枚举操作：
{% endhint %}

## 基本枚举

### **SSRF**

有关如何**枚举GCP元数据**的更多信息，请查看以下hacktricks页面：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

在GCP中，您可以尝试多种选项来猜测您是谁：
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
### 组织枚举

Org枚举

```plaintext
gcloud organizations list
```

列出所有组织

```plaintext
gcloud organizations describe ORGANIZATION_ID
```

获取组织的详细信息

### Project Enumeration

项目枚举

```plaintext
gcloud projects list
```

列出所有项目

```plaintext
gcloud projects describe PROJECT_ID
```

获取项目的详细信息

### Folder Enumeration

文件夹枚举

```plaintext
gcloud resource-manager folders list --organization=ORGANIZATION_ID
```

列出组织下的所有文件夹

```plaintext
gcloud resource-manager folders describe FOLDER_ID
```

获取文件夹的详细信息

### Billing Account Enumeration

计费账户枚举

```plaintext
gcloud alpha billing accounts list
```

列出所有计费账户

```plaintext
gcloud alpha billing accounts describe ACCOUNT_ID
```

获取计费账户的详细信息
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### 主体和IAM枚举

如果您拥有足够的权限，**检查GCP帐户中每个实体的权限**将帮助您了解您和其他身份可以做什么以及如何**升级权限**。

如果您没有足够的权限来枚举IAM，您可以**暴力破解它们**以弄清楚它们。\
在以下链接中查看**如何进行枚举和暴力破解**：

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
现在，您对自己的凭据有了一些信息（如果您是红队，希望您**没有被发现**）。现在是时候弄清楚环境中使用了哪些服务了。\
在下面的部分中，您可以查看一些**枚举一些常见服务的方法**。
{% endhint %}

## 服务枚举、后渗透和持久性

GCP拥有大量的服务，在以下页面中，您将找到一些关于其中一些服务的**基本信息、枚举**速查表，如何**避免被检测**，获取**持久性**以及其他**后渗透**技巧：

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

{% content-ref url="gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](gcp-non-svc-persistance.md)
{% endcontent-ref %}

请注意，您**不需要**手动执行所有工作，在本文的后面部分，您可以找到关于[**自动化工具**](./#automatic-tools)的章节。

此外，在此阶段，您可能会发现**更多服务暴露给未经身份验证的用户**，您可能能够利用它们：

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

## 提权

一旦您获得了一些云凭据或者入侵了云中运行的某些服务，最常见的方法就是**滥用被入侵账户可能具有的配置错误的权限**。因此，您应该首先枚举您的权限。

此外，在此枚举过程中，请记住**权限可以在"组织"的最高级别上设置**。

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

## 公开暴露的服务

在枚举GCP服务时，您可能会发现其中一些服务**将元素暴露给互联网**（VM/容器端口、数据库或队列服务、快照或存储桶...）。\
作为渗透测试员/红队成员，您应该始终检查是否可以在这些服务中找到**敏感信息/漏洞**，因为它们可能为您提供**进一步访问AWS账户**的机会。

在本书中，您可以找到有关如何找到**公开暴露的AWS服务以及如何检查它们**的**信息**。关于如何找到**公开网络服务的漏洞**，我建议您在以下链接中**搜索**具体的**服务**：

{% embed url="https://book.hacktricks.xyz/" %}

## 自动化工具

* 在**GCloud控制台**中，您可以在[https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard)上查看项目使用的资源和IAM。
* 在此处，您可以查看此API支持的资源：[https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* 在[**此处**](../pentesting-cloud-methodology.md)查看可以在**多个云中使用的工具**。
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner)：这是一个GCP资源扫描器，可以帮助确定在GCP上某些凭据具有的**访问级别**。
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): 用gcloud cli枚举GCP环境的Bash脚本，并将结果保存在文件中。
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 用于枚举高级IAM权限并利用它们在GCP中提升权限的脚本（我无法运行枚举脚本）。

## gcloud配置和调试
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### 捕获 gcloud, gsutil... 网络

记住，你可以使用 **`gcloud`** 命令行工具的 **`--log-http`** 参数来打印工具执行的请求。如果你不想让日志遮蔽令牌值，请使用 `gcloud config set log_http_redact_token false`

此外，要拦截通信：
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问最新版本的 PEASS 或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
