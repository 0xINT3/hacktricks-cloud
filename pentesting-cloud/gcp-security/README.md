# GCP Pentesting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* 회사를 **HackTricks에서 광고**하거나 **PDF로 HackTricks 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 기본 정보

**GCP** 환경을 **펜테스팅**하기 전에, 무엇을 해야하고, 미스컨피규레이션을 찾는 방법 및 이를 악용하는 방법을 이해하기 위해 몇 가지 **기본 사항을 알아야합니다**.

**조직** 계층 구조, **권한** 및 기타 기본 개념은 다음에서 설명되어 있습니다:

{% content-ref url="gcp-basic-information.md" %}
[gcp-basic-information.md](gcp-basic-information.md)
{% endcontent-ref %}

## 학습을 위한 랩

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP Pentester/Red Team 방법론

GCP 환경을 감사하기 위해서는 다음을 알아야합니다: 어떤 **서비스가 사용되고 있는지**, 무엇이 **노출**되고 있는지, 누가 **무엇에 접근**할 수 있는지, 내부 GCP 서비스와 **외부 서비스**가 어떻게 연결되어 있는지.

Red Team 관점에서 GCP 환경을 **침해하기 위한 첫 번째 단계**는 일부 **자격 증명을 얻는 것**입니다. 다음은 그 방법에 대한 몇 가지 아이디어입니다:

* github (또는 유사한 곳)에서의 **정보 유출** - OSINT
* **사회 공학** (페이지 [**Workspace Security**](../workspace-security/) 참조)
* **비밀번호 재사용** (비밀번호 유출)
* GCP-호스팅 애플리케이션의 취약점
* [**서버 측 요청 위조(SSRF)**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) - 메타데이터 엔드포인트에 액세스
* **로컬 파일 읽기**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 타사 **침해**
* **내부** 직원

또는 **인증되지 않은 서비스**를 침해함으로써 얻을 수도 있습니다:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

또는 **리뷰**를 수행하는 경우 다음 역할로 **자격 증명을 요청**할 수 있습니다:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
자격 증명을 얻은 후, 해당 자격 증명이 **누구에게 속해 있는지** 및 **무엇에 접근할 수 있는지** 알아야하므로 몇 가지 기본 열거를 수행해야합니다:
{% endhint %}

## 기본 열거

### **SSRF**

GCP 메타데이터를 **열거하는 방법**에 대한 자세한 정보는 다음 hacktricks 페이지를 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

GCP에서는 자신이 누구인지 추측하기 위해 여러 옵션을 시도할 수 있습니다:

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

### 조직 열거

{% code-tabs %}
{% code-tabs-item title="gcloud organizations list" %}
```bash
gcloud organizations list
```
{% endcode-tabs-item %}
{% endcode-tabs %}

조직 열거는 GCP 조직 계정을 식별하는 데 사용됩니다. 이 명령은 현재 사용자의 GCP 프로젝트에 연결된 모든 조직을 나열합니다.

### Project Enumeration

{% code-tabs %}
{% code-tabs-item title="gcloud projects list" %}
```bash
gcloud projects list
```
{% endcode-tabs-item %}
{% endcode-tabs %}

프로젝트 열거는 GCP 프로젝트를 식별하는 데 사용됩니다. 이 명령은 현재 사용자의 GCP 조직에 연결된 모든 프로젝트를 나열합니다.

### Service Account Enumeration

{% code-tabs %}
{% code-tabs-item title="gcloud iam service-accounts list" %}
```bash
gcloud iam service-accounts list
```
{% endcode-tabs-item %}
{% endcode-tabs %}

서비스 계정 열거는 GCP 조직 또는 프로젝트에 연결된 모든 서비스 계정을 식별하는 데 사용됩니다. 이 명령은 현재 사용자의 GCP 조직 또는 프로젝트에 연결된 모든 서비스 계정을 나열합니다.

### IAM Policy Enumeration

{% code-tabs %}
{% code-tabs-item title="gcloud projects get-iam-policy PROJECT_ID" %}
```bash
gcloud projects get-iam-policy PROJECT_ID
```
{% endcode-tabs-item %}
{% endcode-tabs %}

IAM 정책 열거는 GCP 프로젝트의 IAM(Identity and Access Management) 정책을 식별하는 데 사용됩니다. 이 명령은 특정 프로젝트의 IAM 정책을 나열합니다.

### IAM Role Enumeration

{% code-tabs %}
{% code-tabs-item title="gcloud iam roles list" %}
```bash
gcloud iam roles list
```
{% endcode-tabs-item %}
{% endcode-tabs %}

IAM 역할 열거는 GCP 조직 또는 프로젝트에서 사용 가능한 모든 IAM 역할을 식별하는 데 사용됩니다. 이 명령은 현재 사용자의 GCP 조직 또는 프로젝트에서 사용 가능한 모든 IAM 역할을 나열합니다.
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### Principal 및 IAM 열거

충분한 권한이 있다면, GCP 계정 내의 각 엔티티의 권한을 확인하여 자신과 다른 신원이 무엇을 할 수 있는지 및 권한 상승 방법을 이해하는 데 도움이 될 것입니다.

IAM을 열거할 충분한 권한이 없는 경우, 무차별 대입(brute-force)을 통해 IAM을 알아내는 것이 가능합니다.\
다음에서 열거 및 무차별 대입을 수행하는 방법을 확인하세요:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
이제 자격 증명에 대한 일부 정보를 가지고 있으므로 (레드 팀인 경우 감지되지 않았을 것으로 희망합니다), 환경에서 사용되는 서비스를 확인해야 합니다.\
다음 섹션에서 일부 일반적인 서비스를 열거하는 방법을 확인할 수 있습니다.
{% endhint %}

## 서비스 열거

GCP에는 놀라운 수의 서비스가 있으며, 다음 페이지에서는 일부 서비스에 대한 기본 정보, 열거 체크시트, 탐지 회피 방법, 지속성 확보 및 기타 후반 작업 팁을 확인할 수 있습니다:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

수동으로 모든 작업을 수행할 필요는 없다는 점에 유의하십시오. 이 게시물의 아래에서 [자동 도구에 대한](./#automatic-tools) 섹션을 찾을 수 있습니다.

또한, 이 단계에서 인증되지 않은 사용자에게 노출된 더 많은 서비스를 발견할 수 있으며, 이를 악용할 수 있습니다:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## 권한 상승, 후반 작업 및 지속성

클라우드 자격 증명을 얻거나 클라우드 내에서 실행 중인 일부 서비스를 침해한 후에는 침해된 계정이 가질 수 있는 잘못 구성된 권한을 악용하는 것이 가장 일반적인 방법입니다. 따라서, 먼저 권한을 열거해야 합니다.

또한, 이 열거 중에는 권한이 "조직"의 최상위 수준에서 설정될 수 있다는 점을 기억하십시오.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### 공개적으로 노출된 서비스

GCP 서비스를 열거하는 동안 인터넷에 요소를 노출하는 일부 서비스(VM/컨테이너 포트, 데이터베이스 또는 큐 서비스, 스냅샷 또는 버킷 등)를 발견할 수 있었을 것입니다.\
펜테스터/레드 팀은 항상 해당 서비스에서 민감한 정보/취약점을 찾을 수 있는지 확인해야 합니다. 이는 AWS 계정으로의 추가적인 액세스를 제공할 수 있습니다.

이 책에서는 노출된 GCP 서비스를 찾고 확인하는 방법에 대한 정보를 찾을 수 있습니다. 노출된 네트워크 서비스에서 취약점을 찾는 방법에 대해서는 다음에서 특정 서비스에 대해 검색하는 것을 권장합니다:

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace 피벗

**하나의** 플랫폼에서 주체(principal)를 **침해**하면 공격자가 **다른 플랫폼을 침해**할 수 있을 수 있습니다. 확인하려면 다음을 참조하세요:

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## 자동 도구

* **GCloud 콘솔**에서 [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard)에서 프로젝트에서 사용되는 리소스 및 IAM을 확인할 수 있습니다.
* 이 API에서 지원하는 자산은 다음에서 확인할 수 있습니다: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* [다양한 클라우드에서 사용할 수 있는 도구](../pentesting-cloud-methodology.md)를 확인하세요.
* [gcp\_scanner](https://github.com/google/gcp\_scanner): GCP 리소스 스캐너로, GCP에서 특정 자격 증명이 어떤 수준의 액세스를 가지고 있는지 확인하는 데 도움이 됩니다.
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): GCP 환경을 열거하기 위해 gcloud cli를 사용하고 결과를 파일에 저장하는 Bash 스크립트입니다.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 고급 IAM 권한을 열거하고 이를 악용하여 GCP에서 권한을 상승시키는 스크립트입니다 (열거 스크립트를 실행하지 못했습니다).

## gcloud config & debug
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### gcloud, gsutil... 네트워크 캡처

**gcloud** cli에서 **`--log-http`** **매개변수**를 사용하여 도구가 수행하는 **요청**을 **출력**할 수 있습니다. 로그에서 토큰 값을 가려주지 않으려면 `gcloud config set log_http_redact_token false`를 사용하세요.

또한, 통신을 가로채려면:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### gcloud에서 OAuth 토큰 구성

메타데이터 엔드포인트에서 유출된 서비스 계정 OAuth 토큰을 사용하려면 다음을 수행할 수 있습니다:
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## 참고 자료

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
