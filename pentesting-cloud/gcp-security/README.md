# GCP Pentesting

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をハックトリックで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを楽しみましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加しましょう。**

</details>

## 基本情報

**GCP**環境の**ペンテストを開始する前に**、何をすべきか、ミスコンフィギュレーションを見つける方法、それらを悪用する方法を理解するために、いくつかの**基本的な事項を知っておく必要があります**。

組織の階層、権限などの概念については、次のリンクで説明されています：

{% content-ref url="gcp-basic-information.md" %}
[gcp-basic-information.md](gcp-basic-information.md)
{% endcontent-ref %}

## 学習用のラボ

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCPペンテスター/レッドチームの方法論

GCP環境を監査するためには、使用されている**サービス**、**公開されているもの**、誰が**何にアクセス**できるか、内部のGCPサービスと**外部サービス**がどのように接続されているかを知ることが非常に重要です。

レッドチームの視点からは、GCP環境を**侵害する最初のステップ**は、いくつかの**資格情報を入手する**ことです。以下に、それを行うためのいくつかのアイデアがあります：

* GitHub（または同様の場所）での**情報漏洩** - OSINT
* **ソーシャルエンジニアリング**（[**Workspace Security**](../workspace-security.md)ページを参照）
* **パスワードの再利用**（パスワードの漏洩）
* GCPホストされたアプリケーションの脆弱性
* [**サーバーサイドリクエストフォージェリ**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)（メタデータエンドポイントへのアクセス）
* **ローカルファイルの読み取り**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* サードパーティが**侵害された**場合
* **内部の**従業員

または、**認証されていないサービス**を侵害することで：

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

または、**レビュー**を行っている場合は、次の役割で**資格情報を要求**するだけです：

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
資格情報を入手した後、それらの資格情報が**誰に属しているか**、そして**何にアクセスできるか**を知る必要があるため、基本的な列挙を実行する必要があります：
{% endhint %}

## 基本的な列挙

### **SSRF**

GCPメタデータの列挙方法の詳細については、次のハックトリックのページを参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

GCPでは、次のオプションを試して自分が誰であるかを推測することができます：
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
### 組織の列挙

To enumerate an organization in GCP, you can use the following techniques:

GCPで組織を列挙するために、以下のテクニックを使用することができます。

#### 1. Google Cloud Directory API

The Google Cloud Directory API allows you to retrieve information about the organization, including its name, ID, and domain. You can use this API to gather valuable information for further enumeration.

Google Cloud Directory APIを使用すると、組織の名前、ID、ドメインなどの情報を取得することができます。このAPIを使用して、さらなる列挙のための貴重な情報を収集することができます。

#### 2. Google Cloud Resource Manager API

The Google Cloud Resource Manager API provides methods to retrieve and manage GCP resources, including organizations. You can use this API to list all the projects and folders within an organization, which can help you understand the structure and scope of the organization.

Google Cloud Resource Manager APIは、組織を含むGCPリソースを取得および管理するためのメソッドを提供します。このAPIを使用して、組織内のすべてのプロジェクトとフォルダをリストすることができます。これにより、組織の構造と範囲を理解するのに役立ちます。

#### 3. Google Cloud Asset Inventory

Google Cloud Asset Inventory provides a comprehensive view of the assets in your organization, including resources, IAM policies, and access control lists (ACLs). You can use this service to gather information about the organization's assets and their permissions.

Google Cloud Asset Inventoryは、組織内のリソース、IAMポリシー、アクセス制御リスト（ACL）など、組織のアセットの包括的なビューを提供します。このサービスを使用して、組織のアセットとその権限に関する情報を収集することができます。

#### 4. Google Cloud IAM

Google Cloud IAM (Identity and Access Management) allows you to manage access to GCP resources. By analyzing the IAM policies and roles assigned to different users and service accounts within the organization, you can gain insights into the organization's access control model.

Google Cloud IAM（Identity and Access Management）を使用すると、GCPリソースへのアクセスを管理することができます。組織内の異なるユーザーとサービスアカウントに割り当てられたIAMポリシーとロールを分析することで、組織のアクセス制御モデルについての洞察を得ることができます。

#### 5. Google Cloud Identity-Aware Proxy (IAP)

Google Cloud Identity-Aware Proxy (IAP) provides secure access to applications running on GCP. By analyzing the IAP configurations, you can identify the applications and services accessible within the organization.

Google Cloud Identity-Aware Proxy（IAP）は、GCPで実行されているアプリケーションへの安全なアクセスを提供します。IAPの設定を分析することで、組織内でアクセス可能なアプリケーションとサービスを特定することができます。

#### 6. Google Cloud DNS

Google Cloud DNS allows you to manage DNS zones and records. By enumerating the DNS records associated with the organization's domain, you can gather information about the organization's infrastructure and services.

Google Cloud DNSを使用すると、DNSゾーンとレコードを管理することができます。組織のドメインに関連するDNSレコードを列挙することで、組織のインフラストラクチャとサービスに関する情報を収集することができます。

These techniques can help you gather valuable information about the organization's structure, assets, access control, and infrastructure, which can be useful for further penetration testing and security assessments.

これらのテクニックは、組織の構造、アセット、アクセス制御、およびインフラストラクチャに関する貴重な情報を収集するのに役立ちます。これは、さらなる侵入テストやセキュリティ評価に役立つことがあります。
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### プリンシパルとIAMの列挙

十分な権限を持っている場合、GCPアカウント内の各エンティティの特権をチェックすることで、自分や他のアイデンティティが何ができるか、特権をエスカレートする方法を理解するのに役立ちます。

IAMを列挙するための十分な権限がない場合、ブルートフォース攻撃を行ってそれらを特定することができます。\
以下のリンクで、**列挙とブルートフォース攻撃の方法**を確認してください。

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
今、クレデンシャルに関する情報がある（もし赤チームであれば、**検出されていない**ことを願っています）。環境で使用されているサービスを特定するための方法を確認しましょう。\
以下のセクションでは、いくつかの一般的なサービスを列挙する方法を確認できます。
{% endhint %}

## サービスの列挙、ポストエクスプロイテーション、永続化

GCPには驚くほど多くのサービスがあります。以下のページでは、いくつかのサービスに関する**基本情報、列挙のチートシート**、**検出を回避する方法**、**永続性の確保**、およびその他の**ポストエクスプロイテーション**のトリックを確認できます。

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

{% content-ref url="gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](gcp-non-svc-persistance.md)
{% endcontent-ref %}

手作業ですべての作業を行う必要はありませんが、このポストの下部には[**自動ツールに関するセクション**](./#automatic-tools)があります。

さらに、この段階で**認証されていないユーザーに公開されているサービスがさらに見つかる**かもしれません。これらを悪用することができるかもしれません。

{% content-ref url="gcp-unauthenticated-enum/" %}
[gcp-unauthenticated-enum](gcp-unauthenticated-enum/)
{% endcontent-ref %}

## 特権エスカレーション

クラウドのクレデンシャルを取得したり、クラウド内で実行されているサービスを侵害したりした場合、最も一般的な方法は、侵害されたアカウントが持つ**設定ミスの特権を悪用する**ことです。したがって、まずは特権を列挙する必要があります。

また、この列挙中には、**権限が最上位の「組織」レベルで設定されている可能性**もあることを忘れないでください。

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

## 公開されているサービス

GCPのサービスを列挙する際に、それらの一部が**インターネットに要素を公開している**ことがわかるかもしれません（VM/コンテナのポート、データベースやキューサービス、スナップショットやバケットなど）。\
ペンテスターやレッドチームの場合、これらが**AWSアカウントへのさらなるアクセス**を提供する可能性があるため、それらに**機密情報や脆弱性**がないか常に確認する必要があります。

この本では、**公開されたAWSサービスを見つける方法やそれらをチェックする方法**についての情報が記載されています。公開されたネットワークサービスの脆弱性を見つける方法については、以下の特定の**サービス**を検索することをお勧めします。

{% embed url="https://book.hacktricks.xyz/" %}

## 自動ツール

* **GCloudコンソール**の[https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard)では、プロジェクトで使用されているリソースとIAMを確認できます。
* ここでは、このAPIでサポートされているアセットを確認できます：[https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner)：これはGCPリソーススキャナであり、GCP上で特定のクレデンシャルがどのようなアクセスレベルを持っているかを判断するのに役立ちます。
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): GCP環境を列挙するためのBashスクリプト。gcloud cliを使用して結果をファイルに保存します。
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 高いIAM特権を列挙し、それらを悪用してGCPで特権をエスカレーションするためのスクリプト（列挙スクリプトを実行できませんでした）。

## gcloud config & debug
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### ネットワークのキャプチャー gcloud, gsutil...

`gcloud` cliで**`--log-http`**パラメーターを使用して、ツールが実行している**リクエスト**を**表示**することができます。ログがトークンの値を伏せることを望まない場合は、`gcloud config set log_http_redact_token false`を使用してください。

さらに、通信を傍受するには:
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社をハックトリックで宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
