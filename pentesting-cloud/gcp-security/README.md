# GCP Pentesting

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

**Voordat jy begin pentesting** van 'n **GCP-omgewing**, is daar 'n paar **basiese dinge wat jy moet weet** oor hoe dit werk om jou te help verstaan wat jy moet doen, hoe om misconfigurations te vind en hoe om dit uit te buit.

Konsepte soos **organisasiehi√´rargie**, **toestemmings** en ander basiese konsepte word verduidelik in:

{% content-ref url="gcp-basic-information/" %}
[gcp-basic-information](gcp-basic-information/)
{% endcontent-ref %}

## Laboratoriums om te leer

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP Pentester/Red Team Metodologie

Om 'n GCP-omgewing te ouditeer, is dit baie belangrik om te weet: watter **dienste word gebruik**, wat **blootgestel** word, wie het **toegang** tot wat, en hoe is interne GCP-dienste en **eksterne dienste** gekoppel.

Vanuit 'n Red Team-oogpunt is die **eerste stap om 'n GCP-omgewing te kompromitteer** om te slaag om sekere **geloofsbriewe** te verkry. Hier het jy 'n paar idees oor hoe om dit te doen:

* **Lekke** in github (of soortgelyk) - OSINT
* **Sosiale** Ingenieurswese (Kyk na die bladsy [**Workspace Security**](../workspace-security/))
* **Wagwoord** hergebruik (wagwoordlekke)
* Kwesbaarhede in GCP-gehoste Toepassings
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) met toegang tot metadata-eindpunt
* **Plaaslike L√™erlees**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 3de partye **gekraak**
* **Interne** Werknemer

Of deur 'n **ongeagte diens** wat blootgestel word, te kompromitteer:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

Of as jy 'n **ondersoek** doen, kan jy net **vir geloofsbriewe vra** met hierdie rolle:

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Nadat jy daarin geslaag het om geloofsbriewe te verkry, moet jy weet **aan wie behoort daardie geloofsbriewe**, en **waartoe het hulle toegang**, dus moet jy 'n paar basiese opname uitvoer:
{% endhint %}

## Basiese Opname

### **SSRF**

Vir meer inligting oor hoe om **GCP-metadata te ondersoek**, kyk na die volgende hacktricks-bladsy:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Wie is ek

In GCP kan jy verskeie opsies probeer om te raai wie jy is:

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
{% endcode %}

### Organisasie Enumerasie

```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```

### Beginsels & IAM Enumerasie

As jy genoeg toestemmings het, sal dit help om die voorregte van elke entiteit binne die GCP-rekening te ondersoek om te verstaan wat jy en ander identiteite kan doen en hoe om voorregte te verhoog.

As jy nie genoeg toestemmings het om IAM te ondersoek nie, kan jy dit brute-force om dit uit te vind. Kyk hoe om die nummering en brute-forcing te doen in:

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
Nou dat jy enige inligting oor jou geloofsbriewe het (en as jy 'n rooi span is, hoop ek jy is nie opgemerk nie). Dit is tyd om uit te vind watter dienste in die omgewing gebruik word. In die volgende afdeling kan jy 'n paar maniere vind om sommige algemene dienste te ondersoek.
{% endhint %}

## Dienste Enumerasie

GCP het 'n verbysterende hoeveelheid dienste. Op die volgende bladsy sal jy basiese inligting, enumerasie-snelgids, hoe om opsporing te vermy, volharding te verkry en ander post-exploitation-truuks vind oor sommige van hulle:

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

Let daarop dat jy nie al die werk handmatig hoef te doen nie. Hieronder in hierdie pos kan jy 'n afdeling vind oor outomatiese gereedskap.

Verder, in hierdie stadium het jy dalk meer dienste ontdek wat aan ongeagte gebruikers blootgestel is. Jy mag in staat wees om dit uit te buit:

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## Voorregverhoging, Post Exploitation & Volharding

Die mees algemene manier nadat jy enige wolk-geloofsbriewe verkry het of 'n diens binne 'n wolk gekompromitteer het, is om misgekonfigureerde voorregte te misbruik wat die gekompromitteerde rekening mag h√™. Die eerste ding wat jy moet doen, is om jou voorregte te ondersoek.

Verder, tydens hierdie ondersoek, onthou dat toestemmings op die hoogste vlak van die "Organisasie" ingestel kan word.

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### Openbaar Blootgestelde Dienste

Terwyl jy GCP-dienste ondersoek het, het jy dalk sommige van hulle gevind wat elemente aan die internet blootstel (VM/Container-poorte, databasisse of wagdienste, oorsigfoto's of emmers...). As pentester/rooi span, moet jy altyd nagaan of jy sensitiewe inligting/kwesbaarhede daarop kan vind, aangesien dit jou verdere toegang tot die GCP-rekening kan bied.

In hierdie boek sal jy inligting vind oor hoe om blootgestelde GCP-dienste te vind en hoe om dit te ondersoek. Wat betref hoe om kwesbaarhede in blootgestelde netwerkdienste te vind, sal ek aanbeveel om te soek na die spesifieke diens in:

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace Pivoting

Die kompromittering van beginsels in een platform mag 'n aanvaller in staat stel om die ander een te kompromitteer. Kyk dit na:

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## Outomatiese Gereedskap

* In die **GCloud-konsole**, by [https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard) kan jy sien watter hulpbronne en IAM's deur die projek gebruik word.
* Hier kan jy die bates sien wat deur hierdie API ondersteun word: [https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* Kyk na **gereedskap** wat in verskeie wolke gebruik kan word [**hier**](../pentesting-cloud-methodology.md).
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner): Dit is 'n GCP-hulpbron-skanderer wat kan help om te bepaal watter vlak van toegang sekere geloofsbriewe op GCP besit.

```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```

* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): Bash-skrip om 'n GCP-omgewing te ondersoek deur gebruik te maak van die gcloud cli en die resultate in 'n l√™er te stoor.
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): Skripte om ho√´ IAM-voorregte te ondersoek en voorregte in GCP te verhoog deur misbruik daarvan (Ek kon nie die ondersoekskrip laat loop nie).

## gcloud-configurasie & foutopsporing

```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```

### Vang gcloud, gsutil... netwerk

Onthou dat jy die **parameter** **`--log-http`** kan gebruik met die **`gcloud`** cli om die **versoeke** wat die instrument uitvoer, te **druk**. As jy nie wil h√™ dat die logs die tokenwaarde verberg nie, gebruik `gcloud config set log_http_redact_token false`

Verder, om die kommunikasie te onderskep:

```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```

### OAuth-token konfigureer in gcloud

Om **'n uitgelekte diensrekening OAuth-token vanaf die metadata-eindpunt te gebruik**, kan jy net die volgende doen:

```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```

## Verwysings

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
