# GCP 渗透测试

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

**在开始渗透测试** **GCP** 环境之前，您需要了解一些**基础知识**，以帮助您理解需要做什么，如何找到配置错误以及如何利用它们。

诸如**组织**层次结构、**权限**和其他基本概念的解释在：

{% content-ref url="gcp-basic-information.md" %}
[gcp-basic-information.md](gcp-basic-information.md)
{% endcontent-ref %}

## 学习实验室

* [https://gcpgoat.joshuajebaraj.com/](https://gcpgoat.joshuajebaraj.com/)
* [https://github.com/ine-labs/GCPGoat](https://github.com/ine-labs/GCPGoat)
* [https://github.com/lacioffi/GCP-pentest-lab/](https://github.com/lacioffi/GCP-pentest-lab/)
* [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)

## GCP 渗透测试员/红队方法论

为了审计 GCP 环境，非常重要的是要知道：正在使用哪些**服务**，什么是**被暴露的**，谁可以**访问**什么，以及内部 GCP 服务和**外部服务**如何连接。

从红队的角度来看，**攻破 GCP 环境的第一步**是设法获得一些**凭据**。这里有一些想法告诉你如何做到这一点：

* **泄露**在 github（或类似的）- OSINT
* **社交**工程学（查看页面[**Workspace 安全**](../workspace-security/)）
* **密码**重用（密码泄露）
* 托管在 GCP 上的应用程序中的漏洞
* [**服务器端请求伪造**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)访问元数据端点
* **本地文件读取**
* `/home/USERNAME/.config/gcloud/*`
* `C:\Users\USERNAME\.config\gcloud\*`
* 第三方**被破坏**
* **内部**员工

或者通过**攻破一个未经认证的服务**暴露：

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

或者如果您正在进行**审查**，您可以直接**请求具有这些角色的凭据**：

{% content-ref url="gcp-permissions-for-a-pentest.md" %}
[gcp-permissions-for-a-pentest.md](gcp-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
在您设法获得凭据后，您需要知道**这些凭据属于谁**，以及**他们可以访问什么**，因此您需要进行一些基本的枚举：
{% endhint %}

## 基本枚举

### **SSRF**

有关如何**枚举 GCP 元数据**的更多信息，请查看以下 hacktricks 页面：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#6440" %}

### Whoami

在 GCP 中，您可以尝试几个选项来猜测您是谁：

{% code overflow="wrap" %}
```bash
#If you are inside a compromise machine
gcloud auth list
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=$(gcloud auth print-access-token)" https://www.googleapis.com/oauth2/v1/tokeninfo
gcloud auth print-identity-token #Get info from the token

#If you compromised a metadata token or somehow found an OAuth token
curl -H "Content-Type: application/x-www-form-urlencoded" -d "access_token=<token>" https://www.googleapis.com/oauth2/v1/tokeninfo
```
### 组织枚举
```bash
# Get organizations
gcloud organizations list #The DIRECTORY_CUSTOMER_ID is the Workspace ID
gcloud resource-manager folders list --organization <org_number> # Get folders
gcloud projects list # Get projects
```
### 主体和IAM枚举

如果您拥有足够的权限，**检查GCP账户内每个实体的权限**将帮助您了解您和其他身份可以做什么以及如何**提升权限**。

如果您没有足够的权限来枚举IAM，您可以**尝试暴力破解它们**来弄清楚。\
查看**如何进行枚举和暴力破解**：

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

{% hint style="info" %}
现在您**已经了解了一些关于您的凭据的信息**（如果您是红队成员，希望您**尚未被发现**）。是时候弄清楚环境中正在使用哪些服务了。\
在以下部分，您可以查看一些**枚举常见服务的方法。**
{% endhint %}

## 服务枚举

GCP拥有大量的服务，在以下页面您将找到**基本信息、枚举**秘籍，如何**避免被检测**，获得**持久性**，以及其他一些服务的**后期利用**技巧：

{% content-ref url="gcp-services/" %}
[gcp-services](gcp-services/)
{% endcontent-ref %}

请注意，您**不**需要**手动**完成所有工作，在本文下方您可以找到关于[**自动化工具**](./#automatic-tools)的**部分**。

此外，在这个阶段，您可能发现了**更多对未经认证的用户开放的服务**，您可能能够利用它们：

{% content-ref url="gcp-unaunthenticated-enum-and-access/" %}
[gcp-unaunthenticated-enum-and-access](gcp-unaunthenticated-enum-and-access/)
{% endcontent-ref %}

## 权限提升、后期利用和持久性

一旦您获得了一些云凭据或者已经入侵了云中运行的某些服务，最常见的方式就是**滥用被入侵账户可能拥有的错误配置的权限**。因此，您首先应该做的是枚举您的权限。

此外，在这次枚举中，请记住**权限也可以在最高级别的“组织”上设置**。

{% content-ref url="gcp-privilege-escalation/" %}
[gcp-privilege-escalation](gcp-privilege-escalation/)
{% endcontent-ref %}

{% content-ref url="gcp-post-exploitation/" %}
[gcp-post-exploitation](gcp-post-exploitation/)
{% endcontent-ref %}

{% content-ref url="gcp-persistence/" %}
[gcp-persistence](gcp-persistence/)
{% endcontent-ref %}

### 公开暴露的服务

在枚举GCP服务时，您可能发现了一些服务**向互联网暴露了元素**（VM/容器端口、数据库或队列服务、快照或存储桶...）。\
作为渗透测试人员/红队成员，您应该始终检查是否可以在它们上找到**敏感信息/漏洞**，因为它们可能为您提供**进一步访问AWS账户**的途径。

在本书中，您应该找到有关如何找到**暴露的GCP服务以及如何检查它们**的**信息**。关于如何在暴露的网络服务中找到**漏洞**，我建议您**搜索**特定的**服务**：

{% embed url="https://book.hacktricks.xyz/" %}

## GCP <--> Workspace 之间的转换

**入侵**一个平台上的主体可能允许攻击者**入侵另一个**，请查看：

{% content-ref url="gcp-to-workspace-pivoting/" %}
[gcp-to-workspace-pivoting](gcp-to-workspace-pivoting/)
{% endcontent-ref %}

## 自动化工具

* 在**GCloud控制台**，在[https://console.cloud.google.com/iam-admin/asset-inventory/dashboard](https://console.cloud.google.com/iam-admin/asset-inventory/dashboard)您可以看到项目正在使用的资源和IAM。
* 在这里您可以看到此API支持的资产：[https://cloud.google.com/asset-inventory/docs/supported-asset-types](https://cloud.google.com/asset-inventory/docs/supported-asset-types)
* 查看可以在[**几个云中使用的工具**](../pentesting-cloud-methodology.md)。
* [**gcp\_scanner**](https://github.com/google/gcp\_scanner)：这是一个GCP资源扫描器，可以帮助确定某些凭据在GCP上拥有**何种级别的访问权限**。
```bash
# Install
git clone https://github.com/google/gcp_scanner.git
cd gcp_scanner
virtualenv -p python3 venv
source venv/bin/activate
pip install -r requirements.txt
# Execute with gcloud creds
python3 __main__.py -o /tmp/output/ -g "$HOME/.config/gcloud"
```
* [**gcp\_enum**](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_enum): 使用 gcloud cli 枚举 GCP 环境的 Bash 脚本，并将结果保存在文件中。
* [**GCP-IAM-Privilege-Escalation**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation): 枚举 GCP 中高 IAM 权限的脚本，以及滥用这些权限在 GCP 中提升权限的脚本（我无法运行枚举脚本）。

## gcloud 配置 & 调试
```bash
# Login so gcloud can use your credentials
gcloud auth login
gcloud config set project security-devbox
gcloud auth print-access-token

# Login so SDKs can use your user credentials
gcloud auth application-default login
gcloud auth application-default set-quota-project security-devbox
gcloud auth application-default print-access-token

# Update gcloud
gcloud components update
```
### 捕获 gcloud、gsutil... 网络

记住，你可以在 **`gcloud`** cli中使用 **参数** **`--log-http`** 来**打印**工具正在执行的**请求**。如果你不想让日志编辑掉令牌值，请使用 `gcloud config set log_http_redact_token false`

此外，要拦截通信：
```bash
gcloud config set proxy/address 127.0.0.1
gcloud config set proxy/port 8080
gcloud config set proxy/type http
gcloud config set auth/disable_ssl_validation True

# If you don't want to completely disable ssl_validation use:
gcloud config set core/custom_ca_certs_file cert.pem

# Back to normal
gcloud config unset proxy/address
gcloud config unset proxy/port
gcloud config unset proxy/type
gcloud config unset auth/disable_ssl_validation
gcloud config unset core/custom_ca_certs_file
```
### 在 gcloud 中配置 OAuth 令牌

为了**使用从元数据端点泄露的服务账户 OAuth 令牌**，您可以执行以下操作：
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS hacking！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的hacking技巧。

</details>
