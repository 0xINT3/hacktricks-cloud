# GCP - ストレージ特権昇格

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## storage

### `storage.objects.get`

この権限を持つと、GCPストレージ内に保存されているファイルを**ダウンロード**することができます。これにより、いくつかの場合には**機密情報が保存されている可能性があるため、特権昇格が可能**になります。さらに、一部のGCPサービスは情報をバケットに保存しています。

* **GCP Composer**: Composer環境を作成すると、**すべてのDAGのコードがバケットに保存**されます。これらのタスクには、コード内に興味深い情報が含まれている場合があります。
* **GCR（コンテナレジストリ）**: コンテナの**イメージ**は**バケット**に保存されているため、バケットを読み取ることができれば、イメージをダウンロードして**情報の漏洩やソースコードの検索**が可能です。

### `storage.objects.create`、`storage.objects.delete`

バケット内に**新しいオブジェクトを作成**するには、`storage.objects.create`が必要であり、[ドキュメント](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions)によれば、既存のオブジェクトを**変更**するには`storage.objects.delete`も必要です。

クラウド内に書き込み可能なバケットを利用して、**ウェブサーバーファイルを保存**している場合、新しいコードを**保存**することができ、ウェブアプリケーションによって使用されます。

さらに、いくつかのGCPサービスは後で**バケット内にコードを保存**し、**実行**します。

* **GCP Composer**: DAGコードは**GCPストレージに保存**されます。このコードは後でComposerが使用するK8s環境内で**実行**され、GCP SAにも**アクセス**できます。したがって、このコードを変更すると、Composer K8s環境にアクセスし、使用されるGCP SAのトークンを盗むことができるかもしれません。
* **GCR（コンテナレジストリ）**: コンテナイメージはバケットに保存されます。したがって、それらのバケットに書き込みアクセス権がある場合、そのコンテナが使用されるたびに独自のコードを**変更**して実行することができます。
* GCRで使用されるバケットのURLは、`gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`のようになります（トップレベルのサブドメインは[ここ](https://cloud.google.com/container-registry/docs/pushing-and-pulling)で指定されています）。

### `storage.objects.setIamPolicy`

この権限を使用すると、このセクションの前述のシナリオを**悪用**することができます。

### **`storage.buckets.setIamPolicy`**

この権限を使用してアクセス権を変更する例については、次のページを参照してください。

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageの「相互運用性」という機能には、AWS S3など他のクラウドプロバイダのストレージとの連携方法が提供されています。その一環として、サービスアカウントと通常のユーザーの両方に作成できるHMACキーがあります。私たちは、より高い特権を持つサービスアカウントのためにHMACキーを作成することで、Cloud Storageの権限を**特権昇格**することができます。

ユーザーに属するHMACキーはAPIを介してアクセスできず、Webコンソールを介してアクセスする必要がありますが、アクセスキーとシークレットキーはいつでも利用可能です。これは、既存のペアを取得してアカウントへのバックアップアクセスを保存することができることを意味します。サービスアカウントに属するHMACキーはAPIを介してアクセスできますが、作成後はアクセスキーとシークレットキーを再度表示することはできません。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-1.png)

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)で見つけることができます。

## storage.objects Write権限

バケット内のオブジェクトを変更または追加できる場合、バケットを使用してコードを実行する他のリソースへの特権昇格が可能です。

### Composer

**Composer**は、GCP内で管理される**Apache Airflow**です。いくつかの興味深い機能があります。

* **GKEクラスター**内で実行されるため、Composerが実行するコードからアクセスできる**SA**をクラスターが使用しています。
* コードは**バケットに保存**されるため、コードを変更または追加する権限を持つ**バケットにアクセス**できれば、DGAコード（Apache Airflowが実行するコード）を変更または追加できます。\
したがって、コードを保存するためにComposerが使用しているバケットに**書き込みアクセス権**がある場合、GKEクラスターで実行されているSAに特権昇格することができます。

### Cloud Functions

* Cloud Functionsのコードはストレージに保存されているため、**上書き**することで任意のコードを実行することが可能です。

### App Engine

* App Engine
