# GCP - √âl√©vation de privil√®ges dans le stockage

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Stockage

Informations de base :

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Cette permission vous permet de **t√©l√©charger des fichiers stock√©s dans Cloud Storage**. Cela peut potentiellement vous permettre d'augmenter vos privil√®ges car dans certains cas, **des informations sensibles sont sauvegard√©es l√†**. De plus, certains services GCP stockent leurs informations dans des seaux :

* **GCP Composer** : Lorsque vous cr√©ez un environnement Composer, **le code de tous les DAGs** sera sauvegard√© dans un **seau**. Ces t√¢ches peuvent contenir des informations int√©ressantes dans leur code.
* **GCR (Container Registry)** : **L'image** des conteneurs est stock√©e dans **des seaux**, ce qui signifie que si vous pouvez lire les seaux, vous pourrez t√©l√©charger les images et **rechercher des fuites et/ou du code source**.

### `storage.objects.setIamPolicy`

Vous pouvez vous donner la permission d'**abuser de n'importe quel sc√©nario pr√©c√©dent de cette section**.

### **`storage.buckets.setIamPolicy`**

Pour un exemple de modification des permissions avec cette permission, consultez cette page :

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Il existe une fonctionnalit√© de Cloud Storage, "l'interop√©rabilit√©", qui fournit un moyen pour Cloud Storage d'interagir avec les offres de stockage d'autres fournisseurs de cloud, comme AWS S3. Dans ce cadre, il existe des cl√©s HMAC qui peuvent √™tre cr√©√©es pour les comptes de service et les utilisateurs r√©guliers. Nous pouvons **augmenter les permissions de Cloud Storage en cr√©ant une cl√© HMAC pour un compte de service plus privil√©gi√©**.

Les cl√©s HMAC appartenant √† votre utilisateur ne peuvent pas √™tre acc√©d√©es via l'API et doivent √™tre acc√©d√©es via la console web, mais l'avantage est que la cl√© d'acc√®s et la cl√© secr√®te sont disponibles √† tout moment. Cela signifie que nous pourrions prendre une paire existante et les stocker pour un acc√®s de secours au compte. Les cl√©s HMAC appartenant aux comptes de service **peuvent** √™tre acc√©d√©es via l'API, mais apr√®s la cr√©ation, vous ne pouvez plus voir la cl√© d'acc√®s et la cl√© secr√®te.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Un autre script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permissions d'√©criture sur le stockage

Pour **cr√©er un nouvel objet** dans un bucket, vous avez besoin de `storage.objects.create` et, selon [la documentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), vous avez √©galement besoin de `storage.objects.delete` pour **modifier** un objet existant.

Une **exploitation tr√®s courante** des buckets o√π vous pouvez √©crire dans le cloud est dans le cas o√π **le bucket sauvegarde des fichiers de serveur web**, vous pourriez √™tre capable de **stocker du nouveau code** qui sera utilis√© par l'application web.

### Composer

**Composer** est **Apache Airflow** g√©r√© dans GCP. Il pr√©sente plusieurs caract√©ristiques int√©ressantes :

* Il fonctionne √† l'int√©rieur d'un **cluster GKE**, donc le **SA utilis√© par le cluster est accessible** par le code ex√©cut√© √† l'int√©rieur de Composer
* Il stocke le **code dans un bucket**, donc, **toute personne ayant un acc√®s en √©criture sur ce bucket** va pouvoir changer/ajouter un code DGA (le code qu'Apache Airflow ex√©cutera)\
Alors, si vous avez **un acc√®s en √©criture sur le bucket utilis√© par Composer** pour stocker le code, vous pouvez **privesc au SA ex√©cut√© dans le cluster GKE**.

### Cloud Functions

* Le code des Cloud Functions est stock√© dans Storage, donc **le r√©√©crire permet d'ex√©cuter du code arbitraire**.

### App Engine

* Le code source de App Engine est stock√© dans des buckets, **r√©√©crire le code pourrait permettre d'ex√©cuter du code arbitraire.**

### GCR

* **Google Container Registry** stocke les images dans des buckets, si vous pouvez **√©crire dans ces buckets**, vous pourriez √™tre capable de **vous d√©placer lat√©ralement l√† o√π ces buckets sont ex√©cut√©s.**
* Le bucket utilis√© par GCR aura une URL similaire √† `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Les sous-domaines de premier niveau sont sp√©cifi√©s [ici](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **R√©f√©rences**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
