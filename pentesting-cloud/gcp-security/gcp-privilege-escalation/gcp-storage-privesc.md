# GCP - Escalación de Privilegios en Almacenamiento

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Almacenamiento

Información Básica:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Este permiso te permite **descargar archivos almacenados dentro de Cloud Storage**. Esto podría permitirte escalar privilegios porque en algunas ocasiones **se guarda información sensible allí**. Además, algunos servicios de GCP almacenan su información en buckets:

* **GCP Composer**: Cuando creas un Entorno de Composer, el **código de todos los DAGs** se guardará dentro de un **bucket**. Estas tareas pueden contener información interesante en su código.
* **GCR (Container Registry)**: La **imagen** de los contenedores se almacena dentro de **buckets**, lo que significa que si puedes leer los buckets podrás descargar las imágenes y **buscar fugas y/o código fuente**.

### `storage.objects.setIamPolicy`

Puedes darte permiso para **abusar de cualquiera de los escenarios anteriores de esta sección**.

### **`storage.buckets.setIamPolicy`**

Para un ejemplo de cómo modificar permisos con este permiso, consulta esta página:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Hay una característica de Cloud Storage, "interoperabilidad", que proporciona una forma para que Cloud Storage interactúe con ofertas de almacenamiento de otros proveedores de la nube, como AWS S3. Como parte de eso, se pueden crear claves HMAC tanto para Cuentas de Servicio como para usuarios regulares. Podemos **escalar los permisos de Cloud Storage creando una clave HMAC para una Cuenta de Servicio con mayores privilegios**.

Las claves HMAC pertenecientes a tu usuario no se pueden acceder a través de la API y deben ser accedidas a través de la consola web, pero lo bueno es que tanto la clave de acceso como la clave secreta están disponibles en cualquier momento. Esto significa que podríamos tomar un par existente y almacenarlos para acceso de respaldo a la cuenta. Las claves HMAC pertenecientes a Cuentas de Servicio **pueden** ser accedidas a través de la API, pero después de la creación, no podrás ver la clave de acceso y el secreto nuevamente.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Otro script de explotación para este método se puede encontrar [aquí](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permisos de escritura en Storage

Para **crear un nuevo objeto** dentro de un bucket necesitas `storage.objects.create` y, según [la documentación](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), también necesitas `storage.objects.delete` para **modificar** un objeto existente.

Una **explotación muy común** de buckets donde puedes escribir en la nube es en caso de que el **bucket esté guardando archivos de un servidor web**, podrías ser capaz de **almacenar nuevo código** que será utilizado por la aplicación web.

### Composer

**Composer** es **Apache Airflow** gestionado dentro de GCP. Tiene varias características interesantes:

* Se ejecuta dentro de un **cluster de GKE**, por lo que el **SA que utiliza el cluster es accesible** por el código que se ejecuta dentro de Composer
* Almacena el **código en un bucket**, por lo tanto, **cualquiera con acceso de escritura sobre ese bucket** va a poder cambiar/agregar un código DGA (el código que Apache Airflow ejecutará)\
Entonces, si tienes **acceso de escritura sobre el bucket que Composer está usando** para almacenar el código, puedes **escalar privilegios al SA que se ejecuta en el cluster de GKE**.

### Cloud Functions

* El código de Cloud Functions se almacena en Storage, por lo que **sobrescribirlo, es posible ejecutar código arbitrario**.

### App Engine

* El código fuente de App Engine se almacena en buckets, **sobrescribir el código podría hacer posible ejecutar código arbitrario. ESTO NO ES POSIBLE**
* **Parece que las capas del contenedor se almacenan en el bucket, ¿tal vez cambiando esas?**

### GCR

* **Google Container Registry** almacena las imágenes dentro de buckets, si puedes **escribir esos buckets** podrías ser capaz de **moverte lateralmente a donde esos buckets se están ejecutando.**
* El bucket utilizado por GCR tendrá una URL similar a `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Los subdominios de nivel superior están especificados [aquí](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Referencias**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
