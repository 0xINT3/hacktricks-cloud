# GCP - Escala√ß√£o de Privil√©gios em Armazenamento

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## armazenamento

### `storage.objects.get`

Essa permiss√£o permite que voc√™ **baixe arquivos armazenados no Gcp Storage**. Isso pode permitir que voc√™ **eleve privil√©gios** porque, em algumas ocasi√µes, **informa√ß√µes confidenciais s√£o salvas l√°**. Al√©m disso, alguns servi√ßos do Gcp armazenam suas informa√ß√µes em buckets:

* **GCP Composer**: Quando voc√™ cria um ambiente do Composer, o **c√≥digo de todos os DAGs** ser√° salvo em um **bucket**. Essas tarefas podem conter informa√ß√µes interessantes dentro de seu c√≥digo.
* **GCR (Container Registry)**: A **imagem** dos cont√™ineres √© armazenada em **buckets**, o que significa que, se voc√™ puder ler os buckets, poder√° baixar as imagens e **procurar vazamentos e/ou c√≥digo-fonte**.

### `storage.objects.create`, `storage.objects.delete`

Para **criar um novo objeto** dentro de um bucket, voc√™ precisa de `storage.objects.create` e, de acordo com [a documenta√ß√£o](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), voc√™ tamb√©m precisa de `storage.objects.delete` para **modificar** um objeto existente.

Uma **explora√ß√£o muito comum** de buckets onde voc√™ pode escrever na nuvem √© no caso em que o **bucket est√° salvando arquivos do servidor da web**, voc√™ pode ser capaz de **armazenar novo c√≥digo** que ser√° usado pela aplica√ß√£o web.

Al√©m disso, v√°rios servi√ßos do GCP tamb√©m **armazenam c√≥digo em buckets** que posteriormente √© **executado**:

* **GCP Composer**: O **c√≥digo DAG** √© **armazenado no GCP Storage**. Este **c√≥digo** √© posteriormente **executado** dentro do **ambiente K8s** usado pelo composer e tamb√©m tem **acesso a um GCP SA**. Portanto, modificando este c√≥digo, voc√™ pode ser capaz de entrar no ambiente k8s do composer e roubar o token do GCP SA usado.
* **GCR (Container Registry)**: As **imagens de cont√™iner s√£o armazenadas em buckets**. Portanto, se voc√™ tiver acesso de grava√ß√£o sobre eles, poder√° **modificar as imagens** e executar seu pr√≥prio c√≥digo sempre que esse cont√™iner for usado.
  * O bucket usado pelo GCR ter√° uma URL semelhante a `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Os subdom√≠nios de n√≠vel superior s√£o especificados [aqui](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

### `storage.objects.setIamPolicy`

Voc√™ pode dar permiss√£o para **abuso de qualquer um dos cen√°rios anteriores desta se√ß√£o**.

### **`storage.buckets.setIamPolicy`**

Para um exemplo de como modificar permiss√µes com essa permiss√£o, verifique esta p√°gina:

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Existe um recurso do Cloud Storage, "interoperabilidade", que fornece uma maneira para o Cloud Storage interagir com ofertas de armazenamento de outros provedores de nuvem, como o AWS S3. Como parte disso, existem chaves HMAC que podem ser criadas tanto para Contas de Servi√ßo quanto para usu√°rios regulares. Podemos **elevar as permiss√µes do Cloud Storage criando uma chave HMAC para uma Conta de Servi√ßo com privil√©gios mais elevados**.

As chaves HMAC pertencentes ao seu usu√°rio n√£o podem ser acessadas por meio da API e devem ser acessadas por meio do console da web, mas o que √© bom √© que tanto a chave de acesso quanto a chave secreta est√£o dispon√≠veis a qualquer momento. Isso significa que poder√≠amos pegar um par existente e armazen√°-los para acesso de backup √† conta. As chaves HMAC pertencentes a Contas de Servi√ßo **podem** ser acessadas por meio da API, mas ap√≥s a cria√ß√£o, voc√™ n√£o pode ver a chave de acesso e o segredo novamente.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-1.png)

O script de explora√ß√£o para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## Permiss√£o de escrita de objetos de armazenamento

Se voc√™ puder modificar ou adicionar objetos em buckets, poder√° elevar seus privil√©gios para outros recursos que est√£o usando o bucket para armazenar c√≥digo que eles executam.

### Composer

**Composer** √© **Apache Airflow** gerenciado dentro do GCP. Tem v√°rios recursos interessantes:

* Ele √© executado dentro de um **cluster GKE**, portanto, o **SA que o cluster usa √© acess√≠vel** pelo c√≥digo em execu√ß√£o dentro do Composer.
* Ele armazena o **c√≥digo em um bucket**, portanto, **qualquer pessoa com acesso de grava√ß√£o sobre esse bucket** poder√° alterar/adicionar um c√≥digo DGA (o c√≥digo que o Apache Airflow executar√°). Ent√£o, se voc√™ tiver **acesso de grava√ß√£o sobre o bucket que o Composer est√° usando** para armazenar o c√≥digo, poder√° **elevar privil√©gios para o SA em execu√ß√£o no cluster GKE**.

### Fun√ß√µes em nuvem

* O c√≥digo das Fun√ß√µes em Nuvem √© armazenado no Armazenamento, portanto, **sobrescrev√™-lo, √© poss√≠vel executar c√≥digo arbitr√°rio**.

### App Engine

* O c√≥digo-fonte do App Engine √© armazenado em buckets, **sobrescrevendo o c√≥digo, seria poss√≠vel executar c√≥digo arbitr√°rio**.

### GCR

* O **Google Container Registry** armazena as imagens dentro de buckets, se voc√™ puder **escrever nesses buckets**, poder√° **mover lateralmente para onde esses buckets est√£o sendo executados**.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>