# GCP - Depolama Privilege Yükseltme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>

## Depolama

Temel Bilgiler:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Bu izin, Cloud Storage içinde depolanan dosyaları **indirmenize** olanak sağlar. Bu, bazı durumlarda **duyarlı bilgilerin kaydedildiği** için ayrıcalıkları yükseltmenize olanak sağlayabilir. Ayrıca, bazı GCP hizmetleri bilgilerini kovalara kaydeder:

* **GCP Composer**: Bir Composer Ortamı oluşturduğunuzda, **tüm DAG'ların kodu** bir **kova** içinde kaydedilir. Bu görevlerin kodlarının içinde ilginç bilgiler olabilir.
* **GCR (Container Registry)**: Konteynerlerin **görüntüleri** kovalarda saklanır, bu da kovaları okuyabiliyorsanız görüntüleri indirebileceğiniz ve **sızıntıları ve/veya kaynak kodunu arayabileceğiniz** anlamına gelir.

### `storage.objects.setIamPolicy`

Bu izin, bu bölümün önceki senaryolarından herhangi birini **kötüye kullanmanıza** olanak sağlar.

### **`storage.buckets.setIamPolicy`**

Bu izinle izinleri nasıl değiştireceğinize dair bir örnek için bu sayfaya bakın:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storage'ın AWS S3 gibi **çapraz bulut etkileşimleri** için tasarlanmış "uyumluluk" özelliği, **Hizmet Hesapları ve kullanıcılar için HMAC anahtarlarının oluşturulmasını** içerir. Bir saldırgan, **yüksek ayrıcalıklara sahip bir Hizmet Hesabı için HMAC anahtarı oluşturarak** bunu istismar edebilir, böylece Cloud Storage içindeki ayrıcalıkları **yükseltebilir**. Kullanıcıya bağlı HMAC anahtarları yalnızca web konsolu aracılığıyla alınabilirken, erişim ve gizli anahtarlar **sürekli olarak erişilebilir** kalır ve potansiyel yedek erişim depolama için kullanılabilir. Öte yandan, Hizmet Hesabıyla ilişkilendirilmiş HMAC anahtarları API erişimine açıktır, ancak erişim ve gizli anahtarlar oluşturulduktan sonra alınamaz, bu da sürekli erişim için bir karmaşıklık katmanı ekler.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Bu yöntem için başka bir exploit scripti [burada](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py) bulunabilir.

## `storage.objects.create`, `storage.objects.delete` = Depolama Yazma izinleri

Bir kovaya yeni bir nesne oluşturmak için `storage.objects.create` iznine ihtiyacınız vardır ve [belgelere](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions) göre, mevcut bir nesneyi **değiştirmek** için de `storage.objects.delete` iznine ihtiyacınız vardır.

Bulutta yazma yetkisine sahip olduğunuz kovaların yaygın olarak sömürüldüğü bir durum, kovanın **web sunucusu dosyalarını kaydettiği** durumdur. Bu durumda, web uygulaması tarafından kullanılacak olan **yeni bir kodu depolayabilirsiniz**.

### Composer

**Composer**, GCP içinde yönetilen **Apache Airflow**'dur. Birkaç ilginç özelliği vardır:

* Bir **GKE kümesi içinde çalışır**, bu nedenle Composer içinde çalışan kod tarafından erişilebilen **SA kümenin kullandığıdır**.
* Kodu bir kovada saklar, bu nedenle, kodu değiştirme/ekleme yetkisine sahip olan herkes, bir DGA kodu (Apache Airflow tarafından yürütülecek olan kod) değiştirebilecektir.\
Bu durumda, kodu depolamak için Composer'ın kullandığı kovada yazma yetkisine sahipseniz, GKE kümesinde çalışan SA'ya **privilege escalation** yapabilirsiniz.

### Cloud Functions

* Cloud Functions kodu Depolama'da saklanır, bu nedenle onu üzerine yazarak keyfi kodu yürütmek mümkündür.

### App Engine

* App Engine kaynak kodu kovalarda saklanır, kodu üzerine yazarak keyfi kodu yürütmek mümkün olabilir. BU MÜMKÜN DEĞİLDİR.
* **Muhtemelen konteyner katmanları kovada saklanır, belki onları değiştirerek?**

### GCR

* **Google Container Registry**, görüntüleri kovalarda saklar, bu kovalara **yazabilirseniz**, bu kovaların çalıştırıldığı yere yanal hareket edebilirsiniz.
* GCR tarafından kullanılan kova, `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` gibi bir URL'ye sahip olacaktır (Üst düzey alt alan adları [burada](https://cloud.google.com/container-registry/docs/pushing-and-pulling) belirtilmiştir).

## **Referanslar**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin!</summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud github depolarına PR göndererek paylaşın.**

</details>
