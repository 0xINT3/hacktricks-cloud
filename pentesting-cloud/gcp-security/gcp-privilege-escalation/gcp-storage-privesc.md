# GCP - ストレージ権限昇格

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## storage

### `storage.objects.get`

この権限は、**Gcp Storage内に保存されているファイルをダウンロードする**ことを可能にします。これにより、**機密情報がそこに保存されている場合**に権限昇格が可能になることがあります。さらに、いくつかのGcpサービスは情報をバケットに保存します:

* **GCP Composer**: Composer環境を作成すると、**すべてのDAGのコード**が**バケット**内に保存されます。これらのタスクには、コード内に興味深い情報が含まれている可能性があります。
* **GCR (Container Registry)**: コンテナの**イメージ**は**バケット**内に保存されており、バケットを読むことができれば、イメージをダウンロードして**リークやソースコードを探す**ことができます。

### `storage.objects.create`, `storage.objects.delete`

バケット内に**新しいオブジェクトを作成する**ためには`storage.objects.create`が必要であり、[ドキュメント](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions)によると、既存のオブジェクトを**変更する**ためには`storage.objects.delete`も必要です。

クラウド内で書き込み可能なバケットの**一般的な悪用**は、**バケットがWebサーバーのファイルを保存している**場合で、Webアプリケーションが使用する**新しいコードを保存**することができるかもしれません。

さらに、いくつかのGCPサービスも**バケット内にコードを保存**し、後で**実行**します:

* **GCP Composer**: **DAGコード**は**GCP Storage内に保存**されます。この**コード**は後で**K8s環境**内で**実行**され、**GCP SA**にも**アクセス**します。したがって、このコードを変更することで、composer k8s環境に侵入し、使用されているGCP SAのトークンを盗むことができるかもしれません。
* **GCR (Container Registry)**: **コンテナイメージはバケット内に保存**されています。したがって、それらに対する書き込み権限があれば、そのコンテナが使用されるたびに自分のコードを**変更して実行する**ことができます。
* GCRが使用するバケットのURLは`gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`のようになります（トップレベルのサブドメインは[こちら](https://cloud.google.com/container-registry/docs/pushing-and-pulling)で指定されています）。

### `storage.objects.setIamPolicy`

このセクションの前のシナリオを**悪用する**ための権限を自分に与えることができます。

### **`storage.buckets.setIamPolicy`**

この権限でどのように権限を変更するかの例については、このページをチェックしてください:

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageには、「相互運用性」という機能があり、他のクラウドプロバイダーのストレージオファリング、例えばAWS S3とCloud Storageが相互に作用する方法を提供します。その一環として、サービスアカウントと通常のユーザーの両方に対して作成できるHMACキーがあります。**より高い権限を持つサービスアカウントのHMACキーを作成することで、Cloud Storageの権限を昇格させる**ことができます。

ユーザーに属するHMACキーはAPIを通じてアクセスできず、ウェブコンソールを通じてのみアクセスする必要がありますが、アクセスキーとシークレットキーはいつでも利用可能です。これは、既存のペアを取得して、アカウントへのバックアップアクセス用に保存することができることを意味します。サービスアカウントに属するHMACキーはAPIを通じてアクセスできますが、作成後はアクセスキーとシークレットを再度見ることはできません。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-1.png)

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)で見つけることができます。

## storage.objects 書き込み権限

バケット内のオブジェクトを変更または追加できる場合、バケットを使用して実行するコードを保存している他のリソースに対する権限を昇格させることができるかもしれません。

### Composer

**Composer**はGCP内で管理されている**Apache Airflow**です。いくつかの興味深い特徴があります:

* **GKEクラスター**内で実行されるため、クラスターが使用する**SAはComposer内で実行されるコードによってアクセス可能**です
* **コードはバケットに保存される**ため、そのバケットに対する書き込み権限を持つ**誰でも**DGAコード（Apache Airflowが実行するコード）を変更/追加することができます\
したがって、Composerがコードを保存するために使用しているバケットに対する**書き込み権限がある場合**、GKEクラスターで実行されているSAに**権限昇格**することができます。

### Cloud Functions

* Cloud FunctionsのコードはStorageに保存されているため、**それを上書きすることで任意のコードを実行することが可能です**。

### App Engine

* App Engineのソースコードはバケットに保存されているため、**コードを上書きすることで任意のコードを実行する可能性があります**

### GCR

* **Google Container Registry**はイメージをバケット内に保存しており、それらのバケットに**書き込むことができれば**、それらのバケットが実行されている場所に**横移動する**ことができるかもしれません。

## **参考文献**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
