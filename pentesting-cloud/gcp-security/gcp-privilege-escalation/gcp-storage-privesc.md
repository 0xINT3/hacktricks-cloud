# GCP - √âl√©vation de privil√®ges dans Storage

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Storage

Informations de base :

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Cette permission vous permet de **t√©l√©charger des fichiers stock√©s dans Cloud Storage**. Cela peut potentiellement vous permettre d'escalader les privil√®ges car dans certains cas, **des informations sensibles y sont enregistr√©es**. De plus, certains services GCP stockent leurs informations dans des buckets :

* **GCP Composer** : Lorsque vous cr√©ez un environnement Composer, **le code de tous les DAGs** sera sauvegard√© dans un **bucket**. Ces t√¢ches peuvent contenir des informations int√©ressantes dans leur code.
* **GCR (Container Registry)** : **L'image** des conteneurs est stock√©e dans **des buckets**, ce qui signifie que si vous pouvez lire les buckets, vous pourrez t√©l√©charger les images et **rechercher des fuites et/ou du code source**.

### `storage.objects.setIamPolicy`

Vous pouvez vous donner la permission d'**abuser de n'importe quel sc√©nario pr√©c√©dent de cette section**.

### **`storage.buckets.setIamPolicy`**

Pour un exemple de modification des permissions avec cette permission, consultez cette page :

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

La fonctionnalit√© "interop√©rabilit√©" de Cloud Storage, con√ßue pour les **interactions entre diff√©rents clouds** comme avec AWS S3, implique la **cr√©ation de cl√©s HMAC pour les comptes de service et les utilisateurs**. Un attaquant peut exploiter cela en **g√©n√©rant une cl√© HMAC pour un compte de service avec des privil√®ges √©lev√©s**, permettant ainsi une **√©l√©vation de privil√®ges au sein de Cloud Storage**. Alors que les cl√©s HMAC associ√©es aux utilisateurs ne sont r√©cup√©rables que via la console web, les cl√©s d'acc√®s et secr√®tes restent **toujours accessibles**, permettant un acc√®s potentiel au stockage de sauvegarde. En revanche, les cl√©s HMAC li√©es aux comptes de service sont accessibles via l'API, mais leurs cl√©s d'acc√®s et secr√®tes ne sont pas r√©cup√©rables apr√®s la cr√©ation, ajoutant une couche de complexit√© pour un acc√®s continu.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Un autre script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Permissions d'√©criture sur le stockage

Pour **cr√©er un nouvel objet** dans un compartiment, vous avez besoin de `storage.objects.create` et, selon [la documentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), vous avez √©galement besoin de `storage.objects.delete` pour **modifier** un objet existant.

Une **exploitation tr√®s courante** des compartiments o√π vous pouvez √©crire dans le cloud est dans le cas o√π **le compartiment sauvegarde des fichiers de serveur web**, vous pourriez √™tre capable de **stocker du nouveau code** qui sera utilis√© par l'application web.

### Composer

**Composer** est **Apache Airflow** g√©r√© √† l'int√©rieur de GCP. Il pr√©sente plusieurs caract√©ristiques int√©ressantes :

* Il fonctionne √† l'int√©rieur d'un **cluster GKE**, donc le **SA que le cluster utilise est accessible** par le code ex√©cut√© √† l'int√©rieur de Composer
* Il stocke le **code dans un compartiment**, donc, **toute personne ayant un acc√®s en √©criture sur ce compartiment** va pouvoir changer/ajouter un code DGA (le code qu'Apache Airflow ex√©cutera)\
Alors, si vous avez **un acc√®s en √©criture sur le compartiment que Composer utilise** pour stocker le code, vous pouvez **privesc au SA ex√©cut√© dans le cluster GKE**.

### Cloud Functions

* Le code des Cloud Functions est stock√© dans Storage, donc **le r√©√©crire permet de potentiellement ex√©cuter du code arbitraire**.

### App Engine

* Le code source de App Engine est stock√© dans des compartiments, **r√©√©crire le code pourrait permettre d'ex√©cuter du code arbitraire. CECI N'EST PAS POSSIBLE**
* **Il semble que les couches de conteneurs soient stock√©es dans le compartiment, peut-√™tre les changer ?**

### GCR

* **Google Container Registry** stocke les images √† l'int√©rieur de compartiments, si vous pouvez **√©crire dans ces compartiments** vous pourriez √™tre capable de **vous d√©placer lat√©ralement l√† o√π ces compartiments sont ex√©cut√©s.**
* Le compartiment utilis√© par GCR aura une URL similaire √† `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Les sous-domaines de premier niveau sont sp√©cifi√©s [ici](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **R√©f√©rences**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
