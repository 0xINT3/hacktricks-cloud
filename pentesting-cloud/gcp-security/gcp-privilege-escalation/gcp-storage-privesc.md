# GCP - ストレージ権限昇格

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングテクニックを共有する。

</details>

## ストレージ

基本情報:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

この権限により、**Cloud Storage内に保存されているファイルをダウンロード**できます。これにより、**機密情報が保存されている場合**に権限を昇格させる可能性があります。さらに、いくつかのGCPサービスはバケット内に情報を保存します：

* **GCP Composer**: Composer環境を作成すると、**すべてのDAGのコード**が**バケット**内に保存されます。これらのタスクには、コード内に興味深い情報が含まれている可能性があります。
* **GCR (Container Registry)**: コンテナの**イメージ**は**バケット**内に保存されており、バケットを読むことができれば、イメージをダウンロードして**リークやソースコードを探す**ことができます。

### `storage.objects.setIamPolicy`

このセクションの前のシナリオを**悪用するための権限**を自分に与えることができます。

### **`storage.buckets.setIamPolicy`**

この権限で権限を変更する例については、このページを確認してください：

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Cloud Storageには、「相互運用性」という機能があり、他のクラウドプロバイダーのストレージオファリング、例えばAWS S3との相互作用を可能にします。その一環として、サービスアカウントと通常のユーザーの両方に対してHMACキーを作成することができます。**より高い権限を持つサービスアカウントのHMACキーを作成することで、Cloud Storageの権限を昇格させる**ことができます。

ユーザーに属するHMACキーはAPIを通じてアクセスできず、ウェブコンソールを通じてアクセスする必要がありますが、アクセスキーとシークレットキーはいつでも利用可能です。これは、既存のペアを取り、アカウントへのバックアップアクセス用に保存することができることを意味します。サービスアカウントに属するHMACキーはAPIを通じてアクセスできますが、作成後はアクセスキーとシークレットを再度見ることはできません。
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
この方法の別のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py)で見つけることができます。

## `storage.objects.create`, `storage.objects.delete` = ストレージ書き込み権限

バケット内に**新しいオブジェクトを作成する**ためには`storage.objects.create`が必要であり、[ドキュメント](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions)によると、既存のオブジェクトを**変更する**ためには`storage.objects.delete`も必要です。

クラウド内で書き込み可能なバケットの**一般的な悪用**は、**バケットがウェブサーバーのファイルを保存している**場合で、ウェブアプリケーションによって使用される**新しいコードを保存**することができるかもしれません。

### Composer

**Composer**はGCP内で管理されている**Apache Airflow**です。いくつかの興味深い特徴があります：

* **GKEクラスター**内で実行されるため、Composer内で実行されるコードによって**クラスターが使用するSAにアクセス可能です**
* **コードをバケットに保存する**ため、そのバケットに対する書き込み権限を持つ**任意の人**がDGAコード（Apache Airflowが実行するコード）を変更/追加することができます。
そのため、Composerがコードを保存するために使用しているバケットに対する**書き込み権限がある場合**、GKEクラスターで実行中のSAに**権限昇格**することができます。

### Cloud Functions

* Cloud FunctionsのコードはStorageに保存されているため、**それを上書きすることで任意のコードを実行することが可能です**。

### App Engine

* App Engineのソースコードはバケットに保存されており、**コードを上書きすることで任意のコードを実行する可能性があります。これは不可能です**
* **コンテナレイヤーがバケットに保存されているようですが、これらを変更するかもしれません？**

### GCR

* **Google Container Registry**はイメージをバケット内に保存しており、それらのバケットに**書き込むことができれば**、それらのバケットが実行されている場所に**横断的に移動する**ことができるかもしれません。
* GCRが使用するバケットのURLは`gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com`のようになります（トップレベルのサブドメインは[こちら](https://cloud.google.com/container-registry/docs/pushing-and-pulling)で指定されています）。

## **参考文献**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
