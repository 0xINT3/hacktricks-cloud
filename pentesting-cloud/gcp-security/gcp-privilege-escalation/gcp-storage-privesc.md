# GCP - Escalada de privilegios de almacenamiento

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## almacenamiento

### `storage.objects.get`

Este permiso te permite **descargar archivos almacenados dentro de Gcp Storage**. Esto potencialmente te permitir√° escalar privilegios porque en algunas ocasiones **informaci√≥n sensible se guarda all√≠**. Adem√°s, algunos servicios de Gcp almacenan su informaci√≥n en buckets:

* **GCP Composer**: Cuando creas un entorno de Composer, el **c√≥digo de todos los DAG** se guardar√° dentro de un **bucket**. Estas tareas pueden contener informaci√≥n interesante dentro de su c√≥digo.
* **GCR (Container Registry)**: La **imagen** de los contenedores se almacena en **buckets**, lo que significa que si puedes leer los buckets, podr√°s descargar las im√°genes y **buscar fugas y/o c√≥digo fuente**.

### `storage.objects.create`, `storage.objects.delete`

Para **crear un nuevo objeto** dentro de un bucket necesitas `storage.objects.create` y, seg√∫n [la documentaci√≥n](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), tambi√©n necesitas `storage.objects.delete` para **modificar** un objeto existente.

Una **explotaci√≥n muy com√∫n** de los buckets donde puedes escribir en la nube es en caso de que el **bucket est√© guardando archivos del servidor web**, podr√≠as ser capaz de **almacenar nuevo c√≥digo** que ser√° utilizado por la aplicaci√≥n web.

Adem√°s, varios servicios de GCP tambi√©n **almacenan c√≥digo dentro de los buckets** que luego es **ejecutado**:

* **GCP Composer**: El **c√≥digo DAG** se **almacena en GCP Storage**. Este **c√≥digo** se ejecuta m√°s tarde dentro del **entorno K8s** utilizado por el compositor, y tambi√©n tiene **acceso a un GCP SA**. Por lo tanto, modificando este c√≥digo podr√≠as ser capaz de entrar en el entorno k8s del compositor y robar el token del GCP SA utilizado.
* **GCR (Container Registry)**: Las **im√°genes de los contenedores se almacenan dentro de los buckets**. As√≠ que si tienes acceso de escritura sobre ellos, podr√≠as **modificar las im√°genes** y ejecutar tu propio c√≥digo cada vez que se use ese contenedor.
  * El bucket utilizado por GCR tendr√° una URL similar a `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Los subdominios de nivel superior se especifican [aqu√≠](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

### `storage.objects.setIamPolicy`

Puedes darte permiso para **abusar de cualquiera de los escenarios anteriores de esta secci√≥n**.

### **`storage.buckets.setIamPolicy`**

Para un ejemplo de c√≥mo modificar permisos con este permiso, consulta esta p√°gina:

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Hay una caracter√≠stica de Cloud Storage, "interoperabilidad", que proporciona una forma para que Cloud Storage interact√∫e con ofertas de almacenamiento de otros proveedores de la nube, como AWS S3. Como parte de eso, hay claves HMAC que se pueden crear tanto para cuentas de servicio como para usuarios regulares. Podemos **escalar los permisos de Cloud Storage creando una clave HMAC para una cuenta de servicio de mayor privilegio**.

Las claves HMAC que pertenecen a tu usuario no se pueden acceder a trav√©s de la API y deben ser accedidas a trav√©s de la consola web, pero lo bueno es que tanto la clave de acceso como la clave secreta est√°n disponibles en cualquier momento. Esto significa que podr√≠amos tomar un par existente y almacenarlo para acceder de respaldo a la cuenta. Las claves HMAC que pertenecen a las cuentas de servicio **pueden** ser accedidas a trav√©s de la API, pero despu√©s de la creaci√≥n, no puedes ver la clave de acceso y la clave secreta de nuevo.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-1.png)

El script de explotaci√≥n para este m√©todo se puede encontrar [aqu√≠](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## Permiso de escritura de objetos de almacenamiento

Si puedes modificar o agregar objetos en buckets, podr√≠as ser capaz de escalar tus privilegios a otros recursos que est√°n utilizando el bucket para almacenar c√≥digo que ejecutan.

### Composer

**Composer** es **Apache Airflow** gestionado dentro de GCP. Tiene varias caracter√≠sticas interesantes:

* Se ejecuta dentro de un **cl√∫ster GKE**, por lo que el **SA que utiliza el cl√∫ster es accesible** por el c√≥digo que se ejecuta dentro de Composer.
* Almacena el **c√≥digo en un bucket**, por lo tanto, **cualquier persona con acceso de escritura sobre ese bucket** va a ser capaz de cambiar/agregar un c√≥digo DAG (el c√≥digo que Apache Airflow ejecutar√°). Entonces, si tienes **acceso de escritura sobre el bucket que Composer est√° utilizando** para almacenar el c√≥digo, puedes **escalar privilegios al SA que se ejecuta en el cl√∫ster GKE**.

### Funciones en la nube

* El c√≥digo de las funciones en la nube se almacena en Storage, por lo que **sobrescribi√©ndolo, es posible ejecutar c√≥digo arbitrario**.

### App Engine

* El c√≥digo fuente de App Engine se almacena en buckets, **sobrescribiendo el c√≥digo podr√≠a ser posible ejecutar c√≥digo arbitrario**.

### GCR

* **Google Container Registry** almacena las im√°genes dentro de los buckets, si puedes **escribir en esos buckets** podr√≠as ser capaz de **moverte lateralmente a donde se est√°n ejecutando esos buckets**. 

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>