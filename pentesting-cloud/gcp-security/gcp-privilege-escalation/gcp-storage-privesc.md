# GCP - Privil√®ge d'escalade de stockage

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**d√©p√¥ts Github HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## stockage

### `storage.objects.get`

Cette autorisation vous permet de **t√©l√©charger des fichiers stock√©s dans Gcp Storage**. Cela vous permettra potentiellement d'escalader les privil√®ges car dans certaines occasions, **des informations sensibles sont sauvegard√©es l√†-bas**. De plus, certains services Gcp stockent leurs informations dans des buckets :

* **GCP Composer** : Lorsque vous cr√©ez un environnement Composer, le **code de tous les DAG** sera sauvegard√© dans un **bucket**. Ces t√¢ches peuvent contenir des informations int√©ressantes dans leur code.
* **GCR (Container Registry)** : L'**image** des conteneurs est stock√©e dans des **buckets**, ce qui signifie que si vous pouvez lire les buckets, vous pourrez t√©l√©charger les images et **rechercher des fuites et/ou du code source**.

### `storage.objects.create`, `storage.objects.delete`

Pour **cr√©er un nouvel objet** dans un bucket, vous avez besoin de `storage.objects.create` et, selon [la documentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), vous avez √©galement besoin de `storage.objects.delete` pour **modifier** un objet existant.

Une **exploitation tr√®s courante** des buckets o√π vous pouvez √©crire dans le cloud est le cas o√π le **bucket sauvegarde des fichiers de serveur web**, vous pourriez √™tre en mesure de **stocker un nouveau code** qui sera utilis√© par l'application web.

De plus, plusieurs services GCP stockent √©galement du **code dans des buckets** qui est ensuite **ex√©cut√©** :

* **GCP Composer** : Le **code DAG** est **stock√© dans GCP Storage**. Ce **code** est ensuite **ex√©cut√©** √† l'int√©rieur de l'environnement **K8s utilis√© par le compositeur**, et a √©galement **acc√®s √† un GCP SA**. Par cons√©quent, en modifiant ce code, vous pourriez √™tre en mesure d'acc√©der √† l'environnement k8s du compositeur et de voler le jeton du GCP SA utilis√©.
* **GCR (Container Registry)** : Les **images de conteneurs sont stock√©es dans des buckets**. Donc, si vous avez un acc√®s en √©criture sur eux, vous pourriez **modifier les images** et ex√©cuter votre propre code chaque fois que ce conteneur est utilis√©.
  * Le bucket utilis√© par GCR aura une URL similaire √† `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Les sous-domaines de niveau sup√©rieur sont sp√©cifi√©s [ici](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

### `storage.objects.setIamPolicy`

Vous pouvez vous donner la permission d'**abuser de l'un des sc√©narios pr√©c√©dents de cette section**.

### **`storage.buckets.setIamPolicy`**

Pour un exemple de modification des autorisations avec cette autorisation, consultez cette page :

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Il existe une fonctionnalit√© de Cloud Storage, "interop√©rabilit√©", qui permet √† Cloud Storage d'interagir avec des offres de stockage d'autres fournisseurs de cloud, comme AWS S3. Dans le cadre de cela, il existe des cl√©s HMAC qui peuvent √™tre cr√©√©es pour les comptes de service et les utilisateurs r√©guliers. Nous pouvons **escalader les autorisations de Cloud Storage en cr√©ant une cl√© HMAC pour un compte de service √† privil√®ges plus √©lev√©s**.

Les cl√©s HMAC appartenant √† votre utilisateur ne peuvent pas √™tre acc√©d√©es via l'API et doivent √™tre acc√©d√©es via la console Web, mais ce qui est agr√©able, c'est que la cl√© d'acc√®s et la cl√© secr√®te sont disponibles √† tout moment. Cela signifie que nous pourrions prendre une paire existante et les stocker pour un acc√®s de sauvegarde au compte. Les cl√©s HMAC appartenant aux comptes de service **peuvent** √™tre acc√©d√©es via l'API, mais apr√®s leur cr√©ation, vous ne pouvez plus voir la cl√© d'acc√®s et le secret.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-1.png)

Le script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## Autorisation d'√©criture d'objets de stockage

Si vous pouvez modifier ou ajouter des objets dans des buckets, vous pourriez √™tre en mesure d'escalader vos privil√®ges vers d'autres ressources qui utilisent le bucket pour stocker le code qu'ils ex√©cutent.

### Composer

**Composer** est **Apache Airflow** g√©r√© √† l'int√©rieur de GCP. Il a plusieurs fonctionnalit√©s int√©ressantes :

* Il s'ex√©cute √† l'int√©rieur d'un **cluster GKE**, donc le **SA que le cluster utilise est accessible** par le code s'ex√©cutant √† l'int√©rieur de Composer
* Il stocke le **code dans un bucket**, donc **toute personne ayant un acc√®s en √©criture sur ce bucket** sera en mesure de modifier/ajouter un code DGA (le code qu'Apache Airflow ex√©cutera)\
  Ensuite, si vous avez **un acc√®s en √©criture sur le bucket que Composer utilise** pour stocker le code, vous pouvez **escalader les privil√®ges vers le SA s'ex√©cutant dans le cluster GKE**.

### Fonctions Cloud

* Le code des fonctions Cloud est stock√© dans Storage, donc **en l'√©crasant, il est possible d'ex√©cuter du code arbitraire**.

### App Engine

* Le code source d'App Engine est stock√© dans des buckets, **en √©crasant le code, il pourrait √™tre possible d'ex√©cuter du code arbitraire**

### GCR

* **Google Container Registry** stocke les images √† l'int√©rieur des buckets, si vous pouvez **√©crire dans ces buckets**, vous pourriez √™tre en mesure de **vous d√©placer lat√©ralement vers l'endroit o√π ces buckets sont ex√©cut√©s.**

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**d√©p√¥ts Github HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>