# GCP - Ukarabati wa Mamlaka ya Uhifadhi

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Uhifadhi

Maelezo Msingi:

{% content-ref url="../gcp-services/gcp-storage-enum.md" %}
[gcp-storage-enum.md](../gcp-services/gcp-storage-enum.md)
{% endcontent-ref %}

### `storage.objects.get`

Ruhusa hii inakuruhusu **kupakua faili zilizohifadhiwa ndani ya Uhifadhi wa Wingu**. Hii inaweza kukuruhusu kupandisha mamlaka kwa sababu mara nyingine **habari nyeti hufutwa huko**. Zaidi ya hayo, baadhi ya huduma za GCP hufuta habari zao kwenye vikapu:

* **GCP Composer**: Unapounda Mazingira ya Composer **mimba ya DAGs zote** itahifadhiwa ndani ya **kapu**. Kazi hizi zinaweza kuwa na habari muhimu ndani ya nambari zao.
* **GCR (Usajili wa Kontena)**: **Picha** za kontena zimehifadhiwa ndani ya **vikapu**, hii inamaanisha kwamba ikiwa unaweza kusoma vikapu utaweza kupakua picha na **kutafuta uvujaji na/au nambari ya chanzo**.

### `storage.objects.setIamPolicy`

Unaweza kujipa ruhusa ya **kutumia mojawapo ya hali za awali za sehemu hii**.

### **`storage.buckets.setIamPolicy`**

Kwa mfano wa jinsi ya kubadilisha ruhusa na ruhusa hii angalia ukurasa huu:

{% content-ref url="../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unaunthenticated-enum-and-access/gcp-storage-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Kipengele cha "urahisi wa matumizi" cha Uhifadhi wa Wingu, kilichoundwa kwa **mwingiliano wa msalaba wa wingu** kama na AWS S3, inahusisha **uundaji wa funguo za HMAC kwa Akaunti za Huduma na watumiaji**. Mshambuliaji anaweza kutumia hii kwa **kuunda funguo za HMAC kwa Akaunti ya Huduma yenye mamlaka iliyopandishwa**, hivyo **kupandisha mamlaka ndani ya Uhifadhi wa Wingu**. Wakati funguo za HMAC zinazohusiana na mtumiaji zinaweza kupatikana tu kupitia konsoli ya wavuti, funguo za ufikiaji na siri zinabaki **zikipatikana kila wakati**, kuruhusu ufikiaji wa akiba wa siku zijazo. Kinyume chake, funguo za HMAC zinazohusiana na Akaunti ya Huduma zinaweza kupatikana kupitia API, lakini ufikiaji na funguo za siri haziwezi kupatikana baada ya uundaji, ikiongeza safu ya utata kwa ufikiaji endelevu.
```bash
# Create key
gsutil hmac create <sa-email>

# Configure gsutil to use it
gsutil config -a

# Use it
gsutil ls gs://[BUCKET_NAME]
```
Another exploit script for this method can be found [here](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## `storage.objects.create`, `storage.objects.delete` = Ruhusu za Kuandika Kwenye Uhifadhi

Ili **kuunda kitu kipya** ndani ya ndoo unahitaji `storage.objects.create` na, kulingana na [nyaraka](https://cloud.google.com/storage/docs/access-control/iam-permissions#object\_permissions), unahitaji pia `storage.objects.delete` ili **kurekebisha** kitu kilichopo.

Utekaji wa kawaida sana wa ndoo ambapo unaweza kuandika kwenye wingu ni kama ndoo inaokoa faili za seva za wavuti, unaweza kuweza **kuhifadhi msimbo mpya** utakaotumiwa na programu ya wavuti.

### Mtunzi

**Mtunzi** ni **Apache Airflow** inayosimamiwa ndani ya GCP. Ina vipengele vingi vya kuvutia:

* Inakimbia ndani ya **kituo cha GKE**, hivyo **SA inayotumiwa na kituo inaweza kufikiwa** na msimbo unaoruka ndani ya Mtunzi
* Inahifadhi **msimbo kwenye ndoo**, kwa hivyo, **yeyote mwenye ufikiaji wa kuandika kwenye ndoo hiyo** ataweza kubadilisha/kuongeza msimbo wa DGA (msimbo Apache Airflow utakaoendesha)\
Kwa hivyo, ikiwa una **ufikiaji wa kuandika kwenye ndoo inayotumiwa na Mtunzi** kuhifadhi msimbo, unaweza **kuinua ruhusa kwenda kwa SA inayotumika kwenye kituo cha GKE**.

### Kazi za Wingu

* Msimbo wa Kazi za Wingu unahifadhiwa kwenye Uhifadhi, hivyo **kwa kuubadilisha, inawezekana kutekeleza msimbo wa aina yoyote**.

### Programu ya App

* Msimbo wa chanzo wa Programu ya App unahifadhiwa kwenye ndoo, **kwa kuubadilisha inawezekana kutekeleza msimbo wa aina yoyote. HII SIWEZEKANI**
* **Inaonekana safu za kontena zinahifadhiwa kwenye ndoo, labda kubadilisha hizo?**

### GCR

* **Usajili wa Kontena wa Google** unahifadhi picha ndani ya ndoo, ikiwa unaweza **kuandika kwenye ndoo hizo** unaweza kuwa na uwezo wa **kutembea kwa upande kwenda kwenye ndoo hizo zinapoendeshwa.**
* Ndoa inayotumiwa na GCR itakuwa na URL kama `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Vidokezo vya kiwango cha juu vimeelezwa [hapa](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

## **Virejeleo**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuateni** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
