# GCP - √âl√©vation de privil√®ges de stockage

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## storage

### `storage.objects.get`

Cette permission vous permet de **t√©l√©charger des fichiers stock√©s dans Gcp Storage**. Cela peut potentiellement vous permettre d'escalader les privil√®ges car dans certains cas, **des informations sensibles sont sauvegard√©es l√†**. De plus, certains services Gcp stockent leurs informations dans des seaux :

* **GCP Composer** : Lorsque vous cr√©ez un environnement Composer, **le code de tous les DAGs** sera sauvegard√© dans un **seau**. Ces t√¢ches peuvent contenir des informations int√©ressantes dans leur code.
* **GCR (Container Registry)** : **L'image** des conteneurs est stock√©e dans **des seaux**, ce qui signifie que si vous pouvez lire les seaux, vous pourrez t√©l√©charger les images et **rechercher des fuites et/ou du code source**.

### `storage.objects.create`, `storage.objects.delete`

Pour **cr√©er un nouvel objet** dans un seau, vous avez besoin de `storage.objects.create` et, selon [la documentation](https://cloud.google.com/storage/docs/access-control/iam-permissions#object_permissions), vous avez √©galement besoin de `storage.objects.delete` pour **modifier** un objet existant.

Une **exploitation courante** des seaux o√π vous pouvez √©crire dans le cloud est dans le cas o√π **le seau sauvegarde des fichiers de serveur web**, vous pourriez √™tre en mesure de **stocker un nouveau code** qui sera utilis√© par l'application web.

De plus, plusieurs services GCP **stockent √©galement du code dans des seaux** qui est ensuite **ex√©cut√©** :

* **GCP Composer** : Le **code DAG** est **stock√© dans GCP Storage**. Ce **code** est plus tard **ex√©cut√©** √† l'int√©rieur de l'environnement **K8s** utilis√© par Composer, et a √©galement **acc√®s √† un GCP SA**. Par cons√©quent, en modifiant ce code, vous pourriez √™tre en mesure de p√©n√©trer dans l'environnement k8s de Composer et de voler le jeton du GCP SA utilis√©.
* **GCR (Container Registry)** : Les **images de conteneurs sont stock√©es dans des seaux**. Donc, si vous avez un acc√®s en √©criture sur eux, vous pourriez **modifier les images** et ex√©cuter votre propre code chaque fois que ce conteneur est utilis√©.
* Le seau utilis√© par GCR aura une URL similaire √† `gs://<eu/usa/asia/nothing>.artifacts.<project>.appspot.com` (Les sous-domaines de premier niveau sont sp√©cifi√©s [ici](https://cloud.google.com/container-registry/docs/pushing-and-pulling)).

### `storage.objects.setIamPolicy`

Vous pouvez vous donner la permission d'**abuser de n'importe quel sc√©nario pr√©c√©dent de cette section**.

### **`storage.buckets.setIamPolicy`**

Pour un exemple de modification des permissions avec cette permission, consultez cette page :

{% content-ref url="../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md" %}
[gcp-public-buckets-privilege-escalation.md](../gcp-unauthenticated-enum/gcp-public-buckets-privilege-escalation.md)
{% endcontent-ref %}

### `storage.hmacKeys.create`

Il existe une fonctionnalit√© de Cloud Storage, "l'interop√©rabilit√©", qui fournit un moyen pour Cloud Storage d'interagir avec les offres de stockage d'autres fournisseurs de cloud, comme AWS S3. Dans ce cadre, il existe des cl√©s HMAC qui peuvent √™tre cr√©√©es pour les comptes de service et les utilisateurs r√©guliers. Nous pouvons **escalader les permissions de Cloud Storage en cr√©ant une cl√© HMAC pour un compte de service plus privil√©gi√©**.

Les cl√©s HMAC appartenant √† votre utilisateur ne peuvent pas √™tre acc√©d√©es via l'API et doivent √™tre acc√©d√©es via la console web, mais ce qui est bien, c'est que la cl√© d'acc√®s et la cl√© secr√®te sont disponibles √† tout moment. Cela signifie que nous pourrions prendre une paire existante et les stocker pour un acc√®s de secours au compte. Les cl√©s HMAC appartenant aux comptes de service **peuvent** √™tre acc√©d√©es via l'API, mais apr√®s la cr√©ation, vous n'√™tes pas en mesure de voir √† nouveau la cl√© d'acc√®s et la cl√© secr√®te.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-1.png)

Le script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/storage.hmacKeys.create.py).

## Permission d'√©criture storage.objects

Si vous pouvez modifier ou ajouter des objets dans des seaux, vous pourriez √™tre en mesure d'escalader vos privil√®ges vers d'autres ressources qui utilisent le seau pour stocker du code qu'elles ex√©cutent.

### Composer

**Composer** est **Apache Airflow** g√©r√© √† l'int√©rieur de GCP. Il a plusieurs caract√©ristiques int√©ressantes :

* Il fonctionne √† l'int√©rieur d'un **cluster GKE**, donc le **SA que le cluster utilise est accessible** par le code s'ex√©cutant √† l'int√©rieur de Composer
* Il stocke le **code dans un seau**, donc, **quiconque ayant un acc√®s en √©criture sur ce seau** va √™tre en mesure de changer/ajouter un code DGA (le code qu'Apache Airflow ex√©cutera)\
Alors, si vous avez **un acc√®s en √©criture sur le seau que Composer utilise** pour stocker le code, vous pouvez **privesc au SA s'ex√©cutant dans le cluster GKE**.

### Cloud Functions

* Le code des Cloud Functions est stock√© dans Storage, donc **le r√©√©crire, il est possible d'ex√©cuter du code arbitraire**.

### App Engine

* Le code source de App Engine est stock√© dans des seaux, **r√©√©crire le code pourrait permettre d'ex√©cuter du code arbitraire**.
### GCR

* **Google Container Registry** stocke les images dans des seaux. Si vous pouvez **√©crire dans ces seaux**, vous pourriez √™tre capable de vous **d√©placer lat√©ralement l√† o√π ces seaux sont ex√©cut√©s.**

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
