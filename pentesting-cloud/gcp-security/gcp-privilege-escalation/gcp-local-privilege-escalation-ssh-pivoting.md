# GCP - local privilege escalation ssh pivoting

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直至成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

在这个场景中，我们假设您**已经攻破了 Compute Engine 项目中 VM 的一个非特权账户**。

令人惊讶的是，您攻破的计算引擎的 GCP 权限可能帮助您**在机器内部本地提升权限**。即使在云环境中这并不总是非常有用，但知道这是可能的很重要。

## 阅读脚本 <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**计算实例**可能存在是为了**执行一些脚本**，以使用它们的服务账户执行操作。

由于 IAM 非常细致，一个账户可能对资源有**读/写**权限，但**没有列出权限**。

一个很好的假设例子是，一个计算实例有权限读/写到一个名为 `instance82736-long-term-xyz-archive-0332893` 的存储桶中的备份。

从命令行运行 `gsutil ls` 什么也不返回，因为服务账户缺少 `storage.buckets.list` IAM 权限。然而，如果您运行 `gsutil ls gs://instance82736-long-term-xyz-archive-0332893`，您可能会发现一个完整的文件系统备份，让您能够明文访问您的本地 Linux 账户缺少的数据。

您可能会在脚本中找到这个存储桶的名称（在 bash、Python、Ruby...中）。

## 自定义元数据

管理员可以在**实例**和**项目级别**添加[自定义元数据](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom)。这只是一种将**任意键/值对传递到实例**的方法，通常用于环境变量和启动/关闭脚本。

此外，还可以添加**用户数据**，这是一个脚本，将在每次启动或重启机器时**执行**，也可以从元数据端点**访问**。

更多信息请查看：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## **滥用 IAM 权限**

以下提出的大多数权限都**授予了默认的 Compute SA，唯一的问题是默认访问范围阻止了 SA 使用它们**。然而，如果启用了\*\*`cloud-platform`\*\* **范围**或仅启用了\*\*`compute`\*\* **范围**，您将能够**滥用它们**。

检查以下权限：

* [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## 在文件系统中搜索密钥

检查是否有其他用户在盒子里登录过 gcloud 并在文件系统中留下了他们的凭证：

```
sudo find / -name "gcloud"
```

以下是最有趣的文件：

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### 更多API密钥正则表达式

```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```

## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
