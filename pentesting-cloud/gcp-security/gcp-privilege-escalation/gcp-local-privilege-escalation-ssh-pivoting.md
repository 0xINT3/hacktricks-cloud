# GCP - 本地特权升级 SSH 转发

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

在这种情况下，我们假设您已经**入侵了一个非特权账户**，位于 Compute Engine 项目中的虚拟机中。

令人惊讶的是，您入侵的 GPC 计算引擎的权限可能会帮助您**在本地机器上提升特权**。尽管在云环境中这并不总是非常有用，但了解这一点是很好的。

## 阅读脚本 <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**计算实例**可能存在用于**执行一些脚本**以执行其服务账户操作的目的。

由于 IAM 是粒度细的，一个账户可能对资源具有**读/写**权限，但**没有列表权限**。

一个很好的假设性例子是一个计算实例，它具有读/写备份到名为 `instance82736-long-term-xyz-archive-0332893` 的存储桶的权限。

从命令行运行 `gsutil ls` 不返回任何内容，因为服务账户缺少 `storage.buckets.list` IAM 权限。然而，如果您运行 `gsutil ls gs://instance82736-long-term-xyz-archive-0332893`，您可能会找到一个完整的文件系统备份，从而可以以明文方式访问您的本地 Linux 账户无法访问的数据。

您可能能够在脚本（bash、Python、Ruby 等）中找到这个存储桶名称。

## 自定义元数据

管理员可以在**实例**和**项目级别**上添加[自定义元数据](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom)。这只是一种将**任意键/值对传递到实例**中的方法，通常用于环境变量和启动/关闭脚本。

此外，还可以添加**用户数据**，这是一个在每次启动或重新启动机器时都会**执行的脚本**，也可以从元数据端点访问。

了解更多信息，请查看：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## 滥用 IAM 权限

下面提到的大多数权限都是**默认的 Compute SA**所拥有的，唯一的问题是**默认访问范围阻止 SA 使用它们**。然而，如果启用了**`cloud-platform`** **范围**或仅启用了**`compute`** **范围**，您将能够滥用它们。

请检查以下权限：

* ****[**compute.instances.osLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.oslogin)****
* ****[**compute.instances.osAdminLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.osadminlogin)****
* ****[**compute.projects.setCommonInstanceMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)****
* ****[**compute.instances.setMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setmetadata)****
* ****[**compute.instances.setIamPolicy**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setiampolicy)****

## 在文件系统中搜索密钥

很可能**同一台机器上的其他用户**使用比您自己更强大的账户运行了 `gcloud` 命令。您需要**本地 root 权限**来执行此操作。

首先，找出用户主目录中存在哪些 `gcloud` 配置目录。
```
sudo find / -name "gcloud"
```
您可以手动检查其中的文件，但通常这些文件包含了机密信息：

* \~/.config/gcloud/credentials.db
* \~/.config/gcloud/legacy\_credentials/\[ACCOUNT]/adc.json
* \~/.config/gcloud/legacy\_credentials/\[ACCOUNT]/.boto
* \~/.credentials.json

现在，您可以选择在这些文件中查找明文凭据，或者只需将整个`gcloud`文件夹复制到您控制的机器上，并运行`gcloud auth list`来查看现在可用的帐户。
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
<details>

<summary><strong>支持HackTricks并获得好处！</strong></summary>

* 如果您想看到您的**公司在HackTricks中被广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
