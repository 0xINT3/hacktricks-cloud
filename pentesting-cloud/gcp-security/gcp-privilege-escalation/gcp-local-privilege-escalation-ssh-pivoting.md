# GCP - ローカル特権昇格SSHピボット

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSやHackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加する**

</details>

このシナリオでは、Compute Engineプロジェクト内のVM内で**特権のないアカウントが侵害された**と仮定します。

驚くべきことに、侵害されたCompute EngineのGCP権限を利用して、**マシン内でローカル特権を昇格**させることができます。クラウド環境では常に非常に役立つわけではありませんが、それが可能であることを知っていることは良いことです。

## スクリプトを読む <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**Compute Instances**は、おそらく**いくつかのスクリプトを実行**して、サービスアカウントを使用してアクションを実行するために存在しています。

IAMは非常に細かくなっているため、アカウントはリソースに対して**読み取り/書き込み**権限を持つかもしれませんが、**リスト権限は持っていない**かもしれません。

これの素晴らしい仮説的な例は、`instance82736-long-term-xyz-archive-0332893`という名前のストレージバケットにバックアップの**読み取り/書き込み権限**を持つCompute Instanceです。

コマンドラインから`gsutil ls`を実行すると何も返されません。なぜなら、サービスアカウントには`storage.buckets.list`のIAM権限がないからです。しかし、`gsutil ls gs://instance82736-long-term-xyz-archive-0332893`を実行すると、完全なファイルシステムのバックアップが見つかるかもしれません。これにより、ローカルのLinuxアカウントではアクセスできないデータに平文でアクセスできます。

このバケット名は、スクリプト（bash、Python、Rubyなど）の中に見つけることができるかもしれません。

## カスタムメタデータ

管理者は、**インスタンス**と**プロジェクトレベル**で[カスタムメタデータ](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom)を追加できます。これは単に**インスタンスに任意のキー/値のペアを渡す方法**であり、環境変数や起動/シャットダウンスクリプトによく使用されます。

さらに、**メタデータエンドポイントからアクセスできる**スクリプトである**ユーザーデータ**を追加することも可能です。このスクリプトは、マシンが起動または再起動されるたびに**実行されます**。

詳細については、次を参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## IAM権限の乱用

以下の提案された権限のほとんどは、**デフォルトのCompute SAに与えられます**が、**デフォルトのアクセススコープによりSAはそれらを使用できません**。ただし、**`cloud-platform`** **スコープ**が有効になっているか、単に**`compute`** **スコープ**が有効になっている場合は、それらを**乱用することができます**。

次の権限を確認してください：

* ****[**compute.instances.osLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.oslogin)****
* ****[**compute.instances.osAdminLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.osadminlogin)****
* ****[**compute.projects.setCommonInstanceMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)****
* ****[**compute.instances.setMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setmetadata)****
* ****[**compute.instances.setIamPolicy**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setiampolicy)****

## ファイルシステム内のキーを検索する

おそらく、**同じボックス上の他のユーザーが、あなた自身よりも強力なアカウントを使用して`gcloud`コマンドを実行している可能性があります**。これを行うには、**ローカルのルート権限**が必要です。

まず、ユーザーのホームフォルダに存在する`gcloud`の設定ディレクトリを見つけます。
```
sudo find / -name "gcloud"
```
以下は、ファイル内を手動で検査することができますが、一般的には以下のファイルには秘密情報が含まれています：

* \~/.config/gcloud/credentials.db
* \~/.config/gcloud/legacy\_credentials/\[ACCOUNT]/adc.json
* \~/.config/gcloud/legacy\_credentials/\[ACCOUNT]/.boto
* \~/.credentials.json

これらのファイルには、クリアテキストの資格情報を探すか、単に`gcloud`フォルダ全体を制御できるマシンにコピーして`gcloud auth list`を実行して利用可能なアカウントを確認するという選択肢があります。

### より多くのAPIキーの正規表現
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
