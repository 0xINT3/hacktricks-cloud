# GCP - local privilege escalation ssh pivoting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>

рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ рд╣рдо рдорд╛рди рд░рд╣реЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдиреЗ Compute Engine рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ рдПрдХ VM рдХреЗ рдЕрдВрджрд░ рдПрдХ **рдЧреИрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЦрд╛рддреЗ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд┐рдпрд╛ рд╣реИ**ред

рдЖрд╢реНрдЪрд░реНрдпрдЬрдирдХ рд░реВрдк рд╕реЗ, рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдХрдВрдкреНрдпреВрдЯ рдЗрдВрдЬрди рдХреА GPC рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдЖрдкрдХреЛ рдорд╢реАрди рдХреЗ рдЕрдВрджрд░ **рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐** рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рд╣рдореЗрд╢рд╛ рдПрдХ рдХреНрд▓рд╛рдЙрдб рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдмрд╣реБрдд рд╕рд╣рд╛рдпрдХ рдирд╣реАрдВ рд╣реЛрдЧрд╛, рдпрд╣ рдЬрд╛рдирдирд╛ рдЕрдЪреНрдЫрд╛ рд╣реИ рдХрд┐ рдпрд╣ рд╕рдВрднрд╡ рд╣реИред

## рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдкрдврд╝реЗрдВ <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**рдХрдВрдкреНрдпреВрдЯ рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕** рд╢рд╛рдпрдж рд╡рд╣рд╛рдВ рд╣реЛрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ рдЕрдкрдиреЗ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдХреНрд░рд┐рдпрд╛рдПрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдХреБрдЫ рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ**ред

рдЪреВрдВрдХрд┐ IAM рдмрд╣реБрдд рд╡рд┐рд╕реНрддреГрдд рд╣реИ, рдПрдХ рдЦрд╛рддреЗ рдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рд╕рдВрд╕рд╛рдзрди рдкрд░ **рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ** рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рд▓реЗрдХрд┐рди **рд╕реВрдЪреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдирд╣реАрдВ**ред

рдЗрд╕рдХрд╛ рдПрдХ рдорд╣рд╛рди рдХрд╛рд▓реНрдкрдирд┐рдХ рдЙрджрд╛рд╣рд░рдг рдПрдХ рдХрдВрдкреНрдпреВрдЯ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╣реИ рдЬрд┐рд╕реЗ `instance82736-long-term-xyz-archive-0332893` рдирд╛рдордХ рдПрдХ рд╕реНрдЯреЛрд░реЗрдЬ рдмрдХреЗрдЯ рдореЗрдВ рдмреИрдХрдЕрдк рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред

рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рд╕реЗ `gsutil ls` рдЪрд▓рд╛рдиреЗ рдкрд░ рдХреБрдЫ рднреА рдирд╣реАрдВ рдЖрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдореЗрдВ `storage.buckets.list` IAM рдЕрдиреБрдорддрд┐ рдХреА рдХрдореА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдЖрдкрдиреЗ `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` рдЪрд▓рд╛рдпрд╛ рддреЛ рдЖрдкрдХреЛ рдкреВрд░реА рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдмреИрдХрдЕрдк рдорд┐рд▓ рд╕рдХрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЖрдкрдХреЛ рдЙрди рдбреЗрдЯрд╛ рддрдХ рд╕реНрдкрд╖реНрдЯ-рдкрд╛рда рдкрд╣реБрдВрдЪ рдорд┐рд▓ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕рдХреА рдЖрдкрдХреЗ рд╕реНрдерд╛рдиреАрдп рд▓рд┐рдирдХреНрд╕ рдЦрд╛рддреЗ рдореЗрдВ рдХрдореА рд╣реИред

рдЖрдк рдЗрд╕ рдмрдХреЗрдЯ рдирд╛рдо рдХреЛ рдХрд┐рд╕реА рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдЕрдВрджрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ (bash, Python, Ruby... рдореЗрдВ)ред

## рдХрд╕реНрдЯрдо рдореЗрдЯрд╛рдбреЗрдЯрд╛

рдкреНрд░рд╢рд╛рд╕рдХ [рдХрд╕реНрдЯрдо рдореЗрдЯрд╛рдбреЗрдЯрд╛](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) рдХреЛ **рдЗрдВрд╕реНрдЯреЗрдВрд╕** рдФрд░ **рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реНрддрд░** рдкрд░ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рдмрд╕ рдПрдХ рддрд░реАрдХрд╛ рд╣реИ **рдордирдорд╛рдиреЗ рдХреБрдВрдЬреА/рдореВрд▓реНрдп рдЬреЛрдбрд╝реЗ рдХреЛ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛**, рдФрд░ рдЖрдорддреМрд░ рдкрд░ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдФрд░ рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк/рд╢рдЯрдбрд╛рдЙрди рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **userdata** рдЬреЛрдбрд╝рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬреЛ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ рдЬреЛ **рд╣рд░ рдмрд╛рд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЬрд╛рдПрдЧреА** рдЬрдм рдорд╢реАрди рд╢реБрд░реВ рдпрд╛ рдкреБрдирдГ рдЖрд░рдВрдн рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рдЬрд┐рд╕реЗ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рднреА **рдкрд╣реБрдВрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред**

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## **IAM рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ**

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдореЗрдВ рд╕реЗ рдЕрдзрд┐рдХрд╛рдВрд╢ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХрдВрдкреНрдпреВрдЯ SA рдХреЛ рджреА рдЧрдИ рд╣реИрдВ,** рдПрдХрдорд╛рддреНрд░ рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдПрдХреНрд╕реЗрд╕ рд╕реНрдХреЛрдк SA рдХреЛ рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред** рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ **`cloud-platform`** **рд╕реНрдХреЛрдк** рд╕рдХреНрд╖рдо рд╣реИ рдпрд╛ рдХреЗрд╡рд▓ **`compute`** **рд╕реНрдХреЛрдк** рд╕рдХреНрд╖рдо рд╣реИ, рддреЛ рдЖрдк рдЙрдирдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:

* [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХреАрдЬрд╝ рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдмреЙрдХреНрд╕ рдХреЗ рдЕрдВрджрд░ gcloud рдореЗрдВ рд▓реЙрдЧрд┐рди рд╣реИрдВ рдФрд░ рдЙрдиреНрд╣реЛрдВрдиреЗ рдЕрдкрдиреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдЫреЛрдбрд╝ рджреА рд╣реИрдВ:

```
sudo find / -name "gcloud"
```

рдпреЗ рд╕рдмрд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рдлрд╛рдЗрд▓реЗрдВ рд╣реИрдВ:

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### рдФрд░ API рдХреАрдЬрд╝ рдХреЗ рд▓рд┐рдП regexes

```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```

## рд╕рдВрджрд░реНрдн

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>
