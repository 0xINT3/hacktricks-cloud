# GCP - escalatione dei privilegi locali tramite ssh pivoting

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

In questo scenario supponiamo che tu **abbia compromesso un account non privilegiato** all'interno di una VM in un progetto Compute Engine.

Incredibilmente, i permessi GPC della compute engine che hai compromesso potrebbero aiutarti a **aumentare i privilegi localmente all'interno di una macchina**. Anche se ci√≤ non sar√† sempre molto utile in un ambiente cloud, √® bene sapere che √® possibile.

## Leggi gli script <a href="#follow-the-scripts" id="follow-the-scripts"></a>

Le **istanze di calcolo** sono probabilmente l√¨ per **eseguire degli script** per eseguire azioni con i loro account di servizio.

Poich√© IAM √® molto granulare, un account pu√≤ avere privilegi di **lettura/scrittura** su una risorsa ma **nessun privilegio di elenco**.

Un ottimo esempio ipotetico di ci√≤ √® un'istanza di calcolo che ha il permesso di leggere/scrivere backup in un bucket di archiviazione chiamato `instance82736-long-term-xyz-archive-0332893`.

L'esecuzione di `gsutil ls` dalla riga di comando non restituisce nulla, poich√© l'account di servizio non dispone del permesso IAM `storage.buckets.list`. Tuttavia, se esegui `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` potresti trovare un backup completo del file system, che ti d√† accesso in chiaro ai dati che il tuo account Linux locale non ha.

Potresti essere in grado di trovare il nome di questo bucket all'interno di uno script (in bash, Python, Ruby...).

## Metadati personalizzati

Gli amministratori possono aggiungere [metadati personalizzati](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) a livello di **istanza** e **progetto**. Questo √® semplicemente un modo per passare **coppie chiave/valore arbitrarie a un'istanza**, ed √® comunemente utilizzato per le variabili d'ambiente e gli script di avvio/arresto.

Inoltre, √® possibile aggiungere **userdata**, che √® uno script che verr√† **eseguito ogni volta** che la macchina viene avviata o riavviata e che pu√≤ essere **accessibile anche dall'endpoint dei metadati**.

Per ulteriori informazioni, controlla:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## **Abuso dei permessi IAM**

La maggior parte dei permessi proposti di seguito sono **assegnati all'account di servizio di default di Compute**, l'unico problema √® che **l'ambito di accesso predefinito impedisce all'account di servizio di utilizzarli**. Tuttavia, se √® abilitato l'ambito **`cloud-platform`** o solo l'ambito **`compute`**, sarai **in grado di abusarne**.

Controlla i seguenti permessi:

* [**compute.instances.osLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setiampolicy)

## Cerca chiavi nel file system

Verifica se altri utenti hanno effettuato l'accesso a gcloud all'interno della macchina e hanno lasciato le loro credenziali nel file system:
```
sudo find / -name "gcloud"
```
Questi sono i file pi√π interessanti:

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### Altri regex per le chiavi API
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## Riferimenti

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
