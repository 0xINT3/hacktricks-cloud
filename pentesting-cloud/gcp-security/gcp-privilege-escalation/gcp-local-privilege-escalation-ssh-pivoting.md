# GCP - 로컬 권한 상승 SSH 피벗

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter**에서 **팔로우**하세요. 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

이 시나리오에서는 Compute Engine 프로젝트 내에서 **권한이 없는 계정**이 포함된 VM을 침투했다고 가정합니다.

놀랍게도, 침투한 Compute Engine의 GPC 권한을 사용하여 **로컬에서 권한을 상승**할 수 있습니다. 클라우드 환경에서는 항상 매우 유용하지는 않지만 가능하다는 것을 알고 있는 것이 좋습니다.

## 스크립트 읽기 <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**Compute Instances**는 서비스 계정을 사용하여 작업을 수행하기 위해 **일부 스크립트를 실행**하는 것으로 추정됩니다.

IAM이 매우 세분화되어 있으므로 계정은 리소스에 대한 **읽기/쓰기** 권한을 가지고 있지만 **목록 권한은 없을 수** 있습니다.

이에 대한 좋은 가상 예는 `instance82736-long-term-xyz-archive-0332893`라는 저장소 버킷에 대한 읽기/쓰기 권한을 가진 Compute Instance입니다.

명령 줄에서 `gsutil ls`를 실행하면 `storage.buckets.list` IAM 권한이 없기 때문에 아무것도 반환되지 않습니다. 그러나 `gsutil ls gs://instance82736-long-term-xyz-archive-0332893`를 실행하면 완전한 파일 시스템 백업을 찾을 수 있으며, 이를 통해 로컬 Linux 계정이 액세스할 수 없는 데이터에 대한 평문 액세스 권한을 얻을 수 있습니다.

이러한 버킷 이름을 스크립트(배시, 파이썬, 루비...)에서 찾을 수 있을 수도 있습니다.

## 사용자 정의 메타데이터

관리자는 **인스턴스** 및 **프로젝트 수준**에서 [사용자 정의 메타데이터](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom)를 추가할 수 있습니다. 이는 단순히 **임의의 키/값 쌍을 인스턴스로 전달하는 방법**이며, 주로 환경 변수 및 시작/종료 스크립트에 사용됩니다.

또한 **userdata**를 추가할 수 있으며, 이는 기계가 시작되거나 다시 시작될 때마다 **실행되는 스크립트**로 메타데이터 엔드포인트에서도 **액세스할 수 있습니다.**

자세한 정보는 다음을 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## IAM 권한 남용

다음 제안된 권한 대부분은 **기본 Compute SA에게 제공**됩니다. 유일한 문제는 **기본 액세스 범위가 SA가 사용할 수 없게** 막는다는 것입니다. 그러나 **`cloud-platform`** **범위**가 활성화되었거나 **`compute`** **범위**만 활성화되었다면 이를 **남용**할 수 있습니다.

다음 권한을 확인하세요:

* [**compute.instances.osLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setiampolicy)

## 파일 시스템에서 키 검색

상자 내에서 다른 사용자가 gcloud에 로그인하고 파일 시스템에 자격 증명을 남겼는지 확인하세요:
```
sudo find / -name "gcloud"
```
다음은 가장 흥미로운 파일들입니다:

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### 더 많은 API 키 정규식들
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## 참고 자료

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**을** **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 기교를 공유**하세요.

</details>
