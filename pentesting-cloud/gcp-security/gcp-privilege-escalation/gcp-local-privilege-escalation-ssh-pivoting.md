# GCP - local privilege escalation ssh pivoting

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalamu wa Timu Nyekundu ya HackTricks AWS)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

katika hali hii tutadhani kwamba umefanikiwa **kudukua akaunti isiyo na mamlaka** ndani ya VM katika mradi wa Compute Engine.

Kwa kushangaza, ruhusa za GPC za kompyuta ya injini uliyodukua inaweza kukusaidia **kuboresha mamlaka kwa ndani ndani ya mashine**. Hata kama hilo halitasaidia sana katika mazingira ya wingu, ni vizuri kujua kwamba ni jambo linalowezekana.

## Soma hati za maandishi <a href="#fuata-hati-za-maandishi" id="fuata-hati-za-maandishi"></a>

**Mifano ya Kompyuta** labda iko hapo kutekeleza baadhi ya **hati za maandishi** kutekeleza vitendo na akaunti zao za huduma.

Kwa kuwa IAM ni ya kina, akaunti inaweza kuwa na ruhusa za **kusoma/kuandika** juu ya rasilimali lakini **bila ruhusa za orodha**.

Mfano mzuri wa hili ni Kompyuta ambayo ina ruhusa ya kusoma/kuandika nakala rudufu kwenye kisanduku cha uhifadhi kinachoitwa `instance82736-long-term-xyz-archive-0332893`.

Kukimbia `gsutil ls` kutoka kwenye mstari wa amri hakirudishi chochote, kwa sababu akaunti ya huduma inakosa ruhusa ya IAM ya `storage.buckets.list`. Walakini, ikiwa ungekimbia `gsutil ls gs://instance82736-long-term-xyz-archive-0332893` unaweza kupata nakala kamili ya mfumo wa faili, ikikupa ufikiaji wa maandishi wazi ambao akaunti yako ya Linux ya ndani inakosa.

Unaweza kupata jina hili la kisanduku ndani ya hati ya maandishi (kwa bash, Python, Ruby...).

## Metadata ya Desturi

Waadiministrata wanaweza kuongeza [metadata ya desturi](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom) kwenye **kiwango cha kifaa** na **mradi**. Hii ni njia tu ya kupitisha **jozi za funguo/taarifa za thamani isiyojulikana kwenye kifaa**, na mara nyingi hutumiwa kwa mazingira ya mazingira na hati za kuanza/kuzimwa.

Zaidi ya hayo, ni rahisi kuongeza **data ya mtumiaji**, ambayo ni hati ya maandishi itakayokuwa **itekelezwa kila wakati** mashine inapoanzishwa au kuanzishwa upya na inaweza **kufikiwa kutoka kwa mwisho wa metadata pia.**

Kwa habari zaidi angalia:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## **Kudhuru ruhusa za IAM**

Ruhusa nyingi zilizopendekezwa zifuatazo zinapewa **SA ya Kompyuta ya chaguo**, tatizo pekee ni kwamba **wigo wa upatikanaji wa chaguo la msingi unazuia SA kutumia ruhusa hizo**. Walakini, ikiwa **`wigo wa jukwaa la wingu`** **umeamilishwa au tu wigo wa** **`kompyuta`** **umeamilishwa**, utaweza **kuzitumia vibaya**.

Angalia ruhusa zifuatazo:

* [**compute.instances.osLogin**](gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](gcp-compute-privesc/#compute.instances.setiampolicy)

## Tafuta funguo kwenye mfumo wa faili

Angalia ikiwa watumiaji wengine wameingia kwenye gcloud ndani ya sanduku na kuacha vyeti vyao kwenye mfumo wa faili:

```
sudo find / -name "gcloud"
```

Hizi ndizo faili za kuvutia zaidi:

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

### Zaidi ya API Keys regexes

```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```

## Marejeo

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
