# GCP - ローカル権限昇格 ssh ピボット

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

このシナリオでは、Compute Engineプロジェクト内のVMにある**非特権アカウントを侵害した**と仮定します。

驚くべきことに、侵害したコンピュートエンジンのGPC権限は、マシン内で**ローカルに権限を昇格させる**のに役立つかもしれません。それがクラウド環境では常に役立つわけではありませんが、可能であることを知っておくことは良いことです。

## スクリプトを読む <a href="#follow-the-scripts" id="follow-the-scripts"></a>

**コンピュートインスタンス**は、サービスアカウントでアクションを実行するために**いくつかのスクリプトを実行する**ために存在する可能性があります。

IAMは非常に細かいため、アカウントはリソースに対して**読み書き**権限を持っているかもしれませんが、**リスト権限は持っていない**場合があります。

これの素晴らしい仮想例は、`instance82736-long-term-xyz-archive-0332893`というストレージバケットにバックアップを読み書きする権限を持つコンピュートインスタンスです。

コマンドラインから`gsutil ls`を実行しても何も返ってこないかもしれません。なぜなら、サービスアカウントには`storage.buckets.list` IAM権限がないからです。しかし、`gsutil ls gs://instance82736-long-term-xyz-archive-0332893`を実行した場合、完全なファイルシステムのバックアップが見つかり、ローカルLinuxアカウントが持っていないデータへのクリアテキストアクセスが可能になるかもしれません。

このバケット名はスクリプト内（bash、Python、Rubyなど）で見つけることができるかもしれません。

## カスタムメタデータ

管理者は、**インスタンス**と**プロジェクトレベル**で[カスタムメタデータ](https://cloud.google.com/compute/docs/storing-retrieving-metadata#custom)を追加することができます。これは単に、**任意のキー/値ペアをインスタンスに渡す**方法であり、環境変数や起動/シャットダウンスクリプトに一般的に使用されます。

さらに、**userdata**を追加することができます。これは、マシンが起動または再起動されるたびに**実行されるスクリプト**であり、メタデータエンドポイントからも**アクセス可能です。**

詳細については以下をチェックしてください:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

## **IAM権限の悪用**

以下に提案されているほとんどの権限は、**デフォルトのCompute SAに与えられています。**唯一の問題は、**デフォルトのアクセススコープがSAがそれらを使用するのを防ぐ**ことです。しかし、**`cloud-platform`** **スコープ**が有効になっているか、単に**`compute`** **スコープ**が有効になっている場合は、それらを**悪用することができます。**

以下の権限をチェックしてください:

* [**compute.instances.osLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.oslogin)
* [**compute.instances.osAdminLogin**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.osadminlogin)
* [**compute.projects.setCommonInstanceMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.projects.setcommoninstancemetadata)
* [**compute.instances.setMetadata**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setmetadata)
* [**compute.instances.setIamPolicy**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/#compute.instances.setiampolicy)

## ファイルシステムでキーを探す

同じボックス上の**他のユーザーがあなたよりも強力なアカウントを使用して`gcloud`コマンドを実行している**可能性がかなりあります。これを行うには**ローカルのrootが必要**です。

まず、ユーザーのホームフォルダーに存在する`gcloud`設定ディレクトリを見つけます。
```
sudo find / -name "gcloud"
```
手動でファイルを調べることができますが、通常は以下のファイルに秘密情報が含まれています：

* `~/.config/gcloud/credentials.db`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/adc.json`
* `~/.config/gcloud/legacy_credentials/[ACCOUNT]/.boto`
* `~/.credentials.json`

これらのファイルでクリアテキストの認証情報を探すか、単に `gcloud` フォルダ全体を自分のコントロール下にあるマシンにコピーして、`gcloud auth list` を実行して、どのアカウントが利用可能になったかを確認する選択肢があります。

### もっと多くのAPIキーの正規表現
```bash
TARGET_DIR="/path/to/whatever"

# Service account keys
grep -Pzr "(?s){[^{}]*?service_account[^{}]*?private_key.*?}" \
"$TARGET_DIR"

# Legacy GCP creds
grep -Pzr "(?s){[^{}]*?client_id[^{}]*?client_secret.*?}" \
"$TARGET_DIR"

# Google API keys
grep -Pr "AIza[a-zA-Z0-9\\-_]{35}" \
"$TARGET_DIR"

# Google OAuth tokens
grep -Pr "ya29\.[a-zA-Z0-9_-]{100,200}" \
"$TARGET_DIR"

# Generic SSH keys
grep -Pzr "(?s)-----BEGIN[ A-Z]*?PRIVATE KEY[a-zA-Z0-9/\+=\n-]*?END[ A-Z]*?PRIVATE KEY-----" \
"$TARGET_DIR"

# Signed storage URLs
grep -Pir "storage.googleapis.com.*?Goog-Signature=[a-f0-9]+" \
"$TARGET_DIR"

# Signed policy documents in HTML
grep -Pzr '(?s)<form action.*?googleapis.com.*?name="signature" value=".*?">' \
"$TARGET_DIR"
```
## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
