# GCP - Cloudfunctions Privesc

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## cloudfunctions

### `cloudfunctions.functions.create` , `iam.serviceAccounts.actAs`

Pour cette m√©thode, nous allons **cr√©er une nouvelle Cloud Function avec un Service Account associ√©** que nous souhaitons acc√©der. Comme les invocations de Cloud Function ont **acc√®s √† l'API de m√©tadonn√©es**, nous pouvons demander un token directement √† partir de celle-ci, tout comme sur une instance Compute Engine.

Les **permissions requises** pour cette m√©thode sont les suivantes :

* _cloudfunctions.functions.call_ **OU** _cloudfunctions.functions.setIamPolicy_
* _cloudfunctions.functions.create_
* _cloudfunctions.functions.sourceCodeSet_
* _iam.serviceAccounts.actAs_

Le script pour cette m√©thode utilise une Cloud Function pr√©fabriqu√©e qui est incluse sur GitHub, ce qui signifie que vous devrez t√©l√©charger le fichier .zip associ√© et le rendre public sur Cloud Storage (voir le script d'exploitation pour plus d'informations). Une fois la fonction cr√©√©e et t√©l√©charg√©e, vous pouvez soit invoquer la fonction directement, soit modifier la politique IAM pour vous permettre d'invoquer la fonction. La r√©ponse inclura le token d'acc√®s appartenant au Service Account assign√© √† cette Cloud Function.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image12-750x618.png)

Le script cr√©e la fonction et attend qu'elle soit d√©ploy√©e, puis l'ex√©cute et r√©cup√®re le token d'acc√®s.

Les scripts d'exploitation pour cette m√©thode peuvent √™tre trouv√©s [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) et [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) et le fichier .zip pr√©construit peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update` , `iam.serviceAccounts.actAs`

Similaire √† _cloudfunctions.functions.create_, cette m√©thode **met √† jour (√©crase) une fonction existante au lieu de cr√©er une nouvelle**. L'API utilis√©e pour mettre √† jour la fonction vous permet √©galement de **changer le Service Account si vous en avez un autre pour lequel vous souhaitez obtenir le token**. Le script mettra √† jour la fonction cible avec le code malveillant, puis attendra son d√©ploiement, puis finalement l'invoquera pour r√©cup√©rer le token d'acc√®s du Service Account.

Les **permissions suivantes sont requises** pour cette m√©thode :

* _cloudfunctions.functions.sourceCodeSet_
* _cloudfunctions.functions.update_
* _iam.serviceAccounts.actAs_

Le script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

Donnez-vous l'une des privil√®ges pr√©c√©dents .update ou .create pour escalader.

### Permissions d'√©criture sur le Bucket

Un attaquant avec **des permissions d'√©criture sur le bucket** o√π le code des Cloud Functions est stock√© pourra **modifier le code en √©crasant** le `function_code.zip` et pourra **ex√©cuter du code arbitraire** une fois ex√©cut√©.

## R√©f√©rences

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
