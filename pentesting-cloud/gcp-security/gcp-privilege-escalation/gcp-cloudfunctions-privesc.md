# GCP - Privil√®ge d'escalade Cloudfunctions

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## cloudfunctions

### `cloudfunctions.functions.create`, `iam.serviceAccounts.actAs`

Pour cette m√©thode, nous allons **cr√©er une nouvelle fonction Cloud avec un compte de service associ√©** auquel nous voulons acc√©der. Comme les invocations de fonctions Cloud ont **acc√®s √† l'API de m√©tadonn√©es**, nous pouvons demander un jeton directement √† partir de celle-ci, tout comme sur une instance Compute Engine.

Les **autorisations requises** pour cette m√©thode sont les suivantes :

* _cloudfunctions.functions.call_ **OU** _cloudfunctions.functions.setIamPolicy_
* _cloudfunctions.functions.create_
* _cloudfunctions.functions.sourceCodeSet_
* _iam.serviceAccounts.actAs_

Le script pour cette m√©thode utilise une fonction Cloud pr√©fabriqu√©e qui est incluse sur GitHub, ce qui signifie que vous devrez t√©l√©charger le fichier .zip associ√© et le rendre public sur Cloud Storage (voir le script d'exploitation pour plus d'informations). Une fois que la fonction est cr√©√©e et t√©l√©charg√©e, vous pouvez soit invoquer la fonction directement, soit modifier la strat√©gie IAM pour vous permettre d'invoquer la fonction. La r√©ponse inclura le jeton d'acc√®s appartenant au compte de service assign√© √† cette fonction Cloud.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image12-750x618.png)

Le script cr√©e la fonction, attend qu'elle se d√©ploie, puis l'ex√©cute et r√©cup√®re le jeton d'acc√®s retourn√©.

Les scripts d'exploitation pour cette m√©thode peuvent √™tre trouv√©s [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) et [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) et le fichier .zip pr√©-construit peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update`, `iam.serviceAccounts.actAs`

Similaire √† _cloudfunctions.functions.create_, cette m√©thode **met √† jour (√©crase) une fonction existante au lieu d'en cr√©er une nouvelle**. L'API utilis√©e pour mettre √† jour la fonction vous permet √©galement de **√©changer le compte de service si vous en avez un autre pour lequel vous voulez obtenir le jeton**. Le script mettra √† jour la fonction cible avec le code malveillant, attendra qu'elle se d√©ploie, puis l'invoquera enfin pour r√©cup√©rer le jeton d'acc√®s du compte de service.

Les **autorisations suivantes sont requises** pour cette m√©thode :

* _cloudfunctions.functions.sourceCodeSet_
* _cloudfunctions.functions.update_
* _iam.serviceAccounts.actAs_

Le script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.setIamPolicy`, `iam.serviceAccounts.actAs`

Donnez-vous l'un des privil√®ges pr√©c√©dents .update ou .create pour escalader.

### Autorisations d'√©criture de bucket

Un attaquant ayant des **autorisations d'√©criture sur le bucket** o√π le code des fonctions Cloud est stock√© pourra **modifier le code en √©crasant** le `function_code.zip` et pourra **ex√©cuter du code arbitraire** une fois qu'il sera ex√©cut√©. 

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>