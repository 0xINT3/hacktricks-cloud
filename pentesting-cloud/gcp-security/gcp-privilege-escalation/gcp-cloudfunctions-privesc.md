# GCP - Cloudfunctions Privesc

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## cloudfunctions

### `cloudfunctions.functions.create` , `iam.serviceAccounts.actAs`

このメソッドでは、**関連するサービスアカウントを持つ新しいCloud Functionを作成**します。Cloud Functionの呼び出しでは、**メタデータAPIにアクセス**できるため、Compute Engineインスタンスと同様にトークンを直接リクエストできます。

このメソッドの**必要な権限**は次のとおりです：

* _cloudfunctions.functions.call_ **または** _cloudfunctions.functions.setIamPolicy_
* _cloudfunctions.functions.create_
* _cloudfunctions.functions.sourceCodeSet_
* _iam.serviceAccounts.actAs_

このメソッドのスクリプトは、GitHubに含まれている事前作成されたCloud Functionを使用します。したがって、関連する.zipファイルをアップロードし、Cloud Storageで公開する必要があります（詳細については、エクスプロイトスクリプトを参照してください）。関数が作成され、アップロードされた後、関数を直接呼び出すか、IAMポリシーを変更して関数の呼び出しを許可することができます。レスポンスには、そのCloud Functionに割り当てられたサービスアカウントのアクセストークンが含まれます。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image12-750x618.png)

スクリプトは関数を作成し、デプロイを待機し、それから実行してアクセストークンを取得します。

このメソッドのエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py)と[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py)で見つけることができ、事前に作成された.zipファイルは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions)で見つけることができます。

### `cloudfunctions.functions.update` , `iam.serviceAccounts.actAs`

_cloudfunctions.functions.create_と同様に、このメソッドは**既存の関数を更新（上書き）**します。関数を更新するために使用されるAPIでは、**別のトークンを取得したい別のサービスアカウントをスワップ**することもできます。スクリプトは悪意のあるコードでターゲットの関数を更新し、デプロイを待機し、最後に関数を呼び出してサービスアカウントのアクセストークンを取得します。

このメソッドには次の**権限が必要**です：

* _cloudfunctions.functions.sourceCodeSet_
* _cloudfunctions.functions.update_
* _iam.serviceAccounts.actAs_

このメソッドのエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py)で見つけることができます。

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

以前の.updateまたは.createの特権のいずれかを自分自身に与えて特権をエスカレーションします。

### バケットの書き込み権限

Cloud Functionsのコードが格納されているバケットに**書き込み権限を持つ攻撃者**は、`function_code.zip`を上書きしてコードを**変更**し、実行されると**任意の**コードを実行できます。

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
