# GCP - Cloudfunctions Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## cloudfunctions

Cloud Functionsに関する詳細情報:

{% content-ref url="../../gcp-pentesting/gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../../gcp-pentesting/gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create`, `cloudfunctions.functions.sourceCodeSet`, `iam.serviceAccounts.actAs`

この方法では、アクセスを得たい**関連付けられたサービスアカウントを持つ新しいCloud Functionを作成します**。Cloud Functionの呼び出しは**メタデータAPIにアクセスできる**ため、Compute Engineインスタンスのように、直接トークンをリクエストできます。

また、関数をトリガーするための**いくつかの権限が必要です**。

この方法のスクリプトは、GitHubに含まれている事前作成されたCloud Functionを使用します。つまり、関連する.zipファイルをアップロードしてCloud Storageで公開する必要があります（詳細はエクスプロイトスクリプトを参照）。関数が作成されアップロードされたら、直接関数を呼び出すか、関数を呼び出すためのIAMポリシーを変更できます。応答には、そのCloud Functionに割り当てられたサービスアカウントのアクセストークンが含まれます。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image12-750x618.png)

スクリプトは関数を作成し、デプロイを待ち、実行してアクセストークンを取得します。

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py)と[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py)にあり、事前構築された.zipファイルは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions)にあります。

### `cloudfunctions.functions.update`, `cloudfunctions.functions.sourceCodeSet`, `iam.serviceAccounts.actAs`

_cloudfunctions.functions.create_ と似ていますが、この方法では**新しいものを作成する代わりに既存の関数を更新（上書き）します**。関数を更新するために使用されるAPIは、**トークンを取得したい別のサービスアカウントに切り替えることもできます**。スクリプトは悪意のあるコードで対象の関数を更新し、デプロイを待ち、最終的にはサービスアカウントのアクセストークンが返されるように呼び出します。

また、関数をトリガーするための**いくつかの権限が必要です**、または誰かがそれをトリガーするまで待つ必要があります。

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py)にあります。

### `cloudfunctions.functions.sourceCodeSet`

この権限を持っていると、**関数バケットにファイルをアップロードするための署名付きURLを取得できます（ただし、関数のコードは変更されません。更新する必要があります）**。

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
{% endcode %}

攻撃者の視点からこの権限だけがどれほど有用かは不明ですが、知っておくと良いでしょう。

### `cloudfunctions.functions.setIamPolicy`, `iam.serviceAccounts.actAs`

自分自身に以前の **`.update`** や **`.create`** 権限を与えて権限昇格を行います。

### `cloudfunctions.functions.update`

**`cloudfunctions`** 権限のみを持っていて、**`iam.serviceAccounts.actAs`** がない場合、関数を更新することはできないので、これは有効な権限昇格ではありません。

### バケット書き込み権限

バケットに対する**書き込み権限**を持つ攻撃者は、Cloud Functionsのコードが保存されているバケットのコードを**上書きして変更**し、実行されると**任意のコードを実行**することができます。

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
