# GCP - Cloudfunctions Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## cloudfunctions

### `cloudfunctions.functions.create` , `iam.serviceAccounts.actAs`

この方法では、アクセスを得たい**関連付けられたサービスアカウントを持つ新しいCloud Functionを作成します**。Cloud Functionの呼び出しは**メタデータAPIにアクセスできる**ため、Compute Engineインスタンスと同様に、直接トークンを要求できます。

この方法には以下の**必要な権限**があります:

* _cloudfunctions.functions.call_ **または** _cloudfunctions.functions.setIamPolicy_
* _cloudfunctions.functions.create_
* _cloudfunctions.functions.sourceCodeSet_
* _iam.serviceAccounts.actAs_

この方法のスクリプトは、GitHubに含まれている事前作成されたCloud Functionを使用します。つまり、関連する.zipファイルをアップロードしてCloud Storageで公開する必要があります（詳細についてはエクスプロイトスクリプトを参照）。関数が作成されアップロードされたら、直接関数を呼び出すか、関数を呼び出すためのIAMポリシーを変更できます。応答には、そのCloud Functionに割り当てられたサービスアカウントのアクセストークンが含まれます。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image12-750x618.png)

スクリプトは関数を作成し、デプロイを待ち、実行してアクセストークンを取得します。

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py)と[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py)にあり、事前構築された.zipファイルは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions)にあります。

### `cloudfunctions.functions.update` , `iam.serviceAccounts.actAs`

_cloudfunctions.functions.create_ と同様に、この方法は**新しいものを作成する代わりに既存の関数を更新（上書き）します**。関数を更新するために使用されるAPIは、**トークンを取得したい別のサービスアカウントに切り替えることもできます**。スクリプトは悪意のあるコードでターゲット関数を更新し、デプロイを待ち、最終的にはサービスアカウントのアクセストークンが返されるように呼び出します。

この方法には以下の**権限が必要**です:

* _cloudfunctions.functions.sourceCodeSet_
* _cloudfunctions.functions.update_
* _iam.serviceAccounts.actAs_

この方法のエクスプロイトスクリプトは[こちら](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py)にあります。

### `cloudfunctions.functions.setIamPolicy` , `iam.serviceAccounts.actAs`

以前の.updateまたは.create権限のいずれかを自分自身に与えてエスカレーションします。

### Bucket Write Permissions

Cloud Functionsのコードが格納されているバケットに**書き込み権限を持つ攻撃者**は、`function_code.zip`を上書きしてコードを**変更することができ**、実行されると**任意の**コードを実行できます。

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
