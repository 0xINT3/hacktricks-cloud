# GCP - Cloudfunctions Privesc

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## cloudfunctions

Plus d'informations sur Cloud Functions :

{% content-ref url="../../gcp-pentesting/gcp-services/gcp-cloud-functions-enum.md" %}
[gcp-cloud-functions-enum.md](../../gcp-pentesting/gcp-services/gcp-cloud-functions-enum.md)
{% endcontent-ref %}

### `cloudfunctions.functions.create`, `cloudfunctions.functions.sourceCodeSet`, `iam.serviceAccounts.actAs`

Pour cette m√©thode, nous allons **cr√©er une nouvelle Cloud Function avec un Service Account associ√©** auquel nous voulons acc√©der. Comme les invocations de Cloud Function ont **acc√®s √† l'API de m√©tadonn√©es**, nous pouvons demander un jeton directement √† partir de celle-ci, tout comme sur une instance Compute Engine.

Vous aurez √©galement besoin de **certaines permissions pour d√©clencher la fonction**.

Le script pour cette m√©thode utilise une Cloud Function pr√©fabriqu√©e qui est incluse sur GitHub, ce qui signifie que vous devrez t√©l√©charger le fichier .zip associ√© et le rendre public sur Cloud Storage (voir le script d'exploitation pour plus d'informations). Une fois la fonction cr√©√©e et t√©l√©charg√©e, vous pouvez soit invoquer la fonction directement, soit modifier la politique IAM pour vous permettre d'invoquer la fonction. La r√©ponse inclura le jeton d'acc√®s appartenant au Service Account assign√© √† cette Cloud Function.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image12-750x618.png)

Le script cr√©e la fonction et attend qu'elle soit d√©ploy√©e, puis l'ex√©cute et r√©cup√®re le jeton d'acc√®s.

Les scripts d'exploitation pour cette m√©thode peuvent √™tre trouv√©s [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-call.py) et [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.create-setIamPolicy.py) et le fichier .zip pr√©construit peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudFunctions).

### `cloudfunctions.functions.update`, `cloudfunctions.functions.sourceCodeSet`, `iam.serviceAccounts.actAs`

Similaire √† _cloudfunctions.functions.create_, cette m√©thode **met √† jour (√©crase) une fonction existante au lieu de cr√©er une nouvelle**. L'API utilis√©e pour mettre √† jour la fonction vous permet √©galement de **changer le Service Account si vous en avez un autre pour lequel vous voulez obtenir le jeton**. Le script mettra √† jour la fonction cible avec le code malveillant, puis attendra qu'elle soit d√©ploy√©e, puis finalement l'invoquera pour r√©cup√©rer le jeton d'acc√®s du Service Account.

Vous aurez √©galement besoin de **certaines permissions pour d√©clencher la fonction ou attendre** que quelqu'un la d√©clenche.

Le script d'exploitation pour cette m√©thode peut √™tre trouv√© [ici](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudfunctions.functions.update.py).

### `cloudfunctions.functions.sourceCodeSet`

Avec cette permission, vous pouvez obtenir une **URL sign√©e pour pouvoir t√©l√©charger un fichier dans un bucket de fonction (mais le code de la fonction ne sera pas chang√©, vous devrez toujours le mettre √† jour)**

{% code overflow="wrap" %}
```bash
# Generate the URL
curl -X POST https://cloudfunctions.googleapis.com/v2/projects/{project-id}/locations/{location}/functions:generateUploadUrl \
-H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
-H "Content-Type: application/json" \
-d '{}'
```
```markdown
{% endcode %}

Pas vraiment s√ªr de l'utilit√© de cette permission seule du point de vue d'un attaquant, mais c'est bon √† savoir.

### `cloudfunctions.functions.setIamPolicy`, `iam.serviceAccounts.actAs`

Donnez-vous l'un des privil√®ges **`.update`** ou **`.create`** pr√©c√©dents pour vous √©lever en privil√®ges.

### `cloudfunctions.functions.update`

N'ayant que les permissions **`cloudfunctions`**, sans **`iam.serviceAccounts.actAs`**, vous **ne pourrez pas mettre √† jour la fonction DONC CE N'EST PAS UNE √âL√âVATION DE PRIVIL√àGES VALIDE.**

### Permissions d'√©criture sur Bucket

Un attaquant avec **des permissions d'√©criture sur le bucket** o√π le code des Cloud Functions est stock√© pourra **modifier le code en √©crasant** le `function_code.zip` et pourra **ex√©cuter du code arbitraire** une fois ex√©cut√©.

## R√©f√©rences

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
