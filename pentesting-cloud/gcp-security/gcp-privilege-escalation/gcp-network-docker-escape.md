# GCP - ネットワークDockerエスケープ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 初期状態

この技術が指定されている両方のライトアップで、攻撃者はGCPによって管理されている**Docker**コンテナ内で**root**アクセスを取得し、ホストネットワーク（および機能**`CAP_NET_ADMIN`**と**`CAP_NET_RAW`**）にアクセスしました。

## 攻撃

通常のGoogle Compute Engineインスタンスでネットワークトラフィックを調査すると、多くの**平文HTTPリクエスト**が**`169.254.169.254`**の**メタデータ**インスタンスに向けられているのが見られます。このようなリクエストを行うサービスの一つがオープンソースの[**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)です。リクエスト例:

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

このエージェントは**メタデータの変更を監視します。** **メタデータ**内には、承認された**SSH公開**キーの**フィールド**があります。\
したがって、メタデータに新しい公開SSHキーが表示されると、エージェントはユーザーの`.authorized_key`ファイルでそれを**承認**し、必要に応じて新しいユーザーを**作成**し、**sudoers**に追加します。

Google Guest Agentが変更を監視する方法は、**再帰的にすべてのメタデータ値を取得**する呼び出しを通じて行われます（`GET /computeMetadata/v1/?recursive=true`）、メタデータサーバーに対して、最後に取得したメタデータ値に対して変更がある場合のみ応答を送信するよう指示します。これはEtagによって識別されます（`wait_for_change=true&last_etag=`）。

このリクエストには**タイムアウト**も含まれています（`timeout_sec=`）。指定された時間内に**変更が発生しない**場合、メタデータサーバーは**変更されていない値**で応答します。

これにより、**IMDS**はその間隔で設定変更がなかった場合、**60秒後**に**応答**し、ゲストエージェントに対してIMDSから偽の設定応答を**注入するためのウィンドウ**を許可します。

したがって、攻撃者が**MitM**攻撃を実行することに成功した場合、**IMDS**サーバーからの**応答を偽装**し、新しいユーザーが**SSH**を介してホストにアクセスするための新しい公開キーを**挿入**することができます。

### エスケープ

ARPスプーフィングはGoogle Compute Engineネットワークでは機能しませんが、[**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)はSSHユーザーを注入するための通信にパケットを注入するために使用できる[**rshijack**](https://github.com/ezequielpereira/rshijack)の**変更版**を生成しました。

この変更版のrshijackでは、ACKとSEQの番号をコマンドライン引数として**渡すことができ**、時間を節約し、実際のメタデータ応答が来る前に**応答を偽装**することができます。\
\
さらに、Google Guest Agentが`.authorized_keys`ファイルに自分の公開キーを持つユーザー`wouter`を**作成する**ようにトリガーする**特別に作成されたペイロード**を返す[**小さなShellスクリプト**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh)があります。\
\
このスクリプトはETagをパラメータとして受け取ります。同じETagを保持することで、メタデータサーバーは次の応答でGoogle Guest Agentにメタデータ値が異なることをすぐには伝えず、代わりにtimeout\_secで指定された秒数を待ちます。\
\
スプーフィングを実現するには、**tcpdumpでメタデータ**サーバーへのリクエストを監視する必要があります: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &` このような行を待ちます:

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

その値が表示されたら、**正しいETAGを使って偽のメタデータを `rshijack` に送信します**:

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

これにより、エージェントはその公開鍵を**認証し**、**SSH**を介して**プライベート**鍵で**接続**することを許可します。

## 参考文献

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
