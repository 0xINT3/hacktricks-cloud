# GCP - √âvasion de r√©seau Docker

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## √âtat initial

Dans les deux articles o√π cette technique est sp√©cifi√©e, les attaquants ont r√©ussi √† obtenir un acc√®s **root** √† l'int√©rieur d'un conteneur **Docker** g√©r√© par GCP avec acc√®s au r√©seau h√¥te (et les capacit√©s **`CAP_NET_ADMIN`** et **`CAP_NET_RAW`**).

## Attaque

Lorsque vous inspectez le trafic r√©seau sur une instance Google Compute Engine r√©guli√®re, vous verrez beaucoup de **requ√™tes HTTP en clair** dirig√©es vers l'instance de **m√©tadonn√©es** sur **`169.254.169.254`**. Un service qui effectue de telles requ√™tes est l'agent open-source [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent). Exemple de requ√™te :

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

Cet agent **surveille les m√©tadonn√©es pour d√©tecter des changements.** √Ä l'int√©rieur des **m√©tadonn√©es**, il y a un **champ** avec des cl√©s publiques **SSH autoris√©es**.\
Ainsi, lorsqu'une nouvelle cl√© publique SSH appara√Æt dans les m√©tadonn√©es, l'agent va **autoriser** cette cl√© dans le fichier `.authorized_key` de l'utilisateur et il va **cr√©er** un nouvel utilisateur si n√©cessaire en l'ajoutant aux **sudoers**.

La mani√®re dont l'agent Google Guest surveille les changements est par un appel pour **r√©cup√©rer toutes les valeurs des m√©tadonn√©es de mani√®re r√©cursive** (`GET /computeMetadata/v1/?recursive=true`), indiquant au serveur de m√©tadonn√©es de **ne r√©pondre que lorsqu'il y a un changement** par rapport aux derni√®res valeurs de m√©tadonn√©es r√©cup√©r√©es, identifi√©es par son Etag (`wait_for_change=true&last_etag=`).

Cette requ√™te inclut √©galement un **d√©lai d'attente** (`timeout_sec=`), donc si un **changement ne se produit pas** dans le temps sp√©cifi√©, le serveur de m√©tadonn√©es r√©pond avec les **valeurs inchang√©es**.

Cela fait que l'**IMDS** **r√©ponde** apr√®s **60 secondes** s'il n'y a pas eu de changement de configuration dans cet intervalle, permettant une **fen√™tre pour injecter une fausse r√©ponse de configuration** √† l'agent invit√© de l'IMDS.

Par cons√©quent, si un attaquant r√©ussit √† r√©aliser une attaque **MitM**, il pourrait **usurper** la **r√©ponse** du serveur **IMDS** **en ins√©rant une nouvelle cl√© publique** pour permettre √† un nouvel utilisateur d'acc√©der via **SSH** √† l'h√¥te.

### √âvasion

Le spoofing ARP ne fonctionne pas sur les r√©seaux Google Compute Engine, cependant, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) a g√©n√©r√© cette **version modifi√©e de** [**rshijack**](https://github.com/ezequielpereira/rshijack) **** qui peut √™tre utilis√©e pour injecter un paquet dans la communication afin d'injecter l'utilisateur SSH.

Cette version modifi√©e de rshijack permet de **passer les num√©ros ACK et SEQ en arguments de ligne de commande**, √©conomisant du temps et nous permettant d'**usurper une r√©ponse** avant que la vraie r√©ponse des m√©tadonn√©es n'arrive.\
\
De plus, **ce** [**petit script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** qui retournerait un **payload sp√©cialement con√ßu** qui d√©clencherait l'agent Google Guest √† **cr√©er l'utilisateur `wouter`,** avec notre propre cl√© publique dans son fichier `.authorized_keys`.\
\
Ce script re√ßoit l'ETag en param√®tre, car en gardant le m√™me ETag, le serveur de m√©tadonn√©es ne dirait pas imm√©diatement √† l'agent Google Guest que les valeurs des m√©tadonn√©es √©taient diff√©rentes lors de la prochaine r√©ponse, attendant plut√¥t le nombre de secondes sp√©cifi√© dans timeout\_sec.\
\
Pour r√©aliser l'usurpation, vous devriez **surveiller les requ√™tes vers le serveur de m√©tadonn√©es** avec **tcpdump : `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** en attendant une ligne qui ressemblerait √† ceci :

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

Lorsque vous voyez cette valeur, envoyez les **fausses m√©tadonn√©es avec le bon ETAG √† `rshijack`** :

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <IP_LOCALE>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

Et cela devrait faire en sorte que l'agent **autorise cette cl√© publique** qui vous permettra de vous **connecter** via **SSH** avec la cl√© **priv√©e**.

## R√©f√©rences

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
