# GCP - 网络Docker逃逸

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 初始状态

在指定了此技术的两个writeup中，攻击者成功在由GCP管理的Docker容器内获得了**root**访问权限，并且可以访问主机网络（以及具有**`CAP_NET_ADMIN`**和**`CAP_NET_RAW`**的权限）。

## 攻击

当您检查常规Google Compute Engine实例上的网络流量时，您会看到大量的**明文HTTP请求**被定向到**`169.254.169.254`**上的**metadata**实例。一个进行此类请求的服务是开源的[**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)。请求示例：

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

该代理程序**监视元数据的更改**。在**metadata**中，有一个带有授权的**SSH公钥**字段。\
因此，当元数据中出现新的公共SSH密钥时，代理程序将在用户的`.authorized_key`文件中**授权**它，并在需要时**创建**一个新用户并将其添加到**sudoers**。

Google Guest Agent监视更改的方式是通过调用**递归检索所有元数据值**（`GET /computeMetadata/v1/?recursive=true`），告知元数据服务器**仅在与上次检索的元数据值有任何更改时**发送响应，通过其Etag进行标识（`wait_for_change=true&last_etag=`）。

此请求还包括一个**超时**（`timeout_sec=`），因此如果在指定的时间内**没有更改**发生，元数据服务器将以**未更改的值**响应。

这使得**IMDS**在该间隔内没有配置更改时**60秒后**响应，从IMDS向客户代理注入一个伪造的配置响应的**窗口**。

因此，如果攻击者成功执行**MitM**攻击，他可以**伪造**来自**IMDS**服务器的**响应**，插入一个新的公钥，以允许新用户通过**SSH**访问主机。

### 逃逸

ARP欺骗在Google Compute Engine网络上不起作用，但是，[**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)生成了这个**修改版本的**[**rshijack**](https://github.com/ezequielpereira/rshijack) ****，可以用于在通信中注入数据包以注入SSH用户。

这个修改版本的rshijack允许将ACK和SEQ号作为命令行参数传递，节省时间并允许我们在真正的Metadata响应到来之前**伪造一个响应**。\
\
此外，**这个**[**小型Shell脚本**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) ****将返回一个**特制的有效负载**，该有效负载将触发Google Guest Agent在其`.authorized_keys`文件中**创建用户`wouter`**，并包含我们自己的公钥。\
\
该脚本接收ETag作为参数，因为通过保持相同的ETag，元数据服务器不会立即告诉Google Guest Agent下一个响应中的元数据值与上次不同，而是等待timeout\_sec指定的秒数。\
\
要实现伪造，您应该使用**tcpdump监视对Metadata服务器的请求**：`tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`，等待出现类似以下行的内容：

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

当你看到该值时，使用正确的ETAG向`rshijack`发送**伪造的元数据数据**：

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

这将使代理**授权该公钥**，从而允许您使用**私钥**通过**SSH**进行**连接**。

## 参考资料

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
