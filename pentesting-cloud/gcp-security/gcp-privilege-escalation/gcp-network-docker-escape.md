# GCP - Fuga de Rede Docker

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Estado Inicial

Nos relatos onde essa t√©cnica √© especificada, os atacantes conseguiram acesso **root** dentro de um container **Docker** gerenciado pelo GCP com acesso √† rede do host (e as capacidades **`CAP_NET_ADMIN`** e **`CAP_NET_RAW`**).

## Ataque

Quando voc√™ inspeciona o tr√°fego de rede em uma inst√¢ncia regular do Google Compute Engine, voc√™ ver√° muitas **requisi√ß√µes HTTP simples** sendo direcionadas para a inst√¢ncia de **metadados** em **`169.254.169.254`**. Um servi√ßo que faz tais requisi√ß√µes √© o [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) de c√≥digo aberto. Exemplo de requisi√ß√£o:

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

Este agente **monitora os metadados para mudan√ßas.** Dentro dos **metadados** h√° um **campo** com chaves p√∫blicas **SSH** autorizadas.\
Portanto, quando uma nova chave p√∫blica SSH aparece nos metadados, o agente ir√° **autorizar** a mesma no arquivo `.authorized_key` do usu√°rio e ir√° **criar** um novo usu√°rio se necess√°rio, adicionando-o aos **sudoers**.

A forma como o Google Guest Agent monitora mudan√ßas √© atrav√©s de uma chamada para **recuperar todos os valores de metadados recursivamente** (`GET /computeMetadata/v1/?recursive=true`), indicando ao servidor de metadados para **enviar uma resposta apenas quando houver alguma mudan√ßa** em rela√ß√£o aos √∫ltimos valores de metadados recuperados, identificados pelo seu Etag (`wait_for_change=true&last_etag=`).

Esta requisi√ß√£o tamb√©m inclui um **tempo limite** (`timeout_sec=`), ent√£o se uma **mudan√ßa n√£o** ocorrer dentro do tempo especificado, o servidor de metadados responde com os **valores inalterados**.

Isso faz com que o **IMDS** **responda** ap√≥s **60** **segundos** se n√£o houve mudan√ßa de configura√ß√£o nesse intervalo, permitindo uma **janela para injetar uma resposta de configura√ß√£o falsa** ao agente convidado do IMDS.

Portanto, se um atacante conseguir realizar um ataque **MitM**, ele poderia **falsificar** a **resposta** do servidor **IMDS** **inserindo uma nova chave p√∫blica** para permitir que um novo usu√°rio acesse via **SSH** ao host.

### Fuga

ARP spoofing n√£o funciona nas redes do Google Compute Engine, no entanto, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) gerou esta **vers√£o modificada de** [**rshijack**](https://github.com/ezequielpereira/rshijack) **** que pode ser usada para injetar um pacote na comunica√ß√£o para injetar o usu√°rio SSH.

Esta vers√£o modificada do rshijack permite **passar os n√∫meros ACK e SEQ como argumentos de linha de comando**, economizando tempo e permitindo que n√≥s **falsifiquemos uma resposta** antes que a verdadeira resposta do Metadata chegasse.\
\
Al√©m disso, **este** [**pequeno script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** que retornaria um **payload especialmente criado** que acionaria o Google Guest Agent para **criar o usu√°rio `wouter`,** com nossa pr√≥pria chave p√∫blica no seu arquivo `.authorized_keys`.\
\
Este script recebe o ETag como par√¢metro, j√° que mantendo o mesmo ETag, o servidor de Metadados n√£o informaria imediatamente ao Google Guest Agent que os valores de metadados eram diferentes na pr√≥xima resposta, em vez disso, esperando a quantidade especificada de segundos em timeout\_sec.\
\
Para realizar a falsifica√ß√£o, voc√™ deve **observar as requisi√ß√µes ao servidor de Metadados** com **tcpdump: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** esperando por uma linha que pare√ßa com esta:

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

Quando voc√™ ver esse valor, envie os **dados falsos de metadados com o ETAG correto para `rshijack`**:

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

E isso deve fazer com que o agente **autorize essa chave p√∫blica** que permitir√° que voc√™ **conecte** via **SSH** com a chave **privada**.

## Refer√™ncias

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
