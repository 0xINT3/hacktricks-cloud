# GCP - 网络 Docker 逃逸

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 初始状态

在指定这项技术的两篇文章中，攻击者都成功获得了 GCP 管理的 **Docker** 容器内的 **root** 访问权限，并且可以访问宿主网络（并具有 **`CAP_NET_ADMIN`** 和 **`CAP_NET_RAW`** 权限）。

## 攻击

当您在常规的 Google Compute Engine 实例上检查网络流量时，您会看到很多**明文 HTTP 请求**被定向到 **`169.254.169.254`** 上的 **metadata** 实例。一个发出此类请求的服务是开源的 [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)。请求示例：

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

该代理**监控 metadata 的变化**。在 **metadata** 中有一个包含授权的 **SSH 公钥**的**字段**。\
因此，当 metadata 中出现新的公共 SSH 密钥时，代理将在用户的 `.authorized_key` 文件中**授权**它，并在必要时**创建**一个新用户，并将其添加到 **sudoers** 中。

Google Guest Agent 监控变化的方式是通过调用**递归检索所有 metadata 值**（`GET /computeMetadata/v1/?recursive=true`），指示 metadata 服务器**仅在有任何变化**时发送响应，与上次检索的 metadata 值相比，由其 Etag 标识（`wait_for_change=true&last_etag=`）。

此请求还包括一个**超时**（`timeout_sec=`），因此如果在指定的时间内**没有发生变化**，metadata 服务器会响应**未更改的值**。

这使得 **IMDS** 在没有配置更改的 60 秒后**响应**，为向来宾代理注入假配置响应提供了**窗口**。

因此，如果攻击者设法执行 **MitM** 攻击，他可以**伪造**来自 **IMDS** 服务器的**响应**，**插入新的公钥**，以允许新用户通过 **SSH** 访问宿主。

### 逃逸

ARP 欺骗在 Google Compute Engine 网络上不起作用，但是 [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) 生成了这个**修改版的** [**rshijack**](https://github.com/ezequielpereira/rshijack) ****，可以用来在通信中注入数据包以注入 SSH 用户。

这个修改版的 rshijack 允许**通过命令行参数传递 ACK 和 SEQ 号码**，节省时间并允许我们在真正的 Metadata 响应到来之前**伪造响应**。\
\
此外，**这个** [**小型 Shell 脚本**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** 可以返回一个**特别制作的有效载荷**，触发 Google Guest Agent **创建用户 `wouter`**，并在其 `.authorized_keys` 文件中添加我们自己的公钥。\
\
这个脚本接收 ETag 作为参数，因为保持相同的 ETag，Metadata 服务器不会立即告诉 Google Guest Agent 下一个响应中的 metadata 值有所不同，而是等待 timeout\_sec 中指定的秒数。\
\
要实现欺骗，您应该**观察对 Metadata** 服务器的请求，使用 **tcpdump: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** 等待看到像这样的行：

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

当您看到该值时，使用正确的ETAG向**`rshijack`**发送**假元数据**：

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

这应该会让代理**授权那个公钥**，允许您通过**SSH**使用**私钥**进行**连接**。

## 参考资料

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks**中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
