# GCP - Fuga de Rede Docker

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Estado Inicial

Em ambos os relat√≥rios em que essa t√©cnica √© especificada, os atacantes conseguiram obter acesso **root** dentro de um cont√™iner **Docker** gerenciado pelo GCP com acesso √† rede do host (e as capacidades **`CAP_NET_ADMIN`** e **`CAP_NET_RAW`**).

## Ataque

Ao inspecionar o tr√°fego de rede em uma inst√¢ncia regular do Google Compute Engine, voc√™ ver√° muitas solicita√ß√µes **HTTP simples** sendo direcionadas para a inst√¢ncia de **metadados** em **`169.254.169.254`**. Um servi√ßo que faz tais solicita√ß√µes √© o [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) de c√≥digo aberto. Exemplo de solicita√ß√£o:

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

Este agente **monitora os metadados em busca de altera√ß√µes**. Dentro dos **metadados**, h√° um **campo** com as **chaves p√∫blicas SSH** autorizadas.\
Portanto, quando uma nova chave p√∫blica SSH aparece nos metadados, o agente **a autoriza** no arquivo `.authorized_key` do usu√°rio e **cria** um novo usu√°rio, se necess√°rio, adicionando-o aos **sudoers**.

A maneira como o Google Guest Agent monitora as altera√ß√µes √© por meio de uma chamada para **recuperar todos os valores de metadados recursivamente** (`GET /computeMetadata/v1/?recursive=true`), indicando ao servidor de metadados para **enviar uma resposta somente quando houver alguma altera√ß√£o** em rela√ß√£o aos √∫ltimos valores de metadados recuperados, identificados por seu Etag (`wait_for_change=true&last_etag=`).

Esta solicita√ß√£o tamb√©m inclui um **tempo limite** (`timeout_sec=`), portanto, se uma **altera√ß√£o n√£o ocorrer** dentro do tempo especificado, o servidor de metadados responde com os valores **inalterados**.

Isso faz com que o **IMDS** responda ap√≥s **60 segundos** se n√£o houver altera√ß√£o de configura√ß√£o nesse intervalo, permitindo uma **janela para injetar uma resposta de configura√ß√£o falsa** para o agente convidado do IMDS.

Portanto, se um invasor conseguir realizar um ataque **MitM**, ele poder√° **falsificar** a **resposta** do servidor **IMDS** **inserindo uma nova chave p√∫blica** para permitir que um novo usu√°rio acesse via **SSH** ao host.

### Fuga

O spoofing ARP n√£o funciona nas redes do Google Compute Engine, no entanto, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) gerou esta **vers√£o modificada do** [**rshijack**](https://github.com/ezequielpereira/rshijack) **** que pode ser usada para injetar um pacote na comunica√ß√£o para injetar o usu√°rio SSH.

Esta vers√£o modificada do rshijack permite **passar os n√∫meros ACK e SEQ como argumentos de linha de comando**, economizando tempo e permitindo-nos **falsificar uma resposta** antes que a resposta real do Metadata chegasse.\
\
Al√©m disso, **este** [**pequeno script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** que retornaria uma **carga √∫til especialmente criada** que acionaria o Google Guest Agent para **criar o usu√°rio `wouter`,** com nossa pr√≥pria chave p√∫blica em seu arquivo `.authorized_keys`.\
\
Este script recebe o ETag como par√¢metro, uma vez que, mantendo o mesmo ETag, o servidor de metadados n√£o informaria imediatamente ao Google Guest Agent que os valores de metadados eram diferentes na pr√≥xima resposta, em vez disso, esperando a quantidade especificada de segundos em timeout\_sec.\
\
Para realizar o spoofing, voc√™ deve **observar as solicita√ß√µes ao Metadata** servidor com **tcpdump: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** esperando por uma linha que se parecesse com esta:

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

Quando voc√™ vir esse valor, envie os **dados de metadados falsos com o ETAG correto para `rshijack`**:

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

E isso deve fazer com que o agente **autorize essa chave p√∫blica** que permitir√° que voc√™ se **conecte** via **SSH** com a **chave privada**.

## Refer√™ncias

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>