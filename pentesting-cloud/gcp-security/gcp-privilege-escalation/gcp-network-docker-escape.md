# GCP - Escape de Red Docker

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Estado Inicial

En ambos informes donde se especifica esta t√©cnica, los atacantes lograron obtener acceso de **root** dentro de un contenedor **Docker** gestionado por GCP con acceso a la red del host (y las capacidades **`CAP_NET_ADMIN`** y **`CAP_NET_RAW`**).

## Ataque

Cuando inspeccionas el tr√°fico de red en una instancia regular de Google Compute Engine, ver√°s muchos **solicitudes HTTP simples** dirigidas a la instancia de **metadata** en **`169.254.169.254`**. Un servicio que realiza tales solicitudes es el [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent) de c√≥digo abierto. Ejemplo de solicitud:

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

Este agente **monitorea los cambios en la metadata.** Dentro de la **metadata** hay un **campo** con claves p√∫blicas **SSH** autorizadas.\
Por lo tanto, cuando una nueva clave p√∫blica SSH aparece en la metadata, el agente la **autorizar√°** en el archivo `.authorized_key` del usuario y **crear√°** un nuevo usuario si es necesario, a√±adi√©ndolo a **sudoers**.

La forma en que el Google Guest Agent monitorea los cambios es a trav√©s de una llamada para **recuperar todos los valores de metadata recursivamente** (`GET /computeMetadata/v1/?recursive=true`), indicando al servidor de metadata que **solo env√≠e una respuesta cuando haya alg√∫n cambio** con respecto a los √∫ltimos valores de metadata recuperados, identificados por su Etag (`wait_for_change=true&last_etag=`).

Esta solicitud tambi√©n incluye un **tiempo de espera** (`timeout_sec=`), por lo que si un **cambio no ocurre** dentro del tiempo especificado, el servidor de metadata responde con los **valores sin cambios**.

Esto hace que el **IMDS** **responda** despu√©s de **60 segundos** si no hubo un cambio de configuraci√≥n en ese intervalo, permitiendo una **ventana para inyectar una respuesta de configuraci√≥n falsa** al agente invitado desde el IMDS.

Por lo tanto, si un atacante logra realizar un ataque **MitM**, podr√≠a **falsificar** la **respuesta** del servidor **IMDS** **insertando una nueva clave p√∫blica** para permitir que un nuevo usuario acceda v√≠a **SSH** al host.

### Escape

El spoofing ARP no funciona en las redes de Google Compute Engine, sin embargo, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) gener√≥ esta **versi√≥n modificada de** [**rshijack**](https://github.com/ezequielpereira/rshijack) **** que se puede utilizar para inyectar un paquete en la comunicaci√≥n e inyectar el usuario SSH.

Esta versi√≥n modificada de rshijack permite **pasar los n√∫meros ACK y SEQ como argumentos de l√≠nea de comando**, ahorrando tiempo y permiti√©ndonos **falsificar una respuesta** antes de que llegue la verdadera respuesta de Metadata.\
\
Adem√°s, **este** [**peque√±o script de Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** que devolver√≠a un **payload especialmente dise√±ado** que activar√≠a al Google Guest Agent para **crear el usuario `wouter`,** con nuestra propia clave p√∫blica en su archivo `.authorized_keys`.\
\
Este script recibe el ETag como par√°metro, ya que al mantener el mismo ETag, el servidor de Metadata no le dir√≠a inmediatamente al Google Guest Agent que los valores de la metadata eran diferentes en la siguiente respuesta, en su lugar esperando la cantidad de segundos especificada en timeout\_sec.\
\
Para lograr el spoofing, deber√≠as **observar las solicitudes al servidor de Metadata** con **tcpdump: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** esperando una l√≠nea que se pareciera a esta:

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

Cuando veas ese valor, env√≠a los **datos falsos de metadatos con el ETAG correcto a `rshijack`**:

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <IP_LOCAL>:<PUERTO> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

Y esto deber√≠a hacer que el agente **autorice esa clave p√∫blica** que te permitir√° **conectarte** v√≠a **SSH** con la clave **privada**.

## Referencias

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
