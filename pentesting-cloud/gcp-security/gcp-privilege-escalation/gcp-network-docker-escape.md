# GCP - Netwerk Docker Ontsnapping

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Aanvanklike Toestand

In beide write-ups waar hierdie tegniek gespesifiseer word, het die aanvallers **root-toegang** binne 'n **Docker**-houer wat deur GCP bestuur word, verkry met toegang tot die gasheer-netwerk (en die vermo√´ns **`CAP_NET_ADMIN`** en **`CAP_NET_RAW`**).

## Aanval Verduideliking

Op 'n Google Compute Engine-instantie toon gereelde inspeksie van netwerkverkeer tallose **gewone HTTP-versoeke** na die **metadata-instantie** by `169.254.169.254`. Die [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent), 'n oopbron-diens, maak gereeld sulke versoeke.

Hierdie agent is ontwerp om **veranderinge in die metadata te monitor**. Merkwaardig sluit die metadata 'n **veld vir SSH-publieke sleutels** in. Wanneer 'n nuwe publieke SSH-sleutel by die metadata gevoeg word, **magtig** die agent dit outomaties in die `.authorized_key`-l√™er. Dit kan ook 'n nuwe gebruiker **skep** en hulle by **sudoers** voeg indien nodig.

Die agent monitor veranderinge deur 'n versoek te stuur om **alle metadata-waardes outomaties te herwin** (`GET /computeMetadata/v1/?recursive=true`). Hierdie versoek is ontwerp om die metadata-bediener te laat reageer slegs as daar enige verandering in die metadata sedert die laaste herwinning is, ge√Ødentifiseer deur 'n Etag (`wait_for_change=true&last_etag=`). Daarbenewens word 'n **timeout**-parameter (`timeout_sec=`) ingesluit. As geen verandering binne die gespesifiseerde timeout plaasvind nie, reageer die bediener met die **ongewysigde waardes**.

Hierdie proses maak dit moontlik vir die **IMDS** (Instance Metadata Service) om na **60 sekondes** te reageer as geen konfigurasieverandering plaasgevind het nie, wat 'n potensi√´le **venster skep vir die inspuiting van 'n vals konfigurasierespons** na die gasheeragent.

'n Aanvaller kan hiervan misbruik maak deur 'n **Man-in-the-Middle (MitM) aanval** uit te voer, waarby die respons van die IMDS-bediener vervals word en 'n nuwe publieke sleutel **ingespuit** word. Dit kan ongemagtigde SSH-toegang tot die gasheer moontlik maak.

### Ontsnappingstegniek

Hoewel ARP-spoofing nie effektief is op Google Compute Engine-netwerke nie, kan 'n [**aangepaste weergawe van rshijack**](https://github.com/ezequielpereira/rshijack) ontwikkel deur [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) gebruik word vir pakketsinspuiting in die kommunikasie om die SSH-gebruiker in te spuit.

Hierdie weergawe van rshijack maak dit moontlik om die ACK- en SEQ-nommers as opdragre√´l-argumente in te voer, wat die vervalsing van 'n respons voor die werklike Metadata-bediener-respons fasiliteer. Daarbenewens word 'n [**klein Shell-skripsie**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) gebruik om 'n **spesiaal vervaardigde payload** terug te gee. Hierdie payload veroorsaak dat die Google Guest Agent 'n gebruiker `wouter` **skep** met 'n gespesifiseerde publieke sleutel in die `.authorized_keys`-l√™er.

Die skripsie gebruik dieselfde ETag om te voorkom dat die Metadata-bediener die Google Guest Agent onmiddellik in kennis stel van verskillende metadata-waardes, en vertraag sodoende die respons.

Om die vervalsing uit te voer, is die volgende stappe nodig:

1. **Monitor versoek na die Metadata-bediener** met behulp van **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Soek na 'n lyn soortgelyk aan:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Stuur die vals metadata data met die korrekte ETAG na rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Hierdie stap gee die publieke sleutel toestemming, wat SSH-verbinding met die ooreenstemmende private sleutel moontlik maak.


## Verwysings

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Leer AWS hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
