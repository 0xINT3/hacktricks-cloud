# GCP - Fuga di rete Docker

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Stato iniziale

In entrambi i writeup in cui viene specificata questa tecnica, gli attaccanti sono riusciti ad ottenere l'accesso **root** all'interno di un **container Docker** gestito da GCP con accesso alla rete host (e le capacit√† **`CAP_NET_ADMIN`** e **`CAP_NET_RAW`**).

## Spiegazione dell'attacco

Su un'istanza di Google Compute Engine, l'ispezione regolare del traffico di rete rivela numerosi **richieste HTTP in chiaro** all'**istanza dei metadati** all'indirizzo `169.254.169.254`. L'[**Agente Ospite di Google**](https://github.com/GoogleCloudPlatform/guest-agent), un servizio open-source, effettua frequentemente tali richieste.

Questo agente √® progettato per **monitorare le modifiche nei metadati**. In particolare, i metadati includono un **campo per le chiavi pubbliche SSH**. Quando una nuova chiave pubblica SSH viene aggiunta ai metadati, l'agente la **autorizza automaticamente** nel file `.authorized_key`. Pu√≤ anche **creare un nuovo utente** e aggiungerlo ai **sudoers** se necessario.

L'agente monitora le modifiche inviando una richiesta per **recuperare tutti i valori dei metadati in modo ricorsivo** (`GET /computeMetadata/v1/?recursive=true`). Questa richiesta √® progettata per far s√¨ che il server dei metadati invii una risposta solo se c'√® stata una modifica nei metadati dall'ultimo recupero, identificata da un Etag (`wait_for_change=true&last_etag=`). Inoltre, √® incluso un parametro **timeout** (`timeout_sec=`). Se non si verifica alcuna modifica entro il timeout specificato, il server risponde con i **valori invariati**.

Questo processo consente al **IMDS** (Instance Metadata Service) di rispondere dopo **60 secondi** se non √® avvenuto alcun cambiamento di configurazione, creando una potenziale **finestra per l'iniezione di una falsa risposta di configurazione** all'agente ospite.

Un attaccante potrebbe sfruttare ci√≤ eseguendo un **attacco Man-in-the-Middle (MitM)**, contraffacendo la risposta dal server IMDS e **inserendo una nuova chiave pubblica**. Ci√≤ potrebbe consentire l'accesso SSH non autorizzato all'host.

### Tecnica di fuga

Sebbene l'ARP spoofing sia inefficace nelle reti di Google Compute Engine, una [**versione modificata di rshijack**](https://github.com/ezequielpereira/rshijack) sviluppata da [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) pu√≤ essere utilizzata per l'iniezione di pacchetti nella comunicazione al fine di iniettare l'utente SSH.

Questa versione di rshijack consente di inserire i numeri ACK e SEQ come argomenti della riga di comando, facilitando la contraffazione di una risposta prima della vera risposta del server dei metadati. Inoltre, viene utilizzato uno [**script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) per restituire un **payload appositamente creato**. Questo payload attiva l'Agente Ospite di Google per **creare un utente `wouter`** con una chiave pubblica specificata nel file `.authorized_keys`.

Lo script utilizza lo stesso ETag per impedire al server dei metadati di notificare immediatamente all'Agente Ospite di Google valori dei metadati diversi, ritardando cos√¨ la risposta.

Per eseguire la contraffazione, sono necessari i seguenti passaggi:

1. **Monitorare le richieste al server dei metadati** utilizzando **tcpdump**:
```bash
tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &
```
Cerca una riga simile a:
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
2. Invia i dati falsi del metadata con l'ETAG corretto a rshijack:
```bash
fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost
```
Questo passaggio autorizza la chiave pubblica, abilitando la connessione SSH con la corrispondente chiave privata.


## Riferimenti

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Impara l'hacking su AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
