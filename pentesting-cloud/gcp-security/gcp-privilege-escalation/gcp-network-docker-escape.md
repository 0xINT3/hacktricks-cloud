# GCP - ネットワークDockerエスケープ

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## 初期状態

このテクニックが指定されている2つの解説記事では、攻撃者はGCPで管理されている**Docker**コンテナ内で**root**アクセスを取得し、ホストネットワークにアクセスできる（および**`CAP_NET_ADMIN`**と**`CAP_NET_RAW`**の機能を持つ）ことに成功しました。

## 攻撃

通常のGoogle Compute Engineインスタンスでネットワークトラフィックを調査すると、**`169.254.169.254`**の**メタデータ**インスタンスに対して多くの**プレーンなHTTPリクエスト**が送信されているのが見えます。このようなリクエストを行うサービスの1つは、オープンソースの[**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent)です。リクエストの例：

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

このエージェントは、メタデータの変更を監視します。メタデータには、**SSH公開鍵**が認可される**フィールド**があります。したがって、メタデータに新しい公開SSH鍵が表示されると、エージェントはユーザーの`.authorized_key`ファイルでそれを**認可**し、必要に応じて新しいユーザーを**sudoers**に追加して作成します。

Google Guest Agentが変更を監視する方法は、**すべてのメタデータ値を再帰的に取得**する呼び出し（`GET /computeMetadata/v1/?recursive=true`）を行い、メタデータサーバーに対して、最後に取得したメタデータ値との**変更がある場合にのみ応答を送信**するように指示することです。変更はそのEtagによって識別されます（`wait_for_change=true&last_etag=`）。

このリクエストには**タイムアウト**（`timeout_sec=`）も含まれており、指定された時間内に**変更が発生しない**場合、メタデータサーバーは**変更されていない値**で応答します。

これにより、IMDSはその間隔で構成の変更がない場合、**60秒後に応答**するようになり、IMDSからゲストエージェントへの偽の構成応答を**注入するためのウィンドウ**が作成されます。

したがって、攻撃者が**MitM**攻撃を実行できれば、IMDSサーバーからの応答を**スプーフィング**して、新しい公開鍵を挿入してホストへの**SSHアクセスを許可**できます。

### エスケープ

Google Compute EngineネットワークではARPスプーフィングは機能しませんが、[**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)は、この通信にパケットを挿入してSSHユーザーを注入するために使用できる[**rshijack**](https://github.com/ezequielpereira/rshijack)の**改造版**を生成しました。

この改造版のrshijackでは、ACKとSEQ番号を**コマンドライン引数として渡す**ことができ、時間を節約し、実際のメタデータ応答が来る前に**応答をスプーフィング**することができます。

さらに、[**この小さなシェルスクリプト**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh)は、Google Guest Agentが**`wouter`ユーザー**を作成し、その`.authorized_keys`ファイルに独自の公開鍵を含む**特別に作成されたペイロード**を返すものです。

このスクリプトは、同じETagを保持するため、メタデータサーバーは次の応答でメタデータ値が異なることをGoogle Guest Agentにすぐには伝えず、代わりにtimeout_secで指定された秒数を待ちます。

スプーフィングを実現するために、次のような行が表示されるまで、**tcpdumpを使用してメタデータ**サーバーへのリクエストを監視する必要があります：`tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

その値を見つけたら、**正しいETAGを使用して偽のメタデータデータを`rshijack`に送信**します：

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

これにより、エージェントは**公開鍵を承認**し、**プライベート**キーを使用して**SSH**で**接続**できるようになります。

## 参考文献

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>ハックトリックをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**最新バージョンのPEASSを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**をフォロー**してください。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
