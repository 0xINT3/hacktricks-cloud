# GCP - √âvasion de Docker r√©seau

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

## √âtat initial

Dans les deux writeups o√π cette technique est sp√©cifi√©e, les attaquants ont r√©ussi √† obtenir un acc√®s **root** √† l'int√©rieur d'un conteneur **Docker** g√©r√© par GCP avec acc√®s au r√©seau h√¥te (et les capacit√©s **`CAP_NET_ADMIN`** et **`CAP_NET_RAW`**).

## Attaque

Lorsque vous inspectez le trafic r√©seau sur une instance Google Compute Engine r√©guli√®re, vous verrez beaucoup de **requ√™tes HTTP en clair** dirig√©es vers l'instance de **m√©tadonn√©es** sur **`169.254.169.254`**. Un service qui effectue de telles demandes est l'agent invit√© Google open-source [**Google Guest Agent**](https://github.com/GoogleCloudPlatform/guest-agent). Exemple de demande :

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

Cet agent **surveille les m√©tadonn√©es pour les changements**. √Ä l'int√©rieur des **m√©tadonn√©es**, il y a un **champ** avec des **cl√©s publiques SSH autoris√©es**.\
Par cons√©quent, lorsqu'une nouvelle cl√© SSH publique appara√Æt dans les m√©tadonn√©es, l'agent **l'autorise** dans le fichier `.authorized_key` de l'utilisateur et il **cr√©e** un nouvel utilisateur si n√©cessaire et l'ajoute aux **sudoers**.

La fa√ßon dont l'agent invit√© Google surveille les changements est par un appel pour **r√©cup√©rer toutes les valeurs de m√©tadonn√©es de mani√®re r√©cursive** (`GET /computeMetadata/v1/?recursive=true`), indiquant au serveur de m√©tadonn√©es de **ne renvoyer une r√©ponse que lorsqu'il y a un changement** par rapport aux derni√®res valeurs de m√©tadonn√©es r√©cup√©r√©es, identifi√©es par son Etag (`wait_for_change=true&last_etag=`).

Cette demande inclut √©galement un **d√©lai d'expiration** (`timeout_sec=`), donc si un **changement ne se produit pas** dans la quantit√© de temps sp√©cifi√©e, le serveur de m√©tadonn√©es r√©pond avec les **valeurs inchang√©es**.

Cela fait que l'**IMDS** **r√©ponde** apr√®s **60** **secondes** s'il n'y a pas eu de changement de configuration dans cet intervalle, permettant une **fen√™tre pour injecter une fausse r√©ponse de configuration** √† l'agent invit√© depuis l'IMDS.

Par cons√©quent, si un attaquant parvient √† effectuer une attaque **MitM**, il pourrait **fausser** la **r√©ponse** du serveur **IMDS en ins√©rant une nouvelle cl√© publique** pour permettre √† un nouvel utilisateur d'acc√©der via **SSH** √† l'h√¥te.

### √âvasion

Le spoofing ARP ne fonctionne pas sur les r√©seaux Google Compute Engine, cependant, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) a g√©n√©r√© cette **version modifi√©e de** [**rshijack**](https://github.com/ezequielpereira/rshijack) **** qui peut √™tre utilis√©e pour injecter un paquet dans la communication pour injecter l'utilisateur SSH.

Cette version modifi√©e de rshijack permet de **passer les num√©ros ACK et SEQ en ligne de commande**, ce qui permet de gagner du temps et de nous permettre de **fausser une r√©ponse** avant que la r√©ponse r√©elle de Metadata ne soit arriv√©e.\
\
De plus, **ce** [**petit script Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** qui renverrait une **charge utile sp√©cialement con√ßue** qui d√©clencherait l'agent invit√© Google pour **cr√©er l'utilisateur `wouter`,** avec notre propre cl√© publique dans son fichier `.authorized_keys`.\
\
Ce script re√ßoit l'ETag en tant que param√®tre, car en conservant le m√™me ETag, le serveur de m√©tadonn√©es ne dirait pas imm√©diatement √† l'agent invit√© Google que les valeurs de m√©tadonn√©es √©taient diff√©rentes sur la prochaine r√©ponse, attendant plut√¥t le nombre de secondes sp√©cifi√© dans timeout\_sec.\
\
Pour r√©aliser le spoofing, vous devez **surveiller les demandes vers le serveur de m√©tadonn√©es** avec **tcpdump : `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** en attendant une ligne qui ressemble √† ceci :

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

Lorsque vous voyez cette valeur, envoyez les **fausses donn√©es de m√©tadonn√©es avec le bon ETAG √† `rshijack`** :

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

Et cela devrait faire que l'agent **autorise cette cl√© publique** qui vous permettra de vous **connecter** via **SSH** avec la **cl√© priv√©e**.

## R√©f√©rences

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>