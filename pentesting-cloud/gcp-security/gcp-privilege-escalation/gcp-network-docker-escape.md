# GCP - Escape de Docker de Red

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Estado inicial

En ambos writeups donde se especifica esta t√©cnica, los atacantes lograron obtener acceso **root** dentro de un contenedor **Docker** administrado por GCP con acceso a la red del host (y las capacidades **`CAP_NET_ADMIN`** y **`CAP_NET_RAW`**).

## Ataque

Cuando inspeccionas el tr√°fico de red en una instancia regular de Google Compute Engine, ver√°s muchas solicitudes **HTTP sin cifrar** dirigidas a la instancia de **metadatos** en **`169.254.169.254`**. Un servicio que realiza tales solicitudes es el [**Agente de invitado de Google**](https://github.com/GoogleCloudPlatform/guest-agent) de c√≥digo abierto. Ejemplo de solicitud:

<figure><img src="../../../.gitbook/assets/image (1) (4).png" alt=""><figcaption></figcaption></figure>

Este agente **monitorea los metadatos en busca de cambios**. Dentro de los **metadatos** hay un **campo** con claves p√∫blicas **SSH autorizadas**.\
Por lo tanto, cuando aparece una nueva clave p√∫blica SSH en los metadatos, el agente **la autoriza** en el archivo `.authorized_key` del usuario y **crea** un nuevo usuario si es necesario y lo agrega a **sudoers**.

La forma en que el Agente de invitado de Google monitorea los cambios es a trav√©s de una llamada para **recuperar todos los valores de metadatos de forma recursiva** (`GET /computeMetadata/v1/?recursive=true`), indicando al servidor de metadatos que **solo env√≠e una respuesta cuando haya alg√∫n cambio** con respecto a los √∫ltimos valores de metadatos recuperados, identificados por su Etag (`wait_for_change=true&last_etag=`).

Esta solicitud tambi√©n incluye un **tiempo de espera** (`timeout_sec=`), por lo que si no se produce un **cambio dentro** del tiempo especificado, el servidor de metadatos responde con los valores **sin cambios**.

Esto hace que el **IMDS** responda despu√©s de **60 segundos** si no hubo cambios de configuraci√≥n en ese intervalo, permitiendo una **ventana para inyectar una respuesta de configuraci√≥n falsa** al agente invitado desde el IMDS.

Por lo tanto, si un atacante logra realizar un ataque **MitM**, podr√≠a **suplantar** la **respuesta** del servidor **IMDS** **insertando una nueva clave p√∫blica** para permitir que un nuevo usuario acceda a trav√©s de **SSH** al host.

### Escape

El spoofing de ARP no funciona en las redes de Google Compute Engine, sin embargo, [**Ezequiel**](https://www.ezequiel.tech/2020/08/dropping-shell-in.html) gener√≥ esta **versi√≥n modificada de** [**rshijack**](https://github.com/ezequielpereira/rshijack) **** que se puede usar para inyectar un paquete en la comunicaci√≥n para inyectar el usuario SSH.

Esta versi√≥n modificada de rshijack permite **pasar los n√∫meros ACK y SEQ como argumentos de l√≠nea de comando**, ahorrando tiempo y permiti√©ndonos **suplantar una respuesta** antes de que llegara la respuesta real de Metadata.\
\
Adem√°s, **este** [**peque√±o script de Shell**](https://gist.github.com/ezequielpereira/914c2aae463409e785071213b059f96c#file-fakedata-sh) **** que devolver√≠a una **carga √∫til especialmente dise√±ada** que activar√≠a el Agente de invitado de Google para **crear el usuario `wouter`,** con nuestra propia clave p√∫blica en su archivo `.authorized_keys`.\
\
Este script recibe el ETag como par√°metro, ya que al mantener el mismo ETag, el servidor de metadatos no le dir√≠a inmediatamente al Agente de invitado de Google que los valores de metadatos eran diferentes en la siguiente respuesta, en su lugar esperando la cantidad de segundos especificada en timeout\_sec.\
\
Para lograr el spoofing, debes **observar las solicitudes al servidor de metadatos** con **tcpdump: `tcpdump -S -i eth0 'host 169.254.169.254 and port 80' &`** esperando una l√≠nea que se parezca a esto:

{% code overflow="wrap" %}
```
<TIME> IP <LOCAL_IP>.<PORT> > 169.254.169.254.80: Flags [P.], seq <NUM>:<TARGET_ACK>, ack <TARGET_SEQ>, win <NUM>, length <NUM>: HTTP: GET /computeMetadata/v1/?timeout_sec=<SECONDS>&last_etag=<ETAG>&alt=json&recursive=True&wait_for_change=True HTTP/1.1
```
{% endcode %}

Cuando veas ese valor, env√≠a los **datos de metadatos falsos con el ETAG correcto a `rshijack`**:

**`fakeData.sh <ETAG> | rshijack -q eth0 169.254.169.254:80 <LOCAL_IP>:<PORT> <TARGET_SEQ> <TARGET_ACK>; ssh -i id_rsa -o StrictHostKeyChecking=no wouter@localhost`**

Y esto deber√≠a hacer que el agente **autorice esa clave p√∫blica** que te permitir√° **conectar** a trav√©s de **SSH** con la **clave privada**.

## Referencias

* [https://www.ezequiel.tech/2020/08/dropping-shell-in.html](https://www.ezequiel.tech/2020/08/dropping-shell-in.html)
* [https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>