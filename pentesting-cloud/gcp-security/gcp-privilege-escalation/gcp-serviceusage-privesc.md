# GCP - Serviceusage Privesc

<details>

<summary><strong>从零到英雄学习AWS黑客技术，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**上关注我。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## serviceusage

以下权限对于创建和窃取API密钥很有用，注意文档中的这一点：_API密钥是一个简单的加密字符串，它**不涉及任何主体**识别应用程序。它们对于匿名访问**公共数据**很有用，并用于将API请求与您的项目关联，以便进行配额和**计费**。_

因此，使用API密钥，您可以使该公司为您使用API付费，但您将无法提升权限。

### `serviceusage.apiKeys.create`

有另一种使用GCP API的认证方法，称为API密钥。默认情况下，它们是无限制创建的，这意味着它们可以访问它们所创建的整个GCP项目。我们可以利用这一点，创建一个可能比我们自己的用户拥有更多权限的新API密钥。没有官方API可以做到这一点，因此需要向 _https://apikeys.clients6.google.com/_（或 _https://apikeys.googleapis.com/_）发送自定义HTTP请求。这是通过监控浏览GCP网络控制台时的HTTP请求和响应发现的。有关API密钥相关限制的文档，请访问[此链接](https://cloud.google.com/docs/authentication/api-keys)。

以下截图显示了如何在网络控制台中创建API密钥。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image6-1.png)

通过发现的未记录API，我们也可以通过API本身创建API密钥。

上面的截图显示了发送POST请求以检索项目的新API密钥。

此方法的利用脚本可以在[这里](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/serviceusage.apiKeys.create.py)找到。

### `serviceusage.apiKeys.list`

另一个未记录的API是用于列出已经创建的API密钥（这也可以在网络控制台中完成）。因为您在创建后仍然可以看到API密钥的值，所以我们可以提取项目中的所有API密钥。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image4-1.png)

上面的截图显示请求与之前完全相同，只是GET请求而不是POST请求。这只显示了一个密钥，但如果项目中有其他密钥，那些也会被列出。

此方法的利用脚本可以在[这里](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/serviceusage.apiKeys.list.py)找到。

### **`serviceusage.services.enable`** , **`serviceusage.services.use`**

拥有这些权限的攻击者可以在项目中启用和使用新服务。这可能允许攻击者启用像admin或cloudidentity这样的服务来访问Workspace信息，或其他服务来访问有趣的数据。&#x20;

## **参考资料**

* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#:\~:text=apiKeys.-,create,privileges%20than%20our%20own%20user.](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/)

<details>

<summary><strong>支持HackTricks并获得好处！</strong></summary>

您在**网络安全公司**工作吗？您想在**HackTricks中看到您的公司广告**吗？或者您想要访问**最新版本的PEASS或以PDF格式下载HackTricks**？查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)

获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)

**加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**上关注我。**

**通过向** [**hacktricks github仓库提交PR来分享您的黑客技巧**](https://github.com/carlospolop/hacktricks)\*\*\*\*

**。**

</details>
