# GCP - KMS Privesc

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## KMS

KMS рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ KMS рдореЗрдВ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рдХреЗрд╡рд▓ Orgs, Folders рдФрд░ Projects рд╕реЗ **рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓реА** рдирд╣реАрдВ рд╣реЛрддреАрдВ, рдмрд▓реНрдХрд┐ **Keyrings** рд╕реЗ рднреА рдорд┐рд▓рддреА рд╣реИрдВред

### `cloudkms.cryptoKeyVersions.useToDecrypt`

рдЖрдк рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕ рдкрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ рдпрд╣ рдЕрдиреБрдорддрд┐ рд╣реИред
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдЦреБрдж рдХреЛ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ**ред
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

рдЗрд╕ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рд╕реИрджреНрдзрд╛рдВрддрд┐рдХ рд╡рд┐рд╡рд░рдг рдпрд╣рд╛рдБ рд╣реИ:

1. **Service Account A** рдХреЛ KMS рдореЗрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реАрдзреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреА рдкрд╣реБрдБрдЪ рд╣реИред
2. **Service Account B** рдХреЛ `useToDecryptViaDelegation` рдЕрдиреБрдорддрд┐ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИред рдЗрд╕рд╕реЗ рдпрд╣ Service Account A рдХреА рдУрд░ рд╕реЗ KMS рд╕реЗ рдбреЗрдЯрд╛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕ **рдЕрдиреБрдорддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрд╕ рддрд░реАрдХреЗ рдореЗрдВ рдирд┐рд╣рд┐рдд рд╣реИ рдЬрд┐рд╕ рддрд░рд╣ рд╕реЗ KMS рд╕реЗрд╡рд╛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЬрд╛рдБрдЪ рдХрд░рддреА рд╣реИ** рдЬрдм рдПрдХ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЬрдм рдЖрдк Google Cloud KMS API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ (Python рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рднрд╛рд╖рд╛ рдореЗрдВ) рдПрдХ рдорд╛рдирдХ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╕реЗрд╡рд╛ **рдЬрд╛рдБрдЪрддреА рд╣реИ рдХрд┐ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреЗ рдкрд╛рд╕ рдЖрд╡рд╢реНрдпрдХ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ рдпрд╛ рдирд╣реАрдВ**ред рдпрджрд┐ рдЕрдиреБрд░реЛрдз **`useToDecryptViaDelegation`** рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ KMS рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ **рдЕрдХрд╛рдЙрдВрдЯ рдХреБрдВрдЬреА рдХреЗ рдорд╛рд▓рд┐рдХ рдХреА рдУрд░ рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХреГрдд рд╣реИ**ред

#### рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯрдЕрдк рдХрд░рдирд╛

1. **рдХрд╕реНрдЯрдо рд░реЛрд▓ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░реЗрдВ**: рдПрдХ YAML рдлрд╛рдЗрд▓ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `custom_role.yaml`) рдмрдирд╛рдПрдВ рдЬреЛ рдХрд╕реНрдЯрдо рд░реЛрд▓ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреА рд╣реИред рдЗрд╕ рдлрд╛рдЗрд▓ рдореЗрдВ `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation` рдЕрдиреБрдорддрд┐ рд╢рд╛рдорд┐рд▓ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рдпрд╣рд╛рдБ рдЗрд╕ рдлрд╛рдЗрд▓ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **gcloud CLI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ Custom Role рдмрдирд╛рдПрдВ**: рдЕрдкрдиреЗ Google Cloud рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдореЗрдВ custom role рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

`[YOUR_PROJECT_ID]` рдХреА рдЬрдЧрд╣ рдЕрдкрдиреЗ Google Cloud рдкреНрд░реЛрдЬреЗрдХреНрдЯ ID рд╕реЗ рдмрджрд▓реЗрдВред

3. **рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреЛ рдХрд╕реНрдЯрдо рд░реЛрд▓ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ**: рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреЛ рдЕрдкрдирд╛ рдХрд╕реНрдЯрдо рд░реЛрд▓ рдЕрд╕рд╛рдЗрди рдХрд░реЗрдВред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
```
рдЕрдкрдиреА рдкреНрд░реЛрдЬреЗрдХреНрдЯ ID рдФрд░ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреА рдИрдореЗрд▓ рдХреЗ рд╕рд╛рде `[YOUR_PROJECT_ID]` рдФрд░ `[SERVICE_ACCOUNT_EMAIL]` рдХреЛ рдмрджрд▓реЗрдВред

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**ред
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>
```
