# GCP - KMS Privesc

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## KMS

Informacije o KMS-u:

{% content-ref url="../gcp-services/gcp-kms-enum.md" %}
[gcp-kms-enum.md](../gcp-services/gcp-kms-enum.md)
{% endcontent-ref %}

Imajte na umu da u KMS-u **dozvole** nisu samo **nasleƒëene** od Organizacija, Foldera i Projekata, veƒá i od **Keyring-ova**.

### `cloudkms.cryptoKeyVersions.useToDecrypt`

Mo≈æete koristiti ovu dozvolu da **dekriptujete informacije sa kljuƒçem** nad kojim imate ovu dozvolu.
```bash
gcloud kms decrypt \
--location=[LOCATION] \
--keyring=[KEYRING_NAME] \
--key=[KEY_NAME] \
--version=[KEY_VERSION] \
--ciphertext-file=[ENCRYPTED_FILE_PATH] \
--plaintext-file=[DECRYPTED_FILE_PATH]
```
### `cloudkms.cryptoKeys.setIamPolicy`

Napadaƒç sa ovla≈°ƒáenjem mo≈æe **dodeliti sebi ovla≈°ƒáenja** za upotrebu kljuƒça za de≈°ifrovanje informacija.
```bash
gcloud kms keys add-iam-policy-binding [KEY_NAME] \
--location [LOCATION] \
--keyring [KEYRING_NAME] \
--member [MEMBER] \
--role roles/cloudkms.cryptoKeyDecrypter
```
### `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`

Evo konceptualne razrade kako ova delegacija funkcioni≈°e:

1. **Servisni nalog A** ima direktni pristup za de≈°ifrovanje koristeƒái odreƒëeni kljuƒç u KMS-u.
2. **Servisni nalog B** je dobio dozvolu `useToDecryptViaDelegation`. Ovo mu omoguƒáava da zahteva od KMS-a da de≈°ifruje podatke u ime Servisnog naloga A.

Kori≈°ƒáenje ove **dozvole je implicitno u naƒçinu na koji KMS proverava dozvole** prilikom zahteva za de≈°ifrovanje.

Kada napravite standardni zahtev za de≈°ifrovanje koristeƒái Google Cloud KMS API (u Pythonu ili nekom drugom jeziku), servis **proverava da li servisni nalog koji je napravio zahtev ima potrebne dozvole**. Ako zahtev napravi servisni nalog sa dozvolom **`useToDecryptViaDelegation`**, KMS proverava da li je ovom **nalogu dozvoljeno da zahteva de≈°ifrovanje u ime entiteta koji je vlasnik kljuƒça**.

#### Priprema za delegaciju

1. **Defini≈°ite prilagoƒëenu ulogu**: Kreirajte YAML fajl (npr. `custom_role.yaml`) koji defini≈°e prilagoƒëenu ulogu. Ovaj fajl treba da ukljuƒçuje dozvolu `cloudkms.cryptoKeyVersions.useToDecryptViaDelegation`. Evo primera kako bi ovaj fajl mogao izgledati:
```yaml
title: "KMS Decryption via Delegation"
description: "Allows decryption via delegation"
stage: "GA"
includedPermissions:
- "cloudkms.cryptoKeyVersions.useToDecryptViaDelegation"
```
2. **Kreiranje prilagoƒëene uloge pomoƒáu gcloud CLI-a**: Koristite sledeƒáu komandu za kreiranje prilagoƒëene uloge u va≈°em Google Cloud projektu:

{% code overflow="wrap" %}
```bash
gcloud iam roles create kms_decryptor_via_delegation --project [YOUR_PROJECT_ID] --file custom_role.yaml
```
{% endcode %}

Zamenite `[YOUR_PROJECT_ID]` sa ID-em va≈°eg Google Cloud projekta.

3. **Dodelite prilagoƒëenu ulogu servisnom nalogu**: Dodelite prilagoƒëenu ulogu servisnom nalogu koji ƒáe koristiti ovo ovla≈°ƒáenje. Koristite sledeƒáu komandu:
```bash
# Give this permission to the service account to impersonate
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member "serviceAccount:[SERVICE_ACCOUNT_B_EMAIL]" \
--role "projects/[PROJECT_ID]/roles/[CUSTOM_ROLE_ID]"

# Give this permission over the project to be able to impersonate any SA
gcloud projects add-iam-policy-binding [YOUR_PROJECT_ID] \
--member="serviceAccount:[SERVICE_ACCOUNT_EMAIL]" \
--role="projects/[YOUR_PROJECT_ID]/roles/kms_decryptor_via_delegation"
```
Zamenite `[YOUR_PROJECT_ID]` i `[SERVICE_ACCOUNT_EMAIL]` sa ID-jem va≈°eg projekta i emailom servisnog naloga, redom.

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini da podr≈æite HackTricks:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
