# GCP - 权限提升

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## GCP权限提升简介 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP，像其他云平台一样，有一些**主体**：用户、组和服务账户，以及一些**资源**，如计算引擎、云函数等。\
然后，通过角色，**将权限授予这些主体以操作资源**。这是在GCP中指定主体对资源的权限的方式。\
有些权限将允许用户**获得更多的权限**，无论是在资源上还是第三方资源上，这就是所谓的**权限提升**（也包括利用漏洞获得更多权限）。

因此，我想将GCP权限提升技术分为**两组**：

* **提升到主体的权限**：这将允许您**冒充另一个主体**，因此拥有它的所有权限。例如：滥用 _getAccessToken_ 冒充服务账户。
* **在资源上的权限提升**：这将允许您**获得对特定资源的更多权限**。例如：您可以滥用_cloudfunctions_ 上的 _setIamPolicy_ 权限，允许您触发函数。
* 注意，一些**资源权限也将允许您将任意服务账户附加到资源上**。这意味着您将能够以服务账户的身份启动资源，进入资源，并**窃取服务账户令牌**。因此，这将允许通过资源提升来提升到主体。这在以前的几个资源中发生过，但现在较少见（但仍然可能发生）。

显然，**第二组**的权限提升技术最有趣，因为它将允许您**在您已经拥有某些权限的资源之外获得更多权限**。然而，请注意，在资源上**提升权限**也可能让您访问到**敏感信息**，甚至是**其他主体**（可能通过读取包含服务账户令牌的秘密）。

{% hint style="warning" %}
重要的是要注意，在**GCP中服务账户既是主体也是权限**，所以在服务账户中提升权限也将允许您冒充它。
{% endhint %}

{% hint style="info" %}
括号中的权限表示使用`gcloud`利用漏洞所需的权限。如果通过API利用，可能不需要这些权限。
{% endhint %}

## 权限提升方法论的权限

这是我**测试特定权限**以在GCP内执行特定操作的方法。

1. 下载github仓库 [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. 在tests/中添加新脚本

## 绕过访问范围 <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

从GCP元数据服务泄露的SA令牌具有**访问范围**。这些是对令牌拥有的**权限**的**限制**。例如，如果令牌具有**`https://www.googleapis.com/auth/cloud-platform`** 范围，它将拥有对所有GCP服务的**完全访问权限**。然而，如果令牌具有**`https://www.googleapis.com/auth/cloud-platform.read-only`** 范围，即使SA在IAM中拥有更多权限，它也只能对所有GCP服务拥有**只读访问权限**。

没有直接的方法可以绕过这些权限，但您总是可以尝试在受损主机中搜索**新的凭据**，**找到服务密钥**以生成无限制的OAuth令牌，或者**跳转到限制较少的不同VM**。

当使用[访问范围](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)时，为计算实例（VM）生成的OAuth令牌将**包含**[**范围**](https://oauth.net/2/scope/)**限制**。然而，您可能能够**绕过**这一限制并利用受损账户拥有的权限。

**绕过**这一限制的**最佳方式**是在受损主机中**找到新的凭据**，**找到服务密钥以生成无限制的OAuth令牌**，或者**攻破限制较少的不同VM上的SA**。

检查使用以下命令生成的带有密钥的SA：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## 权限提升技术

在AWS中提升权限的方法是拥有足够的权限，以某种方式访问其他服务账户/用户/组的权限。链式提升直到你对组织有管理员访问权限。

{% hint style="warning" %}
GCP拥有**数百个**（如果不是数千个）可以授予实体的**权限**。在这本书中，你可以找到我所知道的所有可以滥用来**提升权限**的权限，但如果你**知道**这里没有提到的某些路径，请**分享出来**。
{% endhint %}

你可以找到按服务划分的所有**权限提升路径**：

* [**Apikeys 权限提升**](gcp-apikeys-privesc.md)
* [**Cloudbuild 权限提升**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions 权限提升**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler 权限提升**](gcp-cloudscheduler-privesc.md)
* [**Compute 权限提升**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer 权限提升**](gcp-composer-privesc.md)
* [**Container 权限提升**](gcp-container-privesc.md)
* [**Deploymentmanager 权限提升**](gcp-deploymentmaneger-privesc.md)
* [**IAM 权限提升**](gcp-iam-privesc.md)
* [**KMS 权限提升**](gcp-kms-privesc.md)
* [**Orgpolicy 权限提升**](gcp-orgpolicy-privesc.md)
* [**Pubsub 权限提升**](gcp-pubsub-privesc.md)
* [**Resourcemanager 权限提升**](gcp-resourcemanager-privesc.md)
* [**Run 权限提升**](gcp-run-privesc.md)
* [**Secretmanager 权限提升**](gcp-secretmanager-privesc.md)
* [**Serviceusage 权限提升**](gcp-serviceusage-privesc.md)
* [**Source Repos 权限提升**](gcp-sourcerepos-privesc.md)
* [**Storage 权限提升**](gcp-storage-privesc.md)
* [**Misc 权限提升**](gcp-misc-perms-privesc.md)

### 在本地滥用GCP提升权限

如果你在GCP中的一台机器内部，你可能能够滥用权限甚至在本地提升权限：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考资料

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果你想在**HackTricks中看到你的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享你的黑客技巧**。

</details>
