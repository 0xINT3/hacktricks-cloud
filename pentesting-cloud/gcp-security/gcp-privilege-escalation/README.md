# GCP - Eskalacja uprawnień

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Wprowadzenie do eskalacji uprawnień w GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, podobnie jak każda inna chmura, ma pewne **podmioty**: użytkowników, grupy i konta usług, oraz pewne **zasoby**, takie jak maszyny obliczeniowe, funkcje chmury...\
Następnie, za pomocą ról, **przyznawane są uprawnienia tym podmiotom wobec zasobów**. To jest sposób określania uprawnień, jakie podmiot ma wobec zasobu w GCP.\
Istnieją pewne uprawnienia, które pozwolą użytkownikowi **uzyskać jeszcze więcej uprawnień** wobec zasobu lub zasobów osób trzecich, i to jest to, co nazywamy **eskalacją uprawnień** (a także wykorzystaniem podatności w celu uzyskania większych uprawnień).

Dlatego chciałbym podzielić techniki eskalacji uprawnień w GCP na **2 grupy**:

* **Eskalacja uprawnień do podmiotu**: Pozwoli ci to **udawać innego podmiotu** i działać w jego imieniu ze wszystkimi jego uprawnieniami. np.: Wykorzystanie _getAccessToken_ do udawania konta usługi.
* **Eskalacja uprawnień w zasobie**: Pozwoli ci to **uzyskać więcej uprawnień wobec konkretnego zasobu**. np.: Możesz wykorzystać uprawnienie _setIamPolicy_ w funkcjach chmury, aby umożliwić wywołanie funkcji.
* Należy zauważyć, że niektóre **uprawnienia zasobów pozwolą ci również dołączyć dowolne konto usługi** do zasobu. Oznacza to, że będziesz mógł uruchomić zasób z kontem usługi, wejść do zasobu i **ukraść token konta usługi**. Dlatego będziesz mógł eskalować uprawnienia do podmiotu za pośrednictwem eskalacji zasobu. Wcześniej zdarzało się to w przypadku wielu zasobów, ale teraz jest to mniej częste (ale wciąż możliwe).

Oczywiście, najbardziej interesujące techniki eskalacji uprawnień to te z **drugiej grupy**, ponieważ pozwolą ci **uzyskać więcej uprawnień poza zasobami, w których już masz pewne uprawnienia**. Jednak należy zauważyć, że **eskalacja w zasobach** może również dać ci dostęp do **wrażliwych informacji** lub nawet do **innych podmiotów** (może to być możliwe poprzez odczytanie tajemnicy zawierającej token konta usługi).

{% hint style="warning" %}
Warto również zauważyć, że w **kontach usług GCP zarówno podmioty, jak i uprawnienia** są tożsame, więc eskalacja uprawnień w koncie usługi pozwoli ci również na udawanie go.
{% endhint %}

{% hint style="info" %}
Uprawnienia w nawiasach wskazują uprawnienia potrzebne do wykorzystania podatności za pomocą `gcloud`. Mogą one nie być potrzebne, jeśli wykorzystasz ją za pomocą interfejsu API.
{% endhint %}

## Uprawnienia dla metodologii eskalacji uprawnień

Tak **testuję konkretne uprawnienia** do wykonania określonych działań w GCP.

1. Pobierz repozytorium github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodaj nowy skrypt do folderu tests/

## Omijanie zakresów dostępu <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeny kont usług (SA) wyciekające z usługi metadanych GCP mają **zakresy dostępu**. Są to **ograniczenia** dotyczące **uprawnień**, jakie posiada token. Na przykład, jeśli token ma zakres **`https://www.googleapis.com/auth/cloud-platform`**, będzie miał **pełny dostęp** do wszystkich usług GCP. Jednak jeśli token ma zakres **`https://www.googleapis.com/auth/cloud-platform.read-only`**, będzie miał tylko **dostęp tylko do odczytu** do wszystkich usług GCP, nawet jeśli konto usługi ma więcej uprawnień w IAM.

Nie ma bezpośredniego sposobu na obejście tych uprawnień, ale zawsze możesz spróbować wyszukać **nowe poświadczenia** na skompromitowanym hoście, **znaleźć klucz usługi do wygenerowania tokenu OAuth bez ograniczeń** lub **przejść do innego mniej ograniczonego VM**.

Kiedy są używane [zakresy dostępu](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), token OAuth generowany dla instancji obliczeniowej (VM) **będzie zawierał ograniczenie zakresu** [**scope**](https://oauth.net/2/scope/). Jednak możesz być w stanie **obejść** to ograniczenie i wykorzystać uprawnienia, jakie ma skompromitowane konto.

**Najlepszym sposobem na obejście** tego ograniczenia jest znalezienie **nowych poświadczeń** na skompromitowanym hoście, znalezienie **klucza usługi do wygenerowania tokenu OAuth** bez ograniczeń lub skompromitowanie innego VM z mniej ograniczonym kontem usługi.

Sprawdź SA z wygenerowanymi kluczami przy użyciu:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniki eskalacji uprawnień

Sposobem na eskalację uprawnień w GCP jest posiadanie wystarczających uprawnień, aby w jakiś sposób uzyskać dostęp do uprawnień innych kont/usług/grup. Eskalacja jest łańcuchowa, aż do uzyskania dostępu administratora do organizacji.

{% hint style="warning" %}
GCP ma **setki** (jeśli nie tysiące) **uprawnień**, które można przyznać podmiotowi. W tej książce znajdziesz **wszystkie uprawnienia, które znam**, które można wykorzystać do **eskalacji uprawnień**, ale jeśli **znasz jakąś ścieżkę**, która tutaj nie jest wymieniona, **podziel się nią**.
{% endhint %}

**Podstrony tej sekcji są uporządkowane według usług. Na każdej usłudze można znaleźć różne sposoby eskalacji uprawnień.**

### Wykorzystywanie GCP do eskalacji uprawnień lokalnie

Jeśli jesteś wewnątrz maszyny w GCP, możesz próbować wykorzystać uprawnienia do eskalacji uprawnień nawet lokalnie:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Odwołania

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
