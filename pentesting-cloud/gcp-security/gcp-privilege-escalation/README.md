# GCP - Escalaci√≥n de Privilegios

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introducci√≥n a la Escalaci√≥n de Privilegios en GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, como cualquier otra nube, tiene algunos **principales**: usuarios, grupos y cuentas de servicio, y algunos **recursos** como compute engine, cloud functions...\
Luego, a trav√©s de roles, **se otorgan permisos a esos principales sobre los recursos**. Esta es la forma de especificar los permisos que un principal tiene sobre un recurso en GCP.\
Hay ciertos permisos que permitir√°n a un usuario **obtener a√∫n m√°s permisos** sobre el recurso o recursos de terceros, y eso es lo que se llama **escalaci√≥n de privilegios** (tambi√©n, la explotaci√≥n de vulnerabilidades para obtener m√°s permisos).

Por lo tanto, me gustar√≠a separar las t√©cnicas de escalaci√≥n de privilegios de GCP en **2 grupos**:

* **Privesc a un principal**: Esto te permitir√° **suplantar a otro principal**, y por lo tanto actuar como √©l con todos sus permisos. Por ejemplo: Abusar de _getAccessToken_ para suplantar una cuenta de servicio.
* **Privesc en el recurso**: Esto te permitir√° **obtener m√°s permisos sobre el recurso espec√≠fico**. Por ejemplo: puedes abusar del permiso _setIamPolicy_ sobre cloudfunctions para permitirte activar la funci√≥n.
* Ten en cuenta que algunos **permisos de recursos tambi√©n te permitir√°n adjuntar una cuenta de servicio arbitraria** al recurso. Esto significa que podr√°s lanzar un recurso con una SA, entrar en el recurso y **robar el token de la SA**. Por lo tanto, esto permitir√° escalar a un principal a trav√©s de una escalaci√≥n de recurso. Esto ha ocurrido en varios recursos anteriormente, pero ahora es menos frecuente (aunque todav√≠a puede suceder).

Obviamente, las t√©cnicas de escalaci√≥n de privilegios m√°s interesantes son las del **segundo grupo** porque te permitir√°n **obtener m√°s privilegios fuera de los recursos sobre los que ya tienes** algunos privilegios. Sin embargo, ten en cuenta que **escalar en recursos** tambi√©n puede darte acceso a **informaci√≥n sensible** o incluso a **otros principales** (quiz√°s leyendo un secreto que contiene un token de una SA).

{% hint style="warning" %}
Es importante tambi√©n notar que en **GCP las Cuentas de Servicio son tanto principales como permisos**, por lo que escalar privilegios en una SA tambi√©n te permitir√° suplantarla.
{% endhint %}

{% hint style="info" %}
Los permisos entre par√©ntesis indican los permisos necesarios para explotar la vulnerabilidad con `gcloud`. Es posible que no sean necesarios si se explota a trav√©s de la API.
{% endhint %}

## Permisos para la Metodolog√≠a de Escalaci√≥n de Privilegios

As√≠ es como **pruebo permisos espec√≠ficos** para realizar acciones espec√≠ficas dentro de GCP.

1. Descarga el repositorio de github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. A√±ade en tests/ el nuevo script

## Eludiendo los √°mbitos de acceso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Los tokens de SA filtrados del servicio de metadatos de GCP tienen **√°mbitos de acceso**. Estas son **restricciones** en los **permisos** que el token tiene. Por ejemplo, si el token tiene el √°mbito **`https://www.googleapis.com/auth/cloud-platform`**, tendr√° **acceso completo** a todos los servicios de GCP. Sin embargo, si el token tiene el √°mbito **`https://www.googleapis.com/auth/cloud-platform.read-only`**, solo tendr√° **acceso de solo lectura** a todos los servicios de GCP incluso si la SA tiene m√°s permisos en IAM.

No hay una forma directa de eludir estos permisos, pero siempre podr√≠as intentar buscar **nuevas credenciales** en el host comprometido, **encontrar la clave del servicio** para generar un token OAuth sin restricci√≥n o **saltar a una VM diferente menos restringida**.

Cuando se utilizan [√°mbitos de acceso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), el token OAuth que se genera para la instancia de computaci√≥n (VM) **tendr√° una limitaci√≥n de** [**√°mbito**](https://oauth.net/2/scope/) **incluida**. Sin embargo, podr√≠as ser capaz de **eludir** esta limitaci√≥n y explotar los permisos que tiene la cuenta comprometida.

La **mejor manera de eludir** esta restricci√≥n es ya sea **encontrar nuevas credenciales** en el host comprometido, **encontrar la clave del servicio para generar un token OAuth** sin restricci√≥n o **comprometer una VM diferente con una SA menos restringida**.

Comprueba SA con claves generadas con:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## T√©cnicas de Escalada de Privilegios

La forma de escalar tus privilegios en AWS es tener suficientes permisos para poder, de alguna manera, acceder a los privilegios de otras cuentas de servicio/usuarios/grupos. Encadenar escaladas hasta tener acceso de administrador sobre la organizaci√≥n.

{% hint style="warning" %}
GCP tiene **cientos** (si no miles) de **permisos** que se pueden otorgar a una entidad. En este libro puedes encontrar **todos los permisos que conozco** que puedes abusar para **escalar privilegios**, pero si **conoces alg√∫n camino** no mencionado aqu√≠, **por favor comp√°rtelo**.
{% endhint %}

Puedes encontrar todos los **caminos de privesc divididos por servicios**:

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### Abusando de GCP para escalar privilegios localmente

Si est√°s dentro de una m√°quina en GCP, podr√≠as ser capaz de abusar de permisos para escalar privilegios incluso localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
