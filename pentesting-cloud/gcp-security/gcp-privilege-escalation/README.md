# GCP - Eskalacija privilegija

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** me na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Uvod u eskalaciju privilegija u GCP-u <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, kao i svaki drugi oblak, ima neke **principale**: korisnike, grupe i servisne naloge, i neke **resurse** poput računarskog sistema, cloud funkcija...\
Zatim, putem uloga, **dodeljuju se dozvole tim principima nad resursima**. To je način da se specificira dozvole koje princip ima nad resursom u GCP-u.\
Postoje određene dozvole koje će omogućiti korisniku da **dobije još više dozvola** nad resursom ili resursima trećih strana, a to se naziva **eskalacija privilegija** (takođe, iskorišćavanje ranjivosti da bi se dobile više dozvole).

Stoga, želeo bih da razdvojim tehnike eskalacije privilegija u GCP-u u **2 grupe**:

* **Privesc na principala**: To će vam omogućiti da **se predstavljate kao drugi princip**, i stoga delujete kao da imate sve njegove dozvole. npr.: Zloupotreba _getAccessToken_ da bi se predstavljao kao servisni nalog.
* **Privesc na resursu**: To će vam omogućiti da **dobijete više dozvola nad određenim resursom**. npr.: možete zloupotrebiti dozvolu _setIamPolicy_ nad cloud funkcijama da biste omogućili pokretanje funkcije.
* Imajte na umu da će neke **dozvole za resurse takođe omogućiti da pridružite proizvoljni servisni nalog** resursu. To znači da ćete moći da pokrenete resurs sa SA, uđete u resurs i **ukradete SA token**. Stoga će vam to omogućiti eskalaciju na principala putem eskalacije resursa. Ovo se dogodilo u nekoliko resursa ranije, ali sada je manje uobičajeno (ali se i dalje može dogoditi).

Očigledno, najinteresantnije tehnike eskalacije privilegija su one iz **druge grupe**, jer će vam omogućiti da **dobijete više privilegija izvan resursa nad kojima već imate neke privilegije**. Međutim, imajte na umu da **eskalacija u resursima** može vam dati i pristup **osetljivim informacijama** ili čak **drugim principima** (možda putem čitanja tajne koja sadrži token SA).

{% hint style="warning" %}
Važno je napomenuti da su u **GCP servisni nalozi i principali i dozvole**, pa će eskalacija privilegija u SA vam omogućiti i da se predstavljate kao taj SA.
{% endhint %}

{% hint style="info" %}
Dozvole između zagrada ukazuju na dozvole potrebne za iskorišćavanje ranjivosti pomoću `gcloud`-a. One možda neće biti potrebne ako se iskorištava putem API-ja.
{% endhint %}

## Dozvole za metodologiju eskalacije privilegija

Ovako **testiram specifične dozvole** za izvođenje određenih radnji unutar GCP-a.

1. Preuzmite github repozitorijum [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Dodajte novi skriptu u tests/

## Zaobilaženje pristupnih opsega <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokeni SA koji su procurili iz GCP metadata servisa imaju **pristupne opsege**. To su **ograničenja** na **dozvole** koje token ima. Na primer, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform`**, imaće **puni pristup** svim GCP uslugama. Međutim, ako token ima opseg **`https://www.googleapis.com/auth/cloud-platform.read-only`**, imaće samo **samo za čitanje pristup** svim GCP uslugama, čak i ako SA ima više dozvola u IAM-u.

Ne postoji direktni način za zaobilaženje ovih dozvola, ali uvek možete pokušati da **tražite nove akreditive** na kompromitovanom hostu, **pronađete ključ servisa** da biste generisali OAuth token bez ograničenja ili **pređete na drugi VM sa manje restrikcija**.

Kada se koriste [pristupni opsezi](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), OAuth token koji se generiše za računarski instancu (VM) će **imati ograničenje opsega** [**uključeno**](https://oauth.net/2/scope/). Međutim, možda ćete moći da **zaobiđete** ovo ograničenje i iskoristite dozvole koje kompromitovani nalog ima.

**Najbolji način za zaobilaženje** ovog ograničenja je ili da **pronađete nove akreditive** na kompromitovanom hostu, da **pronađete ključ servisa za generisanje OAuth tokena** bez ograničenja ili da **kompromitujete drugi VM sa manje restrikcija**.

Proverite SA sa generisanim ključevima koristeći:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Tehnike eskalacije privilegija

Način da eskalirate svoje privilegije u GCP-u je da imate dovoljno dozvola da biste mogli, na neki način, pristupiti privilegijama drugih servisnih naloga/korisnika/grupa. Povezivanje eskalacija dok ne dobijete administratorski pristup organizaciji.

{% hint style="warning" %}
GCP ima **stotine** (ako ne i hiljade) **dozvola** koje entitet može dobiti. U ovoj knjizi možete pronaći **sve dozvole koje znam** koje možete zloupotrebiti za **eskalciju privilegija**, ali ako **znate neki drugi put** koji ovde nije naveden, **molimo vas da ga podelite**.
{% endhint %}

Možete pronaći sve **putanje eskalacije privilegija podeljene po uslugama**:

* [**Apikeys eskalacija privilegija**](gcp-apikeys-privesc.md)
* [**Cloudbuild eskalacija privilegija**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions eskalacija privilegija**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler eskalacija privilegija**](gcp-cloudscheduler-privesc.md)
* [**Compute eskalacija privilegija**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer eskalacija privilegija**](gcp-composer-privesc.md)
* [**Container eskalacija privilegija**](gcp-container-privesc.md)
* [**Deploymentmanager eskalacija privilegija**](gcp-deploymentmaneger-privesc.md)
* [**IAM eskalacija privilegija**](gcp-iam-privesc.md)
* [**KMS eskalacija privilegija**](gcp-kms-privesc.md)
* [**Orgpolicy eskalacija privilegija**](gcp-orgpolicy-privesc.md)
* [**Pubsub eskalacija privilegija**](gcp-pubsub-privesc.md)
* [**Resourcemanager eskalacija privilegija**](gcp-resourcemanager-privesc.md)
* [**Run eskalacija privilegija**](gcp-run-privesc.md)
* [**Secretmanager eskalacija privilegija**](gcp-secretmanager-privesc.md)
* [**Serviceusage eskalacija privilegija**](gcp-serviceusage-privesc.md)
* [**Source Repos eskalacija privilegija**](gcp-sourcerepos-privesc.md)
* [**Storage eskalacija privilegija**](gcp-storage-privesc.md)
* [**Misc eskalacija privilegija**](gcp-misc-perms-privesc.md)

### Zloupotreba GCP-a za lokalnu eskalaciju privilegija

Ako se nalazite unutar mašine u GCP-u, možda ćete moći zloupotrebiti dozvole za lokalnu eskalaciju privilegija:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini da podržite HackTricks:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
