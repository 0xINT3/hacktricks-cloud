# GCP - 权限提升

<details>

<summary><strong>从零到英雄学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## GCP权限提升简介 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP，像其他云平台一样，有一些**主体**：用户、组和服务账户，以及一些**资源**，如计算引擎、云函数等。\
然后，通过角色，**将权限授予这些主体以操作资源**。这是在GCP中指定主体对资源的权限的方式。\
有些权限将允许用户**获得更多的权限**，无论是在资源上还是第三方资源上，这就是所谓的**权限提升**（同时，也包括利用漏洞获得更多权限）。

因此，我想将GCP权限提升技术分为**两组**：

* **提升到一个主体**：这将允许您**冒充另一个主体**，因此拥有它的所有权限。例如：滥用_getAccessToken_来冒充服务账户。
* **在资源上提升权限**：这将允许您**获得对特定资源的更多权限**。例如：您可以滥用_cloudfunctions上的setIamPolicy_权限来允许您触发函数。
* 注意，一些**资源权限也将允许您将任意服务账户附加到资源上**。这意味着您将能够以SA身份启动资源，进入资源，并**窃取SA令牌**。因此，这将允许通过资源提升来提升到一个主体。这在以前的几个资源中发生过，但现在较少见（但仍然可能发生）。

显然，**第二组**的权限提升技术最有趣，因为它将允许您**在您已经拥有一些权限的资源之外获得更多权限**。然而，请注意，**在资源上提升权限**也可能让您访问**敏感信息**，甚至是**其他主体**（可能通过读取包含SA令牌的秘密）。

{% hint style="warning" %}
重要的是要注意，在**GCP中服务账户既是主体也是权限**，所以在SA中提升权限也将允许您冒充它。
{% endhint %}

{% hint style="info" %}
括号中的权限表示利用`gcloud`来利用漏洞所需的权限。如果通过API利用它，则可能不需要这些权限。
{% endhint %}

## 权限提升方法论的权限

这是我**测试特定权限**以在GCP内执行特定操作的方法。

1. 下载github仓库 [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. 在tests/中添加新脚本

## 权限提升技术

在AWS中提升您的权限的方法是拥有足够的权限，以某种方式，访问其他服务账户/用户/组的权限。链式提升直到您对组织拥有管理员访问权限。

{% hint style="warning" %}
GCP拥有**数百个**（如果不是数千个）**权限**，可以授予实体。在这本书中，您可以找到我所知道的所有可以滥用来**提升权限**的权限，但如果您**知道这里未提及的某些路径**，**请分享它**。
{% endhint %}

您可以找到所有**按服务划分的privesc路径**：

* [**Apikeys权限提升**](gcp-apikeys-privesc.md)
* [**Cloudbuild权限提升**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions权限提升**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler权限提升**](gcp-cloudscheduler-privesc.md)
* [**Compute权限提升**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer权限提升**](gcp-composer-privesc.md)
* [**Container权限提升**](gcp-container-privesc.md)
* [**Deploymentmanager权限提升**](gcp-deploymentmaneger-privesc.md)
* [**IAM权限提升**](gcp-iam-privesc.md)
* [**KMS权限提升**](gcp-kms-privesc.md)
* [**Orgpolicy权限提升**](gcp-orgpolicy-privesc.md)
* [**Pubsub权限提升**](gcp-pubsub-privesc.md)
* [**Resourcemanager权限提升**](gcp-resourcemanager-privesc.md)
* [**Run权限提升**](gcp-run-privesc.md)
* [**Secretmanager权限提升**](gcp-secretmanager-privesc.md)
* [**Serviceusage权限提升**](gcp-serviceusage-privesc.md)
* [**Source Repos权限提升**](gcp-sourcerepos-privesc.md)
* [**Storage权限提升**](gcp-storage-privesc.md)
* [**Misc权限提升**](gcp-misc-perms-privesc.md)
### 在 GCP 中滥用权限以在本地提升权限

如果您在 GCP 中的一台机器内部，您可能能够滥用权限甚至在本地提升权限：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考资料

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>从零开始学习 AWS 黑客攻击技巧，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧。

</details>
