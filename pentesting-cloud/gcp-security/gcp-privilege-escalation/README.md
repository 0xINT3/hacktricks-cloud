# GCP - 权限提升

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## GCP权限提升简介 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP和其他云服务一样，有一些**主体**：用户、组和服务账户，以及一些**资源**，如计算引擎、云函数等。\
然后，通过角色，**将权限授予这些主体以操作资源**。这是在GCP中指定主体对资源的权限的方式。\
有些权限允许用户**获得更多资源上的权限**，或第三方资源的权限，这就是所谓的**权限提升**（也包括利用漏洞获得更多权限）。

因此，我想将GCP权限提升技术分为**两组**：

* **提升到一个主体**：这将允许您**冒充另一个主体**，因此拥有它的所有权限。例如：滥用 _getAccessToken_ 冒充服务账户。
* **在资源上提升权限**：这将允许您**在特定资源上获得更多权限**。例如：您可以滥用_cloudfunctions_ 上的 _setIamPolicy_ 权限，允许您触发函数。
* 注意，一些**资源权限也允许您将任意服务账户附加到资源上**。这意味着您将能够以服务账户的身份启动资源，进入资源，并**窃取服务账户令牌**。因此，这将允许通过资源提升来提升到一个主体。这在以前的几个资源中发生过，但现在较少见（但仍然可能发生）。

显然，**第二组**的权限提升技术最有趣，因为它将允许您**在已经拥有一些权限的资源之外获得更多权限**。然而，请注意，在资源上**提升权限**也可能让您访问**敏感信息**，甚至**其他主体**（可能通过读取包含服务账户令牌的秘密）。

{% hint style="warning" %}
重要的是要注意，在**GCP中服务账户既是主体也是权限**，所以在服务账户中提升权限也将允许您冒充它。
{% endhint %}

{% hint style="info" %}
括号中的权限表示使用`gcloud`利用漏洞所需的权限。如果通过API利用，可能不需要这些权限。
{% endhint %}

## 权限提升方法论的权限

这是我**测试特定权限**以在GCP内执行特定操作的方法。

1. 下载github仓库 [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. 在tests/中添加新脚本

## 绕过访问范围 <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

当使用[访问范围](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)时，为计算实例（VM）生成的OAuth令牌将**包含**[**范围**](https://oauth.net/2/scope/)**限制**。然而，您可能能够**绕过**这一限制并利用被泄露账户的权限。

**绕过**这一限制的**最佳方式**是要么**找到新的凭据**，要么**找到服务密钥以生成无限制的OAuth令牌**，要么**跳转到限制较少的不同VM**。

**攻破另一个盒子**

环境中可能存在具有较少限制性访问范围的其他盒子。如果您可以查看`gcloud compute instances list --quiet --format=json`的输出，请寻找具有您想要的特定范围或**`auth/cloud-platform`**全包含范围的实例。

也要注意分配了默认服务账户（`PROJECT_NUMBER-compute@developer.gserviceaccount.com`）的实例。

**搜索服务账户密钥**

Google非常明确地指出[**"访问范围不是安全机制……在不通过OAuth认证的请求中它们没有效果"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)。

因此，如果您在实例上**找到了**[**服务账户密钥**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys)，您可以绕过限制。这些是**RSA私钥**，可以用来认证Google Cloud API并**请求一个无范围限制的新OAuth令牌**。

检查是否有任何服务账户曾经导出过密钥：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
这些文件**默认不存储在计算实例上**，因此你需要很幸运才能遇到它们。文件的默认名称是`[project-id]-[portion-of-key-id].json`。因此，如果你的项目名称是`test-project`，那么你可以**搜索文件系统`test-project*.json`**，寻找这个密钥文件。

文件的内容看起来像这样：
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
或者，如果**通过CLI生成**，它们将如下所示：
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
如果您找到了这些文件之一，您可以告诉 **`gcloud` 命令重新认证** 这个服务账户。您可以在实例上执行此操作，或在安装了工具的任何机器上执行。
```bash
gcloud auth activate-service-account --key-file [FILE]
```
你现在可以按照以下步骤**测试你的新 OAuth 令牌**：
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
您应该会看到列出的 `https://www.googleapis.com/auth/cloud-platform` 范围，这意味着您**不受任何实例级访问范围的限制**。您现在有权使用分配给您的所有 IAM 权限。

## 权限提升技术

在 AWS 中提升权限的方法是拥有足够的权限，以某种方式访问其他服务账户/用户/组的权限。链式提升直到您对组织拥有管理员访问权限。

{% hint style="warning" %}
GCP 拥有**数百个**（如果不是数千个）可以授予实体的**权限**。在这本书中，您可以找到我所知道的所有可以滥用来**提升权限**的权限，但如果您**知道**这里未提及的**某些路径**，**请分享它**。
{% endhint %}

您可以找到按服务划分的所有**privesc 路径**：

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### 在本地滥用 GCP 来提升权限

如果您在 GCP 中的一台机器内部，您可能能够滥用权限甚至在本地提升权限：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考资料

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> 从零开始学习 AWS 黑客攻击！</strong></summary>

其他支持 HackTricks 的方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
