# GCP - 特権エスカレーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、**会社の広告をHackTricksで見たい**場合や、**PEASSの最新バージョンやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**でフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに参加する

</details>

## GCP特権エスカレーションの概要 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCPは、他のクラウドと同様に、**主体**（ユーザー、グループ、サービスアカウント）と、コンピュートエンジン、クラウドファンクションなどの**リソース**を持っています。\
そして、ロールを介して、これらの主体にリソース上の**権限が付与**されます。これは、GCPで主体がリソースに対して持つ権限を指定する方法です。\
特定の権限によって、ユーザーはリソースまたはサードパーティのリソースに対して**さらに権限を取得**することができます。これが**特権エスカレーション**と呼ばれるものです（また、権限を取得するための脆弱性の悪用も含まれます）。

したがって、GCPの特権エスカレーションテクニックを**2つのグループ**に分けたいと思います：

* **主体への特権エスカレーション**：これにより、**他の主体になりすます**ことができ、その主体のすべての権限を持って行動することができます。例：_getAccessToken_を悪用してサービスアカウントになりすます。
* **リソース上の特権エスカレーション**：これにより、**特定のリソースに対してさらに権限を取得**することができます。例：cloudfunctions上の_setIamPolicy_権限を悪用して関数をトリガーできるようにすることができます。
* なお、一部の**リソースの権限では、任意のサービスアカウントをリソースにアタッチ**することもできます。これにより、SAを使用してリソースを起動し、リソースに入り、SAトークンを**盗む**ことができます。したがって、これにより、リソースエスカレーションを介して主体に特権をエスカレーションすることができます。これは以前はいくつかのリソースで起こっていましたが、現在はそれほど頻繁ではありません（しかし、まだ起こる可能性があります）。

明らかに、最も興味深い特権エスカレーションテクニックは**2番目のグループ**のものです。なぜなら、これにより、**既に特権を持っているリソース以外の特権を取得**することができるからです。ただし、**リソースのエスカレーション**によっては、**機密情報**や**他の主体**（SAのトークンを含むトークンを読むことによって）にもアクセスできることに注意してください。

{% hint style="warning" %}
また、GCPのサービスアカウントは主体と権限の両方であることも重要です。したがって、SAの特権をエスカレーションすると、それをなりすますこともできます。
{% endhint %}

{% hint style="info" %}
かっこ内の権限は、`gcloud`を使用して脆弱性を悪用するために必要な権限を示しています。APIを介して悪用する場合は、これらの権限は必要ない場合があります。
{% endhint %}

## 特権エスカレーション手法の権限

これは、GCP内で特定のアクションを実行するための特定の権限を**テストする方法**です。

1. [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)からGitHubリポジトリをダウンロードします。
2. tests/に新しいスクリプトを追加します。

## 特権エスカレーション手法

AWSで特権をエスカレーションする方法は、他のサービスアカウント/ユーザー/グループの特権に、ある程度の権限を持つことができるようになることです。組織全体に対して管理者アクセス権を持つまで、エスカレーションを連鎖させます。

{% hint style="warning" %}
GCPには、（おそらく数千もの）**数百の権限**があります。この本では、**特権をエスカレーションするために悪用できるすべての権限**を見つけることができますが、ここに記載されていないパスを**知っている場合は、共有してください**。
{% endhint %}

すべての**サービスごとに分けられた特権エスカレーションパス**を見つけることができます：

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)
### GCPを悪用して特権をローカルでエスカレーションする

GCP内のマシンにいる場合、権限を悪用して特権をローカルでエスカレーションすることができるかもしれません：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>HackTricksをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れる
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>
