# GCP - Ayrıcalık Yükseltme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## GCP Ayrıcalık Yükseltmeye Giriş <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, diğer herhangi bir bulut gibi, bazı **ilkeleri** içerir: kullanıcılar, gruplar ve hizmet hesapları ve bazı **kaynaklar** gibi hesaplama motoru, bulut işlevleri...\
Sonra, roller aracılığıyla, bu **ilkelerin kaynaklar üzerindeki izinleri verilir**. Bu, GCP'deki bir kaynak üzerinde bir ilkeye sahip olan izinleri belirtmenin yoludur.\
Bazı izinler, bir kullanıcının kaynak veya üçüncü taraf kaynaklar üzerinde **daha fazla izin almasına** izin verecektir ve bu, **ayrıcalık yükseltme** olarak adlandırılır (ayrıca, daha fazla izin almak için zafiyetleri sömürme).

Bu nedenle, GCP ayrıcalık yükseltme tekniklerini **2 gruba** ayırmak istiyorum:

* **Bir ilkeye ayrıcalık yükseltme**: Bu, başka bir ilkeyi **taklit etmenize** izin verecektir ve bu nedenle tüm izinleriyle onun gibi davranmanıza olanak sağlar. Örneğin: Bir hizmet hesabını taklit etmek için _getAccessToken_ kötüye kullanımı.
* **Kaynak üzerinde ayrıcalık yükseltme**: Bu, **belirli bir kaynak üzerinde daha fazla izin almanıza** izin verecektir. Örneğin: bir işlevi tetiklemenize izin vermek için cloudfunctions üzerinde _setIamPolicy_ iznini kötüye kullanabilirsiniz.
* Bazı **kaynak izinleri ayrıca bir hizmet hesabını** kaynağa **bağlamanıza** izin verecektir. Bu, bir SA ile bir kaynağı başlatabileceğiniz, kaynağa girebileceğiniz ve **SA belirtecinin çalınmasına** izin vereceğiniz anlamına gelir. Bu nedenle, bir kaynak yükseltmesi aracılığıyla bir ilkeye ayrıcalık yükseltme yapmanıza izin verecektir. Bu daha önce birkaç kaynakta yaşandı, ancak şimdi daha az sıklıkta oluyor (ancak hala olabilir).

Açıkçası, en ilginç ayrıcalık yükseltme teknikleri, **ikinci gruptaki** tekniklerdir çünkü **zaten bazı ayrıcalıklara sahip olduğunuz kaynakların dışında daha fazla ayrıcalık elde etmenizi** sağlar. Bununla birlikte, **kaynaklarda yükseltme** yapmak, aynı zamanda **hassas bilgilere** veya hatta **diğer ilkelere** (belki bir SA belirteci içeren bir gizliyi okuyarak) erişim sağlayabilir.

{% hint style="warning" %}
Ayrıca, **GCP Hizmet Hesapları hem ilke hem de izinlerdir**, bu nedenle bir SA'da ayrıcalıkları yükseltmek, onu taklit etmenize de izin verecektir.
{% endhint %}

{% hint style="info" %}
Parantez içindeki izinler, `gcloud` ile zafiyetin sömürülmesi için gereken izinleri gösterir. Bunlar, API aracılığıyla sömürülüyorsa gerekli olmayabilir.
{% endhint %}

## Ayrıcalık Yükseltme Metodolojisi için İzinler

Belirli eylemleri gerçekleştirmek için belirli izinleri **test etmek** için aşağıdaki adımları izleyin.

1. Github deposunu [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts) adresinden indirin.
2. tests/ klasörüne yeni betiği ekleyin

## Erişim kapsamlarını atlatma <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCP meta veri servisinden sızdırılan SA belirteçleri **erişim kapsamlarına** sahiptir. Bunlar, belirli belirtecin sahip olduğu **izinler üzerindeki kısıtlamalardır**. Örneğin, belirtecin **`https://www.googleapis.com/auth/cloud-platform`** kapsamı varsa, tüm GCP hizmetlerine **tam erişimi** olacaktır. Bununla birlikte, belirtecin **`https://www.googleapis.com/auth/cloud-platform.read-only`** kapsamı varsa, yalnızca IAM'de SA'nın daha fazla izne sahip olsa bile tüm GCP hizmetlerine **salt okunur erişimi** olacaktır.

Bu izinleri atlamak için doğrudan bir yol yoktur, ancak her zaman kompromize edilmiş ana makinede **yeni kimlik bilgileri arayabilir**, kısıtlama olmadan bir OAuth belirteci oluşturmak için **hizmet anahtarını bulabilir** veya **daha az kısıtlı bir SA'ya sahip farklı bir sanal makineye geçebilirsiniz**.

[**Erişim kapsamları**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) kullanıldığında, hesaplama örneği (VM) için oluşturulan OAuth belirteci, **kapsam sınırlamasını içeren** bir [**kapsam**](https://oauth.net/2/scope/) **kısıtlamasına sahip olacaktır**. Bununla birlikte, kompromize edilen hesabın sahip olduğu izinleri sömürmek ve bu kısıtlamayı atlamak mümkün olabilir.

Bu kısıtlamayı **atlamak için en iyi yol**, ya kompromize edilmiş ana makinede **yeni kimlik bilgileri bulmak**, kısıtlama olmadan bir OAuth belirteci oluşturmak için **hizmet anahtarını bulmak** veya **daha az kısıtlı bir SA'ya sahip farklı bir sanal makineyi ele geçirmektir**.

Anahtarları oluşturulan SA'yı kontrol edin:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Yetki Yükseltme Teknikleri

AWS'de yetkilerinizi yükseltmenin yolu, diğer hizmet hesapları/kullanıcılar/gruplarının yetkilerine bir şekilde erişebilecek kadar yeterli izne sahip olmaktır. Yetkilendirme zincirlemesi yaparak, organizasyon üzerinde yönetici erişimi elde edene kadar yetkileri yükseltmek.

{% hint style="warning" %}
GCP'de bir varlık **binlerce** (belki de binlerce) **izin** alabilir. Bu kitapta, **yetkileri yükseltmek** için **kullanabileceğiniz tüm izinleri** bulabilirsiniz, ancak burada bahsedilmeyen **başka bir yol biliyorsanız**, **lütfen paylaşın**.
{% endhint %}

**Bu bölümün alt sayfaları hizmetlere göre sıralanmıştır. Her hizmette yetkileri yükseltmenin farklı yollarını bulabilirsiniz.**

### Yetkileri yerel olarak yükseltmek için GCP'yi kötüye kullanma

GCP'deki bir makinedeyseniz, yerel olarak bile yetkileri yükseltmek için izinleri kötüye kullanabilirsiniz:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak isterseniz** veya HackTricks'i **PDF olarak indirmek isterseniz**, [**ABONELİK PLANLARINA**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**'ı takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>
