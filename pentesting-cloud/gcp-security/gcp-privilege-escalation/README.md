# GCP - 権限昇格

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## GCP権限昇格入門 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCPは他のクラウドと同様に、**プリンシパル**（ユーザー、グループ、サービスアカウント）と、コンピュートエンジン、クラウドファンクションなどの**リソース**を持っています。\
そして、ロールを通じて、**リソースに対するプリンシパルへの権限が付与されます**。これは、GCPでプリンシパルがリソースに対して持つ権限を指定する方法です。\
特定の権限により、ユーザーはリソースや第三者のリソースに対して**さらに多くの権限を取得することができます**。これが**権限昇格**と呼ばれるものです（また、より多くの権限を得るための脆弱性の悪用も含まれます）。

したがって、GCPの権限昇格テクニックを**2つのグループ**に分けたいと思います：

* **プリンシパルへのPrivesc**：これにより、他のプリンシパルに**なりすますことができます**。したがって、そのプリンシパルのすべての権限で行動することができます。例：_getAccessToken_を悪用してサービスアカウントになりすます。
* **リソース上のPrivesc**：これにより、特定のリソースに対する**より多くの権限を取得することができます**。例：cloudfunctions上の_setIamPolicy_権限を悪用して、関数をトリガーすることができます。
* また、一部の**リソース権限により、任意のサービスアカウントをリソースにアタッチすることもできます**。これは、SAを持つリソースを起動し、リソースに入り、**SAトークンを盗むことができる**ことを意味します。したがって、これにより、リソースのエスカレーションを介してプリンシパルにエスカレートすることができます。これは以前にいくつかのリソースで発生しましたが、現在はあまり頻繁ではありません（しかし、まだ発生する可能性があります）。

明らかに、最も興味深い権限昇格テクニックは**2番目のグループ**のものです。なぜなら、それにより、すでにいくつかの権限を持っているリソースの外で**より多くの権限を取得することができる**からです。しかし、**リソースでのエスカレーション**により、**機密情報**や**他のプリンシパル**へのアクセス（SAのトークンを含むシークレットを読むことによって）も得られる可能性があることに注意してください。

{% hint style="warning" %}
**GCPのサービスアカウントはプリンシパルであり権限でもある**ということも重要です。したがって、SAの権限を昇格することにより、それをなりすますこともできます。
{% endhint %}

{% hint style="info" %}
括弧内の権限は、`gcloud`を使用して脆弱性を悪用するために必要な権限を示しています。APIを通じて悪用する場合、これらは必要ないかもしれません。
{% endhint %}

## 権限昇格方法論のための権限

これは、GCP内で特定のアクションを実行するために特定の権限を**テストする方法**です。

1. githubリポジトリ[https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)をダウンロードする
2. tests/に新しいスクリプトを追加する

## アクセススコープのバイパス <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

[アクセススコープ](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)が使用される場合、コンピューティングインスタンス（VM）に生成されるOAuthトークンには[**スコープ**](https://oauth.net/2/scope/)の**制限が含まれます**。しかし、侵害されたアカウントが持っている権限を悪用して、この制限を**バイパスすることができる**かもしれません。

この制限を**バイパスする最良の方法**は、侵害されたホストで**新しい資格情報を見つける**か、制限なしでOAuthトークンを生成する**サービスキーを見つける**か、または**制限の少ない異なるVMにジャンプする**ことです。

**別のボックスをポップする**

環境内にアクセススコープがより制限されていない別のボックスが存在する可能性があります。`gcloud compute instances list --quiet --format=json`の出力を見ることができれば、特定のスコープを持つインスタンス、または**`auth/cloud-platform`**の全包括的なスコープを持つインスタンスを探します。

また、デフォルトのサービスアカウントが割り当てられているインスタンス（`PROJECT_NUMBER-compute@developer.gserviceaccount.com`）にも注意してください。

**サービスアカウントキーを検索する**

Googleは非常に明確に[**"アクセススコープはセキュリティメカニズムではない... OAuthを介して認証されないリクエストを行う場合、それらは効果がない"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)と述べています。

したがって、インスタンス上に保存されている[**サービスアカウントキー**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys)を**見つけた場合**、制限をバイパスすることができます。これらは**RSAプライベートキー**であり、Google Cloud APIに認証し、**スコープ制限のない新しいOAuthトークンを要求するために使用できます**。

任意のサービスアカウントがいつかキーをエクスポートしたかを確認します：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
これらのファイルは**デフォルトではCompute Instanceに保存されていません**ので、これらに遭遇するには幸運が必要です。ファイルのデフォルト名は`[project-id]-[portion-of-key-id].json`です。したがって、プロジェクト名が`test-project`である場合、このキーファイルを探すためにファイルシステムで`test-project*.json`を**検索**できます。

ファイルの内容は以下のようなものです：
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
また、**CLIから生成された場合**、次のようになります：
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
もしこのようなファイルを見つけた場合、**`gcloud` コマンドにこのサービスアカウントで再認証するよう指示**できます。これはインスタンス上、またはツールがインストールされている任意のマシン上で行うことができます。
```bash
gcloud auth activate-service-account --key-file [FILE]
```
```
**新しいOAuthトークンをテスト**するには、次のようにします:
```
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
スコープに `https://www.googleapis.com/auth/cloud-platform` が表示されている場合、インスタンスレベルのアクセススコープによって制限されていないことを意味します。これで、割り当てられたIAM権限をすべて使用する完全な権力を持っています。

## 権限昇格テクニック

AWSで権限を昇格させる方法は、他のサービスアカウント/ユーザー/グループの権限にアクセスできる十分な権限を持っていることです。組織に対する管理者アクセスを持つまでエスカレーションをチェーンします。

{% hint style="warning" %}
GCPには、エンティティに付与できる**数百**（場合によっては数千）の**権限**があります。この本では、権限を昇格させるために悪用できる**私が知っているすべての権限**を見つけることができますが、ここに記載されていない**何か経路を知っている**場合は、**共有してください**。
{% endhint %}

サービスごとに分けられた**privescパス**を見つけることができます：

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### GCPを悪用してローカルで権限を昇格させる

GCP内のマシン内にいる場合、ローカルで権限を昇格させるために権限を悪用できるかもしれません：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
