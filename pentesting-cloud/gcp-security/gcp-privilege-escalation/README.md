# GCP - 権限昇格

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## GCP権限昇格の紹介 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCPは、他のクラウドと同様に、いくつかの**主体**：ユーザー、グループ、サービスアカウント、およびコンピュートエンジン、クラウドファンクションなどのいくつかの**リソース**を持っています。\
そして、ロールを介して、**リソースに対するこれらの主体への権限が付与されます**。これは、GCPで主体がリソースに対して持つ権限を指定する方法です。\
特定の権限は、ユーザーがリソースまたは第三者のリソースに**さらに多くの権限を取得する**ことを可能にします。これが**権限昇格**と呼ばれるものです（また、より多くの権限を取得するための脆弱性の悪用も含まれます）。

したがって、GCPの権限昇格テクニックを**2つのグループ**に分けたいと思います：

* **主体へのPrivesc**：これにより、他の主体を**なりすます**ことができ、したがって、そのすべての権限で行動することができます。例：_getAccessToken_を悪用してサービスアカウントをなりすます。
* **リソース上のPrivesc**：これにより、特定のリソースに対する**より多くの権限を取得する**ことができます。例：cloudfunctionsに対する_setIamPolicy_権限を悪用して、関数のトリガーを許可する。
* いくつかの**リソースの権限は、任意のサービスアカウント**をリソースにアタッチすることも可能にします。これは、リソースでSAを起動し、リソースに入り、**SAトークンを盗む**ことができることを意味します。したがって、これにより、リソースのエスカレーションを介して主体にエスカレートすることができます。これは以前にいくつかのリソースで発生しましたが、現在はあまり頻繁ではありません（しかし、まだ発生する可能性があります）。

明らかに、最も興味深い権限昇格テクニックは**2番目のグループ**のものです。なぜなら、それにより、すでにいくつかの権限を持っているリソースの外で**より多くの権限を取得する**ことができるからです。ただし、リソースでのエスカレーションは、**機密情報**へのアクセスや、サービスアカウントのトークンを含むシークレットを読むことによって**他の主体**へのアクセスも提供する可能性があることに注意してください。

{% hint style="warning" %}
**GCPのサービスアカウントは主体であり権限でもある**ということも重要です。したがって、SAで権限を昇格することは、それをなりすますことも可能にします。
{% endhint %}

{% hint style="info" %}
括弧内の権限は、`gcloud`を使用して脆弱性を悪用するために必要な権限を示しています。APIを通じて悪用する場合、これらは必要ないかもしれません。
{% endhint %}

## 権限昇格方法論のための権限

これは、GCP内で特定のアクションを実行するために特定の権限を**テストする方法**です。

1. githubリポジトリをダウンロードする [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. tests/に新しいスクリプトを追加する&#x20;

## 権限昇格テクニック

AWSで権限を昇格させる方法は、何らかの方法で他のサービスアカウント/ユーザー/グループの権限にアクセスできる十分な権限を持っていることです。組織に対する管理者アクセスを持つまでエスカレーションを連鎖させます。

{% hint style="warning" %}
GCPには、エンティティに付与できる**数百**（場合によっては数千）の**権限**があります。この本では、権限を昇格させるために悪用できる**私が知っているすべての権限**を見つけることができますが、ここに記載されていない何かのパスを**知っている場合は、それを共有してください**。
{% endhint %}

すべての**privescパスをサービス別に分けたもの**を見つけることができます：

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)
### GCPを悪用してローカルで権限を昇格させる

GCP内のマシンにいる場合、権限を悪用してローカルでさえ権限を昇格させることができるかもしれません：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
