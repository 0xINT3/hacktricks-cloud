# GCP - 特権昇格

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **ハッキングトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## GCP特権昇格の概要 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCPは、他のクラウドと同様に、**ユーザー、グループ、サービスアカウント**などの**主体**と、コンピュートエンジン、クラウドファンクションなどの**リソース**を持っています。\
その後、**ロールを介して主体にリソース上の権限が付与**されます。これは、GCPのリソースに対する主体の権限を指定する方法です。\
特定の権限により、ユーザーはリソースまたはサードパーティのリソースに**さらに権限を取得**できるようになり、これが**特権昇格**と呼ばれるものです（また、権限を取得するために脆弱性を悪用することも含まれます）。

したがって、GCP特権昇格テクニックを**2つのグループ**に分けたいと思います：

- **主体への特権昇格**：これにより、**他の主体になりすます**ことができ、その主体としてすべての権限を持って行動できます。例：_getAccessToken_を悪用してサービスアカウントになりすます。
- **リソース上の特権昇格**：これにより、**特定のリソースに対してさらに権限を取得**できます。例：cloudfunctions上の_setIamPolicy_権限を悪用して、その関数をトリガーできるようにすることができます。
- 一部の**リソース権限**は、リソースに**任意のサービスアカウントを添付することも許可**します。これは、リソースをSAで起動し、リソースに入り、SAトークンを**盗む**ことができることを意味します。したがって、これにより、リソース昇格を介して主体に昇格することができます。これは以前いくつかのリソースで起こっていましたが、今ではそれほど頻繁ではありません（しかし、まだ起こり得ます）。

明らかに、最も興味深い特権昇格テクニックは**2番目のグループ**のものです。なぜなら、これにより、**すでに特権を持っているリソース以外のリソースでさらに特権を取得**できるからです。ただし、**リソース内での昇格**は、**機密情報**や**他の主体**（たとえば、SAのトークンを含む秘密を読むことを通じて）へのアクセスも提供する可能性があります。

{% hint style="warning" %}
また、**GCPサービスアカウントは主体であり権限でもある**ことにも注意することが重要です。そのため、SAで特権を昇格させると、それをなりすますこともできます。
{% endhint %}

{% hint style="info" %}
かっこ内の権限は、`gcloud`を使用して脆弱性を悪用するために必要な権限を示しています。APIを介して悪用する場合は必要ない場合があります。
{% endhint %}

## 特権昇格方法論の権限

これは、GCP内で特定のアクションを実行するための特定の権限を**テスト**する方法です。

1. GitHubリポジトリ[https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)をダウンロードします。
2. tests/に新しいスクリプトを追加します。

## アクセススコープのバイパス <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCPメタデータサービスから漏洩したSAのトークンには**アクセススコープ**があります。これは、トークンが持つ**権限に対する制限**です。たとえば、トークンに**`https://www.googleapis.com/auth/cloud-platform`**スコープがある場合、すべてのGCPサービスに**完全アクセス**できます。ただし、トークンに**`https://www.googleapis.com/auth/cloud-platform.read-only`**スコープがある場合、IAMでより多くの権限を持っていても、すべてのGCPサービスに**読み取り専用アクセス**しかありません。

これらの権限をバイパスする直接的な方法はありませんが、侵害されたホストで**新しい資格情報を検索**したり、制限なしでOAuthトークンを生成する**サービスキーを見つけたり**、**制限の少ない別のVMに移動する**ことを試すことができます。

[アクセススコープ](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)が使用されると、計算インスタンス（VM）用に生成されるOAuthトークンには**スコープの制限が含まれます**。ただし、この制限を**バイパス**して、侵害されたアカウントが持つ権限を悪用することができるかもしれません。

この制限を**バイパス**する最良の方法は、侵害されたホストで**新しい資格情報を見つける**か、**制限なしでOAuthトークンを生成するためのサービスキーを見つける**か、**制限の少ないSAを持つ別のVMを侵害する**ことです。

次のコマンドで生成されたSAのキーを使用してSAを確認します：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## 特権昇格テクニック

AWSで特権を昇格させる方法は、他のサービスアカウント/ユーザー/グループの特権にアクセスできるだけの権限を持つことです。組織全体に管理者アクセス権を持つまで、特権昇格を繰り返します。

{% hint style="warning" %}
GCPには、エンティティに付与できる**数百**（もしくは数千）の**権限**があります。この書籍では、**特権昇格**に悪用できる**私が知っているすべての権限**を見つけることができますが、ここに記載されていない**パス**をご存知の場合は、**共有してください**。
{% endhint %}

**このセクションのサブページはサービスごとに並べられています。各サービスで特権昇格の異なる方法を見つけることができます。**

### GCPを悪用してローカルで特権昇格する

GCP内のマシンにいる場合、権限を悪用してローカルで特権昇格することができるかもしれません：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksをPDFでダウンロード**したり、**HackTricksを広告**できるようにしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**する
* **ハッキングトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>
