# GCP - Escalaci√≥n de Privilegios

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introducci√≥n a la Escalaci√≥n de Privilegios en GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, como cualquier otra nube, tiene algunos **principales**: usuarios, grupos y cuentas de servicio, y algunos **recursos** como compute engine, cloud functions...
Luego, a trav√©s de roles, **se otorgan permisos a esos principales sobre los recursos**. Esta es la forma de especificar los permisos que un principal tiene sobre un recurso en GCP.
Hay ciertos permisos que permitir√°n a un usuario **obtener a√∫n m√°s permisos** sobre el recurso o recursos de terceros, y eso es lo que se llama **escalaci√≥n de privilegios** (tambi√©n, la explotaci√≥n de vulnerabilidades para obtener m√°s permisos).

Por lo tanto, me gustar√≠a separar las t√©cnicas de escalaci√≥n de privilegios de GCP en **2 grupos**:

* **Privesc a un principal**: Esto te permitir√° **suplantar a otro principal**, y por lo tanto actuar como √©l con todos sus permisos. Por ejemplo: Abusar de _getAccessToken_ para suplantar una cuenta de servicio.
* **Privesc en el recurso**: Esto te permitir√° **obtener m√°s permisos sobre el recurso espec√≠fico**. Por ejemplo: puedes abusar del permiso _setIamPolicy_ sobre cloudfunctions para permitirte activar la funci√≥n.
* Ten en cuenta que algunos **permisos de recursos tambi√©n te permitir√°n adjuntar una cuenta de servicio arbitraria** al recurso. Esto significa que podr√°s lanzar un recurso con una SA, entrar en el recurso y **robar el token de la SA**. Por lo tanto, esto permitir√° escalar a un principal a trav√©s de una escalaci√≥n de recurso. Esto ha ocurrido en varios recursos anteriormente, pero ahora es menos frecuente (aunque todav√≠a puede suceder).

Obviamente, las t√©cnicas de escalaci√≥n de privilegios m√°s interesantes son las del **segundo grupo** porque te permitir√°n **obtener m√°s privilegios fuera de los recursos sobre los que ya tienes** algunos privilegios. Sin embargo, ten en cuenta que **escalar en recursos** tambi√©n puede darte acceso a **informaci√≥n sensible** o incluso a **otros principales** (quiz√°s a trav√©s de la lectura de un secreto que contiene un token de una SA).

{% hint style="warning" %}
Es importante tambi√©n notar que en **GCP las Cuentas de Servicio son tanto principales como permisos**, por lo que escalar privilegios en una SA tambi√©n te permitir√° suplantarla.
{% endhint %}

{% hint style="info" %}
Los permisos entre par√©ntesis indican los permisos necesarios para explotar la vulnerabilidad con `gcloud`. Es posible que no sean necesarios si se explota a trav√©s de la API.
{% endhint %}

## Permisos para la Metodolog√≠a de Escalaci√≥n de Privilegios

As√≠ es como **pruebo permisos espec√≠ficos** para realizar acciones espec√≠ficas dentro de GCP.

1. Descarga el repositorio de github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. A√±ade en tests/ el nuevo script

## Eludiendo los √°mbitos de acceso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Cuando se utilizan [√°mbitos de acceso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), el token OAuth que se genera para la instancia de computaci√≥n (VM) **tendr√° una** [**limitaci√≥n de √°mbito**](https://oauth.net/2/scope/) **incluida**. Sin embargo, podr√≠as ser capaz de **eludir** esta limitaci√≥n y explotar los permisos que tiene la cuenta comprometida.

La **mejor manera de eludir** esta restricci√≥n es encontrar nuevas credenciales en el host comprometido, encontrar la clave del servicio para generar un token OAuth sin restricci√≥n o **saltar a una VM diferente menos restringida**.

**Explotar otra m√°quina**

Es posible que exista otra m√°quina en el entorno con √°mbitos de acceso menos restrictivos. Si puedes ver la salida de `gcloud compute instances list --quiet --format=json`, busca instancias con el √°mbito espec√≠fico que deseas o el √°mbito **`auth/cloud-platform`** todo incluido.

Tambi√©n presta atenci√≥n a las instancias que tienen asignada la cuenta de servicio predeterminada (`PROJECT_NUMBER-compute@developer.gserviceaccount.com`).

**Buscar claves de cuentas de servicio**

Google afirma muy claramente [**"Los √°mbitos de acceso no son un mecanismo de seguridad... no tienen efecto al hacer solicitudes no autenticadas a trav√©s de OAuth"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam).

Por lo tanto, si **encuentras una** [**clave de cuenta de servicio**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) almacenada en la instancia, puedes eludir la limitaci√≥n. Estas son **claves privadas RSA** que se pueden utilizar para autenticarse en la API de Google Cloud y **solicitar un nuevo token OAuth sin limitaciones de √°mbito**.

Comprueba si alguna cuenta de servicio ha exportado una clave en alg√∫n momento con:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
Estos archivos **no se almacenan en una Instancia de Compute por defecto**, por lo que tendr√≠as que tener suerte para encontrarlos. El nombre predeterminado del archivo es `[project-id]-[portion-of-key-id].json`. Entonces, si el nombre de tu proyecto es `test-project`, puedes **buscar en el sistema de archivos `test-project*.json`** buscando este archivo de clave.

El contenido del archivo se ve algo as√≠:
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
O, si se **generan desde la CLI**, se ver√°n as√≠:
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
Si encuentras uno de estos archivos, puedes indicar al comando **`gcloud` que se vuelva a autenticar** con esta cuenta de servicio. Puedes hacer esto en la instancia o en cualquier m√°quina que tenga las herramientas instaladas.
```bash
gcloud auth activate-service-account --key-file [FILE]
```
Ahora puedes **probar tu nuevo token OAuth** de la siguiente manera:
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
Deber√≠as ver `https://www.googleapis.com/auth/cloud-platform` listado en los alcances, lo que significa que **no est√°s limitado por ning√∫n alcance de acceso a nivel de instancia**. Ahora tienes pleno poder para usar todos tus permisos IAM asignados.

## T√©cnicas de Escalada de Privilegios

La forma de escalar tus privilegios en AWS es tener suficientes permisos para poder, de alguna manera, acceder a otros privilegios de cuentas de servicio/usuarios/grupos. Encadenar escaladas hasta tener acceso de administrador sobre la organizaci√≥n.

{% hint style="warning" %}
GCP tiene **cientos** (si no miles) de **permisos** que se pueden otorgar a una entidad. En este libro puedes encontrar **todos los permisos que conozco** que puedes abusar para **escalar privilegios**, pero si **conoces alg√∫n camino** no mencionado aqu√≠, **por favor comp√°rtelo**.
{% endhint %}

Puedes encontrar todos los **caminos de privesc divididos por servicios**:

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### Abusando de GCP para escalar privilegios localmente

Si est√°s dentro de una m√°quina en GCP, podr√≠as ser capaz de abusar de permisos para escalar privilegios incluso localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
