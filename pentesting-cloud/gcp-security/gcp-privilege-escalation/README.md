# GCP - √âl√©vation de privil√®ges

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introduction √† l'√©l√©vation de privil√®ges GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, comme tout autre cloud, poss√®de certains **principaux** : utilisateurs, groupes et comptes de service, et certaines **ressources** comme compute engine, cloud functions...
Ensuite, via des r√¥les, **des permissions sont accord√©es √† ces principaux sur les ressources**. C'est la mani√®re de sp√©cifier les permissions qu'un principal a sur une ressource dans GCP.
Il existe certaines permissions qui permettront √† un utilisateur d'**obtenir encore plus de permissions** sur la ressource ou des ressources tierces, et c'est ce qu'on appelle l'**√©l√©vation de privil√®ges** (aussi, l'exploitation des vuln√©rabilit√©s pour obtenir plus de permissions).

Par cons√©quent, je voudrais s√©parer les techniques d'√©l√©vation de privil√®ges GCP en **2 groupes** :

* **Privesc vers un principal** : Cela vous permettra d'**usurper l'identit√© d'un autre principal**, et donc d'agir comme lui avec toutes ses permissions. Exemple : Abuser de _getAccessToken_ pour usurper l'identit√© d'un compte de service.
* **Privesc sur la ressource** : Cela vous permettra d'**obtenir plus de permissions sur la ressource sp√©cifique**. Exemple : vous pouvez abuser de la permission _setIamPolicy_ sur cloudfunctions pour vous permettre de d√©clencher la fonction.
* Notez que certaines **permissions de ressources permettront √©galement de rattacher un compte de service arbitraire** √† la ressource. Cela signifie que vous pourrez lancer une ressource avec un SA, entrer dans la ressource, et **voler le jeton SA**. Par cons√©quent, cela permettra d'escalader vers un principal via une escalade de ressource. Cela s'est produit dans plusieurs ressources auparavant, mais maintenant c'est moins fr√©quent (mais cela peut encore arriver).

√âvidemment, les techniques d'√©l√©vation de privil√®ges les plus int√©ressantes sont celles du **deuxi√®me groupe** car elles vous permettront d'**obtenir plus de privil√®ges en dehors des ressources sur lesquelles vous avez d√©j√†** certains privil√®ges. Cependant, notez que **l'escalade dans les ressources** peut √©galement vous donner acc√®s √† des **informations sensibles** ou m√™me √† **d'autres principaux** (peut-√™tre en lisant un secret qui contient un jeton d'un SA).

{% hint style="warning" %}
Il est important de noter √©galement que dans **GCP les comptes de service sont √† la fois des principaux et des permissions**, donc l'escalade de privil√®ges dans un SA vous permettra √©galement de l'usurper.
{% endhint %}

{% hint style="info" %}
Les permissions entre parenth√®ses indiquent les permissions n√©cessaires pour exploiter la vuln√©rabilit√© avec `gcloud`. Celles-ci pourraient ne pas √™tre n√©cessaires si l'exploitation se fait via l'API.
{% endhint %}

## Permissions pour la m√©thodologie d'√©l√©vation de privil√®ges

Voici comment je **teste des permissions sp√©cifiques** pour effectuer des actions sp√©cifiques dans GCP.

1. T√©l√©chargez le d√©p√¥t github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Ajoutez dans tests/ le nouveau script

## Contournement des scopes d'acc√®s <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Lorsque des [scopes d'acc√®s](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) sont utilis√©s, le jeton OAuth g√©n√©r√© pour l'instance de calcul (VM) **inclura une limitation de** [**scope**](https://oauth.net/2/scope/). Cependant, vous pourriez √™tre capable de **contourner** cette limitation et d'exploiter les permissions que le compte compromis poss√®de.

La **meilleure fa√ßon de contourner** cette restriction est soit de **trouver de nouvelles informations d'identification** sur l'h√¥te compromis, de **trouver la cl√© de service pour g√©n√©rer un jeton OAuth** sans restriction ou de **passer √† une VM diff√©rente moins restreinte**.

**Pirater une autre machine**

Il est possible qu'une autre machine dans l'environnement existe avec des scopes d'acc√®s moins restrictifs. Si vous pouvez voir la sortie de `gcloud compute instances list --quiet --format=json`, cherchez des instances avec soit le scope sp√©cifique que vous voulez, soit le scope **`auth/cloud-platform`** tout inclus.

Gardez √©galement un ≈ìil sur les instances qui ont le compte de service par d√©faut assign√© (`PROJECT_NUMBER-compute@developer.gserviceaccount.com`).

**Rechercher des cl√©s de compte de service**

Google d√©clare tr√®s clairement [**"Les scopes d'acc√®s ne sont pas un m√©canisme de s√©curit√©‚Ä¶ ils n'ont aucun effet lors de requ√™tes non authentifi√©es via OAuth"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam).

Par cons√©quent, si vous **trouvez une** [**cl√© de compte de service**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) stock√©e sur l'instance, vous pouvez contourner la limitation. Ce sont des **cl√©s priv√©es RSA** qui peuvent √™tre utilis√©es pour s'authentifier √† l'API Google Cloud et **demander un nouveau jeton OAuth sans limitations de scope**.

V√©rifiez si un compte de service a export√© une cl√© √† un moment donn√© avec :
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
Ces fichiers **ne sont pas stock√©s par d√©faut sur une instance Compute**, donc il faudrait avoir de la chance pour les rencontrer. Le nom par d√©faut du fichier est `[project-id]-[portion-of-key-id].json`. Donc, si le nom de votre projet est `test-project`, vous pouvez **rechercher dans le syst√®me de fichiers `test-project*.json`** √† la recherche de ce fichier de cl√©.

Le contenu du fichier ressemble √† ceci :
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
Ou, si **g√©n√©r√©s depuis le CLI**, ils ressembleront √† ceci :
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
Si vous trouvez l'un de ces fichiers, vous pouvez indiquer √† la commande **`gcloud` de se r√©-authentifier** avec ce compte de service. Vous pouvez faire cela sur l'instance, ou sur n'importe quelle machine qui a les outils install√©s.
```bash
gcloud auth activate-service-account --key-file [FILE]
```
Vous pouvez maintenant **tester votre nouveau jeton OAuth** comme suit :
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
Vous devriez voir `https://www.googleapis.com/auth/cloud-platform` list√© dans les scopes, ce qui signifie que vous **n'√™tes limit√© par aucun scope d'acc√®s au niveau de l'instance**. Vous avez maintenant le plein pouvoir d'utiliser toutes vos permissions IAM assign√©es.

## Techniques d'√âl√©vation de Privil√®ges

La mani√®re d'augmenter vos privil√®ges dans AWS est d'avoir suffisamment de permissions pour pouvoir, d'une mani√®re ou d'une autre, acc√©der aux privil√®ges d'autres comptes de service/utilisateurs/groupes. Encha√Æner les escalades jusqu'√† obtenir un acc√®s administrateur sur l'organisation.

{% hint style="warning" %}
GCP a **des centaines** (sinon des milliers) de **permissions** qu'une entit√© peut se voir accorder. Dans ce livre, vous pouvez trouver **toutes les permissions que je connais** que vous pouvez abuser pour **augmenter les privil√®ges**, mais si vous **connaissez une m√©thode** non mentionn√©e ici, **veuillez la partager**.
{% endhint %}

Vous pouvez trouver tous les **chemins d'√©l√©vation de privil√®ges divis√©s par services** :

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### Abuser de GCP pour augmenter les privil√®ges localement

Si vous √™tes √† l'int√©rieur d'une machine dans GCP, vous pourriez √™tre capable d'abuser des permissions pour augmenter les privil√®ges m√™me localement :

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
