# GCP - Privilege Escalation

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Einf√ºhrung in die GCP-Privilege-Eskalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP hat wie jede andere Cloud einige **Prinzipien**: Benutzer, Gruppen und Dienstkonten sowie einige **Ressourcen** wie Compute Engine, Cloud-Funktionen...\
Dann werden √ºber Rollen **Berechtigungen f√ºr diese Prinzipien √ºber die Ressourcen erteilt**. Dies ist die Art und Weise, die Berechtigungen eines Prinzips f√ºr eine Ressource in GCP festzulegen.\
Bestimmte Berechtigungen erm√∂glichen es einem Benutzer, **noch mehr Berechtigungen** f√ºr die Ressource oder Drittanbieterressourcen zu erhalten, und das wird als **Privilege Escalation** bezeichnet (auch das Ausnutzen von Schwachstellen, um mehr Berechtigungen zu erhalten).

Daher m√∂chte ich die GCP-Privilege-Eskalationstechniken in **2 Gruppen** unterteilen:

* **Privesc auf ein Prinzipal**: Dies erm√∂glicht es Ihnen, **einen anderen Prinzipal zu impersonieren** und daher mit all seinen Berechtigungen wie er zu handeln. z. B.: Missbrauch von _getAccessToken_ zum Impersonieren eines Dienstkontos.
* **Privesc auf die Ressource**: Dies erm√∂glicht es Ihnen, **mehr Berechtigungen f√ºr die spezifische Ressource zu erhalten**. z. B.: Sie k√∂nnen die _setIamPolicy_-Berechtigung bei Cloud-Funktionen missbrauchen, um die Funktion auszul√∂sen.
* Beachten Sie, dass einige **Ressourcenberechtigungen es auch erm√∂glichen, ein beliebiges Dienstkonto an die Ressource anzuh√§ngen**. Dies bedeutet, dass Sie eine Ressource mit einem SA starten, in die Ressource gelangen und das SA-Token **stehlen** k√∂nnen. Dadurch k√∂nnen Sie √ºber eine Ressourcenescalation zu einem Prinzipal eskalieren. Dies ist in mehreren Ressourcen zuvor passiert, ist jetzt jedoch weniger h√§ufig (kann aber immer noch vorkommen).

Offensichtlich sind die interessantesten Privilege-Eskalationstechniken diejenigen der **zweiten Gruppe**, da sie es Ihnen erm√∂glichen, **mehr Berechtigungen au√üerhalb der Ressourcen zu erhalten**, f√ºr die Sie bereits einige Berechtigungen haben. Beachten Sie jedoch, dass **die Eskalation in Ressourcen** Ihnen auch Zugriff auf **sensible Informationen** oder sogar auf **andere Prinzipale** geben kann (vielleicht √ºber das Lesen eines Geheimnisses, das ein Token eines SA enth√§lt).

{% hint style="warning" %}
Es ist auch wichtig zu beachten, dass in **GCP-Dienstkonten sowohl Prinzipale als auch Berechtigungen** sind. Das Eskalieren von Berechtigungen in einem SA erm√∂glicht es Ihnen daher auch, es zu impersonieren.
{% endhint %}

{% hint style="info" %}
Die Berechtigungen in Klammern geben die Berechtigungen an, die zum Ausnutzen der Schwachstelle mit `gcloud` ben√∂tigt werden. Diese sind m√∂glicherweise nicht erforderlich, wenn sie √ºber die API ausgenutzt werden.
{% endhint %}

## Berechtigungen f√ºr die Methodik der Privilege-Eskalation

So **teste ich spezifische Berechtigungen**, um bestimmte Aktionen in GCP auszuf√ºhren.

1. Laden Sie das GitHub-Repository [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts) herunter.
2. F√ºgen Sie im Ordner tests/ das neue Skript hinzu.

## Umgehen von Zugriffsberechtigungen <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Tokens von SA, die aus dem GCP-Metadatendienst **geleakt** wurden, haben **Zugriffsberechtigungen**. Dies sind **Einschr√§nkungen** f√ºr die **Berechtigungen**, die der Token hat. Wenn der Token z. B. den **Bereich** **`https://www.googleapis.com/auth/cloud-platform`** hat, hat er **vollen Zugriff** auf alle GCP-Dienste. Wenn der Token jedoch den Bereich **`https://www.googleapis.com/auth/cloud-platform.read-only`** hat, hat er nur **Lesezugriff** auf alle GCP-Dienste, auch wenn das SA in IAM mehr Berechtigungen hat.

Es gibt keinen direkten Weg, um diese Berechtigungen zu umgehen, aber Sie k√∂nnten immer versuchen, nach **neuen Anmeldeinformationen** im kompromittierten Host zu suchen, den **Service-Schl√ºssel zu finden**, um ein OAuth-Token ohne Einschr√§nkung zu generieren, oder zu einem anderen VM mit weniger Einschr√§nkungen zu **springen**.

Wenn [Zugriffsberechtigungen](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) verwendet werden, wird das OAuth-Token, das f√ºr die Berechnungsinstanz (VM) generiert wird, **eine** [**Bereichseinschr√§nkung enthalten**](https://oauth.net/2/scope/). M√∂glicherweise k√∂nnen Sie jedoch diese Einschr√§nkung umgehen und die Berechtigungen des kompromittierten Kontos ausnutzen.

Der **beste Weg, um** diese Einschr√§nkung zu umgehen, besteht darin, entweder **neue Anmeldeinformationen** im kompromittierten Host zu finden, den **Service-Schl√ºssel zu finden, um ein OAuth-Token** ohne Einschr√§nkung zu generieren, oder eine andere VM mit einem SA mit weniger Einschr√§nkungen zu **kompromittieren**.

√úberpr√ºfen Sie SA mit generierten Schl√ºsseln mit:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Techniken zur Privilegieneskalation

Der Weg, um Ihre Berechtigungen in AWS zu eskalieren, besteht darin, ausreichende Berechtigungen zu haben, um auf die Berechtigungen anderer Dienstkonten/Benutzer/Gruppen zugreifen zu k√∂nnen. Eskalationen verketten, bis Sie Admin-Zugriff auf die Organisation haben.

{% hint style="warning" %}
GCP hat **hunderte** (wenn nicht tausende) von **Berechtigungen**, die einer Entit√§t gew√§hrt werden k√∂nnen. In diesem Buch finden Sie **alle Berechtigungen, die ich kenne**, die Sie missbrauchen k√∂nnen, um **Berechtigungen zu eskalieren**, aber wenn Sie einen **Weg kennen**, der hier nicht erw√§hnt wird, **teilen Sie ihn bitte**.
{% endhint %}

**Die Unterseiten dieses Abschnitts sind nach Diensten geordnet. Sie finden auf jedem Dienst verschiedene M√∂glichkeiten, Berechtigungen zu eskalieren.**

### Missbrauch von GCP zur lokalen Eskalation von Berechtigungen

Wenn Sie sich in einer Maschine in GCP befinden, k√∂nnten Sie Berechtigungen missbrauchen, um Berechtigungen sogar lokal zu eskalieren:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referenzen

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
