# GCP - 権限昇格

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## GCP権限昇格の紹介 <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCPは他のクラウドと同様に、**プリンシパル**（ユーザー、グループ、サービスアカウント）と**リソース**（コンピュートエンジン、クラウドファンクションなど）を持っています。\
そして、ロールを通じて、**リソースに対するプリンシパルの権限が付与されます**。これは、GCPでプリンシパルがリソースに対して持つ権限を指定する方法です。\
特定の権限を持つユーザーは、リソースや第三者のリソースに対して**さらに多くの権限を取得することができます**。これが**権限昇格**と呼ばれるものです（また、より多くの権限を取得するための脆弱性の悪用も含まれます）。

したがって、GCPの権限昇格テクニックを**2つのグループ**に分けたいと思います：

* **プリンシパルへのPrivesc**：これにより、他のプリンシパルに**なりすますことができます**。したがって、そのプリンシパルのすべての権限で行動することができます。例：_getAccessToken_を悪用してサービスアカウントになりすます。
* **リソース上のPrivesc**：これにより、特定のリソースに対する**より多くの権限を取得することができます**。例：cloudfunctions上の_setIamPolicy_権限を悪用して、関数をトリガーすることができます。
* また、一部の**リソース権限により、任意のサービスアカウント**をリソースにアタッチすることもできます。つまり、リソースをSAと共に起動し、リソースに入り、**SAトークンを盗む**ことができます。したがって、これにより、リソースのエスカレーションを介してプリンシパルにエスカレートすることができます。これは以前にいくつかのリソースで発生しましたが、現在はあまり頻繁ではありません（しかし、まだ発生する可能性があります）。

明らかに、**第二グループ**の権限昇格テクニックが最も興味深いものです。なぜなら、それにより、すでにいくつかの権限を持っているリソースの外で**より多くの権限を取得することができる**からです。しかし、リソースでのエスカレーションは、**機密情報**へのアクセスや、サービスアカウントのトークンが含まれている秘密を読むことによって**他のプリンシパル**へのアクセスも提供するかもしれません。

{% hint style="warning" %}
**GCPのサービスアカウントはプリンシパルと権限の両方**であることも重要です。したがって、SAの権限を昇格することは、それをなりすますことも可能にします。
{% endhint %}

{% hint style="info" %}
括弧内の権限は、`gcloud`を使用して脆弱性を悪用するために必要な権限を示しています。APIを通じて悪用する場合、これらは必要ないかもしれません。
{% endhint %}

## 権限昇格方法論のための権限

これは、GCP内で特定のアクションを実行するために特定の権限を**テストする方法**です。

1. githubリポジトリ[https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)をダウンロードする
2. tests/に新しいスクリプトを追加する

## アクセススコープのバイパス <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCPメタデータサービスから漏洩したSAのトークンには**アクセススコープ**があります。これらは、トークンが持つ**権限**に対する**制限**です。例えば、トークンが**`https://www.googleapis.com/auth/cloud-platform`** スコープを持っている場合、すべてのGCPサービスに対して**完全なアクセス**を持ちます。しかし、トークンが**`https://www.googleapis.com/auth/cloud-platform.read-only`** スコープを持っている場合、IAMでSAがより多くの権限を持っていても、すべてのGCPサービスに対して**読み取り専用のアクセス**のみを持ちます。

これらの権限を直接バイパスする方法はありませんが、常に侵害されたホストで**新しい資格情報**を探すか、制限なしでOAuthトークンを生成する**サービスキーを見つける**か、**制限の少ない異なるVMにジャンプする**ことを試みることができます。

[アクセススコープ](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)が使用される場合、コンピューティングインスタンス（VM）に生成されるOAuthトークンには[**スコープ**](https://oauth.net/2/scope/)の**制限が含まれます**。しかし、侵害されたアカウントが持っている権限を悪用して、この制限を**バイパス**することができるかもしれません。

この制限を**バイパスする最良の方法**は、侵害されたホストで**新しい資格情報を見つける**か、制限なしでOAuthトークンを生成する**サービスキーを見つける**か、**制限の少ない異なるVMのSAを侵害する**ことです。

キーが生成されたSAをチェックするには：
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## 権限昇格テクニック

AWSで権限を昇格させる方法は、他のサービスアカウント/ユーザー/グループの権限に何らかの方法でアクセスできる十分な権限を持っていることです。組織に対する管理者アクセスを持つまでエスカレーションを連鎖させます。

{% hint style="warning" %}
GCPには、エンティティに付与できる**数百**（場合によっては数千）の**権限**があります。この本では、権限昇格を**悪用できるすべての権限**を見つけることができますが、ここに記載されていない**何かパスを知っている**場合は、**共有してください**。
{% endhint %}

すべての**privescパスをサービス別に**見つけることができます：

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### GCPを悪用してローカルで権限を昇格させる

GCP内のマシン内にいる場合、権限を悪用してローカルでさえ権限を昇格させることができるかもしれません：

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してハッキングのコツを**共有する**。

</details>
