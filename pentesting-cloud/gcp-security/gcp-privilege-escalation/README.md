# GCP - Escalada de Privilegios

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introducci√≥n a la Escalada de Privilegios en GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, como cualquier otra nube, tiene algunos **principales**: usuarios, grupos y cuentas de servicio, y algunos **recursos** como motor de c√≥mputo, funciones en la nube...\
Luego, a trav√©s de roles, **se otorgan permisos a esos principales sobre los recursos**. Esta es la forma de especificar los permisos que un principal tiene sobre un recurso en GCP.\
Hay ciertos permisos que permitir√°n a un usuario **obtener a√∫n m√°s permisos** en el recurso o en recursos de terceros, y eso es lo que se llama **escalada de privilegios** (tambi√©n, la explotaci√≥n de vulnerabilidades para obtener m√°s permisos).

Por lo tanto, me gustar√≠a separar las t√©cnicas de escalada de privilegios de GCP en **2 grupos**:

* **Privesc a un principal**: Esto te permitir√° **suplantar a otro principal**, y por lo tanto actuar como √©l con todos sus permisos. Ej.: Abusar de _getAccessToken_ para suplantar una cuenta de servicio.
* **Privesc en el recurso**: Esto te permitir√° **obtener m√°s permisos sobre el recurso espec√≠fico**. Ej.: puedes abusar del permiso _setIamPolicy_ sobre las funciones en la nube para permitirte activar la funci√≥n.
  * Ten en cuenta que algunos **permisos de recursos tambi√©n te permitir√°n adjuntar una cuenta de servicio arbitraria** al recurso. Esto significa que podr√°s lanzar un recurso con una cuenta de servicio, entrar en el recurso y **robar el token de la cuenta de servicio**. Por lo tanto, esto permitir√° escalar a un principal a trav√©s de una escalada de recursos. Esto ha sucedido en varios recursos anteriormente, pero ahora es menos frecuente (pero a√∫n puede suceder).

Obviamente, las t√©cnicas de escalada de privilegios m√°s interesantes son las del **segundo grupo** porque te permitir√°n **obtener m√°s privilegios fuera de los recursos** en los que ya tienes algunos privilegios. Sin embargo, ten en cuenta que **escalar en recursos** tambi√©n puede darte acceso a **informaci√≥n confidencial** o incluso a **otros principales** (tal vez a trav√©s de la lectura de un secreto que contiene un token de una cuenta de servicio).

{% hint style="warning" %}
Tambi√©n es importante tener en cuenta que en **GCP las cuentas de servicio son tanto principales como permisos**, por lo que la escalada de privilegios en una cuenta de servicio tambi√©n te permitir√° suplantarla.
{% endhint %}

{% hint style="info" %}
Los permisos entre par√©ntesis indican los permisos necesarios para explotar la vulnerabilidad con `gcloud`. Es posible que no sean necesarios si se explota a trav√©s de la API.
{% endhint %}

## Permisos para la Metodolog√≠a de Escalada de Privilegios

As√≠ es como **pruebo los permisos espec√≠ficos** para realizar acciones espec√≠ficas dentro de GCP.

1. Descarga el repositorio de GitHub [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Agrega en tests/ el nuevo script&#x20;

## T√©cnicas de Escalada de Privilegios

La forma de escalar tus privilegios en GCP es tener suficientes permisos para poder, de alguna manera, acceder a los privilegios de otras cuentas de servicio/usuarios/grupos. Encadenando escaladas hasta que tengas acceso de administrador sobre la organizaci√≥n.

{% hint style="warning" %}
GCP tiene **cientos** (si no miles) de **permisos** que se pueden otorgar a una entidad. En este libro puedes encontrar **todos los permisos que conozco** que se pueden abusar para **escalar privilegios**, pero si **conoces alg√∫n camino** que no se mencione aqu√≠, **por favor comp√°rtelo**.
{% endhint %}

Puedes encontrar todos los **caminos de escalada de privilegios divididos por servicios**:

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### Abusando de GCP para escalar privilegios localmente

Si est√°s dentro de una m√°quina en GCP, es posible que puedas abusar de los permisos para escalar privilegios incluso localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The