# GCP - Escala√ß√£o de Privil√©gios

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introdu√ß√£o √† Escala√ß√£o de Privil√©gios no GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

O GCP, como qualquer outra nuvem, tem alguns **principais**: usu√°rios, grupos e contas de servi√ßo, e alguns **recursos** como motor de computa√ß√£o, fun√ß√µes em nuvem...\
Em seguida, por meio de fun√ß√µes, **permiss√µes s√£o concedidas a esses principais sobre os recursos**. Esta √© a maneira de especificar as permiss√µes que um principal tem sobre um recurso no GCP.\
Existem certas permiss√µes que permitir√£o a um usu√°rio **obter ainda mais permiss√µes** no recurso ou em recursos de terceiros, e isso √© chamado de **escala√ß√£o de privil√©gios** (tamb√©m, a explora√ß√£o de vulnerabilidades para obter mais permiss√µes).

Portanto, gostaria de separar as t√©cnicas de escalonamento de privil√©gios do GCP em **2 grupos**:

* **Privesc para um principal**: Isso permitir√° que voc√™ **se fa√ßa passar por outro principal**, e portanto, atue como ele com todas as suas permiss√µes. ex.: Abusar do _getAccessToken_ para se passar por uma conta de servi√ßo.
* **Privesc no recurso**: Isso permitir√° que voc√™ **obtenha mais permiss√µes sobre o recurso espec√≠fico**. ex.: voc√™ pode abusar da permiss√£o _setIamPolicy_ sobre fun√ß√µes em nuvem para permitir que voc√™ acione a fun√ß√£o.
  * Observe que algumas **permiss√µes de recursos tamb√©m permitir√£o que voc√™ anexe uma conta de servi√ßo arbitr√°ria** ao recurso. Isso significa que voc√™ poder√° lan√ßar um recurso com uma conta de servi√ßo, entrar no recurso e **roubar o token da conta de servi√ßo**. Portanto, isso permitir√° a escalada para um principal por meio de uma escalada de recurso. Isso aconteceu em v√°rios recursos anteriormente, mas agora √© menos frequente (mas ainda pode acontecer).

Obviamente, as t√©cnicas de escalonamento de privil√©gios mais interessantes s√£o as do **segundo grupo** porque permitir√£o que voc√™ **obtenha mais privil√©gios fora dos recursos que j√° possui** alguns privil√©gios. No entanto, observe que **escalando em recursos** voc√™ tamb√©m pode ter acesso a **informa√ß√µes confidenciais** ou at√© mesmo a **outros principais** (talvez lendo um segredo que contenha um token de uma conta de servi√ßo).

{% hint style="warning" %}
Tamb√©m √© importante observar que nas **Contas de Servi√ßo do GCP s√£o tanto principais quanto permiss√µes**, portanto, a escalada de privil√©gios em uma conta de servi√ßo permitir√° que voc√™ tamb√©m se fa√ßa passar por ela.
{% endhint %}

{% hint style="info" %}
As permiss√µes entre par√™nteses indicam as permiss√µes necess√°rias para explorar a vulnerabilidade com `gcloud`. Essas podem n√£o ser necess√°rias se exploradas por meio da API.
{% endhint %}

## Permiss√µes para Metodologia de Escala√ß√£o de Privil√©gios

√â assim que **testo permiss√µes espec√≠ficas** para executar a√ß√µes espec√≠ficas dentro do GCP.

1. Baixe o reposit√≥rio do github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Adicione em tests/ o novo script&#x20;

## T√©cnicas de Escalonamento de Privil√©gios

A maneira de escalar seus privil√©gios no GCP √© ter permiss√µes suficientes para poder, de alguma forma, acessar os privil√©gios de outras contas de servi√ßo/usu√°rios/grupos. Encadeando escalonamentos at√© ter acesso de administrador sobre a organiza√ß√£o.

{% hint style="warning" %}
O GCP tem **centenas** (se n√£o milhares) de **permiss√µes** que uma entidade pode receber. Neste livro, voc√™ pode encontrar **todas as permiss√µes que conhe√ßo** que voc√™ pode abusar para **escalar privil√©gios**, mas se voc√™ **conhece algum caminho** n√£o mencionado aqui, **por favor, compartilhe**.
{% endhint %}

Voc√™ pode encontrar todos os **caminhos de escalonamento de privil√©gios divididos por servi√ßos**:

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### Abusando do GCP para escalar privil√©gios localmente

Se voc√™ estiver dentro de uma m√°quina no GCP, poder√° abusar das permiss√µes para escalar privil√©gios at√© mesmo localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua