# GCP - Escalamento de Privil√©gios

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introdu√ß√£o ao Escalamento de Privil√©gios no GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

O GCP, como qualquer outra nuvem, possui alguns **princ√≠pios**: usu√°rios, grupos e contas de servi√ßo, e alguns **recursos** como o compute engine, cloud functions...\
Ent√£o, por meio de pap√©is, **permiss√µes s√£o concedidas a esses princ√≠pios sobre os recursos**. Esta √© a maneira de especificar as permiss√µes que um princ√≠pio tem sobre um recurso no GCP.\
Existem certas permiss√µes que permitir√£o a um usu√°rio **obter ainda mais permiss√µes** no recurso ou em recursos de terceiros, e isso √© o que se chama de **escalamento de privil√©gios** (tamb√©m, a explora√ß√£o das vulnerabilidades para obter mais permiss√µes).

Portanto, gostaria de separar as t√©cnicas de escalamento de privil√©gios no GCP em **2 grupos**:

* **Privesc para um princ√≠pio**: Isso permitir√° que voc√™ **se passe por outro princ√≠pio**, e, portanto, agir como ele com todas as suas permiss√µes. Ex.: Abusar de _getAccessToken_ para se passar por uma conta de servi√ßo.
* **Privesc no recurso**: Isso permitir√° que voc√™ **obtenha mais permiss√µes sobre o recurso espec√≠fico**. Ex.: voc√™ pode abusar da permiss√£o _setIamPolicy_ em cloudfunctions para permitir que voc√™ acione a fun√ß√£o.
* Note que algumas **permiss√µes de recursos tamb√©m permitir√£o que voc√™ anexe uma conta de servi√ßo arbitr√°ria** ao recurso. Isso significa que voc√™ poder√° lan√ßar um recurso com uma SA, entrar no recurso e **roubar o token da SA**. Portanto, isso permitir√° escalar para um princ√≠pio via escalamento de recurso. Isso aconteceu em v√°rios recursos anteriormente, mas agora √© menos frequente (mas ainda pode acontecer).

Obviamente, as t√©cnicas de escalamento de privil√©gios mais interessantes s√£o as do **segundo grupo**, pois permitir√£o que voc√™ **obtenha mais privil√©gios fora dos recursos que voc√™ j√° tem** alguns privil√©gios. No entanto, note que **escalar em recursos** tamb√©m pode dar acesso a **informa√ß√µes sens√≠veis** ou at√© a **outros princ√≠pios** (talvez lendo um segredo que cont√©m um token de uma SA).

{% hint style="warning" %}
√â importante notar tamb√©m que no **GCP as Contas de Servi√ßo s√£o tanto princ√≠pios quanto permiss√µes**, ent√£o escalar privil√©gios em uma SA permitir√° que voc√™ tamb√©m se passe por ela.
{% endhint %}

{% hint style="info" %}
As permiss√µes entre par√™nteses indicam as permiss√µes necess√°rias para explorar a vulnerabilidade com `gcloud`. Elas podem n√£o ser necess√°rias se a explora√ß√£o for feita atrav√©s da API.
{% endhint %}

## Permiss√µes para Metodologia de Escalamento de Privil√©gios

√â assim que eu **testo permiss√µes espec√≠ficas** para realizar a√ß√µes espec√≠ficas dentro do GCP.

1. Baixe o reposit√≥rio do github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Adicione em tests/ o novo script

## Contornando escopos de acesso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Quando [escopos de acesso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) s√£o usados, o token OAuth que √© gerado para a inst√¢ncia de computa√ß√£o (VM) ter√° uma **limita√ß√£o de** [**escopo**](https://oauth.net/2/scope/) **inclu√≠da**. No entanto, voc√™ pode ser capaz de **contornar** essa limita√ß√£o e explorar as permiss√µes que a conta comprometida possui.

A **melhor maneira de contornar** essa restri√ß√£o √© ou encontrar novas credenciais no host comprometido, encontrar a chave do servi√ßo para gerar um token OAuth sem restri√ß√£o ou **pular para uma VM diferente menos restritiva**.

**Invadir outra m√°quina**

√â poss√≠vel que exista outra m√°quina no ambiente com escopos de acesso menos restritivos. Se voc√™ puder visualizar a sa√≠da de `gcloud compute instances list --quiet --format=json`, procure por inst√¢ncias com o escopo espec√≠fico que voc√™ deseja ou o escopo **`auth/cloud-platform`** abrangente.

Fique atento tamb√©m √†s inst√¢ncias que t√™m a conta de servi√ßo padr√£o atribu√≠da (`PROJECT_NUMBER-compute@developer.gserviceaccount.com`).

**Procurar chaves de conta de servi√ßo**

O Google afirma muito claramente [**"Escopos de acesso n√£o s√£o um mecanismo de seguran√ßa... eles n√£o t√™m efeito ao fazer solicita√ß√µes n√£o autenticadas atrav√©s do OAuth"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam).

Portanto, se voc√™ **encontrar uma** [**chave de conta de servi√ßo**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) armazenada na inst√¢ncia, voc√™ pode contornar a limita√ß√£o. Estas s√£o **chaves privadas RSA** que podem ser usadas para autenticar na API do Google Cloud e **solicitar um novo token OAuth sem limita√ß√µes de escopo**.

Verifique se alguma conta de servi√ßo exportou uma chave em algum momento com:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
Estes arquivos **n√£o s√£o armazenados em uma Inst√¢ncia de Computa√ß√£o por padr√£o**, ent√£o voc√™ teria que ter sorte para encontr√°-los. O nome padr√£o para o arquivo √© `[project-id]-[portion-of-key-id].json`. Ent√£o, se o nome do seu projeto for `test-project`, voc√™ pode **procurar no sistema de arquivos por `test-project*.json`** √† procura deste arquivo de chave.

O conte√∫do do arquivo se parece com isto:
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
Ou, se **gerados a partir do CLI**, eles ter√£o esta apar√™ncia:
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
Se voc√™ encontrar um desses arquivos, pode instruir o comando **`gcloud` a reautenticar** com essa conta de servi√ßo. Voc√™ pode fazer isso na inst√¢ncia ou em qualquer m√°quina que tenha as ferramentas instaladas.
```bash
gcloud auth activate-service-account --key-file [FILE]
```
Voc√™ pode agora **testar seu novo token OAuth** da seguinte forma:
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
Voc√™ deve ver `https://www.googleapis.com/auth/cloud-platform` listado nos escopos, o que significa que voc√™ **n√£o est√° limitado por nenhum escopo de acesso a n√≠vel de inst√¢ncia**. Agora voc√™ tem pleno poder para usar todas as suas permiss√µes IAM atribu√≠das.

## T√©cnicas de Escalonamento de Privil√©gios

A maneira de escalar seus privil√©gios no AWS √© ter permiss√µes suficientes para, de alguma forma, acessar privil√©gios de outras contas de servi√ßo/usu√°rios/grupos. Encadeando escalonamentos at√© ter acesso de administrador sobre a organiza√ß√£o.

{% hint style="warning" %}
GCP tem **centenas** (se n√£o milhares) de **permiss√µes** que uma entidade pode receber. Neste livro voc√™ pode encontrar **todas as permiss√µes que eu conhe√ßo** que voc√™ pode abusar para **escalar privil√©gios**, mas se voc√™ **conhece algum caminho** n√£o mencionado aqui, **por favor compartilhe**.
{% endhint %}

Voc√™ pode encontrar todos os **caminhos de privesc divididos por servi√ßos**:

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](../../gcp-pentesting/gcp-privilege-escalation/gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### Abusando do GCP para escalar privil√©gios localmente

Se voc√™ est√° dentro de uma m√°quina no GCP, voc√™ pode ser capaz de abusar de permiss√µes para escalar privil√©gios at√© mesmo localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
