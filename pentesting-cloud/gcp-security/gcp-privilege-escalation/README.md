# GCP - Privilege Escalation

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Introduzione all'escalation dei privilegi in GCP <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCP, come qualsiasi altro cloud, ha alcuni **principali**: utenti, gruppi e account di servizio, e alcune **risorse** come compute engine, funzioni cloud...\
Quindi, tramite ruoli, **vengono assegnati permessi a questi principali sulle risorse**. Questo √® il modo per specificare i permessi che un principale ha su una risorsa in GCP.\
Ci sono determinati permessi che consentiranno a un utente di **ottenere ancora pi√π permessi** sulla risorsa o su risorse di terze parti, ed √® ci√≤ che viene chiamato **escalation dei privilegi** (inoltre, lo sfruttamento delle vulnerabilit√† per ottenere pi√π permessi).

Pertanto, vorrei separare le tecniche di escalation dei privilegi di GCP in **2 gruppi**:

* **Privesc a un principale**: Ci√≤ ti permetter√† di **impersonare un altro principale**, e quindi agire come se fossi lui con tutti i suoi permessi. Ad esempio: Abuso di _getAccessToken_ per impersonare un account di servizio.
* **Privesc sulla risorsa**: Ci√≤ ti permetter√† di **ottenere pi√π permessi sulla risorsa specifica**. Ad esempio: puoi abusare del permesso _setIamPolicy_ su cloudfunctions per consentirti di attivare la funzione.
* Nota che alcuni **permessi delle risorse ti permetteranno anche di associare un account di servizio arbitrario** alla risorsa. Ci√≤ significa che sarai in grado di avviare una risorsa con un SA, entrare nella risorsa e **rubare il token SA**. Pertanto, ci√≤ consentir√† di scalare a un principale tramite un'escalation delle risorse. Questo √® successo in diverse risorse in passato, ma ora √® meno frequente (ma pu√≤ ancora accadere).

Ovviamente, le tecniche di escalation dei privilegi pi√π interessanti sono quelle del **secondo gruppo** perch√© ti permetteranno di **ottenere pi√π privilegi al di fuori delle risorse** su cui hai gi√† alcuni privilegi. Tuttavia, nota che **l'escalation nelle risorse** potrebbe anche darti accesso a **informazioni sensibili** o persino ad **altri principali** (forse leggendo un segreto che contiene un token di un SA).

{% hint style="warning" %}
√à importante notare anche che in **GCP gli account di servizio sono sia principali che permessi**, quindi l'escalation dei privilegi in un SA ti permetter√† anche di impersonarlo.
{% endhint %}

{% hint style="info" %}
I permessi tra parentesi indicano i permessi necessari per sfruttare la vulnerabilit√† con `gcloud`. Potrebbero non essere necessari se viene sfruttata tramite l'API.
{% endhint %}

## Permessi per la metodologia di escalation dei privilegi

Ecco come **testo specifici permessi** per eseguire azioni specifiche all'interno di GCP.

1. Scarica il repository github [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp\_privesc\_scripts)
2. Aggiungi in tests/ il nuovo script

## Bypassare gli access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

I token di SA trapelati dal servizio di metadati di GCP hanno **access scopes**. Questi sono **vincoli** sui **permessi** che il token ha. Ad esempio, se il token ha lo scope **`https://www.googleapis.com/auth/cloud-platform`**, avr√† **accesso completo** a tutti i servizi GCP. Tuttavia, se il token ha lo scope **`https://www.googleapis.com/auth/cloud-platform.read-only`**, avr√† solo **accesso in sola lettura** a tutti i servizi GCP anche se l'account SA ha pi√π permessi in IAM.

Non esiste un modo diretto per bypassare questi permessi, ma puoi sempre provare a cercare **nuove credenziali** nell'host compromesso, **trovare la chiave di servizio** per generare un token OAuth senza restrizioni o **passare a una diversa VM meno restrittiva**.

Quando vengono utilizzati [access scopes](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), il token OAuth generato per l'istanza di calcolo (VM) avr√† una **limitazione dello scope inclusa**. Tuttavia, potresti essere in grado di **bypassare** questa limitazione e sfruttare i permessi dell'account compromesso.

Il **modo migliore per bypassare** questa restrizione √® trovare **nuove credenziali** nell'host compromesso, trovare la **chiave di servizio per generare un token OAuth** senza restrizioni o compromettere una diversa VM con un SA meno restrittivo.

Controlla SA con chiavi generate con:

```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```

## Tecniche di Escalation dei Privilegi

Il modo per aumentare i privilegi in GCP √® avere abbastanza autorizzazioni per poter, in qualche modo, accedere ai privilegi di altri account utente/gruppi. Concatenare le escalation fino ad ottenere l'accesso amministrativo sull'organizzazione.

{% hint style="warning" %}
GCP ha **centinaia** (se non migliaia) di **autorizzazioni** che possono essere concesse a un'entit√†. In questo libro puoi trovare **tutte le autorizzazioni che conosco** che puoi sfruttare per **aumentare i privilegi**, ma se **conosci qualche percorso** non menzionato qui, **per favore condividilo**.
{% endhint %}

Puoi trovare tutti i **percorsi di escalation dei privilegi suddivisi per servizi**:

* [**Apikeys Privesc**](gcp-apikeys-privesc.md)
* [**Cloudbuild Privesc**](gcp-cloudbuild-privesc.md)
* [**Cloudfunctions Privesc**](gcp-cloudfunctions-privesc.md)
* [**Cloudscheduler Privesc**](gcp-cloudscheduler-privesc.md)
* [**Compute Privesc**](gcp-compute-privesc/)
* [**Composer Privesc**](gcp-composer-privesc.md)
* [**Container Privesc**](gcp-container-privesc.md)
* [**Deploymentmanager Privesc**](gcp-deploymentmaneger-privesc.md)
* [**IAM Privesc**](gcp-iam-privesc.md)
* [**KMS Privesc**](gcp-kms-privesc.md)
* [**Orgpolicy Privesc**](gcp-orgpolicy-privesc.md)
* [**Pubsub Privesc**](https://github.com/carlospolop/hacktricks-cloud/blob/it/pentesting-cloud/gcp-security/gcp-privilege-escalation/gcp-pubsub-privesc.md)
* [**Resourcemanager Privesc**](gcp-resourcemanager-privesc.md)
* [**Run Privesc**](gcp-run-privesc.md)
* [**Secretmanager Privesc**](gcp-secretmanager-privesc.md)
* [**Serviceusage Privesc**](gcp-serviceusage-privesc.md)
* [**Source Repos Privesc**](https://github.com/carlospolop/hacktricks-cloud/blob/it/pentesting-cloud/gcp-security/gcp-privilege-escalation/gcp-sourcerepos-privesc.md)
* [**Storage Privesc**](gcp-storage-privesc.md)
* [**Misc Privesc**](gcp-misc-perms-privesc.md)

### Sfruttare GCP per aumentare i privilegi localmente

Se ti trovi all'interno di una macchina in GCP, potresti essere in grado di sfruttare le autorizzazioni per aumentare i privilegi anche localmente:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## Riferimenti

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
