# GCP - 클라우드빌드 권한 상승

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배우세요!</summary>

HackTricks를 지원하는 다른 방법:

- **회사 광고를 보고 싶거나 HackTricks를 PDF로 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
- [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
- 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
- **해킹 요령을 공유하려면 PR을** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃허브 저장소에 제출하세요.

</details>

## cloudbuild

클라우드 빌드에 대한 자세한 정보는 다음을 확인하세요:

{% content-ref url="../gcp-services/gcp-cloud-build-enum.md" %}
[gcp-cloud-build-enum.md](../gcp-services/gcp-cloud-build-enum.md)
{% endcontent-ref %}

### `cloudbuild.builds.create`

이 권한을 가지면 **클라우드 빌드를 제출**할 수 있습니다. 클라우드빌드 머신에는 **기본적으로 클라우드빌드 서비스 계정의 토큰**이 파일 시스템에 있습니다: `<PROJECT_NUMBER>@cloudbuild.gserviceaccount.com`. 그러나 클라우드빌드 구성에서 **프로젝트 내의 어떤 서비스 계정을 지정**할 수 있습니다.\
따라서 머신을 사용하여 토큰을 서버로 유출하거나 **머신 내에서 역쉘을 획들하여 토큰을 획득**할 수 있습니다 (토큰이 포함된 파일은 변경될 수 있음).

원본 악용 스크립트는 [**여기 GitHub에서**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudbuild.builds.create.py) 찾을 수 있습니다 (하지만 토큰을 가져오는 위치가 제대로 작동하지 않았습니다). 따라서 취약한 환경의 [**생성, 악용 및 정리를 자동화하는 스크립트를 여기서**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.sh) 확인하고 클라우드빌드 머신 내에서 역쉘을 얻고 [**여기서 훔치세요**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.py) (코드에서 다른 서비스 계정을 지정하는 방법을 찾을 수 있음).

더 자세한 설명은 [https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/](https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/)를 방문하세요.

### `cloudbuild.builds.update`

**이 권한으로는** 클라우드 빌드를 **업데이트하고 이전 권한과 같이 서비스 계정 토큰을 훔칠 수 있을 수 있습니다** (하지만 작성 시점에 해당 API를 호출하는 방법을 찾지 못했습니다).

TODO

### `cloudbuild.repositories.accessReadToken`

이 권한으로 사용자는 리포지토리에 액세스하는 데 사용되는 **읽기 액세스 토큰**을 얻을 수 있습니다:

{% code overflow="wrap" %}
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadToken"
```
{% endcode %}

### `cloudbuild.repositories.accessReadWriteToken`

이 권한을 가지면 사용자는 저장소에 액세스하는 데 사용되는 **읽기 및 쓰기 액세스 토큰**을 얻을 수 있습니다:

{% code overflow="wrap" %}
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadWriteToken"
```
{% endcode %}

### `cloudbuild.connections.fetchLinkableRepositories`

이 권한을 사용하면 **연결이 액세스할 수 있는 저장소를 가져올 수 있습니다:** 

{% code overflow="wrap" %}
```bash
curl -X GET \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>:fetchLinkableRepositories"
```
{% endcode %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로부터 영웅이 되는 AWS 해킹을 배우세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하고 싶다면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왹**](https://peass.creator-spring.com)을 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 해킹 트릭을 공유하세요.

</details>
