# GCP - Cloudbuild Privilege Escalation

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## cloudbuild

F√ºr weitere Informationen zu Cloud Build siehe:

{% content-ref url="../gcp-services/gcp-cloud-build-enum.md" %}
[gcp-cloud-build-enum.md](../gcp-services/gcp-cloud-build-enum.md)
{% endcontent-ref %}

### `cloudbuild.builds.create`

Mit dieser Berechtigung k√∂nnen Sie **einen Cloud Build einreichen**. Die cloudbuild-Maschine wird standardm√§√üig einen Token des cloudbuild-Servicekontos in ihrem Dateisystem haben: `<PROJECT_NUMBER>@cloudbuild.gserviceaccount.com`. Sie k√∂nnen jedoch **ein beliebiges Servicekonto innerhalb des Projekts** in der cloudbuild-Konfiguration angeben.\
Daher k√∂nnen Sie einfach die Maschine dazu bringen, den Token an Ihren Server zu exfiltrieren oder **eine Reverse-Shell darin zu erhalten und sich den Token selbst zu besorgen** (die Datei, die den Token enth√§lt, k√∂nnte sich √§ndern).

Das urspr√ºngliche Exploit-Skript finden Sie [**hier auf GitHub**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudbuild.builds.create.py) (aber der Ort, von dem es den Token abruft, hat bei mir nicht funktioniert). √úberpr√ºfen Sie daher ein Skript zur Automatisierung der [**Erstellung, des Exploits und der Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.sh) und ein Python-Skript, um eine Reverse-Shell in der cloudbuild-Maschine zu erhalten und [**sie hier zu stehlen**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.py) (im Code finden Sie, wie Sie andere Servicekonten angeben k√∂nnen)**.**

F√ºr eine ausf√ºhrlichere Erkl√§rung besuchen Sie [https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/](https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/)

### `cloudbuild.builds.update`

**M√∂glicherweise** k√∂nnen Sie mit dieser Berechtigung einen Cloud Build **aktualisieren und einfach den Servicekontotoken stehlen**, wie es mit der vorherigen Berechtigung durchgef√ºhrt wurde (aber leider konnte ich zum Zeitpunkt dieses Schreibens keinen Weg finden, um diese API aufzurufen).

TODO

### `cloudbuild.repositories.accessReadToken`

Mit dieser Berechtigung kann der Benutzer das **Lesezugriffstoken** abrufen, das zum Zugriff auf das Repository verwendet wird:

{% code overflow="wrap" %}
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadToken"
```
{% endcode %}

### `cloudbuild.repositories.accessReadWriteToken`

Mit dieser Berechtigung kann der Benutzer das **Lese- und Schreibzugriffstoken** abrufen, das zum Zugriff auf das Repository verwendet wird:

{% code overflow="wrap" %}
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadWriteToken"
```
{% endcode %}

### `cloudbuild.connections.fetchLinkableRepositories`

Mit dieser Berechtigung k√∂nnen Sie **die Repositories abrufen, auf die die Verbindung Zugriff hat:** 

{% code overflow="wrap" %}
```bash
curl -X GET \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>:fetchLinkableRepositories"
```
{% endcode %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>
