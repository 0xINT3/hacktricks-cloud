# GCP - Cloudscheduler特权升级

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## cloudscheduler

### `cloudscheduler.jobs.create` , `iam.serviceAccounts.actAs`

Cloud Scheduler允许您设置定向任意HTTP端点的cron作业。**如果该端点是\*.googleapis.com端点**，那么您还可以告诉Scheduler您希望它对请求进行身份验证，**作为特定的服务帐户**，这正是我们想要的。

由于我们控制来自Cloud Scheduler的HTTP请求的所有方面，我们可以设置它以命中另一个Google API端点。例如，如果我们想要创建一个新的作业，该作业将使用特定的服务帐户代表我们创建一个新的存储桶，我们可以运行以下命令：

{% code overflow="wrap" %}
```
gcloud scheduler jobs create http test –schedule=’* * * * *’ –uri=’https://storage.googleapis.com/storage/v1/b?project=<PROJECT-ID>’ –message-body “{‘name’:’new-bucket-name’}” –oauth-service-account-email 111111111111-compute@developer.gserviceaccount.com –headers Content-Type=application/json
```
{% endcode %}

这个命令会安排一个每分钟的HTTP POST请求，以_111111111111-compute@developer.gserviceaccount.com_的身份进行身份验证。该请求将命中Cloud Storage API的端点，并创建一个名为“new-bucket-name”的新存储桶。

这种方法需要以下**额外的权限**：

* _cloudscheduler.jobs.create_
* _cloudscheduler.locations.list_
* _iam.serviceAccounts.actAs_

要通过这种方法升级我们的权限，我们只需要**以传递的服务账号身份来构造我们想要命中的API的HTTP请求**。您可以使用上面的gcloud命令，而不是脚本。

使用Cloud Tasks可能也可以实现类似的方法，但我们在测试中无法实现。

## 参考资料

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
