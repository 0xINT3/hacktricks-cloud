# GCP - IAM Privilege Escalation

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## IAM

Finden Sie weitere Informationen zu IAM unter:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

Ein Angreifer mit den genannten Berechtigungen kann eine Rolle aktualisieren, die Ihnen zugewiesen ist, und Ihnen zus√§tzliche Berechtigungen f√ºr andere Ressourcen geben, wie:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
Du findest ein Skript zur Automatisierung der **Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier** und ein Python-Skript zur Ausnutzung dieses Privilegs [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). F√ºr weitere Informationen siehe die [**urspr√ºngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Ein Angreifer mit den genannten Berechtigungen kann **einen Zugriffstoken anfordern, der zu einem Dienstkontos geh√∂rt**, sodass es m√∂glich ist, einen Zugriffstoken eines Dienstkontos mit mehr Berechtigungen als unseren anzufordern.

Du findest ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) und ein Python-Skript zur Ausnutzung dieses Privilegs [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). F√ºr weitere Informationen siehe die [**urspr√ºngliche Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Ein Angreifer mit den genannten Berechtigungen kann **einen benutzerverwalteten Schl√ºssel f√ºr ein Dienstkonto erstellen**, was es uns erm√∂glicht, auf GCP als dieses Dienstkonto zuzugreifen.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Sie finden ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) und ein Python-Skript, um dieses Privileg zu missbrauchen [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Weitere Informationen finden Sie in der [**urspr√ºnglichen Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Beachten Sie, dass **`iam.serviceAccountKeys.update` nicht funktioniert, um den Schl√ºssel** eines SA zu √§ndern, da daf√ºr auch die Berechtigung `iam.serviceAccountKeys.create` ben√∂tigt wird.

### `iam.serviceAccounts.implicitDelegation`

Wenn Sie die Berechtigung **`iam.serviceAccounts.implicitDelegation`** f√ºr einen Service Account haben, der die Berechtigung **`iam.serviceAccounts.getAccessToken`** f√ºr einen dritten Service Account hat, k√∂nnen Sie die implicitDelegation verwenden, um **einen Token f√ºr diesen dritten Service Account zu erstellen**. Hier ist ein Diagramm zur Erl√§uterung.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Sie finden ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) und ein Python-Skript, um dieses Privileg zu missbrauchen [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). Weitere Informationen finden Sie in der [**urspr√ºnglichen Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Laut der [**Dokumentation**](https://cloud.google.com/iam/docs/understanding-service-accounts) funktioniert die Delegation nur, um einen Token mithilfe der Methode [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) zu generieren.

### `iam.serviceAccounts.signBlob`

Ein Angreifer mit den genannten Berechtigungen kann **beliebige Payloads in GCP signieren**. Es wird also m√∂glich sein, **ein nicht signiertes JWT des SA zu erstellen und es dann als Blob zu senden, um das JWT vom anvisierten SA signieren zu lassen**. Weitere Informationen finden Sie [**hier**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Sie finden ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) und ein Python-Skript, um dieses Privileg zu missbrauchen [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) und [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). Weitere Informationen finden Sie in der [**urspr√ºnglichen Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

Ein Angreifer mit den genannten Berechtigungen kann **wohlgeformte JSON-Webtokens (JWTs) signieren**. Der Unterschied zur vorherigen Methode besteht darin, dass **anstatt Google einen Blob signieren zu lassen, der ein JWT enth√§lt, die Methode signJWT verwendet wird, die bereits ein JWT erwartet**. Dies macht die Verwendung einfacher, aber Sie k√∂nnen nur JWT anstelle von beliebigen Bytes signieren.

Sie finden ein Skript zur Automatisierung der [**Erstellung, Ausnutzung und Bereinigung einer verwundbaren Umgebung hier**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) und ein Python-Skript, um dieses Privileg zu missbrauchen [**hier**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). Weitere Informationen finden Sie in der [**urspr√ºnglichen Forschung**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Ein Angreifer mit den genannten Berechtigungen kann **IAM-Richtlinien f√ºr Service Accounts hinzuf√ºgen**. Sie k√∂nnen es missbrauchen, um sich die Berechtigungen zu gew√§hren, die Sie ben√∂tigen, um den Service Account zu √ºbernehmen. Im folgenden Beispiel gew√§hren wir uns die Rolle `roles/iam.serviceAccountTokenCreator` √ºber den interessanten SA:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
### `iam.serviceAccounts.actAs`

Die **iam.serviceAccounts.actAs-Berechtigung** ist √§hnlich wie die **iam:PassRole-Berechtigung von AWS**. Sie ist entscheidend f√ºr die Ausf√ºhrung von Aufgaben, wie das Initiieren einer Compute Engine-Instanz, da sie die F√§higkeit verleiht, "als" ein Dienstkonto zu handeln, was eine sichere Berechtigungsverwaltung gew√§hrleistet. Ohne diese Berechtigung k√∂nnten Benutzer unangemessenen Zugriff erlangen. Dar√ºber hinaus beinhaltet die Ausnutzung von **iam.serviceAccounts.actAs** verschiedene Methoden, von denen jede einen Satz von Berechtigungen erfordert, im Gegensatz zu anderen Methoden, die nur eine ben√∂tigen.

#### Servicekontenimitation <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Die Imitation eines Dienstkontos kann sehr n√ºtzlich sein, um **neue und bessere Privilegien zu erlangen**. Es gibt drei M√∂glichkeiten, auf die Sie ein anderes Dienstkonto [imitieren k√∂nnen](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account):

* Authentifizierung **mit RSA-Privatschl√ºsseln** (oben behandelt)
* Autorisierung **unter Verwendung von Cloud IAM-Richtlinien** (hier behandelt)
* **Bereitstellen von Jobs auf GCP-Diensten** (eher anwendbar auf die Kompromittierung eines Benutzerkontos)

### `iam.serviceAccounts.getOpenIdToken`

Ein Angreifer mit den genannten Berechtigungen kann ein OpenID JWT generieren. Diese werden verwendet, um Identit√§t zu best√§tigen und tragen nicht unbedingt eine implizite Autorisierung gegen√ºber einer Ressource.

Laut diesem [**interessanten Beitrag**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b) ist es notwendig, das Publikum anzugeben (Dienst, f√ºr den Sie das Token verwenden m√∂chten, um sich zu authentifizieren), und Sie erhalten ein von Google signiertes JWT, das das Dienstkonto und das Publikum des JWT angibt.

Sie k√∂nnen ein OpenIDToken generieren (wenn Sie Zugriff haben) mit:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
Dann k√∂nnen Sie es einfach verwenden, um auf den Dienst zuzugreifen:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Einige Dienste, die die Authentifizierung √ºber diese Art von Tokens unterst√ºtzen, sind:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (bei Verwendung von Google OIDC)

Ein Beispiel, wie man im Namen eines Dienstkontos ein OpenID-Token erstellt, finden Sie [**hier**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## Referenzen

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
