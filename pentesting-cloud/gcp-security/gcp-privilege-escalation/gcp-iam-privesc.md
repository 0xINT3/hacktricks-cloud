# GCP - IAM рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks_live**](https://twitter.com/hacktricks_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## IAM

IAM рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкрд╛рдПрдВ:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдПрдХ рднреВрдорд┐рдХрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдЧреА рдФрд░ рд╡рд╣ рдЖрдкрдХреЛ рдЕрдиреНрдп рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рд╡рд▓реНрдирд░рдмрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдХрд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд░реНрдорд╛рдг, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [рдпрд╣рд╛рдБ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py) рдорд┐рд▓реЗрдЧрд╛ред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [рдореВрд▓ рд╢реЛрдз](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рджреЗрдЦреЗрдВред

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА** рд╕реНрд╡реАрдХреГрддрд┐ рд╣реЛрдЧреА, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╣рдорд╛рд░реЗ рд╕реЗ рдЕрдзрд┐рдХ рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓рд╛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рд╡рд▓реНрдирд░рдмрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдХрд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд░реНрдорд╛рдг, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ [рдпрд╣рд╛рдБ](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [рдпрд╣рд╛рдБ](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py) рдорд┐рд▓реЗрдЧрд╛ред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [рдореВрд▓ рд╢реЛрдз](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рджреЗрдЦреЗрдВред

### `iam.serviceAccountKeys.create`

рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдмрдВрдзрд┐рдд рдХреБрдВрдЬреА рдмрдирд╛рдиреЗ** рдХреА рд╕реНрд╡реАрдХреГрддрд┐ рд╣реЛрдЧреА, рдЬрд┐рд╕рд╕реЗ рд╣рдореЗрдВ рдЙрд╕ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд░реВрдк рдореЗрдВ GCP рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрдЧреАред
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рд╡рд▓реНрдирд░реЗрдмрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдХреА [**рд╕реГрдЬрди, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**рдпрд╣рд╛рдБ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py) рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рджреЗрдЦреЗрдВред

рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ **`iam.serviceAccountKeys.update` рдХреБрдВрдЬреА рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛** рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐рдпрд╛рдБ `iam.serviceAccountKeys.create` рднреА рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВред

### `iam.serviceAccounts.implicitDelegation`

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдкрд░ **`iam.serviceAccounts.getAccessToken`** рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓реЗ рддреАрд╕рд░реЗ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдкрд░ **`iam.serviceAccounts.implicitDelegation`** рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЖрдк implicitDelegation рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдЙрд╕ рддреАрд╕рд░реЗ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЛрдХрди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред рдпрд╣рд╛рдБ рдПрдХ рдЖрд░реЗрдЦ рд╣реИ рдЬреЛ рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░реЗрдЧрд╛ред

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рд╡рд▓реНрдирд░реЗрдмрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдХреА [**рд╕реГрдЬрди, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**рдпрд╣рд╛рдБ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py) рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рджреЗрдЦреЗрдВред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг**](https://cloud.google.com/iam/docs/understanding-service-accounts) рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдзрдирд╛рджрд╛рди рдХреЗрд╡рд▓ рдПрдХ рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЬреЛ [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред

### `iam.serviceAccounts.signBlob`

рдЙрд▓реНрд▓рдВрдШрдирдХрд░реНрддрд╛ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рд╡рд╣ **GCP рдореЗрдВ рд╡рд┐рдЪрд┐рддреНрд░ payloads рдХреЗ рд╕рд╛рдЗрди рдХрд░ рд╕рдХреЗрдЧрд╛**ред рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдХрд┐ рдПрдХ рдЕрд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП JWT рдХреЛ рдмрдирд╛рдпрд╛ рдЬрд╛рдП рдФрд░ рдлрд┐рд░ рд╣рдо рдЙрд╕реЗ рдЙрд╕ SA рджреНрд╡рд╛рд░рд╛ рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмреНрд▓реЙрдм рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬреЗрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдпрд╣ рдкрдврд╝реЗрдВ**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed)ред

рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рд╡рд▓реНрдирд░реЗрдмрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдХреА [**рд╕реГрдЬрди, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**рдпрд╣рд╛рдБ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) рдФрд░ [**рдпрд╣рд╛рдБ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py) рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рджреЗрдЦреЗрдВред

### `iam.serviceAccounts.signJwt`

рдЙрд▓реНрд▓рдВрдШрдирдХрд░реНрддрд╛ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рд╡рд╣ **рд╡реЗрд▓-рдлреЙрд░реНрдореЗрдб JSON рд╡реЗрдм рдЯреЛрдХрди (JWTs) рдХреЛ рд╕рд╛рдЗрди рдХрд░ рд╕рдХреЗрдЧрд╛**ред рдкрд┐рдЫрд▓реА рд╡рд┐рдзрд┐ рдХреЗ рд╕рд╛рде рдЕрдВрддрд░ рдпрд╣ рд╣реИ рдХрд┐ **рдЬрдм google рдХреЛ рдПрдХ JWT рд╡рд╛рд▓рд╛ рдмреНрд▓реЙрдм рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ рдмрдирд╛рдирд╛ рд╣реЛрддрд╛ рд╣реИ, рд╣рдо signJWT рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ JWT рдХреА рдЙрдореНрдореАрдж рдХрд░рддрд╛ рд╣реИ**ред рдЗрд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЖрд╕рд╛рди рдмрдирд╛рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдЖрдк рдХреЗрд╡рд▓ JWT рд╕рд╛рдЗрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдмрд╛рдЗрдЯреНрд╕ рдХреА рдмрдЬрд╛рдпред

рдЖрдк рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рд╡рд▓реНрдирд░реЗрдмрд▓ рд╡рд╛рддрд╛рд╡рд░рдг рдХреА [**рд╕реГрдЬрди, рд╢реЛрд╖рдг рдФрд░ рд╕рдлрд╛рдИ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ [**рдпрд╣рд╛рдБ**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py) рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд╢реЛрдз**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) рджреЗрдЦреЗрдВред

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

рдЙрд▓реНрд▓рдВрдШрдирдХрд░реНрддрд╛ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рд╡рд╣ **рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдореЗрдВ IAM рдиреАрддрд┐рдпреЛрдВ рдХреЛ рдЬреЛрдбрд╝ рд╕рдХреЗрдЧрд╛**ред рдЖрдк рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЦреБрдж рдХреЛ **рдЙрд╕ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рджрд╛рди** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рдирдХреА рдЖрдкрдХреЛ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╣рдо рдЦреБрдж рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП `roles/iam.serviceAccountTokenCreator` рднреВрдорд┐рдХрд╛ рдХреЗ рдЙрддреНрдХреГрд╖реНрдЯ SA рдкрд░ рджреЗ рд░рд╣реЗ рд╣реИрдВ:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
### `iam.serviceAccounts.actAs`

**iam.serviceAccounts.actAs рдЕрдиреБрдорддрд┐** **AWS рдХреА iam:PassRole рдЕрдиреБрдорддрд┐ рдХреА рддрд░рд╣** рд╣реИред рдпрд╣ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрддреНрдпрд╛рд╡рд╢реНрдпрдХ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдХрдореНрдкреНрдпреВрдЯ рдЗрдВрдЬрди рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЖрд░рдВрдн рдХрд░рдирд╛, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ "рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ рдХреА" рдПрдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХреЗ рд░реВрдк рдореЗрдВ "рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ" рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЕрдиреБрдорддрд┐ рдкреНрд░рдмрдВрдзрди рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИред рдЗрд╕рдХреЗ рдмрд┐рдирд╛, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЕрдиреБрдЪрд┐рдд рдкрд╣реБрдВрдЪ рдорд┐рд▓ рд╕рдХрддреА рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **iam.serviceAccounts.actAs** рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдирд╛ рд╡рд┐рднрд┐рдиреНрди рд╡рд┐рдзрд┐рдпреЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЬреЛ рдПрдХ рд╣реА рдЪрд╛рд╣рддреЗ рд╣реИрдВред

#### рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ <a href="#service-account-impersonation" id="service-account-impersonation"></a>

рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рдирд╛ рдирдП рдФрд░ рдмреЗрд╣рддрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдЖрдк рдПрдХ рдФрд░ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ [рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account) рдЗрд╕рдореЗрдВ рддреАрди рддрд░реАрдХреЗ рд╣реИрдВ:

* RSA рдирд┐рдЬреА рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (рдКрдкрд░ рдЪрд░реНрдЪрд┐рдд)
* Cloud IAM рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдзрд┐рдХреГрддрд┐ (рдпрд╣рд╛рдБ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рд╣реИ)
* GCP рд╕реЗрд╡рд╛рдУрдВ рдкрд░ рдиреМрдХрд░рд┐рдпрд╛рдВ рдбрд┐рдкреНрд▓реЙрдп рдХрд░рдирд╛ (рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рдХреЗ рдХрдореНрдкреНрд░рдорд╛рдЗрдЬ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рд▓рд╛рдЧреВ)

### `iam.serviceAccounts.getOpenIdToken`

рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдУрдкрдирдЖрдИрдбреА рдЬреЗрдбрдбрдмреНрд▓реНрдпреВрдЯреА рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХреЗрдЧрд╛ред рдпреЗ рдкрд╣рдЪрд╛рди рдХреЛ рджрд╛рд╡рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдХрд┐рд╕реА рд╕рдВрд╕рд╛рдзрди рдХреЗ рдЦрд┐рд▓рд╛рдл рдХреЛрдИ рд╢рд░реНрддрдореБрдХреНрдд рдЕрдзрд┐рдХреГрддрд┐ рдирд╣реАрдВ рд▓реЗрддреЗред

рдЗрд╕ [**рд░реЛрдЪрдХ рдкреЛрд╕реНрдЯ**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b) рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдПрдбрд┐рдпрдВрд╕ (рд╕реЗрд╡рд╛ рдЬрд╣рд╛рдВ рдЖрдк рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдкреНрд░рдорд╛рдгреАрдХреГрдд рдХрд░ рд╕рдХреЗрдВ) рдХреЛ рд╕реВрдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рдФрд░ рдЖрдкрдХреЛ рдЧреВрдЧрд▓ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдЬреЗрдбрдбрдмреНрд▓реНрдпреВрдЯреА рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдФрд░ рдЬреЗрдбрдЯреА рдХрд╛ рдПрдбрд┐рдпрдВрд╕ рджрд┐рдЦрд╛рддрд╛ рд╣реИред

рдЖрдк рдПрдХ рдУрдкрдирдЖрдИрдбреАрдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдкрд╣реБрдВрдЪ рд╣реИ) рдХреЗ рд╕рд╛рде:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
рдлрд┐рд░ рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реЗрд╡рд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
рдХреБрдЫ рд╕реЗрд╡рд╛рдПрдВ рдЬреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рдЯреЛрдХрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреА рд╣реИрдВ:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (рдпрджрд┐ Google OIDC рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ)

рдЖрдк рдПрдХ рдЙрджрд╛рд╣рд░рдг рдпрд╣рд╛рдБ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХреЗ рдкрдХреНрд╖ рд╕реЗ рдУрдкрдирдЖрдИрдбреА рдЯреЛрдХрди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреИрд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ [**рдпрд╣рд╛рдБ**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## рд╕рдВрджрд░реНрдн

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХреЛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks_live**](https://twitter.com/hacktricks_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдХреЛ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
