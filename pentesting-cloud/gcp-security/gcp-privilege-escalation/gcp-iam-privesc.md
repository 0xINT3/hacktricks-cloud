# GCP - IAM Yetkilendirme Yükseltme

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünleri**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* Hacking hilelerinizi **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek paylaşın.

</details>

## IAM

IAM hakkında daha fazla bilgi için:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

Bahsedilen izinlere sahip bir saldırgan, size atanan bir rolü güncelleyebilir ve size diğer kaynaklara ek izinler verebilir, örneğin:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
İşte **burada** bir zayıf ortamın oluşturulması, istismar edilmesi ve temizlenmesini otomatikleştiren bir betik bulabilirsiniz ve bu ayrıcalığı kötüye kullanmak için bir python betiği [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py) bulunmaktadır. Daha fazla bilgi için [**orijinal araştırmayı**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) kontrol edin.

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Bahsedilen izinlere sahip bir saldırgan, bir Hizmet Hesabına ait bir erişim belirteci **isteyebilecektir**, bu nedenle kendi ayrıcalıklarımızdan daha fazla ayrıcalığa sahip bir Hizmet Hesabının erişim belirtecisini istemek mümkündür.

İşte [**burada**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) bir zayıf ortamın oluşturulması, istismar edilmesi ve temizlenmesini otomatikleştiren bir betik bulabilirsiniz ve bu ayrıcalığı kötüye kullanmak için bir python betiği [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py) bulunmaktadır. Daha fazla bilgi için [**orijinal araştırmayı**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) kontrol edin.

### `iam.serviceAccountKeys.create`

Bahsedilen izinlere sahip bir saldırgan, bir Hizmet Hesabı için **kullanıcı tarafından yönetilen bir anahtar oluşturabilecektir**, bu da bize o Hizmet Hesabı olarak GCP'ye erişim sağlayacaktır.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
[**Burada**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) otomatikleştirmek için bir betik bulabilirsiniz. Bir zafiyetli ortam oluşturmak, sömürmek ve temizlemek için bir betik ve bu ayrıcalığı kötüye kullanmak için bir python betiği [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py) bulunabilir. Daha fazla bilgi için [**orijinal araştırmayı**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) kontrol edin.

**`iam.serviceAccountKeys.update`** bir SA'nın anahtarını değiştirmek için çalışmayacaktır çünkü bunu yapmak için **`iam.serviceAccountKeys.create`** izinlerine de ihtiyaç vardır.

### `iam.serviceAccounts.implicitDelegation`

Eğer **`iam.serviceAccounts.getAccessToken`** izni olan bir Servis Hesabı üzerinde **`iam.serviceAccounts.implicitDelegation`** iznine sahipseniz, o zaman implicitDelegation kullanarak **o üçüncü Servis Hesabı için bir belirteç oluşturabilirsiniz**. İşte bunu açıklamaya yardımcı olacak bir diyagram.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

[**Burada**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) otomatikleştirmek için bir betik bulabilirsiniz. Bu ayrıcalığı kötüye kullanmak için bir python betiği [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py) bulunabilir. Daha fazla bilgi için [**orijinal araştırmayı**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) kontrol edin.

Not olarak, [**belgelendirmeye**](https://cloud.google.com/iam/docs/understanding-service-accounts) göre, yetkilendirme yalnızca [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) yöntemini kullanarak bir belirteç oluşturmak için çalışır.

### `iam.serviceAccounts.signBlob`

Bahsedilen izinlere sahip bir saldırgan, GCP'de **keyfi yükleri imzalayabilecektir**. Bu nedenle, hedeflediğimiz SA tarafından imzalanmış bir JWT almak için, SA'nın imzasız bir JWT'sini oluşturup bunu bir blob olarak göndermek mümkün olacaktır. Daha fazla bilgi için [**burayı okuyun**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

[**Burada**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) otomatikleştirmek için bir betik bulabilirsiniz. Bu ayrıcalığı kötüye kullanmak için bir python betiği [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) ve [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py) bulunabilir. Daha fazla bilgi için [**orijinal araştırmayı**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) kontrol edin.

### `iam.serviceAccounts.signJwt`

Bahsedilen izinlere sahip bir saldırgan, **düzgün biçimlendirilmiş JSON web token (JWT)**'leri imzalayabilecektir. Önceki yöntemle farkı, **Google'ın bir JWT içeren bir blobu imzalamasını beklemek yerine, zaten bir JWT bekleyen signJWT yöntemini kullanmamızdır**. Bu kullanımı daha kolay hale getirir, ancak herhangi bir bayt yerine yalnızca JWT imzalayabilirsiniz.

[**Burada**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) otomatikleştirmek için bir betik bulabilirsiniz. Bu ayrıcalığı kötüye kullanmak için bir python betiği [**burada**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py) bulunabilir. Daha fazla bilgi için [**orijinal araştırmayı**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/) kontrol edin.

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Bahsedilen izinlere sahip bir saldırgan, servis hesaplarına **IAM politikaları ekleyebilecektir**. Bu, servis hesabını taklit etmek için ihtiyaç duyduğunuz izinleri kendinize **vermek** için kullanılabilir. Aşağıdaki örnekte, ilgili SA üzerinde `roles/iam.serviceAccountTokenCreator` rolünü kendimize veriyoruz.
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
[**Burada**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**, bir zafiyet ortamının oluşturulması, sömürülmesi ve temizlenmesini otomatikleştiren bir betik bulabilirsiniz.**

### `iam.serviceAccounts.actAs`

**iam.serviceAccounts.actAs izni**, AWS'deki **iam:PassRole izni** gibi bir izindir. Güvenli izin yönetimini sağlamak için bir Hizmet Hesabı olarak "actAs" yeteneğini vererek, bir Hesap Makinesi örneği başlatma gibi görevleri gerçekleştirmek için önemlidir. Bu olmadan, kullanıcılar haksız erişim elde edebilirler. Ayrıca, **iam.serviceAccounts.actAs**'ın sömürülmesi, sadece bir tane gerektiren diğer yöntemlerle karşılaştırıldığında, her biri bir dizi izin gerektiren çeşitli yöntemleri içerir.

#### Hizmet hesabı taklit etme <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Bir hizmet hesabını taklit etmek, **yeni ve daha iyi ayrıcalıklar elde etmek** için çok faydalı olabilir. Başka bir hizmet hesabını [taklit etmek için üç yol](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account) vardır:

* RSA özel anahtarları kullanarak kimlik doğrulama (yukarıda açıklanan)
* Cloud IAM politikalarını kullanarak yetkilendirme (burada açıklanan)
* GCP hizmetlerinde işlerin dağıtılması (bir kullanıcı hesabının tehlikeye atılmasıyla daha ilgili)

### `iam.serviceAccounts.getOpenIdToken`

Bahsedilen izinlere sahip bir saldırgan, bir OpenID JWT'si oluşturabilir. Bunlar, kimliği doğrulamak için kullanılır ve herhangi bir kaynağa karşı herhangi bir örtük yetkilendirme taşımazlar.

Bu [**ilginç yazıya**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b) göre, kimlik doğrulamak için tokenı kullanmak istediğiniz hizmeti (hizmet hesabı ve JWT'nin hedef kitlesi) belirtmeniz gerekmektedir.

Erişiminiz varsa, bir OpenIDToken oluşturabilirsiniz:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
Sonra bunu kullanarak hizmete erişebilirsiniz:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Bu tür belirteçler aracılığıyla kimlik doğrulamasını destekleyen bazı hizmetler şunlardır:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (Google OIDC kullanılıyorsa)

Bir hizmet hesabı adına bir OpenID belirteci oluşturma örneğini [**burada**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py) bulabilirsiniz.

## Referanslar

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>
