# GCP - Ukarabati wa IAM

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## IAM

Pata habari zaidi kuhusu IAM katika:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

### `iam.roles.update` (`iam.roles.get`)

Mshambuliaji mwenye ruhusa zilizotajwa ataweza kusasisha jukumu lililopewa wewe na kukupa ruhusa za ziada kwa rasilimali zingine kama:
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
Unaweza kupata script ya kiotomatiki ya **kuunda, kutumia, na kusafisha mazingira ya udhaifu hapa** na script ya python ya kutumia haki hii [**hapa**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). Kwa maelezo zaidi angalia [**utafiti wa awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Mshambuliaji mwenye ruhusa zilizotajwa ataweza **kuomba tokeni ya ufikiaji inayomilikiwa na Akaunti ya Huduma**, hivyo niwezekana kuomba tokeni ya ufikiaji wa Akaunti ya Huduma yenye ruhusa zaidi kuliko yetu.

Unaweza kupata script ya kiotomatiki ya [**kuunda, kutumia, na kusafisha mazingira ya udhaifu hapa**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh) na script ya python ya kutumia haki hii [**hapa**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Kwa maelezo zaidi angalia [**utafiti wa awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Mshambuliaji mwenye ruhusa zilizotajwa ataweza **kuunda funguo inayosimamiwa na mtumiaji kwa Akaunti ya Huduma**, ambayo itaturuhusu kupata GCP kama Akaunti hiyo ya Huduma.
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
Unaweza kupata script ya kiotomatiki ya [**kuunda, kutumia na kusafisha mazingira ya udhaifu hapa**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh) na script ya python ya kutumia uwezo huu [**hapa**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Kwa maelezo zaidi angalia [**utafiti wa awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Tafadhali kumbuka kwamba **`iam.serviceAccountKeys.update` haitafanya kazi kurekebisha funguo** ya SA kwa sababu ili kufanya hivyo, idhini ya `iam.serviceAccountKeys.create` inahitajika pia.

### `iam.serviceAccounts.implicitDelegation`

Ikiwa una idhini ya **`iam.serviceAccounts.implicitDelegation`** kwenye Akaunti ya Huduma ambayo ina idhini ya **`iam.serviceAccounts.getAccessToken`** kwenye Akaunti ya Huduma ya tatu, basi unaweza kutumia implicitDelegation kwa **kuunda token kwa Akaunti ya Huduma ya tatu**. Hapa kuna mchoro wa kusaidia kueleza.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Unaweza kupata script ya kiotomatiki ya [**kuunda, kutumia na kusafisha mazingira ya udhaifu hapa**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh) na script ya python ya kutumia uwezo huu [**hapa**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py). Kwa maelezo zaidi angalia [**utafiti wa awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Tafadhali kumbuka kwamba kulingana na [**nyaraka**](https://cloud.google.com/iam/docs/understanding-service-accounts), upelekaji hufanya kazi tu kuzalisha token kwa kutumia [**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken) njia.

### `iam.serviceAccounts.signBlob`

Mshambuliaji mwenye idhini zilizotajwa ataweza **kutilia saini maudhui ya kubahatisha kwenye GCP**. Kwa hivyo itakuwa inawezekana **kuunda JWT isiyosaini ya SA na kisha kuituma kama blob ili kupata JWT iliyosainiwa** na SA tunayolenga. Kwa maelezo zaidi [**soma hii**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed).

Unaweza kupata script ya kiotomatiki ya [**kuunda, kutumia na kusafisha mazingira ya udhaifu hapa**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh) na script ya python ya kutumia uwezo huu [**hapa**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py) na [**hapa**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py). Kwa maelezo zaidi angalia [**utafiti wa awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.signJwt`

Mshambuliaji mwenye idhini zilizotajwa ataweza **kutilia saini JWT zenye muundo mzuri (JWTs)**. Tofauti na njia iliyopita ni kwamba **badala ya kufanya google isaini blob inayohusisha JWT, tunatumia njia ya signJWT ambayo tayari inatarajia JWT**. Hii inafanya iwe rahisi kutumia lakini unaweza kusaini JWT badala ya herufi yoyote.

Unaweza kupata script ya kiotomatiki ya [**kuunda, kutumia na kusafisha mazingira ya udhaifu hapa**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh) na script ya python ya kutumia uwezo huu [**hapa**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py). Kwa maelezo zaidi angalia [**utafiti wa awali**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

Mshambuliaji mwenye idhini zilizotajwa ataweza **kuongeza sera za IAM kwa akaunti za huduma**. Unaweza kutumia hii kwa **kujipatia** idhini unazohitaji kujifanya kuwa akaunti ya huduma. Katika mfano ufuatao tunajipatia jukumu la `roles/iam.serviceAccountTokenCreator` juu ya SA inayovutia:
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
Unaweza kupata script ya kiotomatiki [**kuunda, kutumia, na kusafisha mazingira ya udhaifu hapa**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)**.**

### `iam.serviceAccounts.actAs`

**Ruhusa ya iam.serviceAccounts.actAs** ni kama **ruhusa ya iam:PassRole kutoka AWS**. Ni muhimu kwa kutekeleza kazi, kama kuanzisha kifaa cha Compute Engine, kwani inatoa uwezo wa "kutenda kama" Akaunti ya Huduma, ikisimamia ruhusa salama. Bila hii, watumiaji wanaweza kupata ufikivu usiofaa. Aidha, kutumia **iam.serviceAccounts.actAs** kunahusisha njia mbalimbali, kila moja ikihitaji seti ya ruhusa, tofauti na njia nyingine ambazo zinahitaji moja tu.

#### Uigaji wa akaunti ya huduma <a href="#service-account-impersonation" id="service-account-impersonation"></a>

Kuiga akaunti ya huduma inaweza kuwa na manufaa sana kwa **kupata mamlaka mpya na bora**. Kuna njia tatu ambazo unaweza [kuiga akaunti nyingine ya huduma](https://cloud.google.com/iam/docs/understanding-service-accounts#impersonating\_a\_service\_account):

* Uthibitisho **kwa kutumia funguo za siri za RSA** (zilizojadiliwa hapo juu)
* Idhini **kwa kutumia sera za Cloud IAM** (zilizojadiliwa hapa)
* **Kutekeleza kazi kwenye huduma za GCP** (inayofaa zaidi kwa kudhoofisha akaunti ya mtumiaji)

### `iam.serviceAccounts.getOpenIdToken`

Mshambuliaji mwenye ruhusa zilizotajwa ataweza kuzalisha OpenID JWT. Hizi hutumiwa kuthibitisha utambulisho na hazina lazima kubeba idhini ya dhahiri dhidi ya rasilimali.

Kulingana na [**chapisho hili la kuvutia**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b), ni muhimu kuonyesha hadhira (huduma ambapo unataka kutumia tokeni kuthibitisha) na utapokea JWT iliyosainiwa na google ikionyesha akaunti ya huduma na hadhira ya JWT.

Unaweza kuzalisha OpenIDToken (ikiwa una ufikivu) na:
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
Kisha unaweza kutumia hiyo kufikia huduma na:
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
Baadhi ya huduma zinazounga mkono uthibitisho kupitia aina hii ya vitufe ni:

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (ikiwa inatumia Google OIDC)

Unaweza kupata mfano wa jinsi ya kuunda na kutumia kibali cha OpenID kwa niaba ya akaunti ya huduma [**hapa**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py).

## Marejeo

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka mwanzo hadi kuwa shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
