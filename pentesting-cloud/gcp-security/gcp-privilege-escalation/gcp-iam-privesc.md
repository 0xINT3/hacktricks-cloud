# GCP - IAM Privesc

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## IAM

### `iam.roles.update` (`iam.roles.get`)

Se voc√™ tiver as permiss√µes mencionadas, poder√° atualizar uma fun√ß√£o atribu√≠da a voc√™ e dar a si mesmo permiss√µes extras para outros recursos, como:

```bash
gcloud iam roles update <nome da fun√ß√£o> --project <projeto> --add-permissions <permiss√£o>
```

Voc√™ pode encontrar um script para automatizar a **cria√ß√£o, explora√ß√£o e limpeza de um ambiente vulner√°vel aqui** e um script em Python para abusar desse privil√©gio [**aqui**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py). Para mais informa√ß√µes, confira a [**pesquisa original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

Essa permiss√£o permite **solicitar um token de acesso que pertence a uma Conta de Servi√ßo**, portanto, √© poss√≠vel solicitar um token de acesso de uma Conta de Servi√ßo com mais privil√©gios do que os nossos.

Voc√™ pode encontrar um script para automatizar a **cria√ß√£o, explora√ß√£o e limpeza de um ambiente vulner√°vel aqui** e um script em Python para abusar desse privil√©gio [**aqui**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py). Para mais informa√ß√µes, confira a [**pesquisa original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

### `iam.serviceAccountKeys.create`

Essa permiss√£o nos permite fazer algo semelhante ao m√©todo anterior, mas em vez de um token de acesso, estamos **criando uma chave gerenciada pelo usu√°rio para uma Conta de Servi√ßo**, o que nos permitir√° acessar o GCP como essa Conta de Servi√ßo.

```bash
gcloud iam service-accounts keys create --iam-account <nome> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```

Voc√™ pode encontrar um script para automatizar a **cria√ß√£o, explora√ß√£o e limpeza de um ambiente vulner√°vel aqui** e um script em Python para abusar desse privil√©gio [**aqui**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py). Para mais informa√ß√µes, confira a [**pesquisa original**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/).

Observe que **`iam.serviceAccountKeys.update` n√£o funcionar√° para modificar a chave** de uma Conta de Servi√ßo, porque para fazer isso, tamb√©m √© necess√°ria a permiss√£o `iam.serviceAccountKeys.create`.

### `iam.serviceAccounts.implicitDelegation`

Se voc√™ tiver a permiss√£o **`iam.serviceAccounts.implicitDelegation`** em uma Conta de Servi√ßo que tem a permiss√£o **`iam.serviceAccounts.getAccessToken`** em uma terceira Conta de Servi√ßo, poder√° usar a implicitDelegation para **criar um token para essa terceira Conta de Servi√ßo**. Aqui est√° um diagrama para ajudar a explicar.

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

Voc√™ pode encontrar um script para automatizar