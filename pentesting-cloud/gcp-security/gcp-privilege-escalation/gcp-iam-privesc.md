# GCP - IAM Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## IAM

### `iam.roles.update` (`iam.roles.get`)

上記の権限を持っている場合、自分に割り当てられた役割を更新し、他のリソースへの追加の権限を自分に与えることができます。例えば：
```bash
gcloud iam roles update <rol name> --project <project> --add-permissions <permission>
```
以下のスクリプトは、**脆弱な環境の作成、悪用、およびクリーニングを自動化するためのものです**。この特権を悪用するためのPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.roles.update.py)にあります。詳細については、[**元の研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

### `iam.serviceAccounts.getAccessToken` (`iam.serviceAccounts.get`)

この権限により、**サービスアカウントに属するアクセストークンを要求することができます**。つまり、自分の権限よりも高い権限を持つサービスアカウントのアクセストークンを要求することが可能です。

脆弱な環境の[**作成、悪用、およびクリーニングを自動化するスクリプトはこちら**](https://github.com/carlospolop/gcp\_privesc\_scripts/blob/main/tests/4-iam.serviceAccounts.getAccessToken.sh)にあります。この特権を悪用するためのPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getAccessToken.py)にあります。詳細については、[**元の研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

### `iam.serviceAccountKeys.create`

この権限により、前述の方法と似ていますが、アクセストークンの代わりに**サービスアカウント用のユーザー管理キーを作成**します。これにより、そのサービスアカウントとしてGCPにアクセスすることができます。
```bash
gcloud iam service-accounts keys create --iam-account <name> /tmp/key.json

gcloud auth activate-service-account --key-file=sa_cred.json
```
以下は、脆弱な環境の**作成、悪用、およびクリーニングを自動化するスクリプト**です。[**こちら**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/3-iam.serviceAccountKeys.create.sh)にスクリプトがあり、この権限を悪用するPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccountKeys.create.py)です。詳細については、[**元の研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

**`iam.serviceAccountKeys.update`** はSAのキーを変更するためには機能しないことに注意してください。そのためには `iam.serviceAccountKeys.create` 権限も必要です。

### `iam.serviceAccounts.implicitDelegation`

**`iam.serviceAccounts.implicitDelegation`** 権限を持つサービスアカウントが第三のサービスアカウントに対して **`iam.serviceAccounts.getAccessToken`** 権限を持っている場合、implicitDelegationを使用して**その第三のサービスアカウントのためのトークンを作成**することができます。以下の図を参照してください。

![](https://rhinosecuritylabs.com/wp-content/uploads/2020/04/image2-500x493.png)

脆弱な環境の**作成、悪用、およびクリーニングを自動化するスクリプト**は[**こちら**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/5-iam.serviceAccounts.implicitDelegation.sh)にあり、この権限を悪用するPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py)です。詳細については、[**元の研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

[**ドキュメント**](https://cloud.google.com/iam/docs/understanding-service-accounts)によると、委任は[**generateAccessToken()**](https://cloud.google.com/iam/credentials/reference/rest/v1/projects.serviceAccounts/generateAccessToken)メソッドを使用してトークンを生成するためにのみ機能することに注意してください。

### `iam.serviceAccounts.signBlob`

**`iam.serviceAccounts.signBlob`** 権限はGCPで「任意のペイロードの署名を許可する」ことを意味します。これは、SAの未署名JWTを作成し、それをblobとして送信して、ターゲットとするSAによってJWTが署名されるようにすることができることを意味します。詳細については[**こちらを読んでください**](https://medium.com/google-cloud/using-serviceaccountactor-iam-role-for-account-impersonation-on-google-cloud-platform-a9e7118480ed)。

脆弱な環境の**作成、悪用、およびクリーニングを自動化するスクリプト**は[**こちら**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/6-iam.serviceAccounts.signBlob.sh)にあり、この権限を悪用するPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-accessToken.py)と[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signBlob-gcsSignedUrl.py)です。詳細については、[**元の研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

### `iam.serviceAccounts.signJwt`

前の方法が任意のペイロードを署名することによって機能したのと同様に、この方法は整形されたJSONウェブトークン（JWT）を署名することによって機能します。前の方法との違いは、**JWTを含むblobをGoogleに署名させる代わりに、JWTを期待するsignJWTメソッドを使用することです**。これにより使用が容易になりますが、任意のバイトではなくJWTのみを署名できます。

脆弱な環境の**作成、悪用、およびクリーニングを自動化するスクリプト**は[**こちら**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/7-iam.serviceAccounts.signJWT.sh)にあり、この権限を悪用するPythonスクリプトは[**こちら**](https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py)です。詳細については、[**元の研究**](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)を確認してください。

### `iam.serviceAccounts.setIamPolicy` <a href="#iam.serviceaccounts.setiampolicy" id="iam.serviceaccounts.setiampolicy"></a>

この権限により、**サービスアカウントにIAMポリシーを追加**することができます。それを悪用して、サービスアカウントを偽装するために必要な権限を**自分自身に付与**することができます。以下の例では、興味深いSAに対して `roles/iam.serviceAccountTokenCreator` ロールを自分自身に付与しています：
```bash
gcloud iam service-accounts add-iam-policy-binding "${VICTIM_SA}@${PROJECT_ID}.iam.gserviceaccount.com" \
--member="user:username@domain.com" \
--role="roles/iam.serviceAccountTokenCreator"
```
以下のスクリプトは、脆弱な環境の**作成、悪用、およびクリーニングを自動化するためのものです**。[**こちら**](https://github.com/carlospolop/gcp_privesc_scripts/blob/main/tests/d-iam.serviceAccounts.setIamPolicy.sh)。

### `iam.serviceAccounts.actAs`

これは、特定のリソースを作成する際に、呼び出しが成功するためにはService Accountとして「actAs」する必要があることを意味します。例えば、Service Accountを添付して新しいCompute Engineインスタンスを起動する場合、そのService Accountに対して**`iam.serviceAccounts.actAs`**が必要です。この権限がないと、ユーザーはより少ない権限で権限をエスカレーションすることができてしまいます。

**複数の個別のメソッドが\_iam.serviceAccounts.actAs**\_**を使用しているので、あなた自身の権限に応じて、以下のメソッドのうち1つ（または複数）のみを悪用できるかもしれません**。これらのメソッドは、以前のメソッドのように単一の権限ではなく、**悪用するために複数の権限が必要**という点で少し異なります。

### `iam.serviceAccounts.getOpenIdToken`

この権限は、OpenID JWTを生成するために使用できます。これらは身元を主張するために使用され、リソースに対する暗黙の承認を必ずしも伴いません。

この[**興味深い投稿**](https://medium.com/google-cloud/authenticating-using-google-openid-connect-tokens-e7675051213b)によると、トークンを使用して認証したいサービス（audience）を指定する必要があり、Googleによって署名されたJWTを受け取り、そのJWTのService Accountとaudienceが示されます。

アクセス権があれば、OpenIDTokenを生成できます。
```bash
# First activate the SA with iam.serviceAccounts.getOpenIdToken over the other SA
gcloud auth activate-service-account --key-file=/path/to/svc_account.json
# Then, generate token
gcloud auth print-identity-token "${ATTACK_SA}@${PROJECT_ID}.iam.gserviceaccount.com" --audiences=https://example.com
```
その後、以下を使用してサービスにアクセスできます：
```bash
curl -v -H "Authorization: Bearer id_token" https://some-cloud-run-uc.a.run.app
```
以下のサービスは、この種のトークンを介した認証をサポートしています：

* [Google Cloud Run](https://cloud.google.com/run/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs/)
* [Google Identity Aware Proxy](https://cloud.google.com/iap/docs/authentication-howto)
* [Google Cloud Endpoints](https://cloud.google.com/endpoints/docs/openapi/authenticating-users-google-id) (Google OIDCを使用する場合)

サービスアカウントを代わってOpenIDトークンを作成する例は[**こちら**](https://github.com/carlospolop-forks/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.getOpenIdToken.py)で見つけることができます。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
