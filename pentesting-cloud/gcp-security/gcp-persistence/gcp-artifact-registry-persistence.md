# GCP - Persist√™ncia do Registro de Artefatos

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Registro de Artefatos

Para mais informa√ß√µes sobre o Registro de Artefatos, confira:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### Confus√£o de Depend√™ncia

* O que acontece se um **reposit√≥rio remoto e padr√£o** s√£o **misturados em um virtual** e um pacote existe em ambos?
* O que tiver a **prioridade mais alta definida no reposit√≥rio virtual** √© usado
* Se a **prioridade for a mesma**:
* Se a **vers√£o** for a **mesma**, o **nome da pol√≠tica em ordem alfab√©tica** primeiro no reposit√≥rio virtual √© usado
* Caso contr√°rio, a **vers√£o mais alta** √© usada

{% hint style="danger" %}
Portanto, √© poss√≠vel **abusar de uma vers√£o mais alta (confus√£o de depend√™ncia)** em um registro de pacotes p√∫blico se o reposit√≥rio remoto tiver uma prioridade maior ou igual
{% endhint %}

Essa t√©cnica pode ser √∫til para **persist√™ncia** e **acesso n√£o autenticado** pois para abusar dela basta **conhecer o nome de uma biblioteca** armazenada no Registro de Artefatos e **criar essa mesma biblioteca no reposit√≥rio p√∫blico (PyPi, por exemplo)** com uma vers√£o mais alta.

Para persist√™ncia, siga estas etapas:

* **Requisitos**: Um **reposit√≥rio virtual** deve **existir** e ser usado, um **pacote interno** com um **nome** que n√£o existe no **reposit√≥rio p√∫blico** deve ser usado.
* Crie um reposit√≥rio remoto se ele n√£o existir
* Adicione o reposit√≥rio remoto ao reposit√≥rio virtual
* Edite as pol√≠ticas do registro virtual para dar uma prioridade mais alta (ou igual) ao reposit√≥rio remoto.\
Execute algo como:
* [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
* Baixe o pacote leg√≠timo, adicione seu c√≥digo malicioso e registre-o no reposit√≥rio p√∫blico com a mesma vers√£o. Sempre que um desenvolvedor o instalar, ele instalar√° o seu!

Para mais informa√ß√µes sobre confus√£o de depend√™ncia, confira:

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
