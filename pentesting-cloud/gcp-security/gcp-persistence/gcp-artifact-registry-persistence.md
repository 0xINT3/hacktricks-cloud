# GCP - Persist√™ncia no Artifact Registry

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Artifact Registry

Para mais informa√ß√µes sobre o Artifact Registry, confira:

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### Confus√£o de Depend√™ncia

* O que acontece se um reposit√≥rio **remoto e um padr√£o** forem **misturados em um virtual** e um pacote existir em ambos?
* Aquele com a **prioridade mais alta definida no reposit√≥rio virtual** √© utilizado
* Se a **prioridade for a mesma**:
* Se a **vers√£o** for a **mesma**, a **pol√≠tica com nome alfabeticamente** primeiro no reposit√≥rio virtual √© utilizada
* Se n√£o, a **vers√£o mais alta** √© utilizada

{% hint style="danger" %}
Portanto, √© poss√≠vel **abusar de uma vers√£o mais alta (confus√£o de depend√™ncia)** em um registro p√∫blico de pacotes se o reposit√≥rio remoto tiver uma prioridade mais alta ou igual
{% endhint %}

Esta t√©cnica pode ser √∫til para **persist√™ncia** e **acesso n√£o autenticado**, pois para abus√°-la basta **conhecer o nome de uma biblioteca** armazenada no Artifact Registry e **criar essa mesma biblioteca no reposit√≥rio p√∫blico (PyPi para python, por exemplo)** com uma vers√£o mais alta.

Para persist√™ncia, estes s√£o os passos que voc√™ precisa seguir:

* **Requisitos**: Um **reposit√≥rio virtual** deve **existir** e ser utilizado, um **pacote interno** com um **nome** que n√£o exista no **reposit√≥rio p√∫blico** deve ser utilizado.
* Crie um reposit√≥rio remoto se ele n√£o existir
* Adicione o reposit√≥rio remoto ao reposit√≥rio virtual
* Edite as pol√≠ticas do registro virtual para dar uma prioridade mais alta (ou igual) ao reposit√≥rio remoto.\
Execute algo como:
* [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
* Baixe o pacote leg√≠timo, adicione seu c√≥digo malicioso e registre-o no reposit√≥rio p√∫blico com a mesma vers√£o. Toda vez que um desenvolvedor instal√°-lo, ele instalar√° o seu!

Para mais informa√ß√µes sobre confus√£o de depend√™ncia, confira:

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
