# GCP - Artifact Registry Persistence

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で私たちをフォローする [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
- **ハッキングトリックを共有するには**、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## Artifact Registry

Artifact Registryに関する詳細情報は次を参照してください：

{% content-ref url="../gcp-services/gcp-artifact-registry-enum.md" %}
[gcp-artifact-registry-enum.md](../gcp-services/gcp-artifact-registry-enum.md)
{% endcontent-ref %}

### 依存関係混乱

- **リモートと標準**リポジトリが**仮想的に混在**し、パッケージが両方に存在する場合、どうなりますか？
- 仮想リポジトリで**最優先設定されたもの**が使用されます
- **優先度が同じ**場合：
  - バージョンが**同じ**場合、仮想リポジトリ内で**アルファベット順に最初のポリシー名**が使用されます
  - そうでない場合、**最高バージョン**が使用されます

{% hint style="danger" %}
したがって、リモートリポジトリがより高いまたは同じ優先度を持つ場合、**公開パッケージレジストリで最高バージョン（依存関係混乱）を悪用することが可能**です
{% endhint %}

このテクニックは**永続性**と**認証されていないアクセス**に役立ち、それを悪用するにはArtifact Registryに保存されているライブラリ名を**知っているだけ**で、同じライブラリを**公開リポジトリ（たとえばPythonのPyPi）**により高いバージョンで作成する必要があります。

永続性のためには、以下の手順に従う必要があります：

- **要件**：**仮想リポジトリ**が**存在**し、使用されている必要があり、**公開リポジトリ**に存在しない**名前**を持つ**内部パッケージ**を使用する必要があります。
- リモートリポジトリを作成する（存在しない場合）
- リモートリポジトリを仮想リポジトリに追加する
- 仮想レジストリのポリシーを編集して、リモートリポジトリに**より高い優先度（または同じ）**を与えます。\
次のようなコマンドを実行します：
  - [gcloud artifacts repositories update --upstream-policy-file ...](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/update#--upstream-policy-file)
- 正規のパッケージをダウンロードし、悪意のあるコードを追加して、同じバージョンで公開リポジトリに登録します。開発者がインストールするたびに、彼らはあなたのものをインストールします！

依存関係混乱についての詳細は次を参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/dependency-confusion" %}

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で私たちをフォローする [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
- **ハッキングトリックを共有するには**、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
