# GCP - Información Básica

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Jerarquía de recursos**

Google Cloud utiliza una [jerarquía de recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que es similar, conceptualmente, a la de un sistema de archivos tradicional. Esto proporciona un flujo de trabajo lógico de padre/hijo con puntos de conexión específicos para políticas y permisos.

A un alto nivel, se ve así:
```
Organization
--> Folders
--> Projects
--> Resources
```
Una máquina virtual (llamada Instancia de Computación) es un recurso. Un recurso reside en un proyecto, probablemente junto a otras Instancias de Computación, buckets de almacenamiento, etc.

<figure><img src="../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Migración de Proyectos**

Es posible **migrar un proyecto sin ninguna organización** a una organización con los permisos `roles/resourcemanager.projectCreator` y `roles/resourcemanager.projectMover`. Si el proyecto está dentro de otra organización, es necesario contactar al soporte de GCP para **sacarlos primero de la organización**. Para más información, consulta [**esto**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Políticas de Organización**

Permiten centralizar el control sobre los recursos en la nube de su organización:

* Centralizar el control para **configurar restricciones** sobre cómo se pueden utilizar los recursos de su organización.
* Definir y establecer **barreras de protección** para que sus equipos de desarrollo se mantengan dentro de los límites de cumplimiento.
* Ayudar a los propietarios de proyectos y sus equipos a avanzar rápidamente sin preocuparse de romper el cumplimiento.

Estas políticas se pueden crear para **afectar a toda la organización, carpetas o proyectos**. Los descendientes del nodo de la jerarquía de recursos objetivo **heredan la política de organización**.

Para **definir** una política de organización, **eliges una** [**restricción**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que es un tipo particular de restricción contra un servicio de Google Cloud o un grupo de servicios de Google Cloud. **Configuras esa restricción con las restricciones deseadas**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Casos de uso comunes <a href="#common_use_cases" id="common_use_cases"></a>

* Limitar el intercambio de recursos basado en dominio.
* Limitar el uso de cuentas de servicio de Identity and Access Management.
* Restringir la ubicación física de los recursos recién creados.
* Deshabilitar la creación de cuentas de servicio.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Hay muchas más restricciones que le dan un control detallado de los recursos de su organización. Para **más información, consulta la** [**lista de todas las restricciones del Servicio de Política de Organización**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

## **Roles de IAM**

Son como las políticas de IAM en AWS ya que **cada rol contiene un conjunto de permisos.**

Sin embargo, a diferencia de AWS, **no hay un repositorio centralizado** de roles. En su lugar, **los recursos otorgan roles de acceso X a los principios Y**, y la única forma de averiguar quién tiene acceso a un recurso es usar el **método `get-iam-policy` sobre ese recurso**.\
Esto podría ser un problema porque significa que la única forma de averiguar **qué permisos tiene un principio es preguntar a cada recurso a quién está otorgando permisos**, y un usuario podría no tener permisos para obtener permisos de todos los recursos.

Hay **tres tipos** de roles en IAM:

* **Roles básicos/primitivos**, que incluyen los roles de **Propietario**, **Editor** y **Visualizador** que existían antes de la introducción de IAM.
* **Roles predefinidos**, que proporcionan acceso granular para un servicio específico y son gestionados por Google Cloud. Hay muchos roles predefinidos, puedes **ver todos ellos con los privilegios que tienen** [**aquí**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Roles personalizados**, que proporcionan acceso granular según una lista de permisos especificada por el usuario.

Hay miles de permisos en GCP. Para verificar si un rol tiene un permiso, puedes [**buscar el permiso aquí**](https://cloud.google.com/iam/docs/permissions-reference) y ver qué roles lo tienen.

También puedes [**buscar aquí roles predefinidos**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **ofrecidos por cada producto.** Ten en cuenta que algunos **roles** no se pueden asignar a usuarios y **solo a SAs debido a algunos permisos** que contienen.\
Además, ten en cuenta que los **permisos** solo **tendrán efecto** si están **adjuntos al servicio relevante.**

O verifica si un **rol personalizado puede usar un** [**permiso específico aquí**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Usuarios <a href="#default-credentials" id="default-credentials"></a>

En la **consola de GCP** **no hay gestión de Usuarios o Grupos**, eso se hace en **Google Workspace**. Aunque podrías sincronizar un proveedor de identidad diferente en Google Workspace.

Puedes acceder a **usuarios y grupos de Workspaces en** [**https://admin.google.com**](https://admin.google.com/).

**MFA** puede ser **forzado** a los usuarios de Workspaces, sin embargo, un **atacante** podría usar un token para acceder a GCP **a través de la cli que no estará protegido por MFA** (solo estará protegido por MFA cuando el usuario inicie sesión para generarlo: `gcloud auth login`).

## Grupos

Cuando se crea una organización, se **sugiere encarecidamente crear varios grupos**. Si gestionas alguno de ellos, podrías haber comprometido todo o una parte importante de la organización:

<table data-header-hidden><thead><tr><th width="320"></th><th></th></tr></thead><tbody><tr><td><strong>Grupo</strong></td><td><strong>Función</strong></td></tr><tr><td><strong><code>grp-gcp-organization-admins</code></strong><br><em>(grupo o cuentas individuales requeridas para la lista de verificación)</em></td><td>Administrar cualquier recurso que pertenezca a la organización. Asigna este rol con moderación; los administradores de la organización tienen acceso a todos tus recursos de Google Cloud. Alternativamente, debido a que esta función es altamente privilegiada, considera usar cuentas individuales en lugar de crear un grupo.</td></tr><tr><td><strong><code>grp-gcp-network-admins</code></strong><br><em>(requerido para la lista de verificación)</em></td><td>Crear redes, subredes, reglas de firewall y dispositivos de red como Cloud Router, Cloud VPN y balanceadores de carga en la nube.</td></tr><tr><td><strong><code>grp-gcp-billing-admins</code></strong><br><em>(requerido para la lista de verificación)</em></td><td>Configurar cuentas de facturación y monitorear su uso.</td></tr><tr><td><strong><code>grp-gcp-developers</code></strong><br><em>(requerido para la lista de verificación)</em></td><td>Diseñar, codificar y probar aplicaciones.</td></tr><tr><td><strong><code>grp-gcp-security-admins</code></strong><br></td><td>Establecer y gestionar políticas de seguridad para toda la organización, incluyendo la gestión de accesos y <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">políticas de restricción de la organización</a>. Consulta la <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">guía de fundamentos de seguridad de Google Cloud</a> para más información sobre la planificación de tu infraestructura de seguridad en Google Cloud.</td></tr><tr><td><strong><code>grp-gcp-devops</code></strong></td><td>Crear o gestionar pipelines de extremo a extremo que soporten la integración y entrega continuas, monitoreo y aprovisionamiento de sistemas.</td></tr><tr><td><strong><code>grp-gcp-billing-viewer</code></strong></td><td>Monitorear el gasto en proyectos. Los miembros típicos son parte del equipo financiero.</td></tr><tr><td><strong><code>grp-gcp-platform-viewer</code></strong></td><td>Revisar la información de recursos en toda la organización de Google Cloud.</td></tr><tr><td><strong><code>grp-gcp-security-reviewer</code></strong></td><td>Revisar la seguridad en la nube.</td></tr><tr><td><strong><code>grp-gcp-network-viewer</code></strong></td><td>Revisar configuraciones de red.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong></td><td>Ver registros de auditoría.</td></tr><tr><td><strong><code>grp-gcp-scc-admin</code></strong></td><td>Administrar el Security Command Center.</td></tr><tr><td><strong><code>grp-gcp-secrets-admin</code></strong></td><td>Gestionar secretos en el Secret Manager.</td></tr></tbody></table>

## **Política de Contraseña Predeterminada**

<figure><img src="../../.gitbook/assets/image (1) (9).png" alt=""><figcaption></figcaption></figure>

## **Cuentas de servicio**

Estos son los principios a los que **los recursos** pueden **estar adjuntos** y tener acceso para interactuar fácilmente con GCP. Por ejemplo, es posible acceder al **token de autenticación** de una Cuenta de Servicio **adjunta a una VM** en los metadatos.\
Es posible encontrar algunos **conflictos** al usar tanto **IAM como ámbitos de acceso**. Por ejemplo, tu cuenta de servicio puede tener el rol de IAM `compute.instanceAdmin` pero la instancia que has comprometido ha sido limitada con la restricción de ámbito `https://www.googleapis.com/auth/compute.readonly`. Esto te impediría hacer cualquier cambio utilizando el token OAuth que se asigna automáticamente a tu instancia.

Es similar a **los roles de IAM de AWS**. Pero a diferencia de AWS, **cualquier** cuenta de servicio puede estar **adjunta a cualquier servicio** (no necesita permitirlo a través de una política).

Varias de las cuentas de servicio que encontrarás son en realidad **generadas automáticamente por GCP** cuando comienzas a usar un servicio, como:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Sin embargo, también es posible crear y adjuntar a recursos **cuentas de servicio personalizadas**, que se verán así:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Ámbitos de acceso**

Los ámbitos de acceso están **vinculados a los tokens OAuth generados** para acceder a los puntos finales de la API de GCP. Estos **restringen los permisos** del token OAuth.
Esto significa que si un token pertenece a un Propietario de un recurso pero no tiene el ámbito en el token para acceder a ese recurso, el token **no puede ser utilizado para (ab)usar esos privilegios**.

Google realmente [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) que **no se utilicen los ámbitos de acceso y que se confíe totalmente en IAM**. El portal de gestión web de hecho lo exige, pero los ámbitos de acceso todavía pueden aplicarse a instancias utilizando cuentas de servicio personalizadas de forma programática.

Puedes ver qué **ámbitos** están **asignados** mediante **consulta:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Los **scopes** anteriores son los que se generan por **defecto** al usar **`gcloud`** para acceder a datos. Esto se debe a que cuando utilizas **`gcloud`**, primero creas un token OAuth y luego lo usas para contactar con los endpoints.

El scope más importante de esos potencialmente es **`cloud-platform`**, lo que básicamente significa que es posible **acceder a cualquier servicio en GCP**.

Puedes **encontrar una lista de** [**todos los scopes posibles aquí**](https://developers.google.com/identity/protocols/googlescopes)**.**

Si tienes credenciales de navegador de **`gcloud`**, es posible **obtener un token con otros scopes,** haciendo algo como:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Políticas, Vinculaciones y Membresías de IAM en Terraform**

Como define terraform en [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) al usar terraform con GCP hay diferentes maneras de otorgar acceso a un principal sobre un recurso:

* **Membresías**: Estableces **principales como miembros de roles** **sin restricciones** sobre el rol o los principales. Puedes poner a un usuario como miembro de un rol y luego poner a un grupo como miembro del mismo rol y también establecer esos principales (usuario y grupo) como miembro de otros roles.
* **Vinculaciones**: Varios **principales pueden estar vinculados a un rol**. Esos **principales aún pueden estar vinculados o ser miembros de otros roles**. Sin embargo, si un principal que no está vinculado al rol se establece como **miembro de un rol vinculado**, la próxima vez que se aplique la **vinculación, la membresía desaparecerá**.
* **Políticas**: Una política es **autoritativa**, indica roles y principales y luego, **esos principales no pueden tener más roles y esos roles no pueden tener más principales** a menos que se modifique esa política (ni siquiera en otras políticas, vinculaciones o membresías). Por lo tanto, cuando un rol o principal se especifica en política, todos sus privilegios están **limitados por esa política**. Obviamente, esto se puede eludir en caso de que al principal se le dé la opción de modificar la política o permisos de escalada de privilegios (como crear un nuevo principal y vincularle un nuevo rol).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras maneras de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
