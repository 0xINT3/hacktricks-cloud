# GCP - Temel Bilgiler

<details>

<summary><strong>Sıfırdan kahraman olana kadar AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## **Kaynak hiyerarşisi**

Google Cloud, kavramsal olarak geleneksel bir dosya sistemininkine benzer bir [Kaynak hiyerarşisi](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) kullanır. Bu, belirli politika ve izinler için mantıklı bir üst/alt iş akışı sağlar.

Yüksek seviyede şu şekilde görünür:
```
Organization
--> Folders
--> Projects
--> Resources
```
## **Proje Göçleri**

Bir proje, `roles/resourcemanager.projectCreator` ve `roles/resourcemanager.projectMover` izinlerine sahip bir organizasyona, muhtemelen diğer Compute Örnekleri, depolama kovaları vb. ile birlikte, **herhangi bir organizasyonsuz projeyi bir organizasyona göç etmek mümkündür**. Proje başka bir organizasyonun içindeyse, önce bunları organizasyondan çıkarmak için GCP desteğiyle iletişime geçilmesi gerekmektedir. Daha fazla bilgi için [**buraya**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6) bakın.

## **Organizasyon Politikaları**

Organizasyonunuzun bulut kaynakları üzerinde merkezi kontrol sağlamasına izin verir:

- Organizasyonunuzun kaynaklarının nasıl kullanılabileceğine dair **kısıtlamaları yapılandırmak** için merkezi kontrol sağlar.
- Geliştirme ekiplerinin uyumluluk sınırları içinde kalmasını sağlamak için **sınırlar** tanımlar ve oluşturur.
- Proje sahiplerinin ve ekiplerinin uyumluluğu bozmadan hızlı bir şekilde ilerlemelerine yardımcı olur.

Bu politikalar, **tüm organizasyonu, klasör(ler)i veya proje(leri) etkileyebilir**. Hedeflenen kaynak hiyerarşisi düğümünün **alt kümeleri organizasyon politikasını miras alır**.

Bir organizasyon politikasını **tanımlamak** için, bir Google Cloud hizmetine veya bir grup Google Cloud hizmetine karşı belirli bir kısıtlama olan bir [**kısıtlama**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints) seçersiniz. Ardından, bu kısıtlamayı istediğiniz kısıtlamalarla yapılandırırsınız.

#### Ortak kullanım durumları <a href="#common_use_cases" id="common_use_cases"></a>

- Alan adına göre kaynak paylaşımını sınırlama.
- Kimlik ve Erişim Yönetimi hizmet hesaplarının kullanımını sınırlama.
- Yeni oluşturulan kaynakların fiziksel konumunu kısıtlama.
- Hizmet hesabı oluşturmayı devre dışı bırakma

### **Varsayılan Organizasyon Politikaları**

<details>

<summary>Google'ın GCP organizasyonunuzu kurarken varsayılan olarak ekleyeceği politikalar şunlardır:</summary>

**Erişim Yönetimi Politikaları**

- **Alan adı kısıtlı kişiler:** Belirtilen alanlar dışındaki Kritik Kişilere kullanıcı eklenmesini engeller. Bu, yalnızca belirtilen alanlardaki yönetilen kullanıcı kimliklerinin platform bildirimleri almasına izin verir.
- **Alan adı kısıtlı paylaşım:** Belirtilen alanlar dışındaki kullanıcıların IAM politikalarına eklenmesini engeller. Bu, yalnızca belirtilen alanlardaki yönetilen kullanıcı kimliklerinin bu organizasyon içindeki kaynaklara erişmesine izin verir.
- **Genel erişim önleme:** Cloud Storage kovalarının genel erişime açık olmasını engeller. Bu, bir geliştiricinin Cloud Storage kovalarını kimliksiz internet erişimine sahip olacak şekilde yapılandırmasını engeller.
- **Düzgün kova düzeyinde erişim:** Cloud Storage kovalarındaki nesne düzeyinde erişim denetim listelerini (ACL'ler) engeller. Bu, Cloud Storage kovalarındaki tüm nesnelere tutarlı bir şekilde IAM politikaları uygulayarak erişim yönetiminizi basitleştirir.
- **İşletim Sistemi girişini gerektir:** Yeni projelerde oluşturulan VM'lerde OS Girişinin etkin olmasını sağlar. Bu, IAM kullanarak örneklerinize SSH erişimini yönetmenizi sağlar ve ayrıca bireysel SSH anahtarları oluşturmanıza ve yönetmenize gerek kalmaz.

**Hizmet hesapları için ek güvenlik politikaları**

- **Otomatik IAM atamalarını devre dışı bırak:** Varsayılan App Engine ve Compute Engine hizmet hesaplarının projede oluşturulduğunda Editör IAM rolünü otomatik olarak almalarını engeller. Bu, hizmet hesaplarının oluşturulduğunda aşırı derecede genişletilmiş IAM rollerini almalarını önler.
- **Hizmet hesabı anahtar oluşturmayı devre dışı bırak:** Genel hizmet hesabı anahtarlarının oluşturulmasını engeller. Bu, kalıcı kimlik bilgilerinin açığa çıkma riskini azaltmaya yardımcı olur.
- **Hizmet hesabı anahtar yüklemeyi devre dışı bırak:** Genel hizmet hesabı anahtarlarının yüklenmesini engeller. Bu, sızdırılan veya yeniden kullanılan anahtar materyallerinin riskini azaltmaya yardımcı olur.

**Güvenli VPC ağı yapılandırma politikaları**

- **VM örnekleri için izin verilen harici IP'leri tanımla:** Compute örneklerinin genel IP'ye sahip olmasını engeller, bu da onları internet trafiğine açık hale getirebilir.

<!---->

- **VM iç içe sanallaştırmayı devre dışı bırak:** Compute Engine VM'lerinde iç içe VM'lerin oluşturulmasını engeller. Bu, izlenmeyen iç içe VM'lerin güvenlik riskini azaltır.

<!---->

- **VM seri bağlantısını devre dışı bırak:** Compute Engine VM'lerine seri bağlantı erişimini engeller. Bu, Compute Engine API'sını kullanarak bir sunucunun seri bağlantısına girişi engeller.

<!---->

- **Cloud SQL örneklerine yetkilendirilmiş ağları kısıtla:** Genel veya iç olmayan ağ aralıklarının Cloud SQL veritabanlarınıza erişmesini engeller.

<!---->

- **IP Adresi Türüne Göre Protokol Yönlendirmeyi Kısıtla:** Dış IP adresleri için VM protokol yönlendirmesini engeller.

<!---->

- **Cloud SQL örneklerinde Genel IP erişimini kısıtla:** Genel IP'ye sahip Cloud SQL örneklerinin oluşturulmasını engeller, bu da onları internet trafiğine açık hale getirebilir.

<!---->

- **Paylaşılan VPC proje lien kaldırmasını kısıtla:** Paylaşılan VPC ana bilgisayar projelerinin yanlışlıkla silinmesini engeller.

<!---->

- **Yeni projeler için iç DNS ayarını Zonal DNS Only olarak ayarlar:** Hizmet kullanılabilirliğini azaltan eski DNS ayarının kullanılmasını engeller.

<!---->

- **Varsayılan ağ oluşturmayı atla:** Varsayılan VPC ağının ve ilgili kaynakların otomatik oluşturulmasını engeller. Bu, aşırı derecede genişletilmiş varsayılan güvenlik duvarı kurallarını önler.

<!---->

- **VPC Dış IPv6 kullanımını devre dışı bırak:** Yetkisiz internet erişimine açık olabilen dış IPv6 alt ağlarının oluşturulmasını engeller.

</details>

## **IAM Rolleri**

Bu, her rolün bir dizi izni içerdiği AWS'deki IAM politikalarına benzerdir.

Ancak AWS'den farklı olarak, rollerin merkezi bir depo**su yoktur**. Bunun yerine, **kaynaklar X erişim rollerini Y prensiplere verir** ve bir kaynağın kimlere erişim izni verdiğini öğrenmenin tek yolu, o kaynağın üzerinde **`get-iam-policy` yöntemini kullanmaktır**.\
Bu bir sorun olabilir çünkü bu, bir prensibin hangi izinlere sahip olduğunu öğrenmenin tek yolunun, izin verdiği prensipleri sormak olduğu anlamına gelir ve bir kullanıcının tüm kaynaklardan izinleri almak için izni olmayabilir.

IAM'de **üç tür** rol vardır:

- **Temel/İlkel roller**, IAM'in tanıtılmasından önce var olan **Sahip**, **Editör** ve **Görüntüleyici** rollerini içerir.
- **Önceden tanımlanmış roller**, belirli bir hizmet için ayrıntılı erişim sağlar ve Google Cloud tarafından yönetilir. Birçok önceden tanımlanmış rol vardır, **onların tümünü ve sahip oldukları ayrıcalıkları** [**buradan**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles) görebilirsiniz.
- **Özel roller**, kullanıcı tarafından belirtilen bir izin listesine göre ayrıntılı erişim sağlar.

GCP'de binlerce izin bulunmaktadır. Bir rolün bir izne sahip olup olmadığını kontrol etmek için [**buradan izni arayabilirsiniz**](https://cloud.google.com/iam/docs/permissions-reference) ve hangi rollerin ona sahip olduğunu görebilirsiniz.

Ayrıca, **her ürün tarafından sunulan önceden tanımlanmış rolleri** [**buradan arayabilirsiniz**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation). Bazı **rollerin** kullanıcılara **bağlanamayacağını ve yalnızca Hizmet Hesaplarına** bağlanabileceğini unutmayın çünkü içerdiği bazı izinler.\
Ayrıca, **izinlerin** yalnızca ilgili hizmete **bağlandığında** **geçerli olacağını** unutmayın.

Veya bir **özel rolün** [**burada belirli bir izni kullanıp kullanamayacağını kontrol edebilirsiniz**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**
## Kullanıcılar <a href="#default-credentials" id="default-credentials"></a>

**GCP konsolunda** **Kullanıcılar veya Gruplar** yönetimi bulunmamaktadır, bu **Google Workspace** üzerinde gerçekleştirilir. Ancak farklı bir kimlik sağlayıcıyı Google Workspace'e senkronize edebilirsiniz.

Workspace'in **kullanıcılarına ve gruplarına** [**https://admin.google.com**](https://admin.google.com/) adresinden erişebilirsiniz.

**MFA**, Workspace kullanıcılarına **zorunlu** olabilir, ancak bir **saldırgan** MFA tarafından korunmayan GCP'ye erişmek için bir belirteç kullanabilir (kullanıcı giriş yaparak yalnızca oluşturduğunda MFA tarafından korunur: `gcloud auth login`).

## Gruplar

Bir organizasyon oluşturulduğunda, birkaç grubun **kesinlikle oluşturulması önerilir.** Bunlardan herhangi birini yönetiyorsanız, tüm organizasyonu veya önemli bir kısmını tehlikeye atabilirsiniz:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grup</strong></td><td><strong>Fonksiyon</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(kontrol listesi için grup veya bireysel hesaplar gereklidir)</em></td><td>Organizasyona ait herhangi bir kaynağı yönetmek. Bu rolü dikkatlice atayın; org yöneticileri tüm Google Cloud kaynaklarına erişebilir. Alternatif olarak, bu fonksiyon çok ayrıcalıklı olduğundan, bir grup oluşturmak yerine bireysel hesapları kullanmayı düşünebilirsiniz.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(kontrol listesi için gereklidir)</em></td><td>Ağlar, alt ağlar, güvenlik duvarı kuralları ve Cloud Router, Cloud VPN ve bulut yük dengeleyicileri gibi ağ cihazları oluşturma.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(kontrol listesi için gereklidir)</em></td><td>Faturalandırma hesaplarını kurma ve kullanımlarını izleme.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(kontrol listesi için gereklidir)</em></td><td>Uygulamaları tasarlama, kodlama ve test etme.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Organizasyonun tamamı için güvenlik politikalarını oluşturma ve yönetme, erişim yönetimi ve <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">organizasyon kısıtlama politikaları</a> gibi. Google Cloud güvenlik altyapınızı planlarken daha fazla bilgi için <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud güvenlik temelleri kılavuzuna</a> bakın.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Sürekli entegrasyon ve dağıtımı destekleyen uçtan uca boru hatları oluşturma veya yönetme, izleme ve sistem sağlama.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Projelerde harcamaları izleme. Tipik üyeler finans ekibinin bir parçasıdır.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Google Cloud organizasyonu genelinde kaynak bilgilerini inceleme.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Bulut güvenliğini inceleme.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Ağ yapılandırmalarını inceleme.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(artık varsayılan değil)</em></td><td>Denetim günlüklerini görüntüleme.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(artık varsayılan değil)</em></td><td>Güvenlik Komut Merkezi'ni yönetme.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(artık varsayılan değil)</em></td><td>Secret Manager'da sırları yönetme.</td></tr></tbody></table>

## **Varsayılan Şifre Politikası**

* Güçlü şifreleri zorunlu kılma
* 8 ile 100 karakter arası
* Tekrar kullanımı yok
* Süresizlik yok
* İnsanlar üçüncü taraf sağlayıcı aracılığıyla Workspace'e erişiyorsa, bu gereksinimler uygulanmaz.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Hizmet hesapları**

Bunlar, **kaynakların** **bağlı olabileceği** ve GCP ile kolayca etkileşimde bulunabileceği temsilcilerdir. Örneğin, bir Hizmet Hesabının **VM'ye bağlı** kimlik doğrulama belirteçlerine erişmek mümkündür.\
IAM ve erişim kapsamlarını birlikte kullanırken bazı **çakışmalarla** karşılaşmak mümkündür. Örneğin, hizmet hesabınızın `compute.instanceAdmin` IAM rolüne sahip olabilir ancak ele geçirdiğiniz örneğin kapsam kısıtlaması olan `https://www.googleapis.com/auth/compute.readonly` ile sınırlanmış olabilir. Bu durum, otomatik olarak örneğinize atanan OAuth belirteci kullanarak herhangi bir değişiklik yapmanızı engeller.

Bu, **AWS'den IAM rollerine** benzer. Ancak AWS'den farklı olarak, **herhangi bir** hizmet hesabı **herhangi bir hizmete bağlanabilir** (bunu bir politika aracılığıyla izin vermesine gerek yoktur).

Karşılaşacağınız hizmet hesaplarının bir kısmı aslında GCP'yi kullanmaya başladığınızda **otomatik olarak oluşturulur**, örneğin:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Ancak, kaynaklara **özel hizmet hesapları** oluşturmak ve bunlara bağlamak da mümkündür ve bu hesaplar şöyle görünecektir:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Erişim kapsamları**

Erişim kapsamları, GCP API uç noktalarına erişmek için oluşturulan OAuth belgelerine **eklenir**. Bunlar OAuth belgesinin **izinlerini kısıtlar**.\
Bu, bir belgenin bir kaynağın Sahibi olduğu halde o kaynağa erişmek için belgede kapsam olmadığında, belgenin o ayrıcalıkları **kullanmak için kullanılamayacağı** anlamına gelir.

Google aslında [öneriyor](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) ki **erişim kapsamları kullanılmasın ve tamamen IAM'a güvenilsin**. Web yönetim portalı aslında bunu zorlar, ancak erişim kapsamları hala özel servis hesapları kullanılarak örneklerde uygulanabilir.

**Kapsamların** ne olduğunu **sorgulayarak** görebilirsiniz:

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Önceki **kapsamlar**, verilere erişmek için **`gcloud`** kullanılarak varsayılan olarak oluşturulanlardır. Bu, **`gcloud`** kullandığınızda önce bir OAuth belirteci oluşturmanız ve ardından uç noktalara başvurmanız gerektiği anlamına gelir.

Bu kapsamlar arasında en önemlisi muhtemelen **`cloud-platform`**'dur, bu da temelde **GCP'deki herhangi bir hizmete erişilebileceği anlamına gelir**.

[**Burada**](https://developers.google.com/identity/protocols/googlescopes)** tüm olası kapsamların bir listesini bulabilirsiniz**.

Eğer **`gcloud`** tarayıcı kimlik bilgilerine sahipseniz, başka kapsamlara sahip bir belirteç **edinebilirsiniz**, şöyle bir şey yaparak:
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Terraform IAM Politikaları, Bağlantılar ve Üyelikler**

Terraform tarafından [burada](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_iam) tanımlandığı gibi GCP ile terraform kullanarak bir ilkeye bir kaynağın üzerinde erişim vermenin farklı yolları vardır:

- **Üyelikler**: **İlkeye kısıtlama olmadan rollerin üyeleri olarak ilke sahiplerini belirlersiniz**. Bir kullanıcıyı bir rolün üyesi olarak belirleyebilir ve ardından aynı rolün bir üyesi olarak bir grup belirleyebilir ve bu ilke sahiplerini (kullanıcı ve grup) diğer rollerin üyeleri olarak da belirleyebilirsiniz.
- **Bağlantılar**: Bir role **çeşitli ilke sahipleri bağlanabilir**. Bu **ilke sahipleri hala bağlanabilir veya diğer rollerin üyeleri olabilir**. Ancak, bir role bağlı olmayan bir ilke, bir bağlı role üye olarak belirlenirse, **bir sonraki bağlama uygulandığında üyelik kaybolur**.
- **Politikalar**: Bir politika **yetkilidir**, rolleri ve ilke sahiplerini belirtir ve sonra, **bu ilke sahiplerinin daha fazla rolü olamaz ve bu rollerin daha fazla ilke sahibi olamaz** (başka politikalarda, bağlantılarda veya üyeliklerde bile). Dolayısıyla, bir rol veya ilke sahibi politikada belirtildiğinde, tüm ayrıcalıkları **o politika tarafından sınırlanır**. Açıkçası, bu durum, ilke sahibinin politikayı değiştirme veya ayrıcalık yükseltme izinlerine sahip olması durumunda atlanabilir (yeni bir ilke sahibi oluşturup ona yeni bir rol bağlama gibi).

## Referanslar

- [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
- [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)
