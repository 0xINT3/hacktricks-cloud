# GCP - Informations de base

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts github.**

</details>

## **Hi√©rarchie des ressources**

Google Cloud utilise une [hi√©rarchie des ressources](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) qui est similaire, conceptuellement, √† celle d'un syst√®me de fichiers traditionnel. Cela fournit un flux de travail parent/enfant logique avec des points d'attache sp√©cifiques pour les politiques et les autorisations.

√Ä un niveau √©lev√©, cela ressemble √† ceci :

```
Organisation
--> Dossiers
  --> Projets
    --> Ressources
```

Une machine virtuelle (appel√©e instance de calcul) est une ressource. Une ressource r√©side dans un projet, probablement aux c√¥t√©s d'autres instances de calcul, de compartiments de stockage, etc.

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

## **Migration de projets**

Il est possible de **migrer un projet sans aucune organisation** vers une organisation avec les autorisations `roles/resourcemanager.projectCreator` et `roles/resourcemanager.projectMover`. Si le projet est √† l'int√©rieur d'une autre organisation, il est n√©cessaire de contacter le support GCP pour **les sortir de l'organisation en premier**. Pour plus d'informations, consultez [**ceci**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Politiques d'organisation**

Permettent de centraliser le contr√¥le sur les ressources cloud de votre organisation :

* Centraliser le contr√¥le pour **configurer des restrictions** sur la fa√ßon dont les ressources de votre organisation peuvent √™tre utilis√©es.
* D√©finir et √©tablir des **garde-fous** pour que vos √©quipes de d√©veloppement restent dans les limites de conformit√©.
* Aider les propri√©taires de projets et leurs √©quipes √† avancer rapidement sans se soucier de la conformit√©.

Ces politiques peuvent √™tre cr√©√©es pour **affecter l'ensemble de l'organisation, des dossiers ou des projets**. Les descendants du n≈ìud de hi√©rarchie de ressources cibl√© **h√©ritent de la politique d'organisation**.

Pour **d√©finir** une politique d'organisation, **vous choisissez une** [**contrainte**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), qui est un type particulier de restriction contre un service Google Cloud ou un groupe de services Google Cloud. Vous **configurez cette contrainte avec les restrictions souhait√©es**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Cas d'utilisation courants <a href="#common_use_cases" id="common_use_cases"></a>

* Limiter le partage de ressources en fonction du domaine.
* Limiter l'utilisation des comptes de service de gestion d'identit√© et d'acc√®s.
* Restreindre l'emplacement physique des ressources nouvellement cr√©√©es.
* D√©sactiver la cr√©ation de comptes de service.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Il existe de nombreuses autres contraintes qui vous donnent un contr√¥le pr√©cis sur les ressources de votre organisation. Pour **plus d'informations, consultez la** [**liste de toutes les contraintes du service de politique d'organisation**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

## **R√¥les IAM**

Ceux-ci sont comme les politiques IAM dans AWS car **chaque r√¥le contient un ensemble de permissions**.

Cependant, contrairement √† AWS, il n'y a **pas de r√©f√©rentiel centralis√©** de r√¥les. Au lieu de cela, **les ressources donnent des r√¥les d'acc√®s X √† des principes Y**, et la seule fa√ßon de savoir qui a acc√®s √† une ressource est d'utiliser la **m√©thode `get-iam-policy` sur cette ressource**.\
Cela pourrait poser un probl√®me car cela signifie que la seule fa√ßon de savoir **quelles autorisations un principe a est de demander √† chaque ressource √† qui il donne des autorisations**, et un utilisateur pourrait ne pas avoir les autorisations pour obtenir des autorisations de toutes les ressources.

Il existe **trois types** de r√¥les dans IAM :

* **R√¥les de base/primitifs**, qui comp
### **Port√©es d'acc√®s**

Les port√©es d'acc√®s sont **attach√©es aux jetons OAuth g√©n√©r√©s** pour acc√©der aux points d'extr√©mit√© de l'API GCP. Ils **restreignent les autorisations** du jeton OAuth.\
Cela signifie que si un jeton appartient √† un propri√©taire d'une ressource mais n'a pas la port√©e d'acc√®s √† cette ressource, le jeton **ne peut pas √™tre utilis√© pour (ab)user de ces privil√®ges**.

Google [recommande](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) en fait de **ne pas utiliser les port√©es d'acc√®s et de s'appuyer totalement sur IAM**. Le portail de gestion Web l'impose en fait, mais les port√©es d'acc√®s peuvent encore √™tre appliqu√©es aux instances en utilisant des comptes de service personnalis√©s de mani√®re programmatique.

Vous pouvez voir quelles **port√©es** sont **assign√©es** en **interrogeant :**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
  "issued_to": "223044615559.apps.googleusercontent.com",
  "audience": "223044615559.apps.googleusercontent.com",
  "user_id": "139746512919298469201",
  "scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
  "expires_in": 2253,
  "email": "username@testing.com",
  "verified_email": true,
  "access_type": "offline"
}
```
{% endcode %}

Les **port√©es** pr√©c√©dentes sont celles g√©n√©r√©es par **d√©faut** en utilisant **`gcloud`** pour acc√©der aux donn√©es. C'est parce que lorsque vous utilisez **`gcloud`**, vous cr√©ez d'abord un jeton OAuth, puis l'utilisez pour contacter les points d'extr√©mit√©.

La port√©e la plus importante de celles-ci est potentiellement **`cloud-platform`**, ce qui signifie essentiellement qu'il est possible d'**acc√©der √† n'importe quel service dans GCP**.

Vous pouvez **trouver une liste de** [**toutes les port√©es possibles ici**](https://developers.google.com/identity/protocols/googlescopes)**.**

Si vous avez des **informations d'identification de navigateur gcloud**, il est possible d'**obtenir un jeton avec d'autres port√©es**, en faisant quelque chose comme :

{% code overflow="wrap" %}
```bash
# Peut-√™tre pouvez-vous obtenir un jeton utilisateur avec d'autres port√©es en changeant le tableau de port√©es de ~/.config/gcloud/credentials.db

# D√©finir de nouvelles port√©es pour les informations d'identification des SDK
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Imprimer le nouveau jeton 
gcloud auth application-default print-access-token

# Pour utiliser ce jeton avec une API, vous devrez peut-√™tre utiliser curl pour indiquer l'en-t√™te du projet avec --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Politiques IAM Terraform, liaisons et adh√©sions**

Comme d√©fini par terraform dans [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) en utilisant terraform avec GCP, il existe diff√©rentes fa√ßons d'accorder √† un principal l'acc√®s √† une ressource :

* **Adh√©sions** : Vous d√©finissez des **principaux en tant que membres de r√¥les sans restrictions** sur le r√¥le ou les principaux. Vous pouvez mettre un utilisateur en tant que membre d'un r√¥le, puis mettre un groupe en tant que membre du m√™me r√¥le et √©galement d√©finir ces principaux (utilisateur et groupe) en tant que membre d'autres r√¥les.
* **Liaisons** : Plusieurs **principaux peuvent √™tre li√©s √† un r√¥le**. Ces **principaux peuvent toujours √™tre li√©s ou √™tre membres d'autres r√¥les**. Cependant, si un principal qui n'est pas li√© au r√¥le est d√©fini en tant que **membre d'un r√¥le li√©**, la prochaine fois que la **liaison est appliqu√©e, l'adh√©sion dispara√Ætra**.
* **Politiques** : Une politique est **d'autorit√©**, elle indique les r√¥les et les principaux, et ensuite, **ces principaux ne peuvent pas avoir plus de r√¥les et ces r√¥les ne peuvent pas avoir plus de principaux** √† moins que cette politique ne soit modifi√©e (pas m√™me dans d'autres politiques, liaisons ou adh√©sions). Par cons√©quent, lorsqu'un r√¥le ou un principal est sp√©cifi√© dans une politique, tous ses privil√®ges sont **limit√©s par cette politique**. √âvidemment, cela peut √™tre contourn√© si le principal est donn√© la possibilit√© de modifier la politique ou les autorisations d'escalade de privil√®ges (comme cr√©er un nouveau principal et lui lier un nouveau r√¥le).

## R√©f√©rences

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>