# GCP - Osnovne informacije

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Hierarhija resursa**

Google Cloud koristi [Hierarhiju resursa](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) koja je konceptualno slična tradicionalnom sistemskom fajl sistemu. Ovo pruža logičan roditelj/dete radni tok sa specifičnim tačkama za pravila i dozvole.

Na visokom nivou, izgleda ovako:
```
Organization
--> Folders
--> Projects
--> Resources
```
Virtualna mašina (nazvana Compute Instance) je resurs. Resurs se nalazi u projektu, verovatno zajedno sa drugim Compute Instancama, skladišnim kantama itd.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Migracija projekata**

Moguće je **migrirati projekat bez organizacije** u organizaciju sa dozvolama `roles/resourcemanager.projectCreator` i `roles/resourcemanager.projectMover`. Ako je projekat unutar druge organizacije, potrebno je kontaktirati GCP podršku da ih **premesti iz organizacije prvo**. Za više informacija pogledajte [**ovde**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Politike organizacije**

Omogućavaju centralizovanu kontrolu nad resursima oblaka vaše organizacije:

* Centralizovana kontrola za **konfigurisanje ograničenja** o tome kako se mogu koristiti resursi vaše organizacije.
* Definisanje i uspostavljanje **ograničenja** za timove za razvoj kako bi ostali unutar granica usaglašenosti.
* Pomaže vlasnicima projekata i njihovim timovima da se brzo kreću bez brige o kršenju usaglašenosti.

Ove politike mogu biti kreirane da **utiču na celu organizaciju, folder(e) ili projekat(e)**. Potomci ciljanog čvora hijerarhije resursa **nasleđuju politiku organizacije**.

Da biste **definisali** politiku organizacije, **birate** [**ograničenje**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), koje je određeni tip ograničenja protiv određene Google Cloud usluge ili grupe Google Cloud usluga. **Konfigurišete to ograničenje sa željenim ograničenjima**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Uobičajene upotrebe <a href="#common_use_cases" id="common_use_cases"></a>

* Ograničavanje deljenja resursa na osnovu domena.
* Ograničavanje upotrebe servisnih naloga za identitet i pristup.
* Ograničavanje fizičke lokacije novostvorenih resursa.
* Onemogućavanje kreiranja servisnih naloga.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Postoji još mnogo ograničenja koja vam pružaju detaljnu kontrolu nad resursima vaše organizacije. Za **više informacija pogledajte** [**listu svih ograničenja usluge Politika organizacije**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Podrazumevane politike organizacije**

<details>

<summary>Ovo su politike koje će Google automatski dodati prilikom podešavanja vaše GCP organizacije:</summary>

**Politike upravljanja pristupom**

* **Kontakti sa ograničenim domenom:** Onemogućava dodavanje korisnika Essential Contacts izvan vaših odabranih domena. Ovo ograničava Essential Contacts da dozvoli samo upravljanim korisničkim identitetima u vašim odabranim domenima da primaju obaveštenja platforme.
* **Deljenje sa ograničenim domenom:** Onemogućava dodavanje korisnika u IAM politike izvan vaših odabranih domena. Ovo ograničava IAM politike da dozvoli samo upravljanim korisničkim identitetima u vašim odabranim domenima pristup resursima unutar ove organizacije.
* **Prevencija javnog pristupa:** Onemogućava izlaganje kanti za Cloud Storage javnosti. Ovo osigurava da programer ne može konfigurisati kante za Cloud Storage da imaju neautentifikovan pristup internetu.
* **Jedinstven pristup nivou kante:** Onemogućava liste za kontrolu pristupa na nivou objekta (ACL) u kantama za Cloud Storage. Ovo pojednostavljuje upravljanje pristupom primenom IAM politika dosledno na sve objekte u kantama za Cloud Storage.
* **Zahtevaj prijavu na OS:** VM-ovi kreirani u novim projektima će imati omogućenu prijavu na OS. Ovo vam omogućava da upravljate SSH pristupom vašim instancama koristeći IAM, bez potrebe za kreiranjem i upravljanjem pojedinačnim SSH ključevima.

**Dodatne bezbednosne politike za servisne naloge**

* **Onemogući automatske IAM dozvole**: Onemogućava podrazumevane App Engine i Compute Engine servisne naloge da automatski dobiju Editor IAM ulogu na projektu prilikom kreiranja. Ovo osigurava da servisni nalozi ne dobijaju prekomerne IAM uloge prilikom kreiranja.
* **Onemogući kreiranje ključeva servisnih naloga**: Onemogućava kreiranje javnih ključeva servisnih naloga. Ovo pomaže u smanjenju rizika od izlaganja trajnih akreditiva.
* **Onemogući otpremanje ključeva servisnih naloga**: Onemogućava otpremanje javnih ključeva servisnih naloga. Ovo pomaže u smanjenju rizika od curenja ili ponovne upotrebe ključnih materijala.

**Politike konfiguracije bezbedne VPC mreže**

* **Definiši dozvoljene spoljne IP adrese za VM instance**: Onemogućava kreiranje Compute instanci sa javnom IP adresom, što ih može izložiti internet saobraćaju.

<!---->

* **Onemogući ugnježđavanje VM virtuelizacije**: Onemogućava kreiranje ugnježđenih VM-ova na Compute Engine VM-ovima. Ovo smanjuje sigurnosni rizik od prisustva nepraćenih ugnježđenih VM-ova.

<!---->

* **Onemogući serijski port VM-a:** Onemogućava pristup serijskom portu Compute Engine VM-ovima. Ovo sprečava unos na serijski port servera korišćenjem Compute Engine API-ja.

<!---->

* **Ograniči ovlašćene mreže na Cloud SQL instancama:** Onemogućava javne ili neinternetske mrežne opsege da pristupe vašim Cloud SQL bazama podataka.

<!---->

* **Ograniči prosleđivanje protokola na osnovu vrste IP adrese:** Onemogućava prosleđivanje protokola VM-ova za spoljne IP adrese.

<!---->

* **Ograniči pristup javnim IP adresama na Cloud SQL instancama:** Onemogućava kreiranje Cloud SQL instanci sa javnom IP adresom, što ih može izložiti internet saobraćaju.

<!---->

* **Ograniči uklanjanje liena deljenog VPC projekta:** Onemogućava slučajno brisanje host projekata deljenog VPC-a.

<!---->

* **Postavi internu DNS postavku za nove projekte samo na Zonal DNS:** Onemogućava upotrebu zastarele DNS postavke koja ima smanjenu dostupnost usluge.

<!---->

* **Preskoči automatsko kreiranje podrazumevane mreže:** Onemogućava automatsko kreiranje podrazumevane VPC mreže i pripadajućih resursa. Ovo izbegava prekomerno dozvoljena podrazumevana pravila zaštite od požara.

<!---->

* **Onemogući upotrebu VPC spoljnih IPv6 adresa:** Onemogućava kreiranje spoljnih IPv6 podmreža, koje mogu biti izložene neovlašćenom pristupu internetu.

</details>

## **IAM Uloge**

Ove uloge su slične IAM politikama u AWS-u jer **svaka uloga sadrži skup dozvola**.

Međutim, za razliku od AWS-a, ne postoji **centralizovani repozitorijum** uloga. Umesto toga, **resursi dodeljuju uloge pristupu
## Korisnici <a href="#default-credentials" id="default-credentials"></a>

U **GCP konzoli** nema upravljanja **korisnicima ili grupama**, to se radi u **Google Workspace-u**. Međutim, možete sinhronizovati drugog pružaoca identiteta u Google Workspace-u.

Korisnici i grupe Workspace-a mogu se pristupiti na [https://admin.google.com](https://admin.google.com).

**MFA** se može **obavezati** korisnicima Workspace-a, međutim, **napadač** može koristiti token za pristup GCP **putem CLI-a koji neće biti zaštićen MFA-om** (biće zaštićen MFA-om samo kada korisnik se prijavi da ga generiše: `gcloud auth login`).

## Grupe

Kada se organizacija kreira, preporučuje se kreiranje nekoliko grupa. Ako upravljate bilo kojom od njih, možete kompromitovati celu ili važan deo organizacije:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupa</strong></td><td><strong>Funkcija</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupa ili pojedinačni nalozi potrebni za proveru)</em></td><td>Upravljanje svim resursima koji pripadaju organizaciji. Ovu ulogu dodeljujte pažljivo; administratori organizacije imaju pristup svim vašim Google Cloud resursima. Alternativno, zbog visokih privilegija ove funkcije, razmislite o korišćenju pojedinačnih naloga umesto kreiranja grupe.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(potrebno za proveru)</em></td><td>Kreiranje mreža, podmreža, pravila za zaštitni zid i mrežnih uređaja kao što su Cloud Router, Cloud VPN i cloud load balanceri.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(potrebno za proveru)</em></td><td>Podešavanje računa za naplatu i praćenje njihove upotrebe.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(potrebno za proveru)</em></td><td>Dizajniranje, kodiranje i testiranje aplikacija.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Ustanovljavanje i upravljanje sigurnosnim politikama za celu organizaciju, uključujući upravljanje pristupom i <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">ograničenjima organizacije</a>. Pogledajte <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">vodič za osnove sigurnosti Google Cloud-a</a> za više informacija o planiranju infrastrukture sigurnosti Google Cloud-a.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Kreiranje ili upravljanje celokupnim tokovima rada koji podržavaju kontinuiranu integraciju i isporuku, nadgledanje i obezbeđivanje sistema.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Praćenje troškova projekata. Tipični članovi su deo finansijskog tima.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregled informacija o resursima u celoj organizaciji Google Cloud-a.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregledavanje sigurnosti u oblaku.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregledavanje konfiguracija mreže.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregledavanje evidencija audita.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(više nije podrazumevano)</em></td><td>Upravljanje Security Command Center-om.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(više nije podrazumevano)</em></td><td>Upravljanje tajnama u Secret Manager-u.</td></tr></tbody></table>

## **Podrazumevana politika lozinki**

* Zahtevajte jake lozinke
* Između 8 i 100 karaktera
* Bez ponovne upotrebe
* Bez isteka
* Ako ljudi pristupaju Workspace-u putem provajdera treće strane, ovi zahtevi se ne primenjuju.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Servisni nalozi**

Ovo su principali koji mogu biti **pridruženi** **resursima** i omogućavaju im jednostavan pristup i interakciju sa GCP-om. Na primer, moguće je pristupiti **autentičnom tokenu** servisnog naloga **pridruženog virtuelnoj mašini** u metapodacima.\
Moguće je naići na **sukobe** prilikom korišćenja IAM uloga i opsega pristupa. Na primer, vaš servisni nalog može imati IAM ulogu `compute.instanceAdmin`, ali instanca koju ste prekršili ima ograničenje opsega `https://www.googleapis.com/auth/compute.readonly`. To bi vam onemogućilo da vršite bilo kakve promene koristeći OAuth token koji je automatski dodeljen vašoj instanci.

Slično je IAM ulogama u AWS-u. Ali, za razliku od AWS-a, **bilo koji** servisni nalog može biti **pridružen bilo kojoj usluzi** (ne mora biti dozvoljeno putem politike).

Neki od servisnih naloga koje ćete pronaći su zapravo **automatski generisani od strane GCP-a** kada počnete koristiti uslugu, kao što su:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Međutim, takođe je moguće kreirati i povezati **prilagođene servisne naloge** sa resursima, koji će izgledati ovako:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Pristupni opsezi**

Pristupni opsezi su **dodijeljeni OAuth tokenima** kako bi se pristupilo GCP API endpointima. Oni **ograničavaju dozvole** OAuth tokena.\
To znači da ako token pripada vlasniku resursa, ali nema pristupni opseg za pristup tom resursu, token **ne može se koristiti za zloupotrebu tih privilegija**.

Google zapravo [preporučuje](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) da se **ne koriste pristupni opsezi i da se potpuno oslanjaju na IAM**. Web upravljačka ploča zapravo to provodi, ali pristupni opsezi se i dalje mogu primijeniti na instance koristeći prilagođene servisne račune programski.

Možete vidjeti koje **opsege** su **dodijeljeni** tako da **upitate:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Prethodni **opsezi** su generisani **podrazumevano** korišćenjem **`gcloud`** za pristup podacima. To je zato što kada koristite **`gcloud`** prvo kreirate OAuth token, a zatim ga koristite za kontaktiranje krajnjih tačaka.

Najvažniji opseg od tih potencijalno je **`cloud-platform`**, što u osnovi znači da je moguće **pristupiti bilo kojoj usluzi u GCP**.

Možete **pronaći listu** [**svih mogućih opsega ovde**](https://developers.google.com/identity/protocols/googlescopes)**.**

Ako imate **gcloud** kredencijale za pretraživač, moguće je **dobiti token sa drugim opsezima**, tako što ćete uraditi nešto kao:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM politike, veze i članstva**

Kako je definisano od strane terraforma u [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam), korišćenjem terraforma sa GCP postoje različiti načini da se dodeli pristup principalu nad resursom:

* **Članstva**: Postavljate **principale kao članove uloga** **bez ograničenja** nad ulogom ili principale. Možete postaviti korisnika kao člana uloge, a zatim postaviti grupu kao člana iste uloge i takođe postaviti te principe (korisnika i grupu) kao članove drugih uloga.
* **Veze**: Više **principala može biti vezano za ulogu**. Ti **principali i dalje mogu biti vezani ili biti članovi drugih uloga**. Međutim, ako se princip koji nije vezan za ulogu postavi kao **član vezane uloge**, sledeći put kada se **veza primeni, članstvo će nestati**.
* **Politike**: Politika je **autoritativna**, ona definiše uloge i principe, a zatim, **ti principi ne mogu imati više uloga, a te uloge ne mogu imati više principala** osim ako se ta politika ne izmeni (čak ni u drugim politikama, vezama ili članstvima). Dakle, kada se uloga ili princip navedu u politici, sva njihova ovlašćenja su **ograničena tom politikom**. Očigledno, ovo se može zaobići ako se principu omogući izmena politike ili privilegije eskalacije (kao što je kreiranje novog principa i vezivanje mu nove uloge).

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini da podržite HackTricks:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
