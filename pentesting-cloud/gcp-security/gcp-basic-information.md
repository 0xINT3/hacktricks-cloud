# GCP - Informazioni di base

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## **Gerarchia delle risorse**

Google Cloud utilizza una [Gerarchia delle risorse](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) che √® simile, concettualmente, a quella di un filesystem tradizionale. Ci√≤ fornisce un flusso di lavoro logico padre/figlio con punti di attacco specifici per le politiche e le autorizzazioni.

A livello generale, appare cos√¨:
```
Organization
--> Folders
--> Projects
--> Resources
```
Una macchina virtuale (chiamata istanza di calcolo) √® una risorsa. Una risorsa risiede in un progetto, probabilmente insieme ad altre istanze di calcolo, bucket di archiviazione, ecc.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Migrazione dei progetti**

√à possibile **migrare un progetto senza alcuna organizzazione** in un'organizzazione con i permessi `roles/resourcemanager.projectCreator` e `roles/resourcemanager.projectMover`. Se il progetto √® all'interno di un'altra organizzazione, √® necessario contattare il supporto di GCP per **spostarli fuori dall'organizzazione prima**. Per ulteriori informazioni, consulta [**questo**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Politiche dell'organizzazione**

Consentono di centralizzare il controllo sulle risorse cloud dell'organizzazione:

* Centralizza il controllo per **configurare restrizioni** su come le risorse dell'organizzazione possono essere utilizzate.
* Definire ed istituire **vincoli** per i team di sviluppo per rimanere all'interno dei limiti di conformit√†.
* Aiutare i proprietari dei progetti e i loro team a muoversi rapidamente senza preoccuparsi di violare la conformit√†.

Queste politiche possono essere create per **influenzare l'intera organizzazione, le cartelle o i progetti**. I discendenti del nodo gerarchico delle risorse mirate **ereditano la politica dell'organizzazione**.

Per **definire** una politica dell'organizzazione, **si sceglie un** [**vincolo**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), che √® un particolare tipo di restrizione nei confronti di un servizio Google Cloud o di un gruppo di servizi Google Cloud. Si **configura tale vincolo con le restrizioni desiderate**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Casi d'uso comuni <a href="#common_use_cases" id="common_use_cases"></a>

* Limitare la condivisione delle risorse in base al dominio.
* Limitare l'uso degli account di servizio di Identity and Access Management.
* Limitare la posizione fisica delle risorse appena create.
* Disabilitare la creazione di account di servizio.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Ci sono molti altri vincoli che offrono un controllo dettagliato delle risorse dell'organizzazione. Per **ulteriori informazioni, consulta l'elenco di tutti i vincoli del servizio Politiche dell'organizzazione**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Politiche predefinite dell'organizzazione**

<details>

<summary>Queste sono le politiche che Google aggiunger√† per impostazione predefinita durante la configurazione dell'organizzazione GCP:</summary>

**Politiche di gestione degli accessi**

* **Contatti limitati al dominio:** Impedisce l'aggiunta di utenti a Contatti essenziali al di fuori dei domini specificati. Ci√≤ limita i Contatti essenziali a consentire solo identit√† utente gestite nei domini selezionati per ricevere notifiche della piattaforma.
* **Condivisione limitata al dominio:** Impedisce l'aggiunta di utenti alle politiche IAM al di fuori dei domini specificati. Ci√≤ limita le politiche IAM a consentire solo identit√† utente gestite nei domini selezionati per accedere alle risorse all'interno di questa organizzazione.
* **Prevenzione dell'accesso pubblico:** Impedisce l'esposizione dei bucket di Cloud Storage al pubblico. Ci√≤ garantisce che un sviluppatore non possa configurare i bucket di Cloud Storage per avere accesso a Internet non autenticato.
* **Accesso uniforme a livello di bucket:** Impedisce i controlli degli accessi a livello di oggetto (ACL) nei bucket di Cloud Storage. Ci√≤ semplifica la gestione degli accessi applicando in modo coerente le politiche IAM a tutti gli oggetti nei bucket di Cloud Storage.
* **Richiedi l'accesso tramite OS login:** Le VM create in nuovi progetti avranno OS Login abilitato. Ci√≤ consente di gestire l'accesso SSH alle istanze utilizzando IAM senza la necessit√† di creare e gestire chiavi SSH individuali.

**Politiche di sicurezza aggiuntive per gli account di servizio**

* **Disabilita le concessioni IAM automatiche**: Impedisce che gli account di servizio predefiniti di App Engine e Compute Engine vengano automaticamente concessi il ruolo IAM Editor su un progetto alla creazione. Ci√≤ garantisce che gli account di servizio non ricevano ruoli IAM eccessivamente permissivi alla creazione.
* **Disabilita la creazione di chiavi degli account di servizio**: Impedisce la creazione di chiavi pubbliche degli account di servizio. Ci√≤ contribuisce a ridurre il rischio di esposizione di credenziali persistenti.
* **Disabilita il caricamento di chiavi degli account di servizio**: Impedisce il caricamento di chiavi pubbliche degli account di servizio. Ci√≤ contribuisce a ridurre il rischio di materiale chiave divulgato o riutilizzato.

**Politiche di configurazione della rete VPC sicura**

* **Definisci gli indirizzi IP esterni consentiti per le istanze VM**: Impedisce la creazione di istanze di calcolo con un indirizzo IP pubblico, che potrebbe esporle al traffico Internet.

<!---->

* **Disabilita la virtualizzazione nidificata delle VM**: Impedisce la creazione di VM nidificate su VM di Compute Engine. Ci√≤ riduce il rischio di sicurezza derivante dalla presenza di VM nidificate non monitorate.

<!---->

* **Disabilita la porta seriale delle VM:** Impedisce l'accesso alla porta seriale delle VM di Compute Engine. Ci√≤ impedisce l'input alla porta seriale di un server utilizzando l'API di Compute Engine.

<!---->

* **Limita le reti autorizzate sulle istanze di Cloud SQL:** Impedisce a intervalli di rete pubblici o non interni di accedere ai database di Cloud SQL.

<!---->

* **Limita l'inoltro del protocollo in base al tipo di indirizzo IP:** Impedisce l'inoltro del protocollo VM per gli indirizzi IP esterni.

<!---->

* **Limita l'accesso IP pubblico alle istanze di Cloud SQL:** Impedisce la creazione di istanze di Cloud SQL con un indirizzo IP pubblico, che potrebbe esporle al traffico Internet.

<!---->

* **Limita la rimozione del progetto lien condiviso VPC:** Impedisce l'eliminazione accidentale dei progetti host VPC condivisi.

<!---->

* **Imposta l'impostazione DNS interna per i nuovi progetti solo su DNS zonale:** Impedisce l'utilizzo di un'impostazione DNS legacy che ha una disponibilit√† di servizio ridotta.

<!---->

* **Salta la creazione della rete predefinita:** Impedisce la creazione automatica della rete VPC predefinita e delle risorse correlate. Ci√≤ evita regole del firewall predefinite eccessivamente permissive.

<!---->

* **Disabilita l'utilizzo di IPv6 esterno VPC:** Impedisce la creazione di subnet IPv6 esterne, che possono essere esposte a un accesso Internet non autorizzato.

</details>

## **Ruoli IAM**

Sono simili alle politiche IAM in AWS poich√© **ogni ruolo contiene un insieme di autorizzazioni**.

Tuttavia, a differenza di AWS, non esiste un **repository centralizzato** di ruoli. Invece, **le risorse assegnano ruoli di accesso X a principi Y**, e l'unico modo per scoprire chi ha accesso a una risorsa √® utilizzare il **metodo `get-iam-policy` su quella risorsa**.\
Questo potrebbe essere un problema perch√© ci√≤ significa che l'unico modo per scoprire **quali autorizzazioni ha un principio √® chiedere a ogni risorsa a chi sta concedendo autorizzazioni**, e un utente potrebbe non avere le autorizzazioni per ottenere le autorizzazioni da tutte le risorse.

Ci sono **tre tipi** di ruoli in IAM:

* **Ruoli di base/primitivi**, che includono i ruoli **Proprietario**, **Editor** e **Visualizzatore** che esistevano prima dell'introduzione di IAM.
* **Ruoli predefiniti**, che forniscono un accesso granulare per un servizio specifico e sono gestiti da Google Cloud. Ci sono molti ruoli predefiniti, puoi **vedere tutti loro con i privilegi che hanno** [**qui**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Ruoli personalizzati**, che forniscono un accesso granulare in base a un elenco di autorizzazioni specificato dall'utente.

Ci sono migliaia di autorizzazioni in GCP. Per verificare se un ruolo ha un'autorizzazione, puoi [**cercare l'autorizzazione qui**](https://cloud.google.com/iam/docs
## Utenti <a href="#default-credentials" id="default-credentials"></a>

Nella **console GCP** non c'√® alcuna gestione degli **Utenti o dei Gruppi**, che viene invece effettuata in **Google Workspace**. Tuttavia, √® possibile sincronizzare un provider di identit√† diverso in Google Workspace.

√à possibile accedere agli **utenti e ai gruppi di Workspace** su [**https://admin.google.com**](https://admin.google.com/).

L'**MFA** pu√≤ essere **forzato** agli utenti di Workspace, tuttavia, un **attaccante** potrebbe utilizzare un token per accedere a GCP **tramite CLI senza protezione MFA** (sar√† protetto da MFA solo quando l'utente effettua l'accesso per generarlo: `gcloud auth login`).

## Gruppi

Quando viene creata un'organizzazione, √® **fortemente consigliato creare diversi gruppi**. Se si gestisce uno di questi gruppi, potrebbe essere compromessa l'intera organizzazione o una parte importante di essa:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Gruppo</strong></td><td><strong>Funzione</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(account di gruppo o individuali richiesti per la checklist)</em></td><td>Amministrazione di qualsiasi risorsa che appartiene all'organizzazione. Assegna questo ruolo con parsimonia; gli amministratori dell'organizzazione hanno accesso a tutte le risorse di Google Cloud. In alternativa, considera l'utilizzo di account individuali anzich√© creare un gruppo, poich√© questa funzione √® altamente privilegiata.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(richiesto per la checklist)</em></td><td>Creazione di reti, subnet, regole del firewall e dispositivi di rete come Cloud Router, Cloud VPN e bilanciatori di carico cloud.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(richiesto per la checklist)</em></td><td>Configurazione dei conti di fatturazione e monitoraggio del loro utilizzo.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(richiesto per la checklist)</em></td><td>Progettazione, codifica e test di applicazioni.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Stabilire e gestire le politiche di sicurezza per l'intera organizzazione, inclusa la gestione degli accessi e delle <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">politiche di vincolo dell'organizzazione</a>. Consulta la <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">guida alle fondamenta della sicurezza di Google Cloud</a> per ulteriori informazioni sulla pianificazione dell'infrastruttura di sicurezza di Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Creazione o gestione di pipeline end-to-end che supportano l'integrazione e la distribuzione continue, il monitoraggio e la fornitura di sistema.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Monitoraggio delle spese dei progetti. I membri tipici fanno parte del team finanziario.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Revisione delle informazioni sulle risorse in tutta l'organizzazione di Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(non pi√π di default)</em></td><td>Revisione della sicurezza cloud.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Revisione delle configurazioni di rete.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(non pi√π di default)</em></td><td>Visualizzazione dei log di audit.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(non pi√π di default)</em></td><td>Amministrazione di Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(non pi√π di default)</em></td><td>Gestione dei segreti in Secret Manager.</td></tr></tbody></table>

## **Politica predefinita delle password**

* Impone password forti
* Tra 8 e 100 caratteri
* Nessun riutilizzo
* Nessuna scadenza
* Se le persone accedono a Workspace tramite un provider di terze parti, questi requisiti non vengono applicati.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Account di servizio**

Questi sono i principali che **le risorse** possono **avere** **associati** per accedere e interagire facilmente con GCP. Ad esempio, √® possibile accedere al **token di autenticazione** di un account di servizio **associato a una VM** nei metadati.\
√à possibile incontrare alcuni **conflitti** quando si utilizzano sia **IAM che access scopes**. Ad esempio, il tuo account di servizio potrebbe avere il ruolo IAM di `compute.instanceAdmin`, ma l'istanza che hai compromesso √® stata limitata con la restrizione di ambito `https://www.googleapis.com/auth/compute.readonly`. Ci√≤ impedirebbe di apportare modifiche utilizzando il token OAuth assegnato automaticamente all'istanza.

√à simile ai **ruoli IAM di AWS**. Ma a differenza di AWS, **qualsiasi** account di servizio pu√≤ essere **associato a qualsiasi servizio** (non √® necessario consentirlo tramite una policy).

Molti degli account di servizio che troverai sono in realt√† **generati automaticamente da GCP** quando inizi a utilizzare un servizio, come:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Tuttavia, √® anche possibile creare e collegarsi a risorse **account di servizio personalizzati**, che avranno questo aspetto:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Ambiti di accesso**

Gli ambiti di accesso sono **associati ai token OAuth generati** per accedere ai punti di API di GCP. Essi **limitano i permessi** del token OAuth.\
Ci√≤ significa che se un token appartiene a un Proprietario di una risorsa ma non ha l'ambito nel token per accedere a quella risorsa, il token **non pu√≤ essere utilizzato per (ab)usare quei privilegi**.

Google [raccomanda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) effettivamente di **non utilizzare gli ambiti di accesso e di fare affidamento completamente su IAM**. Il portale di gestione web effettivamente applica questa regola, ma gli ambiti di accesso possono comunque essere applicati alle istanze utilizzando account di servizio personalizzati in modo programmato.

√à possibile vedere quali **ambiti** sono **assegnati** effettuando una **query:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Gli **ambiti** precedenti sono quelli generati **per impostazione predefinita** utilizzando **`gcloud`** per accedere ai dati. Ci√≤ avviene perch√© quando si utilizza **`gcloud`** si crea prima un token OAuth e poi lo si utilizza per contattare i punti di accesso.

L'ambito pi√π importante tra questi potenzialmente √® **`cloud-platform`**, che significa essenzialmente che √® possibile **accedere a qualsiasi servizio in GCP**.

√à possibile **trovare un elenco di** [**tutti gli ambiti possibili qui**](https://developers.google.com/identity/protocols/googlescopes)**.**

Se si dispone di credenziali del browser **`gcloud`**, √® possibile **ottenere un token con altri ambiti**, facendo qualcosa del genere:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Policies, Bindings and Memberships**

Come definito da terraform in [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) utilizzando terraform con GCP ci sono diversi modi per concedere l'accesso a un principale su una risorsa:

* **Membri**: Imposti **principali come membri di ruoli** **senza restrizioni** sul ruolo o sui principali. Puoi mettere un utente come membro di un ruolo e poi mettere un gruppo come membro dello stesso ruolo e anche impostare quei principali (utente e gruppo) come membri di altri ruoli.
* **Bindings**: Diversi **principali possono essere associati a un ruolo**. Quei **principali possono ancora essere associati o essere membri di altri ruoli**. Tuttavia, se un principale che non √® associato al ruolo viene impostato come **membro di un ruolo associato**, la prossima volta che **viene applicato il binding, l'appartenenza scomparir√†**.
* **Policies**: Una policy √® **autorevole**, indica ruoli e principali e quindi, **quei principali non possono avere pi√π ruoli e quei ruoli non possono avere pi√π principali** a meno che quella policy non venga modificata (neanche in altre policy, bindings o membri). Pertanto, quando un ruolo o un principale viene specificato nella policy, tutti i suoi privilegi sono **limitati da quella policy**. Ovviamente, questo pu√≤ essere bypassato nel caso in cui al principale venga data l'opzione di modificare la policy o i permessi di escalation dei privilegi (come creare un nuovo principale e associargli un nuovo ruolo).

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
