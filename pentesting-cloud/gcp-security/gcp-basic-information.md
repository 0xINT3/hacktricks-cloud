# GCP - Informa√ß√µes B√°sicas

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## **Hierarquia de recursos**

O Google Cloud usa uma [Hierarquia de recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que √© semelhante, conceitualmente, √† de um sistema de arquivos tradicional. Isso fornece um fluxo de trabalho l√≥gico pai/filho com pontos de anexa√ß√£o espec√≠ficos para pol√≠ticas e permiss√µes.

Em alto n√≠vel, parece com isso:

```
Organiza√ß√£o
--> Pastas
  --> Projetos
    --> Recursos
```

Uma m√°quina virtual (chamada de Inst√¢ncia de Computa√ß√£o) √© um recurso. Um recurso reside em um projeto, provavelmente ao lado de outras Inst√¢ncias de Computa√ß√£o, buckets de armazenamento, etc.

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

## **Migra√ß√£o de projetos**

√â poss√≠vel **migrar um projeto sem nenhuma organiza√ß√£o** para uma organiza√ß√£o com as permiss√µes `roles/resourcemanager.projectCreator` e `roles/resourcemanager.projectMover`. Se o projeto estiver dentro de outra organiza√ß√£o, √© necess√°rio entrar em contato com o suporte do GCP para **mov√™-los para fora da organiza√ß√£o primeiro**. Para mais informa√ß√µes, consulte [**este**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Pol√≠ticas de Organiza√ß√£o**

Permitem centralizar o controle sobre os recursos de nuvem da sua organiza√ß√£o:

* Centralize o controle para **configurar restri√ß√µes** sobre como os recursos da sua organiza√ß√£o podem ser usados.
* Defina e estabele√ßa **guardrails** para que as equipes de desenvolvimento permane√ßam dentro dos limites de conformidade.
* Ajude os propriet√°rios de projetos e suas equipes a se moverem rapidamente sem se preocupar em violar a conformidade.

Essas pol√≠ticas podem ser criadas para **afetar a organiza√ß√£o completa, pasta(s) ou projeto(s)**. Os descendentes do n√≥ hier√°rquico de recursos direcionado **herdam a pol√≠tica da organiza√ß√£o**.

Para **definir** uma pol√≠tica de organiza√ß√£o, **voc√™ escolhe uma** [**restri√ß√£o**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que √© um tipo particular de restri√ß√£o contra um servi√ßo do Google Cloud ou um grupo de servi√ßos do Google Cloud. Voc√™ **configura essa restri√ß√£o com as restri√ß√µes desejadas**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Casos de uso comuns <a href="#common_use_cases" id="common_use_cases"></a>

* Limitar o compartilhamento de recursos com base no dom√≠nio.
* Limitar o uso de contas de servi√ßo de gerenciamento de identidade e acesso.
* Restringir a localiza√ß√£o f√≠sica dos recursos rec√©m-criados.
* Desativar a cria√ß√£o de contas de servi√ßo.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Existem muitas outras restri√ß√µes que d√£o a voc√™ controle refinado sobre os recursos da sua organiza√ß√£o. Para **mais informa√ß√µes, consulte a** [**lista de todas as restri√ß√µes do servi√ßo de pol√≠tica de organiza√ß√£o**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

## **Fun√ß√µes do IAM**

Essas s√£o como pol√≠ticas do IAM na AWS, pois **cada fun√ß√£o cont√©m um conjunto de permiss√µes**.

No entanto, ao contr√°rio da AWS, n√£o h√° um **reposit√≥rio centralizado** de fun√ß√µes. Em vez disso, **os recursos d√£o fun√ß√µes de acesso X a princ√≠pios Y**, e a √∫nica maneira de descobrir quem tem acesso a um recurso √© usar o **m√©todo `get-iam-policy` sobre esse recurso**.\
Isso pode ser um problema porque isso significa que a √∫nica maneira de descobrir **quais permiss√µes um princ√≠pio tem √© perguntar a cada recurso a quem ele est√° dando permiss√µes**, e um usu√°rio pode n√£o ter permiss√µes para obter permiss√µes de todos os recursos.

Existem **tr√™s tipos** de fun√ß√µes no IAM:

* **Fun√ß√µes b√°sicas/primitivas**, que incluem as fun√ß√µes de **Propriet√°rio**, **Editor** e **Visualizador** que existiam antes da introdu
### **Escopos de acesso**

Os escopos de acesso s√£o **anexados a tokens OAuth gerados** para acessar os pontos de extremidade da API do GCP. Eles **restringem as permiss√µes** do token OAuth.\
Isso significa que, se um token pertencer a um propriet√°rio de um recurso, mas n√£o tiver o escopo no token para acessar esse recurso, o token **n√£o poder√° ser usado para (abusar) desses privil√©gios**.

O Google, na verdade, [recomenda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) que **os escopos de acesso n√£o sejam usados e que se confie totalmente no IAM**. O portal de gerenciamento da web realmente imp√µe isso, mas os escopos de acesso ainda podem ser aplicados a inst√¢ncias usando contas de servi√ßo personalizadas programaticamente.

Voc√™ pode ver quais **escopos** est√£o **atribu√≠dos** **consultando:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
  "issued_to": "223044615559.apps.googleusercontent.com",
  "audience": "223044615559.apps.googleusercontent.com",
  "user_id": "139746512919298469201",
  "scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
  "expires_in": 2253,
  "email": "username@testing.com",
  "verified_email": true,
  "access_type": "offline"
}
```
{% endcode %}

Os **escopos** anteriores s√£o os gerados **por padr√£o** usando **`gcloud`** para acessar dados. Isso ocorre porque, quando voc√™ usa **`gcloud`**, primeiro cria um token OAuth e, em seguida, o usa para entrar em contato com os pontos de extremidade.

O escopo mais importante desses potencialmente √© **`cloud-platform`**, o que basicamente significa que √© poss√≠vel **acessar qualquer servi√ßo no GCP**.

Voc√™ pode **encontrar uma lista de** [**todos os escopos poss√≠veis aqui**](https://developers.google.com/identity/protocols/googlescopes)**.**

Se voc√™ tiver credenciais do navegador **`gcloud`**, √© poss√≠vel **obter um token com outros escopos**, fazendo algo como:

{% code overflow="wrap" %}
```bash
# Talvez voc√™ possa obter um token de usu√°rio com outros escopos alterando a matriz de escopos de ~/.config/gcloud/credentials.db

# Definir novos escopos para as credenciais do SDK
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Imprimir novo token
gcloud auth application-default print-access-token

# Para usar este token com alguma API, voc√™ pode precisar usar o curl para indicar o cabe√ßalho do projeto com --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Pol√≠ticas IAM do Terraform, Vincula√ß√µes e Associa√ß√µes**

Conforme definido pelo terraform em [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam), usando o terraform com o GCP, existem diferentes maneiras de conceder acesso a um principal sobre um recurso:

* **Associa√ß√µes**: V√°rios **principais podem ser vinculados a uma fun√ß√£o**. Esses **principais ainda podem ser vinculados ou ser membros de outras fun√ß√µes**. No entanto, se um principal que n√£o est√° vinculado √† fun√ß√£o for definido como **membro de uma fun√ß√£o vinculada**, na pr√≥xima vez que a **vincula√ß√£o for aplicada, a associa√ß√£o desaparecer√°**.
* **Membros**: Voc√™ define **principais como membros de fun√ß√µes sem restri√ß√µes** sobre a fun√ß√£o ou os principais. Voc√™ pode colocar um usu√°rio como membro de uma fun√ß√£o e, em seguida, colocar um grupo como membro da mesma fun√ß√£o e tamb√©m definir esses principais (usu√°rio e grupo) como membros de outras fun√ß√µes.
* **Pol√≠ticas**: Uma pol√≠tica √© **autorit√°ria**, indica fun√ß√µes e principais e, em seguida, **esses principais n√£o podem ter mais fun√ß√µes e essas fun√ß√µes n√£o podem ter mais principais** a menos que essa pol√≠tica seja modificada (nem mesmo em outras pol√≠ticas, vincula√ß√µes ou associa√ß√µes). Portanto, quando uma fun√ß√£o ou principal √© especificado na pol√≠tica, todos os seus privil√©gios s√£o **limitados por essa pol√≠tica**. Obviamente, isso pode ser contornado no caso em que o principal √© dado a op√ß√£o de modificar a pol√≠tica ou as permiss√µes de escalonamento de privil√©gios (como criar um novo principal e vincul√°-lo a uma nova fun√ß√£o).

## Refer√™ncias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>