# GCP - Basiese Inligting

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## **Hulpbronhi√´rargie**

Google Cloud maak gebruik van 'n [Hulpbronhi√´rargie](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) wat konseptueel soortgelyk is aan di√© van 'n tradisionele l√™ersisteem. Dit bied 'n logiese ouer/kind-werkvloei met spesifieke aanhegtingspunte vir beleide en toestemmings.

Op 'n ho√´ vlak lyk dit soos volg:
```
Organization
--> Folders
--> Projects
--> Resources
```
'n Virtuele masjien (genoem 'n Rekeningsinstansie) is 'n hulpbron. 'n Hulpbron bly in 'n projek, waarskynlik saam met ander Rekeningsinstansies, bergingsemmers, ens.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Projeksmigrasie

Dit is moontlik om 'n projek sonder enige organisasie na 'n organisasie te migreer met die toestemmings `roles/resourcemanager.projectCreator` en `roles/resourcemanager.projectMover`. As die projek binne 'n ander organisasie is, moet GCP-ondersteuning gekontak word om hulle eers uit die organisasie te skuif. Vir meer inligting, sien [hierdie](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## Organisasiebeleide

Maak dit moontlik om beheer oor jou organisasie se wolkhulpbronne te sentraliseer:

* Sentraliseer beheer om beperkings te **konfigureer** oor hoe jou organisasie se hulpbronne gebruik kan word.
* Definieer en stel **riglyne** vas vir jou ontwikkelingsteams om binne die nakomingsgrense te bly.
* Help projek-eienaars en hul spanne om vinnig te beweeg sonder om oor nakoming te bekommer.

Hierdie beleide kan geskep word om die hele organisasie, vouer(s) of projek(te) te **be√Ønvloed**. Nageslagte van die geteikende hulpbronhi√´rargienode **erf die organisasiebeleid**.

Om 'n organisasiebeleid te **definieer**, kies jy 'n [beperking](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), wat 'n spesifieke tipe beperking teenoor 'n Google Cloud-diens of 'n groep Google Cloud-dienste is. Jy **konfigureer daardie beperking met jou gewenste beperkings**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Algemene gebruike <a href="#common_use_cases" id="common_use_cases"></a>

* Beperk hulpbron-deling gebaseer op domein.
* Beperk die gebruik van Identiteit en Toegangsbestuur-diensrekeninge.
* Beperk die fisiese ligging van nuut geskepte hulpbronne.
* Deaktiveer die skepping van diensrekeninge.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Daar is baie meer beperkings wat jou fynkontrole oor jou organisasie se hulpbronne gee. Vir **meer inligting, sien die** [**lys van alle Organisasiebeleiddiensbeperkings**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### Standaard Organisasiebeleide

<details>

<summary>Dit is die beleide wat Google standaard sal byvoeg wanneer jou GCP-organisasie opgestel word:</summary>

**Toegangsbestuursbeleide**

* **Domeinbeperkte kontakte:** Voorkom die byvoeging van gebruikers by Essensi√´le Kontakte buite jou gespesifiseerde domeine. Dit beperk Essensi√´le Kontakte om slegs bestuurde gebruikersidentiteite in jou geselekteerde domeine toe te laat om platformkennisgewings te ontvang.
* **Domeinbeperkte deling:** Voorkom die byvoeging van gebruikers by IAM-beleide buite jou gespesifiseerde domeine. Dit beperk IAM-beleide om slegs bestuurde gebruikersidentiteite in jou geselekteerde domeine toe te laat om toegang tot hulpbronne binne hierdie organisasie te verkry.
* **Voorkoming van openbare toegang:** Voorkom dat Cloud Storage-emmers aan die publiek blootgestel word. Dit verseker dat 'n ontwikkelaar nie Cloud Storage-emmers kan konfigureer om ongeagte internettoegang te h√™ nie.
* **Gelykwaardige emmervlaktoegang:** Voorkom dat voorwerpvlak-toegangsbeheerlyste (ACL's) in Cloud Storage-emmers gebruik word. Dit vereenvoudig jou toegangsbestuur deur IAM-beleide konsekwent toe te pas op alle voorwerpe in Cloud Storage-emmers.
* **Vereis OS-aanmelding:** VM's wat in nuwe projekte geskep word, sal OS-aanmelding geaktiveer h√™. Dit stel jou in staat om SSH-toegang tot jou instansies te bestuur deur gebruik te maak van IAM sonder om individuele SSH-sleutels te skep en bestuur.

**Addisionele sekuriteitsbeleide vir diensrekeninge**

* **Deaktiveer outomatiese IAM-toekennings**: Voorkom dat die verstek App Engine- en Compute Engine-diensrekeninge outomaties die Redakteur IAM-rol op 'n projek by skepping ontvang. Dit verseker dat diensrekeninge nie oormatig toegewingsbevoegde IAM-rolle by skepping ontvang nie.
* **Deaktiveer die skepping van diensrekeningsleutels**: Voorkom die skepping van openbare diensrekeningsleutels. Dit help om die risiko van blootstelling van volgehoue geloofsbriewe te verminder.
* **Deaktiveer die oplaai van diensrekeningsleutels**: Voorkom die oplaai van openbare diensrekeningsleutels. Dit help om die risiko van uitgelek of hergebruikte sleutelmateriaal te verminder.

**Veilige VPC-netwerkkonfigurasiebeleide**

* **Definieer toegelate eksterne IP's vir VM-instances**: Voorkom die skepping van Rekeningsinstansies met 'n openbare IP, wat hulle blootstel aan internetverkeer.

<!---->

* **Deaktiveer geneste virtuele masjien**: Voorkom die skepping van geneste VM's op Compute Engine VM's. Dit verminder die veiligheidsrisiko van ongemonitorde geneste VM's.

<!---->

* **Deaktiveer VM-serialpoort:** Voorkom seri√´le poorttoegang tot Compute Engine VM's. Dit voorkom insette na 'n bediener se seri√´le poort deur gebruik te maak van die Compute Engine API.

<!---->

* **Beperk gemagtigde netwerke op Cloud SQL-instanties**: Voorkom dat openbare of nie-interne netwerkreikwydtes toegang tot jou Cloud SQL-databasisse verkry.

<!---->

* **Beperk protokolstuur op basis van die tipe IP-adres**: Voorkom VM-protokolstuur vir eksterne IP-adresse.

<!---->

* **Beperk openbare IP-toegang op Cloud SQL-instanties**: Voorkom die skepping van Cloud SQL-instanties met 'n openbare IP, wat hulle blootstel aan internetverkeer.

<!---->

* **Beperk die verwydering van gedeelde VPC-projeklien**: Voorkom die toevallige verwydering van gedeelde VPC-gashouerprojekte.

<!---->

* **Stel die interne DNS-instelling vir nuwe projekte in op Sone DNS Slegs**: Voorkom die gebruik van 'n verouderde DNS-instelling wat verminderde diensbeskikbaarheid het.

<!---->

* **Slaan die skepping van die versteknetwerk oor**: Voorkom outomatiese skepping van die verstek VPC-netwerk en verwante hulpbronne. Dit vermy oormatig toegewingsbevoegde verstek-vuurmuur-re√´ls.

<!---->

* **Deaktiveer VPC-eksterne IPv6-gebruik**: Voorkom die skepping van eksterne IPv6-subnetwerke, wat aan ongemagtigde internettoegang blootgestel kan word.

</details>

## IAM-rolle

Dit is soos IAM-beleide in AWS, aangesien **elke rol 'n stel toestemmings bevat**.

Maar anders as in AWS, is daar **geen gesentraliseerde bewaarplek** van rolle nie. In plaas daarvan **gee hulpbronne X-toegangsrolle aan Y-beginsels**, en die enigste manier om uit te vind wie toegang tot 'n hulpbron het, is om die **`get-iam-policy`-metode oor daardie hulpbron** te gebruik.\
Dit kan 'n probleem wees omdat dit beteken dat die enigste manier om uit te vind **watter toestemmings 'n beginsel het, is om elke hulpbron te vra wie gee dit toestemmings**, en 'n gebruiker mag nie toestemmings h√™ om toestemmings van alle hulpbronne te verkry nie.

Daar is **drie tipes** rolle in IAM:

* **Basiese/Primitiewe rolle**,
## Gebruikers <a href="#default-credentials" id="default-credentials"></a>

In die **GCP-konsole** is daar **geen Gebruikers of Groepe** bestuur nie, dit word in **Google Workspace** gedoen. Alhoewel jy 'n ander identiteitsverskaffer in Google Workspace kan sinchroniseer.

Jy kan toegang kry tot Workspace **gebruikers en groepe** by [**https://admin.google.com**](https://admin.google.com/).

**MFA** kan aan Workspaces-gebruikers **afgedwing** word, maar 'n **aanvaller** kan 'n token gebruik om toegang tot GCP te verkry **via die opdraglyn wat nie deur MFA beskerm sal word** (dit sal slegs deur MFA beskerm word wanneer die gebruiker aanmeld om dit te genereer: `gcloud auth login`).

## Groepe

Wanneer 'n organisasie geskep word, word dit sterk aanbeveel om verskeie groepe te skep. As jy enige van hulle bestuur, kan jy die hele organisasie of 'n belangrike deel daarvan in gevaar bring:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Groep</strong></td><td><strong>Funksie</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(groep of individuele rekeninge wat vir die lys benodig word)</em></td><td>Administrasie van enige hulpbron wat aan die organisasie behoort. Ken hierdie rol spaarsamig toe; organisasie-admins het toegang tot al jou Google Cloud-hulpbronne. Oorweeg alternatiewelik om individuele rekeninge te gebruik in plaas van 'n groep, omdat hierdie funksie hoogs bevoorreg is.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(benodig vir die lys)</em></td><td>Skep van netwerke, subnette, firewall-re√´ls en netwerktoestelle soos Cloud Router, Cloud VPN en Cloud Load Balancers.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(benodig vir die lys)</em></td><td>Opstel van faktureringsrekeninge en monitering van hul gebruik.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(benodig vir die lys)</em></td><td>Ontwerp, kodering en toetsing van toepassings.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Vasstel en bestuur van sekuriteitsbeleide vir die hele organisasie, insluitend toegangsbestuur en <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">organisasiebeperkingsbeleide</a>. Sien die <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud-sekuriteitsgrondslaggids</a> vir meer inligting oor die beplanning van jou Google Cloud-sekuriteitsinfrastruktuur.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Skep of bestuur van end-to-end-pyplyne wat voortdurende integrasie en aflewering, monitering en stelselvoorsiening ondersteun.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(nie meer standaard nie)</em></td><td>Monitering van die uitgawes op projekte. Tipiese lede is deel van die finansi√´le span.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(nie meer standaard nie)</em></td><td>Oorsig van hulpbroninligting in die hele Google Cloud-organisasie.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(nie meer standaard nie)</em></td><td>Oorsig van die beveiliging van die wolk.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(nie meer standaard nie)</em></td><td>Oorsig van netwerkkonfigurasies.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(nie meer standaard nie)</em></td><td>Oorsig van ouditlogs.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(nie meer standaard nie)</em></td><td>Administrasie van Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(nie meer standaard nie)</em></td><td>Bestuur van geheime in Secret Manager.</td></tr></tbody></table>

## **Verstek Wagwoordbeleid**

* Handhaaf sterk wagwoorde
* Tussen 8 en 100 karakters
* Geen hergebruik
* Geen verval
* As mense toegang tot Workspace verkry deur 'n derde party verskaffer, word hierdie vereistes nie toegepas nie.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Diensrekeninge**

Dit is die beginsels waaraan **hulpbronne** **geheg** kan wees en toegang kan h√™ om maklik met GCP te kommunikeer. Byvoorbeeld, dit is moontlik om toegang te verkry tot die **outentiseringsleutel** van 'n Diensrekening **geheg aan 'n VM** in die metadata.\
Dit is moontlik om enkele **konflikte** te ondervind wanneer jy beide **IAM-rolle en toegangsbereike** gebruik. Byvoorbeeld, jou diensrekening kan die IAM-rol van `compute.instanceAdmin` h√™, maar die instansie wat jy oortree het, is beperk met die toegangsbereik van `https://www.googleapis.com/auth/compute.readonly`. Dit sal voorkom dat jy enige veranderinge kan maak met die OAuth-token wat outomaties aan jou instansie toegewys is.

Dit is soortgelyk aan **IAM-rolle van AWS**. Maar nie soos in AWS nie, kan **enige** diensrekening aan **enige diens geheg word** (dit hoef nie toegelaat te word deur 'n beleid nie).

Verskeie van die diensrekeninge wat jy sal vind, word eintlik **outomaties gegenereer deur GCP** wanneer jy 'n diens begin gebruik, soos:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Egter, dit is ook moontlik om **aangepaste diensrekeninge** te skep en aan hulpbronne te heg, wat soos volg sal lyk:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Toegangsbereik**

Toegangsbereik is **geheg aan gegenereerde OAuth-tokens** om toegang te verkry tot die GCP API-eindpunte. Dit **beperk die toestemmings** van die OAuth-token.\
Dit beteken dat as 'n token behoort aan 'n Eienaar van 'n hulpbron, maar nie die toegangsbereik in die token het om daardie hulpbron te benader nie, die token **nie gebruik kan word om daardie voorregte te misbruik nie**.

Google [beveel eintlik aan](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) dat **toegangsbereike nie gebruik word nie en dat daar heeltemal op IAM vertrou word**. Die webbestuursportal dwing dit eintlik af, maar toegangsbereike kan steeds deur middel van aangepaste diensrekeninge programmaties op instansies toegepas word.

U kan sien watter **bereike** is **toegewys** deur **navrae te doen:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Die vorige **scopes** is diegene wat outomaties gegenereer word deur **standaard** gebruik te maak van **`gcloud`** om toegang tot data te verkry. Dit is omdat wanneer jy **`gcloud`** gebruik, jy eers 'n OAuth-token skep en dit dan gebruik om die eindpunte te kontak.

Die belangrikste scope van daardie potensieel is **`cloud-platform`**, wat basies beteken dat dit moontlik is om **toegang tot enige diens in GCP** te verkry.

Jy kan 'n **lys van alle moontlike scopes hier vind**](https://developers.google.com/identity/protocols/googlescopes)**.

As jy **`gcloud`** blaaierlegitimasie het, is dit moontlik om 'n token met ander scopes te verkry deur iets soos die volgende te doen:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM-beleide, Bindings en Lede**

Soos gedefinieer deur terraform in [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) kan jy met terraform en GCP op verskillende maniere 'n hoof toegang gee tot 'n hulpbron:

* **Lede**: Jy stel **hoofde as lede van rolle** **sonder beperkings** oor die rol of die hoofde. Jy kan 'n gebruiker as 'n lid van 'n rol stel en dan 'n groep as 'n lid van dieselfde rol stel en ook daardie hoofde (gebruiker en groep) as lede van ander rolle stel.
* **Bindings**: Verskeie **hoofde kan aan 'n rol gebind word**. Daardie **hoofde kan steeds gebind word of lede van ander rolle wees**. As 'n hoof wat nie aan die rol gebind is nie, as **lid van 'n gebinde rol** gestel word, sal die lidmaatskap verdwyn wanneer die **binding volgende keer toegepas word**.
* **Beleide**: 'n Beleid is **gesaghebbend**, dit dui rolle en hoofde aan en dan **kan daardie hoofde nie meer rolle h√™ nie en daardie rolle kan nie meer hoofde h√™ nie**, tensy daardie beleid gewysig word (selfs nie in ander beleide, bindings of lede nie). Daarom, wanneer 'n rol of hoof in 'n beleid gespesifiseer word, is al sy voorregte **beperk deur daardie beleid**. Dit kan natuurlik omseil word as die hoof die opsie kry om die beleid te wysig of voorregverhogingsregte te verkry (soos 'n nuwe hoof skep en hom 'n nuwe rol bind).

## Verwysings

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
