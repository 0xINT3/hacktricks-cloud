# GCP - 基本情報

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングテクニックを共有する。

</details>

## **リソース階層**

Google Cloudは、従来のファイルシステムに概念的に似ている[リソース階層](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)を使用しています。これにより、ポリシーや権限の特定のアタッチメントポイントを持つ、論理的な親/子ワークフローが提供されます。

高レベルでは、次のようになります：
```
Organization
--> Folders
--> Projects
--> Resources
```
```markdown
仮想マシン（Compute Instanceと呼ばれる）はリソースです。リソースはプロジェクト内に存在し、他のCompute Instances、ストレージバケットなどと共にあります。

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **プロジェクトの移行**

組織がない状態で**プロジェクトを移行することが可能**です。そのためには、`roles/resourcemanager.projectCreator` と `roles/resourcemanager.projectMover` の権限が必要です。プロジェクトが他の組織内にある場合は、**まず組織から移動するために** GCPサポートに連絡する必要があります。詳細は[**こちら**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)を確認してください。

## **組織ポリシー**

組織のクラウドリソースに対する中央集権的な制御を可能にします：

* 組織のリソースの使用方法に**制限を設定**するための中央集権的な制御。
* 開発チームがコンプライアンスの境界内で留まるように**ガードレールを定義**して確立する。
* プロジェクトの所有者とそのチームがコンプライアンスを破る心配なく迅速に動けるように支援する。

これらのポリシーは**組織全体、フォルダ、またはプロジェクトに影響を与えるように作成**することができます。対象のリソース階層ノードの子孫は**組織ポリシーを継承します**。

組織ポリシーを**定義する**ためには、Google Cloudサービスまたは一連のGoogle Cloudサービスに対する特定の種類の制限である[**制約**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)を**選択し、望ましい制限でその制約を設定します**。

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### 一般的な使用例 <a href="#common_use_cases" id="common_use_cases"></a>

* ドメインに基づいてリソース共有を制限する。
* Identity and Access Managementサービスアカウントの使用を制限する。
* 新しく作成されるリソースの物理的な場所を制限する。
* サービスアカウントの作成を無効にする。

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

組織のリソースを細かく制御するための多くの制約があります。**詳細については**、[**すべての組織ポリシーサービス制約のリスト**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**を参照してください。**

### **デフォルトの組織ポリシー**

<details>

<summary>これらは、GCP組織の設定時にGoogleがデフォルトで追加するポリシーです：</summary>

**アクセス管理ポリシー**

* **ドメイン制限付き連絡先:** Essential Contactsに指定されたドメイン外のユーザーを追加することを防ぎます。これにより、Essential Contactsは選択したドメイン内の管理されたユーザーIDのみがプラットフォーム通知を受け取ることを許可します。
* **ドメイン制限付き共有:** IAMポリシーに指定されたドメイン外のユーザーを追加することを防ぎます。これにより、IAMポリシーは選択したドメイン内の管理されたユーザーIDのみがこの組織内のリソースにアクセスすることを許可します。
* **公開アクセスの防止:** Cloud Storageバケットが公開されることを防ぎます。これにより、開発者が認証されていないインターネットアクセスを持つようにCloud Storageバケットを設定することができなくなります。
* **Uniform bucket level access:** Cloud Storageバケット内のオブジェクトレベルのアクセス制御リスト（ACL）を防ぎます。これにより、Cloud Storageバケット内のすべてのオブジェクトに対して一貫してIAMポリシーを適用することでアクセス管理を簡素化します。
* **OSログインを要求:** 新しいプロジェクトで作成されたVMにはOSログインが有効になります。これにより、個々のSSHキーを作成および管理することなく、IAMを使用してインスタンスへのSSHアクセスを管理できます。

**サービスアカウントに対する追加のセキュリティポリシー**

* **自動IAM付与の無効化**: App EngineおよびCompute Engineのデフォルトサービスアカウントが、プロジェクト作成時に自動的にEditor IAMロールを付与されることを防ぎます。これにより、サービスアカウントが作成時に過度に許可されたIAMロールを受け取ることがありません。
* **サービスアカウントキーの作成を無効にする**: 公開サービスアカウントキーの作成を防ぎます。これにより、永続的な資格情報が露出するリスクを減らすことができます。
* **サービスアカウントキーのアップロードを無効にする**: 公開サービスアカウントキーのアップロードを防ぎます。これにより、漏洩したり再利用されたりするキーマテリアルのリスクを減らすことができます。

**セキュアなVPCネットワーク構成ポリシー**

* **VMインスタンスに対する許可された外部IPを定義する**: 公開IPを持つComputeインスタンスの作成を防ぎます。これにより、インターネットトラフィックにさらされることを防ぎます。

<!---->

* **VMネスト仮想化を無効にする**: Compute Engine VM上でネストされたVMの作成を防ぎます。これにより、監視されていないネストされたVMのセキュリティリスクを減らすことができます。

<!---->

* **VMシリアルポートを無効にする:** Compute Engine VMへのシリアルポートアクセスを防ぎます。これにより、Compute Engine APIを使用してサーバーのシリアルポートへの入力を防ぐことができます。

<!---->

* **Cloud SQLインスタンスへの承認されたネットワークを制限する:** Cloud SQLデータベースへの公開または非内部ネットワーク範囲からのアクセスを防ぎます。

<!---->

* **IPアドレスの種類に基づいてプロトコル転送を制限する:** VMのプロトコル転送を外部IPアドレスに対して防ぎます。

<!---->

* **Cloud SQLインスタンスの公開IPアクセスを制限する:** 公開IPを持つCloud SQLインスタンスの作成を防ぎます。これにより、インターネットトラフィックにさらされることを防ぎます。

<!---->

* **共有VPCプロジェクトのリーン除去を制限する:** 共有VPCホストプロジェクトの誤った削除を防ぎます。

<!---->

* **新しいプロジェクトの内部DNS設定をゾーンDNSのみに設定する:** サービス可用性が低下するレガシーDNS設定の使用を防ぎます。

<!---->

* **デフォルトネットワークの作成をスキップする:** デフォルトVPCネットワークおよび関連リソースの自動作成を防ぎます。これにより、過度に許可されたデフォルトのファイアウォールルールを避けることができます。

<!---->

* **VPC外部IPv6の使用を無効にする:** 認可されていないインターネットアクセスにさらされる可能性のある外部IPv6サブネットの作成を防ぎます。

</details>

## **IAMロール**

これらは**各ロールが一連の権限を含む**AWSのIAMポリシーと似ています。

しかし、AWSとは異なり、**中央集権的なロールのリポジトリはありません**。その代わりに、**リソースはXアクセスロールをYプリンシパルに付与**し、リソースにアクセス権を持っている人を見つける唯一の方法は、そのリソースに対して**`get-iam-policy`メソッドを使用することです**。\
これは問題になる可能性があります。つまり、プリンシパルがどの権限を持っているかを知る唯一の方法は、**すべてのリソースに対して誰が権限を付与しているかを尋ねることです**。そして、ユーザーはすべてのリソースから権限を取得する権限を持っていないかもしれません。

IAMには**3種類**のロールがあります：

* **基本/プリミティブロール**には、IAMの導入前に存在していた**オーナー**、**エディター**、**ビューアー**のロールが含まれます。
* **事前定義されたロール**は、特定のサービスに対する詳細なアクセスを提供し、Google Cloudによって管理されます。多くの事前定義されたロールがあり、それらの権限を[**こちらで全て見ることができます**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)。
* **カスタムロール**は、ユーザー指定の権限リストに従って詳細なアクセスを提供します。

GCPには数千の権限があります。ロールが権限を持っているかどうかを確認するには、[**こちらで権限を検索**](https://cloud.google.com/iam/docs/permissions-reference)し、それを持っているロールを確認できます。

また、[**こちらで各製品が提供する事前定義されたロールを検索**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)することもできます。いくつかの**ロール**はユーザーには付与できず、**一部の権限**を含むため**SAにのみ付与**できることに注意してください。\
さらに、**権限**は関連するサービスに**付与された場合にのみ効果を発揮する**ことに注意してください。

または、[**特定の権限を使用できるカスタムロールをこちらで確認**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**してください。**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## ユーザー <a href="#default-credentials" id="default-credentials"></a>

**GCPコンソール**には**ユーザーやグループ**の管理はありません。それは**Google Workspace**で行われます。ただし、Google Workspaceに異なるアイデンティティプロバイダーを同期させることができます。

Workspacesの**ユーザーとグループには**[**https://admin.google.com**](https://admin.google.com/)でアクセスできます。

**MFA**はWorkspacesユーザーに**強制することができます**が、**攻撃者**はMFAで保護されていない**cli経由でGCPにアクセスするためのトークンを使用する可能性があります**（トークンを生成するためにユーザーがログインするときにのみMFAで保護されます：`gcloud auth login`）。

## グループ

組織が作成されると、いくつかのグループが**強く作成を推奨されます**。それらのいずれかを管理している場合、組織全体または重要な部分が危険にさらされる可能性があります：

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>グループ</strong></td><td><strong>機能</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(チェックリストに必要なグループまたは個別アカウント)</em></td><td>組織に属する任意のリソースを管理します。このロールは慎重に割り当ててください。組織管理者はGoogle Cloudのすべてのリソースにアクセスできます。代わりに、この機能は高い権限を持っているため、グループを作成する代わりに個別のアカウントを使用することを検討してください。</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(チェックリストに必要)</em></td><td>ネット
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
しかし、このように見える**カスタムサービスアカウント**を作成し、リソースにアタッチすることも可能です：
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **アクセススコープ**

アクセススコープは、GCP APIエンドポイントにアクセスするために**生成されたOAuthトークンに添付されます**。これらはOAuthトークンの権限を**制限します**。\
つまり、トークンがリソースのオーナーに属していても、そのリソースにアクセスするためのスコープがトークンにない場合、トークンはそれらの権限を**(悪用)利用することはできません**。

Googleは実際に、アクセススコープを使用せずに完全にIAMに依存することを[推奨しています](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions)。ウェブ管理ポータルは実際にこれを強制しますが、アクセススコープはプログラムによってカスタムサービスアカウントを使用してインスタンスに適用することができます。

**割り当てられたスコープ**を**確認する**には、以下を**クエリします**：

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

前述の**スコープ**は、データにアクセスするために**`gcloud`**を使用する際に**デフォルト**で生成されるものです。これは、**`gcloud`**を使用する際に最初にOAuthトークンを作成し、そのトークンを使用してエンドポイントに連絡するためです。

おそらく最も重要なスコープは**`cloud-platform`**で、これは基本的に**GCP内の任意のサービスにアクセス可能**であることを意味します。

[**こちら**](https://developers.google.com/identity/protocols/googlescopes)で**可能なすべてのスコープのリストを見つける**ことができます。

**`gcloud`**ブラウザの認証情報を持っている場合、他のスコープでトークンを**取得することが可能**です。以下のような操作を行います：

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
```markdown
{% endcode %}

## **Terraform IAM ポリシー、バインディング、およびメンバーシップ**

terraform が [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) で定義しているように、GCP で terraform を使用すると、リソースに対するプリンシパルのアクセスを付与する方法がいくつかあります：

* **メンバーシップ**: **ロールやプリンシパルに制限なく**、**プリンシパルをロールのメンバーとして設定**します。ユーザーをロールのメンバーとして設定し、その後でグループを同じロールのメンバーとして設定することもできますし、それらのプリンシパル（ユーザーとグループ）を他のロールのメンバーとして設定することもできます。
* **バインディング**: 複数の **プリンシパルをロールにバインド**することができます。これらの **プリンシパルは他のロールにバインドされているか、またはメンバーであることができます**。しかし、ロールにバインドされていないプリンシパルが **バインドされたロールのメンバーとして設定された場合**、次に **バインディングが適用されると、そのメンバーシップは消えます**。
* **ポリシー**: ポリシーは **権威的**であり、ロールとプリンシパルを示し、その後、**それらのプリンシパルは他のロールを持つことができず、それらのロールは他のプリンシパルを持つことができません**（他のポリシー、バインディング、またはメンバーシップでさえ）。したがって、ポリシーでロールまたはプリンシパルが指定されると、その特権は **そのポリシーによって制限されます**。もちろん、プリンシパルにポリシーまたは特権エスカレーションの権限（新しいプリンシパルを作成し、彼に新しいロールをバインドするなど）を変更するオプションが与えられた場合は、これを回避することができます。

## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で AWS ハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する、私たちの独占的な [**NFT**](https://opensea.io/collection/the-peass-family) コレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に **参加する** か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** の [**GitHub リポジトリ**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを共有する。

</details>
```
