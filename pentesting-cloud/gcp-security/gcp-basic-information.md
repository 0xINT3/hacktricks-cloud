# GCP - 基本信息

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## **资源层次结构**

Google Cloud 使用类似于传统文件系统的[资源层次结构](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)，在概念上类似于传统文件系统。这提供了一个具有特定策略和权限附加点的逻辑父/子工作流程。

在高层次上，它看起来像这样：
```
Organization
--> Folders
--> Projects
--> Resources
```
虚拟机（称为计算实例）是一种资源。资源位于一个项目中，可能与其他计算实例、存储桶等资源一起。

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

## **项目迁移**

可以将一个没有任何组织的项目迁移到具有`roles/resourcemanager.projectCreator`和`roles/resourcemanager.projectMover`权限的组织中。如果项目位于其他组织中，则需要联系GCP支持人员先将其移出组织。有关更多信息，请参见[**此处**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)。

## **组织策略**

允许集中控制组织的云资源：

* 集中控制以**配置限制**组织资源的使用方式。
* 为开发团队**定义和建立**合规边界内的**限制条件**。
* 帮助项目所有者及其团队快速移动，无需担心违反合规性。

这些策略可以创建以**影响整个组织、文件夹或项目**的方式。目标资源层次结构节点的**后代继承组织策略**。

为了**定义**组织策略，**选择一个**[**约束条件**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)，它是针对Google Cloud服务或一组Google Cloud服务的特定类型的限制。您可以**使用所需的限制条件配置该约束条件**。

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### 常见用例 <a href="#common_use_cases" id="common_use_cases"></a>

* 基于域限制资源共享。
* 限制身份和访问管理服务账号的使用。
* 限制新创建资源的物理位置。
* 禁用服务账号创建。

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

还有许多其他约束条件可以对组织的资源进行精细控制。有关**更多信息，请参见**[**所有组织策略服务约束条件的列表**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**。**

## **IAM角色**

这些角色类似于AWS中的IAM策略，**每个角色包含一组权限**。

然而，与AWS不同的是，**没有集中的角色存储库**。而是**资源向主体提供X访问角色**，找出谁可以访问资源的唯一方法是使用**`get-iam-policy`方法查询该资源**。\
这可能是一个问题，因为这意味着找出一个主体拥有哪些权限的唯一方法是询问每个资源它授予权限的对象，并且用户可能没有权限从所有资源获取权限。

IAM有**三种类型**的角色：

* **基本/原始角色**，包括在引入IAM之前存在的**Owner**、**Editor**和**Viewer**角色。
* **预定义角色**，为特定服务提供细粒度访问权限，由Google Cloud管理。有很多预定义角色，您可以**在此处查看它们及其权限**[**here**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)。
* **自定义角色**，根据用户指定的权限列表提供细粒度访问权限。

GCP中有数千个权限。为了检查角色是否具有某个权限，您可以[**在此处搜索权限**](https://cloud.google.com/iam/docs/permissions-reference)并查看具有该权限的角色。&#x20;

您还可以[**在此处搜索每个产品提供的预定义角色**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)**。**请注意，某些**角色**不能附加给用户，**只能附加给服务账号**，因为它们包含某些权限。\
此外，请注意，**权限**只有在附加到相关服务时才会**生效**。

或者在[**此处检查自定义角色是否可以使用特定权限**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**。**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## 用户 <a href="#default-credentials" id="default-credentials"></a>

在**GCP控制台**中，**没有任何用户或组**管理，这是在**Google Workspace**中完成的。尽管您可以在Google Workspace中同步不同的身份提供者。

您可以在[**https://admin.google.com**](https://admin.google.com/)中访问Workspaces的**用户和组**。

可以**强制**Workspaces用户使用**MFA**，但是攻击者可以使用令牌通过cli访问GCP，而cli不受MFA保护（仅在用户登录以生成令牌时受MFA保护：`gcloud auth login`）。

## 组

创建组织时，**强烈建议创建几个组**。如果您管理其中任何一个组，可能会危及整个组织或重要部分：
| 组 | 功能 |
| --- | --- |
| grp-gcp-organization-admins | 管理属于组织的任何资源。请谨慎分配此角色；组织管理员可以访问您的所有Google Cloud资源。或者，考虑使用个人帐户而不是创建组，因为此功能权限非常高。 |
| grp-gcp-network-admins | 创建网络、子网、防火墙规则和网络设备，如Cloud Router、Cloud VPN和云负载均衡器。 |
| grp-gcp-billing-admins | 设置计费帐户并监控其使用情况。 |
| grp-gcp-developers | 设计、编码和测试应用程序。 |
| grp-gcp-security-admins | 为整个组织建立和管理安全策略，包括访问管理和组织约束策略。有关规划Google Cloud安全基础设施的更多信息，请参阅Google Cloud安全基础指南。 |
| grp-gcp-devops | 创建或管理支持持续集成和交付、监控和系统配置的端到端流水线。 |
| grp-gcp-billing-viewer | 监控项目的支出。典型成员是财务团队的一部分。 |
| grp-gcp-platform-viewer | 查看Google Cloud组织中的资源信息。 |
| grp-gcp-security-reviewer | 审查云安全。 |
| grp-gcp-network-viewer | 查看网络配置。 |
| grp-gcp-audit-viewer | 查看审计日志。 |
| grp-gcp-scc-admin | 管理安全命令中心。 |
| grp-gcp-secrets-admin | 在Secret Manager中管理密钥。 |

## **默认密码策略**

<figure><img src="../../.gitbook/assets/image (1) (9).png" alt=""><figcaption></figcaption></figure>

## **服务帐户**

这些是资源可以附加并与GCP轻松交互的主体。例如，可以在元数据中访问附加到VM的服务帐户的身份验证令牌。\
在使用IAM和访问范围时可能会遇到一些冲突。例如，您的服务帐户可能具有`compute.instanceAdmin`的IAM角色，但您入侵的实例可能受到`https://www.googleapis.com/auth/compute.readonly`范围限制的限制。这将阻止您使用自动分配给实例的OAuth令牌进行任何更改。

这类似于AWS的IAM角色。但与AWS不同的是，任何服务帐户都可以附加到任何服务（不需要通过策略允许）。

您将发现的一些服务帐户实际上是在您开始使用服务时由GCP自动生成的，例如：
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
然而，您也可以创建和附加到资源的**自定义服务帐号**，其形式如下：
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **访问范围**

访问范围是附加到生成的OAuth令牌上的，用于访问GCP API端点的。它们限制了OAuth令牌的权限。

这意味着，如果一个令牌属于资源的所有者，但在令牌范围内没有访问该资源的权限，那么该令牌将无法被用于滥用这些特权。

Google实际上建议不使用访问范围，完全依赖于IAM。Web管理门户实际上强制执行了这一点，但仍然可以使用自定义服务帐户以编程方式将访问范围应用于实例。

您可以通过查询来查看分配了哪些范围：

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

之前的**范围（scopes）**是使用**`gcloud`**访问数据时生成的默认范围。这是因为当您使用**`gcloud`**时，首先创建一个OAuth令牌，然后使用它来联系终端。

其中最重要的范围可能是**`cloud-platform`**，它基本上意味着可以**访问GCP中的任何服务**。

您可以在[**这里找到所有可能的范围列表**](https://developers.google.com/identity/protocols/googlescopes)**。**

如果您拥有**`gcloud`**浏览器凭据，可以通过执行类似以下操作来**获取具有其他范围的令牌**：

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM策略、绑定和成员关系**

根据terraform在[https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam)中的定义，使用terraform与GCP一起，有不同的方法可以授予主体对资源的访问权限：

* **成员关系**：您可以将**主体设置为角色的成员**，**没有限制**对角色或主体的限制。您可以将用户设置为角色的成员，然后将组设置为相同角色的成员，并将这些主体（用户和组）设置为其他角色的成员。
* **绑定**：可以将多个**主体绑定到一个角色**。这些**主体仍然可以绑定或成为其他角色的成员**。但是，如果将未绑定到角色的主体设置为**绑定角色的成员**，则下次**应用绑定时，成员关系将消失**。
* **策略**：策略是**有权威的**，它指示角色和主体，然后，**除非修改该策略**（甚至在其他策略、绑定或成员关系中），否则这些主体不能拥有更多角色，这些角色不能拥有更多主体。因此，当在策略中指定角色或主体时，所有特权都受到该策略的**限制**。显然，如果主体被赋予修改策略或特权升级权限的选项（例如创建一个新的主体并将其绑定到新的角色），则可以绕过此限制。

## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>
