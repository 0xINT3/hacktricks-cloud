# GCP - Informaci칩n b치sica

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## **Jerarqu칤a de recursos**

Google Cloud utiliza una [jerarqu칤a de recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que es similar, conceptualmente, a la de un sistema de archivos tradicional. Esto proporciona un flujo de trabajo l칩gico de padre/hijo con puntos de conexi칩n espec칤ficos para pol칤ticas y permisos.

A grandes rasgos, se ve as칤:
```
Organization
--> Folders
--> Projects
--> Resources
```
Una m치quina virtual (llamada una instancia de c칩mputo) es un recurso. Un recurso reside en un proyecto, probablemente junto con otras instancias de c칩mputo, buckets de almacenamiento, etc.

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

## **Migraci칩n de proyectos**

Es posible migrar un proyecto sin ninguna organizaci칩n a una organizaci칩n con los permisos `roles/resourcemanager.projectCreator` y `roles/resourcemanager.projectMover`. Si el proyecto est치 dentro de otra organizaci칩n, es necesario contactar al soporte de GCP para moverlos fuera de la organizaci칩n primero. Para obtener m치s informaci칩n, consulta [**este**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6) enlace.

## **Pol칤ticas de organizaci칩n**

Permiten centralizar el control sobre los recursos en la nube de tu organizaci칩n:

* Centralizar el control para configurar restricciones sobre c칩mo se pueden utilizar los recursos de tu organizaci칩n.
* Definir y establecer l칤mites para que los equipos de desarrollo se mantengan dentro de los l칤mites de cumplimiento.
* Ayudar a los propietarios de proyectos y sus equipos a moverse r치pidamente sin preocuparse por incumplir el cumplimiento.

Estas pol칤ticas se pueden crear para afectar a toda la organizaci칩n, carpeta(s) o proyecto(s). Los descendientes del nodo de jerarqu칤a de recursos objetivo heredan la pol칤tica de la organizaci칩n.

Para definir una pol칤tica de organizaci칩n, eliges una [restricci칩n](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que es un tipo particular de restricci칩n contra un servicio de Google Cloud o un grupo de servicios de Google Cloud. Configuras esa restricci칩n con las restricciones deseadas.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Casos de uso comunes <a href="#common_use_cases" id="common_use_cases"></a>

* Limitar el intercambio de recursos basado en el dominio.
* Limitar el uso de cuentas de servicio de Identity and Access Management.
* Restringir la ubicaci칩n f칤sica de los recursos reci칠n creados.
* Deshabilitar la creaci칩n de cuentas de servicio.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Existen muchas m치s restricciones que te brindan un control detallado sobre los recursos de tu organizaci칩n. Para obtener m치s informaci칩n, consulta la [lista de todas las restricciones del servicio de pol칤ticas de organizaci칩n](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints).

## **Roles de IAM**

Estos son como las pol칤ticas de IAM en AWS, ya que cada rol contiene un conjunto de permisos.

Sin embargo, a diferencia de AWS, no hay un repositorio centralizado de roles. En lugar de eso, los recursos otorgan roles de acceso X a los principales Y, y la 칰nica forma de saber qui칠n tiene acceso a un recurso es utilizar el m칠todo `get-iam-policy` sobre ese recurso.\
Esto podr칤a ser un problema porque esto significa que la 칰nica forma de saber qu칠 permisos tiene un principal es preguntar a cada recurso a qui칠n le est치 dando permisos, y un usuario puede no tener permisos para obtener permisos de todos los recursos.

Existen tres tipos de roles en IAM:

* Roles b치sicos/primitivos, que incluyen los roles de Propietario, Editor y Espectador que exist칤an antes de la introducci칩n de IAM.
* Roles predefinidos, que proporcionan acceso granular para un servicio espec칤fico y son administrados por Google Cloud. Hay muchos roles predefinidos, puedes ver todos ellos con los privilegios que tienen [aqu칤](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles).
* Roles personalizados, que proporcionan acceso granular seg칰n una lista de permisos especificada por el usuario.

Existen miles de permisos en GCP. Para verificar si un rol tiene un permiso, puedes [buscar el permiso aqu칤](https://cloud.google.com/iam/docs/permissions-reference) y ver qu칠 roles lo tienen.&#x20;

Tambi칠n puedes [buscar aqu칤 los roles predefinidos](https://cloud.google.com/iam/docs/understanding-roles#product_specific_documentation) ofrecidos por cada producto. Ten en cuenta que algunos roles no se pueden asignar a usuarios y solo a cuentas de servicio debido a los permisos que contienen.\
Adem치s, ten en cuenta que los permisos solo tendr치n efecto si est치n adjuntos al servicio relevante.

O verifica si un rol personalizado puede usar un [permiso espec칤fico aqu칤](https://cloud.google.com/iam/docs/custom-roles-permissions-support).

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Usuarios <a href="#default-credentials" id="default-credentials"></a>

En la consola de GCP no hay ninguna gesti칩n de Usuarios o Grupos, eso se hace en Google Workspace. Aunque podr칤as sincronizar un proveedor de identidad diferente en Google Workspace.

Puedes acceder a los usuarios y grupos de Workspaces en [https://admin.google.com](https://admin.google.com/).

Se puede forzar la autenticaci칩n multifactor (MFA) para los usuarios de Workspaces, sin embargo, un atacante podr칤a usar un token para acceder a GCP a trav칠s de la l칤nea de comandos (CLI) que no estar치 protegida por MFA (solo estar치 protegida por MFA cuando el usuario inicie sesi칩n para generarla: `gcloud auth login`).

## Grupos

Cuando se crea una organizaci칩n, se sugiere crear varios grupos. Si gestionas alguno de ellos, podr칤as comprometer toda o una parte importante de la organizaci칩n:
<table data-header-hidden><thead><tr><th width="320"></th><th></th></tr></thead><tbody><tr><td><strong>Grupo</strong></td><td><strong>Funci칩n</strong></td></tr><tr><td><strong><code>grp-gcp-organization-admins</code></strong><br><em>(grupo o cuentas individuales requeridas para la lista de verificaci칩n)</em></td><td>Administrar cualquier recurso que pertenezca a la organizaci칩n. Asigne este rol con moderaci칩n; los administradores de la organizaci칩n tienen acceso a todos sus recursos de Google Cloud. Alternativamente, debido a que esta funci칩n tiene muchos privilegios, considere utilizar cuentas individuales en lugar de crear un grupo.</td></tr><tr><td><strong><code>grp-gcp-network-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Crear redes, subredes, reglas de firewall y dispositivos de red como Cloud Router, Cloud VPN y equilibradores de carga en la nube.</td></tr><tr><td><strong><code>grp-gcp-billing-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Configurar cuentas de facturaci칩n y supervisar su uso.</td></tr><tr><td><strong><code>grp-gcp-developers</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Dise침ar, codificar y probar aplicaciones.</td></tr><tr><td><strong><code>grp-gcp-security-admins</code></strong><br></td><td>Establecer y administrar pol칤ticas de seguridad para toda la organizaci칩n, incluido el control de acceso y las pol칤ticas de restricci칩n de la organizaci칩n. Consulte la gu칤a de fundamentos de seguridad de Google Cloud para obtener m치s informaci칩n sobre la planificaci칩n de su infraestructura de seguridad de Google Cloud.</td></tr><tr><td><strong><code>grp-gcp-devops</code></strong></td><td>Crear o administrar canalizaciones de extremo a extremo que admitan la integraci칩n y entrega continua, el monitoreo y el aprovisionamiento del sistema.</td></tr><tr><td><strong><code>grp-gcp-billing-viewer</code></strong></td><td>Supervisar el gasto en proyectos. Los miembros t칤picos son parte del equipo financiero.</td></tr><tr><td><strong><code>grp-gcp-platform-viewer</code></strong></td><td>Revisar informaci칩n de recursos en toda la organizaci칩n de Google Cloud.</td></tr><tr><td><strong><code>grp-gcp-security-reviewer</code></strong></td><td>Revisar la seguridad en la nube.</td></tr><tr><td><strong><code>grp-gcp-network-viewer</code></strong></td><td>Revisar configuraciones de red.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong></td><td>Ver registros de auditor칤a.</td></tr><tr><td><strong><code>grp-gcp-scc-admin</code></strong></td><td>Administrar Security Command Center.</td></tr><tr><td><strong><code>grp-gcp-secrets-admin</code></strong></td><td>Administrar secretos en Secret Manager.</td></tr></tbody></table>

## **Pol칤tica de contrase침a predeterminada**

<figure><img src="../../.gitbook/assets/image (1) (9).png" alt=""><figcaption></figcaption></figure>

## **Cuentas de servicio**

Estas son las entidades a las que los **recursos** pueden estar **vinculados** y tener acceso para interactuar f치cilmente con GCP. Por ejemplo, es posible acceder al **token de autenticaci칩n** de una cuenta de servicio **vinculada a una VM** en los metadatos.\
Es posible encontrar algunos **conflictos** al usar tanto **roles IAM como alcances de acceso**. Por ejemplo, su cuenta de servicio puede tener el rol IAM de `compute.instanceAdmin`, pero la instancia a la que ha accedido ha sido limitada con la restricci칩n de alcance `https://www.googleapis.com/auth/compute.readonly`. Esto le impedir칤a realizar cambios utilizando el token OAuth asignado autom치ticamente a su instancia.

Es similar a los roles IAM de AWS. Pero a diferencia de AWS, **cualquier** cuenta de servicio puede estar **vinculada a cualquier servicio** (no es necesario permitirlo mediante una pol칤tica).

Varias de las cuentas de servicio que encontrar치 son en realidad **generadas autom치ticamente por GCP** cuando comienza a usar un servicio, como:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Sin embargo, tambi칠n es posible crear y adjuntar a los recursos **cuentas de servicio personalizadas**, que se ver치n as칤:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Alcances de acceso**

Los alcances de acceso est치n **asociados a los tokens OAuth generados** para acceder a los puntos finales de la API de GCP. Estos **restringen los permisos** del token OAuth.\
Esto significa que si un token pertenece a un propietario de un recurso pero no tiene el alcance en el token para acceder a ese recurso, el token **no se puede utilizar para (ab)usar esos privilegios**.

Google realmente [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) que **no se utilicen alcances de acceso y que se conf칤e totalmente en IAM**. El portal de gesti칩n web realmente hace cumplir esto, pero los alcances de acceso a칰n se pueden aplicar a las instancias utilizando cuentas de servicio personalizadas de forma program치tica.

Puede ver qu칠 **alcances** est치n **asignados** consultando:

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Los **alcances** anteriores son los generados por **defecto** al usar **`gcloud`** para acceder a los datos. Esto se debe a que cuando usas **`gcloud`** primero creas un token de OAuth y luego lo usas para contactar los puntos finales.

El alcance m치s importante de esos potencialmente es **`cloud-platform`**, lo que b치sicamente significa que es posible **acceder a cualquier servicio en GCP**.

Puedes **encontrar una lista de** [**todos los alcances posibles aqu칤**](https://developers.google.com/identity/protocols/googlescopes)**.**

Si tienes credenciales de navegador de **`gcloud`**, es posible **obtener un token con otros alcances**, haciendo algo como:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Pol칤ticas de IAM, asignaciones y membres칤as de Terraform**

Seg칰n lo definido por Terraform en [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam), al utilizar Terraform con GCP existen diferentes formas de otorgar acceso a un principal sobre un recurso:

* **Membres칤as**: Se establecen **principales como miembros de roles** **sin restricciones** sobre el rol o los principales. Puedes poner a un usuario como miembro de un rol y luego poner a un grupo como miembro del mismo rol y tambi칠n establecer esos principales (usuario y grupo) como miembros de otros roles.
* **Asignaciones**: Varios **principales pueden ser asignados a un rol**. Esos **principales a칰n pueden ser asignados o ser miembros de otros roles**. Sin embargo, si un principal que no est치 asignado al rol se establece como **miembro de un rol asignado**, la pr칩xima vez que se **aplique la asignaci칩n, la membres칤a desaparecer치**.
* **Pol칤ticas**: Una pol칤tica es **autoritaria**, indica roles y principales y luego, **esos principales no pueden tener m치s roles y esos roles no pueden tener m치s principales** a menos que se modifique esa pol칤tica (ni siquiera en otras pol칤ticas, asignaciones o membres칤as). Por lo tanto, cuando se especifica un rol o principal en una pol칤tica, todos sus privilegios est치n **limitados por esa pol칤tica**. Obviamente, esto se puede evadir en caso de que se le d칠 al principal la opci칩n de modificar la pol칤tica o los permisos de escalada de privilegios (como crear un nuevo principal y asignarle un nuevo rol).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, 춰consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
