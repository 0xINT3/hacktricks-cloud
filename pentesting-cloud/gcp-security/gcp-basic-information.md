# GCP - Osnovne informacije

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Hijerarhija resursa**

Google Cloud koristi [Hijerarhiju resursa](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) koja je konceptualno slična tradicionalnom sistemskom fajl sistemu. Ovo pruža logičan roditeljski/detinjasti radni tok sa specifičnim tačkama priključenja za politike i dozvole.

Na visokom nivou, izgleda ovako:
```
Organization
--> Folders
--> Projects
--> Resources
```
## **Virtuelna mašina (nazvana Compute Instance) je resurs.**

Resurs se nalazi u projektu, verovatno zajedno sa drugim Compute Instancama, skladišnim kantama, itd.

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption><p><a href="https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg">https://cloud.google.com/static/resource-manager/img/cloud-hierarchy.svg</a></p></figcaption></figure>

## **Migracija Projekata**

Moguće je **migrirati projekat bez bilo koje organizacije** u organizaciju sa dozvolama `roles/resourcemanager.projectCreator` i `roles/resourcemanager.projectMover`. Ako je projekat unutar druge organizacije, potrebno je kontaktirati GCP podršku da ih prvo **izmesti iz organizacije**. Za više informacija pogledajte [**ovde**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Politike Organizacije**

Omogućavaju centralizovanu kontrolu nad resursima u vašoj organizaciji u oblaku:

* Centralizovana kontrola za **konfigurisanje ograničenja** o tome kako se resursi vaše organizacije mogu koristiti.
* Definisanje i uspostavljanje **zaštitnih ograda** za vaše razvojne timove da ostanu unutar granica usaglašenosti.
* Pomažu vlasnicima projekata i njihovim timovima da brzo napreduju bez brige o kršenju usaglašenosti.

Ove politike mogu biti kreirane da **utiču na celu organizaciju, folder(e) ili projekat(e)**. Potomci ciljanog čvora hijerarhije resursa **nasleđuju organizacionu politiku**.

Da biste **definisali** organizacionu politiku, **izaberete** [**ograničenje**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), koje je određeni tip ograničenja protiv Google Cloud servisa ili grupe Google Cloud servisa. Zatim **konfigurišete to ograničenje sa željenim ograničenjima**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption><p><a href="https://cloud.google.com/resource-manager/img/org-policy-concepts.svg">https://cloud.google.com/resource-manager/img/org-policy-concepts.svg</a></p></figcaption></figure>

#### Česti slučajevi upotrebe <a href="#common_use_cases" id="common_use_cases"></a>

* Ograničavanje deljenja resursa na osnovu domena.
* Ograničavanje korišćenja servisnih naloga za identitet i pristup.
* Ograničavanje fizičke lokacije novostvorenih resursa.
* Onemogućavanje kreiranja servisnih naloga.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Postoji još mnogo ograničenja koja vam daju detaljnu kontrolu nad resursima vaše organizacije. Za **više informacija, pogledajte** [**listu svih ograničenja usluge Organizacione Politike**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Podrazumevane Politike Organizacije**

<details>

<summary>Ovo su politike koje će Google automatski dodati prilikom postavljanja vaše GCP organizacije:</summary>

**Politike Upravljanja Pristupom**

* **Ograničeni kontakti po domenu:** Onemogućava dodavanje korisnika Essential kontakata izvan vaših odabranih domena. Ovo ograničava Essential kontakte da dozvoli samo upravljane korisničke identitete u vašim odabranim domenima da primaju obaveštenja platforme.
* **Ograničeno deljenje po domenu:** Onemogućava dodavanje korisnika u IAM politike izvan vaših odabranih domena. Ovo ograničava IAM politike da dozvoli samo upravljane korisničke identitete u vašim odabranim domenima da pristupe resursima unutar ove organizacije.
* **Prevencija javnog pristupa:** Onemogućava Cloud Storage kante da budu izložene javnosti. Ovo osigurava da programer ne može konfigurisati Cloud Storage kante da imaju neautentifikovan pristup internetu.
* **Jednaki pristup nivou kante:** Onemogućava liste kontrole pristupa na nivou objekta (ACL) u Cloud Storage kantama. Ovo pojednostavljuje upravljanje pristupom primenom IAM politika dosledno na sve objekte u Cloud Storage kantama.
* **Zahtevaj prijavljivanje na OS:** Virtuelne mašine kreirane u novim projektima će imati omogućeno prijavljivanje na OS. Ovo vam omogućava da upravljate SSH pristupom vašim instancama koristeći IAM, bez potrebe za kreiranjem i upravljanjem pojedinačnim SSH ključevima.

**Dodatne sigurnosne politike za servisne naloge**

* **Onemogući automatske IAM dozvole**: Onemogućava podrazumevane App Engine i Compute Engine servisne naloge da automatski dobiju Editor IAM ulogu na projektu prilikom kreiranja. Ovo osigurava da servisni nalozi ne dobijaju prekomerne IAM uloge prilikom kreiranja.
* **Onemogući kreiranje ključeva servisnog naloga**: Onemogućava kreiranje javnih ključeva servisnih naloga. Ovo pomaže u smanjenju rizika izlaganja trajnih akreditiva.
* **Onemogući otpremanje ključeva servisnog naloga**: Onemogućava otpremanje javnih ključeva servisnih naloga. Ovo pomaže u smanjenju rizika od izloženih ili ponovo korišćenih ključeva.

**Sigurna konfiguracija VPC mreže**

* **Definiši dozvoljene spoljne IP adrese za VM instance**: Onemogućava kreiranje Compute instanci sa javnom IP adresom, što ih može izložiti internet saobraćaju.

<!---->

* **Onemogući ugnježdeno virtualizaciju VM-ova**: Onemogućava kreiranje ugnježdenih VM-ova na Compute Engine VM-ovima. Ovo smanjuje sigurnosni rizik od neprekidnih ugnježdenih VM-ova.

<!---->

* **Onemogući serijski port VM-a:** Onemogućava pristup serijskom portu Compute Engine VM-ova. Ovo sprečava unos u serijski port servera korišćenjem Compute Engine API-ja.

<!---->

* **Ograniči ovlašćene mreže na Cloud SQL instancama:** Onemogućava javne ili ne-internetske mrežne opsege da pristupe vašim Cloud SQL bazama podataka.

<!---->

* **Ograniči prosleđivanje protokola na osnovu tipa IP adrese:** Onemogućava prosleđivanje protokola VM-ova za eksterne IP adrese.

<!---->

* **Ograniči pristup javnim IP adresama na Cloud SQL instancama:** Onemogućava kreiranje Cloud SQL instanci sa javnom IP adresom, što ih može izložiti internet saobraćaju.

<!---->

* **Ograniči uklanjanje liena deljenog VPC projekta:** Onemogućava slučajno brisanje host projekata deljenog VPC-a.

<!---->

* **Postavlja interni DNS za nove projekte na Zonalni DNS samo:** Onemogućava korišćenje zastarelog DNS postavke koja ima smanjenu dostupnost usluge.

<!---->

* **Preskoči podrazumevano kreiranje mreže:** Onemogućava automatsko kreiranje podrazumevane VPC mreže i povezanih resursa. Ovo izbegava prekomerno dozvoljene podrazumevane pravila firewall-a.

<!---->

* **Onemogući korišćenje spoljnih IPv6 adresa u VPC-u:** Onemogućava kreiranje spoljnih IPv6 podmreža, koje mogu biti izložene neovlašćenom internet pristupu.

</details>

## **IAM Uloge**

Ove su slične IAM politikama u AWS-u jer **svaka uloga sadrži skup dozvola**.

Međutim, za razliku od AWS-a, ne postoji **centralizovani repozitorijum** uloga. Umesto toga, **resursi daju X pristupnih uloga Y principima**, i jedini način da saznate ko ima pristup resursu je da koristite **`get-iam-policy` metodu nad tim resursom**.\
Ovo može biti problem jer to znači da je jedini način da saznate **koje dozvole princip ima je da pitate svaki resurs kome daje dozvole**, a korisnik možda nema dozvole da dobije dozvole od svih resursa.

Postoje **tri vrste** uloga u IAM-u:

* **Osnovne/Primitivne uloge**, koje uključuju uloge **Vlasnik**, **Uređivač** i **Pregledač** koje su postojale pre uvođenja IAM-a.
* **Predefinisane uloge**, koje pružaju granularni pristup za određenu uslugu i upravljaju ih Google Cloud. Postoji mnogo predefinisanih uloga, možete **videti sve njih sa privilegijama koje imaju** [**ovde**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Prilagođene uloge**, koje pružaju granularni pristup prema listi dozvola koje je korisnik odredio.

Postoji hiljade dozvola u GCP-u. Da biste proverili da li uloga ima dozvole, možete [**pretražiti dozvolu ovde**](https://cloud.google.com/iam/docs/permissions-reference) i videti koje uloge je imaju.

Takođe možete [**ovde pretražiti predefinisane uloge**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **ponuđene od strane svakog proizvoda.** Imajte na umu da neke **uloge** ne mogu biti dodeljene korisnicima već **samo servisnim nalozima zbog nekih dozvola** koje sadrže.\
Osim toga, imajte na umu da će **dozvole** imati efekta samo ako su **dodate relevantnoj usluzi.**

Ili proverite da li **prilagođena uloga može koristiti** [**specifičnu dozvolu ovde**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}
## Korisnici <a href="#default-credentials" id="default-credentials"></a>

U **GCP konzoli** nema upravljanja **Korisnicima ili Grupama**, to se radi u **Google Workspace-u**. Međutim, možete sinhronizovati drugog provajdera identiteta u Google Workspace-u.

Korisnici i grupe Workspaces-a mogu se pristupiti na [**https://admin.google.com**](https://admin.google.com/).

**MFA** može biti **obavezan** za korisnike Workspaces-a, međutim, **napadač** može koristiti token za pristup GCP **putem CLI-a koji neće biti zaštićen MFA-om** (biće zaštićen MFA-om samo kada korisnik se prijavi da ga generiše: `gcloud auth login`).

## Grupe

Kada se organizacija kreira, preporučuje se da se kreiraju nekoliko grupa. Ako upravljate bilo kojom od njih, možda ste kompromitovali celu ili važan deo organizacije:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupa</strong></td><td><strong>Funkcija</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupa ili individualni nalozi potrebni za proveru)</em></td><td>Upravljanje svakim resursom koji pripada organizaciji. Dodelite ovu ulogu štedljivo; administratori organizacije imaju pristup svim vašim Google Cloud resursima. Alternativno, zbog visokih privilegija ove funkcije, razmislite o korišćenju individualnih naloga umesto kreiranja grupe.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(potrebno za proveru)</em></td><td>Kreiranje mreža, podmreža, pravila zaštite od požara i mrežnih uređaja poput Cloud Routera, Cloud VPN-a i cloud load balansera.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(potrebno za proveru)</em></td><td>Postavljanje billing naloga i praćenje njihove upotrebe.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(potrebno za proveru)</em></td><td>Dizajniranje, kodiranje i testiranje aplikacija.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Uspostavljanje i upravljanje sigurnosnim politikama za celu organizaciju, uključujući upravljanje pristupom i <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">politike ograničenja organizacije</a>. Pogledajte <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud vodič za osnove sigurnosti</a> za više informacija o planiranju vaše Google Cloud sigurnosne infrastrukture.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Kreiranje ili upravljanje celokupnim tokovima rada koji podržavaju kontinuiranu integraciju i isporuku, praćenje i obezbeđivanje sistema.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Praćenje troškova projekata. Tipični članovi su deo finansijskog tima.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregled informacija o resursima širom Google Cloud organizacije.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregledavanje sigurnosti u oblaku.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregled konfiguracija mreže.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(više nije podrazumevano)</em></td><td>Pregledanje dnevnika revizije.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(više nije podrazumevano)</em></td><td>Upravljanje Security Command Centrom.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(više nije podrazumevano)</em></td><td>Upravljanje tajnama u Secret Manager-u.</td></tr></tbody></table>

## **Podrazumevana politika lozinki**

* Nametanje jakih lozinki
* Između 8 i 100 karaktera
* Bez ponovne upotrebe
* Bez isteka
* Ako ljudi pristupaju Workspace-u putem provajdera treće strane, ovi zahtevi se ne primenjuju.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Servisni nalozi**

Ovo su principali koje **resursi** mogu **imati** **priložene** i pristup za lakšu interakciju sa GCP-om. Na primer, moguće je pristupiti **autentičnom tokenu** Servisnog naloga **priloženog virtuelnoj mašini** u metapodacima.\
Moguće je naići na neke **sukobe** prilikom korišćenja i **IAM i pristupnih opsega**. Na primer, vaš servisni nalog može imati IAM ulogu `compute.instanceAdmin` ali instanca koju ste prekršili je ograničena opsegom `https://www.googleapis.com/auth/compute.readonly`. To bi vas sprečilo da vršite bilo kakve promene koristeći OAuth token koji je automatski dodeljen vašoj instanci.

Slično je **IAM ulogama iz AWS-a**. Ali za razliku od AWS-a, **bilo** koji servisni nalog može biti **priložen bilo kom servisu** (ne mora mu se dozvoliti putem politike).

Neki od servisnih naloga koje ćete pronaći zapravo su **automatski generisani od strane GCP-a** kada počnete koristiti uslugu, kao što su:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Međutim, takođe je moguće kreirati i povezati **prilagođene servisne naloge** sa resursima, koji će izgledati ovako:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Pristupni opsezi**

Pristupni opsezi su **dodeljeni generisanim OAuth tokenima** kako bi se pristupilo GCP API endpointima. Oni **ograničavaju dozvole** OAuth tokena.\
Ovo znači da ako token pripada Vlasniku resursa ali nema dozvolu u opsegu tokena da pristupi tom resursu, token **ne može biti korišćen za zloupotrebu tih privilegija**.

Google zapravo [preporučuje](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) da se **pristupni opsezi ne koriste i da se potpuno oslonite na IAM**. Web menadžerski portal zapravo ovo sprovodi, ali pristupni opsezi i dalje mogu biti primenjeni na instance korišćenjem prilagođenih servisnih naloga programski.

Možete videti koje **opsege** imate **dodeljene** **upitom:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Prethodni **opsezi** su generisani **podrazumevano** korišćenjem **`gcloud`** za pristup podacima. To je zato što kada koristite **`gcloud`**, prvo kreirate OAuth token, a zatim ga koristite da kontaktirate krajnje tačke.

Najvažniji opseg od tih potencijalno je **`cloud-platform`**, što u osnovi znači da je moguće **pristupiti bilo kojoj usluzi u GCP**.

Možete **pronaći listu** [**svih mogućih opsega ovde**](https://developers.google.com/identity/protocols/googlescopes)**.**

Ako imate **`gcloud`** kredencijale pretraživača, moguće je **dobiti token sa drugim opsezima**, radeći nešto slično:
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Terraform IAM politike, veze i članstva**

Kako je definisano od strane terraforma na [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) korišćenjem terraforma sa GCP-om postoje različiti načini dodeljivanja pristupa principalu nad resursom:

* **Članstva**: Postavljate **principale kao članove uloga** **bez ograničenja** nad ulogom ili principale. Možete postaviti korisnika kao člana uloge, a zatim postaviti grupu kao člana iste uloge i takođe postaviti te principe (korisnika i grupu) kao članove drugih uloga.
* **Veze**: Više **principala može biti povezano sa ulogom**. Ti **principali i dalje mogu biti povezani ili biti članovi drugih uloga**. Međutim, ako se princip koji nije povezan sa ulogom postavi kao **član povezane uloge**, sledeći put kada se **veza primeni, članstvo će nestati**.
* **Politike**: Politika je **autoritativna**, ona označava uloge i principe, a zatim, **ti principali ne mogu imati više uloga i te uloge ne mogu imati više principala** osim ako se ta politika ne izmeni (čak ni u drugim politikama, vezama ili članstvima). Stoga, kada se uloga ili princip navedu u politici, sva njegova ovlašćenja su **ograničena tom politikom**. Očigledno, ovo se može zaobići u slučaju kada se principu da opcija da izmeni politiku ili dozvole za eskalaciju privilegija (kao što je kreiranje novog principala i dodeljivanje mu nove uloge).

## Reference

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)
* [https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)
