# GCP - 基本信息

<details>

<summary><strong>从零到英雄学习AWS黑客技术，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## **资源层次结构**

Google Cloud 使用一种[资源层次结构](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy)，在概念上类似于传统文件系统。这提供了一个具有特定策略和权限附着点的逻辑父/子工作流程。

从高层次来看，它是这样的：
```
Organization
--> Folders
--> Projects
--> Resources
```
虚拟机（称为计算实例）是一种资源。资源位于项目中，可能与其他计算实例、存储桶等一起。

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **项目迁移**

可以将**没有任何组织的项目迁移**至具有权限 `roles/resourcemanager.projectCreator` 和 `roles/resourcemanager.projectMover` 的组织。如果项目位于其他组织内，需要联系 GCP 支持**首先将它们移出组织**。更多信息请查看[**此处**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)。

## **组织策略**

允许集中控制组织的云资源：

* 集中控制以**配置限制**，规定组织资源的使用方式。
* 定义和建立**防护栏**，确保开发团队在合规边界内操作。
* 帮助项目所有者及其团队快速行动，无需担心违反合规性。

这些策略可以创建以**影响整个组织、文件夹或项目**。目标资源层次结构节点的后代**继承组织策略**。

为了**定义**组织策略，**您选择一个**[**约束**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)，这是针对 Google Cloud 服务或一组 Google Cloud 服务的特定类型的限制。您**根据所需的限制配置该约束**。

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### 常见用例 <a href="#common_use_cases" id="common_use_cases"></a>

* 根据域限制资源共享。
* 限制身份和访问管理服务账户的使用。
* 限制新创建资源的物理位置。
* 禁用服务账户创建

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

还有更多的约束，让您对组织的资源进行细粒度控制。有关**更多信息，请查看**[**所有组织策略服务约束的列表**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**。**

### **默认组织策略**

<details>

<summary>这些是 Google 在设置您的 GCP 组织时默认添加的策略：</summary>

**访问管理策略**

* **域限制联系人：** 阻止将用户添加到指定域之外的基本联系人。这限制了基本联系人，只允许您选择的域中的托管用户身份接收平台通知。
* **域限制共享：** 阻止将用户添加到指定域之外的 IAM 策略。这限制了 IAM 策略，只允许您选择的域中的托管用户身份访问该组织内的资源。
* **公共访问预防：** 阻止 Cloud Storage 桶对公众开放。这确保开发人员无法配置 Cloud Storage 桶以进行未经身份验证的互联网访问。
* **统一桶级别访问：** 阻止 Cloud Storage 桶中的对象级别访问控制列表（ACL）。这通过在 Cloud Storage 桶中的所有对象上一致应用 IAM 策略，简化了您的访问管理。
* **要求 OS 登录：** 在新项目中创建的 VM 将启用 OS 登录。这允许您使用 IAM 管理对实例的 SSH 访问，而无需创建和管理个人 SSH 密钥。

**服务账户的额外安全策略**

* **禁用自动 IAM 授予：** 阻止默认的 App Engine 和 Compute Engine 服务账户在项目创建时自动被授予编辑者 IAM 角色。这确保服务账户在创建时不会收到过于宽松的 IAM 角色。
* **禁用服务账户密钥创建：** 阻止创建公共服务账户密钥。这有助于减少暴露持久凭据的风险。
* **禁用服务账户密钥上传：** 阻止上传公共服务账户密钥。这有助于减少泄露或重复使用密钥材料的风险。

**安全 VPC 网络配置策略**

* **定义 VM 实例的允许外部 IP：** 阻止创建带有公共 IP 的计算实例，这可能将它们暴露给互联网流量。

<!---->

* **禁用 VM 嵌套虚拟化：** 阻止在 Compute Engine VM 上创建嵌套 VM。这降低了拥有未监控的嵌套 VM 的安全风险。

<!---->

* **禁用 VM 串行端口：** 阻止对 Compute Engine VM 的串行端口访问。这阻止了使用 Compute Engine API 对服务器串行端口的输入。

<!---->

* **限制 Cloud SQL 实例上的授权网络：** 阻止公共或非内部网络范围访问您的 Cloud SQL 数据库。

<!---->

* **根据 IP 地址类型限制协议转发：** 阻止 VM 协议转发外部 IP 地址。

<!---->

* **限制 Cloud SQL 实例上的公共 IP 访问：** 阻止创建带有公共 IP 的 Cloud SQL 实例，这可能将它们暴露给互联网流量。

<!---->

* **限制共享 VPC 项目留置权移除：** 阻止意外删除共享 VPC 主机项目。

<!---->

* **将新项目的内部 DNS 设置为仅区域 DNS：** 阻止使用降低服务可用性的遗留 DNS 设置。

<!---->

* **跳过默认网络创建：** 阻止自动创建默认 VPC 网络及相关资源。这避免了过于宽松的默认防火墙规则。

<!---->

* **禁用 VPC 外部 IPv6 使用：** 阻止创建外部 IPv6 子网，这可能会暴露给未经授权的互联网访问。

</details>

## **IAM 角色**

这些类似于 AWS 中的 IAM 策略，因为**每个角色包含一组权限。**

然而，与 AWS 不同，这里**没有集中的角色仓库**。相反，**资源给予 Y 主体 X 访问角色**，找出谁有权访问资源的唯一方法是使用**该资源上的 `get-iam-policy` 方法**。\
这可能是一个问题，因为这意味着找出**主体拥有哪些权限的唯一方法是询问每个资源它授予了哪些权限**，而用户可能没有权限从所有资源获取权限。

IAM 中有**三种类型**的角色：

* **基本/原始角色**，包括在引入 IAM 之前就存在的**所有者**、**编辑者**和**查看者**角色。
* **预定义角色**，为特定服务提供细粒度访问权限，并由 Google Cloud 管理。有很多预定义角色，您可以在[**这里**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)查看它们及其权限。
* **自定义角色**，根据用户指定的权限列表提供细粒度访问权限。

GCP 中有数千个权限。为了检查角色是否拥有权限，您可以在[**这里搜索权限**](https://cloud.google.com/iam/docs/permissions-reference)，并查看哪些角色拥有它。

您还可以在[**这里搜索每个产品提供的预定义角色**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)。请注意，某些**角色**不能附加给用户，**只能附加给服务账户，因为它们包含的某些权限**。\
此外，请注意，**权限**只有在**附加到相关服务时才会生效**。

或者检查**自定义角色是否可以在**[**这里使用特定权限**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**。**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## 用户 <a href="#default-credentials" id="default-credentials"></a>

在 **GCP 控制台** 中**没有用户或组**管理，这是在 **Google Workspace** 中完成的。尽管您可以在 Google Workspace 中同步不同的身份提供商。

您可以在[**https://admin.google.com**](https://admin.google.com/)中访问 Workspace **用户和组**。

**MFA** 可以**强制**对 Workspace 用户使用，然而，**攻击者**可以使用令牌通过 cli 访问 GCP，**这不会受到 MFA 的保护**（仅在用户登录生成它时受到 MFA 保护：`gcloud auth login`）。

## 组

创建组织时强烈建议创建几个组。如果您管理其中任何一个，您可能已经危及了整个组织或其重要部分：

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>组</strong></td><td><strong>功能</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(清单所需的组或个人账户)</em></td><td>管理属于组织的任何资源。谨慎分配此角色；组织管理员可以访问您的所有 Google Cloud 资源。或者，由于这个功能权限很高，考虑使用个人账户而不是创建一个组。</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(清单所需)</em></td><td>创建网络、子网、防火墙规则和网络设备，如 Cloud Router、Cloud VPN 和云负载均衡器。</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(清单所需)</em></td><td>设置计费账户并监控其使用情况。</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(清单所需)</em></td><td>设计、编码和测试应用程序。</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>为整个组织建立和管理安全策略，包括访问管理和<a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">组织约束策略</a>。有关规划 Google Cloud 安全基础设施的更多信息，请参阅<a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud 安全基础指南</a>。</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>创建或管理支持持续集成和交付、监控和系统配置的端到端管道。</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(不再默认)</em></td><td>监控项目支出。典型成员是财务团队的一部分。</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(不再默认)</em></td><td>查看 Google Cloud 组织的资源信息。</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(不再默认)</em></td><td>审查云安全。</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(不再默认)</em></td><td>审查网络配置。</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(不再默认)</em></td><td>查看审计日志。</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(不再默认)</em></td><td>管理安全命令中心。</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(不再默认)</em></td><td>在秘密管理器中管理秘密。</td></tr></tbody></table>

## **默认密码策略**

* 强制使用强密码
* 8 至 100 个字符之间
* 不允许重复使用
* 无过期
* 如果人们通过第三方提供商访问 Workspace，这些要求不适用。

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **服务账户**

这些是**资源**可以**附加**并轻松与 GCP 交互的主体。例如，可以在元数据中访问**附加到 VM 的服务账户的认证令牌**。\
在使用**IAM 和访问范围**时可能会遇到一些**冲突**。例如，您的服务账户可能拥有 `compute.instanceAdmin` 的 IAM 角色，但您已侵入的实例被限制为 `https://www.googleapis.com/auth/compute.readonly` 的范围。这将阻止您使用自动分配给您实例的 OAuth 令牌进行任何更改。

它类似于 **AWS 中的 IAM 角色**。但与 AWS 不同，**任何**服务账户都可以**附加到任何服务**（它不需要通过策略允许它）。

您会发现的几个服务账户实际上是**由 GCP 在您开始使用服务时自动生成的**，例如：
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
然而，也可以创建并附加到资源**自定义服务账户**，其格式如下：
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **访问范围**

访问范围是**附加到生成的OAuth令牌上**以访问GCP API端点的。它们**限制了OAuth令牌的权限**。\
这意味着，如果一个令牌属于某个资源的所有者，但在令牌范围内没有访问该资源的权限，那么该令牌**不能用来（滥用）这些权限**。

Google实际上[建议](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions)不使用访问范围，而是完全依赖IAM。网络管理门户实际上强制执行了这一点，但仍然可以通过编程方式使用自定义服务账户将访问范围应用于实例。

您可以通过**查询**来查看分配了哪些**范围**：

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

前述的**作用域**是使用**`gcloud`**访问数据时默认生成的。这是因为当你使用**`gcloud`**时，你首先创建一个OAuth令牌，然后使用它来联系端点。

其中最重要的作用域可能是**`cloud-platform`**，这基本上意味着可以**访问GCP中的任何服务**。

你可以在[**这里找到所有可能作用域的列表**](https://developers.google.com/identity/protocols/googlescopes)**。**

如果你有**`gcloud`**浏览器凭证，可以通过执行以下操作来**获取具有其他作用域的令牌**：

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM 策略、绑定和成员资格**

根据 terraform 在 [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) 中的定义，使用 terraform 与 GCP 时，有不同的方式授予主体对资源的访问权限：

* **成员资格**：您将**主体设置为角色的成员**，**没有对角色或主体的限制**。您可以将用户设置为角色的成员，然后将一个组设置为同一角色的成员，也可以将这些主体（用户和组）设置为其他角色的成员。
* **绑定**：可以将多个**主体绑定到一个角色**。这些**主体仍然可以绑定或成为其他角色的成员**。然而，如果一个未绑定到角色的主体被设置为**绑定角色的成员**，下次**应用绑定时，该成员资格将消失**。
* **策略**：策略是**权威性的**，它指明了角色和主体，然后，**这些主体不能有更多的角色，这些角色也不能有更多的主体**，除非修改了该策略（即使在其他策略、绑定或成员资格中也不行）。因此，当在策略中指定了角色或主体时，其所有权限都**受该策略限制**。显然，如果主体被赋予修改策略或权限提升权限（如创建新主体并为其绑定新角色），则可以绕过这一限制。

## 参考资料

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> 从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
