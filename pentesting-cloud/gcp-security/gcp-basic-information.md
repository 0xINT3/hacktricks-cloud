# GCP - 基本情報

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**最新版の PEASS を入手したい**場合、または HackTricks を PDF でダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけてください。これは私たちの独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションです
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、私を **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) で **フォロー**してください。
* **HackTricks** と **HackTricks Cloud** の github リポジトリに **PR を提出**することで、あなたのハッキングトリックを共有してください。

</details>

## **リソースの階層構造**

Google Cloud は、従来のファイルシステムと概念的に似た [リソースの階層構造](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) を使用しています。これにより、ポリシーや権限の特定のアタッチメントポイントを持つ論理的な親子ワークフローが提供されます。

高レベルでは、次のようになります：
```
Organization
--> Folders
--> Projects
--> Resources
```
# **仮想マシン（Compute Instanceと呼ばれる）はリソースです。** リソースはプロジェクト内に存在し、おそらく他のCompute Instance、ストレージバケットなどと一緒に存在します。

<figure><img src="../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

## **プロジェクトの移行**

**組織なしのプロジェクトを組織に移行することができます**。この場合、`roles/resourcemanager.projectCreator`と`roles/resourcemanager.projectMover`の権限が必要です。プロジェクトが他の組織内にある場合は、まずGCPサポートに連絡して**組織から移動する必要があります**。詳細については、[**こちら**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6)を参照してください。

## **組織ポリシー**

組織のクラウドリソースに対する制御を一元化することができます。

* 組織のリソースの使用方法に対する**制限を設定**するための制御を一元化します。
* 開発チームがコンプライアンスの範囲内にとどまるための**ガードレール**を定義し、確立します。
* プロジェクト所有者とそのチームがコンプライアンスを破る心配なく迅速に移動できるように支援します。

これらのポリシーは、**組織全体、フォルダ、またはプロジェクト**に影響を与えるように作成することができます。対象となるリソース階層ノードの子孫は、**組織ポリシーを継承**します。

組織ポリシーを**定義するためには、Google Cloudサービスまたは一連のGoogle Cloudサービスに対する特定の制限である**[**制約**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)**を選択**します。その制約を**所望の制限で構成**します。

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### 一般的なユースケース <a href="#common_use_cases" id="common_use_cases"></a>

* ドメインに基づいてリソースの共有を制限する。
* Identity and Access Managementサービスアカウントの使用を制限する。
* 新しく作成されたリソースの物理的な場所を制限する。
* サービスアカウントの作成を無効にする。

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

組織のリソースを細かく制御するためのさまざまな制約があります。**詳細については、[すべての組織ポリシーサービスの制約のリスト](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**を参照してください。

## **IAMロール**

これらはIAMポリシーと同様で、**各ロールには一連の権限が含まれています**。

ただし、AWSとは異なり、ロールの**集中したリポジトリは存在しません**。その代わり、**リソースはXアクセスロールをYプリンシパルに与え**、リソースへのアクセス権を持つユーザーを特定する唯一の方法は、そのリソース上で**`get-iam-policy`メソッドを使用することです**。\
これは問題になる可能性があります。なぜなら、ユーザーがすべてのリソースから権限を取得するための権限を持っていない場合、**プリンシパルがどの権限を持っているかを調べる唯一の方法は、リソースに権限を与えているユーザーに尋ねること**です。

IAMには**3つのタイプのロール**があります。

* **基本/プリミティブロール**は、IAMの導入前から存在していた**Owner**、**Editor**、**Viewer**の役割を含みます。
* **事前定義済みのロール**は、特定のサービスに対する細かいアクセスを提供し、Google Cloudによって管理されます。事前定義済みのロールはたくさんあり、それぞれの権限を含む**[こちら](https://cloud.google.com/iam/docs/understanding-roles#predefined_roles)**で確認できます。
* **カスタムロール**は、ユーザー指定の権限リストに基づいて細かいアクセスを提供します。

GCPには数千の権限があります。ロールが権限を持っているかどうかを確認するには、[**ここで権限を検索**](https://cloud.google.com/iam/docs/permissions-reference)し、どのロールがそれを持っているかを確認できます。

また、[**ここで各製品が提供する事前定義済みのロールを検索**](https://cloud.google.com/iam/docs/understanding-roles#product_specific_documentation)**する**こともできます。一部の**ロール**はユーザーにはアタッチできず、**一部の権限**を含むため、**サービスアカウントにのみアタッチ**できます。\
さらに、**権限**は、関連するサービスに**アタッチされている場合にのみ有効**になります。

また、**カスタムロールが**[**ここで特定の権限を使用できるかどうかを確認**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**する**こともできます。

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## ユーザー <a href="#default-credentials" id="default-credentials"></a>

**GCPコンソール**には**ユーザーやグループの管理はありません**。それは**Google Workspace**で行われます。ただし、異なるアイデンティティプロバイダをGoogle Workspaceに同期させることもできます。

Workspacesの**ユーザーとグループには**[**https://admin.google.com**](https://admin.google.com/)からアクセスできます。

Workspacesのユーザーには**MFA**を**強制する**ことができますが、**攻撃者**はトークンを使用してGCPにアクセスすることができます。ただし、これはMFAによって保護されません（ユーザーがログインして生成する場合のみMFAによって保護されます：`gcloud auth login`）。

## グループ

組織が作成されると、いくつかのグループの作成が**強く推奨されます**。これらのグループのいずれかを管理している場合、組織全体または重要な部分を侵害する可能性があります。
<table data-header-hidden><thead><tr><th width="320"></th><th></th></tr></thead><tbody><tr><td><strong>グループ</strong></td><td><strong>機能</strong></td></tr><tr><td><strong><code>grp-gcp-organization-admins</code></strong><br><em>(チェックリストに必要なグループまたは個別のアカウント)</em></td><td>組織に所属するリソースの管理。この役割は慎重に割り当ててください。組織の管理者はすべてのGoogle Cloudリソースにアクセスできます。代わりに、この機能は非常に特権があるため、グループを作成する代わりに個別のアカウントを使用することを検討してください。</td></tr><tr><td><strong><code>grp-gcp-network-admins</code></strong><br><em>(チェックリストに必要)</em></td><td>ネットワーク、サブネット、ファイアウォールルール、Cloud Router、Cloud VPN、クラウドロードバランサなどのネットワークデバイスの作成。</td></tr><tr><td><strong><code>grp-gcp-billing-admins</code></strong><br><em>(チェックリストに必要)</em></td><td>請求アカウントの設定と使用状況の監視。</td></tr><tr><td><strong><code>grp-gcp-developers</code></strong><br><em>(チェックリストに必要)</em></td><td>アプリケーションの設計、コーディング、テスト。</td></tr><tr><td><strong><code>grp-gcp-security-admins</code></strong><br></td><td>組織全体のセキュリティポリシーの確立と管理、アクセス管理、<a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">組織の制約ポリシー</a>の管理。Google Cloudセキュリティインフラストラクチャの計画については、<a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloudセキュリティ基盤ガイド</a>を参照してください。</td></tr><tr><td><strong><code>grp-gcp-devops</code></strong></td><td>継続的な統合とデリバリー、モニタリング、システムプロビジョニングをサポートするエンドツーエンドのパイプラインの作成または管理。</td></tr><tr><td><strong><code>grp-gcp-billing-viewer</code></strong></td><td>プロジェクトの支出の監視。通常、財務チームの一員です。</td></tr><tr><td><strong><code>grp-gcp-platform-viewer</code></strong></td><td>Google Cloud組織全体のリソース情報の確認。</td></tr><tr><td><strong><code>grp-gcp-security-reviewer</code></strong></td><td>クラウドセキュリティのレビュー。</td></tr><tr><td><strong><code>grp-gcp-network-viewer</code></strong></td><td>ネットワーク構成のレビュー。</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong></td><td>監査ログの表示。</td></tr><tr><td><strong><code>grp-gcp-scc-admin</code></strong></td><td>Security Command Centerの管理。</td></tr><tr><td><strong><code>grp-gcp-secrets-admin</code></strong></td><td>Secret Managerでのシークレットの管理。</td></tr></tbody></table>

## **デフォルトのパスワードポリシー**

<figure><img src="../../.gitbook/assets/image (1) (9).png" alt=""><figcaption></figcaption></figure>

## **サービスアカウント**

これらは、**リソース**が**アタッチ**され、GCPと簡単に対話するためのアクセスを持つ主体です。たとえば、メタデータに**VMにアタッチされたサービスアカウント**の**認証トークン**にアクセスすることができます。\
IAMとアクセススコープの両方を使用する場合には、いくつかの**競合**が発生する可能性があります。たとえば、サービスアカウントには`compute.instanceAdmin`のIAMロールがあるかもしれませんが、侵害したインスタンスには`https://www.googleapis.com/auth/compute.readonly`のスコープ制限が設定されている場合、自動的に割り当てられるOAuthトークンを使用して変更を行うことができません。

これはAWSのIAMロールと似ていますが、AWSとは異なり、**どの**サービスアカウントも**どのサービスにもアタッチ**できます（ポリシーを介して許可する必要はありません）。

実際には、いくつかのサービスアカウントは、サービスの使用を開始するときにGCPによって**自動的に生成**されます。たとえば、以下のようなものです：
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
ただし、**カスタムサービスアカウント**を作成してリソースにアタッチすることも可能です。これは次のようになります:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **アクセススコープ**

アクセススコープは、GCP APIエンドポイントにアクセスするために生成されたOAuthトークンに**添付される**ものです。これらはOAuthトークンの権限を**制限**します。\
つまり、トークンがリソースの所有者に属していても、トークンのスコープにそのリソースへのアクセス権限がない場合、その特権を**乱用するためにトークンを使用することはできません**。

Googleは実際には、**アクセススコープは使用せず、完全にIAMに依存することを推奨**しています。Web管理ポータルでは、実際にこれを強制していますが、アクセススコープはカスタムサービスアカウントを使用してインスタンスにプログラム的に適用することもできます。

**スコープ**が**割り当てられているかどうか**は、**クエリを使用して確認**できます：

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

前述の**スコープ**は、データにアクセスするために**`gcloud`**を使用して生成されるデフォルトのスコープです。これは、**`gcloud`**を使用すると、まずOAuthトークンを作成し、それを使用してエンドポイントにアクセスするためです。

これらの中で最も重要なスコープは、基本的には**GCPの任意のサービスにアクセスできる**ことを意味する**`cloud-platform`**です。

[**ここにすべての可能なスコープのリストがあります**](https://developers.google.com/identity/protocols/googlescopes)**。**

**`gcloud`**のブラウザの資格情報がある場合、他のスコープでトークンを取得することも可能です。次のようなことを行います：

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAMポリシー、バインディング、およびメンバーシップ**

Terraformによって定義された[https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam)では、Terraformを使用してGCPでリソースに対するプリンシパルのアクセスを許可するための異なる方法があります。

* **メンバーシップ**: プリンシパルを**制限なしにロールのメンバーとして設定**します。ユーザーをロールのメンバーとして設定し、同じロールのメンバーとしてグループを設定し、これらのプリンシパル（ユーザーとグループ）を他のロールのメンバーとして設定することもできます。
* **バインディング**: 複数の**プリンシパルをロールにバインド**することができます。これらの**プリンシパルは他のロールにバインドされるか、他のロールのメンバーになることができます**。ただし、ロールにバインドされていないプリンシパルがバインドされたロールのメンバーとして設定された場合、**次にバインディングが適用されるとメンバーシップは消えます**。
* **ポリシー**: ポリシーは**権威的**であり、ロールとプリンシパルを示し、**そのポリシーが変更されるまで、それらのプリンシパルには追加のロールがなく、それらのロールには追加のプリンシパルがありません**（他のポリシー、バインディング、メンバーシップでもありません）。したがって、ポリシーでロールまたはプリンシパルが指定されている場合、そのポリシーによってその特権は**制限されます**。もちろん、プリンシパルにポリシーの変更権限や特権エスカレーションの許可（新しいプリンシパルを作成して新しいロールをバインドするなど）が与えられている場合、これは回避できます。

## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、当社の独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
