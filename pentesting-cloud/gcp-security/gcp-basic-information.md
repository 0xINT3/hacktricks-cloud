# GCP - Βασικές Πληροφορίες

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## **Ιεραρχία πόρων**

Η Google Cloud χρησιμοποιεί μια [Ιεραρχία πόρων](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) που είναι παρόμοια, έννοιακά, με αυτήν ενός παραδοσιακού συστήματος αρχείων. Αυτό παρέχει ένα λογικό ροή γονέα/παιδιού με συγκεκριμένα σημεία σύνδεσης για πολιτικές και άδειες.

Σε υψηλό επίπεδο, φαίνεται έτσι:
```
Organization
--> Folders
--> Projects
--> Resources
```
Ένα εικονικό μηχάνημα (που ονομάζεται Compute Instance) είναι ένας πόρος. Ένας πόρος βρίσκεται σε ένα έργο, πιθανώς δίπλα σε άλλα Compute Instances, κάδους αποθήκευσης κ.λπ.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Μεταφορά Έργων**

Είναι δυνατή η **μεταφορά ενός έργου χωρίς οργάνωση** σε μια οργάνωση με τις άδειες `roles/resourcemanager.projectCreator` και `roles/resourcemanager.projectMover`. Εάν το έργο βρίσκεται μέσα σε άλλη οργάνωση, είναι απαραίτητο να επικοινωνήσετε με την υποστήριξη του GCP για να **τα μετακινήσετε έξω από την οργάνωση πρώτα**. Για περισσότερες πληροφορίες, ανατρέξτε σε [**αυτό**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Πολιτικές Οργάνωσης**

Επιτρέπουν τον κεντρικό έλεγχο των πόρων του cloud της οργάνωσής σας:

* Κεντρικός έλεγχος για **περιορισμούς ρύθμισης** σχετικά με τον τρόπο χρήσης των πόρων της οργάνωσής σας.
* Ορισμός και θέσπιση **περιορισμών** για τις ομάδες ανάπτυξης σας, ώστε να παραμένουν εντός των ορίων συμμόρφωσης.
* Βοήθεια στους ιδιοκτήτες έργων και τις ομάδες τους να προχωρήσουν γρήγορα χωρίς ανησυχία για παραβίαση της συμμόρφωσης.

Αυτές οι πολιτικές μπορούν να δημιουργηθούν για να **επηρεάσουν την ολόκληρη οργάνωση, φάκελο(υποψήφιος) ή έργο(υποψήφιο)**. Οι απόγονοι του κατευθυνόμενου κόμβου της ιεραρχίας των πόρων κληρονομούν την πολιτική της οργάνωσης.

Για να **ορίσετε** μια πολιτική οργάνωσης, **επιλέγετε έναν** [**περιορισμό**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), που είναι ένας συγκεκριμένος τύπος περιορισμού είτε για έναν υπηρεσία του Google Cloud είτε για μια ομάδα υπηρεσιών του Google Cloud. Στη συνέχεια, **ρυθμίζετε αυτόν τον περιορισμό με τους επιθυμητούς περιορισμούς**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Συνηθισμένες περιπτώσεις χρήσης <a href="#common_use_cases" id="common_use_cases"></a>

* Περιορισμός κοινής χρήσης πόρων με βάση τον τομέα.
* Περιορισμός της χρήσης των λογαριασμών υπηρεσίας ταυτοποίησης και πρόσβασης.
* Περιορισμός της φυσικής τοποθεσίας των νεοδημιουργούμενων πόρων.
* Απενεργοποίηση δημιουργίας λογαριασμών υπηρεσίας.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Υπάρχουν πολλοί περιορισμοί που σας παρέχουν λεπτομερή έλεγχο των πόρων της οργάνωσής σας. Για **περισσότερες πληροφορίες, δείτε τη** [**λίστα όλων των περιορισμών της υπηρεσίας Πολιτικής Οργάνωσης**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Προεπιλεγμένες Πολιτικές Οργάνωσης**

<details>

<summary>Αυτές είναι οι πολιτικές που η Google θα προσθέσει από προεπιλογή κατά την εγκατάσταση της οργάνωσης GCP σας:</summary>

**Πολιτικές Διαχείρισης Πρόσβασης**

* **Περιορισμός επαφών περιορισμένου τομέα:** Αποτρέπει την προσθήκη χρηστών στις Βασικές Επαφές εκτός των καθορισμένων τομέων σας. Αυτό περιορίζει τις Βασικές Επαφές ώστε να επιτρέπουν μόνο ταυτοποιημένες ταυτότητες χρηστών που διαχειρίζεστε στους επιλεγμένους τομείς σα
## Χρήστες <a href="#default-credentials" id="default-credentials"></a>

Στο **GCP console** δεν υπάρχει διαχείριση Χρηστών ή Ομάδων, αυτό γίνεται στο **Google Workspace**. Ωστόσο, μπορείτε να συγχρονίσετε έναν διαφορετικό πάροχο ταυτότητας στο Google Workspace.

Μπορείτε να έχετε πρόσβαση στους χρήστες και τις ομάδες του Workspace στο [https://admin.google.com](https://admin.google.com/).

Η **πολυπαραγοντική ταυτοποίηση (MFA)** μπορεί να επιβληθεί στους χρήστες του Workspace, ωστόσο, ένας **επιτιθέμενος** μπορεί να χρησιμοποιήσει ένα διακριτικό για να έχει πρόσβαση στο GCP μέσω της γραμμής εντολών (cli) χωρίς να προστατεύεται από την πολυπαραγοντική ταυτοποίηση (θα προστατεύεται από την πολυπαραγοντική ταυτοποίηση μόνο όταν ο χρήστης συνδεθεί για να το δημιουργήσει: `gcloud auth login`).

## Ομάδες

Όταν δημιουργείται μια οργάνωση, συνιστάται ιδιαίτερα η δημιουργία ορισμένων ομάδων. Εάν διαχειρίζεστε οποιαδήποτε από αυτές, μπορεί να έχετε παραβιάσει ολόκληρη ή σημαντικό μέρος της οργάνωσης:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Ομάδα</strong></td><td><strong>Λειτουργία</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(απαιτούνται λογαριασμοί ομάδας ή ατόμων για τον έλεγχο)</em></td><td>Διαχείριση οποιουδήποτε πόρου που ανήκει στον οργανισμό. Αναθέστε αυτόν τον ρόλο με επιφύλαξη· οι διαχειριστές του οργανισμού έχουν πρόσβαση σε όλους τους πόρους του Google Cloud σας. Εναλλακτικά, επειδή αυτή η λειτουργία έχει υψηλά προνόμια, εξετάστε τη χρήση ατομικών λογαριασμών αντί να δημιουργήσετε μια ομάδα.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(απαιτούνται για τον έλεγχο)</em></td><td>Δημιουργία δικτύων, υποδικτύων, κανόνων τείχους προστασίας και συσκευών δικτύου, όπως Cloud Router, Cloud VPN και cloud load balancers.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(απαιτούνται για τον έλεγχο)</em></td><td>Ρύθμιση λογαριασμών χρέωσης και παρακολούθηση της χρήσης τους.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(απαιτούνται για τον έλεγχο)</em></td><td>Σχεδίαση, κωδικοποίηση και δοκιμή εφαρμογών.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Δημιουργία και διαχείριση πολιτικών ασφαλείας για ολόκληρο τον οργανισμό, συμπεριλαμβανομένης της διαχείρισης πρόσβασης και των πολιτικών περιορισμών οργανισμού. Δείτε τον οδηγό για τα θεμέλια ασφαλείας του Google Cloud για περισσότερες πληροφορίες σχετικά με τον σχεδιασμό της υποδομής ασφαλείας του Google Cloud σας.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Δημιουργία ή διαχείριση παραγωγικών διαδικασιών που υποστηρίζουν συνεχή ολοκλήρωση και παράδοση, παρακολούθηση και παροχή συστημάτων.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(δεν ισχύει πλέον από προεπιλογή)</em></td><td>Παρακολούθηση των δαπανών σε έργα. Οι τυπικοί χρήστες είναι μέλη της ομάδας οικονομικών.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(δεν ισχύει πλέον από προεπιλογή)</em></td><td>Αναθεώρηση πληροφοριών πόρων σε ολόκληρο τον οργανισμό του Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(δεν ισχύει πλέον από προεπιλογή)</em></td><td>Αναθεώρηση ασφάλειας του cloud.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(δεν ισχύει πλέον από προεπιλογή)</em></td><td>Αναθεώρηση ρυθμίσεων δικτύου.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(δεν ισχύει πλέον από προεπιλογή)</
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Ωστόσο, είναι επίσης δυνατόν να δημιουργήσετε και να συνδέσετε στους πόρους **προσαρμοσμένους λογαριασμούς υπηρεσίας**, οι οποίοι θα φαίνονται ως εξής:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Εύρος πρόσβασης**

Τα εύρη πρόσβασης είναι **συνδεδεμένα με τα παραγόμενα διαπιστευτήρια OAuth** για να έχουν πρόσβαση στα σημεία πρόσβασης του GCP API. Περιορίζουν τα δικαιώματα του διαπιστευτηρίου OAuth.\
Αυτό σημαίνει ότι αν ένα διαπιστευτήριο ανήκει σε έναν Κάτοχο ενός πόρου, αλλά δεν έχει το εύρος πρόσβασης στο διαπιστευτήριο για να έχει πρόσβαση σε αυτόν τον πόρο, το διαπιστευτήριο **δεν μπορεί να χρησιμοποιηθεί για να καταχραστεί αυτά τα προνόμια**.

Η Google προτείνει πραγματικά (https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) να **μην χρησιμοποιούνται τα εύρη πρόσβασης και να βασιστούμε αποκλειστικά στο IAM**. Το διαδικτυακό πύλης διαχείρισης επιβάλλει πραγματικά αυτό, αλλά τα εύρη πρόσβασης μπορούν ακόμα να εφαρμοστούν σε περιπτώσεις χρήσης προσαρμοσμένων λογαριασμών υπηρεσίας προγραμματιστικά.

Μπορείτε να δείτε ποια **εύρη** είναι **ανατεθειμένα** με **ερώτηση:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Οι προηγούμενες **εμβέλειες** είναι αυτές που δημιουργούνται από προεπιλογή χρησιμοποιώντας το **`gcloud`** για να αποκτήσετε πρόσβαση σε δεδομένα. Αυτό συμβαίνει επειδή όταν χρησιμοποιείτε το **`gcloud`** δημιουργείτε πρώτα ένα διακριτικό OAuth και στη συνέχεια το χρησιμοποιείτε για να επικοινωνήσετε με τα τερματικά σημεία.

Η πιο σημαντική εμβέλεια από αυτές είναι η **`cloud-platform`**, η οποία σημαίνει βασικά ότι είναι δυνατή η **πρόσβαση σε οποιαδήποτε υπηρεσία στο GCP**.

Μπορείτε να **βρείτε μια λίστα με** [**όλες τις δυνατές εμβέλειες εδώ**](https://developers.google.com/identity/protocols/googlescopes)**.**

Εάν έχετε διαπιστευτήρια περιήγησης **`gcloud`**, είναι δυνατό να **αποκτήσετε ένα διακριτικό με άλλες εμβέλειες**, κάνοντας κάτι τέτοιο:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Πολιτικές IAM, Δεσμεύσεις και Μέλη Terraform**

Όπως ορίζεται από το terraform στο [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam), χρησιμοποιώντας το terraform με το GCP υπάρχουν διάφοροι τρόποι για να δοθεί πρόσβαση σε έναν αρχή:

* **Μέλη**: Ορίζετε **αρχές ως μέλη ρόλων** **χωρίς περιορισμούς** σε σχέση με τον ρόλο ή τις αρχές. Μπορείτε να ορίσετε έναν χρήστη ως μέλος ενός ρόλου και στη συνέχεια να ορίσετε μια ομάδα ως μέλος του ίδιου ρόλου και επίσης να ορίσετε αυτές τις αρχές (χρήστη και ομάδα) ως μέλη άλλων ρόλων.
* **Δεσμεύσεις**: Πολλές **αρχές μπορούν να δεσμευτούν σε έναν ρόλο**. Αυτές οι **αρχές μπορούν ακόμα να δεσμευτούν ή να είναι μέλη άλλων ρόλων**. Ωστόσο, αν μια αρχή που δεν έχει δεσμευτεί στον ρόλο οριστεί ως **μέλος ενός δεσμευμένου ρόλου**, την επόμενη φορά που θα εφαρμοστεί η **δέσμευση, το μέλος θα εξαφανιστεί**.
* **Πολιτικές**: Μια πολιτική είναι **εξουσιοδοτική**, δηλώνει ρόλους και αρχές και στη συνέχεια, **αυτές οι αρχές δεν μπορούν να έχουν περισσότερους ρόλους και αυτοί οι ρόλοι δεν μπορούν να έχουν περισσότερες αρχές** εκτός αν αυτή η πολιτική τροποποιηθεί (ούτε καν σε άλλες πολιτικές, δεσμεύσεις ή μέλη). Επομένως, όταν ένας ρόλος ή μια αρχή καθορίζεται στην πολιτική, όλα τα προνόμια τους περιορίζονται από αυτήν την πολιτική. Φυσικά, αυτό μπορεί να παρακαμφθεί στην περίπτωση που η αρχή δίνεται η δυνατότητα να τροποποιήσει την πολιτική ή τα δικαιώματα αποκατάστασης προνομίων (όπως να δημιουργήσει έναν νέο αρχή και να του δεσμεύσει έναν νέο ρόλο).

## Αναφορές

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
