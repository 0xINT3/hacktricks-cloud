# GCP - Temel Bilgiler

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamını görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## **Kaynak hiyerarşisi**

Google Cloud, kavramsal olarak geleneksel bir dosya sistemiyle benzer olan bir [Kaynak hiyerarşisi](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) kullanır. Bu, politikalar ve izinler için belirli bir eklenti noktası olan mantıksal bir üst/alt iş akışı sağlar.

Yüksek seviyede, şu şekildedir:
```
Organization
--> Folders
--> Projects
--> Resources
```
Bir sanal makine (Compute Instance olarak adlandırılır) bir kaynaktır. Bir kaynak, muhtemelen diğer Compute Instance'lar, depolama kovaları vb. ile birlikte bir projede bulunur.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Proje Göçü**

Bir projeyi, `roles/resourcemanager.projectCreator` ve `roles/resourcemanager.projectMover` izinlerine sahip bir organizasyona **organizasyon olmadan** göç etmek mümkündür. Proje başka bir organizasyonun içindeyse, önce onları organizasyondan çıkarmak için GCP destek ekibiyle iletişime geçmek gerekmektedir. Daha fazla bilgi için [**buraya**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6) bakın.

## **Organizasyon Politikaları**

Organizasyonunuzun bulut kaynakları üzerinde merkezi kontrol sağlar:

* Organizasyonunuzun kaynaklarının nasıl kullanılabileceği üzerinde **kısıtlamaları yapılandırmak** için merkezi kontrol sağlar.
* Geliştirme ekiplerinin uyumluluk sınırları içinde kalmasını sağlamak için **sınırlamaları** tanımlar ve oluşturur.
* Proje sahipleri ve ekiplerinin uyumluluğu bozmadan hızlı bir şekilde ilerlemelerine yardımcı olur.

Bu politikalar, **tüm organizasyonu, klasör(ler)i veya proje(leri) etkileyebilir**. Hedeflenen kaynak hiyerarşisi düğümünün **alt öğeleri organizasyon politikasını devralır**.

Bir organizasyon politikasını **tanımlamak** için, Google Cloud hizmetine veya bir grup Google Cloud hizmetine karşı belirli bir kısıtlama türü olan bir [**kısıtlama**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints) seçersiniz. Bu kısıtlamayı, istediğiniz kısıtlamalarla yapılandırırsınız.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Ortak kullanım durumları <a href="#common_use_cases" id="common_use_cases"></a>

* Alan adına dayalı kaynak paylaşımını sınırlama.
* Kimlik ve Erişim Yönetimi hizmet hesaplarının kullanımını sınırlama.
* Yeni oluşturulan kaynakların fiziksel konumunu kısıtlama.
* Hizmet hesabı oluşturmayı devre dışı bırakma.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Organizasyonunuzun kaynakları üzerinde ayrıntılı kontrol sağlayan birçok başka kısıtlama bulunmaktadır. **Daha fazla bilgi için, tüm Organizasyon Politikası Hizmeti kısıtlamalarının listesine** [**buradan**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**bakın.**

### **Varsayılan Organizasyon Politikaları**

<details>

<summary>Google, GCP organizasyonunuzu kurarken varsayılan olarak ekleyeceği politikalar bunlardır:</summary>

**Erişim Yönetimi Politikaları**

* **Alan adı kısıtlı iletişim kişileri:** Belirtilen alanlar dışında Kritik İletişimlere kullanıcı eklenmesini engeller. Bu, yalnızca seçtiğiniz alanlardaki yönetilen kullanıcı kimliklerinin platform bildirimleri almasına izin verir.
* **Alan adı kısıtlı paylaşım:** IAM politikalarına belirtilen alanlar dışında kullanıcı eklenmesini engeller. Bu, yalnızca seçtiğiniz alanlardaki yönetilen kullanıcı kimliklerinin bu organizasyon içindeki kaynaklara erişmesine izin verir.
* **Herkese açık erişimi önleme:** Cloud Storage kovalarının halka açık hale gelmesini engeller. Bu, bir geliştiricinin Cloud Storage kovalarını kimliği doğrulanmamış internet erişimine sahip olacak şekilde yapılandırmasını engeller.
* **Birlikte kova düzeyinde erişimi etkinleştirme:** Cloud Storage kovalarındaki nesne düzeyinde erişim kontrol listelerini (ACL'ler) engeller. Bu, Cloud Storage kovalarındaki tüm nesnelere tutarlı bir şekilde IAM politikaları uygulayarak erişim yönetiminizi basitleştirir.
* **İşletim sistemi oturumu açmayı gerektirme:** Yeni projelerde oluşturulan sanal makinelerde işletim sistemi oturumu açmayı etkinleştirir. Bu, IAM kullanarak örneklerinize SSH erişimini yönetmenizi, ayrı ayrı SSH anahtarları oluşturmanıza ve yönetmenize gerek kalmadan yapmanızı sağlar.

**Hizmet hesapları için ek güvenlik politikaları**

* **Otomatik IAM izinlerini devre dışı bırakma**: Varsayılan App Engine ve Compute Engine hizmet hesaplarının projenin oluşturulduğunda otomatik olarak Editör IAM rolünü almalarını engeller. Bu, hizmet hesaplarının oluşturulduğunda aşırı izinli IAM rolleri almamasını sağlar.
* **Hizmet hesabı anahtar oluşturmayı devre dışı bırakma**: Genel hizmet hesabı anahtarlarının oluşturulmasını engeller. Bu, kalıcı kimlik bilgilerinin ifşa edilme riskini azaltmaya yardımcı olur.
* **Hizmet hesabı anahtar yüklemeyi devre dışı bırakma**: Genel hizmet hesabı anahtarlarının yüklenmesini engeller. Bu, sızdırılan veya yeniden kullanılan anahtar materyallerinin riskini azaltmaya yardımcı olur.

**Güvenli VPC ağı yapılandırma politikaları**

* **VM örnekleri için izin verilen harici IP'leri tanımlama**: Halka açık IP'ye sahip Compute örneklerinin oluşturulmasını engeller, bu da onları internet trafiğine maruz bırakabilir.

<!---->

* **VM iç içe sanallaştırmayı devre dışı bırakma**: Compute Engine VM'lerinde iç içe sanal makinelerin oluşturulmasını engeller. Bu, izlenmeyen iç içe sanal makinelerin güvenlik riskini azaltır.

<!---->

* **VM seri bağlantı noktasını devre dışı bırakma:** Compute Engine VM'lerine seri bağlantı noktası erişimini engeller. Bu, Compute Engine API'sını kullanarak sunucunun seri bağlantı noktasına girişi engeller.

<!---->

* **Cloud SQL örneklerinde yetkilendirilmiş ağları kısıtlama:** Genel veya iç ağ aralıklarının Cloud SQL veritabanlarınıza erişmesini engeller.

<!---->

* **IP Adresi Türüne Göre Protokol Yönlendirmesini Kısıtla:** Harici IP adresleri için VM protokol yönlendirmesini engeller.

<!---->

* **Cloud SQL örneklerinde Genel IP erişimini kısıtla:** Halka açık IP'ye sahip Cloud SQL örneklerinin oluşturulmasını engeller, bu da onları internet trafiğine maruz bırakabilir.

<!---->

* **Paylaşılan VPC proje lien kaldırmasını kısıtla:** Paylaşılan VPC ana bilgisayar projelerinin yanlışlıkla silinmesini engeller.

<!---->

* **Yeni projeler için iç DNS ayarını Yalnızca Bölgesel DNS olarak ayarlar:** Hizmet kullanılabilirliği azaltılmış olan eski bir DNS ayarının kullanılmasını engeller.

<!---->

* **Varsayılan ağ oluşturmayı atla:** Varsayılan VPC ağının ve ilgili kaynakların otomatik olarak oluşturulmasını engeller. Bu, aşırı izinli varsayılan güvenlik duvarı kurallarından kaçınmanızı sağlar.

<!---->

* **VPC Harici IPv6 kullanımını devre dışı bırakma:** Harici IPv6 alt ağlarının oluşturulmasını engeller, bu da yetkisiz internet erişimine maruz kalabilir.

</details>

## **
## Kullanıcılar <a href="#default-credentials" id="default-credentials"></a>

**GCP konsolunda** **Kullanıcılar veya Gruplar** yönetimi yoktur, bu işlem **Google Workspace** üzerinde gerçekleştirilir. Bununla birlikte, farklı bir kimlik sağlayıcıyı Google Workspace'e senkronize edebilirsiniz.

Workspaces kullanıcılarına ve gruplarına [**https://admin.google.com**](https://admin.google.com/) adresinden erişebilirsiniz.

**MFA**, Workspaces kullanıcılarına **zorunlu** hale getirilebilir, ancak bir **saldırgan**, MFA tarafından korunmayan GCP'ye erişmek için bir belirteç kullanabilir (kullanıcı yalnızca bunu oluşturmak için oturum açtığında MFA tarafından korunur: `gcloud auth login`).

## Gruplar

Bir organizasyon oluşturulduğunda, birkaç grup **kesinlikle oluşturulması önerilir**. Bunlardan herhangi birini yönetiyorsanız, tüm organizasyonu veya önemli bir bölümünü tehlikeye atabilirsiniz:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grup</strong></td><td><strong>İşlev</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(kontrol listesi için gereken grup veya bireysel hesaplar)</em></td><td>Organizasyona ait herhangi bir kaynağı yönetme. Bu rolü dikkatli bir şekilde atayın; org yöneticileri tüm Google Cloud kaynaklarına erişime sahiptir. Alternatif olarak, bu işlev yüksek ayrıcalıklı olduğu için bir grup oluşturmak yerine bireysel hesapları kullanmayı düşünebilirsiniz.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(kontrol listesi için gereken grup)</em></td><td>Ağlar, alt ağlar, güvenlik duvarı kuralları ve Cloud Router, Cloud VPN ve bulut yük dengeleyicileri gibi ağ cihazları oluşturma.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(kontrol listesi için gereken grup)</em></td><td>Fatura hesaplarını kurma ve kullanımlarını izleme.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(kontrol listesi için gereken grup)</em></td><td>Uygulamaları tasarlama, kodlama ve test etme.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Tüm organizasyon için erişim yönetimi ve <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">organizasyon kısıtlama politikaları</a> dahil olmak üzere güvenlik politikalarını oluşturma ve yönetme. Google Cloud güvenlik temelleri kılavuzunda Google Cloud güvenlik altyapınızı planlama hakkında daha fazla bilgi için bkz.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Sürekli entegrasyon ve dağıtımı destekleyen, izleme ve sistem sağlama süreçlerini oluşturma veya yönetme.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(artık varsayılan olarak yok)</em></td><td>Projelerdeki harcamaları izleme. Tipik üyeler finans ekibinin bir parçasıdır.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(artık varsayılan olarak yok)</em></td><td>Google Cloud organizasyonu genelinde kaynak bilgilerini inceleme.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(artık varsayılan olarak yok)</em></td><td>Bulut güvenliğini inceleme.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(artık varsayılan olarak yok)</em></td><td>Ağ yapılandırmalarını inceleme.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(artık varsayılan olarak yok)</em></td><td>Denetim günlüklerini görüntüleme.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(artık varsayılan olarak yok)</em></td><td>Security Command Center'ı yönetme.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(artık varsayılan olarak yok)</em></td><td>Secret Manager'da gizli bilgileri yönetme.</td></tr></tbody></table>

## **Varsayılan Parola Politikası**

* Güçlü parolaları zorunlu kılma
* 8 ile 100 karakter arası
* Tekrar kullanım yok
* Süresi dolma yok
* İnsanlar, Workspace'e üçüncü taraf sağlayıcı aracılığıyla erişiyorsa, bu gereksinimler uygulanmaz.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Hizmet hesapları**

Bunlar, kaynakların GCP ile kolayca etkileşimde bulunabilmesi için **eklenebilecek** ve erişebilecek **öznelerdir**. Örneğin, bir VM'ye **bağlı bir Hizmet Hesabının** kimlik doğrulama belirteci **metadata**'da erişilebilir.

IAM rolleri AWS'deki gibi benzerdir. Ancak AWS'den farklı olarak, **herhangi bir** hizmet hesabı **herhangi bir hizmete eklenebilir** (bunu bir politika aracılığıyla izin vermesi gerekmez).

Karşılaşabileceğiniz hizmet hesaplarının birçoğu aslında GCP'yi kullanmaya başladığınızda **otomatik olarak oluşturulur**, örneğin:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Ancak, özel hizmet hesapları oluşturmak ve bunları kaynaklara eklemek de mümkündür. Bu hesaplar aşağıdaki gibi görünecektir:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **Erişim kapsamları**

Erişim kapsamları, GCP API uç noktalarına erişmek için oluşturulan OAuth belirteçlerine **eklenir**. Bu, OAuth belirteğinin izinlerini **sınırlar**.

Bu, bir belirteğin bir kaynağın Sahibi olmasına rağmen, belirtekte kaynağa erişmek için kapsam olmadığı durumlarda, belirteğin bu ayrıcalıkları **kullanarak (kötüye) kullanılamayacağı** anlamına gelir.

Google aslında [önerir](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) ki **erişim kapsamları kullanılmasın ve tamamen IAM'a güvenilsin**. Web yönetim portalı aslında bunu zorunlu kılar, ancak erişim kapsamları hala özel hizmet hesapları kullanılarak programatik olarak örnekler üzerinde uygulanabilir.

**Kapsamların** ne olduğunu **sorgulayarak** görebilirsiniz:

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Önceki **kapsamlar**, verilere erişmek için **`gcloud`** kullanarak oluşturulan varsayılan kapsamlardır. Bunun nedeni, **`gcloud`** kullanırken önce bir OAuth belirteci oluşturmanız ve ardından uç noktalara erişmek için bunu kullanmanızdır.

Bu kapsamlar arasında en önemlisi muhtemelen **`cloud-platform`** dur, bu da temel olarak GCP'deki **herhangi bir hizmete erişilebileceği** anlamına gelir.

[**Burada tüm olası kapsamların bir listesini bulabilirsiniz**](https://developers.google.com/identity/protocols/googlescopes)**.**

Eğer **`gcloud`** tarayıcı kimlik bilgilerine sahipseniz, başka kapsamlara sahip bir belirteç **edinmek mümkündür**, şu şekilde bir şey yaparak:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Politikaları, Bağlantılar ve Üyelikler**

Terraform tarafından tanımlandığı gibi [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) kullanarak GCP ile terraform kullanarak bir özneye bir kaynağa erişim vermenin farklı yolları vardır:

* **Üyelikler**: **Öznelere kısıtlama olmadan rollerin üyesi olarak öznelere** **üyeler olarak ayarlanır**. Bir kullanıcıyı bir rolün üyesi olarak ayarlayabilir ve aynı rolün bir üyesi olarak bir grup ayarlayabilir ve bu özneleri (kullanıcı ve grup) diğer rollerin üyesi olarak ayarlayabilirsiniz.
* **Bağlantılar**: Birden fazla **özne bir role bağlanabilir**. Bu **özneler hala bağlanabilir veya diğer rollerin üyesi olabilir**. Ancak, bir role bağlı olmayan bir özne, bir bağlı role **üye olarak ayarlandığında, bir sonraki bağlama uygulandığında üyelik kaybolur**.
* **Politikalar**: Bir politika **yetkilidir**, rolleri ve özneleri belirtir ve sonra, **bu öznelerin daha fazla rolü ve bu rollerin daha fazla öznesi olamaz** (başka politikalarda, bağlantılarda veya üyeliklerde bile). Dolayısıyla, bir rol veya özne politikada belirtilmişse, tüm yetkileri **o politika tarafından sınırlanır**. Elbette, bu, öznenin politikayı değiştirme veya ayrıcalık yükseltme izinlerine sahip olması durumunda atlanabilir (yeni bir özne oluşturmak ve ona yeni bir rol bağlamak gibi).

## Referanslar

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak isterseniz** veya HackTricks'i **PDF olarak indirmek isterseniz** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>
