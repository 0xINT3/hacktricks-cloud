# GCP - Informaci칩n B치sica

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Jerarqu칤a de recursos**

Google Cloud utiliza una [jerarqu칤a de recursos](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) que es similar, conceptualmente, a la de un sistema de archivos tradicional. Esto proporciona un flujo de trabajo l칩gico de padre/hijo con puntos de conexi칩n espec칤ficos para pol칤ticas y permisos.

A un alto nivel, se ve as칤:
```
Organization
--> Folders
--> Projects
--> Resources
```
Una m치quina virtual (llamada Instancia de Computaci칩n) es un recurso. Un recurso reside en un proyecto, probablemente junto a otras Instancias de Computaci칩n, buckets de almacenamiento, etc.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Migraci칩n de Proyectos**

Es posible **migrar un proyecto sin ninguna organizaci칩n** a una organizaci칩n con los permisos `roles/resourcemanager.projectCreator` y `roles/resourcemanager.projectMover`. Si el proyecto est치 dentro de otra organizaci칩n, es necesario contactar al soporte de GCP para **moverlos fuera de la organizaci칩n primero**. Para m치s informaci칩n, consulta [**esto**](https://medium.com/google-cloud/migrating-a-project-from-one-organization-to-another-gcp-4b37a86dd9e6).

## **Pol칤ticas de Organizaci칩n**

Permiten centralizar el control sobre los recursos en la nube de su organizaci칩n:

* Centralizar el control para **configurar restricciones** sobre c칩mo se pueden usar los recursos de su organizaci칩n.
* Definir y establecer **barreras de protecci칩n** para que sus equipos de desarrollo se mantengan dentro de los l칤mites de cumplimiento.
* Ayudar a los propietarios de proyectos y sus equipos a avanzar r치pidamente sin preocuparse de romper el cumplimiento.

Estas pol칤ticas se pueden crear para **afectar a toda la organizaci칩n, carpetas o proyectos**. Los descendientes del nodo de la jerarqu칤a de recursos objetivo **heredan la pol칤tica de organizaci칩n**.

Para **definir** una pol칤tica de organizaci칩n, **eliges una** [**restricci칩n**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints), que es un tipo particular de restricci칩n contra un servicio de Google Cloud o un grupo de servicios de Google Cloud. **Configuras esa restricci칩n con las restricciones deseadas**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### Casos de uso comunes <a href="#common_use_cases" id="common_use_cases"></a>

* Limitar la compartici칩n de recursos basada en dominio.
* Limitar el uso de cuentas de servicio de Identity and Access Management.
* Restringir la ubicaci칩n f칤sica de los recursos reci칠n creados.
* Deshabilitar la creaci칩n de cuentas de servicio

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

Hay muchas m치s restricciones que le dan un control detallado de los recursos de su organizaci칩n. Para **m치s informaci칩n, consulta la** [**lista de todas las restricciones del Servicio de Pol칤tica de Organizaci칩n**](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.**

### **Pol칤ticas de Organizaci칩n Predeterminadas**

<details>

<summary>Estas son las pol칤ticas que Google agregar치 por defecto al configurar su organizaci칩n de GCP:</summary>

**Pol칤ticas de Gesti칩n de Acceso**

* **Contactos restringidos por dominio:** Evita agregar usuarios a Contactos Esenciales fuera de sus dominios especificados. Esto limita los Contactos Esenciales para permitir solo identidades de usuario gestionadas en sus dominios seleccionados para recibir notificaciones de la plataforma.
* **Compartici칩n restringida por dominio:** Evita agregar usuarios a pol칤ticas de IAM fuera de sus dominios especificados. Esto limita las pol칤ticas de IAM para permitir solo identidades de usuario gestionadas en sus dominios seleccionados para acceder a recursos dentro de esta organizaci칩n.
* **Prevenci칩n de acceso p칰blico:** Evita que los buckets de Cloud Storage sean expuestos al p칰blico. Esto asegura que un desarrollador no pueda configurar buckets de Cloud Storage para tener acceso a internet sin autenticaci칩n.
* **Acceso uniforme a nivel de bucket:** Evita listas de control de acceso (ACLs) a nivel de objeto en buckets de Cloud Storage. Esto simplifica su gesti칩n de acceso aplicando pol칤ticas de IAM de manera consistente en todos los objetos en buckets de Cloud Storage.
* **Requerir inicio de sesi칩n en OS:** Las VM creadas en proyectos nuevos tendr치n el inicio de sesi칩n en OS habilitado. Esto le permite gestionar el acceso SSH a sus instancias usando IAM sin necesidad de crear y gestionar claves SSH individuales.

**Pol칤ticas de seguridad adicionales para cuentas de servicio**

* **Deshabilitar concesiones autom치ticas de IAM**: Evita que las cuentas de servicio predeterminadas de App Engine y Compute Engine reciban autom치ticamente el rol de IAM de Editor en un proyecto al crearse. Esto asegura que las cuentas de servicio no reciban roles de IAM excesivamente permisivos al crearse.
* **Deshabilitar la creaci칩n de claves de cuenta de servicio**: Evita la creaci칩n de claves p칰blicas de cuenta de servicio. Esto ayuda a reducir el riesgo de exponer credenciales persistentes.
* **Deshabilitar la subida de claves de cuenta de servicio**: Evita la subida de claves p칰blicas de cuenta de servicio. Esto ayuda a reducir el riesgo de claves filtradas o reutilizadas.

**Pol칤ticas de configuraci칩n de red VPC segura**

* **Definir IPs externas permitidas para instancias de VM**: Evita la creaci칩n de instancias de Computaci칩n con una IP p칰blica, lo que puede exponerlas al tr치fico de internet.

<!---->

* **Deshabilitar la virtualizaci칩n anidada en VM**: Evita la creaci칩n de VMs anidadas en VMs de Compute Engine. Esto disminuye el riesgo de seguridad de tener VMs anidadas no monitoreadas.

<!---->

* **Deshabilitar puerto serie en VM:** Evita el acceso al puerto serie en VMs de Compute Engine. Esto previene la entrada a un puerto serie de un servidor usando la API de Compute Engine.

<!---->

* **Restringir redes autorizadas en instancias de Cloud SQL:** Evita que rangos de redes p칰blicas o no internas accedan a sus bases de datos de Cloud SQL.

<!---->

* **Restringir el reenv칤o de protocolo basado en tipo de direcci칩n IP:** Evita el reenv칤o de protocolo de VM para direcciones IP externas.

<!---->

* **Restringir el acceso a IP p칰blicas en instancias de Cloud SQL:** Evita la creaci칩n de instancias de Cloud SQL con una IP p칰blica, lo que puede exponerlas al tr치fico de internet.

<!---->

* **Restringir la eliminaci칩n de gravamen de proyecto VPC compartido:** Evita la eliminaci칩n accidental de proyectos anfitriones de VPC compartidos.

<!---->

* **Establecer la configuraci칩n de DNS interna para proyectos nuevos a solo DNS zonal:** Evita el uso de una configuraci칩n de DNS heredada que tiene disponibilidad de servicio reducida.

<!---->

* **Omitir la creaci칩n de red predeterminada:** Evita la creaci칩n autom치tica de la red VPC predeterminada y recursos relacionados. Esto evita reglas de firewall predeterminadas excesivamente permisivas.

<!---->

* **Deshabilitar el uso de IPv6 externo en VPC:** Evita la creaci칩n de subredes IPv6 externas, que pueden estar expuestas a acceso a internet no autorizado.

</details>

## **Roles de IAM**

Son como las pol칤ticas de IAM en AWS ya que **cada rol contiene un conjunto de permisos.**

Sin embargo, a diferencia de AWS, no hay un **repositorio centralizado** de roles. En su lugar, **los recursos otorgan roles de acceso X a los principios Y**, y la 칰nica forma de averiguar qui칠n tiene acceso a un recurso es usar el **m칠todo `get-iam-policy` sobre ese recurso**.\
Esto podr칤a ser un problema porque esto significa que la 칰nica forma de averiguar **qu칠 permisos tiene un principio es preguntar a cada recurso a qui칠n est치 otorgando permisos**, y un usuario podr칤a no tener permisos para obtener permisos de todos los recursos.

Hay **tres tipos** de roles en IAM:

* **Roles b치sicos/primitivos**, que incluyen los roles de **Propietario**, **Editor** y **Visualizador** que exist칤an antes de la introducci칩n de IAM.
* **Roles predefinidos**, que proporcionan acceso granular para un servicio espec칤fico y son gestionados por Google Cloud. Hay muchos roles predefinidos, puedes **ver todos ellos con los privilegios que tienen** [**aqu칤**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles).
* **Roles personalizados**, que proporcionan acceso granular seg칰n una lista de permisos especificada por el usuario.

Hay miles de permisos en GCP. Para verificar si un rol tiene un permiso, puedes [**buscar el permiso aqu칤**](https://cloud.google.com/iam/docs/permissions-reference) y ver qu칠 roles lo tienen.

Tambi칠n puedes [**buscar aqu칤 roles predefinidos**](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation) **ofrecidos por cada producto.** Ten en cuenta que algunos **roles** no se pueden adjuntar a usuarios y **solo a cuentas de servicio porque algunos permisos** que contienen.\
Adem치s, ten en cuenta que los **permisos** solo **tendr치n efecto** si est치n **adjuntos al servicio relevante.**

O verifica si un **rol personalizado puede usar un** [**permiso espec칤fico aqu칤**](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.**

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## Usuarios <a href="#default-credentials" id="default-credentials"></a>

En **consola de GCP** no hay gesti칩n de **Usuarios o Grupos**, eso se hace en **Google Workspace**. Aunque podr칤as sincronizar un proveedor de identidad diferente en Google Workspace.

Puedes acceder a **usuarios y grupos de Workspaces en** [**https://admin.google.com**](https://admin.google.com/).

**MFA** puede ser **forzado** a usuarios de Workspaces, sin embargo, un **atacante** podr칤a usar un token para acceder a GCP **a trav칠s de cli que no estar치 protegido por MFA** (estar치 protegido por MFA solo cuando el usuario inicie sesi칩n para generarlo: `gcloud auth login`).

## Grupos

Cuando se crea una organizaci칩n, se **sugiere encarecidamente crear varios grupos.** Si gestionas alguno de ellos, podr칤as haber comprometido todo o una parte importante de la organizaci칩n:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Grupo</strong></td><td><strong>Funci칩n</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(grupo o cuentas individuales requeridas para la lista de verificaci칩n)</em></td><td>Administrar cualquier recurso que pertenezca a la organizaci칩n. Asigna este rol con moderaci칩n; los administradores de la organizaci칩n tienen acceso a todos sus recursos de Google Cloud. Alternativamente, debido a que esta funci칩n es altamente privilegiada, considera usar cuentas individuales en lugar de crear un grupo.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Crear redes, subredes, reglas de firewall y dispositivos de red como Cloud Router, Cloud VPN y balanceadores de carga en la nube.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Configurar cuentas de facturaci칩n y monitorear su uso.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(requerido para la lista de verificaci칩n)</em></td><td>Dise침ar, codificar y probar aplicaciones.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Establecer y gestionar pol칤ticas de seguridad para toda la organizaci칩n, incluyendo la gesti칩n de acceso y <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">pol칤ticas de restricci칩n de organizaci칩n</a>. Consulta la <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">gu칤a de fundamentos de seguridad de Google Cloud</a> para m치s informaci칩n sobre c칩mo planificar tu infraestructura de seguridad de Google Cloud.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Crear o gestionar pipelines de extremo a extremo que soporten integraci칩n y entrega continuas, monitoreo y aprovisionamiento de sistemas.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Monitorear el gasto en proyectos. Los miembros t칤picos son parte del equipo financiero.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar la informaci칩n de recursos a trav칠s de la organizaci칩n de Google Cloud.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar la seguridad en la nube.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Revisar configuraciones de red.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(ya no por defecto)</em></td><td>Ver registros de auditor칤a.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(ya no por defecto)</em></td><td>Administrar el Centro de Comando de Seguridad.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(ya no por defecto)</em></td><td>Gestionar secretos en el Gestor de Secretos.</td></tr></tbody></table>

## **Pol칤tica de Contrase침a Predeterminada**

* Exigir contrase침as fuertes
* Entre 8 y 100 caracteres
* Sin reutilizaci칩n
* Sin caducidad
* Si las personas acceden a Workspace a trav칠s de un proveedor de terceros, estos requisitos no se aplican.

<figure><img src="../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>



## **Cuentas de servicio**

Estos son los principios a los que **los recursos** pueden **estar adjuntos** y tener acceso para interactuar f치cilmente con GCP. Por ejemplo, es posible acceder al **token de autenticaci칩n** de una Cuenta de Servicio **adjunta a una VM** en los metadatos.\
Es posible encontrar algunos **conflictos** al usar tanto **IAM como 치mbitos de acceso**. Por ejemplo, tu cuenta de servicio puede tener el rol de IAM de `compute.instanceAdmin` pero la instancia que has vulnerado ha sido limitada con la restricci칩n de 치mbito de `https://www.googleapis.com/auth/compute.readonly`. Esto te impedir칤a hacer cualquier cambio usando el token OAuth que se asigna autom치ticamente a tu instancia.

Es similar a **roles de IAM de AWS**. Pero a diferencia de AWS, **cualquier** cuenta de servicio puede estar **adjunta a cualquier servicio** (no necesita permitirlo a trav칠s de una pol칤tica).

Varios de las cuentas de servicio que encontrar치s son en realidad **generadas autom치ticamente por GCP** cuando comienzas a usar un servicio, como:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
Sin embargo, tambi칠n es posible crear y adjuntar a los recursos **cuentas de servicio personalizadas**, que se ver치n as칤:
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **츼mbitos de acceso**

Los 치mbitos de acceso est치n **vinculados a los tokens OAuth generados** para acceder a los puntos finales de la API de GCP. Estos **restringen los permisos** del token OAuth.\
Esto significa que si un token pertenece a un Propietario de un recurso pero no tiene el 치mbito en el token para acceder a ese recurso, el token **no puede ser utilizado para (ab)usar esos privilegios**.

Google realmente [recomienda](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) que **no se utilicen los 치mbitos de acceso y confiar totalmente en IAM**. El portal de gesti칩n web de hecho lo exige, pero los 치mbitos de acceso todav칤a pueden aplicarse a instancias utilizando cuentas de servicio personalizadas program치ticamente.

Puedes ver qu칠 **치mbitos** est치n **asignados** mediante **consulta:** 

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

Los **alcances** anteriores son los que se generan por **defecto** al usar **`gcloud`** para acceder a datos. Esto se debe a que cuando usas **`gcloud`**, primero creas un token OAuth y luego lo usas para contactar con los puntos finales.

El alcance m치s importante de esos potencialmente es **`cloud-platform`**, lo que b치sicamente significa que es posible **acceder a cualquier servicio en GCP**.

Puedes **encontrar una lista de** [**todos los posibles alcances aqu칤**](https://developers.google.com/identity/protocols/googlescopes)**.**

Si tienes credenciales de navegador **`gcloud`**, es posible **obtener un token con otros alcances,** haciendo algo como:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
## **Pol칤ticas de IAM, Vinculaciones y Membres칤as de Terraform**

Como define terraform en [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) al usar terraform con GCP hay diferentes maneras de otorgar acceso a un principal sobre un recurso:

* **Membres칤as**: Estableces **principales como miembros de roles** **sin restricciones** sobre el rol o los principales. Puedes poner a un usuario como miembro de un rol y luego poner a un grupo como miembro del mismo rol y tambi칠n establecer esos principales (usuario y grupo) como miembro de otros roles.
* **Vinculaciones**: Varios **principales pueden estar vinculados a un rol**. Esos **principales a칰n pueden estar vinculados o ser miembros de otros roles**. Sin embargo, si un principal que no est치 vinculado al rol se establece como **miembro de un rol vinculado**, la pr칩xima vez que se aplique la **vinculaci칩n, la membres칤a desaparecer치**.
* **Pol칤ticas**: Una pol칤tica es **autoritativa**, indica roles y principales y luego, **esos principales no pueden tener m치s roles y esos roles no pueden tener m치s principales** a menos que se modifique esa pol칤tica (ni siquiera en otras pol칤ticas, vinculaciones o membres칤as). Por lo tanto, cuando un rol o principal se especifica en pol칤tica, todos sus privilegios est치n **limitados por esa pol칤tica**. Obviamente, esto se puede eludir en caso de que al principal se le d칠 la opci칩n de modificar la pol칤tica o permisos de escalada de privilegios (como crear un nuevo principal y vincularle un nuevo rol).

## Referencias

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras maneras de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
