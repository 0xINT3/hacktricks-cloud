# GCP - Abus de f√©d√©ration

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## OIDC - Abus de Github Actions

### GCP

Afin de donner **acc√®s aux Github Actions** d'un d√©p√¥t Github √† un **compte de service GCP**, les √©tapes suivantes sont n√©cessaires :

* **Cr√©er le compte de service** pour acc√©der aux actions Github avec les **permissions souhait√©es :**

```bash
projectId=FIXME
gcloud config set project $projectId

# Cr√©er le compte de service
gcloud iam service-accounts create "github-demo-sa"
saId="github-demo-sa@${projectId}.iam.gserviceaccount.com"

# Activer l'API IAM Credentials
gcloud services enable iamcredentials.googleapis.com

# Donner des autorisations au compte de service

gcloud projects add-iam-policy-binding $projectId \
    --member="serviceAccount:$saId" \
    --role="roles/iam.securityReviewer"
```

* G√©n√©rer un **nouveau pool d'identit√©s de charge de travail** :

```bash
# Cr√©er un pool d'identit√©s de charge de travail
poolName=wi-pool

gcloud iam workload-identity-pools create $poolName \
  --location global \
  --display-name $poolName

poolId=$(gcloud iam workload-identity-pools describe $poolName \
  --location global \
  --format='get(name)')
```

* G√©n√©rer un nouveau **fournisseur d'identit√© OIDC de pool d'identit√©s de charge de travail** qui **fait confiance** aux actions Github (par nom d'organisation/d√©p√¥t dans ce sc√©nario) :

```bash
attributeMappingScope=repository # pourrait √™tre sub (d√©p√¥t et branche GitHub) ou repository_owner (organisation GitHub)

gcloud iam workload-identity-pools providers create-oidc $poolName \
  --location global \
  --workload-identity-pool $poolName \
  --display-name $poolName \
  --attribute-mapping "google.subject=assertion.${attributeMappingScope},attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository" \
  --issuer-uri "https://token.actions.githubusercontent.com"

providerId=$(gcloud iam workload-identity-pools providers describe $poolName \
  --location global \
  --workload-identity-pool $poolName \
  --format='get(name)')
```

* Enfin, **autoriser le principal** du fournisseur √† utiliser un principal de service :

```bash
gitHubRepoName="repo-org/nom-du-repo"
gcloud iam service-accounts add-iam-policy-binding $saId \
  --role "roles/iam.workloadIdentityUser" \
  --member "principalSet://iam.googleapis.com/${poolId}/attribute.${attributeMappingScope}/${gitHubRepoName}"
```

{% hint style="warning" %}
Notez comment dans le membre pr√©c√©dent, nous sp√©cifions le **`nom-de-l'org/nom-du-repo`** comme conditions pour pouvoir acc√©der au compte de service (d'autres param√®tres qui le rendent **plus restrictif** comme la branche pourraient √©galement √™tre utilis√©s).

Cependant, il est √©galement possible de **permettre √† tous les utilisateurs de Github d'acc√©der** au compte de service en cr√©ant un fournisseur tel que celui-ci en utilisant un joker :
{% endhint %}

<pre class="language-bash"><code class="lang-bash"># Cr√©er un pool d'identit√©s de charge de travail
poolName=wi-pool2

gcloud iam workload-identity-pools create $poolName \
  --location global \
  --display-name $poolName

poolId=$(gcloud iam workload-identity-pools describe $poolName \
  --location global \
  --format='get(name)')

gcloud iam workload-identity-pools providers create-oidc $poolName \
  --project="${projectId}" \
  --location="global" \
  --workload-identity-pool="$poolName" \
  --display-name="Demo provider" \
  --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.aud=assertion.aud" \
  --issuer-uri="https://token.actions.githubusercontent.com"

providerId=$(gcloud iam workload-identity-pools providers describe $poolName \
  --location global \
  --workload-identity-pool $poolName \
  --format='get(name)')

<strong># V√âRIFIER LE JOKER
</strong>gcloud iam service-accounts add-iam-policy-binding "${saId}" \
  --project="${projectId}" \
  --role="roles/iam.workloadIdentityUser" \
<strong>  --member="principalSet://iam.googleapis.com/${poolId}/*"
</strong></code></pre>

{% hint style="warning" %}
Dans ce cas, n'importe qui pourrait acc√©der au compte de service √† partir des actions Github, il est donc important de **v√©rifier toujours comment le membre est d√©fini**.\
Il devrait toujours √™tre quelque chose comme ceci :&#x20;

`attribute.{custom_attribute}`:`principalSet://iam.googleapis.com/projects/{project}/locations/{location}/workloadIdentityPools/{pool}/attribute.{custom_attribute}/{value}`
{% endhint %}

### Github

N'oubliez pas de changer **`${providerId}`** et **`${saId}`** pour leurs valeurs respectives :

```yaml
name: Check GCP action
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main

permissions:
  id-token: write

jobs:
  Get_OIDC_ID_token:
    runs-on: ubuntu-latest
    steps:
    - id: 'auth'
      name: 'Authenticate to GCP'
      uses: 'google-github-actions/auth@v0.3.1'
      with:
          create_credentials_file: 'true'
          workload_identity_provider: '${providerId}'
          service_account: '${saId}'
    - id: 'gcloud'
      name: 'gcloud'
      run: |-
        gcloud auth login --brief --cred-file="${{ steps.auth.outputs.credentials_file_path }}"
        gcloud auth list
        gcloud projects list
```

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>