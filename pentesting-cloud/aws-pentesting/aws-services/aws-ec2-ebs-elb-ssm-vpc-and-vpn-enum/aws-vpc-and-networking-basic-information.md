# AWS - VPC & Informa√ß√µes B√°sicas de Rede

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Rede AWS em Resumo

Um **VPC** cont√©m um **CIDR de rede** como 10.0.0.0/16 (com sua **tabela de roteamento** e **ACL de rede**).

Esta rede VPC √© dividida em **sub-redes**, ent√£o uma **sub-rede** est√° diretamente **relacionada** com o **VPC**, **tabela de roteamento** e **ACL de rede**.

Ent√£o, **Interfaces de Rede** anexadas a servi√ßos (como inst√¢ncias EC2) s√£o **conectadas** √†s **sub-redes** com **grupo(s) de seguran√ßa**.

Portanto, um **grupo de seguran√ßa** limitar√° as portas expostas das interfaces de rede **usando-o**, **independentemente da sub-rede**. E uma **ACL de rede** limitar√° as portas expostas para a **rede inteira**.

Al√©m disso, para **acessar a Internet**, existem algumas configura√ß√µes interessantes a verificar:

* Uma **sub-rede** pode **atribuir automaticamente endere√ßos IPv4 p√∫blicos**
* Uma **inst√¢ncia** criada na rede que **atribui automaticamente endere√ßos IPv4 pode obter um**
* Um **gateway de Internet** precisa ser **anexado** ao **VPC**
* Voc√™ tamb√©m pode usar **gateways de Internet somente de sa√≠da**
* Voc√™ tamb√©m pode ter um **gateway NAT** em uma **sub-rede privada** para que seja poss√≠vel **conectar-se a servi√ßos externos** a partir dessa sub-rede privada, mas **n√£o √© poss√≠vel alcan√ß√°-los de fora**.
* O gateway NAT pode ser **p√∫blico** (acesso √† internet) ou **privado** (acesso a outros VPCs)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

O **Virtual Private Cloud** (VPC) da Amazon permite que voc√™ **inicie recursos AWS em uma rede virtual** que voc√™ definiu. Esta rede virtual ter√° v√°rias sub-redes, Gateways de Internet para acesso √† Internet, ACLs, grupos de seguran√ßa, IPs...

### Sub-redes

Sub-redes ajudam a impor um maior n√≠vel de seguran√ßa. **Agrupamento l√≥gico de recursos semelhantes** tamb√©m ajuda a manter uma **facilidade de gerenciamento** em sua infraestrutura.

* CIDRs v√°lidos v√£o de uma m√°scara de rede /16 a uma /28.
* Uma sub-rede n√£o pode estar em zonas de disponibilidade diferentes ao mesmo tempo.
* **AWS reserva os tr√™s primeiros endere√ßos IP de host** de cada sub-rede **para uso interno da AWS**: o primeiro endere√ßo de host usado √© para o roteador VPC. O segundo endere√ßo √© reservado para o DNS da AWS e o terceiro endere√ßo √© reservado para uso futuro.
* S√£o chamadas **sub-redes p√∫blicas** aquelas que t√™m **acesso direto √† Internet, enquanto as sub-redes privadas n√£o t√™m.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabelas de Roteamento

Tabelas de roteamento determinam o roteamento de tr√°fego para uma sub-rede dentro de um VPC. Elas determinam qual tr√°fego de rede √© encaminhado para a internet ou para uma conex√£o VPN. Voc√™ geralmente encontrar√° acesso ao:

* VPC local
* NAT
* Gateways de Internet / Gateways de Internet somente de sa√≠da (necess√°rios para dar acesso √† Internet a um VPC).
* Para tornar uma sub-rede p√∫blica, voc√™ precisa **criar** e **anexar** um **gateway de Internet** ao seu VPC.
* Pontos de extremidade VPC (para acessar o S3 de redes privadas)

Nas seguintes imagens, voc√™ pode verificar as diferen√ßas em uma rede p√∫blica padr√£o e uma privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>
### ACLs

**Listas de Controle de Acesso √† Rede (ACLs)**: ACLs de rede s√£o regras de firewall que controlam o tr√°fego de rede de entrada e sa√≠da de uma sub-rede. Podem ser usadas para permitir ou negar tr√°fego para endere√ßos IP espec√≠ficos ou faixas.

* √â mais comum permitir/negar acesso usando grupos de seguran√ßa, mas esta √© a √∫nica maneira de cortar completamente shells reversos estabelecidos. Uma regra modificada em um grupo de seguran√ßa n√£o interrompe conex√µes j√° estabelecidas
* No entanto, isso se aplica a toda a sub-rede, tenha cuidado ao proibir coisas, pois a funcionalidade necess√°ria pode ser perturbada

### Grupos de Seguran√ßa

Grupos de seguran√ßa s√£o um **firewall virtual** que controla o tr√°fego de rede **de entrada e sa√≠da para inst√¢ncias** em um VPC. Rela√ß√£o de 1 SG para M inst√¢ncias (geralmente 1 para 1).\
Geralmente, isso √© usado para abrir portas perigosas em inst√¢ncias, como a porta 22, por exemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Endere√ßos IP El√°sticos

Um _Endere√ßo IP El√°stico_ √© um **endere√ßo IPv4 est√°tico** projetado para computa√ß√£o em nuvem din√¢mica. Um Endere√ßo IP El√°stico √© alocado √† sua conta AWS e √© seu at√© que voc√™ o libere. Ao usar um Endere√ßo IP El√°stico, voc√™ pode mascarar a falha de uma inst√¢ncia ou software remapeando rapidamente o endere√ßo para outra inst√¢ncia em sua conta.

### Conex√£o entre sub-redes

Por padr√£o, todas as sub-redes t√™m o **atribui√ß√£o autom√°tica de endere√ßos IP p√∫blicos desativada**, mas isso pode ser ativado.

**Uma rota local dentro de uma tabela de rotas permite a comunica√ß√£o entre sub-redes do VPC.**

Se voc√™ est√° **conectando uma sub-rede com uma sub-rede diferente, voc√™ n√£o pode acessar as sub-redes conectadas** com a outra sub-rede, voc√™ precisa criar conex√£o com elas diretamente. **Isso tamb√©m se aplica a gateways de internet**. Voc√™ n√£o pode passar por uma conex√£o de sub-rede para acessar a internet, voc√™ precisa atribuir o gateway de internet √† sua sub-rede.

### VPC Peering

O peering de VPC permite que voc√™ **conecte dois ou mais VPCs juntos**, usando IPV4 ou IPV6, como se fossem parte da mesma rede.

Uma vez que a conectividade de peering √© estabelecida, **recursos em um VPC podem acessar recursos no outro**. A conectividade entre os VPCs √© implementada atrav√©s da infraestrutura de rede existente da AWS, e por isso √© altamente dispon√≠vel sem gargalo de largura de banda. Como **conex√µes peered operam como se fossem parte da mesma rede**, existem restri√ß√µes quanto aos blocos CIDR que podem ser usados.\
Se voc√™ tem **blocos CIDR sobrepostos ou duplicados** para o seu VPC, ent√£o **voc√™ n√£o poder√° fazer o peering dos VPCs** juntos.\
Cada VPC da AWS **s√≥ se comunicar√° com seu par**. Por exemplo, se voc√™ tem uma conex√£o de peering entre VPC 1 e VPC 2, e outra conex√£o entre VPC 2 e VPC 3, como mostrado, ent√£o VPC 1 e 2 poderiam se comunicar diretamente um com o outro, assim como VPC 2 e VPC 3, no entanto, VPC 1 e VPC 3 n√£o poderiam. **Voc√™ n√£o pode rotear atrav√©s de um VPC para chegar a outro.**

### **VPC Flow Logs**

Dentro do seu VPC, voc√™ pode ter centenas ou at√© milhares de recursos todos se comunicando entre diferentes sub-redes, p√∫blicas e privadas, e tamb√©m entre diferentes VPCs atrav√©s de conex√µes de peering de VPC. **VPC Flow Logs permitem que voc√™ capture informa√ß√µes de tr√°fego IP que fluem entre as interfaces de rede de seus recursos dentro do seu VPC**.

Ao contr√°rio dos logs de acesso S3 e CloudFront, os **dados de log gerados pelos VPC Flow Logs n√£o s√£o armazenados no S3. Em vez disso, os dados de log capturados s√£o enviados para os logs do CloudWatch**.

Limita√ß√µes:

* Se voc√™ est√° executando uma conex√£o peered de VPC, ent√£o voc√™ s√≥ poder√° ver os flow logs de VPCs peered que est√£o dentro da mesma conta.
* Se voc√™ ainda est√° executando recursos dentro do ambiente EC2-Classic, ent√£o infelizmente voc√™ n√£o poder√° recuperar informa√ß√µes de suas interfaces
* Uma vez que um VPC Flow Log foi criado, ele n√£o pode ser alterado. Para alterar a configura√ß√£o do VPC Flow Log, voc√™ precisa exclu√≠-lo e depois criar um novo.
* O seguinte tr√°fego n√£o √© monitorado e capturado pelos logs. Tr√°fego DHCP dentro do VPC, tr√°fego de inst√¢ncias destinado ao Servidor DNS da Amazon.
* Qualquer tr√°fego destinado ao endere√ßo IP do roteador padr√£o do VPC e tr√°fego para e dos seguintes endere√ßos, 169.254.169.254 que √© usado para coletar metadados da inst√¢ncia, e 169.254.169.123 que √© usado para o Servi√ßo de Sincroniza√ß√£o de Tempo da Amazon.
* Tr√°fego relacionado a uma licen√ßa de ativa√ß√£o do Windows da Amazon de uma inst√¢ncia Windows
* Tr√°fego entre uma interface de balanceador de carga de rede e uma interface de rede de ponto final

Para cada interface de rede que publica dados no grupo de logs do CloudWatch, ela usar√° um fluxo de log diferente. E dentro de cada um desses fluxos, haver√° os dados do evento de log de fluxo que mostram o conte√∫do das entradas de log. Cada um desses **logs captura dados durante uma janela de aproximadamente 10 a 15 minutos**.

## VPN

### VPN Site-to-Site

**Conecte sua rede local com seu VPC.**

* **Conex√£o VPN**: Uma conex√£o segura entre seu equipamento local e seus VPCs.
*   **T√∫nel VPN**: Um link criptografado onde os dados podem passar da rede do cliente para ou da AWS.

Cada conex√£o VPN inclui dois t√∫neis VPN que voc√™ pode usar simultaneamente para alta disponibilidade.
* **Gateway do cliente**: Um recurso da AWS que fornece informa√ß√µes √† AWS sobre o seu dispositivo de gateway do cliente.
* **Dispositivo de gateway do cliente**: Um dispositivo f√≠sico ou aplicativo de software do seu lado da conex√£o VPN Site-to-Site.
* **Gateway privado virtual**: O concentrador VPN do lado da Amazon da conex√£o VPN Site-to-Site. Voc√™ usa um gateway privado virtual ou um gateway de tr√¢nsito como o gateway do lado da Amazon da conex√£o VPN Site-to-Site.
* **Gateway de tr√¢nsito**: Um hub de tr√¢nsito que pode ser usado para interconectar seus VPCs e redes locais. Voc√™ usa um gateway de tr√¢nsito ou gateway privado virtual como o gateway do lado da Amazon da conex√£o VPN Site-to-Site.

#### Limita√ß√µes

* Tr√°fego IPv6 n√£o √© suportado para conex√µes VPN em um gateway privado virtual.
* Uma conex√£o VPN da AWS n√£o suporta Descoberta de MTU de Caminho.

Al√©m disso, leve em considera√ß√£o o seguinte ao usar VPN Site-to-Site.

* Ao conectar seus VPCs a uma rede local comum, recomendamos que voc√™ use blocos CIDR n√£o sobrepostos para suas redes.
### Componentes do Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Conecte-se da sua m√°quina ao seu VPC**

#### Conceitos

* **Ponto de t√©rmino do Client VPN:** O recurso que voc√™ cria e configura para habilitar e gerenciar sess√µes de Client VPN. √â o recurso onde todas as sess√µes de Client VPN s√£o terminadas.
* **Rede de destino:** Uma rede de destino √© a rede que voc√™ associa a um ponto de t√©rmino do Client VPN. **Uma sub-rede de um VPC √© uma rede de destino**. Associar uma sub-rede a um ponto de t√©rmino do Client VPN permite que voc√™ estabele√ßa sess√µes de VPN. Voc√™ pode associar v√°rias sub-redes a um ponto de t√©rmino do Client VPN para alta disponibilidade. Todas as sub-redes devem ser do mesmo VPC. Cada sub-rede deve pertencer a uma Zona de Disponibilidade diferente.
* **Rota**: Cada ponto de t√©rmino do Client VPN tem uma tabela de rotas que descreve as rotas de rede de destino dispon√≠veis. Cada rota na tabela de rotas especifica o caminho para o tr√°fego para recursos ou redes espec√≠ficos.
* **Regras de autoriza√ß√£o:** Uma regra de autoriza√ß√£o **restringe os usu√°rios que podem acessar uma rede**. Para uma rede especificada, voc√™ configura o grupo do Active Directory ou provedor de identidade (IdP) que tem permiss√£o de acesso. Apenas usu√°rios pertencentes a este grupo podem acessar a rede especificada. **Por padr√£o, n√£o h√° regras de autoriza√ß√£o** e voc√™ deve configurar regras de autoriza√ß√£o para permitir que os usu√°rios acessem recursos e redes.
* **Cliente:** O usu√°rio final que se conecta ao ponto de t√©rmino do Client VPN para estabelecer uma sess√£o de VPN. Os usu√°rios finais precisam baixar um cliente OpenVPN e usar o arquivo de configura√ß√£o do Client VPN que voc√™ criou para estabelecer uma sess√£o de VPN.
* **Faixa de CIDR do cliente:** Uma faixa de endere√ßos IP de onde atribuir endere√ßos IP do cliente. Cada conex√£o ao ponto de t√©rmino do Client VPN recebe um endere√ßo IP √∫nico da faixa de CIDR do cliente. Voc√™ escolhe a faixa de CIDR do cliente, por exemplo, `10.2.0.0/16`.
* **Portas do Client VPN:** O AWS Client VPN suporta as portas 443 e 1194 para TCP e UDP. O padr√£o √© a porta 443.
* **Interfaces de rede do Client VPN:** Quando voc√™ associa uma sub-rede ao seu ponto de t√©rmino do Client VPN, criamos interfaces de rede do Client VPN nessa sub-rede. **O tr√°fego enviado ao VPC a partir do ponto de t√©rmino do Client VPN √© enviado atrav√©s de uma interface de rede do Client VPN**. A tradu√ß√£o de endere√ßo de rede de origem (SNAT) √© ent√£o aplicada, onde o endere√ßo IP de origem da faixa de CIDR do cliente √© traduzido para o endere√ßo IP da interface de rede do Client VPN.
* **Registro de conex√£o:** Voc√™ pode habilitar o registro de conex√£o para o seu ponto de t√©rmino do Client VPN para registrar eventos de conex√£o. Voc√™ pode usar essas informa√ß√µes para realizar forenses, analisar como seu ponto de t√©rmino do Client VPN est√° sendo usado ou depurar problemas de conex√£o.
* **Portal de autoatendimento:** Voc√™ pode habilitar um portal de autoatendimento para o seu ponto de t√©rmino do Client VPN. Os clientes podem fazer login no portal baseado na web usando suas credenciais e baixar a vers√£o mais recente do arquivo de configura√ß√£o do ponto de t√©rmino do Client VPN ou a vers√£o mais recente do cliente fornecido pela AWS.

#### Limita√ß√µes

* **As faixas de CIDR do cliente n√£o podem se sobrepor ao CIDR local** do VPC no qual a sub-rede associada est√° localizada, ou a quaisquer rotas adicionadas manualmente √† tabela de rotas do ponto de t√©rmino do Client VPN.
* As faixas de CIDR do cliente devem ter um tamanho de bloco de pelo menos **/22** e n√£o devem ser maiores que **/12**.
* Uma **parte dos endere√ßos** na faixa de CIDR do cliente √© usada para **suportar o modelo de disponibilidade** do ponto de t√©rmino do Client VPN e n√£o pode ser atribu√≠da a clientes. Portanto, recomendamos que voc√™ **atribua um bloco de CIDR que contenha o dobro do n√∫mero de endere√ßos IP que s√£o necess√°rios** para habilitar o n√∫mero m√°ximo de conex√µes simult√¢neas que voc√™ planeja suportar no ponto de t√©rmino do Client VPN.
* A **faixa de CIDR do cliente n√£o pode ser alterada** ap√≥s a cria√ß√£o do ponto de t√©rmino do Client VPN.
* As **sub-redes** associadas a um ponto de t√©rmino do Client VPN **devem estar no mesmo VPC**.
* Voc√™ **n√£o pode associar v√°rias sub-redes da mesma Zona de Disponibilidade a um ponto de t√©rmino do Client VPN**.
* Um ponto de t√©rmino do Client VPN **n√£o suporta associa√ß√µes de sub-rede em um VPC de loca√ß√£o dedicada**.
* O Client VPN suporta apenas tr√°fego **IPv4**.
* O Client VPN **n√£o √©** compat√≠vel com os Padr√µes Federais de Processamento de Informa√ß√µes (**FIPS**).
*   Se a autentica√ß√£o de m√∫ltiplos fatores (MFA) estiver desativada para o seu Active Directory, uma senha de usu√°rio n√£o pode estar no seguinte formato.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* O portal de autoatendimento **n√£o est√° dispon√≠vel para clientes que autenticam usando autentica√ß√£o m√∫tua**.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
