# AWS - VPC和网络基本信息

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## AWS网络简介

**VPC**包含一个类似于10.0.0.0/16的**网络CIDR**（具有其**路由表**和**网络ACL**）。

这个VPC网络被划分为**子网**，因此**子网**与**VPC**、**路由表**和**网络ACL**直接相关。

然后，附加到服务（如EC2实例）的**网络接口**与**子网**通过**安全组**连接。

因此，**安全组**将限制使用它的网络**接口的暴露端口**，**与子网无关**。而**网络ACL**将限制对**整个网络**的暴露端口。

此外，为了**访问互联网**，有一些有趣的配置需要检查：

* **子网**可以**自动分配公共IPv4地址**
* 在**自动分配IPv4地址的网络**中创建的**实例**可以获得一个
* 需要将**Internet网关**附加到**VPC**
* 您还可以使用**仅出口的Internet网关**
* 您还可以在**私有子网**中拥有一个**NAT网关**，以便从该私有子网连接到外部服务，但**无法从外部访问它们**。
* NAT网关可以是**公共的**（访问互联网）或**私有的**（访问其他VPC）

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud**（Amazon VPC）使您能够将AWS资源启动到您定义的虚拟网络中。这个虚拟网络将有多个子网、用于访问互联网的Internet网关、ACL、安全组、IP等。

### 子网

子网有助于实施更高级别的安全性。**类似资源的逻辑分组**还可以帮助您在基础架构中保持**管理的便利性**。

* 有效的CIDR范围是从/16掩码到/28掩码。
* 一个子网不能同时位于不同的可用区。
* **AWS保留每个子网的前三个主机IP地址**用于**内部AWS使用**：第一个主机地址用于VPC路由器。第二个地址保留给AWS DNS，第三个地址保留供将来使用。
* **直接访问互联网的子网称为公共子网，而无法直接访问互联网的子网称为私有子网。**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### 路由表

路由表确定VPC中子网的流量路由。它们确定哪些网络流量转发到互联网或VPN连接。通常可以访问以下内容：

* 本地VPC
* NAT
* Internet网关/仅出口的Internet网关（为VPC提供访问互联网所需）
* 要使子网公开，您需要在VPC中**创建**并**附加**一个**Internet网关**。
* VPC终端节点（用于从私有网络访问S3）

在下面的图片中，您可以查看默认公共网络和私有网络之间的区别：

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>
### ACLs

**网络访问控制列表（ACL）**：网络ACL是用于控制子网的入站和出站网络流量的防火墙规则。它们可以用于允许或拒绝对特定IP地址或范围的流量。

- 使用安全组允许/拒绝访问是最常见的方法，但这只是完全切断已建立的反向shell的方式。安全组中的修改规则不会停止已建立的连接。
- 然而，这适用于整个子网，禁止某些内容时要小心，因为可能会干扰所需的功能。

### 安全组

安全组是用于控制VPC中实例的入站和出站网络流量的虚拟防火墙。通常，一个安全组对应多个实例（通常是1对1）。
通常用于打开实例中的危险端口，例如端口22：

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### 弹性IP地址

弹性IP地址是专为动态云计算而设计的静态IPv4地址。弹性IP地址分配给您的AWS账户，并且在您释放它之前一直属于您。通过使用弹性IP地址，您可以通过快速重新映射地址到您账户中的另一个实例来掩盖实例或软件的故障。

### 子网之间的连接

默认情况下，所有子网都关闭了自动分配公共IP地址的功能，但可以打开。

路由表中的本地路由使VPC子网之间可以通信。

如果您连接一个子网与另一个子网，您无法访问与另一个子网连接的子网，您需要直接与它们创建连接。这也适用于互联网网关。您不能通过子网连接访问互联网，您需要将互联网网关分配给您的子网。

### VPC对等连接

VPC对等连接允许您将两个或多个VPC连接在一起，使用IPv4或IPv6，就像它们是同一网络的一部分一样。

一旦建立了对等连接，一个VPC中的资源可以访问另一个VPC中的资源。VPC之间的连接是通过现有的AWS网络基础设施实现的，因此具有高可用性且没有带宽瓶颈。由于对等连接的操作就像它们是同一网络的一部分，因此在使用CIDR块范围时存在限制。
如果您的VPC具有重叠或重复的CIDR范围，则无法将VPC连接在一起。
每个AWS VPC只与其对等体通信。例如，如果您在VPC 1和VPC 2之间建立了对等连接，并且在VPC 2和VPC 3之间建立了另一个连接，那么VPC 1和VPC 2可以直接相互通信，VPC 2和VPC 3也可以，但是VPC 1和VPC 3不能。您不能通过一个VPC路由到另一个VPC。

### VPC流量日志

在您的VPC中，您可能有数百甚至数千个资源，在不同的子网之间以及通过VPC对等连接在不同的VPC之间进行通信。VPC流量日志允许您捕获VPC内资源的网络接口之间流动的IP流量信息。

与S3访问日志和CloudFront访问日志不同，VPC流量日志生成的日志数据不存储在S3中。相反，捕获的日志数据被发送到CloudWatch日志中。

限制：

- 如果您正在运行VPC对等连接，则只能查看同一账户中的对等VPC的流量日志。
- 如果您仍在EC2-Classic环境中运行资源，则无法从其接口中检索信息。
- 创建了VPC流量日志后，无法更改。要更改VPC流量日志配置，您需要删除它，然后重新创建一个新的。
- 日志不会监视和捕获以下流量：VPC内的DHCP流量，发送到Amazon DNS服务器的实例流量。
- 发送到VPC默认路由器的流量以及与以下地址之间的流量：169.254.169.254用于收集实例元数据，169.254.169.123用于Amazon时间同步服务。
- 与Windows实例的Amazon Windows激活许可相关的流量
- 网络负载均衡器接口与端点网络接口之间的流量

对于每个发布数据到CloudWatch日志组的网络接口，它将使用不同的日志流。在每个流中，将显示日志条目的流量日志事件数据。每个日志都在大约10到15分钟的时间窗口内捕获数据。

## VPN

### 站点到站点VPN

**将您的本地网络与VPC连接起来。**

- **VPN连接**：您的本地设备与VPC之间的安全连接。
- **VPN隧道**：可以在其中传递数据的加密链接，从客户网络到AWS或从AWS到客户网络。

每个VPN连接包括两个VPN隧道，您可以同时使用这两个隧道以实现高可用性。
- **客户网关**：提供有关您的客户网关设备的信息的AWS资源。
- **客户网关设备**：位于站点到站点VPN连接的您一侧的物理设备或软件应用程序。
- **虚拟专用网关**：位于站点到站点VPN连接的Amazon一侧的VPN集中器。您可以使用虚拟专用网关或传输网关作为站点到站点VPN连接的网关。
- **传输网关**：可用于互连您的VPC和本地网络的传输中心。您可以使用传输网关或虚拟专用网关作为站点到站点VPN连接的网关。

#### 限制

- 虚拟专用网关上不支持IPv6流量的VPN连接。
- AWS VPN连接不支持路径MTU发现。

此外，在使用站点到站点VPN时，请考虑以下事项。

- 当将您的VPC连接到共同的本地网络时，我们建议为您的网络使用不重叠的CIDR块。
### 客户端 VPN 的组件 <a href="#what-is-components" id="what-is-components"></a>

**从您的机器连接到您的 VPC**

#### 概念

* **客户端 VPN 终端节点：**您创建和配置的资源，用于启用和管理客户端 VPN 会话。这是所有客户端 VPN 会话终止的资源。
* **目标网络：**目标网络是与客户端 VPN 终端节点关联的网络。**VPC 的子网是目标网络**。将子网与客户端 VPN 终端节点关联，可以建立 VPN 会话。您可以将多个子网与客户端 VPN 终端节点关联以实现高可用性。所有子网必须来自同一个 VPC。每个子网必须属于不同的可用区。
* **路由：**每个客户端 VPN 终端节点都有一个路由表，描述可用的目标网络路由。路由表中的每个路由指定了流量到特定资源或网络的路径。
* **授权规则：**授权规则**限制可以访问网络的用户**。对于指定的网络，您配置允许访问的 Active Directory 或身份提供者 (IdP) 组。只有属于此组的用户才能访问指定的网络。**默认情况下，没有授权规则**，您必须配置授权规则以使用户能够访问资源和网络。
* **客户端：**连接到客户端 VPN 终端节点以建立 VPN 会话的终端用户。终端用户需要下载 OpenVPN 客户端，并使用您创建的客户端 VPN 配置文件来建立 VPN 会话。
* **客户端 CIDR 范围：**用于分配客户端 IP 地址的 IP 地址范围。每个连接到客户端 VPN 终端节点的连接都会从客户端 CIDR 范围中分配一个唯一的 IP 地址。您可以选择客户端 CIDR 范围，例如 `10.2.0.0/16`。
* **客户端 VPN 端口：**AWS 客户端 VPN 支持 TCP 和 UDP 的端口 443 和 1194。默认端口是 443。
* **客户端 VPN 网络接口：**当您将子网与客户端 VPN 终端节点关联时，我们会在该子网中创建客户端 VPN 网络接口。从客户端 VPN 终端节点发送到 VPC 的流量会通过客户端 VPN 网络接口发送。然后应用源网络地址转换 (SNAT)，将来自客户端 CIDR 范围的源 IP 地址转换为客户端 VPN 网络接口的 IP 地址。
* **连接日志记录：**您可以为客户端 VPN 终端节点启用连接日志记录，以记录连接事件。您可以使用此信息进行取证，分析客户端 VPN 终端节点的使用情况，或调试连接问题。
* **自助门户：**您可以为客户端 VPN 终端节点启用自助门户。客户可以使用自己的凭据登录到基于 Web 的门户，并下载最新版本的客户端 VPN 终端节点配置文件或 AWS 提供的最新版本客户端。

#### 限制

* **客户端 CIDR 范围不能与关联子网所在的 VPC 的本地 CIDR 重叠**，也不能与手动添加到客户端 VPN 终端节点路由表的任何路由重叠。
* 客户端 CIDR 范围的块大小必须至少为 **/22**，且不能大于 **/12**。
* 客户端 CIDR 范围的**一部分地址**用于支持客户端 VPN 终端节点的可用性模型，并且不能分配给客户端。因此，我们建议您**分配一个包含所需最大并发连接数两倍的 IP 地址数量的 CIDR 块**，以支持计划在客户端 VPN 终端节点上支持的最大并发连接数。
* 创建客户端 VPN 终端节点后，**无法更改客户端 CIDR 范围**。
* 与客户端 VPN 终端节点关联的**子网必须位于同一个 VPC** 中。
* **不能将同一可用区的多个子网与客户端 VPN 终端节点关联**。
* 客户端 VPN 终端节点**不支持在专用租户 VPC 中关联子网**。
* 客户端 VPN 仅支持 **IPv4** 流量。
* 客户端 VPN 不符合 **联邦信息处理标准 (FIPS)**。
* 如果您的 Active Directory 禁用了多因素身份验证 (MFA)，则用户密码不能采用以下格式。

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* 自助门户**不适用于使用相互身份验证进行身份验证的客户端**。

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您希望在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS 的最新版本或下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或在 **Twitter** 上关注我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub 仓库提交 PR 来分享您的黑客技巧**。

</details>
