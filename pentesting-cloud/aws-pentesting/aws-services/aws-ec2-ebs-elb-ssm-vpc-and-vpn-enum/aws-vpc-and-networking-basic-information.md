# AWS - Informaci칩n b치sica de VPC y Networking

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## AWS Networking en pocas palabras

Un **VPC** contiene un **CIDR de red** como 10.0.0.0/16 (con su **tabla de enrutamiento** y **ACL de red**).

Esta red VPC se divide en **subredes**, por lo que una **subred** est치 directamente **relacionada** con el **VPC**, la **tabla de enrutamiento** y la **ACL de red**.

Luego, las **interfaces de red** conectadas a los servicios (como las instancias EC2) est치n **conectadas** a las **subredes** con **grupos de seguridad**.

Por lo tanto, un **grupo de seguridad** limitar치 los puertos expuestos de las **interfaces de red que lo usan**, **independientemente de la subred**. Y una **ACL de red** limitar치 los puertos expuestos a toda la red.

Adem치s, para **acceder a Internet**, hay algunas configuraciones interesantes que verificar:

* Una **subred** puede **asignar autom치ticamente direcciones IPv4 p칰blicas**
* Una **instancia** creada en la red que **asigna autom치ticamente direcciones IPv4 puede obtener una**
* Se necesita un **gateway de Internet** para estar **adjunto** al **VPC**
  * Tambi칠n se pueden usar **gateways de Internet solo de salida**
* Tambi칠n se puede tener un **gateway NAT** en una **subred privada** para que sea posible **conectarse a servicios externos** desde esa subred privada, pero **no es posible alcanzarlos desde el exterior**.
  * El gateway NAT puede ser **p칰blico** (acceso a Internet) o **privado** (acceso a otros VPC)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) te permite **lanzar recursos de AWS en una red virtual** que has definido. Esta red virtual tendr치 varios subnets, gateways de Internet para acceder a Internet, ACL, grupos de seguridad, IPs...

### Subnets

Los subnets ayudan a imponer un mayor nivel de seguridad. La **agrupaci칩n l칩gica de recursos similares** tambi칠n te ayuda a mantener una **facilidad de gesti칩n** en toda tu infraestructura.

* Los CIDR v치lidos van desde una m치scara de red /16 hasta una m치scara de red /28.
* Un subnet no puede estar en diferentes zonas de disponibilidad al mismo tiempo.
* **AWS reserva las tres primeras direcciones IP de host** de cada subnet **para uso interno de AWS**: la primera direcci칩n de host utilizada es para el router VPC. La segunda direcci칩n est치 reservada para AWS DNS y la tercera direcci칩n est치 reservada para uso futuro.
* Se llaman **subredes p칰blicas** a aquellas que tienen **acceso directo a Internet, mientras que las subredes privadas no lo tienen.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tablas de enrutamiento

Las tablas de enrutamiento determinan el enrutamiento del tr치fico para un subnet dentro de un VPC. Determinan qu칠 tr치fico de red se reenv칤a a Internet o a una conexi칩n VPN. Por lo general, tendr치s acceso a:

* VPC local
* NAT
* Gateways de Internet / Gateways de Internet solo de salida (necesarios para dar acceso a un VPC a Internet).
  * Para hacer que una subred sea p칰blica, necesitas **crear** y **adjuntar** un **gateway de Internet** a tu VPC.
* Puntos de enlace de VPC (para acceder a S3 desde redes privadas)

En las siguientes im치genes puedes comprobar las diferencias en una red p칰blica predeterminada y una privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_Kay
### **Registros de flujo de VPC**

Dentro de su VPC, potencialmente podr칤a tener cientos o incluso miles de recursos que se comunican entre diferentes subredes tanto p칰blicas como privadas y tambi칠n entre diferentes VPC a trav칠s de conexiones de interconexi칩n de VPC. **Los registros de flujo de VPC le permiten capturar informaci칩n de tr치fico IP que fluye entre las interfaces de red de sus recursos dentro de su VPC**.

A diferencia de los registros de acceso de S3 y los registros de acceso de CloudFront, **los datos de registro generados por los registros de flujo de VPC no se almacenan en S3. En su lugar, los datos de registro capturados se env칤an a los registros de CloudWatch**.

Limitaciones:

* Si est치 ejecutando una conexi칩n de interconexi칩n de VPC, solo podr치 ver los registros de flujo de las VPC interconectadas que se encuentran dentro de la misma cuenta.
* Si a칰n est치 ejecutando recursos dentro del entorno EC2-Classic, lamentablemente no podr치 recuperar informaci칩n de sus interfaces.
* Una vez que se ha creado un registro de flujo de VPC, no se puede cambiar. Para modificar la configuraci칩n del registro de flujo de VPC, debe eliminarlo y luego crear uno nuevo.
* El siguiente tr치fico no se supervisa ni se captura en los registros. Tr치fico DHCP dentro de la VPC, tr치fico desde instancias destinadas al servidor DNS de Amazon.
* Cualquier tr치fico destinado a la direcci칩n IP del enrutador predeterminado de la VPC y tr치fico hacia y desde las siguientes direcciones, 169.254.169.254 que se utiliza para recopilar metadatos de instancia, y 169.254.169.123 que se utiliza para el servicio de sincronizaci칩n de tiempo de Amazon.
* Tr치fico relacionado con una licencia de activaci칩n de Windows de Amazon desde una instancia de Windows
* Tr치fico entre una interfaz de balanceador de carga de red y una interfaz de red de punto final

Para cada interfaz de red que publica datos en el grupo de registros de CloudWatch, se utilizar치 un flujo de registro diferente. Y dentro de cada uno de estos flujos, habr치 datos de eventos de registro de flujo que muestran el contenido de las entradas de registro. Cada uno de estos **registros captura datos durante una ventana de aproximadamente 10 a 15 minutos**.

## VPN

### VPN de sitio a sitio

**Conecte su red local con su VPC.**

* **Conexi칩n VPN**: una conexi칩n segura entre su equipo local y sus VPC.
* **T칰nel VPN**: un enlace cifrado donde los datos pueden pasar desde la red del cliente hacia o desde AWS.

    Cada conexi칩n VPN incluye dos t칰neles VPN que puede usar simult치neamente para alta disponibilidad.
* **Puerta de enlace del cliente**: un recurso de AWS que proporciona informaci칩n a AWS sobre su dispositivo de puerta de enlace del cliente.
* **Dispositivo de puerta de enlace del cliente**: un dispositivo f칤sico o una aplicaci칩n de software en su lado de la conexi칩n VPN de sitio a sitio.
* **Puerta de enlace privada virtual**: el concentrador VPN en el lado de Amazon de la conexi칩n VPN de sitio a sitio. Utiliza una puerta de enlace privada virtual o una puerta de enlace de tr치nsito como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de sitio a sitio.
* **Puerta de enlace de tr치nsito**: un concentrador de tr치nsito que se puede utilizar para interconectar sus VPC y redes locales. Utiliza una puerta de enlace de tr치nsito o una puerta de enlace privada virtual como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de sitio a sitio.

#### Limitaciones

* El tr치fico IPv6 no es compatible con las conexiones VPN en una puerta de enlace privada virtual.
* Una conexi칩n VPN de AWS no admite el descubrimiento de MTU de ruta.

Adem치s, tenga en cuenta lo siguiente cuando use VPN de sitio a sitio.

* Al conectar sus VPC a una red local com칰n, recomendamos que use bloques CIDR no superpuestos para sus redes.

### Componentes de VPN de cliente <a href="#what-is-components" id="what-is-components"></a>

**Con칠ctese desde su m치quina a su VPC**

#### Conceptos

* **Punto de conexi칩n de VPN de cliente:** el recurso que crea y configura para habilitar y administrar sesiones de VPN de cliente. Es el recurso donde se terminan todas las sesiones de VPN de cliente.
* **Red de destino:** una red de destino es la red que se asocia con un punto de conexi칩n de VPN de cliente. **Una subred de una VPC es una red de destino**. Asociar una subred con un punto de conexi칩n de VPN de cliente le permite establecer sesiones VPN. Puede asociar varias subredes con un punto de conexi칩n de VPN de cliente para alta disponibilidad. Todas las subredes deben ser de la misma VPC. Cada subred debe pertenecer a una zona de disponibilidad diferente.
* **Ruta**: cada punto de conexi칩n de VPN de cliente tiene una tabla de rutas que describe las rutas de red de destino disponibles. Cada ruta en la tabla de rutas especifica la ruta para el tr치fico hacia recursos o redes espec칤ficos.
* **Reglas de autorizaci칩n:** una regla de autorizaci칩n **restringe a los usuarios que pueden acceder a una red**. Para una red especificada, configura el grupo de Active Directory o proveedor de identidad (IdP) que tiene acceso permitido. Solo los usuarios que pertenecen a este grupo pueden acceder a la red especificada. **Por defecto, no hay reglas de autorizaci칩n** y debe configurar reglas de autorizaci칩n para permitir que los usuarios accedan a recursos y redes.
* **Cliente:** el usuario final que se conecta al punto de conexi칩n de VPN de cliente para establecer una sesi칩n VPN. Los usuarios finales deben descargar un cliente OpenVPN y usar el archivo de configuraci칩n de VPN de cliente que cre칩 para establecer una sesi칩n VPN.
* **Rango de CIDR de cliente:** un rango de direcciones IP desde el cual asignar direcciones IP de cliente. A cada conexi칩n al punto de conexi칩n de VPN de cliente se le asigna una direcci칩n IP 칰nica del rango de CIDR de cliente. Elija el rango de CIDR de cliente, por ejemplo, `10.2.0.0/16`.
* **Puertos de VPN de cliente:** AWS Client VPN admite los puertos 443 y 1194 tanto para TCP como para UDP. El valor predeterminado es el puerto 443.
* **Interfaces de red de VPN de cliente:** cuando asocia una subred con su punto de conexi칩n de VPN de cliente, creamos interfaces de red de VPN de cliente en esa subred. **El tr치fico que se env칤a a la VPC desde el punto de conexi칩n de VPN de cliente se env칤a a trav칠s de una interfaz de red de VPN de cliente**. Luego se aplica la traducci칩n de direcci칩n de origen de la red, donde la direcci칩n IP de origen del rango de CIDR de cliente se traduce a la direcci칩n IP de la interfaz de red de VPN de cliente.
* **Registro de conexi칩n:** puede habilitar el registro de conexi칩n para su punto de conexi칩n de VPN de cliente para registrar eventos de conexi칩n. Puede utilizar esta informaci칩n para ejecutar la investigaci칩n forense, analizar c칩mo se est치 utilizando su punto de conexi칩n de VPN de cliente o solucionar problemas de conexi칩n.
* **Portal de autoservicio:** puede habilitar un portal de autoservicio para su punto de conexi칩n de VPN de cliente. Los clientes pueden iniciar sesi칩n en el portal basado en web con sus credenciales y descargar la 칰ltima versi칩n del archivo de configuraci칩n del punto de conexi칩n de VPN de cliente o la 칰ltima versi칩n del cliente proporcionado por AWS.
#### Limitaciones

* **Los rangos de CIDR del cliente no pueden superponerse con el CIDR local** de la VPC en la que se encuentra la subred asociada, ni con ninguna ruta agregada manualmente a la tabla de rutas del punto de enlace de VPN del cliente.
* Los rangos de CIDR del cliente deben tener un tama침o de bloque de al menos /22 y no deben ser mayores que /12.
* Una **parte de las direcciones** en el rango de CIDR del cliente se utilizan para **soportar el modelo de disponibilidad** del punto de enlace de VPN del cliente y no se pueden asignar a los clientes. Por lo tanto, recomendamos que **asigne un bloque CIDR que contenga el doble del n칰mero de direcciones IP que se requieren** para habilitar el n칰mero m치ximo de conexiones simult치neas que planea admitir en el punto de enlace de VPN del cliente.
* El **rango de CIDR del cliente no se puede cambiar** despu칠s de crear el punto de enlace de VPN del cliente.
* Las **subredes** asociadas con un punto de enlace de VPN del cliente **deben estar en la misma VPC**.
* **No se pueden asociar varias subredes de la misma zona de disponibilidad con un punto de enlace de VPN del cliente**.
* Un punto de enlace de VPN del cliente **no admite asociaciones de subredes en una VPC de tenencia dedicada**.
* VPN del cliente admite solo tr치fico **IPv4**.
* VPN del cliente **no cumple con los est치ndares FIPS** (Federal Information Processing Standards).
* Si la autenticaci칩n de m칰ltiples factores (MFA) est치 deshabilitada para su Active Directory, la contrase침a del usuario no puede tener el siguiente formato.

    ```
    SCRV1:<base64_encoded_string>:<base64_encoded_string>
    ```
* El portal de autoservicio **no est치 disponible para clientes que se autentican mediante autenticaci칩n mutua**.

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulte los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **칔nase al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤game** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparta sus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>