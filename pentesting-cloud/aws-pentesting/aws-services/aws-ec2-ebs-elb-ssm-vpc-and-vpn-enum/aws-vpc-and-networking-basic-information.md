# AWS - Informations de base sur VPC et Networking

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## AWS Networking en bref

Un **VPC** contient un **CIDR r√©seau** comme 10.0.0.0/16 (avec sa **table de routage** et son **ACL r√©seau**).

Ce r√©seau VPC est divis√© en **sous-r√©seaux**, donc un **sous-r√©seau** est directement **li√©** √† la **VPC**, √† la **table de routage** et √† l'**ACL r√©seau**.

Ensuite, les **interfaces r√©seau** attach√©es aux services (comme les instances EC2) sont **connect√©es** aux **sous-r√©seaux** avec des **groupes de s√©curit√©**.

Par cons√©quent, un **groupe de s√©curit√©** limitera les ports expos√©s des **interfaces r√©seau l'utilisant**, **ind√©pendamment du sous-r√©seau**. Et un **ACL r√©seau** limitera les ports expos√©s √† **l'ensemble du r√©seau**.

De plus, pour **acc√©der √† Internet**, il y a quelques configurations int√©ressantes √† v√©rifier :

* Un **sous-r√©seau** peut **attribuer automatiquement des adresses IPv4 publiques**
* Une **instance** cr√©√©e dans le r√©seau qui **attribue automatiquement des adresses IPv4 peut en obtenir une**
* Une **passerelle Internet** doit √™tre **attach√©e** √† la **VPC**
  * Vous pouvez √©galement utiliser des **passerelles Internet √† sens unique**
* Vous pouvez √©galement avoir une **passerelle NAT** dans un **sous-r√©seau priv√©** afin de pouvoir **se connecter √† des services externes** √† partir de ce sous-r√©seau priv√©, mais il est **impossible de les atteindre depuis l'ext√©rieur**.
  * La passerelle NAT peut √™tre **publique** (acc√®s √† Internet) ou **priv√©e** (acc√®s √† d'autres VPC)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) vous permet de **lancer des ressources AWS dans un r√©seau virtuel** que vous avez d√©fini. Ce r√©seau virtuel aura plusieurs sous-r√©seaux, des passerelles Internet pour acc√©der √† Internet, des ACL, des groupes de s√©curit√©, des adresses IP...

### Sous-r√©seaux

Les sous-r√©seaux aident √† renforcer un niveau de s√©curit√© plus √©lev√©. **Le regroupement logique de ressources similaires** vous aide √©galement √† maintenir une **facilit√© de gestion** sur l'ensemble de votre infrastructure.

* Les CIDR valides vont d'un masque de r√©seau /16 √† un masque de r√©seau /28.
* Un sous-r√©seau ne peut pas √™tre dans diff√©rentes zones de disponibilit√© en m√™me temps.
* **AWS r√©serve les trois premi√®res adresses IP d'h√¥te** de chaque sous-r√©seau **pour l'usage interne d'AWS** : la premi√®re adresse d'h√¥te utilis√©e est pour le routeur VPC. La deuxi√®me adresse est r√©serv√©e pour AWS DNS et la troisi√®me adresse est r√©serv√©e pour une utilisation future.
* On appelle **sous-r√©seaux publics** ceux qui ont un **acc√®s direct √† Internet, tandis que les sous-r√©seaux priv√©s ne le font pas.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7
## VPN

### VPN de site √† site

**Connectez votre r√©seau sur site avec votre VPC.**

* **Connexion VPN**: une connexion s√©curis√©e entre votre √©quipement sur site et vos VPC.
* **Tunnel VPN**: un lien crypt√© o√π les donn√©es peuvent passer du r√©seau client vers AWS ou vice versa.

    Chaque connexion VPN comprend deux tunnels VPN que vous pouvez utiliser simultan√©ment pour une haute disponibilit√©.
* **Passerelle client**: une ressource AWS qui fournit des informations √† AWS sur votre dispositif de passerelle client.
* **Dispositif de passerelle client**: un dispositif physique ou une application logicielle de votre c√¥t√© de la connexion VPN de site √† site.
* **Passerelle priv√©e virtuelle**: le concentrateur VPN du c√¥t√© Amazon de la connexion VPN de site √† site. Vous utilisez une passerelle priv√©e virtuelle ou une passerelle de transit comme passerelle pour le c√¥t√© Amazon de la connexion VPN de site √† site.
* **Passerelle de transit**: un hub de transit qui peut √™tre utilis√© pour interconnecter vos VPC et vos r√©seaux sur site. Vous utilisez une passerelle de transit ou une passerelle priv√©e virtuelle comme passerelle pour le c√¥t√© Amazon de la connexion VPN de site √† site.

#### Limitations

* Le trafic IPv6 n'est pas pris en charge pour les connexions VPN sur une passerelle priv√©e virtuelle.
* Une connexion VPN AWS ne prend pas en charge la d√©couverte de la taille maximale des unit√©s de transfert (MTU).

De plus, prenez en compte les √©l√©ments suivants lorsque vous utilisez VPN de site √† site.

* Lorsque vous connectez vos VPC √† un r√©seau sur site commun, nous vous recommandons d'utiliser des blocs CIDR non chevauchants pour vos r√©seaux.

### Composants de VPN client <a href="#what-is-components" id="what-is-components"></a>

**Connectez-vous depuis votre machine √† votre VPC**

#### Concepts

* **Point de terminaison VPN client**: la ressource que vous cr√©ez et configurez pour activer et g√©rer les sessions VPN client. C'est la ressource o√π toutes les sessions VPN client sont termin√©es.
* **R√©seau cible**: un r√©seau cible est le r√©seau que vous associez √† un point de terminaison VPN client. **Un sous-r√©seau d'un VPC est un r√©seau cible**. L'association d'un sous-r√©seau √† un point de terminaison VPN client vous permet d'√©tablir des sessions VPN. Vous pouvez associer plusieurs sous-r√©seaux √† un point de terminaison VPN client pour une haute disponibilit√©. Tous les sous-r√©seaux doivent √™tre du m√™me VPC. Chaque sous-r√©seau doit appartenir √† une zone de disponibilit√© diff√©rente.
* **Route**: chaque point de terminaison VPN client dispose d'une table de routage qui d√©crit les routes de r√©seau de destination disponibles. Chaque route dans la table de routage sp√©cifie le chemin pour le trafic vers des ressources ou des r√©seaux sp√©cifiques.
* **R√®gles d'autorisation**: une r√®gle d'autorisation **restreint les utilisateurs qui peuvent acc√©der √† un r√©seau**. Pour un r√©seau sp√©cifi√©, vous configurez le groupe Active Directory ou le fournisseur d'identit√© (IdP) qui est autoris√© √† acc√©der. Seuls les utilisateurs appartenant √† ce groupe peuvent acc√©der au r√©seau sp√©cifi√©. **Par d√©faut, il n'y a pas de r√®gles d'autorisation** et vous devez configurer des r√®gles d'autorisation pour permettre aux utilisateurs d'acc√©der aux ressources et aux r√©seaux.
* **Client**: l'utilisateur final se connectant au point de terminaison VPN client pour √©tablir une session VPN. Les utilisateurs finaux doivent t√©l√©charger un client OpenVPN et utiliser le fichier de configuration VPN client que vous avez cr√©√© pour √©tablir une session VPN.
* **Plage CIDR client**: une plage d'adresses IP √† partir de laquelle attribuer des adresses IP client. Chaque connexion au point de terminaison VPN client se voit attribuer une adresse IP unique √† partir de la plage CIDR client. Vous choisissez la plage CIDR client, par exemple, `10.2.0.0/16`.
* **Ports VPN client**: AWS Client VPN prend en charge les ports 443 et 1194 pour TCP et UDP. Le port par d√©faut est le port 443.
* **Interfaces r√©seau VPN client**: lorsque vous associez un sous-r√©seau √† votre point de terminaison VPN client, nous cr√©ons des interfaces r√©seau VPN client dans ce sous-r√©seau. **Le trafic envoy√© au VPC depuis le point de terminaison VPN client est envoy√© via une interface r√©seau VPN client**. La traduction d'adresse r√©seau source (SNAT) est ensuite appliqu√©e, o√π l'adresse IP source de la plage CIDR client est traduite en l'adresse IP de l'interface r√©seau VPN client.
* **Journalisation de la connexion**: vous pouvez activer la journalisation de la connexion pour votre point de terminaison VPN client afin de journaliser les √©v√©nements de connexion. Vous pouvez utiliser ces informations pour ex√©cuter des analyses forensiques, analyser la fa√ßon dont votre point de terminaison VPN client est utilis√© ou d√©boguer des probl√®mes de connexion.
* **Portail en libre-service**: vous pouvez activer un portail en libre-service pour votre point de terminaison VPN client. Les clients peuvent se connecter au portail Web √† l'aide de leurs identifiants et t√©l√©charger la derni√®re version du fichier de configuration du point de terminaison VPN client ou la derni√®re version du client fourni par AWS.

#### Limitations

* Les plages CIDR client ne peuvent pas se chevaucher avec le CIDR local du VPC dans lequel se trouve le sous-r√©seau associ√©, ou avec des routes ajout√©es manuellement √† la table de routage du point de terminaison VPN client.
* Les plages CIDR client doivent avoir une taille de bloc d'au moins /22 et ne doivent pas √™tre sup√©rieures √† /12.
* Une **partie des adresses** de la plage CIDR client est utilis√©e pour **prendre en charge le mod√®le de disponibilit√©** du point de terminaison VPN client et ne peut pas √™tre attribu√©e aux clients. Par cons√©quent, nous vous recommandons d'**attribuer un bloc CIDR contenant deux fois le nombre d'adresses IP requis** pour permettre le nombre maximal de connexions simultan√©es que vous pr√©voyez de prendre en charge sur le point de terminaison VPN client.
* La **plage CIDR client ne peut pas √™tre modifi√©e** apr√®s la cr√©ation du point de terminaison VPN client.
* Les **sous-r√©seaux** associ√©s √† un point de terminaison VPN client **doivent √™tre dans le m√™me VPC**.
* Vous **ne pouvez pas associer plusieurs sous-r√©seaux de la m√™me zone de disponibilit√© √† un point de terminaison VPN client**.
* Un point de terminaison VPN client **ne prend pas en charge les associations de sous-r√©seaux dans un VPC √† locataire d√©di√©**.
* Le VPN client prend en charge uniquement le trafic **IPv4**.
* Le VPN client n'est **pas conforme** aux normes de traitement de l'information f√©d√©rales (**FIPS**).
* Si l'authentification √† deux facteurs (MFA) est d√©sactiv√©e pour votre Active Directory, un mot de passe utilisateur ne peut pas √™tre au format suivant.

    ```
    SCRV1:<base64_encoded_string>:<base64_encoded_string>
    ```
* Le portail en libre-service n'est **pas disponible pour les clients qui s'authentifient √† l'aide de l'authentification mutuelle**.