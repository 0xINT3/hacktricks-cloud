# AWS - VPC & ネットワーキング基本情報

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## AWSネットワーキングの概要

**VPC**には、10.0.0.0/16のような**ネットワークCIDR**（**ルーティングテーブル**と**ネットワークACL**を含む）が含まれています。

このVPCネットワークは**サブネットワーク**に分割され、**サブネットワーク**は直接**VPC**、**ルーティング** **テーブル**、**ネットワークACL**と**関連**しています。

次に、サービス（EC2インスタンスなど）にアタッチされた**ネットワークインターフェース**は、**セキュリティグループ**を持つ**サブネットワーク**に**接続**されます。

したがって、**セキュリティグループ**は、**サブネットワークに関係なく**、それを使用するネットワーク**インターフェースの公開ポートを制限します。そして、**ネットワークACL**は、**全ネットワーク**に対して公開ポートを**制限**します。

さらに、**インターネットへのアクセス**には、いくつかの興味深い設定があります：

* **サブネットワーク**は公開IPv4アドレスを**自動割り当て**できます
* 自動割り当てIPv4アドレスのネットワークに作成された**インスタンス**は、アドレスを取得できます
* **インターネットゲートウェイ**は**VPC**に**アタッチ**する必要があります
* **Egress-onlyインターネットゲートウェイ**も使用できます
* **NATゲートウェイ**を**プライベートサブネット**に設置することで、そのプライベートサブネットから外部サービスに**接続**できますが、外部からそれらにアクセスすることは**できません**。
* NATゲートウェイは**公開**（インターネットへのアクセス）または**プライベート**（他のVPCへのアクセス）にすることができます

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) は、定義した仮想ネットワークにAWSリソースを**起動**することを可能にします。この仮想ネットワークには、いくつかのサブネット、インターネットアクセス用のインターネットゲートウェイ、ACL、セキュリティグループ、IPなどがあります...

### サブネット

サブネットは、より高いレベルのセキュリティを強化するのに役立ちます。**類似リソースの論理的なグループ化**は、インフラストラクチャ全体の**管理の容易さ**を維持するのにも役立ちます。

* 有効なCIDRは、/16ネットマスクから/28ネットマスクまでです。
* サブネットは同時に異なるアベイラビリティゾーンに存在することはできません。
* **AWSは、各サブネットの最初の3つのホストIPアドレスを**内部AWS使用のために**予約しています**：最初のホストアドレスはVPCルーター用です。2番目のアドレスはAWS DNS用に予約され、3番目のアドレスは将来の使用のために予約されています。
* **公開サブネット**はインターネットに**直接アクセス**できるもので、プライベートサブネットはできません。

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### ルートテーブル

ルートテーブルは、VPC内のサブネットのトラフィックルーティングを決定します。インターネットまたはVPN接続へのネットワークトラフィックが転送されるかどうかを決定します。通常、以下へのアクセスが見られます：

* ローカルVPC
* NAT
* インターネットゲートウェイ/ Egress-onlyインターネットゲートウェイ（VPCにインターネットアクセスを提供するために必要）。
* サブネットを公開するためには、**インターネットゲートウェイ**を**作成**してVPCに**アタッチ**する必要があります。
* VPCエンドポイント（プライベートネットワークからS3にアクセスするため）

以下の画像では、デフォルトの公開ネットワークとプライベートネットワークの違いを確認できます：

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>
### ACL

**ネットワークアクセスコントロールリスト（ACL）**: ネットワークACLは、サブネットへの入出力ネットワークトラフィックを制御するファイアウォールルールです。特定のIPアドレスや範囲へのトラフィックを許可または拒否するために使用されます。

* セキュリティグループを使用してアクセスを許可/拒否することが一般的ですが、確立されたリバースシェルを完全に切断する唯一の方法です。セキュリティグループのルールを変更しても、既に確立された接続は停止しません
* しかし、これはサブネット全体に適用されるため、機能が必要な場合は注意してください。必要な機能が妨げられる可能性があります

### セキュリティグループ

セキュリティグループは、VPC内の**インスタンスへの入出力ネットワーク** **トラフィック**を制御する仮想**ファイアウォール**です。関係は1 SGからMインスタンスまで（通常は1対1）。\
通常、インスタンスの危険なポートを開くために使用されます。例えば、ポート22などです：

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### エラスティックIPアドレス

_エラスティックIPアドレス_は、動的クラウドコンピューティング用に設計された**静的IPv4アドレス**です。エラスティックIPアドレスはAWSアカウントに割り当てられ、解放するまであなたのものです。エラスティックIPアドレスを使用することで、インスタンスまたはソフトウェアの障害を迅速に別のインスタンスにアドレスを再マッピングすることで隠すことができます。

### サブネット間の接続

デフォルトでは、すべてのサブネットは**自動的に公開IPアドレスの割り当てがオフ**になっていますが、オンにすることができます。

**ルートテーブル内のローカルルートにより、VPCサブネット間の通信が可能になります。**

**異なるサブネットを接続する場合、他のサブネットに接続されているサブネットにはアクセスできません**。直接接続を作成する必要があります。**これはインターネットゲートウェイにも適用されます**。サブネット接続を通じてインターネットにアクセスすることはできません。インターネットゲートウェイをサブネットに割り当てる必要があります。

### VPCピアリング

VPCピアリングにより、2つ以上のVPCを同じネットワークの一部であるかのように接続することができます。

ピア接続が確立されると、**あるVPCのリソースが他のVPCのリソースにアクセスできます**。VPC間の接続は既存のAWSネットワークインフラストラクチャを介して実装されるため、帯域幅のボトルネックなしに高い可用性があります。**ピア接続は同じネットワークの一部であるかのように動作するため**、使用できるCIDRブロック範囲に制限があります。\
VPCのCIDR範囲が**重複している場合や重複している場合**、VPCをピアリングすることは**できません**。\
各AWS VPCは**ピアとのみ通信します**。例えば、VPC 1とVPC 2の間にピアリング接続があり、VPC 2とVPC 3の間に別の接続がある場合、VPC 1と2は直接互いに通信できますし、VPC 2とVPC 3も同様ですが、VPC 1とVPC 3は通信できません。**一つのVPCを経由して別のVPCにルーティングすることはできません。**

### **VPCフローログ**

VPC内では、公共およびプライベートの異なるサブネット間、またはVPCピアリング接続を介して異なるVPC間で通信するリソースが数百から数千に及ぶ可能性があります。**VPCフローログにより、VPC内のリソースのネットワークインターフェース間で流れるIPトラフィック情報をキャプチャすることができます**。

S3アクセスログやCloudFrontアクセスログとは異なり、**VPCフローログによって生成されるログデータはS3に保存されません。代わりに、キャプチャされたログデータはCloudWatchログに送信されます**。

制限事項：

* VPCピアリング接続を実行している場合、同じアカウント内のピアリングされたVPCのフローログのみを表示できます。
* EC2-Classic環境内でリソースを実行している場合、残念ながらそのインターフェースから情報を取得することはできません
* VPCフローログが作成されると、変更することはできません。VPCフローログの設定を変更するには、削除してから新しいものを再作成する必要があります。
* ログによって監視およびキャプチャされないトラフィック。VPC内のDHCPトラフィック、Amazon DNSサーバーへのインスタンスからのトラフィック。
* VPCデフォルトルーターのIPアドレスへのトラフィック、および以下のアドレスへのトラフィック。169.254.169.254（インスタンスメタデータの収集に使用される）および169.254.169.123（Amazon Time Sync Serviceに使用される）。
* WindowsインスタンスからのAmazon Windowsアクティベーションライセンスに関連するトラフィック
* ネットワークロードバランサーインターフェースとエンドポイントネットワークインターフェース間のトラフィック

CloudWatchロググループにデータを公開する各ネットワークインターフェースは、異なるログストリームを使用します。これらのストリームのそれぞれには、ログエントリの内容を示すフローログイベントデータがあります。これらの**ログは、約10〜15分のウィンドウ中にデータをキャプチャします**。

## VPN

### サイト間VPN

**オンプレミスネットワークをVPCに接続します。**

* **VPN接続**: オンプレミス機器とVPC間の安全な接続。
*   **VPNトンネル**: データが顧客ネットワークからAWSへ、またはその逆に通過できる暗号化されたリンク。

各VPN接続には、高可用性のために同時に使用できる2つのVPNトンネルが含まれています。
* **カスタマーゲートウェイ**: AWSに顧客ゲートウェイデバイスに関する情報を提供するAWSリソース。
* **カスタマーゲートウェイデバイス**: サイト間VPN接続の顧客側にある物理デバイスまたはソフトウェアアプリケーション。
* **バーチャルプライベートゲートウェイ**: サイト間VPN接続のAmazon側のVPNコンセントレータ。バーチャルプライベートゲートウェイまたはトランジットゲートウェイを、サイト間VPN接続のAmazon側のゲートウェイとして使用します。
* **トランジットゲートウェイ**: VPCとオンプレミスネットワークを相互接続するために使用できるトランジットハブ。トランジットゲートウェイまたはバーチャルプライベートゲートウェイを、サイト間VPN接続のAmazon側のゲートウェイとして使用します。

#### 制限事項

* バーチャルプライベートゲートウェイでのVPN接続にはIPv6トラフィックはサポートされていません。
* AWS VPN接続はPath MTU Discoveryをサポートしていません。

サイト間VPNを使用する際には、以下の点を考慮してください。

* VPCを共通のオンプレミスネットワークに接続する場合、ネットワークに重複しないCIDRブロックを使用することをお勧めします。
### クライアントVPNのコンポーネント <a href="#what-is-components" id="what-is-components"></a>

**あなたのマシンからVPCへ接続**

#### 概念

* **クライアントVPNエンドポイント:** クライアントVPNセッションを有効にし、管理するために作成し設定するリソースです。すべてのクライアントVPNセッションが終了するリソースです。
* **ターゲットネットワーク:** ターゲットネットワークは、クライアントVPNエンドポイントに関連付けるネットワークです。**VPCのサブネットがターゲットネットワークです**。サブネットをクライアントVPNエンドポイントに関連付けることで、VPNセッションを確立できます。高可用性のために、複数のサブネットをクライアントVPNエンドポイントに関連付けることができます。すべてのサブネットは同じVPCからでなければなりません。各サブネットは異なるアベイラビリティゾーンに属している必要があります。
* **ルート**: 各クライアントVPNエンドポイントには、利用可能な宛先ネットワークルートを記述するルートテーブルがあります。ルートテーブル内の各ルートは、特定のリソースやネットワークへのトラフィックのパスを指定します。
* **認証ルール:** 認証ルールは、**ネットワークにアクセスできるユーザーを制限します**。指定されたネットワークに対して、アクセスを許可されたActive DirectoryまたはIdPグループを設定します。このグループに属するユーザーのみが指定されたネットワークにアクセスできます。**デフォルトでは認証ルールはありません**。リソースやネットワークにアクセスできるようにするためには、認証ルールを設定する必要があります。
* **クライアント:** クライアントVPNエンドポイントに接続してVPNセッションを確立するエンドユーザーです。エンドユーザーはOpenVPNクライアントをダウンロードし、作成したクライアントVPN設定ファイルを使用してVPNセッションを確立する必要があります。
* **クライアントCIDR範囲:** クライアントIPアドレスを割り当てるためのIPアドレス範囲です。クライアントVPNエンドポイントへの各接続には、クライアントCIDR範囲から一意のIPアドレスが割り当てられます。たとえば、`10.2.0.0/16`のようにクライアントCIDR範囲を選択します。
* **クライアントVPNポート:** AWSクライアントVPNは、TCPとUDPの両方でポート443および1194をサポートしています。デフォルトはポート443です。
* **クライアントVPNネットワークインターフェース:** サブネットをクライアントVPNエンドポイントに関連付けると、そのサブネットにクライアントVPNネットワークインターフェースが作成されます。**クライアントVPNエンドポイントからVPCに送信されるトラフィックは、クライアントVPNネットワークインターフェースを介して送信されます**。ソースネットワークアドレス変換（SNAT）が適用され、クライアントCIDR範囲のソースIPアドレスがクライアントVPNネットワークインターフェースのIPアドレスに変換されます。
* **接続ログ:** クライアントVPNエンドポイントの接続ログを有効にして、接続イベントを記録できます。この情報を使用してフォレンジックを実行したり、クライアントVPNエンドポイントの使用方法を分析したり、接続の問題をデバッグしたりすることができます。
* **セルフサービスポータル:** クライアントVPNエンドポイントのセルフサービスポータルを有効にできます。クライアントは、資格情報を使用してWebベースのポータルにログインし、最新バージョンのクライアントVPNエンドポイント設定ファイルや、AWSが提供するクライアントの最新バージョンをダウンロードできます。

#### 制限事項

* **クライアントCIDR範囲は、関連付けられたサブネットが位置するVPCのローカルCIDRと重複することはできません**。また、クライアントVPNエンドポイントのルートテーブルに手動で追加されたルートとも重複してはなりません。
* クライアントCIDR範囲は、少なくとも**/22のブロックサイズ**でなければならず、**/12より大きくてはなりません**。
* クライアントCIDR範囲内の**アドレスの一部**は、クライアントVPNエンドポイントの可用性モデルを**サポートするために使用され**、クライアントに割り当てることはできません。したがって、クライアントVPNエンドポイントでサポートする予定の同時接続の最大数に必要なIPアドレスの2倍を含むCIDRブロックを割り当てることをお勧めします。
* **クライアントCIDR範囲は、クライアントVPNエンドポイントを作成した後に変更することはできません**。
* クライアントVPNエンドポイントに関連付けられた**サブネットは、同じVPC内にある必要があります**。
* 同じアベイラビリティゾーンの複数のサブネットをクライアントVPNエンドポイントに関連付けることは**できません**。
* クライアントVPNエンドポイントは、**専用テナンシーVPCでのサブネット関連付けをサポートしていません**。
* クライアントVPNは**IPv4**トラフィックのみをサポートしています。
* クライアントVPNは**FIPS（Federal Information Processing Standards）準拠ではありません**。
*   Active Directoryで多要素認証（MFA）が無効になっている場合、ユーザーパスワードは以下の形式ではありません。

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* 相互認証を使用して認証するクライアントには、**セルフサービスポータルは利用できません**。

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>
