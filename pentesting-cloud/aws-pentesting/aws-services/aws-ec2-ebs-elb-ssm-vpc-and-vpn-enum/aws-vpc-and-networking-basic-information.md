# AWS - Informations de base sur VPC et le r√©seau

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Le r√©seau AWS en un clin d'≈ìil

Un **VPC** contient un **CIDR r√©seau** comme 10.0.0.0/16 (avec sa **table de routage** et son **ACL r√©seau**).

Ce r√©seau VPC est divis√© en **sous-r√©seaux**, donc un **sous-r√©seau** est directement **li√©** au **VPC**, √† la **table de routage** et √† l'**ACL r√©seau**.

Ensuite, les **interfaces r√©seau** attach√©es aux services (comme les instances EC2) sont **connect√©es** aux **sous-r√©seaux** avec **groupe(s) de s√©curit√©**.

Par cons√©quent, un **groupe de s√©curit√©** limitera les ports expos√©s des interfaces r√©seau **l'utilisant**, **ind√©pendamment du sous-r√©seau**. Et une **ACL r√©seau** limitera les ports expos√©s √† **l'ensemble du r√©seau**.

De plus, pour **acc√©der √† Internet**, il y a certaines configurations int√©ressantes √† v√©rifier :

* Un **sous-r√©seau** peut **attribuer automatiquement des adresses IPv4 publiques**
* Une **instance** cr√©√©e dans le r√©seau qui **attribue automatiquement des adresses IPv4 peut en obtenir une**
* Une **passerelle Internet** doit √™tre **attach√©e** au **VPC**
* Vous pourriez √©galement utiliser des **passerelles Internet sortantes uniquement**
* Vous pourriez √©galement avoir une **passerelle NAT** dans un **sous-r√©seau priv√©** afin qu'il soit possible de **se connecter √† des services externes** depuis ce sous-r√©seau priv√©, mais il est **impossible d'y acc√©der de l'ext√©rieur**.
* La passerelle NAT peut √™tre **publique** (acc√®s √† Internet) ou **priv√©e** (acc√®s √† d'autres VPC)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) vous permet de **lancer des ressources AWS dans un r√©seau virtuel** que vous avez d√©fini. Ce r√©seau virtuel comprendra plusieurs sous-r√©seaux, des passerelles Internet pour acc√©der √† Internet, des ACL, des groupes de s√©curit√©, des IPs...

### Sous-r√©seaux

Les sous-r√©seaux contribuent √† renforcer un niveau de s√©curit√© plus √©lev√©. Le **regroupement logique de ressources similaires** aide √©galement √† maintenir une **facilit√© de gestion** de votre infrastructure.

* Les CIDR valides vont d'un masque de r√©seau /16 √† un /28.
* Un sous-r√©seau ne peut pas √™tre dans diff√©rentes zones de disponibilit√© en m√™me temps.
* **AWS r√©serve les trois premi√®res adresses IP h√¥tes** de chaque sous-r√©seau **pour** **l'utilisation interne d'AWS** : la premi√®re adresse h√¥te utilis√©e est pour le routeur VPC. La deuxi√®me adresse est r√©serv√©e pour le DNS AWS et la troisi√®me adresse est r√©serv√©e pour une utilisation future.
* On appelle **sous-r√©seaux publics** ceux qui ont **un acc√®s direct √† Internet, contrairement aux sous-r√©seaux priv√©s qui n'en ont pas.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tables de routage

Les tables de routage d√©terminent le routage du trafic pour un sous-r√©seau au sein d'un VPC. Elles d√©terminent quel trafic r√©seau est achemin√© vers Internet ou vers une connexion VPN. Vous trouverez g√©n√©ralement l'acc√®s √† :

* Le VPC local
* NAT
* Passerelles Internet / Passerelles Internet sortantes uniquement (n√©cessaires pour donner √† un VPC l'acc√®s √† Internet).
* Afin de rendre un sous-r√©seau public, vous devez **cr√©er** et **attacher** une **passerelle Internet** √† votre VPC.
* Points de terminaison VPC (pour acc√©der √† S3 depuis des r√©seaux priv√©s)

Dans les images suivantes, vous pouvez v√©rifier les diff√©rences entre un r√©seau public par d√©faut et un r√©seau priv√© :

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>
### ACLs

**Listes de contr√¥le d'acc√®s r√©seau (ACLs)** : Les ACLs r√©seau sont des r√®gles de pare-feu qui contr√¥lent le trafic r√©seau entrant et sortant d'un sous-r√©seau. Elles peuvent √™tre utilis√©es pour autoriser ou refuser le trafic vers des adresses IP sp√©cifiques ou des plages d'adresses.

* Il est plus fr√©quent d'autoriser/refuser l'acc√®s √† l'aide de groupes de s√©curit√©, mais c'est le seul moyen de couper compl√®tement les shells inverses √©tablis. Une r√®gle modifi√©e dans un groupe de s√©curit√© n'arr√™te pas les connexions d√©j√† √©tablies.
* Cependant, cela s'applique √† l'ensemble du sous-r√©seau, soyez prudent lorsque vous interdisez des choses car des fonctionnalit√©s n√©cessaires pourraient √™tre perturb√©es.

### Groupes de s√©curit√©

Les groupes de s√©curit√© sont un **pare-feu virtuel** qui contr√¥le le trafic r√©seau **entrant et sortant des instances** dans un VPC. Relation 1 SG √† M instances (g√©n√©ralement 1 √† 1).\
Habituellement, cela est utilis√© pour ouvrir des ports dangereux dans les instances, comme le port 22 par exemple :

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Adresses IP √©lastiques

Une _adresse IP √©lastique_ est une **adresse IPv4 statique** con√ßue pour le cloud computing dynamique. Une adresse IP √©lastique est allou√©e √† votre compte AWS et vous appartient jusqu'√† ce que vous la lib√©riez. En utilisant une adresse IP √©lastique, vous pouvez masquer la d√©faillance d'une instance ou d'un logiciel en remappant rapidement l'adresse √† une autre instance de votre compte.

### Connexion entre sous-r√©seaux

Par d√©faut, tous les sous-r√©seaux ont **l'attribution automatique d'adresses IP publiques d√©sactiv√©e** mais cela peut √™tre activ√©.

**Une route locale dans une table de routage permet la communication entre les sous-r√©seaux d'un VPC.**

Si vous **connectez un sous-r√©seau √† un autre sous-r√©seau diff√©rent, vous ne pouvez pas acc√©der aux sous-r√©seaux connect√©s** avec l'autre sous-r√©seau, vous devez cr√©er une connexion directe avec eux. **Cela s'applique √©galement aux passerelles Internet**. Vous ne pouvez pas passer par une connexion de sous-r√©seau pour acc√©der √† Internet, vous devez attribuer la passerelle Internet √† votre sous-r√©seau.

### Appariement VPC

L'appariement VPC vous permet de **connecter deux VPC ou plus ensemble**, en utilisant IPV4 ou IPV6, comme s'ils faisaient partie du m√™me r√©seau.

Une fois la connectivit√© par paire √©tablie, **les ressources d'un VPC peuvent acc√©der aux ressources de l'autre**. La connectivit√© entre les VPC est mise en ≈ìuvre via l'infrastructure r√©seau AWS existante, et est donc hautement disponible sans goulot d'√©tranglement de bande passante. Comme **les connexions par paires fonctionnent comme si elles faisaient partie du m√™me r√©seau**, il y a des restrictions concernant les plages de blocs CIDR qui peuvent √™tre utilis√©es.\
Si vous avez des plages de blocs CIDR **chevauchantes ou en double** pour vos VPC, alors **vous ne pourrez pas appairer les VPC** ensemble.\
Chaque VPC AWS ne communiquera **qu'avec son pair**. Par exemple, si vous avez une connexion par paire entre le VPC 1 et le VPC 2, et une autre connexion entre le VPC 2 et le VPC 3 comme illustr√©, alors le VPC 1 et 2 pourraient communiquer directement l'un avec l'autre, tout comme le VPC 2 et le VPC 3, cependant, le VPC 1 et le VPC 3 ne pourraient pas. **Vous ne pouvez pas router √† travers un VPC pour en atteindre un autre.**

### **Journalisation du flux VPC**

Au sein de votre VPC, vous pourriez potentiellement avoir des centaines, voire des milliers de ressources toutes en communication entre diff√©rents sous-r√©seaux publics et priv√©s et √©galement entre diff√©rents VPC via des connexions d'appariement VPC. **Les journaux de flux VPC vous permettent de capturer des informations sur le trafic IP qui circule entre les interfaces r√©seau de vos ressources au sein de votre VPC**.

Contrairement aux journaux d'acc√®s S3 et CloudFront, les **donn√©es de journal g√©n√©r√©es par les journaux de flux VPC ne sont pas stock√©es dans S3. Au lieu de cela, les donn√©es de journal captur√©es sont envoy√©es aux journaux CloudWatch**.

Limitations :

* Si vous utilisez une connexion d'appariement VPC, vous ne pourrez voir que les journaux de flux des VPC appair√©s qui sont dans le m√™me compte.
* Si vous utilisez encore des ressources dans l'environnement EC2-Classic, alors malheureusement vous ne pourrez pas r√©cup√©rer d'informations de leurs interfaces.
* Une fois qu'un journal de flux VPC a √©t√© cr√©√©, il ne peut pas √™tre modifi√©. Pour modifier la configuration du journal de flux VPC, vous devez le supprimer puis en recr√©er un nouveau.
* Le trafic suivant n'est pas surveill√© et captur√© par les journaux : le trafic DHCP au sein du VPC, le trafic des instances destin√© au serveur DNS Amazon.
* Tout trafic destin√© √† l'adresse IP du routeur par d√©faut du VPC et le trafic vers et depuis les adresses suivantes, 169.254.169.254 qui est utilis√© pour la collecte des m√©tadonn√©es d'instance, et 169.254.169.123 qui est utilis√© pour le service de synchronisation de l'heure Amazon.
* Le trafic li√© √† une licence d'activation Windows Amazon d'une instance Windows
* Le trafic entre une interface de r√©partiteur de charge r√©seau et une interface de r√©seau d'extr√©mit√©

Pour chaque interface r√©seau qui publie des donn√©es dans le groupe de journaux CloudWatch, elle utilisera un flux de journaux diff√©rent. Et au sein de chacun de ces flux, il y aura les donn√©es d'√©v√©nement de journal de flux qui montrent le contenu des entr√©es de journal. Chacun de ces **journaux capture des donn√©es pendant une fen√™tre d'environ 10 √† 15 minutes**.

## VPN

### VPN site √† site

**Connectez votre r√©seau sur site avec votre VPC.**

* **Connexion VPN** : Une connexion s√©curis√©e entre votre √©quipement sur site et vos VPC.
*   **Tunnel VPN** : Un lien crypt√© o√π les donn√©es peuvent passer du r√©seau client √† AWS ou inversement.

Chaque connexion VPN comprend deux tunnels VPN que vous pouvez utiliser simultan√©ment pour une haute disponibilit√©.
* **Passerelle client** : Une ressource AWS qui fournit des informations √† AWS sur votre appareil de passerelle client.
* **Appareil de passerelle client** : Un appareil physique ou une application logicielle de votre c√¥t√© de la connexion VPN site √† site.
* **Passerelle priv√©e virtuelle** : Le concentrateur VPN du c√¥t√© Amazon de la connexion VPN site √† site. Vous utilisez une passerelle priv√©e virtuelle ou une passerelle de transit comme passerelle pour le c√¥t√© Amazon de la connexion VPN site √† site.
* **Passerelle de transit** : Un hub de transit qui peut √™tre utilis√© pour interconnecter vos VPC et r√©seaux sur site. Vous utilisez une passerelle de transit ou une passerelle priv√©e virtuelle comme passerelle pour le c√¥t√© Amazon de la connexion VPN site √† site.

#### Limitations

* Le trafic IPv6 n'est pas pris en charge pour les connexions VPN sur une passerelle priv√©e virtuelle.
* Une connexion VPN AWS ne prend pas en charge la d√©couverte de la taille maximale de l'unit√© de transmission (MTU) du chemin.

De plus, prenez en compte les √©l√©ments suivants lorsque vous utilisez le VPN site √† site.

* Lorsque vous connectez vos VPC √† un r√©seau sur site commun, nous recommandons que vous utilisiez des blocs CIDR non chevauchants pour vos r√©seaux.
### Composants du Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Connectez-vous depuis votre machine √† votre VPC**

#### Concepts

* **Point de terminaison du Client VPN :** La ressource que vous cr√©ez et configurez pour activer et g√©rer les sessions de Client VPN. C'est la ressource o√π toutes les sessions de Client VPN sont termin√©es.
* **R√©seau cible :** Un r√©seau cible est le r√©seau que vous associez √† un point de terminaison de Client VPN. **Un sous-r√©seau d'un VPC est un r√©seau cible**. Associer un sous-r√©seau √† un point de terminaison de Client VPN vous permet d'√©tablir des sessions VPN. Vous pouvez associer plusieurs sous-r√©seaux √† un point de terminaison de Client VPN pour une haute disponibilit√©. Tous les sous-r√©seaux doivent √™tre issus du m√™me VPC. Chaque sous-r√©seau doit appartenir √† une zone de disponibilit√© diff√©rente.
* **Route :** Chaque point de terminaison de Client VPN a une table de routage qui d√©crit les routes de r√©seau de destination disponibles. Chaque route dans la table de routage sp√©cifie le chemin pour le trafic vers des ressources ou r√©seaux sp√©cifiques.
* **R√®gles d'autorisation :** Une r√®gle d'autorisation **restreint les utilisateurs qui peuvent acc√©der √† un r√©seau**. Pour un r√©seau sp√©cifi√©, vous configurez le groupe Active Directory ou fournisseur d'identit√© (IdP) qui est autoris√© √† y acc√©der. Seuls les utilisateurs appartenant √† ce groupe peuvent acc√©der au r√©seau sp√©cifi√©. **Par d√©faut, il n'y a pas de r√®gles d'autorisation** et vous devez configurer des r√®gles d'autorisation pour permettre aux utilisateurs d'acc√©der aux ressources et r√©seaux.
* **Client :** L'utilisateur final se connectant au point de terminaison du Client VPN pour √©tablir une session VPN. Les utilisateurs finaux doivent t√©l√©charger un client OpenVPN et utiliser le fichier de configuration du Client VPN que vous avez cr√©√© pour √©tablir une session VPN.
* **Plage CIDR du client :** Une plage d'adresses IP √† partir de laquelle attribuer des adresses IP client. Chaque connexion au point de terminaison du Client VPN se voit attribuer une adresse IP unique √† partir de la plage CIDR du client. Vous choisissez la plage CIDR du client, par exemple, `10.2.0.0/16`.
* **Ports du Client VPN :** AWS Client VPN prend en charge les ports 443 et 1194 pour TCP et UDP. Le port par d√©faut est le 443.
* **Interfaces r√©seau du Client VPN :** Lorsque vous associez un sous-r√©seau √† votre point de terminaison de Client VPN, nous cr√©ons des interfaces r√©seau de Client VPN dans ce sous-r√©seau. **Le trafic envoy√© au VPC depuis le point de terminaison du Client VPN est envoy√© via une interface r√©seau de Client VPN**. La traduction d'adresse r√©seau source (SNAT) est ensuite appliqu√©e, o√π l'adresse IP source de la plage CIDR du client est traduite en adresse IP de l'interface r√©seau de Client VPN.
* **Journalisation des connexions :** Vous pouvez activer la journalisation des connexions pour votre point de terminaison de Client VPN afin de consigner les √©v√©nements de connexion. Vous pouvez utiliser ces informations pour effectuer des analyses forensiques, analyser comment votre point de terminaison de Client VPN est utilis√© ou d√©boguer des probl√®mes de connexion.
* **Portail d'auto-assistance :** Vous pouvez activer un portail d'auto-assistance pour votre point de terminaison de Client VPN. Les clients peuvent se connecter au portail web en utilisant leurs identifiants et t√©l√©charger la derni√®re version du fichier de configuration du point de terminaison de Client VPN, ou la derni√®re version du client fourni par AWS.

#### Limitations

* **Les plages CIDR du client ne peuvent pas se chevaucher avec le CIDR local** du VPC dans lequel le sous-r√©seau associ√© est situ√©, ni avec les routes ajout√©es manuellement √† la table de routage du point de terminaison du Client VPN.
* Les plages CIDR du client doivent avoir une taille de bloc d'au moins **/22** et ne doivent **pas √™tre sup√©rieures √† /12.**
* Une **partie des adresses** dans la plage CIDR du client est utilis√©e pour **soutenir le mod√®le de disponibilit√©** du point de terminaison du Client VPN, et ne peut pas √™tre attribu√©e aux clients. Par cons√©quent, nous recommandons que vous **attribuiez un bloc CIDR qui contient deux fois le nombre d'adresses IP requises** pour activer le nombre maximal de connexions simultan√©es que vous pr√©voyez de prendre en charge sur le point de terminaison du Client VPN.
* La **plage CIDR du client ne peut pas √™tre modifi√©e** apr√®s la cr√©ation du point de terminaison du Client VPN.
* Les **sous-r√©seaux** associ√©s √† un point de terminaison de Client VPN **doivent √™tre dans le m√™me VPC**.
* Vous **ne pouvez pas associer plusieurs sous-r√©seaux de la m√™me zone de disponibilit√© √† un point de terminaison de Client VPN**.
* Un point de terminaison de Client VPN **ne prend pas en charge les associations de sous-r√©seaux dans un VPC √† locataire d√©di√©**.
* Client VPN prend en charge uniquement le trafic **IPv4**.
* Client VPN n'est **pas conforme** aux normes de traitement de l'information f√©d√©rales (**FIPS**).
*   Si l'authentification √† plusieurs facteurs (MFA) est d√©sactiv√©e pour votre Active Directory, un mot de passe utilisateur ne peut pas √™tre au format suivant.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Le portail d'auto-assistance n'est **pas disponible pour les clients qui s'authentifient en utilisant une authentification mutuelle**.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
