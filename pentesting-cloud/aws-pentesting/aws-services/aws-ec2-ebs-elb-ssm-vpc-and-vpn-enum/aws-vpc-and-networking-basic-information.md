# AWS - VPC＆ネットワーキングの基本情報

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksをサポート**し、特典を受け取るには、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubリポジトリに提出してください。**

</details>

## AWSネットワーキングの要点

**VPC**には、10.0.0.0/16のような**ネットワークCIDR**（**ルーティングテーブル**と**ネットワークACL**を含む）が含まれています。

このVPCネットワークは**サブネット**に分割されており、**サブネット**は**VPC**、**ルーティングテーブル**、**ネットワークACL**と直接関連しています。

次に、サービス（EC2インスタンスなど）に接続された**ネットワークインターフェース**は、**セキュリティグループ**を使用して**サブネット**に接続されます。

したがって、**セキュリティグループ**は、**サブネットに関係なく**、それを使用する**ネットワークインターフェースの公開ポートを制限**します。また、**ネットワークACL**は**ネットワーク全体**の公開ポートを制限します。

さらに、**インターネットにアクセス**するためには、いくつかの興味深い設定があります：

* **サブネット**は**パブリックIPv4アドレスを自動割り当て**することができます。
* ネットワークで**IPv4アドレスを自動割り当て**する**インスタンス**は、1つ取得することができます。
* **インターネットゲートウェイ**を**VPCにアタッチ**する必要があります。
* **Egress-onlyインターネットゲートウェイ**を使用することもできます。
* **プライベートサブネット**に**NATゲートウェイ**を配置することで、そのプライベートサブネットから外部サービスに接続することができますが、外部からは到達できません。
* NATゲートウェイは**パブリック**（インターネットへのアクセス）または**プライベート**（他のVPCへのアクセス）であることができます。

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud**（Amazon VPC）を使用すると、定義した仮想ネットワークにAWSリソースを展開できます。この仮想ネットワークには、複数のサブネット、インターネットゲートウェイ（インターネットへのアクセス）、ACL、セキュリティグループ、IPなどが含まれます...

### サブネット

サブネットは、より高いセキュリティレベルを強制するのに役立ちます。**同様のリソースの論理的なグループ化**は、インフラストラクチャ全体での**管理の容易さ**を維持するのにも役立ちます。

* 有効なCIDRは、/16ネットマスクから/28ネットマスクまでです。
* サブネットは同時に異なる可用性ゾーンに存在することはできません。
* 各サブネットの最初の3つのホストIPアドレスは、**内部AWS使用のために予約**されています：最初のホストアドレスはVPCルーター用に使用されます。2番目のアドレスはAWS DNS用に予約され、3番目のアドレスは将来の使用のために予約されています。
* **インターネットに直接アクセスできる**サブネットを**パブリックサブネット**と呼びますが、**プライベートサブネット**はそうではありません。

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### ルートテーブル

ルートテーブルは、VPC内のサブネットのトラフィックルーティングを決定します。インターネットまたはVPN接続に転送されるネットワークトラフィックを決定します。通常、次のアクセスが見つかります：

* ローカルVPC
* NAT
* インターネットゲートウェイ/ Egress-onlyインターネットゲートウェイ（VPCがインターネットにアクセスするために必要）
* サブネットをパブリックにするには、VPCに**インターネットゲートウェイ**を**作成**して**アタッチ**する必要があります。
* VPCエンドポイント（プライベートネットワークからS3にアクセスするため）

次の画像では、デフォルトのパブリックネットワークとプライベートネットワークの違いを確認できます：

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>
### ACLs

**ネットワークアクセス制御リスト（ACL）**：ネットワークACLは、サブネットへの着信および送信ネットワークトラフィックを制御するファイアウォールルールです。特定のIPアドレスや範囲へのトラフィックを許可または拒否するために使用できます。

- セキュリティグループを使用してアクセスを許可または拒否することが最も一般的ですが、これは既に確立された逆シェルを完全に切断する唯一の方法です。セキュリティグループの変更は、既に確立された接続を停止しません。
- ただし、これはサブネット全体に適用されるため、必要な機能が妨げられる可能性があるため、禁止する際には注意が必要です。

### セキュリティグループ

セキュリティグループは、VPC内のインスタンスへの着信および送信ネットワークトラフィックを制御する仮想ファイアウォールです。通常、1つのセキュリティグループに対して複数のインスタンス（通常は1対1）が関連付けられます。

通常、これはインスタンスで危険なポートを開くために使用されます。たとえば、ポート22などを開くために使用されます。

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IPアドレス

_Elastic IPアドレス_は、動的なクラウドコンピューティングに適した**静的なIPv4アドレス**です。Elastic IPアドレスはAWSアカウントに割り当てられ、解放するまで所有者が変わりません。Elastic IPアドレスを使用することで、インスタンスまたはソフトウェアの障害を迅速に別のインスタンスにマッピングすることができます。

### サブネット間の接続

デフォルトでは、すべてのサブネットは**パブリックIPアドレスの自動割り当てがオフになっています**が、オンにすることもできます。

**ルートテーブル内のローカルルートにより、VPCサブネット間で通信が可能になります。**

異なるサブネットとの接続を行う場合、他のサブネットに接続されたサブネットにアクセスすることはできません。直接それらと接続する必要があります。**これはインターネットゲートウェイにも適用されます**。インターネットにアクセスするためには、サブネット接続を経由することはできず、サブネットにインターネットゲートウェイを割り当てる必要があります。

### VPCピアリング

VPCピアリングを使用すると、複数のVPCを1つのネットワークの一部として接続できます（IPv4またはIPv6を使用）。

ピア接続が確立されると、1つのVPCのリソースは他のVPCのリソースにアクセスできます。VPC間の接続は既存のAWSネットワークインフラストラクチャを介して実装されるため、高い可用性と帯域幅の制約はありません。**ピア接続は同じネットワークの一部であるかのように動作するため、使用できるCIDRブロック範囲に制約があります。**
VPCのCIDRブロックに重複または重複する範囲がある場合、VPCをピアリングすることはできません。
各AWS VPCは、そのピアとのみ通信します。たとえば、VPC 1とVPC 2の間にピアリング接続があり、VPC 2とVPC 3の間にも接続がある場合、VPC 1とVPC 2は直接通信できますが、VPC 1とVPC 3は通信できません。**別のVPCにアクセスするためには、1つのVPCを経由することはできません。**

### **VPCフローログ**

VPC内では、パブリックおよびプライベートのさまざまなサブネット間、およびVPCピアリング接続を介して、数百から数千のリソース間でIPトラフィックがやり取りされる可能性があります。**VPCフローログを使用すると、VPC内のリソースのネットワークインターフェース間のIPトラフィック情報をキャプチャできます**。

S3アクセスログやCloudFrontアクセスログとは異なり、VPCフローログによって生成されるログデータはS3に保存されません。代わりに、キャプチャされたログデータはCloudWatchログに送信されます。

制限事項：

- VPCピアリング接続を実行している場合、同じアカウント内のピアリングされたVPCのフローログのみ表示できます。
- まだEC2-Classic環境でリソースを実行している場合、インターフェースから情報を取得することはできません。
- VPCフローログが作成されると、変更することはできません。VPCフローログの構成を変更するには、削除してから新しいものを作成する必要があります。
- 次のトラフィックはログで監視およびキャプチャされません。VPC内のDHCPトラフィック、Amazon DNSサーバーへのインスタンス宛のトラフィック。
- VPCデフォルトルーターのIPアドレス宛およびそのアドレスからのトラフィック、インスタンスメタデータを収集するために使用される169.254.169.254、Amazon Time Sync Serviceに使用される169.254.169.123へのトラフィック。
- WindowsインスタンスからのAmazon Windowsアクティベーションライセンスに関連するトラフィック
- ネットワークロードバランサーインターフェースとエンドポイントネットワークインターフェース間のトラフィック

CloudWatchロググループにデータを公開するネットワークインターフェースごとに、異なるログストリームが使用されます。そして、それぞれのストリーム内には、ログエントリの内容を示すフローログイベントデータが含まれます。これらのログは、おおよそ10〜15分のウィンドウでデータをキャプチャします。

## VPN

### サイト間VPN

**オンプレミスネットワークをVPCと接続します。**

- **VPN接続**：オンプレミスの機器とVPC間の安全な接続。
- **VPNトンネル**：データが顧客ネットワークとAWSの間を通過できる暗号化されたリンク。

各VPN接続には、高可用性のために同時に使用できる2つのVPNトンネルが含まれています。
- **カスタマーゲートウェイ**：AWSにお客様のゲートウェイデバイスに関する情報を提供するAWSリソース。
- **カスタマーゲートウェイデバイス**：サイト間VPN接続のお客様側にある物理デバイスまたはソフトウェアアプリケーション。
- **仮想プライベート
### クライアントVPNのコンポーネント <a href="#what-is-components" id="what-is-components"></a>

**自分のマシンからVPCに接続する**

#### コンセプト

* **クライアントVPNエンドポイント:** クライアントVPNセッションを有効化および管理するために作成および設定するリソース。すべてのクライアントVPNセッションが終了するリソースです。
* **ターゲットネットワーク:** ターゲットネットワークは、クライアントVPNエンドポイントに関連付けるネットワークです。**VPCのサブネットはターゲットネットワークです**。サブネットをクライアントVPNエンドポイントに関連付けることで、VPNセッションを確立することができます。高可用性のために、複数のサブネットをクライアントVPNエンドポイントに関連付けることができます。すべてのサブネットは同じVPCに属している必要があります。各サブネットは異なるアベイラビリティーゾーンに属している必要があります。
* **ルート**: 各クライアントVPNエンドポイントには、利用可能な宛先ネットワークルートを記述するルートテーブルがあります。ルートテーブルの各ルートは、特定のリソースまたはネットワークへのトラフィックのパスを指定します。
* **認証ルール:** 認証ルールは、ネットワークへのアクセスを許可するユーザーを制限します。指定したネットワークに対して、アクセスが許可されるActive DirectoryまたはIdentity Provider（IdP）グループを構成します。このグループに所属するユーザーのみが指定したネットワークにアクセスできます。**デフォルトでは、認証ルールは存在しません**。リソースやネットワークへのアクセスを許可するためには、認証ルールを構成する必要があります。
* **クライアント:** VPNセッションを確立するためにクライアントVPNエンドポイントに接続するエンドユーザー。エンドユーザーはOpenVPNクライアントをダウンロードし、作成したクライアントVPN設定ファイルを使用してVPNセッションを確立する必要があります。
* **クライアントCIDR範囲:** クライアントIPアドレスを割り当てるためのIPアドレス範囲。クライアントVPNエンドポイントへの各接続には、クライアントCIDR範囲から一意のIPアドレスが割り当てられます。クライアントCIDR範囲は、たとえば `10.2.0.0/16` のように選択します。
* **クライアントVPNポート:** AWSクライアントVPNは、TCPおよびUDPの両方のポート443および1194をサポートしています。デフォルトはポート443です。
* **クライアントVPNネットワークインターフェース:** サブネットをクライアントVPNエンドポイントに関連付けると、そのサブネットにクライアントVPNネットワークインターフェースが作成されます。クライアントVPNエンドポイントからVPCに送信されるトラフィックは、クライアントVPNネットワークインターフェースを介して送信されます。その後、ソースネットワークアドレス変換（SNAT）が適用され、クライアントCIDR範囲からのソースIPアドレスがクライアントVPNネットワークインターフェースのIPアドレスに変換されます。
* **接続ログ記録:** クライアントVPNエンドポイントの接続イベントを記録するために、接続ログ記録を有効にすることができます。この情報を使用して、フォレンジックを実行したり、クライアントVPNエンドポイントの使用状況を分析したり、接続の問題をデバッグしたりすることができます。
* **セルフサービスポータル:** クライアントVPNエンドポイントにセルフサービスポータルを有効にすることができます。クライアントは、自分の資格情報を使用してウェブベースのポータルにログインし、クライアントVPNエンドポイントの最新バージョンの設定ファイルまたはAWSが提供する最新バージョンのクライアントをダウンロードすることができます。

#### 制限事項

* クライアントCIDR範囲は、関連するサブネットが存在するVPCのローカルCIDRと重複してはならず、またクライアントVPNエンドポイントのルートテーブルに手動で追加されたルートとも重複してはなりません。
* クライアントCIDR範囲は、少なくとも/22のブロックサイズを持ち、/12を超えてはいけません。
* クライアントCIDR範囲のアドレスの一部は、クライアントVPNエンドポイントの可用性モデルをサポートするために使用され、クライアントに割り当てることはできません。したがって、クライアントVPNエンドポイントでサポートする最大同時接続数を有効にするために必要なIPアドレスの2倍を含むCIDRブロックを割り当てることをお勧めします。
* クライアントCIDR範囲は、クライアントVPNエンドポイントを作成した後に変更することはできません。
* クライアントVPNエンドポイントに関連付けられたサブネットは、同じVPCにある必要があります。
* 同じアベイラビリティーゾーンから複数のサブネットをクライアントVPNエンドポイントに関連付けることはできません。
* クライアントVPNエンドポイントは、専用テナンシーVPCでのサブネットの関連付けをサポートしていません。
* クライアントVPNはIPv4トラフィックのみをサポートしています。
* クライアントVPNは、連邦情報処理標準（FIPS）に準拠していません。
* Active Directoryのマルチファクタ認証（MFA）が無効になっている場合、ユーザーパスワードは次の形式にすることはできません。

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* セルフサービスポータルは、相互認証を使用して認証するクライアントには利用できません。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
