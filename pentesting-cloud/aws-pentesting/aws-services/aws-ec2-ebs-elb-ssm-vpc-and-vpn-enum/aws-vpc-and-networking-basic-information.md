# AWS - Informa√ß√µes B√°sicas sobre VPC e Rede

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## AWS Networking em poucas palavras

Um **VPC** cont√©m um **CIDR de rede** como 10.0.0.0/16 (com sua **tabela de roteamento** e **ACL de rede**).

Esta rede VPC √© dividida em **sub-redes**, ent√£o uma **sub-rede** est√° diretamente **relacionada** com o **VPC**, **tabela de roteamento** e **ACL de rede**.

Em seguida, as **interfaces de rede** anexadas aos servi√ßos (como inst√¢ncias EC2) s√£o **conectadas** √†s **sub-redes** com **grupos de seguran√ßa**.

Portanto, um **grupo de seguran√ßa** limitar√° as portas expostas das **interfaces de rede que o utilizam**, **independentemente da sub-rede**. E uma **ACL de rede** ir√° **limitar** as portas expostas para **toda a rede**.

Al√©m disso, para **acessar a Internet**, existem algumas configura√ß√µes interessantes para verificar:

* Uma **sub-rede** pode **atribuir automaticamente endere√ßos IPv4 p√∫blicos**
* Uma **inst√¢ncia** criada na rede que **atribui automaticamente endere√ßos IPv4 pode obter um**
* Um **gateway da Internet** precisa ser **anexado** ao **VPC**
  * Voc√™ tamb√©m pode usar **gateways de internet somente de sa√≠da**
* Voc√™ tamb√©m pode ter um **gateway NAT** em uma **sub-rede privada** para que seja poss√≠vel **conectar-se a servi√ßos externos** a partir dessa sub-rede privada, mas **n√£o √© poss√≠vel alcan√ß√°-los de fora**.
  * O gateway NAT pode ser **p√∫blico** (acesso √† internet) ou **privado** (acesso a outros VPCs)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

A **Virtual Private Cloud** (Amazon VPC) da Amazon permite que voc√™ **inicie recursos da AWS em uma rede virtual** que voc√™ definiu. Esta rede virtual ter√° v√°rias sub-redes, gateways de Internet para acessar a Internet, ACLs, grupos de seguran√ßa, IPs...

### Sub-redes

As sub-redes ajudam a impor um maior n√≠vel de seguran√ßa. **Agrupamento l√≥gico de recursos semelhantes** tamb√©m ajuda a manter uma **facilidade de gerenciamento** em toda a sua infraestrutura.

* Os CIDRs v√°lidos s√£o de uma m√°scara de rede /16 a uma m√°scara de rede /28.
* Uma sub-rede n√£o pode estar em diferentes zonas de disponibilidade ao mesmo tempo.
* **A AWS reserva os tr√™s primeiros endere√ßos IP do host** de cada sub-rede **para uso interno da AWS**: o primeiro endere√ßo de host usado √© para o roteador VPC. O segundo endere√ßo √© reservado para o DNS da AWS e o terceiro endere√ßo √© reservado para uso futuro.
* S√£o chamadas de **sub-redes p√∫blicas** aquelas que t√™m **acesso direto √† Internet, enquanto as sub-redes privadas n√£o t√™m.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKn
## VPN

### VPN Site-to-Site

**Conecte sua rede local com sua VPC.**

* **Conex√£o VPN**: uma conex√£o segura entre seu equipamento local e suas VPCs.
* **T√∫nel VPN**: um link criptografado onde os dados podem passar da rede do cliente para ou da AWS.

    Cada conex√£o VPN inclui dois t√∫neis VPN que voc√™ pode usar simultaneamente para alta disponibilidade.
* **Gateway do cliente**: um recurso da AWS que fornece informa√ß√µes √† AWS sobre o dispositivo do gateway do cliente.
* **Dispositivo do gateway do cliente**: um dispositivo f√≠sico ou aplicativo de software em seu lado da conex√£o VPN do site a site.
* **Gateway privado virtual**: o concentrador VPN no lado da Amazon da conex√£o VPN do site a site. Voc√™ usa um gateway privado virtual ou um gateway de tr√¢nsito como o gateway para o lado da Amazon da conex√£o VPN do site a site.
* **Gateway de tr√¢nsito**: um hub de tr√¢nsito que pode ser usado para interconectar suas VPCs e redes locais. Voc√™ usa um gateway de tr√¢nsito ou um gateway privado virtual como o gateway para o lado da Amazon da conex√£o VPN do site a site.

#### Limita√ß√µes

* O tr√°fego IPv6 n√£o √© suportado para conex√µes VPN em um gateway privado virtual.
* Uma conex√£o VPN da AWS n√£o suporta a descoberta do MTU do caminho.

Al√©m disso, leve em considera√ß√£o o seguinte ao usar VPN Site-to-Site.

* Ao conectar suas VPCs a uma rede local comum, recomendamos que voc√™ use blocos CIDR n√£o sobrepostos para suas redes.

### Componentes do VPN do cliente <a href="#what-is-components" id="what-is-components"></a>

**Conecte-se da sua m√°quina √† sua VPC**

#### Conceitos

* **Ponto de extremidade do VPN do cliente:** o recurso que voc√™ cria e configura para habilitar e gerenciar sess√µes de VPN do cliente. √â o recurso onde todas as sess√µes de VPN do cliente s√£o encerradas.
* **Rede de destino:** uma rede de destino √© a rede que voc√™ associa a um ponto de extremidade do VPN do cliente. **Uma sub-rede de uma VPC √© uma rede de destino**. Associar uma sub-rede a um ponto de extremidade do VPN do cliente permite que voc√™ estabele√ßa sess√µes VPN. Voc√™ pode associar v√°rias sub-redes a um ponto de extremidade do VPN do cliente para alta disponibilidade. Todas as sub-redes devem ser da mesma VPC. Cada sub-rede deve pertencer a uma zona de disponibilidade diferente.
* **Rota**: cada ponto de extremidade do VPN do cliente tem uma tabela de roteamento que descreve as rotas de rede de destino dispon√≠veis. Cada rota na tabela de roteamento especifica o caminho para o tr√°fego para recursos ou redes espec√≠ficos.
* **Regras de autoriza√ß√£o:** uma regra de autoriza√ß√£o **restringe os usu√°rios que podem acessar uma rede**. Para uma rede especificada, voc√™ configura o grupo do Active Directory ou provedor de identidade (IdP) que tem permiss√£o de acesso. Somente os usu√°rios que pertencem a esse grupo podem acessar a rede especificada. **Por padr√£o, n√£o h√° regras de autoriza√ß√£o** e voc√™ deve configurar regras de autoriza√ß√£o para permitir que os usu√°rios acessem recursos e redes.
* **Cliente:** o usu√°rio final que se conecta ao ponto de extremidade do VPN do cliente para estabelecer uma sess√£o VPN. Os usu√°rios finais precisam baixar um cliente OpenVPN e usar o arquivo de configura√ß√£o do VPN do cliente que voc√™ criou para estabelecer uma sess√£o VPN.
* **Intervalo de CIDR do cliente:** um intervalo de endere√ßos IP a partir do qual atribuir endere√ßos IP do cliente. Cada conex√£o ao ponto de extremidade do VPN do cliente √© atribu√≠da um endere√ßo IP exclusivo do intervalo de CIDR do cliente. Voc√™ escolhe o intervalo de CIDR do cliente, por exemplo, `10.2.0.0/16`.
* **Portas do VPN do cliente:** o AWS Client VPN suporta as portas 443 e 1194 para TCP e UDP. O padr√£o √© a porta 443.
* **Interfaces de rede do VPN do cliente:** quando voc√™ associa uma sub-rede ao seu ponto de extremidade do VPN do cliente, criamos interfaces de rede do VPN do cliente nessa sub-rede. **O tr√°fego enviado para a VPC a partir do ponto de extremidade do VPN do cliente √© enviado por meio de uma interface de rede do VPN do cliente**. A tradu√ß√£o de endere√ßo de rede de origem (SNAT) √© ent√£o aplicada, onde o endere√ßo IP de origem do intervalo de CIDR do cliente √© traduzido para o endere√ßo IP da interface de rede do VPN do cliente.
* **Registro de conex√£o:** voc√™ pode habilitar o registro de conex√£o para o seu ponto de extremidade do VPN do cliente para registrar eventos de conex√£o. Voc√™ pode usar essas informa√ß√µes para executar forense, analisar como seu ponto de extremidade do VPN do cliente est√° sendo usado ou depurar problemas de conex√£o.
* **Portal de autoatendimento:** voc√™ pode habilitar um portal de autoatendimento para o seu ponto de extremidade do VPN do cliente. Os clientes podem fazer login no portal baseado na web usando suas credenciais e baixar a vers√£o mais recente do arquivo de configura√ß√£o do ponto de extremidade do VPN do cliente ou a vers√£o mais recente do cliente fornecido pela AWS.

#### Limita√ß√µes

* **Os intervalos de CIDR do cliente n√£o podem se sobrepor ao CIDR local** da VPC na qual a sub-rede associada est√° localizada ou a qualquer rota adicionada manualmente √† tabela de roteamento do ponto de extremidade do VPN do cliente.
* Os intervalos de CIDR do cliente devem ter um tamanho de bloco de pelo menos /22 e n√£o devem ser maiores que /12.
* Uma **parte dos endere√ßos** no intervalo de CIDR do cliente √© usada para **suportar o modelo de disponibilidade** do ponto de extremidade do VPN do cliente e n√£o pode ser atribu√≠da a clientes. Portanto, recomendamos que voc√™ **atribua um bloco CIDR que contenha o dobro do n√∫mero de endere√ßos IP necess√°rios** para habilitar o n√∫mero m√°ximo de conex√µes simult√¢neas que voc√™ planeja suportar no ponto de extremidade do VPN do cliente.
* O **intervalo de CIDR do cliente n√£o pode ser alterado** depois de criar o ponto de extremidade do VPN do cliente.
* As **sub-redes** associadas a um ponto de extremidade do VPN do cliente **devem estar na mesma VPC**.
* Voc√™ **n√£o pode associar v√°rias sub-redes da mesma zona de disponibilidade a um ponto de extremidade do VPN do cliente**.
* Um ponto de extremidade do VPN do cliente **n√£o suporta associa√ß√µes de sub-rede em uma VPC de loca√ß√£o dedicada**.
* O VPN do cliente suporta apenas tr√°fego **IPv4**.
* O VPN do cliente **n√£o √© compat√≠vel com o Federal Information Processing Standards (FIPS)**.
* Se a autentica√ß√£o de v√°rios fatores (MFA) estiver desativada para o seu Active Directory, uma senha do usu√°rio n√£o pode estar no seguinte formato.

    ```
    SCRV1:<base64_encoded_string>:<base64_encoded_string>
    ```
* O portal de autoatendimento **n√£o est√° dispon√≠vel para clientes que se autenticam usando autentica√ß√£o m√∫tua**.