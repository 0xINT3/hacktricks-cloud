# AWS - VPC 和网络基础信息

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## AWS网络简介

一个 **VPC** 包含一个 **网络CIDR**，如10.0.0.0/16（带有其**路由表**和**网络ACL**）。

这个VPC网络被划分为**子网**，所以一个**子网**直接与**VPC**、**路由表**和**网络ACL**相关联。

然后，连接到服务（如EC2实例）的**网络接口**连接到带有**安全组**的**子网**。

因此，**安全组**将限制使用它的网络**接口**的暴露端口，**独立于子网**。而**网络ACL**将限制暴露给**整个网络**的端口。

此外，为了**访问互联网**，有一些有趣的配置需要检查：

* 一个**子网**可以**自动分配公共IPv4地址**
* 在自动分配IPv4地址的网络中创建的**实例**可以获得一个
* 需要将**互联网网关**连接到**VPC**
* 您还可以使用**仅出口互联网网关**
* 您还可以在**私有子网**中拥有一个**NAT网关**，以便从该私有子网**连接到外部服务**，但**无法从外部到达它们**。
* NAT网关可以是**公共的**（访问互联网）或**私有的**（访问其他VPC）

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **虚拟私有云**（Amazon VPC）使您能够**将AWS资源启动到您定义的虚拟网络中**。这个虚拟网络将拥有多个子网、访问互联网的互联网网关、ACLs、安全组、IP等...

### 子网

子网有助于加强安全级别。**逻辑分组类似资源**也有助于您在基础设施中保持**易于管理**。

* 有效的CIDR从/16网掩码到/28网掩码。
* 一个子网不能同时位于不同的可用区。
* **AWS保留每个子网的前三个主机IP地址**用于**内部AWS使用**：第一个主机地址用于VPC路由器。第二个地址保留给AWS DNS，第三个地址保留给将来使用。
* 被称为**公共子网**的是那些有**直接访问互联网的能力**，而私有子网则没有。

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### 路由表

路由表决定了VPC内子网的流量路由。它们决定哪些网络流量被转发到互联网或VPN连接。您通常会找到访问：

* 本地VPC
* NAT
* 互联网网关/仅出口互联网网关（需要给VPC访问互联网）。
* 为了使子网公开，您需要**创建**并**连接**一个**互联网网关**到您的VPC。
* VPC端点（从私有网络访问S3）

在以下图片中，您可以检查默认公共网络和私有网络的区别：

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>
### ACLs

**网络访问控制列表 (ACLs)**：网络ACL是控制子网进出网络流量的防火墙规则。它们可以用来允许或拒绝特定IP地址或范围的流量。

* 最常见的是使用安全组来允许/拒绝访问，但这是完全切断已建立的反向Shell的唯一方法。在安全组中修改规则不会停止已经建立的连接
* 然而，这适用于整个子网，禁止某些操作时要小心，因为可能会干扰所需的功能

### 安全组

安全组是一个虚拟**防火墙**，控制进出VPC中**实例**的网络**流量**。关系是1个SG对应多个实例（通常是1对1）。\
通常这用于在实例中打开危险端口，例如端口22：

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### 弹性IP地址

_弹性IP地址_ 是为动态云计算设计的**静态IPv4地址**。弹性IP地址分配给您的AWS账户，并且在您释放它之前都是您的。通过使用弹性IP地址，您可以通过快速重新映射地址到您账户中的另一个实例来掩盖实例或软件的故障。

### 子网间的连接

默认情况下，所有子网都关闭了**自动分配公共IP地址**的功能，但可以开启。

**路由表中的本地路由允许VPC子网之间的通信。**

如果您正在**连接一个子网与另一个不同的子网，您无法访问与另一个子网连接的子网**，您需要直接与它们建立连接。**这也适用于互联网网关**。您不能通过子网连接访问互联网，您需要将互联网网关分配给您的子网。

### VPC对等连接

VPC对等连接允许您**将两个或更多的VPC连接在一起**，使用IPV4或IPV6，就像它们是同一个网络的一部分。

一旦建立了对等连接，**一个VPC中的资源就可以访问另一个VPC中的资源**。VPC之间的连接是通过现有的AWS网络基础设施实现的，因此它具有高可用性，没有带宽瓶颈。由于**对等连接的操作就像它们是同一个网络的一部分**，所以在您可以使用的CIDR块范围上有限制。\
如果您的VPC有**重叠或重复的CIDR**范围，那么**您将无法将VPC对等连接在一起**。\
每个AWS VPC将**只与它的对等体通信**。例如，如果您在VPC 1和VPC 2之间有一个对等连接，在VPC 2和VPC 3之间又有另一个连接，那么VPC 1和2可以直接通信，VPC 2和VPC 3也可以，但是，VPC 1和VPC 3则不能。**您不能通过一个VPC路由到另一个VPC。**

### **VPC流量日志**

在您的VPC中，您可能有数百甚至数千个资源在不同的公共和私有子网之间以及通过VPC对等连接在不同VPC之间通信。**VPC流量日志允许您捕获在VPC内您的资源的网络接口之间流动的IP流量信息**。

与S3访问日志和CloudFront访问日志不同，**VPC流量日志生成的日志数据不存储在S3中。相反，捕获的日志数据发送到CloudWatch日志**。

限制：

* 如果您正在运行VPC对等连接，那么您只能看到同一个账户内的对等VPC的流量日志。
* 如果您仍在EC2-Classic环境中运行资源，那么不幸的是您无法检索它们接口的信息
* 一旦创建了VPC流量日志，就无法更改。要更改VPC流量日志配置，您需要删除它，然后重新创建一个新的。
* 以下流量不会被日志监控和捕获：VPC内的DHCP流量，目的地为Amazon DNS服务器的实例流量。
* 任何目的地为VPC默认路由器IP地址的流量，以及到以下地址的流量，169.254.169.254用于收集实例元数据，169.254.169.123用于Amazon时间同步服务。
* 与Amazon Windows激活许可证相关的Windows实例流量
* 网络负载均衡器接口和端点网络接口之间的流量

对于每个向CloudWatch日志组发布数据的网络接口，它将使用不同的日志流。在每个流中，将有流量日志事件数据显示日志条目的内容。每个**日志在大约10到15分钟的窗口期间捕获数据**。

## VPN

### 站点到站点VPN

**将您的本地网络与您的VPC连接。**

* **VPN连接**：您的本地设备和VPC之间的安全连接。
*   **VPN隧道**：数据可以从客户网络传输到AWS或从AWS传输的加密链接。

每个VPN连接包括两个VPN隧道，您可以同时使用它们以实现高可用性。
* **客户网关**：一个AWS资源，向AWS提供有关您的客户网关设备的信息。
* **客户网关设备**：站点到站点VPN连接中您这边的物理设备或软件应用程序。
* **虚拟私有网关**：站点到站点VPN连接中Amazon这边的VPN集中器。您使用虚拟私有网关或传输网关作为站点到站点VPN连接的Amazon这边的网关。
* **传输网关**：一个可以用来互连您的VPC和本地网络的传输枢纽。您使用传输网关或虚拟私有网关作为站点到站点VPN连接的Amazon这边的网关。

#### 限制

* 虚拟私有网关上的VPN连接不支持IPv6流量。
* AWS VPN连接不支持路径MTU发现。

此外，在使用站点到站点VPN时，请考虑以下事项。

* 当将您的VPC连接到一个共同的本地网络时，我们建议您为您的网络使用非重叠的CIDR块。
### 客户端 VPN 组件 <a href="#what-is-components" id="what-is-components"></a>

**从您的机器连接到您的 VPC**

#### 概念

* **客户端 VPN 端点：** 您创建和配置的资源，用于启用和管理客户端 VPN 会话。所有客户端 VPN 会话都在此资源上终止。
* **目标网络：** 目标网络是您与客户端 VPN 端点关联的网络。**VPC 中的一个子网是目标网络**。将子网与客户端 VPN 端点关联，可以建立 VPN 会话。您可以为了高可用性而将多个子网与客户端 VPN 端点关联。所有子网必须来自同一个 VPC。每个子网必须属于不同的可用区。
* **路由：** 每个客户端 VPN 端点都有一个路由表，描述了可用的目的网络路由。路由表中的每条路由都指定了通往特定资源或网络的路径。
* **授权规则：** 授权规则**限制了可以访问网络的用户**。对于指定的网络，您配置允许访问的 Active Directory 或身份提供商（IdP）组。只有属于此组的用户才能访问指定的网络。**默认情况下，没有授权规则**，您必须配置授权规则以启用用户访问资源和网络。
* **客户端：** 最终用户连接到客户端 VPN 端点以建立 VPN 会话。最终用户需要下载 OpenVPN 客户端并使用您创建的客户端 VPN 配置文件来建立 VPN 会话。
* **客户端 CIDR 范围：** 分配客户端 IP 地址的 IP 地址范围。连接到客户端 VPN 端点的每个连接都从客户端 CIDR 范围中分配一个唯一的 IP 地址。您选择客户端 CIDR 范围，例如，`10.2.0.0/16`。
* **客户端 VPN 端口：** AWS 客户端 VPN 支持 TCP 和 UDP 的 443 和 1194 端口。默认端口是 443。
* **客户端 VPN 网络接口：** 当您将子网与客户端 VPN 端点关联时，我们会在该子网中创建客户端 VPN 网络接口。**发送到 VPC 的来自客户端 VPN 端点的流量通过客户端 VPN 网络接口发送**。然后应用源网络地址转换（SNAT），其中客户端 CIDR 范围中的源 IP 地址被转换为客户端 VPN 网络接口 IP 地址。
* **连接日志：** 您可以为客户端 VPN 端点启用连接日志记录连接事件。您可以使用此信息进行取证，分析客户端 VPN 端点的使用情况，或调试连接问题。
* **自助服务门户：** 您可以为客户端 VPN 端点启用自助服务门户。客户可以使用他们的凭据登录基于 Web 的门户，并下载最新版本的客户端 VPN 端点配置文件，或 AWS 提供的客户端的最新版本。

#### 限制

* **客户端 CIDR 范围不能与关联子网所在 VPC 的本地 CIDR 重叠**，或任何手动添加到客户端 VPN 端点路由表的路由。
* 客户端 CIDR 范围的块大小必须至少为 **/22**，且**不能大于 /12**。
* **客户端 CIDR 范围中的一部分地址** 用于**支持客户端 VPN 端点的可用性**模型，不能分配给客户端。因此，我们建议您**分配一个包含所需 IP 地址两倍数量的 CIDR 块**，以支持您计划在客户端 VPN 端点上支持的最大并发连接数。
* **客户端 CIDR 范围在创建客户端 VPN 端点后无法更改**。
* 与客户端 VPN 端点关联的**子网必须在同一个 VPC 中**。
* **您不能将同一个可用区的多个子网与客户端 VPN 端点关联**。
* 客户端 VPN 端点**不支持在专用租户 VPC 中的子网关联**。
* 客户端 VPN 仅支持 **IPv4** 流量。
* 客户端 VPN **不符合**联邦信息处理标准（**FIPS**）**的要求**。
*   如果为您的 Active Directory 禁用了多因素认证（MFA），用户密码不能采用以下格式。

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* 对于使用相互认证进行身份验证的客户，**自助服务门户不可用**。

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
