# AWS - VPC & Informaci칩n B치sica de Redes

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Redes en AWS en Resumen

Un **VPC** contiene un **CIDR de red** como 10.0.0.0/16 (con su **tabla de enrutamiento** y **ACL de red**).

Esta red VPC se divide en **subredes**, por lo que una **subred** est치 directamente **relacionada** con el **VPC**, la **tabla de enrutamiento** y el **ACL de red**.

Luego, las **Interfaces de Red** adjuntas a servicios (como instancias EC2) est치n **conectadas** a las **subredes** con **grupo(s) de seguridad**.

Por lo tanto, un **grupo de seguridad** limitar치 los puertos expuestos de las interfaces de red **que lo usen**, **independientemente de la subred**. Y un **ACL de red** limitar치 los puertos expuestos al **conjunto de la red**.

Adem치s, para **acceder a Internet**, hay algunas configuraciones interesantes para revisar:

* Una **subred** puede **asignar autom치ticamente direcciones IPv4 p칰blicas**
* Una **instancia** creada en la red que **asigna autom치ticamente direcciones IPv4 puede obtener una**
* Se necesita **adjuntar** un **gateway de Internet** al **VPC**
* Tambi칠n podr칤as usar **gateways de Internet solo de salida**
* Tambi칠n podr칤as tener un **gateway NAT** en una **subred privada** para que sea posible **conectarse a servicios externos** desde esa subred privada, pero **no es posible alcanzarlos desde el exterior**.
* El gateway NAT puede ser **p칰blico** (acceso a internet) o **privado** (acceso a otros VPCs)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) te permite **lanzar recursos de AWS en una red virtual** que has definido. Esta red virtual tendr치 varias subredes, Gateways de Internet para acceder a Internet, ACLs, grupos de seguridad, IPs...

### Subredes

Las subredes ayudan a imponer un mayor nivel de seguridad. El **agrupamiento l칩gico de recursos similares** tambi칠n te ayuda a mantener una **facilidad de gesti칩n** en tu infraestructura.

* Los CIDR v치lidos van desde una m치scara de red /16 hasta una /28.
* Una subred no puede estar en diferentes zonas de disponibilidad al mismo tiempo.
* **AWS reserva las tres primeras direcciones IP de host** de cada subred **para** **uso interno de AWS**: la primera direcci칩n de host utilizada es para el router VPC. La segunda direcci칩n est치 reservada para DNS de AWS y la tercera direcci칩n est치 reservada para uso futuro.
* Se llaman **subredes p칰blicas** a aquellas que tienen **acceso directo a Internet, mientras que las subredes privadas no.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tablas de Rutas

Las tablas de rutas determinan el enrutamiento del tr치fico para una subred dentro de un VPC. Determinan qu칠 tr치fico de red se env칤a a Internet o a una conexi칩n VPN. Generalmente encontrar치s acceso a:

* VPC local
* NAT
* Gateways de Internet / Gateways de Internet solo de salida (necesarios para dar acceso a Internet a un VPC).
* Para hacer una subred p칰blica necesitas **crear** y **adjuntar** un **gateway de Internet** a tu VPC.
* Puntos finales de VPC (para acceder a S3 desde redes privadas)

En las siguientes im치genes puedes ver las diferencias en una red p칰blica predeterminada y una privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>
### ACLs

**Listas de Control de Acceso a la Red (ACLs)**: Las ACLs de red son reglas de firewall que controlan el tr치fico de red entrante y saliente a una subred. Se pueden utilizar para permitir o denegar el tr치fico a direcciones IP espec칤ficas o rangos.

* Es m치s frecuente permitir/denegar acceso usando grupos de seguridad, pero esta es la 칰nica manera de cortar completamente shells reversas establecidas. Una regla modificada en un grupo de seguridad no detiene conexiones ya establecidas.
* Sin embargo, esto se aplica a toda la subred, ten cuidado al prohibir cosas porque la funcionalidad necesaria podr칤a verse afectada.

### Grupos de Seguridad

Los grupos de seguridad son un **firewall virtual** que controla el tr치fico de red **entrante y saliente a instancias** en una VPC. Relaci칩n de 1 SG a M instancias (usualmente 1 a 1).\
Normalmente se utiliza para abrir puertos peligrosos en instancias, como el puerto 22 por ejemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Direcciones IP El치sticas

Una _Direcci칩n IP El치stica_ es una **direcci칩n IPv4 est치tica** dise침ada para la computaci칩n en la nube din치mica. Una direcci칩n IP el치stica se asigna a tu cuenta de AWS y es tuya hasta que la liberes. Al usar una direcci칩n IP el치stica, puedes enmascarar la falla de una instancia o software reasignando r치pidamente la direcci칩n a otra instancia en tu cuenta.

### Conexi칩n entre subredes

Por defecto, todas las subredes tienen la **asignaci칩n autom치tica de direcciones IP p칰blicas desactivada** pero se puede activar.

**Una ruta local dentro de una tabla de rutas permite la comunicaci칩n entre subredes de una VPC.**

Si est치s **conectando una subred con otra diferente no puedes acceder a las subredes conectadas** con la otra subred, necesitas crear conexi칩n con ellas directamente. **Esto tambi칠n se aplica a las puertas de enlace a internet**. No puedes pasar a trav칠s de una conexi칩n de subred para acceder a internet, necesitas asignar la puerta de enlace a internet a tu subred.

### Emparejamiento de VPC

El emparejamiento de VPC te permite **conectar dos o m치s VPCs juntas**, usando IPV4 o IPV6, como si fueran parte de la misma red.

Una vez que se establece la conectividad entre pares, **los recursos en una VPC pueden acceder a recursos en la otra**. La conectividad entre las VPCs se implementa a trav칠s de la infraestructura de red existente de AWS, y por lo tanto es altamente disponible sin cuellos de botella de ancho de banda. Como las **conexiones entre pares operan como si fueran parte de la misma red**, hay restricciones en cuanto a los rangos de bloques CIDR que se pueden usar.\
Si tienes **rangos CIDR superpuestos o duplicados** para tus VPC, entonces **no podr치s emparejar las VPCs** juntas.\
Cada VPC de AWS **solo se comunicar치 con su par**. Por ejemplo, si tienes una conexi칩n de emparejamiento entre VPC 1 y VPC 2, y otra conexi칩n entre VPC 2 y VPC 3 como se muestra, entonces VPC 1 y 2 podr칤an comunicarse entre s칤 directamente, al igual que VPC 2 y VPC 3, sin embargo, VPC 1 y VPC 3 no podr칤an. **No puedes enrutar a trav칠s de una VPC para llegar a otra.**

### **Registros de Flujo de VPC**

Dentro de tu VPC, podr칤as tener potencialmente cientos o incluso miles de recursos comunic치ndose entre diferentes subredes tanto p칰blicas como privadas y tambi칠n entre diferentes VPCs a trav칠s de conexiones de emparejamiento de VPC. **Los Registros de Flujo de VPC te permiten capturar informaci칩n del tr치fico IP que fluye entre tus interfaces de red de tus recursos dentro de tu VPC**.

A diferencia de los registros de acceso de S3 y CloudFront, los **datos de registro generados por los Registros de Flujo de VPC no se almacenan en S3. En cambio, los datos de registro capturados se env칤an a los registros de CloudWatch**.

Limitaciones:

* Si est치s ejecutando una conexi칩n de emparejamiento de VPC, solo podr치s ver los registros de flujo de VPCs emparejadas que est칠n dentro de la misma cuenta.
* Si a칰n est치s ejecutando recursos dentro del entorno EC2-Classic, entonces lamentablemente no podr치s recuperar informaci칩n de sus interfaces.
* Una vez que se ha creado un Registro de Flujo de VPC, no se puede cambiar. Para alterar la configuraci칩n del Registro de Flujo de VPC, necesitas eliminarlo y luego recrear uno nuevo.
* El siguiente tr치fico no es monitoreado ni capturado por los registros. Tr치fico DHCP dentro de la VPC, tr치fico de instancias destinado al Servidor DNS de Amazon.
* Cualquier tr치fico destinado a la direcci칩n IP del enrutador predeterminado de la VPC y tr치fico hacia y desde las siguientes direcciones, 169.254.169.254 que se utiliza para recopilar metadatos de instancia, y 169.254.169.123 que se utiliza para el Servicio de Sincronizaci칩n de Tiempo de Amazon.
* Tr치fico relacionado con una licencia de activaci칩n de Windows de Amazon desde una instancia de Windows.
* Tr치fico entre una interfaz de balanceador de carga de red y una interfaz de red de punto final.

Para cada interfaz de red que publica datos al grupo de registros de CloudWatch, utilizar치 un flujo de registros diferente. Y dentro de cada uno de estos flujos, habr치 datos de eventos de registro de flujo que muestran el contenido de las entradas de registro. Cada uno de estos **registros captura datos durante una ventana de aproximadamente 10 a 15 minutos**.

## VPN

### VPN de Sitio a Sitio

**Conecta tu red local con tu VPC.**

* **Conexi칩n VPN**: Una conexi칩n segura entre tu equipo local y tus VPCs.
*   **T칰nel VPN**: Un enlace cifrado por donde los datos pueden pasar de la red del cliente a o desde AWS.

Cada conexi칩n VPN incluye dos t칰neles VPN que puedes usar simult치neamente para alta disponibilidad.
* **Puerta de enlace del cliente**: Un recurso de AWS que proporciona informaci칩n a AWS sobre tu dispositivo de puerta de enlace del cliente.
* **Dispositivo de puerta de enlace del cliente**: Un dispositivo f칤sico o aplicaci칩n de software en tu lado de la conexi칩n VPN de Sitio a Sitio.
* **Puerta de enlace privada virtual**: El concentrador VPN del lado de Amazon de la conexi칩n VPN de Sitio a Sitio. Utilizas una puerta de enlace privada virtual o una puerta de enlace de tr치nsito como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de Sitio a Sitio.
* **Puerta de enlace de tr치nsito**: Un centro de tr치nsito que se puede utilizar para interconectar tus VPCs y redes locales. Utilizas una puerta de enlace de tr치nsito o una puerta de enlace privada virtual como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de Sitio a Sitio.

#### Limitaciones

* El tr치fico IPv6 no es compatible con las conexiones VPN en una puerta de enlace privada virtual.
* Una conexi칩n VPN de AWS no admite el Descubrimiento de MTU de Ruta.

Adem치s, ten en cuenta lo siguiente cuando uses VPN de Sitio a Sitio.

* Al conectar tus VPCs a una red local com칰n, recomendamos que uses bloques CIDR no superpuestos para tus redes.
### Componentes de Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Con칠ctese desde su m치quina a su VPC**

#### Conceptos

* **Punto final de Client VPN:** El recurso que crea y configura para habilitar y administrar sesiones de Client VPN. Es el recurso donde todas las sesiones de Client VPN terminan.
* **Red objetivo:** Una red objetivo es la red que asocia con un punto final de Client VPN. **Una subred de una VPC es una red objetivo**. Asociar una subred con un punto final de Client VPN le permite establecer sesiones VPN. Puede asociar m칰ltiples subredes con un punto final de Client VPN para alta disponibilidad. Todas las subredes deben ser de la misma VPC. Cada subred debe pertenecer a una Zona de Disponibilidad diferente.
* **Ruta**: Cada punto final de Client VPN tiene una tabla de rutas que describe las rutas de red de destino disponibles. Cada ruta en la tabla de rutas especifica el camino para el tr치fico a recursos o redes espec칤ficos.
* **Reglas de autorizaci칩n:** Una regla de autorizaci칩n **restringe los usuarios que pueden acceder a una red**. Para una red especificada, configura el grupo de Active Directory o proveedor de identidad (IdP) que tiene acceso permitido. Solo los usuarios pertenecientes a este grupo pueden acceder a la red especificada. **Por defecto, no hay reglas de autorizaci칩n** y debe configurar reglas de autorizaci칩n para permitir a los usuarios acceder a recursos y redes.
* **Cliente:** El usuario final que se conecta al punto final de Client VPN para establecer una sesi칩n VPN. Los usuarios finales necesitan descargar un cliente OpenVPN y usar el archivo de configuraci칩n de Client VPN que cre칩 para establecer una sesi칩n VPN.
* **Rango CIDR del cliente:** Un rango de direcciones IP desde el cual asignar direcciones IP de cliente. Cada conexi칩n al punto final de Client VPN se le asigna una direcci칩n IP 칰nica del rango CIDR del cliente. Usted elige el rango CIDR del cliente, por ejemplo, `10.2.0.0/16`.
* **Puertos de Client VPN:** AWS Client VPN admite los puertos 443 y 1194 para TCP y UDP. El predeterminado es el puerto 443.
* **Interfaces de red de Client VPN:** Cuando asocia una subred con su punto final de Client VPN, creamos interfaces de red de Client VPN en esa subred. **El tr치fico que se env칤a a la VPC desde el punto final de Client VPN se env칤a a trav칠s de una interfaz de red de Client VPN**. Luego se aplica la traducci칩n de direcciones de red de origen (SNAT), donde la direcci칩n IP de origen del rango CIDR del cliente se traduce a la direcci칩n IP de la interfaz de red de Client VPN.
* **Registro de conexi칩n:** Puede habilitar el registro de conexi칩n para su punto final de Client VPN para registrar eventos de conexi칩n. Puede usar esta informaci칩n para realizar forenses, analizar c칩mo se est치 utilizando su punto final de Client VPN o depurar problemas de conexi칩n.
* **Portal de autoservicio:** Puede habilitar un portal de autoservicio para su punto final de Client VPN. Los clientes pueden iniciar sesi칩n en el portal basado en la web utilizando sus credenciales y descargar la 칰ltima versi칩n del archivo de configuraci칩n del punto final de Client VPN, o la 칰ltima versi칩n del cliente proporcionado por AWS.

#### Limitaciones

* **Los rangos CIDR del cliente no pueden superponerse con el CIDR local** de la VPC en la que se encuentra la subred asociada, o cualquier ruta agregada manualmente a la tabla de rutas del punto final de Client VPN.
* Los rangos CIDR del cliente deben tener un tama침o de bloque de al menos **/22** y no deben **ser mayores que /12**.
* Una **porci칩n de las direcciones** en el rango CIDR del cliente se utilizan para **apoyar el modelo de disponibilidad** del punto final de Client VPN, y no se pueden asignar a clientes. Por lo tanto, recomendamos que **asigne un bloque CIDR que contenga el doble de direcciones IP que se requieren** para habilitar el n칰mero m치ximo de conexiones concurrentes que planea admitir en el punto final de Client VPN.
* El **rango CIDR del cliente no se puede cambiar** despu칠s de crear el punto final de Client VPN.
* Las **subredes** asociadas con un punto final de Client VPN **deben estar en la misma VPC**.
* **No puede asociar m칰ltiples subredes de la misma Zona de Disponibilidad con un punto final de Client VPN**.
* Un punto final de Client VPN **no admite asociaciones de subred en una VPC de tenencia dedicada**.
* Client VPN admite solo tr치fico **IPv4**.
* Client VPN **no es** conforme a los Est치ndares Federales de Procesamiento de Informaci칩n (**FIPS**).
*   Si la autenticaci칩n de m칰ltiples factores (MFA) est치 deshabilitada para su Active Directory, una contrase침a de usuario no puede estar en el siguiente formato.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* El portal de autoservicio **no est치 disponible para clientes que se autentican mediante autenticaci칩n mutua**.

<details>

<summary><strong>Aprenda hacking de AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si desea ver a su **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulte los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nase al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤game** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparta sus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
