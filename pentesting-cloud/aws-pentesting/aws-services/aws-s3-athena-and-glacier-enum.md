# AWS - S3、Athena＆Glacier Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい**場合や、**PEASS の最新バージョンを入手したい**場合、または HackTricks を PDF でダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をご覧ください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけてください。これは、私たちの独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションです
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしてください
* **ハッキングのテクニックを共有するために、PR を** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **の GitHub リポジトリに提出してください**

</details>

## S3

Amazon S3 は、**大量のデータを保存**するためのサービスです。

Amazon S3 は、データの REST における **保護** を実現するための複数のオプションを提供しています。これらのオプションには、**権限**（ポリシー）、**暗号化**（クライアント側およびサーバー側）、**バケットのバージョニング**、**MFA** **ベースの削除**が含まれます。ユーザーはこれらのオプションのいずれかを有効にすることでデータの保護を実現できます。**データのレプリケーション**は、AWS の内部施設であり、S3 は自動的に各オブジェクトをすべての可用性ゾーンに複製します。組織はこれを有効にする必要はありません。

リソースベースの権限を使用すると、バケットのサブディレクトリごとに権限を定義することができます。

### バケットのバージョニングと MFA ベースの削除

バケットのバージョニングが有効になっている場合、ファイル内のファイルを変更しようとするすべてのアクションは、同じ内容の前のバージョンも保持しながら、ファイルの新しいバージョンを生成します。したがって、内容を上書きすることはありません。

さらに、MFA ベースの削除は、S3 バケット内のファイルのバージョンが削除されるのを防ぎ、またバケットのバージョニングが無効にされるのをも防ぐため、攻撃者はこれらのファイルを変更することができません。

### S3 アクセスログ

S3 アクセスログを有効にすることができます（デフォルトでは無効です）。これにより、バケットにアクセスしているユーザーを知るためにログを別のバケットに保存することができます（両方のバケットは同じリージョンにある必要があります）。

### S3 プリサインド URL

バケット内の指定されたファイルにアクセスするために通常使用されるプリサインド URL を生成することができます。**プリサインド URL は次のようになります**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
プリサインドURLは、オブジェクトにアクセス権を持つ主体の資格情報を使用してcliから作成することができます（使用するアカウントにアクセス権がない場合、より短いプリサインドURLが作成されますが、無効です）。
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
署名付きURLを生成するために必要な唯一の権限は、与えられる権限です。したがって、前のコマンドでプリンシパルが必要とする唯一の権限は`s3:GetObject`です。
{% endhint %}

**他の権限**でも署名付きURLを作成することができます。
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3の暗号化メカニズム

**DEKはデータ暗号化キー**であり、常に生成されてデータの暗号化に使用されるキーです。

<details>

<summary><strong>S3管理キーによるサーバーサイド暗号化、SSE-S3</strong></summary>

このオプションでは、最小限の設定が必要で、暗号化に使用される暗号化キーのすべての管理がAWSによって管理されます。必要なのはデータをアップロードするだけで、S3がその他のすべての側面を処理します。S3アカウントの各バケットにはバケットキーが割り当てられます。

* 暗号化：
* オブジェクトデータ + 作成された平文DEK --> 暗号化されたデータ（S3内に格納）
* 作成された平文DEK + S3マスターキー --> 暗号化されたDEK（S3内に格納）、平文はメモリから削除されます
* 復号：
* 暗号化されたDEK + S3マスターキー --> 平文DEK
* 平文DEK + 暗号化されたデータ --> オブジェクトデータ

この場合、キーはAWSによって管理されます（3年ごとにのみローテーション）。独自のキーを使用する場合、ローテーション、無効化、アクセス制御の適用が可能です。

</details>

<details>

<summary><strong>KMS管理キーによるサーバーサイド暗号化、SSE-KMS</strong></summary>

この方法では、S3がキーマネジメントサービスを使用してデータの暗号化キーを生成します。KMSを使用すると、キーの管理方法にはより大きな柔軟性があります。たとえば、CMKに対して無効化、ローテーション、アクセス制御を適用し、AWS Cloud Trailを使用してその使用に対して対策を講じることができます。

* 暗号化：
* S3がKMS CMKからデータキーを要求
* KMSはCMKを使用してDEKの平文と暗号化されたDEKのペアを生成し、それらをS3に送信
* S3は平文キーを使用してデータを暗号化し、暗号化されたデータと暗号化されたキーを保存し、平文キーはメモリから削除します
* 復号：
* S3がオブジェクトの暗号化されたデータキーをKMSに復号するよう要求
* KMSはCMKを使用してデータキーを復号し、それをS3に送り返します
* S3がオブジェクトデータを復号します

</details>

<details>

<summary><strong>顧客提供キーによるサーバーサイド暗号化、SSE-C</strong></summary>

このオプションでは、AWSの外部で既に使用している独自のマスターキーを提供することができます。顧客提供キーはデータとともにS3に送信され、S3が暗号化を実行します。

* 暗号化：
* ユーザーがオブジェクトデータと顧客キーをS3に送信
* 顧客キーを使用してデータを暗号化し、暗号化されたデータを保存
* 顧客キーのソルト付きHMAC値も将来のキーの検証のために保存されます
* 顧客キーはメモリから削除されます
* 復号：
* ユーザーが顧客キーを送信
* 保存されているHMAC値とのキーの検証が行われます
* 顧客提供キーを使用してデータを復号します

</details>

<details>

<summary><strong>KMSを使用したクライアントサイド暗号化、CSE-KMS</strong></summary>

SSE-KMSと同様に、キーマネジメントサービスを使用してデータの暗号化キーを生成します。ただし、この場合はS3ではなくクライアントからKMSを呼び出します。その後、暗号化がクライアント側で行われ、暗号化されたデータがS3に送信されて保存されます。

* 暗号化：
* クライアントがKMSにデータキーを要求
* KMSは平文DEKとCMKで暗号化されたDEKを返します
* 両方のキーが返されます
* クライアントは平文DEKを使用してデータを暗号化し、暗号化されたデータと暗号化されたDEK（S3内の暗号化データのメタデータとして保存されます）をS3に送信します
* 復号：
* 暗号化されたデータと暗号化されたDEKがクライアントに送信されます
* クライアントはCMKを使用して暗号化されたキーをKMSに復号するよう要求し、KMSは平文DEKを返します
* クライアントは暗号化されたデータを復号できます

</details>

<details>

<summary><strong>顧客提供キーを使用したクライアントサイド暗号化、CSE-C</strong></summary>

このメカニズムを使用すると、独自の提供キーを利用してデータを暗号化し、それをS3に保存するためにAWS-SDKクライアントを使用することができます。

* 暗号化：
* クライアントがDEKを生成し、平文データを暗号化します
* 次に、独自のカスタムCMKを使用してDEKを暗号化します
* 暗号化されたデータ+暗号化されたDEKをS3に送信し、保存します
* 復号：
* S3が暗号化されたデータとDEKを送信します
* クライアントはDEKを暗号化したため、CMKを使用してDEKを復号し、平文DEKを使用してデータを復号します

</details>

### **列挙**

AWS組織を侵害するための伝統的な主要な方法の1つは、公開アクセス可能なバケットを侵害することから始まります。[このページで](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets) **パブリックバケットの列挙子を見つけることができます**。
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucekt-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### デュアルスタック <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

デュアルスタックエンドポイントを使用することで、仮想ホストスタイルまたはパススタイルのエンドポイント名を使用してS3バケットにアクセスすることができます。これらはIPv6を介してS3にアクセスするために役立ちます。

デュアルスタックエンドポイントは以下の構文を使用します：

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### 特権昇格

次のページでは、S3の権限を悪用して特権を昇格させる方法を確認できます：

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3のポストエクスプロイト

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### 永続化

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Amazon Athena

Amazon Athenaは、Amazon Simple Storage Service（Amazon S3）を直接使用してデータを分析するための対話型クエリサービスであり、標準のSQLを使用します。

監視されているS3バケットに表示されるコンテンツの形式でリレーショナルDBテーブルを準備する必要があります。その後、Amazon AthenaはログからDBを作成し、クエリを実行できるようになります。

Amazon Athenaは、すでに暗号化されているS3データをクエリする機能をサポートしており、設定によっては、クエリの結果も暗号化してS3に保存することができます。

この結果の暗号化は、クエリされるS3データの下にあるものとは独立しています。つまり、S3データが暗号化されていなくても、クエリされた結果は暗号化されることがあります。注意すべきポイントとして、Amazon Athenaは、次のS3暗号化メソッド（SSE-S3、SSE-KMS、CSE-KMS）で暗号化されたデータのみをサポートしています。

SSE-CおよびCSE-Eはサポートされていません。さらに、Amazon Athenaは、クエリ自体と同じリージョンにある暗号化されたオブジェクトのみを対象としてクエリを実行します。KMSを使用して暗号化されたS3データをクエリする必要がある場合、Athenaユーザにはクエリを実行するために特定の権限が必要です。

### 列挙化
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## 参考文献

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/](https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れる
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
