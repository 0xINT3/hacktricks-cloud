# AWS - S3, Athena & Glacier Enum

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## S3

Amazon S3 est un service qui vous permet de **stocker de grandes quantit√©s de donn√©es**.

Amazon S3 offre plusieurs options pour assurer la **protection** des donn√©es au repos. Les options comprennent **les autorisations** (politique), **le chiffrement** (c√¥t√© client et c√¥t√© serveur), **la versionnage du bucket** et **la suppression bas√©e sur MFA**. L'utilisateur peut activer l'une de ces options pour assurer la protection des donn√©es. La **r√©plication des donn√©es** est une fonctionnalit√© interne d'AWS o√π **S3 r√©plique automatiquement chaque objet dans toutes les zones de disponibilit√©** et l'organisation n'a pas besoin de l'activer dans ce cas.

Avec les autorisations bas√©es sur les ressources, vous pouvez d√©finir des autorisations pour les sous-r√©pertoires de votre bucket s√©par√©ment.

### Journaux d'acc√®s S3

Il est possible d'**activer la journalisation des acc√®s S3** (qui est d√©sactiv√©e par d√©faut) pour certains buckets et de sauvegarder les journaux dans un autre bucket pour savoir qui acc√®de au bucket (les deux buckets doivent √™tre dans la m√™me r√©gion).

### URL pr√©-sign√©es S3

Il est possible de g√©n√©rer une URL pr√©-sign√©e qui peut g√©n√©ralement √™tre utilis√©e pour **acc√©der au fichier sp√©cifi√©** dans le bucket. Une **URL pr√©-sign√©e ressemble √† ceci** :

```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT
### **√ânum√©ration**

L'une des principales m√©thodes traditionnelles pour compromettre les organisations AWS consiste √† compromettre les buckets accessibles publiquement. **Vous pouvez trouver** [**des √©num√©rateurs de buckets publics sur cette page**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**

```bash
# Obtenir les ACL des buckets
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Obtenir la politique
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #si elle est publique

# lister les buckets S3 associ√©s √† un profil
aws s3 ls
aws s3api list-buckets

# lister le contenu du bucket (sans credentials)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# lister le contenu du bucket (avec credentials)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copier un dossier local vers S3
aws s3 cp MyFolder s3://bucket-name --recursive

# supprimer
aws s3 rb s3://bucket-name ‚Äì-force

# t√©l√©charger un bucket S3 entier
aws s3 sync s3://<bucket>/ .

# d√©placer un bucket S3 vers un emplacement diff√©rent
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# lister les tailles d'un bucket S3 et de son contenu
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Mettre √† jour la politique du bucket
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##Exemple de politique JSON
{
  "Id": "Policy1568185116930",
  "Version": "2012-10-17",
  "Statement": [
  {
      "Sid": "Stmt1568184932403",
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::welcome",
      "Principal": "*"
  },
  {
    "Sid": "Stmt1568185007451",
    "Action": [
      "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:s3:::welcome/*",
    "Principal": "*"
  }
  ]
}

# Mettre √† jour l'ACL du bucket
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 pour obtenir l'ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucekt-name> --key flag #Way 2 pour obtenir l'ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##Exemple d'ACL JSON
## Assurez-vous de modifier le nom d'affichage et l'ID du propri√©taire en fonction de l'ACL d'objet que vous avez r√©cup√©r√©e.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Une ACL doit vous donner la permission WRITE_ACP pour pouvoir mettre une nouvelle ACL
```

### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Vous pouvez acc√©der √† un bucket S3 via un point de terminaison double pile en utilisant un nom de point de terminaison de style h√©berg√© virtuellement ou de style de chemin. Ceux-ci sont utiles pour acc√©der √† S3 via IPv6.

Les points de terminaison double pile utilisent la syntaxe suivante :

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations S3 pour escalader les privil√®ges** :

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Acc√®s non authentifi√©

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### Post-exploitation S3

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Amazon Athena

Amazon Athena est un service de requ√™te interactif qui facilite l'**analyse de donn√©es** directement dans Amazon Simple Storage Service (Amazon **S3**) **en utilisant** SQL standard.

Vous devez **pr√©parer une table de base de donn√©es relationnelle** avec le format du contenu qui va appara√Ætre dans les buckets S3 surveill√©s. Ensuite, Amazon Athena sera capable de peupler la base de donn√©es √† partir des journaux, afin que vous puissiez la requ√™ter.

Amazon Athena prend en charge la **possibilit√© de requ√™ter des donn√©es S3 qui sont d√©j√† chiffr√©es** et si elle est configur√©e pour le faire, **Athena peut √©galement chiffrer les r√©sultats de la requ√™te qui peuvent ensuite √™tre stock√©s dans S3**.

**Ce chiffrement des r√©sultats est ind√©pendant des donn√©es S3 sous-jacentes interrog√©es**, ce qui signifie que m√™me si les donn√©es S3 ne sont pas chiffr√©es, les r√©sultats interrog√©s peuvent l'√™tre. Il est important de comprendre que Amazon Athena ne prend en charge que les donn√©es qui ont √©t√© **chiffr√©es** avec les **m√©thodes de chiffrement S3 suivantes**, **SSE-S3, SSE-KMS et CSE-KMS**.

SSE-C et CSE-E ne sont pas pris en charge. En plus de cela, il est important de comprendre qu'Amazon Athena ne lancera des requ√™tes que contre des objets **chiffr√©s qui se trouvent dans la m√™me r√©gion que la requ√™te elle-m√™me**. Si vous devez interroger des donn√©es S3 qui ont √©t√© chiffr√©es √† l'aide de KMS, des autorisations sp√©cifiques sont n√©cessaires pour l'utilisateur Athena afin de lui permettre d'effectuer la requ√™te.

### √ânum√©ration

```bash
# Obtenir les catalogues
aws athena list-data-catalogs

# Obtenir les bases de donn√©es √† l'int√©rieur du catalogue
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Obtenir les ex√©cutions de requ√™tes, les requ√™tes et les r√©sultats
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Obtenir la requ√™te et les m√©tadonn√©es des r√©sultats
aws athena get-query-results --query-execution-id <id> # Cela va relancer la requ√™te et obtenir les r√©sultats

# Obtenir les groupes de travail et les d√©clarations pr√©par√©es
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name