# AWS - S3, Athena & Glacier Enum

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## S3

Amazon S3 je usluga koja vam omogućava **skladištenje velike količine podataka**.

Amazon S3 pruža više opcija za postizanje **zaštite** podataka u mirovanju. Opcije uključuju **dozvole** (Politika), **enkripciju** (klijentsku i serversku stranu), **verzioniranje kante** i **MFA** **bazirano brisanje**. **Korisnik može omogućiti** bilo koju od ovih opcija kako bi postigao zaštitu podataka. **Replikacija podataka** je interna mogućnost od strane AWS-a gde **S3 automatski replikira svaki objekat preko svih zona dostupnosti** i organizacija ne mora da je omogući u ovom slučaju.

Sa dozvolama zasnovanim na resursima, možete definisati dozvole za poddirektorijume vaše kante posebno.

### Verzioniranje kante i MFA bazirano brisanje

Kada je verzioniranje kante omogućeno, svaka akcija koja pokušava da izmeni fajl unutar fajla će generisati novu verziju fajla, čuvajući takođe prethodni sadržaj istog. Stoga, neće prepisati njegov sadržaj.

Osim toga, MFA bazirano brisanje će sprečiti brisanje verzija fajla u S3 kanti i takođe onemogućiti verzioniranje kante, tako da napadač neće moći da izmeni ove fajlove.

### S3 pristupni logovi

Moguće je **omogućiti pristupne logove S3** (koji su po defaultu onemogućeni) za neku kantu i sačuvati logove u drugoj kanti kako bi se saznalo ko pristupa kanti (obe kante moraju biti u istom regionu).

### S3 prethodno potpisani URL-ovi

Moguće je generisati prethodno potpisani URL koji se obično može koristiti za **pristupanje određenom fajlu** u kanti. **Prethodno potpisani URL izgleda ovako**:
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
Jedan prethodno potpisani URL može biti **kreiran iz komandne linije koristeći akreditive principala sa pristupom objektu** (ako nalog koji koristite nema pristup, biće kreiran kraći prethodno potpisani URL, ali će biti beskoristan).
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
Jedina potrebna dozvola za generisanje prethodno potpisane URL adrese je dozvola koja se daje, tako da za prethodnu komandu jedina dozvola koja je potrebna od strane principala je `s3:GetObject`.
{% endhint %}

Takođe je moguće kreirati prethodno potpisane URL adrese sa **drugim dozvolama**:
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### Mekanizmi šifrovanja S3

**DEK znači Data Encryption Key** i ključ koji se uvek generiše i koristi za šifrovanje podataka.

<details>

<summary><strong>Server-side enkripcija sa upravljanjem ključevima od strane S3, SSE-S3</strong></summary>

Ova opcija zahteva minimalnu konfiguraciju i svi ključevi za šifrovanje koje koristite se upravljaju od strane AWS-a. Sve što treba da uradite je da **otprenirate svoje podatke i S3 će se pobrinuti za sve ostale aspekte**. Svaka kanta u S3 nalogu dobija ključ kante.

* Šifrovanje:
* Podaci objekta + kreirani plaintext DEK --> Šifrovani podaci (smešteni unutar S3)
* Kreirani plaintext DEK + S3 Master ključ --> Šifrovani DEK (smešten unutar S3) i plaintext se briše iz memorije
* Dekripcija:
* Šifrovani DEK + S3 Master ključ --> Plaintext DEK
* Plaintext DEK + Šifrovani podaci --> Podaci objekta

Molimo, imajte na umu da u ovom slučaju **ključem upravlja AWS** (rotacija se vrši samo svake 3 godine). Ako koristite svoj ključ, moći ćete da vršite rotaciju, onemogućavanje i primenu kontrole pristupa.

</details>

<details>

<summary><strong>Server-side enkripcija sa upravljanjem ključevima od strane KMS-a, SSE-KMS</strong></summary>

Ovaj metod omogućava S3-u da koristi uslugu upravljanja ključevima za generisanje ključeva za šifrovanje podataka. KMS vam pruža mnogo veću fleksibilnost u upravljanju ključevima. Na primer, možete onemogućiti, rotirati i primeniti kontrole pristupa na CMK, i pratiti njihovu upotrebu pomoću AWS Cloud Trail-a.

* Šifrovanje:
* S3 zahteva ključeve podataka od KMS CMK
* KMS koristi CMK da generiše par plaintext DEK i šifrovanog DEK-a i šalje ih S3-u
* S3 koristi plaintext ključ za šifrovanje podataka, smešta šifrovane podatke i šifrovani ključ i briše plaintext ključ iz memorije
* Dekripcija:
* S3 traži od KMS-a da dešifruje šifrovani ključ podatka objekta
* KMS dešifruje ključ podataka sa CMK-om i šalje ga nazad S3-u
* S3 dešifruje podatke objekta

</details>

<details>

<summary><strong>Server-side enkripcija sa ključevima koje obezbeđuje korisnik, SSE-C</strong></summary>

Ova opcija vam omogućava da koristite svoj sopstveni glavni ključ koji već možda koristite van AWS-a. Vaš ključ koji obezbeđuje korisnik biće zatim poslat sa vašim podacima u S3, gde će S3 obaviti šifrovanje za vas.

* Šifrovanje:
* Korisnik šalje podatke objekta + Ključ korisnika S3-u
* Ključ korisnika se koristi za šifrovanje podataka i šifrovani podaci se smeštaju
* takođe se čuva soljeni HMAC vrednost ključa korisnika za buduću proveru ključa
* ključ korisnika se briše iz memorije
* Dekripcija:
* Korisnik šalje ključ korisnika
* Ključ se proverava protiv sačuvane HMAC vrednosti
* Ključ koji obezbeđuje korisnik se zatim koristi za dešifrovanje podataka

</details>

<details>

<summary><strong>Klijentska enkripcija sa KMS-om, CSE-KMS</strong></summary>

Slično kao SSE-KMS, i ovde se koristi usluga upravljanja ključevima za generisanje ključeva za šifrovanje podataka. Međutim, ovog puta se KMS poziva putem klijenta, a ne S3. Enkripcija se zatim vrši na strani klijenta, a šifrovani podaci se zatim šalju S3-u radi smeštanja.

* Šifrovanje:
* Klijent zahteva ključ podataka od KMS-a
* KMS vraća plaintext DEK i šifrovani DEK sa CMK-om
* Oba ključa se šalju nazad
* Klijent zatim šifruje podatke sa plaintext DEK-om i šalje S3-u šifrovane podatke + šifrovani DEK (koji se čuva kao metapodatak šifrovanih podataka unutar S3)
* Dekripcija:
* Šifrovani podaci sa šifrovanim DEK-om se šalju klijentu
* Klijent traži od KMS-a da dešifruje šifrovani ključ koristeći CMK i KMS vraća plaintext DEK
* Klijent sada može dešifrovati šifrovane podatke

</details>

<details>

<summary><strong>Klijentska enkripcija sa ključevima koje obezbeđuje korisnik, CSE-C</strong></summary>

Koristeći ovaj mehanizam, možete koristiti svoje sopstvene ključeve i koristiti AWS-SDK klijent za šifrovanje podataka pre slanja u S3 radi smeštanja.

* Šifrovanje:
* Klijent generiše DEK i šifruje plaintext podatke
* Zatim, koristeći sopstveni prilagođeni CMK, šifruje DEK
* šalje šifrovane podatke + šifrovani DEK S3-u gde se smeštaju
* Dekripcija:
* S3 šalje šifrovane podatke i DEK
* Kako klijent već ima CMK koji se koristi za šifrovanje DEK-a, dešifruje DEK, a zatim koristi plaintext DEK za dešifrovanje podataka

</details>

### **Enumeracija**

Jedan od tradicionalnih načina kompromitovanja AWS organizacija počinje kompromitovanjem javno dostupnih kanti. **Možete pronaći** [**alate za enumeraciju javnih kanti na ovoj stranici**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### Dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Možete pristupiti S3 kanti putem dual-stack endpointa koristeći virtualni hosted-style ili path-style endpoint ime. Ovi endpointi su korisni za pristup S3 putem IPv6.

Dual-stack endpointi koriste sledeću sintaksu:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Na sledećoj stranici možete proveriti kako **zloupotrebiti S3 dozvole da biste povećali privilegije**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Neautentifikovan pristup

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 post eksploatacija

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Upornost

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Ostale S3 ranjivosti

### S3 HTTP Cache Poisoning Issue <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**Prema ovom istraživanju**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue) bilo je moguće keširati odgovor proizvoljne kante kao da pripada drugoj kanti. Ovo bi moglo biti zloupotrebljeno da se promene, na primer, odgovori javascript fajlova i kompromituju proizvoljne stranice koje koriste S3 za skladištenje statičkog koda.

## Amazon Athena

Amazon Athena je interaktivna upitna usluga koja olakšava **analizu podataka** direktno u Amazon Simple Storage Service (Amazon **S3**) **koristeći** standardni **SQL**.

Potrebno je **pripremiti tabelu relacijske baze podataka** sa formatom sadržaja koji će se pojaviti u praćenim S3 kantama. Zatim, Amazon Athena će moći da popuni bazu podacima iz logova, tako da ih možete upitati.

Amazon Athena podržava **mogućnost upita nad S3 podacima koji su već enkriptovani**, i ako je konfigurisana da to radi, **Athena takođe može enkriptovati rezultate upita koji se mogu čuvati u S3**.

**Ova enkripcija rezultata je nezavisna od enkriptovanih S3 podataka koji se upituju**, što znači da čak i ako S3 podaci nisu enkriptovani, rezultati upita mogu biti enkriptovani. Neke važne tačke koje treba imati na umu su da Amazon Athena podržava samo podatke koji su **enkriptovani** sa **sledećim metodama enkripcije S3**, **SSE-S3, SSE-KMS i CSE-KMS**.

SSE-C i CSE-E nisu podržani. Pored toga, važno je razumeti da će Amazon Athena izvršavati upite samo nad **enkriptovanim objektima koji se nalaze u istoj regiji kao i sam upit**. Ako želite da upitate S3 podatke koji su enkriptovani pomoću KMS, tada su potrebne određene dozvole od strane korisnika Athene da bi omogućili izvršavanje upita.

### Enumeracija
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## Reference

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/](https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju oglašenu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
