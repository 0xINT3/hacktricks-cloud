# AWS - Enumera√ß√£o de S3, Athena e Glacier

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## S3

O Amazon S3 √© um servi√ßo que permite **armazenar grandes quantidades de dados**.

O Amazon S3 fornece v√°rias op√ß√µes para alcan√ßar a **prote√ß√£o** de dados em repouso. As op√ß√µes incluem **Permiss√£o** (Pol√≠tica), **Criptografia** (Cliente e Servidor), **Versionamento de Bucket** e **Exclus√£o baseada em MFA**. O **usu√°rio pode habilitar** qualquer uma dessas op√ß√µes para alcan√ßar a prote√ß√£o de dados. A **replica√ß√£o de dados** √© uma facilidade interna da AWS, onde **o S3 replica automaticamente cada objeto em todas as zonas de disponibilidade** e a organiza√ß√£o n√£o precisa habilit√°-la nesse caso.

Com permiss√µes baseadas em recursos, voc√™ pode definir permiss√µes para subdiret√≥rios do seu bucket separadamente.

### Logs de acesso do S3

√â poss√≠vel **habilitar o registro de acesso do S3** (que por padr√£o est√° desativado) para algum bucket e salvar os logs em um bucket diferente para saber quem est√° acessando o bucket (ambos os buckets devem estar na mesma regi√£o).

### URLs pr√©-assinadas do S3

√â poss√≠vel gerar uma URL pr√©-assinada que geralmente pode ser usada para **acessar o arquivo especificado** no bucket. Uma **URL pr√©-assinada se parece com isso**:

```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7J
### Enumera√ß√£o

Uma das principais maneiras tradicionais de comprometer organiza√ß√µes AWS come√ßa comprometendo buckets publicamente acess√≠veis. **Voc√™ pode encontrar** [**enumeradores de buckets p√∫blicos nesta p√°gina**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**

```bash
# Obter ACLs de buckets
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Obter pol√≠tica
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #se for p√∫blico

# listar buckets S3 associados a um perfil
aws s3 ls
aws s3api list-buckets

# listar conte√∫do do bucket (sem credenciais)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# listar conte√∫do do bucket (com credenciais)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copiar pasta local para S3
aws s3 cp MyFolder s3://bucket-name --recursive

# excluir
aws s3 rb s3://bucket-name ‚Äì-force

# baixar um bucket S3 inteiro
aws s3 sync s3://<bucket>/ .

# mover bucket S3 para localiza√ß√£o diferente
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# listar os tamanhos de um bucket S3 e seu conte√∫do
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Atualizar pol√≠tica do bucket
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##Exemplo de pol√≠tica JSON
{
  "Id": "Policy1568185116930",
  "Version": "2012-10-17",
  "Statement": [
  {
      "Sid": "Stmt1568184932403",
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::welcome",
      "Principal": "*"
  },
  {
    "Sid": "Stmt1568185007451",
    "Action": [
      "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:s3:::welcome/*",
    "Principal": "*"
  }
  ]
}

# Atualizar ACL do bucket
aws s3api get-bucket-acl --bucket <bucket-name> # Forma 1 de obter a ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucekt-name> --key flag #Forma 2 de obter a ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##Exemplo de ACL JSON
## Certifique-se de modificar o displayName e o ID do propriet√°rio de acordo com a ACL do objeto que voc√™ recuperou.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Uma ACL deve dar permiss√£o WRITE_ACP para poder colocar uma nova ACL
```

### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Voc√™ pode acessar um bucket S3 por meio de um endpoint de dupla pilha usando um nome de endpoint de estilo hospedado virtual ou de estilo de caminho. Isso √© √∫til para acessar o S3 por meio do IPv6.

Os endpoints de dupla pilha usam a seguinte sintaxe:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

Na seguinte p√°gina, voc√™ pode verificar como **abusar das permiss√µes do S3 para escalar privil√©gios**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Acesso n√£o autenticado

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### P√≥s-explora√ß√£o do S3

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Amazon Athena

O Amazon Athena √© um servi√ßo de consulta interativa que facilita a **an√°lise de dados** diretamente no Amazon Simple Storage Service (Amazon **S3**) **usando** SQL padr√£o.

Voc√™ precisa **preparar uma tabela de banco de dados relacional** com o formato do conte√∫do que aparecer√° nos buckets S3 monitorados. E ent√£o, o Amazon Athena poder√° popular o banco de dados a partir dos logs, para que voc√™ possa consult√°-lo.

O Amazon Athena suporta a **capacidade de consultar dados S3 que j√° est√£o criptografados** e, se configurado para isso, **o Athena tamb√©m pode criptografar os resultados da consulta que podem ser armazenados no S3**.

**Essa criptografia de resultados √© independente dos dados S3 consultados subjacentes**, o que significa que mesmo se os dados S3 n√£o estiverem criptografados, os resultados consultados podem ser criptografados. Alguns pontos a serem observados s√£o que o Amazon Athena suporta apenas dados que foram **criptografados** com os **seguintes m√©todos de criptografia S3**, **SSE-S3, SSE-KMS e CSE-KMS**.

SSE-C e CSE-E n√£o s√£o suportados. Al√©m disso, √© importante entender que o Amazon Athena executar√° consultas apenas contra **objetos criptografados que est√£o na mesma regi√£o que a consulta em si**. Se voc√™ precisar consultar dados S3 que foram criptografados usando o KMS, ser√£o necess√°rias permiss√µes espec√≠ficas do usu√°rio Athena para permitir que ele execute a consulta.

### Enumera√ß√£o

```bash
# Obter cat√°logos
aws athena list-data-catalogs

# Obter bancos de dados dentro do cat√°logo
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Obter execu√ß√µes de consulta, consultas e resultados
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Obter consulta e metadados dos resultados
aws athena get-query-results --query-execution-id <id> # Isso ir√° executar a consulta novamente e obter os resultados

# Obter grupos de trabalho e declara√ß√µes preparadas
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Executar consulta
aws athena start-query-execution --query-string <query>
```

## Refer√™ncias

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://h