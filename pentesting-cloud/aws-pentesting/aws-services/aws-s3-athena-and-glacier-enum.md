# AWS - Enumeraci√≥n de S3, Athena y Glacier

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## S3

Amazon S3 es un servicio que permite **almacenar grandes cantidades de datos**.

Amazon S3 proporciona m√∫ltiples opciones para lograr la **protecci√≥n** de los datos en reposo. Las opciones incluyen **Permiso** (Pol√≠tica), **Cifrado** (Cliente y Servidor), **Versionado de cubo** y **Eliminaci√≥n basada en MFA**. El **usuario puede habilitar** cualquiera de estas opciones para lograr la protecci√≥n de datos. La **replicaci√≥n de datos** es una facilidad interna de AWS donde **S3 replica autom√°ticamente cada objeto en todas las zonas de disponibilidad** y la organizaci√≥n no necesita habilitarla en este caso.

Con permisos basados en recursos, puede definir permisos para subdirectorios de su cubo por separado.

### Registros de acceso de S3

Es posible **habilitar el registro de acceso de S3** (que por defecto est√° deshabilitado) para alg√∫n cubo y guardar los registros en un cubo diferente para saber qui√©n est√° accediendo al cubo (ambos cubos deben estar en la misma regi√≥n).

### URLs prefirmadas de S3

Es posible generar una URL prefirmada que generalmente se puede utilizar para **acceder al archivo especificado** en el cubo. Una **URL prefirmada se ve as√≠**:

```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3
### Enumeraci√≥n

Una de las formas tradicionales de comprometer organizaciones de AWS comienza comprometiendo buckets p√∫blicamente accesibles. **Puede encontrar** [**enumeradores de buckets p√∫blicos en esta p√°gina**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**.**

```bash
# Obtener ACLs de buckets
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Obtener pol√≠tica
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #si es p√∫blico

# listar buckets S3 asociados con un perfil
aws s3 ls
aws s3api list-buckets

# listar contenido del bucket (sin credenciales)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# listar contenido del bucket (con credenciales)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copiar carpeta local a S3
aws s3 cp MyFolder s3://bucket-name --recursive

# eliminar
aws s3 rb s3://bucket-name ‚Äì-force

# descargar un bucket completo de S3
aws s3 sync s3://<bucket>/ .

# mover bucket de S3 a una ubicaci√≥n diferente
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# listar los tama√±os de un bucket de S3 y su contenido
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Actualizar pol√≠tica de bucket
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##Ejemplo de pol√≠tica JSON
{
  "Id": "Policy1568185116930",
  "Version": "2012-10-17",
  "Statement": [
  {
      "Sid": "Stmt1568184932403",
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::welcome",
      "Principal": "*"
  },
  {
    "Sid": "Stmt1568185007451",
    "Action": [
      "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:s3:::welcome/*",
    "Principal": "*"
  }
  ]
}

# Actualizar ACL de bucket
aws s3api get-bucket-acl --bucket <bucket-name> # Forma 1 de obtener la ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucekt-name> --key flag # Forma 2 de obtener la ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##Ejemplo de ACL JSON
## Aseg√∫rese de modificar el displayName y el ID del propietario de acuerdo con la ACL de objeto que recuper√≥.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Una ACL debe darle el permiso WRITE_ACP para poder poner una nueva ACL
```

### dual-stack <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

Puede acceder a un bucket de S3 a trav√©s de un punto final de doble pila utilizando un nombre de punto final de estilo virtual o de estilo de ruta. Estos son √∫tiles para acceder a S3 a trav√©s de IPv6.

Los puntos finales de doble pila utilizan la siguiente sintaxis:

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### Privesc

En la siguiente p√°gina puede verificar c√≥mo **abusar de los permisos de S3 para escalar privilegios**:

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### Acceso no autenticado

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Explotaci√≥n de S3

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## Amazon Athena

Amazon Athena es un servicio de consulta interactivo que facilita el **an√°lisis de datos** directamente en Amazon Simple Storage Service (Amazon **S3**) **usando** SQL est√°ndar.

Debe **preparar una tabla de base de datos relacional** con el formato del contenido que aparecer√° en los buckets de S3 monitoreados. Luego, Amazon Athena podr√° poblar la base de datos a partir de los registros, para que pueda consultarla.

Amazon Athena admite la **capacidad de consultar datos de S3 que ya est√°n cifrados** y, si est√° configurado para hacerlo, **Athena tambi√©n puede cifrar los resultados de la consulta que luego se pueden almacenar en S3**.

**Este cifrado de resultados es independiente de los datos de S3 consultados subyacentes**, lo que significa que incluso si los datos de S3 no est√°n cifrados, los resultados consultados pueden estar cifrados. Un par de puntos a tener en cuenta es que Amazon Athena solo admite datos que se han **cifrado** con los **siguientes m√©todos de cifrado de S3**, **SSE-S3, SSE-KMS y CSE-KMS**.

SSE-C y CSE-E no son compatibles. Adem√°s de esto, es importante entender que Amazon Athena solo ejecutar√° consultas contra **objetos cifrados que se encuentren en la misma regi√≥n que la consulta en s√≠**. Si necesita consultar datos de S3 que se hayan cifrado usando KMS, entonces se requieren permisos espec√≠ficos por parte del usuario de Athena para permitirles realizar la consulta.

### Enumeraci√≥n

```bash
# Obtener cat√°logos
aws athena list-data-catalogs

# Obtener bases de datos dentro del cat√°logo
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Obtener ejecuciones de consultas, consultas y resultados
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Obtener consulta y metadatos de resultados
aws athena get-query-results --query-execution-id <id> # Esto volver√° a ejecutar la consulta y obtendr√° los resultados

# Obtener grupos de trabajo y declaraciones preparadas
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Ejecutar consulta
aws athena start-query-execution --query-string <query>
```

## Referencias

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/](https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/)
* [https://docs.aws.amazon.com/AmazonS3