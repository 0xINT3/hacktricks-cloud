# AWS - S3, Athena & Glacier 枚举

<details>

<summary><strong>从零到英雄学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## S3

Amazon S3是一个允许您**存储大量数据**的服务。

Amazon S3提供多种选项来实现数据**保护**。这些选项包括**权限**（策略）、**加密**（客户端和服务器端）、**存储桶版本控制**和**基于MFA的删除**。**用户可以启用**这些选项中的任何一个来实现数据保护。**数据复制**是AWS的内部设施，其中**S3会自动将每个对象复制到所有可用区**，组织在这种情况下不需要启用它。

使用基于资源的权限，您可以分别为存储桶的子目录定义权限。

### 存储桶版本控制和基于MFA的删除

启用存储桶版本控制时，任何试图更改文件内部文件的操作都会生成该文件的新版本，同时也保留相同的旧内容。因此，它不会覆盖其内容。

此外，基于MFA的删除将防止S3存储桶中的文件版本被删除，也防止存储桶版本控制被禁用，因此攻击者将无法更改这些文件。

### S3访问日志

可以**启用S3访问日志**（默认情况下是禁用的），将日志保存在不同的存储桶中，以了解谁在访问存储桶（两个存储桶必须在同一区域内）。

### S3预签名URL

可以生成一个预签名URL，通常用于**访问存储桶中指定的文件**。**预签名URL看起来像这样**：
```
https://<bucket-name>.s3.us-east-1.amazonaws.com/asd.txt?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAUUE8GZC4S5L3TY3P%2F20230227%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20230227T142551Z&X-Amz-Expires=3600&X-Amz-SignedHeaders=host&X-Amz-Security-Token=IQoJb3JpZ2luX2VjELf%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMSJHMEUCIBhQpdETJO3HKKDk2hjNIrPWwBE8gZaQccZFV3kCpPCWAiEAid3ueDtFFU%2FOQfUpvxYTGO%2BHoS4SWDMUrQAE0pIaB40qggMIYBAAGgwzMTgxNDIxMzg1NTMiDJLI5t7gr2EGxG1Y5CrfAioW0foHIQ074y4gvk0c%2B%2Fmqc7cNWb1njQslQkeePHkseJ3owzc%2FCwkgE0EuZTd4mw0aJciA2XIbJRCLPWTb%2FCBKPnIMJ5aBzIiA2ltsiUNQTTUxYmEgXZoJ6rFYgcodnmWW0Et4Xw59UlHnCDB2bLImxPprriyCzDDCD6nLyp3J8pFF1S8h3ZTJE7XguA8joMs4%2B2B1%2FeOZfuxXKyXPYSKQOOSbQiHUQc%2BFnOfwxleRL16prWk1t7TamvHR%2Bt3UgMn5QWzB3p8FgWwpJ6GjHLkYMJZ379tkimL1tJ7o%2BIod%2FMYrS7LDCifP9d%2FuYOhKWGhaakPuJKJh9fl%2B0vGl7kmApXigROxEWon6ms75laXebltsWwKcKuYca%2BUWu4jVJx%2BWUfI4ofoaGiCSaKALTqwu4QNBRT%2BMoK6h%2BQa7gN7JFGg322lkxRY53x27WMbUE4unn5EmI54T4dWt1%2Bg8ljDS%2BvKfBjqmAWRwuqyfwXa5YC3xxttOr3YVvR6%2BaXpzWtvNJQNnb6v0uI3%2BTtTexZkJpLQYqFcgZLQSxsXWSnf988qvASCIUhAzp2UnS1uqy7QjtD5T73zksYN2aesll7rvB80qIuujG6NOdHnRJ2M5%2FKXXNo1Yd15MtzPuSjRoSB9RSMon5jFu31OrQnA9eCUoawxbB0nHqwK8a43CKBZHhA8RoUAJW%2B48EuFsp3U%3D&X-Amz-Signature=3436e4139e84dbcf5e2e6086c0ebc92f4e1e9332b6fda24697bc339acbf2cdfa
```
一个预签名URL可以**使用具有对象访问权限的主体的凭证从cli创建**（如果您使用的帐户没有访问权限，将创建一个较短的预签名URL，但它将是无用的）
```bash
aws s3 presign --region <bucket-region> 's3://<bucket-name>/<file-name>'
```
{% hint style="info" %}
生成预签名 URL 唯一需要的权限就是被授权的权限，因此对于前面的命令，主体唯一需要的权限是 `s3:GetObject`
{% endhint %}

也可以使用**其他权限**创建预签名 URL：
```python
import boto3
url = boto3.client('s3').generate_presigned_url(
ClientMethod='put_object',
Params={'Bucket': 'BUCKET_NAME', 'Key': 'OBJECT_KEY'},
ExpiresIn=3600
)
```
### S3 加密机制

**DEK 指的是数据加密密钥**，这是始终生成并用于加密数据的密钥。

<details>

<summary><strong>使用 S3 管理的密钥进行服务器端加密，SSE-S3</strong></summary>

此选项需要最少的配置，所有使用的加密密钥都由 AWS 管理。您需要做的就是**上传您的数据，S3 将处理所有其他方面**。S3 账户中的每个存储桶都被分配了一个存储桶密钥。

* 加密：
* 对象数据 + 创建的明文 DEK --> 加密数据（存储在 S3 内）
* 创建的明文 DEK + S3 主密钥 --> 加密 DEK（存储在 S3 内），明文从内存中删除
* 解密：
* 加密 DEK + S3 主密钥 --> 明文 DEK
* 明文 DEK + 加密数据 --> 对象数据

请注意，在这种情况下**密钥由 AWS 管理**（仅每三年旋转一次）。如果您使用自己的密钥，您将能够旋转、禁用并应用访问控制。

</details>

<details>

<summary><strong>使用 KMS 管理的密钥进行服务器端加密，SSE-KMS</strong></summary>

此方法允许 S3 使用密钥管理服务来生成您的数据加密密钥。KMS 为您的密钥管理提供了更大的灵活性。例如，您可以禁用、旋转和应用访问控制到 CMK，并使用 AWS Cloud Trail 订单来防止它们的使用。

* 加密：
* S3 从 KMS CMK 请求数据密钥
* KMS 使用 CMK 生成 DEK 明文和 DEK 加密对，并将它们发送给 S£
* S3 使用明文密钥加密数据，存储加密数据和加密密钥，并从内存中删除明文密钥
* 解密：
* S3 要求 KMS 解密对象的加密数据密钥
* KMS 使用 CMK 解密数据密钥并将其发送回 S3
* S3 解密对象数据

</details>

<details>

<summary><strong>使用客户提供的密钥进行服务器端加密，SSE-C</strong></summary>

此选项为您提供了提供自己的主密钥的机会，您可能已经在 AWS 外部使用该密钥。然后，您提供的客户密钥将与您的数据一起发送到 S3，在那里 S3 将为您执行加密。

* 加密：
* 用户将对象数据 + 客户密钥发送到 S3
* 客户密钥用于加密数据，加密数据被存储
* 客户密钥的盐化 HMAC 值也被存储，用于将来的密钥验证
* 客户密钥从内存中删除
* 解密：
* 用户发送客户密钥
* 密钥与存储的 HMAC 值进行验证
* 然后使用客户提供的密钥解密数据

</details>

<details>

<summary><strong>使用 KMS 的客户端加密，CSE-KMS</strong></summary>

与 SSE-KMS 类似，这也使用密钥管理服务来生成您的数据加密密钥。然而，这次是通过客户端而不是 S3 调用 KMS。然后在客户端进行加密，加密数据随后发送到 S3 进行存储。

* 加密：
* 客户端向 KMS 请求数据密钥
* KMS 返回明文 DEK 和使用 CMK 加密的 DEK
* 两个密钥都被发送回来
* 客户端随后使用明文 DEK 加密数据，并将加密数据 + 加密 DEK 发送到 S3（作为 S3 内加密数据的元数据保存）
* 解密：
* 加密数据与加密 DEK 发送给客户端
* 客户端要求 KMS 使用 CMK 解密加密密钥，KMS 发回明文 DEK
* 客户端现在可以解密加密数据

</details>

<details>

<summary><strong>使用客户提供的密钥进行客户端加密，CSE-C</strong></summary>

使用此机制，您可以使用自己提供的密钥，并使用 AWS-SDK 客户端在将数据发送到 S3 存储之前对其进行加密。

* 加密：
* 客户端生成 DEK 并加密明文数据
* 然后，使用它自己的自定义 CMK 加密 DEK
* 将加密数据 + 加密 DEK 提交到 S3，其中存储
* 解密：
* S3 发送加密数据和 DEK
* 由于客户端已经拥有用于加密 DEK 的 CMK，它解密 DEK，然后使用明文 DEK 解密数据

</details>

### **枚举**

侵害 AWS 组织的传统主要方式之一是通过公开可访问的存储桶开始。**您可以在此页面找到**[**公共存储桶枚举器**](../../aws-security/aws-unauthenticated-enum-access/#s3-buckets)**。**
```bash
# Get buckets ACLs
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api get-object-acl --bucket <bucket-name> --key flag

# Get policy
aws s3api get-bucket-policy --bucket <bucket-name>
aws s3api get-bucket-policy-status --bucket <bucket-name> #if it's public

# list S3 buckets associated with a profile
aws s3 ls
aws s3api list-buckets

# list content of bucket (no creds)
aws s3 ls s3://bucket-name --no-sign-request
aws s3 ls s3://bucket-name --recursive

# list content of bucket (with creds)
aws s3 ls s3://bucket-name
aws s3api list-objects-v2 --bucket <bucket-name>
aws s3api list-objects --bucket <bucket-name>
aws s3api list-object-versions --bucket <bucket-name>

# copy local folder to S3
aws s3 cp MyFolder s3://bucket-name --recursive

# delete
aws s3 rb s3://bucket-name –-force

# download a whole S3 bucket
aws s3 sync s3://<bucket>/ .

# move S3 bucket to different location
aws s3 sync s3://oldbucket s3://newbucket --source-region us-west-1

# list the sizes of an S3 bucket and its contents
aws s3api list-objects --bucket BUCKETNAME --output json --query "[sum(Contents[].Size), length(Contents[])]"

# Update Bucket policy
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
##JSON policy example
{
"Id": "Policy1568185116930",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Stmt1568184932403",
"Action": [
"s3:ListBucket"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome",
"Principal": "*"
},
{
"Sid": "Stmt1568185007451",
"Action": [
"s3:GetObject"
],
"Effect": "Allow",
"Resource": "arn:aws:s3:::welcome/*",
"Principal": "*"
}
]
}

# Update bucket ACL
aws s3api get-bucket-acl --bucket <bucket-name> # Way 1 to get the ACL
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

aws s3api get-object-acl --bucket <bucket-name> --key flag #Way 2 to get the ACL
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

##JSON ACL example
## Make sure to modify the Owner’s displayName and ID according to the Object ACL you retrieved.
{
"Owner": {
"DisplayName": "<DisplayName>",
"ID": "<ID>"
},
"Grants": [
{
"Grantee": {
"Type": "Group",
"URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
},
"Permission": "FULL_CONTROL"
}
]
}
## An ACL should give you the permission WRITE_ACP to be able to put a new ACL
```
### 双栈 <a href="#dual-stack-endpoints-description" id="dual-stack-endpoints-description"></a>

您可以通过使用虚拟托管式或路径式端点名称，通过双栈端点访问S3存储桶。这些对于通过IPv6访问S3很有用。

双栈端点使用以下语法：

* `bucketname.s3.dualstack.aws-region.amazonaws.com`
* `s3.dualstack.aws-region.amazonaws.com/bucketname`

### 权限提升

在以下页面中，您可以检查如何**滥用S3权限以提升权限**：

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-s3-privesc.md" %}
[aws-s3-privesc.md](../../aws-security/aws-privilege-escalation/aws-s3-privesc.md)
{% endcontent-ref %}

### 未经认证的访问

{% content-ref url="../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md" %}
[aws-s3-unauthenticated-enum.md](../../aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum.md)
{% endcontent-ref %}

### S3 操作后利用

{% content-ref url="../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

### 持久性

{% content-ref url="../aws-persistence/aws-s3-persistence.md" %}
[aws-s3-persistence.md](../aws-persistence/aws-s3-persistence.md)
{% endcontent-ref %}

## 其他S3漏洞

### S3 HTTP缓存投毒问题 <a href="#heading-s3-http-desync-cache-poisoning-issue" id="heading-s3-http-desync-cache-poisoning-issue"></a>

[**根据这项研究**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-s3-http-desync-cache-poisoning-issue)，可以缓存任意存储桶的响应，就好像它属于另一个存储桶一样。这可能被滥用来更改例如JavaScript文件响应，并通过使用S3存储静态代码来妥协任意页面。

## Amazon Athena

Amazon Athena是一个交互式查询服务，它可以轻松地**分析**直接在Amazon简单存储服务（Amazon **S3**）中的数据，**使用**标准**SQL**。

您需要**准备一个关系型数据库表**，格式与将出现在监控的S3存储桶中的内容相匹配。然后，Amazon Athena将能够从日志中填充数据库，以便您可以查询它。

Amazon Athena支持**查询已加密的S3数据的能力**，如果进行了配置，**Athena还可以加密查询结果，然后可以存储在S3中**。

**这种结果加密与查询的底层S3数据无关**，这意味着即使S3数据未加密，查询结果也可以加密。需要注意的几点是，Amazon Athena仅支持已使用以下S3加密方法加密的数据，**SSE-S3、SSE-KMS和CSE-KMS**。

不支持SSE-C和CSE-E。除此之外，重要的是要理解，Amazon Athena只会对与查询本身位于同一区域的**加密对象**运行查询。如果您需要查询使用KMS加密的S3数据，则Athena用户需要特定权限才能执行查询。

### 枚举
```bash
# Get catalogs
aws athena list-data-catalogs

# Get databases inside catalog
aws athena list-databases --catalog-name <catalog-name>
aws athena list-table-metadata --catalog-name <catalog-name> --database-name <db-name>

# Get query executions, queries and results
aws athena list-query-executions
aws athena get-query-execution --query-execution-id <id> # Get query and meta of results
aws athena get-query-results --query-execution-id <id> # This will rerun the query and get the results

# Get workgroups & Prepared statements
aws athena list-work-groups
aws athena list-prepared-statements --work-group <wg-name>
aws athena get-prepared-statement --statement-name <name> --work-group <wg-name>

# Run query
aws athena start-query-execution --query-string <query>
```
## 参考资料

* [https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3](https://cloudsecdocs.com/aws/defensive/tooling/cli/#s3)
* [https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/](https://hackingthe.cloud/aws/post\_exploitation/s3\_acl\_persistence/)
* [https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html](https://docs.aws.amazon.com/AmazonS3/latest/userguide/dual-stack-endpoints.html)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客技术！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
