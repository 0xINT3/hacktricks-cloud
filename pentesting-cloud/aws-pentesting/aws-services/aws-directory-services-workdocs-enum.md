# AWS - 目录服务 / WorkDocs 枚举

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## 目录服务

AWS Directory Service for Microsoft Active Directory 是一项托管服务，可在 AWS 云中轻松**设置、运行和扩展目录**。它基于实际的**Microsoft Active Directory**，与其他 AWS 服务紧密集成，使您能够轻松管理与目录相关的工作负载和 AWS 资源。使用 AWS 托管的 Microsoft AD，您可以使用现有的 Active Directory 用户、组和策略来管理对 AWS 资源的访问。这有助于简化身份管理，并减少对其他身份解决方案的需求。AWS 托管的 Microsoft AD 还提供自动备份和灾难恢复功能，有助于确保目录的可用性和耐久性。总体而言，AWS Directory Service for Microsoft Active Directory 可以通过在 AWS 云中提供托管、高可用和可扩展的 Active Directory 服务来帮助您节省时间和资源。

### 选项

目录服务允许创建 5 种类型的目录：

* **AWS 托管的 Microsoft AD**：在 AWS 中运行一个新的**Microsoft AD**。您将能够设置管理员密码并访问 VPC 中的 DC。
* **Simple AD**：这将是一个**Linux-Samba**兼容的 Active Directory 服务器。您将能够设置管理员密码并访问 VPC 中的 DC。
* **AD 连接器**：用于将目录请求重定向到现有的 Microsoft Active Directory，而不在云中缓存任何信息的代理。它将在一个**VPC**中监听，并且您需要提供**访问现有 AD 的凭据**。
* **Amazon Cognito 用户池**：与 Cognito 用户池相同。
* **Cloud Directory**：这是**最简单**的一种。一个**无服务器**目录，您指定要使用的**模式**并按使用量计费。

AWS 目录服务允许与现有的**本地** Microsoft AD 进行**同步**，在 AWS 中运行您自己的 AD，或与**其他目录类型**进行同步。

### 实验

在这里，您可以找到一个很好的教程，以在 AWS 中创建自己的 Microsoft AD：[https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### 枚举
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### 登录

请注意，如果目录的**描述**字段中包含**AccessUrl**字段中的**域名**，那么用户可能可以使用其**AD凭据**登录到某些**AWS服务**中：

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### 权限提升

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## 持久性

### 使用AD用户

可以通过角色来授予**AD用户**对AWS管理控制台的访问权限。**默认用户名为Admin**，可以从AWS控制台**更改其密码**。

因此，可以**更改Admin的密码**，**创建新用户**或**更改用户的密码**并授予该用户角色以保持访问权限。\
还可以**将用户添加到AD中的组**并**将该AD组授予角色**（以使此持久性更隐蔽）。

### 共享AD（从受害者到攻击者）

可以将AD环境从受害者共享给攻击者。这样，攻击者将能够继续访问AD环境。\
但是，这意味着需要共享托管的AD并创建VPC对等连接。

您可以在此处找到指南：[https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~共享AD（从攻击者到受害者）~~

似乎不可能将来自不同AD环境的用户授予对一个AWS账户的访问权限。

## WorkDocs

Amazon Web Services (AWS) WorkDocs是一种基于云的**文件存储和共享服务**。它是AWS云计算服务套件的一部分，旨在为组织提供安全可扩展的解决方案，用于存储、共享和协作文件和文档。

AWS WorkDocs为用户提供了一个基于Web的界面，用于上传、访问和管理其文件和文档。它还提供版本控制、实时协作和与其他AWS服务和第三方工具的集成等功能。

### 枚举

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
### 提权

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
