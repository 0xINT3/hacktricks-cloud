# AWS - Services de r√©pertoire / Enum√©ration de WorkDocs

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Services de r√©pertoire

AWS Directory Service pour Microsoft Active Directory est un service g√©r√© qui facilite la **configuration, l'exploitation et la mise √† l'√©chelle d'un r√©pertoire** dans le Cloud AWS. Il est construit sur un **Microsoft Active Directory** r√©el et s'int√®gre √©troitement avec d'autres services AWS, ce qui facilite la gestion de vos charges de travail et ressources AWS sensibles au r√©pertoire. Avec AWS Managed Microsoft AD, vous pouvez **utiliser vos utilisateurs, groupes et strat√©gies Active Directory existants** pour g√©rer l'acc√®s √† vos ressources AWS. Cela peut aider √† simplifier votre gestion des identit√©s et √† r√©duire le besoin de solutions d'identit√© suppl√©mentaires. AWS Managed Microsoft AD fournit √©galement des sauvegardes automatiques et des capacit√©s de r√©cup√©ration apr√®s sinistre, contribuant ainsi √† assurer la disponibilit√© et la durabilit√© de votre r√©pertoire. Dans l'ensemble, AWS Directory Service pour Microsoft Active Directory peut vous aider √† gagner du temps et des ressources en fournissant un service Active Directory g√©r√©, hautement disponible et √©volutif dans le Cloud AWS.

### Options

Directory Services permet de cr√©er 5 types de r√©pertoires :

* **AWS Managed Microsoft AD** : qui ex√©cutera un nouveau **Microsoft AD dans AWS**. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **Simple AD** : qui sera un serveur compatible Active Directory-Samba Linux. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **AD Connector** : un proxy pour **rediriger les demandes de r√©pertoire vers votre Microsoft Active Directory existant** sans mettre en cache aucune information dans le cloud. Il √©coutera dans un **VPC** et vous devrez donner **des informations d'identification pour acc√©der √† l'AD existant**.
* **Amazon Cognito User Pools** : c'est la m√™me chose que Cognito User Pools.
* **Cloud Directory** : c'est le **plus simple**. Un r√©pertoire **sans serveur** o√π vous indiquez le **sch√©ma** √† utiliser et √™tes **factur√© en fonction de l'utilisation**.

AWS Directory Services permet de **synchroniser** avec votre **Microsoft AD sur site existant**, **d'ex√©cuter votre propre r√©pertoire** dans AWS ou de **synchroniser avec d'autres types de r√©pertoires**.

### Laboratoire

Vous pouvez trouver un bon tutoriel pour cr√©er votre propre Microsoft AD dans AWS ici : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### √ânum√©ration

```bash
# Obtenir les r√©pertoires et les DC
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Obtenir les param√®tres du r√©pertoire
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```

### Connexion

Notez que si la **description** du r√©pertoire contenait un **domaine** dans le champ **`AccessUrl`**, c'est parce qu'un **utilisateur** peut probablement **se connecter** avec ses **informations d'identification AD** √† certains **services AWS** :

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### √âl√©vation de privil√®ges

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistance

### Utilisation d'un utilisateur AD

Un **utilisateur AD** peut se voir accorder **l'acc√®s √† la console de gestion AWS** via un r√¥le √† assumer. Le **nom d'utilisateur par d√©faut est Admin** et il est possible de **changer son mot de passe** depuis la console AWS.

Par cons√©quent, il est possible de **changer le mot de passe d'Admin**, de **cr√©er un nouvel utilisateur** ou de **changer le mot de passe** d'un utilisateur et d'accorder √† cet utilisateur un r√¥le pour maintenir l'acc√®s.\
Il est √©galement possible d'**ajouter un utilisateur √† un groupe dans AD** et de **donner √† ce groupe AD l'acc√®s √† un r√¥le** (pour rendre cette persistance plus discr√®te).

### Partage AD (de la victime √† l'attaquant)

Il est possible de partager un environnement AD d'une victime √† un attaquant. Ainsi, l'attaquant pourra continuer √† acc√©der √† l'environnement AD.\
Cependant, cela implique de partager le AD g√©r√© et de cr√©er une connexion VPC peering.

Vous pouvez trouver un guide ici : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Partage AD (de l'attaquant √† la victime)~~

Il ne semble pas possible d'accorder l'acc√®s AWS aux utilisateurs d'un environnement AD diff√©rent √† un compte AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs est un service de **stockage et de partage de fichiers bas√© sur le Cloud**. Il fait partie de la suite de services de cloud computing AWS et est con√ßu pour fournir une solution s√©curis√©e et √©volutive aux organisations pour stocker, partager et collaborer sur des fichiers et des documents.

AWS WorkDocs fournit une interface Web pour que les utilisateurs puissent t√©l√©charger, acc√©der et g√©rer leurs fichiers et documents. Il offre √©galement des fonctionnalit√©s telles que le contr√¥le de version, la collaboration en temps r√©el et l'int√©gration avec d'autres services AWS et des outils tiers.

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# Obtenir les utilisateurs AD (Admin non inclus)
aws workdocs describe-users --organization-id <directory-id>
# Obtenir les groupes AD (contenant "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Cr