# AWS - Directory Services / WorkDocs 枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Directory Services

AWS Directory Service for Microsoft Active Directory 是一项托管服务，可以轻松**设置、操作和扩展**在AWS云中的目录。它基于真正的**Microsoft Active Directory**构建，并与其他AWS服务紧密集成，便于管理您的目录感知工作负载和AWS资源。使用AWS托管的Microsoft AD，您可以**使用现有的** Active Directory用户、组和策略来管理对AWS资源的访问。这有助于简化身份管理，并减少对额外身份解决方案的需求。AWS托管的Microsoft AD还提供自动备份和灾难恢复能力，帮助确保您的目录的可用性和持久性。总的来说，AWS Directory Service for Microsoft Active Directory可以帮助您节省时间和资源，因为它在AWS云中提供了一个托管的、高可用性和可扩展的Active Directory服务。

### 选项

Directory Services 允许创建5种类型的目录：

* **AWS托管的Microsoft AD**：将在AWS中运行一个新的**Microsoft AD**。您将能够设置管理员密码并在VPC中访问DC。
* **Simple AD**：将是一个**Linux-Samba**兼容Active Directory的服务器。您将能够设置管理员密码并在VPC中访问DC。
* **AD Connector**：一个代理，用于**将目录请求重定向到现有的Microsoft Active Directory**，而不在云中缓存任何信息。它将在**VPC**中监听，您需要提供**访问现有AD的凭据**。
* **Amazon Cognito 用户池**：与Cognito用户池相同。
* **Cloud Directory**：这是最**简单**的一个。一个**无服务器**的目录，您可以指定要使用的**模式**，并根据使用情况**计费**。

AWS Directory Services 允许与您现有的**本地** Microsoft AD **同步**，在AWS中**运行您自己的**，或与**其他目录类型**同步。

### 实验室

在这里，您可以找到一个很好的教程，用于在AWS中创建您自己的Microsoft AD：[https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### 枚举
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### 登录

注意，如果目录的**描述**中包含了**域名**，在**`AccessUrl`**字段中，这意味着**用户**可能可以使用其**AD凭据**登录以下一些**AWS服务**：

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### 权限提升

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## 持久性

### 使用AD用户

**AD用户**可以通过假设的角色获得**AWS管理控制台的访问权限**。**默认用户名是Admin**，可以从AWS控制台**更改其密码**。

因此，可以**更改Admin的密码**，**创建新用户**或**更改用户密码**并授予该用户角色以保持访问权限。\
也可以**将用户添加到AD中的组**并**授予该AD组对角色的访问权限**（以使这种持久性更隐蔽）。

### 共享AD（从受害者到攻击者）

可以从受害者那里共享AD环境给攻击者。这样攻击者将能够继续访问AD环境。\
然而，这意味着共享托管的AD，并且还需要创建一个VPC对等连接。

您可以在这里找到指南：[https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~共享AD（从攻击者到受害者）~~

看起来不可能授予来自不同AD环境的用户对一个AWS账户的AWS访问权限。

## WorkDocs

Amazon Web Services (AWS) WorkDocs是一个基于云的**文件存储和共享服务**。它是AWS云计算服务套件的一部分，旨在为组织提供一个安全且可扩展的解决方案，用于存储、共享和协作文件和文档。

AWS WorkDocs提供了一个基于网络的界面，供用户上传、访问和管理他们的文件和文档。它还提供了版本控制、实时协作以及与其他AWS服务和第三方工具集成的功能。

### 枚举

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### 权限提升

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上[**关注**](https://twitter.com/carlospolopm) **我**。
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
