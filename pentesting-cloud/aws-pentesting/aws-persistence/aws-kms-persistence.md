# AWS - Persist√™ncia do KMS

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## KMS

Para mais informa√ß√µes, verifique:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### Conceder acesso por meio de pol√≠ticas KMS

Um invasor pode usar a permiss√£o **`kms:PutKeyPolicy`** para **conceder acesso** a uma chave a um usu√°rio sob seu controle ou at√© mesmo a uma conta externa. Verifique a p√°gina [**KMS Privesc**](../../aws-security/aws-privilege-escalation/aws-kms-privesc.md) para obter mais informa√ß√µes.

### Concess√£o eterna

As concess√µes s√£o outra maneira de dar a um principal algumas permiss√µes sobre uma chave espec√≠fica. √â poss√≠vel dar uma concess√£o que permite a um usu√°rio criar concess√µes. Al√©m disso, um usu√°rio pode ter v√°rias concess√µes (mesmo id√™nticas) sobre a mesma chave.

Portanto, √© poss√≠vel para um usu√°rio ter 10 concess√µes com todas as permiss√µes. O invasor deve monitorar isso constantemente. E se em algum momento 1 concess√£o for removida, outras 10 devem ser geradas.

(Estamos usando 10 e n√£o 2 para poder detectar que uma concess√£o foi removida enquanto o usu√°rio ainda tem alguma concess√£o)

```bash
# Para gerar concess√µes, gere 10 como esta
aws kms create-grant \
    --key-id <key-id> \
    --grantee-principal <user_arn> \
    --operations "CreateGrant" "Decrypt"

# Para monitorar concess√µes
aws kms list-grants --key-id <key-id>
```

{% hint style="info" %}
Uma concess√£o pode conceder permiss√µes apenas a partir deste et: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>