# AWS - KMS永続化

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを見たい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加する**

</details>

## KMS

詳細については、以下を参照してください：

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### KMSポリシーを介してアクセスを許可する

攻撃者は、**`kms:PutKeyPolicy`**権限を使用して、キーへのアクセスを自分が制御するユーザーまたは外部アカウントに与えることができます。詳細については、[**KMS Privescページ**](../../aws-security/aws-privilege-escalation/aws-kms-privesc.md)を参照してください。

### 永続的な許可

グラントは、特定のキーに対して主体にいくつかの権限を与える別の方法です。ユーザーにグラントを作成する権限を与えるグラントを与えることができます。さらに、ユーザーは同じキーに対して複数のグラント（同一の場合もあります）を持つことができます。

したがって、ユーザーは10のグラントを持つことができ、すべての権限を持つことができます。攻撃者はこれを常に監視する必要があります。そして、ある時点で1つのグラントが削除された場合、別の10のグラントが生成されるべきです。

（ユーザーがいくつかのグラントを持っている間にグラントが削除されたことを検出できるように、2ではなく10を使用しています）
```bash
# To generate grants, generate 10 like this one
aws kms create-grant \
--key-id <key-id> \
--grantee-principal <user_arn> \
--operations "CreateGrant" "Decrypt"

# To monitor grants
aws kms list-grants --key-id <key-id>
```
{% hint style="info" %}
許可はこのetからのみ権限を与えることができます：[https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks**であなたの**会社を宣伝**したい場合や、**最新バージョンのPEASSをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
