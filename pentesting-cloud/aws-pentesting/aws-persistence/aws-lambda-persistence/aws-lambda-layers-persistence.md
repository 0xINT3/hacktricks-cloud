# AWS - Persistance de couches Lambda

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Couches Lambda

Une couche Lambda est une archive de fichier .zip qui **peut contenir du code suppl√©mentaire** ou d'autres contenus. Une couche peut contenir des biblioth√®ques, un [runtime personnalis√©](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), des donn√©es ou des fichiers de configuration.

Il est possible d'inclure jusqu'√† **cinq couches par fonction**. Lorsque vous incluez une couche dans une fonction, les **contenus sont extraits dans le r√©pertoire `/opt`** de l'environnement d'ex√©cution.

Par **d√©faut**, les **couches** que vous cr√©ez sont **priv√©es** pour votre compte AWS. Vous pouvez choisir de **partager** une couche avec d'autres comptes ou de la **rendre publique**. Si vos fonctions consomment une couche qu'un compte diff√©rent a publi√©e, vos fonctions peuvent **continuer √† utiliser la version de la couche apr√®s sa suppression, ou apr√®s la r√©vocation de votre autorisation d'acc√®s √† la couche**. Cependant, vous ne pouvez pas cr√©er une nouvelle fonction ou mettre √† jour des fonctions en utilisant une version de couche supprim√©e.

Les fonctions d√©ploy√©es sous forme d'image de conteneur n'utilisent pas de couches. Au lieu de cela, vous emballez votre runtime pr√©f√©r√©, des biblioth√®ques et d'autres d√©pendances dans l'image de conteneur lors de la construction de l'image.

### Chemin de chargement Python

Le chemin de chargement que Python utilisera dans lambda est le suivant :

```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```

V√©rifiez comment les **deuxi√®me** et troisi√®me **positions** sont occup√©es par des r√©pertoires o√π les **couches lambda** d√©compressent leurs fichiers : **`/opt/python/lib/python3.9/site-packages`** et **`/opt/python`**

{% hint style="danger" %}
Si un attaquant parvient √† **ins√©rer une porte d√©rob√©e** dans une **couche lambda** utilis√©e ou √† **en ajouter une** qui **ex√©cutera du code arbitraire lorsqu'une biblioth√®que commune est charg√©e**, il pourra ex√©cuter du code malveillant √† chaque invocation de lambda.
{% endhint %}

Par cons√©quent, les exigences sont les suivantes :

* **V√©rifier les biblioth√®ques** qui sont **charg√©es** par le code de la victime
* Cr√©er une **biblioth√®que proxy avec des couches lambda** qui **ex√©cutera du code personnalis√©** et **chargera la biblioth√®que originale**.

### Biblioth√®ques pr√©charg√©es

{% hint style="warning" %}
Lorsque j'ai abus√© de cette technique, j'ai rencontr√© une difficult√© : certaines biblioth√®ques sont **d√©j√† charg√©es** dans le runtime Python lorsque votre code est ex√©cut√©. Je m'attendais √† trouver des choses comme `os` ou `sys`, mais **m√™me la biblioth√®que `json` √©tait charg√©e**.\
Afin d'abuser de cette technique de persistance, le code doit **charger une nouvelle biblioth√®que qui n'est pas charg√©e** lorsque le code est ex√©cut√©.
{% endhint %}

Avec un code Python comme celui-ci, il est possible d'obtenir la **liste des biblioth√®ques pr√©charg√©es** √† l'int√©rieur du runtime Python dans lambda :

```python
import sys

def lambda_handler(event, context):
    return {
        'statusCode': 200,
        'body': str(sys.modules.keys())
    }
```

Et voici la **liste** (v√©rifiez que des biblioth√®ques comme `os` ou `json` sont d√©j√† pr√©sentes)

```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weak
# Supprimer des autorisations
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
{% endcode %}

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts github.**

</details>