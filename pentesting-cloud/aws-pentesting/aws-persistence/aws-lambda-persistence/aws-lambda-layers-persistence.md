# AWS - Persist√™ncia de Camadas Lambda

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Camadas Lambda

Uma camada Lambda √© um arquivo .zip que **pode conter c√≥digo adicional** ou outro conte√∫do. Uma camada pode conter bibliotecas, um [runtime personalizado](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), dados ou arquivos de configura√ß√£o.

√â poss√≠vel incluir at√© **cinco camadas por fun√ß√£o**. Quando voc√™ inclui uma camada em uma fun√ß√£o, o **conte√∫do √© extra√≠do para o diret√≥rio `/opt`** no ambiente de execu√ß√£o.

Por **padr√£o**, as **camadas** que voc√™ cria s√£o **privadas** para sua conta AWS. Voc√™ pode optar por **compartilhar** uma camada com outras contas ou **tornar** a camada **p√∫blica**. Se suas fun√ß√µes consomem uma camada que uma conta diferente publicou, suas fun√ß√µes podem **continuar a usar a vers√£o da camada depois que ela foi exclu√≠da ou depois que sua permiss√£o de acesso √† camada foi revogada**. No entanto, voc√™ n√£o pode criar uma nova fun√ß√£o ou atualizar fun√ß√µes usando uma vers√£o de camada exclu√≠da.

As fun√ß√µes implantadas como uma imagem de cont√™iner n√£o usam camadas. Em vez disso, voc√™ empacota seu tempo de execu√ß√£o preferido, bibliotecas e outras depend√™ncias na imagem do cont√™iner quando cria a imagem.

### Caminho de carregamento do Python

O caminho de carregamento que o Python usar√° no lambda √© o seguinte:

```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```

Verifique como as **segunda** e terceira **posi√ß√µes** s√£o ocupadas por diret√≥rios onde as **camadas lambda** descompactam seus arquivos: **`/opt/python/lib/python3.9/site-packages`** e **`/opt/python`**

{% hint style="danger" %}
Se um invasor conseguir **inserir uma backdoor** em uma camada lambda usada ou **adicionar uma camada** que executar√° **c√≥digo arbitr√°rio quando uma biblioteca comum for carregada**, ele poder√° executar c√≥digo malicioso com cada invoca√ß√£o lambda.
{% endhint %}

Portanto, os requisitos s√£o:

* **Verificar as bibliotecas** que s√£o **carregadas** pelo c√≥digo da v√≠tima
* Criar uma **biblioteca proxy com camadas lambda** que ir√° **executar c√≥digo personalizado** e **carregar a biblioteca original**.

### Bibliotecas pr√©-carregadas

{% hint style="warning" %}
Ao abusar dessa t√©cnica, encontrei uma dificuldade: algumas bibliotecas j√° s√£o **carregadas** no tempo de execu√ß√£o do Python quando seu c√≥digo √© executado. Eu esperava encontrar coisas como `os` ou `sys`, mas **at√© a biblioteca `json` foi carregada**.\
Para abusar dessa t√©cnica de persist√™ncia, o c√≥digo precisa **carregar uma nova biblioteca que n√£o seja carregada** quando o c√≥digo √© executado.
{% endhint %}

Com um c√≥digo Python como este, √© poss√≠vel obter a **lista de bibliotecas que s√£o pr√©-carregadas** dentro do tempo de execu√ß√£o do Python no lambda:

```python
import sys

def lambda_handler(event, context):
    return {
        'statusCode': 200,
        'body': str(sys.modules.keys())
    }
```

E esta √© a **lista** (verifique que bibliotecas como `os` ou `json` j√° est√£o l√°)

```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weakref', 'collections.abc', '_string', 'string', 'threading', 'atexit', 'logging', 'awsl
# Remover permiss√µes
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
{% endcode %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>