# AWS - Abusing Lambda Extensions

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di Github.

</details>

## Estensioni Lambda

Le estensioni Lambda migliorano le funzioni integrandosi con vari **strumenti di monitoraggio, osservabilit√†, sicurezza e governance**. Queste estensioni, aggiunte tramite [.zip archives usando i Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) o incluse in [deployments di immagini container](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), operano in due modalit√†: **interna** ed **esterna**.

* Le **estensioni interne** si fondono con il processo di runtime, manipolando il suo avvio utilizzando **variabili d'ambiente specifiche del linguaggio** e **script wrapper**. Questa personalizzazione si applica a una serie di runtimes, tra cui **Java Correto 8 e 11, Node.js 10 e 12 e .NET Core 3.1**.
* Le **estensioni esterne** vengono eseguite come processi separati, mantenendo l'allineamento operativo con il ciclo di vita della funzione Lambda. Sono compatibili con vari runtimes come **Node.js 10 e 12, Python 3.7 e 3.8, Ruby 2.5 e 2.7, Java Corretto 8 e 11, .NET Core 3.1** e **runtime personalizzati**.

Per ulteriori informazioni su [**come funzionano le estensioni Lambda controlla la documentazione**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Estensione Esterna per Persistenza, Furto di Richieste e Modifica di Richieste

Questo √® un riassunto della tecnica proposta in questo post: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

√à stato scoperto che il kernel Linux predefinito nell'ambiente di runtime Lambda √® compilato con le chiamate di sistema "**process\_vm\_readv**" e "**process\_vm\_writev**". E tutti i processi vengono eseguiti con lo stesso ID utente, anche il nuovo processo creato per l'estensione esterna. **Ci√≤ significa che un'estensione esterna ha pieno accesso in lettura e scrittura alla memoria heap di Rapid, per design.**

Inoltre, mentre le estensioni Lambda hanno la capacit√† di **sottoscriversi agli eventi di invocazione**, AWS non rivela i dati grezzi a queste estensioni. Ci√≤ garantisce che le **estensioni non possano accedere a informazioni sensibili** trasmesse tramite la richiesta HTTP.

Il processo Init (Rapid) monitora tutte le richieste API su [http://127.0.0.1:9001](http://127.0.0.1:9001/) mentre le estensioni Lambda vengono inizializzate ed eseguite prima dell'esecuzione di qualsiasi codice di runtime, ma dopo Rapid.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

La variabile **`AWS_LAMBDA_RUNTIME_API`** indica l'**indirizzo IP** e il **numero di porta** dell'API Rapid ai **processi di runtime figlio** e alle estensioni aggiuntive.

{% hint style="warning" %}
Cambiando la variabile d'ambiente **`AWS_LAMBDA_RUNTIME_API`** in una **`porta`** a cui abbiamo accesso, √® possibile intercettare tutte le azioni all'interno del runtime Lambda (**man-in-the-middle**). Questo √® possibile perch√© l'estensione viene eseguita con gli stessi privilegi di Rapid Init e il kernel del sistema consente la **modifica della memoria del processo**, consentendo la modifica del numero di porta.
{% endhint %}

Poich√© le **estensioni vengono eseguite prima di qualsiasi codice di runtime**, modificare la variabile d'ambiente influenzer√† il processo di runtime (ad esempio, Python, Java, Node, Ruby) durante l'avvio. Inoltre, le **estensioni caricate dopo** la nostra, che dipendono da questa variabile, verranno anche instradate attraverso la nostra estensione. Questa configurazione potrebbe consentire al malware di bypassare completamente le misure di sicurezza o le estensioni di logging direttamente all'interno dell'ambiente di runtime.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Lo strumento [**lambda-spy**](https://github.com/clearvector/lambda-spy) √® stato creato per eseguire quella **scrittura in memoria** e **rubare informazioni sensibili** dalle richieste lambda, dalle altre **richieste delle estensioni** e persino **modificarle**.

## Riferimenti

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di Github.

</details>
