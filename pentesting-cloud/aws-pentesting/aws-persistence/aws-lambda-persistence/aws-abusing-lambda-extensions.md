# AWS - Misbruik van Lambda-uitbreidings

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere manieren om HackTricks te ondersteunen:

* Als je je **bedrijf wilt adverteren in HackTricks** of **HackTricks in PDF wilt downloaden**, bekijk dan de [**ABONNEMENTSPAKKETTEN**](https://github.com/sponsors/carlospolop)!
* Koop de [**officiële PEASS & HackTricks-merchandise**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), onze collectie exclusieve [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Doe mee aan de** 💬 [**Discord-groep**](https://discord.gg/hRep4RUj7f) of de [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel je hacktrucs door PR's in te dienen bij de** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Lambda-uitbreidingen

Lambda-uitbreidingen verbeteren functies door te integreren met verschillende **monitoring-, observability-, beveiligings- en governance-tools**. Deze uitbreidingen, toegevoegd via [.zip-archieven met behulp van Lambda-lagen](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) of opgenomen in [containerbeeld-implementaties](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), werken in twee modi: **interne** en **externe**.

* **Interne uitbreidingen** worden samengevoegd met het runtime-proces en manipuleren de opstart ervan met behulp van **taalspecifieke omgevingsvariabelen** en **wrapper-scripts**. Deze aanpassing is van toepassing op verschillende runtimes, waaronder **Java Correto 8 en 11, Node.js 10 en 12, en .NET Core 3.1**.

* **Externe uitbreidingen** worden uitgevoerd als afzonderlijke processen en behouden de operationele afstemming met de levenscyclus van de Lambda-functie. Ze zijn compatibel met verschillende runtimes zoals **Node.js 10 en 12, Python 3.7 en 3.8, Ruby 2.5 en 2.7, Java Corretto 8 en 11, .NET Core 3.1**, en **aangepaste runtimes**.

Voor meer informatie over [**hoe lambda-uitbreidingen werken, raadpleeg de documentatie**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Externe uitbreiding voor persistentie, diefstal van verzoeken en wijziging van verzoeken

**Dit is een samenvatting van de techniek die wordt voorgesteld in deze post:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

De onderzoekers ontdekten dat de standaard Linux-kernel in de Lambda-runtime-omgeving is gecompileerd met de systeemaanroepen "**process\_vm\_readv**" en "**process\_vm\_writev**". En alle processen worden uitgevoerd met dezelfde gebruikers-ID, zelfs het nieuwe proces dat is gemaakt voor de externe uitbreiding. **Dit betekent dat een externe uitbreiding volledige lees- en schrijftoegang heeft tot het heap-geheugen van Rapid, opzettelijk.**

Bovendien kunnen Lambda-**uitbreidingen** zich **abonneren** op **aanroepgebeurtenissen**; AWS exposeert echter de ruwe gegevens niet aan de uitbreiding. Dus de uitbreiding kan geen gevoelige informatie verzamelen die wordt verzonden in het HTTP-verzoek.

Het **Init** (Rapid) proces luistert naar alle API-verzoeken op **http://127.0.0.1:9001**. Lambda-**uitbreidingen** worden geladen en **uitgevoerd** vóór elke runtime-code, maar **na Rapid**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

De **variabele** genaamd "**AWS\_LAMBDA\_RUNTIME\_API**" **informeert** de kinder-**runtime**-processen en andere uitbreidingen over het **IP-adres en poortnummer van de Rapid API**.

{% hint style="warning" %}
**Het overschrijven** van deze omgevingsvariabele met een **poortnummer dat we beheren**, stelt ons in staat om **man-in-the-middle-activiteiten** uit te voeren binnen de Lambda-runtime.\
En omdat de kernel is gecompileerd met die systeemaanroepen en de **uitbreiding** wordt **uitgevoerd** met dezelfde gebruikers-ID als de Rapid Init, is het mogelijk om het procesgeheugen te **overschrijven** en de poort te **wijzigen**.
{% endhint %}

Aangezien **uitbreidingen worden uitgevoerd vóór elke runtime-code**, zal de **bijgewerkte omgevingsvariabele van kracht worden wanneer het runtime-proces wordt uitgevoerd** (Python, Java, Node, Ruby, enz.). Bovendien worden eventuele uitbreidingen die na de onze worden geladen en deze variabele gebruiken, ook via onze uitbreiding geproxyd. Dit kan malware in staat stellen om **beveiligingsproducten of logboekuitbreidingen volledig uit te schakelen vanuit de runtime zelf**.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

De tool [**lambda-spy**](https://github.com/clearvector/lambda-spy) is gemaakt om die **geheugen schrijven** uit te voeren en gevoelige informatie te **stelen** van lambda-verzoeken, andere **uitbreidingsverzoeken** en deze zelfs **te wijzigen**.

# Referenties
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere manieren om HackTricks te ondersteunen:

* Als je je **bedrijf wilt adverteren in HackTricks** of **HackTricks in PDF wilt downloaden**, bekijk dan de [**ABONNEMENTSPAKKETTEN**](https://github.com/sponsors/carlospolop)!
* Koop de [**officiële PEASS & HackTricks-merchandise**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), onze collectie exclusieve [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Doe mee aan de** 💬 [**Discord-groep**](https://discord.gg/hRep4RUj7f) of de [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel je hacktrucs door PR's in te dienen bij de** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
