# AWS - Lambda Uzantılarını Kötüye Kullanma

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) ile sıfırdan kahramana kadar AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı göndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>

## Lambda Uzantıları

Lambda uzantıları, çeşitli **izleme, gözlemleme, güvenlik ve yönetim araçlarıyla entegre olarak** işlevleri geliştirir. Bu uzantılar, [.zip arşivleri kullanılarak Lambda katmanları aracılığıyla eklenir](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) veya [konteyner görüntü dağıtımlarına dahil edilir](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) ve iki modda çalışır: **dahili** ve **harici**.

* **Dahili uzantılar**, **dil özgü çevresel değişkenler** ve **kaplama betikleri** kullanarak çalışma zamanı işlemini birleştirir ve başlatmasını değiştirir. Bu özelleştirme, **Java Correto 8 ve 11, Node.js 10 ve 12 ve .NET Core 3.1** gibi çeşitli çalışma zamanları için geçerlidir.
* **Harici uzantılar**, ayrı işlemler olarak çalışır ve Lambda işlevinin yaşam döngüsüyle işletme hizalamasını korur. Bunlar, **Node.js 10 ve 12, Python 3.7 ve 3.8, Ruby 2.5 ve 2.7, Java Corretto 8 ve 11, .NET Core 3.1** ve **özel çalışma zamanları** gibi çeşitli çalışma zamanlarıyla uyumludur.

[**Lambda uzantılarının nasıl çalıştığı hakkında daha fazla bilgi için belgelere bakın**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Kalıcılık, İstekleri Çalma ve İstekleri Değiştirme için Harici Uzantı

Bu, bu yazıda önerilen tekniğin özeti: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Lambda çalışma zamanı ortamındaki varsayılan Linux çekirdeğinin “**process\_vm\_readv**” ve “**process\_vm\_writev**” sistem çağrılarıyla derlendiği ve tüm işlemlerin aynı kullanıcı kimliğiyle çalıştığı bulundu. **Bu, harici uzantının tasarım gereği Rapid'in heap belleğine tam okuma ve yazma erişimine sahip olduğu anlamına gelir.**

Ayrıca, Lambda uzantılarının **çağrı olaylarına abone olma** yeteneğine sahip olduğu, AWS'nin bu uzantılara ham verileri açıklamadığı bulundu. Bu, **uzantıların HTTP isteği aracılığıyla iletilen hassas bilgilere erişememesini** sağlar.

Init (Rapid) işlemi, Lambda uzantıları başlatıldığında ve çalışma zamanı kodunun yürütülmesinden önce, [http://127.0.0.1:9001](http://127.0.0.1:9001/) adresindeki tüm API isteklerini izler.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Değişken **`AWS_LAMBDA_RUNTIME_API`**, **çocuk çalışma zamanı işlemlerine** ve ek uzantılara Rapid API'nin **IP** adresini ve **port** numarasını gösterir.

{% hint style="warning" %}
**`AWS_LAMBDA_RUNTIME_API`** çevresel değişkenini bir **`port`** numarasına değiştirerek, Lambda çalışma zamanı içindeki tüm işlemleri (**orta adam** olarak) ele geçirmek mümkündür. Bu, uzantının Rapid Init ile aynı ayrıcalıklara sahip olması ve sistem çekirdeğinin **işlem belleğini değiştirme** izin vermesi nedeniyle mümkündür.
{% endhint %}

Çünkü **uzantılar herhangi bir çalışma zamanı kodundan önce çalışır**, çevresel değişkeni değiştirmek çalışma zamanı işlemini (örneğin, Python, Java, Node, Ruby) başlatır. Ayrıca, **bizimkinden sonra yüklenen uzantılar**, bu değişkene dayanan ve bizim uzantımız üzerinden yönlendirilen uzantılar da olacaktır. Bu yapı, kötü amaçlı yazılımın güvenlik önlemlerini tamamen atlamasına veya doğrudan çalışma zamanı ortamında güvenlik önlemlerini veya günlükleme uzantılarını atlamasına olanak tanıyabilir.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

[**lambda-spy**](https://github.com/clearvector/lambda-spy) aracı, bu **bellek yazma** işlemini gerçekleştirmek ve lambda isteklerinden hassas bilgileri **çalmak**, diğer **uzantı isteklerini** ve hatta **değiştirmek** için oluşturulmuştur.

## Referanslar

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) ile sıfırdan kahramana kadar AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı göndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>
