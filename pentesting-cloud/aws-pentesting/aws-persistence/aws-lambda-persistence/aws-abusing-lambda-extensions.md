# AWS - Abusando das Extens√µes do Lambda

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Extens√µes do Lambda

As extens√µes do Lambda permitem que voc√™ aumente suas fun√ß√µes. Por exemplo, voc√™ pode usar extens√µes para integrar suas fun√ß√µes com suas ferramentas preferidas de monitoramento, observabilidade, seguran√ßa e governan√ßa. Voc√™ adiciona extens√µes a arquivos .zip de fun√ß√µes usando [camadas do Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), ou inclua-os na imagem para [fun√ß√µes implantadas como imagens de cont√™iner](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* **Extens√µes internas** s√£o executadas como **parte** do processo de **tempo de execu√ß√£o**, **em processo** com seu c√≥digo. Eles permitem que voc√™ modifique o **in√≠cio do processo de tempo de execu√ß√£o** usando vari√°veis de ambiente espec√≠ficas do idioma e scripts de wrapper. As extens√µes internas permitem casos de uso, como instrumenta√ß√£o autom√°tica de c√≥digo.
* **Extens√µes externas** permitem que voc√™ **execute processos separados** do tempo de execu√ß√£o, mas ainda dentro do **mesmo ambiente de execu√ß√£o** que a fun√ß√£o Lambda. As extens√µes externas podem **iniciar antes do processo de tempo de execu√ß√£o** e podem **continuar ap√≥s o tempo de execu√ß√£o** ser encerrado. As extens√µes externas permitem casos de uso, como buscar segredos antes da invoca√ß√£o ou enviar telemetria para um destino personalizado fora da invoca√ß√£o da fun√ß√£o. Essas extens√µes s√£o executadas como processos companheiros das fun√ß√µes Lambda.

Para obter mais informa√ß√µes sobre [**como as extens√µes do lambda funcionam, verifique a documenta√ß√£o**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Extens√£o Externa para Persist√™ncia, Roubo de Solicita√ß√µes e Modifica√ß√£o de Solicita√ß√µes

**Este ser√° um resumo da t√©cnica proposta neste post:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

Os pesquisadores descobriram que o kernel Linux padr√£o no ambiente de tempo de execu√ß√£o do Lambda √© compilado com as chamadas de sistema ‚Äú**process\_vm\_readv**‚Äù e ‚Äú**process\_vm\_writev**‚Äù. E todos os processos s√£o executados com o mesmo ID de usu√°rio, at√© mesmo o novo processo criado para a extens√£o externa. **Isso significa que uma extens√£o externa tem acesso total de leitura e grava√ß√£o √† mem√≥ria heap do Rapid, por design.**

Al√©m disso, as **extens√µes** do Lambda podem **se inscrever** em **eventos de invoca√ß√£o**; no entanto, a AWS n√£o exp√µe os dados brutos para a extens√£o. Portanto, a extens√£o n√£o poder√° coletar informa√ß√µes confidenciais enviadas na solicita√ß√£o HTTP.

O processo **Init** (Rapid) ouve todas as solicita√ß√µes de API em **http://127.0.0.1:9001**. As **extens√µes** do Lambda s√£o carregadas e **executadas** antes de qualquer c√≥digo de tempo de execu√ß√£o, mas **depois do Rapid**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

A **vari√°vel** chamada ‚Äú**AWS\_LAMBDA\_RUNTIME\_API**‚Äù **informa** os processos de tempo de execu√ß√£o filho e outras extens√µes do **IP e n√∫mero de porta da API Rapid**.

{% hint style="warning" %}
**Sobrescrever** essa vari√°vel de ambiente com um **n√∫mero de porta que controlamos** nos permitir√° **interceptar toda a atividade** dentro do tempo de execu√ß√£o do Lambda.\
E como o kernel √© compilado com essas chamadas de sistema e a **extens√£o** est√° **executando** com o **mesmo ID de usu√°rio** que o Rapid Init, √© poss√≠vel **sobrescrever** a **mem√≥ria do processo** e **alterar a porta**.
{% endhint %}

Como as **extens√µes s√£o executadas antes de qualquer c√≥digo de tempo de execu√ß√£o**, a **vari√°vel de ambiente atualizada ter√° efeito quando o processo de tempo de execu√ß√£o for executado** (Python, Java, Node, Ruby, etc). Al√©m disso, quaisquer extens√µes que s√£o carregadas ap√≥s a nossa e usam essa vari√°vel ser√£o proxy por nossa extens√£o tamb√©m. Isso pode permitir que malware **desative completamente produtos de seguran√ßa ou extens√µes de registro de dentro do pr√≥prio tempo de execu√ß√£o**.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

A ferramenta [**lambda-spy**](https://github.com/clearvector/lambda-spy) foi criada para realizar essa **escrita de mem√≥ria** e **roubar informa√ß√µes confidenciais** de solicita√ß√µes lambda, outras **solicita√ß√µes de extens√µes** e at√© mesmo **modific√°-las**.