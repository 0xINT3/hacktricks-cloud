# AWS - Lambda Uzantılarını Kötüye Kullanma

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek** paylaşın.

</details>

## Lambda Uzantıları

Lambda uzantıları, çeşitli **izleme, gözlemleme, güvenlik ve yönetim araçları** ile işlevleri geliştirir. Bu uzantılar, Lambda katmanları kullanılarak [.zip arşivleri kullanılarak](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) veya [konteyner görüntü dağıtımlarında](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/) dahil edilerek iki modda çalışır: **dahili** ve **harici**.

* **Dahili uzantılar**, dil özgü çevre değişkenleri ve sarmalama betikleri kullanarak çalışma zamanı süreciyle birleşir ve başlatmasını manipüle eder. Bu özelleştirme, **Java Correto 8 ve 11, Node.js 10 ve 12 ve .NET Core 3.1** gibi çeşitli çalışma zamanları için geçerlidir.

* **Harici uzantılar**, ayrı süreçler olarak çalışır ve Lambda işlevinin yaşam döngüsüyle uyumlu bir şekilde çalışır. Bunlar, **Node.js 10 ve 12, Python 3.7 ve 3.8, Ruby 2.5 ve 2.7, Java Corretto 8 ve 11, .NET Core 3.1** ve **özel çalışma zamanları** gibi çeşitli çalışma zamanlarıyla uyumludur.

[**Lambda uzantılarının nasıl çalıştığı hakkında daha fazla bilgi için belgelere bakın**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Kalıcılık, İstekleri Çalma ve İstekleri Değiştirme için Harici Uzantı

**Bu yazıda önerilen teknik için bir özet olacak:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

Araştırmacılar, Lambda çalışma zamanı ortamındaki varsayılan Linux çekirdeğinin "**process\_vm\_readv**" ve "**process\_vm\_writev**" sistem çağrılarıyla derlendiğini bulmuşlardır. Ve tüm süreçler, harici uzantı için oluşturulan yeni süreç dahil olmak üzere aynı kullanıcı kimliğiyle çalışır. **Bu, harici bir uzantının Rapid'in heap belleğine tam okuma ve yazma erişimi olduğu anlamına gelir.**

Ayrıca, Lambda **uzantıları**, **çağrı olaylarına abone olabilir**; ancak AWS, uzantıya ham verileri açığa çıkarmaz. Bu nedenle uzantı, HTTP isteğinde gönderilen hassas bilgileri toplayamaz.

**Init** (Rapid) işlemi, **http://127.0.0.1:9001** üzerindeki tüm API isteklerini dinler. Lambda **uzantıları**, çalışma zamanı kodundan önce yüklenir ve çalıştırılır, ancak **Rapid'ten sonra**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

“**AWS\_LAMBDA\_RUNTIME\_API**” adlı **değişken**, çocuk **çalışma zamanı** süreçlerine ve diğer uzantılara Rapid API'nin **IP ve bağlantı noktası numarasını bildirir**.

{% hint style="warning" %}
Bu çevre değişkenini, **kontrol ettiğimiz bir bağlantı noktası numarasıyla üzerine yazmak**, Lambda çalışma zamanı içindeki **tüm etkinliği man-in-the-middle yapmamıza** olanak sağlar.\
Ve çekirdek bu sistem çağrılarıyla derlendiği ve **uzantı**, Rapid Init ile **aynı kullanıcı kimliğiyle çalıştığı** için, işlem belleğini **üzerine yazmak** ve **bağlantı noktasını değiştirmek** mümkündür.
{% endhint %}

Çünkü **uzantılar, çalışma zamanı kodundan önce** çalıştırılır, **güncellenen çevre değişkeni, çalışma zamanı süreci yürütüldüğünde** (Python, Java, Node, Ruby, vb.) etkili olacaktır. Ayrıca, bizimkinden sonra yüklenen ve bu değişkeni kullanan herhangi bir uzantı da uzantımız aracılığıyla proxy olarak yönlendirilecektir. Bu, kötü amaçlı yazılımların **güvenlik ürünlerini veya günlükleme uzantılarını çalışma zamanı içinden tamamen devre dışı bırakmasına** olanak sağlayabilir.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

[**lambda-spy**](https://github.com/clearvector/lambda-spy) aracı, bu bellek yazmasını gerçekleştirmek ve lambda isteklerinden hassas bilgileri çalmak, diğer **uzantıların isteklerini** hatta **onları değiştirmek** için oluşturulmuştur.

# Referanslar
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek** paylaşın.

</details>
