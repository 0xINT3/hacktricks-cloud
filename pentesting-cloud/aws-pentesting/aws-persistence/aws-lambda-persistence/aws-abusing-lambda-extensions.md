# AWS - Zloupotreba Lambda ekstenzija

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Lambda Ekstenzije

Lambda ekstenzije poboljšavaju funkcije integrišući se sa različitim **alatima za praćenje, posmatranje, bezbednost i upravljanje**. Ove ekstenzije, dodate putem [.zip arhiva korišćenjem Lambda slojeva](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ili uključene u [implementacije kontejnerskih slika](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), funkcionišu u dva moda: **interni** i **eksterni**.

* **Interni ekstenzije** se spajaju sa procesom izvršavanja, manipulišući njegovim pokretanjem korišćenjem **specifičnih okružnih promenljivih za jezik** i **omotačkih skripti**. Ova prilagođavanja se primenjuju na različite runtime-ove, uključujući **Java Correto 8 i 11, Node.js 10 i 12, i .NET Core 3.1**.
* **Eksterni ekstenzije** se izvršavaju kao odvojeni procesi, održavajući usklađenost operacija sa životnim ciklusom Lambda funkcije. Kompatibilne su sa različitim runtime-ovima poput **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11, .NET Core 3.1**, i **prilagođenim runtime-ovima**.

Za više informacija o [**radu lambda ekstenzija proverite dokumentaciju**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Eksterna Ekstenzija za Upornost, Krađu Zahteva i Modifikaciju Zahteva

Ovo je sažetak tehnike predložene u ovom postu: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Otkriveno je da je podrazumevano Linux jezgro u Lambda okruženju za izvršavanje kompajlirano sa "process\_vm\_readv" i "process\_vm\_writev" sistemskim pozivima. I svi procesi se izvršavaju sa istim korisničkim ID-om, čak i novi proces kreiran za eksternu ekstenziju. **To znači da eksterna ekstenzija ima pun pristup čitanju i pisanju u Rapid-ovu heap memoriju, po dizajnu.**

Osim toga, iako Lambda ekstenzije imaju mogućnost da se **pretplate na događaje poziva**, AWS ne otkriva sirove podatke ovim ekstenzijama. Ovo osigurava da **ekstenzije ne mogu pristupiti osetljivim informacijama** prenetim putem HTTP zahteva.

Proces Init (Rapid) nadgleda sve API zahteve na [http://127.0.0.1:9001](http://127.0.0.1:9001/) dok se Lambda ekstenzije inicijalizuju i pokreću pre izvršavanja bilo kog runtime koda, ali posle Rapid-a.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Promenljiva **`AWS_LAMBDA_RUNTIME_API`** pokazuje **IP** adresu i **broj porta** Rapid API-ja **dete runtime procesima** i dodatnim ekstenzijama.

{% hint style="warning" %}
Menjanjem **`AWS_LAMBDA_RUNTIME_API`** okružne promenljive u **`port`** do kojeg imamo pristup, moguće je presresti sve akcije unutar Lambda runtime-a (**čovek-u-sredini**). Ovo je moguće jer ekstenzija radi sa istim privilegijama kao Rapid Init, a jezgro sistema omogućava **modifikaciju memorije procesa**, omogućavajući promenu broja porta.
{% endhint %}

Zato što **ekstenzije rade pre bilo kog runtime koda**, modifikacija okružne promenljive će uticati na proces runtime-a (npr. Python, Java, Node, Ruby) prilikom pokretanja. Nadalje, **ekstenzije učitane nakon** naše, koje se oslanjaju na ovu promenljivu, takođe će prolaziti kroz našu ekstenziju. Ova postavka bi mogla omogućiti malveru da potpuno zaobiđe sigurnosne mere ili ekstenzije za beleženje direktno unutar okruženja za izvršavanje.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Alat [**lambda-spy**](https://github.com/clearvector/lambda-spy) je kreiran da izvrši tu **modifikaciju memorije** i **ukrade osetljive informacije** iz lambda zahteva, drugih **ekstenzija zahteve** i čak ih **modifikuje**.

## Reference

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
