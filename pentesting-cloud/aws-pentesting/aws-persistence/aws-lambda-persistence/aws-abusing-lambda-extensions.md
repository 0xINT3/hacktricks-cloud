# AWS - Abusando de Lambda Extensions

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Lambda Extensions

Lambda extensions te permiten mejorar tus funciones. Por ejemplo, puedes usar extensions para integrar tus funciones con tus herramientas preferidas de monitoreo, observabilidad, seguridad y gobernanza. A√±ades extensions a funciones en archivos .zip usando [Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), o incluy√©ndolas en la imagen para [funciones desplegadas como im√°genes de contenedor](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* **Internal extensions** se ejecutan como **parte** del proceso de **runtime**, **en proceso** con tu c√≥digo. Permiten modificar el **inicio del proceso de runtime** usando variables de entorno espec√≠ficas del lenguaje y scripts de envoltura. Las internal extensions habilitan casos de uso como la instrumentaci√≥n autom√°tica del c√≥digo.
* **External extensions** te permiten **ejecutar procesos separados** del runtime pero a√∫n dentro del **mismo entorno de ejecuci√≥n** que la funci√≥n Lambda. Las external extensions pueden **iniciar antes del proceso de runtime**, y pueden **continuar despu√©s de que el runtime** se cierre. Estas extensions se ejecutan como procesos compa√±eros de las funciones Lambda.

Para m√°s informaci√≥n sobre [**c√≥mo funcionan las lambda extensions revisa la documentaci√≥n**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### External Extension para Persistencia, Robo de Solicitudes y Modificaci√≥n de Solicitudes

**Esto va a ser un resumen de la t√©cnica propuesta en este post:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

Los investigadores encontraron que el kernel de Linux por defecto en el entorno de ejecuci√≥n de Lambda est√° compilado con llamadas al sistema ‚Äú**process\_vm\_readv**‚Äù y ‚Äú**process\_vm\_writev**‚Äù. Y todos los procesos se ejecutan con el mismo ID de usuario, incluso el nuevo proceso creado para la external extension. **Esto significa que una external extension tiene acceso completo de lectura y escritura a la memoria heap de Rapid, por dise√±o.**

Adem√°s, las **extensions** de Lambda pueden **suscribirse** a **eventos de invocaci√≥n**; sin embargo, AWS no expone los datos crudos a la extension. As√≠ que la extension no ser√° capaz de recopilar informaci√≥n sensible enviada en la solicitud HTTP.

El proceso **Init** (Rapid) escucha todas las solicitudes de API en **http://127.0.0.1:9001**. Las **extensions** de Lambda se cargan y **ejecutan** antes de cualquier c√≥digo de runtime, pero **despu√©s de Rapid**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

La **variable** llamada ‚Äú**AWS\_LAMBDA\_RUNTIME\_API**‚Äù **informa** a los procesos de **runtime** hijos y otras extensions sobre la **IP y el n√∫mero de puerto de la API de Rapid**.

{% hint style="warning" %}
**Sobrescribir** esta variable de entorno con un **n√∫mero de puerto que controlemos** nos permitir√° **interceptar toda la actividad** dentro del runtime de Lambda.\
Y debido a que el kernel est√° compilado con esas llamadas al sistema y la **extension** est√° **ejecut√°ndose** con el **mismo ID de usuario** que el Rapid Init, es posible **sobrescribir** la **memoria del proceso** y **cambiar el puerto**.
{% endhint %}

Dado que las **extensions se ejecutan antes de cualquier c√≥digo de runtime**, la **variable de entorno actualizada tendr√° efecto cuando se ejecute el proceso de runtime** (Python, Java, Node, Ruby, etc). Adem√°s, cualquier extension que se cargue despu√©s de la nuestra, y use esta variable, tambi√©n ser√° proxy a trav√©s de nuestra extension. Esto podr√≠a permitir que el malware **desactive completamente productos de seguridad o extensions de registro desde dentro del runtime en s√≠**.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

La herramienta [**lambda-spy**](https://github.com/clearvector/lambda-spy) fue creada para realizar esa **escritura en memoria** y **robar informaci√≥n sensible** de las solicitudes de lambda, otras **solicitudes de extensions** e incluso **modificarlas**.

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
