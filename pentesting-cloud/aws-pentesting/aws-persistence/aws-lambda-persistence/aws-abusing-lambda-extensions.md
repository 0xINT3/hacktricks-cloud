# AWS - Abusando de Lambda Extensions

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Lambda Extensions

Lambda extensions permitem que voc√™ aprimore suas fun√ß√µes. Por exemplo, voc√™ pode usar extensions para integrar suas fun√ß√µes com suas ferramentas preferidas de monitoramento, observabilidade, seguran√ßa e governan√ßa. Voc√™ adiciona extensions a fun√ß√µes em arquivos .zip usando [Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), ou as inclui na imagem para [fun√ß√µes implantadas como imagens de cont√™iner](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* **Internal extensions** executam como **parte** do processo de **runtime**, **in-process** com seu c√≥digo. Elas permitem que voc√™ modifique o **in√≠cio do processo de runtime** usando vari√°veis de ambiente espec√≠ficas da linguagem e scripts de wrapper. Internal extensions possibilitam casos de uso como instrumenta√ß√£o autom√°tica de c√≥digo.
* **External extensions** permitem que voc√™ **execute processos separados** do runtime, mas ainda dentro do **mesmo ambiente de execu√ß√£o** que a fun√ß√£o Lambda. External extensions podem **iniciar antes do processo de runtime** e podem **continuar ap√≥s o encerramento do runtime**. External extensions possibilitam casos de uso como buscar segredos antes da invoca√ß√£o ou enviar telemetria para um destino personalizado fora da invoca√ß√£o da fun√ß√£o. Essas extensions executam como processos companheiros das fun√ß√µes Lambda.

Para mais informa√ß√µes sobre [**como as lambda extensions funcionam, consulte a documenta√ß√£o**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### External Extension para Persist√™ncia, Roubo de Requisi√ß√µes & Modifica√ß√£o de Requisi√ß√µes

**Este vai ser um resumo da t√©cnica proposta neste post:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

Os pesquisadores descobriram que o kernel Linux padr√£o no ambiente de runtime do Lambda √© compilado com chamadas de sistema ‚Äú**process_vm_readv**‚Äù e ‚Äú**process_vm_writev**‚Äù. E todos os processos s√£o executados com o mesmo ID de usu√°rio, inclusive o novo processo criado para a external extension. **Isso significa que uma external extension tem acesso total de leitura e escrita √† mem√≥ria heap do Rapid, por design.**

Al√©m disso, Lambda **extensions** podem **se inscrever** em **eventos de invoca√ß√£o**; no entanto, a AWS n√£o exp√µe os dados brutos para a extension. Ent√£o, a extension n√£o ser√° capaz de coletar informa√ß√µes sens√≠veis enviadas na requisi√ß√£o HTTP.

O processo **Init** (Rapid) escuta todas as requisi√ß√µes da API em **http://127.0.0.1:9001**. Lambda **extensions** s√£o carregadas e **executadas** antes de qualquer c√≥digo de runtime, mas **ap√≥s o Rapid**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

A **vari√°vel** chamada ‚Äú**AWS_LAMBDA_RUNTIME_API**‚Äù **informa** os processos de runtime filhos e outras extensions sobre o **IP e n√∫mero da porta da API Rapid**.

{% hint style="warning" %}
**Sobrescrever** esta vari√°vel de ambiente com um **n√∫mero de porta que controlamos** nos permitir√° **interceptar toda a atividade** dentro do runtime do Lambda.\
E como o kernel √© compilado com essas chamadas de sistema e a **extension** est√° **executando** com o **mesmo ID de usu√°rio** que o Rapid Init, √© poss√≠vel **sobrescrever** a mem√≥ria do processo e **alterar a porta**.
{% endhint %}

Como **extensions executam antes de qualquer c√≥digo de runtime**, a **vari√°vel de ambiente atualizada ter√° efeito quando o processo de runtime for executado** (Python, Java, Node, Ruby, etc). Al√©m disso, quaisquer extensions que sejam carregadas ap√≥s a nossa, e que utilizem essa vari√°vel, tamb√©m ser√£o roteadas atrav√©s da nossa extension. Isso poderia permitir que malware **desabilite completamente produtos de seguran√ßa ou extensions de log dentro do pr√≥prio runtime**.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

A ferramenta [**lambda-spy**](https://github.com/clearvector/lambda-spy) foi criada para realizar essa **escrita na mem√≥ria** e **roubar informa√ß√µes sens√≠veis** de requisi√ß√µes lambda, outras **requisi√ß√µes de extensions** e at√© **modific√°-las**.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
