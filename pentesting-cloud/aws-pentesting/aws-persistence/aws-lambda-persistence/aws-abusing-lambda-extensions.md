# AWS - Lambda Extensions 남용

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 **PR을 제출**하여 해킹 기법을 공유하세요.

</details>

## Lambda Extensions

Lambda Extensions는 다양한 **모니터링, 관찰, 보안 및 거버넌스 도구**와 통합하여 함수를 향상시킵니다. 이러한 확장은 Lambda 레이어를 사용하여 [.zip 아카이브로 추가](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)하거나 [컨테이너 이미지 배포](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)에 포함되어 **내부** 및 **외부** 두 가지 모드로 작동합니다.

* **내부 확장**은 **언어별 환경 변수**와 **래퍼 스크립트**를 사용하여 런타임 프로세스와 병합하여 시작을 조작합니다. 이러한 사용자 정의는 **Java Correto 8 및 11, Node.js 10 및 12, .NET Core 3.1**을 포함한 다양한 런타임에 적용됩니다.

* **외부 확장**은 별도의 프로세스로 실행되며 Lambda 함수의 라이프사이클과 일치하도록 작동합니다. 이러한 확장은 **Node.js 10 및 12, Python 3.7 및 3.8, Ruby 2.5 및 2.7, Java Corretto 8 및 11, .NET Core 3.1** 및 **사용자 정의 런타임**과 호환됩니다.

[**람다 확장이 작동하는 방법에 대한 자세한 정보는 문서를 확인하세요**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### 지속성, 요청 도용 및 요청 수정을 위한 외부 확장

**이 게시물에서 제안된 기술에 대한 요약입니다:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

연구원들은 Lambda 런타임 환경의 기본 Linux 커널이 "**process\_vm\_readv**" 및 "**process\_vm\_writev**" 시스템 호출로 컴파일된다는 것을 발견했습니다. 그리고 모든 프로세스는 동일한 사용자 ID로 실행되며, 외부 확장을 위해 생성된 새 프로세스도 동일한 사용자 ID로 실행됩니다. **이는 외부 확장이 Rapid의 힙 메모리에 대한 완전한 읽기 및 쓰기 액세스 권한을 가지고 있다는 것을 의미합니다.**

또한 Lambda **확장**은 **호출 이벤트**에 **구독**할 수 있지만, AWS는 확장에 원시 데이터를 노출하지 않습니다. 따라서 확장은 HTTP 요청에 전송된 민감한 정보를 수집할 수 없습니다.

**Init** (Rapid) 프로세스는 **http://127.0.0.1:9001**에서 모든 API 요청을 수신합니다. Lambda **확장**은 Rapid 이후에 로드되고 **실행**되지만 런타임 코드 이전에 실행됩니다.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

"**AWS\_LAMBDA\_RUNTIME\_API**"라는 **변수**는 Rapid API의 **IP 및 포트 번호를** 자식 **런타임** 프로세스와 다른 확장에 **알려줍니다**.

{% hint style="warning" %}
이 환경 변수를 **제어 가능한 포트 번호로 덮어쓰면** Lambda 런타임 내에서의 **모든 활동을 중간에 가로챌 수 있습니다**.\
그리고 커널이 해당 시스템 호출로 컴파일되고 **확장**이 Rapid Init과 **동일한 사용자 ID**로 **실행**되기 때문에 프로세스 **메모리를 덮어쓰고 포트를 변경**할 수 있습니다.
{% endhint %}

**확장은 런타임 코드 이전에 실행**되므로 **업데이트된 환경 변수는 런타임 프로세스가 실행될 때 적용**됩니다 (Python, Java, Node, Ruby 등). 또한 우리의 확장보다 나중에 로드되고 이 변수를 사용하는 모든 확장은 우리의 확장을 통해 프록시될 수 있습니다. 이는 악성 소프트웨어가 런타임 자체에서 보안 제품이나 로깅 확장을 **완전히 비활성화**할 수 있게 할 수 있습니다.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

[**lambda-spy**](https://github.com/clearvector/lambda-spy) 도구는 람다 요청, 다른 **확장 요청** 및 심지어 **수정**에서 **메모리 쓰기** 및 **민감한 정보 도용**을 수행하기 위해 만들어졌습니다.

# 참고 자료
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 **PR을 제출**하여 해킹 기법을 공유하세요.

</details>
