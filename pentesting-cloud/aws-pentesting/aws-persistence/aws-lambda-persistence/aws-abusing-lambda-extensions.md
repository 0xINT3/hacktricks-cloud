# AWS - 滥用 Lambda 扩展

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## Lambda 扩展

Lambda 扩展使您能够增强您的函数。例如，您可以使用扩展将函数与您喜欢的监控、可观察性、安全和治理工具集成。您可以使用 [Lambda 层](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)将扩展添加到 .zip 归档函数中，或将它们包含在[作为容器映像部署的函数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)的映像中。

* **内部扩展** 作为**运行时**进程的**一部分**，与您的代码**同进程**运行。它们允许您使用特定于语言的环境变量和包装脚本修改**运行时进程的启动**。内部扩展支持的用例包括自动化代码检测。
* **外部扩展** 允许您**运行与运行时分开的进程**，但仍在与 Lambda 函数**相同的执行环境**中。外部扩展可以**在运行时进程之前启动**，并且可以**在运行时关闭后继续运行**。外部扩展支持的用例包括在调用前获取秘密，或在函数调用外将遥测数据发送到自定义目的地。这些扩展作为 Lambda 函数的伴随进程运行。

有关[**lambda 扩展工作原理的更多信息，请查看文档**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### 外部扩展用于持久性、窃取请求和修改请求

**这将是本文提出的技术的总结：** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

研究人员发现 Lambda 运行时环境中的默认 Linux 内核编译时包含了“**process_vm_readv**”和“**process_vm_writev**”系统调用。而且所有进程都以相同的用户 ID 运行，即使是为外部扩展创建的新进程。**这意味着外部扩展按设计可以完全读写 Rapid 的堆内存。**

此外，Lambda **扩展**可以**订阅** **调用事件**；然而，AWS 并没有向扩展暴露原始数据。因此，扩展将无法收集在 HTTP 请求中发送的敏感信息。

**Init**（Rapid）进程在 **http://127.0.0.1:9001** 上监听所有 API 请求。Lambda **扩展**在任何运行时代码之前**加载**和**执行**，但在 **Rapid 之后**。

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

名为“**AWS_LAMBDA_RUNTIME_API**”的**变量** **通知**子**运行时**进程和其他扩展**Rapid API 的 IP 和端口号**。

{% hint style="warning" %}
**覆盖**这个环境变量为我们**控制的端口号**，将允许我们**中间人攻击 Lambda 运行时内的所有活动**。\
由于内核编译时包含了这些系统调用，而且**扩展**与 Rapid Init **运行**在**相同的用户 ID** 下，因此可以**覆盖**进程**内存**并**更改端口**。
{% endhint %}

由于**扩展在任何运行时代码之前执行**，**更新的环境变量将在执行运行时进程时生效**（Python、Java、Node、Ruby 等）。此外，任何在我们之后加载的扩展，如果使用这个变量，也会通过我们的扩展进行代理。这可能允许恶意软件**完全禁用运行时本身内的安全产品或日志扩展**。

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

工具 [**lambda-spy**](https://github.com/clearvector/lambda-spy) 被创建用于执行**内存写入**并**窃取 lambda 请求中的敏感信息**，其他**扩展的请求**甚至**修改它们**。

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
