# AWS - 滥用Lambda扩展

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## Lambda扩展

Lambda扩展允许您增强函数的功能。例如，您可以使用扩展将函数与首选的监控、可观察性、安全性和治理工具集成。您可以使用[Lambda层](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)将扩展添加到.zip归档函数中，或者将它们包含在[以容器镜像形式部署的函数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)中。

* **内部扩展**作为**运行时**进程的一部分**在进程内**与您的代码一起运行。它们允许您使用特定于语言的环境变量和包装脚本修改运行时进程的启动。内部扩展支持自动对代码进行仪表化等用例。
* **外部扩展**允许您在Lambda函数的**相同执行环境**中**运行独立的进程**。外部扩展可以在运行时进程之前启动，并且可以在运行时关闭后继续运行。外部扩展支持在调用之前获取密钥或将遥测发送到函数调用之外的自定义目标等用例。这些扩展作为Lambda函数的伴随进程运行。

有关[**Lambda扩展工作原理的更多信息，请查看文档**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### 用于持久化、窃取请求和修改请求的外部扩展

**这将是对本文中提出的技术的摘要：**[**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

研究人员发现Lambda运行时环境中的默认Linux内核编译了“**process\_vm\_readv**”和“**process\_vm\_writev**”系统调用。而且所有进程都以相同的用户ID运行，即使是为外部扩展创建的新进程。**这意味着外部扩展通过设计可以完全读取和写入Rapid的堆内存。**

此外，Lambda **扩展**可以**订阅**调用事件；但是，AWS不会将原始数据暴露给扩展。因此，扩展将无法收集在HTTP请求中发送的敏感信息。

**Init**（Rapid）进程在**http://127.0.0.1:9001**上监听所有API请求。Lambda **扩展**在任何运行时代码之前加载和执行，但在Rapid之后。

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

名为“**AWS\_LAMBDA\_RUNTIME\_API**”的**变量**通知子**运行时**进程和其他扩展Rapid API的**IP和端口号**。

{% hint style="warning" %}
使用我们控制的**端口号覆盖**此环境变量将允许我们**中间人攻击Lambda运行时内的所有活动**。\
由于内核编译了这些系统调用，并且**扩展**与Rapid Init具有**相同的用户ID**，因此可以**覆盖**进程**内存**并**更改端口**。
{% endhint %}

由于**扩展在任何运行时代码之前执行**，当运行时进程执行时，**更新的环境变量将生效**（Python、Java、Node、Ruby等）。此外，任何在我们之后加载并使用此变量的扩展也将通过我们的扩展进行代理。这可能允许恶意软件**完全禁用运行时内的安全产品或日志扩展**。

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

工具[**lambda-spy**](https://github.com/clearvector/lambda-spy)被创建用于执行该**内存写入**并从lambda请求、其他**扩展请求**中窃取敏感信息，甚至**修改它们**。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
