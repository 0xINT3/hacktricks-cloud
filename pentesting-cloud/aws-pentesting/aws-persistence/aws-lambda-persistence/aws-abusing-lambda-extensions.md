# AWS - Κατάχρηση των Επεκτάσεων Lambda

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Επεκτάσεις Lambda

Οι επεκτάσεις Lambda βελτιώνουν τις λειτουργίες ενσωματώνοντας διάφορα **εργαλεία παρακολούθησης, παρατήρησης, ασφάλειας και διακυβέρνησης**. Αυτές οι επεκτάσεις, προστίθενται μέσω [.zip αρχείων χρησιμοποιώντας τα επίπεδα Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ή συμπεριλαμβάνονται σε [αναπτύξεις εικόνων εμπορευματοκιβωτίων](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), λειτουργούν σε δύο καταστάσεις: **εσωτερικές** και **εξωτερικές**.

* **Εσωτερικές επεκτάσεις** συγχωνεύονται με τη διαδικασία εκτέλεσης, χειριζόμενες την εκκίνησή της χρησιμοποιώντας **μεταβλητές περιβάλλοντος συγκεκριμένες για τη γλώσσα** και **σενάρια περιτύλιξης**. Αυτή η προσαρμογή ισχύει για μια σειρά από χρόνους εκτέλεσης, συμπεριλαμβανομένων των **Java Correto 8 και 11, Node.js 10 και 12, και .NET Core 3.1**.
* **Εξωτερικές επεκτάσεις** λειτουργούν ως ξεχωριστές διαδικασίες, διατηρώντας τη λειτουργική ευθυγράμμιση με τον κύκλο ζωής της λειτουργίας Lambda. Είναι συμβατές με διάφορους χρόνους εκτέλεσης όπως **Node.js 10 και 12, Python 3.7 και 3.8, Ruby 2.5 και 2.7, Java Corretto 8 και 11, .NET Core 3.1**, και **προσαρμοσμένους χρόνους εκτέλεσης**.

Για περισσότερες πληροφορίες σχετικά με [**το πώς λειτουργούν οι επεκτάσεις lambda ελέγξτε τα έγγραφα**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Εξωτερική Επέκταση για Διατήρηση, Κλοπή Αιτημάτων & τροποποίηση Αιτημάτων

Αυτό είναι ένα σύνοψη της τεχνικής που προτείνεται σε αυτήν την ανάρτηση: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Βρέθηκε ότι το προεπιλεγμένο πυρήνα Linux στο περιβάλλον εκτέλεσης του Lambda είναι συνταγμένο με τις κλήσεις συστήματος "**process\_vm\_readv**" και "**process\_vm\_writev**". Και όλες οι διαδικασίες λειτουργούν με τον ίδιο αναγνωριστικό χρήστη, ακόμη και η νέα διαδικασία που δημιουργείται για την εξωτερική επέκταση. **Αυτό σημαίνει ότι μια εξωτερική επέκταση έχει πλήρη πρόσβαση ανάγνωσης και εγγραφής στη μνήμη σωρού του Rapid, από σχεδιασμό.**

Επιπλέον, ενώ οι επεκτάσεις Lambda έχουν τη δυνατότητα να **εγγραφούν σε συμβάντα κλήσης**, η AWS δεν αποκαλύπτει τα ακατέργαστα δεδομένα σε αυτές τις επεκτάσεις. Αυτό εξασφαλίζει ότι **οι επεκτάσεις δεν μπορούν να έχουν πρόσβαση σε ευαίσθητες πληροφορίες** που μεταδίδονται μέσω του αιτήματος HTTP.

Η διαδικασία Init (Rapid) παρακολουθεί όλα τα αιτήματα API στο [http://127.0.0.1:9001](http://127.0.0.1:9001/) ενώ οι επεκτάσεις Lambda αρχικοποιούνται και εκτελούνται πριν από την εκτέλεση οποιουδήποτε κώδικα χρόνου εκτέλεσης, αλλά μετά το Rapid.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

Η μεταβλητή **`AWS_LAMBDA_RUNTIME_API`** υποδεικνύει τη διεύθυνση **IP** και τον αριθμό **θύρας** του Rapid API στις **παιδικές διαδικασίες χρόνου εκτέλεσης** και σε επιπλέον επεκτάσεις.

{% hint style="warning" %}
Αλλάζοντας τη μεταβλητή περιβάλλοντος **`AWS_LAMBDA_RUNTIME_API`** σε μια **`θύρα`** στην οποία έχουμε πρόσβαση, είναι δυνατό να παρεμβάλλουμε όλες τις ενέργειες εντός του χρόνου εκτέλεσης Lambda (**άνθρωπος στη μέση**). Αυτό είναι δυνατό επειδή η επέκταση λειτουργεί με τα ίδια προνόμια με το Rapid Init, και το πυρήνα του συστήματος επιτρέπει τη **τροποποίηση της μνήμης της διαδικασίας**, επιτρέποντας την αλλαγή του αριθμού θύρας.
{% endhint %}

Επειδή οι **επεκτάσεις λειτουργούν πριν από κάθε κώδικα χρόνου εκτέλεσης**, η τροποποίηση της μεταβλητής περιβάλλοντος θα επηρεάσει τη διαδικασία χρόνου εκτέλεσης (π.χ., Python, Java, Node, Ruby) καθώς ξεκινά. Επιπλέον, **οι επεκτάσεις που φορτώνονται μετά** από τη δική μας, οι οποίες εξαρτώνται από αυτήν τη μεταβλητή, θα δρομολογηθούν επίσης μέσω της επέκτασής μας. Αυτή η ρύθμιση θα μπορούσε να επιτρέψει σε κακόβουλο λογισμικό να παρακάμψει εντελώς τα μέτρα ασφαλείας ή τις επεκτάσεις καταγραφής απευθείας μέσα στο περιβάλλον εκτέλεσης.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

Το εργαλείο [**lambda-spy**](https://github.com/clearvector/lambda-spy) δημιουργήθηκε για να πραγματοποιήσει αυτήν τη **εγγραφή μνήμης** και να **κλέψει ευαίσθητες πληροφορίες** από τα αιτήματα lambda, άλλες **επεκτάσεις αιτημάτων** και ακόμη να **τα τροποποιήσει**.

## Αναφορές

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχ
