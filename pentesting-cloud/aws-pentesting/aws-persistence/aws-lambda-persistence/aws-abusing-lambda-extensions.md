# AWS - Lambda Extensionsの悪用

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Lambda Extensions

Lambda Extensionsを使用すると、関数を拡張できます。例えば、Extensionsを使用して、関数をお好みの監視、可観測性、セキュリティ、ガバナンスツールと統合できます。Extensionsは、[Lambda layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)を使用して.zipアーカイブ関数に追加するか、[コンテナイメージとしてデプロイされた関数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)のイメージに含めることができます。

* **Internal extensions**は、コードと**プロセス内**で**ランタイム**プロセスの**一部**として実行されます。これにより、言語固有の環境変数やラッパースクリプトを使用して**ランタイムプロセスの起動**を変更できます。Internal extensionsは、コードの自動計測などのユースケースを可能にします。
* **External extensions**は、ランタイムとは別のプロセスを実行することを可能にしますが、Lambda関数と同じ**実行環境**内にあります。External extensionsは、ランタイムプロセスの**開始前**に開始し、ランタイムがシャットダウンした**後も続行**することができます。External extensionsは、呼び出し前にシークレットを取得したり、関数の呼び出し外部のカスタム先にテレメトリを送信するなどのユースケースを可能にします。これらのextensionsは、Lambda関数のコンパニオンプロセスとして実行されます。

Lambda extensionsの動作についての詳細は[**ドキュメントをチェックしてください**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### 永続性、リクエストの盗み、リクエストの変更のためのExternal Extension

**これは、この投稿で提案された技術の要約です:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

研究者たちは、Lambdaランタイム環境のデフォルトLinuxカーネルが“**process_vm_readv**”と“**process_vm_writev**”のシステムコールでコンパイルされていることを発見しました。そして、すべてのプロセスは同じユーザーIDで実行されます。これは、External extensionが設計によりRapidのヒープメモリへの完全な読み書きアクセスを持っていることを意味します。

さらに、Lambda **extensions**は**呼び出しイベント**に**登録**することができますが、AWSは生データをextensionに公開しません。したがって、extensionはHTTPリクエストで送信された機密情報を収集することはできません。

**Init** (Rapid)プロセスは、**http://127.0.0.1:9001**ですべてのAPIリクエストをリッスンします。Lambda **extensions**は、ランタイムコードの前に**ロードされ実行されます**が、**Rapidの後**になります。

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

環境変数“**AWS_LAMBDA_RUNTIME_API**”は、Rapid APIの**IPとポート番号**を子**ランタイム**プロセスと他のextensionsに**通知**します。

{% hint style="warning" %}
この環境変数を**上書き**して、**私たちがコントロールするポート番号**にすることで、Lambdaランタイム内のすべてのアクティビティを**中間者攻撃**することができます。\
そして、カーネルがそれらのシステムコールでコンパイルされており、**extension**がRapid Initと同じユーザーIDで**実行**されているため、プロセス**メモリを上書き**して**ポートを変更**することが可能です。
{% endhint %}

**Extensionsはランタイムコードの前に実行される**ため、**更新された環境変数はランタイムプロセスが実行されるときに有効になります**（Python、Java、Node、Rubyなど）。さらに、私たちの後にロードされる他のextensionsも、この変数を使用する場合、私たちのextensionを通じてプロキシされます。これにより、マルウェアはランタイム自体からセキュリティ製品やログ記録extensionsを**完全に無効にする**ことができるかもしれません。

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

ツール[**lambda-spy**](https://github.com/clearvector/lambda-spy)は、その**メモリ書き込み**を実行し、lambdaリクエストから機密情報を**盗み**、他の**extensions**の**リクエスト**を**盗み**、さらに**変更する**ために作成されました。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>
