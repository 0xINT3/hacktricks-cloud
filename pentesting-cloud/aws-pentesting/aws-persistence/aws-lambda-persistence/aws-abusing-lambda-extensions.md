# AWS - Lambda Extensionsの悪用

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- **Discordグループ**に**参加**💬（https://discord.gg/hRep4RUj7f）または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦で**フォロー**する：[**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- **HackTricks**（https://github.com/carlospolop/hacktricks）と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに**PRを提出**して、あなたのハッキングテクニックを共有してください。

</details>

## Lambda Extensions

Lambda拡張機能は、さまざまな**モニタリング、可観測性、セキュリティ、およびガバナンスツール**と統合することで、関数を強化します。これらの拡張機能は、Lambdaレイヤーを使用して[.zipアーカイブを追加](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)するか、[コンテナイメージデプロイメントに含める](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)ことで追加され、**内部**および**外部**の2つのモードで動作します。

- **内部拡張機能**は、**言語固有の環境変数**と**ラッパースクリプト**を使用して、ランタイムプロセスに統合され、起動を操作します。このカスタマイズは、**Java Correto 8および11、Node.js 10および12、.NET Core 3.1**などのランタイムに適用されます。
- **外部拡張機能**は、別々のプロセスとして実行され、Lambda関数のライフサイクルに沿って操作を維持します。これらは、**Node.js 10および12、Python 3.7および3.8、Ruby 2.5および2.7、Java Corretto 8および11、.NET Core 3.1**、および**カスタムランタイム**と互換性があります。

[**lambda拡張機能の動作についての詳細はドキュメントを参照してください**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### 永続性、リクエストの盗み出し、リクエストの変更のための外部拡張機能

これは、この投稿で提案されている技術の要約です：[https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Lambdaランタイム環境のデフォルトLinuxカーネルは、「**process\_vm\_readv**」および「**process\_vm\_writev**」システムコールでコンパイルされていることがわかりました。そして、新しいプロセスも含め、すべてのプロセスは同じユーザーIDで実行されます。**つまり、外部拡張機能は設計上、Rapidのヒープメモリに完全な読み取りおよび書き込みアクセス権を持っています。**

さらに、Lambda拡張機能は**呼び出しイベントにサブスクライブ**する機能を持っていますが、AWSはこれらの拡張機能に生データを公開しません。これにより、HTTPリクエスト経由で送信される**機密情報にアクセスできない**ようになっています。

Init（Rapid）プロセスは、Lambda拡張機能が初期化され、実行されるのは、任意のランタイムコードの実行の前であり、Rapidの後であるときに、[http://127.0.0.1:9001](http://127.0.0.1:9001/)ですべてのAPIリクエストを監視します。

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

変数**`AWS_LAMBDA_RUNTIME_API`**は、**子ランタイムプロセス**および追加の拡張機能にRapid APIの**IP**アドレスと**ポート**番号を示します。

{% hint style="warning" %}
**`AWS_LAMBDA_RUNTIME_API`**環境変数を**アクセス可能な`port`**に変更することで、Lambdaランタイム内のすべてのアクションを傍受することが可能です（**中間者攻撃**）。これは、拡張機能がRapid Initと同じ特権で実行され、システムのカーネルが**プロセスメモリの変更**を許可しているため可能です。
{% endhint %}

**拡張機能はランタイムコードの前に実行される**ため、環境変数を変更すると、ランタイムプロセス（例：Python、Java、Node、Ruby）に影響を与えます。さらに、**私たちの後にロードされる拡張機能**も、この変数に依存するため、私たちの拡張機能を経由してルーティングされます。この設定により、マルウェアがセキュリティ対策やログ拡張機能を完全にバイパスしたり、ランタイム環境内で直接ログ拡張機能を迂回することが可能になります。

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

[**lambda-spy**](https://github.com/clearvector/lambda-spy)ツールは、その**メモリ書き込み**を実行し、Lambdaリクエストから**機密情報を盗み出し**、他の**拡張機能のリクエスト**さえも**変更**するために作成されました。

## 参考文献

- [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
- [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- **Discordグループ**に**参加**💬（https://discord.gg/hRep4RUj7f）または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦で**フォロー**する：[**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- **HackTricks**（https://github.com/carlospolop/hacktricks）と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに**PRを提出**して、あなたのハッキングテクニックを共有してください。

</details>
