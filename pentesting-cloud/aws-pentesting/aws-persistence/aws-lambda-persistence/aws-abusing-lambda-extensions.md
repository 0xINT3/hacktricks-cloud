# AWS - Lambda Extensionsの悪用

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* HackTricksの**広告掲載**をご希望の場合や、**最新版のPEASSの利用**、またはHackTricksのPDFダウンロードをご希望の場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)をご覧ください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* 自分のハッキングテクニックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## Lambda Extensions

Lambda Extensionsを使用すると、関数を拡張することができます。たとえば、拡張機能を使用して関数をモニタリング、観測、セキュリティ、ガバナンスツールに統合することができます。Lambdaレイヤーを使用して拡張機能を.zipアーカイブ関数に追加したり、[コンテナイメージとしてデプロイされた関数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)に含めたりすることができます。

* **内部拡張機能**は、ランタイムプロセスの一部として、コードと**インプロセス**で実行されます。言語固有の環境変数とラッパースクリプトを使用して、ランタイムプロセスの起動を変更することができます。内部拡張機能を使用すると、コードの自動インストルメンテーションなどのユースケースが可能になります。
* **外部拡張機能**を使用すると、Lambda関数と同じ実行環境内で、ランタイムから**別のプロセスを実行**することができます。外部拡張機能は、ランタイムプロセスよりも前に開始することができ、ランタイムがシャットダウンした後も継続することができます。外部拡張機能を使用すると、呼び出し前にシークレットを取得したり、関数呼び出しの外部のカスタム宛先にテレメトリを送信したりするなどのユースケースが可能になります。これらの拡張機能は、Lambda関数の補助プロセスとして実行されます。

[**lambda extensionsの動作方法についての詳細は、ドキュメントを参照してください**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### パーシステンス、リクエストの盗用、リクエストの変更のための外部拡張機能

**この記事で提案されているテクニックの要約です:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

研究者たちは、Lambdaランタイム環境のデフォルトのLinuxカーネルが「**process\_vm\_readv**」および「**process\_vm\_writev**」システムコールでコンパイルされていることを発見しました。また、新しいプロセスも含めて、すべてのプロセスが同じユーザーIDで実行されることもわかりました。**つまり、外部拡張機能は、設計上、Rapidのヒープメモリに対して完全な読み取りおよび書き込みアクセス権を持っています。**

さらに、Lambdaの**拡張機能**は**呼び出しイベントにサブスクライブ**することができますが、AWSは拡張機能に生データを公開しません。したがって、拡張機能はHTTPリクエストで送信される機密情報を収集することはできません。

**Init**（Rapid）プロセスは、**http://127.0.0.1:9001**ですべてのAPIリクエストを受け付けます。Lambdaの**拡張機能**は、ランタイムコードの前に**ロード**および**実行**されますが、**Rapid**の後に実行されます。

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

「**AWS\_LAMBDA\_RUNTIME\_API**」という名前の**変数**は、子の**ランタイム**プロセスと他の拡張機能に**Rapid APIのIPとポート番号を通知**します。

{% hint style="warning" %}
この環境変数を**制御可能なポート番号で上書き**すると、Lambdaランタイム内のすべてのアクティビティを**中間者攻撃**することができます。また、カーネルがこれらのシステムコールでコンパイルされているため、**拡張機能**はRapid Initと**同じユーザーID**で**実行**されているため、プロセスのメモリを**上書き**してポートを変更することが可能です。
{% endhint %}

**拡張機能はランタイムコードよりも前に実行**されるため、**更新された環境変数はランタイムプロセスの実行時に効果を発揮**します（Python、Java、Node、Rubyなど）。さらに、私たちの拡張機能よりも後にロードされ、この変数を使用する拡張機能は、私たちの拡張機能を介してプロキシされることもあります。これにより、マルウェアがランタイム自体からセキュリティ製品やログ拡張機能を**完全に無効化**することができます。

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

[**lambda-spyツール**](https://github.com/clearvector/lambda-spy)は、Lambdaリクエスト、他の**拡張機能のリクエスト**、さらにはそれらを**変更**するために、**メモリの書き込み**と**機密情報の盗用**を実行するために作成されました。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* HackTricksの**広告掲載**をご希望の場合や、**最新版のPEASSの利用**、またはHackTricksのPDFダウンロードをご希望の場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)をご覧ください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* 自分のハッキングテクニックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
