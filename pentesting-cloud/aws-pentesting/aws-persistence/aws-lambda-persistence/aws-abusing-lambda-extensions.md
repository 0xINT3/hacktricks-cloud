# AWS - Abuso delle estensioni Lambda

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) su GitHub.

</details>

## Estensioni Lambda

Le estensioni Lambda migliorano le funzioni integrandosi con vari **strumenti di monitoraggio, osservabilit√†, sicurezza e governance**. Queste estensioni, aggiunte tramite archivi .zip utilizzando i **Lambda layers** o incluse nelle **distribuzioni di immagini dei container**, operano in due modalit√†: **interna** ed **esterna**.

* Le **estensioni interne** si fondono con il processo di runtime, manipolando il suo avvio utilizzando **variabili d'ambiente specifiche del linguaggio** e **script wrapper**. Questa personalizzazione si applica a una serie di runtime, tra cui **Java Correto 8 e 11, Node.js 10 e 12 e .NET Core 3.1**.

* Le **estensioni esterne** vengono eseguite come processi separati, mantenendo l'allineamento operativo con il ciclo di vita della funzione Lambda. Sono compatibili con vari runtime come **Node.js 10 e 12, Python 3.7 e 3.8, Ruby 2.5 e 2.7, Java Corretto 8 e 11, .NET Core 3.1** e **runtime personalizzati**.

Per ulteriori informazioni su [**come funzionano le estensioni Lambda, consulta la documentazione**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Estensione esterna per la persistenza, il furto di richieste e la modifica delle richieste

**Questo sar√† un riassunto della tecnica proposta in questo post:** [**https://www.clearvector.com/blog/lambda-spy/**](https://www.clearvector.com/blog/lambda-spy/)

I ricercatori hanno scoperto che il kernel Linux predefinito nell'ambiente di runtime Lambda √® compilato con le chiamate di sistema "**process_vm_readv**" e "**process_vm_writev**". E tutti i processi vengono eseguiti con lo stesso ID utente, anche il nuovo processo creato per l'estensione esterna. **Ci√≤ significa che un'estensione esterna ha pieno accesso in lettura e scrittura alla memoria heap di Rapid, per design.**

Inoltre, le **estensioni Lambda** possono **sottoscriversi** agli **eventi di invocazione**; tuttavia, AWS non espone i dati grezzi all'estensione. Quindi l'estensione non sar√† in grado di raccogliere informazioni sensibili inviate nella richiesta HTTP.

Il processo **Init** (Rapid) ascolta tutte le richieste API su **http://127.0.0.1:9001**. Le **estensioni Lambda** vengono caricate ed **eseguite** prima di qualsiasi codice di runtime, ma **dopo Rapid**.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

La **variabile** chiamata "**AWS_LAMBDA_RUNTIME_API**" **informa** i processi di runtime figlio e altre estensioni dell'**indirizzo IP e del numero di porta dell'API Rapid**.

{% hint style="warning" %}
**Sovrascrivere** questa variabile d'ambiente con un **numero di porta che controlliamo** ci permetter√† di **intercettare tutte le attivit√†** all'interno del runtime Lambda.\
E poich√© il kernel √® compilato con quelle chiamate di sistema e l'estensione viene eseguita con lo **stesso ID utente** di Rapid Init, √® possibile **sovrascrivere** la **memoria del processo** e **cambiare la porta**.
{% endhint %}

Poich√© le **estensioni vengono eseguite prima di qualsiasi codice di runtime**, la **variabile d'ambiente aggiornata avr√† effetto quando viene eseguito il processo di runtime** (Python, Java, Node, Ruby, ecc). Inoltre, qualsiasi estensione che viene caricata dopo la nostra e utilizza questa variabile, verr√† instradata anche attraverso la nostra estensione. Ci√≤ potrebbe consentire al malware di **disabilitare completamente i prodotti di sicurezza o le estensioni di registrazione direttamente all'interno del runtime**.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption></figcaption></figure>

Lo strumento [**lambda-spy**](https://github.com/clearvector/lambda-spy) √® stato creato per eseguire quella **scrittura in memoria** e **rubare informazioni sensibili** dalle richieste lambda, dalle richieste di altre **estensioni** e persino **modificarle**.

# Riferimenti
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) su GitHub.

</details>
