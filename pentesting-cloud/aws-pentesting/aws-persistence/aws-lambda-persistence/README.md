# AWS - Lambda 持久性

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Lambda

更多信息请查看：

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda 层持久性

可以**引入/后门一个层来执行任意代码**，当lambda执行时以隐蔽的方式：

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda 扩展持久性

滥用Lambda层也可以滥用扩展，并在lambda中持续存在，同时窃取和修改请求。

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### 通过资源策略

可以授予不同的lambda操作（如调用或更新代码）给外部账户的访问权限：

<figure><img src="../../../../.gitbook/assets/image (2) (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

### 版本、别名和权重

Lambda可以有**不同的版本**（每个版本都有不同的代码）。\
然后，您可以创建**不同版本的不同别名**的lambda，并为每个别名设置不同的权重。\
这样，攻击者可以创建一个**后门版本1**和一个**只有合法代码的版本2**，并**只在1%的请求中执行版本1**以保持隐蔽。

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### 版本后门 + API 网关

1. 复制Lambda的原始代码
2. **创建一个新版本，对原始代码进行后门处理**（或只是带有恶意代码）。发布并**部署该版本**到$LATEST
3. 调用与lambda相关的API网关来执行代码
4. **创建一个带有原始代码的新版本**，发布并将**该版本**部署到$LATEST。
5. 这将在之前的版本中隐藏后门代码
6. 转到API网关并**创建一个新的POST方法**（或选择任何其他方法），该方法将执行lambda的后门版本：`arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
7. 注意arn的最后一个:1**表示函数的版本**（在这种情况下，版本1将是后门版本）。
8. 选择创建的POST方法，在操作中选择**`Deploy API`**
9. 现在，当您通过POST**调用函数时，您的后门**将被调用

### Cron/事件激活器

您可以使**lambda函数在某些事情发生或某段时间过去时运行**，这使得lambda成为获得持久性和避免检测的一个好方法和常见方式。\
这里有一些想法，通过创建lambdas使您在AWS中的**存在更加隐蔽**。

* 每次创建新用户时，lambda生成一个新的用户密钥并将其发送给攻击者。
* 每次创建新角色时，lambda给被泄露的用户授予假设角色权限。
* 每次生成新的cloudtrail日志时，删除/更改它们

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
