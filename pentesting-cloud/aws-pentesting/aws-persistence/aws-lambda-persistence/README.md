# AWS - Persistencia en Lambda

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Lambda

Para obtener más información, consulte:

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Persistencia de capa Lambda

Es posible **introducir/instalar una capa para ejecutar código arbitrario** cuando se ejecuta la lambda de manera sigilosa:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Persistencia de extensión Lambda

Abusando de las capas Lambda, también es posible abusar de las extensiones y persistir en la lambda, pero también robar y modificar solicitudes.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### A través de políticas de recursos

Es posible otorgar acceso a diferentes acciones de lambda (como invocar o actualizar el código) a cuentas externas:

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### Versiones, Alias y Pesos

Una Lambda puede tener **diferentes versiones** (con un código diferente en cada versión).\
Luego, puede crear **diferentes alias con diferentes versiones** de la lambda y establecer diferentes pesos para cada una.\
De esta manera, un atacante podría crear una **versión 1 con puerta trasera** y una **versión 2 con solo el código legítimo** y **solo ejecutar la versión 1 en el 1%** de las solicitudes para permanecer sigiloso.

<figure><img src="../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Backdoor de versión + API Gateway

1. Copie el código original de Lambda
2. **Cree una nueva versión con puerta trasera** del código original (o simplemente con código malicioso). Publique y **implemente esa versión** en $LATEST
   1. Llame a la API gateway relacionada con la lambda para ejecutar el código
3. **Cree una nueva versión con el código original**, publique e implemente esa **versión** en $LATEST.
   1. Esto ocultará el código con puerta trasera en una versión anterior
4. Vaya a la API Gateway y **cree un nuevo método POST** (o elija cualquier otro método) que ejecutará la versión con puerta trasera de la lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
   1. Note el final :1 del arn **indicando la versión de la función** (la versión 1 será la con puerta trasera en este escenario).
5. Seleccione el método POST creado y en Acciones seleccione **`Implementar API`**
6. Ahora, cuando **llame a la función a través de POST, se invocará su puerta trasera**

### Integración de proxy Lambda de API Gateway

Es posible hacer que una API Gateway llame a una lambda con un **rol de ejecución personalizado** que la lambda usará en su ejecución. Aquí podría asignar un rol de ejecución privilegiado y ejecutar un punto final de lambda controlado con él:

<figure><img src="../../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

### Actuador de Cron/Evento

El hecho de que pueda hacer que las **funciones lambda se ejecuten cuando algo sucede o cuando pasa algún tiempo** hace que lambda sea una forma agradable y común de obtener persistencia y evitar la detección.\
Aquí tienes algunas ideas para hacer que tu **presencia en AWS sea más sigilosa creando lambdas**.

* Cada vez que se crea un nuevo usuario, lambda genera una nueva clave de usuario y la envía al atacante.
* Cada vez que se crea un nuevo rol, lambda otorga permisos de asumir roles a usuarios comprometidos.
* Cada vez que se generan nuevos registros de cloudtrail, eliminar/alterarlos. 

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>