# AWS - Lambda Persistence

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricks swag**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) または [**telegram group**](https://t.me/peass) に**参加する**、または **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Lambda

詳細については以下をチェックしてください:

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

レイヤーを導入/バックドアして、Lambdaが実行される際に任意のコードをこっそりと実行することが可能です:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Lambda Layersを悪用することで、拡張機能を悪用し、Lambda内に永続化するだけでなく、リクエストを盗んだり変更したりすることも可能です。

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### リソースポリシーを介して

異なるLambdaアクション（invokeやupdate codeなど）へのアクセスを外部アカウントに許可することが可能です:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

### バージョン、エイリアス、ウェイト

Lambdaには**異なるバージョン**（それぞれのバージョンに異なるコード）があります。\
その後、Lambdaの**異なるバージョンに異なるエイリアスを作成し、それぞれに異なるウェイトを設定**することができます。\
この方法では、攻撃者は**バックドアされたバージョン1**と**正当なコードのみのバージョン2**を作成し、**バージョン1をリクエストの1%のみで実行して**、検出を避けることができます。

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### バージョンバックドア + API Gateway

1. Lambdaの元のコードをコピーする
2. 元のコードをバックドアする**新しいバージョンを作成**（または単に悪意のあるコードで）。公開し、そのバージョンを$LATESTに**デプロイする**
3. Lambdaに関連するAPIゲートウェイを呼び出してコードを実行する
4. **元のコードで新しいバージョンを作成**し、その**バージョン**を$LATESTに公開してデプロイする。
5. これにより、バックドアされたコードが以前のバージョンに隠される
6. API Gatewayに移動し、バックドアされたバージョンのLambdaを実行する**新しいPOSTメソッド**を作成する（または他の任意のメソッドを選択する）：`arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
7. arnの最後の:1に注目してください。これは**関数のバージョンを示しています**（このシナリオではバージョン1がバックドアされたものになります）。
8. 作成されたPOSTメソッドを選択し、Actionsで**`Deploy API`**を選択する
9. これで、**POST経由で関数を呼び出すと、バックドア**が起動されます

### Cron/Event actuator

**何かが起こったときや時間が経過したときにLambda関数を実行できる**という事実は、Lambdaを永続性を獲得し、検出を避けるための良く使われる方法にしています。\
ここに、Lambdaを作成することでAWS内での**存在をより隠密にするためのいくつかのアイデア**があります。

* 新しいユーザーが作成されるたびに、Lambdaは新しいユーザーキーを生成し、攻撃者に送信します。
* 新しいロールが作成されるたびに、Lambdaは侵害されたユーザーにassume role権限を与えます。
* 新しいCloudTrailログが生成されるたびに、それらを削除/変更します。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricks swag**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) または [**telegram group**](https://t.me/peass) に**参加する**、または **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
