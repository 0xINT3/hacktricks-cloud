# AWS - Lambda Persistence

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## Lambda

詳細については、次を参照してください：

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambdaレイヤーの永続化

Lambdaがステルス的に実行されるときに、**レイヤーを導入/バックドアとして使用して任意のコードを実行**することが可能です：

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda拡張の永続化

Lambdaレイヤーを悪用することで、拡張機能を悪用し、Lambdaに永続化するだけでなく、リクエストを盗み取りおよび変更することも可能です。

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### リソースポリシーを介して

外部アカウントに対してLambdaの異なるアクション（invokeやupdate codeなど）へのアクセス権を付与することが可能です：

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### バージョン、エイリアス、ウェイト

Lambdaは**異なるバージョン**（各バージョンごとに異なるコード）を持つことができます。\
その後、Lambdaの**異なるバージョンに対応する異なるエイリアス**を作成し、それぞれに異なるウェイトを設定することができます。\
これにより、攻撃者は**バックドア付きのバージョン1**と**正当なコードのみのバージョン2**を作成し、リクエストの1%でのみ**バージョン1を実行**することでステルス性を保つことができます。

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### バージョンバックドア+API Gateway

1. Lambdaの元のコードをコピーします
2. 元のコードをバックドアとしてバックドア付きの**新しいバージョンを作成**します（または単に悪意のあるコードを含めます）。そのバージョンを$LATESTに**公開およびデプロイ**します
1. Lambdaに関連するAPIゲートウェイを呼び出してコードを実行します
3. 元のコードで**新しいバージョンを作成**し、そのバージョンを$LATESTに**公開およびデプロイ**します。
1. これにより、バックドア付きのコードが以前のバージョンに隠されます
4. API Gatewayに移動し、**新しいPOSTメソッド**（または他の任意のメソッド）を作成します。このメソッドはバックドア付きのLambdaのバージョンを実行します：`arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. arnの最後の:1は、関数のバージョンを示しています（このシナリオではバージョン1がバックドア付きのものになります）。
5. 作成したPOSTメソッドを選択し、アクションで**`APIをデプロイ`**を選択します
6. これで、**POSTを介して関数を呼び出すとバックドアが呼び出されます**

### Cron/Eventアクチュエータ

Lambda関数を実行することができるという事実は、何かが起こったり、時間が経過したりしたときに**Lambda関数を実行する**素敵で一般的な方法であり、永続性を得て検出を回避するための方法です。\
ここでは、AWSでの存在をよりステルスにするためにLambdaを作成するいくつかのアイデアを紹介します。

* 新しいユーザーが作成されるたびに、Lambdaは新しいユーザーキーを生成して攻撃者に送信します。
* 新しいロールが作成されるたびに、Lambdaは侵害されたユーザーにassume roleの権限を付与します。
* 新しいクラウドトレイルログが生成されるたびに、削除/変更します

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
