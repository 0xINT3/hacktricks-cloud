# AWS - Lambda Persistence

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**PEASS の最新バージョンを入手したい**場合、または **HackTricks を PDF でダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をご覧ください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**Telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **HackTricks** と **HackTricks Cloud** の GitHub リポジトリに **PR を提出**して、あなたのハッキングトリックを共有しましょう。

</details>

## Lambda

詳細については、以下を参照してください：

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda レイヤーの永続化

Lambda がステルス的に実行されるときに、**レイヤーを導入/バックドア化して任意のコードを実行**することが可能です：

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda 拡張の永続化

Lambda レイヤーを悪用することで、拡張機能を悪用し、Lambda に永続化するだけでなく、リクエストを盗み取り、変更することも可能です。

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### リソースポリシーを介して

外部アカウントに対して、Lambda の異なるアクション（invoke や update code など）へのアクセス権を付与することが可能です：

<figure><img src="../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

### バージョン、エイリアス、ウェイト

Lambda には**異なるバージョン**（それぞれ異なるコードを持つ）が存在することができます。\
その後、Lambda の**異なるバージョンに対応する異なるエイリアス**を作成し、それぞれに異なるウェイトを設定することができます。\
これにより、攻撃者は**バックドア付きのバージョン 1**と**正規のコードのみのバージョン 2**を作成し、リクエストの 1% でのみ**バージョン 1 を実行**することでステルス性を保つことができます。

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### バージョンバックドア + API Gateway

1. Lambda の元のコードをコピーします。
2. 元のコードをバックドア化した**新しいバージョンを作成**し、それを $LATEST に**公開およびデプロイ**します。
1. Lambda に関連する API ゲートウェイを呼び出してコードを実行します。
3. 元のコードで**新しいバージョンを作成**し、それを $LATEST に**公開およびデプロイ**します。
1. これにより、バックドア付きのコードが以前のバージョンに隠されます。
4. API ゲートウェイに移動し、**新しい POST メソッド**（または他のメソッドを選択）を作成します。このメソッドは、バックドア付きの Lambda のバージョンを実行します：`arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. arn の最後の :1 は、関数のバージョンを示しています（このシナリオではバージョン 1 がバックドア付きのバージョンです）。
5. 作成した POST メソッドを選択し、アクションで **`Deploy API`** を選択します。
6. これで、**POST 経由で関数を呼び出すとバックドアが呼び出されます**。

### API Gateway Lambda プロキシ統合

API ゲートウェイは、**カスタム実行ロール**を使用して Lambda を呼び出すことが可能です。ここで特権のある実行ロールを割り当て、それを使用して制御された Lambda エンドポイントを実行することができます。

<figure><img src="../../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

### Cron/Event アクチュエータ

Lambda 関数を何かが起こったときや一定の時間が経過したときに実行できるという事実は、Lambda を使用して永続性を確保し、検出を回避するための便利な方法です。\
ここでは、AWS での存在をよりステルスにするために Lambda を作成するいくつかのアイデアを紹介します。

* 新しいユーザーが作成されるたびに、Lambda は新しいユーザーキーを生成し、それを攻撃者に送信します。
* 新しいロールが作成されるたびに、Lambda は侵害されたユーザーに assume role の権限を付与します。
* 新しいクラウドトレイルログが生成されるたびに、それらを削除/変更します

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**PEASS の最新バージョンを入手したい**場合、または **HackTricks を PDF でダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をご覧ください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**Telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **HackTricks** と **HackTricks Cloud** の GitHub リポジトリに **PR を提出**して、あなたのハッキングトリックを共有しましょう。

</details>
