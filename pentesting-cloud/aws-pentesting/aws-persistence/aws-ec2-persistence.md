# AWS - EC2 Persistence

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**PEASS の最新バージョンを入手したい**場合、または **HackTricks を PDF でダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をご覧ください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**Telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## EC2

詳細については、以下を参照してください：

{% content-ref url="../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### セキュリティグループ接続の永続化

もし防御者が **EC2 インスタンスが侵害された**ことを発見した場合、彼はおそらくマシンの **ネットワークを分離**しようとするでしょう。これは明示的な **Deny NACL**（ただし、NACL はサブネット全体に影響を与えます）または **セキュリティグループの変更**によって行うことができます。これにより、**入出力トラフィックを許可しないように変更**された場合でも、マシンから発信された **逆シェルの接続は切断されません**。これは [**セキュリティグループ接続の追跡**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**によるものです。**

### EC2 ライフサイクルマネージャー

このサービスを使用すると、**AMI とスナップショットの作成をスケジュール**したり、他のアカウントと **共有**したりすることができます。\
攻撃者は、すべてのイメージまたはすべてのボリュームの **AMI またはスナップショットの生成**を **毎週**行い、それらを **自分のアカウントと共有**することができます。

### スケジュールされたインスタンス

インスタンスを毎日、毎週、または月次でスケジュールすることができます。攻撃者は、特権が高いか興味深いアクセスが可能なマシンを実行することができます。

### スポットフリートリクエスト

スポットインスタンスは通常のインスタンスよりも **安価**です。攻撃者は、例えば **5年間の小さなスポットフリートリクエスト**を起動し、**自動 IP**割り当てと **ユーザーデータ**を設定して、スポットインスタンスが起動したときに攻撃者に送信される **IP アドレス**と **特権の高い IAM ロール**を取得することができます。

### バックドアインスタンス

攻撃者はインスタンスにアクセスしてバックドアを設置することができます：

* 例えば、従来の **ルートキット** を使用する
* 新しい **公開 SSH キー** を追加する（[EC2 特権昇格オプション](../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)を確認してください）
* **ユーザーデータ** にバックドアを仕掛ける

### **バックドア起動構成**

* 使用されている AMI にバックドアを仕掛ける
* ユーザーデータにバックドアを仕掛ける
* キーペアにバックドアを仕掛ける

### VPN

VPN を作成することで、攻撃者は VPC に直接接続することができます。

### VPC ピアリング

被害者の VPC と攻撃者の VPC の間にピアリング接続を作成することで、攻撃者は被害者の VPC にアクセスすることができます。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**PEASS の最新バージョンを入手したい**場合、または **HackTricks を PDF でダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をご覧ください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**Telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>
