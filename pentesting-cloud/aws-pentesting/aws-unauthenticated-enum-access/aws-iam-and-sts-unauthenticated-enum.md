# AWS - IAM √ânum√©ration non authentifi√©e

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## √ânum√©rer les r√¥les et noms d'utilisateur dans un compte

### ~~Brute-Force de l'Assume Role~~

{% hint style="danger" %}
**Cette technique ne fonctionne plus** car que le r√¥le existe ou non, vous obtenez toujours cette erreur :

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Vous pouvez **tester ceci en ex√©cutant** :

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Si vous essayez **d'assumer un r√¥le pour lequel vous n'avez pas la permission**, AWS affichera une erreur similaire √† :
```
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Ce message d'erreur indique que le r√¥le existe, mais que son document de politique d'assomption de r√¥le ne vous permet pas de l'assumer. En ex√©cutant la m√™me commande, mais en ciblant **un r√¥le qui n'existe pas**, AWS renverra :
```
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
√âtonnamment, **ce processus fonctionne entre comptes**. Avec n'importe quel ID de compte AWS valide et une liste de mots bien con√ßue, vous pouvez √©num√©rer les r√¥les existants du compte sans restrictions.

Vous pouvez utiliser ce [script pour √©num√©rer les principaux potentiels](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) en abusant de ce probl√®me.

### Politiques de confiance : For√ßage brutal des r√¥les et utilisateurs inter-comptes

Lors de la configuration/mise √† jour d'une **politique de confiance de r√¥le IAM**, vous sp√©cifiez quels **ressources/services AWS peuvent assumer ce r√¥le** et obtenir des identifiants temporaires.

Lorsque vous enregistrez la politique, si la ressource est **trouv√©e**, la politique de confiance sera **enregistr√©e avec succ√®s**, mais si elle n'est **pas trouv√©e**, alors une **erreur sera g√©n√©r√©e**, indiquant qu'un principal invalide a √©t√© fourni.

{% hint style="warning" %}
Notez que dans cette ressource, vous pourriez sp√©cifier un r√¥le ou un utilisateur inter-comptes :

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Voici un exemple de politique :
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

C'est l'**erreur** que vous trouverez si vous utilisez un **r√¥le qui n'existe pas**. Si le r√¥le **existe**, la politique sera **enregistr√©e** sans aucune erreur. (L'erreur est pour la mise √† jour, mais cela fonctionne √©galement lors de la cr√©ation)

![](<../../../.gitbook/assets/image (68).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Vous pouvez automatiser ce processus avec [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Ou en utilisant [Pacu](https://github.com/RhinoSecurityLabs/pacu) :

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Le r√¥le `admin` utilis√© dans l'exemple est un **r√¥le dans votre compte √† √™tre usurp√©** par pacu pour cr√©er les politiques n√©cessaires √† l'√©num√©ration

### Privesc

Dans le cas o√π le r√¥le a √©t√© mal configur√© et permet √† quiconque de l'assumer :

![](<../../../.gitbook/assets/image (35).png>)

L'attaquant pourrait simplement l'assumer.

## F√©d√©ration OIDC de tiers

Imaginez que vous parvenez √† lire un **workflow Github Actions** qui acc√®de √† un **r√¥le** √† l'int√©rieur d'**AWS**.\
Cette confiance pourrait donner acc√®s √† un r√¥le avec la **politique de confiance** suivante :
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Cette politique de confiance peut √™tre correcte, mais **l'absence de conditions suppl√©mentaires** devrait vous inciter √† la m√©fier.\
C'est parce que le r√¥le pr√©c√©dent peut √™tre assum√© par **N'IMPORTE QUI depuis Github Actions** ! Vous devriez √©galement sp√©cifier dans les conditions d'autres √©l√©ments tels que le nom de l'org, le nom du repo, l'env, la branche...

Une autre mauvaise configuration potentielle est d'**ajouter une condition** comme la suivante :
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Notez l'**ast√©risque** (\*) avant le **deux-points** (:). Vous pouvez cr√©er une organisation telle que **org\_name1** et **assumer le r√¥le** √† partir d'une action Github.

## R√©f√©rences

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)
* [https://hackingthe.cloud/aws/enumeration/enum\_iam\_user\_role/](https://hackingthe.cloud/aws/enumeration/enum\_iam\_user\_role/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
