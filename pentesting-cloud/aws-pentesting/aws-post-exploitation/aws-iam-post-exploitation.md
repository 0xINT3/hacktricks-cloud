# AWS - IAM рдкреЛрд╕реНрдЯ рдЕрдзрд┐рдХрд╛рд░реАрдХрд░рдг

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХрд╛ рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos** рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## IAM

IAM рдПрдХреНрд╕реЗрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## рднреНрд░рдорд┐рдд рдЙрдкрд╛рдпреБрдХреНрдд рд╕рдорд╕реНрдпрд╛

рдпрджрд┐ рдЖрдк **рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A)** рдХреЛ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдПрдХ **рд░реЛрд▓** рддрдХ рдкрд╣реБрдВрдЪ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ **рдпрд╣ рджреЗрдЦрдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрдЧреА рдХрд┐ рдХреМрди рдЙрд╕ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рдпрд╣ рдПрдХ рд╕рдорд╕реНрдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрджрд┐ рдПрдХ рдФрд░ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ (B) рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **B рдЖрдкрдХреЗ рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рднреА рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

рдЗрд╕рд▓рд┐рдП, рдЬрдм рдЖрдк рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рдХреЛ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдПрдХ рд░реЛрд▓ рддрдХ рдкрд╣реБрдВрдЪ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдПрдХ `ExternalId` рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рдПрдХ "рдЧреБрдкреНрдд" рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реИ рдЬрд┐рд╕реЗ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ (A) рдХреЛ **рдЕрдкрдиреЗ рд╕рдВрдЧрдарди рдореЗрдВ рд░реЛрд▓ рдХрд╛ рдЕрд╡рдзрд╛рд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛**ред рдЬрдм рддрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ A рдЗрд╕реЗ рдЬрд╛рдирддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ **B рдЗрд╕реЗ рдирд╣реАрдВ рдЬрд╛рдирддрд╛ рд╣реИ**, рд╡рд╣ **B рдХреЛ рдЖрдкрдХреЗ рд░реЛрд▓ рддрдХ рдкрд╣реБрдВрдЪ рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ**ред

<figure><img src="../../../.gitbook/assets/image (1) (7).png" alt=""><figcaption></figcaption></figure>

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ `ExternalId` "рдЧреБрдкреНрдд" рдирд╣реАрдВ рд╣реИ, рдЬреЛ рднреА IAM assume role policy рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИ, рд╡рд╣ рдЗрд╕реЗ рджреЗрдЦ рд╕рдХреЗрдЧрд╛ред рд▓реЗрдХрд┐рди рдЬрдм рддрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ A рдЗрд╕реЗ рдЬрд╛рдирддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ **B рдЗрд╕реЗ рдирд╣реАрдВ рдЬрд╛рдирддрд╛ рд╣реИ**, рдпрд╣ **B рдХреЛ A рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдкрдХреЗ рд░реЛрд▓ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ**ред

рдЙрджрд╛рд╣рд░рдг:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рд▓рд┐рдП рдПрдХ рднреНрд░рдорд┐рдд рдЙрдкрдирд┐рдпреБрдХреНрдд рдХрд╛ рд╢реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрд╕реЗ рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдЦреЛрдЬрдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╡рд░реНрддрдорд╛рди рдЦрд╛рддреЗ рдХреЗ рдкреНрд░рдореБрдЦ рдЕрдиреНрдп рдЦрд╛рддреЛрдВ рдореЗрдВ рднреВрдорд┐рдХрд╛рдУрдВ рдХрд╛ рдЕрднрд┐рдирдп рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╡рд┐рд╢реНрд╡рд╛рд╕

#### рдкреНрд░рдореБрдЦ рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
рдпрд╣ рдиреАрддрд┐ **рд╕рднреА AWS** рдХреЛ рднреВрдорд┐рдХрд╛ рдЧреНрд░рд╣рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

#### рдкреНрд░рдореБрдЦ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрд╡рд╛
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
рдпрд╣ рдиреАрддрд┐ **рдХрд┐рд╕реА рднреА рдЦрд╛рддреЗ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ** рдХрд┐ рд╡реЗ рдЕрдкрдиреЗ apigateway рдХреЛ рдЗрд╕ Lambda рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХреЗрдВред

#### S3 рдХреЗ рд░реВрдк рдореЗрдВ рдореБрдЦреНрдп
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
рдпрджрд┐ рдПрдХ S3 рдмрдХреЗрдЯ рдХреЛ рдореБрдЦреНрдп рдЕрднрд┐рдпрдВрддреНрд░реА рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ S3 рдмрдХреЗрдЯ рдХреЗ рдкрд╛рд╕ рдПрдХ рдЦрд╛рддрд╛ рдЖрдИрдбреА рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ, рддреЛ рдпрджрд┐ рдЖрдкрдиреЗ рдЕрдкрдиреЗ рдмрдХреЗрдЯ рдХреЛ рд╣рдЯрд╛ рджрд┐рдпрд╛ рд╣реИ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдиреЗ рдЗрд╕реЗ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдмрдирд╛рдпрд╛ рд╣реИ, рддреЛ рд╡реЗ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ Confused Deputy рд╕рдорд╕реНрдпрд╛рдУрдВ рд╕реЗ рдмрдЪрдиреЗ рдХрд╛ рд╣реИ `AWS:SourceArn` рдХреЗ рд╕рд╛рде рд╢рд░реНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдореВрд▓ ARN рдХреА рдЬрд╛рдВрдЪ рдХрд░рдирд╛ред рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдХреБрдЫ рд╕реЗрд╡рд╛рдПрдВ рдЗрд╕реЗ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░ рд╕рдХрддреА рд╣реИрдВ** (рдХреБрдЫ рд╕реНрд░реЛрддреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ CloudTrail рдЬреИрд╕реЗ)ред

## рд╕рдВрджрд░реНрдн

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХрд╛ рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
