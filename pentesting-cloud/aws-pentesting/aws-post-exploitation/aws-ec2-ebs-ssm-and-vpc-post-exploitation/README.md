# AWS - EC2、EBS、SSM和VPC后渗透

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

- 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
- 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
- **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## EC2和VPC

有关更多信息，请查看：

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **恶意VPC镜像**

VPC流量镜像**复制VPC内EC2实例的入站和出站流量**，无需在实例本身上安装任何东西。这个复制的流量通常会被发送到类似网络入侵检测系统（IDS）的设备上进行分析和监控。\
攻击者可以利用这一点来捕获所有流量并从中获取敏感信息：

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### 复制运行中的实例

实例通常包含某种敏感信息。有不同的方法可以进入其中（请查看[EC2权限提升技巧](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)）。然而，另一种检查其内容的方法是**创建一个AMI并从中运行一个新实例（甚至在您自己的账户中）**：
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS快照转储

**快照是卷的备份**，通常会包含**敏感信息**，因此检查它们应该会揭示这些信息。\
如果您找到一个**没有快照的卷**，您可以：**创建一个快照**并执行以下操作，或者只是在帐户内的实例中**挂载它**：

{% content-ref url="aws-ebs-spanshot-dump.md" %}
[aws-ebs-spanshot-dump.md](aws-ebs-spanshot-dump.md)
{% endcontent-ref %}

### 数据外泄

#### DNS外泄

即使您锁定了EC2以阻止流量流出，它仍然可以通过DNS进行**外泄**。

* **VPC流日志不会记录此操作**。
* 您无法访问AWS DNS日志。
* 使用以下命令将其禁用，将"enableDnsSupport"设置为false：

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### 通过API调用进行外泄

攻击者可以调用由他控制的帐户的API端点。Cloudtrail将记录这些调用，攻击者将能够在Cloudtrail日志中看到外泄的数据。

### SSM后渗透

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md)
{% endcontent-ref %}

### 提权到ECS

可以运行一个EC2实例并注册它以用于运行ECS实例，然后窃取ECS实例的数据。

有关[**更多信息，请查看此处**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs)。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
