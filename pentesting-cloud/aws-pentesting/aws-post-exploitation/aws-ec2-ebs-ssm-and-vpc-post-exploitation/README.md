# AWS - EC2, EBS, SSM y VPC Post Explotaci√≥n

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## EC2 y VPC

Para obtener m√°s informaci√≥n, consulta:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### Espejo VPC Malicioso

El espejo de tr√°fico VPC **duplica el tr√°fico de entrada y salida para las instancias EC2 dentro de una VPC** sin necesidad de instalar nada en las propias instancias. Este tr√°fico duplicado se enviar√≠a com√∫nmente a algo como un sistema de detecci√≥n de intrusos de red (IDS) para su an√°lisis y monitoreo.\
Un atacante podr√≠a abusar de esto para capturar todo el tr√°fico y obtener informaci√≥n confidencial de √©l:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### Copiar Instancia en Ejecuci√≥n

Las instancias suelen contener alg√∫n tipo de informaci√≥n confidencial. Hay diferentes formas de ingresar (consulte [Trucos de escalada de privilegios de EC2](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)). Sin embargo, otra forma de verificar lo que contiene es **crear una AMI y ejecutar una nueva instancia (incluso en su propia cuenta) desde ella**:

```shell
# Listar instancias
aws ec2 describe-images

# Crear una nueva imagen para la instancia-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1  

# Agregar clave a AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1  

# Crear ec2 utilizando la AMI creada anteriormente, use el mismo grupo de seguridad y subred para conectarse f√°cilmente.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# Ahora puedes verificar la instancia
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1 

# Si es necesario: editar grupos
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# S√© un buen tipo, limpia nuestra instancia para evitar cualquier costo in√∫til
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1 
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```

### Volcado de Instant√°nea EBS

**Las instant√°neas son copias de seguridad de los vol√∫menes**, que generalmente contendr√°n **informaci√≥n confidencial**, por lo tanto, verificarlos deber√≠a revelar esta informaci√≥n.\
Si encuentra un **volumen sin una instant√°nea**, podr√≠a: **Crear una instant√°nea** y realizar las siguientes acciones o simplemente **montarlo en una instancia** dentro de la cuenta:

{% content-ref url="aws-ebs-spanshot-dump.md" %}
[aws-ebs-spanshot-dump.md](aws-ebs-spanshot-dump.md)
{% endcontent-ref %}

### Exfiltraci√≥n de Datos

#### Exfiltraci√≥n DNS

Incluso si bloquea un EC2 para que no pueda salir tr√°fico, a√∫n puede **exfiltrarse a trav√©s de DNS**.

* **Los registros de flujo de VPC no registrar√°n esto**.
* No tienes acceso a los registros de DNS de AWS.
*   Deshabil√≠telo estableciendo "enableDnsSupport" en falso con:

    `aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### Exfiltraci√≥n a trav√©s de llamadas API

Un atacante podr√≠a llamar a los puntos finales de API de una cuenta controlada por √©l. Cloudtrail registrar√° estas llamadas y el atacante podr√° ver los datos de exfiltraci√≥n en los registros de Cloudtrail.

### Post Explotaci√≥n de SSM

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md)
{% endcontent-ref %}

### Privesc a ECS

Es posible ejecutar una instancia EC2 y registrarla para que se use para ejecutar instancias ECS y luego robar los datos de las instancias ECS.

Para [**m√°s informaci√≥n, consulte esto**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>