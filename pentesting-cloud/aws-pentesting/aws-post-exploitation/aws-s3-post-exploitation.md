# AWS - S3 ポストエクスプロイト

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## S3

詳細については以下をチェックしてください:

{% content-ref url="../aws-services/aws-s3-athena-and-glacier-enum.md" %}
[aws-s3-athena-and-glacier-enum.md](../aws-services/aws-s3-athena-and-glacier-enum.md)
{% endcontent-ref %}

### 機密情報

時々、バケット内で読める機密情報を見つけることができます。例えば、terraformの状態の秘密です。

### ピボッティング

異なるプラットフォームがS3を使用して機密資産を保存している可能性があります。\
例えば、**airflow**が**DAGs** **コード**をそこに保存していたり、**ウェブページ**が直接S3から提供されている場合があります。書き込み権限を持つ攻撃者は、他のプラットフォームに**ピボット**するためにバケットから**コードを変更**したり、JSファイルを変更して**アカウントを乗っ取る**ことができます。

### S3 ランサムウェア

1. **攻撃者は自分の「個人」AWSアカウント（または別の侵害されたアカウント）でKMSキーを作成し**、「世界」にそのKMSキーを暗号化に使用するアクセスを提供します。これは、任意のAWSユーザー/ロール/アカウントがS3のオブジェクトを暗号化するために使用できることを意味しますが、**解読することはできません**。
2. **攻撃者はターゲットS3バケットを特定し、それに対する書き込みレベルのアクセス権を獲得します**。これは、公開されているバケットの[悪い設定](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)や、[攻撃者がAWS環境自体にアクセスを獲得する](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)など、さまざまな方法で可能です。通常、攻撃者はPII、PHI、ログ、バックアップなどの機密情報を含むバケットをターゲットにします。
3. **攻撃者はバケットの設定をチェックして**、ランサムウェアのターゲットになり得るかどうかを判断します。これには、S3オブジェクトバージョニングが有効になっているか、多要素認証削除（MFA削除）が有効になっているかを確認することが含まれます。オブジェクトバージョニングが有効になっていない場合は、攻撃に適しています。オブジェクトバージョニングが有効になっているがMFA削除が無効になっている場合、攻撃者はオブジェクトバージョニングを無効にするだけです。オブジェクトバージョニングとMFA削除の両方が有効になっている場合は、その特定のバケットをランサムウェアにするためには_非常に多くの_追加作業が必要になります。
4. **攻撃者はAWS APIを使用して、バケット内の各オブジェクトを新しいコピーに置き換えます**が、今回は攻撃者のKMSキーで暗号化されています。
5. **攻撃者はこの攻撃に使用されたKMSキーの削除をスケジュールし**、ターゲットに7日間のウィンドウを与えます。その後、キーが削除され、データが永遠に失われます。
6. **攻撃者は最終ファイル**をアップロードします。例えば「ransom-note.txt」のようなもので、暗号化せずに、ターゲットにファイルを取り戻す方法を指示します。

以下のスクリーンショットは、ランサムウェア攻撃の対象となったファイルの例を示しています。ご覧のように、オブジェクトを暗号化するために使用されたKMSキーを所有するアカウントID（7\*\*\*\*\*\*\*\*\*\*2）は、オブジェクトを所有するアカウントのアカウントID（2\*\*\*\*\*\*\*\*\*\*1）と異なります。

![](<../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1).png>)

ここで、以下のことを行う[ランサムウェアの例を見つける](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/s3\_ransomware/s3-ransomware-poc.py)ことができます:

1. バケット内の最初の100オブジェクトを収集します（バケット内のオブジェクトが100未満の場合はすべて）
2. 一つ一つ、新しいKMS暗号化キーを使用して自分自身で各オブジェクトを上書きします

詳細については[元の研究をチェックしてください](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
