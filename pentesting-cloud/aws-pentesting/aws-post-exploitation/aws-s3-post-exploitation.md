# AWS - S3のポストエクスプロイテーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks**であなたの**会社を広告**したい場合や、**PEASSの最新バージョンを入手**したい場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## S3

詳細については、次を参照してください：

{% content-ref url="../aws-services/aws-s3-athena-and-glacier-enum.md" %}
[aws-s3-athena-and-glacier-enum.md](../aws-services/aws-s3-athena-and-glacier-enum.md)
{% endcontent-ref %}

### 機密情報

バケット内の読み取り可能な場所には、時には機密情報が含まれていることがあります。たとえば、terraformの状態の秘密情報です。

### ピボット

異なるプラットフォームでは、S3を使用して機密アセットを保存する場合があります。たとえば、**airflow**は**DAGのコード**をそこに保存しているか、**ウェブページ**は直接S3から提供されているかもしれません。書き込み権限を持つ攻撃者は、バケットから**コードを変更**して他のプラットフォームに**ピボット**したり、JSファイルを変更してアカウントを**乗っ取る**ことができます。

### S3ランサムウェア

1. **攻撃者は、自分自身の「個人用」AWSアカウント（または他の侵害されたアカウント）でKMSキーを作成**し、そのKMSキーを暗号化に使用するために「世界」にアクセスを提供します。これは、AWSのユーザー/ロール/アカウントが暗号化に使用できますが、S3のオブジェクトを復号化することはできません。
2. **攻撃者は、ターゲットのS3バケットを特定し、書き込みレベルのアクセス権を取得**します。これはさまざまな方法で可能です。これには、[公開されているバケットの設定が不適切な場合](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)や、[攻撃者がAWS環境自体にアクセスを取得した場合](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)などが含まれます。通常、攻撃者はPII、PHI、ログ、バックアップなどの機密情報を含むバケットをターゲットにします。
3. **攻撃者は、バケットの設定をチェック**して、ランサムウェアの対象になるかどうかを判断します。これには、S3オブジェクトのバージョニングが有効になっているかどうか、マルチファクタ認証削除（MFA削除）が有効になっているかどうかを確認することが含まれます。バージョニングが有効になっていない場合は、攻撃者は問題ありません。バージョニングが有効になっているが、MFA削除が無効になっている場合、攻撃者は単にバージョニングを無効にすることができます。バージョニングとMFA削除の両方が有効になっている場合、特定のバケットをランサムウェア化するには、_非常に_多くの追加作業が必要です。
4. **攻撃者はAWS APIを使用して、バケット内の各オブジェクトを自身の新しいコピーで置き換えます**が、この場合、攻撃者のKMSキーで暗号化されています。
5. **攻撃者は、この攻撃に使用されたKMSキーの削除をスケジュール**し、ターゲットにはキーが削除され、データが永久に失われるまでの7日間のウィンドウが与えられます。
6. **攻撃者は、暗号化されていない最終ファイル**（たとえば「ransom-note.txt」）をアップロードし、ターゲットにファイルを取り戻す方法を指示します。

次のスクリーンショットは、ランサムウェア攻撃の対象となったファイルの例を示しています。ご覧のように、オブジェクトを暗号化するために使用されたKMSキーを所有するアカウントID（7\*\*\*\*\*\*\*\*\*\*2）は、オブジェクトを所有するアカウントのアカウントID（2\*\*\*\*\*\*\*\*\*\*1）とは異なります。

![](<../../../.gitbook/assets/image (2) (1) (1) (1).png>)

ここで、次のようなランサムウェアの例を[見つけることができます](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/s3\_ransomware/s3-ransomware-poc.py)：

1. バケット内の最初の100個のオブジェクト（またはバケット内のオブジェクトが100個未満の場合はすべて）を収集します。
2. 1つずつ、新しいKMS暗号化キーを使用してオブジェクトを自身で上書きします。

詳細については、[元の研究を確認してください](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)。

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks**であなたの**会社を広告**したい場合や、**PEASSの最新バージョンを入手**したい場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
