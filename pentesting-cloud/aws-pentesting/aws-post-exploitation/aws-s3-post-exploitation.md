# AWS - S3 后期利用

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## S3

更多信息请查看：

{% content-ref url="../aws-services/aws-s3-athena-and-glacier-enum.md" %}
[aws-s3-athena-and-glacier-enum.md](../aws-services/aws-s3-athena-and-glacier-enum.md)
{% endcontent-ref %}

### 敏感信息

有时您可以在可读的存储桶中找到敏感信息。例如，terraform 状态机密。

### 转移

不同的平台可能使用 S3 存储敏感资产。\
例如，**airflow** 可能在其中存储 **DAGs** **代码**，或者 **网页** 可能直接从 S3 提供服务。拥有写权限的攻击者可以**修改存储桶中的代码**，以**转移到其他平台**，或通过修改 JS 文件**接管账户**。

### S3 勒索软件

1. **攻击者在他们自己的“个人”AWS 账户（或另一个被攻破的账户）中创建一个 KMS 密钥**，并提供“全世界”访问该 KMS 密钥进行加密的权限。这意味着任何 AWS 用户/角色/账户都可以使用它来加密 S3 中的对象，但**不能**解密。
2. **攻击者识别目标 S3 存储桶并获得对其的写级别访问权限**，这可以通过多种不同的方式实现。这可能包括[存储桶的糟糕配置，使其公开暴露](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)，或者[攻击者获得对 AWS 环境本身的访问权限](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)。通常，攻击者会针对存储有敏感信息的存储桶，例如 PII、PHI、日志、备份等。
3. **攻击者检查存储桶的配置**，以确定它是否能够成为勒索软件的目标。这将包括检查是否启用了 S3 对象版本控制以及是否启用了多因素认证删除（MFA 删除）。如果没有启用对象版本控制，那么他们可以开始行动。如果启用了对象版本控制，但未启用 MFA 删除，攻击者可以简单地禁用对象版本控制。如果同时启用了对象版本控制和 MFA 删除，则需要_大量_额外工作才能勒索该特定存储桶。
4. **攻击者使用 AWS API 替换存储桶中的每个对象**，但这次，它使用攻击者的 KMS 密钥进行加密。
5. **攻击者计划删除用于此次攻击的 KMS 密钥**，为目标提供 7 天的窗口期，直到密钥被删除，数据永远丢失。
6. **攻击者上传最后一个文件**，例如“ransom-note.txt”，不加密，指导目标如何取回他们的文件。

以下截图显示了一个针对勒索软件攻击的目标文件的示例。如您所见，拥有用于加密对象的 KMS 密钥的账户 ID（7\*\*\*\*\*\*\*\*\*\*2）与拥有对象的账户 ID（2\*\*\*\*\*\*\*\*\*\*1）不同。

![](<../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png>)

在这里，您可以[找到一个勒索软件示例](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/s3\_ransomware/s3-ransomware-poc.py)，它执行以下操作：

1. 收集存储桶中的前 100 个对象（或全部，如果存储桶中的对象少于 100 个）
2. 逐个用新的 KMS 加密密钥覆盖每个对象

更多信息请[查看原始研究](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)。

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
