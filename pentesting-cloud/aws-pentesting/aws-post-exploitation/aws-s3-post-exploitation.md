# AWS - S3 Post Explotaci√≥n

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## S3

Para m√°s informaci√≥n revisa:

{% content-ref url="../aws-services/aws-s3-athena-and-glacier-enum.md" %}
[aws-s3-athena-and-glacier-enum.md](../aws-services/aws-s3-athena-and-glacier-enum.md)
{% endcontent-ref %}

### Informaci√≥n Sensible

A veces podr√°s encontrar informaci√≥n sensible legible en los buckets. Por ejemplo, secretos del estado de terraform.

### Pivoteo

Diferentes plataformas podr√≠an estar utilizando S3 para almacenar activos sensibles.\
Por ejemplo, **airflow** podr√≠a estar almacenando **c√≥digo de DAGs** all√≠, o **p√°ginas web** podr√≠an estar siendo servidas directamente desde S3. Un atacante con permisos de escritura podr√≠a **modificar el c√≥digo** del bucket para **pivoteo** a otras plataformas, o **tomar control de cuentas** modificando archivos JS.

### Ransomware de S3

1. **El atacante crea una clave KMS** en su propia cuenta de AWS "personal" (o en otra cuenta comprometida) y proporciona acceso "al mundo" para usar esa clave KMS para encriptaci√≥n. Esto significa que cualquier usuario/rol/cuenta de AWS podr√≠a usarla para encriptar, pero **no** desencriptar objetos en S3.
2. **El atacante identifica un bucket S3 objetivo y obtiene acceso a nivel de escritura en √©l**, lo cual es posible a trav√©s de diferentes medios. Esto podr√≠a incluir [configuraci√≥n deficiente en buckets que los exponen p√∫blicamente](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/) o un [atacante que obtiene acceso al entorno de AWS en s√≠](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/). T√≠picamente los atacantes apuntar√≠an a buckets con informaci√≥n sensible, como PII, PHI, registros, copias de seguridad y m√°s.
3. **El atacante verifica la configuraci√≥n del bucket** para determinar si puede ser objetivo de ransomware. Esto incluir√≠a verificar si la Versioning de Objetos de S3 est√° habilitada y si la autenticaci√≥n multifactor para eliminar (MFA delete) est√° habilitada. Si la Versioning de Objetos no est√° habilitada, entonces est√°n listos para proceder. Si la Versioning de Objetos est√° habilitada, pero MFA delete est√° deshabilitado, el atacante puede simplemente deshabilitar la Versioning de Objetos. Si tanto la Versioning de Objetos como MFA delete est√°n habilitados, se requerir√≠a _mucho_ trabajo adicional para poder aplicar ransomware a ese bucket espec√≠fico.
4. **El atacante usa la API de AWS para reemplazar cada objeto en un bucket con una nueva copia de s√≠ mismo**, pero esta vez, est√° encriptado con la clave KMS del atacante.
5. **El atacante programa la eliminaci√≥n de la clave KMS** que se us√≥ para este ataque, dando un plazo de 7 d√≠as a su objetivo hasta que la clave se elimine y los datos se pierdan para siempre.
6. **El atacante sube un archivo final** como ‚Äúransom-note.txt‚Äù sin encriptaci√≥n, que instruye al objetivo sobre c√≥mo recuperar sus archivos.

La siguiente captura de pantalla muestra un ejemplo de un archivo que fue objetivo de un ataque de ransomware. Como puedes ver, el ID de cuenta que posee la clave KMS que se us√≥ para encriptar el objeto (7\*\*\*\*\*\*\*\*\*\*2) es diferente al ID de cuenta del propietario del objeto (2\*\*\*\*\*\*\*\*\*\*1).

![](<../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png>)

Aqu√≠ puedes [encontrar un ejemplo de ransomware](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/s3\_ransomware/s3-ransomware-poc.py) que hace lo siguiente:

1. Recopila los primeros 100 objetos en el bucket (o todos, si hay menos de 100 objetos en el bucket)
2. Uno por uno, sobrescribe cada objeto consigo mismo utilizando la nueva clave de encriptaci√≥n KMS

Para m√°s informaci√≥n [revisa la investigaci√≥n original](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/).

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
