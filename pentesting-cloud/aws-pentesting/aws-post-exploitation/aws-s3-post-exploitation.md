# AWS - S3后渗透

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## S3

有关更多信息，请查看：

{% content-ref url="../aws-services/aws-s3-athena-and-glacier-enum.md" %}
[aws-s3-athena-and-glacier-enum.md](../aws-services/aws-s3-athena-and-glacier-enum.md)
{% endcontent-ref %}

### 敏感信息

有时您可以在存储桶中找到可读的敏感信息。例如，terraform状态的机密信息。

### 枢轴攻击

不同的平台可能使用S3来存储敏感资产。例如，**airflow**可能会在其中存储**DAGs代码**，或者**网页**可以直接从S3中提供。具有写权限的攻击者可以通过修改存储桶中的代码来**枢轴**到其他平台，或者通过修改JS文件来**接管账户**。

### S3勒索软件

1. **攻击者在自己的“个人”AWS账户（或另一个被入侵的账户）中创建KMS密钥**，并提供“全球”访问权限以使用该KMS密钥进行加密。这意味着任何AWS用户/角色/账户都可以使用该KMS密钥进行加密，但**无法**解密S3中的对象。
2. **攻击者确定目标S3存储桶并获得写级别的访问权限**，这可以通过多种不同的方式实现。这可能包括[公开暴露存储桶的不良配置](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)或[攻击者获得对AWS环境本身的访问权限](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/)。通常，攻击者会针对包含敏感信息的存储桶，例如PII、PHI、日志、备份等。
3. **攻击者检查存储桶的配置**，以确定是否可以成为勒索软件的目标。这将包括检查是否启用了S3对象版本控制以及是否启用了多因素身份验证删除（MFA删除）。如果未启用对象版本控制，则可以继续进行。如果启用了对象版本控制，但未启用MFA删除，则攻击者可以直接禁用对象版本控制。如果同时启用了对象版本控制和MFA删除，则需要额外的工作才能对该特定存储桶进行勒索软件攻击。
4. **攻击者使用AWS API将存储桶中的每个对象替换为自身的新副本**，但这次使用攻击者的KMS密钥进行加密。
5. **攻击者安排删除用于此攻击的KMS密钥**，给目标提供了7天的时间窗口，直到密钥被删除并数据永久丢失。
6. **攻击者上传最后一个未加密的文件**，例如“ransom-note.txt”，其中说明了目标如何恢复其文件。

下面的屏幕截图显示了一个被勒索软件攻击的文件示例。正如您所看到的，用于加密对象的KMS密钥的所有者账户ID（7\*\*\*\*\*\*\*\*\*\*2）与拥有该对象的账户的账户ID（2\*\*\*\*\*\*\*\*\*\*1）不同。

![](<../../../.gitbook/assets/image (2) (1) (1) (1).png>)

您可以在[这里找到一个勒索软件示例](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/s3\_ransomware/s3-ransomware-poc.py)，它执行以下操作：

1. 收集存储桶中的前100个对象（如果存储桶中的对象少于100个，则全部收集）
2. 逐个使用新的KMS加密密钥将每个对象覆盖为自身

有关更多信息，请查看[原始研究](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)。


<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
