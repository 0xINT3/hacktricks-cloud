# AWS - S3 ポストエクスプロイト

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでの AWS ハッキングを学ぶ</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式の PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを共有する。

</details>

## S3

詳細については以下をチェックしてください:

{% content-ref url="../aws-services/aws-s3-athena-and-glacier-enum.md" %}
[aws-s3-athena-and-glacier-enum.md](../aws-services/aws-s3-athena-and-glacier-enum.md)
{% endcontent-ref %}

### 機密情報

時々、バケット内で読み取り可能な機密情報を見つけることができます。例えば、terraform state の秘密です。

### ピボッティング

異なるプラットフォームが S3 を使用して機密資産を保存している可能性があります。\
例えば、**airflow** が **DAGs** **コード** をそこに保存しているか、**ウェブページ** が直接 S3 から提供されている可能性があります。書き込み権限を持つ攻撃者は、他のプラットフォームに **ピボット** するためにバケットから **コードを変更** したり、JS ファイルを変更して **アカウントを乗っ取る** ことができます。

### S3 ランサムウェア

1. **攻撃者は自分の「個人」AWS アカウントで KMS キーを作成します**（または別の侵害されたアカウント）し、「世界」にその KMS キーを暗号化に使用するアクセスを提供します。これは、任意の AWS ユーザー/ロール/アカウントが S3 のオブジェクトを暗号化するために使用できることを意味しますが、**解読することはできません**。
2. **攻撃者はターゲット S3 バケットを特定し、それに対する書き込みレベルのアクセスを獲得します**。これは、[公開されているバケットの構成が悪いことにより露出する](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/) か、[攻撃者が AWS 環境自体にアクセスを獲得する](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/) ことを含むさまざまな手段を通じて可能です。通常、攻撃者は PII、PHI、ログ、バックアップなどの機密情報を含むバケットをターゲットにします。
3. **攻撃者はバケットの設定をチェックして**、ランサムウェアによってターゲットにされる可能性があるかどうかを判断します。これには、S3 オブジェクトバージョニングが有効になっているか、および多要素認証削除（MFA 削除）が有効になっているかどうかを確認することが含まれます。オブジェクトバージョニングが有効になっていない場合は、攻撃に適しています。オブジェクトバージョニングが有効になっているが MFA 削除が無効になっている場合、攻撃者は単にオブジェクトバージョニングを無効にすることができます。オブジェクトバージョニングと MFA 削除の両方が有効になっている場合、その特定のバケットをランサムウェアにするためには、_非常に多くの_ 追加作業が必要になります。
4. **攻撃者は AWS API を使用して、バケット内の各オブジェクトを新しいコピーに置き換えます**。ただし、今回は攻撃者の KMS キーで暗号化されています。
5. **攻撃者はこの攻撃に使用された KMS キーの削除をスケジュールします**。ターゲットに 7 日間のウィンドウを与え、そのキーが削除され、データが永遠に失われるまで。
6. **攻撃者は最終ファイルをアップロードします**。例えば「ransom-note.txt」のような暗号化されていないファイルで、ターゲットにファイルを取り戻す方法を指示します。

以下のスクリーンショットは、ランサムウェア攻撃の対象となったファイルの例を示しています。ご覧のとおり、オブジェクトを暗号化するために使用された KMS キーを所有するアカウント ID (7\*\*\*\*\*\*\*\*\*\*2) は、オブジェクトを所有するアカウントのアカウント ID (2\*\*\*\*\*\*\*\*\*\*1) と異なります。

![](<../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png>)

ここで、以下のことを行う [ランサムウェアの例を見つけることができます](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/s3\_ransomware/s3-ransomware-poc.py)：

1. バケット内の最初の 100 オブジェクトを収集します（または、バケット内のオブジェクトが 100 未満の場合はすべて）
2. 一つ一つ、新しい KMS 暗号化キーを使用して自分自身で各オブジェクトを上書きします

詳細については [元の研究をチェックしてください](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/)。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでの AWS ハッキングを学ぶ</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式の PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを共有する。

</details>
