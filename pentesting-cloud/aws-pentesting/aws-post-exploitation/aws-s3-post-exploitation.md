# AWS - Post Explotaci칩n de S3

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## S3

Para obtener m치s informaci칩n, consulta:

{% content-ref url="../aws-services/aws-s3-athena-and-glacier-enum.md" %}
[aws-s3-athena-and-glacier-enum.md](../aws-services/aws-s3-athena-and-glacier-enum.md)
{% endcontent-ref %}

### Informaci칩n Sensible

A veces podr치s encontrar informaci칩n sensible en los buckets que se puede leer. Por ejemplo, secretos de estado de terraform.

### Pivoting

Diferentes plataformas podr칤an estar usando S3 para almacenar activos sensibles.\
Por ejemplo, **airflow** podr칤a estar almacenando el **c칩digo DAGs** all칤, o las **p치ginas web** podr칤an ser servidas directamente desde S3. Un atacante con permisos de escritura podr칤a **modificar el c칩digo** del bucket para **pivotar** a otras plataformas, o **tomar el control de cuentas** modificando archivos JS.

### Ransomware de S3

1. **El atacante crea una clave KMS** en su propia cuenta de AWS "personal" (o en otra cuenta comprometida) y proporciona acceso "al mundo" para usar esa clave KMS para la encriptaci칩n. Esto significa que cualquier usuario/rol/cuenta de AWS podr칤a usarla para encriptar, pero **no** para desencriptar objetos en S3.
2. **El atacante identifica un bucket de S3 objetivo y obtiene acceso de nivel de escritura a 칠l**, lo cual es posible a trav칠s de una variedad de medios diferentes. Esto podr칤a incluir [una mala configuraci칩n en los buckets que los expone p칰blicamente](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/) o un [atacante que obtiene acceso al propio entorno de AWS](https://rhinosecuritylabs.com/penetration-testing/penetration-testing-aws-storage/). Normalmente, los atacantes apuntar칤an a buckets con informaci칩n sensible, como PII, PHI, registros, copias de seguridad y m치s.
3. **El atacante verifica la configuraci칩n del bucket** para determinar si se puede apuntar con ransomware. Esto incluir칤a verificar si la versi칩n de objetos de S3 est치 habilitada y si la eliminaci칩n de autenticaci칩n multifactor (MFA delete) est치 habilitada. Si la versi칩n de objetos no est치 habilitada, entonces est치n listos para continuar. Si la versi칩n de objetos est치 habilitada, pero MFA delete est치 deshabilitado, el atacante puede simplemente deshabilitar la versi칩n de objetos. Si tanto la versi칩n de objetos como MFA delete est치n habilitados, requerir칤a _mucho_ trabajo adicional para poder ransomware ese bucket espec칤fico.
4. **El atacante usa la API de AWS para reemplazar cada objeto en un bucket con una nueva copia de s칤 mismo**, pero esta vez, est치 encriptado con la clave KMS del atacante.
5. **El atacante programa la eliminaci칩n de la clave KMS** que se us칩 para este ataque, dando una ventana de 7 d칤as a su objetivo hasta que se elimine la clave y los datos se pierdan para siempre.
6. **El atacante carga un archivo final** como "ransom-note.txt" sin encriptaci칩n, que instruye al objetivo sobre c칩mo recuperar sus archivos.

La siguiente captura de pantalla muestra un ejemplo de un archivo que fue objetivo de un ataque de ransomware. Como se puede ver, el ID de cuenta que es due침o de la clave KMS que se us칩 para encriptar el objeto (7\*\*\*\*\*\*\*\*\*\*2) es diferente del ID de cuenta de la cuenta que es due침a del objeto (2\*\*\*\*\*\*\*\*\*\*1).

![](<../../../.gitbook/assets/image (2) (1) (1) (1).png>)

Aqu칤 puedes [encontrar un ejemplo de ransomware](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/s3\_ransomware/s3-ransomware-poc.py) que hace lo siguiente:

1. Recopila los primeros 100 objetos en el bucket (o todos, si hay menos de 100 objetos en el bucket)
2. Uno por uno, sobrescribe cada objeto con s칤 mismo usando la nueva clave de encriptaci칩n KMS

Para obtener m치s informaci칩n, [consulta la investigaci칩n original](https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/).

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>