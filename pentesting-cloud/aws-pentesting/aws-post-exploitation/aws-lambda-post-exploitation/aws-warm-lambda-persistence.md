# AWS - Lambdaリクエストの盗み出し

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
- **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

## Lambdaフロー

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**は、**invocations**を**init**プロセスに送信するコンテナ外のプロセスです。
2. initプロセスは、いくつかの興味深いエンドポイントを公開するポート**9001**でリスンします：
   - **`/2018-06-01/runtime/invocation/next`** – 次のinvocationイベントを取得
   - **`/2018-06-01/runtime/invocation/{invoke-id}/response`** – invokeのハンドラ応答を返す
   - **`/2018-06-01/runtime/invocation/{invoke-id}/error`** – 実行エラーを返す
3. **bootstrap.py**は、initプロセスからinvocationsを取得するループを持ち、ユーザーのコードを処理するために呼び出します（**`/next`**）。
4. 最後に、**bootstrap.py**はinitに**response**を送信します。

bootstrapはユーザーコードをモジュールとしてロードするため、ユーザーコードによって実行されるコード実行は実際にはこのプロセスで行われています。

## Lambdaリクエストの盗み出し

この攻撃の目的は、ユーザーコードが脆弱なリクエストを処理する**`bootstrap.py`**プロセス内で悪意のある**`bootstrap.py`**プロセスを実行させることです。これにより、**悪意のあるbootstrap**プロセスがリクエストを処理するためにinitプロセスと**通信を開始**し、**正規**のbootstrapが**罠にかかって**悪意のあるプロセスを実行している間、initプロセスにリクエストを要求しません。

これは、ユーザーコードが正規の**`bootstrap.py`**プロセスによって実行されているため、簡単に達成できるタスクです。したがって、攻撃者は次のことができます：

- **現在のinvocationの偽の結果をinitプロセスに送信**して、initがbootstrapプロセスがさらにinvocationsを待っていると思うようにします。
- リクエストを**`/${invoke-id}/response`**に送信する必要があります。
- invoke-idは、正規の**`bootstrap.py`**プロセスのスタックから[**inspect**](https://docs.python.org/3/library/inspect.html) pythonモジュールを使用して取得できます（[こちらで提案されている](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)）または単に再度**`/2018-06-01/runtime/invocation/next`**にリクエストして取得できます（[こちらで提案されている](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)）。
- 次のinvocationsを処理する悪意のある**`boostrap.py`**を実行します。
- ステルス性を確保するために、Lambda invocationsのパラメータを攻撃者が制御するC2に送信し、その後通常通りリクエストを処理します。
- この攻撃では、システムから**`bootstrap.py`**の元のコードを取得し、悪意のあるコードを追加して、現在のLambda invocationから**`invoke-id`**をパラメータとして指定して実行するだけで十分です。

### 攻撃手順

## 参考文献

- [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/) 

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
- **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>
