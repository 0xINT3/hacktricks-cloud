# AWS - Robar Solicitudes de Lambda

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Flujo de Lambda

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** es un proceso fuera del contenedor que **env√≠a** **invocaciones** al proceso **init**.
2. El proceso init escucha en el puerto **9001** exponiendo algunos endpoints interesantes:
* **`/2018-06-01/runtime/invocation/next`** ‚Äì obtener el pr√≥ximo evento de invocaci√≥n
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** ‚Äì devolver la respuesta del manejador para la invocaci√≥n
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** ‚Äì devolver un error de ejecuci√≥n
3. **bootstrap.py** tiene un bucle que obtiene invocaciones del proceso init y llama al c√≥digo de los usuarios para manejarlas (**`/next`**).
4. Finalmente, **bootstrap.py** env√≠a la **respuesta** al init.

Ten en cuenta que bootstrap carga el c√≥digo de usuario como un m√≥dulo, por lo que cualquier ejecuci√≥n de c√≥digo realizada por el c√≥digo de usuario en realidad est√° ocurriendo en este proceso.

## Robar Solicitudes de Lambda

El objetivo de este ataque es hacer que el c√≥digo de los usuarios ejecute un proceso malicioso **`bootstrap.py`** dentro del proceso **`bootstrap.py`** que maneje la solicitud vulnerable. De esta manera, el proceso **bootstrap** **malicioso** comenzar√° a **comunicarse con el proceso init** para manejar las solicitudes mientras el **bootstrap** leg√≠timo est√° **atrapado** ejecutando el malicioso, por lo que no solicitar√° m√°s solicitudes al proceso init.&#x20;

Esta es una tarea sencilla de lograr, ya que el c√≥digo del usuario se est√° ejecutando en el proceso leg√≠timo **`bootstrap.py`**. Por lo tanto, el atacante podr√≠a:

* **Enviar un resultado falso de la invocaci√≥n actual al proceso init**, para que init piense que el proceso bootstrap est√° esperando m√°s invocaciones.
* Se debe enviar una solicitud a **`/${invoke-id}/response`**&#x20;
* El invoke-id se puede obtener de la pila del proceso leg√≠timo **`bootstrap.py`** utilizando el m√≥dulo de python [**inspect**](https://docs.python.org/3/library/inspect.html) (como se [propone aqu√≠](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) o simplemente solicit√°ndolo nuevamente a **`/2018-06-01/runtime/invocation/next`** (como se [propone aqu√≠](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)).
* Ejecutar un **`bootstrap.py`** malicioso que manejar√° las pr√≥ximas invocaciones
* Con fines de sigilo, es posible enviar los par√°metros de las invocaciones de lambda a un C2 controlado por los atacantes y luego manejar las solicitudes como de costumbre.
* Para este ataque, es suficiente obtener el c√≥digo original de **`bootstrap.py`** del sistema, agregar el c√≥digo malicioso y ejecutarlo desde la invocaci√≥n actual de lambda indicando el **`invoke-id`** como par√°metro.

### Pasos del Ataque



## Referencias

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
