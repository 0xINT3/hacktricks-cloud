# AWS - Kradzież żądań Lambda

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>

## Przepływ Lambdy

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** to proces poza kontenerem, który **wysyła wywołania** do procesu **init**.
2. Proces init nasłuchuje na porcie **9001**, ujawniając kilka interesujących punktów końcowych:
* **`/2018-06-01/runtime/invocation/next`** – pobierz następne zdarzenie wywołania
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** – zwróć odpowiedź obsługi wywołania dla wywołania
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** – zwróć błąd wykonania
3. **bootstrap.py** ma pętlę pobierającą wywołania od procesu init i wywołuje kod użytkownika do ich obsługi (**`/next`**).
4. W końcu **bootstrap.py** wysyła do init **odpowiedź**.

Należy zauważyć, że bootstrap ładuje kod użytkownika jako moduł, więc wszelkie wykonanie kodu wykonywane przez kod użytkownika faktycznie dzieje się w tym procesie.

## Kradzież żądań Lambdy

Celem tego ataku jest zmuszenie kodu użytkownika do wykonania złośliwego procesu **`bootstrap.py`** wewnątrz procesu **`bootstrap.py`**, który obsługuje podatne żądanie. W ten sposób **złośliwy proces bootstrap** rozpocznie **komunikację z procesem init** w celu obsługi żądań, podczas gdy **legitymacyjny** bootstrap jest **uwięziony** uruchamiając złośliwy, więc nie będzie prosił o żądania do procesu init.&#x20;

Jest to proste zadanie do osiągnięcia, ponieważ kod użytkownika jest wykonywany przez legitymacyjny **`bootstrap.py`**. W związku z tym atakujący mógłby:

* **Wysłać fałszywy wynik bieżącego wywołania do procesu init**, więc init myśli, że proces bootstrap czeka na więcej wywołań.
* Należy wysłać żądanie do **`/${invoke-id}/response`**&#x20;
* Identyfikator wywołania można uzyskać z stosu legitymacyjnego **`bootstrap.py`** procesu, korzystając z modułu pythona [**inspect**](https://docs.python.org/3/library/inspect.html) (jak [zaproponowano tutaj](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) lub po prostu ponownie żądając go do **`/2018-06-01/runtime/invocation/next`** (jak [zaproponowano tutaj](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)).
* Wykonaj złośliwy **`boostrap.py`**, który będzie obsługiwał kolejne wywołania
* W celu zachowania dyskrecji można przesłać parametry wywołań lambdy do kontrolowanego przez atakującego C2, a następnie obsługiwać żądania jak zwykle.
* Dla tego ataku wystarczy uzyskać oryginalny kod **`bootstrap.py`** z systemu, dodać złośliwy kod i uruchomić go z bieżącego wywołania lambdy wskazując **`invoke-id`** jako parametr.

### Kroki ataku



## Referencje

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/) 

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów na GitHubie.

</details>
