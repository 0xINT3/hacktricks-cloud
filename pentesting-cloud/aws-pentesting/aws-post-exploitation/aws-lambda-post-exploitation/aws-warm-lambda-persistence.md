# AWS - 窃取Lambda请求

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Lambda流程

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**是一个位于容器外部的进程，向**init**进程发送**调用**。
2. init进程监听端口**9001**，暴露一些有趣的端点：
* **`/2018-06-01/runtime/invocation/next`** – 获取下一个调用事件
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** – 返回调用的处理程序响应
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** – 返回执行错误
3. **bootstrap.py**循环从init进程获取调用，并调用用户代码来处理它们（**`/next`**）。
4. 最后，**bootstrap.py**向init发送**响应**

请注意，bootstrap将用户代码作为模块加载，因此用户代码执行的任何代码执行实际上是在此进程中发生的。

## 窃取Lambda请求

此攻击的目标是使用户代码在**`bootstrap.py`**进程内执行一个恶意**`bootstrap.py`**进程，该进程处理易受攻击的请求。这样，**恶意bootstrap**进程将开始与init进程**通信**以处理请求，而**合法**的bootstrap被**困住**运行恶意进程，因此不会向init进程请求更多请求。&#x20;

这是一个简单的任务，因为用户的代码是由合法的**`bootstrap.py`**进程执行的。因此，攻击者可以：

* 向init进程**发送当前调用的虚假结果**，因此init认为bootstrap进程正在等待更多调用。
* 必须发送一个请求到**`/${invoke-id}/response`**&#x20;
* 可以使用[**inspect**](https://docs.python.org/3/library/inspect.html) python模块（如[此处提出的](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)）从合法的**`bootstrap.py`**进程的堆栈中获取invoke-id，或者只需再次请求**`/2018-06-01/runtime/invocation/next`**（如[此处提出的](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)）。
* 执行一个恶意**`boostrap.py`**，它将处理下一个调用
* 为了隐蔽起见，可以将lambda调用参数发送到攻击者控制的C2，然后像往常一样处理请求。
* 对于此攻击，只需从系统获取**`bootstrap.py`**的原始代码，添加恶意代码，并从当前lambda调用中运行它，指定**`invoke-id`**作为参数。

### 攻击步骤



## 参考资料

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/) 

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
