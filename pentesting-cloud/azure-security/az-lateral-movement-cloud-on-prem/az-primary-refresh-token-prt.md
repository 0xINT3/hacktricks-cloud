# Az - рдкреНрд░рд╛рдЗрдорд░реА рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди (PRT)

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

**рдкреЛрд╕реНрдЯ рдХреЙрдкреА рдХреА рдЧрдИ** [**https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

**рдкреНрд░рд╛рдЗрдорд░реА рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди** рдХреА рддреБрд▓рдирд╛ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рджреАрд░реНрдШрдХрд╛рд▓рд┐рдХ **рд╕реНрдерд╛рдпреА рдЯрд┐рдХрдЯ рдЧреНрд░рд╛рдВрдЯрд┐рдВрдЧ рдЯрд┐рдХрдЯ (TGT)** рд╕реЗ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред рдпрд╣ рдПрдХ рдЯреЛрдХрди рд╣реИ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрдирдХреЗ Azure AD рд╕реЗ рдЬреБрдбрд╝реЗ рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ **рдПрдХ рдмрд╛рд░ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ** рдФрд░ рдлрд┐рд░ Azure AD рд╕реЗ рдЬреБрдбрд╝реЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдореЗрдВ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

рдкреНрд░рд╛рдЗрдорд░реА рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рднреА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдЗрд╕реАрд▓рд┐рдП Microsoft рдиреЗ рдЗрд╕ рдЯреЛрдХрди рдкрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реБрд░рдХреНрд╖рд╛ рд▓рд╛рдЧреВ рдХреА рд╣реИред рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рдпрд╣ рд╣реИ рдХрд┐ **TPM** рд╡рд╛рд▓реЗ рдбрд┐рд╡рд╛рдЗрд╕реЛрдВ рдкрд░, рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рдХреБрдВрдЬрд┐рдпрд╛рдБ рдЙрд╕ TPM рдХреЗ рднреАрддрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рддреА рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдЕрдзрд┐рдХрд╛рдВрд╢ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ **OS рд╕реЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ**ред рдкреНрд░рд╛рдЗрдорд░реА рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХрд╛рдлреА рд╡рд┐рд╕реНрддреГрдд рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг [рдпрд╣рд╛рдБ рдЙрдкрд▓рдмреНрдз рд╣реИ](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token)ред рдореИрдВ рдЖрдкрдХреЛ рдкреВрд░рд╛ рд▓реЗрдЦ рдкрдврд╝рдиреЗ рдХрд╛ рд╕реБрдЭрд╛рд╡ рджреЗрддрд╛ рд╣реВрдБ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдХрд╛рдлреА рддрдХрдиреАрдХреА рд╡рд┐рд╡рд░рдг рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЗрд╕ рдкреЛрд╕реНрдЯ рдХреЗ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП, рдпрд╣рд╛рдБ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБ рд╣реИрдВ:

* рдпрджрд┐ TPM рдореМрдЬреВрдж рд╣реИ, рддреЛ PRT рдХреЛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдпрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдХреБрдВрдЬрд┐рдпрд╛рдБ **TPM рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд** рд╣реЛрддреА рд╣реИрдВ рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдирд┐рдХрд╛рд▓реА рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред
* **рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ MFA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ PRT рдХреЛ MFA рджрд╛рд╡реЗ рдХреЗ рд╕рд╛рде рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**, рдЬрд┐рд╕рд╕реЗ рдмрд╛рдж рдореЗрдВ MFA рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╡рд╛рд▓реЗ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд▓рд┐рдП SSO рд╕рдХреНрд╖рдо рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред
* **PRT рдореЗрдВ рдбрд┐рд╡рд╛рдЗрд╕ ID рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИ** рдФрд░ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдпрд╣ **рдбрд┐рд╡рд╛рдЗрд╕ рд╕реЗ рдмрдВрдзреА рд╣реЛрддреА рд╣реИ** рдЬреЛ Azure AD рдореЗрдВ рдбрд┐рд╡рд╛рдЗрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗ рдореЗрд▓ рдЦрд╛рддреА рд╣реИ, рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдиреБрд░реВрдк рдбрд┐рд╡рд╛рдЗрд╕реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╡рд╛рд▓реА рдХрдВрдбреАрд╢рдирд▓ рдПрдХреНрд╕реЗрд╕ рдкреЙрд▓рд┐рд╕рд┐рдпреЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рдЯреЛрдХрдиреНрд╕ рдХреЛ рдорд┐рд▓рд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рдЬрдм рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ Azure AD рдореЗрдВ рдЕрдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **PRT рдЕрдорд╛рдиреНрдп рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ** рдФрд░ рдЙрд╕ рд╕рдордп рдирдП рдЯреЛрдХрдиреНрд╕ рдХреЗ рдЕрдиреБрд░реЛрдз рдХреЗ рд▓рд┐рдП рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* SSO рдХреЗ рджреМрд░рд╛рди **PRT рдХрд╛ рдЙрдкрдпреЛрдЧ рд░рд┐рдлреНрд░реЗрд╢ рдФрд░ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрдиреНрд╕ рдХреЗ рдЕрдиреБрд░реЛрдз рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрдиреНрд╕ рдХреЛ **CloudAP рдкреНрд▓рдЧ-рдЗрди рджреНрд╡рд╛рд░рд╛ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ DPAPI рдХреЗ рд╕рд╛рде рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрдиреНрд╕ рдХреЛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЗрд╕ рдкрд░ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдЗрди рд╕реБрд░рдХреНрд╖рд╛рдУрдВ рдореЗрдВ рд╕реЗ рдХрд╛рдлреА **TPM** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИрдВ, рдЬреЛ рдХрд┐ рд╣рд╛рдЗрдмреНрд░рд┐рдб рдЬреЙрдЗрди рдореЗрдВ **рд╡реИрдХрд▓реНрдкрд┐рдХ** рд╣реИред рдпрджрд┐ TPM рдирд╣реАрдВ рд╣реИ рддреЛ **рдХреБрдВрдЬрд┐рдпрд╛рдБ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рддреА рд╣реИрдВ**ред рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ, рд╕рд╣реА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде OS рд╕реЗ рдЙрдиреНрд╣реЗрдВ **рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**ред рдПрдХ рдФрд░ рдмрд╛рдд рдЬреЛ рдЖрдЧреЗ рдХреЗ рд╢реЛрдз рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ, рд╡рд╣ рд╣реИ **рд╕рддреНрд░ рдХреБрдВрдЬреА** рдЬрд┐рд╕рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ [PRT рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token) рдореЗрдВ рдХрдИ рдмрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдкрд░рд┐рд╡рд╣рди рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ TPM рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЬрдм рддрдХ рдпрд╣ рдПрдХ рдПрдХрд▓ рдХрджрдо рдирд╣реАрдВ рд╣реЛрддрд╛ рдЬреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ TPM рдХреЗ рднреАрддрд░ рд╣реЛрддрд╛ рд╣реИ, рдпрд╣ **рд╕рддреНрд░ рдХреБрдВрдЬреА рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ рдЕрдирдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд░рдЦрдиреЗ рдХрд╛ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╕рдордп рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддрд╛ рд╣реИ**, рдЬрд┐рд╕ рд╕рдордп рдЗрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдЕрд╡рд░реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрджрд┐ рд╕рддреНрд░ рдХреБрдВрдЬреА рдХреЛ рд╕рдордп-рд╕рдордп рдкрд░ рдирд╡реАрдиреАрдХреГрдд рдпрд╛ рдмрджрд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕ рдХреБрдВрдЬреА рдХреЛ рдЕрд╡рд░реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рдЕрд╡рд╕рд░ рдмрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред

## рд╕рд┐рдВрдЧрд▓ рд╕рд╛рдЗрди рдСрди <a href="#single-sign-on" id="single-sign-on"></a>

PRT рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдЕрдиреБрд╕рд╛рд░, PRT **Azure AD рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд┐рдВрдЧрд▓ рд╕рд╛рдЗрди-рдСрди рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ**ред Edge рдореЗрдВ рдпрд╣ рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬреИрд╕рд╛ рдХрд┐ рдЕрдкреЗрдХреНрд╖рд┐рдд рд╣реИ), рд▓реЗрдХрд┐рди **Chrome рдЗрд╕реЗ рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ**, рдЗрд╕рдХреЗ рд▓рд┐рдП Microsoft рдХрд╛ рдПрдХ Chrome рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред

### Chrome рдПрдХреНрд╕рдЯреЗрдВрд╢рди рджреНрд╡рд╛рд░рд╛ PRT <a href="#interaction-with-the-prt-from-chrome" id="interaction-with-the-prt-from-chrome"></a>

рдЪрд▓рд┐рдП [Chrome рдПрдХреНрд╕рдЯреЗрдВрд╢рди](https://chrome.google.com/webstore/detail/windows-10-accounts/ppnbnpeolgkicgegkbkbjmhlideopiji?hl=en) рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ **рдЬреЛ Microsoft Windows 10 рдкрд░ SSO рдХреЗ рд▓рд┐рдП рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ**ред рдПрдХ рдмрд╛рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж рдФрд░ рдЖрдк office.com рдЬреИрд╕реЗ Azure AD рд╕реЗ рдЬреБрдбрд╝реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрд░ рдмреНрд░рд╛рдЙрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ, рд╕рд╛рдЗрди-рдЗрди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреБрдЫ рднреА рдкреНрд░реЙрдореНрдкреНрдЯ рдирд╣реАрдВ рдХрд░рддреА рдмрд▓реНрдХрд┐ рд╕реАрдзреЗ рдЖрдкрдХреЗ рдЦрд╛рддреЗ рдореЗрдВ рдЬрд╛рд░реА рд░рд╣рддреА рд╣реИред рдЪреВрдВрдХрд┐ Chrome рдПрдХреНрд╕рдЯреЗрдВрд╢рди JavaScript рдореЗрдВ рд▓рд┐рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЖрдк рдЕрдкрдиреЗ рдкрд╕рдВрджреАрджрд╛ рдПрдбрд┐рдЯрд░ рдореЗрдВ рдХреЛрдб рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╕рдВрджрд░реНрдн рдХреЗ рд▓рд┐рдП, рдПрдХреНрд╕рдЯреЗрдВрд╢рди `C:\Users\youruser\AppData\Local\Google\Chrome\User Data\Default\Extensions` рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдореИрдирд┐рдлреЗрд╕реНрдЯ рдореЗрдВ, `nativeMessaging` рдХреА рдЕрдиреБрдорддрд┐ рдШреЛрд╖рд┐рдд рдХреА рдЧрдИ рд╣реИ, `background.js` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ `com.microsoft.browsercore` рдирд╛рдорд╕реНрдерд╛рди рдХреЗ рд▓рд┐рдП `sendNativeMessage` рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИред

<figure><img src="../../../
```json
{
"name": "com.microsoft.browsercore",
"description": "BrowserCore",
"path": "BrowserCore.exe",
"type": "stdio",
"allowed_origins": [
"chrome-extension://ppnbnpeolgkicgegkbkbjmhlideopiji/",
"chrome-extension://ndjpnladcallmjemlbaebfadecfhkepb/"
]
}
```
рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХреНрдпрд╛ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдХреБрдЫ рдмрд╛рд░ рд╕рд╛рдЗрди рдЗрди рдХрд┐рдпрд╛ рдЬрдмрдХрд┐ Sysinternals рд╕реЗ Process Monitor рдЪрд▓ рд░рд╣рд╛ рдерд╛, рдЬрд┐рд╕рдиреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд┐рдпрд╛:

<figure><img src="../../../.gitbook/assets/image (100).png" alt=""><figcaption></figcaption></figure>
```bash
C:\Windows\system32\cmd.exe /d /c "C:\Windows\BrowserCore\BrowserCore.exe" chrome-extension://ppnbnpeolgkicgegkbkbjmhlideopiji/ --parent-window=0 < \\.\pipe\chrome.nativeMessaging.in.720bfd13d22dec77 > \\.\pipe\chrome.nativeMessaging.out.720bfd13d22dec77
```
рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ Chrome рдЬрд╛рдирдХрд╛рд░реА рдХреЛ `stdin` рдореЗрдВ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдирд╛рдорд┐рдд рдкрд╛рдЗрдкреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ рдФрд░ рджреВрд╕рд░реЗ рдкрд╛рдЗрдк рдХрд╛ рдЙрдкрдпреЛрдЧ `stdout` рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд░рд╣рд╛ рд╣реИред рдореИрдВрдиреЗ рд╕реЛрдЪрд╛ рдХрд┐ рдЗрди рдирд╛рдорд┐рдд рдкрд╛рдЗрдкреНрд╕ рдкрд░ рднреЗрдЬреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рджреЗрдЦрдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдпрд╛ рдореЙрдирд┐рдЯрд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рдореБрдЭреЗ рдХреЛрдИ рдУрдкрди рд╕реЛрд░реНрд╕ рдЯреВрд▓ рдирд╣реАрдВ рдорд┐рд▓рд╛ рдЬреЛ рдирд╛рдорд┐рдд рдкрд╛рдЗрдкреНрд╕ рдХреА рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рд╕рдХреНрд╖рдо рдмрдирд╛рддрд╛ рд╣реЛ, рдЗрд╕рд▓рд┐рдП рдореБрдЭреЗ [IO Ninja](https://ioninja.com/plugins/pipe-monitor.html) рдХреЗ рдХрдорд░реНрд╢рд┐рдпрд▓ Pipe Monitor рдХрд╛ рд╡рд┐рдХрд▓реНрдк рдЪреБрдирдирд╛ рдкрдбрд╝рд╛ (рд╡реЗ рдПрдХ рдореВрд▓реНрдпрд╛рдВрдХрди рд╕рдВрд╕реНрдХрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ рдореИрдВрдиреЗ рдЗрд╕рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛)ред рдпрд╣ рдХрд╛рдлреА рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рдерд╛ рдФрд░ рдХреБрдХреАрдЬрд╝ рдХреЛ рд╕рд╛рдл рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдФрд░ Office.com рдореЗрдВ рд╡рд╛рдкрд╕ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдкрд░ рдореИрдВрдиреЗ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рдВрдЪрд╛рд░ рдХреЛ рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реБрдП рджреЗрдЦрд╛:

<figure><img src="../../../.gitbook/assets/image (101).png" alt=""><figcaption></figcaption></figure>

`nativeMessaging` рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдореЗрдВ рдкрд╣рд▓реЗ рд╣реА рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдкрд╣рд▓реЗ рдХреБрдЫ рдмрд╛рдЗрдЯреНрд╕ рд╕рдВрджреЗрд╢ рдХреА рдХреБрд▓ рд▓рдВрдмрд╛рдИ рд╣реЛрддреА рд╣реИрдВ рдФрд░ рдмрд╛рдХреА рдбреЗрдЯрд╛ (JSON рдореЗрдВ) рдиреЗрдЯрд┐рд╡ рдХреМрдореНрдкреЛрдиреЗрдиреНрдЯ рдХреЛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рд╣реЛрддрд╛ рд╣реИред JSON рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ:
```json
{
"method":"GetCookies",
"uri":"https://login.microsoftonline.com/common/oauth2/authorize?client_id=4345a7b9-9a63-4910-a426-35363201d503&redirect_uri=https%3<cut>ANDARD2_0&x-client-ver=6.6.0.0&sso_nonce=AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA",
"sender":"https://login.microsoftonline.com/common/oauth2/authorize?client_id=4345a7b9-9a63-4910-a426-35363201d503&redirect_uri=https%3<cut>oth8XvXy-663HzpYYNgNtUPkF0RwNtvu1WdojjxycLl-zbLOsM_T4s&x-client-SKU=ID_NETSTANDARD2_0&x-client-ver=6.6.0.0"
}
```
рдЗрд╕рдХреЗ рдмрд╛рдж рдпрд╣ рдПрдХ рд╕рдорд╛рди JSON рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреБрдХреА рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИ, рдЬреЛ (Azure AD рдореЗрдВ рдЕрдиреНрдп рдЯреЛрдХрдиреЛрдВ рдХреА рддрд░рд╣) рдПрдХ JSON Web Token (JWT) рд╣реИ:
```json
{
"response":[
{
"name":"x-ms-RefreshTokenCredential",
"data":"eyJhbGciOiJIUzI1NiIsICJjdHgiOiJxSDBtSzc0VE92Z1Rz<cut>NjcjkwZXlhaDV5QUEifQ.Er2I_1unszMORwB5K0ZESc-HD1uZW9dQlJd8MulOQi0",
"p3pHeader":"CP=\"CAO DSP COR ADMa DEV CONo TELo CUR PSA PSD TAI IVDo OUR SAMi BUS DEM NAV STA UNI COM INT PHY ONL FIN PUR LOCi CNT\"",
"flags":8256
}
]
}
```
рдЬрдм рд╣рдо рдЗрд╕ JWT рдХреЛ рдбрд┐рдХреЛрдб рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рджреЗрдЦрддреЗ рд╣реИрдВ рдХрд┐ рдЗрд╕рдореЗрдВ PRT рд╕реНрд╡рдпрдВ рдФрд░ рдПрдХ nonce рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдХреБрдХреА рдХреЛ рд╡рд░реНрддрдорд╛рди рд▓реЙрдЧрд┐рди рд╕реЗ рдЬреЛрдбрд╝рддрд╛ рд╣реИ рдЬреЛ рдХрд┐ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ:
```json
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
рдЬрдмрдХрд┐ Azure рдореЗрдВ рдЕрдзрд┐рдХрд╛рдВрд╢ JWTs Azure AD рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд рдПрдХ рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрддреЗ рд╣реИрдВ, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **PRT рд╡рд╛рд▓рд╛ JWT рдЙрд╕ рд╕рддреНрд░ рдХреБрдВрдЬреА рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ TPM рдореЗрдВ рд╣реЛрддреА рд╣реИ**ред PRT рд╕реНрд╡рдпрдВ рдПрдХ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдмреНрд▓реЙрдм** рд╣реИ рдФрд░ рдЙрдкрдХрд░рдг рдкрд░ рдХрд┐рд╕реА рднреА рдХреБрдВрдЬреА рджреНрд╡рд╛рд░рд╛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ Azure AD рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд рдкрд╣рдЪрд╛рди рджрд╛рд╡реЗ рд╣реЛрддреЗ рд╣реИрдВред

### рд▓реЙрдЧрд┐рди рдкреНрд░рдХреНрд░рд┐рдпрд╛

Azure AD рдореЗрдВ рд╕рднреА рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЬрд╣рд╛рдВ рд╣реЛрддрд╛ рд╣реИ рд╡рд╣ рдкреНрд░рд╛рдердорд┐рдХ рдбреЛрдореЗрди `login.microsoftonline.com` рд╣реИред рдпрд╣ рд╡рд╣ рдбреЛрдореЗрди рд╣реИ рдЬрд╣рд╛рдВ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдЯреЛрдХрди рдХреА рдорд╛рдВрдЧ рдФрд░ рдирд╡реАрдиреАрдХрд░рдг рдХреА рдЬрд╛рддреА рд╣реИ**ред

рдпрд╣ рдЕрдиреБрд░реЛрдз рдЕрднреА рддрдХ PRT рдХреБрдХреА рдирд╣реАрдВ рд░рдЦрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЪреВрдВрдХрд┐ рдпрд╣ Chrome рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдЬреЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рд╣рдореЗрдВ "рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯрд┐рдВрдЧ" рдкреГрд╖реНрда рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рд╛рдЧрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ JavaScript рдХреЛрдб рд╣реЛрддрд╛ рд╣реИ рдЬреЛ Chrome рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИред

<figure><img src="../../../.gitbook/assets/image (102).png" alt=""><figcaption></figcaption></figure>

рдЬрдм рд╣рдо рдЙрд╕ URL рдХреЛ рджреЗрдЦрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╕реЗ рдиреЗрдЯрд┐рд╡ рдХреЙрдореНрдкреЛрдиреЗрдВрдЯ рдХреЛ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ URL рд╣рдо рдЬреЛ URL рджреЗрдЦ рд░рд╣реЗ рдереЗ, рдЙрд╕рдХреЗ рд╕рд╛рде **`sso_nonce`** рдкреИрд░рд╛рдореАрдЯрд░ (рдЬреЛ рдкреГрд╖реНрда рдкрд░ JavaScript рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ) рдХрд╛ рд╕рдВрдпреЛрдЬрди рд╣реЛрддрд╛ рд╣реИред рдпрд╣ nonce рдлрд┐рд░ **рдЯреЛрдХрди рдореЗрдВ рд╡рд╛рдкрд╕ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд▓реЙрдЧрд┐рди рдХреЗ рд▓рд┐рдП PRT рдХреЗ рд╕рд╛рде рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд JWT рдХреЛ рдмрд╛рдВрдзрддрд╛ рд╣реИред рдореБрдЭреЗ рдпрдХреАрди рдирд╣реАрдВ рд╣реИ рдХрд┐ рд▓реЙрдЧрд┐рди рдкреГрд╖реНрда рд╕реНрдерд┐рддрд┐ рдХреЛ рдХреИрд╕реЗ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИ рдФрд░ рдпрд╣ рдЗрд╕ nonce рдХреЛ рдХрд╣рд╛рдВ/рдЕрдЧрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ рдЕрд▓рдЧ nonce рдХреЗ рд╕рд╛рде JWT рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред

<figure><img src="../../../.gitbook/assets/image (103).png" alt=""><figcaption></figcaption></figure>

### рдиреЙрдиреНрд╕ рд╕реЗ рдЫреБрдЯрдХрд╛рд░рд╛ рдкрд╛рдирд╛ <a href="#getting-rid-of-the-nonce" id="getting-rid-of-the-nonce"></a>

рдЕрдм рдЬрдм рд╣рдордиреЗ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛ рд▓рд┐рдпрд╛ рдХрд┐ рд╣рдо `BrowserCore.exe` рдХреЗ рд╕рд╛рде рдХреИрд╕реЗ рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдореИрдВрдиреЗ Python рдореЗрдВ рдПрдХ рдЫреЛрдЯрд╛ рдЙрдкрдХрд░рдг рд▓рд┐рдЦрд╛ рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдФрд░ JSON рдХреЛ рд╕реАрдзреЗ рдЗрд╕рдХреЗ `stdin` рдФрд░ `stdout` рдореЗрдВ рд▓рд┐рдЦрддрд╛ рд╣реИред рдлрд┐рд░ рдпрд╣ рдЙрддреНрддрд░ рдкрдврд╝рддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдбрд┐рдХреЛрдб рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдореЗрдВ рдХрд┐рд╕реА рднреА URL рдХреЗ рд▓рд┐рдП PRT рдХреБрдХреАрдЬрд╝ рдХреА рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред
```python
import subprocess
import struct
import json
process = subprocess.Popen([r"C:\Windows\BrowserCore\browsercore.exe"], stdin=subprocess.PIPE, stdout=subprocess.PIPE)
inv = {}
inv['method'] = 'GetCookies'
inv['sender'] = "https://login.microsoftonline.com"
inv['uri'] = 'https://login.microsoftonline.com/common/oauth2/authorize?client_id=4345a7b9-9a63-4910-a426-35363201d503&response_mode=form_post&response_type=code+id_token&scope=openid+profile&state=OpenIdConnect.AuthenticationProperties%3dhiUgyLP6LnqNTRRyNpT0W1WGjOO_9hNAUjayiM5WJb0wwdAK0fwF635Dw5XStDKDP9EV_AeGIuWqN_rtyrl8m9t6pUGiXHhG3GMSSpW-AWcpfxW9D6bmWECYrN36_9zw&nonce=636957966885511040.YmI2MDIxNmItZDA0Yy00MjZlLThlYjAtYjNkNDM5NzkwMjVlYThhYTMyZGYtMGVlZi00Mjk4LWE2ODktY2Q2ZjllODU4ZjNk&redirect_uri=https%3a%2f%2fwww.office.com%2f&ui_locales=nl&mkt=nl&client-request-id=d738dfc8-db89-4f27-9522-eb70aa55c2b3&sso_nonce=AQABAAAAAADCoMpjJXrxTq9VG9te-7FX2rBuuPsFpQIW4_wk_IAK5pG2t1EdXLfKDDJotUpwFvQKzd0U_I_IKLw4CEQ5d9uzoWgbWEsY6lt1Tm3Kpw9CfiAA'
text = json.dumps(inv).encode('utf-8')
encoded_length = struct.pack('=I', len(text))
print(process.communicate(input=encoded_length + text)[0])
```
рдореИрдВрдиреЗ рдереЛрдбрд╝рд╛ рд╕рд╛ рдЗрд╕рдХреЗ рд╕рд╛рде рдЦреЗрд▓рддреЗ рд╣реБрдП рджреЗрдЦрд╛ рдХрд┐ URL рдореЗрдВ рдЕрдзрд┐рдХрд╛рдВрд╢ рдкреИрд░рд╛рдореАрдЯрд░реНрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдПрдХ рдорд╛рдиреНрдп PRT рдХреБрдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `https://login.microsoftonline.com/?sso_nonce=aaaaa"` рд╡рд╛рд▓рд╛ URL рдкрд░реНрдпрд╛рдкреНрдд рд╣реИ рдПрдХ рдорд╛рдиреНрдп рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд PRT рдХреБрдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рд╕рдореЗрдВ nonce `aaaaa` рд╣реЛред

рдореЗрд░реЗ рдкрд░реАрдХреНрд╖рдг рдореЗрдВ, **PRT рдХреБрдХреА рд▓рдЧрднрдЧ 35 рдорд┐рдирдЯ рдХреЗ рдмрд╛рдж рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдИ**, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рдерд╛ред рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕рд╛рдЗрдЯреЗрдВ рдЬреЛ рдЕрдкрдирд╛ рд╕реНрд╡рдпрдВ рдХрд╛ рд╕рддреНрд░ рдкреНрд░рдмрдВрдзрди рдХрд░рддреА рд╣реИрдВ, рд╡реЗ рдЖрдкрдХреЛ рдХреБрдЫ рд╕рдордп рдХреЗ рд▓рд┐рдП рд╕рд╛рдЗрди рдЗрди рд░рдЦреЗрдВрдЧреА рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ **рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд╣реБрдБрдЪ рдХреЛ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЬреЛ рд╕рд╛рдЗрдЯреЗрдВ рдирд┐рд╣рд┐рдд **OAuth2** рдкреНрд░рд╡рд╛рд╣ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИрдВ, рд╡реЗ рдХреЗрд╡рд▓ рдПрдХ рдкрд╣реБрдБрдЪ рдЯреЛрдХрди рджреЗрддреА рд╣реИрдВред рдпрд╣ рдкрд╣реБрдБрдЪ **рдЯреЛрдХрди рдПрдХ рдШрдВрдЯреЗ рдХреЗ рдмрд╛рдж рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ**, рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк PRT рдХреБрдХреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдРрд╕реА рд╕рд╛рдЗрдЯ рдкрд░ рд╕рд╛рдЗрди рдЗрди рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдПрдХ рдШрдВрдЯреЗ рдХреЗ рдмрд╛рдж рдлрд┐рд░ рд╕реЗ рд▓реЙрдЧ рдЖрдЙрдЯ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕рдХрд╛ рдпрд╣ рднреА рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рднреА рдХрд╛рд░рдг рд╕реЗ рдбрд┐рд╡рд╛рдЗрд╕ рддрдХ рдЕрдкрдиреА рдкрд╣реБрдБрдЪ рдЦреЛ рджреЗрддреЗ рд╣реИрдВ, рддреЛ Azure AD рддрдХ рднреА рдкрд╣реБрдБрдЪ рдЦреЛ рдЬрд╛рдПрдЧреАред

### рдкрдмреНрд▓рд┐рдХ рдХреНрд▓рд╛рдЗрдВрдЯреНрд╕ рдХреЗ рд╕рд╛рде PRT рдХреБрдХреА рдХрд╛ рдЙрдкрдпреЛрдЧ <a href="#using-the-prt-cookie-with-public-clients" id="using-the-prt-cookie-with-public-clients"></a>

рдореБрдЭреЗ рдЬрд┐рдЬреНрдЮрд╛рд╕рд╛ рдереА рдХрд┐ рдХреНрдпрд╛ рд╣рдо SSO рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдиреНрдп Azure AD рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдХреЗ рд╕рд╛рде рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ Azure PowerShell рдореЙрдбреНрдпреВрд▓ред рдЬрдм рд╣рдо `Connect-AzureAD` cmdlet рдЪрд▓рд╛рддреЗ рд╣реИрдВ, рдПрдХ рдкреЙрдк-рдЕрдк рдмреЙрдХреНрд╕ рдЦреБрд▓рддрд╛ рд╣реИ рдЬреЛ рд╣рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддрд╛ рд╣реИ, рдФрд░ рдХреЛрдИ SSO рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред ~~рдореБрдЭреЗ рдирд╣реАрдВ рдкрддрд╛ рдХрд┐ рдРрд╕рд╛ рдХреНрдпреЛрдВ рд╣реИ, рд╢рд╛рдпрдж рдпрд╣ рдЕрднреА рддрдХ рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИ~~ рдЬреИрд╕рд╛ рдХрд┐ [@cnotin](https://twitter.com/cnotin/status/1285734903389265922?s=20) рдиреЗ рдмрддрд╛рдпрд╛ рд╣реИ SSO рддрдм рд╣реЛрддрд╛ рд╣реИ рдЬрдм `-AccountId` рдкреИрд░рд╛рдореАрдЯрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рдмрд┐рдирд╛ рднреА `x-ms-RefreshTokenCredential` HTTP рд╣реЗрдбрд░ рдореЗрдВ рдПрдХ PRT рдХреБрдХреА рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИ:

<figure><img src="../../../.gitbook/assets/image (105).png" alt=""><figcaption></figcaption></figure>

рдлрд┐рд░ рднреА **рдХреЛрдИ SSO рдирд╣реАрдВ рд╣реЛ рд░рд╣рд╛ рд╣реИ, рдмрд╛рд╡рдЬреВрдж рдЗрд╕рдХреЗ рдХрд┐ рдПрдХ PRT рдХреБрдХреА рдореМрдЬреВрдж рд╣реИ**ред рдпрд╣ `prompt=login` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рдХрд╛рд░рдг рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд▓реЙрдЧрд┐рди рдкреНрд░реЙрдореНрдкреНрдЯ рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░рддрд╛ рд╣реИ рдмрдЬрд╛рдп рд╕реАрдзреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗред рдореБрдЭреЗ рдирд╣реАрдВ рдкрддрд╛ рдХрд┐ PowerShell рдореЙрдбреНрдпреВрд▓реНрд╕ рдХрд┐рд╕ рдлреНрд░реЗрдорд╡рд░реНрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдореИрдВ рдорд╛рдирддрд╛ рд╣реВрдБ рдХрд┐ рдпрд╣ WAM рдлреНрд░реЗрдорд╡рд░реНрдХ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдЬреЗрдВрдЯ Internet Explorer рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ?)ред рдЬрдм рд╣рдо HTTP рдЕрдиреБрд░реЛрдз рдореЗрдВ `prompt` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рд╣рдЯрд╛рддреЗ рд╣реИрдВ, рддреЛ рд╣рдореЗрдВ рдПрдХ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЛрдб рдорд┐рд▓рддрд╛ рд╣реИ:

<figure><img src="../../../.gitbook/assets/image (106).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ [OAuth2 рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЛрдб рдкреНрд░рд╡рд╛рд╣](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow) рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рд╣рдо рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдПрдХ рдкрд╣реБрдБрдЪ рдЯреЛрдХрди рдФрд░ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдХреНрдпреЛрдВрдХрд┐ Azure AD PowerShell рдореЙрдбреНрдпреВрд▓ рдПрдХ _рдкрдмреНрд▓рд┐рдХ_ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд╣реБрдБрдЪ рдФрд░ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреА рдорд╛рдВрдЧ рдХрд░рдиреЗ рдореЗрдВ рдХреЛрдИ рдЧреБрдкреНрдд рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реИред рдпрд╣ рд╕рднреА рдореЛрдмрд╛рдЗрд▓ рдФрд░ рдиреЗрдЯрд┐рд╡ рдПрдкреНрд╕ рдХреЗ рд▓рд┐рдП рдорд╛рдорд▓рд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдХреЛрдИ рдмреИрдХрдПрдВрдб рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдпреЗ рдХреНрд▓рд╛рдЗрдВрдЯреНрд╕ рд╕реАрдзреЗ рд╡рд┐рднрд┐рдиреНрди API's рд╕реЗ рдмрд╛рдд рдХрд░рддреЗ рд╣реИрдВред рдпрд╣ рднреА рдЙрд╕реА рдкреГрд╖реНрда рдкрд░ [рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХреГрдд](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow#request-an-access-token) рд╣реИред рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдореИрдВ Azure PowerShell рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реВрдБ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрд╛рдлреА рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЕрдиреНрдп рднреА рд╣реИрдВред рдореИрдВрдиреЗ рдЕрдкрдиреЗ [BlueHat рдЯреЙрдХ](https://dirkjanm.io/assets/raw/Im%20in%20your%20cloud%20bluehat-v1.0.pdf) рдореЗрдВ рд╕реНрд▓рд╛рдЗрдб 24 рдкрд░ рдХреБрдЫ рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рд╣реИред рдЖрдк **ROADrecon рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрдмреНрд▓рд┐рдХ рдХреНрд▓рд╛рдЗрдВрдЯреНрд╕ рднреА рдвреВрдБрдв рд╕рдХрддреЗ рд╣реИрдВ**ред рдкрд╣рд▓реЗ рдкрдХреНрд╖ рдХреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ (рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдЬреЛ рдЙрд╕реА рдЯреЗрдиреЗрдВрдЯ рдореЗрдВ рдореМрдЬреВрдж рд╣реЛрддреЗ рд╣реИрдВ) рдХреЗ рд▓рд┐рдП, рдпрд╣ рдЕрд╡рд▓реЛрдХрди рдореЗрдВ рдПрдХ рдХреЙрд▓рдо рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЖрдкрдХреЗ рдЯреЗрдиреЗрдВрдЯ рдореЗрдВ рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП, рд▓реЗрдХрд┐рди рдЬрд┐рдирдХреЗ рдкрд╛рд╕ рдПрдХ рд╕реЗрд╡рд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рд╣реЛрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдЕрдзрд┐рдХрд╛рдВрд╢ Office 365 рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕), рдЖрдк рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ ApplicationRefs рдЯреЗрдмрд▓ рдореЗрдВ рдкрдмреНрд▓рд┐рдХ рдХреНрд▓рд╛рдЗрдВрдЯреНрд╕ рдвреВрдБрдв рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../.gitbook/assets/image (107).png" alt=""><figcaption></figcaption></figure>

рдкреНрд░рд╛рдкреНрдд рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЛрдб рдХреЛ рд╕рд╣реА рдПрдВрдбрдкреЙрдЗрдВрдЯ (`https://login.microsoftonline.com/Common/oauth2/token`) рдкрд░ рднреЗрдЬрдХрд░ рд╣рдо рджреЛрдиреЛрдВ рдПрдХ рдкрд╣реБрдБрдЪ рдЯреЛрдХрди рдФрд░ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рд╕рд╛рдорд╛рдиреНрдпрддрдГ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдирд╣реАрдВ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди WAM рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЕрдиреБрд░реЛрдз рд╕реНрд╡рдпрдВ рднреЗрдЬрдХрд░ рд╣рдо рдмрд┐рдирд╛ рдХрд┐рд╕реА рд╕рдорд╕реНрдпрд╛ рдХреЗ рджреЛрдиреЛрдВ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../.gitbook/assets/image (108).png" alt=""><figcaption></figcaption></figure>

рдкрд░рд┐рдгрд╛рдореА JSON рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛:

<figure><img src="../../../.gitbook/assets/image (109).png" alt=""><figcaption></figcaption></figure>

## рдЯреЛрдХрди рджрд╛рд╡реЗ рдФрд░ рдирд┐рд╣рд┐рддрд╛рд░реНрде <a href="#token-claims-and-implications" id="token-claims-and-implications"></a>

рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рдкрд╣реБрдБрдЪ рдЯреЛрдХрди рдФрд░ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдореЗрдВ PRT рдХреЗ рд╕рдорд╛рди рджрд╛рд╡реЗ рд╣реЛрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП рдпрджрд┐ MFA рдкреНрд░рдорд╛рдгреАрдХрд░рдг SSO рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ **PRT рдореЗрдВ MFA рджрд╛рд╡рд╛ рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛** [рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдХреЗ рдЕрдиреБрд╕рд╛рд░](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token#when-does-a-prt-get-an-mfa-claim)ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЕрдзрд┐рдХрд╛рдВрд╢ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдЗрд╕ рддрд░рд╣ рд╕реЗ рдкреНрд░рд╛рдкреНрдд **рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди** рдореЗрдВ **MFA рджрд╛рд╡рд╛ рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛** рдФрд░ рдЗрд╕ рдкреНрд░рдХрд╛рд░ MFA рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╡рд╛рд▓реА Conditional Access рдиреАрддрд┐рдпреЛрдВ рдХреЛ рд╕рдВрддреБрд╖реНрдЯ рдХрд░реЗрдЧрд╛ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЪреВрдВрдХрд┐ PRT рдПрдХ Azure AD рдЬреБрдбрд╝реЗ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛ рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, PRT рдХреБрдХреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдореЗрдВ рдорд┐рд▓рдиреЗ рд╡рд╛рд▓реЗ рдЯреЛрдХрдиреНрд╕ рдореЗрдВ рднреА рдбрд┐рд╡рд╛рдЗрд╕ ID рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдпрд╣ рдЙрди рдиреАрддрд┐рдпреЛрдВ рдХреЛ рд╕рдВрддреБрд╖реНрдЯ рдХрд░рддреА рд╣реИ рдЬрд┐рдирдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдПрдХ рдЕрдиреБрд░реВрдк рдпрд╛ Hybrid рдбрд┐рд╡рд╛рдЗрд╕ рд╣реЛрддреА рд╣реИ:

<figure><img src="../../../.gitbook/assets/image (110).png" alt=""><figcaption></figcaption></figure>

рддреЛ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдЪрд╛рд╣реЗ рд▓реЙрдЧрд┐рди рд╕реБрд░рдХреНрд╖рд╛ рдХрд┐рддрдиреА рднреА рдордЬрдмреВрдд рд╣реЛ, рдПрдХ рдмрд╛рд░ рдЬрдм рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рдорд╢реАрди рдкрд░ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реЗрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ SSO рдХреНрд╖рдо
