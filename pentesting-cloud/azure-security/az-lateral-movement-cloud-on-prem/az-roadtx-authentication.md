# Az - Roadtx - Authentification

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Article copi√© de** [**https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/**](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Informations de base

ROADtools Token eXchange (roadtx) est un outil pour **√©changer et utiliser diff√©rents types de tokens √©mis par Azure AD**. Il prend en charge de nombreux flux d'authentification diff√©rents, l'enregistrement des appareils et les op√©rations li√©es au PRT.

Il peut faire ce qui suit :

* Enregistrer et joindre des appareils √† Azure AD.
* Demander des Primary Refresh Tokens √† partir des identifiants d'utilisateur ou d'autres tokens valides.
* Utiliser des Primary Refresh Tokens de mani√®re similaire au Web Account Manager (WAM) dans Windows.
* Effectuer toutes sortes de flux de r√©demption de tokens Oauth2.
* R√©aliser des connexions interactives bas√©es sur le Browser SSO en injectant le Primary Refresh Token dans le flux d'authentification.
* Ajouter des capacit√©s SSO √† Chrome via le plugin Windows 10 accounts et une impl√©mentation personnalis√©e de browsercore.
* Automatiser les connexions, la MFA et les demandes de tokens pour diverses ressources dans Azure AD en utilisant Selenium.
* Possibilit√© de charger des identifiants et des graines TOTP MFA √† partir d'une base de donn√©es KeePass pour les utiliser dans des flux automatis√©s.

## Enregistrement d'un appareil

La plupart des modules de roadtx sont con√ßus autour des Primary Refresh Tokens et des identit√©s d'appareils. **Pour obtenir un PRT, nous devons d'abord enregistrer un appareil dans Azure AD**.\
L'enregistrement d'un appareil **n√©cessite** un **access token** pour la ressource du service d'enregistrement d'appareils. L'access token doit √™tre un **token sans revendication d'appareil**, donc vous ne pouvez pas utiliser de single sign-on ou un PRT existant pour en demander un. Il existe **plusieurs fa√ßons d'obtenir un tel token avec roadtx**, certaines m√©thodes prenant en charge la MFA et d'autres non.\
**La MFA pourrait √™tre requise pour enregistrer un appareil, selon les param√®tres du locataire**. Si ce n'est pas le cas, vous pouvez demander un token pour le service d'enregistrement d'appareil (sp√©cifi√© ici par l'alias _devicereg_) avec seulement un nom d'utilisateur et un mot de passe :
```bash
roadtx gettokens -u myuser@mytenant.com -p password -r devicereg
```
Si MFA est requis, vous pouvez utiliser le flux d'authentification de l'appareil pour demander les jetons depuis une **fen√™tre de navigateur quelque part** :
```bash
roadtx gettokens --device-auth -r devicereg
```
En alternative, nous utilisons une **fen√™tre bas√©e sur Selenium pour le MFA**, tout en remplissant automatiquement le nom d'utilisateur + le mot de passe :
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password -r devicereg
```
Toutes les commandes ci-dessus **sauvegardent un jeton d'acc√®s dans le fichier `.roadtools_auth`**. La commande d'enregistrement de l'appareil le chargera automatiquement √† partir de ce fichier. Vous pouvez personnaliser les propri√©t√©s de l'appareil que vous souhaitez avec divers param√®tres de ligne de commande pour le module `roadtx device` :

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Nous enregistrons un appareil joint √† Azure AD avec le nom ‚Äúblogdevice‚Äù :
```bash
roadtx device -n blogdevice
Saving private key to blogdevice.key
Registering device
Device ID: 5f138d8b-6416-448d-89ef-9b279c419943
Saved device certificate to blogdevice.pem
```
Nous obtenons deux √©l√©ments qui identifient notre appareil : Le premier est le **certificat d'appareil** sauvegard√© dans `blogdevice.pem`, qui est d√©livr√© par Azure AD et **identifie notre appareil**. La seconde partie est le fichier `blogdevice.key`, qui contient la **cl√© priv√©e du certificat** et est √©galement utilis√©e comme cl√© de transport. Maintenant que nous avons le certificat d'appareil, nous pouvons effectuer des **op√©rations n√©cessitant une identit√© d'appareil**. La plus utile est **la demande d'un jeton d'actualisation principal**, car cela nous permettra d'ajouter des capacit√©s de connexion unique √† nos demandes de jetons (interactives ou automatis√©es).

## Demande d'un jeton d'actualisation principal <a href="#requesting-a-primary-refresh-token" id="requesting-a-primary-refresh-token"></a>

Un jeton d'actualisation principal est le plus souvent demand√© avec un nom d'utilisateur et un mot de passe. Lorsque vous vous connectez √† un poste de travail joint √† Azure AD ou hybride avec votre **nom d'utilisateur et mot de passe**, Windows demande imm√©diatement un PRT √† Azure AD. J'ai parl√© des aspects techniques de ce flux lors de mes conf√©rences √† Troopers et Romhack [talks](https://dirkjanm.io/talks/) dans le pass√©, donc si vous √™tes int√©ress√© par les d√©tails techniques, jetez un ≈ìil √† ces diapositives. **Pour demander un PRT avec roadtx, ex√©cutez la commande `roadtx prt`**, sp√©cifiez le certificat/cl√© de l'appareil et le nom d'utilisateur + mot de passe √† utiliser, et vous obtenez un PRT :

{% code overflow="wrap" %}
```bash
roadtx prt -u myuser@mytenant.com -p password --key-pem blogdevice.key --cert-pem blogdevice.pem
```
```markdown
La commande nous fournira un **PRT** (sous forme de jeton chiffr√©) et une **cl√© de session** n√©cessaire pour utiliser le PRT. Par d√©faut, le PRT est enregistr√© dans `roadtx.prt`, o√π il peut √™tre r√©cup√©r√© par d'autres modules roadtx.

Un PRT est valide par d√©faut pendant 90 jours, mais nous pouvons le **renouveler √† tout moment** pour prolonger sa validit√© de 90 jours suppl√©mentaires avec l'action `renew` :
```
```bash
roadtx prt -a renew
Renewing PRT
Saved PRT to roadtx.prt
```
Notez que le PRT que nous avons demand√© ici est uniquement bas√© sur un mot de passe, donc **toute authentification qui n√©cessite MFA √©chouera m√™me si nous utilisons le PRT**. Nous pouvons √©galement am√©liorer ou ¬´ enrichir ¬ª le PRT avec une revendication MFA, cela est montr√© dans la section suivante sur l'authentification bas√©e sur Selenium.

## Utilisation des jetons d'actualisation principaux en ligne de commande <a href="#using-primary-refresh-tokens-on-the-command-line" id="using-primary-refresh-tokens-on-the-command-line"></a>

Une fois que nous avons un PRT, nous pouvons l'utiliser pour **se connecter aux ressources qui acceptent l'authentification Azure AD**. Vous pouvez le faire soit avec la commande **`roadtx gettokens`**, et **sp√©cifier le PRT et la cl√© de session** en ligne de commande, soit utiliser la commande **`roadtx prtauth`**. La diff√©rence entre les deux est que la commande **`gettokens`** impl√©mente une authentification qui est **bas√©e sur la mani√®re dont Chrome effectue la connexion unique** dans le navigateur. Cette m√©thode est un peu bricol√©e et si elle √©choue, elle ne vous donnera aucun retour.

Le module **`prtauth`** √† la place √©mule le **Web Account Manager (WAM) que Windows** utilise si vous demandez des jetons d'acc√®s depuis une application ou un processus natif. Le WAM agit comme un courtier de jetons et demande des jetons au nom d'autres clients. Il utilise une combinaison de requ√™tes sign√©es et de r√©ponses chiffr√©es pour emp√™cher l'exposition des jetons en transit, tout cela en utilisant la cl√© de session PRT.

Par d√©faut, le module `roadtx prtauth` utilisera l'**ID client du Module PowerShell Azure AD** et le graphique Azure AD comme ressource, mais vous pouvez sp√©cifier tout autre ID client ou URL de ressource soit par sa partie compl√®te soit comme un alias (listable avec `roadtx listaliases`) :
```bash
roadtx prtauth
Tokens were written to .roadtools_auth
```
Exemple d'utilisation de l'Azure CLI comme ID client et de demande de jetons pour le Azure Resource Manager :
```bash
roadtx prtauth -c azcli -r azrm
Tokens were written to .roadtools_auth
```
Il existe √©galement d'autres options que vous pouvez utiliser pour sp√©cifier d'autres ressources ou l'URL de redirection correcte pour l'application que vous utilisez :

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Authentification Azure AD bas√©e sur Selenium <a href="#selenium-based-azure-a-d-authentication" id="selenium-based-azure-a-d-authentication"></a>

Les demandes de jetons et leur utilisation en ligne de commande sont pratiques, mais souvent vous rencontrerez un flux qui n√©cessite soit une fen√™tre de navigateur pour effectuer une Authentification Multifacteur, soit vous souhaitez simplement utiliser votre PRT de mani√®re interactive pour naviguer sur des sites comme le Portail Azure ou simplement lire vos mails en utilisant un PRT vol√©.

Le principe des op√©rations bas√©es sur Selenium dans roadtx est simple : **il lance une fen√™tre de navigateur, essaie de remplir automatiquement les identifiants que vous avez fournis √† la commande, et vous laisse compl√©ter le reste √† la main**. Si vos comptes sont configur√©s correctement, il effectuera l'authentification de mani√®re totalement automatique.

### Authentification interactive <a href="#interactive-authentication" id="interactive-authentication"></a>

Dans sa forme la plus simple, roadtx lancera un navigateur pour vous, demandera un jeton pour le service indiqu√©, remplira les identifiants que vous avez sp√©cifi√©s et obtiendra des jetons. Exemple :
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password
```
Si **MFA** est requis, vous pouvez l'entrer et obtenir un jeton avec une revendication MFA. Sinon, il capturera la sortie et sauvegardera les jetons demand√©s. Vous pouvez sp√©cifier le **client ID** que vous souhaitez utiliser avec `-c` et la ressource pour l'authentification avec `-r`. Voici une [**courte d√©monstration vid√©o**](https://dirkjanm.io/assets/video/selenium_autofill.mp4).

### Utiliser KeePass pour s'authentifier dans diff√©rents comptes <a href="#keepass-credentials-based-authentication" id="keepass-credentials-based-authentication"></a>

**`roadtx`** prend en charge **l'importation des identifiants et des informations MFA bas√©es sur TOTP √† partir d'un fichier kdbx** (fichier KeePass) ou d'une exportation XML KeePass. Pour cela, utilisez la commande **`roadtx keepassauth`**. Elle accepte un fichier **KeePass** avec le param√®tre **`-kp`** ou, si vous omettez ce param√®tre, elle essaie de charger `roadtx.kdbx` depuis le r√©pertoire courant. Le **mot de passe** du fichier KeePass peut √™tre sp√©cifi√© avec **`-kpp`** ou via la variable d'environnement `KPPASS`. Le seul param√®tre **obligatoire** est le **nom d'utilisateur**, qu'il recherchera dans le fichier KeePass. Il remplira automatiquement le mot de passe et √©galement le code OTP si "Mobile app OTP" est activ√© comme m√©thode MFA sur le compte. Cela n√©cessite que la graine TOTP soit stock√©e dans le param√®tre suppl√©mentaire `otp` de l'identit√© dans le fichier KeePass. Pour des instructions sur comment configurer cela et quelques mises en garde concernant l'utilisation des fichiers KeePass, consultez le [wiki roadtx](https://github.com/dirkjanm/ROADtools/wiki/ROADtools-Token-eXchange-(roadtx)).

Consultez la [**d√©monstration vid√©o**](https://dirkjanm.io/assets/video/selenium_kpautofill.mp4).

Outre la demande directe de jetons, vous pouvez √©galement utiliser cela comme une fen√™tre de navigateur interactive avec authentification automatique. Pour ce faire, sp√©cifiez manuellement une URL qui vous redirigera vers la page de connexion de Microsoft. Par exemple, en utilisant `-url https://myaccount.microsoft.com`, cela ouvrira un navigateur, vous authentifiera et vous dirigera vers la page "Mon compte". Vous pouvez utiliser `--keep-open` pour garder la fen√™tre du navigateur ouverte apr√®s l'authentification, ce qui permet de naviguer vers d'autres pages avec une perspective authentifi√©e. Exemple :

{% code overflow="wrap" %}
```bash
roadtx keepassauth -url https://myaccount.microsoft.com --keep-open -u myuser@mytenant.com -kp accounts.kdbx -kpp keepassfilepassword
```
{% endcode %}

### Authentification PRT dans le navigateur <a href="#primary-refresh-token-authentication-in-browser" id="primary-refresh-token-authentication-in-browser"></a>

Un sc√©nario plus int√©ressant consiste √† utiliser un Jeton d'Actualisation Primaire que vous avez soit enregistr√© vous-m√™me, soit que vous avez [vol√© √† un point de terminaison l√©gitime](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/) lors d'une op√©ration de red team pour cr√©er une exp√©rience de navigateur interactive. Supposons que nous avons **extrait un PRT et une cl√© de session en utilisant Mimikatz d'un point de terminaison** (ceci est seulement possible s'il n'utilise pas un Module de Plateforme Fiable). Nous pouvons utiliser ce PRT en ligne de commande, ou nous pouvons automatiquement l'injecter dans notre session de navigateur Selenium. roadtx fait cela en proxyant le trafic du navigateur √† travers lui-m√™me et en injectant un cookie PRT √† diff√©rents moments pendant l'authentification. Sur le point de terminaison victime, nous pouvons utiliser Mimikatz pour extraire le PRT et la cl√© de session.

Vous pouvez **v√©rifier les commandes** pour extraire le PRT et la cl√© de session, puis utiliser les valeurs avec **`roadtx`** dans [**l'Option 2 de la m√©thode mimikatz pour Passer le PRT**](pass-the-prt.md#attack-mimikatz)**.**

### Utilisation du PRT avec d'autres comptes <a href="#primary-refresh-token-usage-with-other-accounts" id="primary-refresh-token-usage-with-other-accounts"></a>

Un cas d'utilisation int√©ressant pour les Jetons d'Actualisation Primaire vol√©s est que vous pouvez √©galement **les utiliser pour d'autres comptes afin d'ajouter des revendications d'appareil** √† l'authentification. Par exemple, si une politique d'acc√®s conditionnel exige un appareil d'entreprise conforme ou joint en hybride pour acc√©der √† des ressources sp√©cifiques, la revendication d'appareil provient du jeton d'actualisation primaire utilis√© pendant l'authentification. Cette revendication peut √©galement √™tre utilis√©e pour d'autres utilisateurs. Donc, si j'ai un **PRT vol√© d'un appareil conforme** pour l'utilisateur `tpmtest@iminyour.cloud`, je peux utiliser ce **PRT avec les identifiants de `newlowpriv@iminyour.cloud`** pour me connecter et passer le test de conformit√©.

Dans cet exemple, nous avons toujours le PRT vol√© de `tpmtest@iminyour.cloud` utilis√© dans l'exemple ci-dessus enregistr√© sous `roadtx.prt`. Je peux utiliser ce **PRT avec les identifiants de `newlowpriv`** qui sont stock√©s dans mon fichier KeePass pour me connecter √† Microsoft Teams et acc√©der aux donn√©es l√†-bas avec la commande `roadtx browserprtinject`.
```bash
roadtx browserprtinject -u newlowpriv@iminyour.cloud -r msgraph -c msteams
```
Le jeton d'acc√®s √©mis contiendra la revendication `deviceid`, qui est l'appareil √† partir duquel nous avons vol√© le PRT. √âtant donn√© que cet appareil est g√©r√© par Intune et conforme, il passe l'exigence de conformit√© :

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Ajout de revendications MFA √† un PRT existant <a href="#adding-mfa-claims-to-an-existing-prt" id="adding-mfa-claims-to-an-existing-prt"></a>

Revenant aux PRT que nous avons vol√©s et retournant au PRT que nous avons enregistr√© plus t√¥t en utilisant une combinaison nom d'utilisateur + mot de passe. Si nous voulons avoir un **PRT avec revendication MFA, nous devons utiliser une session interactive** qui demandera un jeton d'actualisation sp√©cial d'Azure AD pour ¬´ enrichir ¬ª notre PRT. La commande pour cela est **`roadtx prtenrich`**, qui, comme les commandes pr√©c√©dentes, accepte une identit√© dans un fichier KeePass pour remplir automatiquement les informations MFA, ou vous pouvez le faire manuellement.
```bash
roadtx prtenrich -u newlowpriv@iminyour.cloud
Got refresh token. Can be used to request prt with roadtx prt -r <refreshtoken>
```
Le r√©sultat est un jeton d'actualisation sp√©cial que nous pouvons utiliser pour demander un nouveau PRT. Pour cela, nous revenons au module `roadtx prt` :
```bash
roadtx prt -r <refreshtoken> -c blogdevice.pem -k blogdevice.key
```
Le nouveau PRT est √©crit sur le disque et lorsque nous l'utilisons pour demander des jetons, nous voyons la revendication MFA :

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Nous pouvons utiliser ce PRT pour obtenir des jetons pour des ressources qui n√©cessitent MFA en utilisant l'une des m√©thodes ci-dessus.

### SSO en utilisant Chrome et un browsercore personnalis√© <a href="#single-sign-on-in-windows-using-chrome-and-a-custom-browsercore" id="single-sign-on-in-windows-using-chrome-and-a-custom-browsercore"></a>

Dans la page suivante, vous avez des informations sur la mani√®re dont Google Chrome utilise **`browsercore.exe`** pour s'authentifier via SSO :

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

**`roadtx`** poss√®de `browsercore.py`, vous pouvez utiliser un PTR de **`roadtx`** (ou un que vous avez vol√© ailleurs) pour vous authentifier automatiquement dans votre navigateur Chrome sur votre h√¥te contr√¥l√© par l'attaquant. Vous n'avez pas besoin d'avoir une fen√™tre Selenium, mais pouvez utiliser le PRT directement comme si vous √©tiez sur la machine de la victime dans un navigateur l√©gitime.

Le SSO personnalis√© n√©cessite quelques √©tapes pour la configuration :

* Vous devez placer les fichiers `browsercore.py` et `manifest.json` [files](https://github.com/dirkjanm/ROADtools/tree/master/browsercore) dans un emplacement sur le disque, par exemple dans `C:\browsercore\`.
* Installez roadtx et placez un fichier `roadtx.prt` dans le m√™me r√©pertoire.
* Modifiez `HKEY_CURRENT_USER\Software\Google\Chrome\NativeMessagingHosts\com.microsoft.browsercore` pour pointer vers `C:\browsercore\manifest.json`.
* Testez si tout fonctionne en utilisant `bctest.py`
* Effacez tous les cookies existants dans Chrome pour `login.microsoftonline.com`

Les instructions compl√®tes d'installation sont sur le [wiki ROADtools](https://github.com/dirkjanm/ROADtools/wiki/Setting-up-BrowserCore.py). Apr√®s la configuration, Chrome devrait utiliser le PRT automatiquement lors de la connexion. La premi√®re fois, il peut n√©cessiter un indice pour le nom d'utilisateur pour fonctionner correctement.

Avec cette configuration, vous pouvez naviguer sur n'importe quelle ressource connect√©e √† Azure AD avec SSO et les revendications du PRT, y compris le statut de l'appareil et les informations MFA mises en cache.

## Autres utilitaires <a href="#other-utilities" id="other-utilities"></a>

Il y a quelques autres utilitaires dans roadtx, principalement pour faciliter mes propres recherches :

* `roadtx decrypt` peut d√©chiffrer les r√©ponses chiffr√©es √©tant donn√© une cl√© de session PRT ou une cl√© de transport d'appareil
* `roadtx getotp` peut calculer un code OTP √† partir d'une graine ou de la propri√©t√© otp stock√©e dans un fichier KeePass (si vous devez faire MFA pour cet utilisateur)
* `roadtx codeauth` peut effectuer le flux de rachat de code OAuth2 pour les clients publics et confidentiels.
* `roadtx listaliases` liste tous les alias pris en charge pour les ressources et les clients. Si vous avez besoin d'autres alias que vous utilisez fr√©quemment, n'h√©sitez pas √† ouvrir un probl√®me ou √† m'envoyer un message.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
