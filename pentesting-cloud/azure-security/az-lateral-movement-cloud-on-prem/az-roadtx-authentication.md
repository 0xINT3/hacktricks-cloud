# Az - Roadtx - 認証

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

**以下の投稿は** [**https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/**](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/) **からコピーされました**

## 基本情報

ROADtools Token eXchange (roadtx) は、**異なるタイプのAzure ADが発行したトークンを交換し使用するためのツール**です。多くの異なる認証フロー、デバイス登録、PRT関連の操作をサポートしています。

以下の機能を実行できます:

* Azure ADにデバイスを登録し参加させる。
* ユーザーの資格情報や他の有効なトークンからプライマリリフレッシュトークンを要求する。
* WindowsのWeb Account Manager (WAM) が行うようにプライマリリフレッシュトークンを使用する。
* あらゆる種類のOauth2トークン償還フローを実行する。
* プライマリリフレッシュトークンを認証フローに注入することで、ブラウザSSOに基づく対話型ログインを実行する。
* Windows 10アカウントプラグインとカスタムbrowsercore実装を介してChromeにSSO機能を追加する。
* Seleniumを使用してAzure ADのさまざまなリソースへのサインイン、MFA、トークン要求を自動化する。
* 自動化されたフローで使用するために、KeePassデータベースから資格情報とMFA TOTPシードをロードする可能性。

## デバイスの登録

roadtxのほとんどのモジュールは、プライマリリフレッシュトークンとデバイスのアイデンティティを中心に設計されています。**PRTを取得するには、まずAzure ADにデバイスを登録する必要があります**。\
デバイスを登録するには、デバイス登録サービスリソースへの**アクセストークン**が**必要です**。アクセストークンは**デバイスクレームを持たないトークン**でなければならず、シングルサインオンや既存のPRTを使用して要求することはできません。roadtxでこのようなトークンを取得する**いくつかの方法があります**が、その中にはMFAをサポートするものとそうでないものがあります。\
**デバイスを登録するためにMFAが必要かどうかは、テナントの設定によります**。もし必要でなければ、ユーザー名とパスワードのみでデバイス登録サービス（ここでは_devicereg_エイリアスを通じて指定）のトークンを要求できます：
```bash
roadtx gettokens -u myuser@mytenant.com -p password -r devicereg
```
MFAが必要な場合、以下のようにデバイス認証フローを使用して、**どこかのブラウザウィンドウ**からトークンをリクエストできます：
```bash
roadtx gettokens --device-auth -r devicereg
```
代わりに、ユーザー名とパスワードを自動入力しながら、**SeleniumベースのウィンドウをMFAに使用します**：
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password -r devicereg
```
上記のコマンドのいずれかで**アクセストークンを `.roadtools_auth` ファイルに保存します**。デバイス登録コマンドは自動的にこのファイルから読み込みます。`roadtx device` モジュールへのさまざまなコマンドラインパラメータを使用して、デバイスのプロパティをカスタマイズできます：

<figure><img src="../../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

名前が “blogdevice” のAzure ADに参加しているデバイスを登録します：
```bash
roadtx device -n blogdevice
Saving private key to blogdevice.key
Registering device
Device ID: 5f138d8b-6416-448d-89ef-9b279c419943
Saved device certificate to blogdevice.pem
```
私たちはデバイスを識別する2つのデータを取得します。1つ目はAzure ADによって発行され、**デバイスを識別する** **デバイス証明書**で、`blogdevice.pem`に保存されています。2つ目は証明書の**秘密鍵**を含む`blogdevice.key`ファイルで、これもトランスポートキーとして使用されます。デバイス証明書を手に入れたので、**デバイスの身元が必要な操作**を行うことができます。最も有用なのは**プライマリリフレッシュトークンの要求**です。これにより、私たちの（対話型または自動化された）トークン要求にシングルサインオン機能を追加することができます。

## プライマリリフレッシュトークンの要求 <a href="#requesting-a-primary-refresh-token" id="requesting-a-primary-refresh-token"></a>

プライマリリフレッシュトークンは、通常、ユーザー名とパスワードで要求されます。Azure ADに参加している、またはハイブリッドに参加しているワークステーションに**ユーザー名とパスワード**でログインすると、WindowsはすぐにAzure ADから**PRTを要求**します。このフローの背後にある技術的な詳細については、過去にTroopersやRomhackでの[トーク](https://dirkjanm.io/talks/)で話しましたので、興味があればそれらのスライドを読んでみてください。**roadtxでPRTを要求するには、`roadtx prt`コマンドを実行し**、デバイス証明書/キーと使用するユーザー名 + パスワードを指定すると、PRTが取得できます：

{% code overflow="wrap" %}
```bash
roadtx prt -u myuser@mytenant.com -p password --key-pem blogdevice.key --cert-pem blogdevice.pem
```
{% endcode %}

このコマンドは、**PRT**（暗号化されたトークンの形式で）と、PRTを使用するために必要な**セッションキー**を提供します。PRTはデフォルトで`roadtx.prt`に保存され、他のroadtxモジュールから取得できます。

PRTはデフォルトで90日間有効ですが、`renew`アクションを使用していつでも更新し、さらに90日間有効期間を延長することができます：
```bash
roadtx prt -a renew
Renewing PRT
Saved PRT to roadtx.prt
```
以下は、パスワードに基づいて要求されたPRTであるため、**MFAが必要な認証は、PRTを使用しても失敗します**。次のセクションのSeleniumベースの認証で示されているように、MFAクレームでPRTをアップグレードまたは「豊かに」することもできます。

## コマンドラインでのプライマリリフレッシュトークンの使用 <a href="#using-primary-refresh-tokens-on-the-command-line" id="using-primary-refresh-tokens-on-the-command-line"></a>

PRTを取得したら、**Azure AD認証を受け入れるリソースにサインインする**ために使用できます。これは、コマンドラインで**`roadtx gettokens`** コマンドを使用し、PRTとセッションキーを**指定するか、**`roadtx prtauth`** コマンドを使用して行うことができます。2つの違いは、**`gettokens`** コマンドはブラウザ内でChromeがシングルサインオンを行う方法に**基づいて認証を実装していることです。この方法は少しハッキーで、失敗した場合にはフィードバックを提供しません。

代わりに**`prtauth`** モジュールは、アプリやネイティブプロセスからアクセストークンを要求する場合にWindowsが使用する**Webアカウントマネージャー（WAM）をエミュレートします**。WAMはトークンブローカーのように機能し、他のクライアントの代わりにトークンを要求します。トークンが転送中に露出するのを防ぐために、署名されたリクエストと暗号化されたレスポンスの組み合わせを使用し、すべてPRTセッションキーを使用して行われます。

デフォルトでは、`roadtx prtauth` モジュールは**Azure AD PowerShellモジュールクライアントID**とAzure ADグラフをリソースとして使用しますが、フルパートまたはエイリアスとして（`roadtx listaliases`でリスト可能）任意の他のクライアントIDまたはリソースURLを指定することができます：
```bash
roadtx prtauth
Tokens were written to .roadtools_auth
```
Azure CLIをクライアントIDとして使用し、Azure Resource Managerのトークンを要求する例：
```bash
roadtx prtauth -c azcli -r azrm
Tokens were written to .roadtools_auth
```
以下は、アプリに使用する他のリソースを指定するため、または正しいリダイレクトURLを指定するために使用できる他のオプションです：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## SeleniumベースのAzure AD認証 <a href="#selenium-based-azure-a-d-authentication" id="selenium-based-azure-a-d-authentication"></a>

コマンドラインベースのトークンリクエストと使用は便利ですが、ブラウザウィンドウを使用して多要素認証を行う必要があるフローに遭遇することがよくあります。または、単に盗まれたPRTを使用してAzureポータルをブラウズしたり、メールを読んだりするなど、対話的な方法でPRTを使用したいと思うかもしれません。

roadtxにおけるSeleniumベースの操作の原理はシンプルです：**ブラウザウィンドウを起動し、コマンドに指定した資格情報を自動入力しようとし、残りは手動で入力させます**。アカウントが正しく設定されていれば、認証を完全に自動的に行います。

### 対話型認証 <a href="#interactive-authentication" id="interactive-authentication"></a>

最もシンプルな形では、roadtxはブラウザを起動し、指定されたサービスのトークンを要求し、指定された資格情報を入力し、トークンを取得します。例：
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password
```
**MFA** が必要な場合は、それを入力して MFA クレームを含むトークンを取得できます。そうでない場合は、出力をキャプチャして要求されたトークンを保存します。`-c` で使用したい **クライアント ID** を、`-r` で認証するリソースを指定できます。こちらは[**短いビデオデモ**](https://dirkjanm.io/assets/video/selenium\_autofill.mp4)です。

### KeePass を使用して異なるアカウントで認証する <a href="#keepass-credentials-based-authentication" id="keepass-credentials-based-authentication"></a>

**`roadtx`** は、kdbx ファイル（KeePass ファイル）または KeePass XML エクスポートからの **資格情報と TOTP ベースの MFA 情報の取得をサポートしています**。これを使用するには、**`roadtx keepassauth`** コマンドを使用します。**KeePass** ファイルは **`-kp`** パラメータで指定するか、このパラメータを省略すると現在のディレクトリから `roadtx.kdbx` を読み込もうとします。KeePass ファイルの **パスワード** は **`-kpp`** で指定するか、`KPPASS` 環境変数を介して指定できます。唯一 **必要な** パラメータは **ユーザー名** で、これは KeePass ファイルで検索されます。パスワードと、アカウントで「モバイルアプリ OTP」が MFA 方法として有効になっている場合は OTP コードも自動入力されます。これには、KeePass ファイルのアイデンティティの `otp` 追加パラメータに TOTP シードが保存されている必要があります。KeePass ファイルの設定方法と使用時の注意点については、[roadtx wiki](https://github.com/dirkjanm/ROADtools/wiki/ROADtools-Token-eXchange-\(roadtx\)) を参照してください。

[**ビデオデモ**](https://dirkjanm.io/assets/video/selenium\_kpautofill.mp4)をチェックしてください。

トークンを直接リクエストするだけでなく、自動認証付きのインタラクティブなブラウザウィンドウとしても使用できます。これを行うには、Microsoft サインインページにリダイレクトする URL を手動で指定します。例えば、`-url https://myaccount.microsoft.com` を使用すると、ブラウザが開き、認証され、「マイアカウント」ページに移動します。認証後にブラウザウィンドウを開いたままにするには `--keep-open` を使用でき、認証された視点から他のページに移動することが可能になります。例:

{% code overflow="wrap" %}
```bash
roadtx keepassauth -url https://myaccount.microsoft.com --keep-open -u myuser@mytenant.com -kp accounts.kdbx -kpp keepassfilepassword
```
{% endcode %}

### ブラウザでのPRT認証 <a href="#primary-refresh-token-authentication-in-browser" id="primary-refresh-token-authentication-in-browser"></a>

より興味深いシナリオは、自分で登録した、またはレッドチームの間に[正当なエンドポイントから盗んだ](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)プライマリリフレッシュトークン（PRT）を使用してインタラクティブなブラウザ体験を作成することです。**エンドポイントからMimikatzを使用してPRTとセッションキーをダンプした**としましょう（これはTrusted Platform Moduleを使用していない場合にのみ可能です）。このPRTをコマンドラインで使用することも、Seleniumブラウザセッションに自動的に注入することもできます。roadtxは、ブラウザトラフィックを自身を通じてプロキシし、認証中に様々なポイントでPRTクッキーを注入することでこれを行います。被害者のエンドポイントでは、Mimikatzを使用してPRTとセッションキーをダンプすることができます。

**`roadtx`** を使用してPRTとセッションキーをダンプし、その値を使用する**コマンドを確認**するには、[**mimikatzメソッドのオプション2でPRTを渡す**](pass-the-prt.md#attack-mimikatz)**を参照してください。**

### 他のアカウントでのPRT使用 <a href="#primary-refresh-token-usage-with-other-accounts" id="primary-refresh-token-usage-with-other-accounts"></a>

盗まれたプライマリリフレッシュトークンを使用する興味深いユースケースは、**他のアカウントにデバイスクレームを追加するためにそれらを使用する**こともできるということです。例えば、特定のリソースにアクセスするために準拠したデバイスまたはハイブリッドジョインされた企業デバイスが必要とする条件付きアクセスポリシーがある場合、デバイスクレームは認証中に使用されるプライマリリフレッシュトークンから発生します。このクレームは他のユーザーにも使用できます。したがって、準拠したデバイスの**盗まれたPRTを持っている**場合、例えば`tpmtest@iminyour.cloud`のユーザーの場合、この**PRTを`newlowpriv@iminyour.cloud`の資格情報と共に使用して**サインインし、準拠テストを通過することができます。

この例では、上記の例で使用された`tpmtest@iminyour.cloud`から盗まれたPRTを`roadtx.prt`として保存しています。私はこの**PRTと、私のKeePassファイルに保存されている`newlowpriv`の資格情報を一緒に使用して**、`roadtx browserprtinject`コマンドを使用してMicrosoft Teamsにサインインし、そこでデータにアクセスすることができます。
```bash
roadtx browserprtinject -u newlowpriv@iminyour.cloud -r msgraph -c msteams
```
発行されたアクセストークンには、盗んだPRTのデバイスである`deviceid`クレームが含まれます。このデバイスはIntuneで管理され、準拠しているため、準拠要件を満たします：

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 既存のPRTにMFAクレームを追加する <a href="#adding-mfa-claims-to-an-existing-prt" id="adding-mfa-claims-to-an-existing-prt"></a>

盗んだPRTから離れて、以前にユーザー名+パスワードの組み合わせを使用して登録したPRTに戻ります。**MFAクレームを持つPRTが必要な場合、特別なリフレッシュトークンをAzure ADから要求するインタラクティブセッションを使用する必要があります**。これを行うコマンドは**`roadtx prtenrich`**で、前のコマンドと同様に、KeePassファイルのアイデンティティを受け入れてMFA情報を自動入力するか、手動で行うことができます。
```bash
roadtx prtenrich -u newlowpriv@iminyour.cloud
Got refresh token. Can be used to request prt with roadtx prt -r <refreshtoken>
```
結果は、新しいPRTを要求するために使用できる特別なリフレッシュトークンです。これには、`roadtx prt` モジュールに戻ります：
```bash
roadtx prt -r <refreshtoken> -c blogdevice.pem -k blogdevice.key
```
新しいPRTはディスクに書き込まれ、トークンを要求するときにMFAクレームが表示されます：

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

このPRTを使用して、上記の方法のいずれかを使用してMFAが必要なリソースのトークンを取得できます。

### Chromeとカスタムbrowsercoreを使用したSSO <a href="#single-sign-on-in-windows-using-chrome-and-a-custom-browsercore" id="single-sign-on-in-windows-using-chrome-and-a-custom-browsercore"></a>

次のページには、Google Chromeが**`browsercore.exe`** を使用してSSO経由で認証する方法についての情報があります：

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

**`roadtx`** には`browsercore.py`があり、攻撃者が制御するホスト上のChromeブラウザで自動的に認証するために、**`roadtx`** のPTR（または他の場所で盗んだもの）を使用できます。Seleniumウィンドウを持つ必要はありませんが、正当なブラウザで被害者のマシンにいるかのように直接PRTを使用できます。

カスタムSSOの設定にはいくつかのステップが必要です：

* `browsercore.py`と`manifest.json`[ファイル](https://github.com/dirkjanm/ROADtools/tree/master/browsercore)をディスク上の何らかの場所に配置します。例えば、`C:\browsercore\`に。
* roadtxをインストールし、同じディレクトリに`roadtx.prt`ファイルを配置します。
* `HKEY_CURRENT_USER\Software\Google\Chrome\NativeMessagingHosts\com.microsoft.browsercore`を`C:\browsercore\manifest.json`を指すように変更します。
* `bctest.py`を使用してすべてが正常に動作するかテストします。
* `login.microsoftonline.com`のChromeで既存のクッキーをクリアします。

完全なインストール手順は[ROADtools wiki](https://github.com/dirkjanm/ROADtools/wiki/Setting-up-BrowserCore.py)にあります。セットアップ後、Chromeはサインイン中に自動的にPRTを使用するはずです。最初はユーザー名のヒントが適切に機能するために必要になるかもしれません。

このセットアップを使用すると、デバイスのステータスとキャッシュされたMFA情報を含むPRTのクレームを使用して、Azure ADに接続されたリソースをSSOで閲覧できます。

## その他のユーティリティ <a href="#other-utilities" id="other-utilities"></a>

roadtxには、主に私自身の研究を容易にするためのいくつかの他のユーティリティがあります：

* `roadtx decrypt`は、PRTセッションキーまたはデバイストランスポートキーを使用して暗号化された応答を復号化できます。
* `roadtx getotp`は、シードまたはKeePassファイルに保存されたotpプロパティからOTPコードを計算できます（そのユーザーのMFAを行う必要がある場合）。
* `roadtx codeauth`は、公開クライアントと機密クライアントのOAuth2コード償還フローを実行できます。
* `roadtx listaliases`は、リソースとクライアントに対応するすべてのエイリアスをリストします。頻繁に使用する他のエイリアスが必要な場合は、問題を開いたり私にメッセージを送ったりしてください。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加するか**、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>
