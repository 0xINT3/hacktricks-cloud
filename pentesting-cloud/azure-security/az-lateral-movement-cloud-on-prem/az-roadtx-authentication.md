# Az - Roadtx - Autentica√ß√£o

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Post copiado de** [**https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/**](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Informa√ß√µes B√°sicas

ROADtools Token eXchange (roadtx) √© uma ferramenta para **trocar e usar diferentes tipos de tokens emitidos pelo Azure AD**. Ela suporta muitos fluxos de autentica√ß√£o diferentes, registro de dispositivos e opera√ß√µes relacionadas ao PRT.

Ela pode fazer o seguinte:

* Registrar e associar dispositivos ao Azure AD.
* Solicitar Tokens de Atualiza√ß√£o Prim√°rios a partir de credenciais de usu√°rio ou outros tokens v√°lidos.
* Usar Tokens de Atualiza√ß√£o Prim√°rios de maneira semelhante ao Gerenciador de Contas Web (WAM) no Windows.
* Realizar todos os tipos de fluxos de resgate de tokens Oauth2.
* Realizar logins interativos baseados em SSO do navegador, injetando o Token de Atualiza√ß√£o Prim√°rio no fluxo de autentica√ß√£o.
* Adicionar capacidades de SSO ao Chrome atrav√©s do plugin de contas do Windows 10 e uma implementa√ß√£o personalizada do browsercore.
* Automatizar logins, MFA e solicita√ß√µes de tokens para v√°rios recursos no Azure AD usando Selenium.
* Possibilidade de carregar credenciais e sementes TOTP de MFA de um banco de dados KeePass para usar em fluxos automatizados.

## Registrando um dispositivo

A maioria dos m√≥dulos do roadtx √© projetada em torno de Tokens de Atualiza√ß√£o Prim√°rios e identidades de dispositivos. **Para obter um PRT, primeiro devemos registrar um dispositivo no Azure AD**.\
Registrar um dispositivo **requer** um **token de acesso** ao recurso de servi√ßo de registro de dispositivo. O token de acesso deve ser um **token sem uma reivindica√ß√£o de dispositivo**, ent√£o voc√™ n√£o pode usar single sign-on ou um PRT existente para solicitar um. Existem **algumas maneiras de obter tal token com o roadtx**, onde alguns m√©todos suportam MFA e outros n√£o.\
**MFA pode ser necess√°rio para registrar um dispositivo, dependendo das configura√ß√µes do tenant**. Se n√£o for, voc√™ pode solicitar um token para o servi√ßo de registro de dispositivo (especificado aqui atrav√©s do alias _devicereg_) apenas com um nome de usu√°rio e senha:
```bash
roadtx gettokens -u myuser@mytenant.com -p password -r devicereg
```
Se o MFA for necess√°rio, voc√™ pode usar o fluxo de autentica√ß√£o de dispositivo para solicitar os tokens de uma **janela do navegador em algum lugar**:
```bash
roadtx gettokens --device-auth -r devicereg
```
Alternativamente, usamos uma **janela baseada em Selenium para MFA**, enquanto preenchemos automaticamente o nome de usu√°rio + senha:
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password -r devicereg
```
Qualquer um dos comandos acima **salvar√° um token de acesso no arquivo `.roadtools_auth`**. O comando de registro de dispositivo carregar√° automaticamente dele. Voc√™ pode personalizar as propriedades do dispositivo que deseja com v√°rios par√¢metros de linha de comando para o m√≥dulo `roadtx device`:

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Registramos um dispositivo associado ao Azure AD com o nome ‚Äúblogdevice‚Äù:
```bash
roadtx device -n blogdevice
Saving private key to blogdevice.key
Registering device
Device ID: 5f138d8b-6416-448d-89ef-9b279c419943
Saved device certificate to blogdevice.pem
```
Obtemos dois dados que identificam nosso dispositivo: O primeiro √© o **certificado do dispositivo** salvo em `blogdevice.pem`, que √© emitido pelo Azure AD e **identifica nosso dispositivo**. A segunda parte √© o arquivo `blogdevice.key`, que cont√©m a **chave privada do certificado** e tamb√©m √© usada como chave de transporte. Agora que temos o certificado do dispositivo, podemos realizar **opera√ß√µes que requerem uma identidade de dispositivo**. A mais √∫til √© **solicitar um Primary Refresh Token**, pois isso nos permitir√° adicionar capacidades de Single Sign On √†s nossas solicita√ß√µes de token (interativas ou automatizadas).

## Solicitando um Primary Refresh Token <a href="#requesting-a-primary-refresh-token" id="requesting-a-primary-refresh-token"></a>

Um primary refresh token √© mais frequentemente solicitado com um nome de usu√°rio e senha. Quando voc√™ faz login em uma esta√ß√£o de trabalho unida ao Azure AD ou h√≠brida com seu **nome de usu√°rio e senha**, o Windows imediatamente **solicita um PRT** do Azure AD. Eu falei sobre as tecnicidades por tr√°s desse fluxo nas minhas palestras no Troopers e Romhack [talks](https://dirkjanm.io/talks/) no passado, ent√£o se voc√™ est√° interessado nas tecnicidades, d√™ uma olhada nesses slides. **Para solicitar um PRT com roadtx, execute o comando `roadtx prt`**, especifique o certificado/chave do dispositivo e o nome de usu√°rio + senha a serem usados, e voc√™ obter√° um PRT:

{% code overflow="wrap" %}
```bash
roadtx prt -u myuser@mytenant.com -p password --key-pem blogdevice.key --cert-pem blogdevice.pem
```
{% endcode %}

O comando nos fornecer√° um **PRT** (na forma de um token criptografado) e uma **chave de sess√£o** que precisamos para usar o PRT. Por padr√£o, o PRT √© salvo em `roadtx.prt`, de onde pode ser utilizado por outros m√≥dulos do roadtx.

Um PRT √© v√°lido por padr√£o por 90 dias, mas podemos **renov√°-lo a qualquer momento** para estender a validade por mais 90 dias com a a√ß√£o `renew`:
```bash
roadtx prt -a renew
Renewing PRT
Saved PRT to roadtx.prt
```
Note que o PRT que solicitamos aqui √© baseado apenas em uma senha, ent√£o **qualquer autentica√ß√£o que requeira MFA falhar√° mesmo se usarmos o PRT**. Tamb√©m podemos atualizar ou "enriquecer" o PRT com uma declara√ß√£o de MFA, isso √© mostrado na pr√≥xima se√ß√£o sobre autentica√ß√£o baseada em Selenium.

## Usando Tokens de Atualiza√ß√£o Prim√°rios na linha de comando <a href="#using-primary-refresh-tokens-on-the-command-line" id="using-primary-refresh-tokens-on-the-command-line"></a>

Uma vez que temos um PRT, podemos us√°-lo para **entrar em recursos que aceitam autentica√ß√£o Azure AD**. Voc√™ pode fazer isso com o comando **`roadtx gettokens`**, e **especificar o PRT e a chave de sess√£o** na linha de comando, ou usar o comando **`roadtx prtauth`**. A diferen√ßa entre os dois √© que o comando **`gettokens`** implementa autentica√ß√£o que √© **baseada em como o Chrome faz Single Sign On** no navegador. Este m√©todo √© um pouco improvisado e, se falhar, n√£o fornecer√° nenhum feedback.

O m√≥dulo **`prtauth`** em vez disso emula o **Web Account Manager (WAM) que o Windows** usa se voc√™ solicitar tokens de acesso de um aplicativo ou processo nativo. O WAM atua como um corretor de tokens e solicita tokens em nome de outros clientes. Ele usa uma combina√ß√£o de solicita√ß√µes assinadas e respostas criptografadas para evitar a exposi√ß√£o dos tokens em tr√¢nsito, tudo feito usando a chave de sess√£o PRT.

Por padr√£o, o m√≥dulo `roadtx prtauth` usar√° o **ID do cliente do M√≥dulo PowerShell Azure AD** e o gr√°fico Azure AD como recurso, mas voc√™ pode especificar qualquer outro ID de cliente ou URL de recurso, seja por sua parte completa ou como um alias (list√°vel com `roadtx listaliases`):
```bash
roadtx prtauth
Tokens were written to .roadtools_auth
```
Exemplo usando o Azure CLI como ID do cliente e solicitando tokens para o Azure Resource Manager:
```bash
roadtx prtauth -c azcli -r azrm
Tokens were written to .roadtools_auth
```
Tamb√©m existem outras op√ß√µes que voc√™ pode usar para especificar outros recursos ou a URL de redirecionamento correta para o aplicativo que voc√™ est√° usando:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Autentica√ß√£o Azure AD baseada em Selenium <a href="#selenium-based-azure-a-d-authentication" id="selenium-based-azure-a-d-authentication"></a>

Comandos de linha de comando para solicita√ß√£o e uso de tokens s√£o √∫teis, mas frequentemente voc√™ encontrar√° algum fluxo que exige uma janela de navegador para realizar a Autentica√ß√£o de M√∫ltiplos Fatores, ou simplesmente deseja usar seu PRT de maneira interativa para navegar em coisas como o Portal Azure ou ler seus e-mails usando um PRT roubado.

O princ√≠pio das opera√ß√µes baseadas em Selenium no roadtx √© simples: **ele lan√ßa uma janela de navegador, tenta preencher automaticamente quaisquer credenciais que voc√™ forneceu ao comando e permite que voc√™ complete o restante manualmente**. Se suas contas estiverem configuradas corretamente, ele far√° a autentica√ß√£o de forma totalmente autom√°tica.

### Autentica√ß√£o interativa <a href="#interactive-authentication" id="interactive-authentication"></a>

Na forma mais simples, o roadtx lan√ßar√° um navegador para voc√™, solicitar√° um token para o servi√ßo indicado, preencher√° quaisquer credenciais especificadas e obter√° tokens. Exemplo:
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password
```
Se o **MFA** for necess√°rio, voc√™ pode inseri-lo e obter um token com a reivindica√ß√£o MFA. Caso contr√°rio, ele capturar√° a sa√≠da e salvar√° os tokens solicitados. Voc√™ pode especificar o **client ID** que deseja usar com `-c` e o recurso para autenticar com `-r`. Aqui est√° um [**v√≠deo curto demonstrativo**](https://dirkjanm.io/assets/video/selenium_autofill.mp4).

### Usando KeePass para autenticar em diferentes contas <a href="#keepass-credentials-based-authentication" id="keepass-credentials-based-authentication"></a>

**`roadtx`** suporta **obten√ß√£o de credenciais e informa√ß√µes de MFA baseadas em TOTP de um arquivo kdbx** (arquivo KeePass) ou exporta√ß√£o XML do KeePass. Para usar isso, utilize o comando **`roadtx keepassauth`**. Ele aceita um arquivo **KeePass** com o par√¢metro **`-kp`** ou, se voc√™ n√£o usar este par√¢metro, tentar√° carregar `roadtx.kdbx` do diret√≥rio atual. A **senha** do arquivo KeePass pode ser especificada com **`-kpp`** ou atrav√©s da vari√°vel de ambiente `KPPASS`. O √∫nico par√¢metro **obrigat√≥rio** √© o **nome de usu√°rio**, que ser√° procurado no arquivo KeePass. Ele preencher√° automaticamente a senha e tamb√©m o c√≥digo OTP se "Mobile app OTP" estiver habilitado como m√©todo MFA na conta. Isso requer que a semente TOTP esteja armazenada no par√¢metro adicional `otp` da identidade no arquivo KeePass. Para instru√ß√µes sobre como configurar isso e algumas ressalvas ao usar arquivos KeePass, consulte a [wiki do roadtx](https://github.com/dirkjanm/ROADtools/wiki/ROADtools-Token-eXchange-(roadtx)).

Confira o [**v√≠deo demonstrativo**](https://dirkjanm.io/assets/video/selenium_kpautofill.mp4).

Al√©m de solicitar tokens diretamente, voc√™ tamb√©m pode usar isso como uma janela de navegador interativa com autentica√ß√£o autom√°tica. Para fazer isso, especifique manualmente uma URL que o redirecionar√° para a p√°gina de login da Microsoft. Por exemplo, usar `-url https://myaccount.microsoft.com` abrir√° um navegador, autenticar√° voc√™ e ir√° para a p√°gina "Minha conta". Voc√™ pode usar `--keep-open` para manter a janela do navegador aberta ap√≥s a autentica√ß√£o, o que possibilita navegar para outras p√°ginas a partir de uma perspectiva autenticada. Exemplo:

{% code overflow="wrap" %}
```bash
roadtx keepassauth -url https://myaccount.microsoft.com --keep-open -u myuser@mytenant.com -kp accounts.kdbx -kpp keepassfilepassword
```
{% endcode %}

### Autentica√ß√£o PRT no navegador <a href="#primary-refresh-token-authentication-in-browser" id="primary-refresh-token-authentication-in-browser"></a>

Um cen√°rio mais interessante √© usar um Token de Atualiza√ß√£o Prim√°rio que voc√™ registrou ou que voc√™ [roubou de um ponto final leg√≠timo](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/) durante um red team para criar uma experi√™ncia interativa no navegador. Vamos supor que **despejamos um PRT e chave de sess√£o usando Mimikatz de um ponto final** (isso s√≥ √© poss√≠vel se n√£o usar um M√≥dulo de Plataforma Confi√°vel). Podemos usar este PRT na linha de comando, ou podemos injet√°-lo automaticamente em nossa sess√£o de navegador Selenium. roadtx faz isso ao encaminhar o tr√°fego do navegador atrav√©s de si mesmo e injetando um cookie PRT em v√°rios pontos durante a autentica√ß√£o. No ponto final da v√≠tima, podemos usar Mimikatz para despejar o PRT e a chave de sess√£o.

Voc√™ pode **verificar os comandos** para despejar o PRT e a chave de sess√£o e depois usar os valores com **`roadtx`** na [**Op√ß√£o 2 do m√©todo mimikatz para Passar o PRT**](pass-the-prt.md#attack-mimikatz)**.**

### Uso do PRT com outras contas <a href="#primary-refresh-token-usage-with-other-accounts" id="primary-refresh-token-usage-with-other-accounts"></a>

Um caso de uso interessante para Tokens de Atualiza√ß√£o Prim√°rios roubados √© que voc√™ tamb√©m pode **us√°-los para outras contas para adicionar reivindica√ß√µes de dispositivo** √† autentica√ß√£o. Por exemplo, se houver uma pol√≠tica de acesso condicional que exija um dispositivo corporativo compat√≠vel ou h√≠brido para acessar recursos espec√≠ficos, a reivindica√ß√£o de dispositivo origina-se do token de atualiza√ß√£o prim√°rio usado durante a autentica√ß√£o. Esta reivindica√ß√£o tamb√©m pode ser usada para outros usu√°rios. Ent√£o, se eu tenho um **PRT roubado de um dispositivo compat√≠vel** para o usu√°rio `tpmtest@iminyour.cloud`, eu posso usar este **PRT com as credenciais de `newlowpriv@iminyour.cloud`** para entrar e passar no teste de conformidade.

Neste exemplo, ainda temos o PRT roubado de `tpmtest@iminyour.cloud` usado no exemplo acima salvo como `roadtx.prt`. Eu posso usar este **PRT junto com as credenciais de `newlowpriv`** que est√£o armazenadas no meu arquivo KeePass para entrar no Microsoft Teams e acessar dados l√° com o comando `roadtx browserprtinject`.
```bash
roadtx browserprtinject -u newlowpriv@iminyour.cloud -r msgraph -c msteams
```
O token de acesso emitido conter√° a declara√ß√£o `deviceid`, que √© o dispositivo do qual roubamos o PRT. Como este dispositivo √© gerenciado pelo Intune e est√° em conformidade, ele passa no requisito de conformidade:

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Adicionando declara√ß√µes MFA a um PRT existente <a href="#adding-mfa-claims-to-an-existing-prt" id="adding-mfa-claims-to-an-existing-prt"></a>

Voltando aos PRTs que roubamos e retornando ao PRT que registramos anteriormente usando uma combina√ß√£o de nome de usu√°rio + senha. Se quisermos ter um **PRT com declara√ß√£o MFA, temos que usar uma sess√£o interativa** que solicitar√° um token de atualiza√ß√£o especial do Azure AD para "enriquecer" nosso PRT. O comando para isso √© **`roadtx prtenrich`**, que, como os comandos anteriores, aceita uma identidade em um arquivo KeePass para preencher automaticamente as informa√ß√µes de MFA, ou voc√™ pode fazer isso manualmente.
```bash
roadtx prtenrich -u newlowpriv@iminyour.cloud
Got refresh token. Can be used to request prt with roadtx prt -r <refreshtoken>
```
O resultado √© um token de atualiza√ß√£o especial que podemos usar para solicitar um novo PRT. Para isso, voltamos ao m√≥dulo `roadtx prt`:
```bash
roadtx prt -r <refreshtoken> -c blogdevice.pem -k blogdevice.key
```
O novo PRT √© gravado no disco e, quando o usamos para solicitar tokens, vemos a reivindica√ß√£o MFA:

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Podemos usar este PRT para obter tokens para recursos que exigem MFA usando qualquer um dos m√©todos acima.

### SSO usando Chrome e um browsercore personalizado <a href="#single-sign-on-in-windows-using-chrome-and-a-custom-browsercore" id="single-sign-on-in-windows-using-chrome-and-a-custom-browsercore"></a>

Na p√°gina a seguir, voc√™ tem informa√ß√µes sobre como o Google Chrome usa **`browsercore.exe`** para autenticar via SSO:

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

**`roadtx`** possui `browsercore.py`, voc√™ pode usar um PTR do **`roadtx`** (ou um que voc√™ roubou em outro lugar) para autenticar automaticamente no seu navegador Chrome em seu host controlado pelo atacante. Voc√™ n√£o precisa ter uma janela do Selenium, mas pode usar o PRT diretamente como se estivesse na m√°quina da v√≠tima em um navegador leg√≠timo.

A configura√ß√£o do SSO personalizado requer alguns passos:

* Voc√™ deve colocar os arquivos `browsercore.py` e `manifest.json` [arquivos](https://github.com/dirkjanm/ROADtools/tree/master/browsercore) em algum local no disco, por exemplo, em `C:\browsercore\`.
* Instale roadtx e coloque um arquivo `roadtx.prt` no mesmo diret√≥rio.
* Modifique `HKEY_CURRENT_USER\Software\Google\Chrome\NativeMessagingHosts\com.microsoft.browsercore` para apontar para `C:\browsercore\manifest.json`.
* Teste se tudo funciona usando `bctest.py`
* Limpe quaisquer cookies existentes no Chrome para `login.microsoftonline.com`

Instru√ß√µes completas de instala√ß√£o est√£o no [ROADtools wiki](https://github.com/dirkjanm/ROADtools/wiki/Setting-up-BrowserCore.py). Ap√≥s a configura√ß√£o, o Chrome deve usar o PRT automaticamente durante o login. Na primeira vez, pode ser necess√°rio uma dica para o nome de usu√°rio funcionar corretamente.

Com essa configura√ß√£o, voc√™ pode navegar em qualquer recurso conectado ao Azure AD com SSO e as reivindica√ß√µes do PRT, incluindo status do dispositivo e informa√ß√µes de MFA em cache.

## Outras utilidades <a href="#other-utilities" id="other-utilities"></a>

Existem algumas outras utilidades em roadtx, principalmente para facilitar minha pr√≥pria pesquisa:

* `roadtx decrypt` pode descriptografar respostas criptografadas dado uma chave de sess√£o PRT ou uma chave de transporte de dispositivo
* `roadtx getotp` pode calcular um c√≥digo OTP a partir de uma semente ou da propriedade otp armazenada em um arquivo KeePass (se voc√™ precisar fazer MFA para esse usu√°rio)
* `roadtx codeauth` pode realizar o fluxo de resgate de c√≥digo OAuth2 para clientes p√∫blicos e confidenciais.
* `roadtx listaliases` lista todos os aliases que s√£o suportados para recursos e clientes. Se voc√™ precisar de outros aliases que usa com frequ√™ncia, sinta-se √† vontade para abrir um problema ou enviar-me uma mensagem.

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**merchandising oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
