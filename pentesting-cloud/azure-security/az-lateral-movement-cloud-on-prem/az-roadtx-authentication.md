# Az - Roadtx - Autenticaci칩n

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Post copiado de** [**https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/**](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## Informaci칩n B치sica

ROADtools Token eXchange (roadtx) es una herramienta para **intercambiar y utilizar diferentes tipos de tokens emitidos por Azure AD**. Soporta muchos flujos de autenticaci칩n diferentes, registro de dispositivos y operaciones relacionadas con PRT.

Puede hacer lo siguiente:

* Registrar y unir dispositivos a Azure AD.
* Solicitar Tokens de Actualizaci칩n Primarios a partir de credenciales de usuario u otros tokens v치lidos.
* Utilizar Tokens de Actualizaci칩n Primarios de manera similar a como lo hace el Administrador de Cuentas Web (WAM) en Windows.
* Realizar todo tipo de flujos de redenci칩n de tokens Oauth2.
* Realizar inicios de sesi칩n interactivos basados en SSO de navegador inyectando el Token de Actualizaci칩n Primario en el flujo de autenticaci칩n.
* A침adir capacidades de SSO a Chrome mediante el plugin de cuentas de Windows 10 y una implementaci칩n personalizada de browsercore.
* Automatizar inicios de sesi칩n, MFA y solicitudes de tokens para varios recursos en Azure AD utilizando Selenium.
* Posibilidad de cargar credenciales y semillas TOTP de MFA desde una base de datos de KeePass para usar en flujos automatizados.

## Registrando un dispositivo

La mayor칤a de los m칩dulos de roadtx est치n dise침ados en torno a Tokens de Actualizaci칩n Primarios e identidades de dispositivos. **Para obtener un PRT, primero debemos registrar un dispositivo en Azure AD**.\
Registrar un dispositivo **requiere** un **token de acceso** al recurso de servicio de registro de dispositivos. El token de acceso debe ser un **token sin una reclamaci칩n de dispositivo**, por lo que no puedes usar inicio de sesi칩n 칰nico o un PRT existente para solicitar uno. Hay **varias formas de obtener dicho token con roadtx**, donde algunos m칠todos soportan MFA y otros no.\
**Podr칤a ser necesario MFA para registrar un dispositivo, dependiendo de la configuraci칩n del inquilino**. Si no es as칤, puedes solicitar un token para el servicio de registro de dispositivos (especificado aqu칤 a trav칠s del alias _devicereg_) solo con un nombre de usuario y contrase침a:
```bash
roadtx gettokens -u myuser@mytenant.com -p password -r devicereg
```
Si se requiere MFA, puedes usar el flujo de autenticaci칩n de dispositivo para solicitar los tokens desde una **ventana de navegador en alg칰n lugar**:
```bash
roadtx gettokens --device-auth -r devicereg
```
Alternativamente, utilizamos una **ventana basada en Selenium para MFA**, mientras completamos autom치ticamente el nombre de usuario + contrase침a:
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password -r devicereg
```
Cualquiera de los comandos anteriores **guardar치 un token de acceso en el archivo `.roadtools_auth`**. El comando de registro de dispositivo lo cargar치 autom치ticamente desde este archivo. Puedes personalizar lo que desees para las propiedades del dispositivo con varios par치metros de l칤nea de comandos para el m칩dulo `roadtx device`:

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

Registramos un dispositivo unido a Azure AD con el nombre "blogdevice":
```bash
roadtx device -n blogdevice
Saving private key to blogdevice.key
Registering device
Device ID: 5f138d8b-6416-448d-89ef-9b279c419943
Saved device certificate to blogdevice.pem
```
Obtenemos dos piezas de datos que identifican nuestro dispositivo: La primera es el **certificado del dispositivo** guardado en `blogdevice.pem`, que es emitido por Azure AD y **identifica nuestro dispositivo**. La segunda parte es el archivo `blogdevice.key`, que contiene la **clave privada del certificado** y tambi칠n se utiliza como clave de transporte. Ahora que tenemos el certificado del dispositivo, podemos realizar **operaciones que requieren una identidad de dispositivo**. La m치s 칰til es **solicitar un Primary Refresh Token**, ya que eso nos permitir치 agregar capacidades de Single Sign On a nuestras solicitudes de token (interactivas o automatizadas).

## Solicitando un Primary Refresh Token <a href="#requesting-a-primary-refresh-token" id="requesting-a-primary-refresh-token"></a>

Un primary refresh token se solicita m치s a menudo con un nombre de usuario y contrase침a. Cuando inicias sesi칩n en una estaci칩n de trabajo unida a Azure AD o h칤brida con tu **nombre de usuario y contrase침a**, Windows inmediatamente **solicita un PRT** de Azure AD. He hablado sobre las tecnicidades detr치s de este flujo en mis charlas de Troopers y Romhack [talks](https://dirkjanm.io/talks/) en el pasado, as칤 que si est치s interesado en las tecnicidades, echa un vistazo a esas diapositivas. **Para solicitar un PRT con roadtx, ejecuta el comando `roadtx prt`**, especifica el certificado/clave del dispositivo y el nombre de usuario + contrase침a a usar, y obtendr치s un PRT:

{% code overflow="wrap" %}
```bash
roadtx prt -u myuser@mytenant.com -p password --key-pem blogdevice.key --cert-pem blogdevice.pem
```
{% endcode %}

El comando nos proporcionar치 un **PRT** (en forma de un token encriptado) y una **clave de sesi칩n** que necesitamos para usar el PRT. Por defecto, el PRT se guarda en `roadtx.prt`, donde puede ser utilizado por otros m칩dulos de roadtx.

Un PRT por defecto es v치lido por 90 d칤as, pero podemos **renovarlo en cualquier momento** para extender su validez por otros 90 d칤as con la acci칩n `renew`:
```bash
roadtx prt -a renew
Renewing PRT
Saved PRT to roadtx.prt
```
Tenga en cuenta que el PRT que solicitamos aqu칤 se basa 칰nicamente en una contrase침a, por lo que **cualquier autenticaci칩n que requiera MFA fallar치 incluso si usamos el PRT**. Tambi칠n podemos actualizar o "enriquecer" el PRT con una afirmaci칩n de MFA, esto se muestra en la siguiente secci칩n sobre autenticaci칩n basada en Selenium.

## Usando Tokens de Actualizaci칩n Primarios en la l칤nea de comandos <a href="#using-primary-refresh-tokens-on-the-command-line" id="using-primary-refresh-tokens-on-the-command-line"></a>

Una vez que tenemos un PRT, podemos usarlo para **iniciar sesi칩n en recursos que aceptan autenticaci칩n de Azure AD**. Puede hacer esto ya sea con el comando **`roadtx gettokens`**, y **especificar el PRT y la clave de sesi칩n** en la l칤nea de comandos, o usar el comando **`roadtx prtauth`**. La diferencia entre los dos es que el comando **`gettokens`** implementa una autenticaci칩n que se basa en **c칩mo Chrome realiza el Single Sign On** en el navegador. Este m칠todo es un poco rudimentario y si falla no le dar치 ning칰n tipo de retroalimentaci칩n.

El m칩dulo **`prtauth`** en cambio emula el **Web Account Manager (WAM) que utiliza Windows** si solicitas tokens de acceso desde una aplicaci칩n o proceso nativo. El WAM act칰a como un intermediario de tokens y solicita tokens en nombre de otros clientes. Utiliza una combinaci칩n de solicitudes firmadas y respuestas cifradas para evitar exponer los tokens en tr치nsito, todo hecho usando la clave de sesi칩n del PRT.

Por defecto, el m칩dulo `roadtx prtauth` usar치 el **ID de cliente del M칩dulo de PowerShell de Azure AD** y el gr치fico de Azure AD como recurso, pero puedes especificar cualquier otro ID de cliente o URL de recurso ya sea por su parte completa o como un alias (que se puede listar con `roadtx listaliases`):
```bash
roadtx prtauth
Tokens were written to .roadtools_auth
```
Ejemplo utilizando la CLI de Azure como ID de cliente y solicitando tokens para el Administrador de Recursos de Azure:
```bash
roadtx prtauth -c azcli -r azrm
Tokens were written to .roadtools_auth
```
Tambi칠n hay otras opciones que puedes usar para especificar otros recursos o la URL de redirecci칩n correcta para la aplicaci칩n que est치s utilizando:

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

## Autenticaci칩n de Azure AD basada en Selenium <a href="#selenium-based-azure-a-d-authentication" id="selenium-based-azure-a-d-authentication"></a>

Las solicitudes y usos de tokens basados en l칤nea de comandos est치n bien, pero a menudo te encontrar치s con alg칰n flujo que requiere una ventana de navegador para realizar la Autenticaci칩n de M칰ltiples Factores, o simplemente quieres usar tu PRT de manera interactiva para navegar por cosas como el Portal de Azure o leer tu correo utilizando un PRT robado.

El principio de las operaciones basadas en Selenium en roadtx es simple: **lanza una ventana de navegador, intenta autocompletar cualquier credencial que hayas suministrado al comando y te permite completar el resto manualmente**. Si tienes tus cuentas configuradas correctamente, realizar치 la autenticaci칩n de forma totalmente autom치tica.

### Autenticaci칩n interactiva <a href="#interactive-authentication" id="interactive-authentication"></a>

En su forma m치s simple, roadtx lanzar치 un navegador para ti, solicitar치 un token para el servicio indicado, completar치 cualquier credencial que hayas especificado y obtendr치 tokens. Ejemplo:
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password
```
Si se requiere **MFA**, puedes ingresar eso y obtener un token con reclamo de MFA. Si no, capturar치 la salida y guardar치 los tokens solicitados. Puedes especificar el **client ID** que deseas usar con `-c` y el recurso para autenticarte con `-r`. Aqu칤 hay un [**video corto de demostraci칩n**](https://dirkjanm.io/assets/video/selenium_autofill.mp4).

### Usando KeePass para autenticarse en diferentes cuentas <a href="#keepass-credentials-based-authentication" id="keepass-credentials-based-authentication"></a>

**`roadtx`** admite **obtener credenciales e informaci칩n de MFA basada en TOTP de un archivo kdbx** (archivo KeePass) o exportaci칩n XML de KeePass. Para usar esto, utiliza el comando **`roadtx keepassauth`**. Acepta un archivo **KeePass** con el par치metro **`-kp`** o si dejas este par치metro fuera, intentar치 cargar `roadtx.kdbx` desde el directorio actual. La **contrase침a** del archivo KeePass se puede especificar con **`-kpp`** o a trav칠s de la variable de entorno `KPPASS`. El 칰nico par치metro **requerido** es el **nombre de usuario**, que buscar치 en el archivo KeePass. Rellenar치 autom치ticamente la contrase침a y tambi칠n el c칩digo OTP si "Mobile app OTP" est치 habilitado como m칠todo MFA en la cuenta. Esto requiere que la semilla TOTP est칠 almacenada en el par치metro adicional `otp` de la identidad en el archivo KeePass. Para instrucciones sobre c칩mo configurar esto y algunas advertencias sobre el uso de archivos KeePass, consulta la [wiki de roadtx](https://github.com/dirkjanm/ROADtools/wiki/ROADtools-Token-eXchange-(roadtx)).

Revisa el [**video de demostraci칩n**](https://dirkjanm.io/assets/video/selenium_kpautofill.mp4).

Adem치s de solicitar tokens directamente, tambi칠n puedes usar esto como una ventana de navegador interactiva con autenticaci칩n autom치tica. Para hacer esto, especifica manualmente una URL que te redirigir치 a la p치gina de inicio de sesi칩n de Microsoft. Por ejemplo, usar `-url https://myaccount.microsoft.com` abrir치 un navegador, te autenticar치 e ir치 a la p치gina "Mi cuenta". Puedes usar `--keep-open` para mantener la ventana del navegador abierta despu칠s de la autenticaci칩n, lo que te permite navegar a otras p치ginas desde una perspectiva autenticada. Ejemplo:

{% code overflow="wrap" %}
```bash
roadtx keepassauth -url https://myaccount.microsoft.com --keep-open -u myuser@mytenant.com -kp accounts.kdbx -kpp keepassfilepassword
```
{% endcode %}

### Autenticaci칩n PRT en navegador <a href="#primary-refresh-token-authentication-in-browser" id="primary-refresh-token-authentication-in-browser"></a>

Un escenario m치s interesante es usar un Token de Actualizaci칩n Primario que hayas registrado t칰 mismo o que hayas [robado de un punto final leg칤timo](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/) durante un equipo rojo para crear una experiencia interactiva en el navegador. Supongamos que **extrajimos un PRT y clave de sesi칩n usando Mimikatz de un punto final** (esto solo es posible si no utiliza un M칩dulo de Plataforma de Confianza). Podemos usar este PRT en la l칤nea de comandos, o podemos inyectarlo autom치ticamente en nuestra sesi칩n de navegador Selenium. roadtx hace esto al proxyar el tr치fico del navegador a trav칠s de s칤 mismo e inyectar una cookie PRT en varios puntos durante la autenticaci칩n. En el punto final de la v칤ctima, podemos usar Mimikatz para volcar el PRT y la clave de sesi칩n.

Puedes **verificar los comandos** para volcar el PRT y la clave de sesi칩n y luego usar los valores con **`roadtx`** en la [**Opci칩n 2 del m칠todo mimikatz para Pasar el PRT**](pass-the-prt.md#attack-mimikatz)**.**

### Uso de PRT con otras cuentas <a href="#primary-refresh-token-usage-with-other-accounts" id="primary-refresh-token-usage-with-other-accounts"></a>

Un caso de uso interesante para los Tokens de Actualizaci칩n Primarios robados es que tambi칠n puedes **usarlos para otras cuentas para agregar reclamaciones de dispositivo** a la autenticaci칩n. Por ejemplo, si hay una pol칤tica de acceso condicional que requiere un dispositivo corporativo compatible o unido h칤bridamente para acceder a recursos espec칤ficos, la reclamaci칩n del dispositivo proviene del token de actualizaci칩n primario utilizado durante la autenticaci칩n. Esta reclamaci칩n tambi칠n puede ser utilizada para otros usuarios. As칤 que si tengo un **PRT robado de un dispositivo compatible** para el usuario `tpmtest@iminyour.cloud`, puedo usar este **PRT con las credenciales de `newlowpriv@iminyour.cloud`** para iniciar sesi칩n y pasar la prueba de cumplimiento.

En este ejemplo todav칤a tenemos el PRT robado de `tpmtest@iminyour.cloud` utilizado en el ejemplo anterior guardado como `roadtx.prt`. Puedo usar este **PRT junto con las credenciales de `newlowpriv`** que est치n almacenadas en mi archivo KeePass para iniciar sesi칩n en Microsoft Teams y acceder a datos all칤 con el comando `roadtx browserprtinject`.
```bash
roadtx browserprtinject -u newlowpriv@iminyour.cloud -r msgraph -c msteams
```
El token de acceso emitido contendr치 la afirmaci칩n `deviceid`, que es el dispositivo del cual robamos el PRT. Dado que este dispositivo est치 gestionado por Intune y cumple con los requisitos, pasa el requisito de conformidad:

<figure><img src="../../../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

### A침adiendo afirmaciones de MFA a un PRT existente <a href="#adding-mfa-claims-to-an-existing-prt" id="adding-mfa-claims-to-an-existing-prt"></a>

Volviendo a los PRT que robamos y regresando al PRT que registramos anteriormente usando una combinaci칩n de nombre de usuario + contrase침a. Si queremos tener un **PRT con afirmaci칩n de MFA, tenemos que usar una sesi칩n interactiva** que solicitar치 un token de actualizaci칩n especial de Azure AD para "enriquecer" nuestro PRT. El comando para esto es **`roadtx prtenrich`**, que al igual que los comandos anteriores acepta una identidad en un archivo KeePass para autocompletar la informaci칩n de MFA, o puedes hacerlo manualmente.
```bash
roadtx prtenrich -u newlowpriv@iminyour.cloud
Got refresh token. Can be used to request prt with roadtx prt -r <refreshtoken>
```
El resultado es un token de actualizaci칩n especial que podemos utilizar para solicitar un nuevo PRT. Para esto, volvemos al m칩dulo `roadtx prt`:
```bash
roadtx prt -r <refreshtoken> -c blogdevice.pem -k blogdevice.key
```
El nuevo PRT se escribe en disco y cuando lo usamos para solicitar tokens vemos la afirmaci칩n de MFA:

<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

Podemos usar este PRT para obtener tokens para recursos que requieren MFA utilizando cualquiera de los m칠todos anteriores.

### SSO usando Chrome y un browsercore personalizado <a href="#single-sign-on-in-windows-using-chrome-and-a-custom-browsercore" id="single-sign-on-in-windows-using-chrome-and-a-custom-browsercore"></a>

En la siguiente p치gina tienes informaci칩n sobre c칩mo Google Chrome usa **`browsercore.exe`** para autenticarse a trav칠s de SSO:

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

**`roadtx`** tiene `browsercore.py`, puedes usar un PTR de **`roadtx`** (o uno que hayas robado en otro lugar) para autenticarte autom치ticamente en tu navegador Chrome en tu host controlado por el atacante. No necesitas tener una ventana de Selenium, sino que puedes usar el PRT directamente como si estuvieras en la m치quina de la v칤ctima en un navegador leg칤timo.

El SSO personalizado requiere algunos pasos para configurarse:

* Debes colocar los archivos `browsercore.py` y `manifest.json` [archivos](https://github.com/dirkjanm/ROADtools/tree/master/browsercore) en alguna ubicaci칩n en disco, por ejemplo en `C:\browsercore\`.
* Instala roadtx y coloca un archivo `roadtx.prt` en el mismo directorio.
* Modifica `HKEY_CURRENT_USER\Software\Google\Chrome\NativeMessagingHosts\com.microsoft.browsercore` para que apunte a `C:\browsercore\manifest.json`.
* Prueba si todo funciona usando `bctest.py`
* Borra cualquier cookie existente en Chrome para `login.microsoftonline.com`

Las instrucciones completas de instalaci칩n est치n en el [wiki de ROADtools](https://github.com/dirkjanm/ROADtools/wiki/Setting-up-BrowserCore.py). Despu칠s de la configuraci칩n, Chrome deber칤a usar el PRT autom치ticamente durante el inicio de sesi칩n. La primera vez puede necesitar una pista para el nombre de usuario para funcionar correctamente.

Con esta configuraci칩n, puedes navegar por cualquier recurso conectado a Azure AD con SSO y las afirmaciones del PRT, incluido el estado del dispositivo y la informaci칩n de MFA almacenada.

## Otras utilidades <a href="#other-utilities" id="other-utilities"></a>

Hay algunas otras utilidades en roadtx, principalmente para facilitar mi propia investigaci칩n:

* `roadtx decrypt` puede descifrar respuestas encriptadas dada una clave de sesi칩n PRT o una clave de transporte de dispositivo
* `roadtx getotp` puede calcular un c칩digo OTP a partir de una semilla o de la propiedad otp almacenada en un archivo KeePass (si necesitas hacer MFA para ese usuario)
* `roadtx codeauth` puede realizar el flujo de redenci칩n de c칩digo OAuth2 para clientes p칰blicos y confidenciales.
* `roadtx listaliases` lista todos los alias que son compatibles para recursos y clientes. Si necesitas cualquier otro alias que uses con frecuencia, no dudes en abrir un problema o enviarme un mensaje.

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
