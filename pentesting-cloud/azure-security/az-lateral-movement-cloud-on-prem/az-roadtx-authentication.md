# Az - Roadtx - 身份验证

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

**文章复制自** [**https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/**](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)

## 基本信息

ROADtools Token eXchange (roadtx) 是一个用于**交换和使用不同类型的Azure AD颁发的令牌**的工具。它支持许多不同的认证流程、设备注册和与PRT相关的操作。

它可以执行以下操作：

* 注册并将设备加入到Azure AD。
* 从用户凭证或其他有效令牌请求Primary Refresh Tokens。
* 类似于Windows中的Web Account Manager (WAM)那样使用Primary Refresh Tokens。
* 执行各种Oauth2令牌兑换流程。
* 通过将Primary Refresh Token注入认证流程，执行基于浏览器SSO的交互式登录。
* 通过Windows 10账户插件和自定义browsercore实现，为Chrome添加SSO功能。
* 使用Selenium自动化登录、MFA和请求Azure AD中各种资源的令牌。
* 可以从KeePass数据库加载凭证和MFA TOTP种子，以用于自动化流程。

## 注册设备

roadtx的大多数模块都是围绕Primary Refresh Tokens和设备身份设计的。**要获得PRT，我们必须首先在Azure AD中注册一个设备**。\
注册设备**需要**一个对设备注册服务资源的**访问令牌**。访问令牌必须是**没有设备声明的令牌**，因此您不能使用单点登录或现有的PRT来请求一个。有**几种方法可以使用roadtx获得这样的令牌**，其中一些方法支持MFA，另一些则不支持。\
**根据租户设置，注册设备可能需要MFA**。如果不需要，您可以仅使用用户名和密码请求设备注册服务的令牌（在此通过_devicereg_别名指定）：
```bash
roadtx gettokens -u myuser@mytenant.com -p password -r devicereg
```
如果需要MFA，您可以使用设备认证流程通过**某个浏览器窗口**请求令牌：
```bash
roadtx gettokens --device-auth -r devicereg
```
或者，我们使用基于**Selenium 的窗口进行 MFA**，同时自动填充用户名 + 密码：
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password -r devicereg
```
以上任何命令都会**将访问令牌保存到 `.roadtools_auth` 文件中**。设备注册命令将会自动从这个文件加载它。您可以通过各种命令行参数自定义您想要的设备属性，这些参数适用于 `roadtx device` 模块：

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

我们注册了一个名为“blogdevice”的 Azure AD 加入设备：
```bash
roadtx device -n blogdevice
Saving private key to blogdevice.key
Registering device
Device ID: 5f138d8b-6416-448d-89ef-9b279c419943
Saved device certificate to blogdevice.pem
```
我们获得了两个用于识别我们设备的数据：第一个是保存在`blogdevice.pem`中的**设备证书**，它由Azure AD颁发并**识别我们的设备**。第二部分是`blogdevice.key`文件，其中包含**证书的私钥**，也用作传输密钥。现在我们有了设备证书，我们可以执行**需要设备身份的操作**。最有用的一个是**请求主刷新令牌**，因为这将使我们能够向我们的（交互式或自动化）令牌请求添加单点登录功能。

## 请求主刷新令牌 <a href="#requesting-a-primary-refresh-token" id="requesting-a-primary-refresh-token"></a>

主刷新令牌通常使用用户名和密码请求。当您使用**用户名和密码**登录到Azure AD加入或混合加入的工作站时，Windows会立即从Azure AD**请求一个PRT**。我在过去的Troopers和Romhack [讲座](https://dirkjanm.io/talks/)中讨论了这个流程的技术细节，所以如果您对技术细节感兴趣，可以阅读那些幻灯片。**要使用roadtx请求PRT，请运行`roadtx prt`命令**，指定设备证书/密钥和要使用的用户名+密码，然后你会得到一个PRT：

{% code overflow="wrap" %}
```bash
roadtx prt -u myuser@mytenant.com -p password --key-pem blogdevice.key --cert-pem blogdevice.pem
```
```markdown
命令将给我们一个**PRT**（以加密令牌的形式），以及我们需要使用PRT的**会话密钥**。默认情况下，PRT被保存到`roadtx.prt`，其他roadtx模块可以从那里获取它。

默认情况下，PRT有效期为90天，但我们可以随时使用`renew`操作**续订它**，以将有效期再延长90天：
```
```bash
roadtx prt -a renew
Renewing PRT
Saved PRT to roadtx.prt
```
请注意，我们在这里请求的PRT仅基于密码，因此**即使我们使用PRT，任何需要MFA的认证也会失败**。我们还可以通过MFA声明来升级或“丰富”PRT，这将在下一节基于Selenium的认证中展示。

## 在命令行使用主要刷新令牌 <a href="#using-primary-refresh-tokens-on-the-command-line" id="using-primary-refresh-tokens-on-the-command-line"></a>

一旦我们拥有了PRT，我们就可以使用它来**登录接受Azure AD认证的资源**。您可以通过**`roadtx gettokens`**命令来实现，并在命令行上**指定PRT和会话密钥**，或者使用**`roadtx prtauth`**命令。两者的区别在于**`gettokens`**命令实现的认证是**基于Chrome在浏览器中进行单点登录（Single Sign On）的方式**。这种方法有点不稳定，如果失败了不会给出任何反馈。

相反，**`prtauth`**模块模仿了**Windows使用的Web账户管理器（WAM）**，如果您从应用程序或本地进程请求访问令牌时会使用WAM。WAM充当令牌代理，并代表其他客户端请求令牌。它使用签名请求和加密响应的组合来防止在传输中暴露令牌，所有这些都使用PRT会话密钥完成。

默认情况下，`roadtx prtauth`模块将使用**Azure AD PowerShell模块客户端ID**和Azure AD图形作为资源，但您可以指定任何其他客户端ID或资源URL，无论是通过其完整部分还是别名（可通过`roadtx listaliases`列出）：
```bash
roadtx prtauth
Tokens were written to .roadtools_auth
```
使用 Azure CLI 作为客户端 ID 并请求 Azure 资源管理器的令牌的示例：
```bash
roadtx prtauth -c azcli -r azrm
Tokens were written to .roadtools_auth
```
以下是您可以使用的其他选项，用于指定其他资源或您正在使用的应用程序的正确重定向URL：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## 基于Selenium的Azure AD认证 <a href="#selenium-based-azure-a-d-authentication" id="selenium-based-azure-a-d-authentication"></a>

基于命令行的令牌请求和使用很好，但通常您会遇到某些流程，这些流程要么需要一个浏览器窗口来进行多因素认证，要么您只是想以交互方式使用您的PRT来浏览像Azure门户这样的东西，或者使用被盗的PRT阅读您的邮件。

roadtx中基于Selenium操作的原理很简单：**它启动一个浏览器窗口，尝试自动填充您提供给命令的任何凭据，并让您手动填写其余部分**。如果您的账户设置正确，它将完全自动进行认证。

### 交互式认证 <a href="#interactive-authentication" id="interactive-authentication"></a>

在最简单的形式中，roadtx将为您启动一个浏览器，请求指定服务的令牌，填写您指定的任何凭据，并获取令牌。示例：
```bash
roadtx interactiveauth -u myuser@mytenant.com -p password
```
如果需要**MFA**，您可以输入并获得带有MFA声明的令牌。如果不需要，它将捕获输出并保存请求的令牌。您可以使用`-c`指定想要使用的**客户端ID**，并使用`-r`指定要认证的资源。这里有一个[**简短的视频演示**](https://dirkjanm.io/assets/video/selenium_autofill.mp4)。

### 使用KeePass在不同账户中认证 <a href="#keepass-credentials-based-authentication" id="keepass-credentials-based-authentication"></a>

**`roadtx`** 支持从kdbx文件（KeePass文件）或KeePass XML导出中**获取凭证和基于TOTP的MFA信息**。要使用此功能，请使用**`roadtx keepassauth`**命令。它接受带有**`-kp`**参数的**KeePass**文件，如果您省略此参数，它会尝试从当前目录加载`roadtx.kdbx`。可以用**`-kpp`**指定KeePass文件的**密码**，或通过`KPPASS`环境变量指定。唯一**必需**的参数是**用户名**，它将在KeePass文件中查找。如果账户启用了“移动应用OTP”作为MFA方法，它将自动填充密码和OTP代码。这要求将TOTP种子存储在KeePass文件中身份的`otp`附加参数中。有关如何设置以及使用KeePass文件的一些注意事项的说明，请参见[roadtx wiki](https://github.com/dirkjanm/ROADtools/wiki/ROADtools-Token-eXchange-(roadtx))。

查看[**视频演示**](https://dirkjanm.io/assets/video/selenium_kpautofill.mp4)。

除了直接请求令牌外，您还可以将其用作带有自动认证的交互式浏览器窗口。为此，请手动指定一个将重定向您到Microsoft登录页面的URL。例如，使用`-url https://myaccount.microsoft.com`将打开浏览器，认证您，并转到“我的账户”页面。您可以使用`--keep-open`在认证后保持浏览器窗口打开，这使得可以从认证的角度浏览其他页面。示例：

{% code overflow="wrap" %}
```bash
roadtx keepassauth -url https://myaccount.microsoft.com --keep-open -u myuser@mytenant.com -kp accounts.kdbx -kpp keepassfilepassword
```
{% endcode %}

### 浏览器中的 PRT 认证 <a href="#primary-refresh-token-authentication-in-browser" id="primary-refresh-token-authentication-in-browser"></a>

一个更有趣的场景是使用你自己注册的或者在红队行动中[从合法终端窃取的](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/) Primary Refresh Token 来创建交互式浏览器体验。假设我们**使用 Mimikatz 从一个终端转储了 PRT 和会话密钥**（如果它不使用 Trusted Platform Module，这是可能的）。我们可以在命令行中使用这个 PRT，或者我们可以自动将其注入到我们的 Selenium 浏览器会话中。roadtx 通过将浏览器流量通过自身代理并在认证过程中的各个点注入 PRT cookie 来实现这一点。在受害者终端上，我们可以使用 Mimikatz 转储 PRT 和会话密钥。

你可以**检查命令**来转储 PRT 和会话密钥，然后使用这些值与 **`roadtx`** 一起使用，在[**通过 mimikatz 方法传递 PRT 的选项 2**](pass-the-prt.md#attack-mimikatz)**中。**

### 使用其他账户的 PRT <a href="#primary-refresh-token-usage-with-other-accounts" id="primary-refresh-token-usage-with-other-accounts"></a>

被盗的 Primary Refresh Tokens 的一个有趣用例是你也可以**使用它们为其他账户添加设备声明**以进行认证。例如，如果有一个条件访问策略要求一个合规或混合加入的企业设备才能访问特定资源，设备声明来自于认证过程中使用的 primary refresh token。这个声明也可以用于其他用户。所以如果我有一个**从合规设备窃取的 PRT**，用于用户 `tpmtest@iminyour.cloud`，我可以使用这个**PRT 和 `newlowpriv@iminyour.cloud` 的凭据**来登录并通过合规性测试。

在这个例子中，我们仍然有从 `tpmtest@iminyour.cloud` 窃取的并在上面的例子中使用的 PRT，保存为 `roadtx.prt`。我可以使用这个**PRT 和存储在我的 KeePass 文件中的 `newlowpriv` 的凭据**，通过 `roadtx browserprtinject` 命令登录到 Microsoft Teams 并在那里访问数据。
```bash
roadtx browserprtinject -u newlowpriv@iminyour.cloud -r msgraph -c msteams
```
发放的访问令牌将包含`deviceid`声明，这是我们窃取PRT的设备。由于该设备由Intune管理并且符合要求，它通过了合规性要求：

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 为现有的PRT添加MFA声明 <a href="#adding-mfa-claims-to-an-existing-prt" id="adding-mfa-claims-to-an-existing-prt"></a>

回到我们之前窃取的PRT，再回到我们早些时候使用用户名+密码组合注册的PRT。如果我们想要一个带有MFA声明的**PRT，我们必须使用一个交互式会话**，该会话将从Azure AD请求一个特殊的刷新令牌来“丰富”我们的PRT。此命令为**`roadtx prtenrich`**，与之前的命令一样，接受一个KeePass文件中的身份信息来自动填充MFA信息，或者你也可以手动完成此操作。
```bash
roadtx prtenrich -u newlowpriv@iminyour.cloud
Got refresh token. Can be used to request prt with roadtx prt -r <refreshtoken>
```
结果是一个特殊的刷新令牌，我们可以使用它来请求一个新的PRT。为此我们回到`roadtx prt`模块：
```bash
roadtx prt -r <refreshtoken> -c blogdevice.pem -k blogdevice.key
```
新的PRT被写入磁盘，当我们使用它请求令牌时，我们看到MFA声明：

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

我们可以使用这个PRT获取需要MFA的资源的令牌，使用上述任何方法。

### 使用Chrome和自定义browsercore进行SSO <a href="#single-sign-on-in-windows-using-chrome-and-a-custom-browsercore" id="single-sign-on-in-windows-using-chrome-and-a-custom-browsercore"></a>

在以下页面中，您可以了解Google Chrome如何使用**`browsercore.exe`**通过SSO进行认证：

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

**`roadtx`** 有`browsercore.py`，您可以使用**`roadtx`**的PTR（或您在其他地方窃取的）在您控制的攻击者主机上的Chrome浏览器中自动认证。您不需要有一个Selenium窗口，但可以直接使用PRT，就像您在受害者机器上的合法浏览器中一样。

自定义SSO需要几个步骤来设置：

* 您应该将`browsercore.py`和`manifest.json`[文件](https://github.com/dirkjanm/ROADtools/tree/master/browsercore)放在磁盘上的某个位置，例如在`C:\browsercore\`。
* 安装roadtx并将`roadtx.prt`文件放在同一目录下。
* 修改`HKEY_CURRENT_USER\Software\Google\Chrome\NativeMessagingHosts\com.microsoft.browsercore`指向`C:\browsercore\manifest.json`。
* 使用`bctest.py`测试是否一切正常工作。
* 清除Chrome中`login.microsoftonline.com`的所有现有cookies。

完整的安装说明在[ROADtools wiki](https://github.com/dirkjanm/ROADtools/wiki/Setting-up-BrowserCore.py)上。设置完成后，Chrome应该会在登录时自动使用PRT。第一次可能需要一个用户名提示才能正常工作。

通过这种设置，您可以使用SSO和PRT的声明浏览任何Azure AD连接的资源，包括设备状态和缓存的MFA信息。

## 其他工具 <a href="#other-utilities" id="other-utilities"></a>

roadtx中还有一些其他工具，主要是为了使我的研究更容易：

* `roadtx decrypt`可以解密给定PRT会话密钥或设备传输密钥的加密响应。
* `roadtx getotp`可以从种子或存储在KeePass文件中的otp属性计算OTP代码（如果您需要为该用户进行MFA）。
* `roadtx codeauth`可以为公共和机密客户端执行OAuth2代码兑换流程。
* `roadtx listaliases`列出所有支持资源和客户端的别名。如果您需要经常使用的任何其他别名，请随时开启问题或给我发消息。

<details>

<summary><strong>从零开始学习AWS黑客攻击到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)系列。
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
