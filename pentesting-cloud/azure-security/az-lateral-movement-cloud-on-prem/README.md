# Az - Lateral Movement (Cloud - On-Prem)

## Az - 측면 이동 (클라우드 - 온프레미스)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

### 클라우드에 연결된 온프레미스 머신

머신이 클라우드에 연결되는 다양한 방법이 있습니다:

#### Azure AD 가입

<figure><img src="../../../.gitbook/assets/image (3) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

#### 워크플레이스 가입

<figure><img src="../../../.gitbook/assets/image (1) (6).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### 하이브리드 가입

<figure><img src="../../../.gitbook/assets/image (3) (2) (2).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### AADJ 또는 하이브리드에서 워크플레이스 가입

<figure><img src="../../../.gitbook/assets/image (4) (3).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### 토큰 및 제한 사항 <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Azure AD에는 특정 제한 사항이 있는 다양한 유형의 토큰이 있습니다:

* **액세스 토큰**: Microsoft Graph와 같은 API 및 리소스에 액세스하는 데 사용됩니다. 특정 클라이언트와 리소스에 연결됩니다.
* **갱신 토큰**: 새로운 액세스 토큰을 얻기 위해 응용 프로그램에 발급됩니다. 발급된 응용 프로그램 또는 응용 프로그램 그룹에서만 사용할 수 있습니다.
* **기본 갱신 토큰 (PRT)**: Azure AD 가입, 등록 또는 하이브리드 가입 장치에서 Single Sign-On에 사용됩니다. 브라우저 로그인 플로우 및 장치에서 모바일 및 데스크톱 애플리케이션에 로그인하는 데 사용할 수 있습니다.

가장 흥미로운 유형의 토큰은 기본 갱신 토큰 (PRT)입니다.

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### 피벗 기법

**Compromised machine to the cloud**에서:

* [**Pass the Cookie**](az-pass-the-cookie.md): 브라우저에서 Azure 쿠키를 도용하여 로그인에 사용
* [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** PRT를 낚아채서 악용
* [**Pass the PRT**](pass-the-prt.md): 장치 PRT를 도용하여 Azure에 접근하여 위장
* [**Pass the Certificate**](az-pass-the-certificate.md)**:** PRT를 기반으로 인증서를 생성하여 한 기기에서 다른 기기로 로그인

**AD**를 침해하여 **Cloud**를 침해하거나 **Cloud**를 침해하여 **AD**를 침해하는 방법:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **On-Prem에서 Cloud로 피벗하는 또 다른 방법은** [**Intune을 악용**](../az-services/intune.md)하는 것입니다.

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

이 도구를 사용하면 Azure AD에서 기계를 등록하여 PRT를 얻거나 PRT(합법적 또는 도난)를 사용하여 여러 가지 다른 방법으로 리소스에 액세스하는 등 여러 작업을 수행할 수 있습니다. 이들은 직접적인 공격은 아니지만 PRT를 다양한 방법으로 리소스에 액세스하는 데 도움이 됩니다. 자세한 정보는 [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)에서 찾을 수 있습니다.

## 참고 자료

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)을 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
