# Az - 横方向の移動（クラウド - オンプレミス）

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## クラウドに接続されたオンプレミスマシン

マシンがクラウドに接続される方法はいくつかあります：

### Azure ADに参加

<figure><img src="../../../.gitbook/assets/image (3) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

### Workplaceに参加

<figure><img src="../../../.gitbook/assets/image (1) (6).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

### ハイブリッドに参加

<figure><img src="../../../.gitbook/assets/image (3) (2) (2).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

### AADJまたはハイブリッドに参加したWorkplace

<figure><img src="../../../.gitbook/assets/image (4) (3).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

## トークンと制限 <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Azure ADには、それぞれ独自の制限を持つ異なるタイプのトークンがあります：

* **アクセストークン**は、Microsoft GraphなどのAPIと通信し、リソースにアクセスするために使用されます。これらは**特定のクライアント**（それらを要求したアプリケーション）と**特定のリソース**（アクセスしているAPI）に結びつけられています。
* **リフレッシュトークン**は、アクセストークンの寿命が比較的短いため、新しいアクセストークンを取得するためにアプリケーションに発行されます。それらは、発行されたアプリケーション、または場合によってはアプリケーションのグループによってのみ使用できます。
* **プライマリリフレッシュトークン（PRT）**は、Azure ADに参加している、登録されている、またはハイブリッドに参加しているデバイスでの**シングルサインオン**に使用されます。これらは、Webアプリケーションへの**ブラウザサインイン**フローと、デバイス上で実行されている**モバイルおよびデスクトップアプリケーション**へのサインインの両方で使用できます。**アクセストークン**を要求するために使用できます。

PRTは最も興味深いタイプのトークンです。それらについての詳細は以下で確認してください：

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

## ピボットテクニック

**侵害されたマシンからクラウドへ**：

* [**Pass the Cookie**](az-pass-the-cookie.md): ブラウザからAzureのクッキーを盗み、それらを使用してログインする
* [**Phishing Primary Refresh Token**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** PRTをフィッシングして悪用する
* [**Pass the PRT**](pass-the-prt.md): デバイスのPRTを盗んで、それを偽装してAzureにアクセスする。
* [**Pass the Certificate**](az-pass-the-certificate.md)**:** PRTに基づいて証明書を生成し、一台のマシンから別のマシンにログインする

**AD**を侵害して**クラウド**を侵害することから、**クラウドから**侵害して**AD**を侵害することまで：

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **クラウドからオンプレミスにピボットするもう一つの方法は** [**Intuneの悪用**](../intune.md)

### [Roadtx](https://github.com/dirkjanm/ROADtools)

このツールを使用すると、Azure ADにマシンを登録してPRTを取得したり、PRT（合法的または盗まれたもの）を使用してさまざまな方法でリソースにアクセスしたりするなど、いくつかのアクションを実行できます。これらは直接的な攻撃ではありませんが、さまざまな方法でリソースにアクセスするためのPRTの使用を容易にします。詳細は以下で確認してください：

{% content-ref url="az-roadtx-authentication.md" %}
[az-roadtx-authentication.md](az-roadtx-authentication.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>
