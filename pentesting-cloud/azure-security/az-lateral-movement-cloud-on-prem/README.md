# Az - 측면 이동 (클라우드 - 온프렘)

## Az - 측면 이동 (클라우드 - 온프렘)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)를 통해 제로부터 영웅까지 AWS 해킹 배우기</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!</strong></a></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나** **PDF 형식의 HackTricks를 다운로드하고 싶다면** [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [디스코드 그룹](https://discord.gg/hRep4RUj7f)** 또는 [텔레그램 그룹](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **해킹 요령을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

### 클라우드에 연결된 온프렘 머신

머신이 클라우드에 연결되는 다양한 방법이 있습니다:

#### Azure AD 가입

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

#### Workplace 가입

<figure><img src="../../../.gitbook/assets/image (222).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv7UHXsAArdhn?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### 하이브리드 가입

<figure><img src="../../../.gitbook/assets/image (178).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv77jXkAAC4LK?format=jpg&#x26;name=large</a></p></figcaption></figure>

#### AADJ 또는 하이브리드에서 Workplace 가입

<figure><img src="../../../.gitbook/assets/image (252).png" alt=""><figcaption><p><a href="https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large">https://pbs.twimg.com/media/EQZv8qBX0AAMWuR?format=jpg&#x26;name=large</a></p></figcaption></figure>

### 토큰 및 제한 <a href="#tokens-and-limitations" id="tokens-and-limitations"></a>

Azure AD에서는 특정 제한이 있는 다양한 유형의 토큰이 있습니다:

* **액세스 토큰**: Microsoft Graph와 같은 API 및 리소스에 액세스하는 데 사용됩니다. 특정 클라이언트 및 리소스에 바인딩됩니다.
* **새로 고침 토큰**: 응용 프로그램에 새로운 액세스 토큰을 얻기 위해 발급됩니다. 발급된 응용 프로그램이나 응용 프로그램 그룹에서만 사용할 수 있습니다.
* **기본 새로 고침 토큰 (PRT)**: Azure AD 가입, 등록 또는 하이브리드 가입 장치에서 단일 로그인에 사용됩니다. 브라우저 로그인 흐름 및 장치에서 모바일 및 데스크톱 응용 프로그램에 로그인하는 데 사용할 수 있습니다.

가장 흥미로운 유형의 토큰은 기본 새로 고침 토큰 (PRT)입니다.

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### 피벗 기법

**감염된 머신에서 클라우드로**:

* [**쿠키 전달**](az-pass-the-cookie.md): 브라우저에서 Azure 쿠키를 도용하여 로그인에 사용
* [**피싱 기본 새로 고침 토큰**](az-phishing-primary-refresh-token-microsoft-entra.md)**:** PRT를 유인하여 남용
* [**PRT 전달**](pass-the-prt.md): 장치 PRT를 도용하여 Azure에 접근하여 가장하는 것
* [**인증서 전달**](az-pass-the-certificate.md)**:** PRT를 기반으로 인증서 생성하여 한 장치에서 다른 장치로 로그인

**AD**를 **클라우드**로, **클라우드**를 **AD**로 감염시키는 방법:

* [**Azure AD Connect**](azure-ad-connect-hybrid-identity/)
* **온프렘에서 클라우드로 피벗하는 또 다른 방법은** [**Intune 남용**](../az-services/intune.md)

#### [Roadtx](https://github.com/dirkjanm/ROADtools)

이 도구를 사용하면 Azure AD에서 기계를 등록하여 PRT를 얻고, PRT(합법적 또는 도난당한)를 사용하여 여러 가지 방법으로 리소스에 액세스할 수 있습니다. 이들은 직접적인 공격은 아니지만 PRT를 사용하여 다양한 방법으로 리소스에 액세스하는 것을 용이하게 합니다. 자세한 정보는 [https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/](https://dirkjanm.io/introducing-roadtools-token-exchange-roadtx/)에서 찾을 수 있습니다.

## 참고 자료

* [https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)
