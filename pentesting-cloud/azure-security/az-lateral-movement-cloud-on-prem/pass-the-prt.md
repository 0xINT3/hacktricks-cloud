# Az - Pass the PRT

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## O que √© um PRT

Um **Primary Refresh Token (PRT)** √© usado para fornecer uma experi√™ncia de **single sign-on (SSO)** para usu√°rios do Windows 10 e sistemas operacionais m√≥veis.

Quando voc√™ faz login em um dispositivo que suporta esse SSO, o Windows ir√° **comunicar com o provedor de autentica√ß√£o em nuvem, validar** suas credenciais e **retornar** o **PRT e uma chave de sess√£o**. O **PRT √© armazenado no LSASS**, e a **chave de sess√£o √© reencriptada** com o TPM local do dispositivo e armazenada ao lado do PRT.

Ent√£o, quando o **navegador** tenta acessar recursos na nuvem, um **cookie PRT** √© usado para acess√°-los.

Uma vez emitido, um **PRT** √© **v√°lido** por **14 dias** e √© **continuamente renovado** enquanto o usu√°rio usa ativamente o dispositivo. Um PRT s√≥ tem **reivindica√ß√µes MFA** se, ao acessar o RDP, voc√™ usar o **Windows Hello** ou o **Gerenciador de Contas do Windows**.

Ele pode ser usado para obter tokens de acesso e atualiza√ß√£o para qualquer aplicativo.

Para obter mais informa√ß√µes sobre como isso funciona, leia a [**documenta√ß√£o**](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token) ou [**esta p√°gina**](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/).

### Verifique se voc√™ tem um PRT

```
Dsregcmd.exe /status
```

Na se√ß√£o SSO State, voc√™ deve ver o **`AzureAdPrt`** definido como **YES**.

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

No mesmo output, voc√™ tamb√©m pode ver se o **dispositivo est√° conectado ao Azure** (no campo `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## Pass-the-PRT

### Passos

1. **Extraia** o **PRT do LSASS** e salve-o para uso posterior.
2. **Extraia** a **Chave de Sess√£o**. Se voc√™ se lembra, isso √© emitido e, em seguida, reencriptado pelo dispositivo local, ent√£o precisamos **descriptograf√°-lo usando uma masterkey DPAPI**. Para obter mais informa√ß√µes sobre DPAPI, confira este link do [**HackTricks**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) ou o ataque [**Pass-the-cookie**](az-pass-the-cookie.md).
3. Usando a Chave de Sess√£o descriptografada, obteremos a chave derivada para o PRT e o contexto. Isso √© necess√°rio para **criar nosso cookie PRT**. A chave derivada √© o que √© usado para assinar o JWT para o cookie. Dirk-jan fez um √≥timo trabalho explicando esse processo
## Refer√™ncias

* Este post foi em grande parte extra√≠do de [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>