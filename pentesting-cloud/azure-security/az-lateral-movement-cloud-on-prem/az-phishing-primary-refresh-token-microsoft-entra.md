# Az - フィッシング プライマリ リフレッシュ トークン (Microsoft Entra)

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見る
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

**投稿はこちらからコピーされました** [**https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/**](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

## 基本情報

**プライマリ リフレッシュ トークン**は、Azure AD/Microsoft Entraに参加、登録、またはハイブリッド参加しているデバイスでシングル サイン オンに使用されます。これらは、Webアプリケーションへのブラウザサインインフローだけでなく、デバイス上で実行されているモバイルおよびデスクトップアプリケーションへのサインインにも使用できます。

プライマリ リフレッシュ トークンは**データへのアクセスにアクセス トークンを要求するために使用できます**が、アクセス トークンはプライマリ リフレッシュ トークンを要求するために使用できないことに注意してください。

プライマリ リフレッシュ トークンを取得するには、デバイスのアイデンティティから始めて、その後ユーザーの資格情報を使用してPRTを要求する必要があります。これにより、これらの強力なトークンの発行方法が制限され、攻撃者がそれらを取得することがより困難になります。

PRTに関する詳細情報は以下で見つけることができます:

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

## フローの仕組み

新しいWindowsインストールを設定する場合、通常はセットアッププロセス中に一度だけ認証する必要がありますが、これは興味深いことです。なぜなら、セットアップを開始する時点ではデバイスはまだAzure ADに参加または登録されていないにもかかわらず、最終的にはSSOに使用されるPRTを持っており、WHFBキーをプロビジョニングする要件も満たしているからです。

プロセスは、**特定のアプリケーション**にサインインすることから始まり、これによりWindowsに**アクセス トークン**と**リフレッシュ トークン**が与えられます。アクセス トークンは、**デバイスをAzure ADに参加させ**、**デバイスのアイデンティティを設定する**ために使用できます。デバイス登録後、デバイスなしで発行された**リフレッシュ トークン**は、**新しいデバイスアイデンティティと組み合わせてプライマリ リフレッシュ トークンを要求するために使用されます**。

{% hint style="info" %}
したがって、デバイスに結びついていない通常のリフレッシュ トークンを使用して、最初に**デバイスを登録**し、その後**より強力なトークンを要求する**ことが可能です。このトークンは、任意のサインインシナリオで使用できます。
{% endhint %}

通常のリフレッシュ トークンからプライマリ リフレッシュ トークンへの「アップグレード」は、すべてのリフレッシュ トークンで可能なわけではありません。これには、サインインフローで特定のアプリケーションID（クライアントID）が必要です。Windowsは、このリクエストにクライアントID `29d9ed98-a469-4536-ade2-f981bc1d605e`（Microsoft Authentication Broker）とリソース `https://enrollment.manage.microsoft.com/` を使用します。私たちは、いくつかの異なる認証フローをサポートするroadtxの `gettokens` コマンドを使用して、このフローをエミュレートすることができます：

<figure><img src="../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

サインインにMFAが必要なポリシーがある場合は、代わりに `interactiveauth` モジュールを使用できます：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

結果として得られるリフレッシュ トークン（`.roadtools_auth` ファイルにキャッシュされている）は、デバイス登録サービスのトークンを要求するために使用できます。ここでデバイスを作成できます：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

これでデバイスアイデンティティを持つことができたので、同じリフレッシュ トークンと組み合わせてPRTを取得することができます（両方のリフレッシュ トークンは可読性のために短縮されています）：

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

認証から得られるトークンには、登録中に使用された同じ認証方法のクレームが含まれるため、**MFAの使用はPRTに転送されます**。私たちが得るPRTは、任意の認証フローで使用できるので、限定されたリフレッシュ トークンの範囲を任意のアプリに拡大することができます。

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

これをブラウザフローでサインインするためにも使用できます：

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Windows Hello for Businessキーのプロビジョニング <a href="#provisioning-windows-hello-for-business-keys" id="provisioning-windows-hello-for-business-keys"></a>

Windowsをセットアップし、WHFBがデバイスで有効になっている場合、**同じセッションを使用して新しくセットアップされたデバイスのWHFBキーをプロビジョニングします**。これを行うには、`ngcmfa`（新世代資格情報MFA）クレームを持つアクセス トークンが必要です。**過去10分以内にMFA認証を行った場合**、**前の**ステップの**PRT**がすべて必要です。ユーザーのさらなる操作を要求せずに、このクレームを含むデバイス登録サービスのトークンを**Azure ADに要求することができます**。これを行うには、**roadtx**の`prtenrich`コマンドを使用し、このトークンを要求します。

<figure><img src="../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

この新しいアクセス トークンを使用して、新しいWHFBキーをプロビジョニングできます。このキーは、将来的にユーザーのパスワードにアクセスすることなく新しいPRTを要求するためにも使用できます。

<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

## プライマリ リフレッシュ トークンのフィッシング <a href="#phishing-for-primary-refresh-tokens" id="phishing-for-primary-refresh-tokens"></a>

プロセスの仕組みを理解したので、フィッシングに利用できるようにアプローチを変更することができます。PRTを直接フィッシングすることはできません。なぜなら、これにはフロー中に使用される既存のデバイスアイデンティティが必要だからです。私たちは、直接PRTを要求するために必要な情報をユーザーやそのエンドポイントに送信させることをユーザーをだますことはできません。しかし、**適切なクライアントとリソースを持つ通常のリフレッシュ トークンを要求する**いくつかの方法を使用して、その後それを使用して**デバイスを登録し、PRTを要求する**ことができます。

### デバイスコードフィッシング <a href="#device-code-phishing" id="device-code-phishing"></a>

上記の認証ステップでは、ユーザー名とパスワードを使用して認証しました。しかし、これには**デバイスコードフローも使用できます**。Windowsはこのフローを登録/参加プロセスには使用しませんが、これは**有効なOAuthフロー**であり、同じ**リフレッシュ トークンを提供します**：

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

ご覧のとおり、デバイスコードフローはユーザーに自分のデバイスでコードを入力し、認証を完了するように求めます。これにより、トークンは開始されたデバイスで提供されます。このフローはフィッシングにも適しています。なぜなら、被害者を説得してデバイスコードで認証を行わせることができれば、その代わりにトークンを取得できるからです。これは新しいテクニックではありませんが、過去にいくつかの人々によって説明されています。また、このプロセス全体を簡単にするいくつかのツールキットもあります。このテクニックについて詳しく知りたい場合は、こちらの参考文献をご覧ください：

* [https://aadinternals.com/post/phishing/](https://aadinternals.com/post/phishing/)
* [https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html](https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html)
* [https://github.com/secureworks/squarephish](https://github.com/secureworks/squarephish)
* [https://www.blackhillsinfosec.com/dynamic-device-code-phishing/](https://www.blackhillsinfosec.com/dynamic-device-code-phishing/)

したがって、ユーザーを説得して認証させ、リフレッシュ トークンを受け取ると仮定しましょう。これで、この**リフレッシュ トークン**を使用して以下を行うことができます：

* テナント内でデバイスにアクセスできない場合は、**Azure ADにデバイスを登録または参加させる**。
* **リフレッシュ トークンを使用してPRTを要求する**。
* ユーザーがデバイスコードフローで「新鮮な」MFAを実行した場合、そのアカウントにWHFB資格情報を**登録して永続性を持たせることもできます**。

この攻撃を実行する場合、いくつかの注意点があります：

* **デバイスコードは、デバイスコードフローを開始してから15分間のみ有効です**。これは、フィッシングに使用したい場合に追加の制限を加えます。一部のツールは、例えばQRコードを介してユーザーがメールと対話するまでデバイスコードを作成しないことでこれを考慮しています。
* **デバイスの登録または参加は、特定のユーザーにのみ制限されている可能性があります**。一般的に、デバイスの参加は登録よりも頻繁に制限されます。特定のデバイスステータスを要求する特定のポリシーがない限り、トークンの使用可能性に実際の違いはありません。
* **WHFB資格情報の登録は、ユーザーがデバイスコードを使用してアクテ
```
SigninLogs
| where AppId == "29d9ed98-a469-4536-ade2-f981bc1d605e" //Broker app client id
and AuthenticationProtocol == "deviceCode"
```
このトピックについてMicrosoftとの議論の中で、デバイスコードフローがブローカーアプリケーションによって正当に使用される場合があるという情報を得ました。そのため、このクエリではいくつかの偽陽性が出る可能性があります。このクエリで正当なマッチを見つけた場合は、正当なケースを除外するために微調整が可能かどうかを確認するために、お気軽にご連絡ください。

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには、</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
