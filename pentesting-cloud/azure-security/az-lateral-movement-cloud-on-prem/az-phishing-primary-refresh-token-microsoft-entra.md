# Az - Hame√ßonnage du jeton d'actualisation primaire (Microsoft Entra)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Article copi√© de** [**https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/**](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

## Informations de base

Les **jetons d'actualisation primaires** sont utilis√©s pour la connexion unique sur les appareils qui sont joints, enregistr√©s ou joints de mani√®re hybride √† Azure AD/Microsoft Entra. Ils peuvent √™tre utilis√©s √† la fois dans les flux de connexion au navigateur pour les applications Web et pour se connecter aux applications mobiles et de bureau ex√©cut√©es sur l'appareil.

Notez que les jetons d'actualisation primaires peuvent √™tre utilis√©s pour **demander un jeton d'acc√®s pour acc√©der aux donn√©es**, mais les jetons d'acc√®s ne peuvent pas √™tre utilis√©s pour demander un jeton d'actualisation primaire.

Pour obtenir un jeton d'actualisation primaire, vous devez commencer par une identit√© d'appareil, puis utiliser les identifiants de l'utilisateur pour demander un PRT. Cela limite la mani√®re dont ces jetons puissants peuvent √™tre √©mis et rend plus difficile pour les attaquants de les obtenir.

Vous pouvez trouver plus d'informations sur les PRTs dans :

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

## Comment fonctionne le flux

Si l'on configure une nouvelle installation de Windows, il est g√©n√©ralement n√©cessaire de s'authentifier une seule fois pendant le processus de configuration, et ceci est int√©ressant, car au moment o√π nous commen√ßons la configuration, l'appareil n'est pas encore joint ou enregistr√© dans Azure AD, mais √† la fin, nous avons un PRT qui est utilis√© pour la SSO, et r√©pond m√™me aux exigences pour provisionner les cl√©s WHFB.

Le processus commence par se connecter √† une **application sp√©cifique**, ce qui donne √† Windows un **jeton d'acc√®s** et un **jeton d'actualisation**. Les jetons d'acc√®s peuvent √™tre utilis√©s pour **joindre l'appareil √† Azure AD** et **configurer l'identit√© de l'appareil**. Apr√®s l'enregistrement de l'appareil, le **jeton d'actualisation**, qui a √©t√© √©mis sans appareil, est utilis√© avec la **nouvelle identit√© de l'appareil pour demander un jeton d'actualisation primaire**.

{% hint style="info" %}
Par cons√©quent, il est possible d'utiliser un jeton d'actualisation r√©gulier, qui n'est pas li√© √† un appareil mais est **li√© √† une application sp√©cifique**, pour d'abord **enregistrer un appareil** puis **demander un jeton plus puissant** qui peut √™tre utilis√© dans n'importe quel sc√©nario de connexion.
{% endhint %}

La "mise √† niveau" d'un jeton d'actualisation normal √† un jeton d'actualisation primaire n'est pas possible avec chaque jeton d'actualisation. Elle n√©cessite un identifiant d'application (client ID) sp√©cifique dans le flux de connexion. Windows utilise le client ID `29d9ed98-a469-4536-ade2-f981bc1d605e` (Microsoft Authentication Broker) et la ressource `https://enrollment.manage.microsoft.com/` pour cette demande. Nous pouvons √©muler ce flux avec la commande `gettokens` de roadtx, qui prend en charge plusieurs flux d'authentification diff√©rents :

<figure><img src="../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

Si une politique exige une MFA pour se connecter, nous pouvons √† la place utiliser le module `interactiveauth` :

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Le jeton d'actualisation r√©sultant (qui est mis en cache dans le fichier `.roadtools_auth`) peut √™tre utilis√© pour demander un jeton pour le service d'enregistrement de l'appareil, o√π nous pouvons cr√©er l'appareil :

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Maintenant que nous avons une identit√© d'appareil, nous pouvons combiner cela avec le m√™me jeton d'actualisation pour obtenir un PRT (les deux jetons d'actualisation raccourcis pour la lisibilit√©) :

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Les jetons r√©sultant de l'authentification contiendront les m√™mes revendications de m√©thode d'authentification utilis√©es pendant l'enregistrement, donc **toute utilisation de MFA sera transf√©r√©e au PRT**. Le PRT que nous obtenons peut √™tre utilis√© dans n'importe quel flux d'authentification, donc nous pouvons √©tendre la port√©e de notre jeton d'actualisation limit√© √† n'importe quelle application possible.

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Nous pouvons √©galement utiliser cela pour nous connecter aux flux de navigateur :

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Provisionnement des cl√©s Windows Hello pour les entreprises <a href="#provisioning-windows-hello-for-business-keys" id="provisioning-windows-hello-for-business-keys"></a>

Si vous configurez Windows et que WHFB est activ√© pour votre appareil, il utilisera la **m√™me session pour provisionner la cl√© WHFB pour le nouvel appareil configur√©**. Pour ce faire, nous aurons besoin d'un jeton d'acc√®s avec la revendication `ngcmfa` (nouvelle g√©n√©ration de credentials MFA). Tant que nous avons effectu√© l'**authentification MFA dans les 10 derni√®res minutes**, le **PRT** de l'**√©tape pr√©c√©dente** est tout ce dont nous avons besoin. Nous pouvons demander √† **Azure AD de nous donner un jeton pour le service d'enregistrement de l'appareil** qui contient cette revendication, sans n√©cessiter d'interaction suppl√©mentaire de l'utilisateur. Pour ce faire, nous utilisons la commande `prtenrich` de **roadtx**, qui demandera ce jeton.

<figure><img src="../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Avec ce nouveau jeton d'acc√®s, nous pouvons provisionner la nouvelle cl√© WHFB. Cette cl√© peut √™tre utilis√©e pour demander √©galement de nouveaux PRT √† l'avenir, sans avoir besoin d'acc√©der au mot de passe de l'utilisateur.

<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

## Hame√ßonnage pour les jetons d'actualisation primaires <a href="#phishing-for-primary-refresh-tokens" id="phishing-for-primary-refresh-tokens"></a>

Maintenant que nous savons comment fonctionne le processus, nous pouvons changer l'approche pour la rendre utilisable pour l'hame√ßonnage. Il n'est pas possible d'hame√ßonner directement les PRT, car cela n√©cessite une identit√© d'appareil existante √† utiliser pendant le flux. Nous **ne pouvons pas tromper les utilisateurs ou leurs points de terminaison pour nous envoyer les informations requises pour demander directement un PRT**. Nous pouvons cependant utiliser plusieurs m√©thodes pour **demander un jeton d'actualisation r√©gulier avec le bon client et la bonne ressource**, pour ensuite utiliser cela pour **enregistrer un appareil et demander un PRT**.

### Hame√ßonnage de code d'appareil <a href="#device-code-phishing" id="device-code-phishing"></a>

Dans l'√©tape d'authentification ci-dessus, nous avons utilis√© un nom d'utilisateur et un mot de passe pour nous authentifier. Cependant, nous pouvons √©galement utiliser le **flux de code d'appareil pour cela**. Bien que Windows n'utilise pas ce flux pour le processus d'enregistrement/jointure, c'est un **flux OAuth valide** qui nous donnera le m√™me **jeton d'actualisation :**

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

Comme vous pouvez le voir, le flux de code d'appareil demande aux utilisateurs d'**entrer un code sur leur propre appareil et de compl√©ter l'authentification**, ce qui fournira les jetons sur l'appareil √† partir duquel il a √©t√© initi√©. Ce flux est √©galement adapt√© pour l'hame√ßonnage, car si nous pouvons **convaincre notre victime d'effectuer l'authentification avec un code d'appareil, nous obtiendrons des jetons en leur nom**. Ce n'est pas une nouvelle technique, mais elle a √©t√© d√©crite par plusieurs personnes dans le pass√©. Il existe √©galement plusieurs kits d'outils qui **rendent tout le processus plus facile**. Si vous souhaitez vous renseigner sur cette technique, voici quelques r√©f√©rences :

* [https://aadinternals.com/post/phishing/](https://aadinternals.com/post/phishing/)
* [https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html](https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html)
* [https://github.com/secureworks/squarephish](https://github.com/secureworks/squarephish)
* [https://www.blackhillsinfosec.com/dynamic-device-code-phishing/](https://www.blackhillsinfosec.com/dynamic-device-code-phishing/)

Supposons donc que nous **convainquons un utilisateur de s'authentifier, et nous recevons le jeton d'actualisation**. Nous pouvons maintenant utiliser ce **jeton d'actualisation** pour :

* **Enregistrer ou joindre un appareil √† Azure AD** si nous n'avons pas d√©j√† acc√®s √† un appareil dans le locataire.
* Utiliser le **jeton d'actualisation pour demander un PRT**.
* Si l'utilisateur a effectu√© une MFA "fra√Æche" lors de l'authentification avec le flux de code d'appareil, nous pouvons √©galement **enregistrer des identifiants WHFB sur leur compte pour la persistance**.

Il y a quelques mises en garde √† cela, que vous devez prendre en compte si vous effectuez cette attaque :

* Le **code d'appareil n'est valide que pendant 15 minutes** apr√®s avoir initi√© le flux de code d'appareil, ce qui ajoute des restrictions suppl√©mentaires si vous souhaitez utiliser cela pour l'hame√ßonnage. Certains outils tiennent compte de cela en ne cr√©ant le code d'appareil qu'une fois que l'utilisateur interagit avec l'e-mail, par exemple via un code QR.
* **L'enregistrement ou la jointure d'appareils pourrait √™tre restreint dans le locataire √† certains utilisateurs sp√©cifiques**. En g√©n√©ral, la jointure d'appareils est restreinte plus souvent que leur enregistrement. √Ä moins qu'il n'y ait des politiques sp√©cifiques qui exigent un certain statut d'appareil, il n'y aura pas de diff√©rence pratique dans l'utilisabilit√© du jeton.
* **L'enregistrement des identifiants WHFB n'est possible que si l'utilisateur a activement effectu√© une MFA lors de l'utilisation du code d'appareil**. S'ils utilisent le code d'appareil √† partir d'une session existante sur leur appareil g√©r√©, la revendication MFA sera transmise au jeton d'actualisation et ne sera probablement pas assez r√©cente pour provisionner une cl√© WHFB. Dans mes tests, le statut de connexion en cache ne sera utilis√© que si l'utilisateur a une session existante sur un appareil non g√©r√©, et sur les navigateurs qui se sont connect√©s en utilisant la SSO, il n'utilisera pas automatiquement la connexion en cache.

La vid√©o ci-dessous montre l'attaque comme preuve de concept. Dans des sc√©narios pratiques, vous pourriez utiliser votre cadre ou m√©thode de phishing de code d'appareil pr√©f√©r√© pour faire la partie hame√ßonnage.

{% embed url="https://dirkjanm.io/assets/raw/prtphish.mp4" %}

La vid√©o ci-dessus utilise le script [deviceCode2WinHello](https://github.com/kiwids0220/deviceCode2WinHello) qui automatise toutes ces √©tapes, √©crit par [Kai](https://twitter.com/mhskai2017) de SpecterOps (voir conclusions √† la fin du blog). Il utilise √©galement le module `roadtx keepassauth` pour faire l'authentification, en r√©alit√© vous devriez convaincre votre victime de faire l'authentification, mais cela √©tait plus facile pour la d√©monstration.

### Hame√ßonnage de credentials <a href="#credential-phishing" id="credential-phishing"></a>

Il est √©galement possible de r√©aliser l'attaque d'hame√ßonnage en utilisant des m√©thodes d'hame√ßonnage de credentials, par exemple avec evilginx comme cadre. Si nous utilisons un phishlet Microsoft 365 pour nous connecter, par exemple [celui-ci](https://github.com/BakkerJan/evilginx3/blob/main/microsoft365.yaml) de Jan Bakker, nous obtiendrons les cookies de session de la victime. Ces cookies de session peuvent √™tre utilis√©s avec roadtx pour demander les jetons corrects, et √† partir de l√†, l'attaque est la m√™me :

<figure><img src="../../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

## Pr√©vention et d√©tection <a href="#prevention-and-detection" id="prevention-and-detection"></a>

Il n'y a pas beaucoup de moyens de pr√©venir ces attaques. L'hame√ßonnage de code d'appareil est l'une des rares m√©thodes qui n'est pas emp√™ch√©e par l'exigence d'une certaine force de MFA, puisque les utilisateurs effectuent cette authentification contre les domaines l√©gitimes de Microsoft. De plus, il n'y a malheureusement aucun moyen de bloquer certains flux OAuth tels que le flux de code d'appareil. L'approche d'hame√ßonnage de credentials d√©crite ci-dessus est plus facile √† pr√©venir, car cela se produira sur un faux site Web qui emp√™chera certaines m√©thodes de MFA de fonctionner.

La seule mani√®re r√©ellement efficace de bloquer cette attaque est d'exiger qu'un appareil soit g√©r√© via MDM ou MAM, en ayant une politique d'Acc√®s Conditionnel en place qui exige un appareil conforme ou joint de mani√®re hybride. Se conformer √† cette politique exigerait que le nouvel appareil enregistr√© soit √©galement inscrit dans Intune. √Ä condition qu'Intune soit suffisamment verrouill√© pour emp√™cher les gens d'inscrire des appareils non corporatifs ou faux, notre nouvel appareil enregistr√© ne pourra pas devenir conforme et r√©pondre aux exigences de ces politiques. Notez que le flux d'enregistrement de l'appareil lui-m√™me n'est pas bloqu√© par les politiques exigeant des appareils conformes, puisque ce flux est par d√©finition exclu de ces politiques (vous ne pouvez pas d√©j√† avoir un appareil conforme pendant l'enregistrement de l'appareil). Donc, si des politiques sont en place qui exigent un appareil conforme ou joint de mani√®re hybride, il est toujours possible d
```
SigninLogs
| where AppId == "29d9ed98-a469-4536-ade2-f981bc1d605e" //Broker app client id
and AuthenticationProtocol == "deviceCode"
```
Lors de mes discussions avec Microsoft sur ce sujet, on m'a inform√© que dans certains cas, le flux de code de p√©riph√©rique est utilis√© l√©gitimement par l'application de courtage, donc cette requ√™te pourrait produire quelques faux positifs. Si vous trouvez des correspondances l√©gitimes avec cette requ√™te, n'h√©sitez pas √† me contacter pour que nous puissions voir s'il est possible de l'affiner pour exclure les cas l√©gitimes.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe t√©l√©gramme**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
