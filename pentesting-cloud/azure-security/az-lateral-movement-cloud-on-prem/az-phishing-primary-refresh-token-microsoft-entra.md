# Az - フィッシング プライマリ リフレッシュ トークン (Microsoft Entra)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

**投稿はこちらからコピーされました** [**https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/**](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

## 基本情報

**プライマリ リフレッシュ トークン**は、Azure AD/Microsoft Entraに参加、登録、またはハイブリッド参加しているデバイスでシングル サイン オンに使用されます。これらは、Webアプリケーションへのブラウザサインインフローだけでなく、デバイス上で実行されているモバイルおよびデスクトップアプリケーションへのサインインにも使用できます。

プライマリ リフレッシュ トークンは**データへのアクセスにアクセス トークンを要求するために使用できます**が、アクセス トークンはプライマリ リフレッシュ トークンを要求するために使用できないことに注意してください。

プライマリ リフレッシュ トークンを取得するには、デバイスのアイデンティティから始めて、その後ユーザーの資格情報を使用してPRTを要求する必要があります。これにより、これらの強力なトークンの発行方法が制限され、攻撃者がそれらを取得することがより困難になります。

PRTに関する詳細情報は以下で見つけることができます:

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

## フローの仕組み

新しいWindowsインストールを設定する場合、通常はセットアッププロセス中に一度だけ認証する必要がありますが、これは興味深い点です。なぜなら、セットアップを開始する時点ではデバイスはまだAzure ADに参加または登録されていないにもかかわらず、最終的にはSSOに使用されるPRTを持っており、WHFBキーをプロビジョニングする要件も満たしているからです。

プロセスは、**特定のアプリケーション**にサインインすることから始まり、これによりWindowsに**アクセス トークン**と**リフレッシュ トークン**が与えられます。アクセス トークンは**デバイスをAzure ADに参加させ**、**デバイスのアイデンティティを設定する**ために使用できます。デバイス登録後、デバイスなしで発行された**リフレッシュ トークン**は、**新しいデバイス アイデンティティと組み合わせてプライマリ リフレッシュ トークンを要求するために使用されます**。

{% hint style="info" %}
したがって、デバイスに紐づいていない通常のリフレッシュ トークンを使用して、最初に**デバイスを登録**し、その後**より強力なトークンを要求する**ことが可能です。このトークンは、任意のサインインシナリオで使用できます。
{% endhint %}

通常のリフレッシュ トークンからプライマリ リフレッシュ トークンへの「アップグレード」は、すべてのリフレッシュ トークンで可能なわけではありません。これには、サインインフローで特定のアプリケーションID（クライアントID）が必要です。Windowsは、このリクエストにクライアントID `29d9ed98-a469-4536-ade2-f981bc1d605e`（Microsoft Authentication Broker）とリソース `https://enrollment.manage.microsoft.com/` を使用します。私たちは、いくつかの異なる認証フローをサポートするroadtxの `gettokens` コマンドを使用して、このフローをエミュレートすることができます：

<figure><img src="../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

サインインにMFAが必要なポリシーがある場合は、代わりに `interactiveauth` モジュールを使用できます：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

結果として得られるリフレッシュ トークン（`.roadtools_auth` ファイルにキャッシュされている）は、デバイス登録サービスのトークンを要求するために使用できます。ここでデバイスを作成できます：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

これでデバイス アイデンティティを持つことができたので、同じリフレッシュ トークンと組み合わせてPRTを取得することができます（両方のリフレッシュ トークンは可読性のために短縮されています）：

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

認証から得られるトークンには、登録時に使用された同じ認証方法のクレームが含まれるため、**MFAの使用はPRTに転送されます**。私たちが得るPRTは、任意の認証フローで使用できるので、限定されたリフレッシュ トークンの範囲を任意のアプリに拡大することができます。

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

これをブラウザフローでサインインするためにも使用できます：

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Windows Hello for Business キーのプロビジョニング <a href="#provisioning-windows-hello-for-business-keys" id="provisioning-windows-hello-for-business-keys"></a>

Windowsをセットアップし、WHFBがデバイスで有効になっている場合、**同じセッションを使用して新しくセットアップされたデバイスのWHFBキーをプロビジョニングします**。これを行うには、`ngcmfa`（新世代資格情報 MFA）クレームを持つアクセス トークンが必要です。私たちが**過去10分以内にMFA認証を行った場合**、**前の**ステップの**PRT**だけで十分です。ユーザーのさらなる操作を要求せずに、このクレームを含むデバイス登録サービスのトークンを**Azure ADに要求することができます**。これを行うには、**roadtx**の`prtenrich`コマンドを使用し、このトークンを要求します。

<figure><img src="../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

この新しいアクセス トークンを使用して、新しいWHFBキーをプロビジョニングできます。このキーは、将来的にユーザーのパスワードにアクセスすることなく新しいPRTを要求するためにも使用できます。

<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

## プライマリ リフレッシュ トークンのフィッシング <a href="#phishing-for-primary-refresh-tokens" id="phishing-for-primary-refresh-tokens"></a>

プロセスの仕組みがわかったので、フィッシングに利用できるようにアプローチを変更することができます。PRTを直接フィッシングすることはできません。なぜなら、このフローでは既存のデバイス アイデンティティを使用する必要があるからです。私たちは、PRTを直接要求するために必要な情報をユーザーやそのエンドポイントに送信させることをだますことはできません。しかし、**適切なクライアントとリソースを持つ通常のリフレッシュ トークンを要求する**いくつかの方法を使用して、その後それを使用して**デバイスを登録し、PRTを要求する**ことができます。

### デバイス コード フィッシング <a href="#device-code-phishing" id="device-code-phishing"></a>

上記の認証ステップでは、ユーザー名とパスワードを使用して認証しました。しかし、**デバイス コード フローを使用することもできます**。Windowsはこのフローを登録/参加プロセスには使用しませんが、これは**有効なOAuthフロー**であり、同じ**リフレッシュ トークンを提供します**：

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

ご覧のとおり、デバイス コード フローはユーザーに自分のデバイスでコードを入力し、認証を完了するように求めます。これにより、トークンはそれが開始されたデバイスで提供されます。このフローはフィッシングにも適しています。なぜなら、私たちが**被害者を説得してデバイス コードで認証を行わせることができれば、その代わりにトークンを取得することができるからです**。これは新しいテクニックではありませんが、過去にいくつかの人々によって説明されています。また、**プロセス全体を簡単にする**いくつかのツールキットもあります。このテクニックについて詳しく知りたい場合は、こちらの参考文献をご覧ください：

* [https://aadinternals.com/post/phishing/](https://aadinternals.com/post/phishing/)
* [https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html](https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html)
* [https://github.com/secureworks/squarephish](https://github.com/secureworks/squarephish)
* [https://www.blackhillsinfosec.com/dynamic-device-code-phishing/](https://www.blackhillsinfosec.com/dynamic-device-code-phishing/)

では、ユーザーを説得して認証させ、リフレッシュ トークンを受け取ったとしましょう。この**リフレッシュ トークン**を使用して：

* テナント内でデバイスにアクセスできない場合は、**Azure ADにデバイスを登録または参加させる**。
* **リフレッシュ トークンを使用してPRTを要求する**。
* ユーザーがデバイス コード フローで認証する際に「新鮮な」MFAを実行した場合、そのアカウントにWHFB資格情報を**登録して永続性を持たせることもできます**。

この攻撃を実行する場合、いくつかの注意点があります：

* **デバイス コードは、デバイス コード フローを開始してから15分間のみ有効です**。これは、フィッシングに使用したい場合に追加の制限を加えます。一部のツールは、例えばQRコードを介してユーザーがメールと対話するときにのみデバイス コードを作成することでこれを考慮しています。
* **デバイスの登録または参加は、特定のユーザーにのみ制限されている可能性があります**。一般的に、デバイスの参加は登録よりも頻繁に制限されます。特
```
SigninLogs
| where AppId == "29d9ed98-a469-4536-ade2-f981bc1d605e" //Broker app client id
and AuthenticationProtocol == "deviceCode"
```
このトピックについてMicrosoftとの議論の中で、デバイスコードフローがブローカーアプリケーションによって正当に使用される場合があるという情報を得ました。そのため、このクエリではいくつかの偽陽性が出る可能性があります。このクエリで正当なマッチを見つけた場合は、正当なケースを除外するために微調整が可能かどうかを確認するために、お気軽にご連絡ください。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
