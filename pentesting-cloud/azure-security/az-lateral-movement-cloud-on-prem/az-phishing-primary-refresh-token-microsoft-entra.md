# Az - 钓鱼主刷新令牌（Microsoft Entra）

<details>

<summary><strong>从零到英雄学习AWS黑客攻击，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

**文章复制自** [**https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/**](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

## 基本信息

**主刷新令牌**用于在Azure AD/Microsoft Entra加入、注册或混合加入的设备上实现单点登录。它们既可以在浏览器登录流程中用于访问网络应用程序，也可以用于登录运行在设备上的移动和桌面应用程序。

请注意，主刷新令牌可以用来**请求访问令牌以访问数据**，但访问令牌不能用来请求主刷新令牌。

要获得主刷新令牌，您需要从设备身份开始，然后使用用户凭证来请求PRT。这限制了这些强大令牌的发行，并使攻击者更难获得它们。

您可以在以下内容中找到有关PRT的更多信息：

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

## 流程如何工作

如果设置新的Windows安装，通常只需要在设置过程中进行一次认证，这很有趣，因为当我们开始设置时，设备尚未加入或注册到Azure AD，但最终我们有了一个用于SSO的PRT，甚至满足了配置WHFB密钥的要求。

过程从登录到**特定应用程序**开始，这为Windows提供了一个**访问令牌**和一个**刷新令牌**。访问令牌可以用来**将设备加入到Azure AD**和**设置设备身份**。设备注册后，**刷新令牌**（在没有设备的情况下发出）与**新的设备身份一起用来请求主刷新令牌**。

{% hint style="info" %}
因此，可以使用常规刷新令牌，它不与设备绑定，但**与特定应用程序绑定**，首先**注册设备**，然后**请求更强大的令牌**，可用于任何登录场景。
{% endhint %}

并非每个刷新令牌都可以从普通刷新令牌“升级”为主刷新令牌。它需要在登录流程中使用特定的应用程序ID（客户端ID）。Windows使用客户端ID `29d9ed98-a469-4536-ade2-f981bc1d605e`（Microsoft Authentication Broker）和资源`https://enrollment.manage.microsoft.com/`来请求此令牌。我们可以使用roadtx的`gettokens`命令模拟这个流程，它支持几种不同的认证流程：

<figure><img src="../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

如果有策略要求使用MFA进行登录，我们可以改用`interactiveauth`模块：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

结果刷新令牌（在`.roadtools_auth`文件中缓存）可以用来请求设备注册服务的令牌，我们可以创建设备：

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

现在我们有了设备身份，我们可以将其与相同的刷新令牌结合起来获得PRT（为了便于阅读，两个刷新令牌都缩短了）：

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

从认证中得到的令牌将包含与注册时使用的相同的认证方法声明，所以**任何MFA的使用都会转移到PRT上**。我们得到的PRT可以用于任何认证流程，因此我们可以将我们有限的刷新令牌的范围扩展到任何可能的应用程序。

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

我们也可以使用它来登录浏览器流程：

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 配置Windows Hello for Business密钥 <a href="#provisioning-windows-hello-for-business-keys" id="provisioning-windows-hello-for-business-keys"></a>

如果您设置Windows并且为您的设备启用了WHFB，它将使用**相同的会话为新设置的设备配置WHFB密钥**。为此，我们需要一个带有`ngcmfa`（新一代凭证MFA）声明的访问令牌。只要我们在**过去10分钟内进行了MFA认证**，**之前**步骤中的**PRT**就是我们所需要的。我们可以要求**Azure AD给我们一个包含此声明的设备注册**服务的令牌，无需进一步的用户交互。为此，我们使用**roadtx**的`prtenrich`命令，它将请求此令牌。

<figure><img src="../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

有了这个新的访问令牌，我们可以为新的WHFB密钥进行配置。这个密钥可以用来在将来请求新的PRT，而不需要访问用户的密码。

<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

## 钓鱼获取主刷新令牌 <a href="#phishing-for-primary-refresh-tokens" id="phishing-for-primary-refresh-tokens"></a>

现在我们知道了流程是如何工作的，我们可以改变方法，使其适用于钓鱼。直接钓鱼PRT是不可能的，因为这需要在流程中使用现有的设备身份。我们**不能欺骗用户或他们的终端向我们发送直接请求PRT所需的信息**。然而，我们可以使用几种方法来**请求带有正确客户端和资源的常规刷新令牌**，然后使用它来**注册设备并请求PRT**。

### 设备代码钓鱼 <a href="#device-code-phishing" id="device-code-phishing"></a>

在上面的认证步骤中，我们使用了用户名和密码进行认证。然而，我们也可以使用**设备代码流程**来做到这一点。虽然Windows不使用这个流程来进行注册/加入过程，但它是一个**有效的OAuth流程**，它会给我们相同的**刷新令牌：**

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

如您所见，设备代码流程要求用户**在自己的设备上输入代码并完成认证**，这将在启动它的设备上提供令牌。这个流程也适合钓鱼，因为如果我们能**说服受害者使用设备代码进行认证，我们将代表他们获得令牌**。这不是一种新技术，但过去已有几人描述过。也有几个工具包可以**使整个过程更简单**。如果您想了解这项技术，这里有一些参考资料：

* [https://aadinternals.com/post/phishing/](https://aadinternals.com/post/phishing/)
* [https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html](https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html)
* [https://github.com/secureworks/squarephish](https://github.com/secureworks/squarephish)
* [https://www.blackhillsinfosec.com/dynamic-device-code-phishing/](https://www.blackhillsinfosec.com/dynamic-device-code-phishing/)

因此，让我们假设我们**说服了用户进行认证，并且我们收到了刷新令牌**。我们现在可以使用这个**刷新令牌**来：

* **如果我们还没有访问租户中的设备，注册或加入设备到Azure AD**。
* 使用**刷新令牌请求PRT**。
* 如果用户在使用设备代码流程进行认证时进行了“新鲜”的MFA，我们还可以**在他们的账户上注册WHFB凭证以实现持久性**。

如果您要执行这种攻击，有一些注意事项：

* **设备代码在启动设备代码流程后只有15分钟的有效期**，如果您想用它来进行钓鱼，这会增加额外的限制。一些工具会通过在用户与电子邮件互动时才创建设备代码来解决这个问题，例如通过二维码。
* **在租户中注册或加入设备可能仅限于特定用户**。一般来说，加入设备比注册它们受到更多限制。除非有特定的策略要求一定的设备状态，否则令牌的实用性不会有实际差异。
* **只有在用户主动进行MFA时，才能注册WHFB凭证**。如果他们使用现有会话中的设备代码，MFA声明将传递给刷新令牌，并且很可能不够新以配置WHFB密钥。在我的测试中，只有当用户在未受管理的设备上有现有会话时，才会使用缓存的登录状态，在使用SSO登录的浏览器上不会自动使用缓存的登录。

下面的视频展示了这种攻击的概念验证。在实际场景中，您可以使用您喜欢的设备代码钓鱼框架或方法来进行钓鱼部分。

{% embed url="https://dirkjanm.io/assets/raw/prtphish.mp4" %}

上面的视频使用了[deviceCode2WinHello](https://github.com/kiwids0220/deviceCode2WinHello)脚本，由SpecterOps的[Kai](https://twitter.com/mhskai2017)编写（请参阅博客末尾的结论）。它还使用了`roadtx keepassauth`模块进行认证，在现实中您需要说服受害者进行认证，但这对于演示来说更容易。

### 凭证钓鱼 <a href="#credential-phishing" id="credential-phishing"></a>

也可以使用凭证钓鱼方法执行钓鱼攻击，例如使用evilginx作为框架。如果我们使用Microsoft 365的phishlet进行登录，例如[这个](https://github.com/BakkerJan/evilginx3/blob/main/microsoft365.yaml)由Jan Bakker提供的，我们将获得受害者的会话cookie。这些会话cookie可以与roadtx一起使用来请求正确的令牌，从那里开始攻击是相同的：

<figure><img src="../../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

## 预防和检测 <a href="#prevention-and-detection" id="prevention-and-detection"></a>

没有太多方法可以预防这些攻击。设备代码钓鱼是少数不会被要求特定MFA强度所阻止的方法之一，因为用户是针对合法的Microsoft域进行认证的。此外，不幸的是，没有办法阻止某些OAuth流程，如设备代码流程。上面描述的凭证钓鱼方法更容易预防，因为这将发生在假网站上，这将阻止某些MFA方法的工作。

阻止这种攻击的唯一真正有效的方法是要求设备通过MDM或MAM进行管理，通过有条件访问策略要求设备符合要求或混合加入。符合这一政策将要求新注册的设备也要在Intune中注册。只要Intune足够锁定，以阻止人们注册非企业或假设备，我们新注册的设备将无法变得符合要求并满足这些政策的要求。请注意，设备注册流程本身不会被要求符合设备的政策所阻止，因为这个流程本质上是从这些政策中排除的（在设备注册期间，您不可能已经有一个符合要求的设备）。所以，如果有要求符合要求或混合加入设备的政策，仍然可以获得PRT。然而，PRT不能用于认证或注册WHFB密钥，因为这将要求设备符合要求或混合加入。

幸运的是，检测这种技术更容易。Windows不会使用设备代码流程来注册或加入自己到Azure AD，但它会交互式地提示用户进行认证。由于认证流程显示在登录日志中，因此基于应用ID和认证流程编写检测查询相当容易。一个示例KQL查询可能看起来像这样：
```
SigninLogs
| where AppId == "29d9ed98-a469-4536-ade2-f981bc1d605e" //Broker app client id
and AuthenticationProtocol == "deviceCode"
```
在我与微软就此话题的讨论中，我被告知在某些情况下，设备代码流程是由代理应用程序合法使用的，因此这个查询可能会产生一些误报。如果你发现此查询有合法匹配，请随时联系，我们可以看看是否有可能对其进行微调，以排除合法情况。

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 **HackTricks** 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享你的黑客技巧**。

</details>
