# Az - Phishing de Primary Refresh Token (Microsoft Entra)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Post copiado de** [**https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/**](https://dirkjanm.io/phishing-for-microsoft-entra-primary-refresh-tokens/)

## Informa√ß√µes B√°sicas

**Primary Refresh Tokens** s√£o usados para Single Sign On em dispositivos que est√£o Azure AD/Microsoft Entra joined, registrados ou hybrid joined. Eles podem ser usados tanto em fluxos de autentica√ß√£o em navegador para aplica√ß√µes web quanto para autenticar em aplica√ß√µes m√≥veis e de desktop rodando no dispositivo.

Note que Primary Refresh tokens podem ser usados para **solicitar um access token para acessar os dados**, mas Access Tokens n√£o podem ser usados para solicitar um Primary Refresh Token.

Para obter um Primary Refresh Token voc√™ precisa come√ßar com uma identidade de dispositivo, e ent√£o usar as credenciais do usu√°rio para solicitar um PRT. Isso limita como esses tokens poderosos podem ser emitidos e torna mais dif√≠cil para atacantes obt√™-los.

Voc√™ pode encontrar mais informa√ß√µes sobre PRTs em:

{% content-ref url="az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-primary-refresh-token-prt.md)
{% endcontent-ref %}

## Como o Fluxo Funciona

Se algu√©m configura uma nova instala√ß√£o do Windows, geralmente s√≥ √© necess√°rio autenticar uma vez durante o processo de configura√ß√£o, e isso √© interessante, j√° que no momento em que come√ßamos a configura√ß√£o o dispositivo ainda n√£o est√° joined ou registrado no Azure AD, mas no final temos um PRT que √© usado para SSO, e at√© atende aos requisitos para provisionar chaves WHFB.

O processo come√ßa ao se autenticar em uma **aplica√ß√£o espec√≠fica**, o que fornece ao Windows um **access token** e um **refresh token**. Os access tokens podem ser usados para **join do dispositivo ao Azure AD** e **configurar a identidade do dispositivo**. Ap√≥s o registro do dispositivo, o **refresh token** que foi emitido sem um dispositivo, √© usado com a **nova identidade do dispositivo para solicitar um Primary Refresh Token**.

{% hint style="info" %}
Portanto, √© poss√≠vel usar um regular refresh token, que n√£o est√° atrelado a um dispositivo mas est√° **atrelado a uma aplica√ß√£o espec√≠fica**, para primeiro **registrar um dispositivo** e ent√£o **solicitar um token mais poderoso** que pode ser usado em qualquer cen√°rio de autentica√ß√£o.
{% endhint %}

O ‚Äúupgrade‚Äù de refresh token normal para primary refresh token n√£o √© poss√≠vel com todo refresh token. Ele requer um application ID (client ID) espec√≠fico no fluxo de autentica√ß√£o. O Windows usa o client ID `29d9ed98-a469-4536-ade2-f981bc1d605e` (Microsoft Authentication Broker) e o recurso `https://enrollment.manage.microsoft.com/` para essa solicita√ß√£o. Podemos emular esse fluxo com o comando `gettokens` do roadtx, que suporta v√°rios fluxos de autentica√ß√£o diferentes:

<figure><img src="../../../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

Se houver uma pol√≠tica que exige MFA para autenticar, podemos em vez disso usar o m√≥dulo `interactiveauth`:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

O refresh token resultante (que √© armazenado no arquivo `.roadtools_auth`) pode ser usado para solicitar um token para o servi√ßo de registro de dispositivo, onde podemos criar o dispositivo:

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Agora que temos uma identidade de dispositivo, podemos combinar isso com o mesmo refresh token para obter um PRT (ambos os refresh tokens encurtados para legibilidade):

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Tokens resultantes da autentica√ß√£o conter√£o as mesmas reivindica√ß√µes de m√©todo de autentica√ß√£o usadas durante o registro, ent√£o **qualquer uso de MFA ser√° transferido para o PRT**. O PRT que obtemos pode ser usado em qualquer fluxo de autentica√ß√£o, ent√£o podemos expandir o escopo do nosso limitado refresh token para qualquer aplicativo poss√≠vel.

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Tamb√©m podemos usar isso para autenticar em fluxos de navegador:

<figure><img src="../../../.gitbook/assets/image (5) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Provisionamento de chaves Windows Hello for Business <a href="#provisioning-windows-hello-for-business-keys" id="provisioning-windows-hello-for-business-keys"></a>

Se voc√™ configura o Windows e o WHFB est√° habilitado para seu dispositivo, ele usar√° a **mesma sess√£o para provisionar a chave WHFB para o dispositivo rec√©m-configurado**. Para fazer isso, precisaremos de um access token com a reivindica√ß√£o `ngcmfa` (new generation credentials MFA). Contanto que tenhamos feito a **autentica√ß√£o MFA nos √∫ltimos 10 minutos**, o **PRT** do **passo anterior** √© tudo que precisamos. Podemos pedir ao **Azure AD para nos dar um token para o servi√ßo de registro de dispositivo** que cont√©m essa reivindica√ß√£o, sem necessidade de mais intera√ß√£o do usu√°rio. Para fazer isso, usamos o comando `prtenrich` do **roadtx**, que solicitar√° esse token.

<figure><img src="../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Com esse novo access token, podemos provisionar a nova chave WHFB. Esta chave pode ser usada para tamb√©m solicitar novos PRTs no futuro, sem necessidade de acesso √† senha do usu√°rio.

<figure><img src="../../../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

## Phishing de Primary Refresh Tokens <a href="#phishing-for-primary-refresh-tokens" id="phishing-for-primary-refresh-tokens"></a>

Agora que sabemos como o processo funciona, podemos mudar a abordagem para torn√°-la utiliz√°vel para phishing. Phishing de PRTs diretamente n√£o √© poss√≠vel, j√° que isso requer uma identidade de dispositivo existente para ser usada durante o fluxo. N√≥s **n√£o podemos enganar usu√°rios ou seus endpoints para nos enviar as informa√ß√µes necess√°rias para solicitar diretamente um PRT**. No entanto, podemos usar v√°rios m√©todos para **pedir um regular refresh token com o cliente e recurso certos**, para ent√£o usar isso para **registrar um dispositivo e solicitar um PRT**.

### Phishing de c√≥digo de dispositivo <a href="#device-code-phishing" id="device-code-phishing"></a>

No passo de autentica√ß√£o acima, usamos um nome de usu√°rio e senha para autenticar. No entanto, tamb√©m podemos usar o **fluxo de c√≥digo de dispositivo para isso**. Embora o Windows n√£o use esse fluxo para o processo de registro/join, √© um **fluxo OAuth v√°lido** que nos dar√° o mesmo **refresh token:**

<figure><img src="../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

Como voc√™ pode ver, o fluxo de c√≥digo de dispositivo pede aos usu√°rios para **inserir um c√≥digo em seu pr√≥prio dispositivo e completar a autentica√ß√£o**, o que fornecer√° os tokens no dispositivo em que foi iniciado. Este fluxo tamb√©m √© adequado para phishing, porque se conseguirmos **convencer nossa v√≠tima a realizar a autentica√ß√£o com um c√≥digo de dispositivo, obteremos tokens em nome dela**. Esta n√£o √© uma t√©cnica nova, mas foi descrita por v√°rias pessoas no passado. Existem tamb√©m v√°rios kits de ferramentas que **facilitam todo o processo**. Se voc√™ quiser ler mais sobre essa t√©cnica, aqui est√£o algumas refer√™ncias:

* [https://aadinternals.com/post/phishing/](https://aadinternals.com/post/phishing/)
* [https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html](https://0xboku.com/2021/07/12/ArtOfDeviceCodePhish.html)
* [https://github.com/secureworks/squarephish](https://github.com/secureworks/squarephish)
* [https://www.blackhillsinfosec.com/dynamic-device-code-phishing/](https://www.blackhillsinfosec.com/dynamic-device-code-phishing/)

Ent√£o vamos supor que n√≥s **convencemos um usu√°rio a autenticar, e recebemos o refresh token**. Agora podemos usar esse **refresh token** para:

* **Registrar ou join um dispositivo no Azure AD** se ainda n√£o tivermos acesso a um dispositivo no tenant.
* Usar o **refresh token para solicitar um PRT**.
* Se o usu√°rio realizou uma autentica√ß√£o MFA "fresca" ao autenticar com o fluxo de c√≥digo de dispositivo, tamb√©m podemos **registrar credenciais WHFB em sua conta para persist√™ncia**.

H√° algumas ressalvas a isso, que voc√™ deve levar em conta se estiver realizando esse ataque:

* O **c√≥digo de dispositivo s√≥ √© v√°lido por 15 minutos** ap√≥s iniciar o fluxo de c√≥digo de dispositivo, o que adiciona restri√ß√µes extras se voc√™ quiser usar isso para phishing. Algumas ferramentas levam isso em conta criando o c√≥digo de dispositivo apenas quando o usu√°rio interage com o e-mail, por exemplo, via um c√≥digo QR.
* **Registrar ou join dispositivos pode ser restrito no tenant apenas a usu√°rios espec√≠ficos**. Em geral, join dispositivos √© restrito com mais frequ√™ncia do que registr√°-los. A menos que haja pol√≠ticas espec√≠ficas que exijam um certo status de dispositivo, n√£o haver√° uma diferen√ßa pr√°tica na usabilidade do token.
* **Registrar credenciais WHFB s√≥ √© poss√≠vel se o usu√°rio realizou ativamente MFA ao usar o c√≥digo de dispositivo**. Se eles usarem o c√≥digo de dispositivo de uma sess√£o existente em seu dispositivo gerenciado, a reivindica√ß√£o MFA ser√° passada para o refresh token e provavelmente n√£o ser√° recente o suficiente para provisionar uma chave WHFB. Nos meus testes, o status de login armazenado s√≥ ser√° usado se o usu√°rio tiver uma sess√£o existente em um dispositivo n√£o gerenciado, e em navegadores que fizeram login usando SSO, n√£o usar√° automaticamente o login armazenado.

O v√≠deo abaixo mostra o ataque como prova de conceito. Em cen√°rios pr√°ticos, voc√™ poderia usar sua estrutura ou m√©todo de phishing de c√≥digo de dispositivo preferido para fazer a parte de phishing.

{% embed url="https://dirkjanm.io/assets/raw/prtphish.mp4" %}

O v√≠deo acima usa o script [deviceCode2WinHello](https://github.com/kiwids0220/deviceCode2WinHello) que automatiza todos esses passos, escrito por [Kai](https://twitter.com/mhskai2017) da SpecterOps (veja conclus√µes no final do blog). Ele tamb√©m usa o m√≥dulo `roadtx keepassauth` para fazer a autentica√ß√£o, na realidade voc√™ teria que convencer sua v√≠tima a fazer a autentica√ß√£o, mas isso foi mais f√°cil para a demonstra√ß√£o.

### Phishing de credenciais <a href="#credential-phishing" id="credential-phishing"></a>

Tamb√©m √© poss√≠vel realizar o ataque de phishing usando m√©todos de phishing de credenciais, por exemplo com evilginx como framework. Se usarmos um phishlet do Microsoft 365 para fazer login, por exemplo [este](https://github.com/BakkerJan/evilginx3/blob/main/microsoft365.yaml) de Jan Bakker, obteremos os cookies de sess√£o da v√≠tima. Esses cookies de sess√£o podem ser usados com roadtx para solicitar os tokens corretos, e a partir da√≠ o ataque √© o mesmo:

<figure><img src="../../../.gitbook/assets/image (10) (1).png" alt=""><figcaption></figcaption></figure>

## Preven√ß√£o e detec√ß√£o <a href="#prevention-and-detection" id="prevention-and-detection"></a>

N√£o h√° muitas maneiras de prevenir esses ataques. Phishing de c√≥digo de dispositivo √© um dos poucos m√©todos que n√£o √© prevenido exigindo uma certa for√ßa de MFA, j√° que os usu√°rios realizam essa autentica√ß√£o contra os dom√≠nios leg√≠timos da Microsoft. Al√©m disso, infelizmente n√£o h√° como bloquear certos fluxos OAuth como o fluxo de c√≥digo de dispositivo. O m√©todo de phishing de credenciais descrito acima √© mais f√°cil de prevenir, j√° que isso acontecer√° em um site falso que impedir√° alguns m√©todos de MFA de funcionar.

A √∫nica maneira realmente eficaz de bloquear esse ataque √© exigir que um dispositivo seja gerenciado via MDM ou MAM, tendo uma pol√≠tica de Acesso Condicional em vigor que exige um dispositivo compliant ou hybrid joined. Cumprir com essa pol√≠tica exigiria que o dispositivo rec√©m-registrado tamb√©m fosse inscrito no Intune. Desde que o Intune esteja suficientemente bloqueado para impedir que pessoas inscrevam dispositivos n√£o corporativos ou falsos, nosso dispositivo rec√©m-registrado n√£o ser√° capaz de se tornar compliant e atender aos requisitos dessas pol√≠ticas. Note que o pr√≥prio fluxo de registro de dispositivo n√£o √© bloqueado por pol√≠ticas que exigem dispositivos compliant, j√° que esse fluxo √© por defini√ß√£o exclu√≠do dessas pol√≠ticas (voc√™ n√£o pode j√° ter um dispositivo compliant durante o registro de dispositivo). Ent√£o, se pol√≠ticas estiverem em vigor que exigem um dispositivo compliant ou hybrid joined, ainda √© poss√≠vel obter um PRT. O PRT, no entanto, n√£o poder√° ser usado para autenticar ou para inscrever as chaves WHFB, j√° que isso exigiria que o dispositivo fosse compliant ou hybrid joined.

A detec√ß√£o dessa t√©cnica √© felizmente mais f√°cil. O Windows n√£o usar√° o fluxo de C√≥digo de Dispositivo para registrar ou join ao Azure AD, mas solicitar√° interativamente que o usu√°rio se autentique. Como o fluxo de autentica√ß√£o √© mostrado nos logs de Sign-in, √© bastante f√°cil escrever consultas de detec√ß√£o baseadas no app ID e no fluxo de autentica√ß√£o. Uma consulta KQL de exemplo poderia ser assim:
```
SigninLogs
| where AppId == "29d9ed98-a469-4536-ade2-f981bc1d605e" //Broker app client id
and AuthenticationProtocol == "deviceCode"
```
Durante minhas discuss√µes com a Microsoft sobre este t√≥pico, fui informado que, em alguns casos, o fluxo de c√≥digo de dispositivo √© usado legitimamente pela aplica√ß√£o intermedi√°ria, portanto, esta consulta pode gerar alguns falsos positivos. Se voc√™ encontrar algumas correspond√™ncias leg√≠timas com esta consulta, sinta-se √† vontade para entrar em contato para que possamos ver se √© poss√≠vel ajust√°-la para excluir casos leg√≠timos.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
