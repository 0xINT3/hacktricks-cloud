# PTA - Autenticaci칩n de paso

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica

La Autenticaci칩n de paso de Azure Active Directory (Azure AD) permite a tus usuarios **iniciar sesi칩n tanto en aplicaciones locales como basadas en la nube utilizando las mismas contrase침as**. Esta caracter칤stica proporciona a tus usuarios una mejor experiencia - una contrase침a menos que recordar, y reduce los costos del servicio de asistencia t칠cnica de IT porque tus usuarios tienen menos probabilidades de olvidar c칩mo iniciar sesi칩n. Cuando los usuarios inician sesi칩n usando Azure AD, esta caracter칤stica **valida las contrase침as de los usuarios directamente contra tu Active Directory local**.

<figure><img src="../../../../.gitbook/assets/image (8) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

En PTA las **identidades** est치n **sincronizadas** pero las **contrase침as** **no**, como en PHS.

La autenticaci칩n se valida en el AD local y la comunicaci칩n con la nube se realiza mediante un **agente de autenticaci칩n** que se ejecuta en un **servidor local** (no necesita estar en el DC local).

### Flujo de autenticaci칩n

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Para **iniciar sesi칩n** el usuario es redirigido a **Azure AD**, donde env칤a el **nombre de usuario** y la **contrase침a**
2. Las **credenciales** se **cifran** y se colocan en una **cola** en Azure AD
3. El **agente de autenticaci칩n local** recoge las **credenciales** de la cola y las **descifra**. Este agente se llama **"agente de autenticaci칩n de paso"** o **agente PTA.**
4. El **agente** **valida** las credenciales contra el **AD local** y env칤a la **respuesta** **de vuelta** a Azure AD que, si la respuesta es positiva, **completa el inicio de sesi칩n** del usuario.

{% hint style="warning" %}
Si un atacante **compromete** el **PTA**, puede **ver** todas las **credenciales** de la cola (en **texto claro**).\
Tambi칠n puede **validar cualquier credencial** en AzureAD (ataque similar al de Skeleton key).
{% endhint %}

### De local a la nube

Si tienes acceso de **administrador** al servidor **Azure AD Connect** con el **agente PTA** en ejecuci칩n, puedes usar el m칩dulo **AADInternals** para **insertar una puerta trasera** que **validar치 TODAS las contrase침as** introducidas (as칤 todas las contrase침as ser치n v치lidas para la autenticaci칩n):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Si la **instalaci칩n falla**, probablemente se deba a la falta de [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Tambi칠n es posible **ver las contrase침as en texto claro enviadas al agente PTA** utilizando el siguiente cmdlet en la m치quina donde se instal칩 el backdoor anterior:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Esta puerta trasera har치:

* Crear una carpeta oculta `C:\PTASpy`
* Copiar un `PTASpy.dll` a `C:\PTASpy`
* Inyectar `PTASpy.dll` en el proceso `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Cuando se reinicia el servicio AzureADConnectAuthenticationAgent, PTASpy se "descarga" y debe ser reinstalado.
{% endhint %}

### Nube -> Local

{% hint style="danger" %}
Despu칠s de obtener **privilegios de GA** en la nube, es posible **registrar un nuevo agente PTA** configur치ndolo en una **m치quina controlada por el atacante**. Una vez que el agente est치 **configurado**, podemos **repetir** los **pasos anteriores** para **autenticarnos usando cualquier contrase침a** y tambi칠n, **obtener las contrase침as en texto claro.**
{% endhint %}

### Seamless SSO

Es posible usar Seamless SSO con PTA, lo cual es vulnerable a otros abusos. Verificar en:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
