# PTA - 透传身份验证

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## 基本信息

Azure Active Directory（Azure AD）透传身份验证允许用户使用相同的密码登录本地和基于云的应用程序。此功能为用户提供了更好的体验-只需记住一个密码，并减少了 IT 帮助台的成本，因为用户不太可能忘记如何登录。当用户使用 Azure AD 登录时，此功能会直接对用户的密码进行验证，验证方式是针对本地 Active Directory 进行验证。

<figure><img src="../../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

在 PTA 中，身份同步，但密码不同步，与 PHS 不同。

身份验证在本地 AD 中进行验证，与云端的通信由在本地服务器上运行的身份验证代理（不需要在本地 DC 上运行）完成。

### 身份验证流程

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. 用户被重定向到 Azure AD 进行登录，用户发送用户名和密码。
2. 凭据被加密并设置在 Azure AD 的队列中。
3. 本地身份验证代理从队列中获取凭据并对其进行解密。此代理称为“透传身份验证代理”或 PTA 代理。
4. 代理将凭据与本地 AD 进行验证，并将响应发送回 Azure AD，如果响应为正面，则完成用户的登录。

{% hint style="warning" %}
如果攻击者入侵了 PTA，他可以查看队列中的所有凭据（以明文形式）。他还可以对 AzureAD 验证任何凭据（类似于 Skeleton key 攻击）。
{% endhint %}

### 本地 -> 云端

如果您具有在运行 PTA 代理的 Azure AD Connect 服务器上的管理员访问权限，可以使用 AADInternals 模块插入后门，以验证所有输入的密码（因此所有密码都将有效进行身份验证）：
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
如果**安装失败**，可能是由于缺少[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)。
{% endhint %}

还可以使用以下命令在之前安装了后门的机器上**查看发送给 PTA 代理的明文密码**：
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
这个后门将会：

* 创建一个隐藏文件夹 `C:\PTASpy`
* 将 `PTASpy.dll` 复制到 `C:\PTASpy`
* 注入 `PTASpy.dll` 到 `AzureADConnectAuthenticationAgentService` 进程中

{% hint style="info" %}
当 AzureADConnectAuthenticationAgent 服务重新启动时，PTASpy 将被“卸载”，必须重新安装。
{% endhint %}

### 云 -> On-Prem

{% hint style="danger" %}
在云端获得 **GA 特权** 后，可以通过将其设置在 **攻击者控制的机器上** 来 **注册一个新的 PTA 代理**。一旦代理 **设置完成**，我们可以 **重复** 上述步骤来 **使用任意密码进行身份验证**，并且还可以 **获取明文密码**。
{% endhint %}

### 无缝 SSO

可以使用 PTA 进行无缝 SSO，这也容易受到其他滥用的攻击。在以下链接中查看详细信息：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考资料

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF 版本，请查看 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
