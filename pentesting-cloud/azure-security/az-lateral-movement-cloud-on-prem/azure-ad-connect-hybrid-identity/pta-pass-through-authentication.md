# Az - PTA - Πέρασμα ταυτότητας

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Βασικές πληροφορίες

[Από τα έγγραφα:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Το Azure Active Directory (Azure AD) Pass-through Authentication επιτρέπει στους χρήστες σας να **συνδεθούν τόσο σε εφαρμογές εγκατεστημένες στον τοπικό υπολογιστή όσο και σε εφαρμογές βασισμένες στο cloud χρησιμοποιώντας τους ίδιους κωδικούς πρόσβασης**. Αυτή η δυνατότητα παρέχει στους χρήστες σας μια καλύτερη εμπειρία - έναν λιγότερο κωδικό πρόσβασης που πρέπει να θυμούνται και μειώνει το κόστος της τεχνικής υποστήριξης του IT, καθώς οι χρήστες σας είναι λιγότερο πιθανό να ξεχάσουν πώς να συνδεθούν. Όταν οι χρήστες συνδέονται χρησιμοποιώντας το Azure AD, αυτή η δυνατότητα **επικυρώνει τους κωδικούς πρόσβασης των χρηστών απευθείας έναντι του τοπικού ενεργού καταλόγου**.

Στο PTA, οι ταυτότητες συγχρονίζονται, αλλά οι κωδικοί πρόσβασης όχι, όπως στο PHS.

Η επαλήθευση γίνεται στον τοπικό AD και η επικοινωνία με το cloud γίνεται από έναν **πράκτορα επαλήθευσης** που εκτελείται σε έναν **διακομιστή τοπικού υπολογιστή** (δεν χρειάζεται να βρίσκεται στον τοπικό ενεργό κατάλογο).

### Ροή επαλήθευσης

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Για να **συνδεθεί** ο χρήστης ανακατευθύνεται στο **Azure AD**, όπου αποστέλλει το **όνομα χρήστη** και το **κωδικό πρόσβασης**
2. Τα **διαπιστευτήρια** κρυπτογραφούνται και τοποθετούνται σε μια **ουρά** στο Azure AD
3. Ο **πράκτορας επαλήθευσης του τοπικού υπολογιστή** συλλέγει τα **διαπιστευτήρια** από την ουρά και τα **αποκρυπτογραφεί**. Αυτός ο πράκτορας ονομάζεται **"πράκτορας πέρασματος ταυτότητας"** ή **πράκτορας PTA**.
4. Ο **πράκτορας** επαληθεύει τα διαπιστευτήρια έναντι του τοπικού AD και στέλνει την απάντηση **πίσω** στο Azure AD, το οποίο, εάν η απάντηση είναι θετική, **ολοκληρώνει τη σύνδεση** του χρήστη.

{% hint style="warning" %}
Εάν ένας επιτιθέμενος **διαρρεύσει** τον **PTA**, μπορεί να **δει** όλα τα **διαπιστευτήρια** από την ουρά (σε **καθαρό κείμενο**).\
Μπορεί επίσης να **επαληθεύσει οποιαδήποτε διαπιστευτήρια** στο AzureAD (παρόμοια επίθεση με το Skeleton key).
{% endhint %}

### Τοπικός υπολογιστής -> cloud

Εάν έχετε πρόσβαση **διαχειριστή** στον **διακομιστή Azure AD Connect** με τον **πράκτορα PTA** που εκτελείται, μπορείτε να χρησιμοποιήσετε το **module AADInternals** για να **εισαγάγετε μια πίσω πόρτα** που θα **επαληθεύει ΟΛΟΥΣ τους κωδικούς πρόσβασης** που εισάγονται (έτσι όλοι οι κωδικοί πρόσβασης θα είναι έγκυροι για την επαλήθευση):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Εάν η **εγκατάσταση αποτύχει**, αυτό πιθανότατα οφείλεται στην απουσία των [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Είναι επίσης δυνατόν να **δείτε τους καθαρούς κειμενικούς κωδικούς που αποστέλλονται στον πράκτορα PTA** χρησιμοποιώντας την ακόλουθη εντολή στον υπολογιστή όπου έχει εγκατασταθεί η προηγούμενη παρασκηνιακή πύλη:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Αυτή η πίσω πόρτα θα:

* Δημιουργήσει έναν κρυφό φάκελο `C:\PTASpy`
* Αντιγράψει ένα `PTASpy.dll` στο `C:\PTASpy`
* Εισχωρεί το `PTASpy.dll` στη διεργασία `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Όταν η υπηρεσία AzureADConnectAuthenticationAgent επανεκκινείται, το PTASpy "εκφορτώνεται" και πρέπει να επανεγκατασταθεί.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Αφού αποκτηθούν **προνόμια GA** στο cloud, είναι δυνατόν να **καταχωρηθεί ένας νέος πράκτορας PTA** ορίζοντάς τον σε μια **μηχανή που ελέγχεται από τον επιτιθέμενο**. Αφού ο πράκτορας είναι **εγκατεστημένος**, μπορούμε να **επαναλάβουμε** τα **προηγούμενα** βήματα για να **πιστοποιηθούμε χρησιμοποιώντας οποιοδήποτε κωδικό πρόσβασης** και επίσης, να **λάβουμε τους κωδικούς πρόσβασης σε καθαρό κείμενο**.
{% endhint %}

### Seamless SSO

Είναι δυνατόν να χρησιμοποιηθεί το Seamless SSO με το PTA, το οποίο είναι ευάλωτο σε άλλες καταχρήσεις. Ελέγξτε το στο:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Αναφορές

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Συμμετάσχετε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
