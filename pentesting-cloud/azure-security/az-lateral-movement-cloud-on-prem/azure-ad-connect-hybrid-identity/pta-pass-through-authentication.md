# Az - PTA - Prosljeđivanje autentifikacije

<details>

<summary><strong>Naučite hakiranje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite vidjeti **oglašavanje vaše kompanije u HackTricks-u** ili **preuzeti HackTricks u PDF formatu** Provjerite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podijelite svoje hakirajuće trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Prosljeđivanje autentifikacije omogućava vašim korisnicima da se **prijave na lokalne i cloud aplikacije koristeći iste lozinke**. Ova funkcionalnost pruža korisnicima bolje iskustvo - jednu manje lozinku koju treba zapamtiti, i smanjuje troškove IT helpdeska jer je manja vjerovatnoća da će korisnici zaboraviti kako se prijaviti. Kada korisnici se prijave koristeći Azure AD, ova funkcionalnost **validira korisničke lozinke direktno protiv lokalnog Active Directory-ja**.

U PTA **identiteti** su **sinhronizovani** ali **lozinke** **nisu** kao kod PHS.

Autentifikacija se validira u lokalnom AD-u, a komunikacija sa cloud-om se vrši putem **agent za autentifikaciju** koji se izvršava na **lokalnom serveru** (ne mora biti na lokalnom DC-u).

### Tok autentifikacije

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Da bi se **prijavio**, korisnik je preusmjeren na **Azure AD**, gdje šalje **korisničko ime** i **lozinku**
2. **Pristupni podaci** su **enkriptovani** i postavljeni u **red** u Azure AD-u
3. **Agent za autentifikaciju na lokalnom serveru** prikuplja **pristupne podatke** iz reda i **dekriptuje** ih. Ovaj agent se naziva **"Pass-through authentication agent"** ili **PTA agent**.
4. **Agent** **validira** pristupne podatke protiv lokalnog AD-a i šalje **odgovor** **nazad** Azure AD-u koji, ako je odgovor pozitivan, **završava prijavu** korisnika.

{% hint style="warning" %}
Ako napadač **kompromituje** **PTA**, može **vidjeti** sve **pristupne podatke** iz reda (u **čistom tekstu**).\
Takođe može **validirati bilo koje pristupne podatke** prema AzureAD-u (sličan napad kao Skeleton key).
{% endhint %}

### Lokalno -> cloud

Ako imate **admin** pristup **Azure AD Connect serveru** sa pokrenutim **PTA** **agentom**, možete koristiti modul **AADInternals** da **ubacite tajni ulaz** koji će **validirati SVE lozinke** unesene (tako da će sve lozinke biti validne za autentifikaciju):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Ako **instalacija ne uspe**, verovatno je zbog nedostajućih [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Takođe je moguće **videti lozinke u čistom tekstu koje su poslate PTA agentu** koristeći sledeću cmdlet komandu na mašini gde je prethodna zadnja vrata instalirana:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ova zadnja vrata će:

* Kreirati skriveni folder `C:\PTASpy`
* Kopirati `PTASpy.dll` u `C:\PTASpy`
* Umetnuti `PTASpy.dll` u proces `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Kada se ponovno pokrene AzureADConnectAuthenticationAgent servis, PTASpy se "isključuje" i mora biti ponovno instaliran.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Nakon sticanja **GA privilegija** na cloud-u, moguće je **registrovati novi PTA agent** postavljanjem na **napadačevu kontrolisanu mašinu**. Kada je agent **postavljen**, možemo **ponoviti** **prethodne** korake da bismo se **autentifikovali koristeći bilo koju lozinku** i takođe, **dobili lozinke u čistom tekstu**.
{% endhint %}

### Seamless SSO

Moguće je koristiti Seamless SSO sa PTA, što je ranjivo na druge zloupotrebe. Proverite to u:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
