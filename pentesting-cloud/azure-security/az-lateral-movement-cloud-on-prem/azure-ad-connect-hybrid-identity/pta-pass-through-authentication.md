# Az - PTA - Autenticaci√≥n de paso

<details>

<summary><strong>Aprende hacking de AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci√≥n B√°sica

[De la documentaci√≥n:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) La Autenticaci√≥n de Paso de Azure Active Directory (Azure AD) permite a tus usuarios **iniciar sesi√≥n en aplicaciones tanto locales como basadas en la nube utilizando las mismas contrase√±as**. Esta caracter√≠stica proporciona a tus usuarios una mejor experiencia, una contrase√±a menos que recordar, y reduce los costos de soporte t√©cnico de TI porque es menos probable que tus usuarios olviden c√≥mo iniciar sesi√≥n. Cuando los usuarios inician sesi√≥n usando Azure AD, esta caracter√≠stica **valida las contrase√±as de los usuarios directamente contra tu Active Directory local**.

En PTA, las **identidades** est√°n **sincronizadas** pero las **contrase√±as** **no lo est√°n** como en PHS.

La autenticaci√≥n se valida en el AD local y la comunicaci√≥n con la nube se realiza a trav√©s de un **agente de autenticaci√≥n** que se ejecuta en un **servidor local** (no es necesario que est√© en el DC local).

### Flujo de Autenticaci√≥n

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Para **iniciar sesi√≥n**, el usuario es redirigido a **Azure AD**, donde env√≠a el **nombre de usuario** y la **contrase√±a**
2. Las **credenciales** se **encriptan** y se establecen en una **cola** en Azure AD
3. El **agente de autenticaci√≥n local** recopila las **credenciales** de la cola y las **descifra**. Este agente se llama **"agente de autenticaci√≥n de paso"** o **agente PTA**.
4. El **agente** **valida** las credenciales contra el **AD local** y env√≠a la **respuesta** de vuelta a Azure AD que, si la respuesta es positiva, **completa la sesi√≥n** del usuario.

{% hint style="warning" %}
Si un atacante **compromete** el **PTA**, puede **ver** todas las **credenciales** de la cola (en **texto claro**).\
Tambi√©n puede **validar cualquier credencial** en el AzureAD (ataque similar a la clave Skeleton).
{% endhint %}

### Local -> nube

Si tienes acceso de **administrador** al **servidor de Azure AD Connect** con el **agente PTA** en ejecuci√≥n, puedes usar el m√≥dulo **AADInternals** para **insertar una puerta trasera** que **validar√° TODAS las contrase√±as** introducidas (por lo que todas las contrase√±as ser√°n v√°lidas para la autenticaci√≥n):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Si la **instalaci√≥n falla**, esto probablemente se deba a la falta de [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

Tambi√©n es posible **ver las contrase√±as en texto claro enviadas al agente PTA** utilizando el siguiente cmdlet en la m√°quina donde se instal√≥ la puerta trasera anteriormente:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Este backdoor realizar√°:

* Crear una carpeta oculta `C:\PTASpy`
* Copiar un `PTASpy.dll` a `C:\PTASpy`
* Inyectar `PTASpy.dll` en el proceso `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Cuando el servicio AzureADConnectAuthenticationAgent se reinicia, PTASpy se "descarga" y debe ser reinstalado.
{% endhint %}

### Nube -> Local

{% hint style="danger" %}
Despu√©s de obtener **privilegios GA** en la nube, es posible **registrar un nuevo agente PTA** configur√°ndolo en una **m√°quina controlada por el atacante**. Una vez que el agente est√° **configurado**, podemos **repetir** los **pasos anteriores** para **autenticar usando cualquier contrase√±a** y tambi√©n, **obtener las contrase√±as en texto claro**.
{% endhint %}

### SSO sin interrupciones

Es posible utilizar SSO sin interrupciones con PTA, lo cual es vulnerable a otros abusos. Verif√≠calo en:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
