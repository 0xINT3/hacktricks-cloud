# Az - PTA - 패스스루 인증

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로**부터 **히어로**까지 AWS 해킹을 배우세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고**하거나 **PDF 형식으로 HackTricks 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* 💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 기본 정보

[문서에서:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) 패스스루 인증을 사용하면 사용자가 **동일한 암호를 사용하여 온프레미스 및 클라우드 기반 애플리케이션에 로그인**할 수 있습니다. 이 기능은 사용자에게 더 나은 경험을 제공하며 - 기억해야 할 암호가 하나 줄어들고 사용자가 로그인하는 방법을 잊을 가능성이 줄어들기 때문에 IT 도움데스크 비용이 감소합니다. 사용자가 Azure AD를 사용하여 로그인할 때, 이 기능은 사용자의 암호를 **온프레미스 Active Directory**에 직접 **검증**합니다.

PTA에서 **아이덴티티**는 **동기화**되지만 **암호**는 PHS와 달리 **동기화되지 않습니다**.

인증은 온프레미스 AD에서 **검증**되며 클라우드와의 통신은 **온프레미스 서버**에서 실행되는 **인증 에이전트**에 의해 수행됩니다 (온프레미스 DC에 있을 필요는 없음).

### 인증 흐름

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **사용자**가 **로그인**하려면 **Azure AD**로 리디렉션되어 **사용자 이름**과 **암호**를 보냅니다.
2. **자격 증명**은 **암호화**되어 Azure AD의 **대기열**에 설정됩니다.
3. **온프레미스 인증 에이전트**는 대기열에서 **자격 증명**을 수집하고 **해독**합니다. 이 에이전트는 **"패스스루 인증 에이전트"** 또는 **PTA 에이전트**라고 합니다.
4. **에이전트**는 자격 증명을 **온프레미스 AD**에 대해 **검증**하고, 응답을 **Azure AD로 다시 보내** 해당 응답이 긍정적인 경우 **사용자의 로그인을 완료**합니다.

{% hint style="warning" %}
공격자가 **PTA를 침해**하면 대기열에서 모든 **자격 증명**을 볼 수 있습니다 (**평문**으로).\
또한 AzureAD로 **모든 자격 증명을 검증**할 수 있습니다 (Skeleton key와 유사한 공격).
{% endhint %}

### 온프레미스 -> 클라우드

**PTA** **에이전트**가 실행되는 **Azure AD Connect 서버**에 **관리자** 액세스가 있으면 **AADInternals** 모듈을 사용하여 **백도어를 삽입**할 수 있습니다. 이를 통해 도입된 **모든 암호를 검증**하는 백도어를 사용할 수 있습니다 (따라서 모든 암호가 인증에 유효합니다):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
만약 **설치에 실패**한다면, 아마도 [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe)이(가) 누락된 것일 수 있습니다.
{% endhint %}

이전 백도어가 설치된 기기에서 다음 cmdlet을 사용하여 **PTA 에이전트로 전송된 평문 암호를 확인**할 수도 있습니다:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
이 백도어는 다음을 수행합니다:

* 숨겨진 폴더 `C:\PTASpy`를 생성합니다.
* `PTASpy.dll`을 `C:\PTASpy`로 복사합니다.
* `PTASpy.dll`을 `AzureADConnectAuthenticationAgentService` 프로세스에 주입합니다.

{% hint style="info" %}
AzureADConnectAuthenticationAgent 서비스가 다시 시작될 때, PTASpy는 "언로드"되어 다시 설치해야 합니다.
{% endhint %}

### 클라우드 -> 온프레미스

{% hint style="danger" %}
클라우드에서 **GA 권한**을 획득한 후, **공격자가 제어하는 기계**에 **새 PTA 에이전트를 등록**할 수 있습니다. 에이전트가 **설정**되면, 이전 단계를 **반복**하여 **모든 비밀번호를 사용하여 인증**하고 또한 **평문으로 비밀번호를 획득**할 수 있습니다.
{% endhint %}

### Seamless SSO

PTA와 함께 Seamless SSO를 사용할 수 있으며, 다른 남용에 취약합니다. 다음에서 확인할 수 있습니다:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 참고 자료

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)
