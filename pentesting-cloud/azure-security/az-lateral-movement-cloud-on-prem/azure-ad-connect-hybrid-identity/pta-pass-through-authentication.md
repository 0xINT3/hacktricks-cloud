# Az - PTA - パススルー認証

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>

## 基本情報

Azure Active Directory (Azure AD) パススルー認証を使用すると、ユーザーは**オンプレミスとクラウドベースのアプリケーションの両方に同じパスワードでサインイン**できます。この機能は、ユーザーにとってより良い体験を提供します - 覚えるパスワードが1つ減り、サインイン方法を忘れる可能性が低くなるため、ITヘルプデスクのコストが削減されます。ユーザーがAzure ADを使用してサインインするとき、この機能は**ユーザーのパスワードを直接オンプレミスのActive Directoryに対して検証します**。

<figure><img src="../../../../.gitbook/assets/image (8) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

PTAでは**アイデンティティ**は**同期されます**が、PHSのように**パスワード**は**されません**。

認証はオンプレADで検証され、クラウドとの通信は**オンプレサーバー**で実行される**認証エージェント**によって行われます（オンプレDC上にある必要はありません）。

### 認証フロー

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. **ログイン**するために、ユーザーは**Azure AD**にリダイレクトされ、**ユーザー名**と**パスワード**を送信します
2. **資格情報**は**暗号化**され、Azure ADの**キュー**に設定されます
3. **オンプレ認証エージェント**がキューから**資格情報**を収集し、**復号**します。このエージェントは**「パススルー認証エージェント」**または**PTAエージェント**と呼ばれます。
4. **エージェント**はcredsを**オンプレAD**に対して**検証**し、**応答**をAzure ADに**返送**します。応答が肯定的であれば、Azure ADはユーザーのログインを**完了**します。

{% hint style="warning" %}
攻撃者が**PTA**を**侵害**すると、キュー内のすべての**資格情報**を（**クリアテキスト**で）**閲覧**できます。\
また、任意の資格情報をAzureADに対して**検証**することもできます（Skeleton keyに似た攻撃）。
{% endhint %}

### オンプレ -> クラウド

**PTA** **エージェント**が実行されている**Azure AD Connectサーバー**に**管理者**アクセスがある場合、**AADInternals**モジュールを使用して**バックドアを挿入**し、導入されたすべてのパスワードを**検証**することができます（したがって、すべてのパスワードが認証に有効になります）：
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
**インストールが失敗した場合**、これはおそらく[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)が不足しているためです。
{% endhint %}

また、以前にバックドアがインストールされたマシンで以下のコマンドレットを使用することで、**PTAエージェントに送信された平文のパスワードを見る**ことも可能です：
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
このバックドアは以下のことを行います：

* 隠しフォルダ `C:\PTASpy` を作成する
* `PTASpy.dll` を `C:\PTASpy` にコピーする
* `AzureADConnectAuthenticationAgentService` プロセスに `PTASpy.dll` を注入する

{% hint style="info" %}
AzureADConnectAuthenticationAgent サービスが再起動されると、PTASpyは「アンロード」され、再インストールする必要があります。
{% endhint %}

### クラウド -> オンプレミス

{% hint style="danger" %}
クラウドで **GA権限** を取得した後、**攻撃者が制御するマシン** 上で新しい PTA エージェントを **登録** することが可能です。エージェントが **セットアップ** されると、任意のパスワードを使用して認証を **繰り返し**、また、パスワードをクリアテキストで **取得** することもできます。
{% endhint %}

### シームレス SSO

PTA でシームレス SSO を使用することが可能であり、他の悪用にも脆弱です。以下で確認してください：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>AWS ハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks に広告を掲載したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、私たちの独占的な [**NFT コレクション**](https://opensea.io/collection/the-peass-family) を発見する
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に **参加する** か、[**テレグラム グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを **共有する**。

</details>
