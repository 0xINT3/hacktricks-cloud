# Az - PTA - Deurloop-autentifikasie

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

[Volgens die dokumentasie:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Deurloop-autentifikasie stel jou gebruikers in staat om **aan te meld by beide on-premises en wolkgebaseerde toepassings met dieselfde wagwoorde**. Hierdie funksie bied jou gebruikers 'n beter ervaring - een minder wagwoord om te onthou, en verminder IT-helpdesk-koste omdat jou gebruikers minder waarskynlik sal vergeet hoe om aan te meld. Wanneer gebruikers aanmeld met behulp van Azure AD, **valideer hierdie funksie gebruikers se wagwoorde direk teen jou on-premises Active Directory**.

In PTA word **identiteite** **gesinkroniseer** maar **wagwoorde** **nie** soos in PHS nie.

Die outentifikasie word gevalideer in die on-prem AD en die kommunikasie met die wolk word gedoen deur 'n **outentifikasie-agent** wat op 'n **on-prem-bedienaar** loop (dit hoef nie op die on-prem DC te wees nie).

### Outentifikasievloei

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Om aan te **meld**, word die gebruiker omgelei na **Azure AD**, waar hy die **gebruikersnaam** en **wagwoord** stuur
2. Die **legitimasie** word **ge√´nkripteer** en in 'n **ry** in Azure AD geplaas
3. Die **on-prem outentifikasie-agent** versamel die **legitimasie** uit die ry en **ontsleutel** dit. Hierdie agent word genoem **"Pass-through authentication agent"** of **PTA-agent**.
4. Die **agent** **valideer** die legitimasie teen die **on-prem AD** en stuur die **antwoord** **terug** na Azure AD wat, as die antwoord positief is, die aanmelding van die gebruiker **voltooi**.

{% hint style="warning" %}
As 'n aanvaller die **PTA** **kompromitteer**, kan hy al die legitimasie uit die ry sien (in **duidelike teks**).\
Hy kan ook enige legitimasie **valideer** by die AzureAD (soortgelyke aanval as Skeleton-sleutel).
{% endhint %}

### On-Prem -> wolk

As jy **administratiewe** toegang het tot die **Azure AD Connect-bedienaar** met die **PTA-agent** wat loop, kan jy die **AADInternals**-module gebruik om 'n agterdeur in te voeg wat **ALLE wagwoorde** wat ingevoer word, sal **valideer** (sodat alle wagwoorde geldig sal wees vir outentifikasie):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
As die **installasie misluk**, is dit waarskynlik as gevolg van ontbrekende [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Dit is ook moontlik om die duidelike-teks wagwoorde wat na die PTA-agent gestuur word, te **sien** deur die volgende cmdlet op die masjien waar die vorige agterdeur ge√Ønstalleer is, te gebruik:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Hierdie agterdeur sal doen:

* Skep 'n verborge gids `C:\PTASpy`
* Kopieer 'n `PTASpy.dll` na `C:\PTASpy`
* Injecteer `PTASpy.dll` in die `AzureADConnectAuthenticationAgentService` proses

{% hint style="info" %}
Wanneer die AzureADConnectAuthenticationAgent-diens herlaai word, word PTASpy "ontlaai" en moet dit weer ge√Ønstalleer word.
{% endhint %}

### Wolke -> On-Prem

{% hint style="danger" %}
Nadat **GA-voorregte** in die wolk verkry is, is dit moontlik om 'n nuwe PTA-agent te registreer deur dit op 'n **aanvallerbeheerde masjien** in te stel. Sodra die agent **opgestel** is, kan ons die **vorige** stappe **herhaal** om te **verifieer met enige wagwoord** en ook die wagwoorde in **duidelike teks** te kry.
{% endhint %}

### Naadlose SSO

Dit is moontlik om Naadlose SSO met PTA te gebruik, wat vatbaar is vir ander misbruik. Kyk dit na:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Verwysings

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
