# Az - PTA - 패스스루 인증

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>

## 기본 정보

[문서에서 참조:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) 패스스루 인증은 사용자가 **온프레미스 및 클라우드 기반 애플리케이션에 동일한 암호를 사용하여 로그인**할 수 있도록 합니다. 이 기능은 사용자에게 더 나은 경험을 제공하며, 기억해야 할 암호가 하나 줄어들어 IT 도움데스크 비용을 절감할 수 있습니다. 사용자가 Azure AD를 사용하여 로그인할 때, 이 기능은 사용자의 암호를 **온프레미스 Active Directory**에서 직접 확인합니다.

PTA에서는 **아이덴티티**는 **동기화**되지만 **암호**는 PHS와 달리 **동기화되지 않습니다**.

인증은 온프레미스 AD에서 확인되며, 클라우드와의 통신은 **온프레미스 서버**에서 실행되는 **인증 에이전트**에 의해 수행됩니다(온프레미스 DC에 있을 필요는 없음).

### 인증 흐름

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. **사용자**는 **Azure AD**로 리디렉션되어 **사용자 이름**과 **암호**를 전송합니다.
2. **자격 증명**은 **암호화**되어 Azure AD의 **큐**에 설정됩니다.
3. **온프레미스 인증 에이전트**는 큐에서 **자격 증명**을 수집하고 **해독**합니다. 이 에이전트는 **"패스스루 인증 에이전트"** 또는 **PTA 에이전트**라고 불립니다.
4. **에이전트**는 **온프레미스 AD**에서 자격 증명을 **검증**하고, 응답을 Azure AD로 **전송**하여 응답이 긍정적인 경우 사용자의 로그인을 **완료**합니다.

{% hint style="warning" %}
공격자가 **PTA**를 **침해**하면 큐에서 모든 **자격 증명**(평문)을 **볼 수** 있습니다.\
또한 AzureAD로 **임의의 자격 증명**을 **검증**할 수 있습니다(Skeleton key와 유사한 공격).
{% endhint %}

### 온프레미스 -> 클라우드

**PTA** **에이전트**가 실행 중인 **Azure AD Connect 서버**에 **관리자** 액세스 권한이 있다면, **AADInternals** 모듈을 사용하여 도입된 **모든 암호**를 **검증**하는 백도어를 **삽입**할 수 있습니다. (따라서 모든 암호가 인증에 유효합니다):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
만약 **설치가 실패**한다면, 아마도 [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)가 누락된 것일 수 있습니다.
{% endhint %}

이전 백도어가 설치된 컴퓨터에서 다음 cmdlet을 사용하여 **PTA 에이전트로 전송된 평문 암호를 볼 수도 있습니다**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
이 백도어는 다음을 수행합니다:

* `C:\PTASpy`라는 숨겨진 폴더를 생성합니다.
* `PTASpy.dll`을 `C:\PTASpy`로 복사합니다.
* `PTASpy.dll`을 `AzureADConnectAuthenticationAgentService` 프로세스에 주입합니다.

{% hint style="info" %}
AzureADConnectAuthenticationAgent 서비스가 다시 시작되면 PTASpy가 "언로드"되고 다시 설치해야 합니다.
{% endhint %}

### 클라우드 -> 온프레미스

{% hint style="danger" %}
클라우드에서 **GA 권한**을 획득한 후, **공격자가 제어하는 기기**에 **새로운 PTA 에이전트를 등록**할 수 있습니다. 에이전트가 **설정**되면 이전 단계를 **반복**하여 **임의의 암호를 사용하여 인증**하고, 또한 **암호를 평문으로 얻을 수 있습니다.**
{% endhint %}

### Seamless SSO

PTA와 함께 Seamless SSO를 사용할 수 있으며, 다른 악용에 취약합니다. 다음에서 확인할 수 있습니다:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 참고 자료

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 기법을 공유**하세요.

</details>
