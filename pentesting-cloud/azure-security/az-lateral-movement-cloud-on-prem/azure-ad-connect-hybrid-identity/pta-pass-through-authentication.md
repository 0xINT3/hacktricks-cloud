# Az - PTA - Uwierzytelnianie przekazywane

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Uwierzytelnianie przekazywane w usłudze Azure Active Directory (Azure AD) pozwala Twoim użytkownikom **zalogować się do aplikacji zarówno lokalnych, jak i opartych na chmurze, używając tych samych haseł**. Ta funkcja zapewnia Twoim użytkownikom lepsze doświadczenie - mniej haseł do zapamiętania i zmniejsza koszty działu pomocy technicznej IT, ponieważ użytkownicy są mniej skłonni zapomnieć, jak się zalogować. Gdy użytkownicy logują się za pomocą Azure AD, ta funkcja **sprawdza hasła użytkowników bezpośrednio w Twoim lokalnym katalogu Active Directory**.

W PTA **tożsamości** są **synchronizowane**, ale **hasła** **nie są**, jak w przypadku PHS.

Uwierzytelnianie jest weryfikowane w lokalnym AD, a komunikacja z chmurą odbywa się za pomocą **agenta uwierzytelniania** działającego na **serwerze lokalnym** (nie musi być to kontroler domeny lokalnej).

### Przepływ uwierzytelniania

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Aby **zalogować** użytkownika, jest on przekierowywany do **Azure AD**, gdzie wysyła **nazwę użytkownika** i **hasło**
2. **Poświadczenia** są **szyfrowane** i umieszczone w **kolejce** w Azure AD
3. **Agent uwierzytelniania lokalnego** pobiera **poświadczenia** z kolejki i je **deszyfruje**. Ten agent nazywa się **"Agentem uwierzytelniania przekazywanego"** lub **agentem PTA.**
4. **Agent** **sprawdza** poświadczenia w **lokalnym AD** i wysyła **odpowiedź** **z powrotem** do Azure AD, które, jeśli odpowiedź jest pozytywna, **zakończa logowanie** użytkownika.

{% hint style="warning" %}
Jeśli atakujący **przejmuje kontrolę nad** **PTA**, może **zobaczyć** wszystkie **poświadczenia** z kolejki (w **czystym tekście**).\
Może również **zweryfikować dowolne poświadczenia** do AzureAD (podobny atak do klucza szkieletowego).
{% endhint %}

### Lokalnie -> chmura

Jeśli masz **dostęp admina** do **serwera Azure AD Connect** z uruchomionym **agentem PTA**, możesz użyć modułu **AADInternals** do **wstawienia tylnych drzwi**, które będą **weryfikować WSZYSTKIE hasła** wprowadzone (więc wszystkie hasła będą ważne do uwierzytelniania):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Jeśli **instalacja zawiedzie**, prawdopodobnie jest to spowodowane brakiem [Rozdystrybuowalnych pakietów Microsoft Visual C++ 2015](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

Możliwe jest również **zobaczenie haseł w tekście jawnym wysyłanych do agenta PTA** za pomocą następującego polecenia cmdlet na maszynie, na której zainstalowano poprzednie tylne drzwi:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
To backdoor będzie:

* Utworzy ukryty folder `C:\PTASpy`
* Skopiuj `PTASpy.dll` do `C:\PTASpy`
* Wstrzyknie `PTASpy.dll` do procesu `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Po ponownym uruchomieniu usługi AzureADConnectAuthenticationAgent, PTASpy jest "odłączony" i musi zostać ponownie zainstalowany.
{% endhint %}

### Chmura -> Lokalnie

{% hint style="danger" %}
Po uzyskaniu **uprawnień GA** w chmurze, możliwe jest **zarejestrowanie nowego agenta PTA**, ustawiając go na **maszynie kontrolowanej przez atakującego**. Gdy agent jest **skonfigurowany**, możemy **powtórzyć** **poprzednie** kroki, aby **uwierzytelnić się, używając dowolnego hasła** i również **uzyskać hasła w postaci czystego tekstu**.
{% endhint %}

### Bezproblemowe SSO

Możliwe jest korzystanie z Bezproblemowego SSO z PTA, co jest podatne na inne nadużycia. Sprawdź to w:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Odnośniki

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
