# Az - PTA - Pass-through Authentication

<details>

<summary><strong>AWS hackleme becerilerini sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimizden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

## Temel Bilgiler

[Dokümantasyondan alınan bilgilere göre:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication, kullanıcılarınızın **aynı şifreleri kullanarak hem yerel hem de bulut tabanlı uygulamalara giriş yapmasına olanak tanır**. Bu özellik, kullanıcılarınıza daha iyi bir deneyim sunar - hatırlanması gereken bir şifre daha az olduğu için ve kullanıcılarınızın giriş yapmayı unutma olasılığı daha düşük olduğu için IT yardım masası maliyetlerini azaltır. Kullanıcılar Azure AD kullanarak giriş yaptığında, bu özellik kullanıcıların şifrelerini doğrudan yerel Active Directory'nizde doğrular.

PTA'da **kimlikler** senkronize edilirken **şifreler** senkronize edilmez, PHS'deki gibi.

Kimlik doğrulama, yerel AD'de doğrulanır ve bulutla iletişim, bir **kimlik doğrulama ajanı** tarafından gerçekleştirilir ve bu ajan bir **yerel sunucuda** çalışır (yerel DC'de olması gerekmez).

### Kimlik doğrulama akışı

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. **Kullanıcı giriş yapmak** için Azure AD'ye yönlendirilir, burada **kullanıcı adı** ve **şifre** gönderir.
2. **Kimlik bilgileri**, Azure AD'deki bir **kuyruğa** **şifrelenmiş** olarak yerleştirilir.
3. **Yerel kimlik doğrulama ajanı**, kuyruktan **kimlik bilgilerini** toplar ve **şifreleri** **şifre çözer**. Bu ajan **"Pass-through authentication agent"** veya **PTA ajanı** olarak adlandırılır.
4. **Ajan**, kimlik bilgilerini **yerel AD'ye** karşı doğrular ve yanıtı Azure AD'ye gönderir. Eğer yanıt olumlu ise, Azure AD kullanıcının girişini **tamamlar**.

{% hint style="warning" %}
Bir saldırgan, **PTA'yı** ele geçirirse, kuyruktaki tüm **kimlik bilgilerini** (açık metin olarak) **görebilir**.\
Ayrıca, AzureAD'ye herhangi bir kimlik bilgisini **doğrulayabilir** (Skeleton key saldırısına benzer bir saldırı).
{% endhint %}

### Yerel -> bulut

Eğer **PTA ajanı** çalışan **Azure AD Connect sunucusuna** **yönetici** erişiminiz varsa, **AADInternals** modülünü kullanarak **geri kapı** ekleyebilirsiniz. Bu geri kapı, **girilen TÜM şifreleri** doğrulayacak şekilde çalışır:
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Eğer **kurulum başarısız olursa**, bunun muhtemelen [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe) eksikliğinden kaynaklandığını belirtmek gerekir.
{% endhint %}

Ayrıca, önceki arka kapının kurulduğu makinede aşağıdaki cmdlet kullanılarak **PTA ajanına gönderilen açık metin parolaları görüntülemek mümkündür**:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Bu arka kapı şunları yapacak:

* Gizli bir `C:\PTASpy` klasörü oluşturacak
* `PTASpy.dll` dosyasını `C:\PTASpy` klasörüne kopyalayacak
* `PTASpy.dll`'yi `AzureADConnectAuthenticationAgentService` işlemine enjekte edecek

{% hint style="info" %}
AzureADConnectAuthenticationAgent hizmeti yeniden başlatıldığında, PTASpy "boşaltılır" ve yeniden yüklenmesi gerekir.
{% endhint %}

### Bulut -> On-Prem

{% hint style="danger" %}
Bulutta **GA yetkilerine** sahip olduktan sonra, bir **saldırgan kontrolündeki makineye** bir **PTA ajanı kaydederek** yeni bir PTA ajanı **oluşturmak mümkündür**. Ajan **kurulduktan sonra**, önceki adımları **tekrarlayarak** herhangi bir şifre ile **kimlik doğrulaması yapabilir** ve ayrıca **şifreleri açık metin olarak alabiliriz**.
{% endhint %}

### Sorunsuz SSO

PTA ile Sorunsuz SSO kullanmak mümkündür ve bu da diğer kötüye kullanımlara açıktır. Aşağıdaki bağlantıda kontrol edebilirsiniz:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>
