# PTA - パススルー認証

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## 基本情報

Azure Active Directory（Azure AD）のパススルー認証を使用すると、ユーザーは**同じパスワードを使用してオンプレミスおよびクラウドベースのアプリケーションにサインイン**できます。この機能により、ユーザーはパスワードを1つだけ覚える必要がなくなり、サインイン方法を忘れる可能性が低くなるため、ユーザーはより良いエクスペリエンスを得ることができます。ユーザーがAzure ADを使用してサインインすると、この機能はユーザーのパスワードをオンプレミスのActive Directoryと直接検証します。

<figure><img src="../../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

PTAでは、**アイデンティティ**は**同期**されますが、**パスワード**はPHSとは異なり**同期されません**。

認証はオンプレミスのADで検証され、クラウドとの通信はオンプレミスサーバーで実行される**認証エージェント**によって行われます（オンプレミスDCにある必要はありません）。

### 認証フロー

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. ユーザーが**ログイン**するために、**Azure AD**にリダイレクトされ、**ユーザー名**と**パスワード**が送信されます。
2. **資格情報**は**暗号化**され、Azure ADの**キュー**に設定されます。
3. **オンプレミス認証エージェント**はキューから**資格情報**を収集し、それらを**復号化**します。このエージェントは**"パススルー認証エージェント"**または**PTAエージェント**と呼ばれます。
4. **エージェント**は**オンプレミスAD**に対して資格情報を**検証**し、**応答**をAzure ADに送信します。Azure ADは、応答が正常であれば、ユーザーのログインを**完了**します。

{% hint style="warning" %}
攻撃者が**PTA**を**侵害**すると、キューからすべての**資格情報**を（**クリアテキスト**で）**閲覧**できます。\
また、AzureADに対して**任意の資格情報**を**検証**することもできます（Skeleton keyに似た攻撃）。
{% endhint %}

### オンプレミス -> クラウド

**PTA** **エージェント**が実行されている**Azure AD Connectサーバー**への**管理者**アクセス権がある場合、**AADInternals**モジュールを使用して、**バックドア**を挿入して**導入されたすべてのパスワード**を**検証**することができます（つまり、すべてのパスワードが認証に有効になります）。
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
インストールが失敗する場合は、おそらく[Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe)が不足しているためです。
{% endhint %}

また、前のバックドアがインストールされたマシンで、以下のコマンドレットを使用してPTAエージェントに送信される平文のパスワードを確認することも可能です。
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
このバックドアは以下の操作を行います：

* 隠しフォルダ `C:\PTASpy` を作成します。
* `PTASpy.dll` を `C:\PTASpy` にコピーします。
* `PTASpy.dll` を `AzureADConnectAuthenticationAgentService` プロセスにインジェクトします。

{% hint style="info" %}
AzureADConnectAuthenticationAgent サービスが再起動されると、PTASpy は「アンロード」され、再インストールする必要があります。
{% endhint %}

### クラウド -> オンプレミス

{% hint style="danger" %}
クラウドで **GA 特権**を取得した後、**攻撃者が制御するマシン**に **新しい PTA エージェント**を登録することが可能です。エージェントが **セットアップ**されたら、**前述の手順を繰り返して任意のパスワードで認証**し、また、**平文のパスワードを取得**することができます。
{% endhint %}

### シームレス SSO

PTAと一緒にシームレス SSOを使用することも可能であり、他の悪用に対して脆弱です。以下で確認してください：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝**したい場合や、**最新版の PEASS を入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを楽しみましょう。
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) や [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに **PR を提出**することで、あなたのハッキングテクニックを共有しましょう。

</details>
