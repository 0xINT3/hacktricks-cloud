# Az - PTA - Provera autentičnosti prenosa

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodiču PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Od dokumenata:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Provera autentičnosti prenosa (PTA) u Azure Active Directory (Azure AD) omogućava vašim korisnicima da **se prijave na lokalne i cloud aplikacije koristeći iste lozinke**. Ova funkcija pruža korisnicima bolje iskustvo - jedna manje lozinka koju treba zapamtiti, i smanjuje troškove IT podrške jer su korisnici manje verovatno da će zaboraviti kako da se prijave. Kada korisnici se prijave koristeći Azure AD, ova funkcija **validira korisničke lozinke direktno protiv vašeg lokalnog Active Directory-a**.

U PTA **identiteti** su **sinhronizovani** ali **lozinke** **nisu** kao u PHS.

Autentikacija se validira u lokalnom AD-u i komunikacija sa oblakom se vrši preko **agent za autentikaciju** koji se izvršava na **lokalnom serveru** (ne mora biti na lokalnom DC).

### Tok autentikacije

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Da bi se **prijavio** korisnik je preusmeren na **Azure AD**, gde šalje **korisničko ime** i **lozinku**
2. **Poverljivi podaci** su **šifrovani** i postavljeni u **red** u Azure AD
3. **Agent za autentikaciju na lokalnom serveru** prikuplja **poverljive podatke** iz reda i ih **dešifruje**. Ovaj agent se naziva **"Agent za proveru autentičnosti prenosa"** ili **PTA agent.**
4. **Agent** **validira** podatke protiv **lokalnog AD-a** i šalje **odgovor** **nazad** u Azure AD koji, ako je odgovor pozitivan, **završava prijavu** korisnika.

{% hint style="warning" %}
Ako napadač **kompromituje** **PTA** on može **videti** sve **poverljive podatke** iz reda (u **čistom tekstu**).\
Takođe može **validirati bilo koje poverljive podatke** ka AzureAD (sličan napad kao Skeleton key).
{% endhint %}

### Lokalno -> oblak

Ako imate **admin** pristup **Azure AD Connect serveru** sa **PTA** **agentom** koji se izvršava, možete koristiti **AADInternals** modul da **ubacite tajnu vrata** koja će **validirati SVE lozinke** unete (tako da će sve lozinke biti validne za autentikaciju):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Ako **instalacija ne uspe**, verovatno je to zbog nedostajućih [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

Takođe je moguće **videti lozinke u čistom tekstu koje su poslate agentu PTA** korišćenjem sledećeg cmdlet-a na mašini gde je prethodna tajna vrata instalirana:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ova vrata će:

* Napraviti skriveni folder `C:\PTASpy`
* Kopirati `PTASpy.dll` u `C:\PTASpy`
* Ubaciti `PTASpy.dll` u proces `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Kada se usluga AzureADConnectAuthenticationAgent ponovo pokrene, PTASpy se "isključuje" i mora ponovo biti instaliran.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Nakon sticanja **GA privilegija** u oblaku, moguće je **registrovati novog PTA agenta** postavljajući ga na **mašinu kojom upravlja napadač**. Kada je agent **postavljen**, možemo **ponoviti** **prethodne** korake da bismo se **autentifikovali koristeći bilo koju lozinku** i takođe, **dobili lozinke u čistom tekstu**.
{% endhint %}

### Seamless SSO

Moguće je koristiti Seamless SSO sa PTA, što je ranjivo na druge zloupotrebe. Proverite u:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
