# Az - PTA - Deurloop-verifikasie

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kontroleer die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

[Van die dokumente:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory (Azure AD) Pass-through Authentication stel jou gebruikers in staat om **aan te meld by beide aanlokale en wolkgebaseerde toepassings met dieselfde wagwoorde**. Hierdie kenmerk bied jou gebruikers 'n beter ervaring - een minder wagwoord om te onthou, en verminder IT-helpdesk-koste omdat jou gebruikers minder geneig is om te vergeet hoe om aan te meld. Wanneer gebruikers aanmeld met Azure AD, **valideer hierdie kenmerk gebruikers se wagwoorde direk teen jou aanlokale Active Directory**.

In PTA word **identiteite** **gesinkroniseer** maar **wagwoorde** **nie** soos in PHS.

Die verifikasie word gevalideer in die aanlokale AD en die kommunikasie met die wolk word gedoen deur 'n **verifikasie-agent** wat op 'n **aanlokale bediener** hardloop (dit hoef nie op die aanlokale DC te wees nie).

### Verifikasievloei

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Om **aan te meld** word die gebruiker na **Azure AD** omgelei, waar hy die **gebruikersnaam** en **wagwoord** stuur
2. Die **gelde** word **ge√´nkripteer** en in 'n **ry** in Azure AD geplaas
3. Die **aanlokale verifikasie-agent** versamel die **gelde** uit die ry en **dekripteer** dit. Hierdie agent word genoem **"Deurloop-verifikasie-agent"** of **PTA-agent.**
4. Die **agent** **valideer** die gelde teen die **aanlokale AD** en stuur die **antwoord** **terug** na Azure AD wat, as die antwoord positief is, die aanmelding van die gebruiker **voltooi**.

{% hint style="warning" %}
As 'n aanvaller die **PTA** **kompromitteer**, kan hy al die **gelde** uit die ry sien (in **teksvorm**).\
Hy kan ook enige gelde **valideer** na die AzureAD (soortgelyke aanval as Skeleton-sleutel).
{% endhint %}

### Aanlokale -> wolk

As jy **administratiewe** toegang het tot die **Azure AD Connect-bedieners** met die **PTA** **agent** wat hardloop, kan jy die **AADInternals**-module gebruik om 'n agterdeur in te voeg wat **ALLE die wagwoorde** wat ingevoer is, sal **valideer** (sodat alle wagwoorde geldig sal wees vir verifikasie):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Indien die **installasie misluk**, is dit waarskynlik as gevolg van ontbrekende [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

Dit is ook moontlik om **die duidelike-teks wagwoorde wat na die PTA-agent gestuur is** te sien deur die volgende cmdlet op die masjien waar die vorige agterdeur ge√Ønstalleer is, te gebruik:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Hierdie agterdeur sal:

* Skep 'n verborge vouer `C:\PTASpy`
* Kopieer 'n `PTASpy.dll` na `C:\PTASpy`
* Inject `PTASpy.dll` na die `AzureADConnectAuthenticationAgentService` proses

{% hint style="info" %}
Wanneer die AzureADConnectAuthenticationAgent-diens heraangestel word, word PTASpy "ontlaai" en moet dit weer ge√Ønstalleer word.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Nadat **GA-voorregte** op die wolk verkry is, is dit moontlik om 'n nuwe PTA-agent te **registreer** deur dit op 'n **aanvallerbeheerde masjien** in te stel. Sodra die agent **opgestel** is, kan ons die **vorige** stappe **herhaal** om **te verifieer met enige wagwoord** en ook, **die wagwoorde in te sien in die teks.**
{% endhint %}

### Naadlose SSO

Dit is moontlik om Naadlose SSO met PTA te gebruik, wat vatbaar is vir ander misbruik. Kontroleer dit in:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Verwysings

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kontroleer die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
