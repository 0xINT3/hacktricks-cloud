# PTA - Autenticación de paso

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Información básica

La autenticación de paso de Azure Active Directory (Azure AD) permite a tus usuarios **iniciar sesión en aplicaciones tanto locales como basadas en la nube utilizando las mismas contraseñas**. Esta función proporciona a tus usuarios una mejor experiencia, ya que solo necesitan recordar una contraseña y reduce los costos del servicio de asistencia técnica de TI, ya que es menos probable que los usuarios olviden cómo iniciar sesión. Cuando los usuarios inician sesión utilizando Azure AD, esta función **valida las contraseñas de los usuarios directamente en tu Active Directory local**.

<figure><img src="../../../../.gitbook/assets/image (8) (1).png" alt=""><figcaption></figcaption></figure>

En PTA, las **identidades** se **sincronizan** pero las **contraseñas** **no**, como en PHS.

La autenticación se valida en el AD local y la comunicación con la nube se realiza mediante un **agente de autenticación** que se ejecuta en un **servidor local** (no es necesario que esté en el controlador de dominio local).

### Flujo de autenticación

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Para **iniciar sesión**, el usuario es redirigido a **Azure AD**, donde envía el **nombre de usuario** y la **contraseña**.
2. Las **credenciales** se **encriptan** y se almacenan en una **cola** en Azure AD.
3. El **agente de autenticación local** recopila las **credenciales** de la cola y las **descifra**. Este agente se llama **"Agente de autenticación de paso"** o **agente PTA**.
4. El **agente** **valida** las credenciales frente al **AD local** y envía la **respuesta** de vuelta a Azure AD, que, si la respuesta es positiva, **completa la sesión** del usuario.

{% hint style="warning" %}
Si un atacante **compromete** el **PTA**, puede **ver** todas las **credenciales** de la cola (en **texto claro**).\
También puede **validar cualquier credencial** en AzureAD (ataque similar a la clave Skeleton).
{% endhint %}

### Local -> nube

Si tienes acceso de **administrador** al servidor **Azure AD Connect** con el **agente PTA** en ejecución, puedes usar el módulo **AADInternals** para **insertar una puerta trasera** que **validará TODAS las contraseñas** introducidas (por lo que todas las contraseñas serán válidas para la autenticación):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Si la **instalación falla**, esto probablemente se debe a la falta de [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

También es posible **ver las contraseñas en texto claro enviadas al agente PTA** utilizando el siguiente cmdlet en la máquina donde se instaló la puerta trasera anteriormente:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Esta puerta trasera realizará lo siguiente:

* Creará una carpeta oculta `C:\PTASpy`
* Copiará `PTASpy.dll` a `C:\PTASpy`
* Inyectará `PTASpy.dll` en el proceso `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Cuando se reinicie el servicio AzureADConnectAuthenticationAgent, PTASpy se "descargará" y deberá ser reinstalado.
{% endhint %}

### Nube -> Local

{% hint style="danger" %}
Después de obtener privilegios de **GA** en la nube, es posible **registrar un nuevo agente PTA** configurándolo en una **máquina controlada por el atacante**. Una vez que el agente esté **configurado**, podemos **repetir** los **pasos anteriores** para **autenticarnos usando cualquier contraseña** y también **obtener las contraseñas en texto claro**.
{% endhint %}

### SSO sin interrupciones

Es posible utilizar SSO sin interrupciones con PTA, lo cual es vulnerable a otros abusos. Verificar en:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si deseas ver tu **empresa anunciada en HackTricks** o si deseas acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
