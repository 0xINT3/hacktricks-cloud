# Az - PTA - Uthibitishaji wa Kupitia

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalamu wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

[Kutoka kwa nyaraka:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Uthibitishaji wa Kupitia wa Azure Active Directory (Azure AD) unaruhusu watumiaji wako **kuingia kwenye programu za eneo-kazi na zile za wingu kwa kutumia nywila sawa**. Kipengele hiki hutoa watumiaji wako uzoefu bora - nywila moja chini ya kukumbuka, na kupunguza gharama za msaada wa IT kwa sababu watumiaji wako hawana uwezekano wa kusahau jinsi ya kuingia. Wakati watumiaji wanapoingia kwa kutumia Azure AD, kipengele hiki **huthibitisha nywila za watumiaji moja kwa moja dhidi ya Active Directory yako ya eneo-kazi**.

Katika PTA **vitambulisho** vinahusishwa lakini **nywila** **hazihusishwi** kama katika PHS.

Uthibitishaji unathibitishwa katika AD ya eneo-kazi na mawasiliano na wingu hufanywa na **mawakala wa uthibitishaji** wanaofanya kazi kwenye **server ya eneo-kazi** (hauitaji kuwa kwenye DC ya eneo-kazi).

### Mchoro wa Uthibitishaji

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. Kwa **kuingia** mtumiaji anaelekezwa kwa **Azure AD**, ambapo anatuma **jina la mtumiaji** na **nywila**
2. **Vyeti** vinakuwa **vimefichwa** na kuwekwa kwenye **foleni** kwenye Azure AD
3. **Mawakala wa uthibitishaji wa eneo-kazi** wanakusanya **vyeti** kutoka kwenye foleni na **kuvifichua**. Mawakala huyu huitwa **"mawakala wa uthibitishaji wa kupitia"** au **mawakala wa PTA.**
4. **Mawakala** **huthibitisha** vyeti dhidi ya **AD ya eneo-kazi** na kutuma **jibu** **kurejea** kwa Azure AD ambayo, ikiwa jibu ni chanya, **inafunga kuingia** kwa mtumiaji.

{% hint style="warning" %}
Ikiwa mshambuliaji **anadukua** **PTA** anaweza **kuona** vyeti vyote kutoka kwenye foleni (kwa **maandishi wazi**).\
Anaweza pia **kuthibitisha vyeti vyovyote** kwa AzureAD (shambulio sawa na Skeleton key).
{% endhint %}

### Eneo-kazi -> wingu

Ikiwa una **upatikanaji wa admin** kwenye **server ya Azure AD Connect** na **mawakala wa PTA** wanafanya kazi, unaweza kutumia moduli ya **AADInternals** kuingiza mlango wa nyuma ambao utathibitisha **NYWILA ZOTE** zilizoingizwa (hivyo nywila zote zitakuwa halali kwa uthibitishaji):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Ikiwa **usakinishaji unashindwa**, hii labda ni kutokana na kukosekana kwa [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Pia ni **pamoja na uwezekano wa kuona nywila za maandishi wazi zilizotumwa kwa wakala wa PTA** kwa kutumia cmdlet ifuatayo kwenye mashine ambapo mlango wa nyuma ulioshughulikiwa awali ulisakinishwa:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Backdoor hii itafanya yafuatayo:

* Unda folda iliyofichwa `C:\PTASpy`
* Nakili `PTASpy.dll` kwa `C:\PTASpy`
* Injekta `PTASpy.dll` kwa mchakato wa `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Wakati huduma ya AzureADConnectAuthenticationAgent inapoanzishwa tena, PTASpy "inaondolewa" na lazima iwe imewekwa tena.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Baada ya kupata **mamlaka ya GA** kwenye wingu, ni rahisi ku **sajili wakala mpya wa PTA** kwa kuweka kwenye **mashine inayodhibitiwa na mshambuliaji**. Mara tu wakala anapowekwa, tunaweza **kurudia** hatua **zilizopita** kwa **uthibitisho kwa kutumia nenosiri lolote** na pia, **pata nywila kwa maandishi wazi.**
{% endhint %}

### Seamless SSO

Inawezekana kutumia Seamless SSO na PTA, ambayo inaweza kutumika vibaya. Angalia hapa:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Marejeo

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)
