# Az - PTA - Authentification de passe

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

[√Ä partir de la documentation :](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) L'authentification de passe Azure Active Directory (Azure AD) permet √† vos utilisateurs de **se connecter √† la fois aux applications sur site et bas√©es sur le cloud en utilisant les m√™mes mots de passe**. Cette fonctionnalit√© offre √† vos utilisateurs une meilleure exp√©rience - un mot de passe de moins √† retenir, et r√©duit les co√ªts du service d'assistance informatique car vos utilisateurs sont moins susceptibles d'oublier comment se connecter. Lorsque les utilisateurs se connectent en utilisant Azure AD, cette fonctionnalit√© **valide les mots de passe des utilisateurs directement contre votre annuaire Active Directory sur site**.

Dans PTA, les **identit√©s** sont **synchronis√©es** mais les **mots de passe** ne le sont pas comme dans PHS.

L'authentification est valid√©e dans l'AD sur site et la communication avec le cloud est effectu√©e par un **agent d'authentification** s'ex√©cutant sur un **serveur sur site** (il n'a pas besoin d'√™tre sur le DC sur site).

### Flux d'authentification

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Pour **se connecter**, l'utilisateur est redirig√© vers **Azure AD**, o√π il envoie le **nom d'utilisateur** et le **mot de passe**
2. Les **informations d'identification** sont **chiffr√©es** et plac√©es dans une **file d'attente** dans Azure AD
3. L'**agent d'authentification sur site** r√©cup√®re les **informations d'identification** de la file d'attente et les **d√©chiffre**. Cet agent est appel√© **"agent d'authentification de passe"** ou **agent PTA**.
4. L'**agent** **valide** les informations d'identification contre l'**AD sur site** et envoie la **r√©ponse** de **retour** √† Azure AD qui, si la r√©ponse est positive, **compl√®te la connexion** de l'utilisateur.

{% hint style="warning" %}
Si un attaquant **compromet** le **PTA**, il peut **voir** toutes les **informations d'identification** de la file d'attente (en **clair**).\
Il peut √©galement **valider n'importe quelles informations d'identification** aupr√®s de AzureAD (attaque similaire √† la cl√© Skeleton).
{% endhint %}

### Sur site -> cloud

Si vous avez un acc√®s **administrateur** au **serveur Azure AD Connect** avec l'**agent PTA** en cours d'ex√©cution, vous pouvez utiliser le module **AADInternals** pour **ins√©rer une porte d√©rob√©e** qui **validera TOUS les mots de passe** introduits (ainsi tous les mots de passe seront valides pour l'authentification) :
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Si l'**installation √©choue**, cela est probablement d√ª au manque des [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe).
{% endhint %}

Il est √©galement possible de **voir les mots de passe en clair envoy√©s √† l'agent PTA** en utilisant le cmdlet suivant sur la machine o√π la porte d√©rob√©e pr√©c√©dente a √©t√© install√©e :
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ce backdoor va :

* Cr√©er un dossier cach√© `C:\PTASpy`
* Copier un `PTASpy.dll` dans `C:\PTASpy`
* Injecter `PTASpy.dll` dans le processus `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Lorsque le service AzureADConnectAuthenticationAgent est red√©marr√©, PTASpy est "d√©charg√©" et doit √™tre r√©install√©.
{% endhint %}

### Cloud -> On-Prem

{% hint style="danger" %}
Apr√®s avoir obtenu des **privil√®ges GA** sur le cloud, il est possible de **enregistrer un nouvel agent PTA** en le configurant sur une **machine contr√¥l√©e par l'attaquant**. Une fois l'agent **configur√©**, nous pouvons **r√©p√©ter** les **√©tapes pr√©c√©dentes** pour **s'authentifier en utilisant n'importe quel mot de passe** et √©galement **obtenir les mots de passe en clair**.
{% endhint %}

### Authentification unique transparente

Il est possible d'utiliser l'authentification unique transparente avec PTA, qui est vuln√©rable √† d'autres abus. V√©rifiez cela dans :

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
