# Az - PTA - パススルー認証

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)で**フォロー**する。
- **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>

## 基本情報

[ドキュメントから：](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Azure Active Directory（Azure AD）パススルー認証を使用すると、ユーザーは**同じパスワードを使用してオンプレミスおよびクラウドベースのアプリケーションにサインイン**できます。この機能により、ユーザーはより良いエクスペリエンスを得ることができます - 覚える必要があるパスワードが1つ少なくなり、ユーザーがサインイン方法を忘れる可能性が低くなるため、ITヘルプデスクのコストが削減されます。ユーザーがAzure ADを使用してサインインすると、この機能はユーザーのパスワードを**オンプレミスのActive Directory**に直接検証します。

PTAでは**アイデンティティ**が**同期**されますが、**PHS**のように**パスワード**は**同期されません**。

認証はオンプレミスADで検証され、クラウドとの通信は**オンプレミスサーバー**で実行される**認証エージェント**によって行われます（オンプレミスDCである必要はありません）。

### 認証フロー

<figure><img src="../../../../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

1. **ユーザー**が**ログイン**するために、**Azure AD**にリダイレクトされ、**ユーザー名**と**パスワード**が送信されます
2. **資格情報**は**暗号化**され、Azure ADの**キュー**に設定されます
3. **オンプレミス認証エージェント**はキューから**資格情報**を収集し、それらを**復号**します。このエージェントは**"パススルー認証エージェント"**または**PTAエージェント**と呼ばれます。
4. **エージェント**は**資格情報**を**オンプレミスAD**に対して検証し、**応答**を**Azure AD**に送信します。応答が肯定的であれば、ユーザーのログインを**完了**します。

{% hint style="warning" %}
攻撃者が**PTA**を**侵害**すると、キューからすべての**資格情報**（**クリアテキスト**で）を**見る**ことができます。\
また、AzureADに**任意の資格情報を検証**することもできます（Skeleton keyに類似した攻撃）。
{% endhint %}

### オンプレミス -> クラウド

**PTA** **エージェント**が実行されている**Azure AD Connectサーバー**への**管理者**アクセス権がある場合、**AADInternals**モジュールを使用して、導入されたすべてのパスワードを**検証するバックドア**を**挿入**できます（したがって、すべてのパスワードが認証に有効になります）：
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
**インストールに失敗** した場合、おそらく [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe) が不足している可能性があります。
{% endhint %}

前のバックドアがインストールされたマシンで、以下のコマンドレットを使用して **PTA エージェントに送信された平文パスワードを確認** することも可能です：
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
このバックドアは次のことを行います：

* 隠しフォルダ `C:\PTASpy` を作成します
* `PTASpy.dll` を `C:\PTASpy` にコピーします
* `PTASpy.dll` を `AzureADConnectAuthenticationAgentService` プロセスにインジェクトします

{% hint style="info" %}
AzureADConnectAuthenticationAgent サービスが再起動されると、PTASpy は「アンロード」され、再インストールする必要があります。
{% endhint %}

### クラウド -> オンプレミス

{% hint style="danger" %}
クラウドで **GA 権限** を取得した後、**攻撃者が制御するマシン** に **新しい PTA エージェントを登録** することが可能です。エージェントが **セットアップ** されると、**以前の**手順を **繰り返して** **任意のパスワードを使用して認証** し、また、**平文でパスワードを取得** することができます。
{% endhint %}

### シームレス SSO

PTA と一緒にシームレス SSO を使用することが可能で、他の悪用に対して脆弱です。以下で確認できます：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)** で**ゼロからヒーローまでのAWSハッキングを学びましょう**！</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks が広告されたり、HackTricks を PDF でダウンロード** したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks) の github リポジトリに PR を提出して、あなたのハッキングトリックを共有する

</details>
