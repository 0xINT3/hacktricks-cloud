# Az - PTA - Autoryzacja przekazywana

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-pta) Autoryzacja przekazywana Azure Active Directory (Azure AD) umożliwia Twoim użytkownikom **logowanie się zarówno do aplikacji lokalnych, jak i opartych na chmurze, za pomocą tych samych haseł**. Ta funkcja zapewnia Twoim użytkownikom lepsze doświadczenie - jedno hasło mniej do zapamiętania i zmniejsza koszty pomocy technicznej IT, ponieważ użytkownicy są mniej skłonni do zapomnienia, jak się zalogować. Gdy użytkownicy logują się za pomocą Azure AD, ta funkcja **sprawdza hasła użytkowników bezpośrednio w Twoim lokalnym Active Directory**.

W PTA **tożsamości** są **synchronizowane**, ale **hasła** **nie są**, tak jak w PHS.

Autoryzacja jest sprawdzana w lokalnym AD, a komunikacja z chmurą odbywa się za pomocą **agenta autoryzacji** działającego na serwerze lokalnym (nie musi być na lokalnym DC).

### Przebieg autoryzacji

<figure><img src="../../../../.gitbook/assets/image (4) (2) (1).png" alt=""><figcaption></figcaption></figure>

1. Aby **zalogować się**, użytkownik zostaje przekierowany do **Azure AD**, gdzie wysyła **nazwę użytkownika** i **hasło**.
2. **Poświadczenia** są **szyfrowane** i umieszczane w **kolejce** w Azure AD.
3. **Agent autoryzacji lokalnej** pobiera **poświadczenia** z kolejki i **odszyfrowuje** je. Ten agent nazywany jest **"Agentem autoryzacji przekazywanej"** lub **agentem PTA**.
4. **Agent** **sprawdza** poświadczenia w **lokalnym AD** i wysyła **odpowiedź** z powrotem do Azure AD, które, jeśli odpowiedź jest pozytywna, **zakończa logowanie** użytkownika.

{% hint style="warning" %}
Jeśli atakujący **przejmuje kontrolę** nad **PTA**, może **zobaczyć** wszystkie **poświadczenia** z kolejki (w **czystym tekście**).\
Może również **sprawdzić dowolne poświadczenia** w AzureAD (podobny atak do klucza szkieletowego).
{% endhint %}

### Lokalny -> chmura

Jeśli masz **dostęp admina** do **serwera Azure AD Connect** z uruchomionym **agentem PTA**, możesz użyć modułu **AADInternals**, aby **wstawić tylną furtkę**, która **sprawdzi WSZYSTKIE hasła** wprowadzone (więc wszystkie hasła będą ważne do autoryzacji):
```powershell
Install-AADIntPTASpy
```
{% hint style="info" %}
Jeśli **instalacja nie powiedzie się**, prawdopodobnie jest to spowodowane brakiem [Microsoft Visual C++ 2015 Redistributables](https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc\_redist.x64.exe).
{% endhint %}

Możliwe jest również **zobaczenie haseł w czystym tekście wysyłanych do agenta PTA** za pomocą następującego polecenia na maszynie, na której został zainstalowany poprzedni backdoor:
```powershell
Get-AADIntPTASpyLog -DecodePasswords
```
Ta tylna furtka będzie:

* Tworzyć ukryty folder `C:\PTASpy`
* Kopiować `PTASpy.dll` do `C:\PTASpy`
* Wstrzykiwać `PTASpy.dll` do procesu `AzureADConnectAuthenticationAgentService`

{% hint style="info" %}
Po ponownym uruchomieniu usługi AzureADConnectAuthenticationAgent, PTASpy jest "odładowywany" i musi zostać ponownie zainstalowany.
{% endhint %}

### Chmura -> On-Prem

{% hint style="danger" %}
Po uzyskaniu **uprawnień GA** w chmurze, możliwe jest **zarejestrowanie nowego agenta PTA**, ustawiając go na **maszynie kontrolowanej przez atakującego**. Po **skonfigurowaniu** agenta możemy **powtórzyć** **poprzednie** kroki, aby **uwierzytelnić się, używając dowolnego hasła** i również **otrzymać hasła w postaci tekstu jawnego**.
{% endhint %}

### Bezszwowe SSO

Możliwe jest użycie Bezszwowego SSO z PTA, co jest podatne na inne nadużycia. Sprawdź to w:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Odwołania

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-pta)
* [https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication](https://aadinternals.com/post/on-prem\_admin/#pass-through-authentication)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
