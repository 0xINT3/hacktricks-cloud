# Az AD Connect - Identidad Híbrida

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información Básica

**AD local** puede ser **integrado** con Azure AD usando **Azure AD Connect** con los siguientes **métodos,** los cuales podrían ser abusados para comprometer la **nube desde AD local o viceversa (**o ambos). Cada método soporta Single Sign-on (SSO):

* **Sincronización de Hash de Contraseña (PHS)**: Es posible extraer las contraseñas de usuarios privilegiados en texto claro del AD, incluso las credenciales de un usuario auto generado con altos privilegios sobre AzureAD.

{% content-ref url="phs-password-hash-sync.md" %}
[phs-password-hash-sync.md](phs-password-hash-sync.md)
{% endcontent-ref %}

* **Autenticación de Paso a Través (PTA)**: Es posible **comprometer el agente** que se ejecuta en el AD local para **validar todas las contraseñas** de los usuarios que intentan conectarse a Azure (local -> Nube) y también es posible **registrar un nuevo agente** para validar la autenticación en un nuevo lugar (Nube -> local).

{% content-ref url="pta-pass-through-authentication.md" %}
[pta-pass-through-authentication.md](pta-pass-through-authentication.md)
{% endcontent-ref %}

* **Federación**: Roba la **clave privada usada para firmar el SAML** y podrás suplantar identidades locales y en la nube.

{% content-ref url="federation.md" %}
[federation.md](federation.md)
{% endcontent-ref %}

* **SSO Sin Problemas:** Roba la contraseña del usuario auto creado **AZUREADSSOACC** que se utiliza para firmar tickets de plata de kerberos para acceder a AzureAD, e impersonar a cualquier usuario en la nube.

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

* **Confianza Kerberos en la Nube**: De **Administrador Global a Administrador de Dominio local** suplantando usuario modificando el nombre de usuario y SID de usuarios en AzureAD y luego solicitando TGTs a AzureAD.

{% content-ref url="az-cloud-kerberos-trust.md" %}
[az-cloud-kerberos-trust.md](az-cloud-kerberos-trust.md)
{% endcontent-ref %}

* **Aplicaciones Predeterminadas**: Si comprometes una cuenta de **Administrador de Aplicaciones** o la **cuenta de Sincronización local**, puedes leer y **modificar la configuración del directorio, membresías de grupo, cuentas de usuario, sitios de SharePoint y archivos de OneDrive**.

{% content-ref url="az-default-applications.md" %}
[az-default-applications.md](az-default-applications.md)
{% endcontent-ref %}

Para cada método, al menos se realiza la **sincronización de usuarios** y se crea una cuenta con el nombre **`MSOL_<installationidentifier>`** en el **AD local**.

Además, tanto **PHS** como **PTA** **soportan** **SSO Sin Problemas** para iniciar sesión automáticamente en computadoras de Azure AD **unidas al dominio local**.

Es posible verificar si **Azure AD Connect** está instalado con este comando del módulo AzureADConnectHealthSync que se **instala por defecto** en la instalación de **Azure AD Connect**:
```powershell
Get-ADSyncConnector
```
<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
