# Az - 云Kerberos信任

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

**本文是** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **的总结，您可以查阅以获取更多关于攻击的信息。这项技术也在** [**https://www.youtube.com/watch?v=AFay_58QubY**](https://www.youtube.com/watch?v=AFay_58QubY) **中有评论。**

## 基本信息

### 信任

当与Azure AD建立信任时，会在AD中创建一个**只读域控制器（RODC）**。**RODC计算机账户**，名为**`AzureADKerberos$`**。还有一个名为**`krbtgt_AzureAD`**的次级`krbtgt`账户。该账户包含Azure AD创建票据时使用的**Kerberos密钥**。

因此，如果此账户被泄露，就有可能冒充任何用户...尽管这不是真的，因为该账户被阻止为任何常见的特权AD组（如域管理员、企业管理员、管理员等）创建票据...

{% hint style="danger" %}
然而，在真实场景中，会有不在这些组中的特权用户。所以，如果**新的krbtgt账户被泄露**，可以用来冒充它们。
{% endhint %}

### Kerberos TGT

此外，当用户使用混合身份在Windows上认证时，**Azure AD**会发放**部分Kerberos票据以及PRT**。TGT是部分的，因为**AzureAD对于本地AD中的用户信息有限**（如安全标识符（SID）和名称）。\
Windows然后可以**将这个部分的TGT兑换为完整的TGT**，通过请求`krbtgt`服务的服务票据。&#x20;

### NTLM

由于可能存在不支持kerberos认证但支持NTLM的服务，可以请求使用次级`krbtgt`密钥签名的**部分TGT**，在请求的**PADATA**部分包含**`KERB-KEY-LIST-REQ`**字段，然后获取用主`krbtgt`密钥签名的完整TGT，**响应中包含NT哈希**。

## 滥用云Kerberos信任获取域管理员权限 <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

当AzureAD生成**部分TGT**时，它会使用它所知道的用户详情。因此，如果全局管理员可以修改像AzureAD中的用户**安全标识符和名称**这样的数据，当请求该用户的TGT时，**安全标识符将是一个不同的**。

通过Microsoft Graph或Azure AD Graph无法做到这一点，但可以使用**Active Directory Connect API**来创建和更新同步用户，全局管理员可以使用它来**修改任何混合用户的SAM名称和SID**，然后如果我们认证，我们得到的部分TGT将包含修改后的SID。

注意，我们可以使用AADInternals通过[Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet更新同步用户。

### 攻击前提条件 <a href="#attack-prerequisites" id="attack-prerequisites"></a>

为了让攻击成功并给我们域管理员权限，我们有几个要求：

* **通过同步API修改账户的权限**。全局管理员或AD Connect同步账户在这种情况下会起作用。混合身份管理员角色也会提供必要的权限，因为它可以管理AD Connect并创建新的同步账户。
* 至少有一个我们可以**修改并且能够认证的混合账户**。
* **一个在Active Directory中的目标账户**。虽然我们可以对任何已同步的账户使用这种攻击而无需修改它们的属性，但我们**不能在Azure AD租户中有重复的本地安全标识符**，所以为了修改一个账户并获取票据，我们需要**有一个未同步的账户**。
* 此外，这个账户必须具有域管理员等同的权限，**不能在任何常见的AD管理员组中**，因为那样AzureAD的RODC将无法生成有效的TGTs。
* 这种攻击的理想受害者实际上是**AD Connect同步服务使用的Active Directory账户**。这个账户没有同步到Azure AD，所以它的SID可以被定位，它具有域管理员等同的权限，因为它能够**同步密码哈希**（假设使用了密码哈希同步）。如果域使用快速安装，它的名称将以**MSOL\_**开头。如果它有不同的名称，您应该能够通过列出所有在域对象上具有目录复制权限的账户来找到这个账户。

### 完整的攻击 <a href="#the-full-attack" id="the-full-attack"></a>

* **全局管理员账户 `dirkjan@iminyour.cloud`**
* **我们可以修改以执行攻击的混合账户** `hybrid@hybrid.iminyour.cloud`。在这种情况下，我们知道混合账户的密码，这是我们需要的一切，以获得该账户的**PRT**。&#x20;
* **受害者账户**将是**`MSOL_9c3bf742d8e9`**，安全标识符为`S-1-5-21-1414223725-1888795230-1473887622-1104`。

第一步是获取**全局管理员的访问令牌**。同步服务使用与Azure AD Graph API相同的资源ID，所以我们可以使用**`roadtx`**为我们的管理员账户获取令牌。如果我们不需要MFA，可以使用**`gettokens`**命令，或者使用`interactiveauth`来有一个支持MFA的交互式窗口。在我的例子中，我的凭据存储在KeePass数据库中，所以我使用`keepassauth`命令：

<figure><img src="../../../../.gitbook/assets/image (118).png" alt=""><figcaption></figcaption></figure>

接下来，我们可以使用**`roadtools_hybrid`**的`modifyuser.py`脚本**修改`hybrid@hybrid.iminyour.cloud`身份**。这里一个重要的参数是**`SourceAnchor`**，因为这是用来将用户与Azure AD账户匹配的。在门户中，这被称为“本地不可变ID”，在ROADrecon中，你可以在用户对象上找到这个作为`immutableId`属性。我们也可以使用一个不存在的`SourceAnchor`来创建一个新用户，这只是引入了一个额外的步骤来给账户添加密码。我们还向工具**提供目标SAM名称和期望的SID**，它将改变`hybrid@hybrid.iminyour.cloud`用户对象上的这些：

<figure><img src="../../../../.gitbook/assets/image (119).png" alt=""><figcaption></figcaption></figure>

现在账户已经修改，我们可以**为这个用户请求PRT**，包括**部分TGT**。最好是**等待一分钟**以确保我们的更改得到正确同步，但通常这是相当快的：

<figure><img src="../../../../.gitbook/assets/image (122).png" alt=""><figcaption></figcaption></figure>

有了部分TGT，我们可以请求完整的TGT并恢复NT哈希，这次是针对MSOL账户的：

<figure><img src="../../../../.gitbook/assets/image (123).png" alt=""><figcaption></figcaption></figure>

有了**完整的TGT**（或NT哈希），我们可以与域控制器通信并**执行DCSync攻击**，同步所有哈希，包括完整KRBTGT账户的哈希，这允许我们伪造自己的TGTs，从而将我们的访问权限提升到完整的域管理员。

<figure><img src="../../../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

作为最后一步，建议使用`modifyuser.py`将账户更改回其原始的SAM名称和SID，或者如果我们创建了一个新账户，则删除该账户。这一步是可选的，因为从我所见，Azure AD connect会捕捉到更改并自动逆转更改。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
