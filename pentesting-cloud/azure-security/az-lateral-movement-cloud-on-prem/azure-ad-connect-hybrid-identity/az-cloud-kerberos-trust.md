# Az - Confianza Kerberos en la Nube

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks para AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este post es un resumen de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **que se puede consultar para obtener m√°s informaci√≥n sobre el ataque.**

## Informaci√≥n B√°sica

### Confianza

Cuando se establece una confianza con Azure AD, se crea un **Controlador de Dominio de Solo Lectura (RODC) en el AD.** La **cuenta de equipo RODC**, llamada **`AzureADKerberos$`**. Adem√°s, una cuenta secundaria `krbtgt` llamada **`krbtgt_AzureAD`**. Esta cuenta contiene las **claves Kerberos** utilizadas para los tickets que crea Azure AD.

Por lo tanto, si esta cuenta se ve comprometida, podr√≠a ser posible suplantar a cualquier usuario... aunque esto no es cierto porque esta cuenta est√° impedida de crear tickets para cualquier grupo privilegiado com√∫n de AD como Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Sin embargo, en un escenario real habr√° usuarios privilegiados que no est√©n en esos grupos. As√≠ que la **nueva cuenta krbtgt, si se ve comprometida, podr√≠a ser utilizada para suplantarlos.**
{% endhint %}

### TGT de Kerberos

Adem√°s, cuando un usuario se autentica en Windows usando una identidad h√≠brida **Azure AD** emitir√° **un ticket Kerberos parcial junto con el PRT.** El TGT es parcial porque **AzureAD tiene informaci√≥n limitada** del usuario en el AD local (como el identificador de seguridad (SID) y el nombre).\
Windows puede entonces **intercambiar este TGT parcial por un TGT completo** solicitando un ticket de servicio para el servicio `krbtgt`.&#x20;

### NTLM

Como podr√≠a haber servicios que no soportan la autenticaci√≥n kerberos sino NTLM, es posible solicitar un **TGT parcial firmado usando una clave secundaria `krbtgt`** incluyendo el campo **`KERB-KEY-LIST-REQ`** en la parte **PADATA** de la solicitud y luego obtener un TGT completo firmado con la clave primaria `krbtgt` **incluyendo el hash NT en la respuesta**.

## Abusando de la Confianza Kerberos en la Nube para obtener Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Cuando AzureAD genera un **TGT parcial** lo har√° usando los detalles que tiene sobre el usuario. Por lo tanto, si un Global Admin pudiera modificar datos como el **identificador de seguridad y nombre del usuario en AzureAD**, al solicitar un TGT para ese usuario el **identificador de seguridad ser√≠a diferente**.

No es posible hacer eso a trav√©s de Microsoft Graph o Azure AD Graph, pero es posible usar la **API que Active Directory Connect** utiliza para crear y actualizar usuarios sincronizados, que puede ser utilizada por los Global Admins para **modificar el nombre SAM y SID de cualquier usuario h√≠brido**, y luego si nos autenticamos, obtenemos un TGT parcial que contiene el SID modificado.

Nota que podemos hacer esto con AADInternals y actualizar a usuarios sincronizados a trav√©s del cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Prerrequisitos del ataque <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Para que el ataque tenga √©xito y nos otorgue privilegios de Domain Admin, tenemos algunos requisitos:

* **Privilegios para modificar cuentas a trav√©s de la API de Sincronizaci√≥n**. Funcionar√≠a una cuenta de Global Admin o una cuenta de sincronizaci√≥n de AD Connect. El rol de Administrador de Identidad H√≠brida tambi√©n proporcionar√≠a los permisos necesarios, ya que este puede gestionar AD Connect y crear nuevas cuentas de sincronizaci√≥n.
* Al menos una **cuenta h√≠brida** que podamos **modificar con la informaci√≥n de la cuenta v√≠ctima y tambi√©n autenticarnos**.
* **Una cuenta v√≠ctima** para atacar en Active Directory. Aunque podr√≠amos usar este ataque en cualquier cuenta ya sincronizada sin necesidad de modificar sus atributos, **no podemos tener identificadores de seguridad duplicados en nuestro inquilino de Azure AD**, por lo que para modificar una cuenta y obtener el ticket necesitamos **tener una cuenta que no est√© sincronizada**.
* Adem√°s, esta cuenta debe tener privilegios equivalentes a domain admin, **sin estar en ning√∫n grupo com√∫n de administradores de AD** ya que entonces el RODC de AzureAD no podr√° generar TGTs v√°lidos.
* La v√≠ctima ideal para este ataque es de hecho la **cuenta de Active Directory que utiliza el servicio de sincronizaci√≥n de AD Connect**. Esta cuenta no est√° sincronizada con Azure AD, por lo que su SID est√° disponible para atacar, y tiene privilegios equivalentes a Domain Admin debido a su capacidad de **sincronizar hashes de contrase√±as** (asumiendo que se utiliza la sincronizaci√≥n de hashes de contrase√±as). Si el dominio utiliza la instalaci√≥n express, su nombre comenzar√° con **MSOL\_**. Si tiene un nombre diferente, deber√≠as poder encontrarlo listando todas las cuentas que tienen privilegios de Replicaci√≥n de Directorio en el objeto del dominio.

### El ataque completo <a href="#the-full-attack" id="the-full-attack"></a>

* **Cuenta de Global Admin `dirkjan@iminyour.cloud`**
* **Cuenta h√≠brida** que podemos modificar para realizar el ataque `hybrid@hybrid.iminyour.cloud`. En este caso conocemos la contrase√±a de la cuenta h√≠brida, que es todo lo que necesitamos para obtener un **PRT** para la cuenta.&#x20;
* **Cuenta v√≠ctima** ser√° **`MSOL_9c3bf742d8e9`** con identificador de seguridad `S-1-5-21-1414223725-1888795230-1473887622-1104`.

El primer paso es obtener un **token de acceso para el Global Admin**. El servicio de sincronizaci√≥n utiliza el mismo ID de recurso que la API de Azure AD Graph, por lo que podemos usar **`roadtx`** para obtener un token para nuestra cuenta de administrador. Podemos hacer esto usando el comando **`gettokens`** si no necesitamos MFA, o usar `interactiveauth` para tener una ventana interactiva que soporte MFA tambi√©n. En mi ejemplo mis credenciales est√°n almacenadas en una base de datos de KeePass por lo que uso el comando `keepassauth`:

<figure><img src="../../../../.gitbook/assets/image (118).png" alt=""><figcaption></figcaption></figure>

A continuaci√≥n, podemos **modificar la identidad `hybrid@hybrid.iminyour.cloud`** con el script `modifyuser.py` de **`roadtools_hybrid`**. Un par√°metro importante aqu√≠ es el **`SourceAnchor`**, ya que esto se utiliza para hacer coincidir al usuario con la cuenta de Azure AD. En el portal, esto se llama "ID inmutable en las instalaciones" y en ROADrecon puedes encontrar esto como el atributo `immutableId` en el objeto de usuario. Tambi√©n podemos usar un `SourceAnchor` inexistente para crear un nuevo usuario, esto solo introduce un paso extra para a√±adir una contrase√±a a la cuenta. Tambi√©n **proporcionamos el nombre SAM objetivo y el SID deseado** a la herramienta, que cambiar√° estos en el objeto de usuario `hybrid@hybrid.iminyour.cloud`:

<figure><img src="../../../../.gitbook/assets/image (119).png" alt=""><figcaption></figcaption></figure>

Ahora la cuenta est√° modificada y podemos **solicitar un PRT para este usuario**, incluyendo el **TGT parcial**. Es mejor **esperar un minuto** para asegurarnos de que nuestro cambio se ha sincronizado correctamente, pero generalmente esto es bastante r√°pido:

<figure><img src="../../../../.gitbook/assets/image (122).png" alt=""><figcaption></figcaption></figure>

Con el TGT parcial podemos solicitar el TGT completo y recuperar el hash NT, esta vez para la cuenta MSOL:

<figure><img src="../../../../.gitbook/assets/image (123).png" alt=""><figcaption></figcaption></figure>

Con el **TGT completo** (o el hash NT) podemos hablar con el Controlador de Dominio y **realizar un ataque DCSync**, sincronizando todos los hashes, incluyendo el hash de la cuenta completa KRBTGT, lo que nos permite falsificar nuestros propios TGTs, elevando esencialmente nuestro acceso a Domain Admin completo.

<figure><img src="../../../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

Como √∫ltimo paso, es aconsejable cambiar la cuenta de nuevo a su nombre SAM original y SID usando `modifyuser.py`, o eliminar la cuenta si creamos una nueva. Este paso es opcional, ya que por lo que he visto Azure AD connect recoger√° el cambio y revertir√° el cambio autom√°ticamente.

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks para AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
