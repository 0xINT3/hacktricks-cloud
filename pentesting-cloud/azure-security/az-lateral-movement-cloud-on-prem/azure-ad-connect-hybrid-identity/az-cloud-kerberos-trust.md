# Az - Bulut Kerberos Güveni

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamını görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter'da** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'ı takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

**Bu yazı, saldırı hakkında daha fazla bilgi için kontrol edilebilecek olan** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **adresinin özeti niteliğindedir. Bu teknik ayrıca** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**'de de yorumlanmıştır.**

## Temel Bilgiler

### Güven

Azure AD ile bir güven ilişkisi kurulduğunda, AD'de bir **Salt Okunur Etki Alanı Denetleyicisi (RODC) oluşturulur.** RODC bilgisayar hesabı, **`AzureADKerberos$`** adında olur. Ayrıca, ikincil bir `krbtgt` hesabı olan **`krbtgt_AzureAD`** adında bir hesap oluşturulur. Bu hesap, Azure AD'nin oluşturduğu biletler için kullanılan **Kerberos anahtarlarını** içerir.

Bu nedenle, bu hesap ele geçirilirse herhangi bir kullanıcıyı taklit etmek mümkün olabilir... ancak bu doğru değildir çünkü bu hesap, Erişim Denetleyicileri, Kurumsal Yöneticiler, Yöneticiler gibi yaygın ayrıcalıklı AD grubu için bilet oluşturmasını engellenmiştir...

{% hint style="danger" %}
Ancak, gerçek bir senaryoda bu gruplarda olmayan ayrıcalıklı kullanıcılar olacaktır. Bu nedenle, **yeni krbtgt hesabı, ele geçirildiğinde onları taklit etmek için kullanılabilir.**
{% endhint %}

### Kerberos TGT

Ayrıca, bir kullanıcı bir hibrit kimlik kullanarak Windows üzerinde kimlik doğruladığında, **Azure AD**, PRT ile birlikte **kısmi Kerberos bilet**i oluşturur. TGT, AzureAD'nin yerindeki AD hakkında **sınırlı bilgiye** sahip olduğu için kısmidir (güvenlik tanımlayıcısı (SID) ve ad gibi).\
Windows, bu kısmi TGT'yi, `krbtgt` hizmeti için bir hizmet biletiği isteyerek **tam bir TGT ile değiştirebilir**.&#x20;

### NTLM

Kerberos kimlik doğrulamasını desteklemeyen hizmetler olabileceğinden, istekte **`KERB-KEY-LIST-REQ`** alanını içeren ikincil bir `krbtgt` anahtarıyla imzalanmış **kısmi bir TGT** talep etmek ve ardından yanıtta **NT karma değerini içeren bir tam TGT** almak mümkündür.

## Bulut Kerberos Güvenini Kötüye Kullanarak Etki Alanı Yöneticisi Elde Etme <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureAD, **kısmi bir TGT** oluşturduğunda, kullanıcı hakkında sahip olduğu ayrıntıları kullanır. Bu nedenle, bir Global Yönetici, AzureAD'deki kullanıcının **güvenlik tanımlayıcısını ve adını değiştirebilirse**, o kullanıcı için bir TGT istendiğinde **güvenlik tanımlayıcısı farklı olacaktır**.

Bu, Microsoft Graph veya Azure AD Graph aracılığıyla yapılamaz, ancak Global Yöneticiler tarafından kullanılabilen **API Active Directory Connect** kullanarak senkronize edilen kullanıcıları oluşturmak ve güncellemek için kullanılabilir ve bu şekilde kimlik doğrulama yaparsak, değiştirilmiş SID içeren bir kısmi TGT alırız.

AADInternals ile bunu yapabilir ve senkronize edilen kullanıcıları [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet'i aracılığıyla güncelleyebiliriz.

### Saldırı önkoşulları <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Saldırının başarısı ve Etki Alanı Yöneticisi ayrıcalıklarının elde edilmesi, belirli önkoşulların karşılanmasına bağlıdır:

* Hesapları Synchronization API aracılığıyla değiştirebilme yeteneği önemlidir. Bu, Global Yönetici rolüne sahip olmak veya bir AD Connect senkronizasyon hesabına sahip olmakla elde edilebilir. Alternatif olarak, Hibrit Kimlik Yöneticisi rolü yeterli olacaktır, çünkü AD Connect'i yönetme ve yeni senkronizasyon hesapları oluşturma yeteneği sağlar.
* Bir **hibrit hesabın** varlığı önemlidir. Bu hesap, kurban hesabının ayrıntılarıyla değiştirilebilir olmalı ve kimlik doğrulaması için erişilebilir olmalıdır.
* Active Directory içinde bir **hedef kurban hesabının** belirlenmesi gerekmektedir. Saldırı herhangi bir senkronize edilmiş hesap üzerinde gerçekleştirilebilir olsa da, Azure AD kiracının yerindeki güvenlik tanımlayıcılarının çoğaltılmaması gerektiğinden senkronize edilmemiş bir hesabın değiştirilmesi gerekmektedir.
* Ayrıca, bu hesap, etkisiz TGT'lerin AzureAD RODC tarafından oluşturulmasını önlemek için tipik AD yönetici gruplarının üyesi olmamalıdır, ancak etki alanı yöneticisi eşdeğer ayrıcalıklara sahip olmalıdır.
* En uygun hedef, AD Connect Sync hizmeti tarafından kullanılan **Active Directory hesabıdır**. Bu hesap Azure AD ile senkronize edilmez, bu nedenle SID'si hedeflenebilir durumdadır ve şifre karma değerlerini senkronize etme rolü nedeniyle doğal olarak Etki Alanı Yöneticisi eşdeğer ayrıcalıklara sahiptir (Şifre Karma Senkronizasyonu etkinse). Express kurulumlu alanlar için bu hesap **MSOL\_** ile başlar. Diğer durumlar için, etki alanı nesnesindeki Veri Çoğaltma ayrıcalıklar
