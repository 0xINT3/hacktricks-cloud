# Az - Confian√ßa Kerberos na Nuvem

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este post √© um resumo de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **que pode ser consultado para mais informa√ß√µes sobre o ataque. Esta t√©cnica tamb√©m √© comentada em** [**https://www.youtube.com/watch?v=AFay_58QubY**](https://www.youtube.com/watch?v=AFay_58QubY)**.**

## Informa√ß√µes B√°sicas

### Confian√ßa

Quando uma confian√ßa √© estabelecida com o Azure AD, um **Controlador de Dom√≠nio Somente Leitura (RODC) √© criado no AD.** A **conta de computador RODC**, chamada **`AzureADKerberos$`**. Al√©m disso, uma conta secund√°ria `krbtgt` chamada **`krbtgt_AzureAD`**. Esta conta cont√©m as **chaves Kerberos** usadas para os tickets que o Azure AD cria.

Portanto, se esta conta for comprometida, seria poss√≠vel se passar por qualquer usu√°rio... embora isso n√£o seja verdade porque esta conta √© impedida de criar tickets para qualquer grupo privilegiado comum do AD, como Administradores de Dom√≠nio, Administradores Empresariais, Administradores...

{% hint style="danger" %}
No entanto, em um cen√°rio real, haver√° usu√°rios privilegiados que n√£o est√£o nesses grupos. Ent√£o, a **nova conta krbtgt, se comprometida, poderia ser usada para se passar por eles.**
{% endhint %}

### Kerberos TGT

Al√©m disso, quando um usu√°rio se autentica no Windows usando uma identidade h√≠brida **Azure AD** emitir√° **ticket Kerberos parcial junto com o PRT.** O TGT √© parcial porque **o AzureAD tem informa√ß√µes limitadas** do usu√°rio no AD local (como o identificador de seguran√ßa (SID) e o nome).\
O Windows pode ent√£o **trocar este TGT parcial por um TGT completo** solicitando um ticket de servi√ßo para o servi√ßo `krbtgt`.&#x20;

### NTLM

Como pode haver servi√ßos que n√£o suportam autentica√ß√£o kerberos, mas NTLM, √© poss√≠vel solicitar um **TGT parcial assinado usando uma chave secund√°ria `krbtgt`** incluindo o campo **`KERB-KEY-LIST-REQ`** na parte **PADATA** da solicita√ß√£o e, em seguida, obter um TGT completo assinado com a chave prim√°ria `krbtgt` **incluindo o hash NT na resposta**.

## Abusando da Confian√ßa Kerberos na Nuvem para obter Administra√ß√£o de Dom√≠nio <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Quando o AzureAD gera um **TGT parcial**, ele usar√° os detalhes que tem sobre o usu√°rio. Portanto, se um Administrador Global pudesse modificar dados como o **identificador de seguran√ßa e nome do usu√°rio no AzureAD**, ao solicitar um TGT para esse usu√°rio, o **identificador de seguran√ßa seria diferente**.

N√£o √© poss√≠vel fazer isso atrav√©s do Microsoft Graph ou do Azure AD Graph, mas √© poss√≠vel usar a **API Active Directory Connect** que cria e atualiza usu√°rios sincronizados, que pode ser usada pelos Administradores Globais para **modificar o nome SAM e SID de qualquer usu√°rio h√≠brido**, e ent√£o, se nos autenticarmos, obteremos um TGT parcial contendo o SID modificado.

Observe que podemos fazer isso com AADInternals e atualizar para usu√°rios sincronizados via cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Pr√©-requisitos do ataque <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Para que o ataque tenha sucesso e nos d√™ privil√©gios de Administra√ß√£o de Dom√≠nio, temos alguns requisitos:

* **Privil√©gios para modificar contas via API de Sincroniza√ß√£o**. Administrador Global ou conta de sincroniza√ß√£o do AD Connect funcionariam neste caso. O papel de Administrador de Identidade H√≠brida tamb√©m forneceria as permiss√µes necess√°rias, j√° que isso pode gerenciar o AD Connect e criar novas contas de sincroniza√ß√£o.
* Pelo menos uma **conta h√≠brida** que podemos **modificar com as informa√ß√µes da conta da v√≠tima e tamb√©m autenticar**.
* **Uma conta de v√≠tima** para alvo no Active Directory. Embora pud√©ssemos usar este ataque em qualquer conta j√° sincronizada sem a necessidade de modificar seus atributos, **n√£o podemos ter identificadores de seguran√ßa duplicados no local em nosso inquilino do Azure AD**, ent√£o para modificar uma conta e obter o ticket precisamos **ter uma conta que n√£o est√° sincronizada**.
* Al√©m disso, esta conta deve ter privil√©gios equivalentes ao administrador de dom√≠nio, **sem estar em nenhum grupo comum de administradores do AD** pois ent√£o o RODC do AzureAD n√£o ser√° capaz de gerar TGTs v√°lidos.
* A v√≠tima ideal para este ataque √©, de fato, a **conta do Active Directory usada pelo servi√ßo de sincroniza√ß√£o do AD Connect**. Esta conta n√£o √© sincronizada com o Azure AD, ent√£o seu SID est√° dispon√≠vel para alvo, e tem privil√©gios equivalentes ao Administrador de Dom√≠nio por causa de sua capacidade de **sincronizar hashes de senha** (assumindo que a Sincroniza√ß√£o de Hash de Senha est√° em uso). Se o dom√≠nio usa a instala√ß√£o expressa, seu nome come√ßar√° com **MSOL\_**. Se tiver um nome diferente, voc√™ deve ser capaz de encontrar isso listando todas as contas que t√™m privil√©gios de Replica√ß√£o de Diret√≥rio no objeto do dom√≠nio.

### O ataque completo <a href="#the-full-attack" id="the-full-attack"></a>

* **Conta de Administrador Global `dirkjan@iminyour.cloud`**
* **Conta h√≠brida** que podemos modificar para realizar o ataque `hybrid@hybrid.iminyour.cloud`. Neste caso, sabemos a senha da conta h√≠brida, que √© tudo o que precisamos para obter um **PRT** para a conta.&#x20;
* **Conta da v√≠tima** ser√° **`MSOL_9c3bf742d8e9`** com identificador de seguran√ßa `S-1-5-21-1414223725-1888795230-1473887622-1104`.

O primeiro passo √© obter um **token de acesso para o Administrador Global**. O servi√ßo de sincroniza√ß√£o usa o mesmo ID de recurso que a API do Azure AD Graph, ent√£o podemos usar **`roadtx`** para obter um token para nossa conta de administrador. Podemos fazer isso usando o comando **`gettokens`** se n√£o precisarmos de MFA, ou usar o `interactiveauth` para ter uma janela interativa que suporta MFA tamb√©m. No meu exemplo, minhas credenciais est√£o armazenadas em um banco de dados KeePass, ent√£o eu uso o comando `keepassauth`:

<figure><img src="../../../../.gitbook/assets/image (118).png" alt=""><figcaption></figcaption></figure>

Em seguida, podemos **modificar a identidade `hybrid@hybrid.iminyour.cloud`** com o script `modifyuser.py` de **`roadtools_hybrid`**. Um par√¢metro importante aqui √© o **`SourceAnchor`**, j√° que este √© usado para combinar o usu√°rio com a conta do Azure AD. No portal, isso √© chamado de "ID imut√°vel no local" e no ROADrecon voc√™ pode encontrar isso como o atributo `immutableId` no objeto do usu√°rio. Tamb√©m podemos usar um `SourceAnchor` inexistente para criar um novo usu√°rio, isso apenas introduz uma etapa extra para adicionar uma senha √† conta. Tamb√©m **fornecemos o nome SAM alvo e o SID desejado** √† ferramenta, que mudar√° esses na conta do usu√°rio `hybrid@hybrid.iminyour.cloud`:

<figure><img src="../../../../.gitbook/assets/image (119).png" alt=""><figcaption></figcaption></figure>

Agora a conta est√° modificada e podemos **solicitar um PRT para este usu√°rio**, incluindo o **TGT parcial**. √â melhor **esperar um minuto** para garantir que nossa mudan√ßa seja sincronizada corretamente, mas geralmente isso √© bastante r√°pido:

<figure><img src="../../../../.gitbook/assets/image (122).png" alt=""><figcaption></figcaption></figure>

Com o TGT parcial, podemos solicitar o TGT completo e recuperar o hash NT, desta vez para a conta MSOL:

<figure><img src="../../../../.gitbook/assets/image (123).png" alt=""><figcaption></figcaption></figure>

Com o **TGT completo** (ou o hash NT) podemos nos comunicar com o Controlador de Dom√≠nio e **realizar um ataque DCSync**, sincronizando todos os hashes, incluindo o hash da conta KRBTGT completa, o que nos permite forjar nossos pr√≥prios TGTs, elevando essencialmente nosso acesso a Administrador de Dom√≠nio completo.

<figure><img src="../../../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

Como √∫ltimo passo, √© aconselh√°vel mudar a conta de volta para seu nome SAM original e SID usando o `modifyuser.py`, ou deletar a conta se criamos uma nova. Este passo √© opcional, j√° que pelo que vi o Azure AD connect vai detectar a mudan√ßa e reverter a mudan√ßa automaticamente.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
