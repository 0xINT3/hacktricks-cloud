# Az - Cloud Kerberos Trust

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**This post is a summary of** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **which can be checked for further information about the attack. This technique is also commented in** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Basic Information

### Trust

When a trust is stablished with Azure AD, a **Read Only Domain Controller (RODC) is created in the AD.** The **RODC computer account**, named **`AzureADKerberos$`**. Also, a secondary `krbtgt` account named **`krbtgt_AzureAD`**. This account contains the **Kerberos keys** used for tickets that Azure AD creates.

Therefore, if this account is compromised it could be possible to impersonate any user... although this is not true because this account is prevented from creating tickets for any common privileged AD group like Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
However, in a real scenario there are going to be privileged users that aren't in those groups. So the **new krbtgt account, if compromised, could be used to impersonate them.**
{% endhint %}

### Kerberos TGT

Moreover, when a user authenticates on Windows using a hybrid identity **Azure AD** will issue **partial Kerberos ticket along with the PRT.** The TGT is partial because **AzureAD has limited information** of the user in the on-prem AD (like the security identifier (SID) and the name).\
Windows can then **exchange this partial TGT for a full TGT** by requesting a service ticket for the `krbtgt` service.&#x20;

### NTLM

As there could be services that doesn't support kerberos authentication but NTLM, it's possible to request a **partial TGT signed using a secondary `krbtgt`** key including the **`KERB-KEY-LIST-REQ`** field in the **PADATA** part of the request  and then get a full TGT signed with the primary `krbtgt` key **including the NT hash in the response**.

## Abusing Cloud Kerberos Trust to obtain Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

When AzureAD generates a **partial TGT** it will be using the details it has about the user. Therefore, if a Global Admin could modify data like the **security identifier and name of the user in AzureAD**, when requesting a TGT for that user the **security identifier would be a different one**.

It's not possible to do that through the Microsoft Graph or the Azure AD Graph, but it's possible to use the **API Active Directory Connect** uses to create and update synced users, which can be used by the Global Admins to **modify the SAM name and SID of any hybrid user**, and then if we authenticate, we get a partial TGT containing the modified SID.

Note that we can do this with AADInternals and update to synced users via the [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) cmdlet.

### Attack prerequisites <a href="#attack-prerequisites" id="attack-prerequisites"></a>

For the attack to succeed and give us Domain Admin privileges, we have a few requirements:

* **Privileges to modify accounts via the Synchronization API**. Global Admin or AD Connect sync account would work in this case. The Hybrid Identity Administrator role also would provide the necessary permissions, since this can manage AD Connect and create new sync accounts.
* At least one **hybrid account** which we can **modify with the victim account info and also authenticate to**.
* **A victim account** to target in Active Directory. While we could use this attack on any already synced account without the need to modify their attributes, we **cannot have duplicate on-premises security identifiers in our Azure AD tenant**, so to modify an account and obtain the ticket we need to **have an account that is not synced**.
  * Moreover, this account must have domain admin equivalent privileges, **without being in any common AD administrator groups** as then the RODC of AzureAD won't be able to generate valid TGTs.
  * The ideal victim for this attack is in fact the **Active Directory account that is used by the AD Connect Sync service**. This account is not synced to Azure AD, so its SID is available to target, and it has Domain Admin equivalent privileges because of its ability to **synchronize password hashes** (assuming Password Hash Sync is in use). If the domain uses the express installation, its name will start with **MSOL\_**. If it has a different name, you should be able to find this by listing all the accounts that have Directory Replication privileges on the domain object.

### The full attack <a href="#the-full-attack" id="the-full-attack"></a>

* **Global Admin account `dirkjan@iminyour.cloud`**
* **Hybrid account** that we can modify to perform the attack `hybrid@hybrid.iminyour.cloud`. In this case we know the password for the hybrid account, which is all we need to get a **PRT** for the account.&#x20;
* **Victim account** will be **`MSOL_9c3bf742d8e9`** with security identifier `S-1-5-21-1414223725-1888795230-1473887622-1104`.

The first step is obtaining an **access token for the Global Admin**. The synchronization service uses the same resource ID as the Azure AD Graph API, so we can use **`roadtx`** to get a token for our admin account. We can do this using the **`gettokens`** command if we don‚Äôt need MFA, or use the `interactiveauth` to have an interactive window that supports MFA as well. In my example my credentials are stored in a KeePass database so I use the `keepassauth` command:

<figure><img src="../../../../.gitbook/assets/image (118).png" alt=""><figcaption></figcaption></figure>

Next, we can **modify the `hybrid@hybrid.iminyour.cloud` identity** with the `modifyuser.py` script from **`roadtools_hybrid`**. An important parameter here is the **`SourceAnchor`**, since this is used to match the user with the Azure AD account. In the portal, this is called the ‚ÄúOn-premises immutable ID‚Äù and in ROADrecon you can find this as the `immutableId` attribute on the user object. We can also use a non-existing `SourceAnchor` to create a new user, this just introduces an extra step to add a password to the account. We also **supply the target SAM name and desired SID** to the tool, which will change these on the `hybrid@hybrid.iminyour.cloud` user object:

<figure><img src="../../../../.gitbook/assets/image (119).png" alt=""><figcaption></figcaption></figure>

Now the account is modified and we can **request a PRT for this user**, including the **partial TGT**. It is best to **wait a minute** to make sure our change is synchronized properly, but usually this is quite fast:

<figure><img src="../../../../.gitbook/assets/image (122).png" alt=""><figcaption></figcaption></figure>

With the partial TGT we can request the full TGT and recover the NT hash, this time for the MSOL account:

<figure><img src="../../../../.gitbook/assets/image (123).png" alt=""><figcaption></figcaption></figure>

With the **full TGT** (or the NT hash) we can talk to the Domain Controller and **perform a DCSync attack**, synchronizing all the hashes, including the hash of the full KRBTGT account, which allows us to forge our own TGTs, essentially elevating our access to full Domain Admin.

<figure><img src="../../../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

As a last step, it is advisable to change the account back to its original SAM name and SID using the `modifyuser.py`, or to delete the account if we created a new one. This step is optional, since from what I have seen Azure AD connect will pick up the change and reverse the change automatically.

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
