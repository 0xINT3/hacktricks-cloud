# Az - Confianza en Kerberos en la Nube

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Esta publicaci√≥n es un resumen de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **que se puede consultar para obtener m√°s informaci√≥n sobre el ataque. Esta t√©cnica tambi√©n se comenta en** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**.**

## Informaci√≥n B√°sica

### Confianza

Cuando se establece una confianza con Azure AD, se crea un **Controlador de Dominio de Solo Lectura (RODC) en el AD.** La cuenta de equipo RODC, llamada **`AzureADKerberos$`**. Adem√°s, se crea una cuenta secundaria `krbtgt` llamada **`krbtgt_AzureAD`**. Esta cuenta contiene las **claves de Kerberos** utilizadas para los tickets que crea Azure AD.

Por lo tanto, si esta cuenta se ve comprometida, podr√≠a ser posible suplantar a cualquier usuario... aunque esto no es cierto porque esta cuenta est√° impedida de crear tickets para cualquier grupo AD privilegiado com√∫n como Administradores de Dominio, Administradores de Empresa, Administradores...

{% hint style="danger" %}
Sin embargo, en un escenario real habr√° usuarios privilegiados que no est√©n en esos grupos. Por lo tanto, la **nueva cuenta krbtgt, si se ve comprometida, podr√≠a usarse para suplantarlos.**
{% endhint %}

### TGT de Kerberos

Adem√°s, cuando un usuario se autentica en Windows utilizando una identidad h√≠brida de **Azure AD**, Azure AD emitir√° un **ticket de Kerberos parcial junto con el PRT.** El TGT es parcial porque **AzureAD tiene informaci√≥n limitada** del usuario en el AD local (como el identificador de seguridad (SID) y el nombre).\
Windows puede luego **intercambiar este TGT parcial por un TGT completo** solicitando un ticket de servicio para el servicio `krbtgt`.&#x20;

### NTLM

Dado que puede haber servicios que no admiten autenticaci√≥n kerberos sino NTLM, es posible solicitar un **TGT parcial firmado usando una clave `krbtgt`** secundaria que incluya el campo **`KERB-KEY-LIST-REQ`** en la parte de **PADATA** de la solicitud y luego obtener un TGT completo firmado con la clave `krbtgt` primaria **incluyendo el hash NT en la respuesta**.

## Abuso de la Confianza en Kerberos en la Nube para obtener Administrador de Dominio <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Cuando AzureAD genera un **TGT parcial** estar√° utilizando los detalles que tiene sobre el usuario. Por lo tanto, si un Administrador Global pudiera modificar datos como el **identificador de seguridad y nombre del usuario en AzureAD**, al solicitar un TGT para ese usuario el **identificador de seguridad ser√≠a diferente**.

No es posible hacerlo a trav√©s de Microsoft Graph o Azure AD Graph, pero es posible utilizar la **API que utiliza Active Directory Connect** para crear y actualizar usuarios sincronizados, lo cual puede ser utilizado por los Administradores Globales para **modificar el nombre SAM y SID de cualquier usuario h√≠brido**, y luego, si nos autenticamos, obtenemos un TGT parcial que contiene el SID modificado.

Ten en cuenta que podemos hacer esto con AADInternals y actualizar usuarios sincronizados a trav√©s del cmdlet [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Requisitos previos del ataque <a href="#attack-prerequisites" id="attack-prerequisites"></a>

El √©xito del ataque y la obtenci√≥n de privilegios de Administrador de Dominio dependen de cumplir con ciertos requisitos previos:

* La capacidad de alterar cuentas a trav√©s de la API de Sincronizaci√≥n es crucial. Esto se puede lograr teniendo el rol de Administrador Global o poseyendo una cuenta de sincronizaci√≥n de AD Connect. Alternativamente, el rol de Administrador de Identidad H√≠brida ser√≠a suficiente, ya que otorga la capacidad de administrar AD Connect y establecer nuevas cuentas de sincronizaci√≥n.
* Es esencial la presencia de una **cuenta h√≠brida**. Esta cuenta debe ser modificable con los detalles de la cuenta v√≠ctima y tambi√©n debe ser accesible para la autenticaci√≥n.
* Es necesaria la identificaci√≥n de una **cuenta v√≠ctima objetivo** dentro de Active Directory. Aunque el ataque se puede ejecutar en cualquier cuenta ya sincronizada, el inquilino de Azure AD no debe haber replicado identificadores de seguridad locales, lo que requiere la modificaci√≥n de una cuenta no sincronizada para obtener el ticket.
* Adem√°s, esta cuenta debe poseer privilegios equivalentes a los de un administrador de dominio pero no debe ser miembro de grupos administrativos AD t√≠picos para evitar la generaci√≥n de TGT inv√°lidos por el RODC de AzureAD.
* El objetivo m√°s adecuado es la **cuenta de Active Directory utilizada por el servicio de Sincronizaci√≥n de AD Connect**. Esta cuenta no se sincroniza con Azure AD, dejando su SID como un objetivo viable, y posee inherentemente privilegios equivalentes a los de un Administrador de Dominio debido a su funci√≥n en la sincronizaci√≥n de hash de contrase√±as (asumiendo que la Sincronizaci√≥n de Hash de Contrase√±as est√° activa). Para dominios con instalaci√≥n express, esta cuenta tiene el prefijo **MSOL\_**. Para otras instancias, la cuenta se puede identificar enumerando todas las cuentas dotadas de privilegios de Replicaci√≥n de Directorio en el objeto de dominio.

### El ataque completo <a href="#the-full-attack" id="the-full-attack"></a>

Rev√≠salo en la publicaci√≥n original: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
