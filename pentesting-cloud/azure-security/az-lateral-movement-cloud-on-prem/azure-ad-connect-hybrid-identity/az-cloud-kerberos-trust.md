# Az - Confiance Kerberos dans le Cloud

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Cet article est un r√©sum√© de** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **qui peut √™tre consult√© pour plus d'informations sur l'attaque. Cette technique est √©galement comment√©e dans** [**https://www.youtube.com/watch?v=AFay_58QubY**](https://www.youtube.com/watch?v=AFay_58QubY)**.**

## Informations de base

### Confiance

Lorsqu'une confiance est √©tablie avec Azure AD, un **Read Only Domain Controller (RODC) est cr√©√© dans l'AD.** Le **compte d'ordinateur RODC**, nomm√© **`AzureADKerberos$`**. Aussi, un second compte `krbtgt` nomm√© **`krbtgt_AzureAD`**. Ce compte contient les **cl√©s Kerberos** utilis√©es pour les tickets que Azure AD cr√©e.

Par cons√©quent, si ce compte est compromis, il pourrait √™tre possible d'usurper l'identit√© de n'importe quel utilisateur... bien que cela ne soit pas vrai car ce compte est emp√™ch√© de cr√©er des tickets pour tout groupe AD privil√©gi√© commun comme Domain Admins, Enterprise Admins, Administrators...

{% hint style="danger" %}
Cependant, dans un sc√©nario r√©el, il y aura des utilisateurs privil√©gi√©s qui ne sont pas dans ces groupes. Donc le **nouveau compte krbtgt, s'il est compromis, pourrait √™tre utilis√© pour les usurper.**
{% endhint %}

### Kerberos TGT

De plus, lorsqu'un utilisateur s'authentifie sur Windows en utilisant une identit√© hybride **Azure AD** √©mettra **un ticket Kerberos partiel avec le PRT.** Le TGT est partiel car **AzureAD a des informations limit√©es** sur l'utilisateur dans l'AD local (comme l'identifiant de s√©curit√© (SID) et le nom).\
Windows peut alors **√©changer ce TGT partiel contre un TGT complet** en demandant un ticket de service pour le service `krbtgt`.&#x20;

### NTLM

Comme il pourrait y avoir des services qui ne supportent pas l'authentification kerberos mais NTLM, il est possible de demander un **TGT partiel sign√© en utilisant une cl√© `krbtgt` secondaire** incluant le champ **`KERB-KEY-LIST-REQ`** dans la partie **PADATA** de la requ√™te et ensuite obtenir un TGT complet sign√© avec la cl√© `krbtgt` principale **incluant le hash NT dans la r√©ponse**.

## Abuser de la confiance Kerberos dans le Cloud pour obtenir Domain Admin <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Lorsque AzureAD g√©n√®re un **TGT partiel**, il utilisera les d√©tails qu'il a sur l'utilisateur. Par cons√©quent, si un Global Admin pouvait modifier des donn√©es comme l'**identifiant de s√©curit√© et le nom de l'utilisateur dans AzureAD**, lors de la demande d'un TGT pour cet utilisateur, l'**identifiant de s√©curit√© serait diff√©rent**.

Il n'est pas possible de faire cela via Microsoft Graph ou Azure AD Graph, mais il est possible d'utiliser l'**API Active Directory Connect** utilise pour cr√©er et mettre √† jour les utilisateurs synchronis√©s, qui peut √™tre utilis√©e par les Global Admins pour **modifier le nom SAM et le SID de tout utilisateur hybride**, et ensuite si nous nous authentifions, nous obtenons un TGT partiel contenant le SID modifi√©.

Notez que nous pouvons faire cela avec AADInternals et mettre √† jour les utilisateurs synchronis√©s via l'applet de commande [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a).

### Pr√©requis de l'attaque <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Pour que l'attaque r√©ussisse et nous donne des privil√®ges de Domain Admin, nous avons quelques exigences :

* **Privil√®ges pour modifier les comptes via l'API de Synchronisation**. Un compte Global Admin ou AD Connect sync fonctionnerait dans ce cas. Le r√¥le Hybrid Identity Administrator fournirait √©galement les permissions n√©cessaires, puisque cela peut g√©rer AD Connect et cr√©er de nouveaux comptes de synchronisation.
* Au moins un **compte hybride** que nous pouvons **modifier avec les informations du compte victime et √©galement nous authentifier**.
* **Un compte victime** √† cibler dans Active Directory. Bien que nous puissions utiliser cette attaque sur n'importe quel compte d√©j√† synchronis√© sans avoir besoin de modifier leurs attributs, nous **ne pouvons pas avoir de doublons d'identifiants de s√©curit√© locaux dans notre locataire Azure AD**, donc pour modifier un compte et obtenir le ticket, nous devons **avoir un compte qui n'est pas synchronis√©**.
* De plus, ce compte doit avoir des privil√®ges √©quivalents √† ceux d'un admin de domaine, **sans √™tre dans aucun groupe d'administrateurs AD commun** car alors le RODC de AzureAD ne pourra pas g√©n√©rer de TGTs valides.
* La victime id√©ale pour cette attaque est en fait le **compte Active Directory utilis√© par le service de synchronisation AD Connect**. Ce compte n'est pas synchronis√© avec Azure AD, donc son SID est disponible pour √™tre cibl√©, et il a des privil√®ges √©quivalents √† ceux d'un admin de domaine en raison de sa capacit√© √† **synchroniser les hachages de mots de passe** (en supposant que la synchronisation de hachage de mot de passe est utilis√©e). Si le domaine utilise l'installation express, son nom commencera par **MSOL\_**. S'il a un nom diff√©rent, vous devriez √™tre capable de le trouver en listant tous les comptes qui ont des privil√®ges de r√©plication d'annuaire sur l'objet de domaine.

### L'attaque compl√®te <a href="#the-full-attack" id="the-full-attack"></a>

* **Compte Global Admin `dirkjan@iminyour.cloud`**
* **Compte hybride** que nous pouvons modifier pour r√©aliser l'attaque `hybrid@hybrid.iminyour.cloud`. Dans ce cas, nous connaissons le mot de passe du compte hybride, ce qui est tout ce dont nous avons besoin pour obtenir un **PRT** pour le compte.&#x20;
* **Compte victime** sera **`MSOL_9c3bf742d8e9`** avec l'identifiant de s√©curit√© `S-1-5-21-1414223725-1888795230-1473887622-1104`.

La premi√®re √©tape consiste √† obtenir un **jeton d'acc√®s pour le Global Admin**. Le service de synchronisation utilise le m√™me ID de ressource que l'API Azure AD Graph, donc nous pouvons utiliser **`roadtx`** pour obtenir un jeton pour notre compte admin. Nous pouvons faire cela en utilisant la commande **`gettokens`** si nous n'avons pas besoin de MFA, ou utiliser `interactiveauth` pour avoir une fen√™tre interactive qui prend en charge MFA √©galement. Dans mon exemple, mes identifiants sont stock√©s dans une base de donn√©es KeePass donc j'utilise la commande `keepassauth` :

<figure><img src="../../../../.gitbook/assets/image (118).png" alt=""><figcaption></figcaption></figure>

Ensuite, nous pouvons **modifier l'identit√© `hybrid@hybrid.iminyour.cloud`** avec le script `modifyuser.py` de **`roadtools_hybrid`**. Un param√®tre important ici est le **`SourceAnchor`**, puisque cela est utilis√© pour associer l'utilisateur avec le compte Azure AD. Dans le portail, cela s'appelle l'"ID immuable local" et dans ROADrecon, vous pouvez trouver cela comme l'attribut `immutableId` sur l'objet utilisateur. Nous pouvons √©galement utiliser un `SourceAnchor` non existant pour cr√©er un nouvel utilisateur, cela introduit juste une √©tape suppl√©mentaire pour ajouter un mot de passe au compte. Nous fournissons √©galement le nom SAM cible et le SID souhait√© √† l'outil, qui changera ces √©l√©ments sur l'objet utilisateur `hybrid@hybrid.iminyour.cloud` :

<figure><img src="../../../../.gitbook/assets/image (119).png" alt=""><figcaption></figcaption></figure>

Maintenant, le compte est modifi√© et nous pouvons **demander un PRT pour cet utilisateur**, incluant le **TGT partiel**. Il est pr√©f√©rable d'**attendre une minute** pour s'assurer que notre changement est synchronis√© correctement, mais g√©n√©ralement cela est assez rapide :

<figure><img src="../../../../.gitbook/assets/image (122).png" alt=""><figcaption></figcaption></figure>

Avec le TGT partiel, nous pouvons demander le TGT complet et r√©cup√©rer le hash NT, cette fois pour le compte MSOL :

<figure><img src="../../../../.gitbook/assets/image (123).png" alt=""><figcaption></figcaption></figure>

Avec le **TGT complet** (ou le hash NT), nous pouvons parler au Contr√¥leur de Domaine et **r√©aliser une attaque DCSync**, synchronisant tous les hachages, y compris le hachage du compte KRBTGT complet, ce qui nous permet de forger nos propres TGTs, √©levant essentiellement notre acc√®s √† Domain Admin complet.

<figure><img src="../../../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

Comme derni√®re √©tape, il est conseill√© de changer le compte √† son nom SAM et SID d'origine en utilisant `modifyuser.py`, ou de supprimer le compte si nous en avons cr√©√© un nouveau. Cette √©tape est facultative, car d'apr√®s ce que j'ai vu, Azure AD connect d√©tectera le changement et inversera automatiquement le changement.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
