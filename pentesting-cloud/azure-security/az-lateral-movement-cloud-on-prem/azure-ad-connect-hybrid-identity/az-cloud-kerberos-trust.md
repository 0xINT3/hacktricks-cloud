# Az - クラウドKerberosトラスト

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
- **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

**この投稿は** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **の要約であり、攻撃に関する詳細情報はそちらを参照してください。この技術は** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)**でも説明されています。**

## 基本情報

### 信頼

Azure ADとの信頼が確立されると、ADに**読み取り専用ドメインコントローラー（RODC）**が作成されます。**RODCコンピューターアカウント**は**`AzureADKerberos$`**という名前です。また、2次の`krbtgt`アカウントは**`krbtgt_AzureAD`**という名前です。このアカウントには、Azure ADが作成するチケットに使用される**Kerberosキー**が含まれています。

したがって、このアカウントが侵害されると、任意のユーザーをなりすますことが可能になります... ただし、このアカウントはドメイン管理者、エンタープライズ管理者、管理者などの一般的な特権を持つADグループのためのチケットを作成することができないようになっています...

{% hint style="danger" %}
ただし、実際のシナリオでは、これらのグループに属さない特権ユーザーが存在する可能性があります。そのため、**新しいkrbtgtアカウントが侵害された場合、それを使用して彼らをなりすますことができます。**
{% endhint %}

### Kerberos TGT

さらに、ハイブリッドアイデンティティを使用してWindowsでユーザーが認証すると、**Azure AD**は**部分的なKerberosチケットとPRT**を発行します。TGTは部分的であり、**AzureADはオンプレミスADのユーザーに関する情報が制限されている**ためです（セキュリティ識別子（SID）や名前など）。
Windowsは、`krbtgt`サービスのためのサービスチケットを要求することで、この部分的なTGTを完全なTGTに**交換**できます。

### NTLM

kerberos認証をサポートしていないサービスがあるため、**PADATA**の**`KERB-KEY-LIST-REQ`**フィールドを含む**2次`krbtgt`**キーで署名された**部分的なTGT**を要求し、応答で**NTハッシュを含む主要な`krbtgt`**キーで署名された**完全なTGT**を取得することが可能です。

## クラウドKerberosトラストの悪用によるドメイン管理者の取得 <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureADが**部分的なTGT**を生成するとき、ユーザーに関する持っている詳細を使用します。したがって、グローバル管理者がAzureADの**ユーザーのセキュリティ識別子や名前などのデータを変更**できる場合、そのユーザーのTGTを要求するとき、**セキュリティ識別子が異なる**ものになります。

これはMicrosoft GraphやAzure AD Graphを介して行うことはできませんが、グローバル管理者が使用できる**API Active Directory Connect**を使用して、ハイブリッドユーザーの**SAM名とSIDを変更**することが可能です。その後、認証すると、変更されたSIDを含む部分的なTGTが得られます。

AADInternalsを使用してこれを行い、[Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a)コマンドレットを使用して同期されたユーザーを更新できます。

### 攻撃の前提条件 <a href="#attack-prerequisites" id="attack-prerequisites"></a>

攻撃の成功とドメイン管理者権限の獲得には、特定の前提条件を満たす必要があります：

- 同期APIを介してアカウントを変更できる能力が重要です。これはグローバル管理者の役割を持っているか、AD Connect同期アカウントを所有していることで達成できます。ハイブリッドアイデンティティ管理者の役割も適しており、AD Connectを管理し新しい同期アカウントを確立する権限を与えています。
- **ハイブリッドアカウント**が必要です。このアカウントは、被害者アカウントの詳細を変更でき、認証も可能である必要があります。
- Active Directory内の**ターゲット被害者アカウント**を特定する必要があります。攻撃はすでに同期されているアカウントに対して実行できますが、Azure ADテナントはオンプレミスのセキュリティ識別子を複製していない必要があり、同期されていないアカウントを変更してチケットを取得する必要があります。
- さらに、このアカウントはドメイン管理者と同等の特権を持っている必要がありますが、一般的なAD管理者グループのメンバーではない必要があります。これにより、AzureAD RODCによる無効なTGTの生成が回避されます。
- 最適なターゲットは、**AD Connect Syncサービスで使用されるActive Directoryアカウント**です。このアカウントはAzure ADと同期されていないため、そのSIDが攻撃対象となり、パスワードハッシュの同期に関与する役割を持つため、そのアカウントは本質的にドメイン管理者と同等の特権を持っています（パスワードハッシュ同期が有効であると仮定）。expressインストールのドメインの場合、このアカウントは**MSOL\_**で始まります。他のインスタンスの場合、ドメインオブジェクトにディレクトリレプリケーション特権を持つすべてのアカウントを列挙することで、アカウントを特定できます。

### 完全な攻撃 <a href="#the-full-attack" id="the-full-attack"></a>

元の投稿で確認してください：[https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)
