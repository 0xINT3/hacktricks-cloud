# Az - Cloud Kerberos Trust

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**のGitHubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

**この投稿は** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **の要約であり、攻撃に関する詳細情報はこちらで確認できます。**

## 基本情報

### 信頼

Azure ADとの信頼が確立されると、**ADにRead Only Domain Controller (RODC)が作成されます。** **RODCコンピュータアカウント**は**`AzureADKerberos$`**と名付けられます。また、**`krbtgt_AzureAD`**という名前の二次`krbtgt`アカウントもあります。このアカウントには、Azure ADが作成するチケットに使用される**Kerberosキー**が含まれています。

したがって、このアカウントが侵害された場合、任意のユーザーになりすますことが可能になります...ただし、このアカウントは、Domain Admins、Enterprise Admins、Administratorsなどの一般的な特権ADグループのチケットを作成することができないため、これは真実ではありません...

{% hint style="danger" %}
しかし、実際のシナリオでは、これらのグループに属していない特権ユーザーが存在します。したがって、**侵害された新しいkrbtgtアカウントは、これらのユーザーになりすますために使用できます。**
{% endhint %}

### Kerberos TGT

さらに、ハイブリッドIDを使用してWindowsでユーザーが認証すると、**Azure AD**は**PRTと共に部分的なKerberosチケットを発行します。** TGTは部分的なものです。なぜなら、**AzureADはオンプレミスADのユーザーに関する限られた情報**（セキュリティ識別子（SID）や名前など）しか持っていないからです。\
Windowsは、この部分的なTGTを`krbtgt`サービスのサービスチケットを要求することで、完全なTGTと**交換することができます。**

### NTLM

Kerberos認証をサポートしていないがNTLMをサポートするサービスがある場合、**二次`krbtgt`**キーを使用して署名された**部分的なTGTを要求することができます。これは、要求の**PADATA**部分に**`KERB-KEY-LIST-REQ`**フィールドを含めることで行います。そして、応答にNTハッシュを含めることで、主要な`krbtgt`キーで署名された完全なTGTを取得することができます。

## Cloud Kerberos Trustを悪用してDomain Adminを取得する <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

AzureADが**部分的なTGT**を生成するとき、それはユーザーに関する詳細を使用します。したがって、Global AdminがAzureAD内のユーザーの**セキュリティ識別子や名前などのデータを変更できる**場合、そのユーザーのTGTを要求すると、**セキュリティ識別子が異なるものになります。**

これはMicrosoft GraphやAzure AD Graphを通じて行うことはできませんが、**API Active Directory Connect**を使用して同期されたユーザーを作成および更新することができます。これはGlobal Adminsによって使用され、**任意のハイブリッドユーザーのSAM名とSIDを変更することができます。**そして、認証すると、変更されたSIDを含む部分的なTGTを取得します。

この操作はAADInternalsを使用して行い、[Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a)コマンドレットを使用して同期されたユーザーを更新します。

### 攻撃の前提条件 <a href="#attack-prerequisites" id="attack-prerequisites"></a>

攻撃が成功し、Domain Admin権限を与えるためには、いくつかの要件があります:

* **Synchronization APIを介してアカウントを変更する権限**。この場合、Global AdminまたはAD Connect同期アカウントが機能します。Hybrid Identity Administratorの役割も必要な権限を提供します。なぜなら、これはAD Connectを管理し、新しい同期アカウントを作成することができるからです。
* 少なくとも1つの**ハイブリッドアカウント**があり、**被害者アカウントの情報を変更して認証することができます**。
* Active Directoryでターゲットにする**被害者アカウント**。既に同期されたアカウントにこの攻撃を使用することはできますが、属性を変更する必要はありませんが、Azure ADテナント内にオンプレミスのセキュリティ識別子の重複を持つことはできません。したがって、アカウントを変更してチケットを取得するには、**同期されていないアカウントが必要です**。
* さらに、このアカウントは、AzureADのRODCが有効なTGTを生成できないような一般的なAD管理者グループには属していないが、ドメイン管理者に相当する権限を持っている必要があります。
* この攻撃の理想的な被害者は、実際にはAD Connect Syncサービスによって使用される**Active Directoryアカウント**です。このアカウントはAzure ADに同期されていないため、そのSIDはターゲットにするために利用可能であり、パスワードハッシュの同期が使用されていると仮定すると、ハッシュを同期する能力のためにドメイン管理者に相当する権限を持っています。ドメインがエクスプレスインストールを使用している場合、その名前は**MSOL\_**で始まります。異なる名前を持っている場合は、ドメインオブジェクトにディレクトリレプリケーション権限を持つすべてのアカウントをリストアップすることでこれを見つけることができるはずです。

### 攻撃の全体像 <a href="#the-full-attack" id="the-full-attack"></a>

* **Global Adminアカウント `dirkjan@iminyour.cloud`**
* 攻撃を実行するために変更できる**ハイブリッドアカウント** `hybrid@hybrid.iminyour.cloud`。この場合、ハイブリッドアカウントのパスワードを知っているので、アカウントの**PRT**を取得するだけで十分です。
* **被害者アカウント**は**`MSOL_9c3bf742d8e9`**で、セキュリティ識別子は`S-1-5-21-1414223725-1888795230-1473887622-1104`です。

最初のステップは、Global Adminの**アクセストークンを取得する**ことです。同期サービスはAzure AD Graph APIと同じリソースIDを使用するので、adminアカウントのために**`roadtx`**を使用してトークンを取得することができます。MFAが不要な場合は**`gettokens`**コマンドを使用できますし、MFAをサポートする対話型ウィンドウが必要な場合は`interactiveauth`を使用できます。私の例では、資格情報はKeePassデータベースに保存されているので、`keepassauth`コマンドを使用します：

<figure><img src="../../../../.gitbook/assets/image (118).png" alt=""><figcaption></figcaption></figure>

次に、`modifyuser.py`スクリプトを使用して**`hybrid@hybrid.iminyour.cloud`アイデンティティを変更**できます。ここで重要なパラメータは**`SourceAnchor`**です。これは、ユーザーをAzure ADアカウントと照合するために使用されます。ポータルでは、これは「オンプレミスの不変ID」と呼ばれ、ROADreconではユーザーオブジェクトの`immutableId`属性として見つけることができます。存在しない`SourceAnchor`を使用して新しいユーザーを作成することもできますが、これはアカウントにパスワードを追加するための追加ステップを導入するだけです。また、目的のSAM名と希望するSIDをツールに**供給し**、これらを`hybrid@hybrid.iminyour.cloud`ユーザーオブジェクトで変更します：

<figure><img src="../../../../.gitbook/assets/image (119).png" alt=""><figcaption></figcaption></figure>

これでアカウントが変更され、**このユーザーのPRTを要求することができます**。これには**部分的なTGT**が含まれています。変更が適切に同期されることを確認するために**1分待つ**のが最善ですが、通常は非常に速いです：

<figure><img src="../../../../.gitbook/assets/image (122).png" alt=""><figcaption></figcaption></figure>

部分的なTGTを使用して、完全なTGTを要求し、今回はMSOLアカウントのNTハッシュを回復することができます：

<figure><img src="../../../../.gitbook/assets/image (123).png" alt=""><figcaption></figcaption></figure>

**完全なTGT**（またはNTハッシュ）を使用して、ドメインコントローラーにアクセスし、**DCSync攻撃を実行し**、完全なKRBTGTアカウントのハッシュを含むすべてのハッシュを同期し、本質的に私たちのアクセスを完全なドメイン管理者に昇格させることができます。

<figure><img src="../../../../.gitbook/assets/image (124).png" alt=""><figcaption></figcaption></figure>

最後のステップとして、`modifyuser.py`を使用してアカウントを元のSAM名とSIDに戻すか、新しいものを作成した場合はアカウントを削除することをお勧めします。このステップはオプションですが、私が見たところではAzure AD connectが変更を検出し、自動的に変更を元に戻すようです。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**のGitHubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
