# Az - Cloud Kerberos Trust

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

**Dieser Beitrag ist eine Zusammenfassung von** [**https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/**](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/) **, der weitere Informationen zum Angriff enth√§lt. Diese Technik wird auch in** [**https://www.youtube.com/watch?v=AFay\_58QubY**](https://www.youtube.com/watch?v=AFay\_58QubY)** kommentiert.**

## Grundlegende Informationen

### Vertrauen

Wenn ein Vertrauensverh√§ltnis mit Azure AD hergestellt wird, wird ein **Read Only Domain Controller (RODC)** im AD erstellt. Das **RODC-Computerkonto** wird **`AzureADKerberos$`** genannt. Au√üerdem wird ein sekund√§res `krbtgt`-Konto namens **`krbtgt_AzureAD`** erstellt. Dieses Konto enth√§lt die **Kerberos-Schl√ºssel**, die f√ºr Tickets verwendet werden, die von Azure AD erstellt werden.

Daher k√∂nnte es m√∂glich sein, jeden Benutzer zu imitieren, wenn dieses Konto kompromittiert ist... obwohl dies nicht stimmt, da dieses Konto daran gehindert wird, Tickets f√ºr g√§ngige privilegierte AD-Gruppen wie Dom√§nenadministratoren, Unternehmensadministratoren, Administratoren usw. zu erstellen...

{% hint style="danger" %}
In einem realen Szenario wird es jedoch privilegierte Benutzer geben, die nicht in diesen Gruppen sind. Daher k√∂nnte das **neue krbtgt-Konto, wenn kompromittiert, verwendet werden, um sie zu imitieren.**
{% endhint %}

### Kerberos TGT

Dar√ºber hinaus wird bei der Authentifizierung eines Benutzers unter Windows mit einer hybriden Identit√§t **Azure AD** ein **teilweises Kerberos-Ticket zusammen mit dem PRT ausstellen**. Das TGT ist teilweise, weil **AzureAD begrenzte Informationen** √ºber den Benutzer im lokalen AD hat (wie die Sicherheitskennung (SID) und den Namen).\
Windows kann dann dieses teilweise TGT gegen ein vollst√§ndiges TGT austauschen, indem es ein Dienstticket f√ºr den `krbtgt`-Dienst anfordert.&#x20;

### NTLM

Da es Dienste geben k√∂nnte, die keine Kerberos-Authentifizierung, sondern NTLM unterst√ºtzen, ist es m√∂glich, ein **teilweises TGT zu fordern, das mit einem sekund√§ren `krbtgt`-Schl√ºssel signiert ist, einschlie√ülich des Felds `KERB-KEY-LIST-REQ` im **PADATA**-Teil der Anforderung, und dann ein vollst√§ndiges TGT zu erhalten, das mit dem prim√§ren `krbtgt`-Schl√ºssel signiert ist, **einschlie√ülich des NT-Hash im Antwort**.

## Ausnutzen des Cloud-Kerberos-Vertrauens zur Erlangung von Dom√§nenadministratorrechten <a href="#abusing-cloud-kerberos-trust-to-obtain-domain-admin" id="abusing-cloud-kerberos-trust-to-obtain-domain-admin"></a>

Wenn AzureAD ein **teilweises TGT** generiert, verwendet es die Details, die es √ºber den Benutzer hat. Daher, wenn ein Globaler Administrator Daten wie die **Sicherheitskennung und den Namen des Benutzers in AzureAD √§ndern k√∂nnte**, wenn er ein TGT f√ºr diesen Benutzer anfordert, w√§re die **Sicherheitskennung eine andere**.

Dies ist nicht √ºber das Microsoft Graph oder das Azure AD Graph m√∂glich, aber es ist m√∂glich, die **API zu verwenden, die Active Directory Connect** verwendet, um synchronisierte Benutzer zu erstellen und zu aktualisieren, was von den Globalen Administratoren verwendet werden kann, um den SAM-Namen und die SID eines beliebigen hybriden Benutzers zu **√§ndern, und dann, wenn wir uns authentifizieren, erhalten wir ein teilweises TGT, das die modifizierte SID enth√§lt**.

Beachten Sie, dass dies mit AADInternals m√∂glich ist und die Synchronisierung von Benutzern √ºber das [Set-AADIntAzureADObject](https://aadinternals.com/aadinternals/#set-aadintazureadobject-a) Cmdlet aktualisiert werden kann.

### Angriffsvoraussetzungen <a href="#attack-prerequisites" id="attack-prerequisites"></a>

Der Erfolg des Angriffs und die Erlangung von Dom√§nenadministratorrechten h√§ngen von bestimmten Voraussetzungen ab:

* Die F√§higkeit, Konten √ºber die Synchronisierungs-API zu √§ndern, ist entscheidend. Dies kann durch die Rolle des Globalen Administrators oder den Besitz eines AD Connect Sync-Kontos erreicht werden. Alternativ w√ºrde die Rolle des Hybrid Identity Administrators ausreichen, da sie die M√∂glichkeit bietet, AD Connect zu verwalten und neue Sync-Konten einzurichten.
* Das Vorhandensein eines **hybriden Kontos** ist unerl√§sslich. Dieses Konto muss f√ºr √Ñnderungen mit den Details des Opferkontos anf√§llig sein und sollte auch f√ºr die Authentifizierung zug√§nglich sein.
* Die Identifizierung eines **Ziel-Opferkontos** im Active Directory ist eine Notwendigkeit. Obwohl der Angriff auf jedes bereits synchronisierte Konto ausgef√ºhrt werden kann, darf der Azure AD-Mandant keine replizierten lokalen Sicherheitskennungen haben, was die √Ñnderung eines nicht synchronisierten Kontos zur Beschaffung des Tickets erforderlich macht.
* Dar√ºber hinaus sollte dieses Konto √ºber Dom√§nenadministrator-√§quivalente Berechtigungen verf√ºgen, darf jedoch kein Mitglied typischer AD-Administratorgruppen sein, um die Generierung ung√ºltiger TGTs durch den AzureAD RODC zu vermeiden.
* Das geeignetste Ziel ist das **Active Directory-Konto, das vom AD Connect Sync-Dienst** verwendet wird. Dieses Konto wird nicht mit Azure AD synchronisiert, sodass seine SID als m√∂gliches Ziel bleibt, und es besitzt inh√§rent Dom√§nenadministrator-√§quivalente Berechtigungen aufgrund seiner Rolle bei der Synchronisierung von Passworthashes (sofern die Passworthashsynchronisierung aktiv ist). F√ºr Dom√§nen mit Expressinstallation wird dieses Konto mit **MSOL\_** vorangestellt. In anderen F√§llen kann das Konto durch Aufz√§hlen aller Konten ermittelt werden, die mit Replikationsberechtigungen f√ºr das Dom√§nenobjekt ausgestattet sind.

### Der vollst√§ndige Angriff <a href="#the-full-attack" id="the-full-attack"></a>

√úberpr√ºfen Sie dies im Originalbeitrag: [https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/](https://dirkjanm.io/obtaining-domain-admin-from-azure-ad-via-cloud-kerberos-trust/)
