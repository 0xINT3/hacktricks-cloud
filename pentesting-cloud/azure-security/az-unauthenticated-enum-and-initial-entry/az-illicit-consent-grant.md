# Az - Concesión de Consentimiento Ilícito

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing de Aplicación OAuth

Las **aplicaciones de Azure** solicitan permisos para acceder a los **datos del usuario** (información básica, pero también acceso a documentos, envío de correos electrónicos...).\
Si se **permite**, un usuario normal solo puede otorgar consentimiento para **"Permisos de bajo impacto"**. En **todos los demás** casos, se requiere **consentimiento de administrador**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` y un rol personalizado que incluya `permiso para otorgar permisos a aplicaciones` pueden proporcionar consentimiento en todo el inquilino.

Solo los permisos que **no requieren consentimiento de administrador** se clasifican como de **bajo impacto**. Estos son los permisos necesarios para **iniciar sesión básica openid, perfil, correo electrónico, User.Read y offline\_access**. Si una **organización** **permite** el consentimiento del usuario para **todas las aplicaciones**, un empleado puede otorgar consentimiento a una aplicación para **leer lo anterior de su perfil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Por lo tanto, un atacante podría preparar una **aplicación maliciosa** y con un **phishing**, hacer que el usuario **acepte la aplicación y robe sus datos**.

### Verificar si los usuarios pueden otorgar consentimiento

Verifique si los usuarios pueden otorgar consentimiento a las aplicaciones:

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **Deshabilitar el consentimiento del usuario**: los usuarios no pueden otorgar permisos a las aplicaciones.
* **Los usuarios pueden otorgar consentimiento a aplicaciones de editores verificados o de su organización, pero solo para los permisos que seleccione**: todos los usuarios solo pueden otorgar consentimiento a aplicaciones que fueron publicadas por un editor verificado y aplicaciones que están registradas en su inquilino.
* **Los usuarios pueden otorgar consentimiento a todas las aplicaciones**: permite que todos los usuarios otorguen consentimiento a cualquier permiso que no requiera consentimiento de administrador,
* **Política de consentimiento de aplicaciones personalizada**

## **¿Qué es un Ataque de Concesión de Consentimiento Ilícito?**

En un ataque de concesión de consentimiento ilícito, el atacante crea una aplicación registrada en Azure que solicita acceso a datos como información de contacto, correo electrónico o documentos. Luego, el atacante engaña a un usuario final para que otorgue consentimiento a la aplicación para que el atacante pueda acceder a los datos a los que el usuario objetivo tiene acceso. Después de que se haya otorgado el consentimiento de la aplicación, tiene acceso a nivel de cuenta de usuario a los datos sin necesidad de una cuenta organizativa.

En palabras simples, cuando la víctima hace clic en ese hermoso botón azul de "Aceptar", Azure AD envía un token al sitio de terceros que pertenece a un atacante donde el atacante usará el token para realizar acciones en nombre de las víctimas como acceder a todos los archivos, leer correos electrónicos, enviar correos electrónicos, etc.

## **Flujo de Ataque**

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

Para realizar este ataque contra la empresa "ecorp", el atacante podría registrar un dominio con el nombre "safedomainlogin.com" y crear un subdominio ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) donde **alojó la aplicación para capturar el código de autorización** y luego solicitar los tokens de acceso.

Luego, registre una aplicación de varios inquilinos en su inquilino de Azure y nómbrela como "ecorp" y agregue la URL de redireccionamiento que apunta a "ecorp.safedomainlogin.com" que aloja una aplicación para capturar el código de autorización.

El atacante también crea un nuevo secreto de cliente y agrega algunos permisos de API como `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` en la aplicación. Para que una vez que el **usuario otorgue el consentimiento a la aplicación**, el atacante pueda **extraer la información sensible** en nombre del usuario.

Finalmente, el atacante crea el **enlace** que contenía el ID de cliente de la aplicación maliciosa y **compartió** el enlace con los **usuarios objetivo** para obtener su consentimiento.

## 365-Stealer

Puede realizar este ataque con [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

Como paso adicional, si tiene algún **acceso sobre un usuario en la organización víctima**, puede verificar si la política le permitirá **aceptar aplicaciones**:

```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Si "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", puede
```

Para este ataque, deberá crear una **nueva aplicación en su inquilino de Azure** con, por ejemplo, los siguientes permisos:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` está dentro de `Microsoft Graph` en `Delegated permissions`. (Los permisos de aplicación siempre necesitarán aprobación adicional).

* `User.ReadBasic.All` es el permiso que le permitirá **leer información de todos los usuarios** en la organización si se concede.
* Recuerde que solo `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` y un rol personalizado que incluya `permiso para otorgar permisos a aplicaciones` pueden proporcionar consentimiento en todo el inquilino. Por lo tanto, debería **phishing a un usuario con uno de esos roles** si desea que apruebe una **aplicación que requiere consentimiento de administrador**.

Consulte [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender cómo configurarlo.

{% hint style="warning" %}
Tenga en cuenta que el **token de acceso** obtenido será para el **punto final de gráficos** con los ámbitos: `User.Read` y `User.ReadBasic.All` (los permisos solicitados). No podrá realizar otras acciones (pero esos son suficientes para **descargar información sobre todos los usuarios** en la organización).
{% endhint %}

## Post-Explotación

Una vez que tenga acceso al usuario, puede hacer cosas como robar documentos sensibles e incluso cargar archivos de documentos con puerta tras