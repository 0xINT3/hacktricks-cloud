# Az - Concess√£o de Consentimento Il√≠cito

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Phishing de Aplicativo OAuth

**As Aplica√ß√µes Azure** solicitam permiss√µes para acessar os **dados do usu√°rio** (informa√ß√µes b√°sicas, mas tamb√©m acesso a documentos, envio de e-mails...).\
Se **permitido**, um usu√°rio normal pode conceder consentimento apenas para **"Permiss√µes de Baixo Impacto"**. Em **todos os outros** casos, **√© necess√°rio o consentimento do administrador**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e uma fun√ß√£o personalizada que inclui `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em n√≠vel de locat√°rio.

Somente as permiss√µes que **n√£o exigem consentimento do administrador** s√£o classificadas como **baixo impacto**. Essas s√£o as permiss√µes necess√°rias para **login b√°sico s√£o openid, profile, email, User.Read e offline\_access**. Se uma **organiza√ß√£o** **permite** o consentimento do usu√°rio para **todos os aplicativos**, um funcion√°rio pode conceder consentimento a um aplicativo para **ler o acima de seu perfil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Portanto, um atacante poderia preparar um **aplicativo malicioso** e com um **phishing**, fazer o usu√°rio **aceitar o aplicativo e roubar seus dados**.

### Verificar se os usu√°rios podem consentir

Verifique se os usu√°rios podem consentir com aplicativos:

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **Desativar o consentimento do usu√°rio**: os usu√°rios n√£o podem conceder permiss√µes a aplicativos.
* **Os usu√°rios podem consentir em aplicativos de editores verificados ou de sua organiza√ß√£o, mas apenas para as permiss√µes que voc√™ selecionar**: todos os usu√°rios s√≥ podem consentir em aplicativos publicados por um editor verificado e aplicativos registrados em seu locat√°rio.
* **Os usu√°rios podem consentir em todos os aplicativos**: permite que todos os usu√°rios concedam consentimento a qualquer permiss√£o que n√£o exija consentimento do administrador,
* **Pol√≠tica de consentimento de aplicativo personalizada**

## **O que √© o Ataque de Concess√£o de Consentimento Il√≠cito?**

Em um ataque de concess√£o de consentimento il√≠cito, o atacante cria um **aplicativo registrado no Azure que solicita acesso a dados, como informa√ß√µes de contato, e-mail ou documentos**. O atacante ent√£o engana um usu√°rio final a conceder consentimento ao aplicativo para que o atacante possa acessar os dados aos quais o usu√°rio-alvo tem acesso. Depois que o aplicativo recebeu o consentimento, ele tem acesso ao n√≠vel da conta do usu√°rio aos dados sem a necessidade de uma conta organizacional.

Em palavras simples, quando a v√≠tima clica no belo bot√£o azul de "Aceitar", o Azure AD envia um token para o site de terceiros que pertence a um atacante, onde o atacante usar√° o token para realizar a√ß√µes em nome das v√≠timas, como acessar todos os arquivos, ler e-mails, enviar e-mails etc.

## **Fluxo de Ataque**

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

Para realizar este ataque contra a empresa "ecorp", o atacante poderia registrar um dom√≠nio com o nome "safedomainlogin.com" e criar um subdom√≠nio ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) onde eles **hospedaram o aplicativo para capturar o c√≥digo de autoriza√ß√£o** e, em seguida, solicitar os tokens de acesso.

Em seguida, registre um aplicativo de v√°rios locat√°rios em seu locat√°rio Azure AD e nomeie-o como "ecorp" e adicione o URL de redirecionamento que aponta para o "ecorp.safedomainlogin.com" que hospeda um aplicativo para capturar o c√≥digo de autoriza√ß√£o.

O atacante tamb√©m cria um novo segredo do cliente e adiciona algumas **permiss√µes** de API, como `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` no aplicativo. Para que, uma vez que o **usu√°rio conceda o consentimento ao aplicativo**, o atacante possa **extrair** as **informa√ß√µes sens√≠veis** em nome do usu√°rio.

O atacante finalmente cria o **link** que cont√©m o ID do cliente do aplicativo malicioso e **compartilha** o link com os **usu√°rios-alvo** para obter seu consentimento.

## 365-Stealer

Voc√™ pode realizar este ataque com [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

Como etapa extra, se voc√™ tiver algum **acesso sobre um usu√°rio na organiza√ß√£o da v√≠tima**, poder√° verificar se a pol√≠tica permitir√° que ele **aceite aplicativos**:

```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Se "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", ele pode
```

Para este ataque, voc√™ precisar√° criar um **novo aplicativo em seu locat√°rio Azure** (em registros de aplicativos) com, por exemplo, as seguintes permiss√µes:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` est√° dentro de `Microsoft Graph` em `Permiss√µes delegadas`. (As permiss√µes do aplicativo sempre precisar√£o de aprova√ß√£o extra).

* `User.ReadBasic.All` √© a permiss√£o que permitir√° que voc√™ **leia informa√ß√µes de todos os usu√°rios** na organiza√ß√£o se concedido.
* Lembre-se de que apenas `GA`, `ApplicationAdministrator