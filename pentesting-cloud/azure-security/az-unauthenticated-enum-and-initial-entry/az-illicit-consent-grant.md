# Az - Consentement Illicite

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

## Phishing d'application OAuth

Les **Applications Azure** demandent des autorisations pour acc√©der aux **donn√©es utilisateur** (informations de base, mais aussi acc√®s aux documents, envoi d'e-mails...).\
Si **autoris√©**, un utilisateur normal peut donner son consentement uniquement pour les **"Autorisations √† faible impact"**. Dans **tous les autres** cas, **le consentement de l'administrateur est requis**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` et un r√¥le personnalis√© incluant `l'autorisation d'accorder des autorisations aux applications` peuvent fournir un consentement √† l'√©chelle du locataire.

Seules les autorisations qui **ne n√©cessitent pas de consentement de l'administrateur** sont class√©es comme **√† faible impact**. Il s'agit des autorisations requises pour **la connexion de base sont openid, profile, email, User.Read et offline\_access**. Si une **organisation** **autorise** le consentement de l'utilisateur pour **toutes les applications**, un employ√© peut donner son consentement √† une application pour **lire les √©l√©ments ci-dessus de son profil**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Par cons√©quent, un attaquant pourrait pr√©parer une **application malveillante** et, avec un **phishing**, faire accepter l'application √† l'utilisateur et voler ses donn√©es.

### V√©rifier si les utilisateurs sont autoris√©s √† donner leur consentement

V√©rifiez si les utilisateurs sont autoris√©s √† donner leur consentement aux applications :

{% code overflow="wrap" %}
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
{% endcode %}

* **D√©sactiver le consentement de l'utilisateur** : Les utilisateurs ne peuvent pas accorder d'autorisations aux applications.
* **Les utilisateurs peuvent donner leur consentement aux applications des √©diteurs v√©rifi√©s ou de votre organisation, mais uniquement pour les autorisations que vous s√©lectionnez** : Tous les utilisateurs ne peuvent donner leur consentement qu'aux applications publi√©es par un √©diteur v√©rifi√© et aux applications enregistr√©es dans votre locataire.
* **Les utilisateurs peuvent donner leur consentement √† toutes les applications** : permet √† tous les utilisateurs de donner leur consentement √† toute autorisation qui ne n√©cessite pas de consentement de l'administrateur,
* **Politique de consentement d'application personnalis√©e**

## **Qu'est-ce qu'une attaque de consentement illicite ?**

Dans une attaque de consentement illicite, l'attaquant cr√©e une **application enregistr√©e Azure qui demande l'acc√®s √† des donn√©es telles que les informations de contact, l'e-mail ou les documents**. L'attaquant trompe ensuite un utilisateur final en lui accordant son consentement pour l'application afin que l'attaquant puisse acc√©der aux donn√©es auxquelles l'utilisateur cible a acc√®s. Apr√®s que l'application ait √©t√© autoris√©e, elle a un acc√®s de niveau de compte utilisateur aux donn√©es sans avoir besoin d'un compte organisationnel.

En termes simples, lorsque la victime clique sur ce beau bouton bleu "Accepter", Azure AD envoie un jeton au site tiers qui appartient √† un attaquant o√π l'attaquant utilisera le jeton pour effectuer des actions au nom des victimes comme acc√©der √† tous les fichiers, lire les e-mails, envoyer des e-mails, etc.

## **D√©roulement de l'attaque**

<figure><img src="../../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

Pour effectuer cette attaque contre l'entreprise "ecorp", l'attaquant pourrait enregistrer un domaine avec le nom "safedomainlogin.com" et cr√©er un sous-domaine ["ecorp.safedomainlogin.com"](http://ecorp.safedomainlogin.com/) o√π ils **ont h√©berg√© l'application pour capturer le code d'autorisation** et demander ensuite les jetons d'acc√®s.

Ensuite, enregistrez une application multi-locataire dans leur locataire Azure AD et nommez-la "ecorp" et ajoutez l'URL de redirection qui pointe vers "ecorp.safedomainlogin.com" qui h√©berge une application pour capturer le code d'autorisation.

L'attaquant cr√©e √©galement un nouveau secret client et ajoute quelques **autorisations d'API** telles que `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` dans l'application. Ainsi, une fois que l'utilisateur a donn√© son consentement √† l'application, l'attaquant peut **extraire** les **informations sensibles** au nom de l'utilisateur.

L'attaquant cr√©e enfin le **lien** qui contient l'ID client de l'application malveillante et **partage** le lien avec les **utilisateurs cibl√©s** pour obtenir leur consentement.

## 365-Stealer

Vous pouvez effectuer cette attaque avec [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

En √©tape suppl√©mentaire, si vous avez un **acc√®s sur un utilisateur dans l'organisation victime**, vous pouvez v√©rifier si la politique lui permettra de **donner son consentement aux applications** :

```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# S'il y a "ManagePermissionGrantsForSelf.microsoft-user-default-legacy", il peut
```

Pour cette attaque, vous devrez cr√©er une **nouvelle application dans votre locataire Azure** (dans les inscriptions d'applications) avec, par exemple, les autorisations suivantes :

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` est dans `Microsoft Graph` dans `De