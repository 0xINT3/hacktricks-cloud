# Az - 未经身份验证的枚举和初始入口

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Azure租户

### 租户枚举

有一些**公共Azure API**，只要知道攻击者可以查询的**租户域**，就可以查询更多关于它的信息。\
您可以直接查询API，或使用PowerShell库[**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | 信息                                                                                                                                                                                                                                           | AADInternals函数                             |
| -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **登录信息**，包括租户ID                                                                                                                                                                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | 租户的**所有域**                                                                                                                                                                                                                               | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>租户的登录信息</strong>，包括租户名称和域名<strong>身份验证类型。</strong><br>如果<code>NameSpaceType</code>是<strong><code>Managed</code></strong>，则表示使用<strong>AzureAD</strong>。</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | 登录信息，包括**桌面SSO信息**                                                                                                                                                                                                                 | `Get-AADIntLoginInformation -UserName <UserName>` |

您可以使用[**AADInternals**](https://github.com/Gerenios) **库的一个命令查询Azure租户的所有信息**：
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure租户信息的输出示例：
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
可以观察到租户的名称、ID和“品牌”名称的详细信息。此外，还显示了桌面单点登录（SSO）的状态，也称为[**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)。启用此功能有助于确定目标组织中特定用户的存在（枚举）。

此外，输出显示了与目标租户关联的所有经过验证的域的名称，以及它们各自的身份类型。对于联合域，通常会披露正在使用的身份提供者的完全限定域名（FQDN），通常是一个 ADFS 服务器。"MX" 列指定电子邮件是否路由到 Exchange Online，而 "SPF" 列表示 Exchange Online 作为电子邮件发件人的列表。值得注意的是，当前的侦察功能不解析 SPF 记录中的 "include" 语句，这可能导致误报。

### 用户枚举

可以**检查用户名是否存在**在租户内。这也包括**访客用户**，其用户名格式为：
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
邮箱是用户的电子邮件地址，在“@”处用下划线“\_”替换。

使用[**AADInternals**](https://github.com/Gerenios/AADInternals)，您可以轻松地检查用户是否存在：
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## 未经身份验证的枚举和初始入口

在进行云安全渗透测试时，未经身份验证的枚举和初始入口是一个重要的步骤。通过识别目标系统中可能存在的漏洞和弱点，黑客可以利用这些信息来获取未经授权访问权限。以下是一些常见的技术和方法，可用于执行未经身份验证的枚举和获取初始入口：

### 未经身份验证的枚举

- **服务发现**：使用工具和技术来识别目标系统上运行的服务和应用程序。
- **敏感文件和目录扫描**：扫描系统以查找可能包含敏感信息的文件和目录。
- **默认凭证**：尝试使用常见的默认凭证来访问系统，例如admin/admin、root/root等。
- **公开信息收集**：搜索互联网和公开来源，查找与目标系统相关的信息。

### 初始入口

- **弱密码攻击**：使用暴力破解或密码字典攻击来破解弱密码。
- **社会工程学**：通过欺骗用户或员工来获取访问权限，例如钓鱼攻击。
- **漏洞利用**：利用已知的漏洞来获取系统访问权限。
- **后门安装**：在系统中安装后门，以便在未来访问系统。

在执行未经身份验证的枚举和获取初始入口时，黑客需要谨慎行事，以避免被检测到并触发安全警报。
```
UserName         Exists
--------         ------
user@company.com True
```
您还可以使用一个每行包含一个电子邮件地址的文本文件：
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
有**三种不同的枚举方法**可供选择：

| 方法       | 描述                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 正常       | 这是指上面提到的GetCredentialType API。默认方法。                                                                                                                           |
| 登录       | <p>此方法尝试以用户身份登录。<br><strong>注意：</strong>查询将记录在登录日志中。</p>                                                                                       |
| 自动登录    | <p>此方法尝试通过自动登录端点以用户身份登录。<br><strong>查询不会</strong>记录在登录日志中！因此，也适用于密码喷洒和暴力攻击。</p> |

发现有效用户名后，您可以使用以下方式获取**有关用户的信息**：
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
脚本 [**o365creeper**](https://github.com/LMGsec/o365creeper) 也允许您发现**电子邮件是否有效**。
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure 服务

现在我们知道 Azure 租户正在使用的**域**，是时候尝试找到**暴露的 Azure 服务**了。

您可以使用[**MicroBust**](https://github.com/NetSPI/MicroBurst)中的一种方法来实现这个目标。此功能将在几个**Azure 服务域**中搜索基本域名（以及一些排列组合）。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## 开放存储

您可以使用诸如[**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1)之类的工具，该工具将使用文件**`Microburst/Misc/permitations.txt`**生成排列组合（非常简单），以尝试**查找开放的存储账户**。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

一个**共享访问签名**（SAS）URL是一个URL，**提供对存储账户的某个部分的访问权限**（可以是完整的容器、一个文件...），具有一些特定的权限（读取、写入...）来访问资源。如果发现泄露了一个这样的URL，你可能能够访问到敏感信息，它们看起来像这样（这是用于访问一个容器的，如果只是授予对文件的访问权限，URL的路径也将包含该文件）：

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

使用[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)来访问数据

## 危害凭证

### 钓鱼

* [**常见钓鱼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（凭证或OAuth应用 -[非法同意授予攻击](az-illicit-consent-grant.md)-）
* [**设备代码认证** 钓鱼](az-device-code-authentication-phishing.md)

### 密码喷洒 / 暴力破解

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## 参考资料

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
