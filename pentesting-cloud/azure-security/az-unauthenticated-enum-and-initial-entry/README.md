# Az - Nieuwierzytelniona enumeracja i początkowe wejście

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Azure Tenant

### Enumeracja tenantów

Istnieją niektóre **publiczne interfejsy API Azure**, które, znając **domenę tenantów**, atakujący może zapytać, aby uzyskać więcej informacji na ich temat.\
Możesz zapytać bezpośrednio API lub użyć biblioteki PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informacje                                                                                                                                                                                                                                           | Funkcja AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informacje o logowaniu**, w tym identyfikator tenantów                                                                                                                                                                                              | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Wszystkie domeny** tenantów                                                                                                                                                                                                                        | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informacje o logowaniu</strong> tenantów, w tym nazwa tenantów i domena <strong>typu uwierzytelniania.</strong><br>Jeśli <code>NameSpaceType</code> to <strong><code>Managed</code></strong>, oznacza to, że używane jest <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informacje o logowaniu, w tym **informacje o jednokrotnym logowaniu na pulpicie**                                                                                                                                                                       | `Get-AADIntLoginInformation -UserName <UserName>` |

Możesz zapytać o wszystkie informacje dotyczące tenantów Azure za pomocą **tylko jednej komendy z biblioteki** [**AADInternals**](https://github.com/Gerenios/AADInternals):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Przykładowy wynik informacji o Azure tenant:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Jest możliwe obserwowanie szczegółów dotyczących nazwy, identyfikatora i nazwy "marki" najemcy. Dodatkowo wyświetlany jest status jednokrotnego logowania do pulpitu (SSO), znany również jako [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Po włączeniu tej funkcji ułatwia to określenie obecności (enumeracji) określonego użytkownika w organizacji docelowej.

Ponadto, wynik prezentuje nazwy wszystkich zweryfikowanych domen powiązanych z docelowym najemcą, wraz z ich odpowiednimi typami tożsamości. W przypadku domen federacyjnych ujawniany jest również pełny nazwa domeny (FQDN) dostawcy tożsamości, zwykle serwera ADFS. Kolumna "MX" określa, czy e-maile są kierowane do Exchange Online, natomiast kolumna "SPF" oznacza umieszczenie Exchange Online jako nadawcy e-maili. Ważne jest zauważenie, że bieżąca funkcja rozpoznawania nie analizuje instrukcji "include" w rekordach SPF, co może prowadzić do fałszywych negatywów.

### Enumeracja użytkowników

Jest możliwe **sprawdzenie, czy nazwa użytkownika istnieje** wewnątrz najemcy. Dotyczy to również **użytkowników gości**, których nazwa użytkownika ma format:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Adres e-mail to adres e-mail użytkownika, w którym znak "@" jest zastąpiony podkreślnikiem "\_".

Z [**AADInternals**](https://github.com/Gerenios/AADInternals) można łatwo sprawdzić, czy użytkownik istnieje czy nie:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Enumeracja i początkowe wejście do Azure (brak uwierzytelnienia)

Ten dokument opisuje techniki i narzędzia, które można wykorzystać do przeprowadzenia testów penetracyjnych w chmurze Azure bez uwierzytelnienia.

## 1. Enumeracja

### 1.1. Enumeracja subskrypcji

Aby zebrać informacje o subskrypcji, wykonaj następujące kroki:

1. Użyj narzędzia `az account show` lub `az account list` w celu uzyskania informacji o bieżącej subskrypcji.
2. Użyj narzędzia `az account list-locations` w celu uzyskania listy dostępnych lokalizacji.
3. Użyj narzędzia `az account list-offers` w celu uzyskania listy dostępnych ofert.

### 1.2. Enumeracja grup zasobów

Aby zebrać informacje o grupach zasobów, wykonaj następujące kroki:

1. Użyj narzędzia `az group list` w celu uzyskania listy grup zasobów.
2. Użyj narzędzia `az group show` w celu uzyskania szczegółowych informacji o konkretnej grupie zasobów.

### 1.3. Enumeracja zasobów

Aby zebrać informacje o zasobach, wykonaj następujące kroki:

1. Użyj narzędzia `az resource list` w celu uzyskania listy zasobów.
2. Użyj narzędzia `az resource show` w celu uzyskania szczegółowych informacji o konkretnym zasobie.

## 2. Początkowe wejście

### 2.1. Przechwytywanie ruchu sieciowego

Aby przechwycić ruch sieciowy, wykonaj następujące kroki:

1. Użyj narzędzia `az network watcher create` w celu utworzenia obiektu monitorowania sieciowego.
2. Użyj narzędzia `az network watcher packet-capture create` w celu rozpoczęcia przechwytywania ruchu sieciowego.
3. Użyj narzędzia `az network watcher packet-capture show-status` w celu sprawdzenia statusu przechwytywania.
4. Użyj narzędzia `az network watcher packet-capture show` w celu pobrania przechwyconych pakietów.

### 2.2. Wykorzystywanie podatności

Aby wykorzystać podatności, wykonaj następujące kroki:

1. Zidentyfikuj podatności, korzystając z narzędzi takich jak `Nmap`, `Metasploit` lub `OpenVAS`.
2. Wykorzystaj znalezione podatności, aby uzyskać dostęp do systemu lub danych.

## 3. Zabezpieczenia

Aby zabezpieczyć środowisko Azure, należy wziąć pod uwagę następujące czynniki:

- Używanie silnych haseł i wieloczynnikowej autoryzacji.
- Regularne aktualizacje systemu operacyjnego i oprogramowania.
- Konfiguracja odpowiednich uprawnień dostępu do zasobów.
- Monitorowanie i analiza logów systemowych.
- Wdrażanie zabezpieczeń warstwy sieciowej, takich jak grupy zabezpieczeń sieciowych (NSG) i listy kontrolne dostępu (ACL).
- Regularne przeprowadzanie testów penetracyjnych w celu identyfikacji i naprawy podatności.

## 4. Podsumowanie

W tym dokumencie omówiono techniki i narzędzia, które można wykorzystać do przeprowadzenia testów penetracyjnych w chmurze Azure bez uwierzytelnienia. Przed przystąpieniem do testów należy jednak pamiętać o przestrzeganiu zasad etyki hackingu i uzyskaniu odpowiednich uprawnień.
```
UserName         Exists
--------         ------
user@company.com True
```
Możesz również użyć pliku tekstowego zawierającego jeden adres e-mail na każdym wierszu:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Istnieją **trzy różne metody wyliczania** do wyboru:

| Metoda    | Opis                                                                                                                                                                                                   |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normalna  | Odnosi się do wspomnianego powyżej interfejsu API GetCredentialType. Metoda domyślna.                                                                                                                  |
| Logowanie | <p>Ta metoda próbuje zalogować się jako użytkownik.<br><strong>Uwaga:</strong> zapytania zostaną zapisane w dzienniku logowania logów logowań.</p>                                                       |
| Autologon | <p>Ta metoda próbuje zalogować się jako użytkownik za pomocą punktu końcowego autologowania.<br><strong>Zapytania nie są rejestrowane</strong> w dzienniku logowania logów logowań! Działa więc również w przypadku ataków typu password spray i brute-force.</p> |

Po odkryciu prawidłowych nazw użytkowników możesz uzyskać **informacje o użytkowniku** za pomocą:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skrypt [**o365creeper**](https://github.com/LMGsec/o365creeper) pozwala również odkryć, **czy adres e-mail jest prawidłowy**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Usługi Azure

Teraz, gdy już znamy **domeny, których używa dzierżawca Azure**, czas spróbować znaleźć **odsłonięte usługi Azure**.

Możesz skorzystać z metody z [**MicroBurst**](https://github.com/NetSPI/MicroBurst), aby osiągnąć ten cel. Ta funkcja będzie wyszukiwać podstawową nazwę domeny (oraz kilka permutacji) w kilku **domenach usług Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Otwarte magazynowanie

Możesz odkryć otwarte magazynowanie za pomocą narzędzia takiego jak [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1), które będzie używać pliku **`Microburst/Misc/permitations.txt`** do generowania permutacji (bardzo proste) w celu próby **znalezienia otwartych kont magazynowych**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**Podpis URL dostępu współdzielonego**_ (SAS) to URL, który **zapewnia dostęp** do określonej części konta Storage (może to być pełny kontener, plik...) z określonymi uprawnieniami (odczyt, zapis...) do zasobów. Jeśli znajdziesz wyciekły taki URL, możesz uzyskać dostęp do poufnych informacji. Wyglądają one tak (to jest przykład dostępu do kontenera, jeśli dotyczyłoby to tylko dostępu do pliku, ścieżka URL również zawierałaby ten plik):

`https://<nazwa_konta_storage>.blob.core.windows.net/nowy_kontener?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Użyj [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/), aby uzyskać dostęp do danych.

## Kompromitacja poświadczeń

### Phishing

* [**Powszechne metody phishingu**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (poświadczenia lub aplikacja OAuth - [Atak nielegalnego udzielenia zgody](az-illicit-consent-grant.md) -)
* [**Phishing uwierzytelniania kodem urządzenia**](az-device-code-authentication-phishing.md)

### Spraying hasła / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Odnośniki

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć **reklamę swojej firmy w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
