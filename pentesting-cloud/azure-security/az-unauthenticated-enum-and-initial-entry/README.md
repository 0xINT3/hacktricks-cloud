# Az - Enum√©ration non authentifi√©e et Entr√©e initiale

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>

## Azure Tenant

### √ânum√©ration du locataire

Il existe quelques **APIs Azure publiques** que juste en connaissant le **domaine du locataire** un attaquant pourrait interroger pour recueillir plus d'informations √† ce sujet.\
Vous pouvez interroger directement l'API ou utiliser la biblioth√®que PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Information                                                                                                                                                                                                                                           | Fonction AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informations de connexion**, y compris l'ID du locataire                                                                                                                                                                                             | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Tous les domaines** du locataire                                                                                                                                                                                                                    | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informations de connexion</strong> du locataire, y compris le nom du locataire et le domaine du type d'**authentification**.<br>Si <code>TypeEspaceNom</code> est <strong><code>G√©r√©</code></strong>, cela signifie qu'**AzureAD** est utilis√©.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informations de connexion, y compris les **informations de SSO de bureau**                                                                                                                                                                             | `Get-AADIntLoginInformation -UserName <UserName>` |

Vous pouvez interroger toutes les informations d'un locataire Azure avec **juste une commande de la** [**biblioth√®que AADInternals**](https://github.com/Gerenios) **:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Exemple de sortie des informations du locataire Azure :
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Il est possible d'observer des d√©tails sur le nom du locataire, l'ID et le nom de la "marque". De plus, l'√©tat de la connexion unique au bureau (SSO), √©galement connu sous le nom de [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), est affich√©. Lorsqu'il est activ√©, cette fonction facilite la d√©termination de la pr√©sence (√©num√©ration) d'un utilisateur sp√©cifique au sein de l'organisation cible.

De plus, la sortie pr√©sente les noms de tous les domaines v√©rifi√©s associ√©s au locataire cible, ainsi que leurs types d'identit√© respectifs. Dans le cas des domaines f√©d√©r√©s, le nom de domaine complet (FQDN) du fournisseur d'identit√© utilis√©, g√©n√©ralement un serveur ADFS, est √©galement divulgu√©. La colonne "MX" sp√©cifie si les e-mails sont rout√©s vers Exchange Online, tandis que la colonne "SPF" indique l'inscription de Exchange Online en tant qu'exp√©diteur d'e-mails. Il est important de noter que la fonction actuelle de reconnaissance ne parse pas les d√©clarations "include" dans les enregistrements SPF, ce qui peut entra√Æner des faux n√©gatifs.

### √ânum√©ration des utilisateurs

Il est possible de **v√©rifier si un nom d'utilisateur existe** √† l'int√©rieur d'un locataire. Cela inclut √©galement les **utilisateurs invit√©s**, dont le nom d'utilisateur est au format :
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
L'email est l'adresse e-mail de l'utilisateur o√π le "@" est remplac√© par un tiret bas "\_".

Avec [**AADInternals**](https://github.com/Gerenios/AADInternals), vous pouvez facilement v√©rifier si l'utilisateur existe ou non :
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Enum√©ration non authentifi√©e et entr√©e initiale

---

## D√©couverte de ressources

### D√©couverte de l'API Management

L'API Management peut √™tre d√©couvert en acc√©dant √† l'URL suivante :

```
https://<AZURE_TENANT>.portal.azure-api.net/
```

### D√©couverte de l'Application Insights

L'Application Insights peut √™tre d√©couvert en acc√©dant √† l'URL suivante :

```
https://<AZURE_TENANT>.portal.azure-api.net/
```

---

## Attaque de force brute

### Attaque de force brute sur les services Azure

Il est possible d'effectuer une attaque de force brute sur les services Azure en utilisant des outils tels que Hydra ou Medusa.

---

## Vuln√©rabilit√©s connues

### Vuln√©rabilit√© de contournement de l'authentification

Certains services Azure peuvent pr√©senter des vuln√©rabilit√©s de contournement de l'authentification, permettant un acc√®s non autoris√© aux ressources.

---

## Exploitation des vuln√©rabilit√©s

### Utilisation de l'API Management sans authentification

En exploitant la d√©couverte de l'API Management sans authentification, un attaquant peut acc√©der √† des informations sensibles ou effectuer des actions non autoris√©es.
```
UserName         Exists
--------         ------
user@company.com True
```
Vous pouvez √©galement utiliser un fichier texte contenant une adresse e-mail par ligne :
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Il existe **trois m√©thodes d'√©num√©ration diff√©rentes** parmi lesquelles choisir :

| M√©thode    | Description                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normale    | Il s'agit de l'API GetCredentialType mentionn√©e ci-dessus. La m√©thode par d√©faut.                                                                                                                           |
| Connexion     | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur.<br><strong>Remarque :</strong> les requ√™tes seront enregistr√©es dans le journal des connexions.</p>                                                                                       |
| Autologon | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur via le point de terminaison autologon.<br><strong>Les requ√™tes ne sont pas enregistr√©es</strong> dans le journal des connexions ! Par cons√©quent, elle fonctionne √©galement bien pour les attaques de pulv√©risation de mots de passe et de force brute.</p> |

Apr√®s avoir d√©couvert les noms d'utilisateur valides, vous pouvez obtenir des **informations sur un utilisateur** avec :
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Le script [**o365creeper**](https://github.com/LMGsec/o365creeper) vous permet √©galement de d√©couvrir **si un e-mail est valide**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Services Azure

Maintenant que nous connaissons les **domaines utilis√©s par le locataire Azure**, il est temps d'essayer de trouver les **services Azure expos√©s**.

Vous pouvez utiliser une m√©thode de [**MicroBust**](https://github.com/NetSPI/MicroBurst) pour atteindre cet objectif. Cette fonction recherchera le nom de domaine de base (et quelques permutations) dans plusieurs **domaines de services Azure :**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Stockage Ouvert

Vous pourriez d√©couvrir un stockage ouvert avec un outil tel que [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) qui utilisera le fichier **`Microburst/Misc/permitations.txt`** pour g√©n√©rer des permutations (tr√®s simples) afin de **trouver des comptes de stockage ouverts**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URL SAS

Un _**jeton d'acc√®s partag√©**_ (SAS) est une URL qui **fournit l'acc√®s** √† certaines parties d'un compte de stockage (peut √™tre un conteneur complet, un fichier...) avec des autorisations sp√©cifiques (lecture, √©criture...) sur les ressources. Si vous en trouvez un qui a fuit√©, vous pourriez acc√©der √† des informations sensibles, ils ressemblent √† ceci (pour acc√©der √† un conteneur, s'il ne faisait que accorder l'acc√®s √† un fichier, le chemin de l'URL contiendrait √©galement ce fichier) :

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Utilisez [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) pour acc√©der aux donn√©es

## Compromission des identifiants

### Phishing

* [**Phishing Commun**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (identifiants ou application OAuth -[Attaque de Consentement Illicite](az-illicit-consent-grant.md)-)
* [**Phishing d'Authentification par Code Appareil**](az-device-code-authentication-phishing.md)

### Pulv√©risation de Mot de Passe / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
