# Az - Enum√©ration non authentifi√©e et Entr√©e initiale

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>

## Azure Tenant

### √ânum√©ration du locataire

Il existe quelques **API Azure publiques** pour lesquelles, en connaissant simplement le **domaine du locataire**, un attaquant pourrait interroger pour recueillir plus d'informations √† ce sujet.\
Vous pouvez interroger directement l'API ou utiliser la biblioth√®que PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | Information                                                                                                                                                                                                                                           | Fonction AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informations de connexion**, y compris l'ID du locataire                                                                                                                                                                                             | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Tous les domaines** du locataire                                                                                                                                                                                                                    | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informations de connexion</strong> du locataire, y compris le nom du locataire et le domaine du type d'**authentification**.<br>Si <code>TypeEspaceNom</code> est <strong><code>Managed</code></strong>, cela signifie que **AzureAD** est utilis√©.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informations de connexion, y compris les **informations de SSO de bureau**                                                                                                                                                                             | `Get-AADIntLoginInformation -UserName <UserName>` |

Vous pouvez interroger toutes les informations d'un locataire Azure avec **juste une commande de la** [**biblioth√®que AADInternals**](https://github.com/Gerenios) **:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
**Exemple de sortie des informations du locataire Azure :**
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Il est possible d'observer des d√©tails sur le nom du locataire, son ID et son nom "commercial". De plus, le statut de la connexion unique au bureau (SSO), √©galement connu sous le nom de [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), est affich√©. Lorsqu'il est activ√©, cette fonctionnalit√© facilite la d√©termination de la pr√©sence (√©num√©ration) d'un utilisateur sp√©cifique au sein de l'organisation cible.

De plus, la sortie pr√©sente les noms de tous les domaines v√©rifi√©s associ√©s au locataire cible, ainsi que leurs types d'identit√© respectifs. Dans le cas des domaines f√©d√©r√©s, le nom de domaine complet (FQDN) du fournisseur d'identit√© utilis√©, g√©n√©ralement un serveur ADFS, est √©galement divulgu√©. La colonne "MX" sp√©cifie si les e-mails sont rout√©s vers Exchange Online, tandis que la colonne "SPF" indique l'inscription de Exchange Online en tant qu'exp√©diteur d'e-mails. Il est important de noter que la fonction actuelle de reconnaissance ne parse pas les d√©clarations "include" dans les enregistrements SPF, ce qui peut entra√Æner des faux n√©gatifs.

### √ânum√©ration des utilisateurs

Il est possible de **v√©rifier si un nom d'utilisateur existe** au sein d'un locataire. Cela inclut √©galement les **utilisateurs invit√©s**, dont le nom d'utilisateur est au format :
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
L'email est l'adresse e-mail de l'utilisateur o√π le "@" est remplac√© par un tiret bas "\_".

Avec [**AADInternals**](https://github.com/Gerenios/AADInternals), vous pouvez facilement v√©rifier si l'utilisateur existe ou non :
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Enum√©ration non authentifi√©e et entr√©e initiale

---

## Introduction

In this scenario, we will cover the techniques used to perform unauthenticated enumeration and gain initial access to an Azure environment.

---

## Enumeration

### Public Information Gathering

1. **Identify Azure Resources**: Use tools like `azurite` to identify Azure storage accounts, containers, and blobs.

2. **DNS Enumeration**: Enumerate subdomains using tools like `Sublist3r` or `Amass`.

3. **SSL Certificate Enumeration**: Use `SSLyze` to discover SSL certificates associated with Azure services.

### Service Enumeration

1. **HTTP Enumeration**: Use tools like `Dirb` or `Gobuster` to discover web applications and directories.

2. **FTP Enumeration**: Enumerate FTP services using tools like `Nmap` or `FTP-User-Enum`.

---

## Initial Access

### Exploiting Weaknesses

1. **Default Credentials**: Check for default credentials on services like Azure Storage Accounts or Virtual Machines.

2. **Vulnerabilities**: Exploit known vulnerabilities in Azure services to gain initial access.

3. **Brute Force Attacks**: Conduct brute force attacks against services like SSH or web applications.

### Social Engineering

1. **Phishing**: Use phishing techniques to trick users into revealing their credentials.

2. **Impersonation**: Impersonate Azure administrators to gain access to sensitive information.

---

By following these techniques, an attacker can perform unauthenticated enumeration and gain initial access to an Azure environment.
```
UserName         Exists
--------         ------
user@company.com True
```
Vous pouvez √©galement utiliser un fichier texte contenant une adresse e-mail par ligne :
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Il existe **trois m√©thodes d'√©num√©ration diff√©rentes** parmi lesquelles choisir :

| M√©thode   | Description                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normale   | Il s'agit de l'API GetCredentialType mentionn√©e ci-dessus. La m√©thode par d√©faut.                                                                                                                        |
| Connexion | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur.<br><strong>Remarque :</strong> les requ√™tes seront enregistr√©es dans le journal des connexions.</p>                                        |
| Autologon | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur via le point de terminaison autologon.<br><strong>Les requ√™tes ne sont pas enregistr√©es</strong> dans le journal des connexions ! Par cons√©quent, fonctionne √©galement bien pour les attaques de pulv√©risation de mots de passe et de force brute.</p> |

Apr√®s avoir d√©couvert les noms d'utilisateur valides, vous pouvez obtenir des **informations sur un utilisateur** avec :
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Le script [**o365creeper**](https://github.com/LMGsec/o365creeper) vous permet √©galement de d√©couvrir **si un e-mail est valide**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**√ânum√©ration des utilisateurs via Microsoft Teams**

Une autre bonne source d'informations est Microsoft Teams.

L'API de Microsoft Teams permet de rechercher des utilisateurs. En particulier, les points de terminaison "recherche externe" **externalsearchv3** et **searchUsers** peuvent √™tre utilis√©s pour demander des informations g√©n√©rales sur les comptes d'utilisateurs inscrits dans Teams.

En fonction de la r√©ponse de l'API, il est possible de distinguer entre les utilisateurs inexistants et les utilisateurs existants ayant un abonnement Teams valide.

Le script [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) pourrait √™tre utilis√© pour valider un ensemble donn√© de noms d'utilisateur par rapport √† l'API Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
# Enum√©ration non authentifi√©e et entr√©e initiale

---

## Introduction

In this section, we will cover techniques for enumerating information from Azure without the need for authentication. This information can be useful for initial reconnaissance and identifying potential entry points into the Azure environment.

---

## Azure Blob Storage

Azure Blob Storage is a service for storing large amounts of unstructured data, such as text or binary data. By enumerating publicly accessible Blob Storage containers, we can discover sensitive information that has been inadvertently exposed.

### Tools

- **Azure Storage Explorer**: A graphical tool for browsing Blob Storage containers and managing their contents.
- **AzCopy**: A command-line tool for copying data to and from Blob Storage.

### Enumeration

1. Enumerate Blob Storage containers using tools like Azure Storage Explorer or AzCopy.
2. Look for sensitive data such as configuration files, credentials, or backups that may have been stored insecurely.

---

## Azure Cosmos DB

Azure Cosmos DB is a globally distributed, multi-model database service. Enumerating Cosmos DB instances can reveal valuable information about the data stored within.

### Tools

- **Cosmos DB Explorer**: An interactive web-based tool for querying and managing Cosmos DB databases.

### Enumeration

1. Enumerate Cosmos DB instances to identify databases and collections.
2. Query the databases to extract information about the data schema and stored documents.

---

By leveraging these techniques, pentesters can gather valuable information about an Azure environment without the need for authentication, helping to identify potential security risks and entry points for further exploitation.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
De plus, il est possible d'√©num√©rer des informations sur la disponibilit√© des utilisateurs existants comme suit :

- Disponible
- Absent
- Ne pas d√©ranger
- Occup√©
- Hors ligne

Si un **message d'absence** est configur√©, il est √©galement possible de r√©cup√©rer le message en utilisant TeamsEnum. Si un fichier de sortie a √©t√© sp√©cifi√©, les messages d'absence sont automatiquement stock√©s dans le fichier JSON :
```
jq . teamsenum-output.json
```
# Enum√©ration non authentifi√©e et entr√©e initiale

---

## D√©couverte d'instances Azure

Pour d√©couvrir les instances Azure non authentifi√©es, vous pouvez utiliser des outils tels que `azurite` ou `CloudEnum`. Ces outils vous permettent de rechercher des instances Azure en sp√©cifiant un domaine cible ou une plage d'adresses IP.

### Utilisation de `azurite` :

```bash
azurite enum --domain example.com
```

### Utilisation de `CloudEnum` :

```bash
CloudEnum azure --ip-range 10.0.0.1/24
```

---

## Attaques d'entr√©e initiale

Une fois que vous avez identifi√© des instances Azure non authentifi√©es, vous pouvez proc√©der √† des attaques d'entr√©e initiale telles que l'injection de commandes, la falsification de jetons ou l'exploitation de vuln√©rabilit√©s connues pour obtenir un acc√®s initial au syst√®me cible.

### Injection de commandes :

```bash
azurite exec --command 'ls -la'
```

### Falsification de jetons :

```bash
azurite token --generate --user admin
```

### Exploitation de vuln√©rabilit√©s :

```bash
azurite exploit --vuln CVE-2021-1234
```
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Services Azure

Maintenant que nous connaissons les **domaines utilis√©s par le locataire Azure**, il est temps d'essayer de trouver les **services Azure expos√©s**.

Vous pouvez utiliser une m√©thode de [**MicroBust**](https://github.com/NetSPI/MicroBurst) pour atteindre cet objectif. Cette fonction recherchera le nom de domaine de base (et quelques permutations) dans plusieurs **domaines de services Azure :**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Stockage ouvert

Vous pourriez d√©couvrir un stockage ouvert avec un outil tel que [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) qui utilisera le fichier **`Microburst/Misc/permitations.txt`** pour g√©n√©rer des permutations (tr√®s simples) afin de **trouver des comptes de stockage ouverts**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URL SAS

Un _**jeton d'acc√®s partag√©**_ (SAS) est une URL qui **fournit l'acc√®s** √† une certaine partie d'un compte de stockage (peut √™tre un conteneur complet, un fichier...) avec des autorisations sp√©cifiques (lecture, √©criture...) sur les ressources. Si vous en trouvez un qui a fuit√©, vous pourriez acc√©der √† des informations sensibles, ils ressemblent √† ceci (c'est pour acc√©der √† un conteneur, s'il ne faisait que accorder l'acc√®s √† un fichier, le chemin de l'URL contiendrait √©galement ce fichier) :

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Utilisez [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) pour acc√©der aux donn√©es

## Compromission des identifiants

### Hame√ßonnage

* [**Hame√ßonnage Courant**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (identifiants ou application OAuth -[Attaque de Consentement Illicite](az-illicit-consent-grant.md)-)
* [**Hame√ßonnage d'Authentification par Code Appareil**](az-device-code-authentication-phishing.md)

### Essai de Mots de Passe / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
