# Az - Enumera√ß√£o N√£o Autenticada & Entrada Inicial

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Azure Tenant

### Enumera√ß√£o de Tenant

Existem algumas **APIs p√∫blicas do Azure** que, conhecendo apenas o **dom√≠nio do tenant**, um atacante poderia consultar para coletar mais informa√ß√µes sobre ele.\
Voc√™ pode consultar diretamente a API ou usar a biblioteca PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informa√ß√£o                                                                                                                                                                                                                                           | Fun√ß√£o AADInternals                               |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informa√ß√µes de login**, incluindo ID do tenant                                                                                                                                                                                                     | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos os dom√≠nios** do tenant                                                                                                                                                                                                                      | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informa√ß√µes de login</strong> do tenant, incluindo nome do tenant e dom√≠nio <strong>tipo de autentica√ß√£o.</strong><br>Se <code>NameSpaceType</code> for <strong><code>Managed</code></strong>, significa que <strong>AzureAD</strong> √© usado.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informa√ß√µes de login, incluindo **informa√ß√µes de SSO de Desktop**                                                                                                                                                                                    | `Get-AADIntLoginInformation -UserName <UserName>` |

Voc√™ pode consultar todas as informa√ß√µes de um tenant do Azure com **apenas um comando da biblioteca** [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Exemplo de Sa√≠da das informa√ß√µes do tenant Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
A partir da sa√≠da, podemos ver as informa√ß√µes do tenant da organiza√ß√£o alvo, incluindo o nome do tenant, id e o nome da "marca". Tamb√©m podemos ver **se o Desktop SSO (tamb√©m conhecido como** [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**) est√° habilitado**. Se estiver habilitado, podemos descobrir se um usu√°rio espec√≠fico existe na organiza√ß√£o alvo ou n√£o (enumera√ß√£o de usu√°rio).

Tamb√©m podemos ver os nomes de todos os dom√≠nios (verificados) e seus tipos de identidade do tenant alvo. Para dom√≠nios federados, o FQDN do provedor de identidade utilizado (geralmente servidor ADFS) tamb√©m √© mostrado. A coluna MX indica se o email √© enviado para o Exchange online ou n√£o. A coluna SPF indica se o Exchange online est√° listado como um remetente de email. **Aten√ß√£o!** Atualmente, a fun√ß√£o de reconhecimento n√£o segue as declara√ß√µes include dos registros SPF, portanto, podem haver falsos-negativos.

### Enumera√ß√£o de Usu√°rio

√â poss√≠vel **verificar se um nome de usu√°rio existe** dentro de um tenant. Isso inclui tamb√©m **usu√°rios convidados**, cujo nome de usu√°rio est√° no formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
O email √© o endere√ßo de email do usu√°rio onde o "@" √© substitu√≠do por um sublinhado "\_".

Com [**AADInternals**](https://github.com/Gerenios/AADInternals), voc√™ pode facilmente verificar se o usu√°rio existe ou n√£o:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# Enumera√ß√£o N√£o Autenticada e Entrada Inicial no Azure

A enumera√ß√£o n√£o autenticada √© uma t√©cnica de pentesting onde um atacante tenta coletar informa√ß√µes sobre um alvo sem ter credenciais. No contexto do Azure, isso pode incluir a identifica√ß√£o de:

- Contas de armazenamento expostas
- Bancos de dados configurados incorretamente
- Informa√ß√µes de configura√ß√£o que podem vazar

## T√©cnicas Comuns

### Azure CLI & PowerShell

A Azure CLI e o PowerShell s√£o ferramentas poderosas que podem ser usadas para enumerar recursos do Azure. Mesmo sem autentica√ß√£o, algumas informa√ß√µes podem ser descobertas.

### Ferramentas de Terceiros

Existem v√°rias ferramentas de terceiros projetadas para ajudar na enumera√ß√£o do Azure. Elas podem identificar recursos mal configurados ou expostos.

### Busca na Web

Informa√ß√µes sobre configura√ß√µes do Azure podem ser encontradas em f√≥runs, reposit√≥rios de c√≥digo e outras fontes p√∫blicas.

## Entrada Inicial

Ap√≥s a enumera√ß√£o, a pr√≥xima etapa √© tentar uma entrada inicial. Isso pode ser feito explorando:

- Configura√ß√µes incorretas
- Vulnerabilidades conhecidas
- Dados vazados

A entrada inicial √© cr√≠tica para estabelecer uma posi√ß√£o dentro do ambiente do Azure para explora√ß√£o adicional.

## Conclus√£o

A enumera√ß√£o n√£o autenticada e a entrada inicial s√£o passos fundamentais no pentesting do Azure. Eles permitem que um atacante entenda o ambiente e encontre pontos de entrada sem credenciais.
```
```
UserName         Exists
--------         ------
user@company.com True
```
Voc√™ tamb√©m pode usar um arquivo de texto contendo um endere√ßo de email por linha:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Existem **tr√™s diferentes m√©todos de enumera√ß√£o** para escolher:

| M√©todo    | Descri√ß√£o                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Refere-se √† API GetCredentialType mencionada acima. O m√©todo padr√£o.                                                                                                                                   |
| Login     | <p>Este m√©todo tenta fazer login como o usu√°rio.<br><strong>Nota:</strong> as consultas ser√£o registradas no log de acessos.</p>                                                                       |
| Autologon | <p>Este m√©todo tenta fazer login como o usu√°rio atrav√©s do endpoint de autologon.<br><strong>As consultas n√£o s√£o registradas</strong> no log de acessos! Assim, funciona bem tamb√©m para ataques de for√ßa bruta e spray de senhas.</p> |

Ap√≥s descobrir os nomes de usu√°rio v√°lidos, voc√™ pode obter **informa√ß√µes sobre um usu√°rio** com:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
O script [**o365creeper**](https://github.com/LMGsec/o365creeper) tamb√©m permite descobrir **se um email √© v√°lido**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Servi√ßos Azure

Agora que sabemos os **dom√≠nios do tenant Azure** que est√£o sendo usados, √© hora de tentar encontrar **servi√ßos Azure expostos**.

Voc√™ pode usar um m√©todo do [**MicroBust**](https://github.com/NetSPI/MicroBurst) para tal objetivo. Esta fun√ß√£o ir√° pesquisar o nome de dom√≠nio base (e algumas permuta√ß√µes) em v√°rios **dom√≠nios de servi√ßos azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Armazenamento Aberto

Voc√™ pode descobrir armazenamento aberto com uma ferramenta como [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) que usar√° o arquivo **`Microburst/Misc/permitations.txt`** para gerar permuta√ß√µes (muito simples) para tentar **encontrar contas de armazenamento abertas**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URLs SAS

Uma URL _**shared access signature**_ (SAS) √© uma URL que **fornece acesso** a certa parte de uma conta de Armazenamento (pode ser um cont√™iner inteiro, um arquivo...) com algumas permiss√µes espec√≠ficas (ler, escrever...) sobre os recursos. Se voc√™ encontrar uma vazada, poder√° acessar informa√ß√µes sens√≠veis, elas se parecem com isso (isso √© para acessar um cont√™iner, se fosse apenas concedendo acesso a um arquivo, o caminho da URL tamb√©m conteria esse arquivo):

`https://<nome_da_conta_de_armazenamento>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Use o [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acessar os dados

## Comprometimento de Credenciais

### Phishing

* [**Phishing Comum**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciais ou OAuth App -[Ataque de Concess√£o de Consentimento Il√≠cito](az-illicit-consent-grant.md)-)
* [**Phishing de Autentica√ß√£o de C√≥digo de Dispositivo**](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
