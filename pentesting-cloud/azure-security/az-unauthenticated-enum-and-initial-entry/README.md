# Az - Enumera√ß√£o e Entrada Inicial N√£o Autenticada

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Azure Tenant

### Enumera√ß√£o do Tenant

Existem algumas **APIs p√∫blicas do Azure** que, apenas conhecendo o **dom√≠nio do tenant**, um atacante poderia consultar para obter mais informa√ß√µes sobre ele.\
Voc√™ pode consultar diretamente a API ou usar a biblioteca PowerShell [**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                 | Informa√ß√£o                                                                                                                                                                                                                                           | Fun√ß√£o AADInternals                             |
| ------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<dom√≠nio>/.well-known/openid-configuration | **Informa√ß√µes de login**, incluindo o ID do tenant                                                                                                                                                                                                     | `Get-AADIntTenantID -Domain <dom√≠nio>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos os dom√≠nios** do tenant                                                                                                                                                                                                                       | `Get-AADIntTenantDomains -Domain <dom√≠nio>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<NomeUsu√°rio>     | <p><strong>Informa√ß√µes de login</strong> do tenant, incluindo o Nome do tenant e o dom√≠nio do tipo de autentica√ß√£o <strong>.<br>Se o <code>NameSpaceType</code> for <strong><code>Gerenciado</code></strong>, significa que o <strong>AzureAD</strong> √© usado.</p> | `Get-AADIntLoginInformation -UserName <NomeUsu√°rio>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informa√ß√µes de login, incluindo **informa√ß√µes de SSO de Desktop**                                                                                                                                                                                     | `Get-AADIntLoginInformation -UserName <NomeUsu√°rio>` |

Voc√™ pode consultar todas as informa√ß√µes de um tenant do Azure com **apenas um comando da** [**biblioteca AADInternals**](https://github.com/Gerenios):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Exemplo de sa√≠da das informa√ß√µes do locat√°rio do Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
√â poss√≠vel observar detalhes sobre o nome do locat√°rio, ID e nome da "marca". Al√©m disso, o status do Logon √önico para Desktop (SSO), tamb√©m conhecido como [**SSO sem interrup√ß√µes**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), √© exibido. Quando ativado, esse recurso facilita a determina√ß√£o da presen√ßa (enumera√ß√£o) de um usu√°rio espec√≠fico dentro da organiza√ß√£o alvo.

Al√©m disso, a sa√≠da apresenta os nomes de todos os dom√≠nios verificados associados ao locat√°rio alvo, juntamente com seus respectivos tipos de identidade. No caso de dom√≠nios federados, o Nome de Dom√≠nio Totalmente Qualificado (FQDN) do provedor de identidade em uso, normalmente um servidor ADFS, tamb√©m √© divulgado. A coluna "MX" especifica se os e-mails s√£o roteados para o Exchange Online, enquanto a coluna "SPF" denota a listagem do Exchange Online como remetente de e-mails. √â importante observar que a fun√ß√£o de reconhecimento atual n√£o analisa as declara√ß√µes "include" dentro dos registros SPF, o que pode resultar em falsos negativos.

### Enumera√ß√£o de Usu√°rios

√â poss√≠vel **verificar se um nome de usu√°rio existe** dentro de um locat√°rio. Isso inclui tamb√©m **usu√°rios convidados**, cujo nome de usu√°rio segue o formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
O email √© o endere√ßo de email do usu√°rio onde em "@" √© substitu√≠do por sublinhado "\_".

Com [**AADInternals**](https://github.com/Gerenios/AADInternals), voc√™ pode facilmente verificar se o usu√°rio existe ou n√£o:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## Enumera√ß√£o n√£o autenticada e Entrada Inicial

Nesta se√ß√£o, vamos explorar como realizar a enumera√ß√£o n√£o autenticada e obter acesso inicial em ambientes do Azure.

### Enumera√ß√£o n√£o autenticada

A enumera√ß√£o n√£o autenticada √© uma t√©cnica que pode ser usada para coletar informa√ß√µes sobre recursos e servi√ßos dispon√≠veis em um ambiente do Azure sem a necessidade de autentica√ß√£o. Isso pode incluir descobrir informa√ß√µes sobre inst√¢ncias de m√°quinas virtuais, contas de armazenamento, grupos de seguran√ßa de rede, entre outros.

### Entrada Inicial

Uma vez que informa√ß√µes relevantes tenham sido coletadas durante a fase de enumera√ß√£o n√£o autenticada, √© poss√≠vel utilizar esses dados para obter acesso inicial ao ambiente do Azure. Isso pode envolver a identifica√ß√£o de vulnerabilidades ou configura√ß√µes inadequadas que possam ser exploradas para ganhar acesso n√£o autorizado.
```
UserName         Exists
--------         ------
user@company.com True
```
Voc√™ tamb√©m pode usar um arquivo de texto contendo um endere√ßo de e-mail por linha:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Existem **tr√™s m√©todos de enumera√ß√£o diferentes** para escolher:

| M√©todo    | Descri√ß√£o                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Isso se refere ao API GetCredentialType mencionado acima. O m√©todo padr√£o.                                                                                                                           |
| Login     | <p>Este m√©todo tenta fazer login como o usu√°rio.<br><strong>Nota:</strong> as consultas ser√£o registradas no log de logins.</p>                                                                                       |
| Autologon | <p>Este m√©todo tenta fazer login como o usu√°rio via endpoint de autologon.<br><strong>As consultas n√£o s√£o registradas</strong> no log de logins! Como tal, funciona bem tamb√©m para ataques de pulveriza√ß√£o de senha e for√ßa bruta.</p> |

Depois de descobrir os nomes de usu√°rio v√°lidos, voc√™ pode obter **informa√ß√µes sobre um usu√°rio** com:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
O script [**o365creeper**](https://github.com/LMGsec/o365creeper) tamb√©m permite descobrir **se um email √© v√°lido**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Enumera√ß√£o de Usu√°rios via Microsoft Teams**

Outra boa fonte de informa√ß√£o √© o Microsoft Teams.

A API do Microsoft Teams permite pesquisar usu√°rios. Em particular, os endpoints de "pesquisa de usu√°rio" **externalsearchv3** e **searchUsers** podem ser usados para solicitar informa√ß√µes gerais sobre contas de usu√°rios inscritos no Teams.

Dependendo da resposta da API, √© poss√≠vel distinguir entre usu√°rios que n√£o existem e usu√°rios existentes que t√™m uma assinatura v√°lida do Teams.

O script [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) pode ser usado para validar um conjunto dado de nomes de usu√°rio contra a API do Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## Enumera√ß√£o n√£o autenticada e Entrada Inicial

Nesta se√ß√£o, vamos discutir como realizar a enumera√ß√£o n√£o autenticada e obter acesso inicial em ambientes do Azure.

### Enumera√ß√£o n√£o autenticada

A enumera√ß√£o n√£o autenticada √© uma t√©cnica usada para coletar informa√ß√µes sobre recursos e servi√ßos dispon√≠veis em um ambiente do Azure sem a necessidade de autentica√ß√£o. Isso pode incluir descobrir informa√ß√µes sobre inst√¢ncias de m√°quinas virtuais, contas de armazenamento, grupos de seguran√ßa de rede e muito mais.

### Entrada Inicial

Uma vez que a enumera√ß√£o n√£o autenticada tenha sido realizada com sucesso, o pr√≥ximo passo √© obter acesso inicial ao ambiente do Azure. Isso pode ser feito explorando vulnerabilidades conhecidas, como configura√ß√µes incorretas de seguran√ßa, credenciais fracas ou at√© mesmo a falta de patches de seguran√ßa.

√â importante ressaltar que a obten√ß√£o de acesso inicial sem autoriza√ß√£o √© ilegal e deve ser realizada apenas em ambientes nos quais voc√™ tenha permiss√£o expl√≠cita para realizar testes de seguran√ßa.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Al√©m disso, √© poss√≠vel enumerar informa√ß√µes de disponibilidade sobre usu√°rios existentes, como:

- Dispon√≠vel
- Ausente
- N√£o perturbe
- Ocupado
- Offline

Se uma **mensagem de aus√™ncia do escrit√≥rio** estiver configurada, tamb√©m √© poss√≠vel recuperar a mensagem usando o TeamsEnum. Se um arquivo de sa√≠da foi especificado, as mensagens de aus√™ncia do escrit√≥rio s√£o armazenadas automaticamente no arquivo JSON:
```
jq . teamsenum-output.json
```
## Enumera√ß√£o n√£o autenticada e entrada inicial

Nesta se√ß√£o, vamos discutir como realizar a enumera√ß√£o n√£o autenticada e obter acesso inicial em ambientes do Azure.

### Enumera√ß√£o n√£o autenticada

Para realizar a enumera√ß√£o n√£o autenticada em um ambiente do Azure, voc√™ pode usar ferramentas como `Nmap` para identificar servi√ßos em execu√ß√£o e poss√≠veis vulnerabilidades. Al√©m disso, a enumera√ß√£o de DNS pode revelar informa√ß√µes √∫teis sobre a infraestrutura do alvo.

### Entrada inicial

Ap√≥s identificar poss√≠veis vulnerabilidades durante a enumera√ß√£o n√£o autenticada, voc√™ pode explor√°-las para obter acesso inicial ao ambiente do Azure. Isso pode incluir a explora√ß√£o de servi√ßos desatualizados, configura√ß√µes incorretas ou credenciais fracas para ganhar acesso n√£o autorizado. Certifique-se de documentar todas as etapas e resultados para refer√™ncia futura.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Servi√ßos do Azure

Agora que sabemos os **dom√≠nios usados pelo inquilino do Azure**, √© hora de tentar encontrar **servi√ßos do Azure expostos**.

Voc√™ pode usar um m√©todo do [**MicroBust**](https://github.com/NetSPI/MicroBurst) para esse objetivo. Essa fun√ß√£o ir√° procurar o nome do dom√≠nio base (e algumas permuta√ß√µes) em v√°rios **dom√≠nios de servi√ßos do Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Armazenamento Aberto

Voc√™ pode descobrir armazenamento aberto com uma ferramenta como [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) que usar√° o arquivo **`Microburst/Misc/permitations.txt`** para gerar permuta√ß√µes (muito simples) e tentar **encontrar contas de armazenamento abertas**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URLs SAS

Um _**token de acesso compartilhado**_ (SAS) √© um URL que **fornece acesso** a uma determinada parte de uma conta de armazenamento (pode ser um cont√™iner completo, um arquivo...) com permiss√µes espec√≠ficas (leitura, escrita...) sobre os recursos. Se voc√™ encontrar um vazado, poder√° acessar informa√ß√µes sens√≠veis, eles se parecem com isso (isso √© para acessar um cont√™iner, se fosse apenas concedendo acesso a um arquivo, o caminho do URL tamb√©m conteria esse arquivo):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Use [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acessar os dados

## Comprometer Credenciais

### Phishing

* [**Phishing Comum**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciais ou Aplicativo OAuth -[Ataque de Concess√£o de Consentimento Il√≠cito](az-illicit-consent-grant.md)-)
* [**Phishing de Autentica√ß√£o de C√≥digo de Dispositivo**](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
