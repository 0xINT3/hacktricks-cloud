# Az - Enumeración no autenticada y entrada inicial

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Azure Tenant

### Enumeración de Tenant

Existen algunas **APIs públicas de Azure** que, con solo conocer el **dominio del tenant**, un atacante podría consultar para recopilar más información sobre él.\
Puedes consultar directamente la API o usar la biblioteca de PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Información                                                                                                                                                                                                                                           | Función de AADInternals                           |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Información de inicio de sesión**, incluyendo el ID del tenant                                                                                                                                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos los dominios** del tenant                                                                                                                                                                                                                     | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Información de inicio de sesión</strong> del tenant, incluyendo el nombre del tenant y el dominio <strong>tipo de autenticación.</strong><br>Si <code>NameSpaceType</code> es <strong><code>Managed</code></strong>, significa que se utiliza <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Información de inicio de sesión, incluyendo **información de SSO de escritorio**                                                                                                                                                                      | `Get-AADIntLoginInformation -UserName <UserName>` |

Puedes consultar toda la información de un tenant de Azure con **solo un comando de la** [**biblioteca AADInternals**](https://github.com/Gerenios/AADInternals)**:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Ejemplo de salida de la información del tenant de Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Del resultado podemos ver la información del inquilino de la organización objetivo, incluyendo el nombre del inquilino, id y el nombre de "marca". También podemos ver **si el Desktop SSO (también conocido como** [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**) está habilitado**. Si está habilitado, podemos averiguar si un usuario dado existe en la organización objetivo o no (enumeración de usuarios).

También podemos ver los nombres de todos los dominios (verificados) y sus tipos de identidad del inquilino objetivo. Para los dominios federados, también se muestra el FQDN del proveedor de identidad utilizado (generalmente servidor ADFS). La columna MX indica si el correo electrónico se envía a Exchange online o no. La columna SPF indica si Exchange online está listado como remitente de correo electrónico. **¡Nota!** Actualmente, la función de reconocimiento no sigue las declaraciones include de los registros SPF, por lo que puede haber falsos negativos.

### Enumeración de Usuarios

Es posible **verificar si un nombre de usuario existe** dentro de un inquilino. Esto incluye también a los **usuarios invitados**, cuyo nombre de usuario tiene el formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
El correo electrónico es la dirección de correo del usuario donde el "@" se reemplaza por un guion bajo "\_".

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), puedes verificar fácilmente si el usuario existe o no:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# Enumeración no autenticada e ingreso inicial en Azure

La enumeración no autenticada en Azure puede proporcionar una gran cantidad de información que puede ser utilizada para un ingreso inicial. Algunas técnicas incluyen:

## Listado de blobs públicos

Los blobs públicos en Azure pueden contener información sensible. Utiliza herramientas como `AzCopy` o `Microsoft Azure Storage Explorer` para listar y descargar blobs.

## Fugas de claves en repositorios

Las claves de acceso pueden estar presentes en repositorios públicos. Herramientas como `truffleHog` o `git-secrets` pueden ayudar a identificarlas.

## Subdominios de Azure

Los subdominios de Azure pueden revelar información sobre la infraestructura. Herramientas como `Sublist3r` o `Amass` pueden ser útiles para enumerar subdominios.

## Fugas de información en plantillas de ARM

Las plantillas de Azure Resource Manager (ARM) pueden contener datos sensibles. Revisa las plantillas en busca de posibles fugas.

## Búsqueda de información en redes sociales y foros

La información sobre la infraestructura de Azure puede ser compartida en redes sociales y foros. Utiliza técnicas de OSINT para recopilar datos.

## Enumeración de espacios de trabajo de Azure DevOps

Los espacios de trabajo de Azure DevOps pueden contener información valiosa. Intenta enumerar proyectos y repositorios.

## Fugas de información en configuraciones de CI/CD

Las configuraciones de integración continua y entrega continua (CI/CD) pueden exponer claves y secretos. Examina estas configuraciones cuidadosamente.

## Enumeración de contenedores y Kubernetes

Azure Kubernetes Service (AKS) y contenedores pueden ser configurados incorrectamente. Utiliza herramientas como `kube-hunter` o `kubeaudit` para la enumeración.

## Fugas de información en registros de auditoría y logs

Los registros de auditoría y logs pueden contener información sensible. Revisa los registros en busca de datos que puedan ser explotados.

## Enumeración de recursos de Azure mediante APIs

Las APIs de Azure ofrecen otra vía para la enumeración de recursos. Utiliza scripts o herramientas como `Postman` para explorar las APIs.

## Fugas de información en configuraciones de almacenamiento

Las configuraciones de almacenamiento de Azure pueden estar mal configuradas y exponer datos. Verifica las configuraciones de acceso y permisos.

## Enumeración de servicios expuestos

Los servicios expuestos en Azure pueden ser vulnerables. Identifica servicios accesibles públicamente y evalúa su configuración de seguridad.

## Fugas de información en dashboards y paneles de control

Los dashboards y paneles de control de Azure pueden revelar información crítica. Asegúrate de revisar cualquier interfaz accesible públicamente.

## Enumeración de identidades y roles

Las identidades y roles en Azure pueden ser mal administrados. Enumera y evalúa las asignaciones de roles y políticas de acceso.

## Fugas de información en scripts y código

Los scripts y el código pueden contener claves y configuraciones sensibles. Revisa el código en busca de posibles fugas.

Recuerda que estas técnicas deben ser utilizadas de manera responsable y dentro del marco legal.
```
```
UserName         Exists
--------         ------
user@company.com True
```
También puedes usar un archivo de texto que contenga una dirección de correo electrónico por fila:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Hay **tres métodos de enumeración diferentes** para elegir:

| Método    | Descripción                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Se refiere a la API GetCredentialType mencionada anteriormente. El método predeterminado.                                                                                                               |
| Login     | <p>Este método intenta iniciar sesión como el usuario.<br><strong>Nota:</strong> las consultas se registrarán en el log de inicios de sesión.</p>                                                       |
| Autologon | <p>Este método intenta iniciar sesión como el usuario a través del punto final de autologon.<br><strong>Las consultas no se registran</strong> en el log de inicios de sesión. Por lo tanto, funciona bien también para ataques de rociado de contraseñas y fuerza bruta.</p> |

Después de descubrir los nombres de usuario válidos, puedes obtener **información sobre un usuario** con:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
El script [**o365creeper**](https://github.com/LMGsec/o365creeper) también te permite descubrir **si un correo electrónico es válido**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Servicios de Azure

Ahora que sabemos los **dominios que el inquilino de Azure** está utilizando, es hora de intentar encontrar **servicios de Azure expuestos**.

Puedes utilizar un método de [**MicroBust**](https://github.com/NetSPI/MicroBurst) para tal fin. Esta función buscará el nombre de dominio base (y algunas permutaciones) en varios **dominios de servicios de azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Almacenamiento Abierto

Podrías descubrir almacenamiento abierto con una herramienta como [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) que utilizará el archivo **`Microburst/Misc/permitations.txt`** para generar permutaciones (muy simples) para intentar **encontrar cuentas de almacenamiento abiertas**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URLs SAS

Una URL de _**firma de acceso compartido**_ (SAS) es una URL que **proporciona acceso** a cierta parte de una cuenta de Almacenamiento (puede ser un contenedor completo, un archivo...) con algunos permisos específicos (leer, escribir...) sobre los recursos. Si encuentras una filtrada podrías acceder a información sensible, se ven así (esto es para acceder a un contenedor, si solo otorgara acceso a un archivo, la ruta de la URL también contendría ese archivo):

`https://<nombre_cuenta_almacenamiento>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos

## Comprometer Credenciales

### Phishing

* [**Phishing Común**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciales o aplicación OAuth -[Ataque de Concesión de Consentimiento Ilícito](az-illicit-consent-grant.md)-)
* [**Phishing de Autenticación de Código de Dispositivo**](az-device-code-authentication-phishing.md)

### Rociado de Contraseñas / Fuerza Bruta

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Referencias

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repos de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
