# Az - Enumerazione non autenticata e accesso iniziale

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Tenant Azure

### Enumerazione del tenant

Ci sono alcune **API pubbliche di Azure** che, conoscendo solo il **dominio del tenant**, un attaccante potrebbe interrogare per raccogliere ulteriori informazioni al riguardo.\
Puoi interrogare direttamente l'API o utilizzare la libreria PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informazioni                                                                                                                                                                                                                                           | Funzione AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<dominio>/.well-known/openid-configuration | **Informazioni di accesso**, inclusa l'ID del tenant                                                                                                                                                                                                   | `Get-AADIntTenantID -Domain <dominio>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Tutti i domini** del tenant                                                                                                                                                                                                                         | `Get-AADIntTenantDomains -Domain <dominio>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<NomeUtente>         | <p><strong>Informazioni di accesso</strong> del tenant, inclusi il nome del tenant e il <strong>tipo di autenticazione del dominio.</strong><br>Se <code>NameSpaceType</code> √® <strong><code>Managed</code></strong>, significa che viene utilizzato <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <NomeUtente>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informazioni di accesso, inclusa l'**informazione di Desktop SSO**                                                                                                                                                                                     | `Get-AADIntLoginInformation -UserName <NomeUtente>` |

Puoi interrogare tutte le informazioni di un tenant Azure con **solo un comando della** libreria [**AADInternals**](https://github.com/Gerenios/AADInternals):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Esempio di output delle informazioni del tenant Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
√à possibile osservare i dettagli sul nome del tenant, l'ID e il nome "brand". Inoltre, viene visualizzato lo stato del Desktop Single Sign-On (SSO), noto anche come [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso). Quando abilitata, questa funzionalit√† facilita la determinazione della presenza (enumerazione) di un utente specifico all'interno dell'organizzazione di destinazione.

Inoltre, l'output presenta i nomi di tutti i domini verificati associati al tenant di destinazione, insieme ai rispettivi tipi di identit√†. Nel caso dei domini federati, viene anche divulgato il Fully Qualified Domain Name (FQDN) del provider di identit√† in uso, tipicamente un server ADFS. La colonna "MX" specifica se le email vengono instradate verso Exchange Online, mentre la colonna "SPF" indica l'inserimento di Exchange Online come mittente delle email. √à importante notare che la funzione di riconoscimento corrente non analizza le istruzioni "include" all'interno dei record SPF, il che potrebbe comportare falsi negativi.

### Enumerazione degli utenti

√à possibile **verificare se esiste un nome utente** all'interno di un tenant. Ci√≤ include anche gli utenti ospiti, il cui nome utente √® nel formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
L'email √® l'indirizzo email dell'utente in cui il simbolo "@" √® sostituito con l'underscore "\_".

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), √® possibile verificare facilmente se l'utente esiste o meno:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Enumerazione non autenticata e accesso iniziale in Azure

Questa guida fornisce una panoramica delle tecniche di enumerazione non autenticata e accesso iniziale in Azure. Queste tecniche consentono di ottenere informazioni sensibili e di accedere a risorse all'interno di un ambiente Azure senza autenticazione.

## Enumerazione non autenticata

L'enumerazione non autenticata √® una tecnica che sfrutta le vulnerabilit√† di configurazione per ottenere informazioni sulle risorse all'interno di un ambiente Azure senza autenticazione. Questa tecnica pu√≤ essere utilizzata per identificare risorse esposte pubblicamente, come endpoint API, database, storage account e altro ancora.

### Strumenti e metodi

- **Azure AD Graph API**: L'API di Azure AD Graph consente di ottenere informazioni sugli utenti, i gruppi e le autorizzazioni all'interno di un ambiente Azure.
- **Azure Resource Manager API**: L'API di Azure Resource Manager consente di ottenere informazioni sulle risorse all'interno di un ambiente Azure, come le impostazioni di configurazione e le autorizzazioni.
- **Enumerazione DNS**: L'enumerazione DNS pu√≤ essere utilizzata per identificare i nomi di dominio associati alle risorse Azure, come i servizi di Azure Active Directory e i servizi di archiviazione.
- **Enumerazione di servizi**: L'enumerazione di servizi pu√≤ essere utilizzata per identificare i servizi esposti pubblicamente all'interno di un ambiente Azure, come i servizi di Azure Key Vault e i servizi di Azure Storage.

## Accesso iniziale

Una volta ottenute informazioni sensibili tramite l'enumerazione non autenticata, √® possibile utilizzare queste informazioni per ottenere un accesso iniziale all'ambiente Azure. Questo pu√≤ essere fatto sfruttando vulnerabilit√† di configurazione, debolezze delle password o altre tecniche di hacking.

### Possibili punti di accesso

- **Endpoint API**: Se un endpoint API √® esposto pubblicamente e non richiede autenticazione, potrebbe essere possibile accedere alle risorse o eseguire operazioni non autorizzate.
- **Database**: Se un database √® esposto pubblicamente e non richiede autenticazione, potrebbe essere possibile accedere ai dati sensibili o eseguire query non autorizzate.
- **Storage account**: Se un account di archiviazione √® esposto pubblicamente e non richiede autenticazione, potrebbe essere possibile accedere ai file o eseguire operazioni non autorizzate.
- **Impostazioni di configurazione**: Se le impostazioni di configurazione di un'applicazione o di un servizio sono accessibili pubblicamente, potrebbe essere possibile ottenere informazioni sensibili o modificare le impostazioni per ottenere un accesso non autorizzato.

## Conclusioni

L'enumerazione non autenticata e l'accesso iniziale sono tecniche comuni utilizzate dai pentester per identificare e sfruttare vulnerabilit√† all'interno di un ambiente Azure. √à importante comprendere queste tecniche per poter proteggere adeguatamente le risorse e prevenire potenziali violazioni della sicurezza.
```
UserName         Exists
--------         ------
user@company.com True
```
Puoi anche utilizzare un file di testo contenente un indirizzo email per riga:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Ci sono **tre diversi metodi di enumerazione** tra cui scegliere:

| Metodo    | Descrizione                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normale   | Si riferisce all'API GetCredentialType menzionata sopra. Il metodo predefinito.                                                                                                                           |
| Login     | <p>Questo metodo cerca di effettuare il login come utente.<br><strong>Nota:</strong> le query verranno registrate nel log degli accessi.</p>                                                                                       |
| Autologon | <p>Questo metodo cerca di effettuare il login come utente tramite l'endpoint di autologon.<br>Le query <strong>non vengono registrate</strong> nel log degli accessi! Pertanto, funziona bene anche per attacchi di password spray e brute-force.</p> |

Dopo aver scoperto i nomi utente validi, √® possibile ottenere **informazioni su un utente** con:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Lo script [**o365creeper**](https://github.com/LMGsec/o365creeper) ti permette anche di scoprire **se un'email √® valida**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Servizi Azure

Ora che sappiamo quali sono i **domini utilizzati dal tenant Azure**, √® il momento di cercare i **servizi Azure esposti**.

Puoi utilizzare un metodo da [**MicroBust**](https://github.com/NetSPI/MicroBurst) per raggiungere questo obiettivo. Questa funzione cercher√† il nome di dominio di base (e alcune permutazioni) in diversi **domini dei servizi Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Archiviazione aperta

√à possibile scoprire l'archiviazione aperta utilizzando uno strumento come [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) che utilizzer√† il file **`Microburst/Misc/permitations.txt`** per generare permutazioni (molto semplici) per cercare di **trovare account di archiviazione aperti**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URL SAS

Un URL _**shared access signature**_ (SAS) √® un URL che **fornisce accesso** a una determinata parte di un account di archiviazione (pu√≤ essere un intero contenitore, un file...) con alcune autorizzazioni specifiche (lettura, scrittura...) sulle risorse. Se ne trovi uno che √® stato divulgato, potresti essere in grado di accedere a informazioni sensibili, hanno questo aspetto (questo √® per accedere a un contenitore, se fosse solo per concedere accesso a un file, il percorso dell'URL conterr√† anche quel file):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) per accedere ai dati

## Compromettere le credenziali

### Phishing

* [**Phishing comune**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenziali o OAuth App -[Attacco di concessione di consenso illecito](az-illicit-consent-grant.md)-)
* [**Phishing di autenticazione del codice del dispositivo**](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Riferimenti

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
