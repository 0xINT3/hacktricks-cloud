# Az - Uchambuzi na Kuingia kwa Kutothibitishwa

<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalamu wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Azure Tenant

### Uchambuzi wa Tenant

Kuna **Azure APIs za umma** ambazo kwa kujua **kikoa cha tenant** mshambuliaji anaweza kuuliza ili kupata habari zaidi kuhusu hilo.\
Unaweza kuuliza moja kwa moja API au kutumia maktaba ya PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Taarifa                                                                                                                                                                                                                                           | Kazi ya AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Taarifa za kuingia**, ikiwa ni pamoja na kitambulisho cha tenant                                                                                                                                                                                | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Mikoa yote** ya tenant                                                                                                                                                                                                                         | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Taarifa za kuingia</strong> za tenant, ikiwa ni pamoja na Jina la tenant na kikoa cha aina ya <strong>uthibitishaji.</strong><br>Ikiwa <code>NameSpaceType</code> ni <strong><code>Managed</code></strong>, inamaanisha <strong>AzureAD</strong> inatumika.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Taarifa za kuingia, ikiwa ni pamoja na **taarifa za Desktop SSO**                                                                                                                                                                                  | `Get-AADIntLoginInformation -UserName <UserName>` |

Unaweza kuuliza taarifa zote za tenant wa Azure kwa **amri moja tu ya** [**AADInternals**](https://github.com/Gerenios/AADInternals) **maktaba**:
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Mfano wa Maudhui ya Mmiliki wa Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
Niwezekana kuona maelezo kuhusu jina la mpangishaji, kitambulisho, na jina la "brand". Aidha, hali ya Desktop Single Sign-On (SSO), inayojulikana pia kama [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), inaonyeshwa. Wakati ikiruhusiwa, kipengele hiki hufanikisha kugundua uwepo (ujumuishaji) wa mtumiaji maalum ndani ya shirika lengwa.

Zaidi ya hayo, matokeo yanatoa majina ya uhalalishaji wa vikoa vyote vilivyothibitishwa vinavyohusiana na mpangishaji lengwa, pamoja na aina zao za utambulisho. Katika kesi ya vikoa vilivyofederated, Jina Kamili la Kikoa (FQDN) la mtoa huduma wa utambulisho unaotumiwa, kawaida seva ya ADFS, pia hufunuliwa. Safu ya "MX" inabainisha ikiwa barua pepe zinapelekwa kwa Exchange Online, wakati safu ya "SPF" inaonyesha orodha ya Exchange Online kama mtumaji wa barua pepe. Ni muhimu kutambua kuwa kazi ya uchunguzi wa sasa haipasui taarifa za "include" ndani ya rekodi za SPF, ambayo inaweza kusababisha matokeo hasi ya uwongo.

### Ujumuishaji wa Mtumiaji

Niwezekana **kuangalia ikiwa jina la mtumiaji lipo** ndani ya mpangishaji. Hii ni pamoja na **watumiaji wa mwaliko**, ambao majina yao ya mtumiaji yana muundo wa:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
Email ni anwani ya barua pepe ya mtumiaji ambapo katika ‚Äú@‚Äù imebadilishwa na mstari wa chini ‚Äú\_‚Äú.

Kwa [**AADInternals**](https://github.com/Gerenios/AADInternals), unaweza kwa urahisi kuthibitisha ikiwa mtumiaji yupo au la:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Kuchunguza na Kuingia kwa Awamu ya Kwanza bila Kuthibitishwa

Katika hatua hii, tutachunguza jinsi ya kuchunguza na kuingia kwenye mazingira ya Azure bila kuthibitishwa. Hii ni pamoja na kutafuta habari muhimu kama vile vitambulisho vya huduma, vitambulisho vya wateja, na maelezo mengine ya siri ambayo yanaweza kutusaidia kupata ufikiaji usiothibitishwa kwenye mazingira ya Azure.
```
UserName         Exists
--------         ------
user@company.com True
```
Unaweza pia kutumia faili ya maandishi inayohifadhi anwani moja ya barua pepe kwa kila safu:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Kuna **njia tatu tofauti za uchambuzi** za kuchagua kutoka:

| Njia      | Maelezo                                                                                                                                                                                                 |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Kawaida   | Hii inahusu API ya GetCredentialType iliyotajwa hapo juu. Njia ya kawaida.                                                                                                                             |
| Ingia     | <p>Njia hii inajaribu kuingia kama mtumiaji.<br><strong>Angalizo:</strong> maswali yataorodheshwa kwenye logi za kuingia.</p>                                                                           |
| Autologon | <p>Njia hii inajaribu kuingia kama mtumiaji kupitia kielekezi cha autologon.<br><strong>Maswali hayo hayataorodheshwa</strong> kwenye logi za kuingia! Kwa hivyo, inafanya kazi vizuri pia kwa mashambulizi ya kunyunyizia nywila na nguvu ya nguvu.</p> |

Baada ya kugundua majina halali ya watumiaji unaweza kupata **taarifa kuhusu mtumiaji** na:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Skripti [**o365creeper**](https://github.com/LMGsec/o365creeper) pia inakuruhusu kugundua **ikiwa barua pepe ni halali**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Huduma za Azure

Tukiwa tunajua **domaini ambazo mpangaji wa Azure** anatumia, ni wakati wa kujaribu kutafuta **huduma za Azure zilizofichuliwa**.

Unaweza kutumia njia kutoka kwa [**MicroBust**](https://github.com/NetSPI/MicroBurst) kwa lengo kama hilo. Kazi hii itatafuta jina la msingi la domaini (na mabadiliko machache) katika **domaini kadhaa za huduma za Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Uhifadhi Uliofunguliwa

Unaweza kugundua uhifadhi uliofunguliwa kwa kutumia chombo kama [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) ambacho kitatumia faili **`Microburst/Misc/permitations.txt`** kuunda mabadiliko (rahisi sana) kujaribu **kupata akaunti za uhifadhi zilizofunguliwa**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**Shared access signature**_ (SAS) URL ni URL inayotoa **upatikanaji** wa sehemu fulani ya akaunti ya Uhifadhi (inaweza kuwa kontena kamili, faili...) na idhini maalum (kusoma, kuandika...) juu ya rasilimali. Ikiwa unapata moja iliyovuja unaweza kuweza kupata habari nyeti, zinaonekana kama hivi (hii ni kwa kupata kontena, ikiwa ilikuwa tu inatoa upatikanaji kwa faili basi njia ya URL pia itaambatisha faili hiyo):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Tumia [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) kupata data

## Compromise Credentials

### Phishing

* [**Common Phishing**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (idhini au OAuth App -[Illicit Consent Grant Attack](az-illicit-consent-grant.md)-)
* [**Device Code Authentication** Phishing](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## References

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
