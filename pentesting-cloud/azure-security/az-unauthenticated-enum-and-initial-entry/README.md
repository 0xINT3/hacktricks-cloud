# Az - Enumeración no autenticada y entrada inicial

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Inquilino de Azure

### Enumeración de inquilinos

Hay algunas **API públicas de Azure** que, solo conociendo el **dominio del inquilino**, un atacante podría consultar para recopilar más información sobre él.\
Puede consultar directamente la API o utilizar la biblioteca de PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Información                                                                                   | Función AADInternals                             |
| -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Información de inicio de sesión**, incluido el ID del inquilino                                | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos los dominios** del inquilino                                                         | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | **Información de inicio de sesión** del inquilino, incluido el nombre del inquilino y el **tipo de autenticación de dominio** | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Información de inicio de sesión, incluida la **información de SSO de escritorio**               | `Get-AADIntLoginInformation -UserName <UserName>` |

Puede consultar toda la información de un inquilino de Azure con **solo un comando de la** biblioteca [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```

Ejemplo de salida de información del inquilino de Azure:

```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```

A partir de la salida, podemos ver la información del inquilino de la organización objetivo, incluido el nombre del inquilino, el ID y el nombre de la "marca". También podemos ver si se habilitó el **SSO de escritorio (también conocido como** [**SSO sin interrupciones**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**)**. Si está habilitado, podemos averiguar si un usuario determinado existe en la organización objetivo o no (enumeración de usuarios).

También podemos ver los nombres de todos los dominios (verificados) y sus tipos de identidad del inquilino objetivo. Para los dominios federados, también se muestra el FQDN del proveedor de identidad utilizado (generalmente el servidor ADFS). La columna MX indica si el correo electrónico se envía a Exchange en línea o no. La columna SPF indica si Exchange en línea está incluido como remitente de correo electrónico. **¡Nota!** Actualmente, la función de reconocimiento no sigue las declaraciones de inclusión de registros SPF, por lo que puede haber falsos negativos.

### Enumeración de usuarios

Es posible **verificar si un nombre de usuario existe** dentro de un inquilino. Esto también incluye a los **usuarios invitados**, cuyo nombre de usuario tiene el siguiente formato:

```
<email>#EXT#@<tenant name>.onmicrosoft.com
```

El correo electrónico es la dirección de correo electrónico del usuario donde "@" se reemplaza por guión bajo "_".

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), puede verificar fácilmente si el usuario existe o no:

```powershell
# Verificar si el usuario existe
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```

Salida:

```
UserName         Exists
--------         ------
user@company.com True
```

También puede usar un archivo de texto que contenga una dirección de correo electrónico por fila:

```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invocar la enumeración de usuarios
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```

Hay **tres métodos de enumeración diferentes** para elegir:

| Método    | Descripción                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Esto se refiere a la API GetCredentialType mencionada anteriormente.