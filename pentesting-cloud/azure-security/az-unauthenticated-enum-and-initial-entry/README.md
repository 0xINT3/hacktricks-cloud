# Az - Enumera√ß√£o e Entrada Inicial N√£o Autenticada

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Tenant Azure

### Enumera√ß√£o de Tenant

Existem algumas **APIs p√∫blicas do Azure** que, apenas sabendo o **dom√≠nio do tenant**, um atacante poderia consultar para obter mais informa√ß√µes sobre ele.\
Voc√™ pode consultar diretamente a API ou usar a biblioteca PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informa√ß√£o                                                                                   | Fun√ß√£o AADInternals                             |
| -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informa√ß√µes de login**, incluindo o ID do tenant                                           | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Todos os dom√≠nios** do tenant                                                              | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | **Informa√ß√µes de login** do tenant, incluindo o nome do tenant e o **tipo de autentica√ß√£o do dom√≠nio** | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informa√ß√µes de login, incluindo **informa√ß√µes de SSO de desktop**                                      | `Get-AADIntLoginInformation -UserName <UserName>` |

Voc√™ pode consultar todas as informa√ß√µes de um tenant do Azure com **apenas um comando da biblioteca** [**AADInternals**](https://github.com/Gerenios/AADInternals):

```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```

Exemplo de sa√≠da das informa√ß√µes do tenant do Azure:

```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```

A partir da sa√≠da, podemos ver as informa√ß√µes do tenant da organiza√ß√£o de destino, incluindo o nome do tenant, o ID e o nome da "marca". Tamb√©m podemos ver se o **Desktop SSO (tamb√©m conhecido como** [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**) est√° habilitado**. Se habilitado, podemos descobrir se um determinado usu√°rio existe na organiza√ß√£o de destino ou n√£o (enumera√ß√£o de usu√°rio).

Tamb√©m podemos ver os nomes de todos os dom√≠nios (verificados) e seus tipos de identidade do tenant de destino. Para dom√≠nios federados, o FQDN do provedor de identidade usado (geralmente o servidor ADFS) tamb√©m √© mostrado. A coluna MX indica se o e-mail √© enviado para o Exchange online ou n√£o. A coluna SPF indica se o Exchange online est√° listado como remetente de e-mail. **Nota!** Atualmente, a fun√ß√£o de reconhecimento n√£o segue as declara√ß√µes de inclus√£o dos registros SPF, portanto, pode haver falsos negativos.

### Enumera√ß√£o de Usu√°rio

√â poss√≠vel **verificar se um nome de usu√°rio existe** dentro de um tenant. Isso inclui tamb√©m **usu√°rios convidados**, cujo nome de usu√°rio est√° no formato:

```
<email>#EXT#@<tenant name>.onmicrosoft.com
```

O e-mail √© o endere√ßo de e-mail do usu√°rio, onde o "@" √© substitu√≠do pelo sublinhado "_".

Com o [**AADInternals**](https://github.com/Gerenios/AADInternals), voc√™ pode verificar facilmente se o usu√°rio existe ou n√£o:

```powershell
# Verifica se o usu√°rio existe
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```

Sa√≠da:

```
UserName         Exists
--------         ------
user@company.com True
```

Voc√™ tamb√©m pode usar um arquivo de texto contendo um endere√ßo de e-mail por linha:

```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoca a enumera√ß√£o de usu√°rio
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```

Existem **tr√™s m√©todos diferentes de enumera√ß√£o** para escolher:

| M√©todo    | Descri√ß√£o                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Isso se refere √† API GetCredentialType mencionada acima. O m√©todo padr√£o.                                                                                                                           |
| Login     | <p>Este m√©todo tenta fazer login como o usu√°rio.<br><strong>Nota:</strong> as consultas ser√£o registradas no log de logins.</p>