# Az - √ânum√©ration non authentifi√©e et entr√©e initiale

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Locataire Azure

### √ânum√©ration des locataires

Il existe certaines **APIs Azure publiques** qui, en connaissant simplement le **domaine du locataire**, permettent √† un attaquant de recueillir plus d'informations √† son sujet.\
Vous pouvez interroger directement l'API ou utiliser la biblioth√®que PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Information                                                                                                                                                                                                                                           | Fonction AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informations de connexion**, y compris l'ID du locataire                                                                                                                                                                                            | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Tous les domaines** du locataire                                                                                                                                                                                                                    | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informations de connexion</strong> du locataire, y compris le nom du locataire et le domaine <strong>type d'authentification.</strong><br>Si <code>NameSpaceType</code> est <strong><code>Managed</code></strong>, cela signifie que <strong>AzureAD</strong> est utilis√©.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informations de connexion, y compris **les informations SSO de bureau**                                                                                                                                                                                | `Get-AADIntLoginInformation -UserName <UserName>` |

Vous pouvez interroger toutes les informations d'un locataire Azure avec **juste une commande de la biblioth√®que** [**AADInternals**](https://github.com/Gerenios/AADInternals) **:**
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Exemple de sortie des informations du locataire Azure :
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
√Ä partir de la sortie, nous pouvons voir les informations du locataire de l'organisation cible, y compris le nom du locataire, l'identifiant et le nom de la "marque". Nous pouvons √©galement voir **si le Bureau SSO (alias** [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**) est activ√©**. Si activ√©, nous pouvons d√©terminer si un utilisateur donn√© existe dans l'organisation cible ou non (√©num√©ration des utilisateurs).

Nous pouvons √©galement voir les noms de tous les domaines (v√©rifi√©s) et leurs types d'identit√© du locataire cible. Pour les domaines f√©d√©r√©s, le FQDN du fournisseur d'identit√© utilis√© (g√©n√©ralement le serveur ADFS) est √©galement affich√©. La colonne MX indique si l'email est envoy√© √† Exchange en ligne ou non. La colonne SPF indique si Exchange en ligne est r√©pertori√© comme exp√©diteur d'email. **Notez !** Actuellement, la fonction de reconnaissance ne suit pas les instructions include des enregistrements SPF, il peut donc y avoir des faux-n√©gatifs.

### √ânum√©ration des Utilisateurs

Il est possible de **v√©rifier si un nom d'utilisateur existe** dans un locataire. Cela inclut √©galement les **utilisateurs invit√©s**, dont le nom d'utilisateur est au format :
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
L'email est l'adresse email de l'utilisateur o√π le "@" est remplac√© par un tiret bas "\_".

Avec [**AADInternals**](https://github.com/Gerenios/AADInternals), vous pouvez facilement v√©rifier si l'utilisateur existe ou non :
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# √ânum√©ration non authentifi√©e et entr√©e initiale sur Azure

L'√©num√©ration non authentifi√©e sur Azure peut r√©v√©ler des informations pr√©cieuses qui peuvent √™tre utilis√©es pour une entr√©e initiale. Voici quelques techniques:

## √ânum√©ration de stockage Blob Azure

Les blobs Azure sont souvent mal configur√©s et exposent des donn√©es sensibles. Utilisez des outils comme `Azurite` ou `BlobHunter` pour identifier et acc√©der √† des blobs non s√©curis√©s.

## Fuites d'informations via les m√©tadonn√©es

Les m√©tadonn√©es d'instance Azure peuvent fuir des informations telles que les cl√©s d'API et les configurations de s√©curit√©. Utilisez des scripts pour interroger les points de terminaison de m√©tadonn√©es et collecter des informations.

## Sous-domaines Azure et prise de contr√¥le

Des sous-domaines Azure abandonn√©s peuvent √™tre repris pour obtenir un acc√®s initial. Recherchez des sous-domaines orphelins avec des outils comme `Sublist3r` ou `Amass`, puis tentez de les prendre en contr√¥le.

## Exploitation des fonctions Azure

Les fonctions Azure mal s√©curis√©es peuvent √™tre exploit√©es pour ex√©cuter du code arbitraire. Identifiez les fonctions vuln√©rables avec des outils comme `Kudu` ou `Azure-Functions-Pwn`.

## D√©tournement de jetons Azure

Les jetons Azure peuvent √™tre d√©tourn√©s lorsqu'ils sont transmis en clair ou mal g√©r√©s. √âcoutez le trafic r√©seau ou exploitez des vuln√©rabilit√©s pour intercepter et utiliser ces jetons.

## Conclusion

L'√©num√©ration non authentifi√©e est une √©tape cl√© dans le pentesting Azure. Elle peut r√©v√©ler des points d'entr√©e potentiels et des informations critiques pour l'escalade des privil√®ges et d'autres attaques.
```
```
UserName         Exists
--------         ------
user@company.com True
```
Vous pouvez √©galement utiliser un fichier texte contenant une adresse e-mail par ligne :
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Il existe **trois diff√©rentes m√©thodes d'√©num√©ration** parmi lesquelles choisir :

| M√©thode   | Description                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | Cela fait r√©f√©rence √† l'API GetCredentialType mentionn√©e ci-dessus. La m√©thode par d√©faut.                                                                                                              |
| Login     | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur.<br><strong>Note :</strong> les requ√™tes seront enregistr√©es dans le journal des connexions.</p>                                          |
| Autologon | <p>Cette m√©thode tente de se connecter en tant qu'utilisateur via le point de terminaison autologon.<br><strong>Les requ√™tes ne sont pas enregistr√©es</strong> dans le journal des connexions ! De ce fait, elle est √©galement efficace pour les attaques par force brute et par pulv√©risation de mots de passe.</p> |

Apr√®s avoir d√©couvert les noms d'utilisateur valides, vous pouvez obtenir **des informations sur un utilisateur** avec :
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Le script [**o365creeper**](https://github.com/LMGsec/o365creeper) permet √©galement de d√©couvrir **si un e-mail est valide**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Services Azure

Maintenant que nous connaissons les **domaines du locataire Azure** utilis√©s, il est temps d'essayer de trouver des **services Azure expos√©s**.

Vous pouvez utiliser une m√©thode de [**MicroBust**](https://github.com/NetSPI/MicroBurst) pour atteindre cet objectif. Cette fonction recherchera le nom de domaine de base (et quelques permutations) dans plusieurs **domaines de services azure :**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Stockage Ouvert

Vous pourriez d√©couvrir un stockage ouvert avec un outil tel que [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) qui utilisera le fichier **`Microburst/Misc/permitations.txt`** pour g√©n√©rer des permutations (tr√®s simples) afin d'essayer de **trouver des comptes de stockage ouverts**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URLs SAS

Une URL _**signature d'acc√®s partag√©**_ (SAS) est une URL qui **fournit l'acc√®s** √† certaines parties d'un compte de stockage (peut √™tre un conteneur complet, un fichier...) avec des permissions sp√©cifiques (lecture, √©criture...) sur les ressources. Si vous en trouvez une divulgu√©e, vous pourriez √™tre en mesure d'acc√©der √† des informations sensibles, elles ressemblent √† ceci (cela est pour acc√©der √† un conteneur, si cela ne faisait qu'accorder l'acc√®s √† un fichier, le chemin de l'URL contiendrait √©galement ce fichier) :

`https://<nom_du_compte_de_stockage>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Utilisez [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) pour acc√©der aux donn√©es

## Compromission de Credentials

### Phishing

* [**Phishing Commun**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credentials ou OAuth App -[Attaque par Consentement Illicite](az-illicit-consent-grant.md)-)
* [**Phishing d'Authentification par Code de P√©riph√©rique**](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
