# Az - 未经身份验证的枚举和初始入口

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Azure租户

### 租户枚举

有一些**公共Azure API**，只要知道攻击者可以查询的**租户域**，就可以查询更多关于它的信息。\
您可以直接查询API，或使用PowerShell库[**AADInternals**](https://github.com/Gerenios)**:**

| API                                                                  | 信息                                                                                                                                                                                                                                           | AADInternals函数                             |
| -------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **登录信息**，包括租户ID                                                                                                                                                                                                                        | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | 租户的**所有域**                                                                                                                                                                                                                               | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>租户的登录信息</strong>，包括租户名称和域名<strong>身份验证类型。</strong><br>如果<code>NameSpaceType</code>是<strong><code>Managed</code></strong>，则表示使用<strong>AzureAD</strong>。</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | 登录信息，包括**桌面SSO信息**                                                                                                                                                                                                                 | `Get-AADIntLoginInformation -UserName <UserName>` |

您可以使用[**AADInternals**](https://github.com/Gerenios) **库的一个命令查询Azure租户的所有信息**：
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure租户信息的输出示例：
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
可以观察到租户的名称、ID和“品牌”名称。此外，还显示了桌面单点登录（SSO）的状态，也称为[**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)。启用此功能有助于确定目标组织中特定用户的存在（枚举）。

此外，输出显示了与目标租户关联的所有经过验证的域的名称，以及它们各自的身份类型。对于联合域，还披露了正在使用的身份提供者的完全限定域名（FQDN），通常是一个ADFS服务器。"MX"列指定电子邮件是否路由到Exchange Online，而"SPF"列表示Exchange Online作为电子邮件发件人的列表。值得注意的是，当前的侦察功能不解析SPF记录中的“include”语句，这可能导致误报。

### 用户枚举

可以**检查用户名是否存在**在租户内。这也包括**访客用户**，其用户名格式为：
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
邮箱是用户的电子邮件地址，在“@”处用下划线“\_”替换。

使用[**AADInternals**](https://github.com/Gerenios/AADInternals)，您可以轻松地检查用户是否存在：
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
## 未经身份验证的枚举和初始入口

在进行云渗透测试时，未经身份验证的枚举和初始入口是一个重要的步骤。这些技术可以帮助鉴定目标系统中的弱点和潜在的入口点，为后续的攻击和渗透测试做准备。

### 未经身份验证的枚举

在进行未经身份验证的枚举时，渗透测试人员通常会尝试访问目标系统的公开资源和信息，以发现可能存在的安全漏洞。这可能涉及到查找公开可访问的存储桶、数据库、日志文件、配置文件等敏感信息。

### 初始入口

通过未经身份验证的枚举，渗透测试人员可能会发现一些初始入口点，如弱密码、未经身份验证的API端点、未经身份验证的管理界面等。利用这些初始入口点，攻击者可以进一步深入系统，获取更多权限并执行更高级的攻击。

在进行云渗透测试时，重要的是要全面而系统地进行未经身份验证的枚举，以发现潜在的安全风险并及时加以修复。
```
UserName         Exists
--------         ------
user@company.com True
```
您还可以使用一个每行包含一个电子邮件地址的文本文件：
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
有**三种不同的枚举方法**可供选择：

| 方法      | 描述                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 正常     | 这是指上面提到的GetCredentialType API。默认方法。                                                                                                                           |
| 登录     | <p>此方法尝试以用户身份登录。<br><strong>注意：</strong>查询将记录在登录日志中。</p>                                                                                       |
| 自动登录 | <p>此方法尝试通过自动登录端点以用户身份登录。<br><strong>查询不会被记录</strong>在登录日志中！因此，也适用于密码喷洒和暴力攻击。</p> |

发现有效用户名后，您可以使用以下方式获取**有关用户的信息**：
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
该脚本 [**o365creeper**](https://github.com/LMGsec/o365creeper) 也允许您发现**电子邮件是否有效**。
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**通过 Microsoft Teams 进行用户枚举**

另一个信息来源是 Microsoft Teams。

Microsoft Teams 的 API 允许搜索用户。特别是 "user search" 端点 **externalsearchv3** 和 **searchUsers** 可以用于请求有关已注册 Teams 用户帐户的一般信息。

根据 API 响应，可以区分不存在的用户和具有有效 Teams 订阅的现有用户。

脚本 [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) 可用于验证一组给定的用户名是否与 Teams API 匹配。
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
## 未经身份验证的枚举和初始入口

在Azure中，有一些公开可用的终结点，可以在未经身份验证的情况下进行枚举。这些终结点可能包含有关Azure资源的敏感信息，如存储帐户、数据库等。黑客可以利用这些信息来发起更深入的攻击。

### 枚举服务

1. **Azure Blob 存储服务**：可以通过公共Blob存储帐户的URL进行访问，如果未正确配置访问权限，黑客可以枚举存储桶中的文件。
   
2. **Azure Cosmos DB**：可以通过公共Cosmos DB帐户的URL进行访问，如果未正确配置访问权限，黑客可以枚举数据库中的数据。

### 初始入口

1. **未经身份验证的访问**：黑客可以尝试使用公开可用的终结点，如Azure Blob存储或Cosmos DB，来获取未经身份验证的访问。这为黑客提供了进一步探索Azure环境的机会。

2. **信息收集**：黑客可以收集有关Azure资源的信息，如存储桶、数据库等，为后续攻击做准备。

3. **潜在风险**：未经身份验证的枚举和初始入口可能导致敏感数据泄露和进一步的权限提升攻击。因此，组织应该确保正确配置其Azure资源的访问权限，以防止此类攻击。
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
此外，还可以枚举现有用户的可用性信息，如下所示：

- 可用
- 离开
- 请勿打扰
- 忙碌
- 离线

如果配置了**外出办公留言**，也可以使用 TeamsEnum 检索留言。如果指定了输出文件，则外出办公留言会自动存储在 JSON 文件中：
```
jq . teamsenum-output.json
```
## 未经身份验证的枚举和初始入口

在进行云安全渗透测试时，未经身份验证的枚举和初始入口是一个重要的步骤。通过此过程，黑客可以发现目标系统中的敏感信息和潜在的漏洞，为进一步入侵提供可能性。

### 枚举服务

1. **Azure Blob 存储服务**：使用工具如 `azcopy` 或 `Azure Storage Explorer` 枚举 Blob 存储中的文件和文件夹。
2. **Azure 文件存储服务**：使用 SMB 客户端枚举文件共享中的文件和目录。
3. **Azure 表存储服务**：使用工具如 `Azure Storage Explorer` 或 `Azure CLI` 枚举表存储中的数据。
4. **Azure Cosmos DB**：使用工具如 `Cosmos DB Explorer` 或 `NoSQLBooster` 枚举 Cosmos DB 中的数据。
5. **Azure Key Vault**：使用 `Azure CLI` 或 `Azure PowerShell` 枚举密钥和机密。
6. **Azure Functions**：使用工具如 `Azure Portal` 或 `Azure CLI` 枚举 Azure Functions 中的函数和代码。

### 初始入口

1. **未经身份验证的存储桶访问**：尝试访问未经身份验证的 Azure 存储桶以获取敏感数据。
2. **未经身份验证的数据库访问**：尝试通过未经身份验证的连接字符串访问 Azure 数据库。
3. **未经身份验证的 API 访问**：尝试通过未经身份验证的 API 终端点访问 Azure 服务。
4. **未经身份验证的函数调用**：尝试调用未经身份验证的 Azure Functions 以执行恶意操作。

通过执行这些步骤，黑客可以识别目标系统中的弱点，并利用它们获取对系统的未经授权访问。
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Azure 服务

现在我们知道 Azure 租户正在使用的**域**，是时候尝试找到**暴露的 Azure 服务**了。

您可以使用[**MicroBust**](https://github.com/NetSPI/MicroBurst)中的一种方法来实现这个目标。此功能将在几个**Azure 服务域**中搜索基本域名（以及一些排列组合）。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## 开放存储

您可以使用诸如[**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1)之类的工具，该工具将使用文件**`Microburst/Misc/permitations.txt`**生成排列组合（非常简单），以尝试**查找开放的存储账户**。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

一个**共享访问签名**（SAS）URL是一个URL，**提供对**存储账户的某个部分的访问权限（可以是完整容器、文件...），具有一些特定权限（读取、写入...）来访问资源。如果发现泄漏了一个，您可能能够访问敏感信息，它们看起来像这样（这是用于访问容器的，如果只是授予对文件的访问权限，URL的路径也将包含该文件）：

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

使用[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)来访问数据

## 危害凭证

### 钓鱼

* [**常见钓鱼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（凭证或OAuth应用 -[非法同意授予攻击](az-illicit-consent-grant.md)-）
* [**设备代码认证** 钓鱼](az-device-code-authentication-phishing.md)

### 密码喷洒 / 暴力破解

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## 参考资料

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
