# Az - 인증되지 않은 열거 및 초기 진입

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## Azure 테넌트

### 테넌트 열거

**테넌트의 도메인**만 알고 있다면 공개 Azure API를 사용하여 추가 정보를 수집할 수 있습니다.\
API를 직접 쿼리하거나 PowerShell 라이브러리 [**AADInternals**](https://github.com/Gerenios/AADInternals)를 사용할 수 있습니다.

| API                                                                  | 정보                                                                                                                                                                                                                                                  | AADInternals 함수                                |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | 테넌트 ID를 포함한 **로그인 정보**                                                                                                                                                                                                                   | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | 테넌트의 **모든 도메인**                                                                                                                                                                                                                              | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p>테넌트의 **로그인 정보**, 테넌트 이름 및 도메인 <strong>인증 유형</strong>을 포함합니다.<br><code>NameSpaceType</code>이 <strong><code>Managed</code></strong>인 경우 <strong>AzureAD</strong>가 사용됩니다.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | **데스크톱 SSO 정보**를 포함한 로그인 정보                                                                                                                                                                                                            | `Get-AADIntLoginInformation -UserName <UserName>` |

**AADInternals** 라이브러리의 **한 명령어로 Azure 테넌트의 모든 정보를 쿼리**할 수 있습니다.
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure 테넌트 정보의 출력 예시:

```plaintext
Tenant ID: 12345678-1234-1234-1234-1234567890ab
Tenant Name: MyAzureTenant
Tenant Domain: myazuretenant.onmicrosoft.com
```

Azure 테넌트 정보의 출력 예시: 

```plaintext
테넌트 ID: 12345678-1234-1234-1234-1234567890ab
테넌트 이름: MyAzureTenant
테넌트 도메인: myazuretenant.onmicrosoft.com
```
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
테넌트의 이름, ID 및 "브랜드" 이름에 대한 세부 정보를 확인할 수 있습니다. 또한 데스크톱 단일 로그인(SSO) 또는 [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)라고도 알려진 상태도 표시됩니다. 이 기능이 활성화되면 해당 기능을 사용하여 대상 조직 내에서 특정 사용자의 존재(열거)를 확인할 수 있습니다.

또한 출력에는 대상 테넌트와 관련된 모든 확인된 도메인의 이름과 해당 식별 유형도 표시됩니다. 페더레이션 도메인의 경우 일반적으로 ADFS 서버와 같은 사용자 식별 공급자의 완전한 정규 도메인 이름(FQDN)도 공개됩니다. "MX" 열은 이메일이 Exchange Online으로 라우팅되는지 여부를 지정하고, "SPF" 열은 Exchange Online이 이메일 발신자로 나열되어 있는지를 나타냅니다. 현재의 정찰 기능은 SPF 레코드 내의 "include" 문을 구문 분석하지 않으므로 잘못된 부정적인 결과가 발생할 수 있음에 유의해야 합니다.

### 사용자 열거

테넌트 내에서 **사용자 이름이 존재하는지 확인**할 수 있습니다. 이는 **게스트 사용자**의 경우에도 해당되며, 게스트 사용자의 사용자 이름 형식은 다음과 같습니다:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
이메일은 사용자의 이메일 주소이며, "@"가 언더스코어 "_"로 대체되었습니다.

[**AADInternals**](https://github.com/Gerenios/AADInternals)를 사용하면 사용자가 존재하는지 여부를 쉽게 확인할 수 있습니다:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Azure Security - 인증되지 않은 열거 및 초기 진입

이 문서는 Azure 클라우드 환경에서 인증되지 않은 열거 및 초기 진입에 대한 정보를 제공합니다. 이러한 기술은 Azure 환경에서 펜테스팅을 수행하는 과정에서 유용합니다.

## 1. 인증되지 않은 열거

Azure 환경에서 인증되지 않은 열거를 수행하는 방법에는 다음과 같은 기술이 있습니다.

### 1.1. Azure AD 인증되지 않은 열거

Azure AD 인증되지 않은 열거는 다음과 같은 기술을 사용하여 수행할 수 있습니다.

- **Azure AD 인증되지 않은 사용자 목록 노출**: Azure AD에서 인증되지 않은 사용자의 목록을 노출할 수 있습니다. 이를 통해 공격자는 사용자 계정을 식별하고 대상으로 선택할 수 있습니다.

- **Azure AD 인증되지 않은 그룹 목록 노출**: Azure AD에서 인증되지 않은 그룹의 목록을 노출할 수 있습니다. 이를 통해 공격자는 그룹 구조를 파악하고 대상으로 선택할 수 있습니다.

### 1.2. Azure 리소스 인증되지 않은 열거

Azure 리소스 인증되지 않은 열거는 다음과 같은 기술을 사용하여 수행할 수 있습니다.

- **Azure 리소스 인증되지 않은 엔드포인트 노출**: Azure 리소스의 인증되지 않은 엔드포인트를 노출할 수 있습니다. 이를 통해 공격자는 리소스에 대한 액세스를 시도할 수 있습니다.

- **Azure 리소스 인증되지 않은 서비스 목록 노출**: Azure 리소스의 인증되지 않은 서비스 목록을 노출할 수 있습니다. 이를 통해 공격자는 취약한 서비스를 식별하고 대상으로 선택할 수 있습니다.

## 2. 초기 진입

Azure 환경에서 초기 진입을 수행하는 방법에는 다음과 같은 기술이 있습니다.

### 2.1. Azure AD 초기 진입

Azure AD 초기 진입은 다음과 같은 기술을 사용하여 수행할 수 있습니다.

- **Azure AD 악용**: Azure AD의 취약점을 악용하여 초기 진입을 수행할 수 있습니다. 이를 통해 공격자는 Azure AD에 대한 권한을 획득하고 추가적인 공격을 수행할 수 있습니다.

### 2.2. Azure 리소스 초기 진입

Azure 리소스 초기 진입은 다음과 같은 기술을 사용하여 수행할 수 있습니다.

- **Azure 리소스 악용**: Azure 리소스의 취약점을 악용하여 초기 진입을 수행할 수 있습니다. 이를 통해 공격자는 리소스에 대한 권한을 획득하고 추가적인 공격을 수행할 수 있습니다.

- **Azure 리소스 미구성**: Azure 리소스의 부적절한 구성을 이용하여 초기 진입을 수행할 수 있습니다. 이를 통해 공격자는 리소스에 대한 액세스를 얻을 수 있습니다.

이 문서에서는 Azure 환경에서 인증되지 않은 열거 및 초기 진입에 대한 기술을 설명했습니다. 이러한 기술을 사용하여 Azure 환경의 보안 취약점을 식별하고 대응할 수 있습니다.
```
UserName         Exists
--------         ------
user@company.com True
```
당신은 또한 한 줄에 하나의 이메일 주소가 있는 텍스트 파일을 사용할 수 있습니다:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
**세 가지 다른 열거 방법** 중에서 선택할 수 있습니다:

| 방법       | 설명                                                                                                                                                                                                 |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | 위에서 언급한 GetCredentialType API를 의미합니다. 기본 방법입니다.                                                                                                                           |
| Login     | <p>이 방법은 사용자로서 로그인을 시도합니다.<br><strong>참고:</strong> 쿼리는 로그인 로그에 기록됩니다.</p>                                                                                       |
| Autologon | <p>이 방법은 사용자로서 autologon 엔드포인트를 통해 로그인을 시도합니다.<br><strong>쿼리는 로그인 로그에 기록되지 않습니다</strong>! 따라서, 패스워드 스프레이 및 브루트포스 공격에도 잘 작동합니다.</p> |

유효한 사용자 이름을 발견한 후에는 다음과 같이 **사용자에 대한 정보**를 얻을 수 있습니다:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
스크립트 [**o365creeper**](https://github.com/LMGsec/o365creeper)은 또한 **이메일이 유효한지 여부를 확인**할 수 있도록 해줍니다.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure 서비스

Azure 테넌트가 사용하는 **도메인을 알았으니**, 이제 **노출된 Azure 서비스를 찾아보는 것**이 필요합니다.

이를 위해 [**MicroBurst**](https://github.com/NetSPI/MicroBurst)에서 제공하는 방법을 사용할 수 있습니다. 이 함수는 **여러 Azure 서비스 도메인**에서 기본 도메인 이름과 몇 가지 변형을 검색할 것입니다:
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## 오픈 스토리지

[**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1)와 같은 도구를 사용하여 오픈 스토리지를 발견할 수 있습니다. 이 도구는 파일 **`Microburst/Misc/permitations.txt`**을 사용하여 간단한 순열을 생성하여 **오픈 스토리지 계정을 찾으려고 시도**합니다.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**공유 액세스 서명(SAS) URL**_은 특정 Storage 계정의 일부 (전체 컨테이너, 파일 등)에 대한 액세스를 제공하는 URL입니다. 이 URL은 리소스에 대한 특정 권한 (읽기, 쓰기 등)을 가지고 있습니다. 유출된 URL을 찾으면 민감한 정보에 액세스할 수 있습니다. URL은 다음과 같이 구성됩니다 (이 예시는 컨테이너에 액세스하기 위한 것이며, 파일에 대한 액세스를 허용하는 경우 URL 경로에 해당 파일도 포함됩니다):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

데이터에 액세스하기 위해 [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)를 사용하세요.

## 자격 증명 탈취

### 피싱

* [**일반적인 피싱**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (자격 증명 또는 OAuth 앱 -[부정한 동의 부여 공격](az-illicit-consent-grant.md)-)
* [**Device Code Authentication** 피싱](az-device-code-authentication-phishing.md)

### 패스워드 스프레이 / 브루트 포스

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## 참고 자료

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
