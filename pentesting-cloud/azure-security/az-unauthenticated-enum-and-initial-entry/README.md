# Az - Enumerazione non autenticata e Accesso Iniziale

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**Gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Tenant Azure

### Enumerazione del Tenant

Ci sono alcune **API pubbliche di Azure** che, conoscendo solo il **dominio del tenant**, un attaccante potrebbe interrogare per raccogliere ulteriori informazioni su di esso.\
Puoi interrogare direttamente l'API o utilizzare la libreria PowerShell [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | Informazioni                                                                                                                                                                                                                                           | Funzione AADInternals                             |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **Informazioni di accesso**, inclusa l'ID del tenant                                                                                                                                                                                                    | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **Tutti i domini** del tenant                                                                                                                                                                                                                         | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>Informazioni di accesso</strong> del tenant, inclusi il nome del tenant e il dominio del <strong>tipo di autenticazione.</strong><br>Se <code>NameSpaceType</code> √® <strong><code>Managed</code></strong>, significa che viene utilizzato <strong>AzureAD</strong>.</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | Informazioni di accesso, inclusi **informazioni sul Desktop SSO**                                                                                                                                                                                       | `Get-AADIntLoginInformation -UserName <UserName>` |

Puoi interrogare tutte le informazioni di un tenant Azure con **solo un comando della** [**libreria AADInternals**](https://github.com/Gerenios/AADInternals):
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Esempio di output delle informazioni del tenant Azure:
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          1937e3ab-38de-a735-a830-3075ea7e5b39
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
√à possibile osservare dettagli sul nome del tenant, l'ID e il nome "brand". Inoltre, lo stato del Desktop Single Sign-On (SSO), noto anche come [**Seamless SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso), viene visualizzato. Quando abilitata, questa funzionalit√† facilita la determinazione della presenza (enumerazione) di un utente specifico all'interno dell'organizzazione target.

Inoltre, l'output presenta i nomi di tutti i domini verificati associati al tenant target, insieme ai rispettivi tipi di identit√†. Nel caso dei domini federati, viene anche rivelato il Fully Qualified Domain Name (FQDN) del provider di identit√† in uso, tipicamente un server ADFS. La colonna "MX" specifica se le email vengono instradate verso Exchange Online, mentre la colonna "SPF" indica l'elenco di Exchange Online come mittente di email. √à importante notare che la funzione corrente di ricognizione non analizza le dichiarazioni "include" all'interno dei record SPF, il che potrebbe causare falsi negativi.

### Enumerazione degli Utenti

√à possibile **verificare se esiste un nome utente** all'interno di un tenant. Questo include anche gli **utenti ospiti**, il cui nome utente √® nel formato:
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
L'email √® l'indirizzo email dell'utente in cui il simbolo "@" √® sostituito con l'underscore "\_".

Con [**AADInternals**](https://github.com/Gerenios/AADInternals), puoi facilmente verificare se l'utente esiste o meno:
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
# Enumerazione non autenticata e accesso iniziale

Durante un test di penetrazione, la fase di enumerazione non autenticata √® fondamentale per identificare informazioni sensibili e punti di accesso potenziali nel sistema target. Questa fase pu√≤ includere la raccolta di informazioni come elenchi di risorse, configurazioni di servizi, versioni di software e altro ancora.

## Strumenti e tecniche
Alcuni strumenti comuni utilizzati per l'enumerazione non autenticata includono **Nmap**, **Dirb**, **Gobuster** e **Enum4linux**. Questi strumenti possono aiutare a raccogliere informazioni utili senza la necessit√† di autenticazione.

## Accesso iniziale
Una volta identificate le informazioni sensibili durante l'enumerazione non autenticata, √® possibile utilizzarle per ottenere un accesso iniziale al sistema target. Questo pu√≤ includere l'utilizzo di vulnerabilit√† note, configurazioni non sicure o altre tecniche per ottenere l'accesso al sistema senza la necessit√† di credenziali valide.

Ricorda sempre di ottenere l'autorizzazione esplicita prima di condurre test di penetrazione su qualsiasi sistema o rete.
```
UserName         Exists
--------         ------
user@company.com True
```
Puoi anche utilizzare un file di testo contenente un indirizzo email per riga:
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
Ci sono **tre diversi metodi di enumerazione** tra cui scegliere:

| Metodo    | Descrizione                                                                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normale   | Questo si riferisce all'API GetCredentialType menzionata sopra. Il metodo predefinito.                                                                                                                    |
| Login     | <p>Questo metodo cerca di effettuare l'accesso come utente.<br><strong>Nota:</strong> le query verranno registrate nel log degli accessi.</p>                                                             |
| Autologon | <p>Questo metodo cerca di effettuare l'accesso come utente tramite il punto di accesso autologon.<br><strong>Le query non vengono registrate</strong> nel log degli accessi! Pertanto, funziona bene anche per attacchi di password spray e forza bruta.</p> |

Dopo aver scoperto i nomi utente validi √® possibile ottenere **informazioni su un utente** con:
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
Lo script [**o365creeper**](https://github.com/LMGsec/o365creeper) ti permette anche di scoprire **se un'email √® valida**.
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
**Enumerazione degli utenti tramite Microsoft Teams**

Un'altra buona fonte di informazioni √® Microsoft Teams.

L'API di Microsoft Teams consente di cercare gli utenti. In particolare, i punti finali "user search" **externalsearchv3** e **searchUsers** potrebbero essere utilizzati per richiedere informazioni generali sugli account utente iscritti a Teams.

In base alla risposta dell'API √® possibile distinguere tra utenti inesistenti e utenti esistenti che hanno una sottoscrizione Teams valida.

Lo script [**TeamsEnum**](https://github.com/sse-secure-systems/TeamsEnum) potrebbe essere utilizzato per convalidare un dato insieme di nomi utente rispetto all'API di Teams.
```bash
python3 TeamsEnum.py -a password -u <username> -f inputlist.txt -o teamsenum-output.json
```
# Enumerazione non autenticata e accesso iniziale

Durante un test di penetrazione, la fase di enumerazione non autenticata √® spesso la prima fase in cui un attaccante cerca di raccogliere informazioni su un obiettivo senza la necessit√† di autenticarsi. Questo pu√≤ includere la raccolta di informazioni su servizi esposti, configurazioni errate, versioni di software non patchate e altro ancora.

## Strumenti e tecniche

Alcuni strumenti comuni utilizzati per l'enumerazione non autenticata includono **Nmap**, **Dirb**, **Gobuster** e **Wfuzz**. Questi strumenti possono aiutare a identificare servizi aperti, directory nascoste, file sensibili e altre informazioni utili per l'attaccante.

## Accesso iniziale

Una volta completata l'enumerazione non autenticata, l'attaccante pu√≤ utilizzare le informazioni raccolte per tentare di ottenere un accesso iniziale al sistema di destinazione. Questo potrebbe includere l'utilizzo di vulnerabilit√† note, attacchi di forza bruta, exploit di applicazioni web e altre tecniche per compromettere la sicurezza del sistema.

√à importante condurre queste attivit√† con il permesso esplicito del proprietario del sistema e nel rispetto delle leggi sulla sicurezza informatica.
```
[-] user1@domain - Target user not found. Either the user does not exist, is not Teams-enrolled or is configured to not appear in search results (personal accounts only)
[+] user2@domain - User2 | Company (Away, Mobile)
[+] user3@domain - User3 | Company (Available, Desktop)
```
Inoltre √® possibile enumerare le informazioni sulla disponibilit√† degli utenti esistenti come segue:

- Disponibile
- Assente
- Non disturbare
- Occupato
- Offline

Se √® configurato un **messaggio di fuori sede**, √® anche possibile recuperare il messaggio utilizzando TeamsEnum. Se √® stato specificato un file di output, i messaggi di fuori sede vengono automaticamente memorizzati all'interno del file JSON:
```
jq . teamsenum-output.json
```
# Enumerazione non autenticata e accesso iniziale

Durante un test di penetrazione, la fase di enumerazione non autenticata √® cruciale per identificare informazioni sensibili e punti di accesso potenziali nel sistema target. Questa fase pu√≤ includere la raccolta di informazioni tramite ricerche su motori di ricerca, esplorazione di repository pubblici, analisi di documenti esposti e altro ancora.

## Ricerca di informazioni sensibili

Durante la fase di enumerazione non autenticata, √® possibile cercare informazioni sensibili come credenziali, chiavi API, stringhe di connessione al database e altro ancora. Queste informazioni possono essere trovate in file di configurazione, repository pubblici, documenti esposti e altri luoghi accessibili senza autenticazione.

## Identificazione dei punti di accesso potenziali

Oltre alla ricerca di informazioni sensibili, la fase di enumerazione non autenticata pu√≤ aiutare a identificare potenziali punti di accesso al sistema target. Ci√≤ potrebbe includere endpoint API non protetti, interfacce di amministrazione non autenticate, servizi esposti e altro ancora.

## Approcci per l'enumerazione non autenticata

Gli approcci per l'enumerazione non autenticata possono variare a seconda del sistema target e delle informazioni disponibili. Tuttavia, √® importante condurre ricerche approfondite e sfruttare al meglio le informazioni raccolte per identificare potenziali vulnerabilit√† e punti di accesso nel sistema target.
```json
{
"email": "user2@domain",
"exists": true,
"info": [
{
"tenantId": "[REDACTED]",
"isShortProfile": false,
"accountEnabled": true,
"featureSettings": {
"coExistenceMode": "TeamsOnly"
},
"userPrincipalName": "user2@domain",
"givenName": "user2@domain",
"surname": "",
"email": "user2@domain",
"tenantName": "Company",
"displayName": "User2",
"type": "Federated",
"mri": "8:orgid:[REDACTED]",
"objectId": "[REDACTED]"
}
],
"presence": [
{
"mri": "8:orgid:[REDACTED]",
"presence": {
"sourceNetwork": "Federated",
"calendarData": {
"outOfOfficeNote": {
"message": "Dear sender. I am out of the office until March 23rd with limited access to my email. I will respond after my return.Kind regards, User2",
"publishTime": "2023-03-15T21:44:42.0649385Z",
"expiry": "2023-04-05T14:00:00Z"
},
"isOutOfOffice": true
},
"capabilities": [
"Audio",
"Video"
],
"availability": "Away",
"activity": "Away",
"deviceType": "Mobile"
},
"etagMatch": false,
"etag": "[REDACTED]",
"status": 20000
}
]
}
```
## Servizi Azure

Ora che conosciamo i **domini utilizzati dal tenant Azure** √® il momento di cercare i **servizi Azure esposti**.

Puoi utilizzare un metodo da [**MicroBust**](https://github.com/NetSPI/MicroBurst) per raggiungere questo obiettivo. Questa funzione cercher√† il nome di dominio di base (e alcune permutazioni) in diversi **domini di servizio Azure:**
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## Archiviazione Aperta

Potresti scoprire archiviazioni aperte con uno strumento come [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) che utilizzer√† il file **`Microburst/Misc/permitations.txt`** per generare permutazioni (molto semplici) per cercare di **trovare account di archiviazione aperti**.
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### URL SAS

Un _**shared access signature**_ (SAS) URL √® un URL che **fornisce accesso** a una determinata parte di un account di archiviazione (potrebbe essere un intero contenitore, un file...) con specifici permessi (lettura, scrittura...) sulle risorse. Se ne trovi uno esposto potresti essere in grado di accedere a informazioni sensibili, hanno questo aspetto (questo √® per accedere a un contenitore, se stesse concedendo l'accesso a un file, il percorso dell'URL conterr√† anche quel file):

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

Usa [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) per accedere ai dati

## Compromissione delle credenziali

### Phishing

* [**Phishing Comune**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenziali o App OAuth -[Attacco Illecito di Concessione di Consenso](az-illicit-consent-grant.md)-)
* [**Phishing con Autenticazione tramite Codice Dispositivo**](az-device-code-authentication-phishing.md)

### Password Spraying / Brute-Force

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## Riferimenti

* [https://aadinternals.com/post/just-looking/](https://aadinternals.com/post/just-looking/)
* [https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/](https://www.securesystems.de/blog/a-fresh-look-at-user-enumeration-in-microsoft-teams/)

<details>

<summary><strong>Impara l'hacking su AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
