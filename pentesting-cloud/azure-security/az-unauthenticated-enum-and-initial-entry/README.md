# Az - 未经认证的枚举与初始入口

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## Azure租户

### 租户枚举

有一些**公共Azure API**，只需知道**租户的域名**，攻击者就可以查询以收集更多关于它的信息。\
您可以直接查询API或使用PowerShell库 [**AADInternals**](https://github.com/Gerenios/AADInternals)**：**

| API                                                                  | 信息                                                                                                                                                                                                                                                  | AADInternals函数                                  |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **登录信息**，包括租户ID                                                                                                                                                                                                                              | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **租户的所有域名**                                                                                                                                                                                                                                    | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | <p><strong>租户的登录信息</strong>，包括租户名称和域名<strong>认证类型。</strong><br>如果<code>NameSpaceType</code>是<strong><code>Managed</code></strong>，这意味着使用了<strong>AzureAD</strong>。</p> | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | 登录信息，包括**桌面SSO信息**                                                                                                                                                                                                                         | `Get-AADIntLoginInformation -UserName <UserName>` |

您可以使用[**AADInternals**](https://github.com/Gerenios/AADInternals) **库的仅一个命令**查询Azure租户的所有信息：
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
输出示例：Azure 租户信息：
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
从输出中我们可以看到目标组织的租户信息，包括租户名称、ID和“品牌”名称。我们还可以看到**桌面单点登录（又名**[**无缝 SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**）是否启用**。如果启用，我们可以找出目标组织中是否存在给定用户（用户枚举）。

我们还可以看到目标租户的所有（已验证）域名及其身份类型。对于联合域，还会显示所使用的身份提供者（通常是 ADFS 服务器）的 FQDN。MX 列指示电子邮件是否发送到 Exchange Online。SPF 列指示 Exchange Online 是否列为电子邮件发送者。**注意！**目前，侦察功能不遵循 SPF 记录的 include 语句，因此可能会有误报。

### 用户枚举

可以**检查租户内是否存在用户名**。这也包括**访客用户**，其用户名格式为：
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
电子邮件是用户的电子邮件地址，其中的“@”被下划线“\_”替换。

使用 [**AADInternals**](https://github.com/Gerenios/AADInternals)，您可以轻松检查用户是否存在：
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# Azure 未经认证的枚举和初始入口

在对Azure环境进行渗透测试时，初始信息收集是关键步骤。这通常涉及到未经认证的枚举，即在不拥有有效凭证的情况下收集尽可能多的信息。

## 枚举Azure服务

Azure提供了多种服务，每种服务都可能泄露有价值的信息。以下是一些常见服务及其潜在的信息泄露风险：

- **Azure Blob Storage**：可能包含敏感数据，如果配置不当，可能会公开访问。
- **Azure Virtual Machines**：可以通过其元数据服务泄露VM实例详细信息。
- **Azure Kubernetes Service (AKS)**：可能泄露配置信息，包括API服务器的地址。

## 初始入口点

确定潜在的初始入口点是成功渗透的关键。以下是一些可能的入口点：

- 公开的Azure Blob存储容器
- 未经保护的Azure VM的元数据服务
- 暴露的AKS API服务器

## 工具和技术

渗透测试人员可以使用各种工具和技术来执行未经认证的枚举，例如：

- 使用自定义脚本来发现和枚举Azure服务。
- 利用公开的API和端点进行信息收集。
- 使用专门的渗透测试工具，如`MicroBurst`。

## 结论

未经认证的枚举是Azure渗透测试的重要组成部分。通过识别和利用信息泄露，渗透测试人员可以为进一步的攻击行动找到初始入口点。
```
```
UserName         Exists
--------         ------
user@company.com True
```
你也可以使用一个文本文件，每行包含一个电子邮件地址：
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
有**三种不同的枚举方法**可供选择：

| 方法       | 描述                                                                                                                                                                                                     |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal     | 这指的是上面提到的 GetCredentialType API。默认方法。                                                                                                                                                     |
| Login      | <p>此方法尝试以用户身份登录。<br><strong>注意：</strong>查询将记录到登录日志中。</p>                                                                                                                      |
| Autologon  | <p>此方法尝试通过自动登录端点以用户身份登录。<br><strong>查询不会被记录</strong>到登录日志中！因此，也适用于密码喷涂和暴力破解攻击。</p>                                                                 |

在发现有效的用户名后，你可以获取**用户的信息**：
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
脚本 [**o365creeper**](https://github.com/LMGsec/o365creeper) 也允许您发现**如果一个电子邮件是有效的**。
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure 服务

现在我们知道了**Azure 租户**正在使用的**域名**，是时候尝试找到**暴露的 Azure 服务**了。

你可以使用 [**MicroBust**](https://github.com/NetSPI/MicroBurst) 中的一个方法来实现这个目标。这个函数将在几个**azure 服务域名**中搜索基础域名（以及一些变体）：
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## 开放存储

您可以使用像 [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) 这样的工具来发现开放存储，它将使用文件 **`Microburst/Misc/permitations.txt`** 生成排列（非常简单），以尝试**找到开放的存储账户**。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**共享访问签名**_（SAS）URL 是一个提供对存储帐户某部分访问权限的 URL（可以是完整的容器、文件等），具有对资源的特定权限（读、写等）。如果你发现一个泄露的 SAS URL，你可能能够访问敏感信息，它们看起来像这样（这是用来访问容器的，如果它只是授予对文件的访问权限，URL 的路径还会包含该文件）：

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

使用 [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) 来访问数据

## 妥协凭证

### 钓鱼攻击

* [**常见钓鱼攻击**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（凭证或 OAuth 应用程序 -[非法同意授权攻击](az-illicit-consent-grant.md)-）
* [**设备代码认证** 钓鱼攻击](az-device-code-authentication-phishing.md)

### 密码喷涂 / 暴力破解

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## 参考资料

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>从零开始学习 AWS 黑客攻击成为英雄，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

其他支持 HackTricks 的方式：

* 如果你想在 HackTricks 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。

</details>
