# Az - 未经身份验证的枚举和初始入口

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## Azure 租户

### 租户枚举

有一些**公共 Azure API**，只要知道**租户的域名**，攻击者就可以查询更多关于租户的信息。\
您可以直接查询 API 或使用 PowerShell 库 [**AADInternals**](https://github.com/Gerenios/AADInternals)**:**

| API                                                                  | 信息                                                                                         | AADInternals 函数                                 |
| -------------------------------------------------------------------- | -------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **登录信息**，包括租户 ID                                                                   | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover.s.outlook.com/autodiscover/autodiscover.svc             | 租户的**所有域名**                                                                             | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | 租户的**登录信息**，包括租户名称和域名**身份验证类型**                                         | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | 登录信息，包括**桌面 SSO 信息**                                                              | `Get-AADIntLoginInformation -UserName <UserName>` |

您可以使用 [**AADInternals**](https://github.com/Gerenios/AADInternals) **库的一个命令**查询 Azure 租户的所有信息：
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure租户信息的输出示例：

```plaintext
Tenant ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
Tenant Name: My Azure Tenant
```

```plaintext
租户ID：xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
租户名称：我的Azure租户
```
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
从输出中，我们可以看到目标组织的租户信息，包括租户名称、ID和“品牌”名称。我们还可以看到**是否启用了桌面SSO（也称为**[**无缝SSO**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**）**。如果启用了，我们可以确定给定的用户是否存在于目标组织中（用户枚举）。

我们还可以看到目标租户的所有（已验证）域的名称和身份类型。对于联合域，还显示了所使用身份提供者的FQDN（通常是ADFS服务器）。MX列指示邮件是否发送到Exchange Online。SPF列指示Exchange Online是否被列为邮件发送者。**注意！**目前，recon函数不会遵循SPF记录的include语句，因此可能会有误报。

### 用户枚举

可以**检查用户名是否存在**于租户中。这也包括**访客用户**，其用户名的格式为：
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
电子邮件是用户的电子邮件地址，其中“@”被下划线“\_”替换。

使用[**AADInternals**](https://github.com/Gerenios/AADInternals)，您可以轻松地检查用户是否存在：
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
以下是关于黑客技术的一本书中的内容。以下内容来自文件/hive/hacktricks-cloud/pentesting-cloud/azure-security/az-unauthenticated-enum-and-initial-entry/README.md。将相关的英文文本翻译成中文，并返回翻译结果，保持完全相同的markdown和html语法。请不要翻译代码、黑客技术名称、黑客术语、云/SaaS平台名称（如Workspace、aws、gcp...）、泄漏一词、渗透测试和markdown标签。同时，请不要添加任何额外的内容，只需提供翻译和markdown语法即可。
```
UserName         Exists
--------         ------
user@company.com True
```
您还可以使用一个文本文件，每行包含一个电子邮件地址：
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
有三种不同的枚举方法可供选择：

| 方法       | 描述                                                                                                                                                                                                 |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 正常       | 这是上面提到的 GetCredentialType API 的默认方法。                                                                                                                                                      |
| 登录       | <p>此方法尝试以用户身份登录。<br><strong>注意：</strong>查询将被记录到登录日志中。</p>                                                                                                                 |
| 自动登录   | <p>此方法通过自动登录端点尝试以用户身份登录。<br><strong>查询不会被记录</strong>到登录日志中！因此，对于密码喷洒和暴力攻击也很有效。</p>                                                                         |

在发现有效的用户名后，您可以使用以下方法获取有关用户的信息：
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
脚本[**o365creeper**](https://github.com/LMGsec/o365creeper)还可以帮助你发现一个电子邮件地址是否有效。
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure服务

现在我们知道Azure租户使用的**域名**，是时候尝试找到**暴露的Azure服务**了。

您可以使用[**MicroBurst**](https://github.com/NetSPI/MicroBurst)中的一种方法来实现这个目标。该函数将在几个**Azure服务域名**中搜索基本域名（以及一些排列组合）：
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## 开放存储

您可以使用诸如[**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1)这样的工具来发现开放存储。该工具将使用文件**`Microburst/Misc/permitations.txt`**生成排列组合（非常简单），以尝试**找到开放的存储账户**。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**共享访问签名**_（SAS）URL是一个URL，它提供对存储账户的某个特定部分（可以是完整的容器、文件等）的访问权限（读取、写入等）。如果发现泄露的SAS URL，您可能能够访问敏感信息，它们的格式如下（这是访问容器的URL，如果只是授予对文件的访问权限，URL的路径中也会包含该文件）：

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

使用[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)访问数据

## 损害凭据

### 钓鱼

* [**常见钓鱼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（凭据或OAuth应用程序-[非法同意授权攻击](az-illicit-consent-grant.md)-）
* [**设备代码身份验证**钓鱼](az-device-code-authentication-phishing.md)

### 密码喷洒/暴力破解

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## 参考资料

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
