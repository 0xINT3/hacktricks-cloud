# Az - 未经认证的枚举与初始入口

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Azure租户

### 租户枚举

有一些**公共Azure API**，仅凭知道**租户的域名**，攻击者就可以查询以收集更多关于它的信息。\
您可以直接查询API或使用PowerShell库 [**AADInternals**](https://github.com/Gerenios/AADInternals)**：**

| API                                                                  | 信息                                                                                          | AADInternals函数                                  |
| -------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| login.microsoftonline.com/\<domain>/.well-known/openid-configuration | **登录信息**，包括租户ID                                                                      | `Get-AADIntTenantID -Domain <domain>`             |
| autodiscover-s.outlook.com/autodiscover/autodiscover.svc             | **租户的所有域名**                                                                            | `Get-AADIntTenantDomains -Domain <domain>`        |
| login.microsoftonline.com/GetUserRealm.srf?login=\<UserName>         | **租户的登录信息**，包括租户名称和域名**认证类型**                                            | `Get-AADIntLoginInformation -UserName <UserName>` |
| login.microsoftonline.com/common/GetCredentialType                   | 登录信息，包括**桌面SSO信息**                                                                 | `Get-AADIntLoginInformation -UserName <UserName>` |

您可以使用 [**AADInternals**](https://github.com/Gerenios/AADInternals) **库的仅一个命令查询Azure租户的所有信息**：
```powershell
Invoke-AADIntReconAsOutsider -DomainName corp.onmicrosoft.com | Format-Table
```
Azure 租户信息输出示例：
```
Tenant brand:       Company Ltd
Tenant name:        company
Tenant id:          05aea22e-32f3-4c35-831b-52735704feb3
DesktopSSO enabled: True

Name                           DNS   MX    SPF  Type      STS
----                           ---   --    ---  ----      ---
company.com                   True  True  True  Federated sts.company.com
company.mail.onmicrosoft.com  True  True  True  Managed
company.onmicrosoft.com       True  True  True  Managed
int.company.com              False False False  Managed
```
从输出中我们可以看到目标组织的租户信息，包括租户名称、ID和“品牌”名称。我们还可以看到**桌面单点登录（又名**[**无缝单点登录**](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-sso)**）是否启用**。如果启用，我们可以找出目标组织中是否存在给定用户（用户枚举）。

我们还可以看到目标租户的所有（已验证）域名及其身份类型。对于联合域，还会显示所使用的身份提供者（通常是ADFS服务器）的FQDN。MX列指示电子邮件是否发送到Exchange在线。SPF列指示Exchange在线是否列为电子邮件发送者。**注意！**目前，侦察功能不遵循SPF记录的include语句，因此可能会有误报。

### 用户枚举

可以**检查租户内是否存在用户名**。这也包括**访客用户**，其用户名格式为：
```
<email>#EXT#@<tenant name>.onmicrosoft.com
```
电子邮件是用户的电子邮件地址，其中“@”被下划线“\_”替换。

使用 [**AADInternals**](https://github.com/Gerenios/AADInternals)，您可以轻松检查用户是否存在：
```powershell
# Check does the user exist
Invoke-AADIntUserEnumerationAsOutsider -UserName "user@company.com"
```
```markdown
# Azure 未经认证的枚举和初始入口

在对Azure环境进行渗透测试时，初始信息收集阶段至关重要。这个阶段的目标是识别出潜在的初始攻击向量。以下是一些未经认证的枚举技术，这些技术可以在没有任何Azure凭证的情况下执行。

## 公共Blob检测

Azure Blob存储是用于存储大量非结构化数据的服务。公共Blob可能包含敏感信息，可以通过以下方式检测：

- 使用第三方工具，如`BlobHunter`，自动检测公共Blob。
- 手动检测，通过访问`http://<storage_account>.blob.core.windows.net/`并检查返回的状态码。

## Azure文件共享枚举

Azure文件共享允许用户创建和使用SMB文件共享。未经授权的用户可能能够枚举文件共享：

- 使用`SMBMap`或`CrackMapExec`等工具。
- 手动检测，尝试访问`\\<storage_account>.file.core.windows.net\`。

## 子域枚举

子域可能会泄露有关Azure环境的信息。可以使用以下方法进行枚举：

- 使用子域枚举工具，如`Amass`或`Sublist3r`。
- 检查DNS记录，如CNAME或A记录，这可能会指向Azure服务。

## 元数据服务泄露

Azure元数据服务可以泄露关于虚拟机的信息。这些信息可以通过访问特定URL来检索：

- 访问`http://169.254.169.254/metadata/instance?api-version=2021-02-01`，并添加`Metadata: true`头部。

## 服务主体枚举

服务主体是Azure AD中的一个实体，用于授权应用程序访问资源。可以通过以下方式检测未经授权的服务主体：

- 使用`MicroBurst`工具集中的`Get-AzureServicePrincipal`脚本。
- 手动检测，通过尝试访问Azure AD中的服务主体。

## 总结

这些技术可以帮助渗透测试人员在不需要任何凭证的情况下发现Azure环境中的潜在漏洞。一旦发现了潜在的入口点，就可以进一步探索和利用这些漏洞。
```
```
UserName         Exists
--------         ------
user@company.com True
```
你也可以使用一个文本文件，每行包含一个电子邮件地址：
```
user@company.com
user2@company.com
admin@company.com
admin2@company.com
external.user_gmail.com#EXT#@company.onmicrosoft.com
external.user_outlook.com#EXT#@company.onmicrosoft.com
```

```powershell
# Invoke user enumeration
Get-Content .\users.txt | Invoke-AADIntUserEnumerationAsOutsider -Method Normal
```
有**三种不同的枚举方法**可供选择：

| 方法       | 描述                                                                                                                                                                                                 |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Normal    | 这指的是上面提到的 GetCredentialType API。默认方法。                                                                                                                                                 |
| Login     | <p>此方法尝试以用户身份登录。<br><strong>注意：</strong>查询将记录到登录日志中。</p>                                                                                                                 |
| Autologon | <p>此方法尝试通过自动登录端点以用户身份登录。<br><strong>查询不会被记录</strong>到登录日志中！因此，也适用于密码喷涂和暴力破解攻击。</p>                                                              |

在发现有效的用户名后，你可以获取**关于用户的信息**：
```powershell
Get-AADIntLoginInformation -UserName root@corp.onmicrosoft.com
```
脚本 [**o365creeper**](https://github.com/LMGsec/o365creeper) 也允许您发现**电子邮件是否有效**。
```powershell
# Put in emails.txt emails such as:
# - root@corp.onmicrosoft.com
python.exe .\o365creeper\o365creeper.py -f .\emails.txt -o validemails.txt
```
## Azure 服务

现在我们知道了**Azure 租户**正在使用的**域名**，是时候尝试找出**暴露的 Azure 服务**了。

你可以使用 [**MicroBust**](https://github.com/NetSPI/MicroBurst) 中的一个方法来实现这一目标。这个函数将在几个**Azure 服务域名**中搜索基础域名（以及一些变体）：
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1 -Verbose
Invoke-EnumerateAzureSubDomains -Base corp -Verbose
```
## 开放存储

您可以使用像 [**InvokeEnumerateAzureBlobs.ps1**](https://github.com/NetSPI/MicroBurst/blob/master/Misc/Invoke-EnumerateAzureBlobs.ps1) 这样的工具来发现开放存储，它将使用文件 **`Microburst/Misc/permitations.txt`** 生成排列（非常简单），以尝试**找到开放的存储账户**。
```powershell
Import-Module .\MicroBurst\MicroBurst.psm1
Invoke-EnumerateAzureBlobs -Base corp
[...]
https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
[...]

# Access https://corpcommon.blob.core.windows.net/secrets?restype=container&comp=list
# Check: <Name>ssh_info.json</Name>
# Access then https://corpcommon.blob.core.windows.net/secrets/ssh_info.json
```
### SAS URLs

_**共享访问签名**_（SAS）URL 是一个提供对存储帐户某部分访问权限的 URL（可以是完整的容器、文件等），具有对资源的特定权限（读、写等）。如果你发现一个泄露的 SAS URL，你可能能够访问敏感信息，它们看起来像这样（这是为了访问一个容器，如果它只是授予对一个文件的访问权限，URL 的路径也会包含该文件）：

`https://<storage_account_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

使用 [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) 来访问数据

## 妥协凭证

### 钓鱼

* [**常见钓鱼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（凭证或 OAuth 应用程序 -[非法同意授予攻击](az-illicit-consent-grant.md)-）
* [**设备代码认证** 钓鱼](az-device-code-authentication-phishing.md)

### 密码喷涂 / 暴力破解

{% content-ref url="az-password-spraying.md" %}
[az-password-spraying.md](az-password-spraying.md)
{% endcontent-ref %}

## 参考资料

* [https://o365blog.com/post/just-looking/](https://o365blog.com/post/just-looking/)

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 **HackTricks** 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 系列
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。**

</details>
