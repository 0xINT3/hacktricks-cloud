# Az - Osnovne informacije

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju oglašenu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Hijerarhija organizacije

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Grupa za upravljanje

Ako vaša organizacija ima **mnogo Azure pretplata**, možda će vam biti potreban način da efikasno **upravljate pristupom**, politikama i usaglašenošću za te **pretplate**. **Grupe za upravljanje** pružaju **obim upravljanja iznad pretplata**.

Imajte na umu da se u jednom direktorijumu može podržati **10.000 grupa za upravljanje**, a stablo grupa za upravljanje može podržati **do šest nivoa dubine**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

[Iz dokumentacije](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Svaki direktorijum ima jednu **grupu za upravljanje najvišeg nivoa koja se naziva koren**. Koren grupa za upravljanje je ugrađen u hijerarhiju kako bi **sve grupe za upravljanje i pretplate bile povezane sa njim**. Ova koren grupa za upravljanje omogućava primenu **globalnih politika i Azure uloga** na nivou direktorijuma. [Azure AD **Globalni administrator** treba da se uzdigne](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) na **ulogu administratora pristupa korisnika ove korenske grupe**. Nakon podizanja pristupa, administrator može **dodeliti bilo koju Azure ulogu drugim korisnicima ili grupama direktorijuma za upravljanje hijerarhijom**. Kao administrator, možete dodeliti **sopstveni nalog kao vlasnika** korenske grupe za upravljanje.

Koren grupa za upravljanje **ne može se premestiti ili izbrisati**, za razliku od drugih grupa za upravljanje.

Grupe za upravljanje vam omogućavaju upravljanje na nivou preduzeća bez obzira na vrstu pretplata koje imate. Međutim, **sve pretplate unutar jedne grupe za upravljanje** moraju verovati **istom Azure Active Directory (Azure AD) zakupcu**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Azure pretplate

U Azure-u, pretplata služi kao **logički kontejner** za svrhu **provisioniranja** poslovnih ili tehničkih **resursa**. Ovaj kontejner čuva **detalje o resursima** kao što su virtuelne mašine (VM), baze podataka i drugi. Prilikom kreiranja Azure resursa, kao što je VM, specificira se **povezana pretplata**. Ova struktura olakšava delegiranje pristupa, koristeći mehanizme kontrole pristupa zasnovane na ulogama.

### Grupe resursa

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Grupa resursa je **kontejner** koji sadrži **povezane resurse** za Azure rešenje. Grupa resursa može uključivati sve resurse za rešenje, ili samo one **resurse koje želite upravljati kao grupu**. Općenito, dodajte **resurse** koji dele **isti životni ciklus** u istu grupu resursa kako biste ih lako mogli implementirati, ažurirati i brisati kao grupu.

Svi **resursi** moraju biti **unutar grupe resursa** i mogu pripadati samo jednoj grupi, a ako se grupa resursa izbriše, svi resursi unutar nje takođe se brišu.

### Administrativne jedinice

[Iz dokumentacije:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Administrativne jedinice vam omogućavaju da **podelite** vašu organizaciju na **bilo koju jedinicu** koju želite, a zatim **dodelite specifične administratore** koji mogu **upravljati samo članovima** te jedinice. Na primer, možete koristiti administrativne jedinice da biste delegirali dozvole administratorima svake škole na velikom univerzitetu, tako da mogu kontrolisati pristup, upravljati korisnicima i postavljati politike samo u Školi inženjeringa.

Samo **korisnici**, **grupe** i **uređaji** mogu biti **članovi** administrativne jedinice.

Stoga će **administrativna jedinica** sadržati neke **članove**, a drugi **principali** će biti **dodeljeni dozvole nad tom** administrativnom **jedinicom** koje mogu koristiti za **upravljanje članovima** administrativne jedinice.

## Azure vs Azure AD vs Azure AD Domain Services

Važno je napomenuti da je **Azure AD** usluga **unutar** **Azure-a**. **Azure** je Microsoftova **cloud platforma**, dok je **Azure AD** korporativna **identitetska** **usluga** u Azure-u.\
Osim toga, **Azure AD nije kao Windows Active Directory**, to je identitetska usluga koja radi na potpuno drugačiji način. Ako želite pokrenuti **Domain Controller u Azure-u** za vaše Windows Active Directory okruženje, morate koristiti **Azure AD Domain Services**.

## Principali

Azure podržava različite vrste principala:

* **Korisnik**: Obična **osoba** sa pristupnim podacima.
* **Grupa**: **Grupa principala** koja se zajedno upravlja. **Dozvole** dodeljene grupama se **nasleđuju** od njenih **članova**.
* **Service Principal/Enterprise Applications**: To je **identitet** koji je kreiran za **korišćenje** sa **aplikacijama**, hostovanim uslugama i automatizovanim alatima za pristup Azure resursima. Ovaj pristup je **ograničen ulogama koje su dodeljene** servisnom principalu, što vam omogućava kontrolu nad **kojim resursima se može pristupiti** i na kojem
## Uloge i dozvole

**Uloge** se **dodeljuju** **principima** na **opsegu**: `principal -[IMA ULOGU]->(opseg)`

**Uloge** dodeljene **grupama** se **nasleđuju** od svih **članova** grupe.

Zavisno od opsega na koji je uloga dodeljena, **uloga** se može **naslediti** na **druge resurse** unutar kontejnera opsega. Na primer, ako korisnik A ima **ulogu na pretplati**, imaće tu **ulogu na svim grupama resursa** unutar pretplate i na **svim resursima** unutar grupe resursa.

### **Klasične uloge**

| **Vlasnik**                   | <ul><li>Potpuni pristup svim resursima</li><li>Može upravljati pristupom drugim korisnicima</li></ul> | Svi tipovi resursa |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Saradnik**                  | <ul><li>Potpuni pristup svim resursima</li><li>Ne može upravljati pristupom</li></ul>     | Svi tipovi resursa |
| **Čitalac**                   | • Pregled svih resursa                                                                  | Svi tipovi resursa |
| **Administrator pristupa korisnika** | <ul><li>Pregled svih resursa</li><li>Može upravljati pristupom drugim korisnicima</li></ul>           | Svi tipovi resursa |

### Ugrađene uloge

[Iz dokumentacije: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ima nekoliko Azure **ugrađenih uloga** koje možete **dodeliti** **korisnicima, grupama, servisnim principima i upravljanim identitetima**. Dodeljivanje uloga je način na koji kontrolišete **pristup Azure resursima**. Ako ugrađene uloge ne zadovoljavaju specifične potrebe vaše organizacije, možete kreirati [**Azure prilagođene uloge**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Ugrađene** uloge se primenjuju samo na **resurse** za koje su **namenjene**, na primer pogledajte ova 2 primera **ugrađenih uloga nad resursima Compute**:

| [Čitač rezervne kopije diska](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Pruža dozvolu za izvršavanje rezervne kopije diska.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Korisnik prijave virtuelne mašine](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Pregled virtuelnih mašina u portalu i prijava kao običan korisnik. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Ove uloge se **takođe mogu dodeliti nad logičkim kontejnerima** (kao što su upravljačke grupe, pretplate i grupe resursa) i principali koji su pogođeni će ih imati **nad resursima unutar tih kontejnera**.

* Pronađite ovde listu [**svih Azure ugrađenih uloga**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Pronađite ovde listu [**svih Azure AD ugrađenih uloga**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Prilagođene uloge

Azure takođe omogućava kreiranje [**prilagođenih uloga**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) sa dozvolama koje korisniku trebaju.

### Odbijen pristup

* Da bi **princip imao pristup resursu**, mora mu biti dodeljena eksplicitna uloga koja mu **dodeljuje tu dozvolu**.
* Eksplicitno **odbijanje dodele uloge ima prednost** nad ulogom koja dodeljuje dozvolu.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Globalni administrator

Korisnici sa ulogom globalnog administratora imaju mogućnost da '**povećaju' pristup korisnika administratora pristupa Azure ulozi do korenske upravljačke grupe**. To znači da će globalni administrator moći da upravlja pristupom **svim Azure pretplatama i upravljačkim grupama**.\
Ovo povećanje se može izvršiti na kraju stranice: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure politike

Azure politike su skup **pravila i propisa u Microsoft Azuru**, cloud computing servisu, koji pomažu u upravljanju i sprovođenju organizacionih standarda i procene usaglašenosti na velikoj skali. Ove politike sprovode različita pravila nad vašim **Azure resursima**, obezbeđujući da ti resursi ostanu usaglašeni sa korporativnim standardima i sporazumima o nivou usluge.

Azure politike su ključne za upravljanje i bezbednost u oblaku, pomažući da se osigura pravilno i efikasno korišćenje resursa, kao i usaglašenost sa spoljnim propisima i internim politikama.\
Neki primeri:

1. **Obezbeđivanje usaglašenosti sa određenim Azure regionima**: Ova politika obezbeđuje da se svi resursi implementiraju u određenim Azure regionima. Na primer, kompanija može želeti da obezbedi da se svi njeni podaci čuvaju u Evropi radi usaglašenosti sa GDPR-om.
2. **Sprovođenje standarda za imenovanje**: Politike mogu da sprovode konvencije za imenovanje Azure resursa. Ovo pomaže u organizaciji i lakom identifikovanju resursa na osnovu njihovih imena, što je korisno u velikim okruženjima.
3. **Ograničavanje određenih tipova resursa**: Ova politika može ograničiti kreiranje određenih tipova resursa. Na primer, politika može biti postavljena da spreči kreiranje skupih tipova resursa, poput određenih veličina virtuelnih mašina, radi kontrole troškova.
4. **Sprovođenje politika o označavanju**: Oznake su parovi ključ-vrednost koji se dodeljuju Azure resursima radi upravljanja resursima. Politike mogu da obezbede da određene oznake moraju biti prisutne ili imaju određene vrednosti za sve resurse. Ovo je korisno za praćenje troškova, vlasništva ili kategorizacije resursa.
5. **Ograničavanje javnog pristupa resursima**: Politike mogu da obezbede da određeni resursi, poput skladišnih naloga ili baza podataka, nemaju javne krajnje tačke, čime se osigurava da im se može pristupiti samo unutar mreže organizacije.
6. **Automatsko primenjivanje bezbednosnih podešavanja**: Politike se mogu koristiti za automatsko primenjivanje bezbednosnih podešavanja na resurse, kao što je primena određene grupe mrežnih bezbednosnih grupa na sve virtuelne mašine ili osiguravanje da svi skladišni nalozi koriste enkripciju.

Imajte na umu da se Azure politike mogu primeniti na bilo koji nivo Azure hijerarhije, ali se **obično koriste u korenskoj upravljačkoj grupi** ili drugim upravljačkim grupama.

###
### Podrazumevana korisnička ovlašćenja

Osnovni korisnik će imati neka **podrazumevana ovlašćenja** za enumeraciju određenih delova AzureAD:

* Čitanje svih korisnika, grupa, aplikacija, uređaja, uloga, pretplata i njihovih javnih svojstava
* Pozivanje gostiju (_može se isključiti_)
* Kreiranje sigurnosnih grupa
* Čitanje ne-skrivenih članstava u grupama
* Dodavanje gostiju u vlasničke grupe
* Kreiranje nove aplikacije (_može se isključiti_)
* Dodavanje do 50 uređaja u Azure (_može se isključiti_)

Možete videti punu [**listu podrazumevanih ovlašćenja korisnika** u dokumentaciji](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Takođe, obratite pažnju da u toj listi možete videti i **listu podrazumevanih ovlašćenja gostiju**.

{% hint style="info" %}
Zapamtite da bi korisnik mogao da enumeriše Azure resurse, korisniku je potrebno eksplicitno odobrenje za to ovlašćenje.
{% endhint %}

### Privileged Identity Management (PIM)

Privileged Identity Management (PIM) u Azure-u je alat koji **upravlja, kontroliše i nadgleda privilegovani pristup** u Azure Active Directory i Azure-u. Poboljšava bezbednost pružanjem **privremenog i vremenski ograničenog privilegovanog pristupa**, **sprovođenjem odobravanja tokova rada i zahtevanjem dodatne autentifikacije**. Ovaj pristup minimizira rizik od neovlašćenog pristupa tako što se osigurava da se povišena ovlašćenja dodeljuju samo kada je to potrebno i za određeno vreme.

## Autentifikacioni tokeni

Postoje **tri vrste tokena** koji se koriste u OIDC:

* [**Pristupni tokeni**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klijent predstavlja ovaj token serveru resursa da bi **pristupio resursima**. Može se koristiti samo za određenu kombinaciju korisnika, klijenta i resursa i **ne može se opozvati** do isteka - podrazumevano je 1 sat. Detekcija je niska pri korišćenju ovog tokena.
* **ID tokeni**: Klijent dobija ovaj **token od autorizacionog servera**. Sadrži osnovne informacije o korisniku. **Povezan je sa određenom kombinacijom korisnika i klijenta**.
* **Osvježavajući tokeni**: Dodeljeni klijentu zajedno sa pristupnim tokenom. Koriste se za **dobijanje novih pristupnih i ID tokena**. Povezani su sa određenom kombinacijom korisnika i klijenta i mogu se opozvati. Podrazumevani rok trajanja je **90 dana** za neaktivne osvježavajuće tokene i **bez roka trajanja za aktivne tokene**.

{% hint style="warning" %}
Informacije za **uslovni pristup** su **smeštene** unutar **JWT**-a. Dakle, ako zatražite **token sa dozvoljene IP adrese**, ta **IP adresa** će biti **smeštena** u tokenu i zatim možete koristiti taj token sa **ne-dozvoljene IP adrese da pristupite resursima**.
{% endhint %}

Proverite sledeću stranicu da biste naučili različite načine za **zahtevanje pristupnih tokena** i prijavljivanje sa njima:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

Najčešće korišćene API tačke su:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph koji je zastareo je graph.windows.net)

## Reference

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
