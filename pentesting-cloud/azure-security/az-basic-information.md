# Az - Informations de base

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PRs aux** d√©p√¥ts github [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Hi√©rarchie de l'organisation

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Groupes de gestion

Si votre organisation a **de nombreuses souscriptions Azure**, vous pourriez avoir besoin d'un moyen efficace de **g√©rer l'acc√®s**, les politiques et la conformit√© pour ces **souscriptions**. Les **groupes de gestion** offrent une **port√©e de gouvernance au-dessus des souscriptions**.

Notez que **10 000 groupes de gestion** peuvent √™tre pris en charge dans un seul annuaire et un arbre de groupe de gestion peut supporter **jusqu'√† six niveaux de profondeur**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

Chaque annuaire se voit attribuer un seul **groupe de gestion de niveau sup√©rieur appel√© le groupe racine**. Le groupe de gestion racine est int√©gr√© dans la hi√©rarchie pour que **tous les groupes de gestion et souscriptions se regroupent sous lui**. Ce groupe de gestion racine permet d'appliquer des **politiques globales et des attributions de r√¥les Azure** au niveau de l'annuaire. L'[**Administrateur Global Azure AD** doit s'√©lever](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) au r√¥le de **Administrateur d'Acc√®s Utilisateur de ce groupe racine** initialement. Apr√®s avoir √©lev√© l'acc√®s, l'administrateur peut **attribuer n'importe quel r√¥le Azure √† d'autres utilisateurs ou groupes de l'annuaire pour g√©rer la hi√©rarchie**. En tant qu'administrateur, vous pouvez attribuer **votre propre compte en tant que propri√©taire du groupe** de gestion racine.

Le groupe de gestion racine **ne peut pas √™tre d√©plac√© ou supprim√©**, contrairement aux autres groupes de gestion.

Les groupes de gestion vous offrent une gestion de niveau entreprise √† grande √©chelle, quel que soit le type de souscriptions que vous pourriez avoir. Cependant, **toutes les souscriptions au sein d'un m√™me groupe de gestion** doivent faire confiance au **m√™me locataire Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Souscriptions Azure

Une souscription Azure est un **conteneur logique** utilis√© pour **provisionner** des **ressources** d'affaires ou techniques **dans Azure**. Elle contient les **d√©tails de toutes vos ressources** comme les machines virtuelles (VM), les bases de donn√©es, et plus encore. Lorsque vous cr√©ez une ressource Azure comme une VM, vous identifiez la **souscription √† laquelle elle appartient**. Elle vous permet de d√©l√©guer l'acc√®s via des m√©canismes de contr√¥le d'acc√®s bas√©s sur les r√¥les.

### Groupes de ressources

Un groupe de ressources est un **conteneur** qui d√©tient des **ressources li√©es** pour une solution Azure. Le groupe de ressources peut inclure toutes les ressources pour la solution, ou seulement celles que **vous souhaitez g√©rer en tant que groupe**. G√©n√©ralement, ajoutez des **ressources** qui partagent le **m√™me cycle de vie** au m√™me groupe de ressources afin de pouvoir les d√©ployer, les mettre √† jour et les supprimer facilement en tant que groupe.

Toutes les **ressources** doivent √™tre **√† l'int√©rieur d'un groupe de ressources** et ne peuvent appartenir qu'√† un seul groupe et si un groupe de ressources est supprim√©, toutes les ressources √† l'int√©rieur sont √©galement supprim√©es.

### Unit√©s administratives

Les unit√©s administratives vous permettent de **subdiviser** votre organisation en **n'importe quelle unit√©** que vous souhaitez, puis d'**attribuer des administrateurs sp√©cifiques** qui peuvent **g√©rer uniquement les membres** de cette unit√©. Par exemple, vous pourriez utiliser des unit√©s administratives pour d√©l√©guer des permissions aux administrateurs de chaque √©cole d'une grande universit√©, afin qu'ils puissent contr√¥ler l'acc√®s, g√©rer les utilisateurs et d√©finir des politiques uniquement dans l'√âcole d'Ing√©nierie.

Seuls les **utilisateurs**, **groupes** et **appareils** peuvent √™tre **membres** d'une **unit√© administrative**.

Par cons√©quent, une **unit√© administrative** contiendra certains **membres** et d'autres **principaux** se verront **attribuer des permissions sur cette** unit√© administrative qu'ils peuvent utiliser pour **g√©rer les membres** de l'unit√© administrative.

## Azure vs Azure AD vs Azure AD Domain Services

Il est important de noter que **Azure AD** est un service **√† l'int√©rieur** d'**Azure**. **Azure** est la **plateforme cloud** de Microsoft tandis qu'**Azure AD** est un service d'**identit√© d'entreprise** dans Azure.\
De plus, **Azure AD n'est pas comme Windows Active Directory**, c'est un service d'identit√© qui fonctionne d'une mani√®re compl√®tement diff√©rente. Si vous souhaitez ex√©cuter un **Contr√¥leur de Domaine dans Azure** pour votre environnement Windows Active Directory, vous devez utiliser **Azure AD Domain Services**.

## Principaux

Azure prend en charge diff√©rents types de principaux :

* **Utilisateur** : Une **personne** r√©guli√®re avec des identifiants pour acc√©der.
* **Groupe** : Un **groupe de principaux** g√©r√© ensemble. Les **permissions** accord√©es aux groupes sont **h√©rit√©es** par ses **membres**.
*   **Principal de service/Applications d'entreprise** : C'est une **identit√©** cr√©√©e pour √™tre **utilis√©e** avec des **applications**, des services h√©berg√©s et des outils automatis√©s pour acc√©der aux ressources Azure. Cet acc√®s est **restreint par les r√¥les attribu√©s** au principal de service, vous donnant le contr√¥le sur **quelles ressources peuvent √™tre acc√©d√©es** et √† quel niveau. Pour des raisons de s√©curit√©, il est toujours recommand√© d'**utiliser des principaux de service avec des outils automatis√©s** plut√¥t que de les laisser se connecter avec une identit√© d'utilisateur.

Lors de la cr√©ation d'un **principal de service**, vous pouvez choisir entre une **authentification par mot de passe** ou une **authentification par certificat**.

* Si vous choisissez l'authentification par **mot de passe** (par d√©faut), **sauvegardez le mot de passe g√©n√©r√©** car vous ne pourrez plus y acc√©der.
* Si vous choisissez l'authentification par certificat, assurez-vous que l'**application aura acc√®s √† la cl√© priv√©e**.
* **Identit√© g√©r√©e (M√©tadonn√©es d'identification)** : Les identit√©s g√©r√©es fournissent une **identit√© g√©r√©e automatiquement** dans Azure Active Directory pour les applications √† utiliser lors de la **connexion** √† des **ressources** qui prennent en charge l'authentification Azure Active Directory (**Azure AD**). Les applications peuvent utiliser des identit√©s g√©r√©es pour **obtenir des jetons Azure AD sans avoir √† g√©rer d'identifiants**.\
Il existe deux types d'identit√©s g√©r√©es :
* **Attribu√©e par le syst√®me**. Certains services Azure vous permettent d'**activer une identit√© g√©r√©e directement sur une instance de service**. Lorsque vous activez une identit√© g√©r√©e par le syst√®me, une identit√© est cr√©√©e dans Azure AD. L'identit√© est li√©e au **cycle de vie de cette instance de service**. Lorsque la **ressource** est **supprim√©e**, Azure **supprime automatiquement** l'**identit√©** pour vous. Par conception, seule cette ressource Azure peut utiliser cette identit√© pour demander des jetons √† Azure AD.
* **Attribu√©e par l'utilisateur**. Vous pouvez √©galement cr√©er une identit√© g√©r√©e en tant que ressource Azure autonome. Vous pouvez [cr√©er une identit√© g√©r√©e attribu√©e par l'utilisateur](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) et l'assigner √† une ou **plusieurs instances** d'un service Azure (ressources multiples). Pour les identit√©s g√©r√©es attribu√©es par l'utilisateur, l'**identit√© est g√©r√©e s√©par√©ment des ressources qui l'utilisent**.

## R√¥les & Permissions

**Les r√¥les** sont **attribu√©s** aux **principaux** sur une **port√©e** : `principal -[A LE R√îLE]->(port√©e)`

**Les r√¥les** attribu√©s aux **groupes** sont **h√©rit√©s** par tous les **membres** du groupe.

Selon la port√©e √† laquelle le r√¥le a √©t√© attribu√©, le **r√¥le** pourrait √™tre **h√©rit√©** par **d'autres ressources** √† l'int√©rieur du conteneur de port√©e. Par exemple, si un utilisateur A a un **r√¥le sur la souscription**, il aura ce **r√¥le sur tous les groupes de ressources** √† l'int√©rieur de la souscription et sur **toutes les ressources** √† l'int√©rieur du groupe de ressources.

### **R√¥les classiques**

| **Propri√©taire**                     | <ul><li>Acc√®s complet √† toutes les ressources</li><li>Peut g√©rer l'acc√®s pour d'autres utilisateurs</li></ul> | Tous les types de ressources |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contributeur**               | <ul><li>Acc√®s complet √† toutes les ressources</li><li>Ne peut pas g√©rer l'acc√®s</li></ul>              | Tous les types de ressources |
| **Lecteur**                    | ‚Ä¢ Voir toutes les ressources                                                                     | Tous les types de ressources |
| **Administrateur d'Acc√®s Utilisateur** | <ul><li>Voir toutes les ressources</li><li>Peut g√©rer l'acc√®s pour d'autres utilisateurs</li></ul>           | Tous les types de ressources |

### R√¥les int√©gr√©s

Le contr√¥le d'acc√®s bas√© sur les r√¥les Azure ([Azure RBAC](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)) dispose de plusieurs **r√¥les int√©gr√©s Azure** que vous pouvez **attribuer** √† des **utilisateurs, groupes, principaux de service et identit√©s g√©r√©es**. Les attributions de r√¥les sont la mani√®re dont vous contr√¥lez **l'acc√®s aux ressources Azure**. Si les r√¥les int√©gr√©s ne r√©pondent pas aux besoins sp√©cifiques de votre organisation, vous pouvez cr√©er vos propres [**r√¥les personnalis√©s Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Les r√¥les int√©gr√©s** s'appliquent uniquement aux **ressources** auxquelles ils sont **destin√©s**, par exemple, consultez ces 2 exemples de **r√¥les int√©gr√©s sur les ressources de calcul** :

| [Lecteur de sauvegarde de disque](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fournit la permission au coffre-fort de sauvegarde d'effectuer une sauvegarde de disque.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Connexion utilisateur de machine virtuelle](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Voir les machines virtuelles dans le portail et se connecter en tant qu'utilisateur r√©gulier. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Ces r√¥les peuvent **√©galement √™tre attribu√©s sur des conteneurs logiques** (tels que les groupes de gestion, les souscriptions et les groupes de ressources) et les principaux affect√©s les auront **sur les ressources √† l'int√©rieur de ces conteneurs**.

* Trouvez ici une liste avec [**tous les r√¥les int√©gr√©s Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trouvez ici une liste avec [**tous les r√¥les int√©gr√©s Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### R√¥les personnalis√©s

Azure permet √©galement de cr√©er des [**r√¥les personnalis√©s**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) avec les permissions dont l'utilisateur a besoin.

### Permission refus√©e

* Pour qu'un **principal ait un certain acc√®s sur une ressource**, il doit avoir un r√¥le explicite lui accordant cette permission.
* Une attribution de r√¥le de **refus explicite a la priorit√©** sur le r√¥le accordant la permission.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Administrateur Global

Les utilisateurs avec le r√¥le d'Administrateur Global ont la capacit√© de '**s'√©lever' au r√¥le d'Administrateur d'Acc√®s Utilisateur Azure pour le groupe de gestion racine**. Cela signifie qu'un Administrateur Global pourra g√©rer l'acc√®s **√† toutes les souscriptions et groupes de gestion Azure.**\
Cette √©l√©vation peut √™tre effectu√©e √† la fin de la page : [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Politiques Azure

Les politiques Azure sont un ensemble de **r√®gles et r√©glementations dans Microsoft Azure**, un service de cloud computing, qui aident √† g√©rer et √† faire respecter les normes organisationnelles et √† √©valuer la conformit√© √† grande √©chelle. Ces politiques imposent diff√©rentes r√®gles sur vos **ressources Azure**, garantissant que ces ressources restent conformes aux normes d'entreprise et aux accords de niveau de service.

Les politiques Azure sont cruciales pour la gouvernance du cloud et la s√©curit√©, aidant √† garantir que les ressources sont utilis√©es correctement et efficacement, et qu'elles se conforment aux r√©glementations externes et aux politiques internes.\
Quelques exemples :

1. **Assurer la conformit√© avec des r√©gions Azure sp√©cifiques** : Cette politique garantit que toutes les ressources sont d√©ploy√©es dans des r√©gions Azure sp√©cifiques. Par exemple, une entreprise pourrait vouloir s'assurer que toutes ses donn√©es sont stock√©es en Europe pour la conformit√© au RGPD.
2. **Imposer des normes de nommage** : Les politiques peuvent imposer des conventions de nommage pour les ressources Azure. Cela aide √† organiser et √† identifier facilement les ressources en fonction de leurs noms, ce qui est utile dans les grands environnements.
3. **Restreindre certains types de ressources** : Cette politique peut restreindre la cr√©ation de certains types de ressources. Par exemple, une politique pourrait √™tre mise en place pour emp√™cher la cr√©ation de types de ressources co√ªteux, comme certaines tailles de VM, pour contr√¥ler les co√ªts.
4. **Imposer des politiques de balisage** : Les balises sont des paires cl√©-valeur associ√©es aux ressources Azure utilis√©es pour la gestion des ressources. Les politiques peuvent imposer que certaines balises doivent √™tre pr√©sentes, ou avoir des valeurs sp√©cifiques, pour toutes les ressources. Cela est utile pour le suivi des co√ªts, la propri√©t√© ou la cat√©gorisation des ressources.
5. **Limiter l'acc√®s public aux ressources** :
