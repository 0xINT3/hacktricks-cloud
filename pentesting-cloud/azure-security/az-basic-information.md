# Az - 基本情報

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 組織階層

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### 管理グループ

組織が**多くのAzureサブスクリプション**を持っている場合、それらの**サブスクリプション**に対する**アクセス管理**、ポリシー、コンプライアンスを効率的に**管理する**方法が必要になるかもしれません。**管理グループ**は、サブスクリプションより上の**ガバナンス範囲**を提供します。

単一のディレクトリで**10,000の管理グループ**をサポートし、管理グループツリーは**最大6レベルの深さ**をサポートできることに注意してください。

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

各ディレクトリには、**ルート**管理グループと呼ばれる単一の**トップレベルの管理グループ**が与えられます。ルート管理グループは、**すべての管理グループとサブスクリプションがそれに折りたたまれる**ように階層に組み込まれています。このルート管理グループにより、**グローバルポリシーとAzureロールの割り当て**がディレクトリレベルで適用されます。[Azure AD **グローバル管理者**は、このルートグループの**ユーザーアクセス管理者ロール**に自分を昇格させる必要があります](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin)。アクセスを昇格した後、管理者は**階層を管理するために他のディレクトリユーザーやグループに任意のAzureロールを割り当てる**ことができます。管理者として、**ルート**管理グループの**所有者として自分のアカウントを割り当てる**ことができます。

ルート管理グループは、他の管理グループとは異なり、**移動または削除することはできません**。

管理グループは、どのようなタイプのサブスクリプションを持っているかに関わらず、エンタープライズグレードの管理を大規模に提供します。ただし、**単一の管理グループ内のすべてのサブスクリプション**は、**同じAzure Active Directory (Azure AD)テナント**を信頼する必要があります。

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Azureサブスクリプション

Azureサブスクリプションは、Azure内の関連するビジネスまたは技術**リソースをプロビジョニング**するために使用される**論理コンテナ**です。仮想マシン（VM）、データベースなど、すべてのリソースの**詳細を保持**します。VMのようなAzureリソースを作成するとき、それが属する**サブスクリプションを特定**します。ロールベースのアクセス制御メカニズムを通じてアクセスを委任することができます。

### リソースグループ

リソースグループは、Azureソリューションの**関連リソース**を保持する**コンテナ**です。リソースグループには、ソリューションのすべてのリソース、または**グループとして管理したいリソースのみ**を含めることができます。一般的に、**同じライフサイクル**を共有する**リソース**を同じリソースグループに追加して、グループとして簡単にデプロイ、更新、削除できるようにします。

すべての**リソース**は**リソースグループ内に存在**しなければならず、グループにのみ属することができ、リソースグループが削除されると、その中のすべてのリソースも削除されます。

### 管理単位

管理単位を使用すると、組織を**任意の単位**に**細分化**し、その単位の**メンバーのみを管理**できる**特定の管理者**を**割り当てる**ことができます。たとえば、大学で各学校の管理者に権限を委任して、エンジニアリング学部でのみアクセスを制御し、ユーザーを管理し、ポリシーを設定することができます。

**ユーザー**、**グループ**、および**デバイス**のみが**管理単位**の**メンバー**になることができます。

したがって、**管理単位**はいくつかの**メンバー**を**含み**、他の**プリンシパル**にはその管理単位に対する**権限が割り当てられ**、管理単位の**メンバーを管理**するために使用できます。

## Azure vs Azure AD vs Azure ADドメインサービス

**Azure AD**は**Azure内**のサービスであることに注意してください。**Azure**はMicrosoftの**クラウドプラットフォーム**であり、**Azure AD**はAzure内のエンタープライズ**アイデンティティサービス**です。\
さらに、**Azure ADはWindows Active Directoryのようではありません**。それは完全に異なる方法で機能するアイデンティティサービスです。AzureでWindows Active Directory環境の**ドメインコントローラーを実行**したい場合は、**Azure ADドメインサービス**を使用する必要があります。

## プリンシパル

Azureは異なるタイプのプリンシパルをサポートしています：

* **ユーザー**：アクセスするための資格情報を持つ通常の**人**。
* **グループ**：一緒に管理される**プリンシパルのグループ**。グループに付与された**権限**は、その**メンバー**に**継承**されます。
*   **サービスプリンシパル/エンタープライズアプリケーション**：**アプリケーション**、ホストされたサービス、および自動化ツールがAzureリソースにアクセスするために作成された**アイデンティティ**です。このアクセスは、サービスプリンシパルに割り当てられたロールによって**制限され**、**どのリソースにアクセスできるか**、どのレベルでアクセスできるかを制御できます。セキュリティ上の理由から、ユーザーのアイデンティティでログインすることを許可するよりも、自動化ツールでサービスプリンシパルを**使用することを常に推奨**します。

**サービスプリンシパル**を作成するとき、**パスワード認証**または**証明書認証**のいずれかを選択できます。

* **パスワード**認証を選択すると（デフォルト）、**生成されたパスワードを保存**してください。再度アクセスすることはできません。
* 証明書認証を選択する場合は、**アプリケーションが秘密鍵にアクセスできることを確認**してください。
* **マネージドアイデンティティ（メタデータクレデンシャル）**：マネージドアイデンティティは、Azure Active Directory（**Azure AD**）認証をサポートする**リソースに接続**するためにアプリケーションが使用する**自動的に管理されるアイデンティティ**を提供します。アプリケーションは、マネージドアイデンティティを使用して、**資格情報を管理することなくAzure ADトークンを取得**できます。\
マネージドアイデンティティには2つのタイプがあります：
* **システム割り当て**。一部のAzureサービスでは、サービスインスタンスに直接マネージドアイデンティティを**有効にすることができます**。システム割り当てマネージドアイデンティティを有効にすると、Azure ADにアイデンティティが作成されます。アイデンティティは、そのサービスインスタンスの**ライフサイクルに結びついています**。**リソース**が**削除される**と、Azureは自動的にその**アイデンティティを削除**します。設計上、そのAzureリソースのみがこのアイデンティティを使用してAzure ADからトークンを要求できます。
* **ユーザー割り当て**。マネージドアイデンティティをスタンドアロンのAzureリソースとして作成することもできます。[ユーザー割り当てマネージドアイデンティティを作成](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal)し、Azureサービスの1つ以上のインスタンス（複数のリソース）に割り当てることができます。ユーザー割り当てマネージドアイデンティティの場合、**アイデンティティはそれを使用するリソースから別に管理されます**。

## ロールと権限

**ロール**は**スコープ**に**プリンシパル**に**割り当てられます**：`principal -[HAS ROLE]->(scope)`

**グループ**に割り当てられた**ロール**は、グループのすべての**メンバー**に**継承**されます。

ロールが割り当てられたスコープに応じて、**ロール**はスコープコンテナ内の**他のリソース**に**継承**される可能性があります。たとえば、ユーザーAが**サブスクリプションにロール**を持っている場合、サブスクリプション内のすべてのリソースグループとリソースグループ内の**すべてのリソース**にその**ロールを持つ**ことになります。

### **クラシックロール**

| **オーナー**                     | <ul><li>すべてのリソースへのフルアクセス</li><li>他のユーザーのアクセスを管理できる</li></ul> | すべてのリソースタイプ |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **コントリビューター**               | <ul><li>すべてのリソースへのフルアクセス</li><li>アクセスを管理できない</li></ul>              | すべてのリソースタイプ |
| **リーダー**                    | • すべてのリソースを表示                                                                   | すべてのリソースタイプ |
| **ユーザーアクセス管理者** | <ul><li>すべてのリソースを表示</li><li>他のユーザーのアクセスを管理できる</li></ul>           | すべてのリソースタイプ |

### 組み込みロール

[Azureロールベースのアクセス制御（Azure RBAC）](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)には、**ユーザー、グループ、サービスプリンシパル、およびマネージドアイデンティティ**に**割り当てる**ことができるいくつかのAzure**組み込みロール**があります。ロールの割り当ては、**Azureリソースへのアクセスを制御する方法**です。組み込みロールが組織の特定のニーズを
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**各ポータルをテスト**し、**MFAなしでログイン**できるかどうかを確認します：
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

**Azure** **ポータル**は**制約されていない**ため、前回の実行で検出された任意のサービスにアクセスするためのトークンをポータルエンドポイントから**収集することが可能です**。この場合、Sharepointが識別され、それにアクセスするためのトークンが要求されました：
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune Read-JWTtoken -token $token.access_token
```
```markdown
<figure><img src="../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

トークンにはSites.Read.All（Sharepointから）の権限があります：

<figure><img src="../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

MFAのためにWebからSharepointにアクセスできない場合でも、生成されたトークンを使用してファイルにアクセスすることが可能です：
```
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
ファイルのダウンロードURLを取得する：

## 参考文献

* [https://learn.microsoft.com/ja-jp/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/ja-jp/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
