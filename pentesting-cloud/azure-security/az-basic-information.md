# Az - 基本信息

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 来分享您的黑客技巧。

</details>

## 组织层次结构

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### 管理组

如果您的组织拥有**许多 Azure 订阅**，您可能需要一种有效地**管理访问权限**、策略和合规性的方式来管理这些**订阅**。**管理组**为**订阅**提供了一个**管理范围**。

请注意，单个目录中可以支持**10,000 个管理组**，并且管理组树可以支持**最多六层深度**。

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

每个目录都有一个名为**根管理组**的**顶级管理组**。根管理组内置于层次结构中，将**所有管理组和订阅**折叠到其中。此根管理组允许在目录级别应用**全局策略和 Azure 角色分配**。[Azure AD **全局管理员**需要将自己提升](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin)为此根组的**用户访问管理员角色**。提升访问权限后，管理员可以将**任何 Azure 角色分配给其他目录用户或组以管理层次结构**。作为管理员，您可以将**自己的帐户指定为根**管理组的所有者。

与其他管理组不同，**根管理组无法移动或删除**。

管理组为您提供了企业级的管理能力，无论您拥有何种类型的订阅。但是，**单个管理组内的所有订阅**必须信任**同一个 Azure Active Directory (Azure AD) 租户**。

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Azure 订阅

Azure 订阅是用于在 Azure 中**提供**相关业务或技术**资源的逻辑容器**。它保存了所有资源的详细信息，如虚拟机 (VM)、数据库等。当您创建 Azure 资源（如 VM）时，您需要标识其所属的**订阅**。它允许您通过基于角色的访问控制机制委派访问权限。

### 资源组

资源组是用于 Azure 解决方案的**相关资源**的**容器**。资源组可以包含解决方案的所有资源，或者仅包含您希望作为一组进行管理的**资源**。通常，将**共享生命周期的资源**添加到同一个资源组中，以便可以轻松地部署、更新和删除它们。

所有**资源**必须**位于资源组内**，并且只能属于一个组，如果删除资源组，则其中的所有资源也将被删除。

### 管理单元

管理单元允许您将组织细分为**任何单位**，然后**分配特定管理员**来**仅管理该单位的成员**。例如，您可以使用管理单元将权限委派给大学中每个学院的管理员，以便他们只能在工程学院中控制访问权限、管理用户和设置策略。

只有**用户**、**组**和**设备**可以成为**管理单元的成员**。

因此，**管理单元**将**包含一些成员**，其他**主体**将被**分配对该**管理**单元的权限**，他们可以使用这些权限来**管理管理单元的成员**。

## Azure vs Azure AD vs Azure AD 域服务

重要的是要注意，**Azure AD** 是 Azure 内部的一项服务。**Azure** 是微软的**云平台**，而 **Azure AD** 是 Azure 中的企业**身份**服务。\
此外，**Azure AD 与 Windows Active Directory 不同**，它是一种以完全不同方式工作的身份服务。如果您想在 Azure 中运行用于 Windows Active Directory 环境的**域控制器**，您需要使用 **Azure AD 域服务**。

## 主体

Azure 支持不同类型的主体：

* **用户**：具有访问凭据的普通**人**。
* **组**：一组一起管理的**主体**。授予组的权限将被其**成员继承**。
* **服务主体**：它是为**应用程序**、**托管服务**和**自动化工具**创建的**身份**，用于访问 Azure 资源。此访问受到分配给服务主体的角色的限制，使您能够**控制可以访问哪些资源**以及在哪个级别访问。出于安全原因，始终建议**使用服务主体与自动化工具**，而不是允许其使用用户身份登录。

创建**服务主体**时，可以选择**密码身份验证**或**证书身份验证**。

* 如果选择**密码**身份验证（默认情况下），请**保存生成的密码**，因为您将无法再次访问它。
* 如果选择证书身份验证，请确保**应用程序将能够访问私钥**。
* **托管标识**：托管标识为应用程序在 Azure Active Directory 中提供了一个**自动管理的标识**，用于连接支持 Azure Active Directory（Azure AD）身份验证的资源。应用程序可以使用托管标识来**获取 Azure AD 令牌，而无需管理任何凭据**。\
有两种类型的托管标识：
* **系统分配**。某些 Azure 服务允许您**直接在服务实例上启用托管标识**。启用系统分配的托管标识时，将在 Azure AD 中创建一个标识。该标识与**该服务实例的生命周期**相关联。当**资源**被**删除**时，Azure 会自动为您**删除**该**标识**。按设计，只有该 Azure 资源可以使用此标识向 Azure AD 请求令牌。
* **用户分配**。您还可以将托管标识作为独立的 Azure 资源创建。您可以[创建用户分配的托管标识](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal)，并将其分配给一个或**多个 Azure 服务的实例**（多个资源）。对于用户分配的托管标识，**标识与使用它的资源分开管理**。
## 角色和权限

**角色**被**分配**给**主体**在一个**范围**上：`主体 -[拥有角色]->(范围)`

**分配给组的角色**将被**组的所有成员继承**。

根据角色分配的范围，该角色可以被继承到范围容器内的其他资源。例如，如果用户A在订阅上有一个角色，他将在订阅内的所有资源组和资源上都有该角色。

### **经典角色**

| **所有者**                     | <ul><li>对所有资源具有完全访问权限</li><li>可以管理其他用户的访问权限</li></ul> | 所有资源类型 |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **贡献者**               | <ul><li>对所有资源具有完全访问权限</li><li>无法管理访问权限</li></ul>              | 所有资源类型 |
| **读取者**                    | • 查看所有资源                                                                     | 所有资源类型 |
| **用户访问管理员** | <ul><li>查看所有资源</li><li>可以管理其他用户的访问权限</li></ul>           | 所有资源类型 |

### 内置角色

[Azure基于角色的访问控制（Azure RBAC）](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)有几个Azure**内置角色**，您可以将其分配给**用户、组、服务主体和托管标识**。角色分配是您控制**对Azure资源的访问权限**的方式。如果内置角色不满足您组织的特定需求，您可以创建自己的[**Azure自定义角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**。**

**内置**角色仅适用于它们**所针对的资源**，例如，检查以下两个**内置角色在计算资源上的应用**的示例：

| [磁盘备份读取器](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | 允许备份保险库执行磁盘备份。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [虚拟机用户登录](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | 在门户中查看虚拟机并作为普通用户登录。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

这些角色也可以分配给逻辑容器（例如管理组、订阅和资源组），受影响的主体将在这些容器内的资源上具有这些角色。

* 在此处找到[**所有Azure内置角色的列表**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)。
* 在此处找到[**所有Azure AD内置角色的列表**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)。

### 自定义角色

Azure还允许创建[**自定义角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)，以满足用户的权限需求。

### 权限被拒绝

* 为了使**主体对资源具有某些访问权限**，他需要被授予一个明确的角色（无论如何），**授予他该权限**。
* 显式的**拒绝角色分配优先于**授予权限的角色。

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### 全局管理员

具有全局管理员角色的用户可以将“**用户访问管理员Azure角色提升**”到根管理组。这意味着全局管理员将能够管理**所有Azure订阅和管理组的访问权限**。\
\*\*\*\*此提升可以在此页面完成：[https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC**（基于角色的访问控制）是我们在前面的部分中已经看到的：**将角色分配给主体以授予其对资源的访问权限**。\
然而，在某些情况下，您可能希望提供**更精细的访问管理**或**简化**数百个角色**分配**的管理。

Azure **ABAC**（基于属性的访问控制）在Azure RBAC的基础上添加了**基于属性的角色分配条件**，以特定操作的上下文为基础。_角色分配条件_是您可以选择添加到角色分配中的**附加检查**，以提供更精细的访问控制。条件会过滤掉作为角色定义和角色分配一部分授予的权限。例如，您可以**添加一个条件，要求对象具有特定标签才能读取该对象**。\
您**不能**使用条件**显式拒绝对特定资源的访问**。

### 默认用户权限

基本用户将具有一些**默认权限**来枚举AzureAD的某些部分：

* 读取所有用户、组、应用程序、设备、角色、订阅及其公共属性
* 邀请访客（可以关闭）
* 创建安全组
* 读取非隐藏的组成员
* 将访客添加到所拥有的组
* 创建新应用程序（可以关闭）
* 将最多50个设备添加到Azure（可以关闭）

您可以在文档中查看[**用户的默认权限的完整列表**](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions)。此外，请注意在该列表中您还可以看到**访客的默认权限列表**。

{% hint style="info" %}
请记住，要枚举Azure资源，用户需要明确授予该权限。
{% endhint %}

## 认证令牌

OIDC中使用了**三种类型的令牌**：

* \*\*\*\*[**访问令牌**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**：**客户端将此令牌呈现给资源服务器以**访问资源**。它只能用于特定的用户、客户端和资源组合，**在到期之前无法撤销**- 默认情况下为1小时。使用此方法检测的风险较低。
* **ID令牌**：客户端从授权服务器接收此**令牌**。它包含有关用户的基本信息。它**绑定到特定的用户和客户端**。
* **刷新令牌**：与访问令牌一起提供给客户端。用于**获取新的访问和ID令牌**。它绑定到特定的用户和客户端，并且可以被撤销。对于不活动的刷新令牌，默认到期时间为**90天**，对于活动令牌没有到期时间。

{% hint style="warning" %}
**条件访问**的信息存储在**JWT**中。因此，如果您从允许的IP地址请求令牌，该IP将存储在令牌中，然后您可以使用该令牌从**不允许的IP访问资源**。
{% endhint %}

请查看以下页面，了解不同的方式来**请求访问令牌**并使用它们进行登录：

{% content-ref url="az-services/az-azuread.md" %}
[az-azuread.md](az-services/az-azuread.md)
{% endcontent-ref %}

最常见的API端点是：

* **Azure资源管理器**（ARM）：management.azure.com
* **Microsoft Graph**：graph.microsoft.com（已弃用的Azure AD Graph为graph.windows.net）
## MFA绕过

MFA（多因素认证）是一种安全措施，要求用户在登录时提供多个身份验证因素。然而，有时候攻击者可以绕过MFA并获得未经授权的访问权限。以下是一些常见的MFA绕过技术：

### 社会工程学攻击

攻击者可以利用社会工程学技术欺骗用户，使其提供MFA代码或将其重定向到恶意网站。这种攻击通常涉及钓鱼邮件、钓鱼电话或钓鱼网站。

### 暴力破解

攻击者可以使用暴力破解工具尝试猜测MFA代码。这种攻击方法需要耐心和大量的计算资源。

### 漏洞利用

攻击者可以利用系统或应用程序中的漏洞来绕过MFA。这可能涉及到利用身份验证绕过漏洞或利用应用程序的弱点。

### 会话劫持

攻击者可以劫持已经通过MFA验证的会话，从而绕过后续的MFA验证。这可以通过窃取会话令牌或利用会话管理漏洞来实现。

### 钓鱼攻击

攻击者可以通过发送钓鱼邮件或创建钓鱼网站来欺骗用户，使其提供MFA代码。这种攻击方法依赖于用户的不谨慎行为。

### 移动设备攻击

攻击者可以通过攻击用户的移动设备来绕过MFA。这可能涉及到利用操作系统或应用程序中的漏洞，或者通过恶意应用程序来窃取MFA代码。

要防止MFA绕过攻击，用户和组织应该采取以下措施：

- 提供安全意识培训，以教育用户如何识别和应对社会工程学攻击。
- 使用强密码和MFA代码，以增加攻击者猜测的难度。
- 定期更新系统和应用程序，以修复已知的漏洞。
- 实施会话管理和访问控制策略，以防止会话劫持。
- 定期审查和监控系统日志，以检测潜在的攻击行为。
- 下载和安装来自可信来源的应用程序，以减少移动设备攻击的风险。

通过采取这些措施，用户和组织可以增强MFA的安全性，并减少MFA绕过攻击的风险。
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**测试每个门户**是否可以**在没有多因素身份验证的情况下登录**：
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

由于**Azure** **portal**没有限制，可以从portal端点收集令牌以访问之前执行中检测到的任何服务。在这种情况下，已经识别出Sharepoint，并请求了一个访问它的令牌：
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune Read-JWTtoken -token $token.access_token
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

令牌具有Sites.Read.All权限（来自Sharepoint）：

<figure><img src="../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

即使由于多因素身份验证（MFA）而无法通过Web访问Sharepoint，也可以使用令牌访问生成的令牌中的文件：
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_28_26-Window.png" alt=""><figcaption></figcaption></figure>

获取下载文件的URL：

<figure><img src="../../.gitbook/assets/2023-03-06 17_28_50-Window.png" alt=""><figcaption></figcaption></figure>

## 参考资料

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载HackTricks的PDF，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
