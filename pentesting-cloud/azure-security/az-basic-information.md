# Az - 基本信息

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 组织层次结构

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### 管理组

如果您的组织拥有**多个Azure订阅**，您可能需要一种有效地**管理访问权限**、策略和合规性的方式来管理这些**订阅**。**管理组**提供了一个**高于订阅的治理范围**。

请注意，单个目录中可以支持**10,000个管理组**，管理组树可以支持**最多六级深度**。

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[来自文档](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory)：每个目录都有一个名为**根管理组**的**顶级管理组**。根管理组内置于层次结构中，**所有管理组和订阅都折叠到它**。这个根管理组允许在目录级别应用**全局策略和Azure角色分配**。[Azure AD **全局管理员需要提升自己的权限](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin)** 到此根组的**用户访问管理员角色**。提升访问权限后，管理员可以**将任何Azure角色分配给其他目录用户或组以管理层次结构**。作为管理员，您可以将**自己的帐户分配为根管理组的所有者**。

与其他管理组不同，**根管理组** **无法移动或删除**。

管理组为您提供了企业级的管理规模，无论您可能拥有什么类型的订阅。但是，**单个管理组内的所有订阅**必须信任**相同的Azure Active Directory（Azure AD）租户**。

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azure订阅

在Azure中，订阅作为一个**逻辑容器**，用于**提供**业务或技术**资源**。该容器维护了诸如虚拟机（VM）、数据库等资源的**详细信息**。在创建Azure资源（如VM）时，会指定**与之关联的订阅**。这种结构有助于利用基于角色的访问控制机制进行访问权限委派。

### 资源组

[来自文档：](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) 资源组是一个**容器**，用于保存Azure解决方案的**相关资源**。资源组可以包含解决方案的所有资源，或者仅包含您希望作为一个组进行管理的**资源**。通常，将**共享相同生命周期的资源**添加到同一资源组中，以便您可以轻松地将它们作为一个组进行部署、更新和删除。

所有的**资源**必须**位于资源组内**，并且只能属于一个组，如果删除资源组，则其中的所有资源也将被删除。

### 管理单元

[来自文档：](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) 管理单元允许您将组织**细分**为**任何您想要的单元**，然后**分配特定管理员**，这些管理员可以**仅管理该单元的成员**。例如，您可以使用管理单元将权限委派给大学中每个学院的管理员，以便他们可以仅在工程学院中控制访问权限、管理用户并设置策略。

只有**用户**、**组**和**设备**可以成为**管理单元**的**成员**。

因此，一个**管理单元**将**包含**一些**成员**，其他**主体**将被**分配权限**以**管理**管理单元的**成员**。

## Azure vs Azure AD vs Azure AD域服务

重要的是要注意，**Azure AD**是**Azure**内的一个服务。**Azure**是微软的**云平台**，而**Azure AD**是Azure中的企业**身份****服务**。\
此外，**Azure AD不同于Windows Active Directory**，它是一种以完全不同方式工作的身份服务。如果您想在Azure中为Windows Active Directory环境运行**域控制器**，您需要使用**Azure AD域服务**。

## 主体

Azure支持不同类型的主体：

* **用户**：具有凭据以访问的**普通人**。
* **组**：一组**一起管理的主体**。授予组的**权限**将被其**成员**所**继承**。
* **服务主体/企业应用程序**：这是为**应用程序**、托管服务和自动化工具创建的**身份**，用于访问Azure资源。通过分配给服务主体的角色，可以控制**可以访问哪些资源**以及在哪个级别。出于安全原因，始终建议**使用服务主体与自动化工具**，而不是允许它们使用用户身份登录。

创建**服务主体**时，可以选择**密码身份验证**或**证书身份验证**。

* 如果选择**密码**身份验证（默认情况下），请**保存生成的密码**，因为您将无法再次访问它。
* 如果选择证书身份验证，请确保**应用程序将具有对私钥的访问权限**。
* **托管标识（元数据凭证）**：Azure Active Directory中的托管标识为**自动管理应用程序的身份**提供了解决方案。这些标识由应用程序用于连接与Azure Active Directory（Azure AD）身份验证兼容的资源。通过使用托管标识，应用程序可以**安全地获取Azure AD令牌**，同时无需直接处理凭据。有两种类型的托管标识：
* **系统分配**。一些Azure服务允许您**直接在服务实例上启用托管标识**。启用系统分配的托管标识时，将在Azure AD中创建一个标识。该标识与该服务实例的**生命周期绑定**。当**资源**被**删除**时，Azure会自动为您**删除**该**标识**。按设计，只有该Azure资源可以使用此标识向Azure AD请求令牌。
* **用户分配**。您还可以将托管标识作为一个独立的Azure资源创建。您可以[创建用户分配的托管标识](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) 并将其分配给一个或**多个Azure服务实例**（多个资源）。对于用户分配的托管标识，**标识**将**独立于使用它的资源**进行管理。
## 角色和权限

**角色**被分配给**主体**在一个**范围**上：`principal -[HAS ROLE]->(scope)`

分配给**组**的**角色**将被所有**组成员**继承。

根据分配角色的范围，**角色**可能被继承到范围容器内的**其他资源**。例如，如果用户A在**订阅上有一个角色**，他将在订阅内的所有资源组和资源组内的**所有资源**上拥有该**角色**。

### **经典角色**

| **所有者**                     | <ul><li>对所有资源具有完全访问权限</li><li>可以管理其他用户的访问权限</li></ul> | 所有资源类型 |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **参与者**               | <ul><li>对所有资源具有完全访问权限</li><li>无法管理访问权限</li></ul>              | 所有资源类型 |
| **读取者**                    | • 查看所有资源                                                                     | 所有资源类型 |
| **用户访问管理员** | <ul><li>查看所有资源</li><li>可以管理其他用户的访问权限</li></ul>           | 所有资源类型 |

### 内置角色

[从文档中：](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure基于角色的访问控制（Azure RBAC）](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)有几个Azure **内置角色**，您可以将其分配给**用户、组、服务主体和托管标识**。角色分配是您控制对**Azure资源访问**的方式。如果内置角色不符合您组织的特定需求，您可以创建自己的[**Azure自定义角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**。**

**内置**角色仅适用于它们**所针对的资源**，例如检查这两个**内置角色在计算资源上的示例**：

| [磁盘备份读取器](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | 允许备份库执行磁盘备份。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [虚拟机用户登录](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | 在门户中查看虚拟机并作为普通用户登录。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

这些角色也可以**分配给逻辑容器**（如管理组、订阅和资源组），受影响的主体将在这些容器内的资源上拥有这些角色。

* 在此处找到[**所有Azure内置角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)的列表。
* 在此处找到[**所有Azure AD内置角色**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)的列表。

### 自定义角色

Azure还允许创建[**自定义角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)，具有用户所需的权限。

### 权限被拒绝

* 为了使**主体对资源具有某些访问权限**，他需要被授予一个明确的角色（无论如何）**授予他该权限**。
* 明确的**拒绝角色分配优先于**授予权限的角色。

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### 全局管理员

具有全局管理员角色的用户可以将**“提升”到用户访问管理员Azure角色到根管理组**。这意味着全局管理员将能够管理**所有Azure订阅和管理组的访问权限。**\
此提升可以在此页面底部完成：[https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure策略

Azure策略是Microsoft Azure云计算服务中的一组**规则和规定**，有助于管理和执行组织标准，并在规模上评估合规性。这些策略对您的**Azure资源**实施不同的规则，确保这些资源符合公司标准和服务级别协议。

Azure策略对云治理和安全至关重要，有助于确保资源被正确和高效地使用，并且符合外部法规和内部政策。\
一些示例：

1. **确保符合特定Azure区域的合规性**：此策略确保所有资源部署在特定的Azure区域。例如，公司可能希望确保所有数据存储在欧洲以符合GDPR合规性。
2. **强制执行命名标准**：策略可以强制执行Azure资源的命名约定。这有助于根据名称组织和轻松识别资源，这在大型环境中很有帮助。
3. **限制某些资源类型**：此策略可以限制创建某些类型的资源。例如，可以设置策略以阻止创建昂贵的资源类型，如某些VM大小，以控制成本。
4. **强制执行标记策略**：标记是与Azure资源关联的键值对，用于资源管理。策略可以强制执行所有资源必须具有特定标记，或具有特定值。这对于成本跟踪、所有权或资源分类很有用。
5. **限制对资源的公共访问**：策略可以强制执行某些资源，如存储账户或数据库，没有公共端点，确保它们仅在组织网络内可访问。
6. **自动应用安全设置**：策略可用于自动将安全设置应用于资源，例如将特定网络安全组应用于所有VM或确保所有存储账户使用加密。

请注意，Azure策略可以附加到Azure层次结构的任何级别，但它们通常用于根管理组或其他管理组中。

### 权限范围

在Azure中，**权限可以分配给层次结构的任何部分**。这包括管理组、订阅、资源组和单个资源。权限将被分配的实体的包含**资源**继承。

这种分层结构允许有效和可扩展的访问权限管理。

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC与ABAC

**RBAC**（基于角色的访问控制）是我们在前面部分已经看到的：**将角色分配给主体以授予他访问权限**。\
然而，在某些情况下，您可能希望提供**更精细的访问管理**或**简化****数百个角色分配**的管理。

Azure **ABAC**（基于属性的访问控制）在Azure RBAC基础上添加了**基于特定操作上下文中的属性的角色分配条件**。_角色分配条件_是您可以选择添加到角色分配中的**附加检查**，以提供更精细的访问控制。条件会过滤掉作为角色定义和角色分配的一部分授予的权限。例如，您可以**添加一个条件，要求对象具有特定标记才能读取该对象**。\
您**不能**使用条件**显式拒绝**对特定资源的**访问**。
### 默认用户权限

基本用户将具有一些**默认权限**来枚举 AzureAD 的一些部分：

- 读取所有用户、组、应用程序、设备、角色、订阅和它们的公共属性
- 邀请访客（_可以关闭_）
- 创建安全组
- 读取非隐藏的组成员
- 将访客添加到拥有的组
- 创建新应用程序（_可以关闭_）
- 将最多 50 个设备添加到 Azure（_可以关闭_）

您可以在文档中查看[用户的**默认权限列表**](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions)。此外，请注意在该列表中您还可以查看**访客的默认权限列表**。

{% hint style="info" %}
请记住，要枚举 Azure 资源，用户需要明确授予权限。
{% endhint %}

### 特权身份管理（PIM）

Azure 中的特权身份管理（PIM）是一种工具，用于在 Azure Active Directory 和 Azure 中**管理、控制和监视特权访问**。它通过提供**即时和限时的特权访问**、**强制批准工作流程**和**要求额外身份验证**来增强安全性。这种方法通过确保仅在必要时且特定时间内授予提升的权限，最大程度地减少了未经授权访问的风险。

## 认证令牌

OIDC 中使用**三种类型的令牌**：

- [**访问令牌**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**：**客户端向资源服务器呈现此令牌以**访问资源**。它仅可用于特定的用户、客户端和资源组合，并且**在到期之前无法撤销** - 默认为 1 小时。使用此方法检测风险较低。
- **ID 令牌**：客户端从授权服务器接收此**令牌**。它包含有关用户的基本信息。它**绑定到特定的用户和客户端**。
- **刷新令牌**：与访问令牌一起提供给客户端。用于**获取新的访问和 ID 令牌**。它绑定到特定的用户和客户端，并且可以被撤销。对于不活跃的刷新令牌，默认到期时间为**90 天**，对于活跃令牌则**没有到期时间**。

{% hint style="warning" %}
**有条件访问**的信息**存储**在**JWT**中。因此，如果您从**允许的 IP 地址请求令牌**，那么该**IP**将被**存储**在令牌中，然后您可以使用该令牌从**不允许的 IP 访问资源**。
{% endhint %}

查看以下页面以了解不同的方式**请求访问令牌**并使用它们登录：

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

最常见的 API 端点包括：

- **Azure 资源管理器**（ARM）：management.azure.com
- **Microsoft Graph**：graph.microsoft.com（已弃用的 Azure AD Graph 是 graph.windows.net）

## 参考资料

- [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
- [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
- [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
- [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

- 如果您想在 HackTricks 中看到您的**公司广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
- 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT**](https://opensea.io/collection/the-peass-family) 收藏品
- **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
- 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
