# Az - 기본 정보

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 조직 계층

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### 관리 그룹

조직에 **여러 Azure 구독**이 있는 경우 **구독에 대한 액세스**, 정책 및 규정을 효율적으로 **관리**해야 할 수 있습니다. **관리 그룹**은 **구독 위에 있는 관리 범위**를 제공합니다.

참고로 **10,000개의 관리 그룹**을 단일 디렉터리에서 지원할 수 있으며, 관리 그룹 트리는 **최대 여섯 단계의 깊이**를 지원할 수 있습니다.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

[문서에서](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory)는 각 디렉터리에는 **루트** 관리 그룹이라는 **최상위 관리 그룹**이 있습니다. 루트 관리 그룹은 **모든 관리 그룹과 구독이 포함**되도록 계층 구조에 내장되어 있습니다. 이 루트 관리 그룹을 사용하면 디렉터리 수준에서 **전역 정책 및 Azure 역할 할당**을 적용할 수 있습니다. [Azure AD **Global Administrator**는](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) 초기에 이 루트 그룹의 **사용자 액세스 관리자 역할**로 승격해야 합니다. 액세스를 승격한 후 관리자는 **다른 디렉터리 사용자 또는 그룹에 Azure 역할을 할당**할 수 있습니다. 관리자로서, 루트 관리 그룹의 소유자로 **자신의 계정을 할당**할 수 있습니다.

루트 관리 그룹은 다른 관리 그룹과 달리 **이동하거나 삭제할 수 없습니다**.

관리 그룹은 어떤 유형의 구독이든 규모에 맞는 기업급 관리를 제공합니다. 그러나 **단일 관리 그룹 내의 모든 구독**은 **동일한 Azure Active Directory (Azure AD) 테넌트**를 신뢰해야 합니다.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Azure 구독

Azure에서 구독은 비즈니스 또는 기술 **리소스를 프로비저닝**하기 위한 **논리적인 컨테이너**로 작동합니다. 이 컨테이너는 가상 머신 (VM), 데이터베이스 등과 같은 **리소스의 세부 정보**를 유지합니다. VM과 같은 Azure 리소스의 생성 시 **해당 구독이 지정**됩니다. 이 구조는 역할 기반 액세스 제어 메커니즘을 활용하여 액세스 위임을 용이하게 합니다.

### 리소스 그룹

[문서에서:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) 리소스 그룹은 Azure 솔루션에 대한 **관련 리소스를 보유하는 컨테이너**입니다. 리소스 그룹에는 솔루션의 모든 리소스 또는 **그룹으로 관리하려는 리소스만 포함**될 수 있습니다. 일반적으로 **동일한 라이프사이클을 공유하는 리소스**를 동일한 리소스 그룹에 추가하여 그룹으로 쉽게 배포, 업데이트 및 삭제할 수 있습니다.

**모든 리소스**는 **리소스 그룹 내에 있어야**하며, 그룹에만 속할 수 있으며, 리소스 그룹이 삭제되면 그 안에 있는 모든 리소스도 삭제됩니다.

### 관리 단위

[문서에서:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) 관리 단위를 사용하면 조직을 원하는 **임의의 단위로 세분화**한 다음 해당 단위의 **특정 관리자**를 할당할 수 있습니다. 예를 들어, 대학교의 각 학교의 관리자에게 권한을 위임하여 공학 학부에서만 액세스를 제어하고 사용자를 관리하고 정책을 설정할 수 있습니다.

**사용자**, **그룹** 및 **장치**만 **관리 단위의 구성원**이 될 수 있습니다.

따라서 **관리 단위**에는 일부 **구성원**이 포함되며, 다른 **주체**는 해당 관리 **단위의 구성원을 관리**하는 데 사용할 수 있는 권한이 할당됩니다.

## Azure vs Azure AD vs Azure AD Domain Services

**Azure AD**는 **Azure** 내부의 서비스입니다. **Azure**는 Microsoft의 **클라우드 플랫폼**이고, **Azure AD**는 Azure의 기업 **신원 서비스**입니다.\
또한, **Azure AD는 Windows Active Directory와 같지 않습니다**. Azure에서 Windows Active Directory 환경에 대한 **도메인 컨트롤러를 실행**하려면 **Azure AD Domain Services**를 사용해야 합니다.

## 주체

Azure는 다양한 유형의 주체를 지원합니다:

* **사용자**: 자격 증명을 사용하여 액세스할 수 있는 일반 **사람**입니다.
* **그룹**: 함께 관리되는 **주체 그룹**입니다. 그룹에 부여된 **권한**은 그룹의 **구성원**에게 **상속**됩니다.
* **서비스 주체/기업 애플리케이션**: Azure 리소스에 액세스하기 위해 **애플리케이션**, 호스팅 서비스 및 자동화된 도구와 함께 사용되는 **신원**입니다. 이 액세스는 서비스 주체에 할당된 역할에 의해 **제한**됩니다. 이를 통해 **어떤 리소
## 역할 및 권한

**역할**은 **주체**에게 **범위**에 할당됩니다: `주체 -[역할 보유]->(범위)`

**그룹에 할당된 역할**은 그룹의 **모든 구성원**에게 **상속**됩니다.

역할이 할당된 범위에 따라 해당 **역할**은 범위 컨테이너 내의 **다른 리소스**에게도 **상속**될 수 있습니다. 예를 들어, 사용자 A가 **구독에 역할을 가지고 있다면**, 해당 사용자는 구독 내의 **모든 리소스 그룹** 및 리소스 그룹 내의 **모든 리소스**에 대해 해당 **역할을 가질 것**입니다.

### **클래식 역할**

| **소유자**                     | <ul><li>모든 리소스에 대한 전체 액세스</li><li>다른 사용자의 액세스 관리 가능</li></ul> | 모든 리소스 유형 |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **기여자**               | <ul><li>모든 리소스에 대한 전체 액세스</li><li>액세스 관리 불가능</li></ul>              | 모든 리소스 유형 |
| **리더**                    | • 모든 리소스 보기                                                                     | 모든 리소스 유형 |
| **사용자 액세스 관리자** | <ul><li>모든 리소스 보기</li><li>다른 사용자의 액세스 관리 가능</li></ul>           | 모든 리소스 유형 |

### 내장된 역할

[문서에서 참조: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure 역할 기반 액세스 제어 (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)에는 사용자, 그룹, 서비스 주체 및 관리 식별자에 할당할 수 있는 여러 Azure **내장된 역할**이 있습니다. 역할 할당은 **Azure 리소스에 대한 액세스를 제어하는 방법**입니다. 내장된 역할이 조직의 특정 요구 사항을 충족하지 못하는 경우 [**Azure 사용자 정의 역할**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)을 만들 수 있습니다.

**내장된** 역할은 **해당 리소스에만 적용**됩니다. 예를 들어, **Compute** 리소스에 대한 **내장된 역할 2개의 예**를 확인하세요:

| [디스크 백업 리더](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | 디스크 백업 수행을 위한 백업 보관소에 대한 권한 제공      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [가상 머신 사용자 로그인](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | 포털에서 가상 머신 보기 및 일반 사용자로 로그인 가능 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

이러한 역할은 논리 컨테이너(관리 그룹, 구독 및 리소스 그룹과 같은)에도 **할당**될 수 있으며, 영향을 받는 주체는 해당 컨테이너 내의 **리소스에 대해 해당 역할을 가질 것**입니다.

* [**모든 Azure 내장된 역할**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)의 목록을 여기에서 찾을 수 있습니다.
* [**모든 Azure AD 내장된 역할**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)의 목록을 여기에서 찾을 수 있습니다.

### 사용자 정의 역할

Azure는 사용자가 필요한 권한으로 [**사용자 정의 역할**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)을 생성할 수도 있습니다.

### 액세스 거부

* **주체가 리소스에 대한 일부 액세스를 가져야 한다면**, 해당 권한을 부여하는 **명시적 역할이 그에게 부여**되어야 합니다.
* **액세스 거부 역할 할당은 권한을 부여하는 역할보다 우선**합니다.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### 전역 관리자

전역 관리자 역할을 가진 사용자는 '**사용자 액세스 관리자 Azure 역할을 루트 관리 그룹에 승격**'할 수 있습니다. 이는 전역 관리자가 **모든 Azure 구독 및 관리 그룹에 대한 액세스를 관리**할 수 있음을 의미합니다.\
이 승격은 다음 페이지에서 수행할 수 있습니다: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure 정책

Azure 정책은 Microsoft Azure의 규칙과 규정으로, 조직의 표준을 관리하고 강제로 시행하며 규모에 맞게 준수를 평가하는 데 도움이 되는 클라우드 컴퓨팅 서비스입니다. 이러한 정책은 Azure 리소스에 대해 다양한 규칙을 시행하여 해당 리소스가 기업 표준과 서비스 수준 계약을 준수하도록 보장합니다.

Azure 정책은 클라우드 거버넌스와 보안에 중요한 역할을 합니다. 리소스가 올바르고 효율적으로 사용되며 외부 규정 및 내부 정책을 준수하는지 확인하는 데 도움이 됩니다.\
일부 예시:

1. **특정 Azure 지역과의 규정 준수 보장**: 이 정책은 모든 리소스가 특정 Azure 지역에 배포되도록 보장합니다. 예를 들어, GDPR 준수를 위해 모든 데이터를 유럽에 저장하도록 회사가 원할 수 있습니다.
2. **이름 표준 강제 적용**: 정책은 Azure 리소스의 이름 규칙을 강제로 적용할 수 있습니다. 이는 이름을 기반으로 리소스를 구성하고 쉽게 식별하는 데 도움이 됩니다.
3. **특정 리소스 유형 제한**: 이 정책은 특정 유형의 리소스 생성을 제한할 수 있습니다. 예를 들어, 정책을 설정하여 특정 VM 크기와 같은 비용이 많이 드는 리소스 유형의 생성을 방지하여 비용을 제어할 수 있습니다.
4. **태그 정책 강제 적용**: 태그는 리소스 관리에 사용되는 Azure 리소스와 관련된 키-값 쌍입니다. 정책은 모든 리소스에 대해 특정 태그가 있거나 특정 값을 가져야 함을 강제로 적용할 수 있습니다. 이는 비용 추적, 소유권 또는 리소스의 분류에 유용합니다.
5. **리소스에 대한 공개 액세스 제한**: 정책은 저장소 계정이나 데이터베이스와 같은 특정 리소스가 공개 엔드포인트를 가지지 않도록 강제로 적용하여 해당 리소스가 조직의 네트워크 내에서만 액세스할 수 있도록 보장할 수 있습니다.
6. **보안 설정 자동 적용**: 정
### 기본 사용자 권한

기본 사용자는 AzureAD의 일부를 열거하기 위해 일부 **기본 권한**을 갖습니다:

* 모든 사용자, 그룹, 애플리케이션, 장치, 역할, 구독 및 공개 속성 읽기
* 게스트 초대 (_비활성화 가능_)
* 보안 그룹 생성
* 숨겨지지 않은 그룹 멤버십 읽기
* 소유한 그룹에 게스트 추가
* 새로운 애플리케이션 생성 (_비활성화 가능_)
* 최대 50개의 장치를 Azure에 추가

전체 [**사용자의 기본 권한 목록**을 문서에서 확인할 수 있습니다](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). 또한 해당 목록에서 **게스트의 기본 권한 목록**도 확인할 수 있습니다.

{% hint style="info" %}
Azure 리소스를 열거하려면 사용자에게 명시적으로 권한이 부여되어야 함을 기억하세요.
{% endhint %}

### 특권 ID 관리 (PIM)

Azure의 특권 ID 관리 (PIM)은 Azure Active Directory 및 Azure에서 **특권 액세스를 관리, 제어 및 모니터링**하는 도구입니다. 이는 **즉시 및 시간 제한된 특권 액세스**, **승인 워크플로우 강제 적용 및 추가 인증 요구**를 제공함으로써 보안을 강화합니다. 이 접근 방식은 특정 기간 동안 필요한 경우에만 상승된 권한이 부여되어 무단 액세스의 위험을 최소화합니다.

## 인증 토큰

OIDC에서는 **세 가지 유형의 토큰**을 사용합니다:

* [**액세스 토큰**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** 클라이언트는 이 토큰을 리소스 서버에 제공하여 **리소스에 액세스**합니다. 이는 특정 사용자, 클라이언트 및 리소스의 조합에만 사용할 수 있으며 만료까지 **폐기할 수 없습니다** - 기본적으로 1시간입니다. 이를 사용하여 감지가 어렵습니다.
* **ID 토큰**: 클라이언트는 이 토큰을 **인증 서버에서 받습니다**. 사용자에 대한 기본 정보가 포함되어 있습니다. 특정 사용자 및 클라이언트의 조합에 **바인딩**됩니다.
* **새로 고침 토큰**: 액세스 토큰과 함께 클라이언트에 제공됩니다. 새로운 액세스 및 ID 토큰을 가져오는 데 사용됩니다. 특정 사용자 및 클라이언트의 조합에 바인딩되며 폐기할 수 있습니다. 비활성 새로 고침 토큰의 기본 만료 기간은 **90일**이며 활성 토큰의 경우 만료 기간이 없습니다.

{% hint style="warning" %}
**조건부 액세스**에 대한 정보는 **JWT**에 **저장**됩니다. 따라서 **허용된 IP 주소에서 토큰을 요청**하면 해당 **IP**가 토큰에 **저장**되고 그런 다음 **허용되지 않은 IP에서 해당 토큰을 사용하여 리소스에 액세스**할 수 있습니다.
{% endhint %}

다음 페이지에서 **액세스 토큰을 요청**하고 해당 토큰으로 로그인하는 다양한 방법을 알아보세요:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

가장 일반적인 API 엔드포인트는 다음과 같습니다:

* **Azure 리소스 관리자** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (사용이 중단된 Azure AD Graph은 graph.windows.net)

## 참고 자료

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹을 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고**하거나 **PDF로 HackTricks를 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **자신의 해킹 기법을 공유**하세요.

</details>
