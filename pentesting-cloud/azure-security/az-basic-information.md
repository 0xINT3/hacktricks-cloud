# Az - 基本情報

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を通じて、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手してください
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つけてください
- **Discordグループ**に参加する💬(https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローしてください。
- **HackTricks**（https://github.com/carlospolop/hacktricks）と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## 組織階層

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### 管理グループ

組織に **多くのAzureサブスクリプション**がある場合、これらの **サブスクリプション**の **アクセス**、ポリシー、コンプライアンスを効率的に **管理**する方法が必要になる場合があります。 **管理グループ**は、 **サブスクリプションよりも上位のガバナンススコープ**を提供します。

1つのディレクトリで **10,000の管理グループ**をサポートし、管理グループツリーは **最大6階層の深さ**をサポートできます。

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[ドキュメントから](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): 各ディレクトリには、 **ルート管理グループと呼ばれる単一の最上位管理グループ**が与えられます。 ルート管理グループは、 **すべての管理グループとサブスクリプションがそれに折りたたまれる**ように階層に組み込まれています。 このルート管理グループには、 **グローバルポリシーとAzureロールの割り当て**がディレクトリレベルで適用できます。 [Azure AD **Global Administrator は、最初にこのルートグループのユーザーアクセス管理者ロールに昇格する必要があります**](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin)。 アクセスを昇格させた後、管理者は、他のディレクトリユーザーまたはグループにAzureロールを割り当てて階層を管理できます。 管理者として、 **自分のアカウントをルートの所有者として割り当てることができます**。

ルート管理グループは、他の管理グループとは異なり、 **移動または削除できません**。

管理グループを使用すると、どのような種類のサブスクリプションがあっても、スケールでエンタープライズグレードの管理が可能です。 ただし、 **単一の管理グループ内のすべてのサブスクリプション**は、 **同じAzure Active Directory（Azure AD）テナントを信頼する必要があります**。

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Azureサブスクリプション

Azureでは、サブスクリプションは、ビジネスや技術の **リソースをプロビジョニング**するための **論理的なコンテナ**として機能します。 このコンテナは、仮想マシン（VM）、データベースなどのリソースの詳細を維持します。 VMなどのAzureリソースの作成時には、それに関連付けられた **サブスクリプションが指定**されます。 この構造により、ロールベースのアクセス制御メカニズムを利用してアクセスを委任することが容易になります。

### リソースグループ

[ドキュメントから：](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) リソースグループは、Azureソリューションの **関連するリソース**を保持する **コンテナ**です。 リソースグループには、ソリューションのすべてのリソース、または **グループとして管理したいリソースのみ**を含めることができます。 通常、 **ライフサイクルを共有するリソース**を同じリソースグループに追加して、グループとして簡単に展開、更新、削除できるようにします。

すべての **リソース**は **リソースグループ内**にあり、グループにのみ属することができ、リソースグループが削除されると、それに含まれるすべてのリソースも削除されます。

### 管理ユニット

[ドキュメントから：](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) 管理ユニットを使用すると、組織を **任意の単位**に **細分化**し、そのユニットの **メンバーだけを管理できる特定の管理者**を **割り当てる**ことができます。 たとえば、大学の各学部の管理者に権限を委任して、工学部のみでアクセスを制御し、ユーザーを管理し、ポリシーを設定できるようにするために、管理ユニットを使用できます。

**ユーザー**、**グループ**、**デバイス**のみが **管理ユニット**の **メンバー**になることができます。

したがって、 **管理ユニット**にはいくつかの **メンバー**が含まれ、他の **主体**はその管理ユニットを管理するために使用できる権限が **割り当てられます**。

## Azure vs Azure AD vs Azure AD Domain Services

重要なのは、**Azure AD**は **Azure**の中にあるサービスです。 **Azure**はMicrosoftの **クラウドプラットフォーム**であり、**Azure AD**はAzure内のエンタープライズ **アイデンティティサービス**です。\
さらに、**Azure ADはWindows Active Directoryとは異なり**、完全に異なる方法で機能するアイデンティティサービスです。 Windows Active Directory環境で **ドメインコントローラーをAzureで実行**したい場合は、**Azure AD Domain Services**を使用する必要があります。

## 主体

Azureは異なるタイプの主体をサポートしています:

- **ユーザー**: アクセス権を持つ **通常の人**
- **グループ**: 一緒に管理される **主体のグループ**。 グループに付与された **権限** は、その **メンバー** に **継承** されます。
- **サービスプリンシパル/エンタープライズアプリケーション**: **アプリケーション**、ホストされるサービス、およびAzureリソースにアクセスするために作成された **アイデンティティ**。 このアクセスは、サービスプリンシパルに割り当てられた **ロールによって制限** され、 **どのリソースにアクセスできるか** およびどのレベルでアクセスできるかを制御します。 セキュリティ上の理由から、 **自動化ツールでサービスプリンシパルを使用** することが常に推奨されます。

**サービスプリンシパル**を作成する際には、 **パスワード認証** または **証明書認証** のいずれかを選択できます。

- パスワード認証を選択した場合（デフォルト）、 **生成されたパスワードを保存** しておく必要があります。
- 証明書認証を選択した場合は、 **アプリケーションがプライベートキーにアクセスできるように** してください。
- **管理されたアイデンティティ（メタデータ認証情報）**: Azure Active Directoryの管理されたアイデンティティは、アプリケーションの **アイデンティティを自動的に管理する** 解決策を提供します。 これらのアイデンティティは、Azure Active Directory（Azure AD）認証に対応したリソースに接続するためにアプリケーションによって使用されます。 管理されたアイデンティティを利用することで、アプリケーションは **Azure ADトークンを安全に保護** しながら、直接資格情報を処理する必要がなくなります。 2種類の管理されたアイデンティティがあります:
  - **システム割り当て**。一部のAzureサービスでは、サービスインスタンスに **直接管理されたアイデンティティを有効にする**ことができます。 システム割り当ての管理されたアイデンティティを有効にすると、Azure ADにアイデンティティが作成されます。 このアイデンティティは、そのサービスインスタンスの **ライフサイクルに結び付けられています**。 リソースが **削除** されると、Azureは自動的に **そのアイデンティティを削除** します。 設計上、そのAzureリソースだけがこのアイデンティティを使用してAzure ADからトークンを要求できます。
  - **ユーザー割り当て**。スタンドアロンのAzureリソースとして管理されたアイデンティティを作成することもできます。 ユーザー割り当ての管理されたアイデンティティを作成し、Azureサービスの1つまたは **複数のインスタンス**（複数のリソース）に割り当てることができます。 ユーザー割り当ての管理されたアイデンティティでは、 **そのアイデンティティを使用するリソースとは別に管理** されます。
## ロールと権限

**ロール**は**スコープ**に**主体**に**割り当てられます**: `主体 -[HAS ROLE]->(スコープ)`

**グループに割り当てられたロール**は、**グループのすべてのメンバー**に**継承**されます。

割り当てられたロールがスコープによって異なり、例えば、ユーザーAが**サブスクリプションにロールを持っている**場合、その**ユーザーはサブスクリプション内のすべてのリソースグループ**および**リソースグループ内のすべてのリソース**にその**ロールを持つ**ことになります。

### **クラシックロール**

| **所有者**                     | <ul><li>すべてのリソースへのフルアクセス</li><li>他のユーザーのアクセスを管理できる</li></ul> | すべてのリソースタイプ |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **寄稿者**               | <ul><li>すべてのリソースへのフルアクセス</li><li>アクセスを管理できない</li></ul>              | すべてのリソースタイプ |
| **リーダー**                    | • すべてのリソースを表示                                                                     | すべてのリソースタイプ |
| **ユーザーアクセス管理者** | <ul><li>すべてのリソースを表示</li><li>他のユーザーのアクセスを管理できる</li></ul>           | すべてのリソースタイプ |

### 組み込みロール

[ドキュメントから: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure ロールベースのアクセス制御 (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)には、**ユーザー、グループ、サービスプリンシパル、および管理された ID**に**割り当てることができるいくつかの Azure **組み込みロール**があります。ロールの割り当ては、**Azure リソースへのアクセス**を制御する方法です。組み込みのロールが組織の特定のニーズを満たさない場合は、[**Azure カスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**を作成**することができます。

**組み込み**のロールは、それが**意図されているリソース**にのみ適用されます。たとえば、**Compute**リソースに対する**2つの組み込みロール**の例を確認してください:

| [ディスクバックアップリーダー](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | ディスクバックアップを実行するためのバックアップボールトの権限を提供します。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [仮想マシンユーザーログイン](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | ポータルで仮想マシンを表示し、通常のユーザーとしてログインします。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

これらのロールは**ロジックコンテナ**（管理グループ、サブスクリプション、リソースグループなど）にも**割り当てることができ**、影響を受ける主体はそれらのコンテナ内のリソースにそれらを持つことになります。

* [**すべての Azure 組み込みロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)のリストはこちらで見つけることができます。
* [**すべての Azure AD 組み込みロール**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)のリストはこちらで見つけることができます。

### カスタムロール

Azureでは、ユーザーが必要とする権限を持つ[**カスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)を作成することもできます。

### アクセスが拒否されました

**主体がリソースにアクセス権を持つ**ためには、**明示的なロールが割り当てられ**（どのようにであれ）**その権限が与えられる**必要があります。
明示的な**拒否ロール割り当ては**、権限を付与するロールよりも**優先されます**。

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### グローバル管理者

グローバル管理者ロールを持つユーザーは、**User Access Administrator Azure ロールをルート管理グループに昇格**する権限を持っています。これにより、グローバル管理者は**すべての Azure サブスクリプションと管理グループを管理**することができます。\
この昇格は次のページの最後で行うことができます: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Azure ポリシー

Azure ポリシーは、Microsoft Azureの**ルールと規制**のセットであり、組織の基準を管理し、規制順守を評価するのに役立ちます。これらのポリシーは、異なるルールを**Azure リソース**に強制し、それらのリソースが企業の基準とサービスレベル契約に準拠していることを確認します。

Azure ポリシーは、クラウドガバナンスとセキュリティに不可欠であり、リソースが適切かつ効率的に使用され、外部規制および内部ポリシーに準拠していることを確認します。\
いくつかの例:

1. **特定の Azure リージョンへの準拠の確保**: このポリシーは、すべてのリソースが特定の Azure リージョンに展開されることを確認します。たとえば、企業は GDPR の準拠のためにすべてのデータをヨーロッパに保存することを望むかもしれません。
2. **命名規則の強制**: ポリシーは Azure リソースの命名規則を強制できます。これにより、名前に基づいてリソースを整理および簡単に識別することができ、大規模な環境で役立ちます。
3. **特定のリソースタイプの制限**: このポリシーは、特定の種類のリソースの作成を制限できます。たとえば、特定の VM サイズなどの高価なリソースタイプの作成を防止するためにポリシーを設定できます。
4. **タグ付けポリシーの強制**: タグは、Azure リソースに関連付けられたキーと値のペアで、リソース管理に使用されます。ポリシーは、すべてのリソースに特定のタグが存在するか、特定の値を持つ必要があることを強制できます。これは、コスト追跡、所有権、またはリソースのカテゴリ分類に役立ちます。
5. **リソースへの公開アクセスの制限**: ポリシーは、ストレージアカウントやデータベースなどの特定のリソースが公開エンドポイントを持たないように強制し、それらが組織のネットワーク内でのみアクセス可能であることを確認します。
6. **セキュリティ設定の自動適用**: ポリシーは、リソースにセキュリティ設定を自動的に適用するために使用できます。たとえば、すべての VM に特定のネットワークセキュリティグループを適用したり、すべてのストレージアカウントが暗号化を使用するようにしたりすることができます。

Azure ポリシーは Azure 階層の**任意のレベルにアタッチ**できますが、**一般的にはルート管理グループ**や他の管理グループで使用されます。

### 権限スコープ

Azureでは、**権限は階層の任意の部分に割り当てる**ことができます。これには、管理グループ、サブスクリプション、リソースグループ、個々のリソースが含まれます。権限は、割り当てられたエンティティの**含まれるリソース**によって**継承**されます。

この階層構造により、アクセス権限の効率的かつスケーラブルな管理が可能となります。

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC**（ロールベースのアクセス制御）は、以前のセクションで見たように、**主体にロールを割り当ててアクセス権を付与**することです。\
ただし、場合によっては、**より細かいアクセス管理**を提供したり、**何百ものロール割り当て**を**簡素化**することが望ましい場合があります。

Azure **ABAC**（属性ベースのアクセス制御）は、Azure RBACに**特定のアクションのコンテキストで属性に基づいたロール割り当て条件を追加**することで構築されます。**ロール割り当て条件**は、**ロール定義およびロール割り当ての一部としてオプションで追加できる追加チェック**です。たとえば、**特定のタグを持つオブジェクトがオブジェクトを読むために必要**であるという条件を追加できます。\
**条件を使用して特定のリソースへのアクセスを明示的に拒否することはできません**。
### デフォルトユーザー権限

基本ユーザーはAzureADの一部を列挙するためのいくつかの**デフォルト権限**を持ちます：

- すべてのユーザー、グループ、アプリケーション、デバイス、ロール、サブスクリプション、およびそれらの公開プロパティを読む
- ゲストを招待する（_オフにできる_）
- セキュリティグループを作成する
- 非表示のグループメンバーシップを読む
- 所有するグループにゲストを追加する
- 新しいアプリケーションを作成する（_オフにできる_）
- 最大50台のデバイスをAzureに追加する（_オフにできる_）

[**ユーザーのデフォルト権限のリスト**をドキュメントで確認できます](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions)。さらに、そのリストには**ゲストのデフォルト権限リスト**も表示されます。

{% hint style="info" %}
Azureリソースを列挙するには、ユーザーに明示的な権限付与が必要です。
{% endhint %}

### 特権アイデンティティ管理（PIM）

Azureの特権アイデンティティ管理（PIM）は、Azure Active DirectoryとAzureでの特権アクセスを**管理、制御、監視**するツールです。**必要なときにだけ特権アクセスを提供し、時間制限を設け、承認ワークフローを強制し、追加の認証を要求**することでセキュリティを強化します。このアプローチにより、昇格された権限が必要な場合にのみ、特定の期間だけ付与されるため、未承認のアクセスのリスクが最小限に抑えられます。

## 認証トークン

OIDCで使用される**3種類のトークン**があります：

- [**アクセストークン**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** クライアントはこのトークンをリソースサーバーに提示して**リソースにアクセス**します。ユーザー、クライアント、リソースの特定の組み合わせにのみ使用でき、有効期限まで**取り消すことはできません**（デフォルトでは1時間）。これを使用して検出することは難しいです。
- **IDトークン**：クライアントは認可サーバーからこの**トークンを受け取ります**。ユーザーに関する基本情報が含まれています。特定のユーザーとクライアントの組み合わせにバインドされています。
- **リフレッシュトークン**：アクセストークンとともにクライアントに提供されます。新しいアクセスおよびIDトークンを取得するために使用されます。特定のユーザーとクライアントの組み合わせにバインドされ、取り消すことができます。非アクティブなリフレッシュトークンのデフォルトの有効期限は**90日**であり、アクティブなトークンには**有効期限がありません**。

{% hint style="warning" %}
**条件付きアクセス**の情報は**JWT**内に**保存**されます。したがって、許可されたIPアドレスから**トークンを要求**すると、その**IP**がトークンに**保存**され、その後、そのトークンを使用して**リソースにアクセス**できる**許可されていないIPからアクセス**できます。
{% endhint %}

異なる方法で**アクセストークンを要求**し、それらでログインする方法を学ぶために、次のページをチェックしてください：

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

最も一般的なAPIエンドポイントは次のとおりです：

- **Azure Resource Manager**（ARM）: management.azure.com
- **Microsoft Graph**: graph.microsoft.com（非推奨のAzure AD Graphはgraph.windows.net）

## 参考文献

- [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
- [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
- [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
- [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学びましょう</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手してください
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)コレクションを見つけてください
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
- **ハッキングトリックを共有するには**、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
