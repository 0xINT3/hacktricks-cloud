# Az - 基本情報

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**最新版の PEASS を入手したい**場合、または HackTricks を PDF でダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をご覧ください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけてください。これは私たちの独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションです
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしてください。
* **HackTricks** と **HackTricks Cloud** の github リポジトリに **PR を提出**して、あなたのハッキングテクニックを共有してください。

</details>

## 組織の階層

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### 管理グループ

もし組織が **多くの Azure サブスクリプション**を持っている場合、それらのサブスクリプションの **アクセス**、**ポリシー**、**コンプライアンス**を効率的に管理する方法が必要になるかもしれません。**管理グループ**は、**サブスクリプションの上位にあるガバナンススコープ**を提供します。

1つのディレクトリで **10,000 の管理グループ**をサポートすることができ、管理グループツリーは **最大 6 レベルの深さ**をサポートすることができます。

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

各ディレクトリには、**ルート**管理グループと呼ばれる **最上位の管理グループ**が与えられます。ルート管理グループは、**すべての管理グループとサブスクリプションがそれにまとめられる**ように階層に組み込まれています。このルート管理グループには、グローバルポリシーと Azure の役割割り当てを適用することができます。[Azure AD **グローバル管理者**は、最初にこのルートグループの**ユーザーアクセス管理者ロール**に昇格する](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) 必要があります。アクセスを昇格させた後、管理者は他のディレクトリのユーザーやグループに任意の Azure の役割を割り当てて階層を管理することができます。管理者として、自分のアカウントをルートの所有者として割り当てることができます。

ルート管理グループは、他の管理グループとは異なり、**移動や削除はできません**。

管理グループを使用すると、どのような種類のサブスクリプションを持っていても、スケールでエンタープライズグレードの管理が可能になります。ただし、**1つの管理グループ内のすべてのサブスクリプション**は、**同じ Azure Active Directory (Azure AD) テナント**を信頼する必要があります。

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Azure サブスクリプション

Azure サブスクリプションは、Azure で関連するビジネスや技術のリソースをプロビジョニングするための **論理的なコンテナ**です。仮想マシン (VM)、データベースなどの **リソースの詳細**を保持します。VM のような Azure リソースを作成する際には、それが所属する **サブスクリプションを識別**します。役割ベースのアクセス制御メカニズムを介してアクセスを委任することができます。

### リソースグループ

リソースグループは、Azure ソリューションのための **関連するリソースを保持するコンテナ**です。リソースグループには、ソリューションのすべてのリソースまたは **グループとして管理したいリソースのみ**を含めることができます。一般的に、**同じライフサイクル**を共有するリソースを同じリソースグループに追加することで、グループとして簡単にデプロイ、更新、削除することができます。

すべての **リソース**は **リソースグループ内**にある必要があり、1つのグループにのみ所属することができます。リソースグループが削除されると、それに含まれるすべてのリソースも削除されます。

### 管理単位

管理単位を使用すると、組織を任意の単位に **細分化**し、その単位のメンバーのみを **管理できる特定の管理者**を **割り当てる**ことができます。たとえば、大学の各学部の管理者に権限を委任し、彼らがエンジニアリング学部のみでアクセスを制御し、ユーザーを管理し、ポリシーを設定できるようにするために、管理単位を使用することができます。

**ユーザー**、**グループ**、**デバイス**のみが **管理単位**の **メンバー**になることができます。

したがって、**管理単位**にはいくつかの **メンバー**が含まれ、他の **プリンシパル**はその管理単位の **上に権限を割り当てられ**、管理単位のメンバーを管理するために使用できます。

## Azure vs Azure AD vs Azure AD Domain Services

重要なことは、**Azure AD** は **Azure の中にあるサービス**であるということです。**Azure** は Microsoft の **クラウドプラットフォーム**であり、**Azure AD** は Azure の中のエンタープライズ **アイデンティティサービス** です。\
さらに、**Azure AD は Windows Active Directory とは異なり**、完全に異なる方法で機能するアイデンティティサービスです。Windows Active Directory 環境のために Azure で **ドメインコントローラを実行**する場合は、**Azure AD Domain Services** を使用する必要があります。

## プリンシパル

Azure はさまざまなタイプのプリンシパルをサポートしています。

* **ユーザー**: アクセスするための資格情報を持つ **一般の人**です。
* **グループ**: 一緒に管理される **プリンシパルのグループ**です。グループに付与された **権限はメンバーに継承**されます。
* **サービスプリンシパル**: Azure リソースにアクセスするために **アプリケーション**、**
## ロールと権限

**ロール**は、**主体**に**スコープ**で**割り当て**られます：`主体 -[HAS ROLE]->(スコープ)`

**グループ**に割り当てられた**ロール**は、グループの**メンバー**全員に**継承**されます。

ロールが割り当てられたスコープによっては、そのスコープコンテナ内の**他のリソース**にも**継承**されることがあります。たとえば、ユーザーAが**サブスクリプションにロールを持っている**場合、そのユーザーはサブスクリプション内の**すべてのリソースグループ**とリソースグループ内の**すべてのリソース**にそのロールを持つことになります。

### **クラシックなロール**

| **Owner**                     | <ul><li>すべてのリソースへの完全なアクセス</li><li>他のユーザーのアクセスを管理できる</li></ul> | すべてのリソースタイプ |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contributor**               | <ul><li>すべてのリソースへの完全なアクセス</li><li>アクセスを管理できない</li></ul>              | すべてのリソースタイプ |
| **Reader**                    | • すべてのリソースを表示する                                                                     | すべてのリソースタイプ |
| **User Access Administrator** | <ul><li>すべてのリソースを表示する</li><li>他のユーザーのアクセスを管理できる</li></ul>           | すべてのリソースタイプ |

### 組み込みのロール

[Azure ロールベースのアクセス制御 (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)には、ユーザー、グループ、サービスプリンシパル、および管理された ID に**割り当て**ることができるいくつかのAzureの**組み込みのロール**があります。ロールの割り当ては、Azure リソースへの**アクセスを制御する方法**です。組み込みのロールが組織の特定のニーズを満たさない場合、[**Azure カスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**を作成**することもできます。

**組み込み**のロールは、それが**対象とするリソース**にのみ適用されます。たとえば、**Compute**リソースに対する**組み込みのロール**の2つの例を確認してください。

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | ディスクバックアップを実行するためのバックアップボールトへのアクセス権を提供します。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | ポータルで仮想マシンを表示し、通常のユーザーとしてログインするためのアクセス権を提供します。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

これらのロールは、**管理グループ、サブスクリプション、リソースグループ**などの**ロジックコンテナ**にも**割り当てることができ**、影響を受ける主体は**それらのコンテナ内のリソース**に対してそれらのロールを持つことになります。

* [**すべての Azure 組み込みのロール**のリスト](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)をここで見つけることができます。
* [**すべての Azure AD 組み込みのロール**のリスト](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)をここで見つけることができます。

### カスタムロール

Azureでは、ユーザーが必要とする権限を持つ[**カスタムロール**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)を作成することもできます。

### アクセスが拒否されました

**主体がリソースにアクセスするためには**、**明示的に権限が付与**された**ロール**が必要です。

アクセスを許可する**権限を付与する**ロールよりも、**アクセスを拒否する**明示的な**ロール割り当てが優先**されます。

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### グローバル管理者

グローバル管理者ロールを持つユーザーは、User Access Administrator Azure ロールをルート管理グループに**昇格**することができます。これにより、グローバル管理者は**すべての Azure サブスクリプションと管理グループ**のアクセスを管理できるようになります。\
この昇格は、次のページの最後で行うことができます：[https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC**（ロールベースのアクセス制御）は、前のセクションで既に見たものです：**ロールを主体に割り当ててアクセスを許可**することです。\
ただし、場合によっては、**より細かいアクセス管理**を提供したり、**数百のロール割り当て**の管理を**簡素化**するために、Azure **ABAC**（属性ベースのアクセス制御）を使用することがあります。ABACは、特定のアクションの文脈での属性に基づいた**ロール割り当て条件**を追加することで、Azure RBACを拡張します。ロール割り当て条件は、ロール定義とロール割り当ての一部として付与される権限を絞り込むための**追加のチェック**です。たとえば、オブジェクトが特定のタグを持っていることを要求する条件を追加することができます。\
条件を使用して、特定のリソースへの**アクセスを明示的に拒否することはできません**。

### デフォルトのユーザー権限

基本的なユーザーは、AzureADの一部を列挙するためのいくつかの**デフォルトの権限**を持っています。

* すべてのユーザー、グループ、アプリケーション、デバイス、ロール、サブスクリプション、およびそれらの公開プロパティを読み取る
* ゲストを招待する（オフにすることもできます）
* セキュリティグループを作成する
* 非表示のグループメンバーシップを読み取る
* 所有
## MFAバイパス

MFA（Multi-Factor Authentication）バイパスは、複数要素認証を回避するための技術です。

### パスワードスプレー攻撃

パスワードスプレー攻撃は、一般的なパスワードを使用して複数のアカウントにログインを試みる攻撃です。この攻撃は、MFAが有効なアカウントに対しても有効です。攻撃者は、パスワードが成功するまで繰り返しログインを試み、MFAコードを要求する前に正しいパスワードを見つけることを目指します。

### ソーシャルエンジニアリング

ソーシャルエンジニアリングは、人々の信頼を悪用して情報を入手する攻撃手法です。攻撃者は、ターゲットの信頼を得るために偽のメールやウェブサイトを作成し、MFAコードを要求するフィッシング攻撃を行います。ターゲットがMFAコードを提供すると、攻撃者はそれを使用してアカウントにアクセスします。

### セッションハイジャック

セッションハイジャックは、有効なユーザーのセッションを盗み、そのセッションを使用してアカウントにアクセスする攻撃です。攻撃者は、ターゲットのセッションIDを入手し、自分のブラウザでそのセッションを再利用します。この攻撃では、MFAコードを要求する前にログインが成功するため、MFAをバイパスすることができます。

### パスワードリセット攻撃

パスワードリセット攻撃は、アカウントのパスワードをリセットし、新しいパスワードを設定する攻撃です。攻撃者は、ターゲットのアカウントに関連する情報を収集し、パスワードリセットの手続きを行います。MFAが有効な場合でも、攻撃者はパスワードリセットの手続き中にMFAコードを要求されることはありません。したがって、攻撃者は新しいパスワードを設定し、アカウントにアクセスすることができます。

### モバイルデバイスの攻撃

モバイルデバイスの攻撃は、ターゲットのモバイルデバイスを標的にした攻撃です。攻撃者は、SMSやアプリを介して送信されるMFAコードを盗み、それを使用してアカウントにアクセスします。この攻撃では、ターゲットのモバイルデバイスにアクセスする必要があります。

### パスワードリスト攻撃

パスワードリスト攻撃は、事前に作成されたパスワードリストを使用してアカウントにログインを試みる攻撃です。攻撃者は、一般的なパスワードや辞書ワードを含むリストを使用し、MFAコードを要求する前に正しいパスワードを見つけることを目指します。

### フォーセット攻撃

フォーセット攻撃は、アカウントのセキュリティ質問や回答を推測する攻撃です。攻撃者は、ターゲットの個人情報や公開された情報を使用して、セキュリティ質問の回答を推測します。MFAが有効な場合でも、攻撃者はセキュリティ質問の回答を使用してアカウントにアクセスすることができます。
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**各ポータル**が**MFAなしでログイン**できるかどうかを**テスト**してください。
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

**Azure**の**ポータル**は**制約されていないため、前回の実行で検出された任意のサービスにアクセスするためのトークンをポータルエンドポイントから収集することが可能です。この場合、Sharepointが特定され、それにアクセスするためのトークンが要求されます。
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune Read-JWTtoken -token $token.access_token
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

トークンには、SharepointからのSites.Read.Allの許可があります：

<figure><img src="../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

MFAのためにWebからSharepointにアクセスできなくても、生成されたトークンを使用してファイルにアクセスすることができます：
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_28_26-Window.png" alt=""><figcaption></figcaption></figure>

ファイルをダウンロードするためのURLを取得します：

<figure><img src="../../.gitbook/assets/2023-03-06 17_28_50-Window.png" alt=""><figcaption></figcaption></figure>

## 参考文献

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで広告表示**したい場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローしましょう。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
