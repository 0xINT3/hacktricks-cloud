# Az - 基本信息

<details>

<summary><strong>从零到英雄学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 组织层次结构

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### 管理组

如果您的组织有**许多Azure订阅**，您可能需要一种有效地**管理访问**、策略和这些**订阅**的合规性的方法。**管理组**提供了一个**高于订阅的治理范围**。

请注意，单个目录中可以支持**10,000个管理组**，并且管理组树可以支持**最多六层深度**。

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

每个目录都被赋予一个单一的**顶级管理组称为根**管理组。根管理组内置于层次结构中，以便**所有管理组和订阅都归结于它**。这个根管理组允许在目录级别应用**全局策略和Azure角色分配**。[Azure AD **全局管理员**需要提升自己](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin)到这个根组的**用户访问管理员角色**。提升访问权限后，管理员可以**分配任何Azure角色给其他目录用户或组来管理层次结构**。作为管理员，您可以将**自己的账户指定为根**管理组的所有者。

根管理组**不能被移动或删除**，与其他管理组不同。

管理组为您提供了企业级的大规模管理，无论您拥有哪种类型的订阅。然而，**单个管理组内的所有订阅**必须信任**相同的Azure活动目录(Azure AD)租户**。

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Azure订阅

Azure订阅是用于在Azure中**配置**相关业务或技术**资源**的**逻辑容器**。它包含了您所有资源的**详细信息**，如虚拟机(VMs)、数据库等。当您创建一个Azure资源，如VM时，您需要指明它属于哪个**订阅**。它允许您通过基于角色的访问控制机制来委派访问权限。

### 资源组

资源组是一个**容器**，它包含了Azure解决方案的**相关资源**。资源组可以包括解决方案的所有资源，或者只包括您想要作为一个组管理的**资源**。通常，将**共享相同生命周期**的**资源**添加到同一个资源组中，这样您就可以轻松地作为一个组来部署、更新和删除它们。

所有的**资源**必须位于**资源组内**，并且只能属于一个组，如果删除了资源组，其中的所有资源也会被删除。

### 行政单位

行政单位允许您将组织**细分**为您想要的**任何单位**，然后**指定特定的管理员**来**仅管理**该单位的**成员**。例如，您可以使用行政单位来委派权限给大学各学院的管理员，这样他们就可以仅在工程学院控制访问、管理用户和设置策略。

只有**用户**、**组**和**设备**可以是**行政单位的成员**。

因此，一个**行政单位**将**包含**一些**成员**，其他**主体**将被**分配权限**来**管理**行政**单位**，他们可以使用这些权限来**管理行政单位的成员**。

## Azure vs Azure AD vs Azure AD 域服务

重要的是要注意**Azure AD**是**Azure内部**的一项服务。**Azure**是微软的**云平台**，而**Azure AD**是Azure中的企业**身份**服务。\
此外，**Azure AD不像Windows活动目录**，它是一种以完全不同的方式工作的身份服务。如果您想在Azure中为您的Windows活动目录环境运行一个**域控制器**，您需要使用**Azure AD域服务**。

## 主体

Azure支持不同类型的主体：

* **用户**：一个有凭证访问权限的**普通人**。
* **组**：一起管理的**一组主体**。授予组的**权限**由其**成员继承**。
*   **服务主体/企业应用程序**：为**应用程序**、托管服务和自动化工具访问Azure资源而创建的**身份**。这种访问权限受限于分配给服务主体的角色，让您控制**可以访问哪些资源**以及在哪个级别上。出于安全原因，建议**总是使用服务主体与自动化工具**，而不是允许它们以用户身份登录。

创建**服务主体**时，您可以选择**密码认证**或**证书认证**。

* 如果您选择**密码**认证（默认情况下），**保存生成的密码**，因为您将无法再次访问它。
* 如果您选择证书认证，请确保**应用程序将能够访问私钥**。
* **托管身份（元数据凭证）**：托管身份在Azure活动目录中为应用程序提供了一个**自动管理的身份**，用于**连接**到支持Azure活动目录（**Azure AD**）认证的**资源**。应用程序可以使用托管身份**获取Azure AD令牌，而无需管理任何凭证**。\
有两种类型的托管身份：
* **系统分配**。一些Azure服务允许您**直接在服务实例上启用托管身份**。当您启用系统分配的托管身份时，会在Azure AD中创建一个身份。该身份与**该服务实例的生命周期绑定**。当**资源**被**删除**时，Azure会自动为您**删除**该**身份**。设计上，只有那个Azure资源可以使用这个身份从Azure AD请求令牌。
* **用户分配**。您也可以创建一个独立的Azure资源作为托管身份。您可以[创建一个用户分配的托管身份](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal)并将其分配给一个或**多个实例**的Azure服务（多个资源）。对于用户分配的托管身份，**身份是独立于使用它的资源进行管理的**。

## 角色和权限

**角色**被**分配**给在**范围**上的**主体**：`principal -[HAS ROLE]->(scope)`

分配给**组**的**角色**由组的所有**成员继承**。

根据角色被分配的范围，**角色**可能会被**继承**到范围容器内的**其他资源**。例如，如果用户A在**订阅上有一个角色**，他将在订阅内的**所有资源组**以及资源组内的**所有资源**上拥有该角色。

### **经典角色**

| **所有者**                     | <ul><li>对所有资源的完全访问权限</li><li>可以管理其他用户的访问权限</li></ul> | 所有资源类型 |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **贡献者**               | <ul><li>对所有资源的完全访问权限</li><li>不能管理访问权限</li></ul>              | 所有资源类型 |
| **读者**                    | • 查看所有资源                                                                     | 所有资源类型 |
| **用户访问管理员** | <ul><li>查看所有资源</li><li>可以管理其他用户的访问权限</li></ul>           | 所有资源类型 |

### 内置角色

[Azure基于角色的访问控制（Azure RBAC）](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)有几个Azure**内置角色**，您可以**分配**给**用户、组、服务主体和托管身份**。角色分配是您控制**访问Azure资源**的方式。如果内置角色不符合您组织的特定需求，您可以创建自己的[**Azure自定义角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**。**

**内置**角色仅适用于它们**意图**的**资源**，例如检查这两个关于**计算**资源的**内置角色**示例：

| [磁盘备份读者](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | 提供权限以执行磁盘备份的备份库。      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [虚拟机用户登录](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | 在门户中查看虚拟机并作为普通用户登录。 | fb879df8-f326-4884-b1cf-06f3ad86be52 |

这些角色**也可以分配给逻辑容器**（如管理组、订阅和资源组），受影响的主体将在这些容器内的资源上拥有它们。

* 在此处找到[**所有Azure内置角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)的列表。
* 在此处找到[**所有Azure AD内置角色**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference)的列表。

### 自定义角色

Azure还允许创建[**自定义角色**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)，具有用户需要的权限。

### 权限拒绝

* 为了让**主体对资源有一些访问权限**，他需要被明确授予一个角色（无论如何）**授予他那个权限**。
* 明确的**拒绝角色分配优先于**授予权限的角色。

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### 全局管理员

具有全局管理员角色的用户有能力'**提升**到根管理组的用户访问管理员Azure角色'。这意味着全局管理员将能够管理**所有Azure订阅和管理组的访问权限。**\
这种提升可以在页面底部完成：[https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure策略

Azure策略是一组**规则和规定在Microsoft Azure**中，一个云计算服务，帮助管理和执行组织标准，并在大规模评估合规性。这些策略对您的**Azure资源**执行不同的规则，确保这些资源保持符合企业标准和服务级别协议。

Azure策略对于云治理和安全至关重要，有助于确保资源得到适当和高效的使用，并且它们符合外部法规和内部政策。\
一些例子：

1. **确保与特定Azure区域的合规性**：此策略确保所有资源都部署在特定的Azure区域。例如，一家公司可能想确保其所有数据都存储在欧洲，以符合GDPR合规性。
2. **强制命名标准**：策略可以强制执行Azure资源的命名约定。这有助于组织和轻松识别基于名称的资源，这在大型环境中很有帮助。
3. **限制某些资源类型**：此策略可以限制创建某些类型的资源。例如，可以设置一个策略来防止创建昂贵的资源类型，如某些VM大小，以控制成本。
4. **强制执行标签策略**：标签是与Azure资源相关联的键值对，用于资源管理。策略可以强制要求所有资源必须存在某些标签，或者具有特定的值。这对于成本跟踪、所有权或资源分类很有用。
5. **限制对资源的公共访问**：策略可以强制某些资源，如存储账户或数据库，不具有公共端点，确保它们只能在组织的网络内访问。
6. **自动应用安全设置**：策略可用于自动向资源应用安全设置，例如将特定的网络安全组应用于所有VM或确保所有存储账户使用加密。

请注意，Azure策略可以附加到Azure层次结构的任何级别，但它们**通常用于根管理组**或其他管理组。

### Azure RBAC vs ABAC

**RBAC**（基于角色的访问控制）是我们在前面章节中已经看到的：**分配一个角色给主体以授予他对资源的访问权限**。\
然而，在某些情况下，您可能希望提供**更细粒度的访问管理**或**简化**管理**数百个**角色**分配**。

Azure **ABAC**（基于属性的访问控制）在Azure RBAC的基础上增加
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**测试每个门户** 是否可以**不使用 MFA 登录**：
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

因为 **Azure** **门户** **没有受到限制**，所以可以从门户端点**收集令牌以访问之前执行过程中检测到的任何服务**。在这种情况下，Sharepoint 被识别出来，并且请求了一个访问它的令牌：
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune Read-JWTtoken -token $token.access_token
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

令牌具有 Sites.Read.All 权限（来自 Sharepoint）：

<figure><img src="../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

即使因为 MFA 你无法从网页访问 Sharepoint，也可以使用生成的令牌来访问文件：
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
获取下载文件的URL：

## 参考资料

* [https://learn.microsoft.com/zh-cn/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/zh-cn/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/zh-cn/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果你想在**HackTricks中看到你的公司广告**或者**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享你的黑客技巧**。

</details>
