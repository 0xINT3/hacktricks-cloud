# Az - Informazioni di Base

<details>

<summary><strong>Impara l'hacking di Azure da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks su AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Gerarchia dell'Organizzazione

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

### Gruppi di Gestione

Se la tua organizzazione ha **molti abbonamenti Azure**, potresti aver bisogno di un modo per gestire in modo efficiente **l'accesso**, le **policy** e la **conformit√†** per quegli **abbonamenti**. I **gruppi di gestione** forniscono uno **scope di governance sopra gli abbonamenti**.

Si noti che possono essere supportati **10.000 gruppi di gestione** in un singolo directory e un albero di gruppi di gestione pu√≤ supportare **fino a sei livelli di profondit√†**.

<figure><img src="../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

[Dalla documentazione](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Ogni directory ha un singolo **gruppo di gestione di alto livello chiamato root**. Il gruppo di gestione radice √® integrato nella gerarchia per avere **tutti i gruppi di gestione e gli abbonamenti che si piegano ad esso**. Questo gruppo di gestione radice consente l'applicazione di **policy globali e assegnazioni di ruoli Azure** a livello di directory. Il [**Global Administrator di Azure AD deve elevare se stesso**](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) al **ruolo di Amministratore di Accesso Utente di questo gruppo radice** inizialmente. Dopo aver elevato l'accesso, l'amministratore pu√≤ **assegnare qualsiasi ruolo Azure ad altri utenti o gruppi della directory per gestire la gerarchia**. Come amministratore, puoi assegnare **il tuo account come proprietario del gruppo di gestione radice**.

Il gruppo di gestione radice **non pu√≤ essere spostato o eliminato**, a differenza degli altri gruppi di gestione.

I gruppi di gestione ti offrono una gestione aziendale su larga scala indipendentemente dal tipo di abbonamenti che potresti avere. Tuttavia, **tutti gli abbonamenti all'interno di un singolo gruppo di gestione** devono fidarsi dello stesso **tenant di Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (157).png" alt=""><figcaption></figcaption></figure>

### Abbonamenti Azure

In Azure, un abbonamento funge da **contenitore logico** per lo scopo di **provisioning** di **risorse** aziendali o tecniche. Questo contenitore mantiene i **dettagli delle risorse** come macchine virtuali (VM), database, tra gli altri. All'atto della creazione di una risorsa Azure, come una VM, viene specificato l'**abbonamento associato ad essa**. Questa struttura facilita la delega dell'accesso, utilizzando meccanismi di controllo degli accessi basati su ruoli.

### Gruppi di Risorse

[Dalla documentazione:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un gruppo di risorse √® un **contenitore** che contiene **risorse correlate** per una soluzione Azure. Il gruppo di risorse pu√≤ includere tutte le risorse per la soluzione, o solo quelle **risorse che si desidera gestire come gruppo**. Generalmente, aggiungi **risorse** che condividono lo **stesso ciclo di vita** nello stesso gruppo di risorse in modo da poterle facilmente distribuire, aggiornare ed eliminare come gruppo.

Tutte le **risorse** devono essere **all'interno di un gruppo di risorse** e possono appartenere solo a un gruppo e se un gruppo di risorse viene eliminato, tutte le risorse al suo interno vengono eliminate.

### Unit√† Amministrative

[Dalla documentazione:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Le unit√† amministrative ti consentono di **suddividere** la tua organizzazione in **qualsiasi unit√†** desideri, e quindi **assegnare specifici amministratori** che possono **gestire solo i membri** di quell'unit√†. Ad esempio, potresti utilizzare le unit√† amministrative per delegare autorizzazioni agli amministratori di ciascuna scuola di una grande universit√†, in modo che possano controllare l'accesso, gestire gli utenti e impostare le policy solo nella Scuola di Ingegneria.

Solo **utenti**, **gruppi** e **dispositivi** possono essere **membri** di un'**unit√† amministrativa**.

Pertanto, un'**unit√† amministrativa** conterr√† alcuni **membri** e ad altri **principali** verranno **assegnate autorizzazioni su quell'**unit√† amministrativa che potranno utilizzare per **gestire i membri** dell'unit√† amministrativa.

## Azure vs Azure AD vs Azure AD Domain Services

√à importante notare che **Azure AD** √® un servizio **all'interno di** **Azure**. **Azure** √® la **piattaforma cloud** di Microsoft mentre **Azure AD** √® un **servizio di identit√† aziendale** in Azure.\
Inoltre, **Azure AD non √® come Windows Active Directory**, √® un servizio di identit√† che funziona in modo completamente diverso. Se desideri eseguire un **Domain Controller in Azure** per il tuo ambiente Windows Active Directory devi utilizzare **Azure AD Domain Services**.

## Principali

Azure supporta diversi tipi di principali:

* **Utente**: Una **persona** regolare con credenziali per l'accesso.
* **Gruppo**: Un **gruppo di principali** gestiti insieme. Le **autorizzazioni** concesse ai gruppi sono **ereditate** dai suoi **membri**.
*   **Service Principal/Applicazioni Enterprise**: √à un'**identit√†** creata per **l'uso** con **applicazioni**, servizi ospitati e strumenti automatizzati per accedere alle risorse di Azure. Questo accesso √® **limitato dai ruoli assegnati** al service principal, dando il controllo su **quali risorse possono essere accessate** e a quale livello. Per motivi di sicurezza, √® sempre consigliabile **utilizzare service principal con strumenti automatizzati** anzich√© consentire loro di accedere con un'identit√† utente.

Nella creazione di un **service principal** puoi scegliere tra **autenticazione tramite password** o **autenticazione tramite certificato**.

* Se scegli l'autenticazione tramite **password** (per impostazione predefinita), **salva la password generata** poich√© non potrai pi√π accedervi.
* Se scegli l'autenticazione tramite certificato, assicurati che **l'applicazione abbia accesso alla chiave privata**.
* **Identit√† Gestita (Credenziali Metadata)**: Le identit√† gestite in Azure Active Directory offrono una soluzione per **gestire automaticamente l'identit√†** delle applicazioni. Queste identit√† sono utilizzate dalle applicazioni allo scopo di **connettersi** a **risorse** compatibili con l'autenticazione di Azure Active Directory (**Azure AD**). Utilizzando le identit√† gestite, le applicazioni possono **proteggere i token di Azure AD** eliminando la necessit√† di gestire direttamente le credenziali. Ci sono due tipi di identit√† gestite:
* **Assegnata dal sistema**. Alcuni servizi Azure ti consentono di **abilitare un'identit√† gestita direttamente su un'istanza di servizio**. Quando abiliti un'identit√† gestita assegnata dal sistema, viene creata un'identit√† in Azure AD. L'identit√† √® legata al **ciclo di vita di quell'istanza di servizio**. Quando la **risorsa** viene **eliminata**, Azure elimina automaticamente l'**identit√†** per te. Per progettazione, solo quella risorsa Azure pu√≤ utilizzare questa identit√† per richiedere token da Azure AD.
* **Assegnata dall'utente**. Puoi anche creare un'identit√† gestita come risorsa Azure autonoma. Puoi [creare un'identit√† gestita assegnata dall'utente](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) e assegnarla a una o **pi√π istanze** di un servizio Azure (pi√π risorse). Per le identit√† gestite assegnate dall'utente, l'**identit√† √® gestita separatamente dalle risorse che la utilizzano**.
## Ruoli e Autorizzazioni

**I ruoli** vengono **assegnati** ai **principali** su un **ambito**: `principale -[HA RUOLO]->(ambito)`

I **ruoli** assegnati ai **gruppi** vengono **ereditati** da tutti i **membri** del gruppo.

A seconda dell'ambito a cui √® stato assegnato il ruolo, il **ruolo** potrebbe essere **ereditato** ad **altri risorse** all'interno del contenitore dell'ambito. Ad esempio, se un utente A ha un **ruolo sulla sottoscrizione**, avr√† quel **ruolo su tutti i gruppi di risorse** all'interno della sottoscrizione e su **tutte le risorse** all'interno del gruppo di risorse.

### **Ruoli Classici**

| **Proprietario**              | <ul><li>Accesso completo a tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul> | Tutti i tipi di risorse |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Collaboratore**             | <ul><li>Accesso completo a tutte le risorse</li><li>Non pu√≤ gestire l'accesso</li></ul>    | Tutti i tipi di risorse |
| **Lettore**                   | ‚Ä¢ Visualizza tutte le risorse                                                            | Tutti i tipi di risorse |
| **Amministratore di Accesso Utenti** | <ul><li>Visualizza tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul> | Tutti i tipi di risorse |

### Ruoli Incorporati

[Dalla documentazione: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Controllo degli accessi basato su ruoli di Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ha diversi **ruoli incorporati di Azure** che √® possibile **assegnare** a **utenti, gruppi, principali del servizio e identit√† gestite**. Le assegnazioni di ruolo sono il modo in cui si controlla **l'accesso alle risorse di Azure**. Se i ruoli incorporati non soddisfano le esigenze specifiche della tua organizzazione, √® possibile creare i [**ruoli personalizzati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

I **ruoli incorporati** si applicano solo alle **risorse** a cui sono **destinati**, ad esempio controlla questi 2 esempi di **ruoli incorporati sulle risorse di Calcolo**:

| [Lettore del Backup del Disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Concede il permesso al vault di backup per eseguire il backup del disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Accesso Utente alla Macchina Virtuale](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Visualizza le macchine virtuali nel portale e accede come utente normale. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Questi ruoli possono **anche essere assegnati ai contenitori logici** (come gruppi di gestione, sottoscrizioni e gruppi di risorse) e i principali interessati li avranno **sulle risorse all'interno di quei contenitori**.

* Trova qui un elenco di [**tutti i ruoli incorporati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trova qui un elenco di [**tutti i ruoli incorporati di Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Ruoli Personalizzati

Azure consente anche di creare [**ruoli personalizzati**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con le autorizzazioni necessarie all'utente.

### Permesso Negato

* Affinch√© un **principale abbia accesso a una risorsa**, ha bisogno di un ruolo esplicito che gli venga assegnato (in ogni caso) **concedendogli tale autorizzazione**.
* Un'assegnazione di ruolo di **negazione esplicita ha la precedenza** sull'assegnazione del ruolo che concede l'autorizzazione.

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

### Amministratore Globale

Gli utenti con il ruolo di Amministratore Globale hanno la possibilit√† di '**elevare' al ruolo di Amministratore di Accesso Utenti Azure al gruppo di gestione radice**. Ci√≤ significa che un Amministratore Globale potr√† gestire l'accesso a **tutte le sottoscrizioni e i gruppi di gestione di Azure.**\
Questa elevazione pu√≤ essere effettuata alla fine della pagina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (162).png" alt=""><figcaption></figcaption></figure>

### Normative di Azure

Le normative di Azure sono un insieme di **regole e regolamenti in Microsoft Azure**, un servizio di cloud computing, che aiutano a gestire e far rispettare gli standard organizzativi e valutare la conformit√† su larga scala. Queste normative impongono diverse regole sulle **risorse di Azure**, garantendo che tali risorse rimangano conformi agli standard aziendali e agli accordi di livello di servizio.

Le normative di Azure sono cruciali per la governance e la sicurezza del cloud, aiutando a garantire che le risorse siano utilizzate correttamente ed efficientemente, e che siano conformi a regolamenti esterni e politiche interne.\
Alcuni esempi:

1. **Garantire la Conformit√† con Specifiche Regioni di Azure**: Questa normativa garantisce che tutte le risorse siano distribuite in specifiche regioni di Azure. Ad esempio, un'azienda potrebbe voler garantire che tutti i suoi dati siano memorizzati in Europa per la conformit√† al GDPR.
2. **Imporre Standard di Denominazione**: Le normative possono imporre convenzioni di denominazione per le risorse di Azure. Questo aiuta nell'organizzazione e nell'identificazione facile delle risorse in base ai loro nomi, utile in ambienti di grandi dimensioni.
3. **Limitare Determinati Tipi di Risorse**: Questa normativa pu√≤ limitare la creazione di determinati tipi di risorse. Ad esempio, una normativa potrebbe essere impostata per impedire la creazione di tipi di risorse costosi, come determinate dimensioni di VM, per controllare i costi.
4. **Imporre Normative di Tag**: I tag sono coppie chiave-valore associate alle risorse di Azure utilizzate per la gestione delle risorse. Le normative possono imporre che determinati tag siano presenti, o abbiano valori specifici, per tutte le risorse. Questo √® utile per il tracciamento dei costi, la propriet√† o la categorizzazione delle risorse.
5. **Limitare l'Accesso Pubblico alle Risorse**: Le normative possono imporre che determinate risorse, come account di archiviazione o database, non abbiano endpoint pubblici, garantendo che siano accessibili solo all'interno della rete dell'organizzazione.
6. **Applicare Automaticamente Impostazioni di Sicurezza**: Le normative possono essere utilizzate per applicare automaticamente impostazioni di sicurezza alle risorse, ad esempio applicando un gruppo di sicurezza di rete specifico a tutte le VM o garantendo che tutti gli account di archiviazione utilizzino la crittografia.

Si noti che le Normative di Azure possono essere collegate a qualsiasi livello della gerarchia di Azure, ma sono **comunemente utilizzate nel gruppo di gestione radice** o in altri gruppi di gestione.

### Ambito delle Autorizzazioni

In Azure le **autorizzazioni possono essere assegnate a qualsiasi parte della gerarchia**. Ci√≤ include gruppi di gestione, sottoscrizioni, gruppi di risorse e risorse individuali. Le autorizzazioni sono **ereditate** dalle **risorse** contenute dell'entit√† a cui sono state assegnate.

Questa struttura gerarchica consente una gestione efficiente e scalabile delle autorizzazioni di accesso.

<figure><img src="../../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (controllo degli accessi basato su ruoli) √® ci√≤ che abbiamo gi√† visto nelle sezioni precedenti: **Assegnare un ruolo a un principale per concedergli accesso** a una risorsa.\
Tuttavia, in alcuni casi potresti voler fornire **gestione degli accessi pi√π dettagliata** o **semplificare** la gestione di **centinaia** di **assegnazioni di ruoli**.

Azure **ABAC** (controllo degli accessi basato su attributi) si basa su Azure RBAC aggiungendo **condizioni di assegnazione del ruolo basate su attributi** nel contesto di azioni specifiche. Una _condizione di assegnazione del ruolo_ √® un **controllo aggiuntivo che √® possibile aggiungere facoltativamente alla tua assegnazione di ruolo** per fornire un controllo degli accessi pi√π dettagliato. Una condizione filtra le autorizzazioni concesse come parte della definizione del ruolo e dell'assegnazione del ruolo. Ad esempio, puoi **aggiungere una condizione che richiede che un oggetto abbia un tag specifico per leggere l'oggetto**.\
**Non** √® possibile **negare esplicitamente** **l'accesso** a risorse specifiche **utilizzando condizioni**.
### Autorizzazioni predefinite degli utenti

Un utente di base avr√† alcune **autorizzazioni predefinite** per enumerare alcune parti di AzureAD:

- Leggere tutti gli utenti, Gruppi, Applicazioni, Dispositivi, Ruoli, Sottoscrizioni e le loro propriet√† pubbliche
- Invitare Ospiti (_pu√≤ essere disattivato_)
- Creare gruppi di sicurezza
- Leggere le appartenenze ai Gruppi non nascosti
- Aggiungere ospiti ai Gruppi di propriet√†
- Creare nuove applicazioni (_pu√≤ essere disattivato_)
- Aggiungere fino a 50 dispositivi ad Azure (_pu√≤ essere disattivato_)

Puoi vedere l'elenco completo delle [**autorizzazioni predefinite degli utenti** nella documentazione](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Inoltre, nota che in quell'elenco puoi vedere anche l'**elenco delle autorizzazioni predefinite degli ospiti**.

{% hint style="info" %}
Ricorda che per enumerare le risorse di Azure, all'utente √® necessario un consenso esplicito dell'autorizzazione.
{% endhint %}

### Gestione delle identit√† privilegiate (PIM)

La Gestione delle identit√† privilegiate (PIM) in Azure √® uno strumento che **gestisce, controlla e monitora l'accesso privilegiato** in Azure Active Directory e Azure. Migliora la sicurezza fornendo **accesso privilegiato su richiesta e limitato nel tempo**, **applicando flussi di approvazione e richiedendo autenticazioni aggiuntive**. Questo approccio riduce al minimo il rischio di accessi non autorizzati garantendo che le autorizzazioni elevate siano concesse solo quando necessario e per una durata specifica.

## Token di autenticazione

Ci sono **tre tipi di token** utilizzati in OIDC:

- [**Token di accesso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Il client presenta questo token al server delle risorse per **accedere alle risorse**. Pu√≤ essere utilizzato solo per una specifica combinazione di utente, client e risorsa e **non pu√≤ essere revocato** fino alla scadenza - che di default √® di 1 ora. La rilevazione √® bassa utilizzando questo.
- **Token ID**: Il client riceve questo **token dal server di autorizzazione**. Contiene informazioni di base sull'utente. √à **vincolato a una specifica combinazione di utente e client**.
- **Token di aggiornamento**: Fornito al client con il token di accesso. Usato per **ottenere nuovi token di accesso e ID**. √à vincolato a una specifica combinazione di utente e client e pu√≤ essere revocato. La scadenza predefinita √® di **90 giorni** per i token di aggiornamento inattivi e **nessuna scadenza per i token attivi**.

{% hint style="warning" %}
Le informazioni per l'**accesso condizionale** sono **memorizzate** all'interno del **JWT**. Quindi, se richiedi il **token da un indirizzo IP consentito**, quell'**IP** sar√† **memorizzato** nel token e quindi potrai utilizzare quel token da un **IP non consentito per accedere alle risorse**.
{% endhint %}

Controlla la seguente pagina per apprendere i diversi modi per **richiedere token di accesso** e accedere con essi:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

Gli endpoint API pi√π comuni sono:

- **Gestore delle risorse di Azure** (ARM): management.azure.com
- **Microsoft Graph**: graph.microsoft.com (Azure AD Graph che √® deprecato √® graph.windows.net)

## Riferimenti

- [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
- [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
- [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
- [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

- Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
- Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
- Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusivi [**NFT**](https://opensea.io/collection/the-peass-family)
- **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>
