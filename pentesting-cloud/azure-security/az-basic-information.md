# Az - Informazioni di base

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>

## Gerarchia dell'organizzazione

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Gruppi di gestione

Se la tua organizzazione ha **molti abbonamenti Azure**, potresti avere bisogno di un modo per gestire in modo efficiente **l'accesso**, le politiche e la conformit√† per quegli **abbonamenti**. I **gruppi di gestione** forniscono uno **scope di governance sopra gli abbonamenti**.

Si noti che √® possibile supportare **10.000 gruppi di gestione** in una singola directory e un albero di gruppi di gestione pu√≤ supportare **fino a sei livelli di profondit√†**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

[Dalla documentazione](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Ogni directory ha un singolo **gruppo di gestione di primo livello chiamato root**. Il gruppo di gestione radice √® incorporato nella gerarchia per avere **tutti i gruppi di gestione e gli abbonamenti che si ripiegano su di esso**. Questo gruppo di gestione radice consente l'applicazione di **politiche globali e assegnazioni di ruoli di Azure AD** a livello di directory. L'**amministratore globale di Azure AD** deve **elevare se stesso** al ruolo di **amministratore di accesso utente di questo gruppo radice** inizialmente. Dopo aver elevato l'accesso, l'amministratore pu√≤ **assegnare qualsiasi ruolo di Azure ad altri utenti o gruppi della directory per gestire la gerarchia**. Come amministratore, puoi assegnare **il tuo account come proprietario del gruppo di gestione radice**.

Il gruppo di gestione radice **non pu√≤ essere spostato o eliminato**, a differenza degli altri gruppi di gestione.

I gruppi di gestione offrono una gestione aziendale di livello enterprise a qualsiasi tipo di abbonamento tu possa avere. Tuttavia, **tutti gli abbonamenti all'interno di un singolo gruppo di gestione** devono fidarsi dello stesso **tenant di Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Abbonamenti Azure

In Azure, un abbonamento funge da **contenitore logico** per lo scopo di **provisioning** delle risorse aziendali o tecniche. Questo contenitore mantiene i **dettagli delle risorse** come macchine virtuali (VM), database, tra gli altri. Alla creazione di una risorsa Azure, come una VM, viene specificato l'**abbonamento associato ad essa**. Questa struttura facilita la delega dell'accesso, utilizzando meccanismi di controllo degli accessi basati sui ruoli.

### Gruppi di risorse

[Dalla documentazione:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un gruppo di risorse √® un **contenitore** che contiene **risorse correlate** per una soluzione Azure. Il gruppo di risorse pu√≤ includere tutte le risorse per la soluzione o solo quelle **risorse che si desidera gestire come gruppo**. In generale, aggiungi **risorse** che condividono lo **stesso ciclo di vita** allo stesso gruppo di risorse in modo da poterle facilmente distribuire, aggiornare ed eliminare come gruppo.

Tutte le **risorse** devono essere **all'interno di un gruppo di risorse** e possono appartenere solo a un gruppo e se un gruppo di risorse viene eliminato, tutte le risorse al suo interno vengono eliminate.

### Unit√† amministrative

[Dalla documentazione:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Le unit√† amministrative ti consentono di **suddividere** la tua organizzazione in **qualsiasi unit√†** desideri e quindi **assegnare amministratori specifici** che possono **gestire solo i membri** di quell'unit√†. Ad esempio, potresti utilizzare le unit√† amministrative per delegare le autorizzazioni agli amministratori di ogni scuola di una grande universit√†, in modo che possano controllare l'accesso, gestire gli utenti e impostare le politiche solo nella Scuola di Ingegneria.

Solo **utenti**, **gruppi** e **dispositivi** possono essere **membri** di un'**unit√† amministrativa**.

Pertanto, un'**unit√† amministrativa** conterr√† alcuni **membri** e altri **principali** saranno **assegnati permessi su quella** unit√† amministrativa che potranno utilizzare per **gestire i membri** dell'unit√† amministrativa.

## Azure vs Azure AD vs Azure AD Domain Services

√à importante notare che **Azure AD** √® un servizio **all'interno di** **Azure**. **Azure** √® la **piattaforma cloud** di Microsoft, mentre **Azure AD** √® un **servizio di identit√† aziendale** in Azure.\
Inoltre, **Azure AD non √® come Windows Active Directory**, √® un servizio di identit√† che funziona in modo completamente diverso. Se desideri eseguire un **Domain Controller in Azure** per il tuo ambiente di Windows Active Directory, √® necessario utilizzare **Azure AD Domain Services**.

## Principali

Azure supporta diversi tipi di principali:

* **Utente**: una **persona** regolare con credenziali per l'accesso.
* **Gruppo**: un **gruppo di principali** gestiti insieme. Le **autorizzazioni** concesse ai gruppi sono **ereditate** dai suoi **membri**.
* **Service Principal/Applicazioni aziendali**: √® un'**identit√†** creata per **l'uso** con **applicazioni**, servizi ospitati e strumenti automatizzati per accedere alle risorse di Azure. Questo accesso √® **limitato dai ruoli assegnati** al service principal, consentendoti di **controllare** quali risorse possono essere **accedute** e a quale livello. Per motivi di sicurezza, √® sempre consigliabile **utilizzare service principal con strumenti automatizzati** anzich√© consentire loro di accedere con un'identit√† utente.

Durante la creazione di un **service principal**, √® possibile scegliere tra **autenticazione tramite password** o **autenticazione tramite certificato**.

* Se si sceglie l'autenticazione tramite **password** (per impostazione predefinita), **salvare la password generata** poich√© non sar√† possibile accedervi nuovamente.
* Se si sceglie l'autenticazione tramite certificato, assicurarsi che l'**applicazione abbia accesso alla chiave privata**.
* **Identit√† gestita (Credenziali di metadati)**: le identit√† gestite in Azure Active Directory offrono una soluzione per **gestire automaticamente l'identit√†** delle applicazioni. Queste identit√† vengono utilizz
## Ruoli e autorizzazioni

I **ruoli** vengono **assegnati** ai **principali** su uno **scope**: `principale -[HA RUOLO]->(scope)`

I **ruoli** assegnati ai **gruppi** vengono **ereditati** da tutti i **membri** del gruppo.

A seconda dello scope a cui √® stato assegnato il ruolo, il **ruolo** pu√≤ essere **ereditato** ad **altri risorse** all'interno del contenitore dello scope. Ad esempio, se un utente A ha un **ruolo sul sottoscrizione**, avr√† quel **ruolo su tutti i gruppi di risorse** all'interno della sottoscrizione e su **tutte le risorse** all'interno del gruppo di risorse.

### **Ruoli classici**

| **Proprietario**              | <ul><li>Accesso completo a tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul> | Tutti i tipi di risorse |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ---------------------- |
| **Collaboratore**             | <ul><li>Accesso completo a tutte le risorse</li><li>Non pu√≤ gestire l'accesso</li></ul>  | Tutti i tipi di risorse |
| **Lettore**                   | ‚Ä¢ Visualizza tutte le risorse                                                            | Tutti i tipi di risorse |
| **Amministratore di accesso utente** | <ul><li>Visualizza tutte le risorse</li><li>Pu√≤ gestire l'accesso per altri utenti</li></ul> | Tutti i tipi di risorse |

### Ruoli predefiniti

[Dalla documentazione: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ha diversi **ruoli predefiniti di Azure** che √® possibile **assegnare** a **utenti, gruppi, principali del servizio e identit√† gestite**. Le assegnazioni di ruolo sono il modo in cui si controlla l'**accesso alle risorse di Azure**. Se i ruoli predefiniti non soddisfano le esigenze specifiche dell'organizzazione, √® possibile creare [**ruoli personalizzati di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

I ruoli **predefiniti** si applicano solo alle **risorse** a cui sono **destinati**, ad esempio controlla questi 2 esempi di **ruoli predefiniti sulle risorse di calcolo**:

| [Lettore di backup del disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fornisce l'autorizzazione al vault di backup per eseguire il backup del disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Accesso utente alla macchina virtuale](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Visualizza le macchine virtuali nel portale e accede come utente normale. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Questi ruoli possono essere **assegnati anche a contenitori logici** (come gruppi di gestione, sottoscrizioni e gruppi di risorse) e i principali interessati li avranno **sulle risorse all'interno di quei contenitori**.

* Trova qui un elenco di [**tutti i ruoli predefiniti di Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trova qui un elenco di [**tutti i ruoli predefiniti di Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Ruoli personalizzati

Azure consente anche di creare [**ruoli personalizzati**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con le autorizzazioni necessarie per l'utente.

### Permesso negato

* Perch√© un **principale abbia accesso a una risorsa**, √® necessario che gli venga assegnato un ruolo esplicito (in ogni caso) **che gli conceda tale autorizzazione**.
* Un'assegnazione di ruolo esplicito **con permesso negato ha la precedenza** sul ruolo che concede l'autorizzazione.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Amministratore globale

Gli utenti con il ruolo di Amministratore globale hanno la possibilit√† di '**elevare' al ruolo di Amministratore di accesso utente Azure** nel gruppo di gestione radice. Ci√≤ significa che un Amministratore globale sar√† in grado di gestire l'accesso a **tutte le sottoscrizioni e i gruppi di gestione di Azure.**\
Questa elevazione pu√≤ essere effettuata alla fine della pagina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

Le Azure policies sono un insieme di **regole e regolamenti in Microsoft Azure**, un servizio di cloud computing, che aiutano a gestire e applicare gli standard organizzativi e valutare la conformit√† su larga scala. Queste politiche impongono diverse regole sulle **risorse di Azure**, garantendo che tali risorse siano conformi agli standard aziendali e agli accordi di livello di servizio.

Le Azure policies sono fondamentali per la governance e la sicurezza del cloud, contribuendo a garantire che le risorse vengano utilizzate correttamente ed efficientemente e che siano conformi alle normative esterne e alle politiche interne.\
Alcuni esempi:

1. **Garantire la conformit√† con specifiche regioni di Azure**: questa politica garantisce che tutte le risorse vengano distribuite in specifiche regioni di Azure. Ad esempio, un'azienda potrebbe voler garantire che tutti i suoi dati siano archiviati in Europa per la conformit√† al GDPR.
2. **Imporre standard di denominazione**: le politiche possono imporre convenzioni di denominazione per le risorse di Azure. Ci√≤ aiuta nell'organizzazione e nell'identificazione facile delle risorse in base ai loro nomi, il che √® utile in ambienti di grandi dimensioni.
3. **Limitare determinati tipi di risorse**: questa politica pu√≤ limitare la creazione di determinati tipi di risorse. Ad esempio, una politica potrebbe essere impostata per impedire la creazione di tipi di risorse costose, come determinate dimensioni di macchine virtuali, per controllare i costi.
4. **Imporre politiche di etichettatura**: le etichette sono coppie chiave-valore associate alle risorse di Azure utilizzate per la gestione delle risorse. Le politiche possono imporre che determinate etichette siano presenti o abbiano valori specifici per tutte le risorse. Questo √® utile per il monitoraggio dei costi, la propriet√† o la categorizzazione delle risorse.
5. **Limitare l'accesso pubblico alle risorse**: le politiche possono imporre che determinate risorse, come account di archiviazione o database, non abbiano endpoint pubblici, garantendo che siano accessibili solo all'interno della rete dell'organizzazione.
6. **Applicazione automatica delle impostazioni di sicurezza**: le politiche possono essere utilizzate per applicare automaticamente le impostazioni di sicurezza alle risorse, ad esempio applicando un gruppo di sicurezza di rete specifico a tutte le VM o garantendo che tutti gli account di archiviazione utilizzino la crittografia.

Si noti che le Azure policies possono essere associate a qualsiasi livello della gerarchia di Azure, ma vengono **comunemente utilizzate nel gruppo di gestione radice** o in altri gruppi di gestione.

### Ambito delle autorizzazioni

In Azure, le **autorizzazioni possono essere assegnate a qualsiasi parte della gerarchia**. Ci√≤ include gruppi di gestione, sottoscrizioni, gruppi di risorse e risorse individuali. Le autorizzazioni vengono **ereditate** dalle **risorse contenute** dell'entit√† a cui sono state assegnate.

Questa struttura gerarchica consente una gestione efficiente e scalabile delle autorizzazioni di accesso.

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (role-based access control) √® ci√≤ che abbiamo gi√† visto nelle sezioni precedenti: **Assegnare un ruolo a un principale per concedergli l'accesso** a una risorsa.\
Tuttavia, in alcuni casi potresti voler fornire una **gestione degli accessi pi√π dettagliata** o **semplificare
### Permessi utente predefiniti

Un utente di base avr√† alcuni **permessi predefiniti** per enumerare alcune parti di AzureAD:

- Leggere tutti gli utenti, i gruppi, le applicazioni, i dispositivi, i ruoli, le sottoscrizioni e le loro propriet√† pubbliche
- Invitare ospiti (_pu√≤ essere disattivato_)
- Creare gruppi di sicurezza
- Leggere l'appartenenza ai gruppi non nascosti
- Aggiungere ospiti ai gruppi di propriet√†
- Creare una nuova applicazione (_pu√≤ essere disattivato_)
- Aggiungere fino a 50 dispositivi ad Azure (_pu√≤ essere disattivato_)

√à possibile visualizzare l'elenco completo dei **permessi predefiniti degli utenti** nella documentazione. Inoltre, si noti che in tale elenco √® possibile visualizzare anche l'elenco dei **permessi predefiniti degli ospiti**.

{% hint style="info" %}
Ricorda che per enumerare le risorse di Azure, l'utente ha bisogno di un'autorizzazione esplicita.
{% endhint %}

### Privileged Identity Management (PIM)

Privileged Identity Management (PIM) in Azure √® uno strumento che **gestisce, controlla e monitora l'accesso privilegiato** in Azure Active Directory e Azure. Migliora la sicurezza fornendo **accesso privilegiato solo quando necessario e per una durata specifica**, **imponendo flussi di approvazione e richiedendo autenticazione aggiuntiva**. Questo approccio riduce al minimo il rischio di accesso non autorizzato garantendo che le autorizzazioni elevate vengano concesse solo quando necessario e per una durata specifica.

## Token di autenticazione

Ci sono **tre tipi di token** utilizzati in OIDC:

- [**Token di accesso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Il client presenta questo token al server delle risorse per **accedere alle risorse**. Pu√≤ essere utilizzato solo per una combinazione specifica di utente, client e risorsa e **non pu√≤ essere revocato** fino alla scadenza, che di default √® di 1 ora. La rilevazione √® bassa utilizzando questo tipo di token.
- **Token ID**: Il client riceve questo **token dal server di autorizzazione**. Contiene informazioni di base sull'utente. √à **vincolato a una combinazione specifica di utente e client**.
- **Token di aggiornamento**: Fornito al client con il token di accesso. Utilizzato per **ottenere nuovi token di accesso e ID**. √à vincolato a una combinazione specifica di utente e client e pu√≤ essere revocato. La scadenza predefinita √® di **90 giorni** per i token di aggiornamento inattivi e **nessuna scadenza per i token attivi**.

{% hint style="warning" %}
Le informazioni per l'**accesso condizionale** sono **memorizzate** all'interno del **JWT**. Quindi, se richiedi il **token da un indirizzo IP consentito**, quell'**IP** verr√† **memorizzato** nel token e successivamente potrai utilizzare quel token da un **indirizzo IP non consentito per accedere alle risorse**.
{% endhint %}

Consulta la seguente pagina per conoscere i diversi modi per **richiedere token di accesso** e accedere con essi:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

I punti di API pi√π comuni sono:

- **Azure Resource Manager** (ARM): management.azure.com
- **Microsoft Graph**: graph.microsoft.com (Azure AD Graph, che √® deprecato, √® graph.windows.net)

## Riferimenti

- [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
- [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
- [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
- [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

- Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, consulta i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
- Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
- Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
- **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Condividi i tuoi trucchi di hacking inviando PR** a [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
