# Az - Informaci√≥n B√°sica

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Jerarqu√≠a Organizacional

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Grupos de Gesti√≥n

Si tu organizaci√≥n tiene **muchas suscripciones de Azure**, podr√≠as necesitar una manera eficiente de **gestionar el acceso**, pol√≠ticas y cumplimiento para esas **suscripciones**. Los **grupos de gesti√≥n** proporcionan un **alcance de gobernanza por encima de las suscripciones**.

Ten en cuenta que se pueden soportar **10,000 grupos de gesti√≥n** en un solo directorio y un √°rbol de grupo de gesti√≥n puede soportar **hasta seis niveles de profundidad**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

A cada directorio se le asigna un √∫nico **grupo de gesti√≥n de nivel superior llamado el grupo ra√≠z**. El grupo de gesti√≥n ra√≠z est√° integrado en la jerarqu√≠a para tener **todos los grupos de gesti√≥n y suscripciones bajo √©l**. Este grupo de gesti√≥n ra√≠z permite aplicar **pol√≠ticas globales y asignaciones de roles de Azure** a nivel de directorio. El [**Administrador Global de Azure AD** necesita elevarse a s√≠ mismo](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) al **rol de Administrador de Acceso de Usuario de este grupo ra√≠z** inicialmente. Despu√©s de elevar el acceso, el administrador puede **asignar cualquier rol de Azure a otros usuarios o grupos del directorio para gestionar la jerarqu√≠a**. Como administrador, puedes asignar **tu propia cuenta como propietario del grupo** de gesti√≥n ra√≠z.

El grupo de gesti√≥n ra√≠z **no se puede mover ni eliminar**, a diferencia de otros grupos de gesti√≥n.

Los grupos de gesti√≥n te ofrecen una gesti√≥n de nivel empresarial a gran escala, sin importar qu√© tipo de suscripciones puedas tener. Sin embargo, **todas las suscripciones dentro de un mismo grupo de gesti√≥n** deben confiar en el **mismo inquilino de Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Suscripciones de Azure

Una suscripci√≥n de Azure es un **contenedor l√≥gico** utilizado para **aprovisionar** recursos empresariales o t√©cnicos **relacionados en Azure**. Contiene los **detalles de todos tus recursos** como m√°quinas virtuales (VMs), bases de datos y m√°s. Cuando creas un recurso de Azure como una VM, identificas la **suscripci√≥n a la que pertenece**. Te permite delegar acceso a trav√©s de mecanismos de control de acceso basado en roles.

### Grupos de Recursos

Un grupo de recursos es un **contenedor** que contiene **recursos relacionados** para una soluci√≥n de Azure. El grupo de recursos puede incluir todos los recursos para la soluci√≥n, o solo aquellos **recursos que deseas gestionar como grupo**. Generalmente, agrega **recursos** que comparten el **mismo ciclo de vida** al mismo grupo de recursos para que puedas implementarlos, actualizarlos y eliminarlos f√°cilmente como grupo.

Todos los **recursos** deben estar **dentro de un grupo de recursos** y solo pueden pertenecer a un grupo y si se elimina un grupo de recursos, todos los recursos dentro de √©l tambi√©n se eliminan.

### Unidades Administrativas

Las unidades administrativas te permiten **subdividir** tu organizaci√≥n en **cualquier unidad** que desees y luego **asignar administradores espec√≠ficos** que puedan **gestionar solo a los miembros** de esa unidad. Por ejemplo, podr√≠as usar unidades administrativas para delegar permisos a los administradores de cada escuela en una universidad grande, para que puedan controlar el acceso, gestionar usuarios y establecer pol√≠ticas solo en la Escuela de Ingenier√≠a.

Solo **usuarios**, **grupos** y **dispositivos** pueden ser **miembros** de una **unidad administrativa**.

Por lo tanto, una **unidad administrativa** contendr√° algunos **miembros** y a otros **principales** se les **asignar√°n permisos sobre esa** unidad administrativa **que pueden usar para** **gestionar los miembros** de la unidad administrativa.

## Azure vs Azure AD vs Azure AD Domain Services

Es importante notar que **Azure AD** es un servicio **dentro de** **Azure**. **Azure** es la **plataforma en la nube** de Microsoft, mientras que **Azure AD** es un servicio de **identidad empresarial** en Azure.\
Adem√°s, **Azure AD no es como Windows Active Directory**, es un servicio de identidad que funciona de una manera completamente diferente. Si quieres ejecutar un **Controlador de Dominio en Azure** para tu entorno de Windows Active Directory necesitas usar **Azure AD Domain Services**.

## Principales

Azure soporta diferentes tipos de principales:

* **Usuario**: Una **persona** regular con credenciales para acceder.
* **Grupo**: Un **grupo de principales** gestionado conjuntamente. Los **permisos** otorgados a los grupos son **heredados** por sus **miembros**.
*   **Principal de Servicio/Aplicaciones Empresariales**: Es una **identidad** creada para **uso** con **aplicaciones**, servicios alojados y herramientas automatizadas para acceder a recursos de Azure. Este acceso est√° **restringido por los roles asignados** al principal de servicio, d√°ndote control sobre **qu√© recursos se pueden acceder** y en qu√© nivel. Por razones de seguridad, siempre se recomienda **usar principales de servicio con herramientas automatizadas** en lugar de permitirles iniciar sesi√≥n con una identidad de usuario.

Al crear un **principal de servicio** puedes elegir entre **autenticaci√≥n por contrase√±a** o **autenticaci√≥n por certificado**.

* Si eliges autenticaci√≥n por **contrase√±a** (por defecto), **guarda la contrase√±a generada** ya que no podr√°s acceder a ella de nuevo.
* Si eliges autenticaci√≥n por certificado, aseg√∫rate de que la **aplicaci√≥n tendr√° acceso sobre la clave privada**.
* **Identidad Administrada (Credenciales de Metadatos)**: Las identidades administradas proporcionan una **identidad gestionada autom√°ticamente** en Azure Active Directory para que las aplicaciones la utilicen al **conectarse** a **recursos** que admiten la autenticaci√≥n de Azure Active Directory (**Azure AD**). Las aplicaciones pueden usar identidades administradas para **obtener tokens de Azure AD sin tener que gestionar ninguna credencial**.\
Hay dos tipos de identidades administradas:
* **Asignada por el sistema**. Algunos servicios de Azure te permiten **habilitar una identidad administrada directamente en una instancia de servicio**. Cuando habilitas una identidad administrada asignada por el sistema, se crea una identidad en Azure AD. La identidad est√° vinculada al **ciclo de vida de esa instancia de servicio**. Cuando se **elimina** el **recurso**, Azure autom√°ticamente **elimina** la **identidad** por ti. Por dise√±o, solo ese recurso de Azure puede usar esta identidad para solicitar tokens de Azure AD.
* **Asignada por el usuario**. Tambi√©n puedes crear una identidad administrada como un recurso de Azure independiente. Puedes [crear una identidad administrada asignada por el usuario](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) y asignarla a una o **m√°s instancias** de un servicio de Azure (m√∫ltiples recursos). Para las identidades administradas asignadas por el usuario, la **identidad se gestiona por separado de los recursos que la utilizan**.

## Roles & Permisos

Los **roles** se **asignan** a **principales** en un **alcance**: `principal -[TIENE ROL]->(alcance)`

Los **roles** asignados a **grupos** son **heredados** por todos los **miembros** del grupo.

Dependiendo del alcance al que se asign√≥ el rol, el **rol** podr√≠a ser **heredado** a **otros recursos** dentro del contenedor de alcance. Por ejemplo, si un usuario A tiene un **rol en la suscripci√≥n**, tendr√° ese **rol en todos los grupos de recursos** dentro de la suscripci√≥n y en **todos los recursos** dentro del grupo de recursos.

### **Roles Cl√°sicos**

| **Propietario**                     | <ul><li>Acceso completo a todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul> | Todos los tipos de recursos |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Colaborador**               | <ul><li>Acceso completo a todos los recursos</li><li>No puede gestionar el acceso</li></ul>              | Todos los tipos de recursos |
| **Lector**                    | ‚Ä¢ Ver todos los recursos                                                                     | Todos los tipos de recursos |
| **Administrador de Acceso de Usuario** | <ul><li>Ver todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul>           | Todos los tipos de recursos |

### Roles Integrados

El control de acceso basado en roles de Azure (Azure RBAC) tiene varios **roles integrados** que puedes **asignar** a **usuarios, grupos, principales de servicio e identidades administradas**. Las asignaciones de roles son la forma en que controlas el **acceso a los recursos de Azure**. Si los roles integrados no satisfacen las necesidades espec√≠ficas de tu organizaci√≥n, puedes crear tus propios [**roles personalizados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Los roles **integrados** solo se aplican a los **recursos** para los que est√°n **destinados**, por ejemplo, revisa estos 2 ejemplos de **roles integrados sobre recursos de Computaci√≥n**:

| [Lector de Copia de Seguridad de Disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Proporciona permiso para realizar copias de seguridad de disco en la b√≥veda de copia de seguridad.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Inicio de Sesi√≥n de Usuario de M√°quina Virtual](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Ver M√°quinas Virtuales en el portal e iniciar sesi√≥n como usuario regular. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Estos roles **tambi√©n pueden asignarse sobre contenedores l√≥gicos** (como grupos de gesti√≥n, suscripciones y grupos de recursos) y los principales afectados los tendr√°n **sobre los recursos dentro de esos contenedores**.

* Encuentra aqu√≠ una lista con [**todos los roles integrados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Encuentra aqu√≠ una lista con [**todos los roles integrados de Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Roles Personalizados

Azure tambi√©n permite crear [**roles personalizados**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con los permisos que el usuario necesita.

### Permiso Denegado

* Para que un **principal tenga alg√∫n acceso sobre un recurso**, necesita un rol expl√≠cito que le otorgue ese permiso.
* Una asignaci√≥n de rol de **denegaci√≥n expl√≠cita tiene prioridad** sobre el rol que otorga el permiso.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Administrador Global

Los usuarios con el rol de Administrador Global tienen la capacidad de '**elevarse' al rol de Administrador de Acceso de Usuario de Azure en el grupo de gesti√≥n ra√≠z**. Esto significa que un Administrador Global podr√° gestionar el acceso a **todas las suscripciones y grupos de gesti√≥n de Azure.**\
Esta elevaci√≥n se puede realizar al final de la p√°gina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Pol√≠ticas de Azure

Las pol√≠ticas de Azure son un conjunto de **reglas y regulaciones en Microsoft Azure**, un servicio de computaci√≥n en la nube, que ayudan a gestionar y hacer cumplir los est√°ndares organizacionales y a evaluar el cumplimiento a gran escala. Estas pol√≠ticas imponen diferentes reglas sobre tus **recursos de Azure**, asegurando que esos recursos se mantengan en cumplimiento con los est√°ndares corporativos y los acuerdos de nivel de servicio.

Las pol√≠ticas de Azure son cruciales para la gobernanza y seguridad en la nube, ayudando a asegurar que los recursos se utilicen de manera adecuada y eficiente, y que cumplan con regulaciones externas y pol√≠ticas internas.\
Algunos ejemplos:

1. **Asegurar el Cumplimiento con Regiones Espec√≠ficas de Azure**: Esta pol√≠tica asegura que todos los recursos se desplieguen en regiones espec√≠ficas de Azure. Por ejemplo, una empresa podr√≠a querer asegurarse de que todos sus datos se almacenen en Europa para cumplir con el GDPR.
2. **Imponer Est√°ndares de Nomenclatura**: Las pol√≠ticas pueden imponer convenciones de nomenclatura para los recursos de Azure. Esto ayuda a organizar y a identificar f√°cilmente los recursos basados en sus nombres, lo cual es √∫til en entornos grandes.
3. **Restringir Ciertos Tipos de Recursos**: Esta pol√≠tica puede restringir la creaci√≥n de ciertos tipos de recursos. Por ejemplo, se podr√≠a establecer una pol√≠tica para prevenir la creaci√≥n de tipos de recursos costosos, como ciertos tama√±os de VM, para controlar costos.
4. **Imponer Pol√≠ticas de Etiquetado**: Las etiquetas son pares de clave-valor asociados con recursos de Azure utilizados para la gesti√≥n de recursos. Las pol√≠ticas pueden imponer que ciertas etiquetas deben estar presentes, o tener valores espec√≠ficos, para todos los recursos. Esto es √∫til para el seguimiento de costos, propiedad o categorizaci√≥n de recursos.
5. **Limitar el Acceso P√∫blico a Recursos**: Las pol√≠ticas pueden imponer que ciertos recursos, como cuentas de almacenamiento o bases de datos, no tengan puntos finales p√∫blicos, asegurando que solo sean accesibles dentro de la red de la organizaci√≥n.
6. **Aplicar Autom√°ticamente Configuraciones de Seguridad**: Las pol√≠ticas pueden usarse para aplicar autom√°ticamente configuraciones de seguridad a los recursos, como aplicar un grupo de seguridad de red espec√≠fico a todas las VM o asegurar que todas las cuentas de almacenamiento usen cifrado.

Ten en cuenta que las Pol√≠ticas de Azure pueden adjuntarse a cualquier nivel de la jerarqu√≠a de Azure, pero son **com√∫nmente utilizadas en el grupo de gesti√≥n ra√≠z** o en otros grupos de gesti√≥n.

### Azure RBAC vs ABAC

**RBAC** (control de acceso basado en roles) es lo que ya hemos visto en las secciones anteriores: **Asignar un rol a un principal para otorgarle acceso** sobre un recurso.\
Sin embargo, en algunos casos podr√≠as querer proporcionar **gesti√≥n de acceso m√°s detallada** o **simplificar** la gesti√≥n de **cientos** de **asignaciones de roles**.

Azure **ABAC** (control de acceso basado en atributos) se basa en Azure RBAC a√±adiendo **condiciones de asignaci√≥n de roles basadas en atributos** en el contexto de acciones espec√≠ficas. Una _condici√≥n de asignaci√≥n de rol_ es una **verificaci√≥n adicional que puedes agregar opcionalmente a
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Prueba cada portal** si es posible **iniciar sesi√≥n sin MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

Debido a que el **portal Azure** **no est√° restringido**, es posible **obtener un token del punto final del portal para acceder a cualquier servicio detectado** por la ejecuci√≥n anterior. En este caso se identific√≥ Sharepoint, y se solicita un token para acceder a √©l:
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune Read-JWTtoken -token $token.access_token
```
<figure><img src="../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

El token tiene el permiso Sites.Read.All (de Sharepoint):

<figure><img src="../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

Incluso si no puedes acceder a Sharepoint desde la web debido a MFA, es posible usar el token para acceder a los archivos con el token generado:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
Obtener URL para descargar archivos:

## Referencias

* [https://learn.microsoft.com/es-es/azure/governance/management-groups/overview](https://learn.microsoft.com/es-es/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/es-es/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/es-es/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=Una%20suscripci√≥n%20de%20Azure%20es%20una,la%20suscripci√≥n%20a%20la%20que%20pertenece.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/es-es/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/es-es/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
