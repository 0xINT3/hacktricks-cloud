# Az - Informa√ß√µes B√°sicas

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## Hierarquia de Organiza√ß√£o

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Grupos de Gerenciamento

Se sua organiza√ß√£o tiver **muitas assinaturas do Azure**, voc√™ pode precisar de uma maneira de gerenciar eficientemente o **acesso**, as **pol√≠ticas** e a **conformidade** para essas **assinaturas**. Os **grupos de gerenciamento** fornecem um **escopo de governan√ßa acima das assinaturas**.

Observe que **10.000 grupos de gerenciamento** podem ser suportados em um √∫nico diret√≥rio e uma √°rvore de grupos de gerenciamento pode suportar **at√© seis n√≠veis de profundidade**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

Cada diret√≥rio recebe um √∫nico **grupo de gerenciamento de n√≠vel superior chamado raiz**. O grupo de gerenciamento raiz √© incorporado √† hierarquia para ter **todos os grupos de gerenciamento e assinaturas dobrados para ele**. Este grupo de gerenciamento raiz permite que **pol√≠ticas globais e atribui√ß√µes de fun√ß√£o do Azure** sejam aplicadas no n√≠vel do diret√≥rio. O [**Administrador Global do Azure AD precisa se elevar**](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) para a **fun√ß√£o de Administrador de Acesso do Usu√°rio deste grupo raiz** inicialmente. Ap√≥s elevar o acesso, o administrador pode **atribuir qualquer fun√ß√£o do Azure a outros usu√°rios ou grupos do diret√≥rio para gerenciar a hierarquia**. Como administrador, voc√™ pode atribuir **sua pr√≥pria conta como propriet√°rio da raiz** do grupo de gerenciamento.

O grupo de gerenciamento raiz **n√£o pode ser movido ou exclu√≠do**, ao contr√°rio de outros grupos de gerenciamento.

Os grupos de gerenciamento oferecem gerenciamento de n√≠vel empresarial em escala, independentemente do tipo de assinaturas que voc√™ possa ter. No entanto, **todas as assinaturas dentro de um √∫nico grupo de gerenciamento** devem confiar no **mesmo locat√°rio do Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Assinaturas do Azure

Uma assinatura do Azure √© um **cont√™iner l√≥gico** usado para **provisionar recursos de neg√≥cios ou t√©cnicos relacionados no Azure**. Ele cont√©m os **detalhes de todos os seus recursos** como m√°quinas virtuais (VMs), bancos de dados e muito mais. Quando voc√™ cria um recurso do Azure, como uma VM, voc√™ identifica a **assinatura √† qual ele pertence**. Isso permite que voc√™ delegue acesso por meio de mecanismos de controle de acesso baseados em fun√ß√£o.

### Grupos de Recursos

Um grupo de recursos √© um **cont√™iner** que cont√©m **recursos relacionados** para uma solu√ß√£o do Azure. O grupo de recursos pode incluir todos os recursos para a solu√ß√£o ou apenas aqueles **recursos que voc√™ deseja gerenciar como um grupo**. Geralmente, adicione **recursos** que compartilham o **mesmo ciclo de vida** ao mesmo grupo de recursos para que voc√™ possa implant√°-los, atualiz√°-los e exclu√≠-los facilmente como um grupo.

Todos os **recursos** devem estar **dentro de um grupo de recursos** e podem pertencer apenas a um grupo e, se um grupo de recursos for exclu√≠do, todos os recursos dentro dele tamb√©m ser√£o exclu√≠dos.

### Unidades Administrativas

As unidades administrativas permitem que voc√™ **subdivida** sua organiza√ß√£o em **qualquer unidade** que desejar e, em seguida, **atribua administradores espec√≠ficos** que podem **gerenciar apenas os membros** dessa unidade. Por exemplo, voc√™ pode usar unidades administrativas para delegar permiss√µes aos administradores de cada escola em uma grande universidade, para que eles possam controlar o acesso, gerenciar usu√°rios e definir pol√≠ticas apenas na Escola de Engenharia.

Somente **usu√°rios**, **grupos** e **dispositivos** podem ser **membros** de uma **unidade administrativa**.

Portanto, uma **unidade administrativa** conter√° alguns **membros** e outros **principais** ser√£o **atribu√≠dos permiss√µes sobre essa** unidade administrativa **que eles podem usar para gerenciar os membros** da unidade administrativa.

## Azure vs Azure AD vs Azure AD Domain Services

√â importante observar que o **Azure AD** √© um servi√ßo **dentro do** **Azure**. O **Azure** √© a **plataforma de nuvem** da Microsoft, enquanto o **Azure AD** √© um **servi√ßo de identidade empresarial** no Azure.\
Al√©m disso, o **Azure AD n√£o √© como o Active Directory do Windows**, √© um servi√ßo de identidade que funciona de maneira completamente diferente. Se voc√™ quiser executar um **Controlador de Dom√≠nio no Azure** para seu ambiente do Active Directory do Windows, voc√™ precisa usar o **Azure AD Domain Services**.

## Princ√≠pios

O Azure suporta diferentes tipos de princ√≠pios:

* **Usu√°rio**: uma **pessoa** com credenciais para acessar.
* **Grupo**: um **grupo de princ√≠pios** gerenciados juntos. As **permiss√µes** concedidas aos grupos s√£o **herdadas** por seus **membros**.
* **Service Principal**: √© uma **identidade** criada para **uso** com **aplicativos**, servi√ßos hospedados e ferramentas automatizadas para acessar recursos do Azure. Esse acesso √© **restrito pelas fun√ß√µes atribu√≠das**, dando a voc√™ controle sobre **quais recursos podem ser acessados** e em qual n√≠vel. Por motivos de seguran√ßa, √© sempre recomend√°vel **usar service principals com ferramentas automatizadas** em vez de permitir que eles fa√ßam login com uma identidade de usu√°rio.

Ao criar um **service principal**, voc√™ pode escolher entre **autentica√ß√£o de senha** ou **autentica√ß√£o de certificado**.

* Se voc√™ escolher a autentica√ß√£o por **senha** (por padr√£o), **salve a senha gerada**, pois voc√™ n√£o poder√° acess√°-la novamente.
* Se voc√™ escolher a autentica√ß√£o por certificado, certifique-se de que a **aplica√ß√£o ter√° acesso √† chave privada**.
* **Identidade Gerenciada**: as identidades gerenciadas fornecem uma **identidade gerenciada automaticamente** no Azure Active Directory para que as aplica√ß√µes usem ao **conectar-se a recursos** que suportam a autentica√ß√£o do Azure Active Directory (**Azure AD**). As aplica√ß√µes podem usar identidades gerenciadas para **obter tokens do Azure AD sem precisar gerenciar credenciais**.\
Existem dois tipos de identidades gerenciadas:
  * **Atribu√≠da pelo sistema**. Alguns servi√ßos do Azure permitem que voc√™ **habilite uma identidade gerenciada diretamente em uma inst√¢ncia de servi√ßo**. Quando voc√™ habilita uma identidade gerenciada atribu√≠da pelo sistema, uma identidade √© criada no Azure AD. A identidade est√°
### Fun√ß√µes integradas

O controle de acesso baseado em fun√ß√£o do Azure (Azure RBAC) tem v√°rias **fun√ß√µes integradas do Azure** que voc√™ pode **atribuir** a **usu√°rios, grupos, identidades gerenciadas e de servi√ßo**. As atribui√ß√µes de fun√ß√£o s√£o a maneira como voc√™ controla **o acesso aos recursos do Azure**. Se as fun√ß√µes integradas n√£o atenderem √†s necessidades espec√≠ficas da sua organiza√ß√£o, voc√™ pode criar suas pr√≥prias [**fun√ß√µes personalizadas do Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles).

As fun√ß√µes **integradas** se aplicam apenas aos **recursos** para os quais s√£o **destinadas**, por exemplo, verifique esses dois exemplos de fun√ß√µes **integradas sobre recursos de computa√ß√£o**:

| [Leitor de backup de disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader) | Fornece permiss√£o para o cofre de backup executar backup de disco. | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------- | ------------------------------------ |
| [Usu√°rio de login de m√°quina virtual](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Visualizar m√°quinas virtuais no portal e fazer login como usu√°rio regular. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Essas fun√ß√µes tamb√©m podem ser atribu√≠das a **cont√™ineres l√≥gicos** (como grupos de gerenciamento, assinaturas e grupos de recursos) e os princ√≠pios afetados ter√£o essas fun√ß√µes **sobre os recursos dentro desses cont√™ineres**.

* Encontre aqui uma lista com [**todas as fun√ß√µes integradas do Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Encontre aqui uma lista com [**todas as fun√ß√µes integradas do Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Fun√ß√µes personalizadas

O Azure tamb√©m permite criar [**fun√ß√µes personalizadas**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) com as permiss√µes necess√°rias do usu√°rio.

### Permiss√£o negada

* Para que um **princ√≠pio tenha algum acesso sobre um recurso**, ele precisa de uma atribui√ß√£o de fun√ß√£o expl√≠cita sendo concedida a ele (de qualquer maneira) **concedendo-lhe essa permiss√£o**.
* Uma atribui√ß√£o de fun√ß√£o de **nega√ß√£o expl√≠cita tem preced√™ncia** sobre a fun√ß√£o que concede a permiss√£o.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Administrador global

Os usu√°rios com a fun√ß√£o de Administrador global t√™m a capacidade de '**elevar' para a fun√ß√£o de Administrador de acesso do usu√°rio ao grupo de gerenciamento raiz**. Isso significa que um Administrador global poder√° gerenciar o acesso a **todas as assinaturas e grupos de gerenciamento do Azure**.\
\*\*\*\*Essa eleva√ß√£o pode ser feita no final da p√°gina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

O controle de acesso baseado em atributos do Azure (ABAC) baseia-se no Azure RBAC, adicionando **condi√ß√µes de atribui√ß√£o de fun√ß√£o com base em atributos** no contexto de a√ß√µes espec√≠ficas. Uma _condi√ß√£o de atribui√ß√£o de fun√ß√£o_ √© uma **verifica√ß√£o adicional que voc√™ pode adicionar opcionalmente √† sua atribui√ß√£o de fun√ß√£o** para fornecer um controle de acesso mais refinado. Uma condi√ß√£o filtra as permiss√µes concedidas como parte da defini√ß√£o e atribui√ß√£o de fun√ß√£o. Por exemplo, voc√™ pode **adicionar uma condi√ß√£o que exige que um objeto tenha uma tag espec√≠fica para ler o objeto**.\
Voc√™ **n√£o pode** negar explicitamente **o acesso** a recursos espec√≠ficos **usando condi√ß√µes**.

### Permiss√µes padr√£o do usu√°rio

Um usu√°rio b√°sico ter√° algumas **permiss√µes padr√£o** para enumerar algumas partes do AzureAD:

* Ler todos os usu√°rios, grupos, aplicativos, dispositivos, fun√ß√µes, assinaturas e suas propriedades p√∫blicas
* Convidar convidados (_pode ser desativado_)
* Criar grupos de seguran√ßa
* Ler associa√ß√µes de grupo n√£o ocultas
* Adicionar convidados a grupos de propriedade
* Criar novo aplicativo (_pode ser desativado_)
* Adicionar at√© 50 dispositivos ao Azure (_pode ser desativado_)

Voc√™ pode ver a lista completa de [**permiss√µes padr√£o dos usu√°rios** na documenta√ß√£o](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Al√©m disso, observe que nessa lista voc√™ tamb√©m pode ver a lista de **permiss√µes padr√£o de convidados**.

{% hint style="info" %}
Lembre-se de que, para enumerar recursos do Azure, o usu√°rio precisa de uma concess√£o expl√≠cita da permiss√£o.
{% endhint %}

## Tokens de autentica√ß√£o

Existem **tr√™s tipos de tokens** usados em OIDC:

* \*\*\*\*[**Tokens de acesso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** O cliente apresenta esse token ao servidor de recursos para **acessar recursos**. Ele pode ser usado apenas para uma combina√ß√£o espec√≠fica de usu√°rio, cliente e recurso e **n√£o pode ser revogado** at√© o vencimento - que √© de 1 hora por padr√£o. A detec√ß√£o √© baixa usando isso.
* **Tokens de ID**: O cliente recebe este **token do servidor de autoriza√ß√£o**. Ele cont√©m informa√ß√µes b√°sicas sobre o usu√°rio. Est√° **vinculado a uma combina√ß√£o espec√≠fica de usu√°rio e cliente**.
* **Tokens de atualiza√ß√£o**: Fornecido ao cliente com o token de acesso. Usado para **obter novos tokens de acesso e ID**. Est√° vinculado a uma combina√ß√£o espec√≠fica de usu√°rio e cliente e pode ser revogado. O vencimento padr√£o √© de **90 dias** para tokens de atualiza√ß√£o inativos e **sem vencimento para tokens ativos**.

{% hint style="warning" %}
As informa√ß√µes para **acesso condicional** s√£o **armazenadas** dentro do **JWT**. Portanto,