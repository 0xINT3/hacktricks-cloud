# Az - Información Básica

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Jerarquía de Organización

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Grupos de Administración

Si tu organización tiene **muchas suscripciones de Azure**, es posible que necesites una forma de **gestionar eficientemente el acceso, las políticas y el cumplimiento de esas suscripciones**. Los **grupos de administración** proporcionan un **alcance de gobernanza por encima de las suscripciones**.

Ten en cuenta que se pueden admitir **10,000 grupos de administración** en un solo directorio y un árbol de grupos de administración puede admitir **hasta seis niveles de profundidad**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

[Desde la documentación](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): A cada directorio se le asigna un **grupo de administración de nivel superior único llamado raíz**. El grupo de administración raíz está integrado en la jerarquía para que todos los grupos de administración y suscripciones se plieguen a él. Este grupo de administración raíz permite que se apliquen **políticas globales y asignaciones de roles de Azure** a nivel de directorio. El [**Administrador Global de Azure AD necesita elevarse a sí mismo](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) al **rol de Administrador de Acceso de Usuario de este grupo raíz** inicialmente. Después de elevar el acceso, el administrador puede **asignar cualquier rol de Azure a otros usuarios o grupos del directorio para gestionar la jerarquía**. Como administrador, puedes asignar **tu propia cuenta como propietario de la raíz** del grupo de administración.

El grupo de administración raíz **no se puede mover ni eliminar**, a diferencia de otros grupos de administración.

Los grupos de administración te brindan una gestión de nivel empresarial a escala, independientemente del tipo de suscripciones que puedas tener. Sin embargo, **todas las suscripciones dentro de un solo grupo de administración** deben confiar en el **mismo inquilino de Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Suscripciones de Azure

En Azure, una suscripción sirve como un **contenedor lógico** para el propósito de **aprovisionar recursos** comerciales o técnicos. Este contenedor mantiene los **detalles de los recursos** como máquinas virtuales (VM), bases de datos, entre otros. Al crear un recurso de Azure, como una VM, se especifica la **suscripción asociada** a él. Esta estructura facilita la delegación de acceso, utilizando mecanismos de control de acceso basados en roles.

### Grupos de Recursos

[Desde la documentación:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Un grupo de recursos es un **contenedor** que alberga **recursos relacionados** para una solución de Azure. El grupo de recursos puede incluir todos los recursos de la solución, o solo aquellos **recursos que deseas gestionar como grupo**. Generalmente, agrega **recursos** que comparten el **mismo ciclo de vida** al mismo grupo de recursos para poder implementar, actualizar y eliminarlos fácilmente como grupo.

Todos los **recursos** deben estar **dentro de un grupo de recursos** y solo pueden pertenecer a un grupo, y si se elimina un grupo de recursos, también se eliminan todos los recursos dentro de él.

### Unidades Administrativas

[Desde la documentación:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Las unidades administrativas te permiten **subdividir tu organización en cualquier unidad** que desees, y luego **asignar administradores específicos** que pueden **gestionar solo los miembros** de esa unidad. Por ejemplo, podrías usar unidades administrativas para delegar permisos a los administradores de cada escuela en una gran universidad, para que puedan controlar el acceso, gestionar usuarios y establecer políticas solo en la Escuela de Ingeniería.

Solo **usuarios**, **grupos** y **dispositivos** pueden ser **miembros** de una **unidad administrativa**.

Por lo tanto, una **unidad administrativa** contendrá algunos **miembros** y otros **principales** tendrán **asignados permisos sobre esa** unidad administrativa que pueden usar para **gestionar los miembros** de la unidad administrativa.

## Azure vs Azure AD vs Servicios de Dominio de Azure AD

Es importante tener en cuenta que **Azure AD** es un servicio **dentro de** **Azure**. **Azure** es la **plataforma en la nube** de Microsoft, mientras que **Azure AD** es un **servicio de identidad empresarial** en Azure.\
Además, **Azure AD no es como Active Directory de Windows**, es un servicio de identidad que funciona de una manera completamente diferente. Si deseas ejecutar un **Controlador de Dominio en Azure** para tu entorno de Active Directory de Windows, necesitas usar **Servicios de Dominio de Azure AD**.

## Principales

Azure admite diferentes tipos de principales:

* **Usuario**: Una **persona** regular con credenciales para acceder.
* **Grupo**: Un **grupo de principales** gestionados juntos. Los **permisos** concedidos a los grupos son **heredados** por sus **miembros**.
* **Principal de Servicio/Aplicaciones Empresariales**: Es una **identidad** creada para **usar** con **aplicaciones**, servicios alojados y herramientas automatizadas para acceder a recursos de Azure. Este acceso está **restringido por los roles asignados** al principal de servicio, lo que te da control sobre **a qué recursos se puede acceder** y en qué nivel. Por razones de seguridad, siempre se recomienda **utilizar principales de servicio con herramientas automatizadas** en lugar de permitirles iniciar sesión con una identidad de usuario.

Al crear un **principal de servicio** puedes elegir entre **autenticación de contraseña** o **autenticación de certificado**.

* Si eliges la autenticación por **contraseña** (por defecto), **guarda la contraseña generada** ya que no podrás acceder a ella nuevamente.
* Si eliges la autenticación por certificado, asegúrate de que la **aplicación tenga acceso a la clave privada**.
* **Identidad Administrada (Credenciales de Metadatos)**: Las identidades administradas en Azure Active Directory ofrecen una solución para **gestionar automáticamente la identidad** de las aplicaciones. Estas identidades son utilizadas por las aplicaciones con el propósito de **conectar** a **recursos** compatibles con la autenticación de Azure Active Directory (**Azure AD**). Al utilizar identidades administradas, las aplicaciones pueden **asegurar tokens de Azure AD** eliminando la necesidad de manejar credenciales directamente.
Existen dos tipos de identidades administradas:
* **Asignada por el sistema**. Algunos servicios de Azure te permiten **habilitar una identidad administrada directamente en una instancia de servicio**. Cuando habilitas una identidad administrada asignada por el sistema, se crea una identidad en Azure AD. La identidad está vinculada al **ciclo de vida de esa instancia de servicio**. Cuando se **elimina el recurso**, Azure elimina automáticamente la **identidad** por ti. Por diseño, solo ese recurso de Azure puede usar esta identidad para solicitar tokens a Azure AD.
* **Asignada por el usuario**. También puedes crear una identidad administrada como un recurso independiente de Azure. Puedes [crear una identidad administrada asignada por el usuario](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) y asignarla a una o **más instancias** de un servicio de Azure (múltiples recursos). Para las identidades administradas asignadas por el usuario, la **identidad se gestiona por separado de los recursos que la utilizan**.

## Roles y Permisos

Los **roles** se **asignan** a **principales** en un **ámbito**: `principal -[TIENE ROL]->(ámbito)`

Los **roles** asignados a **grupos** son **heredados** por todos los **miembros** del grupo.

Dependiendo del ámbito al que se asignó el rol, el **rol** podría ser **heredado** por **otros recursos** dentro del contenedor de ámbito. Por ejemplo, si un usuario A tiene un **rol en la suscripción**, tendrá ese **rol en todos los grupos de recursos** dentro de la suscripción y en **todos los recursos** dentro del grupo de recursos.

### **Roles Clásicos**

| **Propietario**               | <ul><li>Acceso completo a todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul> | Todos los tipos de recursos |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contribuyente**             | <ul><li>Acceso completo a todos los recursos</li><li>No puede gestionar el acceso</li></ul>              | Todos los tipos de recursos |
| **Lector**                    | • Ver todos los recursos                                                                     | Todos los tipos de recursos |
| **Administrador de Acceso de Usuario** | <ul><li>Ver todos los recursos</li><li>Puede gestionar el acceso para otros usuarios</li></ul>           | Todos los tipos de recursos |

### Roles Integrados

[Desde la documentación: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Control de acceso basado en roles de Azure (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) tiene varios **roles integrados de Azure** que puedes **asignar** a **usuarios, grupos, principales de servicio e identidades administradas**. Las asignaciones de roles son la forma en que controlas **el acceso a los recursos de Azure**. Si los roles integrados no cumplen con las necesidades específicas de tu organización, puedes crear tus propios [**roles personalizados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Los roles **integrados** se aplican solo a los **recursos** para los que están **destinados**, por ejemplo, revisa estos 2 ejemplos de **roles integrados sobre recursos de Cómputo**:

| [Lector de Copias de Seguridad de Disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Proporciona permiso para realizar copias de seguridad de disco en el almacén.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Inicio de Sesión de Usuario de Máquina Virtual](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Ver Máquinas Virtuales en el portal e iniciar sesión como un usuario regular. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Estos roles también se pueden **asignar sobre contenedores lógicos** (como grupos de administración, suscripciones y grupos de recursos) y los principales afectados los tendrán **sobre los recursos dentro de esos contenedores**.

* Encuentra aquí una lista con [**todos los roles integrados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Encuentra aquí una lista con [**todos los roles integrados de Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Roles Personalizados

Azure también permite crear [**roles personalizados**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con los permisos que el usuario necesita.

### Permiso Denegado

* Para que un **principal tenga acceso sobre un recurso**, necesita que se le otorgue explícitamente un rol (de todos modos) **concediéndole ese permiso**.
* Una asignación de rol de **denegación explícita tiene precedencia** sobre el rol que otorga el permiso.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Administrador Global

Los usuarios con el rol de Administrador Global tienen la capacidad de '**elevar' al rol de Administrador de Acceso de Usuario al grupo de administración raíz**. Esto significa que un Administrador Global podrá gestionar el acceso a **todas las suscripciones y grupos de administración de Azure**.\
Esta elevación se puede realizar al final de la página: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Políticas de Azure

Las políticas de Azure son un conjunto de **reglas y regulaciones en Microsoft Azure**, un servicio de computación en la nube, que ayudan a gestionar y hacer cumplir los estándares organizativos y evaluar el cumplimiento a escala. Estas políticas hacen cumplir diferentes reglas sobre tus **recursos de Azure**, asegurando que esos recursos cumplan con los estándares corporativos y los acuerdos de nivel de servicio.

Las políticas de Azure son cruciales para la gobernanza y la seguridad en la nube, ayudando a garantizar que los recursos se utilicen de manera adecuada y eficiente, y que cumplan con las regulaciones externas y las políticas internas.\
Algunos ejemplos:

1. **Garantizar el Cumplimiento con Regiones Específicas de Azure**: Esta política asegura que todos los recursos se implementen en regiones de Azure específicas. Por ejemplo, una empresa podría querer asegurarse de que todos sus datos se almacenen en Europa para cumplir con el GDPR.
2. **Imponer Estándares de Nomenclatura**: Las políticas pueden imponer convenciones de nomenclatura para los recursos de Azure. Esto ayuda a organizar e identificar fácilmente los recursos según sus nombres, lo cual es útil en entornos grandes.
3. **Restringir Ciertos Tipos de Recursos**: Esta política puede restringir la creación de ciertos tipos de recursos. Por ejemplo, se podría establecer una política para evitar la creación de tipos de recursos costosos, como ciertos tamaños de VM, para controlar los costos.
4. **Imponer Políticas de Etiquetado**: Las etiquetas son pares clave-valor asociados con los recursos de Azure utilizados para la gestión de recursos. Las políticas pueden exigir que ciertas etiquetas estén presentes, o tengan valores específicos, para todos los recursos. Esto es útil para el seguimiento de costos, la propiedad o la categorización de recursos.
5. **Limitar el Acceso Público a los Recursos**: Las políticas pueden exigir que ciertos recursos, como cuentas de almacenamiento o bases de datos, no tengan puntos finales públicos, asegurando que solo sean accesibles dentro de la red de la organización.
6. **Aplicar Configuraciones de Seguridad Automáticamente**: Las políticas se pueden utilizar para aplicar automáticamente configuraciones de seguridad a los recursos, como aplicar un grupo de seguridad de red específico a todas las VM o garantizar que todas las cuentas de almacenamiento utilicen cifrado.

Ten en cuenta que las políticas de Azure se pueden adjuntar a cualquier nivel de la jerarquía de Azure, pero **comúnmente se utilizan en el grupo
