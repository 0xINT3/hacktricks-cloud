# Az - Informations de base

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github**.

</details>

## Hi√©rarchie de l'organisation

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Groupes de gestion

Si votre organisation a **de nombreux abonnements Azure**, vous pouvez avoir besoin d'un moyen de g√©rer efficacement l'acc√®s, les strat√©gies et la conformit√© pour ces **abonnements**. Les **groupes de gestion** fournissent une **port√©e de gouvernance au-dessus des abonnements**.

Notez que **10 000 groupes de gestion** peuvent √™tre pris en charge dans un seul r√©pertoire et qu'un arbre de groupe de gestion peut prendre en charge **jusqu'√† six niveaux de profondeur**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

Chaque r√©pertoire re√ßoit un seul **groupe de gestion de niveau sup√©rieur appel√© racine**. Le groupe de gestion racine est int√©gr√© √† la hi√©rarchie pour avoir **tous les groupes de gestion et les abonnements repli√©s dessus**. Ce groupe de gestion racine permet l'application de **strat√©gies globales et d'attributions de r√¥les Azure** au niveau du r√©pertoire. L'administrateur **Global Administrator d'Azure AD doit s'√©lever** au **r√¥le d'administrateur d'acc√®s utilisateur de ce groupe racine** initialement. Apr√®s avoir √©lev√© l'acc√®s, l'administrateur peut **attribuer n'importe quel r√¥le Azure √† d'autres utilisateurs ou groupes de r√©pertoires pour g√©rer la hi√©rarchie**. En tant qu'administrateur, vous pouvez attribuer **votre propre compte en tant que propri√©taire de la racine** du groupe de gestion.

Le groupe de gestion racine **ne peut pas √™tre d√©plac√© ou supprim√©**, contrairement aux autres groupes de gestion.

Les groupes de gestion vous offrent une gestion de qualit√© professionnelle √† grande √©chelle, quel que soit le type d'abonnements que vous pourriez avoir. Cependant, **tous les abonnements au sein d'un seul groupe de gestion** doivent faire confiance au **m√™me locataire Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Abonnements Azure

Un abonnement Azure est un **conteneur logique** utilis√© pour **provisionner** des ressources commerciales ou techniques **connexes dans Azure**. Il contient les **d√©tails de toutes vos ressources** telles que les machines virtuelles (VM), les bases de donn√©es, et plus encore. Lorsque vous cr√©ez une ressource Azure comme une VM, vous identifiez l'**abonnement auquel elle appartient**. Cela vous permet de d√©l√©guer l'acc√®s par des m√©canismes de contr√¥le d'acc√®s bas√©s sur les r√¥les.

### Groupes de ressources

Un groupe de ressources est un **conteneur** qui contient des **ressources connexes** pour une solution Azure. Le groupe de ressources peut inclure toutes les ressources pour la solution, ou seulement celles **que vous souhaitez g√©rer en tant que groupe**. En g√©n√©ral, ajoutez les **ressources** qui partagent le **m√™me cycle de vie** au m√™me groupe de ressources afin de pouvoir les d√©ployer, les mettre √† jour et les supprimer facilement en tant que groupe.

Toutes les **ressources** doivent √™tre **√† l'int√©rieur d'un groupe de ressources** et ne peuvent appartenir qu'√† un groupe et si un groupe de ressources est supprim√©, toutes les ressources √† l'int√©rieur sont √©galement supprim√©es.

### Unit√©s administratives

Les unit√©s administratives vous permettent de **diviser** votre organisation en **n'importe quelle unit√©** que vous souhaitez, puis d'**assigner des administrateurs sp√©cifiques** qui peuvent **g√©rer uniquement les membres** de cette unit√©. Par exemple, vous pourriez utiliser des unit√©s administratives pour d√©l√©guer des autorisations aux administrateurs de chaque √©cole dans une grande universit√©, afin qu'ils puissent contr√¥ler l'acc√®s, g√©rer les utilisateurs et d√©finir des strat√©gies uniquement dans l'√©cole d'ing√©nierie.

Seuls les **utilisateurs**, les **groupes** et les **appareils** peuvent √™tre **membres** d'une **unit√© administrative**.

Par cons√©quent, une **unit√© administrative** contiendra certains **membres** et d'autres **principaux** se verront attribuer des autorisations sur cette **unit√© administrative** qu'ils pourront utiliser pour **g√©rer les membres** de l'unit√© administrative.

## Azure vs Azure AD vs Azure AD Domain Services

Il est important de noter que **Azure AD** est un service **√† l'int√©rieur** d'**Azure**. **Azure** est la **plateforme cloud** de Microsoft, tandis qu'**Azure AD** est un **service d'identit√© d'entreprise** dans Azure.\
De plus, **Azure AD n'est pas comme Windows Active Directory**, c'est un service d'identit√© qui fonctionne de mani√®re compl√®tement diff√©rente. Si vous souhaitez ex√©cuter un **contr√¥leur de domaine dans Azure** pour votre environnement Windows Active Directory, vous devez utiliser **Azure AD Domain Services**.

## Principaux

Azure prend en charge diff√©rents types de principaux :

* **Utilisateur** : une **personne** ordinaire avec des identifiants pour acc√©der.
* **Groupe** : un **groupe de principaux** g√©r√©s ensemble. Les **autorisations** accord√©es aux groupes sont **h√©rit√©es** par ses **membres**.
* **Service Principal** : c'est une **identit√©** cr√©√©e pour une **utilisation** avec des **applications**, des services h√©berg√©s et des outils automatis√©s pour acc√©der aux ressources Azure. Cet acc√®s est **restreint par les r√¥les attribu√©s**, vous donnant un contr√¥le sur **les ressources qui peuvent √™tre accessibles** et √† quel niveau. Pour des raisons de s√©curit√©, il est toujours recommand√© d'**utiliser des principaux de service avec des outils automatis√©s** plut√¥t que de leur permettre de se connecter avec une identit√© utilisateur.

  Lors de la cr√©ation d'un **principal de service**, vous pouvez choisir entre **l'authentification par mot de passe** ou **l'authentification par certificat**.

  * Si vous choisissez l'authentification par **mot de passe** (par d√©faut), **enregistrez le mot de passe g√©n√©r√©** car vous ne pourrez plus y acc√©der.
  * Si vous choisissez l'authentification par certificat, assurez-vous que **l'application aura acc√®s √† la cl√© priv√©e**.
* **Identit√© g√©r√©e** : les identit√©s g√©r√©es fournissent une **identit√© g√©r√©e automatiquement** dans Azure Active Directory pour que les applications l'utilisent lorsqu'elles se **connectent** √† des **ressources** qui prennent en charge l'authentification Azure Active Directory (**Azure AD**). Les applications peuvent utiliser des identit√©s g√©r√©es pour **obtenir des jetons Azure AD sans avoir √† g√©rer des
### R√¥les int√©gr√©s

[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) dispose de plusieurs **r√¥les int√©gr√©s Azure** que vous pouvez **attribuer** √† des **utilisateurs, des groupes, des principaux de service et des identit√©s g√©r√©es**. Les attributions de r√¥le sont la mani√®re dont vous contr√¥lez **l'acc√®s aux ressources Azure**. Si les r√¥les int√©gr√©s ne r√©pondent pas aux besoins sp√©cifiques de votre organisation, vous pouvez cr√©er vos propres [**r√¥les personnalis√©s Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Les r√¥les **int√©gr√©s** s'appliquent uniquement aux **ressources** pour lesquelles ils sont **destin√©s**, par exemple, voici deux exemples de **r√¥les int√©gr√©s sur les ressources Compute** :

| [Lecteur de sauvegarde de disque](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Fournit l'autorisation de sauvegarde de disque √† effectuer par le coffre de sauvegarde.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Utilisateur de connexion de machine virtuelle](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Afficher les machines virtuelles dans le portail et se connecter en tant qu'utilisateur r√©gulier. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Ces r√¥les peuvent √©galement √™tre attribu√©s √† des **conteneurs logiques** (tels que des groupes de gestion, des abonnements et des groupes de ressources) et les principaux affect√©s les auront **sur les ressources √† l'int√©rieur de ces conteneurs**.

* Trouvez ici une liste de [**tous les r√¥les int√©gr√©s Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Trouvez ici une liste de [**tous les r√¥les int√©gr√©s Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### R√¥les personnalis√©s

Azure permet √©galement de cr√©er des [**r√¥les personnalis√©s**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) avec les autorisations dont l'utilisateur a besoin.

### Autorisation refus√©e

* Pour qu'un **principal ait un certain acc√®s sur une ressource**, il a besoin d'un r√¥le explicite qui lui est accord√© (de toute fa√ßon) **lui accordant cette autorisation**.
* Une **affectation de r√¥le de refus explicite a la priorit√©** sur le r√¥le accordant l'autorisation.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Administrateur global

Les utilisateurs ayant le r√¥le d'administrateur global ont la possibilit√© de '**√©lever' le r√¥le d'administrateur d'acc√®s utilisateur Azure au groupe de gestion racine**. Cela signifie qu'un administrateur global pourra g√©rer l'acc√®s √† **tous les abonnements et groupes de gestion Azure**.\
\*\*\*\*Cette √©l√©vation peut √™tre effectu√©e en bas de la page : [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (contr√¥le d'acc√®s bas√© sur les r√¥les) est ce que nous avons d√©j√† vu dans les sections pr√©c√©dentes : **Attribution d'un r√¥le √† un principal pour lui accorder l'acc√®s** √† une ressource.\
Cependant, dans certains cas, vous voudrez peut-√™tre fournir une **gestion d'acc√®s plus fine** ou **simplifier** la gestion de **centaines** d'attributions de r√¥le.

Azure **ABAC** (contr√¥le d'acc√®s bas√© sur les attributs) s'appuie sur Azure RBAC en ajoutant des **conditions d'attribution de r√¥le bas√©es sur des attributs** dans le contexte d'actions sp√©cifiques. Une _condition d'attribution de r√¥le_ est une **v√©rification suppl√©mentaire que vous pouvez √©ventuellement ajouter √† votre attribution de r√¥le** pour fournir un contr√¥le d'acc√®s plus fin. Une condition filtre les autorisations accord√©es dans le cadre de la d√©finition de r√¥le et de l'attribution de r√¥le. Par exemple, vous pouvez **ajouter une condition qui exige qu'un objet ait une √©tiquette sp√©cifique pour lire l'objet**.\
Vous **ne pouvez pas** refuser **explicitement** l'acc√®s √† des ressources sp√©cifiques **en utilisant des conditions**.

### Autorisations utilisateur par d√©faut

Un utilisateur de base aura certaines **autorisations par d√©faut** pour √©num√©rer certaines parties d'AzureAD :

* Lire tous les utilisateurs, groupes, applications, appareils, r√¥les, abonnements et leurs propri√©t√©s publiques
* Inviter des invit√©s (_peut √™tre d√©sactiv√©_)
* Cr√©er des groupes de s√©curit√©
* Lire les adh√©sions de groupe non masqu√©es
* Ajouter des invit√©s aux groupes poss√©d√©s
* Cr√©er une nouvelle application (_peut √™tre d√©sactiv√©_)
* Ajouter jusqu'√† 50 appareils √† Azure (_peut √™tre d√©sactiv√©_)

Vous pouvez voir la [liste compl√®te des **autorisations par d√©faut des utilisateurs** dans la documentation](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). De plus, notez que dans cette liste, vous pouvez √©galement voir la liste des **autorisations par d√©faut des invit√©s**.

{% hint style="info" %}
N'oubliez pas que pour √©num√©rer les ressources Azure, l'utilisateur a besoin d'une autorisation explicite accord√©e.
{% endhint %}

## Jetons d'authentification

Il existe **trois types de jetons** utilis√©s dans OIDC :

* \*\*\*\*[**Jetons d'acc√®s**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Le client pr√©sente ce jeton au serveur de ressources pour **acc√©