# Az - Informaci√≥n B√°sica

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Jerarqu√≠a de Organizaci√≥n

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Grupos de Administraci√≥n

Si tu organizaci√≥n tiene **muchas suscripciones de Azure**, es posible que necesites una forma de **administrar eficientemente el acceso**, las pol√≠ticas y el cumplimiento de esas **suscripciones**. Los **grupos de administraci√≥n** proporcionan un **√°mbito de gobierno por encima de las suscripciones**.

Ten en cuenta que se pueden admitir **10.000 grupos de administraci√≥n** en un solo directorio y un √°rbol de grupos de administraci√≥n puede admitir **hasta seis niveles de profundidad**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

A cada directorio se le asigna un **grupo de administraci√≥n de nivel superior llamado ra√≠z**. El grupo de administraci√≥n ra√≠z est√° integrado en la jerarqu√≠a para que **todos los grupos de administraci√≥n y suscripciones se plieguen en √©l**. Este grupo de administraci√≥n ra√≠z permite que se apliquen **pol√≠ticas globales y asignaciones de roles de Azure** a nivel de directorio. El [**Administrador Global de Azure AD debe elevarse**](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) al **rol de Administrador de Acceso de Usuario de este grupo ra√≠z** inicialmente. Despu√©s de elevar el acceso, el administrador puede **asignar cualquier rol de Azure a otros usuarios o grupos del directorio para administrar la jerarqu√≠a**. Como administrador, puedes asignar **tu propia cuenta como propietario de la ra√≠z** del grupo de administraci√≥n.

El grupo de administraci√≥n ra√≠z **no se puede mover ni eliminar**, a diferencia de otros grupos de administraci√≥n.

Los grupos de administraci√≥n te brindan una administraci√≥n de nivel empresarial a escala, sin importar qu√© tipo de suscripciones puedas tener. Sin embargo, **todas las suscripciones dentro de un solo grupo de administraci√≥n** deben confiar en el **mismo inquilino de Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Suscripciones de Azure

Una suscripci√≥n de Azure es un **contenedor l√≥gico** utilizado para **aprovisionar recursos empresariales o t√©cnicos relacionados en Azure**. Contiene los **detalles de todos tus recursos** como m√°quinas virtuales (VM), bases de datos y m√°s. Cuando creas un recurso de Azure como una VM, identificas la **suscripci√≥n a la que pertenece**. Te permite delegar el acceso a trav√©s de mecanismos de control de acceso basados en roles.

### Grupos de Recursos

Un grupo de recursos es un **contenedor** que contiene **recursos relacionados** para una soluci√≥n de Azure. El grupo de recursos puede incluir todos los recursos para la soluci√≥n o solo aquellos **recursos que deseas administrar como grupo**. Por lo general, agrega **recursos** que comparten el **mismo ciclo de vida** al mismo grupo de recursos para que puedas implementarlos, actualizarlos y eliminarlos f√°cilmente como grupo.

Todos los **recursos** deben estar **dentro de un grupo de recursos** y solo pueden pertenecer a un grupo y si se elimina un grupo de recursos, tambi√©n se eliminan todos los recursos que contiene.

### Unidades Administrativas

Las unidades administrativas te permiten **subdividir** tu organizaci√≥n en **cualquier unidad** que desees y luego **asignar administradores espec√≠ficos** que puedan **administrar solo los miembros** de esa unidad. Por ejemplo, podr√≠as usar unidades administrativas para delegar permisos a los administradores de cada escuela en una gran universidad, para que puedan controlar el acceso, administrar usuarios y establecer pol√≠ticas solo en la Escuela de Ingenier√≠a.

Solo los **usuarios**, **grupos** y **dispositivos** pueden ser **miembros** de una **unidad administrativa**.

Por lo tanto, una **unidad administrativa** contendr√° algunos **miembros** y otros **principales** se les asignar√°n permisos sobre esa **unidad administrativa** que pueden usar para **administrar los miembros** de la unidad administrativa.

## Azure vs Azure AD vs Azure AD Domain Services

Es importante tener en cuenta que **Azure AD** es un servicio **dentro de** **Azure**. **Azure** es la **plataforma en la nube** de Microsoft, mientras que **Azure AD** es un **servicio de identidad empresarial** en Azure.\
Adem√°s, **Azure AD no es como Windows Active Directory**, es un servicio de identidad que funciona de una manera completamente diferente. Si deseas ejecutar un **Controlador de Dominio en Azure** para tu entorno de Windows Active Directory, debes usar **Azure AD Domain Services**.

## Principales

Azure admite diferentes tipos de principales:

* **Usuario**: una **persona** regular con credenciales para acceder.
* **Grupo**: un **grupo de principales** administrados juntos. Los **permisos** otorgados a los grupos son **heredados** por sus **miembros**.
* **Service Principal**: es una **identidad** creada para **usar** con **aplicaciones**, servicios alojados y herramientas automatizadas para acceder a recursos de Azure. Este acceso est√° **restringido por los roles asignados**, lo que te brinda control sobre **a qu√© recursos se puede acceder** y en qu√© nivel. Por razones de seguridad, siempre se recomienda **usar Service Principal con herramientas automatizadas** en lugar de permitirles iniciar sesi√≥n con una identidad de usuario.

  Al crear un **Service Principal**, puedes elegir entre **autenticaci√≥n de contrase√±a** o **autenticaci√≥n de certificado**.

  * Si eliges la autenticaci√≥n de **contrase√±a** (por defecto), **guarda la contrase√±a generada** ya que no podr√°s acceder a ella de nuevo.
  * Si eliges la autenticaci√≥n de certificado, aseg√∫rate de que la **aplicaci√≥n tendr√° acceso sobre la clave privada**.
* **Identidad Administrada**: las identidades administradas proporcionan una **identidad administrada autom√°ticamente** en Azure Active Directory para que las aplicaciones la usen al **conectar** a **recursos** que admiten la autenticaci√≥n de Azure Active Directory (**Azure AD**). Las aplicaciones pueden usar identidades administradas para **obtener tokens de Azure AD sin tener que administrar ninguna credencial**.\
Hay dos tipos de identidades administradas:
  * **Asignada por el sistema**. Algunos servicios de Azure te permiten **habilitar una identidad administrada directamente en una instancia de servicio**. Cuando habilitas una identidad administrada asignada por el sistema, se crea una identidad en Azure AD. La identidad est√° vinculada al **ciclo de vida de esa instancia de servicio**. Cuando se **elimina el recurso**, Azure **elimina autom√°ticamente la identidad** por ti. Por dise√±o, solo ese recurso de Azure puede usar esta identidad para solicitar tokens de Azure AD.
  * **Asignada por el usuario**. Tambi√©n puedes crear una identidad administrada como un recurso independiente de Azure. Puedes [crear una identidad administrada asignada por el usuario](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) y asignarla a una o **m√°s instancias** de un servicio de Azure (m√∫ltiples recursos). Para las identidades administradas asignadas por el usuario, la **identidad se administra por separado de los recursos que la usan**.
## Roles y permisos

Los **roles** se **asignan** a **principales** en un **√°mbito**: `principal -[HAS ROLE]->(scope)`

Los **roles** asignados a **grupos** son **heredados** por todos los **miembros** del grupo.

Dependiendo del √°mbito al que se asign√≥ el rol, el **rol** podr√≠a ser **heredado** a **otros recursos** dentro del contenedor de √°mbito. Por ejemplo, si un usuario A tiene un **rol en la suscripci√≥n**, tendr√° ese **rol en todos los grupos de recursos** dentro de la suscripci√≥n y en **todos los recursos** dentro del grupo de recursos.

### **Roles cl√°sicos**

| **Propietario**               | <ul><li>Acceso completo a todos los recursos</li><li>Puede administrar el acceso para otros usuarios</li></ul> | Todos los tipos de recursos |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Colaborador**               | <ul><li>Acceso completo a todos los recursos</li><li>No puede administrar el acceso</li></ul>              | Todos los tipos de recursos |
| **Lector**                    | ‚Ä¢ Ver todos los recursos                                                                     | Todos los tipos de recursos |
| **Administrador de acceso de usuario** | <ul><li>Ver todos los recursos</li><li>Puede administrar el acceso para otros usuarios</li></ul>           | Todos los tipos de recursos |

### Roles integrados

[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) tiene varios **roles integrados de Azure** que se pueden **asignar** a **usuarios, grupos, identidades de servicio y identidades administradas**. Las asignaciones de roles son la forma en que se controla el **acceso a los recursos de Azure**. Si los roles integrados no satisfacen las necesidades espec√≠ficas de su organizaci√≥n, puede crear sus propios [**roles personalizados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

Los roles **integrados** se aplican solo a los **recursos** para los que est√°n **destinados**, por ejemplo, consulte estos 2 ejemplos de roles **integrados sobre recursos de Compute**:

| [Lector de copia de seguridad de disco](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Proporciona permiso para que el almac√©n de copia de seguridad realice una copia de seguridad del disco.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Inicio de sesi√≥n de usuario de m√°quina virtual](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Ver m√°quinas virtuales en el portal e iniciar sesi√≥n como usuario regular. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Estos roles tambi√©n se pueden asignar a **contenedores l√≥gicos** (como grupos de administraci√≥n, suscripciones y grupos de recursos) y los principales afectados los tendr√°n **sobre los recursos dentro de esos contenedores**.

* Encuentre aqu√≠ una lista con [**todos los roles integrados de Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Encuentre aqu√≠ una lista con [**todos los roles integrados de Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Roles personalizados

Azure tambi√©n permite crear [**roles personalizados**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) con los permisos que necesita el usuario.

### Permiso denegado

* Para que un **principal tenga acceso a un recurso**, necesita una asignaci√≥n de rol expl√≠cita que le otorgue ese permiso.
* Una asignaci√≥n de **rol de denegaci√≥n expl√≠cita tiene prioridad** sobre el rol que otorga el permiso.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Administrador global

Los usuarios con el rol de Administrador global tienen la capacidad de '**elevarse' al rol de Administrador de acceso de usuario de Azure hasta el grupo de administraci√≥n ra√≠z**. Esto significa que un Administrador global podr√° administrar el acceso a **todas las suscripciones y grupos de administraci√≥n de Azure.**\
\*\*\*\*Esta elevaci√≥n se puede hacer al final de la p√°gina: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (control de acceso basado en roles) es lo que hemos visto en las secciones anteriores: **Asignar un rol a un principal para otorgarle acceso** a un recurso.\
Sin embargo, en algunos casos, es posible que desee proporcionar una gesti√≥n de acceso m√°s **detallada** o **simplificar** la gesti√≥n de **cientos** de **asignaciones de roles**.

Azure **ABAC** (control de acceso basado en atributos) se basa en Azure RBAC al agregar **condiciones de asignaci√≥n de roles basadas en atributos** en el contexto de acciones espec√≠ficas. Una _condici√≥n de asignaci√≥n de roles_ es una **verificaci√≥n adicional que puede agregar opcionalmente a su asignaci√≥n de roles** para proporcionar un control de acceso m√°s detallado. Una condici√≥n filtra los permisos concedidos como parte de la definici√≥n de roles y la asignaci√≥n de roles. Por ejemplo, puede **agregar una condici√≥n que requiera que un objeto tenga una etiqueta espec√≠fica para leer el objeto**.\
No se puede **denegar expl√≠citamente** el **acceso** a recursos espec√≠ficos **usando condiciones**.

### Permisos de usuario predeterminados

Un usuario b√°sico tendr√° algunos **permisos predeterminados** para enumerar algunas partes de AzureAD:

* Leer todos los usuarios, grupos, aplicaciones, dispositivos, roles, suscripciones y sus propiedades p√∫blicas
* Invitar a invitados (_se puede desactivar_)
* Crear grupos de seguridad
* Leer las membres√≠as de grupo no ocultas
* Agregar invitados a grupos de propiedad
* Crear nueva aplicaci√≥n (_se puede desactivar_)
* Agregar hasta 50 dispositivos a Azure (_se puede desactivar_)

Puede ver la lista completa de [**permisos predeterminados de los usuarios** en la documentaci√≥n](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Adem√°s, tenga en cuenta que en esa lista tambi√©n puede ver la lista de **permisos predeterminados de los invitados**.

{% hint style="info" %}
Recuerde que para enumerar los recursos de Azure, el usuario necesita una concesi√≥n expl√≠cita del permiso.
{% endhint %}

## Tokens de autenticaci√≥n

Hay **tres tipos de tokens** utilizados en OIDC:

* \*\*\*\*[**Tokens de acceso**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** El cliente presenta este token al servidor de recursos para **acceder a los recursos**. Solo se puede usar para una combinaci√≥n espec√≠fica de usuario, cliente y recurso y **no se puede revocar** hasta que expire, que es 1 hora de forma predeterminada. La detecci√≥n es baja usando esto.
* **Tokens de ID**: El cliente recibe este **token del servidor de autorizaci√≥n**. Contiene informaci√≥n b√°sica sobre el usuario. Est√° **vinculado a una combinaci√≥n espec√≠fica de usuario y cliente**.
* **Tokens de actualizaci√≥n**: Proporcionado al cliente con el token de acceso. Se utiliza para **
## Referencias

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a **tu empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>