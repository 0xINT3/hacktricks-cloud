# Az - Podstawowe informacje

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Hierarchia organizacji

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Grupy zarządzające

Jeśli Twoja organizacja ma **wiele subskrypcji Azure**, możesz potrzebować sposobu na efektywne **zarządzanie dostępem**, politykami i zgodnością dla tych **subskrypcji**. **Grupy zarządzające** zapewniają **zakres zarządzania powyżej subskrypcji**.

Należy zauważyć, że w pojedynczym katalogu można obsłużyć **10 000 grup zarządzających**, a drzewo grup zarządzających może obsługiwać **do sześciu poziomów głębokości**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

[Z dokumentacji](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): Każdemu katalogowi przypisana jest pojedyncza **grupa zarządzająca najwyższego poziomu, zwana grupą główną**. Grupa główna jest wbudowana w hierarchię, aby **wszystkie grupy zarządzające i subskrypcje złożyły się w niej**. Ta grupa główna umożliwia zastosowanie **globalnych polityk i przypisań ról Azure AD** na poziomie katalogu. [Azure AD **Globalny Administrator** musi podnieść swoje uprawnienia](https://learn.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin) do roli **Administrator dostępu użytkownika tej grupy głównej** początkowo. Po podniesieniu uprawnień administrator może **przypisać dowolną rolę Azure innym użytkownikom lub grupom katalogowym w celu zarządzania hierarchią**. Jako administrator możesz przypisać **własne konto jako właściciela** grupy głównej.

Grupa główna **nie może być przeniesiona ani usunięta**, w przeciwieństwie do innych grup zarządzających.

Grupy zarządzające zapewniają zarządzanie na poziomie przedsiębiorstwa, niezależnie od rodzaju subskrypcji, jakie możesz mieć. Jednak **wszystkie subskrypcje w ramach jednej grupy zarządzającej** muszą ufać **temu samemu Azure Active Directory (Azure AD)**.

<figure><img src="../../.gitbook/assets/image (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Subskrypcje Azure

W Azure subskrypcja służy jako **kontener logiczny** do celów **udostępniania** zasobów biznesowych lub technicznych. Ten kontener przechowuje **szczegóły zasobów**, takich jak wirtualne maszyny (VM), bazy danych i inne. Przy tworzeniu zasobu Azure, takiego jak VM, określa się **powiązaną z nim subskrypcję**. Ta struktura ułatwia delegowanie dostępu, wykorzystując mechanizmy kontroli dostępu oparte na rolach.

### Grupy zasobów

[Z dokumentacji:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) Grupa zasobów to **kontener**, który przechowuje **powiązane zasoby** dla rozwiązania Azure. Grupa zasobów może zawierać wszystkie zasoby dla rozwiązania lub tylko te **zasoby, które chcesz zarządzać jako grupę**. Ogólnie rzecz biorąc, dodawaj **zasoby**, które mają **ten sam cykl życia**, do tej samej grupy zasobów, aby można je było łatwo wdrażać, aktualizować i usuwać jako grupę.

Wszystkie **zasoby** muszą być **wewnątrz grupy zasobów** i mogą należeć tylko do jednej grupy, a jeśli grupa zasobów zostanie usunięta, wszystkie zasoby w niej również zostaną usunięte.

### Jednostki administracyjne

[Z dokumentacji:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) Jednostki administracyjne pozwalają na **podział** organizacji na **dowolne jednostki**, a następnie **przypisanie określonym administratorom**, którzy mogą **zarządzać tylko członkami** tej jednostki. Na przykład można użyć jednostek administracyjnych do delegowania uprawnień do administratorów każdej szkoły na dużej uczelni, aby mogli kontrolować dostęp, zarządzać użytkownikami i ustawiać polityki tylko w Wydziale Inżynierii.

Tylko **użytkownicy**, **grupy** i **urządzenia** mogą być **członkami** jednostki **administracyjnej**.

Dlatego **jednostka administracyjna** będzie **zawierać** pewne **członków**, a inni **podmioty** zostaną **przypisane uprawnienia** do tej **jednostki administracyjnej**, które mogą wykorzystać do **zarządzania członkami** jednostki administracyjnej.

## Azure vs Azure AD vs Azure AD Domain Services

Warto zauważyć, że **Azure AD** to usługa **wewnątrz** **Azure**. **Azure** to platforma chmurowa firmy Microsoft, podczas gdy **Azure AD** to usługa **tożsamościowa dla przedsiębiorstw** w Azure.\
Ponadto, **Azure AD nie jest tak jak Windows Active Directory**, to usługa tożsamościowa, która działa w zupełnie inny sposób. Jeśli chcesz uruchomić **kontroler domeny w Azure** dla swojego środowiska Windows Active Directory, musisz użyć **Azure AD Domain Services**.

## Podmioty

Azure obsługuje różne rodzaje podmiotów:

* **Użytkownik**: Zwykła **osoba** z danymi uwierzytelniającymi do dostępu.
* **Grupa**: **Grupa podmiotów** zarządzana razem. **Uprawnienia** przyznane grupom są **dziedziczone** przez jej **członków**.
* **Podmiot usługi/Aplikacje przedsiębiorstwowe**: Jest to **tożsamość** utworzona do **używania** z **aplikacjami**, usługami hostowanymi i narzędziami automatycznymi do dostępu do zasobów Azure. Ten dostęp jest **ograniczony przez przypisane role** do podmiotu usługi, dając
## Role i uprawnienia

**Role** są **przypisywane** do **podmiotów** na **zakresie**: `podmiot -[MA ROLĘ]->(zakres)`

**Role** przypisane do **grup** są **dziedziczone** przez wszystkich **członków** grupy.

W zależności od zakresu, do którego przypisano rolę, rola może być dziedziczona przez **inne zasoby** wewnątrz kontenera zakresu. Na przykład, jeśli użytkownik A ma **rolę w subskrypcji**, będzie miał tę **rolę we wszystkich grupach zasobów** wewnątrz subskrypcji i we **wszystkich zasobach** w grupie zasobów.

### **Klasyczne role**

| **Właściciel**                | <ul><li>Pełny dostęp do wszystkich zasobów</li><li>Może zarządzać dostępem dla innych użytkowników</li></ul> | Wszystkie typy zasobów |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Współpracownik**            | <ul><li>Pełny dostęp do wszystkich zasobów</li><li>Nie może zarządzać dostępem</li></ul>              | Wszystkie typy zasobów |
| **Czytelnik**                 | • Wyświetlanie wszystkich zasobów                                                                     | Wszystkie typy zasobów |
| **Administrator dostępu użytkownika** | <ul><li>Wyświetlanie wszystkich zasobów</li><li>Może zarządzać dostępem dla innych użytkowników</li></ul>           | Wszystkie typy zasobów |

### Wbudowane role

[Z dokumentacji: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) ma kilka wbudowanych ról Azure, które można przypisać do użytkowników, grup, podmiotów usługowych i zarządzanych tożsamości. Przypisania ról są sposobem kontrolowania **dostępu do zasobów Azure**. Jeśli wbudowane role nie spełniają konkretnych potrzeb Twojej organizacji, możesz utworzyć [**własne role Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Wbudowane** role dotyczą tylko **zasobów**, dla których są **przeznaczone**, na przykład sprawdź te 2 przykłady **wbudowanych ról dla zasobów obliczeniowych**:

| [Czytelnik kopii zapasowej dysku](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Udziela uprawnień do kopii zapasowej dysku.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Użytkownik logowania wirtualnej maszyny](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | Wyświetlanie maszyn wirtualnych w portalu i logowanie jako zwykły użytkownik. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

Te role mogą być również przypisywane do kontenerów logicznych (takich jak grupy zarządzania, subskrypcje i grupy zasobów), a dotknięte podmioty będą miały je **dla zasobów wewnątrz tych kontenerów**.

* Znajdź tutaj listę [**wszystkich wbudowanych ról Azure**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Znajdź tutaj listę [**wszystkich wbudowanych ról Azure AD**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Własne role

Azure umożliwia również tworzenie [**własnych ról**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) z potrzebnymi uprawnieniami użytkownika.

### Odmowa dostępu

* Aby **podmiot miał dostęp do zasobu**, musi mieć przypisaną mu rolę (w dowolny sposób) **udzielającą mu tego uprawnienia**.
* Wyraźne **przypisanie roli odmowy ma pierwszeństwo** nad rolą udzielającą uprawnienia.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Globalny administrator

Użytkownicy z rolą Globalny administrator mają możliwość '**podniesienia' do roli Administrator dostępu użytkownika Azure** w głównej grupie zarządzania. Oznacza to, że Globalny administrator będzie mógł zarządzać dostępem **do wszystkich subskrypcji i grup zarządzania Azure.**\
Podniesienie to można wykonać na końcu strony: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Zasady Azure

Zasady Azure to zestaw **reguł i przepisów w usłudze Microsoft Azure**, usłudze obliczeniowej w chmurze, które pomagają zarządzać i egzekwować standardy organizacyjne oraz oceniać zgodność na dużą skalę. Te zasady narzucają różne reguły na Twoje **zasoby Azure**, zapewniając, że te zasoby pozostają zgodne z korporacyjnymi standardami i umowami o poziomie usług.

Zasady Azure są kluczowe dla zarządzania chmurą i bezpieczeństwa, pomagając zapewnić, że zasoby są używane prawidłowo i efektywnie, oraz że są zgodne z zewnętrznymi przepisami i wewnętrznymi politykami.\
Przykłady:

1. **Zapewnienie zgodności z określonymi regionami Azure**: Ta zasada zapewnia, że wszystkie zasoby są wdrażane w określonych regionach Azure. Na przykład firma może chcieć zapewnić, że wszystkie jej dane są przechowywane w Europie zgodnie z przepisami GDPR.
2. **Wymuszanie standardów nazewnictwa**: Zasady mogą wymuszać konwencje nazewnicze dla zasobów Azure. Pomaga to w organizacji i łatwym identyfikowaniu zasobów na podstawie ich nazw, co jest przydatne w dużych środowiskach.
3. **Ograniczanie pewnych typów zasobów**: Ta zasada może ograniczać tworzenie pewnych typów zasobów. Na przykład można ustawić zasadę uniemożliwiającą tworzenie drogich typów zasobów, takich jak niektóre rozmiary maszyn wirtualnych, w celu kontroli kosztów.
4. **Wymuszanie polityk tagowania**: Tagi to pary klucz-wartość przypisane do zasobów Azure, używane do zarządzania zasobami. Zasady mogą wymuszać obecność określonych tagów lub określonych wartości dla wszystkich zasobów. Jest to przydatne do śledzenia kosztów, właściciela lub kategoryzacji zasobów.
5. **Ograniczanie publicznego dostępu do zasobów**: Zasady mogą wymuszać, aby pewne zasoby, takie jak konta magazynowe lub bazy danych, nie miały publicznych punktów końcowych, zapewniając, że są one dostępne tylko w ramach sieci organizacji.
6. **Automatyczne stosowanie ustawień zabezpieczeń**: Zasady mogą być używane do automatycznego stosowania ustawień zabezpieczeń dla zasobów, takich jak przypisanie określonej grupy zabezpieczeń sieciowych do wszystkich maszyn wirtualnych lub zapewnienie, że wszystkie konta magazynowe używają szyfrowania.

Należy zauważyć, że zasady Azure można przypisać do dowolnego poziomu hierarchii Azure, ale są **najczęściej używane w głównej grupie zarządzania** lub innych grupach zarządzania.

### Zakres uprawnień

W
### Domyślne uprawnienia użytkownika

Podstawowy użytkownik będzie miał pewne **domyślne uprawnienia** do wyliczenia niektórych części AzureAD:

* Odczyt wszystkich użytkowników, grup, aplikacji, urządzeń, ról, subskrypcji i ich publicznych właściwości
* Zapraszanie gości (_może zostać wyłączone_)
* Tworzenie grup zabezpieczeń
* Odczyt nieukrytych przynależności do grup
* Dodawanie gości do grup własnych
* Tworzenie nowej aplikacji (_może zostać wyłączone_)
* Dodawanie do 50 urządzeń do Azure (_może zostać wyłączone_)

Możesz zobaczyć pełną [listę **domyślnych uprawnień użytkowników** w dokumentacji](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Ponadto, zauważ, że na tej liście można również zobaczyć **listę domyślnych uprawnień gości**.

{% hint style="info" %}
Pamiętaj, że do wyliczenia zasobów Azure użytkownik potrzebuje wyraźnego przyznania uprawnienia.
{% endhint %}

### Zarządzanie tożsamością uprzywilejowaną (PIM)

Zarządzanie tożsamością uprzywilejowaną (PIM) w Azure to narzędzie, które **zarządza, kontroluje i monitoruje uprzywilejowany dostęp** w Azure Active Directory i Azure. Zwiększa bezpieczeństwo, zapewniając dostęp uprzywilejowany **w trybie natychmiastowym i ograniczonym czasowo**, **wymuszając przepływy zatwierdzania i wymagając dodatkowej autoryzacji**. Ta metoda minimalizuje ryzyko nieautoryzowanego dostępu, zapewniając, że podwyższone uprawnienia są udzielane tylko wtedy, gdy są potrzebne i na określony czas.

## Tokeny uwierzytelniające

W OIDC używane są **trzy rodzaje tokenów**:

* [**Tokeny dostępu**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** Klient przedstawia ten token serwerowi zasobów, aby **uzyskać dostęp do zasobów**. Może być używany tylko dla określonej kombinacji użytkownika, klienta i zasobu i **nie może zostać wycofany** do momentu wygaśnięcia - domyślnie jest to 1 godzina. Wykrywalność jest niska przy użyciu tego tokena.
* **Tokeny ID**: Klient otrzymuje ten **token od serwera autoryzacji**. Zawiera podstawowe informacje o użytkowniku. Jest **powiązany z określoną kombinacją użytkownika i klienta**.
* **Tokeny odświeżania**: Udostępniane klientowi wraz z tokenem dostępu. Służą do **uzyskiwania nowych tokenów dostępu i ID**. Są powiązane z określoną kombinacją użytkownika i klienta i mogą zostać wycofane. Domyślny czas wygaśnięcia wynosi **90 dni** dla nieaktywnych tokenów odświeżania i **brak wygaśnięcia dla aktywnych tokenów**.

{% hint style="warning" %}
Informacje dotyczące **dostępu warunkowego** są **przechowywane** wewnątrz **JWT**. Jeśli więc żądasz **tokena z dozwolonego adresu IP**, to **IP** to będzie **przechowywane** w tokenie, a następnie możesz użyć tego tokenu z **nieautoryzowanego adresu IP, aby uzyskać dostęp do zasobów**.
{% endhint %}

Sprawdź następującą stronę, aby dowiedzieć się, jak różnymi sposobami **żądać tokenów dostępu** i zalogować się za ich pomocą:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

Najczęściej używane punkty końcowe API to:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph, który jest przestarzały, to graph.windows.net)

## Odwołania

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
