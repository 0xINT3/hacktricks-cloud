# Az - Key Vault

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

## Temel Bilgiler

[Dokümantasyondan:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault, **güvenli bir şekilde saklama ve erişim sağlamak için** bir bulut hizmetidir. Bir sır, API anahtarları, şifreler, sertifikalar veya kriptografik anahtarlar gibi **erişimi sıkı bir şekilde kontrol etmek istediğiniz her şeydir**. Key Vault hizmeti, iki tür konteyneri destekler: kasa ve yönetilen donanım güvenlik modülü (HSM) havuzları. Kasalar, yazılım ve HSM destekli anahtarları, sırları ve sertifikaları saklamayı destekler. Yönetilen HSM havuzları yalnızca HSM destekli anahtarları destekler. Tam ayrıntılar için [Azure Key Vault REST API genel bakışına](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) bakın.

**URL formatı** şu şekildedir: `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` Burada:

* `vault-name`, anahtar kasasının küresel olarak **benzersiz** adıdır
* `object-type`, "keys", "secrets" veya "certificates" olabilir
* `object-name`, anahtar kasası içindeki nesnenin **benzersiz** adıdır
* `object-version`, sistem tarafından oluşturulan ve isteğe bağlı olarak bir nesnenin **benzersiz bir sürümünü** belirtmek için kullanılır.

Anahtar kasasında saklanan sırlara erişmek için 2 izin modeli kullanılabilir:

* **Kasa erişim politikası**
* **Azure RBAC**

### Erişim Kontrolü <a href="#access-control" id="access-control"></a>

Bir Anahtar Kasası kaynağına erişim, iki düzlem tarafından kontrol edilir:

* **Yönetim düzlemi**, hedefi [management.azure.com](http://management.azure.com/) olan bir düzlemdir.&#x20;
* Anahtar kasasını ve **erişim politikalarını yönetmek** için kullanılır. Yalnızca Azure rol tabanlı erişim kontrolü (**RBAC**) desteklenir.
* **Veri düzlemi**, hedefi **`<vault-name>.vault.azure.com`** olan bir düzlemdir.&#x20;
* Anahtar kasasındaki **verileri** (anahtarlar, sırlar ve sertifikalar) **yönetmek ve erişmek** için kullanılır. Bu, **anahtar kasası erişim politikalarını** veya Azure **RBAC**'ı destekler.

Yönetim düzleminde erişim politikalarını yönetmek için izinlere sahip olan **Contributor** gibi bir rol, erişim politikalarını değiştirerek sırlara erişebilir.

### Anahtar Kasası RBAC Yerleşik Roller <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Ağ Erişimi

Azure Key Vault'ta, **güvenlik duvarı** kuralları **belirli sanal ağlardan veya IPv4 adres aralıklarından yalnızca veri düzlemi işlemlerine izin vermek** için ayarlanabilir. Bu kısıtlama, Azure yönetim portalı üzerinden erişimi de etkiler; kullanıcılar yetkilendirilmiş aralık içinde olmayan bir giriş IP adresine sahipse anahtar kasasındaki anahtarları, sırları veya sertifikaları listeleyemezler.

Bu ayarları analiz etmek ve yönetmek için **Azure CLI**'yi kullanabilirsiniz:
```bash
az keyvault show --name name-vault --query networkAcls
```
Önceki komut, `name-vault` adlı anahtar deposunun etkin IP aralıklarını ve reddedilen trafiğe yönelik politikalarını içeren f**irewall ayarlarını** görüntüleyecektir.

## Numaralandırma

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> –AsPlainText
```
{% code %}
## Key Vault

Azure Key Vault is a cloud service that provides a secure storage for secrets, keys, and certificates. It allows you to securely store and manage sensitive information such as passwords, API keys, and connection strings.

### Key Vault Security Best Practices

Here are some best practices to ensure the security of your Key Vault:

1. **Access Control**: Implement proper access control to restrict who can manage and access the Key Vault. Use RBAC (Role-Based Access Control) to assign appropriate roles to users and groups.

2. **Network Security**: Configure network security groups (NSGs) to restrict inbound and outbound traffic to the Key Vault. Use virtual network service endpoints to allow access only from specific virtual networks.

3. **Encryption**: Enable encryption at rest for the Key Vault data. Azure Key Vault automatically encrypts the data using Azure Storage Service Encryption (SSE) and Azure Disk Encryption (ADE).

4. **Monitoring and Logging**: Enable diagnostic logs and monitor the Key Vault activities. Use Azure Monitor to track and analyze the logs for any suspicious activities.

5. **Secret Management**: Follow secure coding practices to handle secrets securely. Avoid hardcoding secrets in code and use Key Vault references or environment variables to retrieve secrets at runtime.

6. **Key Rotation**: Regularly rotate the keys and certificates stored in the Key Vault. This helps to mitigate the risk of compromised keys.

7. **Backup and Recovery**: Implement a backup and recovery strategy for the Key Vault. Regularly backup the Key Vault data and test the recovery process to ensure data availability in case of any failures.

### Key Vault Vulnerabilities and Exploits

Here are some common vulnerabilities and exploits related to Key Vault:

1. **Weak Access Controls**: Improperly configured access controls can allow unauthorized users to manage or access the Key Vault. Always follow the principle of least privilege and regularly review and update access control policies.

2. **Insecure Secrets Management**: Storing secrets in an insecure manner, such as hardcoding them in code or configuration files, can lead to their exposure. Always use secure methods like Key Vault references or environment variables to handle secrets.

3. **Misconfigured Network Security**: Improperly configured network security settings can expose the Key Vault to unauthorized access. Ensure that proper network security groups and virtual network service endpoints are configured.

4. **Lack of Monitoring and Logging**: Without proper monitoring and logging, it becomes difficult to detect and respond to any suspicious activities or breaches in the Key Vault. Enable diagnostic logs and regularly review the logs for any anomalies.

5. **Insufficient Key Rotation**: Failure to regularly rotate keys and certificates increases the risk of compromised keys. Implement a key rotation policy and regularly update the keys and certificates stored in the Key Vault.

6. **Lack of Backup and Recovery**: Without a proper backup and recovery strategy, the Key Vault data may be lost in case of any failures or disasters. Regularly backup the Key Vault data and test the recovery process.

By following these best practices and addressing the vulnerabilities, you can enhance the security of your Key Vault and protect your sensitive information from unauthorized access or exposure.
{% endcode %}
{% endtab %}
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

<details>

<summary><strong>AWS hackleme becerilerini sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>
