### Usuários

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerar usuários
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Obter informações de 1 usuário
az ad user show --id "test@corp.onmicrosoft.com"
# Procurar usuários "admin"
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Procurar atributos contendo a palavra "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# Todos os usuários do AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# Todos os usuários sincronizados do local
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Obter grupos em que o usuário é membro
az ad user get-member-groups --id <email>
# Obter funções atribuídas ao usuário
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Enumerar usuários
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Obter informações de 1 usuário
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Procurar usuários "admin"
Get-AzureADUser -SearchString "admin" #Procurar admin no início de DisplayName ou userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Procurar a palavra "admin" em DisplayName
# Obter todos os atributos de um usuário
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Procurar atributos contendo a palavra "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# Todos os usuários do AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# Todos os usuários sincronizados do local
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objetos criados por um/qualquer usuário
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Enumerate Users
Get-AzADUser -All $true
Get-AzADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD
Get-AzADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzADUser [-ObjectId <email>] | Get-AzADUserCreatedObject
```
{% endtab %}

{% tab title="Raw PS" %}
```powershell
# Enumerate Users
$Token = 'eyJ0eXAi..'
$URI = 'https://graph.microsoft.com/v1.0/users'
$RequestParams = @{
  Method  = 'GET'
  Uri     = $URI
  Headers = @{
      'Authorization' = "Bearer $Token"
  }
}
(Invoke-RestMethod @RequestParams).value

# Get info of 1 user
$URI = 'https://graph.microsoft.com/v1.0/users/test@corp.onmicrosoft.com'
$RequestParams = @{
  Method  = 'GET'
  Uri     = $URI
  Headers = @{
      'Authorization' = "Bearer $Token"
  }
}
Invoke-RestMethod @RequestParams

# Search "admin" users
$URI = 'https://graph.microsoft.com/v1.0/users?$search="admin"'
$RequestParams = @{
  Method  = 'GET'
  Uri     = $URI
# Dispositivos de propriedade de um usuário
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objetos de propriedade de um usuário específico
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Obter grupos e funções em que o usuário é membro
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Obter dispositivos de propriedade de um usuário
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Obter dispositivos registrados por um usuário
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Aplicativos em que um usuário tem uma função (função não exibida)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Obter unidades administrativas de um usuário
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }

#### Alterar a senha do usuário

$password = "EstaÉANovaSenha.!123" | ConvertTo- SecureString -AsPlainText –Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password –Verbose

### Grupos

# Enumerar grupos
az ad group list
az ad group list --query "[].[displayName]" -o table
# Obter informações de 1 grupo
az ad group show --group <group>
# Obter grupos "admin"
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# Todos os grupos do AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# Todos os grupos sincronizados do local
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Obter membros do grupo
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Verificar se é membro do grupo
az ad group member check --group "VM Admins" --member-id <id>
# Obter quais grupos um grupo é membro
az ad group get-member-groups -g "VM Admins"
# Obter aplicativos em que um grupo tem uma função (função não exibida)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *

#### Adicionar usuário ao grupo

Os proprietários do grupo podem adicionar novos usuários ao grupo

Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose

### Princípios de serviço

Observe que o **Service Principal** na terminologia do PowerShell é chamado de **Enterprise Applications** no portal Azure (web).

# Obter Princípios de Serviço
Get-AzureADServicePrincipal -All $true
# Obter detalhes sobre um SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Obter SP por nome de string ou Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Obter proprietário do SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Obter objetos de propriedade de um SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Obter objetos criados por um SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Obter grupos em que o SP é membro
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
### Funções

{% tabs %}
{% tab title="az cli" %}
```bash
# Obter funções
az role definition list
# Obter funções atribuídas
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Obter informações de 1 função
az role definition list --name "AzureML Registry User"
# Obter apenas funções personalizadas
az role definition list --custom-role-only
# Obter apenas funções atribuídas ao grupo de recursos indicado
az role definition list --resource-group <resource_group>
# Obter apenas funções atribuídas ao escopo indicado
az role definition list --scope <scope>
# Obter todos os princípios aos quais uma função é atribuída
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Obter todos os modelos de funções disponíveis
Get-AzureADDirectoryroleTemplate
# Obter funções habilitadas (funções atribuídas)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Obter informações sobre a função
# Obter funções personalizadas - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Usuários atribuídos a uma função (Administrador Global)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Funções da Unidade Administrativa (quem tem permissões sobre a unidade administrativa e seus membros)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Obter atribuições de função na assinatura
Get-AzRoleDefinition
# Obter definição de função
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Obter funções de um usuário ou recurso
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Raw" %}
```powershell
# Obter permissões sobre um recurso usando ARM diretamente
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
 Method = 'GET'
 Uri = $URI
 Headers = @{
 'Authorization' = "Bearer $Token"
 }
}
(Invoke-RestMethod @RequestParams).value 
```
{% endtab %}
{% endtabs %}

### Dispositivos

{% tabs %}
{% tab title="az cli" %}
```bash
# Se você souber como fazer isso, envie um PR!
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Enumerar dispositivos
Get-AzureADDevice -All $true | fl *
# Listar todos os dispositivos ativos (e não os dispositivos obsoletos)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Obter proprietários de todos os dispositivos
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Usuários registrados de todos os dispositivos
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Obter dispositivos gerenciados usando Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Obter dispositivos de propriedade de um usuário
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Obter Unidades Administrativas de um dispositivo
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Se um dispositivo (VM) estiver **associado ao AzureAD**, os usuários do AzureAD poderão **fazer login**.\
Além disso, se o usuário conectado for **Proprietário** do dispositivo, ele será **administrador local**.
{% endhint %}

### Aplicativos

{% hint style="info" %}
**Aplicativos** são **Registros de Aplicativos** no portal (não Aplicativos Empresariais).\
Mas cada Registro de Aplicativo criará um **Aplicativo Empresarial** (**Principal de Serviço**) com o mesmo nome.\
Além disso, se o aplicativo for um **aplicativo multilocatário**, **outro** Aplicativo Empresarial (**Principal de Serviço**) será criado no **inquilino** com o mesmo nome.
{% endhint %}

Quando um aplicativo é gerado, são fornecidos 2 tipos de permissões:

* **Permissões** concedidas ao **Principal de Serviço**
* **Permissões** que o **aplicativo** pode ter e usar **em nome do usuário**.

{% tabs %}
{% tab title="az cli" %}
```bash
# Listar aplicativos
az ad app list
az ad app list --query "[].[displayName]" -o table
# Obter informações de 1 aplicativo
az ad app show --id 00000000-0000-0000-0000-000000000000
# Pesquisar aplicativo por string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Obter o proprietário de um aplicativo
az ad app owner list --id <id> --query "[].[displayName]" -o table
# Listar todos os aplicativos com uma senha de aplicativo
az ad app list --query "[?passwordCredentials != null].displayName"
# Listar aplicativos que têm