# Az - AzureAD

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### Enumeración

Para esta enumeración puedes usar la herramienta [**az cli**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli), el módulo de PowerShell [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (o [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) y el módulo [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps).

{% hint style="success" %}
En Linux necesitarás instalar PowerShell Core:

```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Actualizar repositorios
sudo apt-get update
sudo add-apt-repository universe

# Instalar y ejecutar PowerShell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

### **Conexión**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #Esto abrirá el navegador
az login -u <username> -p <password> #Especificar usuario y contraseña
az login --identity #Usar la identidad administrada de la máquina actual
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Iniciar sesión con la identidad administrada por el usuario
# Iniciar sesión como principal de servicio
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #Con contraseña
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #Con certificado

# Solicitar token de acceso (ARM)
az account get-access-token
# Solicitar token de acceso para un recurso diferente. Tokens admitidos: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# Si quieres configurar algunos valores predeterminados
az configure

# Obtener el usuario que ha iniciado sesión
az ad signed-in-user show

# Ayuda
az find "vm" # Buscar comandos de vm
az vm -h # Obtener subdominios
az ad user list --query-examples # Obtener ejemplos
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
Connect-AzureAD #Abrir navegador
# Usando credenciales
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Usando tokens
## AzureAD no puede solicitar tokens, pero puede usar tokens de AADGraph y MSGraph para conectarse
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Abrir navegador
# Usando credenciales
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Obtener token de acceso
(Get-AzAccessToken).Token
# Solicitar token de acceso a otros puntos finales: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conectar con token de acceso
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## El -AccessToken es de management.azure.com

# Conectar con Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
 System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

# Todos los cmdlets de Azure AD tienen el formato *-AzAD*
# Get all Enterprise Apps
$apps = Get-AzureADServicePrincipal -All $true

# Loop through each app and try to add a client secret
foreach ($app in $apps) {
    $appId = $app.AppId
    $displayName = $app.DisplayName
    Write-Host "Checking $displayName ($appId)"
    try {
        $secret = New-AzureADServicePrincipalPasswordCredential -ObjectId $appId -StartDate (Get-Date) -EndDate (Get-Date).AddYears(1) -Value "P@ssw0rd!" -CustomKeyIdentifier "MyCustomKeyIdentifier"
        Write-Host "Added client secret for $displayName ($appId)"
    } catch {
        Write-Host "Failed to add client secret for $displayName ($appId)"
    }
}
```

</details>

### Roles

{% tabs %}
{% tab title="az cli" %}
```bash
# List all roles
az role definition list --name "Contributor"
# Get details of a role
az role definition show --name "Contributor"
# Get all role assignments
az role assignment list
# Get role assignments for a user
az role assignment list --assignee <user_id>
# Get role assignments for a group
az role assignment list --all --query "[?principalType=='Group'].{roleDefinitionName:roleDefinitionName,principalName:principalName}"
# Get role assignments for a service principal
az role assignment list --all --query "[?principalType=='ServicePrincipal'].{roleDefinitionName:roleDefinitionName,principalName:principalName}"
# Get role assignments for a resource group
az role assignment list --all --query "[?scope=='/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/MyResourceGroup'].{roleDefinitionName:roleDefinitionName,principalName:principalName}"
# Get role assignments for a subscription
az role assignment list --all --query "[?scope=='/subscriptions/00000000-0000-0000-0000-000000000000'].{roleDefinitionName:roleDefinitionName,principalName:principalName}"
# Get role assignments for a management group
az role assignment list --all --query "[?scope=='/providers/Microsoft.Management/managementGroups/MyManagementGroup'].{roleDefinitionName:roleDefinitionName,principalName:principalName}"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# List all roles
Get-AzureADDirectoryRole
# Get details of a role
Get-AzureADDirectoryRole -ObjectId <id>
# Get all role assignments
Get-AzureADDirectoryRoleMember -All $true
# Get role assignments for a user
Get-AzureADUser -ObjectId <id> | Get-AzureADUserMembership
# Get role assignments for a group
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupMembership
# Get role assignments for a service principal
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# List all roles
Get-AzRoleDefinition
# Get details of a role
Get-AzRoleDefinition -Name "Contributor"
# Get all role assignments
Get-AzRoleAssignment
# Get role assignments for a user
Get-AzRoleAssignment -SignInName <user_email>
# Get role assignments for a group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name> -IncludeClassicAdministrators | ?{$_.PrincipalType -eq "Group"}
# Get role assignments for a service principal
Get-AzRoleAssignment -ServicePrincipalName <service_principal_name>
# Get role assignments for a resource group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
# Get role assignments for a subscription
Get-AzRoleAssignment -Scope "/subscriptions/<subscription_id>"
# Get role assignments for a management group
Get-AzRoleAssignment -Scope "/providers/Microsoft.Management/managementGroups/<management_group_name>"
```
{% endtab %}
{% endtabs %}

#### Add role assignment

{% tabs %}
{% tab title="az cli" %}
```bash
# Assign a role to a user
az role assignment create --assignee <user_id> --role "Contributor" --scope "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/MyResourceGroup"
# Assign a role to a group
az role assignment create --assignee <group_id> --role "Contributor" --scope "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/MyResourceGroup"
# Assign a role to a service principal
az role assignment create --assignee <service_principal_id> --role "Contributor" --scope "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/MyResourceGroup"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Assign a role to a user
$user = Get-AzureADUser -ObjectId <id>
$role = Get-AzureADDirectoryRole | ?{$_.DisplayName -eq "Contributor"}
Add-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -RefObjectId $user.ObjectId
# Assign a role to a group
$group = Get-AzureADGroup -ObjectId <id>
Add-AzureADGroupMember -ObjectId $group.ObjectId -RefObjectId $user.ObjectId
# Assign a role to a service principal
$sp = Get-AzureADServicePrincipal -ObjectId <id>
Add-AzureADServicePrincipalMember -ObjectId $sp.ObjectId -RefObjectId $user.ObjectId
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Assign a role to a user
$user = Get-AzADUser -UserPrincipalName <user_email>
$role = Get-AzRoleDefinition -Name "Contributor"
New-AzRoleAssignment -SignInName $user.UserPrincipalName -RoleDefinitionName $role.Name -Scope "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>"
# Assign a role to a group
$group = Get-AzADGroup -DisplayName <group_name>
New-AzRoleAssignment -ObjectId $group.Id -RoleDefinitionName $role.Name -Scope "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>"
# Assign a role to a service principal
$sp = Get-AzADServicePrincipal -DisplayName <service_principal_name>
New-AzRoleAssignment -ServicePrincipalName $sp.ApplicationId -RoleDefinitionName $role.Name -Scope "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>"
```
{% endtab %}
{% endtabs %}

#### Remove role assignment

{% tabs %}
{% tab title="az cli" %}
```bash
# Remove a role assignment
az role assignment delete --assignee <user_id> --role "Contributor" --scope "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/MyResourceGroup"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Remove a role assignment
$user = Get-AzureADUser -ObjectId <id>
$role = Get-AzureADDirectoryRole | ?{$_.DisplayName -eq "Contributor"}
Remove-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -MemberId $user.ObjectId
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Remove a role assignment
$user = Get-AzADUser -UserPrincipalName <user_email>
$role = Get-AzRoleDefinition -Name "Contributor"
Remove-AzRoleAssignment -SignInName $user.UserPrincipalName -RoleDefinitionName $role.Name -Scope "/subscriptions/<subscription_id>/resourceGroups/<resource_group_name>"
```
{% endtab %}
{% endtabs %}

### Conditional Access Policies

{% tabs %}
{% tab title="az cli" %}
```
# Simplemente llama a Add-AzADAppSecret
Función Add-AzADAppSecret
{
<#
    .SYNOPSIS
        Agrega un secreto de cliente a las aplicaciones.

    .PARAMETER GraphToken
        Pase el token de Graph API 

    .EXAMPLE
        PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

    .LINK
        https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
        https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

    [CmdletBinding()]
    param(
    [Parameter(Mandatory=$True)]
    [String]
    $GraphToken = $null
    )

    $AppList = $null
    $AppPassword = $null

    # Listar todas las aplicaciones

    $Params = @{
     "URI"     = "https://graph.microsoft.com/v1.0/applications"
     "Method"  = "GET"
     "Headers" = @{
     "Content-Type"  = "application/json"
     "Authorization" = "Bearer $GraphToken"
     }
    }

    try
    { 
        $AppList = Invoke-RestMethod @Params -UseBasicParsing
    }
    catch
    {
    }

    # Agregar contraseña en la aplicación

    if($AppList -ne $null)
    {
        [System.Collections.ArrayList]$Details = @()

        foreach($App in $AppList.value)
        {
            $ID = $App.ID
            $psobj = New-Object PSObject

            $Params = @{
             "URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
             "Method"  = "POST"
             "Headers" = @{
             "Content-Type"  = "application/json"
             "Authorization" = "Bearer $GraphToken"
             }
            }

            $Body = @{
              "passwordCredential"= @{
                "displayName" = "Password"
              }
            }
 
            try
            {
                $AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
                Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
                Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
                Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
                Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
                Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
                $Details.Add($psobj) | Out-Null
            }
            catch
            {
                Write-Output "No se pudo agregar un nuevo secreto de cliente a la aplicación '$($App.displayName)'." 
            }
        }
        if($Details -ne $null)
        {
            Write-Output ""
            Write-Output "Secreto de cliente agregado a: " 
            Write-Output $Details | fl *
        }
    }
    else
    {
       Write-Output "No se pudieron enumerar las aplicaciones."
    }
}
```

</details>

### Roles

{% tabs %}
{% tab title="az cli" %}
```bash
# Obtener roles
az role definition list
# Obtener roles asignados
az role assignment list --all --query "[].roleDefinitionName"
# Obtener información de 1 rol
az role definition list --name "AzureML Registry User"
# Obtener solo roles personalizados
az role definition list --custom-role-only
# Obtener solo roles asignados al grupo de recursos indicado
az role definition list --resource-group <resource_group>
# Obtener solo roles asignados al ámbito indicado
az role definition list --scope <scope>
# Obtener todos los principales a los que se asigna un rol
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Obtener todas las plantillas de roles disponibles
Get-AzureADDirectoryroleTemplate
# Obtener roles habilitados (roles asignados)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Obtener información sobre el rol
# Obtener roles personalizados - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Usuarios asignados a un rol (Administrador global)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Administrador global'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles de la Unidad Administrativa (quién tiene permisos sobre la unidad administrativa y sus miembros)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Obtener asignaciones de roles en la suscripción
Get-AzRoleDefinition
# Obtener definición de rol
Get-AzRoleDefinition -Name "Ejecutor de comandos de máquina virtual"
# Obtener roles de un usuario o recurso
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Raw" %}
```powershell
# Obtener permisos sobre un recurso utilizando ARM directamente
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
 Method = 'GET'
 Uri = $URI
 Headers = @{
 'Authorization' = "Bearer $Token"
 }
}
(Invoke-RestMethod @RequestParams).value 
```
{% endtab %}
{% endtabs %}

### Dispositivos

{% tabs %}
{% tab title="az cli" %}
```bash
# Si sabes cómo hacer esto, ¡envía un PR!
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Enumerar dispositivos
Get-AzureADDevice -All $true | fl *
# Listar todos los dispositivos activos (y no
### Unidades Administrativas

Se utilizan para una mejor gestión de los usuarios.

Las unidades administrativas **restringen los permisos de un rol a cualquier parte de su organización** que usted defina. Por ejemplo, podría utilizar unidades administrativas para delegar el rol de [Administrador de Helpdesk](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) a especialistas de soporte regional, para que puedan administrar usuarios solo en la región que ellos apoyan.

Por lo tanto, puede asignar roles a la unidad administrativa y los miembros de esta tendrán estos roles.

{% tabs %}
{% tab title="az cli" %}
```
```
{% endtab %}

{% tab title="AzureAD" %}
```powershell
# Obtener Unidades Administrativas
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Obtener ID de la unidad administrativa por cadena
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# Listar los usuarios, grupos y dispositivos afectados por la unidad administrativa
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Obtener los roles que los usuarios tienen sobre los miembros de la UA
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Obtener ID de rol y miembros del rol
```
{% endtab %}
{% endtabs %}

### Referencias

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a **tu empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡echa un vistazo a los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>