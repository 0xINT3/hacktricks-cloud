# Az - AzureAD

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### Enumeración

Para esta enumeración, puedes usar la herramienta [**az cli**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli), el módulo de PowerShell [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (o [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) y el módulo [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps).

{% hint style="success" %}
En Linux, necesitarás instalar PowerShell Core:

```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Actualizar repositorios
sudo apt-get update
sudo add-apt-repository universe

# Instalar y ejecutar PowerShell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

### **Conexión**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #Esto abrirá el navegador
az login -u <username> -p <password> #Especificar usuario y contraseña
az login --identity #Usar la identidad administrada de la máquina actual (metadatos)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Iniciar sesión con la identidad administrada por el usuario
# Iniciar sesión como principal de servicio
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #Con contraseña
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #Con certificado

# Solicitar token de acceso (ARM)
az account get-access-token
# Solicitar token de acceso para un recurso diferente. Tokens admitidos: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# Si quieres configurar algunos valores predeterminados
az configure

# Obtener el usuario que ha iniciado sesión
az ad signed-in-user show

# Ayuda
az find "vm" # Buscar comandos de vm
az vm -h # Obtener subdominios
az ad user list --query-examples # Obtener ejemplos
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Abrir navegador
# Usando credenciales
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Usando tokens
## AzureAD no puede solicitar tokens, pero puede usar tokens AADGraph y MSGraph para conectarse
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Abrir navegador
# Usando credenciales
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Obtener token de acceso
(Get-AzAccessToken).Token
# Solicitar token de acceso a otros puntos finales: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake,
# Dispositivos propiedad de un usuario
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objetos propiedad de un usuario específico
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Obtener grupos y roles donde el usuario es miembro
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Obtener dispositivos propiedad de un usuario
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Obtener dispositivos registrados por un usuario
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Aplicaciones donde un usuario tiene un rol (el rol no se muestra)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Obtener unidades administrativas de un usuario
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }

#### Cambiar la contraseña de un usuario

```powershell
$password = "EstaEsLaNuevaContraseña.!123" | ConvertTo- SecureString -AsPlainText –Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password –Verbose
```

### Grupos

```powershell
# Enumerar grupos
Get-AzureADGroup -All $true
# Obtener información de un grupo
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Obtener grupos que permiten membresía dinámica
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# Todos los grupos que son de Azure AD 
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# Todos los grupos que se sincronizan desde local (tenga en cuenta que los grupos de seguridad no se sincronizan)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Obtener miembros de un grupo
Get-AzureADGroupMember -ObjectId <group_id>
# Obtener roles de un grupo
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Obtener id del grupo
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Obtener unidades administrativas de un grupo
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```

#### Agregar usuario a un grupo

Los propietarios del grupo pueden agregar nuevos usuarios al grupo

```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```

### Principales de servicio

```powershell
# Obtener Principales de Servicio
Get-AzureADServicePrincipal -All $true
# Obtener detalles de un principal de servicio
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Obtener Principales de Servicio por nombre de cadena o Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Obtener propietario de un principal de servicio
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Obtener objetos propiedad de un principal de servicio
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Obtener objetos creados por un principal de servicio
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Obtener grupos donde el principal de servicio es miembro
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```

La propiedad de un principal de servicio puede cambiar su contraseña.
### Roles

{% tabs %}
{% tab title="az cli" %}
```bash
# Obtener roles
az role definition list
# Obtener roles asignados
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Obtener información de un rol
az role definition list --name "AzureML Registry User"
# Obtener solo roles personalizados
az role definition list --custom-role-only
# Obtener solo roles asignados al grupo de recursos indicado
az role definition list --resource-group <resource_group>
# Obtener solo roles asignados al ámbito indicado
az role definition list --scope <scope>
# Obtener todos los principales a los que se asigna un rol
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Obtener todas las plantillas de roles disponibles
Get-AzureADDirectoryroleTemplate
# Obtener roles habilitados (roles asignados)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Obtener información sobre el rol
# Obtener roles personalizados - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Usuarios asignados a un rol (Administrador global)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles de la Unidad Administrativa (quién tiene permisos sobre la unidad administrativa y sus miembros)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Obtener asignaciones de roles en la suscripción
Get-AzRoleDefinition
# Obtener definición de rol
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Obtener roles de un usuario o recurso
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Raw" %}
```powershell
# Obtener permisos sobre un recurso utilizando ARM directamente
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
 Method = 'GET'
 Uri = $URI
 Headers = @{
 'Authorization' = "Bearer $Token"
 }
}
(Invoke-RestMethod @RequestParams).value 
```
{% endtab %}
{% endtabs %}

### Dispositivos

{% tabs %}
{% tab title="az cli" %}
```bash
# Si sabes cómo hacer esto, ¡envía un PR!
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Enumerar dispositivos
Get-AzureADDevice -All $true | fl *
# Listar todos los dispositivos activos (y no los obsoletos)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Obtener propietarios de todos los dispositivos
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Usuarios registrados de todos los dispositivos
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Obtener dispositivos administrados con Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Obtener dispositivos propiedad de un usuario
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Obtener Unidades Administrativas de un dispositivo
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Si un dispositivo (VM) está **unido a AzureAD**, los usuarios de AzureAD podrán **iniciar sesión**.\
Además, si el usuario que ha iniciado sesión es **propietario** del dispositivo, será **administrador local**.
{% endhint %}

### Aplicaciones

{% hint style="info" %}
**Las aplicaciones** son **registros de aplicaciones** en el portal (no aplicaciones empresariales).\
Pero cada registro de aplicación creará una **aplicación empresarial** (**Service Principal**) con el mismo nombre.\
Además, si la aplicación es una **aplicación multiinquilino**, se creará **otra** aplicación empresarial (**Service Principal**) en **ese inquilino** con el mismo nombre.
{% endhint %}

Cuando se genera una aplicación se otorgan 2 tipos de permisos:

* **Permisos** otorgados al **Service Principal**
* **Permisos** que la **aplicación** puede tener y usar **en nombre del usuario**.

{% tabs %}
{% tab title="az cli" %}
```bash
# Listar aplicaciones
az ad app list
az ad app list --query "[].[displayName]" -o table
# Obtener información de una aplicación
az ad app show --id 00000000-0000-0000-0000-000000000000
# Buscar aplicación por cadena
az ad app list --query "[?contains(displayName,'app')].displayName"
# Obtener el propietario de una aplicación
az ad app owner list --id <id> --query "[].[displayName]" -o table
# Listar todas las aplicaciones con una contraseña de aplicación
az ad app list --query "[?passwordCredentials != null].displayName"
# Listar aplicaciones que tienen credenciales de clave (uso de autenticación de certificado)
az ad app list --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Listar todas las aplicaciones registradas
Get-AzureADApplication -All $true
# Obtener detalles de una aplicación