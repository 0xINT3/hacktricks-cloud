### Utilisateurs

{% tabs %}
{% tab title="az cli" %}
```bash
# Enumérer les utilisateurs
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Obtenir les informations d'un utilisateur
az ad user show --id "test@corp.onmicrosoft.com"
# Rechercher les utilisateurs "admin"
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Rechercher les attributs contenant le mot "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# Tous les utilisateurs d'AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# Tous les utilisateurs synchronisés depuis l'infrastructure locale
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Obtenir les groupes auxquels l'utilisateur appartient
az ad user get-member-groups --id <email>
# Obtenir les rôles attribués à l'utilisateur
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Enumérer les utilisateurs
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Obtenir les informations d'un utilisateur
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Rechercher les utilisateurs "admin"
Get-AzureADUser -SearchString "admin" #Recherche "admin" au début de DisplayName ou userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Recherche le mot "admin" dans DisplayName
# Obtenir tous les attributs d'un utilisateur
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Rechercher les attributs contenant le mot "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# Tous les utilisateurs d'AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# Tous les utilisateurs synchronisés depuis l'infrastructure locale
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objets créés par un/plusieurs utilisateurs
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Enumérer les utilisateurs
Get-AzADUser -All $true
Get-AzADUser -All $true | select UserPrincipalName
# Obtenir les informations d'un utilisateur
Get-AzADUser -ObjectId test@corp.onmicrosoft.com | fl
# Rechercher les utilisateurs "admin"
Get-AzADUser -SearchString "admin" #Recherche "admin" au début de DisplayName ou userPrincipalName
Get-AzADUser -All $true |?{$_.Displayname -match "admin"} #Recherche le mot "admin" dans DisplayName
# Obtenir tous les attributs d'un utilisateur
Get-AzADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Rechercher les attributs contenant le mot "password"
Get-AzADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# Tous les utilisateurs d'AzureAD
Get-AzADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# Tous les utilisateurs synchronisés depuis l'infrastructure locale
Get-AzADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objets créés par un/plusieurs utilisateurs
Get-AzADUser [-ObjectId <email>] | Get-AzADUserCreatedObject
```
{% endtab %}

{% tab title="Raw PS" %}
```powershell
# Enumérer les utilisateurs
$Token = 'eyJ0eXAi..'
$URI = 'https://graph.windows.net/myorganization/users?api-version=1.6'
$RequestParams = @{
  Method  = 'GET'
  Uri     = $URI
  Headers = @{
      'Authorization' = "Bearer $Token"
  }
}
(Invoke-RestMethod @RequestParams).value
# Obtenir les informations d'un utilisateur
$URI = 'https://graph.windows.net/myorganization/users/test@corp.onmicrosoft.com'
$RequestParams = @{
  Method  = 'GET'
  Uri
# Appareils possédés par un utilisateur
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objets possédés par un utilisateur spécifique
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Obtenir les groupes et les rôles auxquels l'utilisateur appartient
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Obtenir les appareils possédés par un utilisateur
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Obtenir les appareils enregistrés par un utilisateur
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Applications où un utilisateur a un rôle (rôle non affiché)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Obtenir les unités administratives d'un utilisateur
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }

#### Changer le mot de passe de l'utilisateur

```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText –Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password –Verbose
```

### Groupes

```powershell
# Énumérer les groupes
Get-AzureADGroup -All $true
# Obtenir les informations d'un groupe
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Obtenir les groupes "admin"
Get-AzureADGroup -SearchString "admin" | fl #Groupes commençant par "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groupes avec le mot "admin"
# Obtenir les groupes permettant l'appartenance dynamique
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# Tous les groupes qui sont d'Azure AD 
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# Tous les groupes qui sont synchronisés à partir d'un local (notez que les groupes de sécurité ne sont pas synchronisés)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Obtenir les membres d'un groupe
Get-AzureADGroupMember -ObjectId <group_id>
# Obtenir les rôles d'un groupe
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Obtenir l'ID du groupe
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Obtenir les unités administratives d'un groupe
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```

#### Ajouter un utilisateur à un groupe

Les propriétaires du groupe peuvent ajouter de nouveaux utilisateurs au groupe

```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```

### Principaux services

Notez que **Service Principal** en terminologie PowerShell est appelé **Applications d'entreprise** dans le portail Azure (web).

```powershell
# Obtenir les principaux services
Get-AzureADServicePrincipal -All $true
# Obtenir les détails d'un principal de service
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Obtenir un principal de service par nom de chaîne ou ID
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Obtenir le propriétaire du principal de service
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Obtenir les objets possédés par un principal de service
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Obtenir les objets créés par un principal de service
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Obtenir les groupes dont le principal de service est membre
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADService
### Rôles

{% tabs %}
{% tab title="az cli" %}
```bash
# Obtenir les rôles
az role definition list
# Obtenir les rôles assignés
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Obtenir les informations d'un rôle
az role definition list --name "AzureML Registry User"
# Obtenir uniquement les rôles personnalisés
az role definition list --custom-role-only
# Obtenir uniquement les rôles assignés au groupe de ressources indiqué
az role definition list --resource-group <resource_group>
# Obtenir uniquement les rôles assignés à la portée indiquée
az role definition list --scope <scope>
# Obtenir tous les principaux auxquels un rôle est assigné
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Obtenir tous les modèles de rôle disponibles
Get-AzureADDirectoryroleTemplate
# Obtenir les rôles activés (rôles assignés)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Obtenir des informations sur le rôle
# Obtenir les rôles personnalisés - utiliser AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Utilisateurs assignés à un rôle (administrateur global)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Rôles de l'unité administrative (qui a des autorisations sur l'unité administrative et ses membres)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Obtenir les affectations de rôle sur l'abonnement
Get-AzRoleDefinition
# Obtenir la définition de rôle
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Obtenir les rôles d'un utilisateur ou d'une ressource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```
{% endtab %}

{% tab title="Raw" %}
```powershell
# Obtenir les autorisations sur une ressource en utilisant ARM directement
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
 Method = 'GET'
 Uri = $URI
 Headers = @{
 'Authorization' = "Bearer $Token"
 }
}
(Invoke-RestMethod @RequestParams).value 
```
{% endtab %}
{% endtabs %}

### Appareils

{% tabs %}
{% tab title="az cli" %}
```bash
# Si vous savez comment faire cela, envoyez une PR !
```
{% endtab %}

{% tab title="Azure AD" %}
```powershell
# Énumérer les appareils
Get-AzureADDevice -All $true | fl *
# Liste de tous les appareils actifs (et non les appareils obsolètes)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Obtenir les propriétaires de tous les appareils
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Utilisateurs enregistrés de tous les appareils
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Obtenir les plongées gérées à l'aide d'Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Obtenir les appareils possédés par un utilisateur
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Obtenir les unités administratives d'un appareil
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
Si un appareil (VM) est **joint à AzureAD**, les utilisateurs d'AzureAD pourront **se connecter**.\
De plus, si l'utilisateur connecté est **propriétaire** de l'appareil, il sera **administrateur local**.
{% endhint %}

### Applications

{% hint style="info" %}
Les **Applications** sont des **enregistrements d'application** dans le portail (pas des Applications d'entreprise).\
Mais chaque enregistrement d'application va créer une **Application d'entreprise** (**Principal de service**) avec le même nom.\
De plus, si l'application est une **application multi-tenant**, une **autre** Application d'entreprise (**Principal de service**) sera créée dans **ce locataire** avec le même nom.
{% endhint %}

Lorsqu'une application est générée, deux types d'autorisations sont données :

* **Autorisations** données au **Principal de service**
* **Autorisations** que l'**application** peut avoir et utiliser **au nom de l'utilisateur**.

{% tabs %}
{% tab title="az cli" %}
```bash
# Liste des applications
az ad app list
az ad app list --query "[].[displayName]" -o table
# Obtenir les informations d'une application
az ad app show --id 00000000-0000-0000-0000-000000000000
# Rechercher une application par chaîne
az ad app list --query "[?contains(displayName,'app')].displayName"
# Obtenir le propriétaire d'une application
az ad app owner list --