# Az - Key Vault

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

[来自文档：](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault是一个用于**安全存储和访问秘密**的云服务。秘密是您想要**严格控制访问权限**的任何内容，例如API密钥、密码、证书或加密密钥。Key Vault服务支持两种类型的容器：vaults和托管硬件安全模块（HSM）池。Vaults支持存储软件和HSM支持的密钥、秘密和证书。托管HSM池仅支持HSM支持的密钥。查看[Azure Key Vault REST API概述](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates)获取完整详情。

**URL格式**为 `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` 其中：

* `vault-name`是密钥保管库的全局**唯一**名称
* `object-type`可以是“keys”、“secrets”或“certificates”
* `object-name`是密钥保管库中对象的**唯一**名称
* `object-version`是系统生成的，可选用于访问对象的**唯一版本**。

为了访问存储在保管库中的秘密，可以使用两种权限模型：

* **Vault访问策略**
* **Azure RBAC**

### 访问控制 <a href="#access-control" id="access-control"></a>

对Key Vault资源的访问由两个平面控制：

* **管理平面**，其目标是[management.azure.com](http://management.azure.com/)。
* 用于管理密钥保管库和**访问策略**。仅支持Azure基于角色的访问控制（**RBAC**）。
* **数据平面**，其目标是**`<vault-name>.vault.azure.com`**。
* 用于管理和访问密钥保管库中的**数据**（密钥、秘密和证书）。这支持**密钥保管库访问策略**或Azure **RBAC**。

像**Contributor**这样的角色在管理平面具有管理访问策略的权限，可以通过修改访问策略来访问秘密。

### Key Vault RBAC内置角色 <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

### 网络访问

在Azure Key Vault中，可以设置**防火墙**规则，以便**仅允许来自指定虚拟网络或IPv4地址范围的数据平面操作**。此限制还会影响通过Azure管理门户的访问；如果用户的登录IP地址不在授权范围内，则用户将无法列出密钥、秘密或证书。

要分析和管理这些设置，可以使用**Azure CLI**：
```bash
az keyvault show --name name-vault --query networkAcls
```
前一个命令将显示`name-vault`的防火墙设置，包括启用的IP范围和拒绝流量的策略。

## 枚举

{% tabs %}
{% tab title="Az Powershell" %}
{% code overflow="wrap" %}
```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> –AsPlainText
```
## Azure Key Vault

### Key Vault Usage

Azure Key Vault is a cloud service that safeguards encryption keys and secrets like certificates, connection strings, and passwords. It helps secure sensitive information by storing keys and secrets in a centralized cloud location, allowing strict access control policies and auditing.

### Key Vault Features

1. **Secrets Management**: Store and manage application secrets.
2. **Key Management**: Create and control encryption keys.
3. **Certificate Management**: Provision, manage, and deploy SSL/TLS certificates.
4. **Access Policies**: Define who can access specific keys and secrets.
5. **Monitoring**: Track key usage and manage key rotation.

### Key Vault Security Best Practices

1. **Access Control**: Use Azure RBAC to control access to Key Vault resources.
2. **Vault Hierarchy**: Organize vaults based on security requirements.
3. **Key Rotation**: Regularly rotate keys and secrets.
4. **Monitoring and Logging**: Enable logging and monitor for suspicious activities.
5. **Backup and Recovery**: Implement backup and recovery processes for keys and secrets.

### Key Vault Pricing

Azure Key Vault pricing is based on the number of operations and the type of key or secret being stored. There are additional costs for storing and managing HSM-protected keys. Check the Azure website for the most up-to-date pricing information.
```bash
#!/bin/bash

# Dump all keyvaults from the subscription

# Define Azure subscription ID
AZ_SUBSCRIPTION_ID="your-subscription-id"

# Specify the filename for output
CSV_OUTPUT="vault-names-list.csv"

# Login to Azure account
az login

# Select the desired subscription
az account set --subscription $AZ_SUBSCRIPTION_ID

# Retrieve all resource groups within the subscription
AZ_RESOURCE_GROUPS=$(az group list --query "[].name" -o tsv)

# Initialize the CSV file with headers
echo "Vault Name,Associated Resource Group" > $CSV_OUTPUT

# Iterate over each resource group
for GROUP in $AZ_RESOURCE_GROUPS
do
# Fetch key vaults within the current resource group
VAULT_LIST=$(az keyvault list --resource-group $GROUP --query "[].name" -o tsv)

# Process each key vault
for VAULT in $VAULT_LIST
do
# Extract the key vault's name
VAULT_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

# Append the key vault name and its resource group to the file
echo "$VAULT_NAME,$GROUP" >> $CSV_OUTPUT
done
done
```
{% endtab %}
{% endtabs %}

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
