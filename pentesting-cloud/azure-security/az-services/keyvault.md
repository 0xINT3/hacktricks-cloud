# Az - Key Vault

## Az - Key Vault

<details>

<summary><strong>Jifunze kuhack AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

### Taarifa Msingi

[Kutoka kwa nyaraka:](https://learn.microsoft.com/en-us/azure/key-vault/general/basic-concepts) Azure Key Vault ni huduma ya wingu ya **kuhifadhi na kupata siri kwa usalama**. Siri ni kitu chochote unachotaka **kudhibiti upatikanaji kwa karibu**, kama vile funguo za API, nywila, vyeti, au funguo za kryptographia. Huduma ya Key Vault inasaidia aina mbili za kontena: hifadhi na mabwawa ya moduli ya usalama ya vifaa iliyosimamiwa (HSM). Hifadhi inasaidia kuhifadhi funguo za programu na zilizosimamiwa na HSM, siri, na vyeti. Mabwawa ya HSM yaliyosimamiwa yanayosaidia tu funguo zilizosimamiwa na HSM. Angalia [Maelezo ya Jumla ya Azure Key Vault REST API](https://learn.microsoft.com/en-us/azure/key-vault/general/about-keys-secrets-certificates) kwa maelezo kamili.

**Muundo wa URL** ni `https://{vault-name}.vault.azure.net/{object-type}/{object-name}/{object-version}` Ambapo:

* `vault-name` ni jina la kipekee kwa kiwanda cha funguo
* `object-type` inaweza kuwa "funguo", "siri" au "vyeti"
* `object-name` ni jina la kipekee la kitu ndani ya kiwanda cha funguo
* `object-version` inajengwa na mfumo na kutumiwa hiari kushughulikia **toleo la kipekee la kitu**.

Ili kupata siri zilizohifadhiwa kwenye kiwanda, mifano 2 ya ruhusa inaweza kutumika:

* **Sera ya Upatikanaji wa Kiwanda**
* **Azure RBAC**

#### Kudhibiti Upatikanaji <a href="#access-control" id="access-control"></a>

Upatikanaji wa rasilimali ya Key Vault unadhibitiwa na ndege mbili:

* **Ndege ya usimamizi**, lengo lake ni [management.azure.com](http://management.azure.com/).
* Inatumika kusimamia kiwanda cha funguo na **sera za upatikanaji**. Inasaidia tu udhibiti wa upatikanaji wa msingi wa jukumu la Azure (**RBAC**).
* **Ndege ya data**, lengo lake ni **`<vault-name>.vault.azure.com`**.
* Inatumika kusimamia na kupata **data** (funguo, siri, na vyeti) **katika kiwanda cha funguo**. Hii inasaidia **sera za upatikanaji wa kiwanda cha funguo** au Azure **RBAC**.

Jukumu kama **Mchangiaji** ambaye ana ruhusa katika mahali pa usimamizi kusimamia sera za upatikanaji anaweza kupata siri kwa kubadilisha sera za upatikanaji.

#### Majukumu Yaliyojengwa Ndani ya RBAC ya Key Vault <a href="#rbac-built-in-roles" id="rbac-built-in-roles"></a>

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

#### Upatikanaji wa Mtandao

Katika Azure Key Vault, sheria za **firewall** zinaweza kuwekwa ili **kuruhusu operesheni za ndege ya data tu kutoka kwenye mitandao ya kawaida iliyowekwa au safu za anwani za IPv4**. Kizuizi hiki pia huathiri upatikanaji kupitia portal ya utawala ya Azure; watumiaji hawataweza kuorodhesha funguo, siri, au vyeti katika kiwanda cha funguo ikiwa anwani yao ya IP ya kuingia haiko ndani ya safu iliyoruhusiwa.

Kwa kuchambua na kusimamia mipangilio hii, unaweza kutumia **Azure CLI**:

```bash
az keyvault show --name name-vault --query networkAcls
```

Amri iliyopita itaonyesha mipangilio ya f**irewall ya `name-vault`**, ikiwa ni pamoja na safu zilizowezeshwa za IP na sera za trafiki iliyokataliwa.

### Uchambuzi

```powershell
# Get keyvault token
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Connect with PS AzureAD
## $token from management API
Connect-AzAccount -AccessToken $token -AccountId 1937ea5938eb-10eb-a365-10abede52387 -KeyVaultAccessToken $keyvaulttoken

# List vaults
Get-AzKeyVault
# Get secrets names from the vault
Get-AzKeyVaultSecret -VaultName <vault_name>
# Get secret values
Get-AzKeyVaultSecret -VaultName <vault_name> -Name <secret_name> ‚ÄìAsPlainText
```

\`\`\`bash #!/bin/bash

## Dump all keyvaults from the subscription

## Define Azure subscription ID

AZ\_SUBSCRIPTION\_ID="your-subscription-id"

## Specify the filename for output

CSV\_OUTPUT="vault-names-list.csv"

## Login to Azure account

az login

## Select the desired subscription

az account set --subscription $AZ\_SUBSCRIPTION\_ID

## Retrieve all resource groups within the subscription

AZ\_RESOURCE\_GROUPS=$(az group list --query "\[].name" -o tsv)

## Initialize the CSV file with headers

echo "Vault Name,Associated Resource Group" > $CSV\_OUTPUT

## Iterate over each resource group

for GROUP in $AZ\_RESOURCE\_GROUPS do

## Fetch key vaults within the current resource group

VAULT\_LIST=$(az keyvault list --resource-group $GROUP --query "\[].name" -o tsv)

## Process each key vault

for VAULT in $VAULT\_LIST do

## Extract the key vault's name

VAULT\_NAME=$(az keyvault show --name $VAULT --resource-group $GROUP --query "name" -o tsv)

## Append the key vault name and its resource group to the file

echo "$VAULT\_NAME,$GROUP" >> $CSV\_OUTPUT done done

```
<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
```
