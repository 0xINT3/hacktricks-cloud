# Az - Conta de Automa√ß√£o

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Informa√ß√µes B√°sicas

O Azure Automation oferece um servi√ßo de automa√ß√£o baseado em nuvem, atualiza√ß√µes do sistema operacional e configura√ß√£o que suporta gerenciamento consistente em seus ambientes Azure e n√£o-Azure. Ele inclui automa√ß√£o de processos, gerenciamento de configura√ß√£o, gerenciamento de atualiza√ß√µes, recursos compartilhados e recursos heterog√™neos.

Esses s√£o como "**tarefas agendadas**" no Azure que permitir√£o que voc√™ execute coisas (a√ß√µes ou at√© scripts) para **gerenciar**, verificar e configurar o **ambiente Azure**.

### Conta de Execu√ß√£o

Quando a **Conta de Execu√ß√£o** √© usada, ela cria um **aplicativo Azure AD** com certificado autoassinado, cria um **principal de servi√ßo** e atribui a fun√ß√£o **Contribuinte** para a conta na **assinatura atual** (muitos privil√©gios).\
A Microsoft recomenda o uso de uma **Identidade Gerenciada** para a Conta de Automa√ß√£o.

{% hint style="warning" %}
Isso ser√° **removido em 30 de setembro de 2023 e substitu√≠do por Identidades Gerenciadas**.
{% endhint %}

## Comprometimento de Runbooks e Jobs

Os **Runbooks** permitem que voc√™ execute c√≥digo PowerShell arbitr√°rio. Isso pode ser **abusado por um invasor** para roubar as permiss√µes do **principal anexado** (se houver).\
No **c√≥digo** dos **Runbooks**, voc√™ tamb√©m pode encontrar **informa√ß√µes sens√≠veis** (como credenciais).

Se voc√™ pode **ler** os **jobs**, fa√ßa isso, pois eles **cont√™m** a **sa√≠da** da execu√ß√£o (informa√ß√µes potencialmente **sens√≠veis**).

V√° para `Contas de Automa√ß√£o` --> `<Selecione a Conta de Automa√ß√£o>` --> `Runbooks/Jobs/Grupos de trabalhadores h√≠bridos/Tarefas de observa√ß√£o/credenciais/vari√°veis/certificados/conex√µes`

### Trabalhador H√≠brido

Um Runbook pode ser executado em um **cont√™iner dentro do Azure** ou em um **Trabalhador H√≠brido**.\
O **Agente de An√°lise de Log** √© implantado na VM para registr√°-lo como um trabalhador h√≠brido.\
Os trabalhos do trabalhador h√≠brido s√£o executados como **SYSTEM** no Windows e como conta **nxautomation** no Linux.\
Cada Trabalhador H√≠brido √© registrado em um **Grupo de Trabalhadores H√≠bridos**.

Portanto, se voc√™ puder escolher executar um **Runbook** em um **Trabalhador H√≠brido do Windows**, voc√™ executar√° **comandos arbitr√°rios** dentro da m√°quina como **System**.

## Comprometimento da Configura√ß√£o de Estado (SC)

A Configura√ß√£o de Estado da Automa√ß√£o do Azure √© um servi√ßo de gerenciamento de configura√ß√£o do Azure que permite escrever, gerenciar e compilar configura√ß√µes de Desired State Configuration (DSC) do PowerShell [configura√ß√µes](https://learn.microsoft.com/en-us/powershell/dsc/configurations/configurations) para n√≥s em qualquer nuvem ou datacenter local. O servi√ßo tamb√©m importa [Recursos DSC](https://learn.microsoft.com/en-us/powershell/dsc/resources/resources) e atribui configura√ß√µes a n√≥s de destino, tudo na nuvem. Voc√™ pode acessar a Configura√ß√£o de Estado da Automa√ß√£o do Azure no portal do Azure selecionando **Configura√ß√£o de estado (DSC)** em **Gerenciamento de configura√ß√£o**.

**Informa√ß√µes sens√≠veis** podem ser encontradas nessas configura√ß√µes.

### RCE

√â poss√≠vel abusar do SC para executar scripts arbitr√°rios nas m√°quinas gerenciadas.

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## Enumera√ß√£o

{% code overflow="wrap" %}
```powershell
# Verifique o direito do usu√°rio para automa√ß√£o
az extension add --upgrade -n automation
az automation account list # se n√£o retornar nada, o usu√°rio n√£o faz parte de um grupo de Automa√ß√£o

# Obt√©m contas de Automa√ß√£o do Azure em um grupo de recursos
Get-AzAutomationAccount

# Listar e obter configura√ß√µes DSC
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## As contas de Automa√ß√£o com o nome SecurityBaselineConfigurationWS... est√£o l√° por padr√£o (n√£o s√£o interessantes)

# Listar e obter c√≥digo de Runbooks
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRunbook -OutputFolder /tmp

# Listar