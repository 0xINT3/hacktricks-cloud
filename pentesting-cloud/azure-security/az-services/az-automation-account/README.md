# Az - Cuenta de Automatización

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información básica

Azure Automation ofrece una automatización basada en la nube, actualizaciones del sistema operativo y un servicio de configuración que admite una gestión coherente en sus entornos de Azure y no de Azure. Incluye automatización de procesos, gestión de configuración, gestión de actualizaciones, capacidades compartidas y características heterogéneas.

Estos son como "**tareas programadas**" en Azure que le permitirán ejecutar cosas (acciones o incluso scripts) para **administrar**, verificar y configurar el **entorno de Azure**.

### Cuenta de Ejecución

Cuando se utiliza la **Cuenta de Ejecución**, se crea una **aplicación de Azure AD** con un certificado autofirmado, se crea un **principal de servicio** y se asigna el rol de **Contribuyente** para la cuenta en la **suscripción actual** (muchos privilegios).\
Microsoft recomienda el uso de una **Identidad Administrada** para la Cuenta de Automatización.

{% hint style="warning" %}
Esto se **eliminará el 30 de septiembre de 2023 y se cambiará por Identidades Administradas**.
{% endhint %}

## Compromiso de Runbooks y Trabajos

Los **Runbooks** le permiten **ejecutar código PowerShell arbitrario**. Esto podría ser **abusado por un atacante** para robar los permisos del **principal adjunto** (si lo hay).\
En el **código** de los **Runbooks** también se pueden encontrar **información sensible** (como credenciales).

Si puede **leer** los **trabajos**, hágalo ya que **contienen** la **salida** de la ejecución (información potencialmente **sensible**).

Vaya a `Cuentas de Automatización` --> `<Seleccione la Cuenta de Automatización>` --> `Runbooks/Trabajos/Grupos de trabajadores híbridos/Tareas de vigilancia/credenciales/variables/certificados/conexiones`

### Trabajador Híbrido

Un Runbook se puede ejecutar en un **contenedor dentro de Azure** o en un **Trabajador Híbrido**.\
El **Agente de Análisis de registros** se implementa en la VM para registrarla como un trabajador híbrido.\
Los trabajos de trabajador híbrido se ejecutan como **SYSTEM** en Windows y como cuenta **nxautomation** en Linux.\
Cada Trabajador Híbrido se registra en un **Grupo de Trabajadores Híbridos**.

Por lo tanto, si puede elegir ejecutar un **Runbook** en un **Trabajador Híbrido de Windows**, ejecutará **comandos arbitrarios** dentro de esa máquina como **System**.

## Compromiso de Configuración de Estado (SC)

La **Configuración de Estado de Automatización de Azure** es un servicio de gestión de configuración de Azure que le permite escribir, administrar y compilar configuraciones de PowerShell Desired State Configuration (DSC) [configuraciones](https://learn.microsoft.com/en-us/powershell/dsc/configurations/configurations) para nodos en cualquier nube o centro de datos local. El servicio también importa [Recursos DSC](https://learn.microsoft.com/en-us/powershell/dsc/resources/resources) y asigna configuraciones a nodos de destino, todo en la nube. Puede acceder a la Configuración de Estado de Automatización de Azure en el portal de Azure seleccionando **Configuración de estado (DSC)** en **Gestión de configuración**.

Se podría encontrar **información sensible** en estas configuraciones.

### RCE

Es posible abusar de SC para ejecutar scripts arbitrarios en las máquinas administradas.

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## Enumeración

{% code overflow="wrap" %}
```powershell
# Comprueba los derechos de usuario para la automatización
az extension add --upgrade -n automation
az automation account list # si no devuelve nada, el usuario no es parte de un grupo de automatización

# Obtiene las cuentas de automatización de Azure en un grupo de recursos
Get-AzAutomationAccount

# Lista y obtiene configuraciones DSC
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## Las cuentas de automatización con nombre SecurityBaselineConfigurationWS... están ahí por defecto (no son interesantes)

# Lista y obtiene el código de los Runbooks
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRun