# Az - Compte Automation

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Informations de base

Azure Automation fournit une automatisation bas√©e sur le cloud, des mises √† jour du syst√®me d'exploitation et un service de configuration qui prend en charge une gestion coh√©rente dans vos environnements Azure et non-Azure. Il comprend l'automatisation de processus, la gestion de la configuration, la gestion des mises √† jour, les fonctionnalit√©s partag√©es et les fonctionnalit√©s h√©t√©rog√®nes.

Ce sont comme des "**t√¢ches planifi√©es**" dans Azure qui vous permettront d'ex√©cuter des choses (actions ou m√™me des scripts) pour **g√©rer**, v√©rifier et configurer l'**environnement Azure**.

### Compte Run As

Lorsque le **Compte Run As** est utilis√©, il cr√©e une **application Azure AD** avec un certificat auto-sign√©, cr√©e un **principal de service** et attribue le r√¥le **Contributeur** pour le compte dans l'**abonnement actuel** (beaucoup de privil√®ges).\
Microsoft recommande d'utiliser une **Identit√© g√©r√©e** pour le Compte Automation.

{% hint style="warning" %}
Cela sera **supprim√© le 30 septembre 2023 et remplac√© par des Identit√©s g√©r√©es**.
{% endhint %}

## Compromission des Runbooks & Jobs

Les **Runbooks** vous permettent d'ex√©cuter du code PowerShell arbitraire. Cela pourrait √™tre **abus√© par un attaquant** pour voler les autorisations du **principal attach√©** (s'il y en a).\
Dans le **code** des **Runbooks**, vous pouvez √©galement trouver des **informations sensibles** (telles que des informations d'identification).

Si vous pouvez **lire** les **jobs**, faites-le car ils **contiennent** la **sortie** de l'ex√©cution (des informations potentiellement **sensibles**).

Allez dans `Comptes Automation` --> `<S√©lectionner le Compte Automation>` --> `Runbooks/Jobs/Groupes de travailleurs hybrides/T√¢ches de surveillance/Informations d'identification/Variables/Certificats/Connexions`

### Travailleur hybride

Un Runbook peut √™tre ex√©cut√© dans un **conteneur √† l'int√©rieur d'Azure** ou dans un **travailleur hybride**.\
L'**Agent Log Analytics** est d√©ploy√© sur la machine virtuelle pour l'enregistrer en tant que travailleur hybride.\
Les travaux des travailleurs hybrides s'ex√©cutent en tant que **SYSTEM** sur Windows et en tant que compte **nxautomation** sur Linux.\
Chaque travailleur hybride est enregistr√© dans un **groupe de travailleurs hybrides**.

Par cons√©quent, si vous pouvez choisir d'ex√©cuter un **Runbook** dans un **travailleur hybride Windows**, vous ex√©cuterez des **commandes arbitraires** √† l'int√©rieur de cette machine en tant que **System**.

## Compromission de la configuration d'√©tat (SC)

Azure Automation **State Configuration** est un service de gestion de la configuration Azure qui vous permet d'√©crire, de g√©rer et de compiler des configurations de **PowerShell Desired State Configuration (DSC)** pour les n≈ìuds dans n'importe quel cloud ou centre de donn√©es sur site. Le service importe √©galement des **ressources DSC**, et affecte des configurations aux n≈ìuds cibles, le tout dans le cloud. Vous pouvez acc√©der √† Azure Automation State Configuration dans le portail Azure en s√©lectionnant **Configuration de l'√©tat (DSC)** sous **Gestion de la configuration**.

Des **informations sensibles** peuvent √™tre trouv√©es dans ces configurations.

### RCE

Il est possible d'abuser de SC pour ex√©cuter des scripts arbitraires dans les machines g√©r√©es.

{% content-ref url="az-state-configuration-rce.md" %}
[az-state-configuration-rce.md](az-state-configuration-rce.md)
{% endcontent-ref %}

## √ânum√©ration

{% code overflow="wrap" %}
```powershell
# V√©rifier les droits de l'utilisateur pour l'automatisation
az extension add --upgrade -n automation
az automation account list # si cela ne renvoie rien, l'utilisateur ne fait pas partie d'un groupe Automation

# Obtenir les comptes Automation Azure dans un groupe de ressources
Get-AzAutomationAccount

# Liste et obtient les configurations DSC
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration
Get-AzAutomationAccount | Get-AzAutomationDscConfiguration | where {$_.name -match '<name>'} | Export-AzAutomationDscConfiguration -OutputFolder . -Debug
## Les comptes Automation nomm√©s SecurityBaselineConfigurationWS... sont l√† par d√©faut (pas int√©ressants)

# Liste et obtient le code des Runbooks
Get-AzAutomationAccount | Get-AzAutomationRunbook
Get-AzAutomationAccount | Get-AzAutomationRunbook | Export-AzAutomationRunbook -OutputFolder /tmp

# Liste les informations d'identification et les variables