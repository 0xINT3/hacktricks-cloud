# Az - Blob Storage

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Información básica

Azure Blob Storage es la solución de almacenamiento de objetos de Microsoft para la nube. Blob Storage está optimizado para almacenar grandes cantidades de datos no estructurados. Los datos no estructurados son datos que no se adhieren a un modelo o definición de datos particular, como datos de texto o binarios.

Blob Storage ofrece tres tipos de recursos:

* La **cuenta de almacenamiento** (nombre único)
* Un **contenedor** en la cuenta de almacenamiento (carpeta)
* Un **blob** en un contenedor

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Diferentes tipos de almacenamiento

| **Blob Storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue Storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table Storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Acceso al almacenamiento <a href="#about-blob-storage" id="about-blob-storage"></a>

* Use los principios de Azure AD a través de los **roles RBAC** admitidos.
* **Claves de acceso**: Use las claves de acceso de la cuenta de almacenamiento. Esto proporciona acceso **completo a la cuenta de almacenamiento**.
* **Firma de acceso compartido** (SAS): Tiempo **limitado** y permisos específicos.
  * Puede generar una URL SAS con una clave de acceso (más complicado de detectar).

### Exposición pública

Si se habilita "Permitir acceso público a Blob" (deshabilitado de forma predeterminada), es posible:

* Dar **acceso público para leer blobs** (necesita conocer el nombre).
* **Listar blobs del contenedor** y **leerlos**.

### Conexión al almacenamiento

Si encuentra algún **almacenamiento** al que pueda conectarse, puede utilizar la herramienta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para hacerlo.

## URLs SAS

Una firma de acceso compartido (SAS) proporciona acceso delegado seguro a los recursos de su cuenta de almacenamiento. Con una SAS, tiene un control granular sobre cómo un cliente puede acceder a sus datos. Por ejemplo:

* A qué recursos puede acceder el cliente.
* Qué permisos tienen para esos recursos.
* Cuánto tiempo es válida la SAS.

Una URL SAS se ve así: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Use [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
    print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
    print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
    f.write(blob.download_blob().readall())
```
{% endcode %}

### SAS de delegación de usuario <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puede **asegurar un token de firma de acceso compartido (SAS)** para acceder a un contenedor, directorio o blob utilizando las **credenciales de Azure Active Directory (Azure AD) o una clave de cuenta**. Para crear una SAS de delegación de usuario, primero debe solicitar una **clave de delegación de usuario**, que luego utiliza para firmar la SAS.

Una SAS de delegación de usuario es compatible con **Azure Blob Storage** y **Azure Data Lake Storage Gen2**. **Las políticas de acceso almacenadas no son compatibles** con una SAS de delegación de usuario.

Tenga en cuenta que la SAS de delegación de usuario está **asegurada con credenciales de Azure AD en lugar de claves de cuenta de almacenamiento**. Esto evita que los clientes/aplicaciones almacenen/recuperen claves de almacenamiento para crear SAS.

### SAS de servicio

Una SAS de servicio está asegurada con la **clave de cuenta de almacenamiento**. Una SAS de servicio **delega el acceso a un recurso en solo uno** de los servicios de almacenamiento de Azure: almacenamiento de blobs, almacenamiento de colas, almacenamiento de tablas o archivos de Azure. La URI para una SAS de nivel de servicio consta de la URI al recurso para el que la SAS delegará acceso, seguida del token SAS.

Para usar las credenciales de Azure Active Directory (Azure AD) para asegurar una SAS para un **contenedor** o **blob**, use una **SAS de delegación de usuario**.

### SAS de cuenta

Una SAS de cuenta está asegurada con una de las **claves de cuenta de almacenamiento** (hay 2). Una SAS de cuenta delega el acceso a recursos en uno o más de los servicios de almacenamiento. Todas las operaciones disponibles a través de una SAS de servicio o de delegación de usuario también están disponibles a través de una SAS de cuenta.

Al crear una SAS de cuenta, puede:

* Delegar acceso a operaciones de nivel de servicio que actualmente no están disponibles con una SAS específica del servicio, como las operaciones `Get/Set Service Properties` y `Get Service Stats`.
* Delegar acceso a más de un servicio en una cuenta de almacenamiento al mismo tiempo. Por ejemplo, puede delegar acceso a recursos tanto en Azure Blob Storage como en Azure Files mediante una SAS de cuenta.
* Delegar acceso a operaciones de escritura y eliminación para contenedores, colas, tablas y recursos compartidos de archivos, que no están disponibles con una SAS específica del objeto.
* Especificar una dirección IP o un rango de direcciones IP desde las que aceptar solicitudes.
* Especificar el protocolo HTTP desde el que aceptar solicitudes (ya sea HTTPS o HTTP/HTTPS).

## Enumeración

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Introducción

Azure Blob Storage es un servicio de almacenamiento de objetos en la nube que permite almacenar y acceder a grandes cantidades de datos no estructurados. Es una solución escalable y rentable para almacenar y procesar datos, y se utiliza comúnmente para almacenar archivos de medios, datos de IoT y copias de seguridad.

En este artículo, exploraremos cómo realizar pruebas de penetración en Azure Blob Storage y cómo identificar y explotar vulnerabilidades comunes.

## Configuración de la cuenta de almacenamiento

Antes de comenzar a realizar pruebas de penetración en Azure Blob Storage, es importante configurar adecuadamente la cuenta de almacenamiento. Asegúrese de seguir las mejores prácticas de seguridad, como habilitar la autenticación multifactor y restringir el acceso a la cuenta de almacenamiento solo a los usuarios y aplicaciones necesarios.

## Escaneo de puertos y servicios

El primer paso en la realización de pruebas de penetración en Azure Blob Storage es escanear los puertos y servicios para identificar posibles vulnerabilidades. Utilice herramientas como Nmap o Masscan para escanear los puertos abiertos y los servicios que se ejecutan en ellos.

## Enumeración de cuentas de almacenamiento

Una vez que se han identificado los puertos y servicios abiertos, el siguiente paso es enumerar las cuentas de almacenamiento. Utilice herramientas como AzCopy o Azure Storage Explorer para enumerar las cuentas de almacenamiento y los contenedores.

## Identificación de vulnerabilidades comunes

Después de enumerar las cuentas de almacenamiento, es importante identificar y explotar vulnerabilidades comunes. Algunas vulnerabilidades comunes en Azure Blob Storage incluyen:

- Configuración incorrecta de permisos de acceso
- Uso de claves de acceso compartidas en lugar de SAS (Signature Access Keys)
- Uso de SAS con permisos excesivos
- Exposición de claves de acceso en código fuente o en repositorios de código

## Explotación de vulnerabilidades

Una vez que se han identificado las vulnerabilidades, el siguiente paso es explotarlas. Por ejemplo, si se encuentra una cuenta de almacenamiento con permisos de acceso incorrectamente configurados, se puede intentar acceder a los datos almacenados en la cuenta.

## Conclusiones

Azure Blob Storage es un servicio de almacenamiento en la nube escalable y rentable que se utiliza comúnmente para almacenar y procesar grandes cantidades de datos no estructurados. Sin embargo, como con cualquier servicio en la nube, es importante realizar pruebas de penetración para identificar y remediar posibles vulnerabilidades de seguridad.
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
