# Az - Blob Storage

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **ハックトリックで会社を宣伝したい**場合や、**最新バージョンのPEASSを見たい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加する**

</details>

## 基本情報

Azure Blobストレージは、Microsoftのオブジェクト**ストレージソリューション**です。Blobストレージは、大量の非構造化データを格納するために最適化されています。非構造化データとは、特定のデータモデルや定義に従わないデータのことであり、テキストやバイナリデータなどが該当します。

Blobストレージには、次の3つのリソースがあります。

* **ストレージアカウント**（一意の名前）
* ストレージアカウント内の**コンテナ**（フォルダ）
* コンテナ内の**ブロブ**

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### 異なるストレージの種類

| **Blobストレージ**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data LakeストレージGen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queueストレージ**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Tableストレージ**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### ストレージへのアクセス <a href="#about-blob-storage" id="about-blob-storage"></a>

* **RBACロール**を介したAzure ADプリンシパルを使用します。
* **アクセスキー**：ストレージアカウントのアクセスキーを使用します。これにより、ストレージアカウントへの**完全なアクセス**が可能になります。
* **共有アクセス署名**（SAS）：時間制限があり、特定の権限が付与されます。
* アクセスキーを使用してSAS URLを生成することもできます（検出がより複雑です）。

### パブリック公開

「Blobパブリックアクセスを許可する」が**有効**になっている場合（デフォルトでは無効）、次の操作が可能です。

* **ブロブの公開アクセス**を許可します（名前を知る必要があります）。
* コンテナのブロブを**一覧表示**し、**読み取り**します。

### ストレージへの接続

**ストレージ**を見つけた場合は、[**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/)ツールを使用して接続できます。

## SAS URL

共有アクセス署名（SAS）は、ストレージアカウント内のリソースへの安全な委任アクセスを提供します。SASを使用すると、クライアントがデータにアクセスする方法について細かい制御が可能です。例えば：

* クライアントがアクセスできるリソース。
* それらのリソースに対して持つ権限。
* SASの有効期間。

SAS URLは次のようになります：**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)を使用してデータにアクセスするか、Pythonを使用します：

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### ユーザーデリゲーションSAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Azure Active Directory（Azure AD）の資格情報またはアカウントキーを使用して、コンテナ、ディレクトリ、またはブロブへのアクセスのための**共有アクセス署名（SAS）**トークンを**保護**することができます。ユーザーデリゲーションSASを作成するには、まず**ユーザーデリゲーションキー**をリクエストし、それを使用してSASに署名します。

ユーザーデリゲーションSASは、**Azure Blob Storage**および**Azure Data Lake Storage Gen2**でサポートされています。ユーザーデリゲーションSASでは、**格納されたアクセスポリシーはサポートされていません**。

ユーザーデリゲーションSASは、**ストレージアカウントキーの代わりにAzure ADの資格情報で保護**されています。これにより、クライアント/アプリケーションがSASを作成するためにストレージキーを保存/取得することが防止されます。

### サービスSAS

サービスSASは、**ストレージアカウントキー**で保護されています。サービスSASは、Azure Storageサービスのいずれか（Blobストレージ、キューストレージ、テーブルストレージ、またはAzure Files）のリソースへのアクセスを**1つだけ委任**します。サービスレベルのSASのURIは、SASがアクセスを委任するリソースへのURIの後にSASトークンが続く形式です。

**コンテナ**または**ブロブ**のSASを保護するために、Azure Active Directory（Azure AD）の資格情報を使用して**ユーザーデリゲーションSAS**を使用します。

### アカウントSAS

アカウントSASは、**ストレージアカウントキー**のいずれか（2つあります）で保護されています。アカウントSASは、1つ以上のストレージサービスのリソースへのアクセスを委任します。サービスまたはユーザーデリゲーションSASを介して利用可能なすべての操作は、アカウントSASを介しても利用できます。

アカウントSASを作成することで、次のことができます：

* サービス固有のSASでは現在利用できないサービスレベルの操作（たとえば、`Get/Set Service Properties`および`Get Service Stats`操作）へのアクセスを委任します。
* アカウントSASを使用して、ストレージアカウント内の複数のサービスへのアクセスを委任できます。たとえば、アカウントSASを使用して、Azure Blob StorageとAzure Filesの両方のリソースへのアクセスを委任できます。
* オブジェクト固有のSASでは利用できないコンテナ、キュー、テーブル、およびファイル共有の書き込みおよび削除操作へのアクセスを委任します。
* リクエストを受け入れるためのIPアドレスまたはIPアドレスの範囲を指定します。
* リクエストを受け入れるためのHTTPプロトコル（HTTPSまたはHTTP/HTTPS）を指定します。

## 列挙

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 参考文献

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks**で**会社の広告を見たい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
