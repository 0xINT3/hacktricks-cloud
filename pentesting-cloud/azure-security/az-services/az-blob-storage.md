# Az - Blob Storage

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 자신의 해킹 기법을 공유하세요.

</details>

## 기본 정보

[문서에서 참조:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage는 Microsoft의 클라우드를 위한 객체 **저장 솔루션**입니다. Blob storage는 비구조화된 대량의 데이터를 저장하기에 최적화되어 있습니다. 비구조화된 데이터는 텍스트 또는 이진 데이터와 같이 특정 데이터 모델이나 정의에 따르지 않는 데이터입니다.

Blob storage는 세 가지 유형의 리소스를 제공합니다:

* **스토리지 계정** (고유 이름)
* 스토리지 계정의 **컨테이너** (폴더)
* 컨테이너의 **블롭**

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### 다른 유형의 저장소

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### 저장소에 대한 액세스 <a href="#about-blob-storage" id="about-blob-storage"></a>

* Azure AD 주체를 통한 **RBAC 역할**을 사용합니다.
* **액세스 키**: 스토리지 계정의 액세스 키를 사용합니다. 이는 스토리지 계정에 대한 **전체 액세스**를 제공합니다.
* **공유 액세스 서명** (SAS): **시간 제한**과 특정 권한을 제공합니다.
* 액세스 키로부터 SAS URL을 생성할 수 있습니다 (감지하기 더 복잡함).
* SAS는 액세스 키에서 생성되므로 액세스 키가 갱신되면 SAS가 작동하지 않습니다.

### 공개 노출

"Blob 공개 액세스 허용"이 **활성화**되어 있는 경우 (기본적으로 비활성화됨), 다음을 수행할 수 있습니다:

* **블롭 읽기에 대한 공개 액세스**를 제공합니다 (이름을 알아야 함).
* 컨테이너 블롭을 **목록화**하고 **읽을 수 있습니다**.

### 저장소에 연결

**저장소**를 찾으면 [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) 도구를 사용하여 연결할 수 있습니다.

## SAS URL

[문서에서 참조:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 공유 액세스 서명(SAS)은 스토리지 계정의 리소스에 대한 안전한 대리 액세스를 제공합니다. SAS를 사용하면 클라이언트가 데이터에 액세스하는 방법을 세밀하게 제어할 수 있습니다. 예를 들어:

* 클라이언트가 액세스할 수 있는 리소스.
* 해당 리소스에 대한 권한.
* SAS의 유효 기간.

SAS URL은 다음과 같습니다: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

데이터에 액세스하려면 [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) 또는 python을 사용하세요:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### 사용자 위임 SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

**Azure Active Directory (Azure AD) 자격 증명 또는 계정 키**를 사용하여 컨테이너, 디렉터리 또는 블롭에 대한 **공유 액세스 서명 (SAS)** 토큰을 보호할 수 있습니다. 사용자 위임 SAS를 생성하려면 먼저 **사용자 위임 키**를 요청한 다음 이를 사용하여 SAS를 서명해야 합니다.

**Azure Blob Storage** 및 **Azure Data Lake Storage Gen2** 모두에서 **사용자 위임 공유 액세스 서명 (SAS)**를 지원하지만, **저장된 액세스 정책**은 사용자 위임 SAS와 호환되지 않음을 주의해야 합니다.

사용자 위임 SAS는 **저장소 계정 키 대신 Azure AD 자격 증명으로 보호**됩니다. 이로써 클라이언트/응용 프로그램이 SAS를 생성하기 위해 저장소 키를 저장/검색하는 것을 방지할 수 있습니다.

### 서비스 SAS

서비스 SAS는 **저장소 계정 키로 보호**됩니다. 서비스 SAS는 Azure Storage 서비스 중 하나인 Blob storage, Queue storage, Table storage 또는 Azure Files 중 **하나의 리소스에 대한 액세스를 위임**합니다. 서비스 수준 SAS의 URI는 SAS가 액세스를 위임할 리소스의 URI 뒤에 SAS 토큰이 따라오는 형식입니다.

**컨테이너** 또는 **블롭**에 대한 SAS를 보호하기 위해 Azure Active Directory (Azure AD) 자격 증명을 사용하려면 사용자 위임 SAS를 사용하세요.

### 계정 SAS

계정 SAS는 **저장소 계정 키 중 하나로 보호**됩니다 (2개의 키가 있음). 계정 SAS는 하나 이상의 저장소 서비스의 리소스에 대한 액세스를 위임합니다. 서비스 또는 사용자 위임 SAS를 통해 사용 가능한 모든 작업은 계정 SAS를 통해도 사용할 수 있습니다.

[문서에서 가져옴:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) 계정 SAS를 생성함으로써 다음을 수행할 수 있습니다:

* 현재 서비스별 SAS로 사용할 수 없는 `Get/Set Service Properties` 및 `Get Service Stats`와 같은 서비스 수준 작업에 대한 액세스 위임.
* 계정 SAS를 사용하여 저장소 계정의 여러 서비스에 동시에 액세스 위임. 예를 들어, 계정 SAS를 사용하여 Azure Blob Storage 및 Azure Files의 리소스에 액세스를 위임할 수 있습니다.
* 개체별 SAS로 사용할 수 없는 컨테이너, 큐, 테이블 및 파일 공유에 대한 쓰기 및 삭제 작업에 대한 액세스 위임.
* 요청을 수락할 IP 주소 또는 IP 주소 범위를 지정.
* 요청을 수락할 HTTP 프로토콜 지정 (HTTPS 또는 HTTP/HTTPS).

## 열거

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 참고 자료

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹을 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
