# Az - Blob Storage

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

## 基本情報

Azure Blob storageは、クラウド用のMicrosoftのオブジェクト**ストレージソリューション**です。Blob storageは、非構造化データの大量保存に最適化されています。非構造化データとは、テキストやバイナリデータなど、特定のデータモデルや定義に従わないデータのことです。

Blob storageは3種類のリソースを提供します:

* **ストレージアカウント** (一意の名前)
* ストレージアカウント内の**コンテナ** (フォルダ)
* コンテナ内の**blob**

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### 異なるタイプのストレージ

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### ストレージへのアクセス <a href="#about-blob-storage" id="about-blob-storage"></a>

* Azure ADプリンシパルを介して**RBACロール**をサポートしています。
* **アクセスキー**: ストレージアカウントのアクセスキーを使用します。これにより、ストレージアカウントへの**完全なアクセス**が可能になります。
* **共有アクセス署名** (SAS): 時間が**限定され**、特定の権限があります。
* アクセスキーでSAS URLを生成できます（検出がより複雑になります）。

### 公開露出

"Allow Blob public access"が**有効**になっている場合（デフォルトでは無効）、以下が可能です:

* **blobの読み取りへの公開アクセス**を許可する（名前を知っている必要があります）。
* **コンテナblobのリスト**と**読み取り**。

### ストレージへの接続

任意の**ストレージ**に接続できる場合は、[**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/)を使用して接続できます。

## SAS URL

共有アクセス署名（SAS）は、ストレージアカウント内のリソースへの安全な委任アクセスを提供します。SASを使用すると、クライアントがデータにアクセスする方法を細かく制御できます。例えば:

* クライアントがアクセスできるリソース。
* それらのリソースに対する彼らの権限。
* SASが有効な期間。

SAS URLは次のようになります: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

データにアクセスするには[**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/)を使用するか、pythonを使用します:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### ユーザー委任 SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

コンテナ、ディレクトリ、またはblobへのアクセスのための**共有アクセス署名（SAS）**トークンを、Azure Active Directory（Azure AD）の**クレデンシャルまたはアカウントキー**を使用して確保できます。ユーザー委任 SAS を作成するには、まず\*\* **\_**ユーザー委任キー\*\*\_を要求し、そのキーを使用してSASに署名します。

ユーザー委任 SAS は、**Azure Blob Storage**と**Azure Data Lake Storage Gen2**でサポートされています。**保存されたアクセスポリシーは、ユーザー委任 SAS ではサポートされていません**。

ユーザー委任 SAS は、ストレージアカウントキーではなく、Azure AD クレデンシャルで**保護されている**ことに注意してください。これにより、クライアント/アプリケーションがストレージキーを保存/取得してSASを作成することが防止されます。

### サービス SAS

サービス SAS は、**ストレージアカウントキー**で保護されています。サービス SAS は、Azure Storage サービスの1つのリソースへのアクセスを**委任します**：Blob storage、Queue storage、Table storage、または Azure Files。サービスレベルの SAS の URI は、SAS がアクセスを委任するリソースへの URI と、SAS トークンに続く形式です。

**コンテナ**または**blob**に対して Azure Active Directory（Azure AD）のクレデンシャルを使用して SAS を保護するには、**ユーザー委任 SAS**を使用します。

### アカウント SAS

アカウント SAS は、**ストレージアカウントキー**（2つあります）のいずれかで保護されています。アカウント SAS は、1つ以上のストレージサービスのリソースへのアクセスを委任します。サービスまたはユーザー委任 SAS で利用可能なすべての操作は、アカウント SAS でも利用可能です。

アカウント SAS を作成することで、以下のことができます：

* サービス固有の SAS では現在利用できないサービスレベルの操作へのアクセスを委任することができます。例えば、`Get/Set Service Properties`や`Get Service Stats`の操作です。
* 一度に複数のサービスへのアクセスを委任することができます。例えば、アカウント SAS を使用して、Azure Blob Storage と Azure Files の両方のリソースへのアクセスを委任することができます。
* オブジェクト固有の SAS では利用できない、コンテナ、キュー、テーブル、ファイル共有の書き込みおよび削除操作へのアクセスを委任することができます。
* 要求を受け入れる IP アドレスまたは IP アドレスの範囲を指定することができます。
* 要求を受け入れる HTTP プロトコルを指定することができます（HTTPS または HTTP/HTTPS）。

## 列挙

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 参考文献

* [https://learn.microsoft.com/ja-jp/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/ja-jp/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
