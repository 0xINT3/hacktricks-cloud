# Az - Almacenamiento de Blob

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informaci√≥n b√°sica

Azure Blob Storage es la soluci√≥n de almacenamiento de objetos de Microsoft para la nube. Blob Storage est√° optimizado para almacenar grandes cantidades de datos no estructurados. Los datos no estructurados son datos que no se adhieren a un modelo o definici√≥n de datos espec√≠ficos, como datos de texto o binarios.

Blob Storage ofrece tres tipos de recursos:

* La **cuenta de almacenamiento** (nombre √∫nico)
* Un **contenedor** en la cuenta de almacenamiento (carpeta)
* Un **blob** en un contenedor

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Diferentes tipos de almacenamiento

| **Almacenamiento de Blob**        | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;containre-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Almacenamiento de cola**       | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Almacenamiento de tabla**      | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Acceso al almacenamiento <a href="#about-blob-storage" id="about-blob-storage"></a>

* Use los principios de Azure AD a trav√©s de los **roles RBAC** admitidos.
* **Claves de acceso**: Use las claves de acceso de la cuenta de almacenamiento. Esto proporciona acceso completo a la cuenta de almacenamiento.
* **Firma de acceso compartido** (SAS): Tiempo **limitado** y permisos espec√≠ficos.
  * Puede generar una URL SAS con una clave de acceso (m√°s complicado de detectar).

### Exposici√≥n p√∫blica

Si "Permitir acceso p√∫blico a Blob" est√° **habilitado** (deshabilitado de forma predeterminada), es posible:

* Dar **acceso p√∫blico para leer blobs** (necesita conocer el nombre).
* **Listar blobs del contenedor** y **leerlos**.

### Conexi√≥n al almacenamiento

Si encuentra alg√∫n **almacenamiento** al que pueda conectarse, puede usar la herramienta [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) para hacerlo.

## URLs SAS

Una firma de acceso compartido (SAS) proporciona acceso delegado seguro a recursos en su cuenta de almacenamiento. Con un SAS, tiene un control granular sobre c√≥mo un cliente puede acceder a sus datos. Por ejemplo:

* A qu√© recursos puede acceder el cliente.
* Qu√© permisos tienen para esos recursos.
* Cu√°nto tiempo es v√°lido el SAS.

Use [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) para acceder a los datos.

### Firma de acceso compartido delegada por usuario <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puede **asegurar un token de firma de acceso compartido (SAS)** para acceder a un contenedor, directorio o blob mediante las credenciales de Azure Active Directory (Azure AD) **o una clave de cuenta**. Para crear una firma de acceso compartido delegada por usuario, primero debe solicitar una **clave de delegaci√≥n de usuario**, que luego usa para firmar la SAS.

Se admite una firma de acceso compartido delegada por usuario para **Azure Blob Storage** y **Azure Data Lake Storage Gen2**. **No se admiten pol√≠ticas de acceso almacenadas** para una firma de acceso compartido delegada por usuario.

Tenga en cuenta que la firma de acceso compartido delegada por usuario est√° **asegurada con credenciales de Azure AD en lugar de claves de cuenta de almacenamiento**. Esto evita que los clientes/aplicaciones almacenen/recuperen claves de almacenamiento para crear SAS.

### SAS de servicio

Una SAS de servicio est√° asegurada con la **clave de cuenta de almacenamiento**. Una SAS de servicio **delega el acceso a un recurso en solo uno** de los servicios de almacenamiento de Azure: almacenamiento de blobs, almacenamiento de colas, almacenamiento de tablas o archivos de Azure. La URI para una SAS de nivel de servicio consta de la URI al recurso para el que la SAS delegar√° el acceso, seguida del token SAS.

Para usar las credenciales de Azure Active Directory (Azure AD) para asegurar una SAS para un **contenedor** o **blob**, use una **SAS de delegaci√≥n de usuario**.

### SAS de cuenta

Una SAS de cuenta est√° asegurada con una de las **claves de cuenta de almacenamiento** (hay 2). Una SAS de cuenta delega el acceso a recursos en uno o m√°s de los servicios de almacenamiento. Todas las operaciones disponibles mediante una SAS de servicio o de delegaci√≥n de usuario tambi√©n est√°n disponibles mediante una SAS de cuenta.

Al crear una SAS de cuenta, puede:

* Delegar acceso a operaciones de nivel de servicio que actualmente no est√°n disponibles con una SAS espec√≠fica del servicio, como las operaciones `Get/Set Service Properties` y `Get Service Stats`.
* Delegar acceso a m√°s de un servicio en una cuenta de almacenamiento al mismo tiempo. Por ejemplo, puede delegar acceso a recursos tanto en Azure Blob Storage como en Azure Files mediante una SAS de cuenta.
* Delegar acceso a operaciones de escritura y eliminaci√≥n para contenedores, colas, tablas y recursos compartidos de archivos, que no est√°n disponibles con una SAS espec√≠fica del objeto.
* Especificar una direcci√≥n IP o un rango de direcciones IP desde las que aceptar solicitudes.
* Especificar el protocolo HTTP desde el que aceptar solicitudes (HTTPS o HTTP/HTTPS).

Una URL SAS se ve as√≠: `https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`

## Enumeraci√≥n

```powershell
# Obtener cuentas de almacenamiento
Get-AzStorageAccount | fl
# Obtener reglas para acceder a la cuenta de almacenamiento
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Obtener IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Obtener contenedores de una cuenta de almacenamiento
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Obtener blobs dentro del contenedor