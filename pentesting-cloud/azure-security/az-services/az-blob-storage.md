# Az - Blob Storage

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

[Dalla documentazione:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage √® la soluzione di **archiviazione degli oggetti di Microsoft per il cloud**. Blob storage √® ottimizzato per archiviare grandi quantit√† di dati non strutturati. I dati non strutturati sono dati che non seguono un particolare modello o definizione dei dati, come testo o dati binari.

Blob storage offre tre tipi di risorse:

* L'**account di archiviazione** (nome univoco)
* Un **contenitore** nell'account di archiviazione (cartella)
* Un **blob** in un contenitore

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Diversi tipi di archiviazione

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Accesso all'archiviazione <a href="#about-blob-storage" id="about-blob-storage"></a>

* Utilizzare i principali di Azure AD tramite **ruoli RBAC** supportati.
* **Chiavi di accesso**: Utilizzare le chiavi di accesso dell'account di archiviazione. Questo fornisce **accesso completo all'account di archiviazione**.
* **Firma di accesso condiviso** (SAS): **Limitato nel tempo** e con autorizzazioni specifiche.
* √à possibile generare un URL SAS con una **chiave di accesso** (pi√π complicato da rilevare).
* Poich√© il SAS viene generato dalla chiave di accesso, se viene rinnovato, il SAS smette di funzionare.

### Esposizione pubblica

Se "Consenti accesso pubblico al blob" √® **abilitato** (disabilitato per impostazione predefinita), √® possibile:

* Dare **accesso pubblico per la lettura dei blob** (√® necessario conoscere il nome).
* **Elencare i blob del contenitore** e **leggerli**.

### Connessione all'archiviazione

Se trovi qualsiasi **archiviazione** a cui puoi connetterti, puoi utilizzare lo strumento [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) per farlo.

## URL SAS

[Dalla documentazione:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Una firma di accesso condiviso (SAS) fornisce un accesso delegato sicuro alle risorse nel tuo account di archiviazione. Con un SAS, hai un controllo dettagliato su come un client pu√≤ accedere ai tuoi dati. Ad esempio:

* A quali risorse pu√≤ accedere il client.
* Quali autorizzazioni ha su tali risorse.
* Per quanto tempo il SAS √® valido.

Un URL SAS ha questo aspetto: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Utilizza [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) per accedere ai dati o python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Puoi **proteggere un token di firma di accesso condiviso (SAS)** per accedere a un contenitore, una directory o un blob utilizzando le **credenziali di Azure Active Directory (Azure AD) o una chiave dell'account**. Per creare un SAS di delega dell'utente, devi prima richiedere una **chiave di delega dell'utente**, che poi utilizzi per firmare il SAS.

Il supporto √® fornito per un **User Delegation Shared Access Signature (SAS)** sia in **Azure Blob Storage** che in **Azure Data Lake Storage Gen2**. Tuttavia, √® importante notare che le **Stored Access Policies** non sono compatibili con un SAS di delega dell'utente.

Nota che il SAS di delega dell'utente √® **protetto con le credenziali di Azure AD invece delle chiavi dell'account di archiviazione**. Ci√≤ impedisce ai clienti/applicazioni di memorizzare/recuperare le chiavi di archiviazione per creare SAS.

### SAS del servizio

Un SAS del servizio √® protetto con la **chiave dell'account di archiviazione**. Un SAS del servizio **delega l'accesso a una risorsa in uno solo** dei servizi di archiviazione di Azure: Blob storage, Queue storage, Table storage o Azure Files. L'URI per un SAS a livello di servizio √® composto dall'URI alla risorsa per la quale il SAS delega l'accesso, seguito dal token SAS.

Per utilizzare le credenziali di Azure Active Directory (Azure AD) per proteggere un SAS per un **contenitore** o un **blob**, utilizza un **SAS di delega dell'utente**.

### SAS dell'account

Un SAS dell'account √® protetto con una delle **chiavi dell'account di archiviazione** (ce ne sono 2). Un SAS dell'account delega l'accesso alle risorse in uno o pi√π dei servizi di archiviazione. Tutte le operazioni disponibili tramite un SAS del servizio o di delega dell'utente sono disponibili anche tramite un SAS dell'account.

[dalla documentazione:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Creando un SAS dell'account, puoi:

* Delegare l'accesso a operazioni a livello di servizio che attualmente non sono disponibili con un SAS specifico del servizio, come le operazioni `Get/Set Service Properties` e `Get Service Stats`.
* Delegare l'accesso a pi√π di un servizio in un account di archiviazione contemporaneamente. Ad esempio, puoi delegare l'accesso alle risorse sia in Azure Blob Storage che in Azure Files utilizzando un SAS dell'account.
* Delegare l'accesso alle operazioni di scrittura e cancellazione per contenitori, code, tabelle e condivisioni di file, che non sono disponibili con un SAS specifico dell'oggetto.
* Specificare un indirizzo IP o un intervallo di indirizzi IP da cui accettare le richieste.
* Specificare il protocollo HTTP da cui accettare le richieste (HTTPS o HTTP/HTTPS).

## Enumerazione

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
Il seguente codice PowerShell pu√≤ essere utilizzato per ottenere informazioni sullo storage blob di Azure:

```powershell
# Installa il modulo Az.Storage
Install-Module -Name Az.Storage -Force

# Imposta le credenziali di accesso
$storageAccountName = "nome_account_storage"
$storageAccountKey = "chiave_account_storage"
$context = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey

# Ottieni le informazioni sullo storage blob
$blobContainerName = "nome_container_blob"
$blobName = "nome_blob"
$blob = Get-AzStorageBlob -Context $context -Container $blobContainerName -Blob $blobName

# Stampa le informazioni sullo storage blob
$blob | Select-Object Name, BlobType, Length, LastModified
```
{% endcode %}
{% endtab %}

{% tab title="Az CLI" %}
{% code overflow="wrap" %}
Il seguente comando Az CLI pu√≤ essere utilizzato per ottenere informazioni sullo storage blob di Azure:

```bash
# Imposta le credenziali di accesso
storageAccountName="nome_account_storage"
storageAccountKey="chiave_account_storage"
export AZURE_STORAGE_ACCOUNT=$storageAccountName
export AZURE_STORAGE_KEY=$storageAccountKey

# Ottieni le informazioni sullo storage blob
blobContainerName="nome_container_blob"
blobName="nome_blob"
az storage blob show --container-name $blobContainerName --name $blobName --output table
```
{% endcode %}
{% endtab %}
{% endtabs %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Riferimenti

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
