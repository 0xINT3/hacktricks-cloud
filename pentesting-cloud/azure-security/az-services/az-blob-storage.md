# Az - Blob Storage

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或在 **Twitter** 上 **关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

Azure Blob 存储是 Microsoft 的云端对象**存储解决方案**。Blob 存储专为存储大量非结构化数据进行了优化。非结构化数据是指不符合特定数据模型或定义的数据，例如文本或二进制数据。

Blob 存储提供三种类型的资源：

* **存储帐户**（唯一名称）
* 存储帐户中的**容器**（文件夹）
* 容器中的** Blob**

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### 不同类型的存储

| **Blob 存储**                   | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake 存储 Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **队列存储**                   | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **表存储**                     | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### 访问存储 <a href="#about-blob-storage" id="about-blob-storage"></a>

* 使用 Azure AD 主体通过支持的**RBAC 角色**。
* **访问密钥**：使用存储帐户的访问密钥。这提供对存储帐户的**完全访问权限**。
* **共享访问签名**（SAS）：时间**有限**且具有特定权限。
* 您可以使用访问密钥生成 SAS URL（更难检测）。

### 公开暴露

如果“允许 Blob 公开访问”已**启用**（默认禁用），则可能：

* 公开访问以读取 Blob（需要知道名称）。
* **列出容器 Blob** 并对其进行读取。

### 连接到存储

如果您找到任何**存储**，您可以使用工具 [**Microsoft Azure 存储资源管理器**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) 进行连接。

## SAS URL

共享访问签名（SAS）提供对存储帐户中资源的安全委派访问。使用 SAS，您可以对客户端访问数据的方式进行细粒度控制。例如：

* 客户端可以访问哪些资源。
* 他们对这些资源拥有什么权限。
* SAS 的有效期是多长时间。

SAS URL 的格式如下：**`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

使用 [**存储资源管理器**](https://azure.microsoft.com/en-us/features/storage-explorer/) 访问数据或使用 Python：

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### 用户委派 SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

您可以使用 Azure Active Directory (Azure AD) 凭据或帐户密钥来创建用户委派 SAS，以便访问容器、目录或 Blob。要创建用户委派 SAS，您必须首先请求一个用户委派密钥，然后使用该密钥对 SAS 进行签名。

用户委派 SAS 支持 Azure Blob 存储和 Azure Data Lake 存储 Gen2。用户委派 SAS 不支持存储访问策略。

请注意，用户委派 SAS 使用 Azure AD 凭据进行安全保护，而不是存储帐户密钥。这样可以防止客户端/应用程序存储/检索存储密钥以创建 SAS。

### 服务 SAS

服务 SAS 使用存储帐户密钥进行安全保护。服务 SAS 仅委派对 Azure 存储服务中的一个资源的访问权限：Blob 存储、队列存储、表存储或 Azure 文件。服务级 SAS 的 URI 由将委派访问权限的 SAS 令牌之后的资源的 URI 组成。

要使用 Azure Active Directory (Azure AD) 凭据为容器或 Blob 安全地创建 SAS，请使用用户委派 SAS。

### 帐户 SAS

帐户 SAS 使用其中一个存储帐户密钥（共有 2 个）进行安全保护。帐户 SAS 委派对一个或多个存储服务中的资源的访问权限。通过服务或用户委派 SAS 可用的所有操作也可通过帐户 SAS 进行。

通过创建帐户 SAS，您可以：

* 委派对目前无法使用特定于服务的 SAS 进行的服务级操作的访问权限，例如 `Get/Set Service Properties` 和 `Get Service Stats` 操作。
* 委派同时访问存储帐户中多个服务的权限。例如，您可以使用帐户 SAS 委派对 Azure Blob 存储和 Azure 文件中的资源进行访问。
* 委派对容器、队列、表和文件共享的写入和删除操作的访问权限，这是对象特定 SAS 不可用的。
* 指定要接受请求的 IP 地址或 IP 地址范围。
* 指定要接受请求的 HTTP 协议（HTTPS 或 HTTP/HTTPS）。

## 枚举

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## 参考资料

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
