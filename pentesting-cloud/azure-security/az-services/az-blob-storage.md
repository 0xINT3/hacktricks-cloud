# Az - Blob Berging

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

[Van die dokumentasie:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob-berging is Microsoft se objek **bergingoplossing vir die wolk**. Blob-berging is geoptimaliseer vir die berging van massiewe hoeveelhede ongestruktureerde data. Ongestruktureerde data is data wat nie aan 'n spesifieke data-model of -definisie voldoen nie, soos teks- of bin√™re data.

Blob-berging bied drie tipes hulpbronne:

* Die **bergingrekening** (unieke naam)
* 'n **Houer** in die bergingsrekening (gids)
* 'n **Blob** in 'n houer

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Verskillende tipes berging

| **Blob-berging**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue-berging**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table-berging**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Toegang tot Berging <a href="#about-blob-storage" id="about-blob-storage"></a>

* Gebruik Azure AD-prinsipale via **RBAC-rolle** wat ondersteun word.
* **Toegangssleutels**: Gebruik toegangssleutels van die bergingsrekening. Dit bied **volle toegang tot die bergingsrekening**.
* **Gedeelde Toegangshandtekening** (SAS): **Tyd** **beperk** en spesifieke toestemmings.
* Jy kan 'n SAS-url genereer met 'n **toegangssleutel** (meer ingewikkeld om op te spoor).
* Aangesien die SAS gegenereer word vanuit die toegangssleutel, as dit hernu word, hou die SAS op om te werk.

### Openbare Blootstelling

As "Allow Blob public access" **ingeskakel** is (standaard uitgeschakel), is dit moontlik om:

* Gee **openbare toegang om blobs te lees** (jy moet die naam weet).
* **Lys houerblokke** en **lees** hulle.

### Koppel aan Berging

As jy enige **berging** vind waaraan jy kan koppel, kan jy die instrument [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) gebruik om dit te doen.

## SAS-URL's

[Van die dokumentasie:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) 'n Gedeelde toegangshandtekening (SAS) bied veilige gedelegeerde toegang tot hulpbronne in jou bergingsrekening. Met 'n SAS het jy fyn beheer oor hoe 'n kli√´nt toegang tot jou data kan verkry. Byvoorbeeld:

* Watter hulpbronne die kli√´nt mag benader.
* Watter toestemmings hulle het vir daardie hulpbronne.
* Hoe lank die SAS geldig is.

'N SAS-URL lyk soos dit: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Gebruik [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) om toegang tot die data te verkry of python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### Gebruikersdelegasie SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Jy kan **'n gedeelde toegangshandtekening (SAS)** token beveilig vir toegang tot 'n houer, gids of blob deur gebruik te maak van Azure Active Directory (Azure AD) **volmaggings of 'n rekening sleutel**. Om 'n gebruikersdelegasie SAS te skep, moet jy eers 'n **gebruikersdelegasie sleutel** aanvra, wat jy dan gebruik om die SAS te onderteken.

Ondersteuning word verskaf vir 'n **Gebruikersdelegasie Gedeelde Toegangshandtekening (SAS)** in beide **Azure Blob Storage** en **Azure Data Lake Storage Gen2**. Dit is egter belangrik om daarop te let dat **Opgeslaan Toegangbeleide** nie verenigbaar is met 'n Gebruikersdelegasie SAS nie.

Let daarop dat 'n gebruikersdelegasie SAS **beveilig is met Azure AD volmaggings in plaas van stoorrekening sleutels**. Dit voorkom dat kli√´nte/toepassings stoorrekening sleutels stoor/opvra om SAS te skep.

### Diens SAS

'n Diens SAS is beveilig met die **stoorrekening sleutel**. 'n Diens SAS **delegeer toegang tot 'n hulpbron in slegs een** van die Azure Stoor Dienste: Blob stoor, Queue stoor, Tabel stoor, of Azure L√™ers. Die URI vir 'n diensvlak SAS bestaan uit die URI na die hulpbron waarvoor die SAS toegang sal delegeer, gevolg deur die SAS token.

Om Azure Active Directory (Azure AD) volmaggings te gebruik om 'n SAS te beveilig vir 'n **houer** of **blob**, gebruik 'n **gebruikersdelegasie SAS**.

### Rekening SAS

'n Rekening SAS is beveilig met een van die **stoorrekening sleutels** (daar is 2). 'n Rekening SAS delegeer toegang tot hulpbronne in een of meer van die stoor dienste. Al die operasies wat beskikbaar is via 'n diens of gebruikersdelegasie SAS is ook beskikbaar via 'n rekening SAS.

[van die dokumentasie:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Deur 'n rekening SAS te skep, kan jy:

* Toegang tot diensvlak operasies delegeer wat tans nie beskikbaar is met 'n diens-spesifieke SAS nie, soos die `Get/Set Service Properties` en `Get Service Stats` operasies.
* Toegang tot meer as een diens in 'n stoorrekening op 'n slag delegeer. Byvoorbeeld, jy kan toegang tot hulpbronne in beide Azure Blob Storage en Azure L√™ers delegeer deur 'n rekening SAS te gebruik.
* Skryf- en verwyderingsoperasies vir houers, rye, tabelle en l√™er-aandele delegeer, wat nie beskikbaar is met 'n objek-spesifieke SAS nie.
* 'n IP-adres of 'n reeks IP-adresse spesifiseer waarvandaan versoek aanvaar moet word.
* Die HTTP-protokol spesifiseer waarvandaan versoek aanvaar moet word (of HTTPS of HTTP/HTTPS).

## Opname

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Verwysings

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy in HackTricks wil adverteer** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
