# Az - Blob Storage

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-overview) Azure Blob storage je Microsoft-ovo objektno **rešenje za skladištenje u oblaku**. Blob storage je optimizovan za skladištenje ogromnih količina nestrukturiranih podataka. Nestrukturirani podaci su podaci koji se ne pridržavaju određenog modela ili definicije, kao što su tekstualni ili binarni podaci.

Blob storage nudi tri vrste resursa:

* **Storage account** (jedinstveno ime)
* **Container** u storage account-u (folder)
* **Blob** u kontejneru

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

### Različite vrste skladištenja

| **Blob storage**                 | <p><code>https://&#x3C;storage-account>.blob.core.windows.net</code><br><br><code>https://&#x3C;stg-acc>.blob.core.windows.net/&#x3C;container-name>?restype=container&#x26;comp=list</code></p> |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Azure Data Lake Storage Gen2** | `https://<storage-account>.dfs.core.windows.net`                                                                                                                                                 |
| **Azure Files**                  | `https://<storage-account>.file.core.windows.net`                                                                                                                                                |
| **Queue storage**                | `https://<storage-account>.queue.core.windows.net`                                                                                                                                               |
| **Table storage**                | `https://<storage-account>.table.core.windows.net`                                                                                                                                               |

### Pristup skladištu <a href="#about-blob-storage" id="about-blob-storage"></a>

* Koristite Azure AD principe putem podržanih **RBAC uloga**.
* **Pristupni ključevi**: Koristite pristupne ključeve storage account-a. Ovo omogućava **puni pristup storage account-u**.
* **Shared Access Signature** (SAS): **Vremenski ograničen** i sa specifičnim dozvolama.
* Možete generisati SAS URL sa **pristupnim ključem** (teže otkriti).
* Pošto se SAS generiše iz pristupnog ključa, ako se ključ obnovi, SAS prestaje da radi.

### Javno izlaganje

Ako je "Allow Blob public access" **omogućeno** (po defaultu onemogućeno), moguće je:

* Dati **javni pristup za čitanje blob-ova** (morate znati ime).
* **Izlistati blob-ove kontejnera** i **čitati** ih.

### Povezivanje sa skladištem

Ako pronađete bilo koje **skladište** sa kojim možete da se povežete, možete koristiti alatku [**Microsoft Azure Storage Explorer**](https://azure.microsoft.com/es-es/products/storage/storage-explorer/) za to.

## SAS URL-ovi

[Iz dokumentacije:](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview) Shared access signature (SAS) pruža siguran delegirani pristup resursima u vašem storage account-u. Sa SAS-om, imate detaljnu kontrolu nad tim kako klijent može pristupiti vašim podacima. Na primer:

* Koje resurse klijent može pristupiti.
* Koje dozvole imaju za te resurse.
* Koliko dugo je SAS validan.

SAS URL izgleda ovako: **`https://<container_name>.blob.core.windows.net/newcontainer?sp=r&st=2021-09-26T18:15:21Z&se=2021-10-27T02:14:21Z&spr=https&sv=2021-07-08&sr=c&sig=7S%2BZySOgy4aA3Dk0V1cJyTSIf1cW%2Fu3WFkhHV32%2B4PE%3D`**

Koristite [**Storage Explorer**](https://azure.microsoft.com/en-us/features/storage-explorer/) za pristup podacima ili python:

{% code overflow="wrap" %}
```python
#pip3 install azure-storage-blob
from azure.storage.blob import BlobServiceClient

# List containers
conn_str="<SAS URL>"
svc = BlobServiceClient.from_connection_string(conn_str=conn_str)
for c in svc.list_containers():
print(c['name']

# List blobs inside conteiner
container = svc.get_container_client(container="<container_name>")
for b in container.list_blobs():
print(b['name']

# Download file
blob = svc.get_blob_client(container="<container_name>",blob="<blob_name>")
with open("download.out","wb") as f:
f.write(blob.download_blob().readall())
```
{% endcode %}

### User delegation SAS <a href="#user-delegation-sas" id="user-delegation-sas"></a>

Možete **zaštititi zajednički pristupni potpis (SAS)** token za pristup kontejneru, direktorijumu ili blobu koristeći Azure Active Directory (Azure AD) **poverenice ili ključ naloga**. Da biste kreirali korisnički potpis SAS, prvo morate zatražiti **ključ za poverenje korisnika**, koji zatim koristite za potpisivanje SAS.

Podrška je obezbeđena za **User Delegation Shared Access Signature (SAS)** kako u **Azure Blob Storage** tako i u **Azure Data Lake Storage Gen2**. Međutim, važno je napomenuti da **Stored Access Policies** nisu kompatibilne sa User Delegation SAS.

Imajte na umu da je korisnički potpis SAS **zaštićen Azure AD poverenicama umesto ključevima naloga za skladištenje**. Ovo sprečava klijente/aplikacije da skladište/dobavljaju ključeve za skladištenje kako bi kreirali SAS.

### Service SAS

Service SAS je zaštićen sa **ključem naloga za skladištenje**. Service SAS **delegira pristup resursu samo jednoj** od Azure Storage usluga: Blob storage, Queue storage, Table storage ili Azure Files. URI za SAS na nivou usluge sastoji se od URI-ja do resursa za koji će SAS delegirati pristup, a zatim slijedi SAS token.

Da biste koristili Azure Active Directory (Azure AD) poverenice za zaštitu SAS za **kontejner** ili **blob**, koristite **korisnički potpis SAS**.

### Account SAS

Account SAS je zaštićen jednim od **ključeva naloga za skladištenje** (postoje 2). Account SAS delegira pristup resursima u jednoj ili više usluga skladištenja. Sve operacije dostupne putem SAS na nivou usluge ili korisničkog potpisa SAS takođe su dostupne putem account SAS.

[iz dokumentacije:](https://learn.microsoft.com/en-us/rest/api/storageservices/create-account-sas) Kreiranjem account SAS-a možete:

* Delegirati pristup operacijama na nivou usluge koje trenutno nisu dostupne sa specifičnim SAS-om za uslugu, kao što su operacije `Get/Set Service Properties` i `Get Service Stats`.
* Delegirati pristup više od jedne usluge u jednom skladišnom nalogu. Na primer, možete delegirati pristup resursima kako u Azure Blob Storage tako i u Azure Files koristeći account SAS.
* Delegirati pristup operacijama pisanja i brisanja za kontejnere, redove, tabele i deljenje fajlova, koje nisu dostupne sa objektno-specifičnim SAS-om.
* Odrediti IP adresu ili opseg IP adresa iz kojih će se prihvatati zahtevi.
* Odrediti HTTP protokol iz kojeg će se prihvatati zahtevi (HTTPS ili HTTP/HTTPS).

## Enumeracija

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# Get keys to authenticate
az storage account keys list --account-name <name>

# Get shares
az storage share list --account-name <name> --account-key <key>

# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name> --account-key <key>
## If type is "dir", you can continue enumerationg files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name> --account-key <key>

# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name> --account-key <key>
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
{% code overflow="wrap" %}
```powershell
# Get storage accounts
Get-AzStorageAccount | fl
# Get rules to access the storage account
Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet
# Get IPs
(Get-AzStorageAccount | select -ExpandProperty NetworkRuleSet).IPRules
# Get containers of a storage account
Get-AzStorageContainer -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context
# Get blobs inside container
Get-AzStorageBlob -Container epbackup-planetary -Context (Get-AzStorageAccount -name <name> -ResourceGroupName <name>).context
# Get a blob from a container
Get-AzStorageBlobContent -Container <NAME> -Context (Get-AzStorageAccount -name <NAME> -ResourceGroupName <NAME>).context -Blob <blob_name> -Destination .\Desktop\filename.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Reference

* [https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction](https://learn.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction)
* [https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview](https://learn.microsoft.com/en-us/azure/storage/common/storage-sas-overview)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
