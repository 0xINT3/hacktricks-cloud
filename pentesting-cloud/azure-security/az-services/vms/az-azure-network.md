# Az - Azure 网络

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

- 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
- 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

Azure 中的网络作为其云计算平台的一个重要组成部分，实现了**连接和通信各种 Azure 服务和资源**。Azure 的网络架构旨在具有高度可扩展性、安全性和可定制性。

在核心层，Azure 提供了一个允许用户在 Azure 云中创建**隔离的虚拟网络（VNet）**的功能。在这些 VNet 中，用户可以安全地托管和管理资源，如虚拟机、应用程序和数据库。Azure 中的网络支持云内通信（Azure 服务之间）以及与外部网络和互联网的连接。

**安全性**是 Azure 网络的一个关键方面，提供了各种工具和服务来保护数据、管理访问权限并确保合规性。这些安全措施包括**防火墙**、**网络安全组**和**加密**功能，允许对流量和访问进行高级别控制。

总体而言，Azure 的网络功能旨在提供灵活性，使用户能够创建符合其特定应用程序和工作负载需求的网络环境，同时保持对安全性和可靠性的重视。

## 虚拟网络（VNET）和子网

Azure 中的 VNet 本质上是您在云中的网络的表示。它是专门为您的订阅**提供的 Azure 云的逻辑隔离**。VNet 允许您在 Azure 中配置和管理虚拟专用网络（VPN），并可用于托管和**管理多种类型的 Azure 资源**，如虚拟机（VM）、数据库和应用服务。

VNet 为您提供了对网络设置的**完全控制**，包括**IP 地址**范围、子网创建、路由表和网络网关。

**子网**是您 VNet 中的**一系列 IP 地址**。您可以将 VNet 划分为多个子网以进行组织和安全性。VNet 中的每个子网可用于根据您的网络和应用程序架构对资源进行隔离和分组。

此外，子网允许您**将 VNet 划分为一个或多个子网络**，提供资源可以使用的 IP 地址范围。

### **示例**

- 假设您有一个名为 `MyVNet` 的 VNet，具有 IP 地址范围为 `10.0.0.0/16`。您可以在此 VNet 中创建一个子网，比如 `Subnet-1`，其 IP 地址范围为 `10.0.0.0/24`，用于托管您的 Web 服务器。另一个子网 `Subnet-2`，其范围为 `10.0.1.0/24`，可用于您的数据库服务器。这种划分允许在网络内进行高效管理和安全控制。

### 枚举

要列出 Azure 帐户中的所有 VNet 和子网，您可以使用 Azure 命令行界面（CLI）。以下是操作步骤：

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
{% endcode %}

## 网络安全组（NSG）

在Azure中，**网络安全组（NSG）**的主要功能是过滤Azure虚拟网络（VNet）内Azure资源的网络流量。它包含一组**安全规则**，精细地规定了网络流量的流向。

NSG的关键方面包括：

* **流量控制**：每个NSG包含的规则对于允许或阻止与各种Azure资源相关的入站和出站网络流量至关重要。
* **规则组成**：NSG内的规则非常具体，根据诸如源/目标IP地址、端口和协议等标准过滤流量。这种特定性允许对网络流量进行细粒度管理。
* **安全增强**：通过确保只有经授权的流量可以进入或离开您的Azure资源，NSG在加固网络基础设施的安全姿态方面发挥着关键作用。

### **示例**

* 假设您有一个名为`MyNSG`的NSG应用于VNet内的子网或特定虚拟机。您可以创建如下规则：
* 一个入站规则，允许来自任何源的HTTP流量（端口80）到达您的Web服务器。
* 一个出站规则，仅允许SQL流量（端口1433）到达特定目标IP地址范围。

### 枚举

{% code overflow="wrap" %}
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table
```
{% endcode %}

## Azure防火墙

Azure防火墙是一项托管的基于云的**网络安全服务，用于保护您的Azure虚拟网络资源**。它是一个具有内置高可用性和可扩展性功能的完全有状态的防火墙服务。

Azure防火墙提供比**NSG**更**高级**的功能，包括应用程序级过滤、网络级过滤、基于威胁情报的过滤，以及与Azure Monitor集成以进行日志记录和分析。\
它可以过滤出站、入站、辐射到辐射、VPN和ExpressRoute流量。**防火墙规则可以基于FQDN（完全限定域名）、IP地址和端口创建**。

### Azure防火墙与NSG之间的区别

1. **范围:**
* **NSG:** 在子网或网络接口级别工作。它旨在为网络接口（NIC）、虚拟机或子网的入站和出站流量提供基本过滤。
* **Azure防火墙:** 在VNet级别运行，提供更广泛的保护范围。它旨在保护您的虚拟网络资源并管理流入和流出VNet的流量。
2. **功能:**
* **NSG:** 基于IP地址、端口和协议提供基本过滤功能。它不支持应用程序级别检查或威胁情报等高级功能。
* **Azure防火墙:** 提供高级功能，如应用程序级（第7层）流量过滤、基于威胁情报的过滤、网络流量过滤等。它还支持多个公共IP地址。
3. **用例:**
* **NSG:** 适用于基本的网络级流量过滤。
* **Azure防火墙:** 适用于需要应用程序级控制、日志记录和威胁情报的更复杂过滤场景。
4. **管理和监控:**
* **NSG:** 提供基本日志记录和与Azure Monitor的集成。
* **Azure防火墙:** 通过Azure Monitor提供高级日志记录和分析功能，这对于了解流量的性质和模式至关重要。

### 枚举

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
{% endcode %}

## 网络虚拟设备（NVA）

在Azure中，网络虚拟设备（**NVA**）是一种在虚拟网络中执行网络功能的虚拟设备。NVA通常用于Azure中**本身不具备的网络功能**，或者需要更多定制化的情况。它们本质上是**运行网络应用程序或服务的虚拟机**，例如防火墙、WAN优化器或负载均衡器。

NVA用于复杂的路由、**安全性**和**网络流量管理**任务。它们可以从Azure **Marketplace**部署，许多第三方供应商在那里提供其准备好用于集成到Azure环境中的设备。

### **示例**

* 一个组织可以在Azure中部署一个NVA来创建一个**自定义防火墙解决方案**。这个NVA可以运行**第三方防火墙软件**，提供高级功能，如入侵检测、数据包检查或VPN连接。可以配置NVA来检查和过滤通过它的流量，确保根据组织政策实施增强的安全措施。

### **枚举**

{% code overflow="wrap" %}
```bash
# Usually NVAs are named or tagged in a way to distinguish them from other VMs
az vm list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# For a specific VM identified as an NVA, list its network interfaces
az vm nic list --vm-name <VMName> --resource-group <ResourceGroupName> --query "[].{id:id}" -o table
```
## Azure路由表和用户定义路由（UDR）

**Azure路由表**是Microsoft Azure中的一个功能，允许在Azure虚拟网络（VNets）内控制网络流量路由。基本上，它们定义了在VNets内部子网、VNets之间或外部网络之间如何转发**数据包**。每个路由表包含一组规则，称为路由，这些规则根据其目标IP地址指定应如何路由数据包。

在Azure中，**用户定义路由（UDR）**是您在Azure路由表中创建的**自定义路由**，用于控制Azure虚拟网络（VNets）内部和之间以及与外部连接之间的**网络流量流动**。UDR使您能够根据特定需求指定网络流量的方向，覆盖Azure的默认路由决策。

这些路由特别适用于需要**通过虚拟设备路由流量**、强制执行特定的安全路径或策略合规性，或与本地网络集成的情况。

### **示例**

* 假设您部署了一个用于检查VNet内子网之间流量的网络虚拟设备（NVA）。您可以创建一个UDR，将一个子网到另一个子网的所有流量定向通过NVA。这个UDR确保NVA在流量到达目的地之前对其进行安全检查。

### **枚举**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List UDRs for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure私有链接

Azure私有链接是Azure中的一项服务，通过确保**Azure虚拟网络（VNet）与服务之间的流量完全在Microsoft的Azure骨干网络内传输**，从而**实现对Azure服务的私有访问**。它有效地将服务引入到您的VNet中。这种设置通过不将数据暴露给公共互联网来增强安全性。

私有链接可与各种Azure服务一起使用，如Azure存储、Azure SQL数据库以及通过私有链接共享的自定义服务。它提供了一种安全的方式来从您自己的VNet或甚至来自不同Azure订阅中消费服务。

{% hint style="danger" %}
NSG不适用于私有端点，这明确意味着将NSG与包含私有链接的子网关联将不会产生任何效果。
{% endhint %}

### **示例**

* 假设您有一个**Azure SQL数据库，希望从您的VNet安全访问**。通常，这可能涉及通过公共互联网进行传输。使用私有链接，您可以在您的VNet中创建一个**私有端点**，直接连接到Azure SQL数据库服务。这个端点使数据库看起来好像是您自己VNet的一部分，可以通过私有IP地址访问，从而确保安全和私密访问。

### **枚举**

{% code overflow="wrap" %}
```bash
# List Private Link Services
z network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
## Azure服务终结点

Azure服务终结点扩展了您的虚拟网络私有地址空间和VNet的身份，使其通过直接连接与Azure服务相连。通过启用服务终结点，**您的VNet中的资源可以安全地连接到Azure服务**，如Azure存储和Azure SQL数据库，使用Azure的骨干网络。这确保了**从VNet到Azure服务的流量保持在Azure网络内**，提供了更安全和可靠的路径。

### **示例**

* 例如，默认情况下，**Azure存储**帐户可以通过公共互联网访问。通过在您的VNet中为Azure存储启用**服务终结点**，您可以确保只有来自您的VNet的流量可以访问存储帐户。然后可以配置存储帐户防火墙，仅接受来自您的VNet的流量。

### **枚举**

{% code overflow="wrap" %}
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
### 服务端点和私有链接之间的区别

微软建议在[**文档**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints)中使用私有链接：\\

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**服务端点:**

* 从您的虚拟网络到Azure服务的流量经过Microsoft Azure骨干网络，绕过公共互联网。
* 端点是与Azure服务的直接连接，并不为VNet内的服务提供私有IP。
* 除非配置服务防火墙阻止此类流量，否则服务本身仍可通过其公共端点从VNet外部访问。
* 子网与Azure服务之间是一对一的关系。
* 比私有链接更便宜。

**私有链接:**

* 私有链接通过私有端点将Azure服务映射到您的VNet中，私有端点是具有VNet内私有IP地址的网络接口。
* 使用此私有IP地址访问Azure服务，使其看起来像是您网络的一部分。
* 通过私有链接连接的服务只能从您的VNet或连接的网络访问；服务无法通过公共互联网访问。
* 它实现了与Azure服务或托管在Azure中的您自己的服务的安全连接，以及与他人共享的服务的连接。
* 通过VNet中的私有端点提供更精细的访问控制，而不是通过服务端点在子网级别提供更广泛的访问控制。

总之，虽然服务端点和私有链接都提供了与Azure服务的安全连接，**私有链接通过确保服务在不暴露给公共互联网的情况下私下访问，提供了更高级别的隔离和安全性**。另一方面，服务端点更容易设置，适用于一般情况下需要对Azure服务进行简单、安全访问而无需在VNet中使用私有IP的情况。

## Azure前端门 (AFD) & AFD WAF

**Azure前端门**是全球网络应用的可扩展和安全入口点，用于**快速交付**。它将全球**负载平衡、站点加速、SSL卸载和Web应用程序防火墙 (WAF)**等各种服务**结合**到一个服务中。Azure前端门根据用户**最近的边缘位置**提供智能路由，确保最佳性能和可靠性。此外，它提供基于URL的路由、多站点托管、会话亲和性和应用层安全性。

**Azure前端门WAF**旨在**保护Web应用程序免受基于Web的攻击**，无需修改后端代码。它包括自定义规则和托管规则集，以保护免受SQL注入、跨站脚本和其他常见攻击等威胁。

### **示例**

* 假设您有一个全球分布的应用程序，用户遍布全球。您可以使用Azure前端门将用户请求路由到托管应用程序的最近区域数据中心，从而减少延迟，提高用户体验，并使用WAF功能**防御Web攻击**。如果特定区域出现停机，Azure前端门可以自动将流量重新路由到下一个最佳位置，确保高可用性。

### 枚举

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
{% endcode %}

## Azure 应用程序网关和 Azure 应用程序网关 WAF

Azure 应用程序网关是一个**Web 流量负载均衡器**，可帮助您管理对您的**Web**应用程序的流量。它在应用交付控制器 (ADC) 中作为服务提供**第 7 层负载平衡、SSL 终止和 Web 应用程序防火墙 (WAF) 功能**。关键功能包括基于 URL 的路由、基于 cookie 的会话关联以及安全套接字层 (SSL) 卸载，这对于需要复杂负载平衡功能的应用程序（如全局路由和基于路径的路由）至关重要。

### 示例

* 假设您有一个包含多个子域用于不同功能的电子商务网站，比如用户账户和支付处理。Azure 应用程序网关可以**根据 URL 路径将流量路由到适当的 Web 服务器**。例如，`example.com/accounts` 的流量可以被定向到用户账户服务，而 `example.com/pay` 的流量可以被定向到支付处理服务。\
并且**利用 WAF 功能保护您的网站免受攻击**。

### **枚举**

{% code overflow="wrap" %}
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
{% endcode %}

## Azure Hub, Spoke & VNet Peering

**VNet Peering**是Azure中的一项网络功能，**允许不同的虚拟网络（VNets）直接和无缝地连接**。通过VNet Peering，一个VNet中的资源可以使用私有IP地址与另一个VNet中的资源通信，**就好像它们在同一个网络中一样**。\
**VNet Peering也可以与本地网络一起使用**，方法是建立站点到站点VPN或Azure ExpressRoute。

**Azure Hub和Spoke**是Azure中使用的网络拓扑，用于管理和组织网络流量。**“中心”是一个控制和路由不同“辐射”之间流量的中心点**。中心通常包含共享服务，如网络虚拟设备（NVAs）、Azure VPN网关、Azure防火墙或Azure堡垒机。**“辐射”是承载工作负载并使用VNet Peering连接到中心的VNets**，使它们能够利用中心内的共享服务。这种模型促进了清晰的网络布局，通过集中多个VNets中多个工作负载可以使用的共同服务，从而减少了复杂性。

{% hint style="danger" %}
**Azure中的VNET配对是非传递的**，这意味着如果辐射1连接到辐射2，辐射2连接到辐射3，那么辐射1无法直接与辐射3通信。
{% endhint %}

### 例子

* 想象一个拥有销售、人力资源和开发等不同部门的公司，**每个部门都有自己的VNet（辐射）**。这些VNets **需要访问共享资源**，如中央数据库、防火墙和互联网网关，这些资源都位于**另一个VNet（中心）**中。通过使用中心和辐射模型，每个部门可以**通过中心VNet安全地连接到共享资源，而无需将这些资源暴露给公共互联网**或创建具有大量连接的复杂网络结构。

### 枚举

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
{% endcode %}

## 站点到站点 VPN

Azure中的站点到站点VPN允许您**将您的本地网络连接到Azure虚拟网络（VNet）**，使Azure中的VM等资源看起来好像在您的本地网络上一样。这种连接是通过**VPN网关建立的，用于加密**两个网络之间的流量。

### **示例**

* 位于纽约的主办办公室的企业拥有一个需要与Azure中的VNet安全连接的本地数据中心，该数据中心托管其虚拟化工作负载。通过设置**站点到站点VPN，公司可以确保本地服务器和Azure VM之间的加密连接**，允许资源在两个环境中安全访问，就好像它们在同一个本地网络中一样。

### **枚举**

{% code overflow="wrap" %}
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
{% endcode %}

## Azure ExpressRoute

Azure ExpressRoute是一项服务，提供了**在您的本地基础设施和Azure数据中心之间的私人、专用、高速连接**。通过连接提供商进行连接，绕过公共互联网，提供比典型互联网连接更可靠、更快速、延迟更低、安全性更高的服务。

### **示例**

* 一家跨国公司需要**与Azure服务保持一致可靠的连接，因为数据量大**，需要高吞吐量。该公司选择Azure ExpressRoute直接连接其本地数据中心到Azure，促进大规模数据传输，如每日备份和实时数据分析，具有增强的隐私性和速度。

### **枚举**

{% code overflow="wrap" %}
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
{% endcode %}

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
