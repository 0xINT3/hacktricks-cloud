# Az - Azure 网络

<details>

<summary><strong>从零开始学习 AWS 黑客技术直到成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

Azure 内的网络作为其云计算平台的一个不可或缺的部分，使得**各种 Azure 服务和资源之间的连接和通信**成为可能。Azure 中的网络架构旨在高度可扩展、安全和可定制。

Azure 的核心是提供一个**虚拟网络 (VNet)**，允许用户在 Azure 云中创建**隔离的** **网络**。在这些 VNets 中，可以安全地托管和管理诸如虚拟机、应用程序和数据库等资源。Azure 的网络支持云内（Azure 服务之间）的通信以及与外部网络和互联网的连接。

**安全性**是 Azure 网络的关键方面，提供了各种工具和服务来保护数据、管理访问和确保合规。这些安全措施包括**防火墙**、**网络安全组**和**加密**功能，允许对流量和访问进行高度控制。

总体而言，Azure 的网络功能旨在提供灵活性，允许用户创建适合其特定应用程序和工作负载需求的网络环境，同时保持对安全性和可靠性的强调。

## 虚拟网络 (VNET) 和子网

Azure 中的 VNet 本质上是您在云中自己网络的表示。它是 Azure 云中专属于您订阅的**逻辑隔离**。VNet 允许您在 Azure 中配置和管理虚拟私有网络 (VPNs)，并可用于托管和**管理多种类型的 Azure 资源**，例如虚拟机 (VMs)、数据库和应用程序服务。

VNets 为您提供了对网络设置的**完全控制**，包括**IP 地址**范围、子网创建、路由表和网络网关。

**子网**是您 VNet 中的**一系列 IP 地址**。您可以将 VNet 划分为多个子网，以便于组织和安全。VNet 中的每个子网都可以用来隔离和分组资源，以符合您的网络和应用程序架构。

此外，子网允许您**将 VNet 分割成一个或多个子网络**，提供资源可以使用的 IP 地址范围。

### **示例**

* 假设您有一个名为 `MyVNet` 的 VNet，其 IP 地址范围为 `10.0.0.0/16`。您可以在此 VNet 内创建一个子网，比如说 `Subnet-1`，其 IP 地址范围为 `10.0.0.0/24`，用于托管您的 Web 服务器。另一个子网 `Subnet-2`，其范围为 `10.0.1.0/24`，可以用于您的数据库服务器。这种分割允许在网络内进行有效的管理和安全控制。

### 枚举

要列出 Azure 帐户中的所有 VNets 和子网，您可以使用 Azure 命令行界面 (CLI)。以下是步骤：

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
## 网络安全组 (NSG)

Azure 中的网络安全组（NSG）用于**过滤进出 Azure 资源的网络流量**，在 Azure 虚拟网络（**VNet**）中使用。NSG 包含**安全规则**，允许或拒绝进入或流出多种类型 Azure 资源的入站网络流量。

NSG 中的每条规则都根据**源/目的 IP 地址、端口和协议**定义了一个**过滤器**。这允许对网络流量进行细粒度控制，确保只有授权的流量可以访问或离开您的 Azure 资源。

### **示例**

* 假设您有一个应用于子网或 VNet 内特定虚拟机的 NSG，名为 `MyNSG`。您可以创建规则，例如：
* 一个入站规则，允许任何来源的 HTTP 流量（端口 80）到您的 web 服务器。
* 一个出站规则，仅允许 SQL 流量（端口 1433）到特定目的 IP 地址范围。

### 枚举

{% code overflow="wrap" %}
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table
```
## Azure 防火墙

Azure 防火墙是一种托管的云基础网络安全服务，用于保护您的 Azure 虚拟网络资源。它是一种具有内置高可用性和可伸缩性特性的全状态防火墙即服务。

Azure 防火墙提供比 **NSG** 更**高级**的功能，包括**应用程序级别过滤**、网络级别过滤、基于威胁情报的过滤，以及与 Azure Monitor 的集成用于日志记录和分析。\
它可以过滤出站、入站、Spoke 对 Spoke、VPN 和 ExpressRoute 流量。**防火墙规则可以基于 FQDN（完全合格域名）、IP 地址和端口创建**。

### Azure 防火墙与 NSG 的区别

1. **范围:**
* **NSG:** 在子网或网络接口级别工作。它旨在为网络接口（NIC）、VM 或子网提供基本的入站和出站流量过滤。
* **Azure 防火墙:** 在 VNet 级别操作，提供更广泛的保护范围。它旨在保护您的虚拟网络资源，并管理流入和流出 VNet 的流量。
2. **能力:**
* **NSG:** 提供基于 IP 地址、端口和协议的基本过滤功能。它不支持应用程序级别检查或威胁情报等高级功能。
* **Azure 防火墙:** 提供高级功能，如应用程序级别（第 7 层）流量过滤、基于威胁情报的过滤、网络流量过滤等。它还支持多个公共 IP 地址。
3. **使用案例:**
* **NSG:** 适用于基本的网络级别流量过滤。
* **Azure 防火墙:** 适用于需要应用程序级别控制、日志记录和威胁情报的更复杂过滤场景。
4. **管理和监控:**
* **NSG:** 提供基本的日志记录和与 Azure Monitor 的集成。
* **Azure 防火墙:** 通过 Azure Monitor 提供高级日志记录和分析能力，这对于理解流量的性质和模式至关重要。

### 枚举

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
## 网络虚拟设备 (NVA)

Azure 中的网络虚拟设备（**NVA**）是一种在虚拟网络内**执行网络功能的虚拟设备**。NVA 通常用于那些在 Azure 中**原生不可用**的网络功能，或者当需要更多自定义时使用。它们本质上是**运行网络应用程序或服务的 VM**，例如防火墙、WAN 优化器或负载均衡器。

NVA 用于复杂的路由、**安全**和**网络流量管理**任务。它们可以从 Azure **市场**部署，许多第三方供应商提供了准备好集成到 Azure 环境中的设备。

### **示例**

* 一个组织可以在 Azure 中部署一个 NVA 来创建一个**自定义防火墙解决方案**。这个 NVA 可以运行**第三方防火墙软件**，提供高级功能，如入侵检测、数据包检查或 VPN 连接。NVA 可以配置为检查和过滤通过它的流量，确保根据组织的政策实施增强的安全措施。

### **枚举**

{% code overflow="wrap" %}
```bash
# Usually NVAs are named or tagged in a way to distinguish them from other VMs
az vm list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# For a specific VM identified as an NVA, list its network interfaces
az vm nic list --vm-name <VMName> --resource-group <ResourceGroupName> --query "[].{id:id}" -o table
```
## Azure 路由表 & 用户定义的路由 (UDR)

**Azure 路由表** 是 Microsoft Azure 中的一个功能，允许**控制在 Azure 虚拟网络 (VNets) 内的网络流量路由**。本质上，它们定义了**数据包**如何在 VNets 内的子网之间、VNets 之间或到外部网络之间**转发**。每个路由表包含一组规则，称为路由，这些规则指定了基于目的 IP 地址应如何路由数据包。

**用户定义的路由 (UDR)** 在 Azure 中是**你在 Azure 路由表内创建的自定义路由**，用于控制网络流量在 Azure 虚拟网络 (VNets) 内部和之间的**流动**，以及到外部连接。UDR 为你提供了灵活性，根据你的具体需求指导网络流量，覆盖 Azure 默认的路由决策。

这些路由对于需要**通过虚拟设备路由流量**的场景特别有用，强制执行特定路径以符合安全或政策合规性，或与本地网络集成。

### **示例**

* 假设你在一个 VNet 内部的子网之间部署了一个网络虚拟设备 (NVA) 来检查流量。你可以创建一个 UDR，指导所有从一个子网到另一个子网的流量通过 NVA。这个 UDR 确保 NVA 在流量到达目的地之前出于安全目的进行检查。

### **枚举**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List UDRs for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure 私有链接

Azure 私有链接是 Azure 中的一项服务，它**通过确保您的 Azure 虚拟网络 (VNet) 与服务之间的流量完全在 Microsoft 的 Azure 主干网络内部传输**，**实现对 Azure 服务的私有访问**。它有效地将服务引入您的 VNet。这种设置通过不将数据暴露给公共互联网来增强安全性。

私有链接可以与各种 Azure 服务一起使用，如 Azure 存储、Azure SQL 数据库和通过私有链接共享的自定义服务。它提供了一种安全的方式，从您自己的 VNet 或甚至不同的 Azure 订阅中使用服务。

{% hint style="danger" %}
网络安全组 (NSGs) 不适用于私有终结点，这显然意味着将 NSG 关联到包含私有链接的子网将不起作用。
{% endhint %}

### **示例**

* 考虑一个场景，您有一个** Azure SQL 数据库，您希望从您的 VNet 安全访问**。通常，这可能涉及穿越公共互联网。使用私有链接，您可以在您的 VNet 中创建一个**私有终结点**，直接连接到 Azure SQL 数据库服务。这个终结点使得数据库看起来好像是您自己 VNet 的一部分，可以通过私有 IP 地址访问，从而确保安全和私密的访问。

### **枚举**

{% code overflow="wrap" %}
```bash
# List Private Link Services
z network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
{% endcode %}

## Azure 服务终结点

Azure 服务终结点扩展了您的虚拟网络私有地址空间和您的 VNet 身份到 Azure 服务的直接连接。通过启用服务终结点，**您的 VNet 中的资源可以安全地连接到 Azure 服务**，如 Azure 存储和 Azure SQL 数据库，使用 Azure 的骨干网络。这确保了**从 VNet 到 Azure 服务的流量保持在 Azure 网络内**，提供了一个更安全可靠的路径。

### **示例**

* 例如，默认情况下，**Azure 存储**账户可以通过公共互联网访问。通过在您的 VNet 内启用**Azure 存储的服务终结点**，您可以确保只有来自您的 VNet 的流量才能访问存储账户。然后可以配置存储账户防火墙，只接受来自您的 VNet 的流量。

### **枚举**

{% code overflow="wrap" %}
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
### 服务终结点与私有链接的区别

Microsoft 在 [**文档**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints) 中推荐使用私有链接：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**服务终结点：**

* 您的 VNet 到 Azure 服务的流量通过 Microsoft Azure 主干网络，绕过公共互联网。
* 终结点是到 Azure 服务的直接连接，并且不在 VNet 内为服务提供私有 IP。
* 除非您配置服务防火墙以阻止此类流量，否则服务本身仍可通过其公共终结点从您的 VNet 外部访问。
* 它是子网与 Azure 服务之间一对一的关系。
* 比私有链接便宜。

**私有链接：**

* 私有链接通过私有终结点将 Azure 服务映射到您的 VNet，私有终结点是在您的 VNet 内具有私有 IP 地址的网络接口。
* 使用这个私有 IP 地址访问 Azure 服务，使其看起来像是您网络的一部分。
* 通过私有链接连接的服务只能从您的 VNet 或连接的网络访问；服务对公共互联网没有访问权限。
* 它能够安全地连接到 Azure 服务或您在 Azure 中托管的自己的服务，以及连接到其他人共享的服务。
* 它通过您 VNet 中的私有终结点提供更细粒度的访问控制，与服务终结点在子网级别提供的更广泛访问控制相比。

总结来说，虽然服务终结点和私有链接都提供了安全的连接到 Azure 服务，**私有链接通过确保服务私下访问而不暴露于公共互联网，提供了更高级别的隔离和安全性**。另一方面，服务终结点在需要简单、安全地访问 Azure 服务且不需要 VNet 中的私有 IP 的一般情况下更容易设置。

## Azure Front Door (AFD) & AFD WAF

**Azure Front Door** 是一个可扩展且安全的入口点，用于**快速交付**您的全球 Web 应用程序。它**结合**了全球**负载均衡、站点加速、SSL 卸载和 Web 应用程序防火墙 (WAF)** 等多种服务于一个服务中。Azure Front Door 根据**用户最近的边缘位置**提供智能路由，确保最佳性能和可靠性。此外，它还提供基于 URL 的路由、多站点托管、会话亲和性和应用层安全性。

**Azure Front Door WAF** 旨在**保护 Web 应用程序免受基于 Web 的攻击**，无需修改后端代码。它包括自定义规则和管理规则集，以防御 SQL 注入、跨站脚本和其他常见攻击。

### **示例**

* 假设您有一个全球分布的应用程序，用户遍布全世界。您可以使用 Azure Front Door 将**用户请求路由到最近的区域数据中心**托管您的应用程序，从而减少延迟，改善用户体验并**利用 WAF 功能防御 Web 攻击**。如果某个区域发生停机，Azure Front Door 可以自动将流量重新路由到下一个最佳位置，确保高可用性。

### 枚举

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
## Azure 应用程序网关和 Azure 应用程序网关 WAF

Azure 应用程序网关是一个**网络流量负载均衡器**，它使您能够管理流向您的**网络**应用程序的流量。它在作为服务的应用程序交付控制器 (ADC) 中提供**第7层负载均衡、SSL终止和网络应用程序防火墙 (WAF) 功能**。主要特性包括基于 URL 的路由、基于 cookie 的会话亲和性以及安全套接字层 (SSL) 卸载，这些对于需要复杂负载均衡能力的应用程序（如全球路由和基于路径的路由）至关重要。

### 示例

* 假设您有一个电子商务网站，该网站包含多个子域，用于不同的功能，例如用户账户和支付处理。Azure 应用程序网关可以**根据 URL 路径将流量路由到适当的网络服务器**。例如，流向 `example.com/accounts` 的流量可以被引导到用户账户服务，流向 `example.com/pay` 的流量可以被引导到支付处理服务。\
并且**使用 WAF 功能保护您的网站免受攻击。**

### **枚举**

{% code overflow="wrap" %}
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
## Azure Hub、Spoke 和 VNet 对等连接

**VNet 对等连接** 是 Azure 中的一项网络功能，**允许不同的虚拟网络（VNets）直接无缝连接**。通过 VNet 对等连接，一个 VNet 中的资源可以使用私有 IP 地址与另一个 VNet 中的资源通信，**就像它们在同一个网络中一样**。\
**VNet 对等连接也可以与本地网络一起使用**，通过设置站点到站点 VPN 或 Azure ExpressRoute。

**Azure Hub 和 Spoke** 是 Azure 中用于管理和组织网络流量的网络拓扑。**“hub”是一个中心点，控制并路由不同“spokes”之间的流量**。hub 通常包含共享服务，如网络虚拟设备（NVAs）、Azure VPN 网关、Azure 防火墙或 Azure Bastion。**“spokes”是托管工作负载的 VNets，并使用 VNet 对等连接连接到 hub**，允许它们利用 hub 中的共享服务。这种模型促进了清晰的网络布局，通过集中化多个不同 VNets 中的工作负载可以使用的共同服务来减少复杂性。

{% hint style="danger" %}
**Azure 中的 VNET 对等连接是非传递性的**，这意味着如果 spoke 1 连接到 spoke 2 并且 spoke 2 连接到 spoke 3，则 spoke 1 不能直接与 spoke 3 通信。
{% endhint %}

### 示例

* 想象一个公司有像销售、人力资源和开发这样的不同部门，**每个部门都有自己的 VNet（spokes）**。这些 VNets **需要访问共享资源**，如中央数据库、防火墙和互联网网关，这些都位于 **另一个 VNet（hub）** 中。通过使用 Hub 和 Spoke 模型，每个部门都可以 **通过 hub VNet 安全地连接到共享资源，而无需将这些资源暴露给公共互联网** 或创建具有众多连接的复杂网络结构。

### 枚举

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
{% endcode %}

## 站点到站点 VPN

Azure 中的站点到站点 VPN 允许您**将本地网络连接到 Azure 虚拟网络 (VNet)**，使得 Azure 中的资源，如 VM，看起来好像它们在您的本地网络上。这种连接是通过一个**加密流量的 VPN 网关**建立的。

### **示例**

* 一家位于纽约的公司在其本地数据中心需要安全地连接到 Azure 中的 VNet，该 VNet 托管着其虚拟化工作负载。通过建立**站点到站点 VPN，公司可以确保本地服务器与 Azure VM 之间的加密连接**，允许跨两个环境安全地访问资源，就像它们在同一个本地网络中一样。

### **枚举**

{% code overflow="wrap" %}
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
{% endcode %}

## Azure ExpressRoute

Azure ExpressRoute 是一项服务，它提供了一种**私有的、专用的、高速的连接，连接您的本地基础设施和 Azure 数据中心**。这种连接是通过连接提供商进行的，绕过了公共互联网，并提供了比典型互联网连接更高的可靠性、更快的速度、更低的延迟和更高的安全性。

### **示例**

* 一家跨国公司由于数据量大，需要**稳定可靠的连接到其 Azure 服务，以及高吞吐量的需求**。该公司选择了 Azure ExpressRoute 来直接连接其本地数据中心和 Azure，便于进行大规模数据传输，如每日备份和实时数据分析，同时提高了隐私性和速度。

### **枚举**

{% code overflow="wrap" %}
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客技术！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
