# Az - Rede Azure

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

As redes dentro do Azure funcionam como uma parte integral de sua plataforma de computa√ß√£o em nuvem, possibilitando a **conex√£o e comunica√ß√£o entre v√°rios servi√ßos e recursos do Azure**. A arquitetura de rede no Azure √© projetada para ser altamente escal√°vel, segura e personaliz√°vel.

No seu n√∫cleo, o Azure fornece uma **rede virtual (VNet)** que permite aos usu√°rios criar **redes isoladas** dentro da nuvem Azure. Dentro dessas VNets, recursos como m√°quinas virtuais, aplica√ß√µes e bancos de dados podem ser hospedados e gerenciados com seguran√ßa. A rede no Azure suporta tanto a comunica√ß√£o dentro da nuvem (entre servi√ßos do Azure) quanto a conex√£o com redes externas e a internet.

**Seguran√ßa** √© um aspecto cr√≠tico da rede Azure, com v√°rias ferramentas e servi√ßos dispon√≠veis para proteger dados, gerenciar acesso e garantir conformidade. Essas medidas de seguran√ßa incluem **firewalls**, **grupos de seguran√ßa de rede** e capacidades de **criptografia**, permitindo um alto n√≠vel de controle sobre tr√°fego e acesso.

No geral, as capacidades de rede do Azure s√£o projetadas para oferecer flexibilidade, permitindo aos usu√°rios criar um ambiente de rede que atenda √†s suas necessidades espec√≠ficas de aplica√ß√£o e carga de trabalho, mantendo um forte √™nfase em seguran√ßa e confiabilidade.

## Rede Virtual (VNET) & Sub-redes

Uma VNet no Azure √© essencialmente uma representa√ß√£o da sua pr√≥pria rede na nuvem. √â uma **isolamento l√≥gico da nuvem Azure dedicado √† sua assinatura**. Uma VNet permite que voc√™ provisione e gerencie redes privadas virtuais (VPNs) no Azure e pode ser usada para hospedar e **gerenciar v√°rios tipos de recursos do Azure**, como M√°quinas Virtuais (VMs), bancos de dados e servi√ßos de aplica√ß√£o.

VNets oferecem **controle total sobre as configura√ß√µes de sua rede**, incluindo faixas de **endere√ßos IP**, cria√ß√£o de sub-redes, tabelas de roteamento e gateways de rede.

Uma **sub-rede** √© uma **faixa de endere√ßos IP na sua VNet**. Voc√™ pode dividir uma VNet em v√°rias sub-redes para organiza√ß√£o e seguran√ßa. Cada sub-rede em uma VNet pode ser usada para isolar e agrupar recursos de acordo com sua arquitetura de rede e aplica√ß√£o.

Al√©m disso, sub-redes permitem que voc√™ **segmente sua VNet em uma ou mais sub-redes**, fornecendo uma faixa de endere√ßos IP que os recursos podem usar.

### **Exemplo**

* Suponha que voc√™ tenha uma VNet chamada `MyVNet` com uma faixa de endere√ßos IP de `10.0.0.0/16`. Voc√™ pode criar uma sub-rede dentro desta VNet, digamos `Subnet-1`, com uma faixa de endere√ßos IP de `10.0.0.0/24` para hospedar seus servidores web. Outra sub-rede, `Subnet-2` com uma faixa de `10.0.1.0/24`, poderia ser usada para seus servidores de banco de dados. Essa segmenta√ß√£o permite um gerenciamento eficiente e controles de seguran√ßa dentro da rede.

### Enumera√ß√£o

Para listar todas as VNets e sub-redes em uma conta Azure, voc√™ pode usar a Interface de Linha de Comando (CLI) do Azure. Aqui est√£o os passos:

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
## Grupos de Seguran√ßa de Rede (NSG)

Um Grupo de Seguran√ßa de Rede (NSG) no Azure √© usado para **filtrar o tr√°fego de rede para e de recursos Azure** em uma rede virtual Azure (**VNet**). Um NSG cont√©m **regras de seguran√ßa** que permitem ou negam o tr√°fego de rede de entrada para, ou de sa√≠da de, v√°rios tipos de recursos Azure.

Cada regra em um NSG define um **filtro baseado em endere√ßo IP de origem/destino, porta e protocolo**. Isso permite um controle refinado sobre o tr√°fego de rede, garantindo que apenas o tr√°fego autorizado possa acessar ou sair dos seus recursos Azure.

### **Exemplo**

* Imagine que voc√™ tem um NSG chamado `MyNSG` aplicado a uma sub-rede ou a uma m√°quina virtual espec√≠fica dentro da sua VNet. Voc√™ pode criar regras como:
* Uma regra de entrada permitindo tr√°fego HTTP (porta 80) de qualquer origem para seus servidores web.
* Uma regra de sa√≠da permitindo apenas tr√°fego SQL (porta 1433) para uma faixa espec√≠fica de endere√ßos IP de destino.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table
```
{% endcode %}

## Azure Firewall

O Azure Firewall √© um servi√ßo de seguran√ßa de rede baseado na nuvem e gerenciado que **protege os recursos da sua Rede Virtual Azure**. √â um firewall totalmente stateful como servi√ßo, com alta disponibilidade e recursos de escalabilidade integrados.

O Azure Firewall oferece recursos **mais avan√ßados** do que os **NSGs**, incluindo **filtragem em n√≠vel de aplica√ß√£o**, filtragem em n√≠vel de rede, filtragem baseada em intelig√™ncia contra amea√ßas e integra√ß√£o com o Azure Monitor para registro e an√°lise.
Ele pode filtrar tr√°fego de sa√≠da, entrada, de spoke para spoke, VPN e ExpressRoute. **Regras de firewall podem ser criadas com base em FQDN (Fully Qualified Domain Name), endere√ßos IP e portas**.

### Diferen√ßas entre Azure Firewall e NSGs&#x20;

1. **Escopo:**
* **NSG:** Funciona no n√≠vel da sub-rede ou interface de rede. Destina-se a fornecer filtragem b√°sica de tr√°fego de entrada e sa√≠da de interfaces de rede (NIC), VMs ou sub-redes.
* **Azure Firewall:** Opera no n√≠vel do VNet, fornecendo um escopo mais amplo de prote√ß√£o. √â projetado para proteger seus recursos de rede virtual e gerenciar o tr√°fego que entra e sai do VNet.
2. **Capacidades:**
* **NSG:** Oferece capacidades b√°sicas de filtragem baseadas em endere√ßo IP, porta e protocolo. N√£o suporta recursos avan√ßados como inspe√ß√£o em n√≠vel de aplica√ß√£o ou intelig√™ncia contra amea√ßas.
* **Azure Firewall:** Oferece recursos avan√ßados como filtragem de tr√°fego em n√≠vel de aplica√ß√£o (Camada 7), filtragem baseada em intelig√™ncia contra amea√ßas, filtragem de tr√°fego de rede e mais. Tamb√©m suporta m√∫ltiplos endere√ßos IP p√∫blicos.
3. **Casos de Uso:**
* **NSG:** Ideal para filtragem b√°sica de tr√°fego em n√≠vel de rede.
* **Azure Firewall:** Adequado para cen√°rios de filtragem mais complexos onde controle em n√≠vel de aplica√ß√£o, registro e intelig√™ncia contra amea√ßas s√£o necess√°rios.
4. **Gerenciamento e Monitoramento:**
* **NSG:** Oferece registro b√°sico e integra√ß√£o com o Azure Monitor.
* **Azure Firewall:** Fornece capacidades avan√ßadas de registro e an√°lise por meio do Azure Monitor, o que √© essencial para entender a natureza e o padr√£o do tr√°fego.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
{% endcode %}

## Appliance Virtual de Rede (NVA)

Um Appliance Virtual de Rede (**NVA**) no Azure √© um appliance virtual que **realiza fun√ß√µes de rede dentro de uma rede virtual**. NVAs s√£o tipicamente usados para fun√ß√µes de rede que **n√£o est√£o dispon√≠veis nativamente** no Azure ou quando √© necess√°ria mais personaliza√ß√£o. Eles s√£o essencialmente **VMs que executam aplica√ß√µes ou servi√ßos de rede**, como firewalls, otimizadores de WAN ou balanceadores de carga.

NVAs s√£o usados para tarefas complexas de roteamento, **seguran√ßa** e **gerenciamento de tr√°fego de rede**. Eles podem ser implantados a partir do **Marketplace** do Azure, onde muitos fornecedores terceirizados oferecem seus appliances prontos para integra√ß√£o em ambientes Azure.

### **Exemplo**

* Uma organiza√ß√£o pode implantar um NVA no Azure para criar uma **solu√ß√£o de firewall personalizada**. Este NVA poderia executar um **software de firewall de terceiros**, fornecendo recursos avan√ßados como detec√ß√£o de intrus√£o, inspe√ß√£o de pacotes ou conectividade VPN. O NVA pode ser configurado para inspecionar e filtrar o tr√°fego que passa por ele, garantindo que medidas de seguran√ßa aprimoradas estejam em vigor conforme as pol√≠ticas da organiza√ß√£o.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# Usually NVAs are named or tagged in a way to distinguish them from other VMs
az vm list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# For a specific VM identified as an NVA, list its network interfaces
az vm nic list --vm-name <VMName> --resource-group <ResourceGroupName> --query "[].{id:id}" -o table
```
## Tabelas de Rotas Azure & Rotas Definidas pelo Usu√°rio (UDR)

**Tabelas de Rotas Azure** s√£o uma funcionalidade dentro do Microsoft Azure que permite o **controle do roteamento de tr√°fego de rede dentro das Redes Virtuais Azure (VNets)**. Essencialmente, elas definem como os **pacotes** s√£o **encaminhados** entre sub-redes dentro das VNets, entre VNets ou para redes externas. Cada tabela de rotas cont√©m um conjunto de regras, conhecidas como rotas, que especificam como os pacotes devem ser roteados com base em seus endere√ßos IP de destino.

**Rotas Definidas pelo Usu√°rio (UDR)** no Azure s√£o **rotas personalizadas que voc√™ cria dentro das Tabelas de Rotas Azure** para controlar o **fluxo de tr√°fego de rede** dentro e entre as Redes Virtuais Azure (VNets), e para conex√µes externas. UDRs oferecem a flexibilidade de direcionar o tr√°fego de rede conforme suas necessidades espec√≠ficas, substituindo as decis√µes de roteamento padr√£o do Azure.

Essas rotas s√£o particularmente √∫teis para cen√°rios onde voc√™ precisa **direcionar o tr√°fego atrav√©s de um appliance virtual de rede**, impor um caminho espec√≠fico para conformidade de seguran√ßa ou pol√≠tica, ou integrar com redes locais.

### **Exemplo**

* Suponha que voc√™ tenha implantado um Appliance Virtual de Rede (NVA) para inspecionar o tr√°fego entre sub-redes dentro de uma VNet. Voc√™ pode criar uma UDR que direcione todo o tr√°fego de uma sub-rede para outra sub-rede para passar pelo NVA. Esta UDR garante que o NVA inspecione o tr√°fego para fins de seguran√ßa antes de alcan√ßar seu destino.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List UDRs for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure Private Link

Azure Private Link √© um servi√ßo no Azure que **permite acesso privado a servi√ßos Azure** garantindo que **o tr√°fego entre sua rede virtual Azure (VNet) e o servi√ßo viaje inteiramente dentro da rede de backbone da Microsoft Azure**. Ele efetivamente traz o servi√ßo para dentro da sua VNet. Essa configura√ß√£o aumenta a seguran√ßa ao n√£o expor os dados √† internet p√∫blica.

Private Link pode ser usado com v√°rios servi√ßos Azure, como Azure Storage, Azure SQL Database e servi√ßos personalizados compartilhados via Private Link. Ele fornece uma maneira segura de consumir servi√ßos de dentro da sua pr√≥pria VNet ou at√© mesmo de diferentes assinaturas Azure.

{% hint style="danger" %}
NSGs n√£o se aplicam a endpoints privados, o que claramente significa que associar um NSG com uma sub-rede que cont√©m o Private Link n√£o ter√° efeito.
{% endhint %}

### **Exemplo**

* Considere um cen√°rio onde voc√™ tem um **Azure SQL Database que deseja acessar de forma segura a partir da sua VNet**. Normalmente, isso poderia envolver atravessar a internet p√∫blica. Com o Private Link, voc√™ pode criar um **endpoint privado na sua VNet** que se conecta diretamente ao servi√ßo Azure SQL Database. Esse endpoint faz com que o banco de dados pare√ßa como se fosse parte da sua pr√≥pria VNet, acess√≠vel via um endere√ßo IP privado, garantindo assim acesso seguro e privado.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Private Link Services
z network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
{% endcode %}

## Pontos de Extremidade de Servi√ßo Azure

Os Pontos de Extremidade de Servi√ßo Azure estendem o espa√ßo de endere√ßo privado da sua rede virtual e a identidade da sua VNet para servi√ßos Azure atrav√©s de uma conex√£o direta. Ao habilitar pontos de extremidade de servi√ßo, **recursos na sua VNet podem se conectar de forma segura a servi√ßos Azure**, como Azure Storage e Azure SQL Database, usando a rede principal da Azure. Isso garante que o **tr√°fego da VNet para o servi√ßo Azure permane√ßa dentro da rede Azure**, proporcionando um caminho mais seguro e confi√°vel.

### **Exemplo**

* Por exemplo, uma conta de **Azure Storage** por padr√£o √© acess√≠vel pela internet p√∫blica. Ao habilitar um **ponto de extremidade de servi√ßo para Azure Storage dentro da sua VNet**, voc√™ pode garantir que apenas o tr√°fego da sua VNet possa acessar a conta de armazenamento. O firewall da conta de armazenamento pode ent√£o ser configurado para aceitar tr√°fego apenas da sua VNet.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
### Diferen√ßas Entre Service Endpoints e Private Links

A Microsoft recomenda o uso de Private Links nos [**documentos**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints):


<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Service Endpoints:**

* O tr√°fego da sua VNet para o servi√ßo Azure viaja pela rede interna da Microsoft Azure, evitando a internet p√∫blica.
* O endpoint √© uma conex√£o direta com o servi√ßo Azure e n√£o fornece um IP privado para o servi√ßo dentro da VNet.
* O pr√≥prio servi√ßo ainda √© acess√≠vel atrav√©s do seu endpoint p√∫blico de fora da sua VNet, a menos que voc√™ configure o firewall do servi√ßo para bloquear tal tr√°fego.
* √â uma rela√ß√£o um-para-um entre a subnet e o servi√ßo Azure.
* Menos caro do que Private Links.

**Private Links:**

* Private Link mapeia servi√ßos Azure para a sua VNet atrav√©s de um endpoint privado, que √© uma interface de rede com um endere√ßo IP privado dentro da sua VNet.
* O servi√ßo Azure √© acessado usando este endere√ßo IP privado, fazendo parecer que √© parte da sua rede.
* Servi√ßos conectados via Private Link s√≥ podem ser acessados da sua VNet ou redes conectadas; n√£o h√° acesso p√∫blico √† internet para o servi√ßo.
* Permite uma conex√£o segura com servi√ßos Azure ou seus pr√≥prios servi√ßos hospedados no Azure, bem como conex√£o com servi√ßos compartilhados por outros.
* Fornece controle de acesso mais granular atrav√©s de um endpoint privado na sua VNet, em oposi√ß√£o ao controle de acesso mais amplo no n√≠vel da subnet com service endpoints.

Em resumo, enquanto ambos Service Endpoints e Private Links fornecem conectividade segura aos servi√ßos Azure, **Private Links oferecem um n√≠vel mais alto de isolamento e seguran√ßa, garantindo que os servi√ßos sejam acessados de forma privada sem exposi√ß√£o √† internet p√∫blica**. Service Endpoints, por outro lado, s√£o mais f√°ceis de configurar para casos gerais onde √© necess√°rio um acesso seguro simples aos servi√ßos Azure sem a necessidade de um IP privado na VNet.

## Azure Front Door (AFD) & AFD WAF

**Azure Front Door** √© um ponto de entrada escal√°vel e seguro para **entrega r√°pida** de suas aplica√ß√µes web globais. Ele **combina** v√°rios servi√ßos como **balanceamento de carga global, acelera√ß√£o de site, offloading SSL e capacidades de Web Application Firewall (WAF)** em um √∫nico servi√ßo. Azure Front Door oferece roteamento inteligente baseado na **localiza√ß√£o de borda mais pr√≥xima do usu√°rio**, garantindo desempenho √≥timo e confiabilidade. Al√©m disso, oferece roteamento baseado em URL, hospedagem de m√∫ltiplos sites, afinidade de sess√£o e seguran√ßa na camada de aplica√ß√£o.

**Azure Front Door WAF** √© projetado para **proteger aplica√ß√µes web de ataques baseados na web** sem modifica√ß√£o no c√≥digo de back-end. Inclui regras personalizadas e conjuntos de regras gerenciadas para proteger contra amea√ßas como inje√ß√£o de SQL, cross-site scripting e outros ataques comuns.

### **Exemplo**

* Imagine que voc√™ tem uma aplica√ß√£o distribu√≠da globalmente com usu√°rios ao redor do mundo. Voc√™ pode usar Azure Front Door para **rotear solicita√ß√µes de usu√°rios para o data center regional mais pr√≥ximo** hospedando sua aplica√ß√£o, reduzindo assim a lat√™ncia, melhorando a experi√™ncia do usu√°rio e **defendendo-a de ataques web com as capacidades do WAF**. Se uma regi√£o espec√≠fica sofrer inatividade, Azure Front Door pode automaticamente redirecionar o tr√°fego para a pr√≥xima melhor localiza√ß√£o, garantindo alta disponibilidade.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
## Azure Application Gateway e Azure Application Gateway WAF

O Azure Application Gateway √© um **balanceador de carga de tr√°fego web** que permite gerenciar o tr√°fego para suas **aplica√ß√µes web**. Oferece **balanceamento de carga de Camada 7, t√©rmino SSL e capacidades de firewall de aplica√ß√£o web (WAF)** no Application Delivery Controller (ADC) como um servi√ßo. Recursos chave incluem roteamento baseado em URL, afinidade de sess√£o baseada em cookie e offloading de camada de soquetes seguros (SSL), que s√£o cruciais para aplica√ß√µes que requerem capacidades complexas de balanceamento de carga como roteamento global e roteamento baseado em caminho.

### Exemplo

* Considere um cen√°rio onde voc√™ tem um site de e-commerce que inclui m√∫ltiplos subdom√≠nios para diferentes fun√ß√µes, como contas de usu√°rios e processamento de pagamentos. O Azure Application Gateway pode **direcionar o tr√°fego para os servidores web apropriados baseado no caminho da URL**. Por exemplo, o tr√°fego para `example.com/accounts` poderia ser direcionado para o servi√ßo de contas de usu√°rios, e o tr√°fego para `example.com/pay` poderia ser direcionado para o servi√ßo de processamento de pagamentos.\
E **proteger seu site de ataques usando as capacidades do WAF.**

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
{% endcode %}

## Azure Hub, Spoke e VNet Peering

**VNet Peering** √© um recurso de rede no Azure que **permite que diferentes Redes Virtuais (VNets) sejam conectadas diretamente e de maneira transparente**. Atrav√©s do VNet Peering, recursos em uma VNet podem se comunicar com recursos em outra VNet usando endere√ßos IP privados, **como se estivessem na mesma rede**.\
**VNet Peering tamb√©m pode ser usado com redes locais** configurando uma VPN site-to-site ou Azure ExpressRoute.

**Azure Hub and Spoke** √© uma topologia de rede usada no Azure para gerenciar e organizar o tr√°fego de rede. **O "hub" √© um ponto central que controla e direciona o tr√°fego entre diferentes "spokes"**. O hub geralmente cont√©m servi√ßos compartilhados como appliances virtuais de rede (NVAs), Azure VPN Gateway, Azure Firewall ou Azure Bastion. Os **"spokes" s√£o VNets que hospedam cargas de trabalho e se conectam ao hub usando VNet Peering**, permitindo que eles aproveitem os servi√ßos compartilhados dentro do hub. Esse modelo promove uma disposi√ß√£o de rede limpa, reduzindo a complexidade ao centralizar servi√ßos comuns que v√°rias cargas de trabalho em diferentes VNets podem usar.

{% hint style="danger" %}
**O emparelhamento de VNET n√£o √© transitivo no Azure**, o que significa que se o spoke 1 estiver conectado ao spoke 2 e o spoke 2 estiver conectado ao spoke 3, ent√£o o spoke 1 n√£o pode se comunicar diretamente com o spoke 3.
{% endhint %}

### Exemplos

* Imagine uma empresa com departamentos separados como Vendas, RH e Desenvolvimento, **cada um com sua pr√≥pria VNet (os spokes)**. Essas VNets **precisam de acesso a recursos compartilhados** como um banco de dados central, um firewall e um gateway de internet, que est√£o todos localizados em **outra VNet (o hub)**. Usando o modelo Hub and Spoke, cada departamento pode **se conectar de forma segura aos recursos compartilhados atrav√©s da VNet do hub sem expor esses recursos √† internet p√∫blica** ou criar uma estrutura de rede complexa com in√∫meras conex√µes.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
## VPN Site-to-Site

Uma VPN Site-to-Site no Azure permite que voc√™ **conecte sua rede local √† sua Rede Virtual Azure (VNet)**, possibilitando que recursos como VMs dentro do Azure pare√ßam estar na sua rede local. Essa conex√£o √© estabelecida por meio de um **gateway VPN que criptografa o tr√°fego** entre as duas redes.

### **Exemplo**

* Uma empresa com sua sede principal localizada em Nova York possui um data center local que precisa se conectar de forma segura √† sua VNet no Azure, que hospeda suas cargas de trabalho virtualizadas. Ao configurar uma **VPN Site-to-Site, a empresa pode garantir conectividade criptografada entre os servidores locais e as VMs do Azure**, permitindo que os recursos sejam acessados de forma segura em ambos os ambientes como se estivessem na mesma rede local.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
{% endcode %}

## Azure ExpressRoute

Azure ExpressRoute √© um servi√ßo que fornece uma **conex√£o privada, dedicada e de alta velocidade entre sua infraestrutura local e os data centers do Azure**. Essa conex√£o √© feita por meio de um provedor de conectividade, evitando a internet p√∫blica e oferecendo mais confiabilidade, velocidades mais r√°pidas, lat√™ncias menores e maior seguran√ßa do que as conex√µes t√≠picas de internet.

### **Exemplo**

* Uma corpora√ß√£o multinacional requer uma **conex√£o consistente e confi√°vel com seus servi√ßos Azure devido ao alto volume de dados** e √† necessidade de alta capacidade de transfer√™ncia. A empresa opta pelo Azure ExpressRoute para conectar diretamente seu data center local ao Azure, facilitando transfer√™ncias de dados em grande escala, como backups di√°rios e an√°lise de dados em tempo real, com privacidade e velocidade aprimoradas.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
