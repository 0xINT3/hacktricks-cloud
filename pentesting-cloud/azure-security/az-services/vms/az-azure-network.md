# Az - Azure Network

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF** sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Sieci w ramach Azure funkcjonują jako integralna część jej platformy obliczeniowej w chmurze, umożliwiając **połączenie i komunikację między różnymi usługami i zasobami Azure**. Architektura sieci w Azure została zaprojektowana tak, aby była wysoce skalowalna, bezpieczna i dostosowalna.

W swoim rdzeniu Azure zapewnia **wirtualną sieć (VNet)**, która umożliwia użytkownikom tworzenie **izolowanych** **sieci** w chmurze Azure. W ramach tych VNetów zasoby takie jak wirtualne maszyny, aplikacje i bazy danych mogą być bezpiecznie hostowane i zarządzane. Sieciowanie w Azure obsługuje zarówno komunikację wewnątrz chmury (między usługami Azure), jak i połączenie z sieciami zewnętrznymi i internetem.

**Bezpieczeństwo** jest istotnym aspektem sieciowania w Azure, z różnymi narzędziami i usługami dostępnymi do ochrony danych, zarządzania dostępem i zapewnienia zgodności. Te środki bezpieczeństwa obejmują **firewalle**, **grupy zabezpieczeń sieciowych** i możliwości **szyfrowania**, pozwalając na wysoki poziom kontroli nad ruchem i dostępem.

Ogólnie rzecz biorąc, możliwości sieciowe w Azure są zaprojektowane tak, aby oferować elastyczność, umożliwiając użytkownikom tworzenie środowiska sieciowego odpowiadającego ich konkretnym potrzebom aplikacyjnym i obciążeniowym, zachowując przy tym silny nacisk na bezpieczeństwo i niezawodność.

## Wirtualna sieć (VNET) i podsieci

VNet w Azure jest w zasadzie reprezentacją twojej własnej sieci w chmurze. Jest to **logiczna izolacja chmury Azure dedykowana twojej subskrypcji**. VNet umożliwia tworzenie i zarządzanie wirtualnymi sieciami prywatnymi (VPN) w Azure i może być używany do hostowania i **zarządzania wieloma rodzajami zasobów Azure**, takimi jak Wirtualne Maszyny (VM), bazy danych i usługi aplikacyjne.

VNety zapewniają ci **pełną kontrolę nad ustawieniami sieci**, w tym zakresami **adresów IP**, tworzeniem podsieci, tabelami trasowania i bramami sieciowymi.

**Podsieć** to **zakres adresów IP w twoim VNet**. Możesz podzielić VNet na wiele podsieci dla celów organizacyjnych i bezpieczeństwa. Każda podsieć w VNet może być używana do izolowania i grupowania zasobów zgodnie z twoją architekturą sieciową i aplikacyjną.

Ponadto podsieci pozwalają na **segmentację twojego VNetu na jedną lub więcej podsieci**, zapewniając zakres adresów IP, którymi zasoby mogą korzystać.

### **Przykład**

* Załóżmy, że masz VNet o nazwie `MyVNet` z zakresem adresów IP `10.0.0.0/16`. Możesz utworzyć podsieć w ramach tego VNetu, powiedzmy `Subnet-1`, z zakresem adresów IP `10.0.0.0/24` do hostowania serwerów WWW. Inna podsieć, `Subnet-2` o zakresie `10.0.1.0/24`, mogłaby być używana do serwerów baz danych. Ta segmentacja pozwala na efektywne zarządzanie i kontrole bezpieczeństwa w sieci.

### Wyliczenie

Aby wyświetlić wszystkie VNety i podsieci w koncie Azure, można użyć interfejsu wiersza poleceń Azure (CLI). Oto kroki:

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
{% endcode %}

## Grupy zabezpieczeń sieciowych (NSG)

W Azure **Network Security Group (NSG)** pełni główną funkcję filtrowania ruchu sieciowego zarówno do, jak i z zasobów Azure w ramach wirtualnej sieci Azure (VNet). Zawiera zestaw **reguł bezpieczeństwa**, które skrupulatnie określają przepływ ruchu sieciowego.

Kluczowe aspekty NSG obejmują:

* **Kontrola ruchu**: Każda NSG zawiera reguły, które są instrumentalne w zezwalaniu lub blokowaniu ruchu sieciowego przychodzącego i wychodzącego z różnych zasobów Azure.
* **Składniki reguł**: Reguły w ramach NSG są bardzo konkretne, filtrowanie ruchu na podstawie kryteriów takich jak adres IP źródłowy/docelowy, port i protokół. Ta specyfikacja pozwala na szczegółowe zarządzanie ruchem sieciowym.
* **Wzmocnienie bezpieczeństwa**: Zapewniając, że tylko autoryzowany ruch może wchodzić i wychodzić z zasobów Azure, NSG odgrywają kluczową rolę w umacnianiu postawy bezpieczeństwa infrastruktury sieciowej.

### **Przykład**

* Wyobraź sobie, że masz NSG o nazwie `MyNSG` zastosowaną do podsieci lub określonej maszyny wirtualnej w Twojej VNet. Możesz tworzyć reguły takie jak:
* Reguła przychodząca zezwalająca na ruch HTTP (port 80) z dowolnego źródła do serwerów internetowych.
* Reguła wychodząca zezwalająca tylko na ruch SQL (port 1433) do określonego zakresu adresów IP docelowych.

### Wyliczenie

{% code overflow="wrap" %}
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table
```
## Azure Firewall

Azure Firewall to zarządzana usługa bezpieczeństwa sieciowego w chmurze, która chroni zasoby wirtualnej sieci Azure. Jest to w pełni stanowy firewall jako usługa z wbudowanymi funkcjami wysokiej dostępności i skalowalności.

Azure Firewall oferuje bardziej zaawansowane funkcje niż NSG, w tym filtrowanie na poziomie aplikacji, filtrowanie na poziomie sieci, filtrowanie oparte na inteligencji zagrożeń oraz integrację z Azure Monitor do logowania i analizy. Może filtrować ruch wychodzący, przychodzący, między strefami, ruch VPN i ExpressRoute. Reguły firewalla mogą być tworzone na podstawie FQDN (Fully Qualified Domain Name), adresów IP i portów.

### Różnice między Azure Firewall a NSG

1. **Zakres:**
   - **NSG:** Działa na poziomie podsieci lub interfejsu sieciowego. Ma na celu zapewnienie podstawowego filtrowania ruchu przychodzącego i wychodzącego z interfejsów sieciowych (NIC), maszyn wirtualnych lub podsieci.
   - **Azure Firewall:** Działa na poziomie VNet, zapewniając szerszy zakres ochrony. Został zaprojektowany do zabezpieczania zasobów wirtualnej sieci i zarządzania ruchem wchodzącym i wychodzącym z VNet.
2. **Zdolności:**
   - **NSG:** Zapewnia podstawowe możliwości filtrowania oparte na adresie IP, porcie i protokole. Nie obsługuje zaawansowanych funkcji, takich jak inspekcja na poziomie aplikacji czy inteligencja zagrożeń.
   - **Azure Firewall:** Oferuje zaawansowane funkcje, takie jak filtrowanie ruchu na poziomie aplikacji (warstwa 7), filtrowanie oparte na inteligencji zagrożeń, filtrowanie ruchu sieciowego i wiele innych. Obsługuje również wiele publicznych adresów IP.
3. **Przypadki użycia:**
   - **NSG:** Idealny do podstawowego filtrowania ruchu na poziomie sieci.
   - **Azure Firewall:** Nadaje się do bardziej złożonych scenariuszy filtrowania, gdzie wymagana jest kontrola na poziomie aplikacji, logowanie i inteligencja zagrożeń.
4. **Zarządzanie i Monitorowanie:**
   - **NSG:** Oferuje podstawowe logowanie i integrację z Azure Monitor.
   - **Azure Firewall:** Zapewnia zaawansowane możliwości logowania i analizy za pomocą Azure Monitor, co jest istotne dla zrozumienia charakteru i wzorca ruchu.

### Wyliczanie

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
## Wirtualne urządzenie sieciowe (NVA)

Wirtualne urządzenie sieciowe (**NVA**) w usłudze Azure to wirtualne urządzenie, które **wykonuje funkcje sieciowe w ramach wirtualnej sieci**. NVA są zazwyczaj używane do funkcji sieciowych, które **nie są dostępne natywnie** w usłudze Azure lub gdy wymagana jest większa dostosowanie. Są to w zasadzie **maszyny wirtualne uruchamiające aplikacje lub usługi sieciowe**, takie jak zapory sieciowe, optymalizatory WAN lub równoważniki obciążenia.

NVA są wykorzystywane do zadań związanych z **zaawansowanym routowaniem**, **bezpieczeństwem** i **zarządzaniem ruchem sieciowym**. Mogą być wdrożone z **Marketplace** Azure, gdzie wielu dostawców oferuje swoje urządzenia gotowe do integracji w środowiskach Azure.

### **Przykład**

* Organizacja może wdrożyć NVA w usłudze Azure, aby stworzyć **niestandardowe rozwiązanie zapory sieciowej**. To NVA może uruchamiać **oprogramowanie zapory innej firmy**, zapewniając zaawansowane funkcje, takie jak wykrywanie intruzów, inspekcja pakietów czy łączność VPN. NVA może być skonfigurowane do inspekcji i filtrowania ruchu przechodzącego przez niego, zapewniając wzmocnione środki bezpieczeństwa zgodnie z politykami organizacji.

### **Wyliczanie**
```bash
# Usually NVAs are named or tagged in a way to distinguish them from other VMs
az vm list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# For a specific VM identified as an NVA, list its network interfaces
az vm nic list --vm-name <VMName> --resource-group <ResourceGroupName> --query "[].{id:id}" -o table
```
{% endcode %}

## Tabele trasowania w Azure i Trasy zdefiniowane przez użytkownika (UDR)

**Tabele trasowania w Azure** to funkcja w ramach platformy Microsoft Azure, która umożliwia **kontrolę trasowania ruchu sieciowego w ramach Wirtualnych Sieci Azure (VNets)**. W zasadzie definiują, jak **pakiety** są **przekazywane** między podsieciami w ramach VNets, między VNets lub do zewnętrznych sieci. Każda tabela trasowania zawiera zestaw reguł, znanych jako trasy, które określają, jak pakiety powinny być kierowane na podstawie ich docelowych adresów IP.

**Trasy zdefiniowane przez użytkownika (UDR)** w Azure to **niestandardowe trasy, które tworzysz w ramach tabel trasowania w Azure** w celu kontroli **przepływu ruchu sieciowego** wewnątrz i między Wirtualnymi Sieciami Azure (VNets) oraz do połączeń zewnętrznych. UDR umożliwiają elastyczne kierowanie ruchem sieciowym zgodnie z konkretnymi wymaganiami, nadpisując domyślne decyzje trasowania w Azure.

Te trasy są szczególnie przydatne w przypadkach, gdy potrzebujesz **kierować ruch przez wirtualne urządzenie**, narzucić określoną ścieżkę ze względów bezpieczeństwa lub zgodności z polityką, lub zintegrować się z sieciami lokalnymi.

### **Przykład**

* Załóżmy, że wdrożyłeś Wirtualne Urządzenie Sieciowe (NVA) do inspekcji ruchu między podsieciami w ramach jednego VNet. Możesz utworzyć UDR, który kieruje cały ruch z jednej podsieci do innej podsieci przez NVA. Ten UDR zapewnia, że NVA inspekcjonuje ruch w celach bezpieczeństwa przed dotarciem do celu.

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List UDRs for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure Private Link

Azure Private Link to usługa w Azure, która **umożliwia prywatny dostęp do usług Azure**, zapewniając, że **ruch między twoją wirtualną siecią Azure (VNet) a usługą odbywa się wyłącznie w ramach sieci bazowej Azure firmy Microsoft**. Skutecznie przynosi usługę do twojej VNet. To ustawienie zwiększa bezpieczeństwo, nie ujawniając danych publicznemu internetowi.

Private Link można używać z różnymi usługami Azure, takimi jak Azure Storage, Azure SQL Database i niestandardowymi usługami udostępnionymi za pośrednictwem Private Link. Zapewnia bezpieczny sposób na korzystanie z usług z własnej VNet lub nawet z różnych subskrypcji Azure.

{% hint style="danger" %}
NSG nie mają zastosowania do prywatnych punktów końcowych, co jasno oznacza, że przypisanie NSG do podsieci zawierającej Private Link nie będzie miało żadnego efektu.
{% endhint %}

### **Przykład**

* Rozważ scenariusz, w którym masz **Azure SQL Database, do którego chcesz uzyskać bezpieczny dostęp z twojej VNet**. Normalnie może to wymagać przekraczania publicznego internetu. Dzięki Private Link możesz utworzyć **prywatny punkt końcowy w twojej VNet**, który łączy się bezpośrednio z usługą Azure SQL Database. Ten punkt końcowy sprawia, że baza danych wydaje się być częścią twojej własnej VNet, dostępną za pomocą prywatnego adresu IP, zapewniając tym samym bezpieczny i prywatny dostęp.

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List Private Link Services
z network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
{% endcode %}

## Usługi końcowe w usłudze Azure

Usługi końcowe w usłudze Azure rozszerzają prywatną przestrzeń adresową wirtualnej sieci oraz tożsamość Twojej sieci wirtualnej do usług Azure poprzez bezpośrednie połączenie. Włączając usługi końcowe, **zasoby w Twojej sieci wirtualnej mogą bezpiecznie łączyć się z usługami Azure**, takimi jak Azure Storage i Azure SQL Database, korzystając z sieci trzonowej Azure. Zapewnia to, że **ruch z sieci wirtualnej do usługi Azure pozostaje w obrębie sieci Azure**, co zapewnia bardziej bezpieczną i niezawodną ścieżkę.

### **Przykład**

* Na przykład konto **Azure Storage** domyślnie jest dostępne przez publiczny internet. Włączając **usługę końcową dla Azure Storage w obrębie Twojej sieci wirtualnej**, możesz zapewnić, że tylko ruch z Twojej sieci wirtualnej będzie mógł uzyskać dostęp do konta magazynu. Zapora konta magazynu może następnie zostać skonfigurowana tak, aby akceptować ruch tylko z Twojej sieci wirtualnej.

### **Wyliczanie**
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
{% endcode %}

### Różnice między punktami końcowymi usługi a prywatnymi łączami

Microsoft zaleca korzystanie z Prywatnych Linków w [**dokumentacji**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints):\\

<figure><img src="../../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

**Punkty końcowe usługi:**

* Ruch z Twojego VNet do usługi Azure przemieszcza się po sieci rdzenia Microsoft Azure, omijając publiczny internet.
* Punkt końcowy to bezpośrednie połączenie z usługą Azure i nie zapewnia prywatnego adresu IP dla usługi w obrębie VNet.
* Usługa jest nadal dostępna poprzez swój publiczny punkt końcowy spoza Twojego VNet, chyba że skonfigurujesz zaporę usługi w celu zablokowania takiego ruchu.
* Istnieje relacja jeden do jednego między podsiecią a usługą Azure.
* Mniej kosztowne niż Prywatne Linki.

**Prywatne Linki:**

* Prywatny Link mapuje usługi Azure do Twojego VNet za pośrednictwem prywatnego punktu końcowego, który jest interfejsem sieciowym z prywatnym adresem IP w Twoim VNet.
* Usługa Azure jest dostępna za pomocą tego prywatnego adresu IP, co sprawia, że wydaje się być częścią Twojej sieci.
* Usługi połączone za pomocą Prywatnego Linku mogą być dostępne tylko z Twojego VNet lub połączonych sieci; nie ma dostępu z publicznego internetu do usługi.
* Umożliwia bezpieczne połączenie z usługami Azure lub Twoimi własnymi usługami hostowanymi w Azure, a także połączenie z usługami udostępnianymi przez innych.
* Zapewnia bardziej szczegółową kontrolę dostępu za pomocą prywatnego punktu końcowego w Twoim VNet, w przeciwieństwie do szerszej kontroli dostępu na poziomie podsieci za pomocą punktów końcowych usługi.

Podsumowując, chociaż zarówno Punkty końcowe usługi, jak i Prywatne Linki zapewniają bezpieczne połączenie z usługami Azure, **Prywatne Linki oferują wyższy poziom izolacji i bezpieczeństwa, zapewniając, że usługi są dostępne prywatnie bez ich wystawiania na publiczny internet**. Punkty końcowe usługi z kolei są łatwiejsze do skonfigurowania w ogólnych przypadkach, gdy wymagane jest proste, bezpieczne dostęp do usług Azure bez konieczności posiadania prywatnego IP w VNet.

## Azure Front Door (AFD) & AFD WAF

**Azure Front Door** to skalowalne i bezpieczne wejście dla **szybkiego dostarczania** globalnych aplikacji internetowych. **Łączy** różne usługi, takie jak globalne **rozdział obciążenia, przyspieszenie witryny, odbieranie SSL oraz zdolności zapory aplikacji internetowej (WAF)** w jedną usługę. Azure Front Door zapewnia inteligentne kierowanie na podstawie **najbliższej lokalizacji krawędziowej dla użytkownika**, zapewniając optymalną wydajność i niezawodność. Dodatkowo oferuje kierowanie oparte na adresach URL, hosting wielu witryn, powiązanie sesji oraz bezpieczeństwo warstwy aplikacji.

**Azure Front Door WAF** został zaprojektowany, aby **chronić aplikacje internetowe przed atakami internetowymi** bez konieczności modyfikacji kodu backendowego. Obejmuje niestandardowe reguły i zarządzane zestawy reguł w celu ochrony przed zagrożeniami, takimi jak wstrzyknięcie SQL, ataki typu cross-site scripting i inne powszechne ataki.

### **Przykład**

* Wyobraź sobie, że masz globalnie rozproszoną aplikację z użytkownikami z całego świata. Możesz użyć Azure Front Door do **kierowania żądań użytkowników do najbliższego regionalnego centrum danych**, w którym hostowana jest Twoja aplikacja, zmniejszając w ten sposób opóźnienia, poprawiając doświadczenie użytkownika i **chroniąc ją przed atakami internetowymi za pomocą zdolności WAF**. Jeśli określony region doświadcza przestoju, Azure Front Door może automatycznie przekierować ruch do najlepszego dostępnego miejsca, zapewniając wysoką dostępność.

### Wyliczenie

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
{% endcode %}

## Azure Application Gateway i Azure Application Gateway WAF

Azure Application Gateway to **bilans obciążenia ruchem sieciowym** umożliwiający zarządzanie ruchem do Twoich **aplikacji internetowych**. Oferuje **bilansowanie obciążenia warstwy 7, zakończenie SSL oraz zdolności zapory aplikacji internetowej (WAF)** w kontrolerze dostarczania aplikacji (ADC) jako usługa. Kluczowe funkcje obejmują trasowanie oparte na adresie URL, powiązanie sesji oparte na plikach cookie oraz odbieranie warstwy bezpiecznych gniazd (SSL), które są kluczowe dla aplikacji wymagających złożonych zdolności bilansowania obciążenia, takich jak globalne trasowanie i trasowanie oparte na ścieżce.

### Przykład

* Rozważ scenariusz, w którym masz stronę internetową e-commerce, która obejmuje wiele subdomen dla różnych funkcji, takich jak konta użytkowników i przetwarzanie płatności. Azure Application Gateway może **kierować ruch do odpowiednich serwerów internetowych na podstawie ścieżki URL**. Na przykład ruch do `example.com/accounts` może być kierowany do usługi kont użytkowników, a ruch do `example.com/pay` może być kierowany do usługi przetwarzania płatności.\
I **chronić Twoją stronę internetową przed atakami, korzystając z możliwości WAF.**

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
{% endcode %}

## Azure Hub, Spoke & VNet Peering

**VNet Peering** to funkcja sieciowa w Azure, która **pozwala na bezpośrednie i płynne połączenie różnych wirtualnych sieci (VNets)**. Dzięki VNet peering, zasoby w jednej VNet mogą komunikować się z zasobami w innej VNet, korzystając z prywatnych adresów IP, **tak jakby były w tej samej sieci**.\
**VNet Peering można również używać z sieciami lokalnymi** poprzez skonfigurowanie VPN typu site-to-site lub Azure ExpressRoute.

**Azure Hub and Spoke** to topologia sieciowa używana w Azure do zarządzania i organizowania ruchu sieciowego. **"Hub" to centralny punkt kontrolujący i kierujący ruchem między różnymi "spokes"**. Hub zazwyczaj zawiera współdzielone usługi, takie jak wirtualne urządzenia sieciowe (NVAs), brama VPN Azure, zapora Azure lub Bastion Azure. **"Spokes" to VNets, które hostują obciążenia robocze i łączą się z hubem za pomocą VNet peering**, pozwalając im korzystać z współdzielonych usług wewnątrz huba. Ten model promuje czytelną strukturę sieci, redukując złożoność poprzez scentralizowanie wspólnych usług, z których mogą korzystać różne obciążenia robocze w różnych VNets.

{% hint style="danger" %}
**VNET pairing nie jest przechodni w Azure**, co oznacza, że jeśli spoke 1 jest połączony z spoke 2, a spoke 2 jest połączony z spoke 3, to spoke 1 nie może bezpośrednio rozmawiać z spoke 3.
{% endhint %}

### Przykłady

* Wyobraź sobie firmę z oddzielnymi działami, takimi jak Sprzedaż, HR i Rozwój, **każdy z własną VNet (spokes)**. Te VNety **potrzebują dostępu do współdzielonych zasobów**, takich jak centralna baza danych, zapora sieciowa i brama internetowa, które znajdują się w **innym VNet (hub)**. Korzystając z modelu Hub and Spoke, każdy dział może **bezpiecznie łączyć się z współdzielonymi zasobami poprzez hub VNet, bez ujawniania tych zasobów publicznemu internetowi** ani tworzenia złożonej struktury sieci z liczbnymi połączeniami.

### Wyliczenie

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
{% endcode %}

## VPN typu Site-to-Site

VPN typu Site-to-Site w Azure pozwala na **połączenie sieci lokalnej z siecią wirtualną Azure (VNet)**, umożliwiając zasobom takim jak maszyny wirtualne w Azure wydawać się, że znajdują się w sieci lokalnej. Połączenie to jest nawiązywane za pomocą **bramy VPN, która szyfruje ruch** między dwiema sieciami.

### **Przykład**

* Firma z główną siedzibą w Nowym Jorku posiada centrum danych on-premises, które musi bezpiecznie połączyć się z VNet w Azure, gdzie znajdują się jej wirtualne obciążenia. Konfigurując **VPN typu Site-to-Site, firma może zapewnić zaszyfrowane połączenie między serwerami on-premises a maszynami wirtualnymi w Azure**, umożliwiając bezpieczny dostęp do zasobów w obu środowiskach, jak gdyby były w tej samej sieci lokalnej.

### **Wyliczanie**
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
{% endcode %}

## Azure ExpressRoute

Azure ExpressRoute to usługa, która zapewnia **prywatne, dedykowane, wysokoprzepustowe połączenie między infrastrukturą lokalną a centrami danych Azure**. Połączenie to jest realizowane za pośrednictwem dostawcy łączności, omijając publiczny internet i oferując większą niezawodność, szybsze prędkości, niższe opóźnienia i wyższe bezpieczeństwo niż typowe połączenia internetowe.

### **Przykład**

* Międzynarodowa korporacja wymaga **stałego i niezawodnego połączenia do swoich usług Azure ze względu na duży wolumen danych** i potrzebę wysokiej przepustowości. Firma decyduje się na usługę Azure ExpressRoute, aby bezpośrednio połączyć swój lokalny centrum danych z Azure, ułatwiając transfer dużej ilości danych, takich jak codzienne kopie zapasowe i analiza danych w czasie rzeczywistym, z zwiększoną prywatnością i szybkością.

### **Wyliczanie**
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
{% endcode %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
