# Az - Azure Network

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Sieci w Azure działają jako integralna część jej platformy obliczeniowej w chmurze, umożliwiając **połączenie i komunikację między różnymi usługami i zasobami Azure**. Architektura sieciowa w Azure została zaprojektowana tak, aby była wysoce skalowalna, bezpieczna i dostosowywalna.

W centrum Azure znajduje się **wirtualna sieć (VNet)**, która umożliwia użytkownikom tworzenie **izolowanych** **sieci** w chmurze Azure. W ramach tych VNet-ów można bezpiecznie hostować i zarządzać zasobami takimi jak wirtualne maszyny, aplikacje i bazy danych. Sieć w Azure obsługuje zarówno komunikację wewnątrz chmury (między usługami Azure), jak i połączenie z zewnętrznymi sieciami i internetem.

**Bezpieczeństwo** jest istotnym aspektem sieci Azure, z różnymi narzędziami i usługami dostępnymi do ochrony danych, zarządzania dostępem i zapewnienia zgodności. Środki bezpieczeństwa te obejmują **firewalle**, **grupy zabezpieczeń sieciowych** i możliwości **szyfrowania**, umożliwiając wysoki poziom kontroli nad ruchem i dostępem.

Ogólnie rzecz biorąc, możliwości sieciowe Azure są projektowane tak, aby oferować elastyczność, umożliwiając użytkownikom tworzenie środowiska sieciowego, które odpowiada ich konkretnym potrzebom aplikacji i obciążenia, jednocześnie zachowując silne naciski na bezpieczeństwo i niezawodność.

## Wirtualna sieć (VNET) i podsieci

VNet w Azure jest w zasadzie reprezentacją Twojej własnej sieci w chmurze. Jest to **logiczna izolacja chmury Azure dedykowana Twojej subskrypcji**. VNet umożliwia tworzenie i zarządzanie wirtualnymi sieciami prywatnymi (VPN) w Azure i może być używany do hostowania i **zarządzania wieloma rodzajami zasobów Azure**, takimi jak wirtualne maszyny (VM), bazy danych i usługi aplikacyjne.

VNety umożliwiają **pełną kontrolę nad ustawieniami sieci**, w tym zakresami **adresów IP**, tworzeniem podsieci, tabelami trasowania i bramkami sieciowymi.

**Podsieć** to **zakres adresów IP w Twoim VNet**. Możesz podzielić VNet na wiele podsieci w celu organizacji i zabezpieczenia. Każda podsieć w VNet może być używana do izolowania i grupowania zasobów zgodnie z architekturą Twojej sieci i aplikacji.

Ponadto, podsieci pozwalają na **segmentację Twojego VNet na jedną lub więcej podsieci**, zapewniając zakres adresów IP, które zasoby mogą używać.

### **Przykład**

* Załóżmy, że masz VNet o nazwie `MyVNet` z zakresem adresów IP `10.0.0.0/16`. Możesz utworzyć podsieć w ramach tego VNetu, powiedzmy `Subnet-1`, z zakresem adresów IP `10.0.0.0/24` do hostowania serwerów WWW. Inna podsieć, `Subnet-2` o zakresie `10.0.1.0/24`, może być używana do serwerów baz danych. Ta segmentacja umożliwia efektywne zarządzanie i kontrolę bezpieczeństwa w ramach sieci.

### Wyliczanie

Aby wyświetlić wszystkie VNety i podsieci w koncie Azure, można użyć interfejsu wiersza poleceń Azure (CLI). Oto kroki:

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
## Grupy zabezpieczeń sieciowych (NSG)

W Azure **Network Security Group (NSG)** pełni główną funkcję filtrowania ruchu sieciowego zarówno do, jak i z zasobów Azure w ramach wirtualnej sieci Azure (VNet). Zawiera zestaw **reguł zabezpieczeń**, które skrupulatnie określają przepływ ruchu sieciowego.

Kluczowe aspekty NSG obejmują:

- **Kontrola ruchu**: Każda NSG zawiera reguły, które są instrumentalne w zezwalaniu lub blokowaniu ruchu sieciowego przychodzącego i wychodzącego z różnych zasobów Azure.
- **Składniki reguł**: Reguły w ramach NSG są bardzo szczegółowe, filtrowanie ruchu oparte jest na kryteriach takich jak adres IP źródła/destynacji, port i protokół. Ta szczegółowość umożliwia precyzyjne zarządzanie ruchem sieciowym.
- **Wzmacnianie zabezpieczeń**: Poprzez zapewnienie, że tylko autoryzowany ruch może wchodzić lub wychodzić z zasobów Azure, NSG odgrywają kluczową rolę w wzmacnianiu bezpieczeństwa infrastruktury sieciowej.

### **Przykład**

* Wyobraź sobie, że masz NSG o nazwie `MyNSG` zastosowaną do podsieci lub konkretnego wirtualnego komputera w Twojej VNet. Możesz tworzyć reguły takie jak:
* Reguła przychodząca, która zezwala na ruch HTTP (port 80) z dowolnego źródła do Twoich serwerów WWW.
* Reguła wychodząca, która zezwala tylko na ruch SQL (port 1433) do określonego zakresu adresów IP docelowych.

### Wyliczanie

{% code overflow="wrap" %}
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table
```
## Azure Firewall

Azure Firewall to zarządzana, oparta na chmurze **usługa bezpieczeństwa sieciowego, która chroni zasoby wirtualnej sieci Azure**. Jest to pełnowartościowy, zarządzany jako usługa firewall z wbudowanymi funkcjami wysokiej dostępności i skalowalności.

Azure Firewall oferuje **bardziej zaawansowane** funkcje niż **NSG**, w tym filtrowanie na poziomie aplikacji, filtrowanie na poziomie sieci, filtrowanie oparte na inteligencji zagrożeń oraz integrację z Azure Monitor w celu logowania i analizy.\
Może filtrować ruch wychodzący, przychodzący, między strefami, ruch VPN i ExpressRoute. **Reguły firewalla mogą być tworzone na podstawie FQDN (Fully Qualified Domain Name), adresów IP i portów**.

### Różnice między Azure Firewall a NSGs&#x20;

1. **Zakres:**
* **NSG:** Działa na poziomie podsieci lub interfejsu sieciowego. Ma na celu zapewnienie podstawowego filtrowania ruchu przychodzącego i wychodzącego z interfejsów sieciowych (NIC), maszyn wirtualnych lub podsieci.
* **Azure Firewall:** Działa na poziomie VNet, zapewniając szerszy zakres ochrony. Został zaprojektowany do zabezpieczania zasobów wirtualnej sieci i zarządzania ruchem wchodzącym i wychodzącym z VNet.
2. **Możliwości:**
* **NSG:** Oferuje podstawowe możliwości filtrowania oparte na adresie IP, porcie i protokole. Nie obsługuje zaawansowanych funkcji, takich jak kontrola na poziomie aplikacji lub inteligencja zagrożeń.
* **Azure Firewall:** Oferuje zaawansowane funkcje, takie jak filtrowanie ruchu na poziomie aplikacji (warstwa 7), filtrowanie oparte na inteligencji zagrożeń, filtrowanie ruchu sieciowego i wiele innych. Obsługuje również wiele publicznych adresów IP.
3. **Przypadki użycia:**
* **NSG:** Idealny do podstawowego filtrowania ruchu na poziomie sieci.
* **Azure Firewall:** Nadaje się do bardziej zaawansowanych scenariuszy filtrowania, w których wymagana jest kontrola na poziomie aplikacji, logowanie i inteligencja zagrożeń.
4. **Zarządzanie i monitorowanie:**
* **NSG:** Oferuje podstawowe logowanie i integrację z Azure Monitor.
* **Azure Firewall:** Zapewnia zaawansowane możliwości logowania i analizy za pomocą Azure Monitor, co jest niezbędne do zrozumienia charakteru i wzorca ruchu.

### Wyliczanie

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
## Wirtualne urządzenie sieciowe (NVA)

Wirtualne urządzenie sieciowe (**NVA**) w Azure to wirtualne urządzenie, które **wykonuje funkcje sieciowe w ramach wirtualnej sieci**. NVA są zwykle używane do funkcji sieciowych, które **nie są dostępne natywnie** w Azure lub gdy wymagana jest większa dostosowalność. Są to w zasadzie **maszyny wirtualne, które uruchamiają aplikacje lub usługi sieciowe**, takie jak zapory ogniowe, optymalizatory WAN lub równoważniki obciążenia.

NVA są używane do zadań związanych z **zaawansowanym routowaniem**, **bezpieczeństwem** i **zarządzaniem ruchem sieciowym**. Mogą być wdrażane z **Azure Marketplace**, gdzie wielu dostawców zewnętrznych oferuje swoje urządzenia gotowe do integracji z środowiskami Azure.

### **Przykład**

* Organizacja może wdrożyć NVA w Azure, aby stworzyć **niestandardowe rozwiązanie zapory ogniowej**. To NVA może uruchamiać **oprogramowanie zapory ogniowej innych dostawców**, zapewniając zaawansowane funkcje, takie jak wykrywanie włamań, inspekcja pakietów lub łączność VPN. NVA można skonfigurować do inspekcji i filtrowania ruchu przechodzącego przez niego, zapewniając wzmocnione środki bezpieczeństwa zgodnie z politykami organizacji.

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# Usually NVAs are named or tagged in a way to distinguish them from other VMs
az vm list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# For a specific VM identified as an NVA, list its network interfaces
az vm nic list --vm-name <VMName> --resource-group <ResourceGroupName> --query "[].{id:id}" -o table
```
## Tabele trasowania Azure i Trasy zdefiniowane przez użytkownika (UDR)

**Tabele trasowania Azure** to funkcja w ramach Microsoft Azure, która umożliwia **kontrolę trasowania ruchu sieciowego w ramach Wirtualnych Sieci Azure (VNets)**. W zasadzie, definiują one, jak **pakiety** są **przekazywane** między podsieciami w ramach VNets, między VNets lub do sieci zewnętrznych. Każda tabela trasowania zawiera zestaw reguł, zwanych trasami, które określają, jak pakiety powinny być kierowane na podstawie ich docelowych adresów IP.

**Trasy zdefiniowane przez użytkownika (UDR)** w Azure to **niestandardowe trasy, które tworzysz w ramach tabel trasowania Azure**, aby kontrolować **przepływ ruchu sieciowego** wewnątrz i między Wirtualnymi Sieciami Azure (VNets) oraz do połączeń zewnętrznych. UDR umożliwiają elastyczne kierowanie ruchem sieciowym zgodnie z określonymi wymaganiami, zastępując domyślne decyzje dotyczące trasowania w Azure.

Te trasy są szczególnie przydatne w scenariuszach, w których musisz **kierować ruchem przez wirtualne urządzenie**, narzucić określoną ścieżkę dla celów bezpieczeństwa lub zgodności z polityką, lub zintegrować się z sieciami lokalnymi.

### **Przykład**

* Załóżmy, że wdrożyłeś Wirtualne Urządzenie Sieciowe (NVA), które ma sprawdzać ruch między podsieciami w ramach VNet. Możesz utworzyć UDR, który kieruje cały ruch z jednej podsieci do drugiej przez NVA. Ten UDR zapewnia, że NVA sprawdza ruch w celach bezpieczeństwa przed dotarciem do celu.

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List UDRs for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure Private Link

Azure Private Link to usługa w Azure, która **umożliwia prywatny dostęp do usług Azure**, zapewniając, że **ruch między wirtualną siecią Azure (VNet) a usługą odbywa się całkowicie w sieci rdzennej Azure firmy Microsoft**. Efektywnie przenosi usługę do Twojej VNet. Ta konfiguracja zwiększa bezpieczeństwo, nie wystawiając danych na publiczne internet.

Private Link można używać z różnymi usługami Azure, takimi jak Azure Storage, Azure SQL Database i niestandardowymi usługami udostępnianymi za pośrednictwem Private Link. Zapewnia on bezpieczny sposób korzystania z usług z własnej VNet lub nawet z różnych subskrypcji Azure.

{% hint style="danger" %}
NSG nie ma zastosowania do prywatnych punktów końcowych, co jasno oznacza, że przypisanie NSG do podsieci zawierającej Private Link nie będzie miało żadnego efektu.
{% endhint %}

### **Przykład**

* Rozważmy scenariusz, w którym masz **Azure SQL Database, do którego chcesz mieć bezpieczny dostęp z Twojej VNet**. Normalnie, mogłoby to wymagać przejścia przez publiczny internet. Dzięki Private Link możesz utworzyć **prywatny punkt końcowy w Twojej VNet**, który łączy się bezpośrednio z usługą Azure SQL Database. Ten punkt końcowy sprawia, że baza danych wydaje się być częścią Twojej własnej VNet, dostępną za pomocą prywatnego adresu IP, zapewniając tym samym bezpieczny i prywatny dostęp.

### **Wyliczenie**

{% code overflow="wrap" %}
```bash
# List Private Link Services
z network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
## Usługi punktów końcowych Azure

Usługi punktów końcowych Azure rozszerzają prywatną przestrzeń adresową wirtualnej sieci oraz tożsamość Twojej VNet do usług Azure poprzez bezpośrednie połączenie. Włączając punkty końcowe usług, **zasoby w Twojej VNet mogą bezpiecznie łączyć się z usługami Azure**, takimi jak Azure Storage i Azure SQL Database, korzystając z sieci rdzenia Azure. Zapewnia to, że **ruch z VNet do usługi Azure pozostaje w obrębie sieci Azure**, co zapewnia bardziej bezpieczną i niezawodną ścieżkę.

### **Przykład**

* Na przykład, konto **Azure Storage** domyślnie jest dostępne przez publiczny internet. Włączając **punkt końcowy usługi dla Azure Storage w Twojej VNet**, możesz zapewnić, że tylko ruch z Twojej VNet ma dostęp do konta magazynu. Zapora konta magazynu może być następnie skonfigurowana tak, aby akceptować tylko ruch z Twojej VNet.

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
{% endcode %}

### Różnice między punktami końcowymi usługi a prywatnymi linkami

Microsoft zaleca korzystanie z prywatnych linków w [**dokumentacji**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints):\


<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Punkty końcowe usługi:**

* Ruch z Twojej sieci wirtualnej do usługi Azure odbywa się przez sieć centralną Microsoft Azure, omijając publiczny internet.
* Punkt końcowy to bezpośrednie połączenie z usługą Azure i nie zapewnia prywatnego adresu IP dla usługi w ramach sieci wirtualnej.
* Usługa jest nadal dostępna za pośrednictwem swojego publicznego punktu końcowego spoza Twojej sieci wirtualnej, chyba że skonfigurujesz zaporę usługi w celu blokowania takiego ruchu.
* Jest to relacja jeden do jednego między podsiecią a usługą Azure.
* Mniej kosztowne niż prywatne linki.

**Prywatne linki:**

* Prywatny link mapuje usługi Azure do Twojej sieci wirtualnej za pośrednictwem prywatnego punktu końcowego, który jest interfejsem sieciowym z prywatnym adresem IP w Twojej sieci wirtualnej.
* Usługa Azure jest dostępna za pomocą tego prywatnego adresu IP, co sprawia, że wydaje się być częścią Twojej sieci.
* Usługi połączone za pomocą prywatnego linku można uzyskać tylko z Twojej sieci wirtualnej lub połączonych sieci; nie ma dostępu do usługi z publicznego internetu.
* Umożliwia bezpieczne połączenie z usługami Azure lub Twoimi własnymi usługami hostowanymi w Azure, a także połączenie z usługami udostępnianymi przez innych.
* Zapewnia bardziej szczegółową kontrolę dostępu za pośrednictwem prywatnego punktu końcowego w Twojej sieci wirtualnej, w przeciwieństwie do szerszej kontroli dostępu na poziomie podsieci za pomocą punktów końcowych usługi.

Podsumowując, chociaż zarówno punkty końcowe usługi, jak i prywatne linki zapewniają bezpieczne połączenie z usługami Azure, **prywatne linki oferują wyższy poziom izolacji i bezpieczeństwa, zapewniając, że usługi są dostępne prywatnie bez ich eksponowania w publicznym internecie**. Punkty końcowe usługi natomiast są łatwiejsze do skonfigurowania w przypadkach ogólnych, gdzie wymagane jest proste, bezpieczne dostęp do usług Azure bez potrzeby prywatnego adresu IP w sieci wirtualnej.

## Azure Front Door (AFD) i AFD WAF

**Azure Front Door** to skalowalne i bezpieczne wejście do **szybkiego dostarczania** globalnych aplikacji internetowych. **Łączy** różne usługi, takie jak globalne **rozłożenie obciążenia, przyspieszenie witryny, rozładowanie SSL i zapora aplikacji internetowych (WAF)**, w jedną usługę. Azure Front Door zapewnia inteligentne kierowanie na podstawie **najbliższego punktu końcowego do użytkownika**, zapewniając optymalną wydajność i niezawodność. Dodatkowo oferuje kierowanie oparte na adresie URL, hosting wielu witryn, powiązanie sesji i zabezpieczenia na poziomie aplikacji.

**Azure Front Door WAF** został zaprojektowany w celu **ochrony aplikacji internetowych przed atakami opartymi na sieci web**, bez konieczności modyfikacji kodu backendowego. Zawiera niestandardowe reguły i zarządzane zestawy reguł, które chronią przed zagrożeniami takimi jak wstrzyknięcie SQL, ataki typu cross-site scripting i inne powszechne ataki.

### **Przykład**

* Wyobraź sobie, że masz globalnie rozproszoną aplikację z użytkownikami z całego świata. Możesz użyć Azure Front Door, aby **kierować żądania użytkowników do najbliższego regionalnego centrum danych**, w którym hostowana jest Twoja aplikacja, zmniejszając tym samym opóźnienia, poprawiając doświadczenie użytkownika i **chroniąc ją przed atakami sieciowymi za pomocą funkcji WAF**. Jeśli w określonym regionie wystąpi awaria, Azure Front Door może automatycznie przekierować ruch do następnego najlepszego miejsca, zapewniając wysoką dostępność.

### Wyliczanie

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
## Azure Application Gateway i Azure Application Gateway WAF

Azure Application Gateway to **balanser obciążenia ruchu sieciowego** dla aplikacji **internetowych**, który umożliwia zarządzanie ruchem do Twoich aplikacji internetowych. Oferuje **balansowanie obciążenia warstwy 7, zakończenie SSL i możliwości zapory aplikacji internetowej (WAF)** w kontrolerze dostarczania aplikacji (ADC) jako usługa. Kluczowe funkcje obejmują routowanie oparte na adresie URL, powiązanie sesji oparte na plikach cookie i odbieranie warstwy bezpiecznych gniazd (SSL), które są niezbędne dla aplikacji wymagających zaawansowanych możliwości balansowania obciążenia, takich jak globalne routowanie i routowanie oparte na ścieżce.

### Przykład

* Rozważmy scenariusz, w którym masz stronę internetową e-commerce, która zawiera wiele subdomen dla różnych funkcji, takich jak konta użytkowników i przetwarzanie płatności. Azure Application Gateway może **kierować ruch do odpowiednich serwerów internetowych na podstawie ścieżki URL**. Na przykład, ruch do `example.com/accounts` może być kierowany do usługi kont użytkowników, a ruch do `example.com/pay` może być kierowany do usługi przetwarzania płatności.\
I **chronić Twoją stronę internetową przed atakami, korzystając z możliwości WAF.**

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
{% endcode %}

## Azure Hub, Spoke & VNet Peering

**VNet Peering** to funkcja sieciowa w Azure, która **pozwala na bezpośrednie i płynne połączenie różnych wirtualnych sieci (VNets)**. Dzięki VNet peering, zasoby w jednej VNet mogą komunikować się z zasobami w innej VNet za pomocą prywatnych adresów IP, **tak jakby były w tej samej sieci**.\
**VNet Peering można również używać z sieciami lokalnymi** poprzez skonfigurowanie VPN typu site-to-site lub Azure ExpressRoute.

**Azure Hub and Spoke** to topologia sieciowa używana w Azure do zarządzania i organizowania ruchu sieciowego. **"Hub" to centralny punkt kontrolujący i kierujący ruchem między różnymi "spokes"**. Hub zazwyczaj zawiera współdzielone usługi, takie jak wirtualne urządzenia sieciowe (NVAs), brama VPN Azure, zapora Azure lub Azure Bastion. **"Spokes" to VNets, które hostują obciążenia i łączą się z hubem za pomocą VNet peering**, co pozwala im korzystać z współdzielonych usług w ramach huba. Ten model promuje czytelną strukturę sieci, redukując złożoność poprzez scentralizowanie wspólnych usług, z których mogą korzystać różne obciążenia w różnych VNets.

{% hint style="danger" %}
**VNET pairing nie jest przechodnie w Azure**, co oznacza, że jeśli spoke 1 jest połączony z spoke 2, a spoke 2 jest połączony z spoke 3, to spoke 1 nie może bezpośrednio rozmawiać z spoke 3.
{% endhint %}

### Przykłady

* Wyobraź sobie firmę z oddzielnymi działami, takimi jak Sprzedaż, HR i Rozwój, **każdy z własną VNet (spokes)**. Te VNets **wymagają dostępu do współdzielonych zasobów**, takich jak centralna baza danych, zapora sieciowa i brama internetowa, które znajdują się w **innym VNet (hub)**. Korzystając z modelu Hub and Spoke, każdy dział może **bezpiecznie łączyć się z współdzielonymi zasobami za pośrednictwem huba VNet, bez ujawniania tych zasobów publicznemu internetowi** lub tworzenia złożonej struktury sieciowej z liczba połączeń.

### Wyliczanie

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
## Site-to-Site VPN

Site-to-Site VPN w Azure umożliwia **połączenie sieci lokalnej z siecią wirtualną Azure (VNet)**, co pozwala na to, że zasoby takie jak maszyny wirtualne w Azure wydają się być na lokalnej sieci. Połączenie to jest nawiązywane za pomocą **bramy VPN, która szyfruje ruch** między dwiema sieciami.

### **Przykład**

* Firma z główną siedzibą w Nowym Jorku posiada centrum danych na miejscu, które musi bezpiecznie połączyć się z VNet w Azure, gdzie znajdują się jej wirtualizowane obciążenia. Ustawiając **Site-to-Site VPN, firma może zapewnić szyfrowane połączenie między serwerami na miejscu a maszynami wirtualnymi Azure**, umożliwiając bezpieczny dostęp do zasobów w obu środowiskach, tak jakby były w tej samej lokalnej sieci.

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
## Azure ExpressRoute

Azure ExpressRoute to usługa, która zapewnia **prywatne, dedykowane, szybkie połączenie między Twoją infrastrukturą lokalną a centrami danych Azure**. To połączenie jest realizowane za pośrednictwem dostawcy łączności, omijając publiczny internet i oferując większą niezawodność, szybsze prędkości, niższe opóźnienia i wyższe bezpieczeństwo w porównaniu do typowych połączeń internetowych.

### **Przykład**

* Międzynarodowa korporacja wymaga **stałego i niezawodnego połączenia z usługami Azure ze względu na dużą ilość danych** i potrzebę wysokiej przepustowości. Firma decyduje się na Azure ExpressRoute, aby bezpośrednio połączyć swoje centrum danych lokalne z Azure, ułatwiając przesyłanie danych w dużych ilościach, takie jak codzienne kopie zapasowe i analiza danych w czasie rzeczywistym, zwiększając prywatność i prędkość.

### **Wyliczanie**

{% code overflow="wrap" %}
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
{% endcode %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
