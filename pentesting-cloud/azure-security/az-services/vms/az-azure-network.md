# Az - Rede Azure

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

As redes dentro da Azure funcionam como parte integrante de sua plataforma de computa√ß√£o em nuvem, permitindo a **conex√£o e comunica√ß√£o entre v√°rios servi√ßos e recursos da Azure**. A arquitetura de rede na Azure √© projetada para ser altamente escal√°vel, segura e personaliz√°vel.

No cerne, a Azure fornece uma **rede virtual (VNet)** que permite aos usu√°rios criar **redes isoladas** dentro da nuvem da Azure. Dentro dessas VNets, recursos como m√°quinas virtuais, aplicativos e bancos de dados podem ser hospedados e gerenciados com seguran√ßa. A rede na Azure suporta tanto a comunica√ß√£o dentro da nuvem (entre os servi√ßos da Azure) quanto a conex√£o com redes externas e a internet.

A **seguran√ßa** √© um aspecto cr√≠tico da rede da Azure, com v√°rias ferramentas e servi√ßos dispon√≠veis para proteger dados, gerenciar acesso e garantir conformidade. Essas medidas de seguran√ßa incluem **firewalls**, **grupos de seguran√ßa de rede** e capacidades de **criptografia**, permitindo um alto n√≠vel de controle sobre o tr√°fego e o acesso.

No geral, as capacidades de rede da Azure s√£o projetadas para oferecer flexibilidade, permitindo aos usu√°rios criar um ambiente de rede que atenda √†s necessidades espec√≠ficas de aplicativos e cargas de trabalho, mantendo um forte foco em seguran√ßa e confiabilidade.

## Rede Virtual (VNET) e Sub-redes

Uma VNet na Azure √© essencialmente uma representa√ß√£o de sua pr√≥pria rede na nuvem. √â um **isolamento l√≥gico da nuvem da Azure dedicado √† sua assinatura**. Uma VNet permite que voc√™ provisione e gerencie redes privadas virtuais (VPNs) na Azure e pode ser usada para hospedar e **gerenciar v√°rios tipos de recursos da Azure**, como M√°quinas Virtuais (VMs), bancos de dados e servi√ßos de aplicativos.

As VNets fornecem a voc√™ **controle total sobre as configura√ß√µes de sua rede**, incluindo **intervalos de endere√ßos IP**, cria√ß√£o de sub-redes, tabelas de roteamento e gateways de rede.

Uma **sub-rede** √© um **intervalo de endere√ßos IP em sua VNet**. Voc√™ pode dividir uma VNet em v√°rias sub-redes para organiza√ß√£o e seguran√ßa. Cada sub-rede em uma VNet pode ser usada para isolar e agrupar recursos de acordo com sua arquitetura de rede e aplicativo.

Al√©m disso, as sub-redes permitem que voc√™ **segmente sua VNet em uma ou mais sub-redes**, fornecendo um intervalo de endere√ßos IP que os recursos podem usar.

### **Exemplo**

* Suponha que voc√™ tenha uma VNet chamada `MyVNet` com um intervalo de endere√ßos IP de `10.0.0.0/16`. Voc√™ pode criar uma sub-rede dentro desta VNet, digamos `Subnet-1`, com um intervalo de endere√ßos IP de `10.0.0.0/24` para hospedar seus servidores web. Outra sub-rede, `Subnet-2` com um intervalo de `10.0.1.0/24`, poderia ser usada para seus servidores de banco de dados. Essa segmenta√ß√£o permite um gerenciamento eficiente e controles de seguran√ßa dentro da rede.

### Enumera√ß√£o

Para listar todas as VNets e sub-redes em uma conta Azure, voc√™ pode usar a Interface de Linha de Comando (CLI) da Azure. Aqui est√£o os passos:

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
## Grupos de Seguran√ßa de Rede (NSG)

No Azure, um **Grupo de Seguran√ßa de Rede (NSG)** serve a fun√ß√£o principal de filtrar o tr√°fego de rede tanto para quanto a partir de recursos do Azure dentro de uma Rede Virtual do Azure (VNet). Ele cont√©m um conjunto de **regras de seguran√ßa** que ditam meticulosamente o fluxo de tr√°fego de rede.

Aspectos-chave do NSG incluem:

- **Controle de Tr√°fego**: Cada NSG cont√©m regras que s√£o instrumentais em permitir ou obstruir o tr√°fego de rede de entrada e sa√≠da associado a v√°rios recursos do Azure.
- **Componentes da Regra**: As regras dentro de um NSG s√£o altamente espec√≠ficas, filtrando o tr√°fego com base em crit√©rios como endere√ßo IP de origem/destino, porta e protocolo. Essa especificidade permite o gerenciamento granular do tr√°fego de rede.
- **Aprimoramento da Seguran√ßa**: Ao garantir que apenas o tr√°fego autorizado possa entrar ou sair de seus recursos do Azure, os NSGs desempenham um papel crucial em fortalecer a postura de seguran√ßa de sua infraestrutura de rede.

### **Exemplo**

* Imagine que voc√™ tenha um NSG chamado `MeuNSG` aplicado a uma sub-rede ou a uma m√°quina virtual espec√≠fica dentro da sua VNet. Voc√™ pode criar regras como:
* Uma regra de entrada permitindo tr√°fego HTTP (porta 80) de qualquer origem para seus servidores web.
* Uma regra de sa√≠da permitindo apenas tr√°fego SQL (porta 1433) para uma faixa de endere√ßos IP de destino espec√≠fica.

### Enumera√ß√£o
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table
```
{% endcode %}

## Firewall do Azure

O Firewall do Azure √© um servi√ßo de seguran√ßa de rede gerenciado baseado em nuvem que protege os recursos da sua Rede Virtual do Azure. √â um firewall totalmente stateful como servi√ßo com recursos integrados de alta disponibilidade e escalabilidade.

O Firewall do Azure oferece recursos mais avan√ßados do que os NSGs, incluindo filtragem em n√≠vel de aplicativo, filtragem em n√≠vel de rede, filtragem baseada em intelig√™ncia de amea√ßas e integra√ß√£o com o Azure Monitor para registro e an√°lise.\
Ele pode filtrar o tr√°fego de sa√≠da, entrada, de spoke para spoke, VPN e ExpressRoute. As regras do firewall podem ser criadas com base em FQDN (Nome de Dom√≠nio Totalmente Qualificado), endere√ßos IP e portas.

### Diferen√ßas entre o Firewall do Azure e os NSGs

1. **Escopo:**
* **NSG:** Funciona no n√≠vel de sub-rede ou interface de rede. Destina-se a fornecer filtragem b√°sica de tr√°fego de entrada e sa√≠da das interfaces de rede (NIC), VMs ou sub-redes.
* **Firewall do Azure:** Opera no n√≠vel do VNet, fornecendo um escopo mais amplo de prote√ß√£o. Ele √© projetado para proteger seus recursos de rede virtual e gerenciar o tr√°fego que entra e sai do VNet.
2. **Capacidades:**
* **NSG:** Fornece capacidades b√°sicas de filtragem com base em endere√ßo IP, porta e protocolo. N√£o oferece suporte a recursos avan√ßados como inspe√ß√£o em n√≠vel de aplicativo ou intelig√™ncia de amea√ßas.
* **Firewall do Azure:** Oferece recursos avan√ßados como filtragem de tr√°fego em n√≠vel de aplicativo (Camada 7), filtragem baseada em intelig√™ncia de amea√ßas, filtragem de tr√°fego de rede e mais. Tamb√©m suporta v√°rios endere√ßos IP p√∫blicos.
3. **Casos de Uso:**
* **NSG:** Ideal para filtragem b√°sica de tr√°fego em n√≠vel de rede.
* **Firewall do Azure:** Adequado para cen√°rios de filtragem mais complexos onde √© necess√°ria controle em n√≠vel de aplicativo, registro e intelig√™ncia de amea√ßas.
4. **Gerenciamento e Monitoramento:**
* **NSG:** Oferece registro b√°sico e integra√ß√£o com o Azure Monitor.
* **Firewall do Azure:** Fornece recursos avan√ßados de registro e an√°lise por meio do Azure Monitor, essenciais para entender a natureza e o padr√£o do tr√°fego.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
## Appliance Virtual de Rede (NVA)

Uma Appliance Virtual de Rede (**NVA**) no Azure √© uma appliance virtual que **realiza fun√ß√µes de rede dentro de uma rede virtual**. As NVAs s√£o tipicamente usadas para fun√ß√µes de rede que **n√£o est√£o nativamente dispon√≠veis** no Azure ou quando √© necess√°ria mais personaliza√ß√£o. Elas s√£o essencialmente **VMs que executam aplicativos ou servi√ßos de rede**, como firewalls, otimizadores WAN ou balanceadores de carga.

As NVAs s√£o usadas para roteamento complexo, **seguran√ßa** e tarefas de **gerenciamento de tr√°fego de rede**. Elas podem ser implantadas a partir do **Marketplace** do Azure, onde muitos fornecedores de terceiros oferecem suas appliances prontas para integra√ß√£o em ambientes do Azure.

### **Exemplo**

* Uma organiza√ß√£o pode implantar uma NVA no Azure para criar uma **solu√ß√£o de firewall personalizada**. Esta NVA poderia executar um **software de firewall de terceiros**, fornecendo recursos avan√ßados como detec√ß√£o de intrus√£o, inspe√ß√£o de pacotes ou conectividade VPN. A NVA pode ser configurada para inspecionar e filtrar o tr√°fego que passa por ela, garantindo que medidas de seguran√ßa aprimoradas estejam em vigor de acordo com as pol√≠ticas da organiza√ß√£o.

### **Enumera√ß√£o**
```bash
# Usually NVAs are named or tagged in a way to distinguish them from other VMs
az vm list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# For a specific VM identified as an NVA, list its network interfaces
az vm nic list --vm-name <VMName> --resource-group <ResourceGroupName> --query "[].{id:id}" -o table
```
{% endcode %}

## Tabelas de Roteamento do Azure e Rotas Definidas pelo Usu√°rio (UDR)

As **Tabelas de Roteamento do Azure** s√£o um recurso dentro do Microsoft Azure que permite o **controle do roteamento do tr√°fego de rede dentro das Redes Virtuais do Azure (VNets)**. Basicamente, elas definem como os **pacotes** s√£o **encaminhados** entre sub-redes dentro das VNets, entre VNets ou para redes externas. Cada tabela de roteamento cont√©m um conjunto de regras, conhecidas como rotas, que especificam como os pacotes devem ser roteados com base em seus endere√ßos IP de destino.

As **Rotas Definidas pelo Usu√°rio (UDR)** no Azure s√£o **rotas personalizadas que voc√™ cria dentro das Tabelas de Roteamento do Azure** para controlar o **fluxo de tr√°fego de rede** dentro e entre as Redes Virtuais do Azure (VNets) e para conex√µes externas. As UDRs oferecem a flexibilidade de direcionar o tr√°fego de rede de acordo com seus requisitos espec√≠ficos, substituindo as decis√µes de roteamento padr√£o do Azure.

Essas rotas s√£o particularmente √∫teis em cen√°rios onde voc√™ precisa **rotear o tr√°fego por um appliance virtual**, impor um caminho espec√≠fico para seguran√ßa ou conformidade com pol√≠ticas, ou integrar com redes locais.

### **Exemplo**

* Suponha que voc√™ tenha implantado um Appliance Virtual de Rede (NVA) para inspecionar o tr√°fego entre sub-redes dentro de uma VNet. Voc√™ pode criar uma UDR que direcione todo o tr√°fego de uma sub-rede para outra sub-rede para passar pelo NVA. Essa UDR garante que o NVA inspecione o tr√°fego para fins de seguran√ßa antes de chegar ao seu destino.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List UDRs for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure Private Link

O Azure Private Link √© um servi√ßo no Azure que **permite acesso privado aos servi√ßos do Azure** garantindo que **o tr√°fego entre sua rede virtual do Azure (VNet) e o servi√ßo viaje inteiramente dentro da rede principal do Azure da Microsoft**. Ele efetivamente traz o servi√ßo para dentro da sua VNet. Essa configura√ß√£o melhora a seguran√ßa ao n√£o expor os dados √† internet p√∫blica.

O Private Link pode ser usado com v√°rios servi√ßos do Azure, como Armazenamento do Azure, Banco de Dados SQL do Azure e servi√ßos personalizados compartilhados via Private Link. Ele fornece uma maneira segura de consumir servi√ßos de dentro da sua pr√≥pria VNet ou at√© mesmo de diferentes assinaturas do Azure.

{% hint style="danger" %}
As NSGs n√£o se aplicam aos pontos de extremidade privados, o que significa claramente que associar uma NSG a uma sub-rede que contenha o Private Link n√£o ter√° efeito.
{% endhint %}

### **Exemplo**

* Considere um cen√°rio em que voc√™ tem um **Banco de Dados SQL do Azure que deseja acessar de forma segura a partir da sua VNet**. Normalmente, isso poderia envolver atravessar a internet p√∫blica. Com o Private Link, voc√™ pode criar um **ponto de extremidade privado em sua VNet** que se conecta diretamente ao servi√ßo de Banco de Dados SQL do Azure. Esse ponto de extremidade faz com que o banco de dados pare√ßa fazer parte da sua pr√≥pria VNet, acess√≠vel por meio de um endere√ßo IP privado, garantindo assim acesso seguro e privado.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List Private Link Services
z network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
## Pontos de Servi√ßo do Azure

Os Pontos de Servi√ßo do Azure estendem o espa√ßo de endere√ßo privado da sua rede virtual e a identidade da sua VNet para os servi√ßos do Azure por meio de uma conex√£o direta. Ao habilitar os pontos de servi√ßo, **os recursos na sua VNet podem se conectar de forma segura aos servi√ßos do Azure**, como o Armazenamento do Azure e o Banco de Dados SQL do Azure, usando a rede principal do Azure. Isso garante que o **tr√°fego da VNet para o servi√ßo do Azure permane√ßa dentro da rede do Azure**, proporcionando um caminho mais seguro e confi√°vel.

### **Exemplo**

* Por exemplo, uma conta de **Armazenamento do Azure** por padr√£o √© acess√≠vel pela internet p√∫blica. Ao habilitar um **ponto de servi√ßo para o Armazenamento do Azure dentro da sua VNet**, voc√™ pode garantir que apenas o tr√°fego da sua VNet possa acessar a conta de armazenamento. O firewall da conta de armazenamento pode ent√£o ser configurado para aceitar tr√°fego apenas da sua VNet.

### **Enumera√ß√£o**
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
{% endcode %}

### Diferen√ßas entre Pontos de Servi√ßo e Links Privados

A Microsoft recomenda o uso de Links Privados na [**documenta√ß√£o**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints):\

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Pontos de Servi√ßo:**

* O tr√°fego do seu VNet para o servi√ßo Azure viaja pela rede principal da Microsoft Azure, contornando a internet p√∫blica.
* O ponto final √© uma conex√£o direta com o servi√ßo Azure e n√£o fornece um IP privado para o servi√ßo dentro do VNet.
* O pr√≥prio servi√ßo ainda √© acess√≠vel por meio de seu ponto final p√∫blico de fora do seu VNet, a menos que voc√™ configure o firewall do servi√ßo para bloquear esse tr√°fego.
* √â uma rela√ß√£o um para um entre a sub-rede e o servi√ßo Azure.
* Menos caro do que os Links Privados.

**Links Privados:**

* O Link Privado mapeia os servi√ßos Azure em seu VNet por meio de um ponto final privado, que √© uma interface de rede com um endere√ßo IP privado dentro do seu VNet.
* O servi√ßo Azure √© acessado usando este endere√ßo IP privado, fazendo com que pare√ßa fazer parte de sua rede.
* Servi√ßos conectados via Link Privado s√≥ podem ser acessados a partir do seu VNet ou de redes conectadas; n√£o h√° acesso √† internet p√∫blica para o servi√ßo.
* Ele permite uma conex√£o segura com os servi√ßos Azure ou seus pr√≥prios servi√ßos hospedados no Azure, bem como uma conex√£o com servi√ßos compartilhados por outros.
* Ele fornece um controle de acesso mais granular por meio de um ponto final privado em seu VNet, em oposi√ß√£o a um controle de acesso mais amplo no n√≠vel da sub-rede com pontos de servi√ßo.

Em resumo, enquanto Pontos de Servi√ßo e Links Privados fornecem conectividade segura aos servi√ßos Azure, **os Links Privados oferecem um n√≠vel mais alto de isolamento e seguran√ßa, garantindo que os servi√ßos sejam acessados de forma privada sem exp√¥-los √† internet p√∫blica**. Os Pontos de Servi√ßo, por outro lado, s√£o mais f√°ceis de configurar para casos gerais em que √© necess√°ria uma acesso simples e seguro aos servi√ßos Azure sem a necessidade de um IP privado no VNet.

## Azure Front Door (AFD) & AFD WAF

**Azure Front Door** √© um ponto de entrada escal√°vel e seguro para **entrega r√°pida** de suas aplica√ß√µes web globais. Ele **combina** v√°rios servi√ßos como **balanceamento de carga global, acelera√ß√£o de site, descarregamento SSL e capacidades de Firewall de Aplicativos Web (WAF)** em um √∫nico servi√ßo. O Azure Front Door fornece roteamento inteligente com base na **localiza√ß√£o de borda mais pr√≥xima do usu√°rio**, garantindo desempenho e confiabilidade √≥timos. Al√©m disso, oferece roteamento baseado em URL, hospedagem de v√°rios sites, afinidade de sess√£o e seguran√ßa em camada de aplicativo.

**Azure Front Door WAF** √© projetado para **proteger aplica√ß√µes web de ataques baseados na web** sem modifica√ß√£o no c√≥digo de back-end. Ele inclui regras personalizadas e conjuntos de regras gerenciadas para proteger contra amea√ßas como inje√ß√£o de SQL, scripts entre sites e outros ataques comuns.

### **Exemplo**

* Imagine que voc√™ tenha uma aplica√ß√£o distribu√≠da globalmente com usu√°rios em todo o mundo. Voc√™ pode usar o Azure Front Door para **rotear as solicita√ß√µes dos usu√°rios para o centro de dados regional mais pr√≥ximo** que hospeda sua aplica√ß√£o, reduzindo assim a lat√™ncia, melhorando a experi√™ncia do usu√°rio e **defendendo-a de ataques web com as capacidades do WAF**. Se uma regi√£o espec√≠fica enfrentar tempo de inatividade, o Azure Front Door pode redirecionar automaticamente o tr√°fego para a pr√≥xima melhor localiza√ß√£o, garantindo alta disponibilidade.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
## Azure Application Gateway e Azure Application Gateway WAF

O Azure Application Gateway √© um **balanceador de carga de tr√°fego web** que permite gerenciar o tr√°fego para suas aplica√ß√µes **web**. Ele oferece **balanceamento de carga na Camada 7, termina√ß√£o SSL e capacidades de firewall de aplica√ß√£o web (WAF)** no Controlador de Entrega de Aplicativos (ADC) como um servi√ßo. As principais caracter√≠sticas incluem roteamento baseado em URL, afinidade de sess√£o baseada em cookies e descarregamento de camada de soquetes seguros (SSL), que s√£o cruciais para aplica√ß√µes que requerem capacidades avan√ßadas de balanceamento de carga, como roteamento global e roteamento baseado em caminho.

### Exemplo

* Considere um cen√°rio em que voc√™ tem um site de com√©rcio eletr√¥nico que inclui v√°rios subdom√≠nios para fun√ß√µes diferentes, como contas de usu√°rio e processamento de pagamentos. O Azure Application Gateway pode **rotear o tr√°fego para os servidores web apropriados com base no caminho do URL**. Por exemplo, o tr√°fego para `exemplo.com/contas` poderia ser direcionado para o servi√ßo de contas de usu√°rio, e o tr√°fego para `exemplo.com/pagamento` poderia ser direcionado para o servi√ßo de processamento de pagamentos.\
E **proteger seu site de ataques usando as capacidades do WAF.**

### **Enumera√ß√£o**
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
{% endcode %}

## Hub, Spoke e VNet Peering do Azure

**VNet Peering** √© um recurso de rede no Azure que **permite a conex√£o direta e cont√≠nua entre diferentes Redes Virtuais (VNets)**. Atrav√©s do VNet peering, recursos em uma VNet podem se comunicar com recursos em outra VNet usando endere√ßos IP privados, **como se estivessem na mesma rede**.\
**O VNet Peering tamb√©m pode ser usado com redes locais** configurando uma VPN de site a site ou Azure ExpressRoute.

**Azure Hub e Spoke** √© uma topologia de rede usada no Azure para gerenciar e organizar o tr√°fego de rede. **O "hub" √© um ponto central que controla e roteia o tr√°fego entre diferentes "spokes"**. O hub geralmente cont√©m servi√ßos compartilhados como dispositivos virtuais de rede (NVAs), Gateway VPN do Azure, Firewall do Azure ou Bastion do Azure. Os **"spokes" s√£o VNets que hospedam cargas de trabalho e se conectam ao hub usando o VNet peering**, permitindo que eles aproveitem os servi√ßos compartilhados dentro do hub. Esse modelo promove um layout de rede limpo, reduzindo a complexidade ao centralizar servi√ßos comuns que v√°rias cargas de trabalho em diferentes VNets podem usar.

{% hint style="danger" %}
**O emparelhamento de VNets n√£o √© transitivo no Azure**, o que significa que se o spoke 1 estiver conectado ao spoke 2 e o spoke 2 estiver conectado ao spoke 3, ent√£o o spoke 1 n√£o pode se comunicar diretamente com o spoke 3.
{% endhint %}

### Exemplos

* Imagine uma empresa com departamentos separados como Vendas, RH e Desenvolvimento, **cada um com sua pr√≥pria VNet (os spokes)**. Essas VNets **precisam de acesso a recursos compartilhados** como um banco de dados central, um firewall e um gateway de internet, que est√£o todos localizados em **outra VNet (o hub)**. Ao usar o modelo Hub e Spoke, cada departamento pode **se conectar de forma segura aos recursos compartilhados atrav√©s da VNet do hub sem expor esses recursos √† internet p√∫blica** ou criar uma estrutura de rede complexa com in√∫meras conex√µes.

### Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
{% endcode %}

## VPN de Site a Site

Um VPN de Site a Site no Azure permite que voc√™ **conecte sua rede local √† sua Rede Virtual do Azure (VNet)**, permitindo que recursos como VMs dentro do Azure pare√ßam estar na sua rede local. Essa conex√£o √© estabelecida por meio de um **gateway VPN que criptografa o tr√°fego** entre as duas redes.

### **Exemplo**

* Uma empresa com sua sede principal em Nova York possui um data center local que precisa se conectar de forma segura √† sua VNet no Azure, que hospeda suas cargas de trabalho virtualizadas. Ao configurar um **VPN de Site a Site, a empresa pode garantir conectividade criptografada entre os servidores locais e as VMs do Azure**, permitindo que os recursos sejam acessados com seguran√ßa em ambos os ambientes como se estivessem na mesma rede local. 

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
## Azure ExpressRoute

O Azure ExpressRoute √© um servi√ßo que fornece uma **conex√£o privada, dedicada e de alta velocidade entre a infraestrutura local e os data centers do Azure**. Essa conex√£o √© feita por meio de um provedor de conectividade, contornando a internet p√∫blica e oferecendo mais confiabilidade, velocidades mais r√°pidas, lat√™ncias mais baixas e maior seguran√ßa do que as conex√µes t√≠picas da internet.

### **Exemplo**

* Uma corpora√ß√£o multinacional requer uma **conex√£o consistente e confi√°vel com seus servi√ßos do Azure devido ao alto volume de dados** e √† necessidade de alta taxa de transfer√™ncia. A empresa opta pelo Azure ExpressRoute para conectar diretamente seu data center local ao Azure, facilitando transfer√™ncias de dados em grande escala, como backups di√°rios e an√°lises de dados em tempo real, com privacidade e velocidade aprimoradas.

### **Enumera√ß√£o**

{% code overflow="wrap" %}
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
{% endcode %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
