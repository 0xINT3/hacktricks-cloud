# Az - AzureAD (AAD)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

Azure Active Directory（Azure AD）是微软基于云的身份和访问管理服务。它在使员工能够登录并访问资源方面发挥着重要作用，无论是在组织内部还是超出组织范围，包括Microsoft 365、Azure门户和众多其他SaaS应用程序。Azure AD的设计侧重于提供基本的身份服务，主要包括**身份验证、授权和用户管理**。

Azure AD的关键功能包括**多因素身份验证**和**条件访问**，以及与其他Microsoft安全服务的无缝集成。这些功能显著提升了用户身份的安全性，并使组织能够有效地实施和执行其访问策略。作为Microsoft云服务生态系统的基本组成部分，Azure AD对于用户身份的基于云的管理至关重要。

## 实体

### 枚举

您可以使用[**az cli工具**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)\*\*，\*\*PowerShell模块[**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/)（或[**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)）和[Az PowerShell](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps)模块进行此枚举。

{% hint style="success" %}
在Linux中，您需要安装PowerShell Core:

```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **模块差异**

* **AzureAD** 是微软的 PowerShell 模块，用于**管理 Azure AD。它不显示 Azure AD 对象的所有属性，也不能用于访问 Azure 资源信息**。
* **Az PowerShell** 是一个用于**管理 Azure 资源**的模块，可通过 PowerShell 命令行使用。

### **连接**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="原始 PowerShell" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="原始操作系统" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

当您通过CLI登录到Azure时，您正在使用属于Microsoft的租户的Azure应用程序。这些应用程序，就像您可以在您的帐户中创建的应用程序一样，都有一个客户端ID。您在控制台中看到的**允许应用程序列表**中**不会看到所有这些应用程序**，但它们默认是允许的。

例如，一个**PowerShell脚本**进行身份验证时使用的应用程序具有客户端ID **`1950a258-227b-4e31-a9cf-717495945fc2`**。即使该应用程序在控制台中不可见，系统管理员仍然可以**阻止该应用程序**，以便用户无法使用通过该应用程序连接的工具进行访问。

然而，还有**其他应用程序的客户端ID**将允许您连接到Azure：

```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```

### 用户

```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD user enumeration can be performed using the Graph API. By making requests to `https://graph.windows.net/<TENANT_ID>/users`, an attacker can retrieve a list of users in the Azure AD tenant. This information can be useful for further attacks such as password spraying or targeted phishing campaigns.

**Group Enumeration**

Similarly, group enumeration can be done by querying `https://graph.windows.net/<TENANT_ID>/groups`. This can help an attacker identify different groups within the Azure AD tenant and understand the relationships between users and groups.

#### Password Attacks

**Password Spraying**

Password spraying attacks can be conducted against Azure AD using tools like `MSOLSpray` or custom scripts. By trying a small number of common passwords against a large number of usernames, an attacker can attempt to gain access to accounts without triggering account lockouts.

**Brute Force Attacks**

Brjson is a powerful tool for performing brute force attacks against Azure AD accounts. Attackers can use password lists and customize attack parameters to crack weak passwords and gain unauthorized access.

#### Phishing

Phishing attacks targeting Azure AD users can be highly effective. By creating convincing phishing emails or login pages that mimic Azure AD prompts, attackers can trick users into revealing their credentials. These credentials can then be used to access sensitive resources within the Azure AD environment.

#### Token Manipulation

Azure AD tokens can be manipulated to escalate privileges or gain unauthorized access to resources. Techniques like token replay attacks or token forgery can be used to exploit weaknesses in token handling and authentication mechanisms.

#### Account Takeover

Once an attacker has obtained valid credentials, they can perform an account takeover within Azure AD. This can lead to unauthorized access to sensitive data, impersonation of users, or further lateral movement within the Azure AD environment.

#### Monitoring and Detection

Monitoring Azure AD logs and setting up alerts for suspicious activities can help detect and respond to potential security incidents. By monitoring sign-in logs, audit logs, and other relevant events, organizations can identify unauthorized access attempts and take appropriate actions to secure their Azure AD environment.

#### Recommendations

* Implement strong password policies and multi-factor authentication to protect Azure AD accounts.
* Regularly review and update group memberships to ensure least privilege access.
* Educate users about phishing techniques and encourage reporting of suspicious emails or activities.
* Enable logging and monitoring in Azure AD to track and analyze user activities for signs of compromise.
* Conduct regular security assessments and penetration testing to identify and address vulnerabilities in the Azure AD environment.

```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```

### Az PowerShell

#### Description

The Az PowerShell module is used to manage Azure resources using PowerShell. It provides cmdlets that allow you to interact with Azure services and automate tasks.

#### Usage

1.  Install the Az PowerShell module:

    ```powershell
    Install-Module -Name Az -AllowClobber -Scope CurrentUser
    ```
2.  Import the Az module:

    ```powersjson
    Import-Module Az
    ```
3.  Connect to your Azure account:

    ```powershell
    Connect-AzAccount
    ```
4.  Run cmdlets to manage Azure resources:

    ```powershell
    Get-AzResourceGroup
    New-AzVM
    ```

#### Additional Resources

* [Az PowerShell Documentation](https://docs.microsoft.com/en-us/powershell/azure/new-azureps-module-az?view=azps-6.0.0)
* [Az PowerShell GitHub Repository](https://github.com/Azure/azure-powershell)

```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```

#### 更改用户密码

{% code overflow="wrap" %}
```
```
{% endcode %}

```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText –Force

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password –Verbose
```

### MFA & Conditional Access Policies

强烈建议为每个用户添加MFA，然而，一些公司可能不会设置它，或者可能会通过条件访问设置它：如果用户从特定位置、浏览器或某些条件登录，则**需要MFA**。如果这些策略配置不正确，可能会容易受到**绕过**攻击。检查：

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### Groups

```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD allows anonymous enumeration of users through the Graph API. This can be abused by attackers to gather a list of valid usernames.

**Group Enumeration**

Similarly, group enumeration is possible through the Graph API, allowing attackers to discover existing groups within the Azure AD.

#### Password Spraying

Attackers can perform password spraying attacks against Azure AD to attempt to gain access to accounts by trying a few common passwords across many accounts.

#### Brute Force Attacks

Azure AD can be targeted with brute force attacks to crack weak passwords or guess multi-factor authentication codes.

#### Password Policies

Understanding the password policies configured in Azure AD can help attackers tailor their password cracking strategies.

#### Password Hashes

Obtaining password hashes from Azure AD can allow attackers to perform offline password cracking, especially if weak hashing algorithms are used.

#### Password Resets

Attacks can be launched against the password reset functionality in Azure AD to gain unauthorized access to user accounts.

#### OAuth Token Abuse

Abusing OAuth tokens can allow attackers to impersonate users, access resources, and maintain persistence within Azure AD.

#### Application Registration

Weaknesses in how applications are registered in Azure AD can lead to unauthorized access and data exposure.

#### Conditional Access Policies

Bypassing or misconfiguring conditional access policies can enable attackers to circumvent security controls and gain unauthorized access.

#### Privilege Escalation

Discovering and exploiting privilege escalation vulnerabilities in Azure AD can grant attackers higher levels of access within the environment.

#### Account Lockout Policies

Understanding and bypassing account lockout policies in Azure AD can help attackers avoid detection while conducting brute force attacks.

#### Multi-Factor Authentication

Identifying weaknesses in multi-factor authentication implementations in Azure AD can provide attackers with opportunities to bypass this additional security measure.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data inconsistencies and security vulnerabilities in Azure AD.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Reports

Leveraging security reports in Azure AD can help identify security weaknesses, track suspicious activities, and improve overall security posture.

#### Threat Detection

Utilizing threat detection capabilities in Azure AD can help detect and respond to suspicious activities, potential breaches, and advanced threats.

#### Security Best Practices

Following security best practices for Azure AD can help mitigate risks, protect sensitive data, and enhance the overall security of the environment.

#### Compliance Assessments

Conducting compliance assessments in Azure AD can ensure that security controls are properly implemented, and regulatory requirements are met.

#### Incident Response

Establishing an incident response plan for Azure AD can help organizations effectively respond to security incidents, minimize impact, and facilitate recovery.

#### Security Automation

Implementing security automation tools and processes in Azure AD can help streamline security operations, improve incident response times, and enhance overall security posture.

#### Security Training

Providing security training to users and administrators in Azure AD can raise awareness about security risks, promote best practices, and enhance security awareness.

#### Third-Party Integrations

Evaluating security implications of third-party integrations with Azure AD can help identify potential risks, ensure data protection, and maintain a secure environment.

#### Data Encryption

Implementing data encryption mechanisms in Azure AD can help protect sensitive information, prevent unauthorized access, and maintain data confidentiality.

#### Network Security

Implementing network security controls in Azure AD can help defend against network-based attacks, secure communication channels, and protect data in transit.

#### Vulnerability Management

Regularly scanning for and remediating vulnerabilities in Azure AD can help prevent exploitation by attackers, reduce security risks, and safeguard the environment.

#### Patch Management

Applying security patches and updates to Azure AD components can address known vulnerabilities, improve system security, and protect against exploits.

#### Secure Configuration

Applying secure configurations to Azure AD components can reduce security gaps, minimize attack surfaces, and enhance overall security posture.

#### Log Management

Implementing robust log management practices in Azure AD can help track security events, investigate incidents, and meet compliance requirements.

#### Intrusion Detection

Deploying intrusion detection systems in Azure AD can help detect and respond to unauthorized access attempts, malicious activities, and security breaches.

#### Penetration Testing

Conducting penetration tests against Azure AD can help identify security weaknesses, validate defenses, and improve incident response preparedness.

#### Security Monitoring

Implementing continuous security monitoring in Azure AD can help detect anomalies, identify threats, and respond to security incidents in a timely manner.

#### Disaster Recovery

Establishing disaster recovery plans for Azure AD can help ensure business continuity, minimize data loss, and recover from security incidents effectively.

#### Cloud Security Posture Management

Utilizing cloud security posture management tools in Azure AD can help assess security posture, enforce compliance, and mitigate risks in the cloud environment.

#### Conclusion

Securing Azure AD is essential to protecting identities, data, and resources in the cloud environment. By understanding common security risks and implementing best practices, organizations can enhance the security posture of their Azure AD deployment.

```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```

### Az PowerShell

#### Enumerate Azure AD roles

1.  **Description**

    This script enumerates Azure AD roles assigned to users and groups.
2.  **Usage**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId <UserOrGroupId>
    ```
3.  **Example**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId john.doe@company.com
    ```
4.  **Output**

    The script will output the roles assigned to the specified user or group.
5.  **Impact**

    This information can be used to understand the level of access a user or group has within Azure AD.
6.  **Recommendation**

    Regularly review and audit Azure AD roles to ensure least privilege access is maintained.

```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
```

#### 将用户添加到组

组的所有者可以将新用户添加到组中

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
组可以是动态的，这基本上意味着**如果用户满足某些条件，他将被添加到一个组中**。当然，如果条件是基于**用户可以控制的属性**，他可能会滥用这个功能来**进入其他组**。\
查看如何滥用动态组在以下页面：
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### 服务主体 / 企业应用程序

{% hint style="info" %}
请注意，在 PowerShell 术语中**Service Principal**在 Azure 门户（Web）中被称为**Enterprise Applications**。
{% endhint %}

```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```

### Azure AD Enumeration

#### User Enumeration

To enumerate users in Azure AD, you can use tools like **Azure AD Recon** or **Azure AD Connect**. These tools can help you gather information about users, groups, and contacts in the Azure AD environment.

**Using Azure AD Recon**

1. **Install Azure AD Recon** on your local machine.
2. **Run the tool** and provide the necessary inputs such as the target Azure AD domain.
3. **Collect user information** by running the tool with the appropriate flags.

**Using Azure AD Connect**

1. **Install Azure AD Connect** on your local machine.
2. **Configure the tool** to connect to the Azure AD environment.
3. **Run synchronization** to gather user information from Azure AD.

#### Group Enumeration

To enumerate groups in Azure AD, you can use tools like **Azure AD Recon** or **Azure AD Connect**. These tools can help you identify different groups and their members within the Azure AD environment.

**Using Azure AD Recon**

1. **Install Azure AD Recon** on your local machine.
2. **Run the tool** and provide the necessary inputs such as the target Azure AD domain.
3. **Enumerate groups** by running the tool with the appropriate flags.

**Using Azure AD Connect**

1. **Install Azure AD Connect** on your local machine.
2. **Configure the tool** to connect to the Azure AD environment.
3. **Run synchronization** to gather group information from Azure AD.

#### Contact Enumeration

To enumerate contacts in Azure AD, you can use tools like **Azure AD Recon** or **Azure AD Connect**. These tools can help you discover information about contacts stored in the Azure AD environment.

**Using Azure AD Recon**

1. **Install Azure AD Recon** on your local machine.
2. **Run the tool** and provide the necessary inputs such as the target Azure AD domain.
3. **Retrieve contact information** by running the tool with the appropriate flags.

**Using Azure AD Connect**

1. **Install Azure AD Connect** on your local machine.
2. **Configure the tool** to connect to the Azure AD environment.
3. **Run synchronization** to gather contact information from Azure AD.

### Summary

Enumerating users, groups, and contacts in Azure AD is essential for understanding the structure and relationships within the Azure AD environment. By using tools like Azure AD Recon or Azure AD Connect, you can gather valuable information that may assist in further penetration testing activities.

```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```

### Az PowerShell

#### Enumerate Azure AD roles

1.  **Description**

    This script enumerates Azure AD roles assigned to users and groups.
2.  **Usage**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId <UserOrGroupId>
    ```
3.  **Example**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId john.doe@domain.com
    ```
4.  **Impact**

    This script helps identify the roles assigned to users and groups in Azure AD, which can be useful for understanding the level of access different entities have within the Azure environment.
5.  **Recommendation**

    Regularly review and audit the roles assigned in Azure AD to ensure that users and groups have appropriate access levels.

```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```

```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

<details>

<summary>列出并尝试在每个企业应用程序上添加客户端密钥</summary>

\`\`\`powershell # Just call Add-AzADAppSecret Function Add-AzADAppSecret { <# .SYNOPSIS Add client secret to the applications.

.PARAMETER GraphToken Pass the Graph API Token

.EXAMPLE PS C:> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0\&tabs=http https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0\&tabs=http #>

\[CmdletBinding()] param( \[Parameter(Mandatory=$True)] \[String] $GraphToken = $null )

$AppList = $null $AppPassword = $null

## List All the Applications

$Params = @{ "URI" = "https://graph.microsoft.com/v1.0/applications" "Method" = "GET" "Headers" = @{ "Content-Type" = "application/json" "Authorization" = "Bearer $GraphToken" } }

try { $AppList = Invoke-RestMethod @Params -UseBasicParsing } catch { }

## Add Password in the Application

if($AppList -ne $null) { \[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value) { $ID = $App.ID $psobj = New-Object PSObject

$Params = @{ "URI" = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword" "Method" = "POST" "Headers" = @{ "Content-Type" = "application/json" "Authorization" = "Bearer $GraphToken" } }

$Body = @{ "passwordCredential"= @{ "displayName" = "Password" } }

try { $AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json) Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText $Details.Add($psobj) | Out-Null } catch { Write-Output "Failed to add new client secret to '$($App.displayName)' Application." } } if($Details -ne $null) { Write-Output "" Write-Output "Client secret added to : " Write-Output $Details | fl \* } } else { Write-Output "Failed to Enumerate the Applications." } }

````
</details>

### 角色

<div data-gb-custom-block data-tag="tabs"></div>

<div data-gb-custom-block data-tag="tab" data-title='az cli'>

```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
````

</details>

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD allows anonymous enumeration of users through the Graph API. This can be abused by attackers to gather a list of valid usernames.

**Group Enumeration**

Similarly, group enumeration is possible through the Graph API, allowing attackers to discover existing groups within the Azure AD.

#### Password Spraying

Attackers can perform password spraying attacks against Azure AD to attempt to gain access to accounts by trying a few common passwords across many accounts.

#### Brute Force Attacks

Azure AD can be targeted with brute force attacks to crack weak passwords or guess multi-factor authentication codes.

#### Password Policies

Understanding the password policies configured in Azure AD can help attackers tailor their password cracking strategies.

#### Password Hashes

Obtaining password hashes from Azure AD can allow attackers to perform offline password cracking, especially if weak hashing algorithms are used.

#### Password Resets

Attacks can be launched against the password reset functionality in Azure AD to gain unauthorized access to user accounts.

#### OAuth Token Abuse

Abusing OAuth tokens can allow attackers to impersonate users, access resources, and maintain persistence within Azure AD.

#### Application Registration

Weaknesses in how applications are registered in Azure AD can lead to unauthorized access and data exposure.

#### Conditional Access Policies

Bypassing or misconfiguring conditional access policies can enable attackers to circumvent security controls and gain unauthorized access.

#### Privilege Escalation

Discovering and exploiting privilege escalation vulnerabilities in Azure AD can grant attackers higher levels of access within the environment.

#### Account Lockout Policies

Understanding and bypassing account lockout policies in Azure AD can help attackers avoid detection while conducting brute force attacks.

#### Multi-Factor Authentication

Identifying weaknesses in multi-factor authentication implementations in Azure AD can provide attackers with opportunities to bypass this additional security measure.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```

### Az PowerShell

#### Enumerate Azure AD roles

1.  **Description**

    This script enumerates Azure AD roles assigned to users and groups.
2.  **Usage**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId <UserOrGroupId>
    ```
3.  **Example**

    ```powershell
    Get-AzureADUserRoleAssignment -ObjectId john.doe@contoso.com
    ```
4.  **Output**

    The script will output the roles assigned to the specified user or group.

```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```

```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

#### 设备

```bash
# If you know how to do this send a PR!
```

### Azure AD Enumeration

#### User Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate users.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated user enumeration.

#### Group Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate groups.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated group enumeration.

#### Application Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate applications.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated application enumeration.

#### Device Enumeration

1. **Manual Enumeration**: Use tools like `Azure AD Explorer` or `Azure AD PowerShell module` to enumerate devices.
2. **Automated Enumeration**: Use tools like `Azure AD Recon` or `AzureSpray` for automated device enumeration.

### Azure AD Exploitation

#### Password Spraying

1. **Password Sprjsonaying**: Use tools like `MSOLSpray` or `AzureSpray` for password spraying attacks against Azure AD.

#### Password Cracking

1. **Password Cracking**: Use tools like `Hashcat` or `John the Ripper` for cracking Azure AD passwords.

#### Token Impersonation

1. **Token Impersonation**: Exploit token impersonation vulnerabilities to gain unauthorized access.

#### Password Policies

1. **Password Policies**: Check for weak password policies in Azure AD that can be exploited.

#### Privilege Escalation

1. **Privilege Escalation**: Exploit misconfigurations or vulnerabilities to escalate privileges within Azure AD.

#### Federation Trust

1. **Federation Trust**: Exploit misconfigurations in federation trust to gain unauthorized access.

#### OAuth Abuse

1. **OAuth Abuse**: Abuse OAuth vulnerabilities to gain unauthorized access to resources.

#### SAML Abuse

1. **SAML Abuse**: Abuse SAML vulnerabilities to gain unauthorized access to resources.

#### Phishing

1. **Phishing**: Conduct phishing attacks to steal credentials or sensitive information.

#### MFA Bypass

1. **MFA Bypass**: Bypass multi-factor authentication controls to gain unauthorized access.

#### Account Takeover

1. **Account Takeover**: Take over user accounts by exploiting vulnerabilities or weak credentials.

#### Data Exfiltration

1. **Data Exfiltration**: Extract sensitive data from Azure AD using various techniques.

#### Persistence

1. **Persistence**: Maintain access to Azure AD by establishing persistence mechanisms.

#### Enumeration

1. **Enumeration**: Continuously enumerate Azure AD for new information and potential vulnerabilities.

#### Reporting

1. **Reporting**: Document all findings and prepare a detailed report for the client.

```powershell
# Enumerate Devices
Get-AzureADDevice -All $true | fl *
# List all the active devices (and not the stale devices)
Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}
# Get owners of all devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Registred users of all the devices
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
# Get dives managed using Intune
Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get Administrative Units of a device
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $_.ObjectId | where {$_.ObjectId -eq $deviceObjId} }
```

{% hint style="warning" %}
如果设备（VM）加入了**AzureAD**，则来自AzureAD的用户将能够**登录**。\
此外，如果登录用户是设备的**所有者**，他将成为**本地管理员**。
{% endhint %}

### 应用程序

{% hint style="info" %}
**应用程序**是门户中的**应用注册**（不是企业应用程序）。\
但是，每个应用注册将创建一个具有相同名称的**企业应用程序**（**服务主体**）。\
此外，如果应用程序是**多租户应用程序**，将在**该租户**中创建另一个**企业应用程序**（**服务主体**）具有相同的名称。
{% endhint %}

生成应用程序时会赋予两种类型的权限：

* 赋予**服务主体**的**权限**
* **应用程序**可以拥有并代表**用户**使用的**权限**。

```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```

### Azure AD

#### Enumeration

**User Enumeration**

Azure AD allows anonymous enumeration of users through the Graph API. This can be abused by attackers to gather a list of valid usernames.

**Group Enumeration**

Similarly, group enumeration is possible through the Graph API, allowing attackers to discover existing groups within the Azure AD.

#### Password Spraying

Attackers can perform password spraying attacks against Azure AD to attempt to gain access to accounts by trying a few common passwords across many accounts.

#### Brute Force Attacks

Azure AD can be targeted with brute force attacks to crack weak passwords or guess multi-factor authentication codes.

#### Password Policies

Understanding the password policies configured in Azure AD can help attackers tailor their password cracking strategies.

#### Password Hashes

Obtaining password hashes from Azure AD can allow attackers to perform offline password cracking, especially if weak hashing algorithms are used.

#### Password Resets

Attacks can be launched against the password reset functionality in Azure AD to gain unauthorized access to user accounts.

#### OAuth Token Abuse

Abusing OAuth tokens can allow attackers to impersonate users, access resources, and maintain persistence within Azure AD.

#### Application Registration

Weaknesses in how applications are registered in Azure AD can lead to unauthorized access and data exposure.

#### Conditional Access Policies

Bypassing or misconfiguring conditional access policies can enable attackers to circumvent security controls and gain unauthorized access.

#### Privilege Escalation

Discovering and exploiting privilege escalation vulnerabilities in Azure AD can grant attackers higher levels of access within the environment.

#### Account Lockout Policies

Understanding and bypassing account lockout policies in Azure AD can help attackers avoid detection while conducting brute force attacks.

#### Multi-Factor Authentication

Identifying weaknesses in multi-factor authentication implementations in Azure AD can provide attackers with opportunities to bypass this additional security measure.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

#### Security Defaults

Misconfigurations in security defaults can introduce vulnerabilities that attackers can exploit to compromise Azure AD accounts.

#### Risky Sign-Ins

Monitoring and analyzing risky sign-ins can help detect unauthorized access attempts and potential account compromises in Azure AD.

#### Sign-In Logs

Analyzing sign-in logs can provide insights into account activities, identify suspicious behavior, and detect potential security incidents in Azure AD.

#### User Permissions

Understanding and abusing user permissions in Azure AD can allow attackers to escalate privileges and access sensitive information.

#### Application Permissions

Abjsoning and abusing application permissions in Azure AD can lead to unauthorized access to resources and data leakage.

#### Federation Trusts

Exploiting weaknesses in federation trusts can enable attackers to compromise the trust relationship between Azure AD and external identity providers.

#### Legacy Authentication

Legacy authentication protocols in Azure AD may introduce security risks that attackers can leverage to gain unauthorized access to accounts.

#### Guest Accounts

Guest accounts in Azure AD can introduce additional security risks if not properly managed, potentially allowing unauthorized access to resources.

#### Self-Service Password Reset

Abusing self-service password reset features in Azure AD can help attackers gain unauthorized access to user accounts without detection.

#### Directory Synchronization

Misconfigurations in directory synchronization settings can result in data leakage and unauthorized access to Azure AD resources.

#### Privileged Identity Management

Expjsoning weaknesses in privileged identity management configurations can allow attackers to gain elevated privileges and access critical resources.

```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```

### Azure AD Enumeration

#### Description

Azure AD enumeration is the process of gathering information about Azure AD users, groups, roles, and permissions. This information can be used by attackers to identify potential targets for further attacks.

#### Techniques

1. **Enumerate Users**: Use PowerShell scripts to list all Azure AD users and their properties.
2. **Enumerate Groups**: Use PowerShell scripts to list all Azure AD groups and their members.
3. **Enumerate Roles**: Use PowerShell scripts to list all Azure AD roles and their assigned members.
4. **Enumerate Permissions**: Use PowerShell scripts to list all Azure AD permissions assigned to users, groups, or roles.

#### Impact

Azure AD enumeration can help attackers identify high-value targets within an organization, understand the structure of the Azure AD environment, and plan further attacks such as privilege escalation or lateral movement.

#### Detection

Monitor Azure AD logs for suspicious activities related to user, group, role, or permission enumeration. Look for multiple failed login attempts, unusual patterns of access, or changes to user permissions.

#### Prevention

1. Implement strong password policies and multi-factor authentication to prevent unauthorized access to Azure AD accounts.
2. Regularly review and update user permissions to ensure least privilege access.
3. Monitor Azure AD logs for unusual activities and investigate any suspicious behavior promptly.

#### References

* [Microsoft Azure Active Directory documentation](https://docs.microsoft.com/en-us/azure/active-directory/)
* [Azure AD PowerShell module documentation](https://docs.microsoft.com/en-us/powershell/azure/active-directory/overview)

```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```

{% hint style="warning" %}
具有权限 **`AppRoleAssignment.ReadWrite`** 的应用程序可以通过授予自身角色来**升级为全局管理员**。\
有关更多信息，请查看[**此处**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48)。
{% endhint %}

{% hint style="info" %}
应用程序用于在请求令牌时证明其身份的秘密字符串是应用程序密码。\
因此，如果找到此**密码**，您可以作为**服务主体** **在** **租户内**访问。\
请注意，此密码仅在生成时可见（您可以更改它，但无法再次获取它）。\
**应用程序**的**所有者**可以为其**添加密码**（以便冒充它）。\
以这些服务主体的身份登录**不会被标记为风险**，也**不会有多重身份验证**。
{% endhint %}

### 应用程序和（企业应用程序或服务主体）的区别

Azure 中应用程序和服务主体之间的区别：

* **应用程序/应用注册**：存在于您的 Azure AD 中的应用程序
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **服务主体/企业应用程序**：Azure AD 中的安全对象，可以在 Azure 目录中具有**特权**，并与您的应用程序或第三方应用程序关联
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* 如果权限非常敏感，管理员可能需要批准给定的权限。

一个应用程序可以在**第三方租户**中运行，一旦开始使用它并授予访问权限，**在您的租户中将创建一个企业应用程序/服务主体**，以便为其提供所需的信息访问权限：

### 管理单元

用于更好地管理用户。

管理单元**将角色的权限限制为您定义的组织的任何部分**。例如，您可以使用管理单元将[Helpdesk Administrator](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator)角色委派给区域支持专员，以便他们仅能管理其支持的区域中的用户。

因此，您可以将角色分配给管理员单元，其成员将具有这些角色。

```
```

### AzureAD Enumeration

#### User Enumeration

To enumerate users in AzureAD, you can use tools like `Azure AD Connect` or `Azure AD Graph API`. These tools can help you gather information about users, groups, and other directory objects in the Azure Active Directory.

**Using Azure AD Connect**

1. Install and configure Azure AD Connect on your local machine.
2. Use the synchronization feature to sync Azure AD with your local AD.
3. Once synced, you can use the Azure AD Connect interface to view and manage user accounts.

**Using Azure AD Graph API**

1. Authenticate with Azure AD Graph API using tools like `Postman` or `curl`.
2. Send API requests to query user information suchjson as user IDs, emails, and group memberships.

#### Group Enumeration

To enumerate groups in AzureAD, you can use the same tools mentioned above (`Azure AD Connect` or `Azure AD Graph API`). These tools allow you to retrieve information about groups, including their members and permissions.

**Using Azure AD Connect**

Follow the same steps as for user enumeration, but focus on groups instead of individual user accounts.

**Using Azure AD Graph API**

Send API requests to query group information such as group names, member lists, and group permissions.

#### Device Enumeration

To enumerate devices in AzureAD, you can again utilize tools like `Azure AD Connect` or `Azure AD Graph API`. These tools enable you to collect information about devices registered in the Azure Active Directory.

**Using Azure AD Connect**

Similar to user and group enumeration, install and configure Azure AD Connect, then navigate to the device management section to view device details.

**Using Azure AD Graph API**

Authenticate with Azure AD Graph API and send API requests to retrieve device information such as device IDs, types, and registration status.

### Summary

AzureAD enumeration is crucial for understanding the structure and entities within an Azure Active Directory environment. By leveraging tools like `Azure AD Connect` and `Azure AD Graph API`, you can gather valuable information about users, groups, and devices, aiding in the overall security assessment of the AzureAD environment.

\`\`\`powershell # Get Administrative Units Get-AzureADMSAdministrativeUnit Get-AzureADMSAdministrativeUnit -Id # Get ID of admin unit by string $adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'" # List the users, groups, and devices affected by the administrative unit Get-AzureADMSAdministrativeUnitMember -Id # Get the roles users have over the members of the AU Get-AzureADMSScopedRoleMembership -Id | fl #Get role ID and role members \`\`\` ## Azure AD身份保护（AIP）

Azure AD身份保护（AIP）是一项安全服务，利用**自动检测和修复**来帮助保护Azure Active Directory中用户身份不被 compromise。AIP持续监视和评估用户登录和身份配置的风险，**自动应用适当的安全措施**，如要求多重身份验证或阻止潜在危险活动。这有助于组织预防基于身份的安全漏洞。

流程：

1. Azure AD身份保护**监视用户活动**，收集用户**登录、认证**事件和其他相关活动的数据。
2. 该服务使用**机器学习**算法分析这些数据，检测潜在的安全威胁。
3. Azure AD身份保护**为威胁（例如登录）分配风险级别**，并在需要时生成警报以执行一些自动操作。

### Azure AD密码保护（APP）

Azure AD密码保护（APP）是一项安全功能，**通过强制执行强密码策略**，帮助防止Azure Active Directory中的弱密码。APP阻止**常用的弱密码**及其变体，降低与密码相关的风险。它可以在云级别和本地Active Directory上都应用，增强组织整体密码安全。

#### 参考资料

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)
