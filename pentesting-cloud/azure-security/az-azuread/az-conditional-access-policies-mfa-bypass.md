# Az - Uslovi pristupa / Bypass MFA

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Azure Conditional Access politike su pravila postavljena u Microsoft Azure-u koja primenjuju kontrolu pristupa Azure uslugama i aplikacijama na osnovu određenih **uslova**. Ove politike pomažu organizacijama da obezbede svoje resurse primenom odgovarajućih kontrola pristupa u odgovarajućim okolnostima.\
Uslovne pristupne politike u osnovi **definišu** **Ko** može pristupiti **Šta** sa **Koje lokacije** i **Kako**.

Evo nekoliko primera:

1. **Politika rizika prijavljivanja**: Ova politika može biti podešena da zahteva višestruku autentifikaciju (MFA) kada se detektuje rizik prijavljivanja. Na primer, ako je ponašanje prijavljivanja korisnika neobično u poređenju sa njihovim uobičajenim obrascem, kao što je prijavljivanje iz druge zemlje, sistem može zatražiti dodatnu autentifikaciju.
2. **Politika usaglašenosti uređaja**: Ova politika može ograničiti pristup Azure uslugama samo uređajima koji su usaglašeni sa sigurnosnim standardima organizacije. Na primer, pristup može biti dozvoljen samo sa uređaja koji imaju ažuriran softver za antivirus ili pokreću određenu verziju operativnog sistema.

## Bypass-ovi za uslovne pristupne politike

Moguće je da uslovna pristupna politika **proverava neke informacije koje se lako mogu promeniti, omogućavajući zaobilaženje politike**. I ako je na primer politika konfigurisala MFA, napadač će moći da je zaobiđe.

### Platforme uređaja - Uslov uređaja

Moguće je postaviti uslov zasnovan na **platformi uređaja** (Android, iOS, Windows, macOS), međutim, ovo se zasniva na **user-agent-u** pa je prilično lako zaobići. Čak i ako se **sve opcije postave da primoravaju MFA**, ako koristite **user-agent koji nije prepoznat**, moći ćete da zaobiđete MFA.

### Lokacije: Zemlje, IP opsezi - Uslov uređaja

Naravno, ako je ovo postavljeno u uslovnoj politici, napadač jednostavno može koristiti **VPN** u **dozvoljenoj zemlji** ili pokušati da pronađe način da pristupi sa **dozvoljene IP adrese** kako bi zaobišao ove uslove.

### Office365 klijentske aplikacije

Možete naznačiti da ako klijenti **pristupaju Office 365 aplikacijama preko pregledača, potrebna im je MFA**:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Da biste zaobišli ovo, moguće je pretvarati se da se prijavljujete u aplikaciju sa desktop aplikacije (kao što je Microsoft Teams u sledećem primeru), što će zaobići zaštitu:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Kako Microsoft Teams aplikacija ima puno dozvola, moći ćete koristiti taj pristup.

{% hint style="success" %}
Možete pronaći I**D više javnih aplikacija** sa unapred definisanim Office365 dozvolama u bazi podataka roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Ovaj napad je posebno interesantan jer će podrazumevano javne Office365 aplikacije imati dozvole za pristup određenim podacima.

### Druge aplikacije

Podrazumevano, druge aplikacije koje korisnici kreiraju neće imati dozvole i mogu biti privatne.\
Međutim, korisnici takođe mogu kreirati **javne aplikacije** kojima će dodeliti određene **dozvole**.

Potencijalni scenario u kojem je politika postavljena da **zahteva MFA za pristup aplikaciji** kada korisnik koristi **pregledač** (možda zato što je to veb aplikacija i to će biti jedini način), ako postoji **proksi aplikacija** - aplikacija kojoj je dozvoljeno da **interaguje sa drugim aplikacijama u ime korisnika**-, korisnik može **prijaviti se u proksi aplikaciju** a zatim putem ove proksi aplikacije **prijaviti se u početno zaštićenu aplikaciju MFA-om**.

Proverite tehnike [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) i [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Druge Az MFA zaobilaženja

### Zvono

Jedna od opcija Azure MFA je **primanje poziva na konfiguriranom broju telefona** gde će korisniku biti zatraženo da **pošalje znak `#`**.

{% hint style="danger" %}
Kako su znakovi samo **tonovi**, napadač bi mogao **ugroziti** **glasovnu poštu** broja telefona, konfigurirajući ton `#` kao poruku i zatim, prilikom zahteva za MFA, osigurati da je **telefon žrtve zauzet** (pozivanjem), tako da se Azure poziv preusmeri na glasovnu poštu.
{% endhint %}

### Usklađeni uređaji

Politike često zahtevaju usklađeni uređaj ili MFA, pa **napadač može registrovati usklađeni uređaj**, dobiti **PRT** token i **zaobići MFA** na ovaj način.

Počnite tako što ćete registrovati **usklađeni uređaj u Intune-u**, a zatim **dobiti PRT** sa:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Pronađite više informacija o ovakvom napadu na sledećoj stranici:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Alati

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Dobijte sve politike
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep je PowerShell skripta koja pokušava **prijaviti se na različite Microsoft usluge koristeći pružene akreditacije i pokušava identifikovati da li je MFA omogućen**. U zavisnosti od toga kako su konfigurisane politike uslovnog pristupa i druge postavke višestrukog faktora autentifikacije, neki protokoli mogu ostati jednofaktorni. Takođe, ima dodatnu provjeru za ADFS konfiguracije i može pokušati prijaviti se na lokalni ADFS server ako se otkrije.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token je skup funkcija koje imaju za cilj da pomognu sigurnosnim konsultantima koji trebaju da potvrde Politike uslovnog pristupa, testiraju portale Microsofta sa omogućenom dvofaktornom autentifikacijom, itd..
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testirajte svaki portal** da biste videli da li je moguće **prijaviti se bez MFA**:

```plaintext
1. Open the Azure portal.
2. Enter your credentials and click on Sign in.
3. If you are able to login without being prompted for MFA, take note of the portal name.
4. Repeat steps 1-3 for each portal you want to test.
```

```plaintext
1. Otvorite Azure portal.
2. Unesite svoje podatke za prijavu i kliknite na Prijavi se.
3. Ako možete da se prijavite bez traženja MFA, zabeležite ime portala.
4. Ponovite korake 1-3 za svaki portal koji želite da testirate.
```
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Zato što **Azure portal** nije ograničen, moguće je prikupiti token sa portalnog endpointa kako bi se pristupilo bilo kojoj detektovanoj usluzi iz prethodnog izvršavanja. U ovom slučaju je identifikovan Sharepoint i zahtevan je token za pristup njemu:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}


Pretpostavljajući da token ima dozvolu Sites.Read.All (iz Sharepointa), čak i ako ne možete pristupiti Sharepointu putem weba zbog MFA, moguće je koristiti token za pristup datotekama s generiranim tokenom:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Reference

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
