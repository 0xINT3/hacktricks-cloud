# Az - Conditional Access Policies / MFA Bypass

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[NFT](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

Azure条件访问策略是在Microsoft Azure中设置的规则，根据特定**条件**强制执行对Azure服务和应用程序的访问控制。这些策略帮助组织通过在正确的情况下应用正确的访问控制来保护其资源。\
条件访问策略基本上**定义了**谁可以从哪里以及如何访问**什么**。

以下是一些示例：

1. **登录风险策略**：当检测到登录风险时，可以设置此策略要求多重身份验证（MFA）。例如，如果用户的登录行为与其正常模式不同，例如从不同国家登录，则系统可以提示进行额外的身份验证。
2. **设备合规策略**：此策略可以限制对Azure服务的访问仅限于符合组织安全标准的设备。例如，只允许从具有最新防病毒软件或运行特定操作系统版本的设备访问。

## 条件访问策略绕过

可能存在一个条件访问策略正在**检查一些可以轻松篡改的信息，从而绕过策略**。例如，如果策略配置了MFA，攻击者将能够绕过它。

### 设备平台 - 设备条件

可以基于**设备平台**（Android、iOS、Windows、macOS）设置条件，但是，这是基于**用户代理**，因此很容易绕过。即使**使所有选项强制执行MFA**，如果使用**它不识别的用户代理**，您将能够绕过MFA。

### 位置：国家、IP范围 - 设备条件

当然，如果在条件策略中设置了这一点，攻击者可以简单地在**允许的国家**使用**VPN**，或尝试找到一种方式从**允许的IP地址**访问以绕过这些条件。

### Office365客户端应用

您可以指示，如果客户端**从浏览器访问Office 365应用，则需要MFA**：

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

要绕过此设置，可以假装您从桌面应用程序（例如在以下示例中登录到Microsoft Teams）登录到应用程序，这将绕过保护：
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
由于Microsoft Teams应用程序拥有许多权限，您将能够利用该访问权限。

{% hint style="success" %}
您可以在roadtools的数据库中找到具有预定义Office365权限的更多公共应用程序的ID：
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

这种攻击特别有趣，因为默认情况下，公共Office365应用程序将具有访问某些数据的权限。

### 其他应用

默认情况下，用户创建的其他应用程序将不具备权限，可能是私有的。\
然而，用户也可以创建**公共** **应用程序**，授予它们一些**权限**。

一个潜在的情况是，当用户使用**浏览器**访问一个应用程序时需要**MFA**，可能是因为它是一个Web应用程序，因此这将是唯一的方式，如果有一个**代理应用程序** - 一个允许**代表用户与其他应用程序交互的应用程序**，用户可以**登录代理应用程序**，然后通过这个代理应用程序**登录最初受到MFA保护的应用程序**。

查看[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep)和[**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken)技术。

## 其他 Az MFA 绕过方式

### 铃声

Azure MFA的一个选项是**在配置的电话号码接收电话**，用户将被要求**发送字符 `#`**。

{% hint style="danger" %}
由于字符只是**音调**，攻击者可以**篡改**电话号码的**语音邮件**消息，将**音调 `#`**配置为消息，然后，在请求MFA时确保**受害者的电话忙线**（拨打电话），以便Azure的呼叫被重定向到语音邮件。
{% endhint %}

### 符合设备

策略通常要求符合设备或MFA，因此**攻击者可以注册一个符合设备**，获取一个**PRT**令牌，**以此方式绕过MFA**。

首先在Intune中注册一个**符合设备**，然后使用以下命令**获取PRT**：

<figure><img src="../../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

在以下页面找到关于这种类型攻击的更多信息：

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## 工具

### [roadrecon](https://github.com/dirkjanm/ROADtools)

获取所有策略
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep 是一个 PowerShell 脚本，它尝试使用提供的一组凭据登录到各种 Microsoft 服务，并尝试识别是否启用了 MFA。根据条件访问策略和其他多因素身份验证设置的配置方式，一些协议可能最终会被留在单因素状态。它还具有对 ADFS 配置的额外检查，并且如果检测到，可以尝试登录到本地 ADFS 服务器。
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token是一组函数，旨在帮助需要验证条件访问策略、测试启用2FA的Microsoft门户等安全顾问。
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**测试每个门户**，看是否可以**在没有 MFA 的情况下登录**：
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

由于Azure门户没有受到限制，因此可以从门户端点收集令牌以访问先前执行中检测到的任何服务。在这种情况下，已识别出Sharepoint，并请求访问它的令牌:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

令牌具有来自Sharepoint的权限Sites.Read.All：

<figure><img src="../../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

即使由于MFA而无法从Web访问Sharepoint，也可以使用令牌访问使用生成的令牌的文件：
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## 参考资料

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>从零开始学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
