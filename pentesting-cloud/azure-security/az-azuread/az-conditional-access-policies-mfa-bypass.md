# Az - Politiche di Accesso Condizionale / Bypass MFA

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

Le politiche di accesso condizionale di Azure sono regole impostate in Microsoft Azure per applicare controlli di accesso ai servizi e alle applicazioni di Azure in base a determinate **condizioni**. Queste politiche aiutano le organizzazioni a proteggere le loro risorse applicando i giusti controlli di accesso nelle giuste circostanze.\
Le politiche di accesso condizionale definiscono fondamentalmente **Chi** pu√≤ accedere a **Cosa** da **Dove** e **Come**.

Ecco un paio di esempi:

1. **Politica di rischio di accesso**: Questa politica potrebbe essere impostata per richiedere l'autenticazione multifattore (MFA) quando viene rilevato un rischio di accesso. Ad esempio, se il comportamento di accesso di un utente √® insolito rispetto al suo modello abituale, come l'accesso da un paese diverso, il sistema pu√≤ richiedere un'autenticazione aggiuntiva.
2. **Politica di conformit√† del dispositivo**: Questa politica pu√≤ limitare l'accesso ai servizi di Azure solo ai dispositivi conformi agli standard di sicurezza dell'organizzazione. Ad esempio, l'accesso potrebbe essere consentito solo da dispositivi dotati di software antivirus aggiornato o che eseguono una determinata versione del sistema operativo.

## Bypass delle politiche di accesso condizionale

√à possibile che una politica di accesso condizionale stia **verificando alcune informazioni che possono essere facilmente alterate consentendo un bypass della politica**. E se ad esempio la politica stava configurando MFA, l'attaccante sar√† in grado di evitarla.

### Piattaforme dei dispositivi - Condizione del dispositivo

√à possibile impostare una condizione basata sulla **piattaforma del dispositivo** (Android, iOS, Windows, macOS), tuttavia, ci√≤ si basa sull'**user-agent** quindi √® abbastanza facile evitarlo. Anche **rendendo obbligatoria l'autenticazione multifattore per tutte le opzioni**, se si utilizza un **user-agent che non viene riconosciuto**, sar√† possibile evitare l'MFA.

### Posizioni: Paesi, intervalli di indirizzi IP - Condizione del dispositivo

Ovviamente, se ci√≤ √® impostato nella politica condizionale, un attaccante potrebbe semplicemente utilizzare una **VPN** nel **paese consentito** o cercare un modo per accedere da un **indirizzo IP consentito** per eludere queste condizioni.

### App client di Office365

√à possibile indicare che se i client **accedono alle app di Office 365 dal browser hanno bisogno di MFA**:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Per eludere questo, √® possibile fingere di accedere a un'app da un'applicazione desktop (come ad esempio Microsoft Teams nell'esempio seguente) che eluder√† la protezione:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Poich√© l'app Microsoft Teams ha molte autorizzazioni, sarai in grado di utilizzare quell'accesso.

{% hint style="success" %}
Puoi trovare l'I**D di altre applicazioni pubbliche** con le autorizzazioni predefinite di Office365 nel database di roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Questo attacco √® particolarmente interessante perch√© di default le applicazioni pubbliche di Office365 avranno le autorizzazioni per accedere a alcuni dati.

### Altre applicazioni

Di default, le altre applicazioni create dagli utenti non avranno autorizzazioni e potrebbero essere private.\
Tuttavia, gli utenti potrebbero anche creare **applicazioni pubbliche** concedendo loro alcune **autorizzazioni**.

Uno scenario potenziale in cui una policy √® impostata per **richiedere l'MFA per accedere a un'applicazione** quando l'utente sta utilizzando un **browser** (forse perch√© √® un'applicazione web e quindi sar√† l'unico modo), se c'√® un **applicazione proxy** - un'applicazione autorizzata a **interagire con altre applicazioni per conto degli utenti** -, l'utente potrebbe **effettuare il login nell'applicazione proxy** e quindi tramite questa applicazione proxy **effettuare il login nell'applicazione inizialmente protetta da MFA**.

Controlla le tecniche [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) e [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Altri bypass di Az MFA

### Suoneria

Una delle opzioni di Azure MFA √® **ricevere una chiamata nel numero di telefono configurato** dove all'utente verr√† chiesto di **inviare il carattere `#`**.

{% hint style="danger" %}
Poich√© i caratteri sono solo **toni**, un attaccante potrebbe **compromettere** il **messaggio di segreteria telefonica** del numero di telefono, configurando come messaggio il **tono di `#`** e quindi, quando viene richiesto l'MFA, assicurarsi che il **telefono delle vittime sia occupato** (chiamandolo) in modo che la chiamata di Azure venga reindirizzata alla segreteria telefonica.
{% endhint %}

### Dispositivi conformi

Le policy spesso richiedono un dispositivo conforme o l'MFA, quindi un **attaccante potrebbe registrare un dispositivo conforme**, ottenere un token **PRT** e **bypassare in questo modo l'MFA**.

Inizia registrando un **dispositivo conforme in Intune**, quindi **ottieni il PRT** con:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Trova ulteriori informazioni su questo tipo di attacco nella seguente pagina:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Strumenti

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Ottieni tutte le politiche
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep √® uno script PowerShell che cerca di effettuare l'accesso a vari servizi Microsoft utilizzando un set di credenziali fornito e cercher√† di identificare se MFA √® abilitato. A seconda di come sono configurate le politiche di accesso condizionale e altre impostazioni di autenticazione multi-fattore, alcuni protocolli potrebbero finire per essere a un solo fattore. Ha anche un controllo aggiuntivo per le configurazioni ADFS e pu√≤ cercare di effettuare l'accesso al server ADFS on-premises se rilevato.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token √® un insieme di funzioni che mirano ad aiutare i consulenti di sicurezza che hanno bisogno di convalidare le Conditional Access Policies, test per i portali Microsoft abilitati alla 2FA, ecc..
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testa ogni portale** per verificare se √® possibile **effettuare l'accesso senza MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Poich√© il **portale Azure** non √® vincolato, √® possibile **raccogliere un token dall'endpoint del portale per accedere a qualsiasi servizio rilevato** dall'esecuzione precedente. In questo caso √® stato identificato Sharepoint e viene richiesto un token per accedervi:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}


Supponendo che il token abbia il permesso Sites.Read.All (da Sharepoint), anche se non √® possibile accedere a Sharepoint dal web a causa di MFA, √® possibile utilizzare il token per accedere ai file con il token generato:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Riferimenti

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>
