# Az - 条件付きアクセスポリシー / MFAバイパス

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

Azure条件付きアクセスポリシーは、特定の**条件**に基づいてAzureサービスとアプリケーションへのアクセス制御を強制するためにMicrosoft Azureで設定されるルールです。これらのポリシーは、適切な状況下で適切なアクセス制御を適用することにより、組織のリソースを保護するのに役立ちます。\
条件付きアクセスポリシーは基本的に**誰**が**何**に**どこから**、そして**どのように**アクセスできるかを**定義**します。

いくつかの例を挙げます：

1. **サインインリスクポリシー**：このポリシーは、サインインリスクが検出された場合に多要素認証（MFA）を要求するように設定される可能性があります。例えば、ユーザーのログイン行動が通常のパターンと異なる場合、例えば異なる国からのログインなど、システムは追加の認証を求めることができます。
2. **デバイスコンプライアンスポリシー**：このポリシーは、組織のセキュリティ基準に準拠しているデバイスのみにAzureサービスへのアクセスを制限することができます。例えば、最新のアンチウイルスソフトウェアがインストールされているデバイスや、特定のオペレーティングシステムバージョンを実行しているデバイスからのみアクセスを許可することができます。

## 条件付きアクセスポリシーのバイパス

条件付きアクセスポリシーが**簡単に改ざんできる情報をチェックしている可能性があり、ポリシーをバイパスすることができます**。例えば、ポリシーがMFAを設定していた場合、攻撃者はそれをバイパスすることができるでしょう。

### デバイスプラットフォーム - デバイス条件

**デバイスプラットフォーム**（Android、iOS、Windows、macOS）に基づいて条件を設定することができますが、これは**ユーザーエージェント**に基づいているため、非常に簡単にバイパスできます。**すべてのオプションでMFAを強制しても**、**認識されないユーザーエージェントを使用する**と、MFAをバイパスすることができます。

### 位置情報：国、IP範囲 - デバイス条件

もちろん、これが条件付きポリシーに設定されている場合、攻撃者は**許可された国のVPN**を使用するか、**許可されたIPアドレス**からアクセスする方法を見つけることで、これらの条件をバイパスすることができます。

### Office365クライアントアプリ

ブラウザからOffice 365アプリにアクセスするクライアントはMFAが必要であると指定することができます：

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

これをバイパスするには、デスクトップアプリケーション（以下の例のMicrosoft Teamsのように）からアプリにログインするふりをすることができ、これにより保護をバイパスすることができます：

<figure><img src="../../../.gitbook/assets/image (130).png" alt=""><figcaption></figcaption></figure>

Microsoft Teamsアプリには多くの権限があるため、そのアクセスを使用することができます。

{% hint style="success" %}
roadtoolsのデータベースで、事前に定義されたOffice365の権限を持つ**より多くの公開アプリケーションのID**を見つけることができます：

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

この攻撃は特に興味深いです。なぜなら、デフォルトでは公開されているOffice365アプリケーションは、ある程度のデータへのアクセス権を持っているからです。

### その他のアプリ

デフォルトでは、ユーザーによって作成された他のアプリは権限を持たず、プライベートである可能性があります。\
しかし、ユーザーは**公開**された**アプリ**を作成し、それにいくつかの**権限**を与えることもできます。

ポリシーが**ブラウザ**を使用しているユーザーに対し、アプリケーションへのアクセスに**MFAを要求する**ように設定されている場合（おそらくウェブアプリケーションであり、そのため唯一の方法になるでしょう）、**プロキシアプリケーション**があると - ユーザーに代わって他のアプリと**やり取りすることを許可されたアプリケーション** -、ユーザーは**プロキシアプリケーションにログイン**し、そのプロキシアプリケーションを通じて当初MFAで保護されていたアプリに**ログインする**ことができます。

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep)と[**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken)の技術を確認してください。

## その他のAz MFAバイパス

### リングトーン

Azure MFAのオプションの一つに、設定された電話番号に**電話を受け、文字`#`を送信する**ように求めるものがあります。

{% hint style="danger" %}
文字は単なる**トーン**であるため、攻撃者は電話番号の**ボイスメール**メッセージを**侵害**し、メッセージとして**`#`のトーン**を設定し、MFAを要求する際に**被害者の電話が使用中**であることを確認する（それに電話をかける）ことで、Azureの電話がボイスメールに転送されるようにすることができます。
{% endhint %}

### 準拠デバイス

ポリシーはしばしば準拠デバイスまたはMFAを要求するため、**攻撃者は準拠デバイスを登録**し、**PRT**トークンを取得し、この方法で**MFAをバイパス**することができます。

Intuneで**準拠デバイスを登録**し、次に**PRTを取得**します：

<figure><img src="../../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

この種の攻撃に関する詳細情報は、以下のページで見つけることができます：

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ツール

### roadrecon

すべてのポリシーを取得
```bash
roadrecon plugin policies
```
### Invoke-MFASweep

MFASweepは、提供された資格情報を使用して様々なMicrosoftサービスにログインを試み、**MFAが有効になっているかどうかを特定する**ためのPowerShellスクリプトです。条件付きアクセスポリシーとその他の多要素認証設定によっては、一部のプロトコルがシングルファクターのままになる可能性があります。また、ADFSの設定に対する追加チェックがあり、検出された場合にはオンプレミスのADFSサーバーにログインを試みることができます。
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### donkeytoken

Donkey tokenは、条件付きアクセスポリシーの検証が必要なセキュリティコンサルタントや、2FAが有効なMicrosoftポータルのテストなどを支援するための関数セットです。
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**各ポータルをテスト**して、**MFAなしでログイン可能か**どうかを確認します：
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

**Azure** **ポータル**は**制約されていない**ため、前回の実行で検出された任意のサービスにアクセスするために、ポータルエンドポイントからトークンを**収集することが可能です**。この場合、Sharepointが識別され、それにアクセスするためのトークンが要求されます：

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

トークンには、Sites.Read.All（Sharepointから）の権限があります：

<figure><img src="../../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

MFAのためにWebからSharepointにアクセスできない場合でも、生成されたトークンを使用してファイルにアクセスすることが可能です：
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## 参考文献

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**のGitHubリポジトリ[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>
