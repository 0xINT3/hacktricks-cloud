# Az - Voorwaardelike Toegangsbeleid / MFA-Omweg

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

Azure Voorwaardelike Toegangsbeleide is re√´ls wat in Microsoft Azure opgestel word om toegangskontroles tot Azure-diens en -toepassings af te dwing op grond van sekere **voorwaardes**. Hierdie beleide help organisasies om hul hulpbronne te beveilig deur die regte toegangskontroles onder die regte omstandighede toe te pas.\
Voorwaardelike toegangsbeleide definieer basies **Wie** kan **Wat** van **Waar** en **Hoe** toegang verkry.

Hier is 'n paar voorbeelde:

1. **Aanmeldingsrisikobeleid**: Hierdie beleid kan ingestel word om multi-faktor-verifikasie (MFA) te vereis wanneer 'n aanmeldingsrisiko opgespoor word. Byvoorbeeld, as 'n gebruiker se aanmeldingsgedrag ongewoon is in vergelyking met hul gewone patroon, soos om van 'n ander land in te teken, kan die stelsel vra om addisionele verifikasie.
2. **Toestelnakomingsbeleid**: Hierdie beleid kan toegang tot Azure-diens slegs beperk tot toestelle wat voldoen aan die organisasie se sekuriteitsstandaarde. Byvoorbeeld, toegang kan slegs toegelaat word vanaf toestelle wat opgedateerde antivirus sagteware het of 'n sekere bedryfstelselweergawe gebruik.

## Omwegs vir Voorwaardelike Toegangsbeleide

Dit is moontlik dat 'n voorwaardelike toegangsbeleid **sekere inligting nagaan wat maklik vervals kan word en sodoende 'n omweg van die beleid toelaat**. En as byvoorbeeld die beleid MFA instel, sal die aanvaller dit kan omseil.

### Toestelplatforms - Toestelvoorwaarde

Dit is moontlik om 'n voorwaarde te stel gebaseer op die **toestelplatform** (Android, iOS, Windows, macOS), maar dit is gebaseer op die **gebruikersagent**, dus dit is redelik maklik om dit te omseil. Selfs al maak jy al die opsies dwing MFA, as jy 'n **gebruikersagent gebruik wat dit nie herken nie**, sal jy die MFA kan omseil.

### Lokasies: Lande, IP-reekse - Toestelvoorwaarde

Natuurlik kan 'n aanvaller, as dit in die voorwaardelike beleid ingestel is, net 'n **VPN** in die **toegelate land** gebruik of probeer om 'n manier te vind om vanaf 'n **toegelate IP-adres** toegang te verkry om hierdie voorwaardes te omseil.

### Office365-kli√´nttoepassings

Jy kan aandui dat as kli√´nte **Office 365-toepassings vanaf die blaaier toegang verkry, hulle MFA benodig**:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Om dit te omseil, is dit moontlik om voor te gee dat jy inlog in 'n toepassing vanaf 'n lessenaarprogram (soos Microsoft Teams in die volgende voorbeeld) wat die beskerming sal omseil:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Aangesien die Microsoft Teams-app baie toestemmings het, sal jy in staat wees om daardie toegang te gebruik.

{% hint style="success" %}
Jy kan die **ID van meer openbare toepassings** met vooraf gedefinieerde Office365-toestemmings in die databasis van roadtools vind:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Hierdie aanval is besonders interessant omdat openbare Office365-toepassings standaard toestemmings het om toegang tot sekere data te verkry.

### Ander toepassings

Standaard sal ander toepassings wat deur gebruikers geskep word nie toestemmings h√™ en privaat wees.\
Nietemin kan gebruikers ook **openbare toepassings** skep wat hulle sekere toestemmings gee.

'n Potensi√´le scenario waar 'n beleid ingestel is om **MFA te vereis om toegang tot 'n toepassing te verkry** wanneer die gebruiker 'n **blaaier gebruik** (miskien omdat dit 'n webtoepassing is en dit sal dus die enigste manier wees), as daar 'n **proksitoepassing** is - 'n toepassing wat toegelaat word om **namens gebruikers met ander toepassings te kommunikeer** -, kan die gebruiker **inlog in die proksitoepassing** en dan deur hierdie proksitoepassing **inlog in die aanvanklik MFA-beskermde toepassing**.

Kyk na die [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) en die [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) tegnieke.

## Ander Az MFA-omseilings

### Beltoon

Een Azure MFA-opsie is om 'n oproep te ontvang op die gekonfigureerde telefoonnommer waar die gebruiker gevra sal word om die karakter `#` te stuur.

{% hint style="danger" %}
Aangesien karakters net **tone** is, kan 'n aanvaller die **voicemail**-boodskap van die telefoonnommer **kompromitteer**, die toon van `#` as die boodskap konfigureer en dan, wanneer die MFA aangevra word, verseker dat die **slagoffer se telefoon besig is** (deur dit te bel) sodat die Azure-oproep na die voicemail omgelei word.
{% endhint %}

### Voldoenende toestelle

Beleide vra dikwels vir 'n voldoenende toestel of MFA, sodat 'n **aanvaller 'n voldoenende toestel kan registreer**, 'n **PRT**-token kan verkry en sodoende die MFA kan omseil.

Begin deur 'n **voldoenende toestel in Intune te registreer**, kry dan die PRT met:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Vind meer inligting oor hierdie soort aanval in die volgende bladsy:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Gereedskap

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Kry al die beleide
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep is 'n PowerShell-skripsie wat probeer om in te teken op verskeie Microsoft-diens met behulp van 'n verskafte stel geloofsbriewe en sal probeer om te identifiseer of MFA geaktiveer is. Afhangende van hoe voorwaardelike toegangsbeleide en ander multi-faktor-verifikasie-instellings gekonfigureer is, kan sommige protokolle eindig as enkel faktor. Dit het ook 'n addisionele kontrole vir ADFS-konfigurasies en kan probeer om in te teken op die plaaslike ADFS-bediener as dit opgespoor word.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token is 'n stel funksies wat daarop gemik is om sekuriteitskonsultante te help wat Conditional Access-beleide moet valideer, toetse vir 2FA-geaktiveerde Microsoft-portale, ens..
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Toets elke portaal** of dit moontlik is om **in te teken sonder MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Omdat die **Azure** **portal** nie beperk is nie, is dit moontlik om 'n token van die portal eindpunt te versamel om enige diens wat deur die vorige uitvoering opgespoor is, toegang te verkry. In hierdie geval is Sharepoint ge√Ødentifiseer en 'n token om toegang daartoe te verkry, word versoek:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}


Veronderstel dat die token die toestemming Sites.Read.All (van Sharepoint) het, selfs as jy nie toegang het tot Sharepoint vanaf die web nie as gevolg van MFA, is dit moontlik om die token te gebruik om toegang tot die l√™ers te verkry met die gegenereerde token:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Verwysings

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
