# Az - 条件付きアクセスポリシー / MFA バイパス

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## 基本情報

Azureの条件付きアクセスポリシーは、特定の**条件**に基づいてAzureサービスやアプリケーションへのアクセス制御を強制するためにMicrosoft Azureに設定されるルールです。これらのポリシーは、適切な状況下で適切なアクセス制御を適用することで、組織がリソースを保護するのに役立ちます。\
条件付きアクセスポリシーは基本的に**誰**が**どこから****何に**アクセスできるか、そして**どのように**アクセスできるかを定義します。

以下にいくつかの例を示します:

1. **サインインリスクポリシー**: このポリシーは、サインインリスクが検出された場合に多要素認証（MFA）を要求するように設定できます。たとえば、ユーザーのログイン動作が通常のパターンと異なる場合、異なる国からログインするなど、システムは追加の認証を求めることができます。
2. **デバイスコンプライアンスポリシー**: このポリシーは、組織のセキュリティ基準に準拠したデバイスのみがAzureサービスへのアクセスを制限できます。たとえば、最新のアンチウイルスソフトウェアを搭載しているデバイスからのみアクセスを許可したり、特定のオペレーティングシステムバージョンを実行しているデバイスからのみアクセスを許可したりできます。

## 条件付きアクセスポリシーのバイパス

条件付きアクセスポリシーが**容易に改ざんできる情報をチェックしている可能性があるため、ポリシーをバイパスすることができる**かもしれません。たとえば、ポリシーがMFAを設定している場合、攻撃者はそれをバイパスできます。

### デバイスプラットフォーム - デバイス条件

**デバイスプラットフォーム**（Android、iOS、Windows、macOS）に基づいた条件を設定することが可能ですが、これは**ユーザーエージェント**に基づいているため、簡単にバイパスできます。**すべてのオプションをMFAを強制する**場合でも、**認識されないユーザーエージェント**を使用すればMFAをバイパスできます。

### 場所: 国、IP範囲 - デバイス条件

もちろん、これが条件付きポリシーに設定されている場合、攻撃者は**許可された国**でVPNを使用したり、**許可されたIPアドレス**からアクセスしようとしたりして、これらの条件をバイパスできます。

### Office365クライアントアプリ

クライアントが**ブラウザからOffice 365アプリにアクセスする場合はMFAが必要**とすることができます:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

これをバイパスするためには、デスクトップアプリケーション（次の例ではMicrosoft Teamsにログインするような）からアプリにログインしたかのように見せることが可能です。
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Microsoft Teamsアプリには多くの権限があるため、そのアクセスを利用できます。

{% hint style="success" %}
**Office365の事前定義された権限を持つより多くのパブリックアプリケーション**のIDを、roadtoolsのデータベースで見つけることができます：

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

この攻撃は特に興味深いものであり、デフォルトでパブリックなOffice365アプリケーションは一部のデータにアクセスする権限を持っています。

### その他のアプリ

デフォルトでは、ユーザーが作成した他のアプリには権限がなく、プライベートになる可能性があります。\
ただし、ユーザーは**パブリック**な**アプリ**を作成して、それに一部の**権限を付与**することもできます。

ユーザーが**ブラウザ**を使用している場合（おそらくWebアプリケーションであるため、これが唯一の方法であるため）、アプリケーションにアクセスするために**MFAが必要なポリシー**が設定されているシナリオでは、**プロキシアプリケーション**が存在する場合 - ユーザーの代わりに**他のアプリケーションとやり取りすることが許可されているアプリケーション**-、ユーザーは**プロキシアプリケーションにログイン**し、その後このプロキシアプリケーションを介して**最初にMFAで保護されたアプリケーションにログイン**することができます。

[**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep)と[**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken)のテクニックをチェックしてください。

## その他のAz MFAバイパス

### リングトーン

Azure MFAのオプションの1つは、構成された電話番号に**着信を受ける**ことで、ユーザーに**文字 `#` を送信するように求める**ものです。

{% hint style="danger" %}
文字は単なる**音**であるため、攻撃者は電話番号の**ボイスメール**メッセージを**侵害**し、`#`の音をメッセージとして構成し、MFAを要求する際に**被害者の電話が使用中であることを確認**して（それを呼び出して）Azureの呼び出しがボイスメールに転送されるようにします。
{% endhint %}

### 準拠デバイス

ポリシーはしばしば準拠デバイスまたはMFAを要求するため、**攻撃者は準拠デバイスを登録**し、**PRT**トークンを取得して**この方法でMFAをバイパス**することができます。

まず、Intuneで**準拠デバイスを登録**し、次に次のコマンドを使用して**PRTを取得**します：

<figure><img src="../../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

この種の攻撃に関する詳細情報は、次のページで確認できます：

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ツール

### [roadrecon](https://github.com/dirkjanm/ROADtools)

すべてのポリシーを取得
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweepは、提供された資格情報を使用してさまざまなMicrosoftサービスにログインし、MFAが有効になっているかどうかを特定しようとするPowerShellスクリプトです。条件付きアクセスポリシーやその他の多要素認証設定がどのように構成されているかによっては、一部のプロトコルが単要素のままになることがあります。また、ADFSの構成に対する追加のチェックがあり、検出された場合にはオンプレミスのADFSサーバーにログインを試みることができます。
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey tokenは、条件付きアクセスポリシーを検証する必要があるセキュリティコンサルタント向けの関数セットであり、2要素認証が有効になっているMicrosoftポータルのテストを行います。
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**各ポータルをテスト**し、**MFAなしでログイン**できるかどうかを確認します：
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
<figure><img src="../../../.gitbook/assets/2023-03-06 17_02_47-.png" alt=""><figcaption></figcaption></figure>

**Azure** **ポータル** は **制約されていない** ため、前回の実行で検出された任意のサービスにアクセスするためのトークンを **ポータルエンドポイントから収集することが可能** です。この場合、Sharepoint が特定され、それにアクセスするためのトークンが要求されます:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/2023-03-06 17_11_28-Window.png" alt=""><figcaption></figcaption></figure>

トークンには、SharepointからのSites.Read.All権限があります：

<figure><img src="../../../.gitbook/assets/2023-03-06 17_11_43-Window.png" alt=""><figcaption></figcaption></figure>

MFAのためにWebからSharepointにアクセスできなくても、生成されたトークンを使用してファイルにアクセスすることが可能です：
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## 参考文献

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v/xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* 独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) コレクションである [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live) をフォローする。
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出して、あなたのハッキングテクニックを共有してください。

</details>
