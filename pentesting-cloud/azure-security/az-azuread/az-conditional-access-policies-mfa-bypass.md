# Az - Sera za Upatikanaji wa Masharti / Kupuuza MFA

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Sera za Upatikanaji wa Masharti za Azure ni sheria zilizowekwa katika Microsoft Azure kutekeleza udhibiti wa upatikanaji wa huduma na programu za Azure kulingana na **mazingira fulani**. Sera hizi husaidia mashirika kusimamia rasilimali zao kwa kutumia udhibiti sahihi wa upatikanaji chini ya mazingira sahihi.\
Sera za upatikanaji wa masharti kimsingi **inabainisha** **Nani** anaweza kupata **Nini** kutoka **Wapi** na **Vipi**.

Hapa kuna mifano michache:

1. **Sera ya Hatari ya Kuingia**: Sera hii inaweza kuwekwa kuhitaji uthibitishaji wa hatua nyingi (MFA) wakati hatari ya kuingia inagunduliwa. Kwa mfano, ikiwa tabia ya kuingia ya mtumiaji ni isiyo ya kawaida ikilinganishwa na mfumo wao wa kawaida, kama vile kuingia kutoka nchi tofauti, mfumo unaweza kuomba uthibitishaji wa ziada.
2. **Sera ya Ufuatiliaji wa Kifaa**: Sera hii inaweza kuzuia upatikanaji wa huduma za Azure tu kwa vifaa ambavyo vinazingatia viwango vya usalama vya shirika. Kwa mfano, upatikanaji unaweza kuruhusiwa tu kutoka kwa vifaa vilivyo na programu ya antivirus iliyosasishwa au vinavyotumia toleo fulani la mfumo wa uendeshaji.

## Kupuuza Sera za Upatikanaji wa Masharti

Inawezekana kwamba sera ya upatikanaji wa masharti ina **kagua habari fulani ambayo inaweza kubadilishwa kwa urahisi kuruhusu kupuuza sera**. Na ikiwa kwa mfano sera ilikuwa inaendesha MFA, muhusika ataweza kuipuuza.

### Majukwaa ya Kifaa - Hali ya Kifaa

Inawezekana kuweka hali kulingana na **jukwaa la kifaa** (Android, iOS, Windows, macOS), hata hivyo, hii inategemea **user-agent** hivyo ni rahisi sana kuihepa. Hata **kufanya chaguzi zote kutekeleza MFA**, ikiwa utatumia **user-agent ambayo haitambui** utaweza kuihepa MFA.

### Maeneo: Nchi, Vipimo vya IP - Hali ya Kifaa

Bila shaka ikiwa hii imewekwa katika sera ya upatikanaji, muhusika anaweza tu kutumia **VPN** katika **nchi iliyoruhusiwa** au jaribu kupata njia ya kupata kutoka kwa **anwani ya IP iliyoruhusiwa** ili kuihepa hali hizi.

### Programu za Wateja za Office365

Unaweza kusema kwamba ikiwa wateja **wanapata programu za Ofisi 365 kutoka kwa kivinjari wanahitaji MFA**:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Kupuuza hii, inawezekana kujifanya unajiingiza kwenye programu kutoka kwa programu ya desktop (kama vile kwa Timu za Microsoft kwenye mfano ufuatao) ambayo itaipuuza ulinzi:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
Kwa kuwa programu ya Microsoft Teams ina idhini nyingi, utaweza kutumia ufikiaji huo.

{% hint style="success" %}
Unaweza kupata **Kitambulisho cha programu za umma zaidi** na idhini zilizopangwa za Office365 katika database ya roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Shambulizi hili ni maalum kwa sababu kwa chaguo-msingi programu za umma za Office365 zitakuwa na ruhusa ya kupata baadhi ya data.

### Programu Nyingine

Kwa chaguo-msingi, programu nyingine zilizoundwa na watumiaji hazitakuwa na ruhusa na zinaweza kuwa za kibinafsi.\
Hata hivyo, watumiaji pia wanaweza kuunda **programu za umma** zikiwapa baadhi ya **ruhusa.**

Hali inayowezekana ni pale sera inapowekwa ku **hitaji MFA kupata programu** wakati mtumiaji anatumia **kivinjari** (labda kwa sababu ni programu ya wavuti na hivyo itakuwa njia pekee), ikiwa kuna **programu ya proksi** - programu inayoruhusiwa **kuingiliana na programu nyingine kwa niaba ya watumiaji**-, mtumiaji anaweza **kuingia kwenye programu ya proksi** na kisha kupitia programu hii ya proksi **kuingia kwenye programu iliyolindwa awali na MFA.**

Angalia [**Invoke-MFASweep**](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep) na [**donkeytoken**](az-conditional-access-policies-mfa-bypass.md#donkeytoken) mbinu.

## Mbinu Nyingine za Kupuuza Az MFA

### Tone ya Simu

Chaguo moja la Azure MFA ni **kupokea simu kwenye nambari ya simu iliyowekwa** ambapo mtumiaji ataulizwa **kupeleka herufi `#`**.

{% hint style="danger" %}
Kwa kuwa herufi ni **sauti tu**, mshambuliaji anaweza **kuathiri** ujumbe wa **ujumbe wa sauti** wa nambari ya simu, kuweka kama ujumbe sauti **sauti ya `#`** na kisha, wakati wa kuhitaji MFA hakikisha kuwa **simu ya waathiriwa ina shughuli** (kuiita) ili simu ya Azure ielekezwe kwenye ujumbe wa sauti.
{% endhint %}

### Vifaa Vinavyofuata Sera

Mara nyingi sera huzingatia vifaa vinavyofuata au MFA, hivyo **mshambuliaji anaweza kujiandikisha kifaa kinachofuata sera**, kupata **cheti cha PRT** na **kupuuza njia hii ya MFA**.

Anza kwa kujiandikisha **kifaa kinachofuata sera katika Intune**, kisha **pata PRT** na:
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
Pata habari zaidi kuhusu aina hii ya shambulizi katika ukurasa ufuatao:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Zana

### [roadrecon](https://github.com/dirkjanm/ROADtools)

Pata sera zote
```bash
roadrecon plugin policies
```
### [Kuamsha-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep ni script ya PowerShell ambayo inajaribu **kuingia kwenye huduma mbalimbali za Microsoft kwa kutumia seti ya maelezo ya kuingia yaliyotolewa na itajaribu kutambua ikiwa MFA imewezeshwa**. Kulingana na jinsi sera za upatikanaji wa masharti na mipangilio mingine ya uthibitishaji wa hatua nyingi zilivyojulikana, baadhi ya itifaki zinaweza kuishia kuwa na kiwango kimoja cha uthibitishaji. Pia ina ukaguzi wa ziada kwa mazingira ya ADFS na inaweza kujaribu kuingia kwenye seva ya ADFS ya ndani ikiwa itagunduliwa.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token ni seti ya kazi ambazo lengo lake ni kusaidia washauri wa usalama ambao wanahitaji kuthibitisha Sera za Kufikia za Masharti, kufanya vipimo kwa milango ya Microsoft iliyowezeshwa na 2FA, n.k.
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Jaribu kila mlango** ikiwa ni **kupata kuingia bila MFA**:
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
Kwa sababu **Azure** **portal** **haizingatiwi**, inawezekana **kukusanya token kutoka kwa mwisho wa portal ili kupata upatikanaji wa huduma yoyote iliyogunduliwa** na utekelezaji uliopita. Katika kesi hii, Sharepoint iligunduliwa, na token ya kupata niombwa:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}


Kukadiria kwamba token ina idhini ya Sites.Read.All (kutoka kwa Sharepoint), hata kama huwezi kupata Sharepoint kutoka kwenye wavuti kwa sababu ya MFA, ni rahisi kutumia token kufikia faili zilizotengenezwa na token:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## Marejeo

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
