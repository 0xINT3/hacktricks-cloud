# Az - Enregistrement de l'appareil

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

- Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
- D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

Lorsqu'un appareil rejoint AzureAD, un nouvel objet est cr√©√© dans AzureAD.

Lors de l'enregistrement d'un appareil, **l'utilisateur est invit√© √† se connecter avec son compte** (en demandant une MFA si n√©cessaire), puis il demande des jetons pour le service d'enregistrement de l'appareil et demande ensuite une confirmation finale.

Ensuite, deux paires de cl√©s RSA sont g√©n√©r√©es dans l'appareil : La **cl√© de l'appareil** (cl√© **publique**) qui est envoy√©e √† **AzureAD** et la **cl√© de transport** (cl√© **priv√©e**) qui est stock√©e dans le TPM si possible.

Ensuite, l'**objet** est g√©n√©r√© dans **AzureAD** (pas dans Intune) et AzureAD renvoie √† l'appareil un **certificat** sign√© par lui. Vous pouvez v√©rifier que l'appareil est joint √† AzureAD et des informations sur le **certificat** (comme s'il est prot√©g√© par TPM).
```bash
dsregcmd /status
```
Apr√®s l'enregistrement du p√©riph√©rique, un **jeton de rafra√Æchissement principal** est demand√© par le module LSASS CloudAP et donn√© au p√©riph√©rique. Avec le PRT est √©galement livr√©e la **cl√© de session crypt√©e pour que seul le p√©riph√©rique puisse la d√©crypter** (en utilisant la cl√© publique de la cl√© de transport) et elle est **n√©cessaire pour utiliser le PRT**.

Pour plus d'informations sur ce qu'est un PRT, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Module de plateforme s√©curis√©e

Le **TPM** **prot√®ge** contre l'**extraction** de cl√©s √† partir d'un p√©riph√©rique √©teint (s'il est prot√©g√© par un NIP) et contre l'extraction du mat√©riel priv√© de la couche OS.\
Mais il ne **prot√®ge pas** contre **l'interception** de la connexion physique entre le TPM et le CPU ou **l'utilisation du mat√©riel cryptographique** dans le TPM pendant que le syst√®me est en cours d'ex√©cution √† partir d'un processus avec des droits **SYSTEM**.

Si vous consultez la page suivante, vous verrez que **voler le PRT** peut √™tre utilis√© pour acc√©der comme un **utilisateur**, ce qui est g√©nial car le **PRT est situ√© sur les p√©riph√©riques**, il peut donc √™tre vol√© aupr√®s d'eux (ou s'il n'est pas vol√©, il peut √™tre utilis√© de mani√®re abusive pour g√©n√©rer de nouvelles cl√©s de signature) :

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Enregistrer un p√©riph√©rique avec des jetons SSO

Il serait possible pour un attaquant de demander un jeton pour le service d'enregistrement de p√©riph√©rique Microsoft √† partir du p√©riph√©rique compromis et de l'enregistrer :
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## Remplacement d'un ticket de p√©riph√©rique

Il √©tait possible de **demander un ticket de p√©riph√©rique**, **√©craser** celui actuel du p√©riph√©rique, et pendant le processus **voler le PRT** (donc pas besoin de le voler du TPM. Pour plus d'informations [**consultez cette pr√©sentation**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Cependant, cela a √©t√© corrig√©.
{% endhint %}

## Remplacer la cl√© WHFB

**[Consultez les diapositives originales ici](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)**

R√©sum√© de l'attaque :

* Il est possible de **remplacer** la **cl√© WHFB** enregistr√©e d'un **p√©riph√©rique** via SSO
* Cela **contourne la protection TPM** car la cl√© est **captur√©e lors de la g√©n√©ration** de la nouvelle cl√©
* Cela fournit √©galement de la **persistance**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Les utilisateurs peuvent modifier leur propre propri√©t√© searchableDeviceKey via le Graph Azure AD, cependant, l'attaquant doit avoir un p√©riph√©rique dans le locataire (enregistr√© √† la vol√©e ou ayant vol√© le certificat + cl√© d'un p√©riph√©rique l√©gitime) et un jeton d'acc√®s valide pour le Graph AAD.

Ensuite, il est possible de g√©n√©rer une nouvelle cl√© avec :
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
et ensuite PATCH les informations de la searchableDeviceKey :

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Il est possible d'obtenir un jeton d'acc√®s d'un utilisateur via **l'hame√ßonnage de code de p√©riph√©rique** et d'abuser des √©tapes pr√©c√©dentes pour **voler son acc√®s**. Pour plus d'informations, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## R√©f√©rences

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
