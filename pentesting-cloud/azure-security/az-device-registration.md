# Usajili wa Kifaa wa Az

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Wakati kifaa kinajiunga na AzureAD, kifaa kipya huundwa katika AzureAD.

Wakati wa kusajili kifaa, **mtumiaji anaulizwa kuingia kwa akaunti yake** (akihitaji MFA ikiwa inahitajika), kisha inaomba vibali kwa huduma ya usajili wa kifaa na kisha kuuliza uthibitisho wa mwisho.

Kisha, jozi mbili za RSA huzalishwa kwenye kifaa: **funguo la kifaa** (**funguo la umma**) ambalo huletwa kwa **AzureAD** na **funguo la usafirishaji** (**funguo la binafsi**) ambalo hifadhiwa kwenye TPM ikiwezekana.

Kisha, **kitu** huundwa katika **AzureAD** (si katika Intune) na AzureAD inarudisha kwa kifaa **cheti** kilichosainiwa na hiyo. Unaweza kuthibitisha kuwa **kifaa kimejiunga na AzureAD** na habari kuhusu **cheti** (kama ikiwa linalindwa na TPM).
```bash
dsregcmd /status
```
Baada ya usajili wa kifaa **Primary Refresh Token** inahitajika na moduli ya LSASS CloudAP na kutolewa kwa kifaa. Pamoja na PRT, **funguo la kikao limefichwa ili kifaa pekee ndilo liweze kulifungua** (kwa kutumia funguo ya umma ya funguo la usafirishaji) na **linahitajika kutumia PRT.**

Kwa habari zaidi kuhusu ni nini PRT angalia:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Moduli ya Jukwaa Iliyothibitishwa

**TPM** **inalinda** dhidi ya **uchimbaji** wa funguo kutoka kifaa kilichozimwa (ikiwa inalindwa na PIN) na dhidi ya kuchimba vifaa vya kibinafsi kutoka safu ya OS. Lakini **hailindi** dhidi ya **kuchakura** uhusiano wa kimwili kati ya TPM na CPU au **kutumia vifaa vya kryptographi** katika TPM wakati mfumo unafanya kazi kutoka kwa mchakato wenye haki za **SYSTEM**.

Ikiwa unachunguza ukurasa ufuatao utaona kwamba **kuiba PRT** inaweza kutumika kupata ufikiaji kama **mtumiaji**, ambayo ni nzuri kwa sababu **PRT iko kwenye vifaa**, hivyo inaweza kuibiwa kutoka kwao (au ikiwa haijaibiwa inaweza kutumiwa vibaya kuzalisha funguo mpya za kusaini):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Kusajili kifaa na vibali vya SSO

Inawezekana kwa mshambuliaji kuomba kibali kwa huduma ya usajili wa kifaa cha Microsoft kutoka kwa kifaa kilichoharibiwa na kusajili kifaa hicho:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## Kubadilisha tiketi ya kifaa

Ilitakuwa **inawezekana kuomba tiketi ya kifaa**, **kubadilisha** ile ya sasa ya kifaa, na wakati wa mchakato **kuiba PRT** (hivyo hakuna haja ya kuiba kutoka kwa TPM. Kwa maelezo zaidi [**angalia mazungumzo haya**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Hata hivyo, hili lilirekebishwa.
{% endhint %}

## Kubadilisha funguo za WHFB

[**Angalia slaidi za asili hapa**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Muhtasari wa shambulio:

* Inawezekana **kubadilisha** **funguo za WHFB** zilizosajiliwa kutoka kwa **kifaa** kupitia SSO
* Inapita **ulinzi wa TPM** kwa sababu funguo inachukuliwa wakati wa **kuzalisha** funguo mpya
* Hii pia hutoa **uthabiti**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Watumiaji wanaweza kurekebisha mali yao ya searchableDeviceKey kupitia Azure AD Graph, hata hivyo, mshambuliaji anahitaji kuwa na kifaa katika mpangaji (kusajiliwa papo hapo au kuiba cheti + funguo kutoka kifaa halali) na token halali la ufikiaji kwa AAD Graph.

Kisha, inawezekana kuzalisha funguo mpya na:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
and then PATCH the information of the searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Inawezekana kupata tokeni ya ufikiaji kutoka kwa mtumiaji kupitia **udanganyifu wa nambari ya kifaa** na kutumia hatua za awali kuiba ufikiaji wake. Kwa maelezo zaidi angalia:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Marejeo

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
