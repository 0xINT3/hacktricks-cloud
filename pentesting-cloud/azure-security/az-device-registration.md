# Az - Device Registration

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 해킹 기법을 공유하세요.

</details>

## 기본 정보

장치가 AzureAD에 가입하면 AzureAD에 새로운 개체가 생성됩니다.

장치를 등록할 때, **사용자는 자신의 계정으로 로그인**하도록 요청됩니다(MFA가 필요한 경우 MFA를 요청합니다). 그런 다음, 장치 등록 서비스에 대한 토큰을 요청하고 최종 확인 프롬프트를 요청합니다.

그런 다음, 장치에서 두 개의 RSA 키 쌍이 생성됩니다: **장치 키**(공개 키)는 **AzureAD**로 전송되고, **전송** 키\*\*(개인\*\* 키)는 가능한 경우 TPM에 저장됩니다.

그런 다음, **AzureAD**(Intune이 아닌)에서 **개체**가 생성되고, AzureAD에서 장치에게 스스로에 의해 서명된 **인증서**를 반환합니다. 장치가 AzureAD에 가입되어 있는지 및 **인증서**(TPM으로 보호되는지 여부와 같은)에 대한 정보를 확인할 수 있습니다.

```bash
dsregcmd /status
```

장치 등록 후 LSASS CloudAP 모듈에서 \*\*기본 새로 고침 토큰(Primary Refresh Token, PRT)\*\*을 요청하고 장치에 제공됩니다. PRT와 함께 **세션 키가 암호화되어 장치만이 복호화할 수 있도록 전달**됩니다(전송 키의 공개 키를 사용). PRT를 사용하려면 이 키가 **필요**합니다.

PRT가 무엇인지에 대한 자세한 정보는 다음을 확인하세요:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM**은 (PIN으로 보호된 경우) 전원이 꺼진 장치에서 키를 추출하는 것과 OS 레이어에서 개인 자료를 추출하는 것으로부터 **보호**합니다.\
하지만 TPM은 TPM과 CPU 사이의 물리적 연결을 **스니핑**하거나 시스템이 **SYSTEM** 권한을 가진 프로세스에서 실행되는 동안 TPM의 암호 자료를 **사용**하는 것에 대해서는 **보호하지 않습니다**.

다음 페이지를 확인하면 **PRT를 도용**하여 **사용자**처럼 액세스할 수 있다는 것을 알 수 있습니다. 이는 PRT가 장치에 위치하기 때문에 장치에서 도용될 수 있으며(도용되지 않은 경우 새로운 서명 키를 생성하는 데 악용될 수 있음):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO 토큰으로 장치 등록하기

공격자는 침투한 장치에서 Microsoft 장치 등록 서비스에 대한 토큰을 요청하고 등록할 수 있습니다:

```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```

다음은 해킹 기법에 관한 해킹 책의 내용입니다. 다음 내용은 파일 /hive/hacktricks-cloud/pentesting-cloud/azure-security/az-device-registration.md에서 가져온 것입니다. 관련 영어 텍스트를 한국어로 번역하고 정확히 동일한 마크다운 및 HTML 구문을 유지한 채 번역을 반환하세요. 코드, 해킹 기법 이름, 해킹 용어, 클라우드/SaaS 플랫폼 이름(예: Workspace, aws, gcp...), 'leak'이라는 단어, pentesting 및 마크다운 태그와 같은 것들은 번역하지 마십시오. 또한 번역 및 마크다운 구문 이외의 추가적인 내용은 추가하지 마십시오.

**향후 PRT 요청에 사용할 수 있는 인증서**를 제공합니다. 따라서 원래 PRT 토큰을 사용하여 새 장치를 등록하는 동안 **MFA 우회**와 **지속성 유지**가 가능합니다. 이는 새 장치를 등록하는 데 필요한 권한이 있어야 한다는 점에 유의하십시오. 또한, 장치를 등록한다고 해서 Intune에 등록될 수 있는 것은 아닙니다.

{% hint style="danger" %}
이 공격은 2021년 9월에 수정되었으며 SSO 토큰을 사용하여 새 장치를 등록할 수 없습니다. 그러나 여전히 정당한 방법(사용자 이름, 비밀번호 및 필요한 경우 MFA)으로 장치를 등록하는 것은 가능합니다. 확인: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/kr/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## 장치 티켓 덮어쓰기

**장치 티켓을 요청**하고, 장치의 **현재 티켓을 덮어쓰고**, 플로우 중에 **PRT를 탈취**할 수 있었습니다 (따라서 TPM에서 탈취할 필요가 없습니다. 자세한 내용은 [**이 발표를 확인하세요**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
그러나 이는 수정되었습니다.
{% endhint %}

## WHFB 키 덮어쓰기

[**원본 슬라이드는 여기에서 확인하세요**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

공격 요약:

* SSO를 통해 장치의 등록된 WHFB 키를 **덮어쓸 수 있습니다**
* 새 키 생성 중에 키가 **스니핑되므로 TPM 보호를 무력화**시킵니다
* 이는 또한 **지속성을 제공**합니다

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

사용자는 Azure AD Graph를 통해 자체 searchableDeviceKey 속성을 수정할 수 있지만, 공격자는 테넌트에 장치(실시간 등록 또는 정당한 장치에서 인증서 + 키를 도난한)를 가져야 하며 AAD Graph에 대한 유효한 액세스 토큰이 있어야 합니다.

그런 다음 다음과 같이 새 키를 생성할 수 있습니다:

```bash
roadtx genhellokey -d <device id> -k tempkey.key
```

그리고 searchableDeviceKey의 정보를 PATCH합니다:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

**디바이스 코드 피싱**을 통해 사용자로부터 액세스 토큰을 얻고 이전 단계를 악용하여 그의 액세스를 **훔칠 수 있습니다**. 자세한 정보는 다음을 참조하십시오:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## 참고 자료

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로에서 영웅까지 AWS 해킹을 배워보세요**!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
