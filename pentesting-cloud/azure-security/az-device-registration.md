# Az - 장치 등록

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로**부터 **히어로**까지 **AWS 해킹**을 배우세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고**되길 원하거나 **PDF 형식의 HackTricks를 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 기본 정보

장치가 AzureAD에 가입하면 AzureAD에 새 개체가 생성됩니다.

장치를 등록할 때 **사용자는 자신의 계정으로 로그인**하도록 요청받습니다(필요시 MFA를 요청), 그런 다음 장치 등록 서비스에 대한 토큰을 요청하고 최종 확인 프롬프트를 요청합니다.

그런 다음, 장치에서 두 개의 RSA 키페어가 생성됩니다: **장치 키**(**공개** 키)는 **AzureAD**로 전송되고 **전송** 키(**개인** 키)는 가능한 경우 TPM에 저장됩니다.

그런 다음, **AzureAD**(Intune이 아님)에서 **개체**가 생성되고 AzureAD는 장치에게 자체가 서명한 **인증서**를 반환합니다. **장치가 AzureAD에 가입**되었는지 및 **인증서**에 대한 정보(예: TPM으로 보호되었는지)를 확인할 수 있습니다.
```bash
dsregcmd /status
```
장치 등록 후 LSASS CloudAP 모듈에서 **기본 새로 고침 토큰**이 요청되고 장치에 제공됩니다. PRT와 함께 **세션 키가 전달되며 장치만이 해독할 수 있도록 암호화**됩니다(전송 키의 공개 키를 사용). 이것은 **PRT를 사용하는 데 필요**합니다.

PRT가 무엇인지에 대한 자세한 정보는 확인하십시오:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - 신뢰할 수 있는 플랫폼 모듈

**TPM**은 전원이 꺼진 장치로부터 키 **추출**을 방지하고 (PIN으로 보호된 경우) OS 레이어에서 개인 자료를 추출하는 것을 방지합니다.\
그러나 **TPM은** TPM과 CPU 간의 물리적 연결을 **스니핑**하거나 시스템이 **SYSTEM** 권한을 가진 프로세스에서 실행되는 동안 TPM의 암호 자료를 **사용하는 것을 방지하지 않습니다**.

다음 페이지를 확인하면 **PRT를 도용**하여 **사용자처럼 액세스**할 수 있음을 알 수 있습니다. 이는 **PRT가 장치에 위치**하기 때문에 장치로부터 도난당할 수 있습니다(도난당하지 않았더라도 새로운 서명 키를 생성하는 데 악용될 수 있음):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSO 토큰으로 장치 등록

공격자가 감염된 장치로부터 Microsoft 장치 등록 서비스에 대한 토큰을 요청하고 등록할 수 있습니다:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## 장래에 PRT를 요청할 때 사용할 수 있는 **인증서를 제공**합니다. 따라서 지속성을 유지하고 **MFA 우회**를 할 수 있습니다. 왜냐하면 새로운 장치를 등록할 때 사용된 원본 PRT 토큰은 이미 **MFA 권한이 부여**되어 있기 때문입니다.

{% hint style="success" %}
이 공격을 수행하려면 **새로운 장치를 등록할 권한**이 필요합니다. 또한, 장치를 등록한다고 해서 해당 장치가 **Intune에 등록될 수 있다는 것을 의미하지는 않습니다**.
{% endhint %}

{% hint style="danger" %}
이 공격은 2021년 9월에 수정되었습니다. SSO 토큰을 사용하여 새로운 장치를 등록할 수 없게 되었습니다. 그러나 여전히 (사용자 이름, 암호 및 필요한 경우 MFA를 가지고) 합법적인 방법으로 장치를 등록하는 것은 가능합니다. 확인: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/master/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## 장치 티켓 덮어쓰기

**장치 티켓을 요청**하고, 장치의 현재 티켓을 **덮어쓰고**, 흐름 중에 **PRT를 탈취**할 수 있었습니다 (따라서 TPM에서 탈취할 필요가 없습니다. 자세한 정보는 [**이 발표를 확인하세요**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
그러나 이것은 수정되었습니다.
{% endhint %}

## WHFB 키 덮어쓰기

[**원본 슬라이드를 여기서 확인하세요**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

공격 요약:

* SSO를 통해 **장치**의 **등록된 WHFB 키를 덮어쓸 수 있습니다**
* 새로운 키 생성 중에 키가 **스니핑되므로 TPM 보호를 무력화**합니다
* 이는 또한 **지속성을 제공**합니다

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

사용자는 자신의 searchableDeviceKey 속성을 Azure AD Graph를 통해 수정할 수 있지만, 공격자는 테넌트에 장치가 있어야 하며(Azure AD Graph에 대한 유효한 액세스 토큰을 가지고 있어야 함), 합법적인 장치에서 인증서 + 키를 도난당한 경우에는 플라이어 등록된 장치를 가져야 합니다.

그런 다음, 다음과 같이 새 키를 생성할 수 있습니다:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
그런 다음 searchableDeviceKey의 정보를 PATCH하십시오:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

**장치 코드 피싱**을 통해 사용자로부터 액세스 토큰을 얻고 이전 단계를 악용하여 **그의 액세스를 도용**할 수 있습니다. 자세한 정보는 확인하십시오:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## 참고 자료

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)를 통해 제로부터 영웅이 되는 AWS 해킹을 배우세요</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 PDF로 HackTricks를 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구입하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [**디스코드 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나**트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **HackTricks 및 HackTricks Cloud** 깃허브 저장소에 PR을 제출하여 **해킹 트릭을 공유하세요.**

</details>
