# Az - デバイス登録

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## 基本情報

デバイスがAzureADに参加すると、AzureADに新しいオブジェクトが作成されます。

デバイスを登録する際、**ユーザーは自分のアカウントでログインするよう求められます**（必要に応じてMFAを求める）、その後デバイス登録サービスのトークンを要求し、最終確認プロンプトを求めます。

次に、デバイスに2つのRSAキーペアが生成されます：**デバイスキー**（**公開**キー）は**AzureAD**に送信され、**トランスポート**キー（**秘密**キー）は可能であればTPMに保存されます。

その後、**オブジェクト**が**AzureAD**に（Intuneではなく）生成され、AzureADはデバイスにそれに署名した**証明書**を返します。デバイスがAzureADに参加していること、および**証明書**に関する情報（TPMによって保護されているかどうかなど）を確認できます。
```bash
dsregcmd /status
```
デバイス登録後、**Primary Refresh Token**（PRT）がLSASS CloudAPモジュールによって要求され、デバイスに与えられます。PRTと共に、**デバイスのみが復号できるように暗号化されたセッションキー**（トランスポートキーの公開鍵を使用して）も配信され、**PRTを使用するために必要です。**

PRTについての詳細は以下を確認してください：

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM**は、PINで保護されている場合に電源が切れたデバイスからのキー**抽出**を**防ぎ**、OSレイヤーからのプライベート素材の抽出を防ぎます。\
しかし、TPMとCPUの間の物理的な接続を**スニッフィング**することや、**SYSTEM**権限を持つプロセスから実行中のシステムでTPM内の暗号素材を**使用**することに対しては**保護しません**。

以下のページを確認すると、**PRTを盗む**ことが、**ユーザー**のようにアクセスするために使用できることがわかります。これは、**PRTがデバイスに位置している**ため、素晴らしいことです。つまり、それらから盗むことができます（または盗まれていない場合でも新しい署名キーを生成するために悪用される可能性があります）：

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSOトークンを使用したデバイスの登録

攻撃者は、侵害されたデバイスからMicrosoftデバイス登録サービスのためのトークンを要求することが可能です：
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>
```
デバイスを登録することができます：

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

これにより、**将来PRTを要求するために使用できる証明書**が得られます。したがって、元のPRTトークンが新しいデバイスを登録するために使用され、**既にMFAの許可が与えられていた**ため、持続性を維持し、**MFAをバイパス**します。

{% hint style="success" %}
この攻撃を実行するには、**新しいデバイスを登録する権限**が必要であることに注意してください。また、デバイスを登録しても、そのデバイスが**Intuneに登録されることを意味するわけではありません**。
{% endhint %}

{% hint style="danger" %}
この攻撃は2021年9月に修正されました。SSOトークンを使用して新しいデバイスを登録することはできなくなりました。しかし、正当な方法でデバイスを登録することはまだ可能です（ユーザー名、パスワード、必要に応じてMFAを持っている）。確認してください：[**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)。
{% endhint %}

## デバイスチケットの上書き

**デバイスチケットを要求し**、デバイスの現在のチケットを**上書き**、フロー中に**PRTを盗む**ことが可能でした（TPMから盗む必要はありません。詳細はこの[**トーク**](https://youtu.be/BduCn8cLV1A)を確認してください）。

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
しかし、これは修正されました。
{% endhint %}

## WHFBキーの上書き

攻撃の概要：

* SSO経由で**デバイス**の**登録されたWHFB**キーを**上書き**することが可能です
* 新しいキーの生成中にキーが**嗅ぎ取られる**ため、**TPM保護を無効にします**
* これにより**持続性**も提供されます

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

ユーザーはAzure AD Graphを介して自分のsearchableDeviceKeyプロパティを変更することができますが、攻撃者はテナント内にデバイスを持っている必要があります（その場で登録するか、正当なデバイスから盗んだ証明書+キーを持っている）とAAD Graphの有効なアクセストークンが必要です。

次に、新しいキーを生成することが可能です：
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
```markdown
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

そして、searchableDeviceKeyの情報をPATCHします：

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

ユーザーから**デバイスコードフィッシング**を通じてアクセストークンを取得し、前述の手順を悪用して**アクセスを盗む**ことが可能です。詳細は以下をチェックしてください：

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## 参考文献

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
```
