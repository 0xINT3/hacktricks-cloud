# Az - Toestelregistrasie

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kontroleer die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

Wanneer 'n toestel by AzureAD aansluit, word 'n nuwe objek in AzureAD geskep.

Met die registrasie van 'n toestel, word die **gebruiker gevra om in te teken met sy rekening** (vra om MFA indien nodig), dan versoek dit tokens vir die toestelregistrasiediens en vra dan 'n finale bevestigingsvenster.

Dan word twee RSA-sleutelpare op die toestel gegenereer: Die **toestelsleutel** (**publieke** sleutel) wat na **AzureAD** gestuur word en die **vervoer** sleutel (**privaat** sleutel) wat indien moontlik in TPM gestoor word.

Dan word die **objek** gegenereer in **AzureAD** (nie in Intune nie) en AzureAD gee aan die toestel 'n **sertifikaat** wat deur dit onderteken is. Jy kan nagaan dat die **toestel by AzureAD aangesluit** is en inligting oor die **sertifikaat** (soos of dit deur TPM beskerm word).
```bash
dsregcmd /status
```
Na die toestelregistrasie word 'n **Prim√™re Verfrissingsleutel** aangevra deur die LSASS CloudAP-module en aan die toestel gegee. Saam met die PRT word ook die **sessiesleutel versleutel sodat slegs die toestel dit kan ontsluit** (deur die openbare sleutel van die vervoersleutel te gebruik) en dit is **nodig om die PRT te gebruik.**

Vir meer inligting oor wat 'n PRT is, kyk:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Vertroude Platform Module

Die **TPM** **beskerm** teen sleutel **onttrekking** van 'n afgeskakelde toestel (indien beskerm deur 'n PIN) en teen die ontginning van die private materiaal van die OS-laag.\
Maar dit **beskerm nie** teen **snuffel** van die fisiese verbinding tussen die TPM en CPU of teen **die gebruik van die kriptografiese materiaal** in die TPM terwyl die stelsel van 'n proses met **SYSTEM** regte hardloop nie.

As jy die volgende bladsy nagaan, sal jy sien dat **die steel van die PRT** gebruik kan word om toegang te verkry soos 'n **gebruiker**, wat wonderlik is omdat die **PRT op toestelle gele√´ is**, sodat dit van hulle gesteel kan word (of indien nie gesteel nie, misbruik kan word om nuwe ondertekeningsleutels te genereer):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrasie van 'n toestel met SSO-tokens

Dit sou moontlik wees vir 'n aanvaller om 'n token vir die Microsoft-toestelregistrasiediens vanaf die gekompromitteerde toestel aan te vra en dit te registreer:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## Oorskryf 'n toestelkaartjie

Dit was moontlik om **'n toestelkaartjie aan te vra**, die huidige een van die toestel te **oor skryf**, en tydens die vloei **die PRT te steel** (dus geen nodig om dit van die TPM te steel nie. Vir meer inligting [**kyk hierdie aanbieding**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Dit is egter reggestel.
{% endhint %}

## Oorskryf WHFB-sleutel

[Kyk na die oorspronklike dia's hier](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Aanval opsomming:

- Dit is moontlik om die **geregistreerde WHFB** sleutel van 'n **toestel** via SSO te **oor skryf**
- Dit **verslaan TPM beskerming** aangesien die sleutel **gesniff word tydens die generering** van die nuwe sleutel
- Dit bied ook **volharding**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Gebruikers kan hul eie searchableDeviceKey eienskap wysig via die Azure AD Grafiek, maar die aanvaller moet 'n toestel in die huurder h√™ (geregistreer op die vlieg of 'n sertifikaat + sleutel gesteel van 'n regmatige toestel) en 'n geldige toegangstoken vir die AAD Grafiek h√™.

Daarna is dit moontlik om 'n nuwe sleutel te genereer met:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
en dan WYSIG die inligting van die searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Dit is moontlik om 'n toegangstoken van 'n gebruiker te kry via **toestelkoderoffeling** en die vorige stappe te misbruik om **sy toegang te steel**. Vir meer inligting, kyk:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Verwysings

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Leer AWS hak van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
