# Az - Ger√§teanmeldung

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## Grundlegende Informationen

Wenn sich ein Ger√§t bei AzureAD anmeldet, wird ein neues Objekt in AzureAD erstellt.

Bei der Registrierung eines Ger√§ts wird der **Benutzer aufgefordert, sich mit seinem Konto anzumelden** (ggf. unter Verwendung von MFA), dann werden Token f√ºr den Ger√§teregistrierungsdienst angefordert und anschlie√üend eine abschlie√üende Best√§tigungsprompt angezeigt.

Dann werden zwei RSA-Schl√ºsselpaare im Ger√§t generiert: Der **Ger√§teschl√ºssel** (**√∂ffentlicher** Schl√ºssel), der an **AzureAD** gesendet wird, und der **Transport**-Schl√ºssel (**privater** Schl√ºssel), der bei M√∂glichkeit im TPM gespeichert wird.

Dann wird das **Objekt** in **AzureAD** generiert (nicht in Intune) und AzureAD gibt dem Ger√§t ein von ihm signiertes **Zertifikat** zur√ºck. Sie k√∂nnen √ºberpr√ºfen, ob das **Ger√§t AzureAD-verbunden** ist und Informationen zum **Zertifikat** abrufen (z. B. ob es durch TPM gesch√ºtzt ist).
```bash
dsregcmd /status
```
Nach der Ger√§teanmeldung wird ein **Prim√§rer Auffrischungstoken** vom LSASS CloudAP-Modul angefordert und an das Ger√§t √ºbergeben. Mit dem PRT wird auch der **Sitzungsschl√ºssel verschl√ºsselt √ºbermittelt, sodass nur das Ger√§t ihn entschl√ºsseln kann** (unter Verwendung des √∂ffentlichen Schl√ºssels des Transportschl√ºssels) und er **zum Verwenden des PRT ben√∂tigt wird**.

F√ºr weitere Informationen dar√ºber, was ein PRT ist, siehe:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Das **TPM** **sch√ºtzt** vor dem Extrahieren von Schl√ºsseln aus einem ausgeschalteten Ger√§t (wenn es durch eine PIN gesch√ºtzt ist) und vor dem Extrahieren des privaten Materials aus der Betriebssystemebene.\
Es **sch√ºtzt jedoch nicht** vor dem **Abh√∂ren** der physischen Verbindung zwischen dem TPM und der CPU oder vor dem **Verwenden des kryptografischen Materials** im TPM, w√§hrend das System von einem Prozess mit **SYSTEM**-Rechten ausgef√ºhrt wird.

Wenn Sie die folgende Seite √ºberpr√ºfen, werden Sie feststellen, dass das **Stehlen des PRT** dazu verwendet werden kann, um wie ein **Benutzer** zuzugreifen, was gro√üartig ist, da sich der **PRT auf den Ger√§ten befindet**, sodass er von ihnen gestohlen werden kann (oder wenn er nicht gestohlen wird, missbraucht werden kann, um neue Signierschl√ºssel zu generieren):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrierung eines Ger√§ts mit SSO-Token

Es w√§re f√ºr einen Angreifer m√∂glich, von dem kompromittierten Ger√§t aus ein Token f√ºr den Microsoft-Ger√§teanmeldedienst anzufordern und es zu registrieren:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## √úberschreiben eines Ger√§tetickets

Es war m√∂glich, **ein Ger√§teticket anzufordern**, das aktuelle Ticket des Ger√§ts **zu √ºberschreiben** und w√§hrend des Ablaufs **den PRT zu stehlen** (also kein Bedarf, ihn vom TPM zu stehlen. Weitere Informationen [**hier √ºberpr√ºfen**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Dies wurde jedoch behoben.
{% endhint %}

## √úberschreiben des WHFB-Schl√ºssels

**[√úberpr√ºfen Sie die Originalfolien hier](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)**

Angriffszusammenfassung:

* Es ist m√∂glich, den **registrierten WHFB-Schl√ºssel** eines **Ger√§ts** √ºber SSO **zu √ºberschreiben**
* Es **umgeht den TPM-Schutz**, da der Schl√ºssel **beim Generieren des neuen Schl√ºssels abgefangen** wird
* Dies bietet auch **Persistenz**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Benutzer k√∂nnen ihre eigene searchableDeviceKey-Eigenschaft √ºber den Azure AD Graph √§ndern, jedoch muss der Angreifer ein Ger√§t im Mandanten haben (auf die Schnelle registriert oder Zertifikat + Schl√ºssel von einem legitimen Ger√§t gestohlen haben) und ein g√ºltiges Zugriffstoken f√ºr den AAD Graph haben.

Dann ist es m√∂glich, einen neuen Schl√ºssel zu generieren mit:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
und dann AKTUALISIEREN Sie die Informationen des searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Es ist m√∂glich, ein Zugriffstoken von einem Benutzer √ºber **Ger√§tecode-Phishing** zu erhalten und die vorherigen Schritte zu missbrauchen, um **seinen Zugriff zu stehlen**. Weitere Informationen finden Sie unter:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## Referenzen

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
