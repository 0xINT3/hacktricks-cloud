# Az - Toestelregistrasie

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

Wanneer 'n toestel by AzureAD aansluit, word 'n nuwe voorwerp in AzureAD geskep.

By die registrasie van 'n toestel, word die **gebruiker gevra om met sy rekening aan te meld** (deur MFA te vra indien nodig), dan versoek dit tokens vir die toestelregistrasiediens en vra dan 'n finale bevestigingsprompt.

Daarna word twee RSA-sleutelpare in die toestel gegenereer: Die **toestelsleutel** (**openbare** sleutel) wat na **AzureAD** gestuur word en die **vervoer**-sleutel (**privaat** sleutel) wat indien moontlik in TPM gestoor word.

Daarna word die **voorwerp** in **AzureAD** gegenereer (nie in Intune nie) en AzureAD gee 'n **sertifikaat** wat deur dit onderteken is, terug aan die toestel. Jy kan nagaan of die **toestel by AzureAD aangesluit** is en inligting oor die **sertifikaat** (soos of dit deur TPM beskerm word).
```bash
dsregcmd /status
```
Na die toestelregistrasie word 'n **Prim√™re Verfrissingsleutel** deur die LSASS CloudAP-module aangevra en aan die toestel gegee. Saam met die PRT word ook die **sessiesleutel versleutel sodat slegs die toestel dit kan ontsluit** (deur die openbare sleutel van die vervoersleutel te gebruik) en dit is **nodig om die PRT te gebruik**.

Vir meer inligting oor wat 'n PRT is, kyk:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Betroubare Platformmodule

Die **TPM** **beskerm** teen sleutel **onttrekking** van 'n afgeskakelde toestel (as dit deur 'n PIN beskerm word) en teen die ontginning van die private materiaal van die OS-laag.\
Dit **beskerm egter nie** teen die **afluistering** van die fisiese verbinding tussen die TPM en CPU of teen die **gebruik van die kriptografiese materiaal** in die TPM terwyl die stelsel van 'n proses met **SYSTEM**-regte loop nie.

As jy die volgende bladsy nagaan, sal jy sien dat **die steel van die PRT** gebruik kan word om toegang te verkry soos 'n **gebruiker**, wat fantasties is omdat die **PRT op toestelle gele√´ is**, sodat dit van hulle gesteel kan word (of as dit nie gesteel word nie, misbruik kan word om nuwe ondertekeningssleutels te genereer):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Die registrasie van 'n toestel met SSO-tokens

Dit sou moontlik wees vir 'n aanvaller om 'n token vir die Microsoft-toestelregistrasiediens vanaf die gekompromitteerde toestel aan te vra en dit te registreer:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Wat jou 'n sertifikaat sal gee wat jy in die toekoms kan gebruik om vir PRT's te vra. Dit handhaaf volharding en omseil MFA omdat die oorspronklike PRT-token wat gebruik is om die nuwe toestel te registreer, reeds MFA-toestemmings verleen het.

{% hint style="success" %}
Let daarop dat jy toestemming nodig het om nuwe toestelle te registreer om hierdie aanval uit te voer. Die registrasie van 'n toestel beteken egter nie dat die toestel toegelaat sal word om in Intune in te skryf nie.
{% endhint %}

{% hint style="danger" %}
Hierdie aanval is in September 2021 reggestel, aangesien jy nie meer nuwe toestelle kan registreer met behulp van 'n SSO-token nie. Dit is egter steeds moontlik om toestelle op 'n regmatige manier te registreer (met gebruikersnaam, wagwoord en MFA indien nodig). Kyk: [**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Oorskryf van 'n toestelkaartjie

Dit was moontlik om 'n toestelkaartjie aan te vra, die huidige een van die toestel te oorskryf, en tydens die vloei die PRT te steel (so geen behoefte om dit van die TPM te steel nie. Vir meer inligting [**kyk hierdie praatjie**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Dit is egter reggestel.
{% endhint %}

## Oorskryf WHFB-sleutel

**[Kyk die oorspronklike dia's hier](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)**

Aanval opsomming:

* Dit is moontlik om die geregistreerde WHFB-sleutel van 'n toestel te oorskryf via SSO
* Dit verslaan TPM-beskerming aangesien die sleutel gesnuffel word tydens die generering van die nuwe sleutel
* Dit bied ook volharding

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Gebruikers kan hul eie searchableDeviceKey-eienskap wysig via die Azure AD-grafiek, maar die aanvaller moet 'n toestel in die huurder h√™ (op die vlieg geregistreer of 'n sertifikaat + sleutel van 'n regmatige toestel gesteel het) en 'n geldige toegangstoken vir die AAD-grafiek h√™.

Dan is dit moontlik om 'n nuwe sleutel te genereer met:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
en dan PATCH die inligting van die searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Dit is moontlik om 'n toegangsteken van 'n gebruiker te kry deur middel van **toestelkodering-phishing** en die vorige stappe te misbruik om **sy toegang te steel**. Vir meer inligting, kyk:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## Verwysings

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
