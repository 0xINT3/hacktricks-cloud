# Az - Registracija uređaja

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Kada se uređaj pridruži AzureAD-u, novi objekat se kreira u AzureAD-u.

Prilikom registracije uređaja, **korisniku se traži da se prijavi sa svojim nalogom** (traži se MFA ako je potrebno), zatim se zahtevaju tokeni za uslugu registracije uređaja, nakon čega se postavlja konačni prozor za potvrdu.

Zatim se generišu dva RSA para ključeva na uređaju: **ključ uređaja** (**javni** ključ) koji se šalje u **AzureAD** i **transportni** ključ (**privatni** ključ) koji se čuva u TPM-u ako je moguće.

Zatim se generiše **objekat** u **AzureAD-u** (ne u Intune-u) i AzureAD vraća uređaju **sertifikat** potpisan od strane njega. Možete proveriti da li je **uređaj pridružen AzureAD-u** i informacije o **sertifikatu** (kao što je da li je zaštićen TPM-om).
```bash
dsregcmd /status
```
Nakon registracije uređaja, **Primarni osvežavajući token** se zahteva od LSASS CloudAP modula i dodeljuje uređaju. Uz PRT se takođe dostavlja **sesijski ključ enkriptovan tako da ga samo uređaj može dešifrovati** (koristeći javni ključ transportnog ključa) i **potreban je za korišćenje PRT-a.**

Za više informacija o tome šta je PRT proverite:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Modul pouzdanog platformskog modula

**TPM** **štiti** od izvlačenja ključeva sa isključenog uređaja (ako je zaštićen PIN-om) i od izvlačenja privatnog materijala sa nivoa OS-a.\
Međutim, **ne štiti** od **snifovanja** fizičke veze između TPM-a i CPU-a ili **korišćenja kriptografskog materijala** u TPM-u dok sistem radi iz procesa sa **pravima SISTEMA**.

Ako proverite sledeću stranicu, videćete da **ukradeni PRT** može biti korišćen za pristup kao **korisnik**, što je odlično jer se **PRT nalazi na uređajima**, pa može biti ukraden sa njih (ili ako nije ukraden, zloupotrebljen za generisanje novih potpisnih ključeva):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registracija uređaja sa SSO tokenima

Bilo bi moguće da napadač zatraži token za Microsoft uslugu registracije uređaja sa kompromitovanog uređaja i registruje ga:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## Prepisivanje tiketa uređaja

Bilo je moguće **zatražiti tiket uređaja**, **prepisati** trenutni tiket uređaja, i tokom toga **ukrasti PRT** (tako da nije potrebno ukrasti ga sa TPM-a. Za više informacija [**proverite ovaj govor**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Međutim, ovo je ispravljeno.
{% endhint %}

## Prepisivanje WHFB ključa

[**Proverite originalne slajdove ovde**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Sažetak napada:

* Moguće je **prepisati** **registrovani WHFB** ključ sa **uređaja** putem SSO
* Pobedjuje TPM zaštitu jer je ključ **uhvaćen tokom generisanja** novog ključa
* Ovo takođe pruža **upornost**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Korisnici mogu izmeniti svoj sopstveni searchableDeviceKey svojstvo putem Azure AD Graph-a, međutim, napadač mora imati uređaj u zakupu (registrovan na brzinu ili ukraden sertifikat + ključ sa legitimnog uređaja) i validan pristupni token za AAD Graph.

Zatim, moguće je generisati novi ključ sa:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
i zatim IZMENITE informacije o searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

Moguće je dobiti pristupni token od korisnika putem **device code phishing** i zloupotrebiti prethodne korake da **ukradete njegov pristup**. Za više informacija pogledajte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Reference

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
