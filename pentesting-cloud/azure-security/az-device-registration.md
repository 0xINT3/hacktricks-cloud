# Az - Device Registration

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

Quando un dispositivo si unisce ad AzureAD, viene creato un nuovo oggetto in AzureAD.

Durante la registrazione di un dispositivo, all'**utente viene chiesto di effettuare l'accesso con il suo account** (richiedendo l'MFA se necessario), quindi richiede i token per il servizio di registrazione del dispositivo e quindi richiede una conferma finale.

Successivamente, vengono generati due coppie di chiavi RSA nel dispositivo: la **chiave del dispositivo** (chiave **pubblica**) che viene inviata ad **AzureAD** e la **chiave di trasporto** (chiave **privata**) che viene memorizzata nel TPM se possibile.

Successivamente, viene generato l'**oggetto** in **AzureAD** (non in Intune) e AzureAD restituisce al dispositivo un **certificato** firmato da esso. √à possibile verificare che il **dispositivo sia associato ad AzureAD** e ottenere informazioni sul **certificato** (ad esempio se √® protetto da TPM).

```bash
dsregcmd /status
```

Dopo la registrazione del dispositivo, il modulo LSASS CloudAP richiede un **Primary Refresh Token (PRT)** e lo fornisce al dispositivo. Con il PRT viene anche consegnata la **chiave di sessione crittografata in modo che solo il dispositivo possa decifrarla** (utilizzando la chiave pubblica della chiave di trasporto) ed √® **necessaria per utilizzare il PRT**.

Per ulteriori informazioni su cosa sia un PRT, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Il **TPM** **protegge** contro l'estrazione delle chiavi da un dispositivo spento (se protetto da un PIN) e dall'estrazione del materiale privato dal livello del sistema operativo.\
Tuttavia, non **protegge** contro lo **sniffing** della connessione fisica tra il TPM e la CPU o l'uso del materiale crittografico nel TPM mentre il sistema √® in esecuzione da un processo con diritti di **SYSTEM**.

Se controlli la seguente pagina, vedrai che **rubare il PRT** pu√≤ essere utilizzato per accedere come un **utente**, il che √® ottimo perch√© il **PRT si trova nei dispositivi**, quindi pu√≤ essere rubato da essi (o se non rubato, pu√≤ essere abusato per generare nuove chiavi di firma):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrazione di un dispositivo con token SSO

Sarebbe possibile per un attaccante richiedere un token per il servizio di registrazione del dispositivo Microsoft dal dispositivo compromesso e registrarlo:

```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```

Ci√≤ ti fornir√† un **certificato che potrai utilizzare per richiedere PRT in futuro**. Mantenendo cos√¨ la persistenza e **eludendo l'MFA** perch√© il token PRT originale utilizzato per registrare il nuovo dispositivo **aveva gi√† ottenuto le autorizzazioni MFA**.

{% hint style="success" %}
Nota che per eseguire questo attacco avrai bisogno delle autorizzazioni per **registrare nuovi dispositivi**. Inoltre, la registrazione di un dispositivo non significa che il dispositivo sar√† **autorizzato ad iscriversi a Intune**.
{% endhint %}

{% hint style="danger" %}
Questo attacco √® stato risolto nel settembre 2021 poich√© non √® pi√π possibile registrare nuovi dispositivi utilizzando token SSO. Tuttavia, √® ancora possibile registrare dispositivi in modo legittimo (avendo nome utente, password e MFA se necessario). Controlla: [**roadtx**](https://github.com/carlospolop/hacktricks-cloud/blob/it/pentesting-cloud/azure-security/az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Sovrascrittura di un ticket del dispositivo

Era possibile **richiedere un ticket del dispositivo**, **sovrascrivere** quello attuale del dispositivo e durante il flusso **rubare il PRT** (quindi non √® necessario rubarlo dal TPM. Per ulteriori informazioni [**controlla questa presentazione**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Tuttavia, questo √® stato risolto.
{% endhint %}

## Sovrascrittura della chiave WHFB

[**Controlla le slide originali qui**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Sommario dell'attacco:

* √à possibile **sovrascrivere** la **chiave WHFB** registrata da un **dispositivo** tramite SSO
* **Sconfigge la protezione TPM** poich√© la chiave viene **intercettata durante la generazione** della nuova chiave
* Ci√≤ fornisce anche **persistenza**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Gli utenti possono modificare la propriet√† searchableDeviceKey tramite Azure AD Graph, tuttavia, l'attaccante deve avere un dispositivo nel tenant (registrato al volo o aver rubato certificato + chiave da un dispositivo legittimo) e un token di accesso valido per Azure AD Graph.

Quindi, √® possibile generare una nuova chiave con:

```bash
roadtx genhellokey -d <device id> -k tempkey.key
```

e quindi PATCHare le informazioni della searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

√à possibile ottenere un token di accesso da un utente tramite **phishing del codice del dispositivo** e sfruttare i passaggi precedenti per **rubare il suo accesso**. Per ulteriori informazioni, consulta:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## Riferimenti

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
