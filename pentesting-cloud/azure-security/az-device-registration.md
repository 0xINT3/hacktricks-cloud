# Az - デバイス登録

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で **フォロー**する。
* **ハッキングテクニックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>

## 基本情報

デバイスがAzureADに参加すると、AzureADに新しいオブジェクトが作成されます。

デバイスを登録すると、**ユーザーには自分のアカウントでログインするように求められます**（必要に応じてMFAを要求される）、その後、デバイス登録サービス用のトークンをリクエストし、最後に確認プロンプトが表示されます。

その後、デバイスで2つのRSAキーペアが生成されます：**デバイスキー**（**公開**キー）が**AzureAD**に送信され、**トランスポート**キー（**秘密**キー）が可能であればTPMに保存されます。

その後、**AzureAD**でオブジェクトが生成され（Intuneではなく）、AzureADはデバイスに自身が署名した**証明書**を返します。デバイスが**AzureADに参加**していることや、**証明書**に関する情報（TPMで保護されているかどうかなど）を確認できます。
```bash
dsregcmd /status
```
デバイス登録後、LSASS CloudAPモジュールによって**Primary Refresh Token**が要求され、デバイスに渡されます。PRTには**セッションキーが暗号化されてデバイスだけが復号化できるように**（輸送キーの公開鍵を使用）配信され、**PRTを使用するために必要**です。

PRTとは何かについての詳細は、以下をチェックしてください：

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - 信頼されたプラットフォームモジュール

**TPM**は、（PINで保護されている場合）電源が切られたデバイスから鍵の**抽出**を防ぎ、OSレイヤーからプライベート素材を抽出することを防ぎます。\
ただし、TPMとCPUの物理的な接続を**スニッフィング**したり、システムが**SYSTEM**権限を持つプロセスから実行中のシステム内のTPMの暗号素材を**使用**することには対処できません。

以下のページをチェックすると、**PRTを盗む**ことで**ユーザーのようにアクセス**できることがわかります。これは**PRTがデバイスに存在**するため、それらから盗まれる可能性がある（盗まれなかった場合でも、新しい署名キーを生成するために悪用される可能性があります）：

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## SSOトークンを使用してデバイスを登録する

攻撃者が、侵害されたデバイスからMicrosoftデバイス登録サービスのトークンをリクエストすることが可能です：
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>
```
そして、デバイスを登録できます：

<figure><img src="../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

これにより、**将来のPRTを要求するために使用できる証明書**が得られます。したがって、持続性を維持し、**MFAをバイパス**して、新しいデバイスを登録する際に使用される元のPRTトークンにはすでに**MFA権限が付与されていた**ためです。

{% hint style="success" %}
この攻撃を実行するには、**新しいデバイスを登録する権限**が必要です。また、デバイスを登録することは、デバイスが**Intuneに登録できることを意味するわけではありません**。
{% endhint %}

{% hint style="danger" %}
この攻撃は2021年9月に修正されました。SSOトークンを使用して新しいデバイスを登録することはできなくなりました。ただし、（必要に応じて）ユーザー名、パスワード、およびMFAを持っている場合には、合法的な方法でデバイスを登録することができます。確認: [**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)。
{% endhint %}

## デバイスチケットの上書き

**デバイスチケットを要求**し、デバイスの現在のチケットを**上書き**し、フロー中に**PRTを盗む**ことが可能でした（したがって、TPMから盗む必要はありません。詳細は[**このトーク**](https://youtu.be/BduCn8cLV1A)を参照）。

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
ただし、これは修正されました。
{% endhint %}

## WHFBキーの上書き

[元のスライドはこちらをご覧ください](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)

攻撃の要約：

* SSO経由で**デバイス**の**登録されたWHFBキーを上書き**することが可能です
* 新しいキーの生成中にキーが**嗅ぎ取られる**ため、これは**TPM保護を無効に**します
* これはまた**持続性**を提供します

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

ユーザーはAzure AD Graphを介して自分のsearchableDeviceKeyプロパティを変更できますが、攻撃者はテナント内にデバイスを持っている必要があります（即座に登録するか、合法的なデバイスから証明書とキーを盗んでいる必要があります）およびAAD Graphの有効なアクセストークンが必要です。

その後、次のように新しいキーを生成することが可能です：
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

そして、searchableDeviceKeyの情報をPATCHします：

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

**デバイスコードフィッシング**を使用してユーザーからアクセストークンを取得し、前述の手順を悪用して**彼のアクセスを盗む**ことが可能です。詳細については、次を確認してください：

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## 参考文献

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
