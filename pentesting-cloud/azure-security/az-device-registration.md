# Az - Registracija uređaja

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

Kada se uređaj pridruži AzureAD-u, novi objekat se kreira u AzureAD-u.

Prilikom registracije uređaja, **korisnik se traži da se prijavi sa svojim nalogom** (uz zahtev za MFA ako je potrebno), zatim se traže tokeni za servis registracije uređaja, nakon čega se traži konačna potvrda.

Zatim, dva RSA para ključeva se generišu na uređaju: **ključ uređaja** (**javni** ključ) koji se šalje **AzureAD-u** i **transportni** ključ (**privatni** ključ) koji se čuva u TPM-u ako je moguće.

Zatim, **objekat** se generiše u **AzureAD-u** (ne u Intune-u) i AzureAD vraća uređaju **sertifikat** koji je potpisan od strane njega. Možete proveriti da li je **uređaj pridružen AzureAD-u** i informacije o **sertifikatu** (kao što je da li je zaštićen TPM-om).:
```bash
dsregcmd /status
```
Nakon registracije uređaja, modul LSASS CloudAP zahteva **Primarni osvežavajući token (PRT)** i dodeljuje ga uređaju. Uz PRT se takođe dostavlja **ključ sesije koji je šifrovan tako da samo uređaj može da ga dešifruje** (koristeći javni ključ transportnog ključa) i **potreban je za korišćenje PRT-a**.

Za više informacija o tome šta je PRT, pogledajte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

**TPM** štiti od **izvlačenja ključeva** sa isključenog uređaja (ako je zaštićen PIN-om) i od izvlačenja privatnog materijala sa OS sloja.\
Međutim, **ne štiti** od **snifiranja** fizičke veze između TPM-a i CPU-a ili od **korišćenja kriptografskog materijala** u TPM-u dok sistem radi iz procesa sa **SYSTEM** privilegijama.

Ako proverite sledeću stranicu, videćete da **ukradeni PRT** može biti korišćen za pristup kao **korisnik**, što je odlično jer se **PRT nalazi na uređajima**, pa ga je moguće ukrasti (ili ako nije ukraden, zloupotrebiti za generisanje novih potpisnih ključeva):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registracija uređaja sa SSO tokenima

Napadač bi mogao da zatraži token za Microsoft-ovu uslugu registracije uređaja sa kompromitovanog uređaja i da ga registruje:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
Što će vam dati **sertifikat koji možete koristiti za traženje PRT-ova u budućnosti**. Na taj način održavate postojanost i **zaobilazite MFA** jer je originalni PRT token koji se koristio za registraciju novog uređaja **već imao dozvole za MFA**.

{% hint style="success" %}
Imajte na umu da za izvođenje ovog napada trebate dozvole za **registraciju novih uređaja**. Takođe, registracija uređaja ne znači da će uređaj biti **dopušten za upisivanje u Intune**.
{% endhint %}

{% hint style="danger" %}
Ovaj napad je popravljen u septembru 2021. godine, jer više nije moguće registrovati nove uređaje koristeći SSO tokene. Međutim, i dalje je moguće registrovati uređaje na legitimni način (imajući korisničko ime, lozinku i MFA ako je potrebno). Proverite: [**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## Prebrisavanje tiketa uređaja

Bilo je moguće **zatražiti tiket uređaja**, **prebrisati** trenutni tiket uređaja i tokom toga **ukrasti PRT** (tako da nije potrebno kradenje iz TPM-a. Za više informacija [**proverite ovaj govor**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Međutim, ovo je ispravljeno.
{% endhint %}

## Prebrisavanje WHFB ključa

**[Proverite originalne slajdove ovde](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side_nsec_v1.0.pdf)**

Sažetak napada:

* Moguće je **prebrisati** registrovani WHFB ključ sa **uređaja** putem SSO-a
* To **zaobilazi TPM zaštitu** jer se ključ **presreće tokom generisanja** novog ključa
* Ovo takođe pruža **postojanost**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Korisnici mogu izmeniti svoj svojstvo searchableDeviceKey putem Azure AD Graph-a, međutim, napadač mora imati uređaj u zakupu (registrovan na licu mesta ili ukraden sertifikat + ključ sa legitimnog uređaja) i važeći pristupni token za AAD Graph.

Zatim je moguće generisati novi ključ sa:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
a zatim PROMENITE informacije o searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Moguće je dobiti pristupni token od korisnika putem **device code phishing** i iskoristiti prethodne korake da **ukradete njegov pristup**. Za više informacija pogledajte:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## Reference

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
