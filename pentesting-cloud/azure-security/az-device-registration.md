# Az - Enregistrement d'appareil

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Lorsqu'un appareil rejoint AzureAD, un nouvel objet est cr√©√© dans AzureAD.

Lors de l'enregistrement d'un appareil, **l'utilisateur doit se connecter avec son compte** (demande de MFA si n√©cessaire), puis il demande des jetons pour le service d'enregistrement d'appareil et ensuite une derni√®re confirmation est demand√©e.

Ensuite, deux paires de cl√©s RSA sont g√©n√©r√©es sur l'appareil : La **cl√© de l'appareil** (**cl√© publique**) qui est envoy√©e √† **AzureAD** et la **cl√© de transport** (**cl√© priv√©e**) qui est stock√©e dans le TPM si possible.

Puis, **l'objet** est g√©n√©r√© dans **AzureAD** (pas dans Intune) et AzureAD renvoie √† l'appareil un **certificat** sign√© par lui. Vous pouvez v√©rifier que **l'appareil est joint √† AzureAD** et obtenir des informations sur le **certificat** (comme s'il est prot√©g√© par TPM).
```bash
dsregcmd /status
```
Apr√®s l'enregistrement de l'appareil, un **Primary Refresh Token** est demand√© par le module CloudAP de LSASS et remis √† l'appareil. Avec le PRT est √©galement livr√©e la **cl√© de session chiffr√©e pour que seul l'appareil puisse la d√©chiffrer** (en utilisant la cl√© publique de la cl√© de transport) et elle est **n√©cessaire pour utiliser le PRT.**

Pour plus d'informations sur ce qu'est un PRT, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Le **TPM** **prot√®ge** contre l'**extraction** de cl√©s d'un appareil √©teint (si prot√©g√© par un PIN) et contre l'extraction du mat√©riel priv√© depuis la couche OS.\
Cependant, il **ne prot√®ge pas** contre l'**interception** de la connexion physique entre le TPM et le CPU ou **l'utilisation du mat√©riel cryptographique** dans le TPM pendant que le syst√®me fonctionne par un processus avec des droits **SYSTEM**.

Si vous consultez la page suivante, vous verrez que **voler le PRT** peut √™tre utilis√© pour acc√©der comme l'**utilisateur**, ce qui est excellent car le **PRT est situ√© sur les appareils**, donc il peut √™tre vol√© √† partir de ceux-ci (ou si non vol√©, abus√© pour g√©n√©rer de nouvelles cl√©s de signature) :

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Enregistrer un appareil avec des tokens SSO

Il serait possible pour un attaquant de demander un token pour le service d'enregistrement d'appareils Microsoft √† partir de l'appareil compromis :
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>
```
Et ensuite, vous pouvez enregistrer l'appareil :

<figure><img src="../../.gitbook/assets/image (4) (1).png" alt=""><figcaption></figcaption></figure>

Ce qui vous donnera un **certificat que vous pourrez utiliser pour demander des PRTs √† l'avenir**. Ainsi, vous maintenez la persistance et **contournez le MFA** car le jeton PRT original utilis√© pour enregistrer le nouvel appareil **avait d√©j√† les permissions MFA accord√©es**.

{% hint style="success" %}
Notez que pour r√©aliser cette attaque, vous aurez besoin des permissions pour **enregistrer de nouveaux appareils**. De plus, enregistrer un appareil ne signifie pas que l'appareil sera **autoris√© √† s'inscrire √† Intune**.
{% endhint %}

{% hint style="danger" %}
Cette attaque a √©t√© corrig√©e en septembre 2021 car il n'est plus possible d'enregistrer de nouveaux appareils en utilisant des jetons SSO. Cependant, il est toujours possible d'enregistrer des appareils de mani√®re l√©gitime (ayant le nom d'utilisateur, le mot de passe et le MFA si n√©cessaire). V√©rifiez : [**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md).
{% endhint %}

## √âcraser un ticket d'appareil

Il √©tait possible de **demander un ticket d'appareil**, **√©craser** l'actuel de l'appareil, et pendant le flux **voler le PRT** (donc pas besoin de le voler du TPM. Pour plus d'informations, consultez cette [**pr√©sentation**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (4) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Cependant, cela a √©t√© corrig√©.
{% endhint %}

## √âcraser la cl√© WHFB

R√©sum√© de l'attaque :

* Il est possible d'**√©craser** la cl√© **WHFB enregistr√©e** d'un **appareil** via SSO
* Cela **d√©fait la protection TPM** car la cl√© est **intercept√©e pendant la g√©n√©ration** de la nouvelle cl√©
* Cela fournit √©galement une **persistance**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

Les utilisateurs peuvent modifier leur propre propri√©t√© searchableDeviceKey via Azure AD Graph, cependant, l'attaquant doit avoir un appareil dans le tenant (enregistr√© √† la vol√©e ou ayant vol√© cert + cl√© d'un appareil l√©gitime) et un jeton d'acc√®s valide pour le AAD Graph.

Ensuite, il est possible de g√©n√©rer une nouvelle cl√© avec :
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
```markdown
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

et ensuite PATCH les informations de searchableDeviceKey :

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Il est possible d'obtenir un jeton d'acc√®s d'un utilisateur via **device code phishing** et d'abuser des √©tapes pr√©c√©dentes pour **voler son acc√®s**. Pour plus d'informations, consultez :

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## R√©f√©rences

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
