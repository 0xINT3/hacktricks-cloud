# Az - Registrazione Dispositivo

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Informazioni di Base

Quando un dispositivo si unisce ad AzureAD viene creato un nuovo oggetto in AzureAD.

Durante la registrazione di un dispositivo, all'**utente viene chiesto di effettuare l'accesso con il suo account** (chiedendo l'MFA se necessario), quindi richiede i token per il servizio di registrazione del dispositivo e chiede infine una conferma finale.

Successivamente, vengono generati due coppie di chiavi RSA nel dispositivo: La **chiave del dispositivo** (chiave **pubblica**) che viene inviata ad **AzureAD** e la **chiave di trasporto** (chiave **privata**) che viene memorizzata nel TPM se possibile.

Successivamente, l'**oggetto** viene generato in **AzureAD** (non in Intune) e AzureAD restituisce al dispositivo un **certificato** firmato da esso. √à possibile verificare che il **dispositivo sia unito ad AzureAD** e informazioni sul **certificato** (come se √® protetto da TPM).
```bash
dsregcmd /status
```
Dopo la registrazione del dispositivo viene richiesto un **Primary Refresh Token** dal modulo LSASS CloudAP e consegnato al dispositivo. Con il PRT viene anche consegnata la **chiave di sessione crittografata in modo che solo il dispositivo possa decifrarla** (utilizzando la chiave pubblica della chiave di trasporto) ed √® **necessaria per utilizzare il PRT.**

Per ulteriori informazioni su cos'√® un PRT, controlla:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - Trusted Platform Module

Il **TPM** **protegge** dall'estrazione delle chiavi da un dispositivo spento (se protetto da PIN) e dall'estrazione del materiale privato dal livello del sistema operativo.\
Ma non **protegge** dall'**intercettazione** della connessione fisica tra il TPM e la CPU o dall'**utilizzo del materiale crittografico** nel TPM mentre il sistema √® in esecuzione da un processo con diritti di **SYSTEM**.

Se controlli la seguente pagina, vedrai che **rubare il PRT** pu√≤ essere utilizzato per accedere come un **utente**, il che √® ottimo perch√© il **PRT si trova nei dispositivi**, quindi pu√≤ essere rubato da loro (o se non rubato, abusato per generare nuove chiavi di firma):

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Registrazione di un dispositivo con token SSO

Sarebbe possibile per un attaccante richiedere un token per il servizio di registrazione del dispositivo Microsoft dal dispositivo compromesso e registrarla:
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>

# Custom pyhton script to register a device (check roadtx)
registerdevice.py
```
## Sovrascrittura di un ticket del dispositivo

Era possibile **richiedere un ticket del dispositivo**, **sovrascrivere** quello attuale del dispositivo e durante il flusso **rubare il PRT** (quindi non c'√® bisogno di rubarlo dal TPM. Per ulteriori informazioni [**controlla questa presentazione**](https://youtu.be/BduCn8cLV1A).

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Tuttavia, questo √® stato risolto.
{% endhint %}

## Sovrascrittura della chiave WHFB

[**Controlla le slide originali qui**](https://dirkjanm.io/assets/raw/Windows%20Hello%20from%20the%20other%20side\_nsec\_v1.0.pdf)

Sommario dell'attacco:

* √à possibile **sovrascrivere** la **chiave WHFB** registrata da un **dispositivo** tramite SSO
* Sconfigge la protezione del TPM poich√© la chiave √® **intercettata durante la generazione** della nuova chiave
* Questo fornisce anche **persistenza**

<figure><img src="../../.gitbook/assets/image (34).png" alt=""><figcaption></figcaption></figure>

Gli utenti possono modificare la propria propriet√† searchableDeviceKey tramite il Azure AD Graph, tuttavia, l'attaccante deve avere un dispositivo nel tenant (registrato al volo o aver rubato certificato + chiave da un dispositivo legittimo) e un token di accesso valido per il Azure AD Graph.

Quindi, √® possibile generare una nuova chiave con:
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
e poi EFFETTUA il patch delle informazioni del searchableDeviceKey:

<figure><img src="../../.gitbook/assets/image (36).png" alt=""><figcaption></figcaption></figure>

√à possibile ottenere un token di accesso da un utente tramite **phishing del codice dispositivo** e abusare dei passaggi precedenti per **rubare il suo accesso**. Per ulteriori informazioni controlla:

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (37).png" alt=""><figcaption></figcaption></figure>

## Riferimenti

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
