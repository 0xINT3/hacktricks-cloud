# Az - 设备注册

<details>

<summary><strong>从零到英雄学习AWS黑客攻击，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

当设备加入AzureAD时，会在AzureAD中创建一个新对象。

注册设备时，**会要求用户使用其账户登录**（如果需要，请求MFA），然后它请求设备注册服务的令牌，然后要求最终确认提示。

然后，在设备中生成两个RSA密钥对：**设备密钥**（**公钥**），发送到**AzureAD**；以及**传输密钥**（**私钥**），如果可能的话存储在TPM中。

然后，在**AzureAD**中（不在Intune中）生成**对象**，AzureAD返回给设备一个由其签名的**证书**。您可以检查**设备是否加入了AzureAD**以及有关**证书**的信息（比如它是否受TPM保护）。：
```bash
dsregcmd /status
```
设备注册后，LSASS CloudAP 模块会请求一个**Primary Refresh Token**（PRT），并将其提供给设备。PRT 也会交付一个**会话密钥加密，因此只有设备能够解密它**（使用传输密钥的公钥），并且**使用 PRT 是必需的。**

有关 PRT 是什么的更多信息，请查看：

{% content-ref url="az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md" %}
[az-primary-refresh-token-prt.md](az-lateral-movement-cloud-on-prem/az-primary-refresh-token-prt.md)
{% endcontent-ref %}

### TPM - 可信平台模块

**TPM** **保护**设备在关机状态下（如果通过 PIN 保护）不被提取密钥，以及防止从操作系统层提取私有材料。\
但它**不保护**防止**嗅探** TPM 与 CPU 之间的物理连接，或者在系统运行时，由具有**SYSTEM**权限的进程**使用 TPM 中的加密材料**。

如果您查看以下页面，您会看到**窃取 PRT**可以用来像**用户**一样访问，这很棒，因为**PRT 位于设备上**，所以可以从它们那里窃取（或者如果没有被窃取，则可以滥用以生成新的签名密钥）：

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## 使用 SSO 令牌注册设备

攻击者可能会从受损设备请求 Microsoft 设备注册服务的令牌：
```bash
# Initialize SSO flow
roadrecon auth prt-init
.\ROADtoken.exe <nonce>

# Request token with PRT with PRT cookie
roadrecon auth -r 01cb2876-7ebd-4aa4-9cc9-d28bd4d359a9 --prt-cookie <cookie>
```
然后你可以注册设备：

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

这将给你一个**证书，将来你可以用它来请求 PRTs**。因此保持持久性并**绕过 MFA**，因为用来注册新设备的原始 PRT 令牌**已经被授予了 MFA 权限**。

{% hint style="success" %}
请注意，要执行此攻击，你需要有**注册新设备**的权限。此外，注册设备并不意味着该设备将被**允许加入 Intune**。
{% endhint %}

{% hint style="danger" %}
这种攻击在 2021 年 9 月被修复，因为你不再能够使用 SSO 令牌注册新设备。然而，仍然可以以合法方式注册设备（如果需要，有用户名、密码和 MFA）。查看：[**roadtx**](az-lateral-movement-cloud-on-prem/az-roadtx-authentication.md)。
{% endhint %}

## 覆盖设备票据

曾经可以**请求设备票据**，**覆盖**设备当前的票据，并在流程中**窃取 PRT**（因此无需从 TPM 中窃取。更多信息请查看这个[**讲座**](https://youtu.be/BduCn8cLV1A)。

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
然而，这已经被修复。
{% endhint %}

## 覆盖 WHFB 密钥

攻击概要：

* 可以通过 SSO **覆盖**从**设备**注册的 **WHFB** 密钥
* 它**击败了 TPM 保护**，因为密钥是在生成新密钥时**被嗅探**的
* 这也提供了**持久性**

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

用户可以通过 Azure AD Graph 修改他们自己的 searchableDeviceKey 属性，然而，攻击者需要在租户中有一个设备（即时注册或从合法设备窃取证书 + 密钥）和一个有效的 AAD Graph 访问令牌。

然后，可以生成一个新密钥：
```bash
roadtx genhellokey -d <device id> -k tempkey.key
```
```markdown
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

然后 PATCH 可搜索设备密钥的信息：

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

可以通过 **设备代码钓鱼** 从用户那里获取访问令牌，并滥用前面的步骤来 **窃取他的访问权限**。更多信息请查看：

{% content-ref url="az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md" %}
[az-phishing-primary-refresh-token-microsoft-entra.md](az-lateral-movement-cloud-on-prem/az-phishing-primary-refresh-token-microsoft-entra.md)
{% endcontent-ref %}

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

## 参考资料

* [https://youtu.be/BduCn8cLV1A](https://youtu.be/BduCn8cLV1A)
* [https://www.youtube.com/watch?v=x609c-MUZ\_g](https://www.youtube.com/watch?v=x609c-MUZ\_g)
* [https://www.youtube.com/watch?v=AFay\_58QubY](https://www.youtube.com/watch?v=AFay\_58QubY)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方的 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来 **分享您的黑客技巧**。

</details>
```
