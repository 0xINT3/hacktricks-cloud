# Azure ペネトレーションテスト

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **ハッキングのコツを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出する。

</details>

## 私はまだAZUREメソドロジーを構築中です

## 基本情報

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Azure ペネトレーションテスター/レッドチームメソドロジー

AZURE環境を監査するためには、どの**サービスが使用されているか**、何が**公開されているか**、誰が何に**アクセス**しているか、そして内部のAzureサービスと**外部サービス**がどのように接続されているかを知ることが非常に重要です。

レッドチームの観点から見ると、**Azure環境を侵害する最初のステップ**は、Azure ADのいくつかの**資格情報**を取得することです。以下にその方法についていくつかのアイデアを示します：

* github（または類似のもの）での**リーク** - OSINT
* **ソーシャル**エンジニアリング
* **パスワード**の再利用（パスワードリーク）
* Azureホスト型アプリケーションの脆弱性
* メタデータエンドポイントへのアクセスを持つ[**サーバーサイドリクエストフォージェリ**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)
* **ローカルファイルリード**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* 2.30版以前の`az cli`の**`accessTokens.json`**ファイル - 2022年1月 - **アクセストークンを平文で保存**
* **`azureProfile.json`**ファイルにはログインユーザーに関する**情報**が含まれています。
* **`az logout`**はトークンを削除します。
* 古いバージョンの**`Az PowerShell`**は**アクセストークン**を**`TokenCache.dat`**の平文で保存していました。また、**`AzureRmContext.json`**の平文で**ServicePrincipalSecret**を保存しています。**`Save-AzContext`**コマンドレットを使用して**トークン**を**保存**できます。
`Disconnect-AzAccount`を使用してそれらを削除します。
* **第三者**の侵害
* **内部**従業員
* [**一般的なフィッシング**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（資格情報またはOauthアプリ）
* [デバイスコード認証フィッシング](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **パスワードスプレー**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

攻撃しているAzureテナント内のユーザーを**侵害していなくても**、それに関するいくつかの情報を**収集する**ことができます：

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
資格情報を取得した後、それらの資格情報が**誰に属しているか**、そして**何にアクセスできるか**を知る必要があるため、基本的な列挙を行う必要があります：
{% endhint %}

## 基本的な列挙

{% hint style="info" %}
列挙の最も**騒々しい**部分は列挙自体ではなく、**ログイン**であることを覚えておいてください。
{% endhint %}

### SSRF

Azure内のマシンでSSRFを見つけた場合は、このページのトリックをチェックしてください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### ログイン条件のバイパス

<figure><img src="../../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

有効な資格情報があるがログインできない場合、これらは存在している可能性のある一般的な保護措置です：

* **IPホワイトリスト** -- 有効なIPを侵害する必要があります
* **地理的制限** -- ユーザーが住んでいる場所や会社のオフィスがどこにあるかを見つけ、同じ市（または少なくとも国）からIPを取得します
* **ブラウザ** -- 特定のOS（Windows、Linux、Mac、Android、iOS）からのブラウザのみが許可されている可能性があります。被害者/会社が使用しているOSを見つけてください。
* サービスプリンシパルの資格情報を侵害しようとすることもできます。通常、これらは制限が少なく、ログインがあまり確認されていません

それをバイパスした後、初期設定に戻ることができ、それでもアクセスを維持できるかもしれません。

### サブドメインの乗っ取り

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

{% hint style="danger" %}
az cli、AzureAD、Az PowerShellの**インストール方法**を[**Az - AzureAD**](az-azuread/)セクションで学びます。
{% endhint %}

知る必要がある最初のことの一つは、**あなたが誰であるか**（どの環境にいるか）です：

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Azureを列挙する上で最も重要なコマンドの一つは、Az PowerShellの**`Get-AzResource`**です。これにより、現在のユーザーがどのリソースを見ることができるかを**知ることができます**。

同じ情報は、[https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll)にアクセスするか、"All resources"を検索することで**ウェブコンソール**でも取得できます。
{% endhint %}

### AzureAD 列挙

デフォルトでは、任意のユーザーは、ユーザー、グループ、ロール、サービスプリンシパルなどを列挙するための**十分な権限を持っているはずです**（[デフォルトのAzureAD権限](az-basic-information.md#default-user-permissions)を確認してください）。\
こちらにガイドがあります：

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
これで、あなたの資格情報について**いくつかの情報を持っている**（そして、もしあなたがレッドチームであれば、おそらく**検出されていない**はずです）。次に、環境で使用されているサービスが何かを把握する時が来ました。\
以下のセクションでは、いくつかの一般的なサービスを列挙する方法を確認できます。
{% endhint %}

## サービスプリンシパルとアクセスポリシー

Azureサービスは、サービス自体のシステムアイデンティティを持つか、ユーザー割り当てのマネージドアイデンティティを使用することができます。このアイデンティティは、例えばKeyVaultにアクセスポリシーを持ち、シークレットを読み取ることができます。これらのアクセスポリシーは制限されるべきです（最小権限の原則に基づいて）、しかし必要以上の権限を持っていることもあります。通常、App ServiceはKeyVaultからシークレットや証明書を取得するために使用されます。

したがって、これらのアイデンティティを探索することは有用です。

## App Service SCM

App Serviceの'コンテナ'にログインするためのKuduコンソール。

## Webshell

portal.azure.comを使用してシェルを選択するか、shell.azure.comを使用してbashまたはpowershellを使用します。このシェルの'ディスク'は、ストレージアカウント内のイメージファイルとして保存されます。

## Azure DevOps

Azure DevOpsはAzureとは別のものです。リポジトリ、パイプライン（yamlまたはリリース）、ボード、wikiなどがあります。Variable Groupsは変数値とシークレットを保存するために使用されます。

## 自動化されたReconツール

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‘Contributor’ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**、または**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
