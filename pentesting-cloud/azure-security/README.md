# Azure Pentesting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* 회사를 **HackTricks에서 광고**하거나 **PDF로 HackTricks 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter**에서 **팔로우**하세요 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 자신의 해킹 기법을 공유하세요.

</details>

## 아직 AZURE 방법론을 작성 중입니다.

## 기본 정보

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Azure Pentester/Red Team 방법론

AZURE 환경을 감사하기 위해서는 사용되는 **서비스**, **노출되는 것**, 누가 **무엇에 액세스**하는지, 그리고 내부 Azure 서비스와 **외부 서비스**가 어떻게 연결되어 있는지를 알아야 합니다.

Red Team 관점에서 Azure 환경을 침투하기 위한 **첫 번째 단계는 Azure AD의 일부 자격 증명을 획득**하는 것입니다. 다음은 그 방법에 대한 몇 가지 아이디어입니다:

* github(또는 유사한 곳)에서의 **정보 유출** - OSINT
* **사회 공학**
* **비밀번호** 재사용 (비밀번호 유출)
* Azure-호스팅 애플리케이션의 취약점
* [**서버 측 요청 위조(SSRF)**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) - 메타데이터 엔드포인트에 액세스 가능
* **로컬 파일 읽기**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* 2.30 이전의 **`az cli`**에서 **`accessTokens.json`** 파일 - 액세스 토큰을 **평문으로 저장**
* **`azureProfile.json`** 파일에는 로그인한 사용자에 대한 **정보**가 포함되어 있습니다.
* **`az logout`** 명령을 사용하여 토큰을 제거합니다.
* 이전 버전의 **`Az PowerShell`**은 **`TokenCache.dat`**에 액세스 토큰을 **평문**으로 저장했습니다. 또한 **`AzureRmContext.json`**에 **ServicePrincipalSecret**을 **평문**으로 저장합니다. **`Save-AzContext`** cmdlet을 사용하여 **토큰**을 **저장**할 수 있습니다.\
`Disconnect-AzAccount`를 사용하여 제거하세요.
* 타사 **침해**
* **내부** 직원
* [**일반적인 피싱**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (자격 증명 또는 Oauth 앱)
* [장치 코드 인증 피싱](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **비밀번호 스프레이**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Azure 테넌트 내에서 사용자를 침투하지 않았더라도 일부 정보를 수집할 수 있습니다:

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
자격 증명을 획득한 후에는 해당 자격 증명이 **누구에게 속하는지**와 **무엇에 액세스할 수 있는지** 알아야 하므로 기본적인 열거 작업을 수행해야 합니다:
{% endhint %}

## 기본 열거

{% hint style="info" %}
열거의 **가장 시끄러운** 부분은 **로그인**이며, 열거 자체는 그렇게 시끄럽지 않습니다.
{% endhint %}

### SSRF

Azure 내부의 머신에서 SSRF를 찾은 경우 다음 페이지에서 트릭을 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### 로그인 조건 우회

<figure><img src="../../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

유효한 자격 증명이 있지만 로그인할 수 없는 경우 일반적으로 적용되는 일부 보호 기능은 다음과 같습니다:

* **IP 화이트리스트** - 유효한 IP를 침투해야 합니다.
* **지리적 제한** - 사용자가 사는 곳이나 회사의 사무실이 있는 곳을 찾아 동일한 도시(또는 적어도 동일한 국가)의 IP를 얻으세요.
* **브라우저** - 특정 OS(Windows, Linux, Mac, Android, iOS)에서만 브라우저가 허용될 수 있습니다. 피해자/회사가 사용하는 OS를 확인하세요.
* 일반적으로 **Service Principal 자격 증명**을 침투하려고 시도할 수도 있습니다. 이 자격 증명은 일반적으로 제한이 덜 가해지며 로그인이 덜 검토됩니다.

우회한 후에는 초기 설정으로 돌아갈 수 있으며 여전히 액세스 권한이 유지됩니다.

### 서브도메인 탈취

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

{% hint style="danger" %}
[Az - AzureAD](az-azuread/) 섹션에서 **az cli, AzureAD 및 Az PowerShell을 설치하는 방법**을 배워보세요.
{% endhint %}

알아야 할 가장 처음의 것은 **자신이 누구인지**(어떤 환경에 있는지) 알아야 합니다:

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}AzureAD{% endtab %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %}Az PowerShell{% endtab %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Azure를 열거하기 위한 가장 중요한 명령 중 하나는 Az PowerShell의 **`Get-AzResource`**입니다. 이 명령을 사용하면 현재 사용자가 볼 수 있는 리소스를 알 수 있습니다.

웹 콘솔에서도 동일한 정보를 얻을 수 있습니다. [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll)로 이동하거나 "모든 리소스"를 검색하면 됩니다.
{% endhint %}

### AzureAD 열거

기본적으로 모든 사용자는 사용자, 그룹, 역할, 서비스 주체 등을 열거할 수 있는 충분한 권한을 갖고 있어야 합니다. ([기본 AzureAD 권한](az-basic-information.md#default-user-permissions)을 확인하세요).\
여기에서 가이드를 찾을 수 있습니다:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
이제 자격 증명에 대한 일부 정보를 알았으므로 (레드 팀인 경우 감지되지 않았으면 좋겠습니다). 환경에서 사용되는 서비스를 파악해야 합니다.\
다음 섹션에서 일부 일반적인 서비스를 열거하는 방법을 확인할 수 있습니다.
{% endhint %}

## 서비스 주체 및 액세스 정책

Azure 서비스는 시스템 ID(서비스 자체의 ID) 또는 사용자 지정 관리 ID를 사용할 수 있습니다. 이 ID는 예를 들어 KeyVault에서 비밀을 읽기 위한 액세스 정책을 가질 수 있습니다. 이러한 액세스 정책은 제한되어야 하지만 필요한 것보다 더 많은 권한을 가질 수 있습니다. 일반적으로 App Service는 비밀과 인증서를 검색하기 위해 KeyVault를 사용합니다.

따라서 이러한 ID를 탐색하는 것이 유용합니다.

## App Service SCM

App Service '컨테이너'에 로그인하기 위한 Kudu 콘솔입니다.

## 웹 쉘

portal.azure.com을 사용하여 쉘을 선택하거나 shell.azure.com을 사용하여 bash 또는 powershell을 사용할 수 있습니다. 이 쉘의 '디스크'는 스토리지 계정의 이미지 파일로 저장됩니다.

## Azure DevOps

Azure DevOps는 Azure와 별개입니다. 저장소, 파이프라인(yaml 또는 릴리스), 보드, 위키 등이 있습니다. 변수 그룹은 변수 값과 비밀을 저장하는 데 사용됩니다.

## 자동화된 Recon 도구

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)

AzureHound은 Azure AD 환경에서 사용되는 BloodHound 프로젝트의 확장입니다. Azure AD의 권한 및 관계를 분석하여 공격자가 특정 권한 상승 경로를 식별할 수 있도록 도와줍니다.

AzureHound는 Azure AD의 다양한 구성 요소를 검색하고, 사용자, 그룹, 서비스 주체, 애플리케이션 등의 관계를 시각화합니다. 이를 통해 공격자는 Azure AD 환경에서의 권한 상승 가능성을 파악하고, 취약점을 악용할 수 있는 경로를 찾을 수 있습니다.

AzureHound는 BloodHound의 데이터 수집 방법을 사용하여 Azure AD의 정보를 수집합니다. 이를 위해 Azure AD의 API를 사용하며, 이를 위한 인증 정보를 제공해야 합니다. AzureHound는 Azure AD의 정보를 수집한 후, BloodHound의 그래프 데이터베이스에 저장하여 시각화 및 분석할 수 있습니다.

AzureHound는 Azure AD 환경에서의 권한 상승 공격을 탐지하고 방지하기 위해 사용될 수 있습니다. 또한 보안 전문가와 파트너는 Azure AD 환경의 보안 강화를 위해 AzureHound를 사용할 수 있습니다.

AzureHound는 BloodHound 프로젝트의 일부로 제공되며, GitHub에서 무료로 사용할 수 있습니다. Azure AD 환경에서의 보안 강화를 위해 AzureHound를 사용해 보세요.
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‘Contributor’ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)

Azucar은 Azure 클라우드 환경에서의 보안 평가를 위한 도구입니다. 이 도구는 Azure 리소스의 구성 및 보안 설정을 분석하고 취약점을 식별하는 데 도움을 줍니다. Azucar은 Azure Resource Manager(ARM) 템플릿, Azure CLI 명령어 및 Azure Portal을 사용하여 Azure 리소스를 조작하고 분석합니다.

Azucar은 다음과 같은 기능을 제공합니다:

- Azure 리소스의 구성 및 보안 설정을 분석하여 취약점을 식별합니다.
- Azure 리소스의 액세스 제어 및 권한 부여 설정을 평가합니다.
- Azure 리소스의 네트워크 보안 구성을 분석합니다.
- Azure 리소스의 암호화 및 보안 기능을 평가합니다.
- Azure 리소스의 로깅 및 감사 설정을 분석합니다.

Azucar은 Azure 클라우드 환경에서의 보안 평가를 위한 강력한 도구로, Azure 리소스의 보안 취약점을 식별하고 보안 수준을 향상시키는 데 도움이 됩니다.
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)

MicroBurst는 Azure 환경에서의 권한 상승을 위한 도구입니다. 이 도구는 Azure AD의 악용을 통해 권한 상승을 수행할 수 있습니다. MicroBurst는 Azure AD의 특정 권한을 가진 사용자로 인증하여 Azure 리소스에 대한 액세스 권한을 획득합니다. 이를 통해 공격자는 Azure 환경에서 더 큰 권한을 얻을 수 있습니다.

MicroBurst는 다음과 같은 기능을 제공합니다:

- Azure AD의 사용자 및 그룹 정보 수집
- Azure AD의 사용자의 권한 상승을 위한 공격 경로 식별
- Azure 리소스에 대한 권한 상승을 위한 공격 경로 식별

MicroBurst는 Azure 환경에서의 권한 상승 공격을 수행하기 위한 강력한 도구입니다. 이 도구를 사용하여 Azure 환경의 보안 취약점을 식별하고 보호 수준을 향상시킬 수 있습니다.
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)

PowerZure은 Azure 클라우드 환경에서 편리한 펜테스팅 및 보안 평가를 위한 PowerShell 스크립트 모음입니다. 이 도구는 Azure 리소스를 검색하고, 권한 상승 및 권한 부여, 데이터 유출 및 악용 가능성을 확인하는 데 사용됩니다.

PowerZure은 다음과 같은 기능을 제공합니다:

- Azure 리소스 검색 및 정보 수집
- Azure 리소스에 대한 권한 상승 및 권한 부여
- Azure 리소스에서 데이터 유출 및 악용 가능성 확인
- Azure 리소스에서 사용 가능한 악성 코드 실행

PowerZure은 Azure 클라우드 환경에서 펜테스팅 및 보안 평가를 수행하는 데 유용한 도구입니다. Azure 환경에서 보안 취약점을 식별하고 해결하기 위해 PowerZure을 사용할 수 있습니다.
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
