# Pentesting de Azure

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de HackTricks AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## TODAV√çA ESTOY CONSTRUYENDO LA METODOLOG√çA DE AZURE

## Informaci√≥n B√°sica

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Metodolog√≠a de Pentester/Equipo Rojo de Azure

Para auditar un entorno de AZURE es muy importante saber: qu√© **servicios se est√°n utilizando**, qu√© est√° **expuesto**, qui√©n tiene **acceso** a qu√©, y c√≥mo est√°n conectados los servicios internos de Azure y los **servicios externos**.

Desde el punto de vista de un Equipo Rojo, el **primer paso para comprometer un entorno de Azure** es lograr obtener algunas **credenciales** para Azure AD. Aqu√≠ tienes algunas ideas sobre c√≥mo hacerlo:

* **Fugas** en github (o similar) - OSINT
* **Ingenier√≠a** Social
* Reutilizaci√≥n de **contrase√±as** (fugas de contrase√±as)
* Vulnerabilidades en Aplicaciones alojadas en Azure
* [**Falsificaci√≥n de Petici√≥n de Servidor**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) con acceso al punto de metadatos
* **Lectura de Archivos Locales**
* `/home/USUARIO/.azure`
* `C:\Users\USUARIO\.azure`
* El archivo **`accessTokens.json`** en `az cli` antes de la versi√≥n 2.30 - Ene2022 - almacenaba **tokens de acceso en texto claro**
* El archivo **`azureProfile.json`** contiene **informaci√≥n** sobre el usuario conectado.
* **`az logout`** elimina el token.
* Versiones antiguas de **`Az PowerShell`** almacenaban **tokens de acceso** en **texto claro** en **`TokenCache.dat`**. Tambi√©n almacena **ServicePrincipalSecret** en **texto claro** en **`AzureRmContext.json`**. El cmdlet **`Save-AzContext`** se puede utilizar para **almacenar** **tokens**.\
Usa `Disconnect-AzAccount` para eliminarlos.
* Terceros **comprometidos**
* Empleado **interno**
* [**Phishing Com√∫n**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciales o Aplicaci√≥n Oauth)
* [Phishing de Autenticaci√≥n de C√≥digo de Dispositivo de Azure](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [**Rociado de Contrase√±as** de Azure](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Incluso si **no has comprometido ning√∫n usuario** dentro del inquilino de Azure que est√°s atacando, puedes **recopilar informaci√≥n** de √©l:

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
Despu√©s de haber logrado obtener credenciales, necesitas saber a **qui√©n pertenecen esas credenciales**, y **a qu√© tienen acceso**, por lo que necesitas realizar una enumeraci√≥n b√°sica:
{% endhint %}

## Enumeraci√≥n B√°sica

{% hint style="info" %}
Recuerda que la parte **m√°s ruidosa** de la enumeraci√≥n es el **inicio de sesi√≥n**, no la enumeraci√≥n en s√≠.
{% endhint %}

### SSRF

Si encontraste un SSRF en una m√°quina dentro de Azure, revisa esta p√°gina para trucos:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Saltar Condiciones de Inicio de Sesi√≥n

<figure><img src="../../.gitbook/assets/image (268).png" alt=""><figcaption></figcaption></figure>

En casos donde tienes algunas credenciales v√°lidas pero no puedes iniciar sesi√≥n, estas son algunas protecciones comunes que podr√≠an estar en su lugar:

* **Lista blanca de IP** -- Necesitas comprometer una IP v√°lida
* **Restricciones geogr√°ficas** -- Encuentra d√≥nde vive el usuario o d√≥nde est√°n las oficinas de la empresa y obt√©n una IP de la misma ciudad (o al menos del mismo pa√≠s)
* **Navegador** -- Tal vez solo se permite un navegador de cierto sistema operativo (Windows, Linux, Mac, Android, iOS). Descubre qu√© sistema operativo usa la v√≠ctima/empresa.
* Tambi√©n puedes intentar **comprometer credenciales de Service Principal** ya que generalmente est√°n menos limitadas y su inicio de sesi√≥n se revisa menos

Despu√©s de saltarlo, es posible que puedas volver a tu configuraci√≥n inicial y seguir teniendo acceso.

### Toma de Subdominio

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Qui√©n soy

{% hint style="danger" %}
Aprende **c√≥mo instalar** az cli, AzureAD y Az PowerShell en la secci√≥n [**Az - AzureAD**](az-azuread/).
{% endhint %}

Una de las primeras cosas que necesitas saber es **qui√©n eres** (en qu√© entorno est√°s):

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %} 

## AzureAD

### Enumeration

1. **User Enumeration**: 
   - Utilice t√©cnicas como la enumeraci√≥n de usuarios a trav√©s de la API Graph de AzureAD.
   - Enumere usuarios a trav√©s de la interfaz de usuario de Azure Portal.

2. **Group Enumeration**:
   - Enumere grupos a trav√©s de la API Graph de AzureAD.
   - Enumere grupos a trav√©s de la interfaz de usuario de Azure Portal.

3. **Application Enumeration**:
   - Enumere aplicaciones registradas a trav√©s de la API Graph de AzureAD.
   - Enumere aplicaciones a trav√©s de la interfaz de usuario de Azure Portal.

### Exploitation

1. **Password Spraying**:
   - Realice ataques de "password spraying" contra usuarios de AzureAD.
   - Utilice herramientas como `MSOLSpray` para automatizar este proceso.

2. **Phishing**:
   - Realice ataques de phishing para obtener credenciales de usuarios de AzureAD.
   - Utilice plantillas de phishing personalizadas para aumentar la tasa de √©xito.

3. **Brute Force**:
   - Realice ataques de fuerza bruta contra la autenticaci√≥n de AzureAD.
   - Utilice herramientas como `CrackMapExec` para realizar ataques de fuerza bruta.

### Post-Exploitation

1. **Token Extraction**:
   - Extraiga tokens de acceso y tokens de actualizaci√≥n de AzureAD.
   - Utilice estos tokens para realizar acciones en nombre de los usuarios comprometidos.

2. **Privilege Escalation**:
   - Busque oportunidades de escalada de privilegios dentro de AzureAD.
   - Examine roles y permisos para identificar posibles vectores de escalada de privilegios.

3. **Data Exfiltration**:
   - Exfiltra datos confidenciales de AzureAD.
   - Utilice t√©cnicas como la exportaci√≥n de datos a trav√©s de la API Graph de AzureAD.

{% endtab %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %} 

### Ejecuci√≥n de comandos de PowerShell de Azure

Para ejecutar comandos de PowerShell de Azure, primero debe instalar el m√≥dulo Az. Puede hacerlo utilizando el siguiente comando:

```bash
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

Despu√©s de instalar el m√≥dulo Az, puede iniciar sesi√≥n en su cuenta de Azure utilizando el siguiente comando:

```bash
Connect-AzAccount
```

Una vez que haya iniciado sesi√≥n, puede comenzar a ejecutar comandos de PowerShell de Azure para administrar sus recursos en la nube. Por ejemplo, puede usar comandos como `Get-AzVM` para obtener informaci√≥n sobre las m√°quinas virtuales en su suscripci√≥n de Azure.

Recuerde que debe tener permisos adecuados en su cuenta de Azure para poder ejecutar estos comandos con √©xito. 

{% endtab %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Uno de los comandos m√°s importantes para enumerar Azure es **`Get-AzResource`** desde Az PowerShell ya que te permite **saber los recursos sobre los que tu usuario actual tiene visibilidad**.

Puedes obtener la misma informaci√≥n en la **consola web** yendo a [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) o buscando "Todos los recursos".
{% endhint %}

### Enumeraci√≥n de AzureAD

Por defecto, cualquier usuario deber√≠a tener **suficientes permisos para enumerar** cosas como usuarios, grupos, roles, identidades de servicio... (verificar [permisos predeterminados de AzureAD](az-basic-information.md#default-user-permissions)).\
Puedes encontrar aqu√≠ una gu√≠a:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
Ahora que **tienes informaci√≥n sobre tus credenciales** (y si eres un equipo rojo, esperemos que **no hayas sido detectado**), es hora de averiguar qu√© servicios se est√°n utilizando en el entorno.\
En la siguiente secci√≥n puedes ver algunas formas de **enumerar algunos servicios comunes**.
{% endhint %}

## Principal de Servicio y Pol√≠tica de Acceso

Un servicio de Azure puede tener una Identidad del Sistema (del propio servicio) o utilizar una Identidad Administrada Asignada por Usuario. Esta Identidad puede tener una Pol√≠tica de Acceso para, por ejemplo, un KeyVault para leer secretos. Estas Pol√≠ticas de Acceso deben estar restringidas (principio de privilegio m√≠nimo), pero podr√≠an tener m√°s permisos de los necesarios. Normalmente, un Servicio de Aplicaci√≥n usar√≠a KeyVault para recuperar secretos y certificados.

Por lo tanto, es √∫til explorar estas identidades.

## Consola SCM del Servicio de Aplicaci√≥n

Consola Kudu para iniciar sesi√≥n en el 'contenedor' del Servicio de Aplicaci√≥n.

## Shell Web

Usa portal.azure.com y selecciona la shell, o usa shell.azure.com, para un bash o powershell. El 'disco' de esta shell se almacena como un archivo de imagen en una cuenta de almacenamiento.

## Azure DevOps

Azure DevOps es independiente de Azure. Tiene repositorios, pipelines (yaml o release), tableros, wiki y m√°s. Los Grupos de Variables se utilizan para almacenar valores de variables y secretos.

## Herramientas de Reconocimiento Automatizado

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‚ÄòContributor‚Äô role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
