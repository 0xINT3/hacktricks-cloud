# Azure 渗透测试

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 我仍在构建 Azure 方法论

## 基本信息

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Azure 渗透测试员/红队方法论

要审计 AZURE 环境，非常重要的是要了解：正在使用哪些**服务**，**暴露**了什么，谁有**访问权限**，以及内部 Azure 服务和**外部服务**如何连接。

从红队的角度来看，**入侵 Azure 环境的第一步**是设法获取一些 Azure AD 的**凭据**。以下是一些获取凭据的方法：

* 在 github（或类似网站）中的**泄漏** - OSINT
* **社会**工程
* **密码**重用（密码泄漏）
* Azure 托管应用程序中的漏洞
* 具有访问元数据端点的[**服务器端请求伪造**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)
* **本地文件读取**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* 在 2022 年 1 月之前的 `az cli` 版本 2.30 之前的 **`accessTokens.json`** 文件以**明文**形式存储**访问令牌**
* **`azureProfile.json`** 文件包含有关已登录用户的**信息**
* **`az logout`** 会移除令牌。
* 旧版本的 **`Az PowerShell`** 以**明文**形式在 **`TokenCache.dat`** 中存储**访问令牌**。它还以**明文**形式在 **`AzureRmContext.json`** 中存储 **ServicePrincipalSecret**。Cmdlet **`Save-AzContext`** 可用于**存储** **令牌**。\
使用 `Disconnect-AzAccount` 来移除它们。
* 第三方**遭受入侵**
* **内部**员工
* [**常见钓鱼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（凭据或 Oauth 应用程序）
* [设备代码认证钓鱼](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **密码喷洒**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

即使您**尚未入侵**您正在攻击的 Azure 租户内的任何用户，您也可以从中**收集一些信息**：

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
在成功获取凭据后，您需要知道这些凭据属于**谁**，以及他们有**访问权限**，因此您需要执行一些基本枚举：
{% endhint %}

## 基本枚举

{% hint style="info" %}
请记住，枚举中最**吵闹**的部分是**登录**，而不是枚举本身。
{% endhint %}

### SSRF

如果在 Azure 中的某台机器上发现 SSRF，请查看此页面获取技巧：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### 绕过登录条件

<figure><img src="../../.gitbook/assets/image (268).png" alt=""><figcaption></figcaption></figure>

在您拥有一些有效凭据但无法登录的情况下，可能存在以下常见保护措施：

* **IP 白名单** -- 您需要入侵一个有效的 IP
* **地理限制** -- 找出用户所在地或公司办公室所在地，并获取同一城市（或至少同一国家）的 IP
* **浏览器** -- 可能只允许特定操作系统（Windows、Linux、Mac、Android、iOS）的浏览器登录。找出受害者/公司使用的操作系统。
* 您还可以尝试**入侵服务主体凭据**，因为它们通常受限较少，其登录受到较少审查

绕过后，您可能能够回到初始设置，并仍然具有访问权限。

### 子域接管

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

{% hint style="danger" %}
学习如何在 [**Az - AzureAD**](az-azuread/) 部分安装 az cli、AzureAD 和 Az PowerShell。
{% endhint %}

您需要了解的第一件事是**您是谁**（您在哪个环境中）：

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}

## AzureAD

### Enumeration

1. **User Enumeration**: Use tools like `Azure AD Connect` to synchronize on-premises directories with Azure AD. This can help identify valid usernames.

2. **Group Enumeration**: Enumerate Azure AD groups to understand the organization's structure and potential attack paths.

3. **Application Enumeration**: Identify applications registered in Azure AD to discover potential entry points.

### Exploitation

1. **Password Spraying**: Perform password spraying attacks against Azure AD accounts to avoid account lockouts.

2. **Brute Force Attacks**: Use tools like `CrackMapExec` to perform brute force attacks against Azure AD accounts.

3. **Phishing Attacks**: Leverage phishing emails to trick users into revealing their credentials, which can then be used to compromise Azure AD accounts.

### Post-Exploitation

1. **Privilege Escalation**: Exploit misconfigurations or vulnerabilities to escalate privileges within Azure AD.

2. **Persistence**: Maintain access to Azure AD by creating backdoors or using existing permissions.

3. **Data Exfiltration**: Extract sensitive data from Azure AD, such as user information or authentication tokens.

### Detection and Evasion

1. **Detecting Azure AD Attacks**: Monitor logs for suspicious activities, such as multiple failed login attempts or unusual application access.

2. **Evasion Techniques**: Use techniques like obfuscation or encryption to evade detection while compromising Azure AD.

3. **Covering Tracks**: Remove traces of unauthorized access by deleting logs or modifying audit trails.

### References

- [Azure AD Connect](https://docs.microsoft.com/en-us/azure/active-directory/hybrid/whatis-azure-ad-connect)

{% endtab %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %}

## Az PowerShell

### Introduction

Azure PowerShell is a module that provides cmdlets to manage Azure resources directly from the PowerShell command line. It allows you to automate tasks and perform various operations on Azure resources.

### Installation

To install the Azure PowerShell module, you can use the following command:

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

### Connecting to Azure

To connect to your Azure account using Azure PowerShell, you can use the following command:

```powershell
Connect-AzAccount
```

### Managing Resources

You can manage Azure resources using various cmdlets provided by the Az module. Some common operations include creating, updating, and deleting resources.

### Example

Here is an example of creating a new resource group using Azure PowerShell:

```powershell
New-AzResourceGroup -Name MyResourceGroup -Location eastus
```

### Conclusion

Azure PowerShell is a powerful tool for managing Azure resources through automation and scripting. By using Azure PowerShell, you can streamline your workflow and efficiently manage your Azure environment.

{% endtab %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
**`Get-AzResource`**是枚举 Azure 中最重要的命令之一，使用 Az PowerShell 可以让您了解当前用户可以看到的资源。

您也可以在**Web 控制台**中获取相同的信息，转到 [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) 或搜索"All resources"。
{% endhint %}

### AzureAD 枚举

默认情况下，任何用户都应该有**足够的权限来枚举**用户、组、角色、服务主体等内容（查看[默认 AzureAD 权限](az-basic-information.md#default-user-permissions)）。\
您可以在这里找到一个指南：

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
现在您**已经获取了有关您的凭据的一些信息**（如果您是红队，希望您**尚未被发现**）。现在是时候弄清楚环境中正在使用哪些服务了。\
在以下部分，您可以查看一些**枚举一些常见服务的方法**。
{% endhint %}

## 服务主体和访问策略

Azure 服务可以具有系统标识（服务本身）或使用用户分配的托管标识。此标识可以具有访问策略，例如，可以访问 KeyVault 以读取密码。这些访问策略应该受到限制（最小权限原则），但可能具有比所需权限更多的权限。通常，应用服务将使用 KeyVault 来检索密码和证书。

因此，探索这些标识是很有用的。

## 应用服务 SCM

Kudu 控制台可用于登录到应用服务的“容器”。

## Webshell

使用 portal.azure.com 并选择 shell，或使用 shell.azure.com，获取 bash 或 powershell。此 shell 的“磁盘”存储为存储帐户中的图像文件。

## Azure DevOps

Azure DevOps 与 Azure 是分开的。它具有存储库、管道（yaml 或发布）、看板、wiki 等。变量组用于存储变量值和密码。

## 自动化侦察工具

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‘Contributor’ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
