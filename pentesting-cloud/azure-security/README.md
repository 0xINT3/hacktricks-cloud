# Azure渗透测试

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 我仍在构建Azure方法论

## 基本信息

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Azure渗透测试/红队方法论

为了审计Azure环境，了解以下信息非常重要：正在使用哪些**服务**，正在**暴露**什么，谁有权访问什么，以及内部Azure服务和**外部服务**如何连接。

从红队的角度来看，**入侵Azure环境的第一步**是设法获取一些Azure AD的**凭据**。以下是一些获取凭据的方法：

* 在github（或类似网站）上的**泄露** - OSINT
* **社交**工程
* **密码**重用（密码泄露）
* Azure托管应用程序中的漏洞
* [**服务器端请求伪造（SSRF）**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)并访问元数据端点
* **本地文件读取**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* 在az cli 2.30之前的文件**`accessTokens.json`**以明文形式存储了**访问令牌**
* 文件**`azureProfile.json`**包含了有关已登录用户的**信息**
* **`az logout`**会删除令牌
* 旧版本的**`Az PowerShell`**以明文形式在**`TokenCache.dat`**中存储**访问令牌**。它还以明文形式在**`AzureRmContext.json`**中存储**ServicePrincipalSecret**。可以使用命令**`Save-AzContext`**来**存储**令牌。\
使用`Disconnect-AzAccount`来删除它们。
* 第三方**遭到入侵**
* **内部**员工
* [**常见的钓鱼**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（凭据或Oauth应用程序）
* [设备代码身份验证钓鱼](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **密码喷洒**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

即使您没有入侵Azure租户中的任何用户，您仍然可以从中**收集一些信息**：

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
在成功获取凭据后，您需要知道这些凭据属于**谁**，以及他们有权访问什么，因此您需要执行一些基本枚举操作：
{% endhint %}

## 基本枚举

{% hint style="info" %}
请记住，枚举的**最吵闹的部分**是**登录**，而不是枚举本身。
{% endhint %}

### SSRF

如果您在Azure中的某台机器上发现了SSRF漏洞，请查看此页面以获取技巧：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### 绕过登录条件

<figure><img src="../../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

在您拥有一些有效凭据但无法登录的情况下，可能存在以下常见保护措施：

* **IP白名单** -- 您需要入侵一个有效的IP
* **地理限制** -- 找出用户所在的城市或公司的办公地点，并获取相同城市（或至少相同国家）的IP
* **浏览器** -- 可能只允许特定操作系统（Windows、Linux、Mac、Android、iOS）的浏览器登录。找出受害者/公司使用的操作系统。
* 您还可以尝试**入侵服务主体凭据**，因为它们通常受限较少，其登录受到的审查较少

绕过这些保护措施后，您可能能够恢复到初始设置，并且仍然具有访问权限。

### Whoami

{% hint style="danger" %}
在[**Az - AzureAD**](az-services/az-azuread.md)部分了解**如何安装**az cli、AzureAD和Az PowerShell。
{% endhint %}

您需要了解的第一件事是**您是谁**（您在哪个环境中）：

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% tab title="AzureAD" %}AzureAD
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% tab title="Az PowerShell" %}

以下是使用 Az PowerShell 进行 Azure 安全测试的一些技巧和建议。

## 安装 Az PowerShell 模块

要使用 Az PowerShell 进行 Azure 安全测试，首先需要安装 Az PowerShell 模块。可以使用以下命令来安装：

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

## 连接到 Azure 订阅

在使用 Az PowerShell 进行 Azure 安全测试之前，需要连接到 Azure 订阅。可以使用以下命令来连接：

```powershell
Connect-AzAccount
```

## 获取 Azure 资源

使用 Az PowerShell，可以获取 Azure 订阅中的各种资源。以下是一些常用的命令示例：

- 获取所有资源组：

  ```powershell
  Get-AzResourceGroup
  ```

- 获取特定资源组中的所有资源：

  ```powershell
  Get-AzResource -ResourceGroupName <ResourceGroupName>
  ```

- 获取特定类型的资源：

  ```powershell
  Get-AzResource -ResourceType <ResourceType>
  ```

## 检查 Azure 资源的安全配置

使用 Az PowerShell，可以检查 Azure 资源的安全配置。以下是一些常用的命令示例：

- 检查存储帐户的访问权限：

  ```powershell
  Get-AzStorageAccount | Get-AzStorageAccountNetworkRuleSet
  ```

- 检查虚拟机的网络安全组规则：

  ```powershell
  Get-AzNetworkSecurityGroup | Get-AzNetworkSecurityRuleConfig
  ```

- 检查应用服务计划的 SSL 设置：

  ```powershell
  Get-AzAppServicePlan | Get-AzWebAppSSLBinding
  ```

## 检测 Azure 资源的漏洞

使用 Az PowerShell，可以检测 Azure 资源的漏洞。以下是一些常用的命令示例：

- 检测存储帐户的公共访问权限：

  ```powershell
  Get-AzStorageAccount | Where-Object { $_.IsPublicAccessAllowed -eq $true }
  ```

- 检测虚拟机的开放端口：

  ```powershell
  Get-AzNetworkSecurityGroup | Get-AzNetworkSecurityRuleConfig | Where-Object { $_.Access -eq "Allow" -and $_.Direction -eq "Inbound" -and $_.DestinationPortRange -ne "*" }
  ```

- 检测应用服务计划的弱 SSL/TLS 配置：

  ```powershell
  Get-AzAppServicePlan | Get-AzWebAppSSLBinding | Where-Object { $_.Protocol -eq "TLSv1" -or $_.Protocol -eq "SSLv3" }
  ```

## 总结

使用 Az PowerShell，可以方便地进行 Azure 安全测试。通过获取和检查 Azure 资源的安全配置，以及检测 Azure 资源的漏洞，可以帮助发现和修复潜在的安全风险。

{% endtab %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
在枚举 Azure 时，最重要的命令之一是来自 Az PowerShell 的 **`Get-AzResource`**，它可以让你**了解当前用户可见的资源**。

你可以在**Web 控制台**中获取相同的信息，访问 [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) 或搜索 "All resources"。
{% endhint %}

### AzureAD 枚举

默认情况下，任何用户都应该有**足够的权限来枚举**用户、组、角色、服务主体等内容（查看[默认 AzureAD 权限](az-basic-information.md#default-user-permissions)）。\
你可以在这里找到一个指南：

{% content-ref url="az-services/az-azuread.md" %}
[az-azuread.md](az-services/az-azuread.md)
{% endcontent-ref %}

{% hint style="info" %}
现在，你已经**获取了一些关于你的凭据的信息**（如果你是红队，希望你**没有被发现**）。现在是时候弄清楚环境中使用了哪些服务了。\
在下面的部分中，你可以查看一些**枚举一些常见服务的方法**。
{% endhint %}

## 服务主体和访问策略

Azure 服务可以有一个系统标识（服务本身）或使用用户分配的托管标识。这个标识可以有访问策略，例如，访问 KeyVault 以读取密钥。这些访问策略应该是受限制的（最小权限原则），但可能具有比所需权限更多的权限。通常，应用服务将使用 KeyVault 来检索密钥和证书。

因此，探索这些标识是很有用的。

## App Service SCM

使用 Kudu 控制台登录到 App Service 的 'container'。

## Webshell

使用 portal.azure.com 并选择 shell，或使用 shell.azure.com，用于 bash 或 powershell。这个 shell 的 'disk' 存储为存储帐户中的一个镜像文件。

## Azure DevOps

Azure DevOps 与 Azure 是分开的。它有存储库、管道（yaml 或发布）、看板、维基等等。变量组用于存储变量值和密钥。

## 自动化侦察工具

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)

AzureHound是一个用于在Azure环境中进行权限分析和攻击路径探索的工具。它是基于BloodHound项目的扩展，可以帮助渗透测试人员识别Azure AD中的权限问题和潜在的攻击路径。AzureHound使用Azure API来收集有关Azure AD、Azure资源和Azure订阅的信息，并将其导入BloodHound图数据库中进行分析。

使用AzureHound之前，您需要在Azure AD中创建一个应用程序，并为该应用程序授予必要的权限。然后，您可以使用AzureHound来收集和导入Azure AD的数据，并使用BloodHound进行权限分析和攻击路径探索。

请注意，使用AzureHound需要一定的Azure AD和BloodHound的知识。在使用之前，请确保您已经了解这些工具的基本原理和操作方法。

更多关于AzureHound的信息和使用方法，请参考[GitHub页面](https://github.com/BloodHoundAD/AzureHound)。
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‘Contributor’ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)

Azucar是一个用于Azure云环境的安全评估工具。它提供了一些有用的功能，可以帮助渗透测试人员发现和利用Azure云环境中的安全漏洞。

#### 功能

- **Azure AD**：Azucar可以帮助渗透测试人员发现Azure Active Directory（Azure AD）中的安全问题。它可以检查用户、组、应用程序和服务主体的权限配置，并查找可能存在的漏洞。

- **Azure资源**：Azucar可以扫描Azure资源，如虚拟机、存储账户和数据库，以发现可能存在的安全问题。它可以检查访问控制、网络配置和数据存储等方面的漏洞。

- **Azure函数**：Azucar可以帮助渗透测试人员评估Azure函数的安全性。它可以检查函数的权限配置、输入验证和代码执行等方面的漏洞。

- **Azure容器实例**：Azucar可以扫描Azure容器实例，以发现可能存在的安全问题。它可以检查容器实例的权限配置、网络访问和容器映像等方面的漏洞。

#### 使用方法

1. 克隆Azucar存储库：

   ```
   git clone https://github.com/nccgroup/azucar.git
   ```

2. 安装依赖项：

   ```
   pip install -r requirements.txt
   ```

3. 配置Azure凭据：

   在`azucar.py`文件中，将`AZURE_CLIENT_ID`、`AZURE_CLIENT_SECRET`和`AZURE_TENANT_ID`替换为有效的Azure凭据。

4. 运行Azucar：

   ```
   python azucar.py
   ```

   Azucar将开始扫描Azure云环境，并报告发现的安全问题。

#### 注意事项

- 在使用Azucar之前，请确保已获得合法的授权，并遵守适用的法律法规。

- Azucar仅用于合法的渗透测试和安全评估目的。请勿将其用于非法活动。

- 在使用Azucar期间，请小心操作，以免对目标环境造成不必要的损害。

- 作者和贡献者对使用Azucar造成的任何损失概不负责。使用者应自行承担使用Azucar的风险。

#### 贡献

如果您发现任何问题或有改进建议，请在Azucar存储库中提出问题或提交拉取请求。我们欢迎并感谢您的贡献！
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)

MicroBurst是一款用于在Azure云环境中进行网络流量分析的工具。它可以帮助渗透测试人员识别潜在的安全漏洞和攻击路径。该工具使用Azure Monitor API来捕获和分析网络流量，以便发现可能存在的安全问题。使用MicroBurst，您可以检测到可能的数据泄露、恶意活动和未经授权的访问。
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)

PowerZure是一个用于在Azure环境中进行渗透测试和权限提升的工具集。它基于PowerShell，并提供了一些功能强大的模块，用于发现Azure资源、执行命令、横向移动和提升权限。

#### 安装

你可以从GitHub上的PowerZure仓库下载PowerZure的最新版本。下载完成后，你可以将PowerZure解压到你的本地机器上。

#### 使用

在使用PowerZure之前，你需要先安装Azure PowerShell模块。你可以使用以下命令来安装：

```powershell
Install-Module -Name Az -AllowClobber -Force
```

安装完成后，你可以使用以下命令来导入PowerZure模块：

```powershell
Import-Module .\PowerZure.psd1
```

#### 功能

PowerZure提供了以下功能模块：

- **AzAccount**：用于管理Azure账户的模块，包括登录、注销和切换账户。
- **AzResource**：用于管理Azure资源的模块，包括列出资源、创建资源和删除资源。
- **AzCommand**：用于执行命令的模块，包括在Azure虚拟机上执行命令和在Azure函数应用上执行命令。
- **AzLateralMovement**：用于横向移动的模块，包括在Azure虚拟机之间进行端口转发和在Azure虚拟网络之间进行流量转发。
- **AzPrivilegeEscalation**：用于提升权限的模块，包括在Azure虚拟机上查找提权漏洞和利用Azure AD权限提升。

#### 示例

以下是使用PowerZure的一些示例：

- 登录到Azure账户：

```powershell
Login-AzAccount
```

- 列出所有Azure资源：

```powershell
Get-AzResource
```

- 在Azure虚拟机上执行命令：

```powershell
Invoke-AzCommand -ResourceGroupName MyResourceGroup -VMName MyVM -Command "ipconfig"
```

- 在Azure虚拟机之间进行端口转发：

```powershell
Invoke-AzLateralMovement -SourceVMName MyVM1 -DestinationVMName MyVM2 -SourcePort 8080 -DestinationPort 80
```

- 在Azure虚拟机上查找提权漏洞：

```powershell
Invoke-AzPrivilegeEscalation -VMName MyVM
```

#### 注意事项

在使用PowerZure进行渗透测试时，请确保你已经获得了合法的授权，并且遵守适用的法律法规。使用PowerZure进行未经授权的渗透测试是违法行为，可能会导致严重的法律后果。请谨慎使用PowerZure，并始终遵守法律和道德规范。
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想看到您的公司在 HackTricks 中被广告，或者如果您想访问最新版本的 PEASS 或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
