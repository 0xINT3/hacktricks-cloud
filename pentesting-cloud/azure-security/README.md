# Azure Pentesting

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## AINDA ESTOU CONSTRUINDO A METODOLOGIA AZURE

## Informa√ß√µes B√°sicas

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Metodologia de Pentester/Red Team Azure

Para auditar um ambiente AZURE √© muito importante saber: quais **servi√ßos est√£o sendo utilizados**, o que est√° **sendo exposto**, quem tem **acesso** a qu√™ e como os servi√ßos internos do Azure e **servi√ßos externos** est√£o conectados.

Do ponto de vista de um Red Team, o **primeiro passo para comprometer um ambiente Azure** √© conseguir obter algumas **credenciais** para o Azure AD. Aqui est√£o algumas ideias de como fazer isso:

* **Leaks** no github (ou similar) - OSINT
* **Engenharia** Social
* **Reutiliza√ß√£o de Senha** (vazamento de senhas)
* Vulnerabilidades em Aplica√ß√µes Hospedadas no Azure
* [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) com acesso ao endpoint de metadados
* **Leitura de Arquivo Local**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* O arquivo **`accessTokens.json`** no `az cli` antes de 2.30 - Jan2022 - armazenava **tokens de acesso em texto claro**
* O arquivo **`azureProfile.json`** cont√©m **informa√ß√µes** sobre o usu√°rio logado.
* **`az logout`** remove o token.
* Vers√µes antigas do **`Az PowerShell`** armazenavam **tokens de acesso** em **texto claro** em **`TokenCache.dat`**. Ele tamb√©m armazena **ServicePrincipalSecret** em **texto claro** em **`AzureRmContext.json`**. O cmdlet **`Save-AzContext`** pode ser usado para **armazenar** **tokens**.\
Use `Disconnect-AzAccount` para remov√™-los.
* Terceiros **violados**
* **Funcion√°rio** Interno
* [**Phishing Comum**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (credenciais ou App Oauth)
* [Phishing de Autentica√ß√£o de C√≥digo de Dispositivo](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [**Password Spraying** no Azure](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Mesmo que voc√™ **n√£o tenha comprometido nenhum usu√°rio** dentro do tenant do Azure que est√° atacando, voc√™ pode **coletar algumas informa√ß√µes** dele:

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
Ap√≥s conseguir obter credenciais, voc√™ precisa saber **a quem essas credenciais pertencem** e **a que elas t√™m acesso**, ent√£o voc√™ precisa realizar uma enumera√ß√£o b√°sica:
{% endhint %}

## Enumera√ß√£o B√°sica

{% hint style="info" %}
Lembre-se de que a parte **mais barulhenta** da enumera√ß√£o √© o **login**, n√£o a enumera√ß√£o em si.
{% endhint %}

### SSRF

Se voc√™ encontrou um SSRF em uma m√°quina dentro do Azure, confira esta p√°gina para dicas:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Bypass de Condi√ß√µes de Login

<figure><img src="../../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

Em casos em que voc√™ tem credenciais v√°lidas, mas n√£o consegue fazer login, estas s√£o algumas prote√ß√µes comuns que podem estar em vigor:

* **Whitelisting de IP** -- Voc√™ precisa comprometer um IP v√°lido
* **Restri√ß√µes geogr√°ficas** -- Descubra onde o usu√°rio mora ou onde est√£o os escrit√≥rios da empresa e obtenha um IP da mesma cidade (ou pelo menos do mesmo pa√≠s)
* **Navegador** -- Talvez apenas um navegador de certo SO (Windows, Linux, Mac, Android, iOS) seja permitido. Descubra qual SO a v√≠tima/empresa usa.
* Voc√™ tamb√©m pode tentar **comprometer credenciais de Service Principal**, pois geralmente s√£o menos limitadas e seu login √© menos revisado

Ap√≥s contorn√°-las, voc√™ pode ser capaz de voltar √† sua configura√ß√£o inicial e ainda ter acesso.

### Subdomain Takeover

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Whoami

{% hint style="danger" %}
Aprenda **como instalar** az cli, AzureAD e Az PowerShell na se√ß√£o [**Az - AzureAD**](az-azuread/).
{% endhint %}

Uma das primeiras coisas que voc√™ precisa saber √© **quem voc√™ √©** (em que ambiente voc√™ est√°):

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
```markdown
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Um dos comandos mais importantes para enumerar o Azure √© **`Get-AzResource`** do Az PowerShell, pois permite **saber os recursos que o seu usu√°rio atual pode visualizar**.

Voc√™ pode obter a mesma informa√ß√£o na **console web** acessando [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) ou procurando por "Todos os recursos".
{% endhint %}

### Enumera√ß√£o do AzureAD

Por padr√£o, qualquer usu√°rio deve ter **permiss√µes suficientes para enumerar** itens como usu√°rios, grupos, fun√ß√µes, principais de servi√ßo... (verifique [permiss√µes padr√£o do AzureAD](az-basic-information.md#default-user-permissions)).
Aqui voc√™ encontra um guia:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
Agora que voc√™ **tem algumas informa√ß√µes sobre suas credenciais** (e se voc√™ faz parte de uma equipe de ataque, esperan√ßosamente **n√£o foi detectado**). √â hora de descobrir quais servi√ßos est√£o sendo usados no ambiente.
Na se√ß√£o seguinte, voc√™ pode verificar algumas maneiras de **enumerar alguns servi√ßos comuns.**
{% endhint %}

## Principal de Servi√ßo e Pol√≠tica de Acesso

Um servi√ßo Azure pode ter uma Identidade de Sistema (do pr√≥prio servi√ßo) ou usar uma Identidade Gerenciada Atribu√≠da pelo Usu√°rio. Esta Identidade pode ter Pol√≠tica de Acesso para, por exemplo, um KeyVault para ler segredos. Essas Pol√≠ticas de Acesso devem ser restritas (princ√≠pio do menor privil√©gio), mas podem ter mais permiss√µes do que o necess√°rio. Tipicamente, um App Service usaria o KeyVault para recuperar segredos e certificados.

Portanto, √© √∫til explorar essas identidades.

## SCM do App Service

Console Kudu para acessar o 'container' do App Service.

## Webshell

Use portal.azure.com e selecione o shell, ou use shell.azure.com, para um bash ou powershell. O 'disco' deste shell √© armazenado como um arquivo de imagem em uma conta de armazenamento.

## Azure DevOps

O Azure DevOps √© separado do Azure. Ele possui reposit√≥rios, pipelines (yaml ou release), quadros, wiki e mais. Grupos de Vari√°veis s√£o usados para armazenar valores de vari√°veis e segredos.

## Ferramentas Automatizadas de Reconhecimento

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‚ÄòContributor‚Äô role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
