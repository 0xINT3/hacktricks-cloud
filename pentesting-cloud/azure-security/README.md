# Azure Pentesting

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**でフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## Azureペンテスト

## 基本情報

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## Azureペンテスター/レッドチームの方法論

Azure環境を監査するためには、使用されている**サービス**、**公開**されているもの、誰が何に**アクセス**できるか、および内部のAzureサービスと**外部サービス**の接続方法を知ることが非常に重要です。

レッドチームの観点からは、Azure環境を侵害するための**最初のステップ**は、Azure ADの一部の**資格情報**を取得することです。以下に、それを行うためのいくつかのアイデアを示します。

* GitHub（または類似のサイト）での**情報漏洩** - OSINT
* **ソーシャル**エンジニアリング
* **パスワード**の再利用（パスワードの漏洩）
* Azureホストされたアプリケーションの脆弱性
* [**サーバーサイドリクエストフォージェリ**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)（メタデータエンドポイントへのアクセス）
* **ローカルファイルの読み取り**
* `/home/USERNAME/.azure`
* `C:\Users\USERNAME\.azure`
* **`az cli`の2.30以前のバージョン** - Jan2022 - では、**アクセストークンが平文で保存**されていました
* **`azureProfile.json`**ファイルには、ログインユーザーに関する**情報**が含まれています。
* **`az logout`**コマンドを使用すると、トークンが削除されます。
* **古いバージョンの`Az PowerShell`**では、**アクセストークン**が**平文**で**`TokenCache.dat`**に保存されていました。また、**`AzureRmContext.json`**には**ServicePrincipalSecret**が**平文**で保存されています。**`Save-AzContext`**コマンドレットを使用して**トークン**を**保存**できます。\
**Disconnect-AzAccount**を使用してトークンを削除します。
* **第三者による侵害**
* **内部の従業員**
* [**一般的なフィッシング**](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology)（資格情報またはOAuthアプリ）
* [デバイスコード認証フィッシング](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
* [Azure **パスワードスプレー**](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

Azureテナント内のユーザーを**侵害していない場合**でも、いくつかの情報を収集することができます。

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
資格情報を取得できたら、それらの資格情報が**誰に属しているか**と、それらが**何にアクセスできるか**を知る必要があります。そのため、基本的な列挙を実行する必要があります。
{% endhint %}

## 基本的な列挙

{% hint style="info" %}
列挙の中で最も**ノイズの多い**部分は**ログイン**であり、列挙そのものではありません。
{% endhint %}

### SSRF

Azure内のマシンでSSRFを見つけた場合は、以下のページを参照してトリックを確認してください。

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### ログイン条件のバイパス

<figure><img src="../../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

有効な資格情報があるがログインできない場合、次のような一般的な保護が設けられている可能性があります。

* **IPホワイトリスト** - 有効なIPを侵害する必要があります
* **地理的制限** - ユーザーが住んでいる場所や会社のオフィスがどこにあるかを見つけ、同じ都市（または少なくとも同じ国）のIPを取得します
* **ブラウザ** - 特定のOS（Windows、Linux、Mac、Android、iOS）のブラウザのみが許可されている場合があります。被害者/会社が使用しているOSを特定してください。
* また、通常は制限が少なく、ログインが少なく確認されるため、**Service Principalの資格情報を侵害**することも試してみることができます

バイパスした後、元のセットアップに戻ることができ、引き続きアクセスできる場合があります。

### Whoami

{% hint style="danger" %}
[**Az - AzureAD**](az-services/az-azuread.md)セクションでaz cli、AzureAD、Az PowerShellの**インストール方法**を学んでください。
{% endhint %}

最初に知る必要があることの1つは、**自分が誰であるか**（どの環境にいるか）です。

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}AzureAD{% endtab %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %}Az PowerShell{% endtab %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Azureを列挙するための最も重要なコマンドの1つは、Az PowerShellの**`Get-AzResource`**です。これにより、**現在のユーザーが表示できるリソースを知ることができます**。

同じ情報を**Webコンソール**で取得するには、[https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll)にアクセスするか、「すべてのリソース」を検索します。
{% endhint %}

### AzureADの列挙

デフォルトでは、ユーザーはユーザー、グループ、ロール、サービスプリンシパルなどを列挙するための**十分な権限を持っています**（[デフォルトのAzureADの権限](az-basic-information.md#default-user-permissions)を確認してください）。
ここでは、ガイドを見つけることができます：

{% content-ref url="az-services/az-azuread.md" %}
[az-azuread.md](az-services/az-azuread.md)
{% endcontent-ref %}

{% hint style="info" %}
今、あなたは自分の資格情報について**いくつかの情報を持っている**（もし赤チームの場合、**検出されていない**ことを願っています）。次に、環境で使用されているサービスを特定するための方法を確認しましょう。\
次のセクションでは、いくつかの一般的なサービスを列挙する方法を確認できます。
{% endhint %}

## サービスプリンシパルとアクセスポリシー

Azureのサービスは、システムアイデンティティ（サービス自体のアイデンティティ）またはユーザー割り当ての管理アイデンティティを持つことができます。このアイデンティティは、たとえばKeyVaultのシークレットを読み取るためのアクセスポリシーを持つことができます。これらのアクセスポリシーは制限されるべきです（最小特権の原則）、しかし必要な以上の権限を持つ場合もあります。通常、App Serviceはシークレットと証明書を取得するためにKeyVaultを使用します。

そのため、これらのアイデンティティを調査することは有用です。

## App Service SCM

App Service 'container'にログインするためのKuduコンソール。

## Webshell

portal.azure.comを使用してシェルを選択するか、shell.azure.comを使用してbashまたはpowershellを使用します。このシェルの「ディスク」は、ストレージアカウント内のイメージファイルとして保存されます。

## Azure DevOps

Azure DevOpsはAzureとは別のものです。リポジトリ、パイプライン（yamlまたはリリース）、ボード、ウィキなどがあります。変数グループは、変数の値とシークレットを格納するために使用されます。

## Automated Recon Tools

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)

AzureHoundは、Azure環境での特権エスカレーションのためのツールです。これは、Azure ADの情報を収集し、BloodHoundにインポートするためのデータを生成します。

AzureHoundは、次の手順に従って使用できます。

1. Azure ADの情報を収集するために、Azure ADのアプリケーションを作成します。
2. 収集した情報を使用して、AzureHoundを実行します。
3. 生成されたデータをBloodHoundにインポートします。

AzureHoundは、Azure ADの情報を収集するために、Azure AD Graph APIとMicrosoft Graph APIを使用します。これにより、ユーザー、グループ、ロール、サービスプリンシパルなどの情報を取得できます。

AzureHoundは、Azure ADの情報を収集するために、次の情報を必要とします。

- Azure ADのテナントID
- Azure ADのクライアントID
- Azure ADのクライアントシークレット

AzureHoundは、Azure ADの情報を収集するために、次の手順を実行します。

1. Azure ADのテナントID、クライアントID、クライアントシークレットを使用して、Azure ADに対して認証します。
2. Azure AD Graph APIを使用して、ユーザー、グループ、ロール、サービスプリンシパルなどの情報を収集します。
3. 収集した情報をBloodHoundにインポートするためのデータ形式に変換します。

AzureHoundは、Azure ADの情報を収集するための便利なツールです。これを使用することで、Azure環境での特権エスカレーションの可能性を特定することができます。
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‘Contributor’ role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)

Azucarは、Azureクラウド環境におけるセキュリティ評価とペネトレーションテストを支援するためのツールです。このツールは、Azureのセキュリティ設定の不備や脆弱性を特定し、潜在的な攻撃経路を特定するために使用されます。

Azucarは、Azureの各コンポーネント（仮想マシン、ストレージアカウント、ネットワークセキュリティグループなど）に対して自動化されたテストを実行します。これにより、セキュリティの脆弱性や設定ミスを特定し、適切な対策を講じることができます。

Azucarは、Azureのセキュリティ評価において非常に役立つツールであり、ペネトレーションテストの効率を向上させることができます。セキュリティの専門知識がなくても使用することができるため、初心者から上級者まで幅広いユーザーに適しています。

Azucarは、Azureのセキュリティ設定の改善に役立つ情報を提供し、セキュリティの脆弱性を特定するための手がかりを提供します。また、Azucarは、Azureのセキュリティ設定のベストプラクティスに準拠しているかどうかを確認するためのガイドラインも提供します。

Azucarは、Azureクラウド環境のセキュリティ評価とペネトレーションテストを行う際に、貴重なツールとなるでしょう。
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)

MicroBurst is a tool developed by NetSPI for performing reconnaissance and enumeration of Azure cloud environments. It leverages the Azure Resource Manager (ARM) API to gather information about Azure subscriptions, resource groups, virtual networks, storage accounts, and more.

MicroBurst can be used to identify misconfigurations and security vulnerabilities in Azure deployments. It can also help in the discovery of sensitive information, such as storage account keys and connection strings, which could potentially lead to data breaches.

The tool is designed to be used by penetration testers and security professionals to assess the security posture of Azure environments. It provides a command-line interface (CLI) for easy integration into existing workflows and automation scripts.

MicroBurst is an open-source tool and is available on GitHub for free. It is written in Python and requires the installation of the Azure CLI and Python dependencies to run.

To use MicroBurst, you will need valid Azure credentials with appropriate permissions to access the target Azure environment. Once authenticated, the tool will gather information about the Azure resources and present it in a structured format for analysis.

MicroBurst is a powerful tool for assessing the security of Azure cloud environments and can help in identifying potential vulnerabilities and misconfigurations. It is recommended to use this tool responsibly and with proper authorization to avoid any legal or ethical issues.
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)

PowerZureは、Azureクラウド環境でのペネトレーションテストとセキュリティオーディットをサポートするためのPowerShellスクリプトです。

PowerZureは、Azureのリソースとセキュリティ設定に関する情報を収集し、脆弱性を特定するための機能を提供します。また、Azure環境での権限昇格やデータの漏洩などの攻撃手法を実行するためのツールも提供しています。

PowerZureを使用することで、Azureクラウド環境のセキュリティを評価し、脆弱性を特定することができます。また、PowerZureは、Azureのセキュリティ設定を改善するための推奨事項も提供します。

PowerZureは、Azureのセキュリティに関する知識があることが前提となります。また、PowerZureを使用する際には、適切な権限を持つアカウントを使用することが重要です。

PowerZureは、Azureクラウド環境でのペネトレーションテストとセキュリティオーディットを効果的に実施するための強力なツールです。
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>Support HackTricksと特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
