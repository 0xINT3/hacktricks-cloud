# Pentesting Azure

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

- Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
- D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
- **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
- **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## JE SUIS TOUJOURS EN TRAIN DE CONSTRUIRE LA M√âTHODOLOGIE AZURE

## Informations de base

{% content-ref url="az-basic-information.md" %}
[az-basic-information.md](az-basic-information.md)
{% endcontent-ref %}

## M√©thodologie de testeur/Auditeur Azure Red Team

Pour auditer un environnement AZURE, il est tr√®s important de savoir : quels **services sont utilis√©s**, ce qui est **expos√©**, qui a **acc√®s** √† quoi, et comment les services Azure internes et **services externes** sont connect√©s.

Du point de vue de l'√©quipe rouge, le **premier pas pour compromettre un environnement Azure** est de parvenir √† obtenir des **informations d'identification** pour Azure AD. Voici quelques id√©es sur la fa√ßon de le faire :

- **Fuites** sur github (ou similaire) - OSINT
- **Ing√©nierie** sociale
- R√©utilisation de **mot de passe** (fuites de mots de passe)
- Vuln√©rabilit√©s dans les applications h√©berg√©es sur Azure
- [**Falsification de requ√™te c√¥t√© serveur**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) avec acc√®s √† l'endpoint de m√©tadonn√©es
- **Lecture de fichiers locaux**
- `/home/USERNAME/.azure`
- `C:\Users\USERNAME\.azure`
- Le fichier **`accessTokens.json`** dans `az cli` avant 2.30 - Jan2022 - stockait les **jetons d'acc√®s en clair**
- Le fichier **`azureProfile.json`** contient des **informations** sur l'utilisateur connect√©.
- **`az logout`** supprime le jeton.
- Les anciennes versions de **`Az PowerShell`** stockaient les **jetons d'acc√®s** en **clair** dans **`TokenCache.dat`**. Il stocke √©galement le **ServicePrincipalSecret** en **clair** dans **`AzureRmContext.json`**. La commande **`Save-AzContext`** peut √™tre utilis√©e pour **stocker** les **jetons**.\
Utilisez `Disconnect-AzAccount` pour les supprimer.
- Des **tiers ont √©t√© compromis**
- Employ√© **interne**
- [**Phishing** commun](https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology) (informations d'identification ou application Oauth)
- [Phishing d'authentification par code de p√©riph√©rique](az-unauthenticated-enum-and-initial-entry/az-device-code-authentication-phishing.md)
- [**Password Spraying** Azure](az-unauthenticated-enum-and-initial-entry/az-password-spraying.md)

M√™me si vous n'avez **pas compromis d'utilisateur** √† l'int√©rieur du locataire Azure que vous attaquez, vous pouvez **recueillir des informations** √† partir de celui-ci :

{% content-ref url="az-unauthenticated-enum-and-initial-entry/" %}
[az-unauthenticated-enum-and-initial-entry](az-unauthenticated-enum-and-initial-entry/)
{% endcontent-ref %}

{% hint style="info" %}
Apr√®s avoir r√©ussi √† obtenir des informations d'identification, vous devez savoir √† **qui appartiennent ces informations d'identification**, et **√† quoi elles ont acc√®s**, vous devez donc effectuer une certaine √©num√©ration de base :
{% endhint %}

## √ânum√©ration de base

{% hint style="info" %}
Rappelez-vous que la partie la plus **bruyante** de l'√©num√©ration est la **connexion**, pas l'√©num√©ration elle-m√™me.
{% endhint %}

### SSRF

Si vous trouvez un SSRF sur une machine √† l'int√©rieur d'Azure, consultez cette page pour des astuces :

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Contournement des conditions de connexion

<figure><img src="../../.gitbook/assets/image (268).png" alt=""><figcaption></figcaption></figure>

Dans les cas o√π vous avez des informations d'identification valides mais que vous ne pouvez pas vous connecter, voici quelques protections courantes qui pourraient √™tre en place :

- **Liste blanche IP** -- Vous devez compromettre une IP valide
- **Restrictions g√©ographiques** -- Trouvez o√π l'utilisateur vit ou o√π se trouvent les bureaux de l'entreprise et obtenez une IP de la m√™me ville (ou du m√™me pays au moins)
- **Navigateur** -- Peut-√™tre qu'un navigateur sp√©cifique √† certains OS (Windows, Linux, Mac, Android, iOS) est autoris√©. D√©couvrez quels OS la victime/l'entreprise utilise.
- Vous pouvez √©galement essayer de **compromettre les informations d'identification du Service Principal** car elles sont g√©n√©ralement moins limit√©es et leur connexion est moins examin√©e

Apr√®s l'avoir contourn√©, vous pourriez √™tre en mesure de revenir √† votre configuration initiale et conserver l'acc√®s.

### Prise de contr√¥le de sous-domaine

* [https://godiego.co/posts/STO-Azure/](https://godiego.co/posts/STO-Azure/)

### Qui suis-je

{% hint style="danger" %}
Apprenez **comment installer** az cli, AzureAD et Az PowerShell dans la section [**Az - AzureAD**](az-azuread/).
{% endhint %}

Une des premi√®res choses que vous devez savoir est **qui vous √™tes** (dans quel environnement vous √™tes) :

{% tabs %}
{% tab title="az cli" %}
```bash
az account list
az account tenant list # Current tenant info
az account subscription list # Current subscription info
az ad signed-in-user show # Current signed-in user
az ad signed-in-user list-owned-objects # Get owned objects by current user
az account management-group list #Not allowed by default
```
{% endtab %}

{% tab title="AzureAD" %}

### AzureAD Enumeration

#### User Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`, `ADRecon`, or `BloodHound` to gather information about users in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

#### Group Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`, `ADRecon`, or `BloodHjson` to gather information about groups in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

#### Device Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`,json `ADRecon`, or `BloodHound` to gather information about devices in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

#### Application Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`, `ADRecon`, or `BloodHound` to gather information about applications registered in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

#### Service Principal Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`, `ADRejsoncon`, or `BloodHound` to gather information about service principals in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

#### Privileged Role Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`, `ADRecon`,json or `BloodHound` to gather information about privileged roles in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

#### Domain Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`, `ADRecon`, or `BloodHound` to gather information about the domain in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

#### Policy Enumeration

1. **Manual Enumeration**: Use tools like `ldapsearch`, `ADRecon`, or `BloodHound` to gather information about policies in the Azure AD.

2. **Automated Enumeration**: Utilize tools like `Azure AD Recon` or `Azure AD Connect` to automate the enumeration process.

{% endtab %}
```powershell
#Get the current session state
Get-AzureADCurrentSessionInfo
#Get details of the current tenant
Get-AzureADTenantDetail
```
{% endtab %}

{% tab title="Az PowerShell" %} 

### Azure PowerShell

Azure PowerShell est un module PowerShell qui fournit des commandes pour g√©rer les ressources Azure directement √† partir de la ligne de commande PowerShell. Il permet d'automatiser des t√¢ches courantes et de cr√©er des scripts pour g√©rer les ressources Azure. 

Pour commencer √† utiliser Azure PowerShell, vous devez installer le module Azure PowerShell sur votre machine locale. Vous pouvez le faire en ex√©cutant la commande suivante dans PowerShell :

```powershell
Install-Module -Name Az -AllowClobber -Scope CurrentUser
```

Une fois le module install√©, vous pouvez vous connecter √† votre compte Azure √† l'aide de la commande `Connect-AzAccount` et commencer √† utiliser les commandes Azure PowerShell pour g√©rer vos ressources Azure.

Pour plus d'informations sur l'utilisation d'Azure PowerShell, vous pouvez consulter la documentation officielle d'Azure PowerShell sur [le site de Microsoft](https://docs.microsoft.com/en-us/powershell/azure/overview). 

{% endtab %}
```powershell
# Get the information about the current context (Account, Tenant, Subscription etc.)
Get-AzContext
# List all available contexts
Get-AzContext -ListAvailable
# Enumerate subscriptions accessible by the current user
Get-AzSubscription
#Get Resource group
Get-AzResourceGroup
# Enumerate all resources visible to the current user
Get-AzResource
# Enumerate all Azure RBAC role assignments
Get-AzRoleAssignment # For all users
Get-AzRoleAssignment -SignInName test@corp.onmicrosoft.com # For current user
```
{% endtab %}
{% endtabs %}

{% hint style="danger" %}
Un des commandes les plus importantes pour √©num√©rer Azure est **`Get-AzResource`** de Az PowerShell car elle vous permet de **savoir les ressources sur lesquelles votre utilisateur actuel a une visibilit√©**.

Vous pouvez obtenir les m√™mes informations dans la **console web** en allant sur [https://portal.azure.com/#view/HubsExtension/BrowseAll](https://portal.azure.com/#view/HubsExtension/BrowseAll) ou en recherchant "Toutes les ressources"
{% endhint %}

### √ânum√©ration AzureAD

Par d√©faut, tout utilisateur devrait avoir **suffisamment de permissions pour √©num√©rer** des √©l√©ments tels que les utilisateurs, les groupes, les r√¥les, les principaux de service... (v√©rifiez les [permissions AzureAD par d√©faut](az-basic-information.md#default-user-permissions)).\
Vous pouvez trouver ici un guide :

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

{% hint style="info" %}
Maintenant que vous **avez des informations sur vos identifiants** (et si vous √™tes une √©quipe rouge, esp√©rons que vous **n'avez pas √©t√© d√©tect√©**). Il est temps de d√©couvrir quels services sont utilis√©s dans l'environnement.\
Dans la section suivante, vous pouvez v√©rifier quelques fa√ßons d'**√©num√©rer certains services courants**.
{% endhint %}

## Principal de service et politique d'acc√®s

Un service Azure peut avoir une Identit√© Syst√®me (du service lui-m√™me) ou utiliser une Identit√© G√©r√©e attribu√©e √† l'utilisateur. Cette Identit√© peut avoir une Politique d'Acc√®s pour, par exemple, un KeyVault pour lire des secrets. Ces Politiques d'Acc√®s devraient √™tre restreintes (principe du moindre privil√®ge), mais pourraient avoir plus de permissions que n√©cessaire. Typiquement, un service d'application utiliserait KeyVault pour r√©cup√©rer des secrets et des certificats.

Il est donc utile d'explorer ces identit√©s.

## Console SCM du service d'application

Console Kudu pour se connecter au 'conteneur' du service d'application.

## Shell Web

Utilisez portal.azure.com et s√©lectionnez le shell, ou utilisez shell.azure.com, pour un bash ou powershell. Le 'disque' de ce shell est stock√© sous forme de fichier image dans un compte de stockage.

## Azure DevOps

Azure DevOps est s√©par√© d'Azure. Il poss√®de des d√©p√¥ts, des pipelines (yaml ou release), des tableaux, un wiki, et plus encore. Les Groupes de Variables sont utilis√©s pour stocker des valeurs de variables et des secrets.

## Outils de Reconnaissance Automatis√©e

### [**ROADRecon**](https://github.com/dirkjanm/ROADtools)
```powershell
cd ROADTools
pipenv shell
roadrecon auth -u test@corp.onmicrosoft.com -p "Welcome2022!"
roadrecon gather
roadrecon gui
```
### [Monkey365](https://github.com/silverhack/monkey365)

{% code overflow="wrap" %}
```powershell
Import-Module monkey365
Get-Help Invoke-Monkey365
Get-Help Invoke-Monkey365 -Detailed
Invoke-Monkey365 -IncludeAzureActiveDirectory -ExportTo HTML -Verbose -Debug -InformationAction Continue
Invoke-Monkey365 - Instance Azure -Analysis All -ExportTo HTML
```
{% endcode %}

### [**Stormspotter**](https://github.com/Azure/Stormspotter)
```powershell
# Start Backend
cd stormspotter\backend\
pipenv shell
python ssbackend.pyz

# Start Front-end
cd stormspotter\frontend\dist\spa\
quasar.cmd serve -p 9091 --history

# Run Stormcollector
cd stormspotter\stormcollector\
pipenv shell
az login -u test@corp.onmicrosoft.com -p Welcome2022!
python stormspotter\stormcollector\sscollector.pyz cli
# This will generate a .zip file to upload in the frontend (127.0.0.1:9091)
```
### [**AzureHound**](https://github.com/BloodHoundAD/AzureHound)
```powershell
# You need to use the Az PowerShell and Azure AD modules:
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential ("test@corp.onmicrosoft.com", $passwd)
Connect-AzAccount -Credential $creds

Import-Module AzureAD\AzureAD.psd1
Connect-AzureAD -Credential $creds

# Launch AzureHound
. AzureHound\AzureHound.ps1
Invoke-AzureHound -Verbose

# Simple queries
## All Azure Users
MATCH (n:AZUser) return n.name
## All Azure Applications
MATCH (n:AZApp) return n.objectid
## All Azure Devices
MATCH (n:AZDevice) return n.name
## All Azure Groups
MATCH (n:AZGroup) return n.name
## All Azure Key Vaults
MATCH (n:AZKeyVault) return n.name
## All Azure Resource Groups
MATCH (n:AZResourceGroup) return n.name
## All Azure Service Principals
MATCH (n:AZServicePrincipal) return n.objectid
## All Azure Virtual Machines
MATCH (n:AZVM) return n.name
## All Principals with the ‚ÄòContributor‚Äô role
MATCH p = (n)-[r:AZContributor]->(g) RETURN p

# Advanced queries
## Get Global Admins
MATCH p =(n)-[r:AZGlobalAdmin*1..]->(m) RETURN p
## Owners of Azure Groups
MATCH p = (n)-[r:AZOwns]->(g:AZGroup) RETURN p
## All Azure Users and their Groups
MATCH p=(m:AZUser)-[r:MemberOf]->(n) WHERE NOT m.objectid CONTAINS 'S-1-5' RETURN p
## Privileged Service Principals
MATCH p = (g:AZServicePrincipal)-[r]->(n) RETURN p
## Owners of Azure Applications
MATCH p = (n)-[r:AZOwns]->(g:AZApp) RETURN p
## Paths to VMs
MATCH p = (n)-[r]->(g: AZVM) RETURN p
## Paths to KeyVault
MATCH p = (n)-[r]->(g:AZKeyVault) RETURN p
## Paths to Azure Resource Group
MATCH p = (n)-[r]->(g:AZResourceGroup) RETURN p
## On-Prem users with edges to Azure
MATCH  p=(m:User)-[r:AZResetPassword|AZOwns|AZUserAccessAdministrator|AZContributor|AZAddMembers|AZGlobalAdmin|AZVMContributor|AZOwnsAZAvereContributor]->(n) WHERE m.objectid CONTAINS 'S-1-5-21' RETURN p
## All Azure AD Groups that are synchronized with On-Premise AD
MATCH (n:Group) WHERE n.objectid CONTAINS 'S-1-5' AND n.azsyncid IS NOT NULL RETURN n
```
### [Azucar](https://github.com/nccgroup/azucar)
```bash
# You should use an account with at least read-permission on the assets you want to access
git clone https://github.com/nccgroup/azucar.git
PS> Get-ChildItem -Recurse c:\Azucar_V10 | Unblock-File

PS> .\Azucar.ps1 -AuthMode UseCachedCredentials -Verbose -WriteLog -Debug -ExportTo PRINT
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000
PS> .\Azucar.ps1 -ExportTo CSV,JSON,XML,EXCEL -AuthMode Certificate_Credentials -Certificate C:\AzucarTest\server.pfx -CertFilePassword MySuperP@ssw0rd! -ApplicationId 00000000-0000-0000-0000-000000000000 -TenantID 00000000-0000-0000-0000-000000000000

# resolve the TenantID for an specific username
PS> .\Azucar.ps1 -ResolveTenantUserName user@company.com
```
### [**MicroBurst**](https://github.com/NetSPI/MicroBurst)
```
Import-Module .\MicroBurst.psm1
Import-Module .\Get-AzureDomainInfo.ps1
Get-AzureDomainInfo -folder MicroBurst -Verbose
```
### [**PowerZure**](https://github.com/hausec/PowerZure)
```powershell
Connect-AzAccount
ipmo C:\Path\To\Powerzure.psd1
Get-AzureTarget

# Reader
$ Get-Runbook, Get-AllUsers, Get-Apps, Get-Resources, Get-WebApps, Get-WebAppDetails

# Contributor
$ Execute-Command -OS Windows -VM Win10Test -ResourceGroup Test-RG -Command "whoami"
$ Execute-MSBuild -VM Win10Test  -ResourceGroup Test-RG -File "build.xml"
$ Get-AllSecrets # AllAppSecrets, AllKeyVaultContents
$ Get-AvailableVMDisks, Get-VMDisk # Download a virtual machine's disk

# Owner
$ Set-Role -Role Contributor -User test@contoso.com -Resource Win10VMTest

# Administrator
$ Create-Backdoor, Execute-Backdoor
```
<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

D'autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
