# Pentesting dei servizi Kubernetes

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Kubernetes utilizza diversi **servizi di rete specifici** che potresti trovare **esposti su Internet** o in una **rete interna una volta compromesso un pod**.

## Trovare pod esposti con OSINT

Un modo potrebbe essere cercare `Identity LIKE "k8s.%.com"` in [crt.sh](https://crt.sh) per trovare sottodomini correlati a Kubernetes. Un altro modo potrebbe essere cercare `"k8s.%.com"` su GitHub e cercare file **YAML** che contengono la stringa.

## Come Kubernetes espone i servizi

Potrebbe essere utile capire come Kubernetes pu√≤ **esporre servizi pubblicamente** per trovarli:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Trovare pod esposti tramite scansione delle porte

Le seguenti porte potrebbero essere aperte in un cluster Kubernetes:

| Porta           | Processo       | Descrizione                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Porta API di Kubernetes                                                 |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Metriche del container                                                  |
| 6443/TCP        | kube-apiserver | Porta API di Kubernetes                                                 |
| 8443/TCP        | kube-apiserver | Porta API di Minikube                                                   |
| 8080/TCP        | kube-apiserver | Porta API non sicura                                                    |
| 10250/TCP       | kubelet        | API HTTPS che consente l'accesso in modalit√† completa                    |
| 10255/TCP       | kubelet        | Porta HTTP di sola lettura non autenticata: pod, pod in esecuzione e stato del nodo |
| 10256/TCP       | kube-proxy     | Server di controllo dello stato di Kube Proxy                            |
| 9099/TCP        | calico-felix   | Server di controllo dello stato di Calico                                |
| 6782-4/TCP      | weave          | Metriche e endpoint                                                    |
| 30000-32767/TCP | NodePort       | Proxy per i servizi                                                    |
| 44134/TCP       | Tiller         | Servizio Helm in ascolto                                                |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Questo √® il servizio **API di Kubernetes** con cui gli amministratori di solito comunicano utilizzando lo strumento **`kubectl`**.

**Porte comuni: 6443 e 443**, ma anche 8443 in minikube e 8080 come non sicura.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Controlla la seguente pagina per imparare come ottenere dati sensibili e eseguire azioni sensibili parlando con questo servizio:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API Kubelet

Questo servizio **viene eseguito su ogni nodo del cluster**. √à il servizio che **controlla** le pod all'interno del **nodo**. Comunica con il **kube-apiserver**.

Se trovi questo servizio esposto, potresti aver trovato una **RCE non autenticata**.

#### API Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Se la risposta √® `Unauthorized`, allora richiede l'autenticazione.

Se puoi elencare i nodi, puoi ottenere un elenco di endpoint kubelet con:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Sola lettura)

Il kubelet √® un componente chiave di Kubernetes che gestisce i container all'interno di un nodo. √à responsabile dell'esecuzione dei container e della comunicazione con il control plane di Kubernetes. 

Durante un test di penetrazione, √® possibile eseguire una serie di azioni per esplorare e ottenere informazioni dal kubelet in modalit√† di sola lettura. Queste azioni possono includere:

- Ottenere informazioni sulle risorse del nodo, come CPU, memoria e utilizzo del disco.
- Ottenere informazioni sui container in esecuzione sul nodo.
- Ottenere informazioni sulle immagini dei container presenti nel nodo.
- Ottenere informazioni sulle configurazioni di rete del nodo.
- Ottenere informazioni sulle configurazioni di sicurezza del nodo.

Per eseguire queste azioni, √® possibile utilizzare comandi come `kubectl`, `curl` o `wget` per interrogare l'API del kubelet. Ad esempio, √® possibile utilizzare il seguente comando per ottenere informazioni sulle risorse del nodo:

```
kubectl get nodes/<node_name> -o json
```

Questo comando restituir√† un output JSON che contiene informazioni dettagliate sul nodo, come l'indirizzo IP, le risorse disponibili e lo stato del nodo.

√à importante notare che l'accesso al kubelet in modalit√† di sola lettura non consente di apportare modifiche o eseguire azioni sul nodo. Tuttavia, pu√≤ fornire informazioni preziose per la valutazione della sicurezza e l'analisi dei punti deboli del cluster Kubernetes.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API di etcd

L'API di etcd √® un'interfaccia che consente di interagire con il servizio di archiviazione distribuita etcd. Questo servizio viene utilizzato come backend per la memorizzazione dei dati di configurazione e stato nel cluster Kubernetes.

L'API di etcd offre una serie di endpoint che consentono di eseguire operazioni come la lettura e la scrittura dei dati, la gestione delle transazioni e la navigazione della gerarchia dei dati.

Alcuni endpoint comuni dell'API di etcd includono:

- `/v3/kv/put`: consente di scrivere un valore in una chiave specifica.
- `/v3/kv/range`: consente di leggere i valori di una o pi√π chiavi.
- `/v3/kv/delete`: consente di eliminare una chiave e il suo valore.
- `/v3/txn`: consente di eseguire una transazione che comprende operazioni di scrittura e lettura.

L'API di etcd utilizza il protocollo gRPC per la comunicazione tra client e server. √à possibile interagire con l'API di etcd utilizzando strumenti come `etcdctl` o scrivendo codice personalizzato utilizzando un client gRPC.

√à importante comprendere l'API di etcd durante il penetration testing di servizi Kubernetes, in quanto pu√≤ essere utilizzata per accedere e manipolare i dati sensibili memorizzati nel cluster.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller √® il componente del server di gestione di Helm che gestisce le operazioni di installazione, aggiornamento e rimozione delle applicazioni all'interno di un cluster Kubernetes. Tiller √® responsabile della comunicazione tra il client Helm e il server Kubernetes, consentendo al client di inviare comandi per gestire le risorse all'interno del cluster.

Tiller √® un componente critico per la sicurezza di un cluster Kubernetes, poich√© pu√≤ avere accesso privilegiato alle risorse del cluster. Pertanto, √® importante prendere precauzioni per proteggere Tiller da potenziali attacchi.

Alcune delle misure di sicurezza consigliate per proteggere Tiller includono:

- Limitare i privilegi di Tiller: √® consigliabile assegnare a Tiller solo i privilegi minimi necessari per eseguire le operazioni richieste. Ci√≤ pu√≤ essere fatto utilizzando i ruoli e i ruoli di associazione di Kubernetes per limitare l'accesso di Tiller alle risorse del cluster.

- Abilitare l'autenticazione di Tiller: √® possibile abilitare l'autenticazione di Tiller richiedendo l'autenticazione del client Helm prima di consentire l'accesso a Tiller. Ci√≤ pu√≤ essere fatto utilizzando il meccanismo di autenticazione di Kubernetes, ad esempio utilizzando i token di accesso o i certificati client.

- Limitare l'accesso a Tiller: √® consigliabile limitare l'accesso a Tiller solo ai client autorizzati. Ci√≤ pu√≤ essere fatto configurando le regole di rete per consentire solo l'accesso da indirizzi IP specifici o utilizzando meccanismi di autenticazione aggiuntivi come l'autenticazione basata su indirizzo IP.

- Monitorare Tiller: √® importante monitorare l'attivit√† di Tiller per rilevare eventuali anomalie o attivit√† sospette. Ci√≤ pu√≤ essere fatto utilizzando strumenti di monitoraggio e registrazione del cluster Kubernetes.

Seguendo queste misure di sicurezza, √® possibile proteggere Tiller da potenziali attacchi e garantire la sicurezza complessiva del cluster Kubernetes.
```
helm --host tiller-deploy.kube-system:44134 version
```
√à possibile sfruttare questo servizio per ottenere privilegi elevati all'interno di Kubernetes:

### cAdvisor

Servizio utile per raccogliere metriche.
```
curl -k https://<IP Address>:4194
```
### NodePort

Quando una porta viene esposta in tutti i nodi tramite un **NodePort**, la stessa porta viene aperta in tutti i nodi per instradare il traffico nel **Service** dichiarato. Per impostazione predefinita, questa porta sar√† nell'**intervallo 30000-32767**. Quindi nuovi servizi non controllati potrebbero essere accessibili tramite tali porte.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Vulnerabilit√† di configurazione errata

### Accesso anonimo a Kube-apiserver

L'accesso anonimo agli endpoint API di **kube-apiserver non √® consentito**. Tuttavia, √® possibile verificare alcuni endpoint:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### Verifica dell'accesso anonimo a ETCD

ETCD memorizza i segreti del cluster, i file di configurazione e altri dati **sensibili**. Per **default**, l'accesso anonimo a ETCD **non √® consentito**, ma √® sempre bene verificare.

Se √® possibile accedere ad ETCD in modo anonimo, potrebbe essere necessario **utilizzare lo strumento** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Il seguente comando recuperer√† tutte le chiavi memorizzate:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

La [**documentazione di Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) spiega che per **default √® consentito l'accesso anonimo** al servizio:

> Abilita le richieste anonime al server Kubelet. Le richieste che non vengono respinte da un altro metodo di autenticazione vengono trattate come richieste anonime. Le richieste anonime hanno un nome utente `system:anonymous` e un nome di gruppo `system:unauthenticated`.

Per capire meglio come funziona l'**autenticazione e l'autorizzazione dell'API di Kuebelet**, consulta questa pagina:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Il servizio **API di Kubelet non √® documentato**, ma il codice sorgente pu√≤ essere trovato qui e trovare i punti di accesso esposti √® semplice come **eseguire**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Tutti sembrano interessanti.

Puoi utilizzare lo strumento [**Kubeletctl**](https://github.com/cyberark/kubeletctl) per interagire con i Kubelet e i loro endpoint.

#### /pods

Questo endpoint elenca i pod e i loro container:
```bash
kubeletctl pods
```
#### /exec

Questo endpoint consente di eseguire facilmente il codice all'interno di qualsiasi container:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Per evitare questo attacco, il servizio _**kubelet**_ dovrebbe essere eseguito con `--anonymous-auth false` e il servizio dovrebbe essere segregato a livello di rete.
{% endhint %}

### **Verifica dell'esposizione delle informazioni del Kubelet (Porta di sola lettura)**

Quando una **porta di sola lettura del kubelet** √® esposta, diventa possibile recuperare informazioni dall'API da parte di parti non autorizzate. L'esposizione di questa porta pu√≤ portare alla divulgazione di vari **elementi di configurazione del cluster**. Sebbene le informazioni, incluse **i nomi dei pod, le posizioni dei file interni e altre configurazioni**, potrebbero non essere critiche, la loro esposizione rappresenta comunque un rischio per la sicurezza e dovrebbe essere evitata.

Un esempio di come questa vulnerabilit√† pu√≤ essere sfruttata coinvolge un attaccante remoto che accede a un URL specifico. Navigando su `http://<external-IP>:10255/pods`, l'attaccante potrebbe potenzialmente recuperare informazioni sensibili dal kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Riferimenti

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
