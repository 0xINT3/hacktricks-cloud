# Pentesting Servicios de Kubernetes

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Kubernetes utiliza varios **servicios de red específicos** que podrías encontrar **expuestos a Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Encontrar pods expuestos con OSINT

Una forma podría ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con Kubernetes. Otra forma podría ser buscar `"k8s.%.com"` en github y buscar archivos **YAML** que contengan la cadena.

## Cómo expone Kubernetes los servicios

Podría ser útil para ti entender cómo Kubernetes puede **exponer servicios públicamente** para encontrarlos:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrar pods expuestos mediante escaneo de puertos

Los siguientes puertos podrían estar abiertos en un clúster de Kubernetes:

| Puerto          | Proceso        | Descripción                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Puerto de la API de Kubernetes                                          |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Métricas de contenedores                                                |
| 6443/TCP        | kube-apiserver | Puerto de la API de Kubernetes                                          |
| 8443/TCP        | kube-apiserver | Puerto de la API de Minikube                                            |
| 8080/TCP        | kube-apiserver | Puerto de la API insegura                                               |
| 10250/TCP       | kubelet        | API HTTPS que permite el acceso en modo completo                        |
| 10255/TCP       | kubelet        | Puerto HTTP de solo lectura sin autenticación: pods, pods en ejecución y estado del nodo |
| 10256/TCP       | kube-proxy     | Servidor de comprobación de salud de Kube Proxy                          |
| 9099/TCP        | calico-felix   | Servidor de comprobación de salud para Calico                            |
| 6782-4/TCP      | weave          | Métricas y puntos finales                                               |
| 30000-32767/TCP | NodePort       | Proxy a los servicios                                                   |
| 44134/TCP       | Tiller         | Servicio de Helm escuchando                                              |

### Nmap

```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```

### Kube-apiserver

Este es el **servicio API de Kubernetes** con el que los administradores suelen hablar usando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero también 8443 en minikube y 8080 como inseguro.

```
curl -k https://<dirección IP>:(8|6)443/swaggerapi
curl -k https://<dirección IP>:(8|6)443/healthz
curl -k https://<dirección IP>:(8|6)443/api/v1
```

**Consulte la siguiente página para aprender cómo obtener datos sensibles y realizar acciones sensibles hablando con este servicio:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Este servicio **se ejecuta en cada nodo del clúster**. Es el servicio que **controlará** los pods dentro del **nodo**. Habla con el **kube-apiserver**.

Si encuentras este servicio expuesto, podrías haber encontrado una **RCE sin autenticación**.

#### Kubelet API

```
curl -k https://<dirección IP>:10250/metrics
curl -k https://<dirección IP>:10250/pods
```

Si la respuesta es `Unauthorized`, entonces requiere autenticación.

Si puedes listar nodos, puedes obtener una lista de los puntos finales de kubelets con:

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
    ip=$(echo $node | awk '{print $1}')
    port=$(echo $node | awk '{print $2}')
    echo "curl -k --max-time 30 https://$ip:$port/pods"
    echo "curl -k --max-time 30 https://$ip:2379/version" #Comprobar también para etcd
done
```

#### kubelet (Solo lectura)

```
curl -k https://<dirección IP>:10255
http://<external-IP>:10255/pods
```

### etcd API

```
curl -k https://<dirección IP>:2379
curl -k https://<dirección IP>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

```
helm --host tiller-deploy.kube-system:44134 version
```

Podrías abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio útil para recopilar métricas.

```
curl -k https://<dirección IP>:4194
```

### NodePort

Cuando un puerto se expone en todos los nodos a través de un **NodePort**, el mismo puerto se abre en todos los nodos proxificando el tráfico en el **Service** declarado. Por defecto, este puerto estará en el rango **30000-32767**. Por lo tanto, los nuevos servicios no verificados podrían ser accesibles a través de esos puertos.

```
sudo nmap -sS -p 30000-32767 <IP>
```

## Vulnerabilidades de configuración
### **Comprobando la exposición de información de Kubelet (puerto de solo lectura)**

Cuando el **puerto de solo lectura de kubelet** está expuesto, el atacante puede recuperar información de la API. Esto expone **elementos de configuración del clúster, como nombres de pods, ubicación de archivos internos y otras configuraciones**. Esta no es información crítica, pero aún así no debería estar expuesta a Internet.

Por ejemplo, un atacante remoto puede abusar de esto accediendo a la siguiente URL: `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>