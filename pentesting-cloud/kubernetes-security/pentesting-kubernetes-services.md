# Kubernetes服务渗透测试

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

Kubernetes使用了几种**特定的网络服务**，您可能会发现这些服务**暴露在互联网上**，或者在**您成功入侵一个Pod后的内部网络中**。

## 使用OSINT查找暴露的Pod

一种方法是在[crt.sh](https://crt.sh)中搜索`Identity LIKE "k8s.%.com"`，以查找与Kubernetes相关的子域名。另一种方法可能是在github中搜索`"k8s.%.com"`，并搜索包含该字符串的**YAML文件**。

## Kubernetes如何暴露服务

了解Kubernetes如何**公开暴露服务**可能对您有所帮助，以便找到它们：

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## 通过端口扫描查找暴露的Pod

在Kubernetes集群中，以下端口可能是开放的：

| 端口            | 进程           | 描述                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API端口                                                     |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | 容器指标                                                               |
| 6443/TCP        | kube-apiserver | Kubernetes API端口                                                     |
| 8443/TCP        | kube-apiserver | Minikube API端口                                                       |
| 8080/TCP        | kube-apiserver | 不安全的API端口                                                        |
| 10250/TCP       | kubelet        | 允许完全访问的HTTPS API                                                 |
| 10255/TCP       | kubelet        | 未经身份验证的只读HTTP端口：Pod、运行中的Pod和节点状态                  |
| 10256/TCP       | kube-proxy     | Kube Proxy健康检查服务器                                               |
| 9099/TCP        | calico-felix   | Calico的健康检查服务器                                                 |
| 6782-4/TCP      | weave          | 指标和端点                                                             |
| 30000-32767/TCP | NodePort       | 服务的代理                                                             |
| 44134/TCP       | Tiller         | Helm服务监听                                                           |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

这是管理员通常使用工具`kubectl`与之交互的**API Kubernetes服务**。

常见端口：6443和443，但在minikube中也有8443，并且8080是不安全的。
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**查看以下页面以了解如何获取敏感数据并与此服务进行敏感操作：**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

该服务在集群的每个节点上运行。它是控制节点内的Pod的服务。它与kube-apiserver进行通信。

如果您发现此服务暴露在外，可能已经发现了一个未经身份验证的远程命令执行（RCE）漏洞。

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
如果响应是 `Unauthorized`，则需要进行身份验证。

如果您可以列出节点，则可以使用以下命令获取 kubelet 端点列表：
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet（只读）

The kubelet is an agent that runs on each node in the Kubernetes cluster. It is responsible for managing the containers on the node and ensuring their health. As a pentester, you can gain read-only access to the kubelet to gather information about the containers running on the node.

To exploit this, you can use the following techniques:

1. **Unauthenticated Access**: Some kubelet endpoints may be accessible without authentication. You can try accessing the `/metrics` endpoint to gather information about the containers and their resource usage.

2. **API Server Proxy**: If the kubelet is configured to allow API server proxy requests, you can use the API server as a proxy to access the kubelet's endpoints. This can be done by sending requests to the `/api/v1/nodes/<node_name>/proxy/` endpoint.

3. **Kubelet API**: The kubelet exposes an API that can be accessed using the `kubectl proxy` command. This allows you to interact with the kubelet's endpoints through the Kubernetes API server.

By gaining read-only access to the kubelet, you can gather valuable information about the containers running on the node, such as their image, command, and environment variables. This information can be useful for further exploitation or reconnaissance.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

The etcd API is a key-value store used by Kubernetes to store cluster configuration data. It is a critical component of the Kubernetes control plane and is responsible for maintaining the state of the cluster.

#### Security Considerations

When pentesting Kubernetes services, it is important to pay attention to the security of the etcd API. Here are some security considerations to keep in mind:

1. **Authentication**: Ensure that the etcd API is properly configured to require authentication. This can be done by enabling client authentication and configuring user accounts with appropriate permissions.

2. **Authorization**: Implement proper authorization policies to control access to the etcd API. This includes defining roles and role bindings to restrict access to sensitive data.

3. **Transport Encryption**: Enable transport encryption for the etcd API to protect data in transit. This can be achieved by configuring TLS certificates and enforcing secure communication protocols.

4. **Secure Defaults**: Review the default configuration settings of the etcd API and ensure that they align with security best practices. Disable any unnecessary features or endpoints that could potentially expose sensitive information.

5. **Monitoring and Logging**: Implement monitoring and logging mechanisms to detect and track any unauthorized access or suspicious activity in the etcd API. This can help in identifying potential security breaches and taking appropriate actions.

#### Exploitation Techniques

During a pentest, it is important to be aware of potential exploitation techniques that can be used against the etcd API. Some common techniques include:

1. **Information Disclosure**: Exploiting misconfigurations or vulnerabilities in the etcd API to gain unauthorized access to sensitive data. This can include retrieving cluster configuration information, secrets, or other sensitive information stored in etcd.

2. **Privilege Escalation**: Exploiting vulnerabilities in the etcd API to escalate privileges and gain administrative access to the Kubernetes cluster. This can allow an attacker to perform unauthorized actions or manipulate the cluster's configuration.

3. **Denial of Service**: Launching a denial of service attack against the etcd API to disrupt the availability of the Kubernetes cluster. This can be achieved by overwhelming the etcd API with a high volume of requests or exploiting vulnerabilities that cause resource exhaustion.

4. **Man-in-the-Middle Attacks**: Intercepting and manipulating communication between the Kubernetes components and the etcd API. This can allow an attacker to eavesdrop on sensitive data, modify requests, or inject malicious code into the communication channel.

#### Conclusion

Understanding the security considerations and potential exploitation techniques related to the etcd API is crucial for effectively pentesting Kubernetes services. By identifying and addressing vulnerabilities in the etcd API, organizations can enhance the overall security of their Kubernetes clusters.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller是Kubernetes中的一个组件，用于管理Helm Charts的部署。Helm是一个Kubernetes的包管理工具，允许用户轻松地安装、升级和管理应用程序。

Tiller的安全性是非常重要的，因为它具有对整个Kubernetes集群的访问权限。如果Tiller被攻击或滥用，攻击者可能会获取对集群中所有资源的控制权。

以下是一些Tiller的安全建议：

1. **限制Tiller的权限**：确保Tiller只能访问必要的资源，并限制其对敏感资源的访问权限。可以使用Kubernetes的RBAC（Role-Based Access Control）来实现这一点。

2. **使用TLS进行通信**：启用Tiller的TLS通信，以确保通信过程中的数据安全性。可以使用自签名证书或颁发机构（CA）签名的证书来实现TLS。

3. **禁用Tiller的远程访问**：默认情况下，Tiller允许远程访问。为了增加安全性，建议禁用远程访问，并仅允许本地访问。

4. **定期更新和监控Tiller**：及时更新Tiller的版本，并监控其活动以检测任何异常行为。

5. **审查Helm Charts的安全性**：在使用Helm Charts之前，仔细审查其安全性，并确保其中不包含任何潜在的安全漏洞。

通过采取这些安全措施，可以帮助保护Tiller和Kubernetes集群免受潜在的攻击和滥用。
```
helm --host tiller-deploy.kube-system:44134 version
```
您可以滥用此服务来在Kubernetes中提升权限：

### cAdvisor

用于收集指标的有用服务。
```
curl -k https://<IP Address>:4194
```
### NodePort

当一个端口通过**NodePort**在所有节点上暴露时，相同的端口会在所有节点上打开，并将流量代理到声明的**Service**。默认情况下，这个端口将在**30000-32767范围内**。因此，新的未经检查的服务可能可以通过这些端口访问。
```
sudo nmap -sS -p 30000-32767 <IP>
```
## 可能存在的配置错误

### Kube-apiserver匿名访问

默认情况下，kube-apiserver的API端点禁止匿名访问。但是检查是否存在暴露敏感信息的不安全端点总是一个好主意：

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### 检查ETCD的匿名访问

ETCD存储集群的秘密、配置文件和其他敏感数据。默认情况下，ETCD不能匿名访问，但是检查一下总是好的。

如果ETCD可以匿名访问，您可能需要使用[etcdctl工具](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md)。以下命令将获取存储的所有密钥：
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE（远程代码执行）**

[**Kubelet文档**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)解释了默认情况下允许对服务进行匿名访问：

> 启用对Kubelet服务器的匿名请求。未被其他身份验证方法拒绝的请求将被视为匿名请求。匿名请求的用户名为`system:anonymous`，组名为`system:unauthenticated`。

要更好地了解**Kuebelet API的身份验证和授权**工作原理，请查看此页面：

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet**服务的**API未记录**，但可以在此处找到源代码，并且只需运行以下命令即可找到暴露的端点：
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
所有这些听起来都很有趣。

您可以使用[Kubeletctl](https://github.com/cyberark/kubeletctl)工具与Kubelets及其端点进行交互。

#### /pods

此端点列出了Pod及其容器：
```bash
kubeletctl pods
```
#### /exec

此端点允许非常简单地在任何容器中执行代码：
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
为了避免这种攻击，_**kubelet**_ 服务应该使用 `--anonymous-auth false` 参数运行，并且该服务应该在网络层面进行隔离。
{% endhint %}

### **检查 Kubelet（只读端口）信息泄露**

当 **kubelet 只读端口** 被暴露时，攻击者可以从 API 中检索信息。这会暴露集群配置元素，例如 pod 的名称、内部文件的位置和其他配置。这不是关键信息，但仍然不应该暴露在互联网上。

例如，远程攻击者可以通过访问以下 URL 来滥用此功能：`http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 参考资料

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注** 我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
