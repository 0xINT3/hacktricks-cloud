# Kubernetesサービスのペンテスト

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricksであなたの会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

Kubernetesはいくつかの**特定のネットワークサービス**を使用しており、これらは**インターネットに公開されている**か、**1つのポッドを侵害した後の内部ネットワーク**で見つけることができるかもしれません。

## OSINTを使用した公開されたポッドの検索

一つの方法は、[crt.sh](https://crt.sh)で`Identity LIKE "k8s.%.com"`を検索して、kubernetesに関連するサブドメインを見つけることです。別の方法は、githubで`"k8s.%.com"`を検索し、その文字列を含む**YAMLファイル**を検索することです。

## Kubernetesがサービスを公開する方法

Kubernetesがサービスを**公開する方法**を理解することは役に立つかもしれません:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## ポートスキャンによる公開されたポッドの検索

Kubernetesクラスターでは、次のポートが開いている可能性があります:

| ポート           | プロセス        | 説明                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes APIポート                                                   |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | コンテナメトリクス                                                     |
| 6443/TCP        | kube-apiserver | Kubernetes APIポート                                                   |
| 8443/TCP        | kube-apiserver | Minikube APIポート                                                     |
| 8080/TCP        | kube-apiserver | セキュリティのないAPIポート                                             |
| 10250/TCP       | kubelet        | フルモードアクセスを許可するHTTPS API                                   |
| 10255/TCP       | kubelet        | 認証されていない読み取り専用HTTPポート: ポッド、実行中のポッド、ノードの状態 |
| 10256/TCP       | kube-proxy     | Kube Proxyヘルスチェックサーバー                                        |
| 9099/TCP        | calico-felix   | Calicoのヘルスチェックサーバー                                          |
| 6782-4/TCP      | weave          | メトリクスとエンドポイント                                               |
| 30000-32767/TCP | NodePort       | サービスへのプロキシ                                                    |
| 44134/TCP       | Tiller         | Helmサービスのリスニング                                                |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

これは、管理者が通常ツール**`kubectl`**を使用して話す**API Kubernetesサービス**です。

一般的なポートは6443と443ですが、minikubeでは8443、非セキュアな場合は8080も使用されます。
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**次のページをチェックして、このサービスとのやり取りで機密データを入手し、機密なアクションを実行する方法を学びます:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

このサービスは**クラスタの各ノードで実行されます**。これは**ノード**内のポッドを**制御**するサービスです。**kube-apiserver**と通信します。

このサービスが公開されている場合、**認証されていないRCE**を見つけた可能性があります。

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
もしレスポンスが`Unauthorized`であれば、認証が必要です。

ノードの一覧を取得することができれば、以下のコマンドでkubeletのエンドポイントの一覧を取得できます。
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet（読み取り専用）

The kubelet is the primary node agent that runs on each node in a Kubernetes cluster. It is responsible for managing the containers and their lifecycle on the node. As a pentester, you can perform read-only operations on the kubelet to gather information about the node and the containers running on it.

To pentest the kubelet, you can use various techniques such as:

- **Information Gathering**: You can gather information about the node, including its hostname, IP address, and operating system details. Additionally, you can obtain details about the containers running on the node, such as their names, images, and resource usage.

- **Exploiting Misconfigurations**: If the kubelet is misconfigured, you may be able to exploit it to gain unauthorized access to the node or the containers running on it. For example, if the kubelet's API server is exposed without authentication, you can access it and perform unauthorized operations.

- **Enumerating Secrets**: The kubelet stores secrets used by the containers in its local filesystem. By enumerating the secrets, you may discover sensitive information such as API keys, passwords, or certificates.

It is important to note that while the kubelet provides read-only access by default, misconfigurations or vulnerabilities can potentially lead to unauthorized access or data leakage. Therefore, it is crucial to thoroughly test the security of the kubelet during a pentest to identify and mitigate any potential risks.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

The etcd API is a key-value store used by Kubernetes to store and retrieve configuration data. It is a critical component of the Kubernetes control plane and is responsible for maintaining the cluster's state.

During a penetration test, it is important to assess the security of the etcd API to ensure that sensitive data is not exposed or vulnerable to unauthorized access. Here are some key areas to focus on:

1. **Authentication and Authorization**: Verify that proper authentication mechanisms are in place to prevent unauthorized access to the etcd API. Ensure that only authorized users or services can interact with the API.

2. **Transport Security**: Check if the etcd API is using secure communication protocols such as TLS to encrypt data in transit. Insecure communication can lead to data interception and potential leaks.

3. **Access Control**: Review the access control policies and roles defined for the etcd API. Ensure that only necessary permissions are granted to users or services, and that sensitive data is adequately protected.

4. **Sensitive Data Exposure**: Look for any instances where sensitive data, such as credentials or configuration details, are stored in the etcd API. This data should be properly encrypted or masked to prevent unauthorized access.

5. **Default Credentials**: Check if any default or weak credentials are being used for the etcd API. These credentials should be changed to strong, unique passwords to prevent unauthorized access.

By thoroughly assessing the security of the etcd API, you can help ensure the overall security and integrity of the Kubernetes cluster.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller is the server-side component of Helm, a package manager for Kubernetes. It runs inside the Kubernetes cluster and manages the deployment of charts, which are packages of pre-configured Kubernetes resources.

Tiller is a potential security risk because it has extensive privileges within the cluster. By default, Tiller has full administrative access to all resources in the cluster, including the ability to create, modify, and delete resources.

To secure Tiller, it is recommended to follow these best practices:

1. **Disable Tiller**: If you are not using Helm or Tiller, it is recommended to disable Tiller completely. This can be done by uninstalling Tiller from the cluster.

2. **Limit Tiller's privileges**: If you need to use Tiller, it is important to limit its privileges. You can create a dedicated service account for Tiller and assign it the minimum necessary permissions to perform its tasks.

3. **Enable TLS**: By default, Tiller communicates over an unencrypted connection. To secure the communication between Helm and Tiller, it is recommended to enable TLS encryption. This can be done by configuring Helm to use TLS and generating the necessary certificates.

4. **Use RBAC**: Role-Based Access Control (RBAC) can be used to restrict the actions that Tiller can perform. By defining appropriate RBAC rules, you can limit Tiller's access to only the necessary resources and operations.

5. **Regularly update Helm and Tiller**: It is important to keep Helm and Tiller up to date with the latest security patches and updates. Regularly check for new releases and apply the updates as soon as possible.

By following these best practices, you can help secure Tiller and reduce the risk of unauthorized access or misuse of your Kubernetes cluster.
```
helm --host tiller-deploy.kube-system:44134 version
```
このサービスを悪用することで、Kubernetes内で特権を昇格させることができます：

### cAdvisor

メトリクスを収集するために役立つサービスです。
```
curl -k https://<IP Address>:4194
```
### NodePort

ノードポートを介してポートが公開されると、同じポートがすべてのノードで開かれ、トラフィックが宣言されたサービスにプロキシされます。デフォルトでは、このポートは**30000-32767の範囲**にあります。したがって、新しい未チェックのサービスはこれらのポートを介してアクセス可能になる可能性があります。
```
sudo nmap -sS -p 30000-32767 <IP>
```
## 脆弱な設定ミス

### Kube-apiserverの匿名アクセス

**デフォルトでは**、**kube-apiserver**のAPIエンドポイントは**匿名**アクセスが**禁止**されています。しかし、**機密情報を公開する脆弱なエンドポイント**が存在しないか確認することは常に良いアイデアです。

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### ETCDの匿名アクセスのチェック

ETCDはクラスタの秘密、設定ファイルなどの**機密データ**を保存しています。**デフォルトでは**、ETCDは**匿名**でアクセスできませんが、常にチェックすることが良いでしょう。

ETCDに匿名でアクセスできる場合、[etcdctl](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md)ツールを使用する必要があります。次のコマンドで保存されているすべてのキーを取得できます：
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[Kubeletのドキュメント](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)によれば、**デフォルトではサービスへの匿名アクセスが許可されています**：

> Kubeletサーバーへの匿名リクエストを有効にします。他の認証方法によって拒否されないリクエストは匿名リクエストとして扱われます。匿名リクエストのユーザー名は `system:anonymous` で、グループ名は `system:unauthenticated` です。

**Kubelet APIの認証と認可の仕組み**をより理解するために、このページを参照してください：

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet**サービスの**APIはドキュメント化されていません**が、ソースコードはここで見つけることができます。公開されたエンドポイントを見つけるのは簡単です。以下のコマンドを実行してください：
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
すべて興味深いです。

[**Kubeletctl**](https://github.com/cyberark/kubeletctl)ツールを使用して、Kubeletとそのエンドポイントとのやり取りができます。

#### /pods

このエンドポイントは、ポッドとそのコンテナの一覧を表示します：
```bash
kubeletctl pods
```
#### /exec

このエンドポイントは、どのコンテナでも簡単にコードを実行することができます。
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
この攻撃を防ぐためには、_**kubelet**_ サービスを `--anonymous-auth false` オプションで実行し、サービスをネットワークレベルで分離する必要があります。
{% endhint %}

### **Kubelet（読み取り専用ポート）の情報漏洩のチェック**

**kubeletの読み取り専用ポート**が公開されている場合、攻撃者はAPIから情報を取得することができます。これにより、**ポッドの名前、内部ファイルの場所、その他の設定などのクラスタ構成要素**が公開されます。これは重要な情報ではありませんが、インターネットに公開されるべきではありません。

たとえば、リモート攻撃者は次のURLにアクセスすることでこれを悪用することができます：`http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 参考文献

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
