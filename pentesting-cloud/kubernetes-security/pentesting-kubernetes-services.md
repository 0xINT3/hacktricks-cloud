# Pentesting des services Kubernetes

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Kubernetes utilise plusieurs **services r√©seau sp√©cifiques** que vous pourriez trouver **expos√©s sur Internet** ou sur un **r√©seau interne une fois que vous avez compromis un pod**.

## Trouver des pods expos√©s avec OSINT

Une fa√ßon pourrait √™tre de rechercher `Identity LIKE "k8s.%.com"` dans [crt.sh](https://crt.sh) pour trouver des sous-domaines li√©s √† Kubernetes. Une autre fa√ßon pourrait √™tre de rechercher `"k8s.%.com"` dans github et de rechercher des fichiers **YAML** contenant la cha√Æne.

## Comment Kubernetes expose les services

Il pourrait √™tre utile de comprendre comment Kubernetes peut **exposer des services publiquement** afin de les trouver :

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Trouver des pods expos√©s via le scan de ports

Les ports suivants peuvent √™tre ouverts dans un cluster Kubernetes :

| Port            | Process        | Description                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port de l'API Kubernetes                                                |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | M√©triques des conteneurs                                               |
| 6443/TCP        | kube-apiserver | Port de l'API Kubernetes                                                |
| 8443/TCP        | kube-apiserver | Port de l'API Minikube                                                  |
| 8080/TCP        | kube-apiserver | Port d'API non s√©curis√©                                                 |
| 10250/TCP       | kubelet        | API HTTPS permettant un acc√®s en mode complet                           |
| 10255/TCP       | kubelet        | Port HTTP en lecture seule non authentifi√© : pods, pods en cours d'ex√©cution et √©tat du n≈ìud |
| 10256/TCP       | kube-proxy     | Serveur de v√©rification de l'√©tat de sant√© de Kube Proxy                |
| 9099/TCP        | calico-felix   | Serveur de v√©rification de l'√©tat de sant√© pour Calico                  |
| 6782-4/TCP      | weave          | M√©triques et points de terminaison                                      |
| 30000-32767/TCP | NodePort       | Proxy vers les services                                                 |
| 44134/TCP       | Tiller         | Service Helm en √©coute                                                  |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

C'est le service **API Kubernetes** avec lequel les administrateurs communiquent g√©n√©ralement √† l'aide de l'outil **`kubectl`**.

**Ports courants : 6443 et 443**, mais aussi 8443 dans minikube et 8080 en mode non s√©curis√©.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Consultez la page suivante pour apprendre comment obtenir des donn√©es sensibles et effectuer des actions sensibles en communiquant avec ce service :**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API Kubelet

Ce service **s'ex√©cute sur chaque n≈ìud du cluster**. C'est le service qui **contr√¥le** les pods √† l'int√©rieur du **n≈ìud**. Il communique avec le **kube-apiserver**.

Si vous trouvez ce service expos√©, vous pourriez avoir d√©couvert une **RCE non authentifi√©e**.

#### API Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Si la r√©ponse est `Unauthorized`, cela signifie qu'une authentification est requise.

Si vous pouvez r√©pertorier les n≈ìuds, vous pouvez obtenir une liste des points de terminaison kubelets avec :
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Lecture seule)

Le kubelet est un composant cl√© de Kubernetes qui s'ex√©cute sur chaque n≈ìud du cluster. Il est responsable de la gestion des conteneurs et de l'ex√©cution des pods. En tant que composant critique, il est important de comprendre comment le pentester pour identifier les vuln√©rabilit√©s potentielles.

##### Analyse de s√©curit√©

Lors de l'analyse de s√©curit√© du kubelet, voici quelques points cl√©s √† prendre en compte :

- **Authentification et autorisation** : V√©rifiez si le kubelet est correctement configur√© pour utiliser des m√©canismes d'authentification et d'autorisation solides. Assurez-vous que seuls les utilisateurs et les services autoris√©s peuvent acc√©der au kubelet.

- **V√©rification des certificats** : V√©rifiez si les certificats utilis√©s par le kubelet sont valides et correctement configur√©s. Les certificats expir√©s ou mal configur√©s peuvent entra√Æner des vuln√©rabilit√©s.

- **Contr√¥le des acc√®s r√©seau** : V√©rifiez si le kubelet est correctement configur√© pour limiter les acc√®s r√©seau. Assurez-vous que seuls les services et les utilisateurs autoris√©s peuvent communiquer avec le kubelet.

- **V√©rification des autorisations des pods** : V√©rifiez si les autorisations des pods sont correctement configur√©es. Assurez-vous que seuls les pods autoris√©s peuvent √™tre ex√©cut√©s sur le kubelet.

- **V√©rification des journaux** : V√©rifiez les journaux du kubelet pour d√©tecter d'√©ventuelles activit√©s suspectes ou des erreurs de configuration.

##### Techniques de pentest

Lors du pentest du kubelet, voici quelques techniques couramment utilis√©es :

- **Analyse des ports ouverts** : Utilisez des outils d'analyse de ports pour identifier les ports ouverts sur le kubelet. Cela peut r√©v√©ler des services ou des interfaces non s√©curis√©s.

- **Test d'authentification** : Testez les m√©canismes d'authentification du kubelet pour v√©rifier s'ils sont r√©sistants aux attaques d'authentification.

- **Test d'autorisation** : Testez les m√©canismes d'autorisation du kubelet pour v√©rifier s'ils sont correctement configur√©s et r√©sistants aux attaques d'autorisation.

- **Test de v√©rification des certificats** : Testez la v√©rification des certificats du kubelet pour v√©rifier si des certificats invalides ou mal configur√©s peuvent √™tre exploit√©s.

- **Test d'injection de commandes** : Testez si le kubelet est vuln√©rable √† l'injection de commandes. Cela peut √™tre r√©alis√© en exploitant des vuln√©rabilit√©s connues ou en utilisant des techniques d'injection de commandes.

- **Test de fuite d'informations** : Testez si le kubelet est vuln√©rable √† la fuite d'informations sensibles. Cela peut inclure la recherche de fichiers de configuration sensibles ou d'informations d'identification stock√©es de mani√®re non s√©curis√©e.

- **Test de d√©ni de service** : Testez si le kubelet est vuln√©rable aux attaques de d√©ni de service. Cela peut √™tre r√©alis√© en envoyant un grand nombre de requ√™tes au kubelet pour le surcharger.

- **Test de contournement des autorisations** : Testez si le kubelet est vuln√©rable au contournement des autorisations. Cela peut √™tre r√©alis√© en exploitant des vuln√©rabilit√©s connues ou en utilisant des techniques de contournement des autorisations.

##### R√©f√©rences

- [Documentation officielle de Kubernetes - kubelet](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)
- [Documentation officielle de Kubernetes - S√©curit√© du kubelet](https://kubernetes.io/docs/concepts/security/pod-security-standards/#kubelet-security)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
L'API etcd est un service de stockage cl√©-valeur distribu√© utilis√© par Kubernetes pour stocker les donn√©es de configuration. Il est essentiel pour le bon fonctionnement d'un cluster Kubernetes. Cependant, en raison de sa nature distribu√©e, il peut pr√©senter des vuln√©rabilit√©s potentielles qui peuvent √™tre exploit√©es lors d'un test de p√©n√©tration.

#### Vuln√©rabilit√©s courantes de l'API etcd

1. **Acc√®s non autoris√©**: L'API etcd peut √™tre expos√©e publiquement sans aucune authentification ou autorisation, ce qui permet √† un attaquant d'acc√©der aux donn√©es sensibles stock√©es dans etcd.

2. **Fuites d'informations sensibles**: Les cl√©s stock√©es dans etcd peuvent contenir des informations sensibles telles que des secrets d'authentification, des cl√©s d'API, des informations de connexion √† la base de donn√©es, etc. Une mauvaise configuration peut entra√Æner la divulgation de ces informations.

3. **Attaques par d√©ni de service**: Un attaquant peut exploiter l'API etcd en envoyant un grand nombre de requ√™tes pour √©puiser les ressources du cluster Kubernetes, entra√Ænant ainsi un d√©ni de service.

#### M√©thodes de test de p√©n√©tration pour l'API etcd

1. **Analyse des ports**: V√©rifiez si le port par d√©faut de l'API etcd (2379) est ouvert et accessible depuis l'ext√©rieur. Utilisez des outils tels que Nmap pour effectuer cette analyse.

2. **Test d'authentification et d'autorisation**: V√©rifiez si l'API etcd n√©cessite une authentification et une autorisation pour acc√©der aux donn√©es. Essayez d'acc√©der √† l'API sans vous authentifier pour voir si vous pouvez obtenir un acc√®s non autoris√©.

3. **Test de fuite d'informations**: V√©rifiez si des informations sensibles sont stock√©es dans etcd en recherchant des cl√©s qui pourraient contenir ces informations. Utilisez des outils tels que etcdctl pour effectuer cette recherche.

4. **Test de d√©ni de service**: Testez la r√©silience de l'API etcd en envoyant un grand nombre de requ√™tes pour voir si elle peut g√©rer la charge sans affecter les autres composants du cluster Kubernetes.

Il est important de noter que toutes les activit√©s de test de p√©n√©tration doivent √™tre effectu√©es avec l'autorisation et la supervision appropri√©es.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller est le composant du serveur de gestion de paquets Helm qui s'ex√©cute dans un cluster Kubernetes. Il est responsable de la gestion des d√©ploiements des charts Helm dans le cluster. Tiller communique avec l'API Kubernetes pour cr√©er, mettre √† jour et supprimer les ressources n√©cessaires pour les d√©ploiements.

En raison de sa nature sensible, Tiller peut pr√©senter des vuln√©rabilit√©s de s√©curit√© qui peuvent √™tre exploit√©es par des attaquants. Il est donc important de prendre des mesures pour s√©curiser Tiller et r√©duire les risques potentiels.

Voici quelques bonnes pratiques pour s√©curiser Tiller :

1. **Limiter les privil√®ges** : Accordez √† Tiller uniquement les privil√®ges n√©cessaires pour effectuer ses t√¢ches. √âvitez de lui donner des privil√®ges excessifs qui pourraient √™tre exploit√©s par des attaquants.

2. **Utiliser l'authentification** : Configurez Tiller pour qu'il utilise l'authentification afin de s'assurer que seules les personnes autoris√©es peuvent acc√©der √† ses fonctionnalit√©s.

3. **Restreindre l'acc√®s r√©seau** : Limitez l'acc√®s r√©seau √† Tiller en utilisant des r√®gles de pare-feu ou en configurant des politiques de r√©seau pour emp√™cher les connexions non autoris√©es.

4. **Mettre √† jour r√©guli√®rement** : Assurez-vous de mettre √† jour r√©guli√®rement Tiller avec les derni√®res versions pour b√©n√©ficier des correctifs de s√©curit√© et des am√©liorations.

5. **Surveiller les journaux** : Surveillez les journaux de Tiller pour d√©tecter toute activit√© suspecte ou des tentatives d'exploitation.

En suivant ces bonnes pratiques, vous pouvez renforcer la s√©curit√© de Tiller et r√©duire les risques potentiels li√©s √† son utilisation dans un cluster Kubernetes.
```
helm --host tiller-deploy.kube-system:44134 version
```
Vous pouvez exploiter ce service pour escalader les privil√®ges √† l'int√©rieur de Kubernetes :

### cAdvisor

Service utile pour collecter des m√©triques.
```
curl -k https://<IP Address>:4194
```
### NodePort

Lorsqu'un port est expos√© sur tous les n≈ìuds via un **NodePort**, le m√™me port est ouvert sur tous les n≈ìuds, acheminant le trafic vers le **Service** d√©clar√©. Par d√©faut, ce port se situe dans la plage **30000-32767**. Ainsi, de nouveaux services non v√©rifi√©s peuvent √™tre accessibles via ces ports.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configurations vuln√©rables

### Acc√®s anonyme √† Kube-apiserver

Par **d√©faut**, les points d'acc√®s de l'API **kube-apiserver** sont **interdits** √† l'acc√®s **anonyme**. Mais il est toujours bon de v√©rifier s'il existe des **points d'acc√®s non s√©curis√©s qui exposent des informations sensibles** :

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### V√©rification de l'acc√®s anonyme √† ETCD

ETCD stocke les secrets du cluster, les fichiers de configuration et d'autres **donn√©es sensibles**. Par **d√©faut**, l'acc√®s √† ETCD ne peut pas √™tre effectu√© de mani√®re anonyme, mais il est toujours bon de v√©rifier.

Si ETCD peut √™tre acc√©d√© de mani√®re anonyme, vous devrez peut-√™tre **utiliser l'outil** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). La commande suivante permettra d'obtenir toutes les cl√©s stock√©es :
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

La [**documentation de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explique que par **d√©faut, l'acc√®s anonyme au service est autoris√©** :

> Autorise les requ√™tes anonymes vers le serveur Kubelet. Les requ√™tes qui ne sont pas rejet√©es par une autre m√©thode d'authentification sont trait√©es comme des requ√™tes anonymes. Les requ√™tes anonymes ont un nom d'utilisateur `system:anonymous` et un nom de groupe `system:unauthenticated`.

Pour mieux comprendre comment **l'authentification et l'autorisation de l'API Kuebelet** fonctionnent, consultez cette page :

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Le **service Kubelet** n'est pas **document√©**, mais le code source peut √™tre trouv√© ici et trouver les points d'acc√®s expos√©s est aussi simple que **d'ex√©cuter** :
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Tous semblent int√©ressants.

Vous pouvez utiliser l'outil [**Kubeletctl**](https://github.com/cyberark/kubeletctl) pour interagir avec les Kubelets et leurs points de terminaison.


#### /pods

Cet endpoint r√©pertorie les pods et leurs conteneurs :
```bash
kubeletctl pods
```
#### /exec

Cet endpoint permet d'ex√©cuter du code √† l'int√©rieur de n'importe quel conteneur tr√®s facilement:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Pour √©viter cette attaque, le service _**kubelet**_ doit √™tre ex√©cut√© avec `--anonymous-auth false` et le service doit √™tre s√©gr√©gu√© au niveau du r√©seau.
{% endhint %}

### **V√©rification de l'exposition des informations du port en lecture seule de Kubelet**

Lorsque le **port en lecture seule de kubelet** est expos√©, l'attaquant peut r√©cup√©rer des informations √† partir de l'API. Cela expose des **√©l√©ments de configuration du cluster, tels que les noms des pods, l'emplacement des fichiers internes et d'autres configurations**. Il ne s'agit pas d'informations critiques, mais elles ne doivent pas √™tre expos√©es √† Internet.

Par exemple, un attaquant distant peut exploiter cela en acc√©dant √† l'URL suivante : `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## R√©f√©rences

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
