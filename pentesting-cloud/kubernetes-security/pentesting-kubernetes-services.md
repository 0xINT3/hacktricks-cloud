# Testes de Penetra√ß√£o em Servi√ßos Kubernetes

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Kubernetes utiliza v√°rios **servi√ßos de rede espec√≠ficos** que voc√™ pode encontrar **expostos √† Internet** ou em uma **rede interna uma vez que voc√™ tenha comprometido um pod**.

## Encontrando pods expostos com OSINT

Uma maneira pode ser procurando por `Identity LIKE "k8s.%.com"` em [crt.sh](https://crt.sh) para encontrar subdom√≠nios relacionados ao kubernetes. Outra maneira pode ser buscar `"k8s.%.com"` no github e procurar por **arquivos YAML** contendo a string.

## Como o Kubernetes Exp√µe Servi√ßos

Pode ser √∫til para voc√™ entender como o Kubernetes pode **expor servi√ßos publicamente** para encontr√°-los:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrando pods expostos via varredura de portas

As seguintes portas podem estar abertas em um cluster Kubernetes:

| Porta            | Processo        | Descri√ß√£o                                                              |
| ---------------- | --------------- | ---------------------------------------------------------------------- |
| 443/TCP          | kube-apiserver  | Porta da API Kubernetes                                                |
| 2379/TCP         | etcd            |                                                                        |
| 6666/TCP         | etcd            | etcd                                                                   |
| 4194/TCP         | cAdvisor        | M√©tricas de cont√™ineres                                                |
| 6443/TCP         | kube-apiserver  | Porta da API Kubernetes                                                |
| 8443/TCP         | kube-apiserver  | Porta da API Minikube                                                  |
| 8080/TCP         | kube-apiserver  | Porta da API insegura                                                  |
| 10250/TCP        | kubelet         | API HTTPS que permite acesso total ao modo                             |
| 10255/TCP        | kubelet         | Porta HTTP somente leitura n√£o autenticada: pods, pods em execu√ß√£o e estado do n√≥ |
| 10256/TCP        | kube-proxy      | Servidor de verifica√ß√£o de sa√∫de do Kube Proxy                         |
| 9099/TCP         | calico-felix    | Servidor de verifica√ß√£o de sa√∫de para Calico                           |
| 6782-4/TCP       | weave           | M√©tricas e endpoints                                                  |
| 30000-32767/TCP  | NodePort        | Proxy para os servi√ßos                                                |
| 44134/TCP        | Tiller          | Servi√ßo Helm escutando                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
```markdown
{% endcode %}

### Kube-apiserver

Este √© o **servi√ßo de API do Kubernetes** com o qual os administradores normalmente se comunicam usando a ferramenta **`kubectl`**.

**Portas comuns: 6443 e 443**, mas tamb√©m 8443 no minikube e 8080 como inseguro.
```
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Consulte a seguinte p√°gina para aprender como obter dados sens√≠veis e realizar a√ß√µes sens√≠veis ao se comunicar com este servi√ßo:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API do Kubelet

Este servi√ßo **opera em cada n√≥ do cluster**. √â o servi√ßo que vai **controlar** os pods dentro do **n√≥**. Ele se comunica com o **kube-apiserver**.

Se voc√™ encontrar este servi√ßo exposto, pode ter encontrado um **RCE n√£o autenticado**.

#### API do Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Se a resposta for `Unauthorized`, ent√£o √© necess√°ria autentica√ß√£o.

Se voc√™ puder listar os n√≥s, voc√™ pode obter uma lista de endpoints dos kubelets com:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Somente leitura)
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API etcd
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller
```
helm --host tiller-deploy.kube-system:44134 version
```
Voc√™ pode abusar deste servi√ßo para escalar privil√©gios dentro do Kubernetes:

### cAdvisor

Servi√ßo √∫til para coletar m√©tricas.
```
curl -k https://<IP Address>:4194
```
### NodePort

Quando uma porta √© exposta em todos os n√≥s via um **NodePort**, a mesma porta √© aberta em todos os n√≥s, direcionando o tr√°fego para o **Service** declarado. Por padr√£o, esta porta estar√° na **faixa de 30000-32767**. Assim, novos servi√ßos n√£o verificados podem ser acess√≠veis atrav√©s dessas portas.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configura√ß√µes Vulner√°veis

### Acesso An√¥nimo ao Kube-apiserver

O acesso an√¥nimo aos **endpoints da API do kube-apiserver n√£o √© permitido**. Mas voc√™ pode verificar alguns endpoints:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Verificando o Acesso An√¥nimo ao ETCD**

O ETCD armazena os segredos do cluster, arquivos de configura√ß√£o e mais **dados sens√≠veis**. Por **padr√£o**, o ETCD **n√£o** pode ser acessado **anonimamente**, mas √© sempre bom verificar.

Se o ETCD puder ser acessado anonimamente, voc√™ pode precisar **usar a** [**ferramenta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). O seguinte comando obter√° todas as chaves armazenadas:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

A [**documenta√ß√£o do Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que por **padr√£o o acesso an√¥nimo** ao servi√ßo √© **permitido:**

> Permite solicita√ß√µes an√¥nimas ao servidor Kubelet. Solicita√ß√µes que n√£o s√£o rejeitadas por outro m√©todo de autentica√ß√£o s√£o tratadas como solicita√ß√µes an√¥nimas. Solicita√ß√µes an√¥nimas t√™m um nome de usu√°rio `system:anonymous` e um nome de grupo `system:unauthenticated`

Para entender melhor como a **autentica√ß√£o e autoriza√ß√£o da API do Kuebelet funcionam**, confira esta p√°gina:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

A **API do servi√ßo Kubelet** **n√£o √© documentada**, mas o c√≥digo-fonte pode ser encontrado aqui e descobrir os endpoints expostos √© t√£o f√°cil quanto **executar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Todos eles parecem interessantes.

Voc√™ pode usar a ferramenta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interagir com Kubelets e seus endpoints.

#### /pods

Este endpoint lista pods e seus containers:
```bash
kubeletctl pods
```
#### /exec

Este endpoint permite executar c√≥digo dentro de qualquer container com muita facilidade:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar esse ataque, o servi√ßo _**kubelet**_ deve ser executado com `--anonymous-auth false` e o servi√ßo deve ser segregado no n√≠vel de rede.
{% endhint %}

### **Verificando Exposi√ß√£o de Informa√ß√µes do Kubelet (Porta Somente Leitura)**

Quando a **porta somente leitura do kubelet** est√° exposta, o atacante pode recuperar informa√ß√µes da API. Isso exp√µe **elementos de configura√ß√£o do cluster, como nomes de pods, localiza√ß√£o de arquivos internos e outras configura√ß√µes**. Essas n√£o s√£o informa√ß√µes cr√≠ticas, mas ainda assim n√£o devem ser expostas √† internet.

Por exemplo, um atacante remoto pode abusar disso acessando a seguinte URL: `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Refer√™ncias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
