# Pentesting Servicios de Kubernetes

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

Kubernetes utiliza varios **servicios de red específicos** que podrías encontrar **expuestos en Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Encontrar pods expuestos con OSINT

Una forma podría ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con Kubernetes. Otra forma podría ser buscar `"k8s.%.com"` en GitHub y buscar archivos **YAML** que contengan la cadena.

## Cómo Kubernetes expone servicios

Podría ser útil que entiendas cómo Kubernetes puede **exponer servicios públicamente** para poder encontrarlos:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrar pods expuestos mediante escaneo de puertos

Los siguientes puertos podrían estar abiertos en un clúster de Kubernetes:

| Puerto          | Proceso        | Descripción                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Métricas de contenedores                                               |
| 6443/TCP        | kube-apiserver | Puerto de la API de Kubernetes                                         |
| 8443/TCP        | kube-apiserver | Puerto de la API de Minikube                                           |
| 8080/TCP        | kube-apiserver | Puerto de la API insegura                                              |
| 10250/TCP       | kubelet        | API HTTPS que permite acceso en modo completo                          |
| 10255/TCP       | kubelet        | Puerto HTTP de solo lectura sin autenticación: pods, pods en ejecución y estado del nodo |
| 10256/TCP       | kube-proxy     | Servidor de verificación de estado de Kube Proxy                       |
| 9099/TCP        | calico-felix   | Servidor de verificación de estado para Calico                         |
| 6782-4/TCP      | weave          | Métricas y puntos finales                                              |
| 30000-32767/TCP | NodePort       | Proxy a los servicios                                                  |
| 44134/TCP       | Tiller         | Servicio de Helm escuchando                                             |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

Este es el servicio **API de Kubernetes** con el que los administradores suelen comunicarse utilizando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero también 8443 en minikube y 8080 como inseguro.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Consulte la siguiente página para aprender cómo obtener datos sensibles y realizar acciones sensibles hablando con este servicio:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API de Kubelet

Este servicio se **ejecuta en cada nodo del clúster**. Es el servicio que **controlará** las vainas dentro del **nodo**. Habla con el **kube-apiserver**.

Si encuentra este servicio expuesto, es posible que haya encontrado una **RCE no autenticada**.

#### API de Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Si la respuesta es `Unauthorized`, entonces requiere autenticación.

Si puedes listar los nodos, puedes obtener una lista de los puntos finales de los kubelets con:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Solo lectura)

El kubelet es un componente esencial en un clúster de Kubernetes. Es responsable de la comunicación con el API server y gestiona los contenedores en los nodos del clúster. El kubelet expone una interfaz de solo lectura que proporciona información sobre el estado de los nodos y los contenedores en ejecución.

Durante una prueba de penetración, es importante evaluar la seguridad del kubelet y asegurarse de que no haya información sensible expuesta a través de su interfaz de solo lectura. Esto incluye información como nombres de contenedores, imágenes utilizadas, variables de entorno y volúmenes montados.

Algunas de las técnicas comunes utilizadas para evaluar la seguridad del kubelet incluyen:

- Enumeración de la API del kubelet: Se puede utilizar herramientas como `kubectl` para enumerar los endpoints expuestos por el kubelet y obtener información sobre los nodos y los contenedores en ejecución.

- Explotación de endpoints inseguros: Si se descubre un endpoint inseguro en el kubelet, se pueden realizar ataques como la enumeración de directorios, la ejecución remota de comandos o la divulgación de información sensible.

- Análisis de metadatos: El kubelet expone metadatos sobre los nodos y los contenedores en ejecución. Estos metadatos pueden contener información sensible que podría ser utilizada para realizar ataques adicionales.

Es importante tener en cuenta que cualquier información sensible obtenida a través del kubelet debe ser tratada con cuidado y no debe ser divulgada o utilizada de manera maliciosa.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API de etcd

El API de etcd es una interfaz de programación de aplicaciones que permite interactuar con el servicio de almacenamiento distribuido etcd. Este servicio es utilizado por Kubernetes para almacenar y recuperar información de configuración, como datos de estado y metadatos.

El API de etcd proporciona una serie de endpoints que permiten realizar operaciones CRUD (crear, leer, actualizar y eliminar) en los datos almacenados en etcd. Estos endpoints incluyen:

- `/v2/keys`: Permite crear, leer, actualizar y eliminar claves y valores en etcd.
- `/v2/keys/{key}`: Permite realizar operaciones específicas en una clave determinada, como obtener su valor, actualizarlo o eliminarlo.
- `/v2/keys/{directory}`: Permite realizar operaciones en un directorio específico, como obtener una lista de claves contenidas en el directorio o eliminar el directorio y todas sus claves.

El API de etcd utiliza el formato JSON para representar los datos que se envían y reciben a través de las solicitudes HTTP. Esto permite una fácil integración con otras aplicaciones y herramientas.

Es importante tener en cuenta la seguridad al interactuar con el API de etcd. Se deben implementar medidas de autenticación y autorización adecuadas para proteger los datos almacenados en etcd y prevenir posibles ataques.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller es el componente del servidor de Kubernetes que gestiona las operaciones de despliegue de las aplicaciones en el clúster. Es responsable de recibir las solicitudes de despliegue de Helm y coordinar la instalación de los recursos en el clúster.

Durante una evaluación de seguridad de Kubernetes, es importante realizar pruebas de penetración en el componente Tiller para identificar posibles vulnerabilidades. Algunas de las técnicas comunes utilizadas en las pruebas de penetración de Tiller incluyen:

1. Enumeración de servicios Tiller: Identificar los servicios Tiller en el clúster y recopilar información sobre ellos, como las versiones utilizadas y los permisos asociados.

2. Escaneo de puertos: Realizar un escaneo de puertos en los servicios Tiller para identificar posibles puertos abiertos y servicios expuestos.

3. Prueba de credenciales débiles: Intentar autenticarse en los servicios Tiller utilizando credenciales débiles o predeterminadas para identificar posibles vulnerabilidades de autenticación.

4. Inyección de comandos: Intentar inyectar comandos maliciosos en las solicitudes de despliegue de Helm para ejecutar código arbitrario en el clúster.

5. Ataques de denegación de servicio (DoS): Realizar ataques de denegación de servicio contra los servicios Tiller para evaluar su resistencia y capacidad de recuperación.

Es importante tener en cuenta que estas técnicas deben ser realizadas con el permiso y la autorización adecuados, y solo en entornos controlados y autorizados.
```
helm --host tiller-deploy.kube-system:44134 version
```
Puedes abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio útil para recopilar métricas.
```
curl -k https://<IP Address>:4194
```
### NodePort

Cuando se expone un puerto en todos los nodos a través de un **NodePort**, el mismo puerto se abre en todos los nodos para redirigir el tráfico hacia el **Service** declarado. Por defecto, este puerto estará en el **rango 30000-32767**. Por lo tanto, nuevos servicios no verificados podrían ser accesibles a través de esos puertos.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configuraciones vulnerables

### Acceso anónimo a Kube-apiserver

Por **defecto**, los puntos de acceso de la API de **kube-apiserver** están **prohibidos** para el acceso **anónimo**. Pero siempre es una buena idea verificar si hay algún punto de acceso **inseguro que exponga información sensible**:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### Verificación de acceso anónimo a ETCD

El ETCD almacena los secretos del clúster, archivos de configuración y más **datos sensibles**. Por **defecto**, el ETCD **no** puede ser accedido **anónimamente**, pero siempre es bueno verificar.

Si se puede acceder al ETCD de forma anónima, es posible que necesite **utilizar la** [**herramienta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). El siguiente comando obtendrá todas las claves almacenadas:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **RCE de Kubelet**

La [**documentación de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que, de forma predeterminada, se permite el **acceso anónimo** al servicio:

> Habilita las solicitudes anónimas al servidor Kubelet. Las solicitudes que no son rechazadas por otro método de autenticación se tratan como solicitudes anónimas. Las solicitudes anónimas tienen un nombre de usuario `system:anonymous` y un nombre de grupo `system:unauthenticated`.

Para comprender mejor cómo funciona la **autenticación y autorización de la API de Kubelet**, consulta esta página:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

El **servicio Kubelet** no está **documentado**, pero el código fuente se puede encontrar aquí y encontrar los puntos finales expuestos es tan fácil como **ejecutar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Todos ellos suenan interesantes.

Puedes usar la herramienta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interactuar con los Kubelets y sus puntos finales.


#### /pods

Este punto final lista los pods y sus contenedores:
```bash
kubeletctl pods
```
#### /exec

Este punto final permite ejecutar código dentro de cualquier contenedor de manera muy sencilla:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar este ataque, el servicio _**kubelet**_ debe ejecutarse con `--anonymous-auth false` y el servicio debe estar segregado a nivel de red.
{% endhint %}

### **Comprobación de la exposición de información del puerto de solo lectura de Kubelet**

Cuando el puerto de solo lectura de **kubelet** está expuesto, el atacante puede obtener información de la API. Esto expone elementos de configuración del clúster, como nombres de pods, ubicación de archivos internos y otras configuraciones. Esta información no es crítica, pero aún así no debería estar expuesta a Internet.

Por ejemplo, un atacante remoto puede abusar de esto accediendo a la siguiente URL: `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
