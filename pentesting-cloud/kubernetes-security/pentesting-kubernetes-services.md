# Pentesting Kubernetes Services

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

O Kubernetes usa v√°rios **servi√ßos de rede espec√≠ficos** que voc√™ pode encontrar **expostos √† Internet** ou em uma **rede interna depois de comprometer um pod**.

## Encontrando pods expostos com OSINT

Uma maneira pode ser procurar por `Identity LIKE "k8s.%.com"` em [crt.sh](https://crt.sh) para encontrar subdom√≠nios relacionados ao Kubernetes. Outra maneira pode ser pesquisar `"k8s.%.com"` no github e procurar por **arquivos YAML** contendo a string.

## Como o Kubernetes exp√µe servi√ßos

Pode ser √∫til entender como o Kubernetes pode **expor servi√ßos publicamente** para encontr√°-los:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrando pods expostos por meio de varredura de porta

As seguintes portas podem estar abertas em um cluster Kubernetes:

| Porta           | Processo       | Descri√ß√£o                                                               |
| --------------- | -------------- | ----------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Porta da API do Kubernetes                                              |
| 2379/TCP        | etcd           |                                                                         |
| 6666/TCP        | etcd           | etcd                                                                    |
| 4194/TCP        | cAdvisor       | M√©tricas de cont√™iner                                                   |
| 6443/TCP        | kube-apiserver | Porta da API do Kubernetes                                              |
| 8443/TCP        | kube-apiserver | Porta da API do Minikube                                                |
| 8080/TCP        | kube-apiserver | Porta da API insegura                                                   |
| 10250/TCP       | kubelet        | API HTTPS que permite acesso em modo completo                           |
| 10255/TCP       | kubelet        | Porta HTTP somente leitura n√£o autenticada: pods, pods em execu√ß√£o e estado do n√≥ |
| 10256/TCP       | kube-proxy     | Servidor de verifica√ß√£o de integridade do Kube Proxy                     |
| 9099/TCP        | calico-felix   | Servidor de verifica√ß√£o de integridade do Calico                         |
| 6782-4/TCP      | weave          | M√©tricas e endpoints                                                     |
| 30000-32767/TCP | NodePort       | Proxy para os servi√ßos                                                   |
| 44134/TCP       | Tiller         | Servi√ßo Helm ouvindo                                                     |

### Nmap

```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```

### Kube-apiserver

Este √© o **servi√ßo API do Kubernetes** com o qual os administradores geralmente falam usando a ferramenta **`kubectl`**.

**Portas comuns: 6443 e 443**, mas tamb√©m 8443 no minikube e 8080 como inseguro.

```
curl -k https://<Endere√ßo IP>:(8|6)443/swaggerapi
curl -k https://<Endere√ßo IP>:(8|6)443/healthz
curl -k https://<Endere√ßo IP>:(8|6)443/api/v1
```

**Verifique a seguinte p√°gina para aprender como obter dados sens√≠veis e executar a√ß√µes sens√≠veis falando com este servi√ßo:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Este servi√ßo **√© executado em todos os n√≥s do cluster**. √â o servi√ßo que **controlar√°** os pods dentro do **n√≥**