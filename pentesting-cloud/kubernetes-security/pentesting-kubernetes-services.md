# Testando a seguran√ßa dos servi√ßos do Kubernetes

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

O Kubernetes utiliza v√°rios **servi√ßos de rede espec√≠ficos** que voc√™ pode encontrar **expostos √† Internet** ou em uma **rede interna ap√≥s comprometer um pod**.

## Encontrando pods expostos com OSINT

Uma maneira pode ser pesquisar por `Identity LIKE "k8s.%.com"` em [crt.sh](https://crt.sh) para encontrar subdom√≠nios relacionados ao Kubernetes. Outra maneira pode ser pesquisar `"k8s.%.com"` no GitHub e procurar por arquivos **YAML** que contenham a string.

## Como o Kubernetes exp√µe servi√ßos

Pode ser √∫til entender como o Kubernetes pode **expor servi√ßos publicamente** para encontr√°-los:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrando pods expostos por meio de varredura de portas

As seguintes portas podem estar abertas em um cluster Kubernetes:

| Porta           | Processo       | Descri√ß√£o                                                              |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Porta da API do Kubernetes                                             |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | M√©tricas de cont√™ineres                                                |
| 6443/TCP        | kube-apiserver | Porta da API do Kubernetes                                             |
| 8443/TCP        | kube-apiserver | Porta da API do Minikube                                               |
| 8080/TCP        | kube-apiserver | Porta da API insegura                                                  |
| 10250/TCP       | kubelet        | API HTTPS que permite acesso em modo completo                          |
| 10255/TCP       | kubelet        | Porta HTTP somente leitura n√£o autenticada: pods, pods em execu√ß√£o e estado do n√≥ |
| 10256/TCP       | kube-proxy     | Servidor de verifica√ß√£o de integridade do Kube Proxy                   |
| 9099/TCP        | calico-felix   | Servidor de verifica√ß√£o de integridade para Calico                     |
| 6782-4/TCP      | weave          | M√©tricas e endpoints                                                   |
| 30000-32767/TCP | NodePort       | Proxy para os servi√ßos                                                 |
| 44134/TCP       | Tiller         | Servi√ßo Helm ouvindo                                                   |

### Nmap
```
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
### Kube-apiserver

Este √© o servi√ßo **API do Kubernetes** com o qual os administradores geralmente interagem usando a ferramenta **`kubectl`**.

**Portas comuns: 6443 e 443**, mas tamb√©m 8443 no minikube e 8080 como inseguro.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Verifique a seguinte p√°gina para aprender como obter dados sens√≠veis e realizar a√ß√µes sens√≠veis falando com este servi√ßo:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### API do Kubelet

Este servi√ßo **roda em cada n√≥ do cluster**. √â o servi√ßo que ir√° **controlar** os pods dentro do **n√≥**. Ele se comunica com o **kube-apiserver**.

Se voc√™ encontrar este servi√ßo exposto, pode ter encontrado uma **RCE n√£o autenticada**.

#### API do Kubelet
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
Se a resposta for `N√£o autorizado`, ent√£o requer autentica√ß√£o.

Se voc√™ pode listar n√≥s, pode obter uma lista de endpoints kubelets com:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Apenas Leitura)

O kubelet √© um componente cr√≠tico no ecossistema do Kubernetes. Ele √© respons√°vel por gerenciar os containers em um n√≥ espec√≠fico do cluster. O kubelet exp√µe v√°rias APIs que podem ser usadas para obter informa√ß√µes sobre os containers em execu√ß√£o, como o status, os logs e as m√©tricas.

Durante um teste de penetra√ß√£o, √© importante verificar se o kubelet est√° configurado corretamente e se n√£o h√° informa√ß√µes sens√≠veis expostas. Uma configura√ß√£o incorreta pode permitir que um invasor obtenha acesso n√£o autorizado √†s informa√ß√µes do kubelet ou at√© mesmo execute comandos no n√≥.

Alguns pontos de verifica√ß√£o importantes durante um teste de penetra√ß√£o no kubelet incluem:

- Verificar se o kubelet est√° configurado para permitir apenas conex√µes seguras (HTTPS) e se o certificado usado √© v√°lido.
- Verificar se n√£o h√° informa√ß√µes sens√≠veis, como tokens de autentica√ß√£o, expostas no kubelet.
- Verificar se o kubelet est√° configurado para restringir o acesso a determinados IPs ou faixas de IP.
- Verificar se o kubelet est√° configurado para restringir as permiss√µes de acesso √†s APIs expostas.

Essas verifica√ß√µes ajudam a garantir que o kubelet esteja configurado de forma segura e que n√£o haja informa√ß√µes sens√≠veis expostas, reduzindo assim o risco de um ataque bem-sucedido.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### API etcd

O etcd √© um armazenamento de chave-valor distribu√≠do usado pelo Kubernetes para armazenar informa√ß√µes de configura√ß√£o e estado do cluster. O etcd API √© uma interface que permite interagir com o etcd para recuperar, criar, atualizar e excluir chaves e valores.

#### Descobrindo o endpoint do etcd API

Para descobrir o endpoint do etcd API em um cluster Kubernetes, voc√™ pode usar o seguinte comando:

```bash
kubectl get endpoints etcd -n kube-system
```

Isso retornar√° o endpoint do etcd API, que geralmente √© um servi√ßo chamado `etcd` no namespace `kube-system`.

#### Testando a conectividade com o etcd API

Voc√™ pode testar a conectividade com o etcd API usando o seguinte comando:

```bash
curl -k https://<etcd-endpoint>:2379/health
```

Substitua `<etcd-endpoint>` pelo endpoint do etcd API obtido anteriormente. Se a resposta for `{"health":"true"}`, isso indica que a conex√£o com o etcd API est√° funcionando corretamente.

#### Explorando o etcd API

Uma vez conectado ao etcd API, voc√™ pode explorar as chaves e valores armazenados usando os seguintes comandos:

- Listar todas as chaves:

```bash
curl -k https://<etcd-endpoint>:2379/v3alpha/kv/range -X POST -d '{"key": "\u0000", "range_end": "\uffff", "limit": 1000}'
```

- Obter o valor de uma chave espec√≠fica:

```bash
curl -k https://<etcd-endpoint>:2379/v3alpha/kv/range -X POST -d '{"key": "<chave>"}'
```

Substitua `<chave>` pela chave espec√≠fica que voc√™ deseja obter o valor.

- Criar uma nova chave:

```bash
curl -k https://<etcd-endpoint>:2379/v3alpha/kv/put -X POST -d '{"key": "<chave>", "value": "<valor>"}'
```

Substitua `<chave>` pela chave que voc√™ deseja criar e `<valor>` pelo valor correspondente.

- Atualizar o valor de uma chave existente:

```bash
curl -k https://<etcd-endpoint>:2379/v3alpha/kv/put -X POST -d '{"key": "<chave>", "value": "<novo-valor>"}'
```

Substitua `<chave>` pela chave que voc√™ deseja atualizar e `<novo-valor>` pelo novo valor correspondente.

- Excluir uma chave:

```bash
curl -k https://<etcd-endpoint>:2379/v3alpha/kv/deleterange -X POST -d '{"key": "<chave>"}'
```

Substitua `<chave>` pela chave que voc√™ deseja excluir.

#### Considera√ß√µes de seguran√ßa

Ao explorar o etcd API, tenha em mente que voc√™ est√° lidando com informa√ß√µes sens√≠veis do cluster Kubernetes. Certifique-se de ter as permiss√µes adequadas e de que suas a√ß√µes n√£o afetem a integridade ou a disponibilidade do cluster.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller √© o componente do Kubernetes respons√°vel por gerenciar as opera√ß√µes de implanta√ß√£o do Helm. Ele √© respons√°vel por receber os comandos do Helm e interagir com o Kubernetes API Server para implantar os recursos no cluster.

Durante um teste de penetra√ß√£o em servi√ßos Kubernetes, √© importante verificar a seguran√ßa do Tiller, pois ele pode ser um ponto de entrada para ataques. Aqui est√£o algumas t√©cnicas comuns de teste de penetra√ß√£o que podem ser aplicadas ao Tiller:

1. Enumera√ß√£o de vers√£o: Identificar a vers√£o do Tiller instalada no cluster pode fornecer informa√ß√µes valiosas para um atacante. Isso pode ser feito usando comandos como `helm version` ou consultando o endpoint `/version` do Tiller.

2. Verifica√ß√£o de credenciais padr√£o: O Tiller pode ser configurado com credenciais padr√£o, o que pode ser um risco de seguran√ßa. Verifique se as credenciais padr√£o foram alteradas para evitar acesso n√£o autorizado.

3. Explora√ß√£o de vulnerabilidades conhecidas: Pesquise por vulnerabilidades conhecidas no Tiller e verifique se o cluster est√° atualizado com as corre√ß√µes mais recentes. Isso pode ser feito usando ferramentas de verifica√ß√£o de vulnerabilidades ou consultando bancos de dados de vulnerabilidades.

4. Ataques de for√ßa bruta: Se as credenciais do Tiller forem desconhecidas, um atacante pode tentar realizar ataques de for√ßa bruta para obter acesso n√£o autorizado. Isso pode ser feito usando ferramentas como Hydra ou Medusa.

5. Inje√ß√£o de comandos: Se um atacante obtiver acesso ao Tiller, ele pode tentar injetar comandos maliciosos para executar a√ß√µes n√£o autorizadas no cluster. Verifique se o Tiller est√° protegido contra inje√ß√£o de comandos.

6. Escala√ß√£o de privil√©gios: Se um atacante obtiver acesso ao Tiller com privil√©gios limitados, ele pode tentar escalar seus privil√©gios para obter acesso a recursos sens√≠veis no cluster. Verifique se o Tiller est√° configurado corretamente para evitar a escalada de privil√©gios.

Lembre-se de que essas t√©cnicas devem ser realizadas apenas em ambientes controlados e com permiss√£o adequada. A seguran√ßa do Tiller √© crucial para garantir a integridade e a confidencialidade dos recursos implantados no cluster Kubernetes.
```
helm --host tiller-deploy.kube-system:44134 version
```
Voc√™ pode abusar desse servi√ßo para elevar privil√©gios dentro do Kubernetes:

### cAdvisor

Servi√ßo √∫til para coletar m√©tricas.
```
curl -k https://<IP Address>:4194
```
### NodePort

Quando uma porta √© exposta em todos os n√≥s atrav√©s de um **NodePort**, a mesma porta √© aberta em todos os n√≥s, encaminhando o tr√°fego para o **Service** declarado. Por padr√£o, essa porta estar√° no intervalo de **30000-32767**. Portanto, novos servi√ßos n√£o verificados podem ser acess√≠veis por meio dessas portas.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Configura√ß√µes Vulner√°veis

### Acesso An√¥nimo ao Kube-apiserver

Por **padr√£o**, os pontos de API do **kube-apiserver** s√£o **proibidos** para acesso **an√¥nimo**. Mas √© sempre uma boa ideia verificar se existem **pontos de extremidade inseguros que exp√µem informa√ß√µes sens√≠veis**:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### Verificando o Acesso An√¥nimo ao ETCD

O ETCD armazena segredos do cluster, arquivos de configura√ß√£o e outros **dados sens√≠veis**. Por **padr√£o**, o ETCD **n√£o pode** ser acessado **anonimamente**, mas √© sempre bom verificar.

Se o ETCD puder ser acessado anonimamente, voc√™ pode precisar **usar a** [**ferramenta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). O seguinte comando ir√° obter todas as chaves armazenadas:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

A documenta√ß√£o do [**Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que, por padr√£o, o acesso an√¥nimo ao servi√ßo √© permitido:

> Permite solicita√ß√µes an√¥nimas ao servidor Kubelet. Solicita√ß√µes que n√£o s√£o rejeitadas por outro m√©todo de autentica√ß√£o s√£o tratadas como solicita√ß√µes an√¥nimas. Solicita√ß√µes an√¥nimas t√™m um nome de usu√°rio `system:anonymous` e um nome de grupo `system:unauthenticated`.

Para entender melhor como a autentica√ß√£o e autoriza√ß√£o da API do **Kubelet** funcionam, verifique esta p√°gina:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

A API do servi√ßo **Kubelet** n√£o est√° documentada, mas o c√≥digo-fonte pode ser encontrado aqui e encontrar os endpoints expostos √© t√£o f√°cil quanto **executar**:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Todos eles parecem interessantes.

Voc√™ pode usar a ferramenta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interagir com os Kubelets e seus endpoints.


#### /pods

Este endpoint lista os pods e seus containers:
```bash
kubeletctl pods
```
#### /exec

Este endpoint permite executar c√≥digo dentro de qualquer container de forma muito f√°cil:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Para evitar esse ataque, o servi√ßo _**kubelet**_ deve ser executado com `--anonymous-auth false` e o servi√ßo deve ser segregado no n√≠vel de rede.
{% endhint %}

### **Verificando a Exposi√ß√£o de Informa√ß√µes do Porta de Leitura Apenas do Kubelet**

Quando a **porta de leitura apenas do kubelet** est√° exposta, o atacante pode recuperar informa√ß√µes da API. Isso exp√µe **elementos de configura√ß√£o do cluster, como nomes de pods, localiza√ß√£o de arquivos internos e outras configura√ß√µes**. Essas informa√ß√µes n√£o s√£o cr√≠ticas, mas ainda assim n√£o devem ser expostas √† internet.

Por exemplo, um atacante remoto pode abusar disso acessando a seguinte URL: `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Refer√™ncias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
