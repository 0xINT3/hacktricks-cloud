# Pentesting Kubernetes Dienste

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

Kubernetes maak gebruik van verskeie **spesifieke netwerkdienste** wat jy dalk **blootgestel aan die internet** of in 'n **interne netwerk kan vind as jy een pod gekompromitteer het**.

## Vind blootgestelde pods met OSINT

Een manier kan wees om te soek na `Identity LIKE "k8s.%.com"` in [crt.sh](https://crt.sh) om subdomeine wat verband hou met Kubernetes te vind. 'n Ander manier kan wees om te soek na `"k8s.%.com"` in GitHub en te soek na **YAML-l√™ers** wat die string bevat.

## Hoe Kubernetes Dienste Blootstel

Dit kan nuttig wees vir jou om te verstaan hoe Kubernetes dienste **openlik kan blootstel** om hulle te vind:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Vind blootgestelde pods deur poortskandering

Die volgende poorte kan oop wees in 'n Kubernetes-kluster:

| Poort           | Proses         | Beskrywing                                                             |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API-poort                                                   |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | Houermetriek                                                          |
| 6443/TCP        | kube-apiserver | Kubernetes API-poort                                                   |
| 8443/TCP        | kube-apiserver | Minikube API-poort                                                     |
| 8080/TCP        | kube-apiserver | Onveilige API-poort                                                    |
| 10250/TCP       | kubelet        | HTTPS API wat volle toegang toelaat                                    |
| 10255/TCP       | kubelet        | Ongeagte lees-slegs HTTP-poort: pods, lopende pods en nodestatus       |
| 10256/TCP       | kube-proxy     | Kube Proxy gesondheidskontroleserver                                   |
| 9099/TCP        | calico-felix   | Gesondheidskontroleserver vir Calico                                   |
| 6782-4/TCP      | weave          | Metriek en eindpunte                                                   |
| 30000-32767/TCP | NodePort       | Proksi na die dienste                                                  |
| 44134/TCP       | Tiller         | Helm-diens wat luister                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

Dit is die **API Kubernetes-diens** waarmee administrateurs gewoonlik kommunikeer met die hulpmiddel **`kubectl`**.

**Gewone poorte: 6443 en 443**, maar ook 8443 in minikube en 8080 as onveilig.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**Kyk na die volgende bladsy om te leer hoe om sensitiewe data te verkry en sensitiewe aksies uit te voer deur met hierdie diens te praat:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Hierdie diens **loop op elke nodus van die groep**. Dit is die diens wat die peule binne die **nodus** sal **beheer**. Dit praat met die **kube-apiserver**.

As jy hierdie diens blootgestel vind, het jy moontlik 'n **ongeagte RCE** gevind.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
As die antwoord `Unauthorized` is, vereis dit verifikasie.

As jy 'n lys van knooppunte kan kry, kan jy 'n lys van kubelet-eindpunte kry met:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (Slegs lees)

Die kubelet is 'n Kubernetes-diens wat op elke werker-node hardloop en verantwoordelik is vir die bestuur van die pods op daardie node. Dit kommunikeer met die API-diens van die kube-apiserver om instruksies te ontvang en te verslag oor die status van die pods.

As 'n aanvaller toegang tot die kubelet kan verkry, kan dit sensitiewe inligting oor die pods en die werker-node blootstel. Dit kan ook gebruik word om die pods te manipuleer of te beskadig.

Hier is 'n paar pentesting-tegnieke wat gebruik kan word om die kubelet te ondersoek:

- **Kubelet API-aanvalle**: Aanvallers kan probeer om die kubelet API te misbruik deur ongeldige versoeke te stuur of swak ge√Ømplementeerde sekuriteitsmaatre√´ls te omseil.
- **Kubelet-konfigurasie**: Deur die kubelet-konfigurasie te ondersoek, kan aanvallers moontlike swakpunte identifiseer en uitbuit.
- **Kubelet-loginspeksie**: Deur die kubelet-logl√™ers te ondersoek, kan aanvallers inligting verkry oor die aktiwiteite en gebeure wat plaasvind op die werker-node.

Dit is belangrik om die kubelet se sekuriteitsmaatre√´ls te versterk en te verseker dat slegs geakkrediteerde gebruikers toegang tot die kubelet het.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

Die etcd API is 'n sleutel-waarde stoor diens wat gebruik word deur Kubernetes om konfigurasie-inligting te stoor. Dit is belangrik om die veiligheid van die etcd API te toets tydens 'n pentesting-aanval. Hier is 'n paar tegnieke wat gebruik kan word om die veiligheid van die etcd API te ondersoek:

#### 1. Skandeer vir blootgestelde etcd dienste
Voer 'n skandering uit om te kyk of daar enige blootgestelde etcd dienste is. Dit kan gedoen word deur die IP-adresse en poort van die Kubernetes-meester te skandeer.

#### 2. Identifiseer die etcd API-endpunt
As 'n blootgestelde etcd diens gevind word, moet die API-endpunt ge√Ødentifiseer word. Dit kan gedoen word deur na die standaard etcd-poorte te soek, soos 2379 en 2380.

#### 3. Voer 'n verbindingstoets uit
Om te bevestig dat die etcd API toeganklik is, kan 'n eenvoudige verbindingstoets uitgevoer word deur 'n HTTP GET-versoek na die API-endpunt te stuur.

#### 4. Identifiseer onveilige konfigurasies
Deur die etcd API te ondersoek, kan onveilige konfigurasies ge√Ødentifiseer word. Dit kan insluit die gebruik van standaardgelde, swak wagwoorde, of onbeperkte toegang tot die etcd sleutel-waarde stoor.

#### 5. Voer aanvalle uit teen die etcd API
As daar onveilige konfigurasies gevind word, kan aanvalle uitgevoer word teen die etcd API. Dit kan insluit die lees, skryf of verwyder van sleutels, die skep van nuwe sleutels, of die manipuleer van bestaande sleutels.

#### 6. Monitor die etcd API-verkeer
Deur die etcd API-verkeer te monitor, kan verdagte aktiwiteite opgespoor word. Dit kan gedoen word deur die verkeer te onderskep en te analiseer met behulp van hulpmiddels soos tcpdump of Wireshark.

#### 7. Rapporteer bevindings
Alle bevindings en kwesbaarhede moet duidelik gerapporteer word aan die relevante partye, soos die Kubernetes-beheerders of die organisasie wat die Kubernetes-infrastruktuur bestuur.

Dit is belangrik om die etcd API te toets en te monitor tydens 'n pentesting-aanval om die veiligheid van die Kubernetes-infrastruktuur te verseker.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller is die server-side komponent van Helm, 'n Kubernetes-pakketbestuurder. Dit is verantwoordelik vir die hantering van die installasie en bestuur van Helm-charts op die Kubernetes-klasterverbinding. Tiller is 'n belangrike teiken vir aanvalle, aangesien dit toegang het tot die Kubernetes API en die vermo√´ het om hulpbronne te skep, wysig en verwyder. Dit is belangrik om Tiller se sekuriteit te verseker deur die implementering van toepaslike maatre√´ls soos die beperking van toegang, die gebruik van sterk wagwoorde en die beperking van Tiller se regte.
```
helm --host tiller-deploy.kube-system:44134 version
```
Jy kan hierdie diens misbruik om voorregte binne Kubernetes te verhoog:

### cAdvisor

'n Diens wat nuttig is om metriek te versamel.
```
curl -k https://<IP Address>:4194
```
### NodePort

Wanneer 'n poort blootgestel word in alle nodus deur middel van 'n **NodePort**, word dieselfde poort oopgemaak in al die nodusse en word die verkeer gelei na die gedeclareerde **Service**. Standaard sal hierdie poort in die **reeks 30000-32767** wees. Dus kan nuwe ongekontroleerde dienste toeganklik wees deur middel van hierdie poorte.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## Kwesbare Misconfigurations

### Kube-apiserver Anonieme Toegang

Anonieme toegang tot **kube-apiserver API-eindpunten is nie toegelaat** nie. Maar jy kan sekere eindpunte nagaan:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Nagaan vir ETCD Anonieme Toegang**

Die ETCD stoor die groep secrete, konfigurasie l√™ers en meer **sensitiewe data**. Standaard kan die ETCD nie anoniem benader word nie, maar dit is altyd goed om te nagaan.

As die ETCD anoniem benader kan word, mag jy dalk die **etcdctl** [**hulpmiddel**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) moet gebruik. Die volgende bevel sal al die gestoorde sleutels kry:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

Die [**Kubelet-dokumentasie**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) verduidelik dat **standaard anonieme toegang tot die diens toegelaat word:**

> Stel anonieme versoek aan die Kubelet-bediener in staat. Versoeke wat nie deur 'n ander verifikasiemetode afgekeur word nie, word as anonieme versoek behandel. Anonieme versoek het 'n gebruikersnaam van `system:anonymous` en 'n groepnaam van `system:unauthenticated`.

Om beter te verstaan hoe die **verifikasie en magtiging van die Kuebelet API werk**, kyk na hierdie bladsy:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Die **Kubelet**-diens **API is nie gedokumenteer nie**, maar die bronkode kan hier gevind word en dit is so maklik soos **om uit te voer** om die blootgestelde eindpunte te vind:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
Almal van hulle klink interessant.

Jy kan die [**Kubeletctl**](https://github.com/cyberark/kubeletctl) instrument gebruik om met Kubelets en hul eindpunte te kommunikeer.

#### /pods

Hierdie eindpunt lys pods en hul houers:
```bash
kubeletctl pods
```
#### /uitvoer

Hierdie eindpunt maak dit baie maklik om kode binne enige houer uit te voer:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
Om hierdie aanval te voorkom, moet die _**kubelet**_ diens uitgevoer word met `--anonymous-auth false` en die diens moet op netwerkniveau geskei word.
{% endhint %}

### **Nagaan van Kubelet (Lees Slegs Poort) Inligting Blootstelling**

Wanneer 'n **kubelet lees-slegs poort** blootgestel word, word dit moontlik om inligting van die API deur ongemagtigde partye te onttrek. Die blootstelling van hierdie poort kan lei tot die bekendmaking van verskeie **klusterkonfigurasie-elemente**. Alhoewel die inligting, insluitend **pod name, ligging van interne l√™ers, en ander konfigurasies**, nie noodwendig krities is nie, stel die blootstelling daarvan steeds 'n veiligheidsrisiko en moet vermy word.

'n Voorbeeld van hoe hierdie kwesbaarheid uitgebuit kan word, behels 'n afgele√´ aanvaller wat toegang verkry tot 'n spesifieke URL. Deur na `http://<external-IP>:10255/pods` te navigeer, kan die aanvaller potensieel sensitiewe inligting van die kubelet onttrek:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Verwysings

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
