# Kubernetes 서비스의 Pentesting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)을 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

Kubernetes는 여러 **특정 네트워크 서비스**를 사용하며, 이러한 서비스는 **인터넷에 노출**되거나 **하나의 pod를 침투한 후 내부 네트워크에서 찾을 수 있습니다**.

## OSINT를 통한 노출된 pod 찾기

하나의 방법은 [crt.sh](https://crt.sh)에서 `Identity LIKE "k8s.%.com"`을 검색하여 kubernetes와 관련된 하위 도메인을 찾는 것입니다. 또 다른 방법은 github에서 `"k8s.%.com"`을 검색하고 해당 문자열을 포함하는 **YAML 파일**을 찾는 것일 수 있습니다.

## Kubernetes가 서비스를 노출하는 방법

서비스를 **공개적으로 노출**할 수 있는 Kubernetes의 작동 방식을 이해하는 것이 유용할 수 있습니다:

{% content-ref url="exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## 포트 스캐닝을 통한 노출된 pod 찾기

다음 포트는 Kubernetes 클러스터에서 열릴 수 있습니다:

| 포트            | 프로세스        | 설명                                                            |
| --------------- | -------------- | ---------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API 포트                                                    |
| 2379/TCP        | etcd           |                                                                        |
| 6666/TCP        | etcd           | etcd                                                                   |
| 4194/TCP        | cAdvisor       | 컨테이너 메트릭                                                      |
| 6443/TCP        | kube-apiserver | Kubernetes API 포트                                                    |
| 8443/TCP        | kube-apiserver | Minikube API 포트                                                      |
| 8080/TCP        | kube-apiserver | 보안되지 않은 API 포트                                                      |
| 10250/TCP       | kubelet        | 전체 모드 액세스를 허용하는 HTTPS API                                |
| 10255/TCP       | kubelet        | 인증되지 않은 읽기 전용 HTTP 포트: pods, running pods 및 node state |
| 10256/TCP       | kube-proxy     | Kube Proxy 상태 확인 서버                                         |
| 9099/TCP        | calico-felix   | Calico를 위한 상태 확인 서버                                         |
| 6782-4/TCP      | weave          | 메트릭 및 엔드포인트                                                  |
| 30000-32767/TCP | NodePort       | 서비스로의 프록시                                                  |
| 44134/TCP       | Tiller         | Helm 서비스 수신 대기                                                 |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

이것은 일반적으로 관리자가 도구 **`kubectl`**을 사용하여 대화하는 **API Kubernetes 서비스**입니다.

**일반 포트: 6443 및 443**, 그리고 minikube에서는 8443, 보안이 없는 경우 8080도 사용됩니다.
```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```
**다음 페이지를 확인하여 민감한 데이터를 얻고 이 서비스와 통신하여 민감한 작업을 수행하는 방법을 알아보세요:**

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

이 서비스는 **클러스터의 모든 노드에서 실행**됩니다. 이 서비스는 **노드** 내부의 **파드를 제어**하는 역할을 합니다. 이 서비스는 **kube-apiserver**와 통신합니다.

만약 이 서비스가 노출되어 있다면, **인증되지 않은 원격 코드 실행(RCE)** 취약점을 발견한 것일 수 있습니다.

#### Kubelet API
```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```
만약 응답이 `Unauthorized`라면 인증이 필요합니다.

노드 목록을 나열할 수 있다면 다음과 같이 kubelet 엔드포인트 목록을 얻을 수 있습니다:
```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```
#### kubelet (읽기 전용)

The kubelet is the primary node agent that runs on each node in a Kubernetes cluster. It is responsible for managing the containers and their lifecycle on the node. As a pentester, you can gather valuable information by exploiting the read-only access of the kubelet.

##### Exploiting kubelet's read-only access

1. **Enumerating running pods**: Use the `/pods` endpoint to list all the running pods on the node. This can provide information about the applications and services running on the cluster.

2. **Accessing pod logs**: Utilize the `/pods/{pod_name}/log` endpoint to retrieve the logs of a specific pod. This can help in identifying any sensitive information or potential vulnerabilities.

3. **Reading pod metadata**: Use the `/pods/{pod_name}` endpoint to access the metadata of a pod. This can include details such as labels, annotations, and other configuration information.

4. **Checking pod status**: Utilize the `/pods/{pod_name}/status` endpoint to check the status of a pod. This can provide information about the health and availability of the pod.

5. **Inspecting pod environment variables**: Use the `/pods/{pod_name}/env` endpoint to view the environment variables set for a pod. This can reveal sensitive information or potential misconfigurations.

6. **Examining pod volumes**: Utilize the `/pods/{pod_name}/volumes` endpoint to inspect the volumes attached to a pod. This can provide insights into the storage configuration and potential security risks.

By leveraging the read-only access of the kubelet, you can gather valuable information about the running pods, their logs, metadata, status, environment variables, and volumes. This information can be used to identify potential vulnerabilities and misconfigurations in the Kubernetes cluster.
```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```
### etcd API

etcd는 Kubernetes 클러스터에서 중요한 역할을 하는 분산 키-값 저장소입니다. etcd API는 etcd 서버와 상호 작용하기 위한 인터페이스를 제공합니다. 이 API를 통해 클러스터의 구성 정보, 상태 정보 및 기타 중요한 데이터에 액세스할 수 있습니다.

etcd API를 사용하여 다음과 같은 작업을 수행할 수 있습니다.

- 키-값 쌍의 생성, 수정, 삭제
- 특정 키에 대한 조회
- 키 범위에 대한 조회
- 트랜잭션 수행
- 워치 이벤트 수신

etcd API는 HTTP/JSON 기반으로 작동하며, 다양한 클라이언트 라이브러리를 통해 사용할 수 있습니다. 이를 통해 etcd 서버와 상호 작용하는 애플리케이션을 개발할 수 있습니다.

etcd API는 Kubernetes 클러스터의 보안을 강화하기 위해 중요한 역할을 합니다. 따라서 etcd API의 보안 설정은 신중하게 관리되어야 합니다. 적절한 인증 및 권한 부여 메커니즘을 구성하여 불법적인 액세스로부터 클러스터를 보호해야 합니다.
```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### Tiller

Tiller는 Kubernetes 클러스터에서 Helm 차트를 설치, 업그레이드 및 관리하는 데 사용되는 서버 구성 요소입니다. Tiller는 클라이언트 요청을 받아서 클러스터 내의 적절한 리소스를 조작합니다. Tiller는 기본적으로 클러스터 내의 모든 네임스페이스에서 실행되며, Helm 클라이언트와 통신하여 차트를 설치하고 관리합니다.

Tiller는 보안 취약점으로 악용될 수 있으므로 적절한 보호 및 구성이 필요합니다. Tiller에 대한 기본적인 보안 구성은 다음과 같습니다.

- Tiller 서비스 계정에는 최소한의 권한만 부여되어야 합니다.
- Tiller 서비스 계정은 클러스터 관리자 권한을 가지면 안 됩니다.
- Tiller 서비스 계정은 네임스페이스 내에서만 작동하도록 제한되어야 합니다.
- Tiller 서비스 계정은 필요한 권한만 가지도록 제한되어야 합니다.

Tiller의 보안 구성을 강화하기 위해 다음과 같은 조치를 취할 수 있습니다.

- Tiller 서비스 계정에는 RBAC(롤 기반 접근 제어)을 사용하여 필요한 최소한의 권한만 부여합니다.
- Tiller 서비스 계정을 네임스페이스 내에서만 작동하도록 제한합니다.
- Tiller 서비스 계정에는 클러스터 관리자 권한을 부여하지 않습니다.
- Tiller 서비스 계정에는 필요한 권한만 부여하고, 불필요한 권한은 제거합니다.

Tiller의 보안 구성을 강화하는 것은 Kubernetes 클러스터의 안전성을 향상시키는 데 중요한 역할을 합니다. 적절한 보호 및 구성을 통해 Tiller를 안전하게 사용할 수 있습니다.
```
helm --host tiller-deploy.kube-system:44134 version
```
이 서비스를 악용하여 Kubernetes 내에서 권한을 상승시킬 수 있습니다:

### cAdvisor

메트릭을 수집하는 데 유용한 서비스입니다.
```
curl -k https://<IP Address>:4194
```
### NodePort

노드를 통해 포트가 노출될 때, 동일한 포트가 모든 노드에서 열리고 선언된 서비스로 트래픽을 프록시합니다. 기본적으로 이 포트는 **30000-32767** 범위에 있습니다. 따라서 새로운 확인되지 않은 서비스는 이러한 포트를 통해 접근할 수 있습니다.
```
sudo nmap -sS -p 30000-32767 <IP>
```
## 취약한 구성 오류

### Kube-apiserver 익명 액세스

**kube-apiserver API 엔드포인트에 대한 익명 액세스는 허용되지 않습니다**. 그러나 몇 가지 엔드포인트를 확인할 수 있습니다:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **ETCD 익명 액세스 확인**

ETCD는 클러스터 비밀, 구성 파일 및 더 많은 **민감한 데이터**를 저장합니다. **기본적으로** ETCD는 **익명으로 액세스할 수 없지만**, 항상 확인하는 것이 좋습니다.

ETCD에 익명으로 액세스할 수 있다면, [etcdctl](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) 도구를 사용해야 할 수 있습니다. 다음 명령은 저장된 모든 키를 가져옵니다:
```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```
### **Kubelet RCE**

[Kubelet 문서](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)에 따르면, 기본적으로 서비스에 대한 익명 액세스가 허용됩니다:

> Kubelet 서버에 대한 익명 요청을 활성화합니다. 다른 인증 방법에 의해 거부되지 않은 요청은 익명 요청으로 처리됩니다. 익명 요청은 `system:anonymous`라는 사용자 이름과 `system:unauthenticated`라는 그룹 이름을 가지고 있습니다.

Kuebelet API의 **인증 및 권한 부여** 방식에 대해 자세히 알아보려면 이 페이지를 확인하세요:

{% content-ref url="../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](../kubernetes-pentesting/pentesting-kubernetes-services/kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** 서비스 **API는 문서화되어 있지 않지만**, 소스 코드는 여기에서 찾을 수 있으며 노출된 엔드포인트를 찾는 것은 다음과 같이 간단합니다:
```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```
모두 흥미로워 보입니다.

[Kubeletctl](https://github.com/cyberark/kubeletctl) 도구를 사용하여 Kubelet과 해당 엔드포인트와 상호 작용할 수 있습니다.

#### /pods

이 엔드포인트는 파드와 해당 컨테이너를 나열합니다:
```bash
kubeletctl pods
```
#### /exec

이 엔드포인트는 어떤 컨테이너 내에서 코드를 매우 쉽게 실행할 수 있게 해줍니다:
```bash
kubeletctl exec [command]
```
{% hint style="info" %}
이러한 공격을 피하기 위해 _**kubelet**_ 서비스는 `--anonymous-auth false`로 실행되어야 하며, 서비스는 네트워크 수준에서 격리되어야 합니다.
{% endhint %}

### **Kubelet (읽기 전용 포트) 정보 노출 확인**

**kubelet 읽기 전용 포트**가 노출되면, 무단으로 API에서 정보를 검색할 수 있게 됩니다. 이 포트의 노출은 다양한 **클러스터 구성 요소**의 노출로 이어질 수 있습니다. 정보에는 **팟 이름, 내부 파일 위치 및 기타 구성** 등이 포함될 수 있으며, 이러한 정보는 중요하지 않을 수 있지만, 노출은 여전히 보안 위험을 초래하므로 피해야 합니다.

이 취약점이 악용될 수 있는 예시는 원격 공격자가 특정 URL에 접근하는 것입니다. `http://<external-IP>:10255/pods`로 이동함으로써, 공격자는 kubelet에서 민감한 정보를 검색할 수 있습니다:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 참고 자료

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**을** **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
