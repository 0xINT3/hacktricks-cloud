# Kubernetes SecurityContext(s)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## PodSecurityContext <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

Podのセキュリティコンテキストを指定する際には、いくつかの属性を使用することができます。防御的なセキュリティの観点からは、次のことを考慮する必要があります：

* **runASNonRoot**を**True**に設定すること
* **runAsUser**を設定すること
* 可能であれば、**seLinuxOptions**と**seccompProfile**を指定して**権限を制限**すること
* **runAsGroup**と**supplementaryGroups**を使用して、**特権グループ**へのアクセスを**与えない**こと

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                                 | <p>Pod内の<strong>すべてのコンテナに適用される特別な補足グループ</strong>。一部のボリュームタイプでは、Kubeletがそのボリュームの所有権をPodによって所有されるように変更することができます：<br>1. 所有するGIDはFSGroupになります<br>2. setgidビットが設定されます（ボリューム内で作成された新しいファイルはFSGroupによって所有されます）<br>3. パーミッションビットはrw-rw----とORされます。未設定の場合、Kubeletはボリュームの所有権とパーミッションを変更しません</p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>文字列</em></p>                                                                                                                                                                                                                                      | これは、Pod内で公開される前にボリュームの所有権とパーミッションを変更する動作を定義します。                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                              | コンテナプロセスのエントリポイントを実行するための**GID**です。未設定の場合は、ランタイムのデフォルトが使用されます。SecurityContextでも設定できます。                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>真偽値</em></p>                                                                                                                                                                                                                                            | コンテナが**非ルートユーザーとして実行される必要がある**ことを示します。trueの場合、Kubeletは実行時にイメージを検証し、UID 0（root）として実行されないことを確認し、実行に失敗します。                                                                                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                               | コンテナプロセスのエントリポイントを実行するための**UID**です。未指定の場合は、イメージメタデータで指定されたユーザーがデフォルトになります。                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>seLinuxについての詳細情報</em></p>                                                           | **すべてのコンテナに適用されるSELinuxコンテキスト**です。未指定の場合、コンテナランタイムは各コンテナにランダムなSELinuxコンテキストを割り当てます。                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>Seccompについての詳細情報</em></p>                                                           | このPod内のコンテナで使用する**seccompオプション**です。                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>整数配列</em></p>                                                                                                                                                                                                                                | 各コンテナで実行される最初のプロセスに適用される**グループのリスト**です。これは、コンテナの主要なGIDに追加されます。                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>配列</em><br><em>sysctlsについての詳細情報</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em>sysctls</em></a></p> | Sysctlsは、Podで使用される**名前空間のあるsysctlのリスト**を保持します。コンテナランタイムでサポートされていないsysctl（コンテナランタイムによって）を持つPodは起動に失敗する可能性があります。                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | すべてのコンテナに適用されるWindows固有の設定です。未指定の場合、コンテナのSecurityContext内のオプションが使用されます。                                                                                                                                                                                                                                                                                                                                               |
## SecurityContext（セキュリティコンテキスト）

このコンテキストは、**コンテナの定義**内に設定されます。防御的なセキュリティの観点から考慮すべき事項は次のとおりです。

* **allowPrivilegeEscalation**を**False**に設定する
* 機密情報を追加しない（必要のないものは削除する）**capabilities**を追加しない
* **privileged**を**False**に設定する
* 可能であれば、**readOnlyFilesystem**を**True**に設定する
* **runAsNonRoot**を**True**に設定し、**runAsUser**を設定する
* 可能であれば、**seLinuxOptions**と**seccompProfile**を指定して**permissions**を**制限する**
* **runAsGroup**を介して**privilege group**へのアクセス権限を与えない

なお、**SecurityContextとPodSecurityContextの両方に設定された属性**の場合、**SecurityContext**で指定された値が**優先されます**。

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>boolean</em></p>                                                                                                                                                                      | **AllowPrivilegeEscalation**は、プロセスが親プロセスよりも多くの特権を取得できるかどうかを制御します。このブール値は、コンテナプロセスにno\_new\_privsフラグが設定されるかどうかを直接制御します。AllowPrivilegeEscalationは、コンテナが**特権モードで実行される**場合または**CAP\_SYS\_ADMIN**を持つ場合は常にtrueです。 |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>Capabilitiesについての詳細情報</em></p>  | **コンテナの実行時に追加/削除するためのcapabilities**。デフォルトでは、デフォルトのcapabilitiesセットが使用されます。                                                                                                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>boolean</em></p>                                                                                                                                                                                    | 特権モードでコンテナを実行します。特権コンテナ内のプロセスは、基本的にはホスト上の**rootと同等**です。デフォルトはfalseです。                                                                                                                                                                               |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>string</em></p>                                                                                                                                                                                      | procMountは、コンテナに使用する**procマウントのタイプ**を示します。デフォルトはDefaultProcMountで、読み取り専用パスとマスクされたパスに対してコンテナランタイムのデフォルトが使用されます。                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>boolean</em></p>                                                                                                                                                                        | この**コンテナが読み取り専用のルートファイルシステムを持つかどうか**を示します。デフォルトはfalseです。                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                    | コンテナプロセスのエントリポイントを実行するための**GID**です。未設定の場合はランタイムのデフォルトが使用されます。                                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                  | コンテナが**非ルートユーザーとして実行する必要がある**ことを示します。trueの場合、Kubeletは実行時にイメージを検証し、UID 0（root）として実行されないことを確認し、実行に失敗します。                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>integer</em></p>                                                                                                                                                                                     | コンテナプロセスのエントリポイントを実行するための**UID**です。未指定の場合、イメージメタデータで指定されたユーザーがデフォルトです。                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>seLinuxについての詳細情報</em></p> | コンテナに適用する**SELinuxコンテキスト**です。指定されていない場合、コンテナランタイムは各コンテナにランダムなSELinuxコンテキストを割り当てます。                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | このコンテナで使用する**seccompオプション**です。                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | すべてのコンテナに適用される**Windows固有の設定**です。                                                                                                                                                                                                                                                              |

## 参考文献

* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

<details>

<summary><strong>ハックトリックをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**最新バージョンのPEASSを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* 独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションである[**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
