# Kubernetes 安全上下文

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## PodSecurityContext <a href="#podsecuritycontext-v1-core" id="podsecuritycontext-v1-core"></a>

在指定 Pod 的安全上下文时，您可以使用多个属性。从防御安全的角度考虑，您应该考虑以下事项：

* 将 **runASNonRoot** 设置为 **True**
* 配置 **runAsUser**
* 如果可能，考虑通过 **seLinuxOptions** 和 **seccompProfile** **限制** **权限**
* **不要**通过 **runAsGroup** 和 **supplementaryGroups** 给予 **特权组** 访问权限

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroup</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                                 | <p>适用于<strong>Pod 中所有容器的特殊附加组</strong>。某些卷类型允许 Kubelet 将该卷的所有权更改为由 Pod 拥有：<br>1. 拥有的 GID 将是 FSGroup<br>2. 设置 setgid 位（在卷中创建的新文件将由 FSGroup 拥有）<br>3. 权限位与 rw-rw---- 进行 OR 运算。如果未设置，Kubelet 将不会修改任何卷的所有权和权限</p> |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>fsGroupChangePolicy</strong></a><br><em>字符串</em></p>                                                                                                                                                                                                                                      | 这定义了在暴露到 Pod 内部之前更改卷的所有权和权限的行为。                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsGroup</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                              | 容器进程入口点运行的 GID。如果未设置，则使用运行时默认值。也可以在 SecurityContext 中设置。                                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>布尔值</em></p>                                                                                                                                                                                                                                            | 表示容器必须以非 root 用户身份运行。如果为 true，则 Kubelet 将在运行时验证镜像，以确保其不以 UID 0（root）运行，并在其以此方式运行时无法启动容器。                                                                                                                                                                                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>runAsUser</strong></a><br><em>整数</em></p>                                                                                                                                                                                                                                               | 容器进程入口点运行的 UID。如果未指定，默认为图像元数据中指定的用户。                                                                                                                                                                                                                                                                                                                                                              |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>有关</em> <em><strong>seLinux</strong></em> 的更多信息</p>                                                           | 要应用于所有容器的 **SELinux 上下文**。如果未指定，容器运行时将为每个容器分配一个随机的 SELinux 上下文。                                                                                                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a><br><em>有关</em> <em><strong>Seccomp</strong></em> 的更多信息</p>                                                           | 该 Pod 中容器使用的 **seccomp 选项**。                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>supplementalGroups</strong></a><br><em>整数数组</em></p>                                                                                                                                                                                                                                | 附加到每个容器中第一个运行的进程的 **组列表**，除了容器的主要 GID。                                                                                                                                                                                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>sysctls</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#sysctl-v1-core"><em>Sysctl</em></a> <em>数组</em><br><em>有关</em> <a href="https://www.garron.me/en/go2linux/sysctl-linux.html"><em><strong>sysctls</strong></em></a> 的更多信息</p> | Sysctls 包含用于 Pod 的 **命名空间 sysctl 列表**。使用不受容器运行时支持的 sysctl（可能无法启动）的 Pod 可能会失败。                                                                                                                                                                                                                                                                                                                                        |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                                                                           | 应用于所有容器的 Windows 特定设置。如果未指定，将使用容器的 SecurityContext 中的选项。                                                                                                                                                                                                                                                                                                                                               |
## SecurityContext

这个上下文是在**容器定义**中设置的。从防御安全的角度考虑，您应该考虑以下几点：

* 将**allowPrivilegeEscalation**设置为**False**
* 不要添加敏感的**capabilities**（并删除不需要的capabilities）
* 将**privileged**设置为**False**
* 如果可能，将**readOnlyFilesystem**设置为**True**
* 将**runAsNonRoot**设置为**True**并设置一个**runAsUser**
* 如果可能，考虑通过指定**seLinuxOptions**和**seccompProfile**来**限制**权限
* **不要**通过**runAsGroup**给予**privilege group**访问权限。

请注意，**SecurityContext和PodSecurityContext**中设置的属性，以**SecurityContext**中指定的值为准。

| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>allowPrivilegeEscalation</strong></a><br><em>boolean</em></p>                                                                                                                                                                      | **allowPrivilegeEscalation** 控制一个进程是否可以比其父进程获得更多的权限。这个布尔值直接控制容器进程上是否设置 no_new_privs 标志。当容器以**特权模式**运行或具有**CAP_SYS_ADMIN**时，allowPrivilegeEscalation始终为true |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>capabilities</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#capabilities-v1-core"><em>Capabilities</em></a><br><em>有关</em> <em><strong>Capabilities</strong></em> 的更多信息</p>  | 运行容器时要添加/删除的**capabilities**。默认为默认的capabilities集合。                                                                                                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>privileged</strong></a><br><em>boolean</em></p>                                                                                                                                                                                    | 在特权模式下运行容器。特权容器中的进程基本上等同于主机上的root用户。默认为false。                                                                                                                                                                               |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>procMount</strong></a><br><em>string</em></p>                                                                                                                                                                                      | procMount表示容器使用的proc mount类型。默认值为DefaultProcMount，它使用容器运行时默认的只读路径和掩码路径。                                                                                                                                    |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>readOnlyRootFilesystem</strong></a><br><em>boolean</em></p>                                                                                                                                                                        | 此容器是否具有只读的根文件系统。默认值为false。                                                                                                                                                                                                                                             |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsGroup</strong></a><br><em>integer</em></p>                                                                                                                                                                                    | 容器进程的入口点运行的GID。如果未设置，则使用运行时默认值。                                                                                                                                                                                                                                |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsNonRoot</strong></a><br><em>boolean</em></p>                                                                                                                                                                                  | 表示容器必须以非root用户身份运行。如果为true，Kubelet将在运行时验证镜像，以确保其不以UID 0（root）运行，并在其以此方式运行时失败以启动容器。                                                                                                          |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>runAsUser</strong></a><br><em>integer</em></p>                                                                                                                                                                                     | 容器进程的入口点运行的UID。如果未指定，默认为镜像元数据中指定的用户。                                                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seLinuxOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#selinuxoptions-v1-core"><em>SELinuxOptions</em></a><br><em>有关</em> <em><strong>seLinux</strong></em> 的更多信息</p> | 要应用于容器的**SELinux上下文**。如果未指定，容器运行时将为每个容器分配一个随机的SELinux上下文。                                                                                                                                                                  |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>seccompProfile</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#seccompprofile-v1-core"><em>SeccompProfile</em></a></p>                                                               | 此容器要使用的**seccomp选项**。                                                                                                                                                                                                                                                                         |
| <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core"><strong>windowsOptions</strong></a><br><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#windowssecuritycontextoptions-v1-core"><em>WindowsSecurityContextOptions</em></a></p>                                 | 应用于所有容器的**Windows特定设置**。                                                                                                                                                                                                                                                              |

## 参考资料

* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podsecuritycontext-v1-core)
* [https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#securitycontext-v1-core)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问最新版本的 PEASS 或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或在 **Twitter** 上 **关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
