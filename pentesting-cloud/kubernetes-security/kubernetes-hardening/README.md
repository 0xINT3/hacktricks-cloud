# Durcissement de Kubernetes

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Outils pour analyser un cluster

### Kubescape

[**Kubescape**](https://github.com/armosec/kubescape) est un outil open-source K8s fournissant une vue d'ensemble multi-cloud de K8s, comprenant l'analyse des risques, la conformit√© de s√©curit√©, la visualisation des RBAC et la num√©risation des vuln√©rabilit√©s des images. Kubescape analyse les clusters K8s, les fichiers YAML et les charts HELM, d√©tectant les mauvaises configurations selon plusieurs frameworks (comme le [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), les vuln√©rabilit√©s logicielles et les violations des RBAC (contr√¥le d'acc√®s bas√© sur les r√¥les) aux premiers stades du pipeline CI/CD, calcule instantan√©ment le score de risque et montre les tendances des risques au fil du temps.
```bash
kubescape scan --verbose
```
### Kube-bench

L'outil [**kube-bench**](https://github.com/aquasecurity/kube-bench) est un outil qui v√©rifie si Kubernetes est d√©ploy√© de mani√®re s√©curis√©e en ex√©cutant les v√©rifications document√©es dans le [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Vous pouvez choisir de :

* ex√©cuter kube-bench √† partir d'un conteneur (partageant l'espace de noms PID avec l'h√¥te)
* ex√©cuter un conteneur qui installe kube-bench sur l'h√¥te, puis ex√©cuter kube-bench directement sur l'h√¥te
* installer les derniers binaires √† partir de la [page des versions](https://github.com/aquasecurity/kube-bench/releases),
* le compiler √† partir des sources.

### Kubeaudit

L'outil [**kubeaudit**](https://github.com/Shopify/kubeaudit) est un outil en ligne de commande et une biblioth√®que Go pour **auditer les clusters Kubernetes** pour divers probl√®mes de s√©curit√©.

Kubeaudit peut d√©tecter s'il s'ex√©cute dans un conteneur d'un cluster. Dans ce cas, il essaiera d'auditer toutes les ressources Kubernetes de ce cluster :
```
kubeaudit all
```
Cet outil dispose √©galement de l'argument `autofix` pour **corriger automatiquement les probl√®mes d√©tect√©s.**

### **Kube-hunter**

L'outil [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) recherche les faiblesses de s√©curit√© dans les clusters Kubernetes. L'outil a √©t√© d√©velopp√© pour sensibiliser et mettre en √©vidence les probl√®mes de s√©curit√© dans les environnements Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### **Kubei**

[**Kubei**](https://github.com/Erezf-p/kubei) est un outil d'analyse des vuln√©rabilit√©s et de r√©f√©rence CIS Docker qui permet aux utilisateurs d'obtenir une √©valuation pr√©cise et imm√©diate des risques de leurs clusters Kubernetes. Kubei analyse toutes les images utilis√©es dans un cluster Kubernetes, y compris les images des pods d'application et des pods syst√®me.

### KubiScan

[**KubiScan**](https://github.com/cyberark/KubiScan) est un outil de balayage des clusters Kubernetes √† la recherche d'autorisations risqu√©es dans le mod√®le d'autorisation bas√© sur les r√¥les (RBAC) de Kubernetes.

## **Audit du code IaC**

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye) est un utilitaire qui analyse en direct un cluster Kubernetes et signale les probl√®mes potentiels li√©s aux ressources et configurations d√©ploy√©es. Il nettoie votre cluster en fonction de ce qui est d√©ploy√© et non de ce qui est stock√© sur le disque. En analysant votre cluster, il d√©tecte les mauvaises configurations et vous aide √† vous assurer que les meilleures pratiques sont en place, √©vitant ainsi les probl√®mes futurs. Il vise √† r√©duire la surcharge cognitive √† laquelle on est confront√© lors de l'exploitation d'un cluster Kubernetes dans la nature. De plus, s'il utilise un serveur de m√©triques, il signale les √©ventuelles sur ou sous-allocations de ressources et tente de vous avertir si votre cluster manque de capacit√©.

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics) trouve des vuln√©rabilit√©s de s√©curit√©, des probl√®mes de conformit√© et des erreurs de configuration d'infrastructure dans les solutions suivantes d'Infrastructure as Code : Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM et sp√©cifications OpenAPI 3.0.

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov) est un outil d'analyse statique du code pour l'infrastructure en tant que code.

Il analyse l'infrastructure cloud provisionn√©e √† l'aide de [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ou [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) et d√©tecte les erreurs de configuration de s√©curit√© et de conformit√© √† l'aide d'une analyse bas√©e sur les graphiques.

### Kube-score

[**kube-score**](https://github.com/zegl/kube-score) est un outil qui effectue une analyse statique du code de vos d√©finitions d'objets Kubernetes.

Pour l'installation :

| Distribution                                        | Commande / Lien                                                                         |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binaires pr√©compil√©s pour macOS, Linux et Windows    | [Versions GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS et Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS et Linux) | `kubectl krew install score`                                                            |

## Conseils

### Surveillance avec Falco

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

### Kubernetes PodSecurityContext et SecurityContext

Vous pouvez configurer le **contexte de s√©curit√© des pods** (avec _PodSecurityContext_) et des **conteneurs** qui vont √™tre ex√©cut√©s (avec _SecurityContext_). Pour plus d'informations, lisez :

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Durcissement de l'API Kubernetes

Il est tr√®s important de **prot√©ger l'acc√®s au serveur API Kubernetes**, car un acteur malveillant disposant de privil√®ges suffisants pourrait l'exploiter et endommager l'environnement de nombreuses mani√®res.\
Il est important de s√©curiser √† la fois l'**acc√®s** (autoriser les origines en liste blanche √† acc√©der au serveur API et refuser toute autre connexion) et l'**authentification** (en suivant le principe du **privil√®ge** **minimal**). Et surtout, **ne jamais** **autoriser** **les** **requ√™tes** **anonymes**.

**Processus de demande courant :**\
Utilisateur ou compte de service K8s -> Authentification -> Autorisation -> Contr√¥le d'admission.

**Conseils** :

* Fermez les ports.
* √âvitez l'acc√®s anonyme.
* Restriction de n≈ìud ; aucun acc√®s depuis des n≈ìuds sp√©cifiques √† l'API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Emp√™che essentiellement les kubelets d'ajouter/supprimer/mettre √† jour des √©tiquettes avec un pr√©fixe node-restriction.kubernetes.io/. Ce pr√©fixe d'√©tiquette est r√©serv√© aux administrateurs pour √©tiqueter leurs objets Node √† des fins d'isolation des charges de travail, et les kubelets ne seront pas autoris√©s √† modifier les √©tiquettes avec ce pr√©fixe.
* Et aussi, permet aux kubelets d'ajouter/supprimer/mettre √† jour ces √©tiquettes et pr√©fixes d'√©tiquettes.
* Assurez-vous avec des √©tiquettes de l'isolation s√©curis√©e des charges de travail.
* √âvitez l'acc√®s API sp√©cifique aux pods.
* √âvitez l'exposition de l'ApiServer √† Internet.
* √âvitez l'acc√®s non autoris√© RBAC.
* Port ApiServer avec pare-feu et liste blanche d'adresses IP.

### Durcissement du SecurityContext

Par d√©faut, l'utilisateur root sera utilis√© lorsqu'un pod est d√©marr√© si aucun autre utilisateur n'est sp√©cifi√©. Vous pouvez ex√©cuter votre application dans un contexte plus s√©curis√© en utilisant un mod√®le similaire au suivant :
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Kubernetes NetworkPolicies

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### Durcissement g√©n√©ral

Vous devez mettre √† jour votre environnement Kubernetes aussi fr√©quemment que n√©cessaire pour :

* Avoir des d√©pendances √† jour.
* Avoir des correctifs de bogues et de s√©curit√©.

[**Cycles de publication**](https://kubernetes.io/docs/setup/release/version-skew-policy/) : Tous les 3 mois, il y a une nouvelle version mineure -- 1.20.3 = 1(Majeur).20(Mineur).3(correctif)

**La meilleure fa√ßon de mettre √† jour un cluster Kubernetes est (√† partir de** [**ici**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**) :**

* Mettre √† niveau les composants du n≈ìud ma√Ætre en suivant cette s√©quence :
* etcd (toutes les instances).
* kube-apiserver (tous les h√¥tes du plan de contr√¥le).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, si vous en utilisez un.
* Mettre √† niveau les composants du n≈ìud de travail tels que kube-proxy, kubelet.

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
