# Ενίσχυση του Kubernetes

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Εργαλεία για ανάλυση ενός cluster

### [**Kubescape**](https://github.com/armosec/kubescape)

Το [**Kubescape**](https://github.com/armosec/kubescape) είναι ένα εργαλείο ανοιχτού κώδικα για το K8s που παρέχει μια πολυ-νέφους προβολή του K8s, περιλαμβάνοντας ανάλυση κινδύνου, συμμόρφωση με την ασφάλεια, οπτικοποίηση RBAC και σάρωση ευπαθειών εικόνας. Το Kubescape σαρώνει τα clusters K8s, τα αρχεία YAML και τα charts HELM, ανιχνεύοντας ανεπάρκειες σύμφωνα με πολλά πλαίσια (όπως το [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), ευπαθείες λογισμικού και παραβιάσεις RBAC (role-based-access-control) στα αρχικά στάδια του CI/CD pipeline, υπολογίζει αμέσως τον βαθμό κινδύνου και εμφανίζει τις τάσεις κινδύνου με την πάροδο του χρόνου.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Το εργαλείο [**kube-bench**](https://github.com/aquasecurity/kube-bench) είναι ένα εργαλείο που ελέγχει εάν το Kubernetes είναι εγκατεστημένο με ασφάλεια εκτελώντας τους ελέγχους που καταγράφονται στο [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Μπορείτε να επιλέξετε να:

* εκτελέσετε το kube-bench από μέσα σε ένα container (κοινή χρήση του PID namespace με τον host)
* εκτελέσετε ένα container που εγκαθιστά το kube-bench στον host και στη συνέχεια να εκτελέσετε το kube-bench απευθείας στον host
* εγκαταστήσετε τις πιο πρόσφατες δυαδικές εκδόσεις από τη [σελίδα Κυκλοφορίας](https://github.com/aquasecurity/kube-bench/releases),
* το μεταγλωττίσετε από τον πηγαίο κώδικα.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Το εργαλείο [**kubeaudit**](https://github.com/Shopify/kubeaudit) είναι ένα εργαλείο γραμμής εντολών και ένα πακέτο Go για **ελέγχο ασφάλειας Kubernetes clusters** για διάφορα θέματα ασφάλειας.

Το kubeaudit μπορεί να ανιχνεύσει εάν εκτελείται εντός ενός container σε ένα cluster. Σε αυτή την περίπτωση, θα προσπαθήσει να ελέγξει όλους τους πόρους Kubernetes σε αυτό το cluster:
```
kubeaudit all
```
Αυτό το εργαλείο έχει επίσης το όρισμα `autofix` για να **διορθώνει αυτόματα τα εντοπισμένα προβλήματα**.

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Το εργαλείο [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) κυνηγά αδυναμίες ασφαλείας σε συστάδες Kubernetes. Το εργαλείο αναπτύχθηκε για να αυξήσει την ευαισθητοποίηση και την ορατότητα για θέματα ασφαλείας σε περιβάλλοντα Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) είναι ένα εργαλείο σάρωσης ευπαθειών και ελέγχου CIS Docker που επιτρέπει στους χρήστες να λάβουν μια ακριβή και άμεση αξιολόγηση κινδύνου για τα κατάλυματα Kubernetes τους. Το Kubei σαρώνει όλες τις εικόνες που χρησιμοποιούνται σε ένα κατάλυμα Kubernetes, συμπεριλαμβανομένων των εικόνων των εφαρμογών και των συστημικών πόδων.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) είναι ένα εργαλείο για τη σάρωση ενός καταλύματος Kubernetes για επικίνδυνες άδειες στο μοντέλο εξουσιοδότησης Role-based access control (RBAC) του Kubernetes.

## **Ελεγχος κώδικα IaC**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) είναι ένα εργαλείο που σαρώνει ζωντανό κατάλυμα Kubernetes και **αναφέρει πιθανά προβλήματα με τους πόρους και τις διαμορφώσεις που έχουν αναπτυχθεί**. Καθαρίζει το κατάλυμα σας με βάση αυτό που έχει αναπτυχθεί και όχι αυτό που βρίσκεται στον δίσκο. Με τη σάρωση του καταλύματός σας, ανιχνεύει μη σωστές διαμορφώσεις και σας βοηθά να εξασφαλίσετε ότι τηρούνται οι βέλτιστες πρακτικές, αποτρέποντας έτσι μελλοντικά προβλήματα. Στοχεύει στη μείωση του γνωστικού φόρτου που αντιμετωπίζει κανείς κατά τη λειτουργία ενός καταλύματος Kubernetes στον πραγματικό κόσμο. Επιπλέον, αν ο κατάλυμά σας χρησιμοποιεί έναν μετρητή μετρήσεων, αναφέρει πιθανές υπερβολικές/ανεπαρκείς πόρους και προσπαθεί να σας προειδοποιήσει αν το κατάλυμά σας εξαντλήσει τη χωρητικότητά του.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) εντοπίζει **ευπαθείες ασφάλειας**, προβλήματα συμμόρφωσης και λανθασμένες διαμορφώσεις υποδομής στις ακόλουθες λύσεις **Υποδομής ως Κώδικα**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM και προδιαγραφές OpenAPI 3.0

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) είναι ένα εργαλείο ανάλυσης στατικού κώδικα για υποδομή-ως-κώδικα.

Σαρώνει την υποδομή στον νέφος που παρέχεται χρησιμοποιώντας [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ή [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) και ανιχνεύει λανθασμένες διαμορφώσεις ασφάλειας και συμμόρφωσης χρησιμοποιώντας σάρωση βασισμένη σε γράφους.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) είναι ένα εργαλείο που πραγματοποιεί ανάλυση στατικού κώδικα των ορισμών αντικειμένων Kubernetes σας.

Για να εγκαταστήσετε:

| Διανομή                                        | Εντολή / Σύνδεσμος                                                                         |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------ |
| Προεπιλεγμένες δυαδικές εκδόσεις για macOS, Linux και Windows    | [Κυκλοφορίες GitHub](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS και Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS και Linux) | `kubectl krew install score`                                                            |

## Συμβουλές

### Kubernetes PodSecurityContext και SecurityContext

Μπορείτε να διαμορφώσετε το **περιβάλλον ασφάλειας των Pods** (με το _PodSecurityContext_) και των **δοχείων** που θα εκτελεστούν (με το _SecurityContext_). Για περισσότερες πληροφορίες διαβάστε:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Ενίσχυση του Kubernetes API

Είναι πολύ σημαντικό να **προστατεύετε την πρόσβαση στον Kubernetes Api Server**, καθώς ένας κακόβουλος χρήστης με επαρκή δικαιώματα μπορεί να το καταχραστεί και να προκαλέσει ζημιά στο περιβάλλον.\
Είναι σημαντικό να ασφαλίζετε τόσο την **πρόσβαση** (**λευκή λίστα** προέλευσης για πρόσβαση στον API Server και απόρριψη οποιασδήποτε άλλης σύνδεσης) όσο και την [**πιστοποίηση**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (ακολουθώντας την αρχή του **λιγότερου** **προνομίου**). Και σίγουρα **ποτέ** **μην** **επιτρέπετε** **ανώνυμες** **αιτήσεις**.

**Κοινή διαδικασία αιτήματος:**\
Χρήστης ή K8s ServiceAccount –> Πιστοποίηση –> Εξουσιοδότηση –> Έλεγ
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)


### Γενική Ενίσχυση

Θα πρέπει να ενημερώνετε το περιβάλλον σας Kubernetes τακτικά για να έχετε:

* Ενημερωμένες εξαρτήσεις.
* Διορθώσεις σφαλμάτων και ασφάλειας.

[**Κύκλοι κυκλοφορίας**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Κάθε 3 μήνες υπάρχει μια νέα μικρή έκδοση -- 1.20.3 = 1(Μείζονας).20(Ελάσσονας).3(διόρθωση)

**Ο καλύτερος τρόπος για να ενημερώσετε ένα Kubernetes Cluster είναι (από** [**εδώ**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Αναβαθμίστε τα στοιχεία του Master Node ακολουθώντας αυτήν την ακολουθία:
* etcd (όλες οι περιπτώσεις).
* kube-apiserver (όλοι οι hosts του control plane).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, αν χρησιμοποιείτε έναν.
* Αναβαθμίστε τα στοιχεία του Worker Node, όπως το kube-proxy, kubelet.

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΠΑΚΕΤΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
