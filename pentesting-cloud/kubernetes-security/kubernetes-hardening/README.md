# Kubernetesのハードニング

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つけましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加してください。**

</details>

## ツール

### Kubescape

****[**Kubescape**](https://github.com/armosec/kubescape)は、K8sのオープンソースツールで、リスク分析、セキュリティコンプライアンス、RBACビジュアライザー、イメージの脆弱性スキャンを含む、マルチクラウドK8sのシングルペインオブグラスを提供します。 Kubescapeは、K8sクラスター、YAMLファイル、HELMチャートをスキャンし、[NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo)、[MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)などの複数のフレームワークに基づいてミスコンフィギュレーション、ソフトウェアの脆弱性、RBAC（ロールベースのアクセス制御）の違反を検出し、CI/CDパイプラインの早い段階でリスクスコアを計算し、リスクの傾向を表示します。&#x20;

### Kube-bench

ツール[**kube-bench**](https://github.com/aquasecurity/kube-bench)は、[**CIS Kubernetesベンチマーク**](https://www.cisecurity.org/benchmark/kubernetes/)に記載されているチェックを実行して、Kubernetesが安全にデプロイされているかどうかを確認するツールです。\
次のいずれかを選択できます：

* ホストとPID名前空間を共有するコンテナ内からkube-benchを実行する
* ホストにkube-benchをインストールするコンテナを実行し、その後ホスト上でkube-benchを直接実行する
* [リリースページ](https://github.com/aquasecurity/kube-bench/releases)から最新のバイナリをインストールする
* ソースからコンパイルする

### Kubeaudit

ツール[**kubeaudit**](https://github.com/Shopify/kubeaudit)は、さまざまなセキュリティ上の懸念事項に対してKubernetesクラスターを監査するためのコマンドラインツールおよびGoパッケージです。

Kubeauditは、クラスター内のコンテナで実行されているかどうかを検出することができます。そうであれば、そのクラスター内のすべてのKubernetesリソースを監査しようとします：
```
kubeaudit all
```
このツールには、**検出された問題を自動的に修正する**ための`autofix`引数もあります。

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye)は、実行中のKubernetesクラスタをスキャンし、**展開されたリソースと設定の潜在的な問題を報告**するユーティリティです。ディスク上にあるものではなく、展開されているものに基づいてクラスタをクリーンにします。クラスタをスキャンすることで、設定ミスを検出し、ベストプラクティスが適用されていることを確認し、将来の問題を防ぎます。これにより、Kubernetesクラスタを運用する際に直面する認知の過負荷を軽減することを目指しています。さらに、クラスタがメトリックサーバーを使用している場合、リソースの過剰/不足割り当ての可能性を報告し、クラスタの容量が不足する場合に警告を出します。

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics)は、次の**インフラストラクチャコードソリューション**であるTerraform、Kubernetes、Docker、AWS CloudFormation、Ansible、Helm、Microsoft ARM、およびOpenAPI 3.0の仕様において、**セキュリティの脆弱性、コンプライアンスの問題、およびインフラストラクチャの設定ミス**を検出します。

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov)は、インフラストラクチャコードのための静的コード解析ツールです。

[terraform](https://terraform.io)、Terraform plan、[Cloudformation](https://aws.amazon.com/cloudformation/)、[AWS SAM](https://aws.amazon.com/serverless/sam/)、[Kubernetes](https://kubernetes.io)、[Dockerfile](https://www.docker.com)、[Serverless](https://www.serverless.com)、または[ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview)を使用してプロビジョニングされたクラウドインフラストラクチャをスキャンし、グラフベースのスキャンを使用してセキュリティとコンプライアンスの設定ミスを検出します。

### **Falcoによるモニタリング**

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

## ヒント

### KubernetesのPodSecurityContextとSecurityContext

**Podのセキュリティコンテキスト**（_PodSecurityContext_を使用）および実行される**コンテナ**の**セキュリティコンテキスト**（_SecurityContext_を使用）を設定できます。詳細については、次を参照してください：

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes APIの強化

悪意のあるアクターが十分な権限を持っている場合、Kubernetes APIサーバへのアクセスを**保護することは非常に重要**です。これにより、環境にさまざまな方法で損害を与えることができます。\
**アクセス**（APIサーバへのアクセス元を**ホワイトリスト**し、他の接続を拒否する）と[**認証**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)（**最小特権**の原則に従う）の両方を確保することが重要です。そして、**決して****匿名のリクエスト**を許可しないでください。

**一般的なリクエストプロセス**：\
ユーザーまたはK8s ServiceAccount –> 認証 –> 認可 –> Admission Control。

**ヒント**：

* ポートを閉じる。
* 匿名アクセスを避ける。
* NodeRestriction：特定のノードからAPIへのアクセスを禁止する。
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* 基本的には、kubeletがノードオブジェクトをワークロードの分離目的でラベル付けするために予約されているnode-restriction.kubernetes.io/接頭辞を持つラベルの追加/削除/更新をkubeletが許可しないようにします。また、kubeletがこれらのラベルとラベルの接頭辞を追加/削除/更新できるようにもします。
* ラベルを使用してセキュアなワークロードの分離を確保します。
* 特定のポッドがAPIへのアクセスを許可されないようにする。
* ApiServerをインターネットに公開しない。
* 不正なアクセスRBACを避ける。
* ファイアウォールとIPホワイトリストを使用してApiServerポートを保護する。

### SecurityContextの強化

デフォルトでは、指定されていない場合、Podが起動されるときにはrootユーザーが使用されます。以下のテンプレートを使用して、より安全なコンテキストでアプリケーションを実行できます：
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Kubernetes NetworkPolicies

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### 一般的なハードニング

必要に応じてKubernetes環境をアップデートする必要があります。以下の項目を最新の状態に保つために:

* 依存関係を最新の状態にする。
* バグ修正とセキュリティパッチを適用する。

[**リリースサイクル**](https://kubernetes.io/docs/setup/release/version-skew-policy/): 3ヶ月ごとに新しいマイナーリリースがあります -- 1.20.3 = 1(メジャー).20(マイナー).3(パッチ)

**Kubernetesクラスタをアップデートする最良の方法は次のとおりです（**[**こちら**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**）:**

* マスターノードのコンポーネントを次の順序でアップグレードする:
* etcd（すべてのインスタンス）。
* kube-apiserver（すべてのコントロールプレーンホスト）。
* kube-controller-manager。
* kube-scheduler。
* 使用している場合は、クラウドコントローラーマネージャーもアップグレードする。
* kube-proxy、kubeletなどのワーカーノードのコンポーネントをアップグレードする。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**をフォローする。**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
