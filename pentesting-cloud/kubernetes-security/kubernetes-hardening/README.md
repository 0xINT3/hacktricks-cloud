# Kubernetesのハードニング

<details>

<summary><strong>HackTricksをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンをダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## クラスターを分析するためのツール

### Kubescape

[**Kubescape**](https://github.com/armosec/kubescape)は、K8sのオープンソースツールであり、リスク分析、セキュリティコンプライアンス、RBACビジュアライザ、およびイメージの脆弱性スキャンを含む、マルチクラウドK8sのシングルペインオブグラスを提供します。 Kubescapeは、K8sクラスター、YAMLファイル、HELMチャートをスキャンし、[NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo)、[MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)などの複数のフレームワークに基づいてミスコンフィギュレーション、ソフトウェアの脆弱性、およびRBAC（ロールベースのアクセス制御）違反を検出し、CI/CDパイプラインの初期段階でリスクスコアを即座に計算し、時間の経過に伴うリスクの傾向を表示します。
```bash
kubescape scan --verbose
```
### Kube-bench

[**kube-bench**](https://github.com/aquasecurity/kube-bench)というツールは、[**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/)でドキュメント化されたチェックを実行して、Kubernetesが安全に展開されているかどうかを確認するツールです。以下の方法で実行することができます：

* ホストとPID名前空間を共有するコンテナ内からkube-benchを実行する
* ホストにkube-benchをインストールするコンテナを実行し、その後ホスト上でkube-benchを直接実行する
* [リリースページ](https://github.com/aquasecurity/kube-bench/releases)から最新のバイナリをインストールする
* ソースからコンパイルする

### Kubeaudit

[**kubeaudit**](https://github.com/Shopify/kubeaudit)というツールは、さまざまなセキュリティ上の懸念事項に対してKubernetesクラスタを監査するためのコマンドラインツールおよびGoパッケージです。

Kubeauditは、クラスタ内のコンテナで実行されているかどうかを検出することができます。もし実行されている場合、クラスタ内のすべてのKubernetesリソースを監査しようとします。
```
kubeaudit all
```
このツールには、検出された問題を**自動的に修正する**ための引数 `autofix` もあります。

### **Kube-hunter**

ツール [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) は、Kubernetes クラスターのセキュリティ上の脆弱性を探し出します。このツールは、Kubernetes 環境のセキュリティ問題に対する認識と可視性を高めるために開発されました。
```bash
kube-hunter --remote some.node.com
```
### **Kubei**

[**Kubei**](https://github.com/Erezf-p/kubei)は、Kubernetesクラスターの正確で即時のリスク評価を行う脆弱性スキャンおよびCIS Dockerベンチマークツールです。Kubeiは、アプリケーションポッドとシステムポッドのイメージを含む、Kubernetesクラスターで使用されているすべてのイメージをスキャンします。

## **IaCコードの監査**

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye)は、ライブなKubernetesクラスターをスキャンし、**デプロイされたリソースと設定の潜在的な問題を報告**するユーティリティです。ディスク上にあるものではなく、デプロイされているものに基づいてクラスターをクリーンにします。クラスターをスキャンすることで、設定ミスを検出し、ベストプラクティスが適用されていることを確認し、将来の問題を防ぎます。これにより、Kubernetesクラスターを運用する際に直面する認知の負荷を軽減することを目指しています。さらに、クラスターがメトリックサーバーを使用している場合、リソースの過剰/不足割り当ての可能性を報告し、クラスターの容量が不足する場合に警告を試みます。

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics)は、以下の**インフラストラクチャコードソリューション**（Terraform、Kubernetes、Docker、AWS CloudFormation、Ansible、Helm、Microsoft ARM、およびOpenAPI 3.0仕様）で、セキュリティの脆弱性、コンプライアンスの問題、およびインフラストラクチャの設定ミスを検出します。

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov)は、インフラストラクチャコードの静的コード解析ツールです。

[Terraform](https://terraform.io)、Terraformプラン、[Cloudformation](https://aws.amazon.com/cloudformation/)、[AWS SAM](https://aws.amazon.com/serverless/sam/)、[Kubernetes](https://kubernetes.io)、[Dockerfile](https://www.docker.com)、[Serverless](https://www.serverless.com)、または[ARMテンプレート](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview)を使用してプロビジョニングされたクラウドインフラストラクチャをスキャンし、グラフベースのスキャンを使用してセキュリティとコンプライアンスの設定ミスを検出します。

### Kube-score

[**kube-score**](https://github.com/zegl/kube-score)は、Kubernetesオブジェクト定義の静的コード解析を実行するツールです。

インストール方法：

| ディストリビューション                                | コマンド/リンク                                                                                   |
| --------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| macOS、Linux、Windows用のプリビルドバイナリ           | [GitHubリリース](https://github.com/zegl/kube-score/releases)                                     |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/)           |
| Homebrew（macOSおよびLinux）                          | `brew install kube-score`                                                                         |
| [Krew](https://krew.sigs.k8s.io/)（macOSおよびLinux） | `kubectl krew install score`                                                                      |

## ヒント

### Falcoによるモニタリング

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

### Kubernetes PodSecurityContextとSecurityContext

**Podのセキュリティコンテキスト**（_PodSecurityContext_を使用）および実行される**コンテナ**の**セキュリティコンテキスト**（_SecurityContext_を使用）を設定できます。詳細については、次を参照してください：

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes APIのハードニング

悪意のあるアクターが十分な権限を持っている場合、Kubernetes APIサーバーへのアクセスを**保護することは非常に重要**です。これにより、環境がさまざまな方法で悪影響を受ける可能性があります。\
**アクセス**（APIサーバーへのアクセス元をホワイトリストに登録し、他の接続を拒否する）と[**認証**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)（**最小特権**の原則に従う）の両方を確保することが重要です。そして、**決して****匿名のリクエスト**を許可しないでください。

**一般的なリクエストプロセス**：\
ユーザーまたはK8s ServiceAccount –> 認証 –> 認可 –> 入場制御。

**ヒント**：

* ポートを閉じる。
* 匿名アクセスを避ける。
* NodeRestriction：特定のノードからAPIへのアクセスを禁止する。
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* 基本的には、kubeletがノードオブジェクトをワークロードの分離目的でラベル付けするために予約されているnode-restriction.kubernetes.io/接頭辞を持つラベルの追加/削除/更新をkubeletが許可しないようにします。また、kubeletはこれらのラベルとラベルの接頭辞を追加/削除/更新することができます。
* ラベルを使用してセキュアなワークロードの分離を確保します。
* 特定のポッドがAPIへのアクセスを拒否する。
* ApiServerをインターネットに公開しない。
* 不正なアクセスRBACを避ける。
* ファイアウォールとIPホワイトリストを使用したApiServerポートの保護。
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Kubernetes NetworkPolicies

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### 一般的なハードニング

必要に応じてKubernetes環境をアップデートする必要があります。以下の項目を最新の状態に保つためにアップデートしてください。

* 依存関係を最新の状態にする。
* バグ修正とセキュリティパッチを適用する。

[**リリースサイクル**](https://kubernetes.io/docs/setup/release/version-skew-policy/): 3ヶ月ごとに新しいマイナーリリースがあります -- 1.20.3 = 1(メジャー).20(マイナー).3(パッチ)

**Kubernetesクラスタをアップデートする最良の方法は（**[**こちら**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**）:**

* 以下のシーケンスに従ってマスターノードのコンポーネントをアップグレードする:
* etcd（すべてのインスタンス）。
* kube-apiserver（すべてのコントロールプレーンホスト）。
* kube-controller-manager。
* kube-scheduler。
* 使用している場合は、クラウドコントローラーマネージャーもアップグレードする。
* kube-proxy、kubeletなどのワーカーノードのコンポーネントをアップグレードする。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を入手する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
