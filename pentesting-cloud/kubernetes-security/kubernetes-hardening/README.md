# Kubernetes Hardening

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Ferramentas

### Kubescape

****[**Kubescape**](https://github.com/armosec/kubescape) √© uma ferramenta de c√≥digo aberto K8s que fornece uma √∫nica vis√£o para v√°rias nuvens K8s, incluindo an√°lise de risco, conformidade de seguran√ßa, visualizador RBAC e varredura de vulnerabilidades de imagem. O Kubescape escaneia clusters K8s, arquivos YAML e gr√°ficos HELM, detectando configura√ß√µes incorretas de acordo com v√°rios frameworks (como o [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software e viola√ß√µes de RBAC (controle de acesso baseado em fun√ß√£o) nos est√°gios iniciais do pipeline CI/CD, calcula a pontua√ß√£o de risco instantaneamente e mostra tend√™ncias de risco ao longo do tempo.&#x20;

### Kube-bench

A ferramenta [**kube-bench**](https://github.com/aquasecurity/kube-bench) √© uma ferramenta que verifica se o Kubernetes est√° implantado com seguran√ßa executando as verifica√ß√µes documentadas no [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Voc√™ pode escolher:

* executar o kube-bench de dentro de um cont√™iner (compartilhando o namespace PID com o host)
* executar um cont√™iner que instala o kube-bench no host e, em seguida, executar o kube-bench diretamente no host
* instalar os bin√°rios mais recentes da [p√°gina de lan√ßamentos](https://github.com/aquasecurity/kube-bench/releases),
* compil√°-lo a partir do c√≥digo-fonte.

### Kubeaudit

A ferramenta [**kubeaudit**](https://github.com/Shopify/kubeaudit) √© uma ferramenta de linha de comando e um pacote Go para **auditar clusters Kubernetes** para v√°rias preocupa√ß√µes de seguran√ßa diferentes.

O Kubeaudit pode detectar se est√° sendo executado dentro de um cont√™iner em um cluster. Se for o caso, ele tentar√° auditar todos os recursos do Kubernetes nesse cluster:

```
kubeaudit all
```

Esta ferramenta tamb√©m possui o argumento `autofix` para **corrigir automaticamente os problemas detectados.**

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye) √© uma ferramenta que examina o cluster Kubernetes ao vivo e **relata poss√≠veis problemas com recursos e configura√ß√µes implantados**. Ele higieniza seu cluster com base no que est√° implantado e n√£o no que est√° no disco. Ao examinar seu cluster, ele detecta configura√ß√µes incorretas e ajuda voc√™ a garantir que as melhores pr√°ticas estejam em vigor, evitando assim dores de cabe√ßa futuras. Ele visa reduzir a sobrecarga cognitiva que se enfrenta ao operar um cluster Kubernetes na natureza. Al√©m disso, se o seu cluster empregar um servidor de m√©tricas, ele relata poss√≠veis aloca√ß√µes excessivas ou insuficientes de recursos e tenta avis√°-lo caso seu cluster fique sem capacidade.

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics) encontra **vulnerabilidades de seguran√ßa**, problemas de conformidade e configura√ß√µes incorretas de infraestrutura nas seguintes solu√ß√µes de **Infraestrutura como C√≥digo**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM e especifica√ß√µes OpenAPI 3.0

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov) √© uma ferramenta de an√°lise de c√≥digo est√°tico para infraestrutura como c√≥digo.

Ele examina a infraestrutura em nuvem provisionada usando [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ou [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) e detecta configura√ß√µes incorretas de seguran√ßa e conformidade usando varredura baseada em gr√°fico.

### **Monitoramento com Falco**

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

## Dicas

### Kubernetes PodSecurityContext e SecurityContext

Voc√™ pode configurar o **contexto de seguran√ßa dos Pods** (com _PodSecurityContext_) e dos **cont√™ineres** que ser√£o executados (com _SecurityContext_). Para mais informa√ß√µes, leia:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API Hardening

√â muito importante **proteger o acesso ao servidor de API do Kubernetes**, pois um ator mal-intencionado com privil√©gios suficientes pode abusar dele e danificar o ambiente de v√°rias maneiras.\
√â importante proteger tanto o **acesso** (origens de **lista branca**