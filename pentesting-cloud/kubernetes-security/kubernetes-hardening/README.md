# Kubernetes Verharding

<details>

<summary><strong>Leer AWS hack vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Gereedskap om 'n cluster te analiseer

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) is 'n K8s oopbron-gereedskap wat 'n multi-cloud K8s enkelvenster bied, insluitend risiko-analise, sekuriteitsnakoming, RBAC-visualisering en skandering van beeldkwesbaarhede. Kubescape skandeer K8s-klusters, YAML-l√™ers en HELM-grafieke en identifiseer verkeerde konfigurasies volgens verskeie raamwerke (soos die [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), sagtewarekwesbaarhede en RBAC-oortredings (rolgebaseerde toegangsbeheer) in die vroe√´ stadiums van die CI/CD-pyplyn, bereken risikoscore onmiddellik en toon risikotendense oor tyd.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Die instrument [**kube-bench**](https://github.com/aquasecurity/kube-bench) is 'n instrument wat nagaan of Kubernetes veilig ge√Ømplementeer is deur die toetse uit te voer wat gedokumenteer is in die [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Jy kan kies om:

* kube-bench uit te voer van binne 'n houer (waar die PID-ruimte gedeel word met die gasheer)
* 'n houer te gebruik wat kube-bench op die gasheer installeer, en dan kube-bench direk op die gasheer uit te voer
* die nuutste binnerwerke van die [Vrystellingsbladsy](https://github.com/aquasecurity/kube-bench/releases) te installeer,
* dit van bron af saam te stel.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Die instrument [**kubeaudit**](https://github.com/Shopify/kubeaudit) is 'n opdraglyninstrument en 'n Go-pakket om **Kubernetes-klusters te oudit** vir verskeie sekuriteitskwessies.

Kubeaudit kan opspoor of dit binne 'n houer in 'n kluster uitgevoer word. As dit die geval is, sal dit probeer om alle Kubernetes-hulpbronne in daardie kluster te oudit:
```
kubeaudit all
```
Hierdie instrument het ook die argument `autofix` om **opgespoorde kwessies outomaties te herstel.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Die instrument [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) soek na sekuriteitskwessies in Kubernetes-klusters. Die instrument is ontwikkel om bewustheid en sigbaarheid vir sekuriteitskwessies in Kubernetes-omgewings te verhoog.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) is 'n hulpmiddel vir die skandering van kwesbaarhede en CIS Docker-benchmark wat gebruikers in staat stel om 'n akkurate en onmiddellike risiko-assessering van hul kubernetes-klusters te verkry. Kubei skandeer alle beelde wat in 'n Kubernetes-kluster gebruik word, insluitend beelde van toepassingspods en stelselpods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) is 'n hulpmiddel vir die skandering van 'n Kubernetes-kluster vir risikovolle toestemmings in Kubernetes se rolgebaseerde toegangsbeheer (RBAC) outoriseringsmodel.

## **Auditeer IaC-kode**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) is 'n hulpprogram wat 'n lewendige Kubernetes-kluster skandeer en **potensi√´le probleme met ge√Ømplementeerde hulpbronne en konfigurasies rapporteer**. Dit maak jou kluster skoon op grond van wat ge√Ømplementeer is en nie wat op skyf sit nie. Deur jou kluster te skandeer, identifiseer dit verkeerde konfigurasies en help dit om te verseker dat die beste praktyke in plek is, en voorkom dus toekomstige kopseer. Dit streef daarna om die kognitiewe oorlading te verminder wat 'n mens ervaar wanneer jy 'n Kubernetes-kluster in die wild bedryf. Verder, as jou kluster 'n metriek-bediener gebruik, rapporteer dit potensi√´le hulpbron-oor-/onder-toekenning en probeer dit jou waarsku as jou kluster uit kapasiteit loop.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) vind **sekuriteitskwesbaarhede**, nakomingsprobleme en infrastruktuurmisconfiguraties in die volgende **Infrastruktuur as Kode-oplossings**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM en OpenAPI 3.0-spesifikasies.

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) is 'n statiese kode-analisehulpmiddel vir infrastruktuur as kode.

Dit skandeer wolk-infrastruktuur wat voorsien is met behulp van [Terraform](https://terraform.io), Terraform-plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) of [ARM-sjablone](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) en identifiseer sekuriteits- en nakomingsmisconfiguraties deur middel van grafiekgebaseerde skandering.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) is 'n hulpmiddel wat statiese kode-analise van jou Kubernetes-objekdefinisies uitvoer.

Om te installeer:

| Verspreiding                                         | Opdrag / Skakel                                                                          |
| ---------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| Vooraf geboude bina√™re l√™ers vir macOS, Linux en Windows | [GitHub vrystellings](https://github.com/zegl/kube-score/releases)                          |
| Docker                                               | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS en Linux)                            | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS en Linux)    | `kubectl krew install score`                                                            |

## Wenke

### Kubernetes PodSecurityContext en SecurityContext

Jy kan die **sekuriteitskonteks van die Pods** (met _PodSecurityContext_) en van die **houers** wat uitgevoer gaan word, konfigureer (met _SecurityContext_). Vir meer inligting, lees:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API-verharding

Dit is baie belangrik om **toegang tot die Kubernetes API-bediener te beskerm**, aangesien 'n kwaadwillige aktor met genoeg voorregte dit kan misbruik en die omgewing op baie maniere kan beskadig.\
Dit is belangrik om beide die **toegang** (**witlys** oorspronge om toegang tot die API-bediener te verkry en enige ander verbinding te weier) en die [**outentisering**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (deur die beginsel van **minste** **voorreg** te volg) te beveilig. En beslis **nooit** **anonieme** **versoeke** toe te laat nie.

**Gewone versoekproses**:\
Gebruiker of K8s ServiceAccount ‚Äì> Outentisering ‚Äì> Outorisering ‚Äì> Toelatingsbeheer.

**Wenke**:

* Sluit porte.
* Vermy anonieme toegang.
* NodeRestriction; Geen toegang vanaf spesifieke nodes tot die API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Voorkom dat kubelets etikette byvoeg/verwyder/opdateer met 'n node-restriction.kubernetes.io/ voorvoegsel. Hierdie etiketvoorvoegsel is gereserveer vir administrateurs om hul Node-voorwerpe te etiketteer vir werklas-isolasiedoeleindes, en kubelets sal nie toegelaat word om etikette met daardie voorvoegsel te wysig nie.
* En laat ook toe dat kubelets hierdie etikette en etiketvoorvoegsels byvoeg/verwyder/opdateer.
* Verseker met etikette die veilige werklas-isolasie.
* Vermy spesifieke pods van API-toegang.
* Vermy blootstelling van ApiServer aan die internet.
* Vermy ongemagtigde toegang RBAC.
* ApiServer-poort met firewall en IP-witlys.
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)


### Algemene Verharding

Jy moet jou Kubernetes-omgewing so gereeld as nodig opdateer om te verseker dat:

* Afhanklikhede op datum is.
* Foute en sekuriteitspatches aangebring word.

[**Vrylatingsiklusse**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Elke 3 maande is daar 'n nuwe klein vrylating -- 1.20.3 = 1(Groot).20(Klein).3(patch)

**Die beste manier om 'n Kubernetes-kluster op te dateer is (vanaf** [**hier**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Opgradeer die Meester Node-komponente volgens hierdie volgorde:
* etcd (alle instansies).
* kube-apiserver (alle beheervlak-gashere).
* kube-controller-manager.
* kube-scheduler.
* wolkbeheerder, as jy een gebruik.
* Opgradeer die Werker Node-komponente soos kube-proxy, kubelet.

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
