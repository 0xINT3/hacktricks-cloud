# Kubernetes 强化

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## 分析集群的工具

### Kubescape

[**Kubescape**](https://github.com/armosec/kubescape) 是一个开源的 K8s 工具，提供了一个多云 K8s 单一视图，包括风险分析、安全合规性、RBAC 可视化和镜像漏洞扫描。Kubescape 可以扫描 K8s 集群、YAML 文件和 HELM 图表，根据多个框架（如 [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo)、[MITRE ATT\&CK®](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)）检测配置错误、软件漏洞和 RBAC（基于角色的访问控制）违规，并在 CI/CD 流水线的早期阶段计算风险评分，并显示风险趋势。
```bash
kubescape scan --verbose
```
### Kube-bench

工具[**kube-bench**](https://github.com/aquasecurity/kube-bench)是一个检查Kubernetes部署是否安全的工具，它运行了[CIS Kubernetes基准](https://www.cisecurity.org/benchmark/kubernetes/)中记录的检查项。\
您可以选择：

* 在容器内运行kube-bench（与主机共享PID命名空间）
* 运行一个在主机上安装kube-bench的容器，然后直接在主机上运行kube-bench
* 从[发布页面](https://github.com/aquasecurity/kube-bench/releases)安装最新的二进制文件
* 从源代码编译安装。

### Kubeaudit

工具[**kubeaudit**](https://github.com/Shopify/kubeaudit)是一个命令行工具和Go包，用于**审计Kubernetes集群**以检测各种安全问题。

Kubeaudit可以检测是否在集群中的容器中运行。如果是这样，它将尝试审计该集群中的所有Kubernetes资源：
```
kubeaudit all
```
这个工具还有一个参数`autofix`，用于**自动修复检测到的问题**。

### **Kube-hunter**

这个工具[**kube-hunter**](https://github.com/aquasecurity/kube-hunter)用于寻找Kubernetes集群中的安全弱点。该工具的开发旨在增加对Kubernetes环境中安全问题的认识和可见性。
```bash
kube-hunter --remote some.node.com
```
### **Kubei**

[**Kubei**](https://github.com/Erezf-p/kubei) 是一个漏洞扫描和CIS Docker基准工具，允许用户对他们的Kubernetes集群进行准确和即时的风险评估。Kubei扫描在Kubernetes集群中使用的所有镜像，包括应用程序Pod和系统Pod的镜像。

### KubiScan

[**KubiScan**](https://github.com/cyberark/KubiScan) 是一个用于扫描Kubernetes集群中Kubernetes基于角色的访问控制（RBAC）授权模型中的风险权限的工具。

## **审计IaC代码**

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye) 是一个实用程序，用于扫描活动的Kubernetes集群并**报告已部署资源和配置的潜在问题**。它根据已部署的内容而不是磁盘上的内容来清理集群。通过扫描集群，它检测配置错误并帮助您确保最佳实践得到落实，从而避免未来的麻烦。它旨在减少在野外操作Kubernetes集群时所面临的认知负担。此外，如果您的集群使用度量服务器，它会报告潜在的资源过度/不足分配，并在集群容量不足时尝试警告您。

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics) 在以下**基础设施即代码解决方案**中查找安全漏洞、合规性问题和基础设施配置错误：Terraform、Kubernetes、Docker、AWS CloudFormation、Ansible、Helm、Microsoft ARM和OpenAPI 3.0规范。

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov) 是一个用于基础设施即代码的静态代码分析工具。

它扫描使用[Terraform](https://terraform.io)、Terraform计划、[Cloudformation](https://aws.amazon.com/cloudformation/)、[AWS SAM](https://aws.amazon.com/serverless/sam/)、[Kubernetes](https://kubernetes.io)、[Dockerfile](https://www.docker.com)、[Serverless](https://www.serverless.com)或[ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview)进行云基础设施配置，并使用基于图的扫描检测安全和合规性配置错误。

### Kube-score

[**kube-score**](https://github.com/zegl/kube-score) 是一个对Kubernetes对象定义进行静态代码分析的工具。

安装方法：

| 发行版                                              | 命令/链接                                                                               |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| macOS、Linux和Windows的预构建二进制文件             | [GitHub发布](https://github.com/zegl/kube-score/releases)                               |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew（macOS和Linux）                             | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/)（macOS和Linux）    | `kubectl krew install score`                                                            |

## 提示

### 使用Falco进行监控

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

### Kubernetes PodSecurityContext和SecurityContext

您可以配置Pod的**安全上下文**（使用_PodSecurityContext_）和即将运行的**容器**的**安全上下文**（使用_SecurityContext_）。有关更多信息，请阅读：

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes API加固

保护对Kubernetes API服务器的访问非常重要，因为具有足够权限的恶意行为者可能会滥用它并以多种方式损害环境。\
重要的是要保护**访问**（将白名单的来源添加到API服务器的访问列表中，并拒绝任何其他连接）和[**身份验证**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/)（遵循**最小特权**原则）。绝对**不要**允许**匿名请求**。

**常见的请求流程：**\
用户或K8s ServiceAccount –> 身份验证 –> 授权 –> 准入控制。

**提示**：

* 关闭端口。
* 避免匿名访问。
* NodeRestriction；禁止特定节点访问API。
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* 基本上防止kubelet添加/删除/更新带有node-restriction.kubernetes.io/前缀的标签。此标签前缀保留给管理员为了工作负载隔离目的而为其节点对象标记，并且kubelet将不被允许修改带有该前缀的标签。
* 同时，允许kubelet添加/删除/更新这些标签和标签前缀。
* 使用标签确保安全的工作负载隔离。
* 避免特定Pod访问API。
* 避免将ApiServer暴露给互联网。
* 避免未经授权的访问RBAC。
* 使用防火墙和IP白名单对ApiServer端口进行保护。

### SecurityContext加固

如果未指定其他用户，Pod启动时将使用root用户。您可以使用类似以下模板的模板在更安全的上下文中运行应用程序：
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Kubernetes网络策略

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### 一般加固

您应该根据需要定期更新Kubernetes环境，以确保：

* 依赖项是最新的。
* 修复了漏洞和安全补丁。

[**发布周期**](https://kubernetes.io/docs/setup/release/version-skew-policy/)：每3个月会有一个新的次要版本发布 -- 1.20.3 = 1(主要).20(次要).3(补丁)

**更新Kubernetes集群的最佳方法是（来自** [**这里**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**）：**

* 按照以下顺序升级主节点组件：
* etcd（所有实例）。
* kube-apiserver（所有控制平面主机）。
* kube-controller-manager。
* kube-scheduler。
* 如果使用云控制器管理器，则升级云控制器管理器。
* 升级工作节点组件，如kube-proxy、kubelet。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
