# Kubernetes Absicherung

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>

## Tools zur Analyse eines Clusters

### [**Kubescape**](https://github.com/armosec/kubescape)

[**Kubescape**](https://github.com/armosec/kubescape) ist ein K8s Open-Source-Tool, das eine Multi-Cloud-K8s-Gesamt√ºbersicht bietet, einschlie√ülich Risikoanalyse, Sicherheitskonformit√§t, RBAC-Visualisierung und Scannen von Bildschwachstellen. Kubescape scannt K8s-Cluster, YAML-Dateien und HELM-Charts, erkennt Fehlkonfigurationen gem√§√ü mehrerer Frameworks (wie dem [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), Software-Schwachstellen und RBAC-Verst√∂√üe (rollenbasierte Zugriffskontrolle) in fr√ºhen Phasen des CI/CD-Pipelines, berechnet das Risikoscore sofort und zeigt Risikotrends im Laufe der Zeit an.
```bash
kubescape scan --verbose
```
### [**Kube-bench**](https://github.com/aquasecurity/kube-bench)

Das Tool [**kube-bench**](https://github.com/aquasecurity/kube-bench) ist ein Tool, das √ºberpr√ºft, ob Kubernetes sicher bereitgestellt ist, indem es die in der [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/) dokumentierten √úberpr√ºfungen ausf√ºhrt.\
Sie k√∂nnen w√§hlen:

* kube-bench innerhalb eines Containers ausf√ºhren (PID-Namespace mit dem Host teilen)
* Einen Container ausf√ºhren, der kube-bench auf dem Host installiert und dann kube-bench direkt auf dem Host ausf√ºhrt
* Die neuesten Bin√§rdateien von der [Releases-Seite](https://github.com/aquasecurity/kube-bench/releases) installieren,
* Es aus dem Quellcode kompilieren.

### [**Kubeaudit**](https://github.com/Shopify/kubeaudit)

Das Tool [**kubeaudit**](https://github.com/Shopify/kubeaudit) ist ein Befehlszeilentool und ein Go-Paket zum **Auditing von Kubernetes-Clustern** hinsichtlich verschiedener Sicherheitsbedenken.

Kubeaudit kann erkennen, ob es innerhalb eines Containers in einem Cluster ausgef√ºhrt wird. In diesem Fall wird versucht, alle Kubernetes-Ressourcen in diesem Cluster zu √ºberpr√ºfen:
```
kubeaudit all
```
Dieses Tool verf√ºgt auch √ºber das Argument `autofix`, um **automatisch erkannte Probleme zu beheben.**

### [**Kube-hunter**](https://github.com/aquasecurity/kube-hunter)

Das Tool [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) sucht nach Sicherheitsschwachstellen in Kubernetes-Clustern. Das Tool wurde entwickelt, um das Bewusstsein und die Sichtbarkeit f√ºr Sicherheitsprobleme in Kubernetes-Umgebungen zu erh√∂hen.
```bash
kube-hunter --remote some.node.com
```
### [**Kubei**](https://github.com/Erezf-p/kubei)

[**Kubei**](https://github.com/Erezf-p/kubei) ist ein Tool zur Schwachstellenanalyse und zur √úberpr√ºfung der CIS Docker-Benchmark, das es Benutzern erm√∂glicht, eine genaue und sofortige Risikobewertung ihrer Kubernetes-Cluster zu erhalten. Kubei scannt alle Bilder, die in einem Kubernetes-Cluster verwendet werden, einschlie√ülich Bilder von Anwendungspods und Systempods.

### [**KubiScan**](https://github.com/cyberark/KubiScan)

[**KubiScan**](https://github.com/cyberark/KubiScan) ist ein Tool zur √úberpr√ºfung des Kubernetes-Clusters auf riskante Berechtigungen im Rollenbasierten Zugriffskontrollmodell (RBAC) von Kubernetes.

## **Audit des IaC-Codes**

### [**Popeye**](https://github.com/derailed/popeye)

[**Popeye**](https://github.com/derailed/popeye) ist ein Dienstprogramm, das den live Kubernetes-Cluster scannt und potenzielle Probleme mit bereitgestellten Ressourcen und Konfigurationen meldet. Es bereinigt Ihren Cluster basierend auf dem, was bereitgestellt ist und nicht auf dem, was auf der Festplatte liegt. Durch das Scannen Ihres Clusters erkennt es Fehlkonfigurationen und hilft Ihnen sicherzustellen, dass bew√§hrte Verfahren eingehalten werden, um zuk√ºnftige Kopfschmerzen zu vermeiden. Es zielt darauf ab, die kognitive √úberlastung zu reduzieren, mit der man konfrontiert ist, wenn man einen Kubernetes-Cluster in freier Wildbahn betreibt. Dar√ºber hinaus meldet es potenzielle Ressourcen√ºber- oder -unterauslastungen, wenn Ihr Cluster einen Kapazit√§tsengpass hat, falls Ihr Cluster einen Metrik-Server verwendet.

### [**KICS**](https://github.com/Checkmarx/kics)

[**KICS**](https://github.com/Checkmarx/kics) findet Sicherheitsl√ºcken, Compliance-Probleme und Infrastrukturfehler in den folgenden L√∂sungen f√ºr Infrastruktur als Code: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM und OpenAPI 3.0-Spezifikationen

### [**Checkov**](https://github.com/bridgecrewio/checkov)

[**Checkov**](https://github.com/bridgecrewio/checkov) ist ein statisches Code-Analysetool f√ºr Infrastruktur als Code.

Es scannt Cloud-Infrastruktur, die mit Terraform, Terraform-Plan, Cloudformation, AWS SAM, Kubernetes, Dockerfile, Serverless oder ARM-Vorlagen bereitgestellt wurde, und erkennt Sicherheits- und Compliance-Fehlkonfigurationen mithilfe von graphenbasiertem Scannen.

### [**Kube-score**](https://github.com/zegl/kube-score)

[**kube-score**](https://github.com/zegl/kube-score) ist ein Tool, das eine statische Code-Analyse Ihrer Kubernetes-Objektdefinitionen durchf√ºhrt.

Zur Installation:

| Distribution                                        | Befehl / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Vorkompilierte Bin√§rdateien f√ºr macOS, Linux und Windows    | [GitHub-Ver√∂ffentlichungen](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS und Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS und Linux) | `kubectl krew install score`                                                            |

## Tipps

### Kubernetes PodSecurityContext und SecurityContext

Sie k√∂nnen den Sicherheitskontext der Pods (mit PodSecurityContext) und der Container, die ausgef√ºhrt werden sollen (mit SecurityContext), konfigurieren. Lesen Sie f√ºr weitere Informationen:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Kubernetes-API-H√§rtung

Es ist sehr wichtig, den Zugriff auf den Kubernetes-API-Server zu sch√ºtzen, da ein b√∂sartiger Akteur mit ausreichenden Berechtigungen diesen missbrauchen und die Umgebung auf vielf√§ltige Weise besch√§digen k√∂nnte. Es ist wichtig, sowohl den Zugriff (Whitelist von Urspr√ºngen zum Zugriff auf den API-Server und Ablehnung jeglicher anderer Verbindung) als auch die Authentifizierung zu sichern (nach dem Prinzip des geringsten Privilegs). Und definitiv keine anonymen Anfragen zulassen.

**G√§ngiger Anfrageprozess:**\
Benutzer oder K8s-Servicekonto ‚Äì> Authentifizierung ‚Äì> Autorisierung ‚Äì> Zulassungssteuerung.

**Tipps**:

* Ports schlie√üen.
* Anonymen Zugriff vermeiden.
* NodeRestriction; Kein Zugriff von bestimmten Knoten auf die API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Verhindert im Wesentlichen, dass Kubelets Labels mit einem node-restriction.kubernetes.io/-Pr√§fix hinzuf√ºgen/entfernen/aktualisieren. Dieser Label-Pr√§fix ist f√ºr Administratoren reserviert, um ihre Knotenobjekte f√ºr Zwecke der Arbeitslastisolierung zu kennzeichnen, und Kubelets d√ºrfen Labels mit diesem Pr√§fix nicht √§ndern.
* Und erlaubt es auch Kubelets, diese Labels und Label-Pr√§fixe hinzuzuf√ºgen/entfernen/aktualisieren.
* Stellen Sie mit Labels die sichere Arbeitslastisolierung sicher.
* Bestimmte Pods vom API-Zugriff ausschlie√üen.
* Exposition des ApiServers ins Internet vermeiden.
* Unberechtigten Zugriff RBAC vermeiden.
* ApiServer-Port mit Firewall und IP-Whitelisting sichern.

### SecurityContext-H√§rtung

Standardm√§√üig wird der Root-Benutzer verwendet, wenn ein Pod gestartet wird, wenn kein anderer Benutzer angegeben ist. Sie k√∂nnen Ihre Anwendung in einem sichereren Kontext ausf√ºhren, indem Sie eine Vorlage √§hnlich der folgenden verwenden:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)


### Allgemeine H√§rtung

Sie sollten Ihre Kubernetes-Umgebung so h√§ufig wie n√∂tig aktualisieren, um sicherzustellen, dass:

* Abh√§ngigkeiten auf dem neuesten Stand sind.
* Fehler und Sicherheitspatches eingespielt sind.

[**Versionszyklen**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Alle 3 Monate gibt es ein neues Minor-Release -- 1.20.3 = 1(Major).20(Minor).3(patch)

**Der beste Weg, ein Kubernetes-Cluster zu aktualisieren, ist (von** [**hier**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Aktualisieren Sie die Master-Komponenten in folgender Reihenfolge:
* etcd (alle Instanzen).
* kube-apiserver (alle Steuerungsebene-Hosts).
* kube-controller-manager.
* kube-scheduler.
* Cloud-Controller-Manager, wenn Sie einen verwenden.
* Aktualisieren Sie die Worker-Node-Komponenten wie kube-proxy, kubelet.

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
