# Endurecimiento de Kubernetes

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Herramientas

### Kubescape

[**Kubescape**](https://github.com/armosec/kubescape) es una herramienta de c√≥digo abierto de K8s que proporciona una √∫nica vista de m√∫ltiples nubes de K8s, incluyendo an√°lisis de riesgos, cumplimiento de seguridad, visualizador de RBAC y escaneo de vulnerabilidades de im√°genes. Kubescape escanea cl√∫steres K8s, archivos YAML y gr√°ficos HELM, detectando configuraciones incorrectas seg√∫n m√∫ltiples marcos (como [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software y violaciones de RBAC (control de acceso basado en roles) en las primeras etapas del pipeline CI/CD, calcula la puntuaci√≥n de riesgo al instante y muestra las tendencias de riesgo con el tiempo.

### Kube-bench

La herramienta [**kube-bench**](https://github.com/aquasecurity/kube-bench) es una herramienta que verifica si Kubernetes se implementa de manera segura ejecutando las comprobaciones documentadas en el [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Puedes elegir:

* ejecutar kube-bench desde dentro de un contenedor (compartiendo el espacio de nombres PID con el host)
* ejecutar un contenedor que instala kube-bench en el host y luego ejecutar kube-bench directamente en el host
* instalar los √∫ltimos binarios desde la [p√°gina de versiones](https://github.com/aquasecurity/kube-bench/releases),
* compilarlo desde el c√≥digo fuente.

### Kubeaudit

La herramienta [**kubeaudit**](https://github.com/Shopify/kubeaudit) es una herramienta de l√≠nea de comandos y un paquete Go para **auditar cl√∫steres de Kubernetes** para diversas preocupaciones de seguridad diferentes.

Kubeaudit puede detectar si se est√° ejecutando dentro de un contenedor en un cl√∫ster. Si es as√≠, intentar√° auditar todos los recursos de Kubernetes en ese cl√∫ster:

```
kubeaudit all
```

Esta herramienta tambi√©n tiene el argumento `autofix` para **corregir autom√°ticamente los problemas detectados.**

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye) es una utilidad que escanea el cl√∫ster de Kubernetes en vivo y **reporta posibles problemas con los recursos y configuraciones implementados**. Sanitiza tu cl√∫ster en funci√≥n de lo que est√° implementado y no de lo que est√° en el disco. Al escanear tu cl√∫ster, detecta configuraciones incorrectas y te ayuda a asegurarte de que se implementen las mejores pr√°cticas, evitando as√≠ dolores de cabeza futuros. Su objetivo es reducir la sobrecarga cognitiva que uno enfrenta al operar un cl√∫ster de Kubernetes en la naturaleza. Adem√°s, si tu cl√∫ster emplea un servidor de m√©tricas, informa posibles asignaciones de recursos excesivas o insuficientes e intenta advertirte si tu cl√∫ster se queda sin capacidad.

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics) encuentra **vulnerabilidades de seguridad**, problemas de cumplimiento y configuraciones incorrectas de infraestructura en las siguientes soluciones de **infraestructura como c√≥digo**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM y especificaciones OpenAPI 3.0

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov) es una herramienta de an√°lisis de c√≥digo est√°tico para infraestructura como c√≥digo.

Escanea la infraestructura en la nube provista utilizando [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) o [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) y detecta configuraciones incorrectas de seguridad y cumplimiento utilizando un escaneo basado en gr√°ficos.

### **Monitoreo con Falco**

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

## Consejos

### Kubernetes PodSecurityContext y SecurityContext

Puedes configurar el **contexto de seguridad de los Pods** (con _PodSecurityContext_) y de los **contenedores** que se van a ejecutar (con _SecurityContext_). Para obtener m√°s informaci√≥n, lee:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Endurecimiento de la API de Kubernetes

Es muy importante **proteger el acceso al servidor de API de Kubernetes** ya que un actor malintencionado con suficientes privilegios podr√≠a abusar de √©l y da√±ar de muchas maneras el entorno.\
Es importante asegurar tanto el **acceso** (origenes en la lista blanca para acceder al servidor de API y denegar cualquier otra conexi√≥n) como la [**autenticaci√≥n**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (siguiendo el