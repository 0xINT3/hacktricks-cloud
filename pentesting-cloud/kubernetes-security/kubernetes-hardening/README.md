# Fortalecimiento de Kubernetes

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop).
* Obt칠n [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Herramientas para analizar un cl칰ster

### Kubescape

[**Kubescape**](https://github.com/armosec/kubescape) es una herramienta de c칩digo abierto para K8s que proporciona una vista 칰nica de m칰ltiples nubes de K8s, incluyendo an치lisis de riesgos, cumplimiento de seguridad, visualizador de RBAC y escaneo de vulnerabilidades de im치genes. Kubescape escanea cl칰steres de K8s, archivos YAML y gr치ficos HELM, detectando configuraciones incorrectas seg칰n varios marcos (como [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK춽](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software y violaciones de RBAC (control de acceso basado en roles) en las primeras etapas del pipeline de CI/CD, calcula el puntaje de riesgo al instante y muestra las tendencias de riesgo a lo largo del tiempo.
```bash
kubescape scan --verbose
```
### Kube-bench

La herramienta [**kube-bench**](https://github.com/aquasecurity/kube-bench) es una herramienta que verifica si Kubernetes est치 implementado de manera segura ejecutando las verificaciones documentadas en el [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Puedes elegir:

* ejecutar kube-bench desde dentro de un contenedor (compartiendo el espacio de nombres PID con el host)
* ejecutar un contenedor que instale kube-bench en el host y luego ejecutar kube-bench directamente en el host
* instalar los 칰ltimos binarios desde la [p치gina de lanzamientos](https://github.com/aquasecurity/kube-bench/releases),
* compilarlo desde el c칩digo fuente.

### Kubeaudit

La herramienta [**kubeaudit**](https://github.com/Shopify/kubeaudit) es una herramienta de l칤nea de comandos y un paquete Go para **auditar cl칰steres de Kubernetes** en busca de diversas preocupaciones de seguridad.

Kubeaudit puede detectar si se est치 ejecutando dentro de un contenedor en un cl칰ster. Si es as칤, intentar치 auditar todos los recursos de Kubernetes en ese cl칰ster:
```
kubeaudit all
```
Esta herramienta tambi칠n tiene el argumento `autofix` para **corregir autom치ticamente los problemas detectados.**

### **Kube-hunter**

La herramienta [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) busca debilidades de seguridad en cl칰steres de Kubernetes. La herramienta fue desarrollada para aumentar la conciencia y visibilidad de los problemas de seguridad en entornos de Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### **Kubei**

[Kubei](https://github.com/Erezf-p/kubei) es una herramienta de escaneo de vulnerabilidades y benchmark de CIS Docker que permite a los usuarios obtener una evaluaci칩n precisa e inmediata del riesgo de sus cl칰steres de Kubernetes. Kubei escanea todas las im치genes que se utilizan en un cl칰ster de Kubernetes, incluyendo im치genes de pods de aplicaciones y pods del sistema.

### KubiScan

[KubiScan](https://github.com/cyberark/KubiScan) es una herramienta para escanear cl칰steres de Kubernetes en busca de permisos riesgosos en el modelo de autorizaci칩n de control de acceso basado en roles (RBAC) de Kubernetes.

## **Auditar c칩digo IaC**

### **Popeye**

[Popeye](https://github.com/derailed/popeye) es una utilidad que escanea un cl칰ster de Kubernetes en vivo y **reporta posibles problemas con los recursos y configuraciones implementados**. Limpia tu cl칰ster en funci칩n de lo que est치 implementado y no de lo que est치 en el disco. Al escanear tu cl칰ster, detecta configuraciones incorrectas y te ayuda a asegurarte de que se sigan las mejores pr치cticas, evitando as칤 futuros dolores de cabeza. Su objetivo es reducir la sobrecarga cognitiva que se enfrenta al operar un cl칰ster de Kubernetes en la naturaleza. Adem치s, si tu cl칰ster utiliza un servidor de m칠tricas, informa posibles asignaciones de recursos excesivas o insuficientes e intenta advertirte si tu cl칰ster se queda sin capacidad.

### **Kicks**

[KICS](https://github.com/Checkmarx/kics) encuentra vulnerabilidades de seguridad, problemas de cumplimiento y configuraciones incorrectas de infraestructura en las siguientes soluciones de Infraestructura como C칩digo: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM y especificaciones de OpenAPI 3.0.

### Checkov

[Checkov](https://github.com/bridgecrewio/checkov) es una herramienta de an치lisis de c칩digo est치tico para infraestructura como c칩digo.

Escanea la infraestructura en la nube provisionada utilizando [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) o [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) y detecta configuraciones incorrectas de seguridad y cumplimiento utilizando un escaneo basado en gr치ficos.

### Kube-score

[kube-score](https://github.com/zegl/kube-score) es una herramienta que realiza an치lisis de c칩digo est치tico de las definiciones de objetos de Kubernetes.

Para instalar:

| Distribuci칩n                                        | Comando / Enlace                                                                         |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Binarios precompilados para macOS, Linux y Windows   | [Liberaciones de GitHub](https://github.com/zegl/kube-score/releases)                    |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS y Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS y Linux) | `kubectl krew install score`                                                            |

## Consejos

### Monitoreo con Falco

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

### Kubernetes PodSecurityContext y SecurityContext

Puedes configurar el **contexto de seguridad de los Pods** (con _PodSecurityContext_) y de los **contenedores** que se van a ejecutar (con _SecurityContext_). Para obtener m치s informaci칩n, lee:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Reforzamiento de la API de Kubernetes

Es muy importante **proteger el acceso al servidor de API de Kubernetes**, ya que un actor malintencionado con suficientes privilegios podr칤a abusar de 칠l y da침ar el entorno de muchas maneras.\
Es importante asegurar tanto el **acceso** (permitiendo solo el acceso a or칤genes espec칤ficos al servidor de API y denegando cualquier otra conexi칩n) como la [**autenticaci칩n**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (siguiendo el principio de **privilegio m칤nimo**). Y definitivamente **nunca permitas solicitudes an칩nimas**.

**Proceso de solicitud com칰n:**\
Usuario o cuenta de servicio de K8s -> Autenticaci칩n -> Autorizaci칩n -> Control de admisi칩n.

**Consejos**:

* Cerrar puertos.
* Evitar el acceso an칩nimo.
* Restricci칩n de nodos; Sin acceso desde nodos espec칤ficos a la API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* B치sicamente evita que los kubelets agreguen/eliminen/actualicen etiquetas con un prefijo node-restriction.kubernetes.io/. Este prefijo de etiqueta est치 reservado para que los administradores etiqueten sus objetos de nodo con fines de aislamiento de carga de trabajo, y los kubelets no podr치n modificar etiquetas con ese prefijo.
* Y tambi칠n permite a los kubelets agregar/eliminar/actualizar estas etiquetas y prefijos de etiquetas.
* Aseg칰rate con etiquetas el aislamiento seguro de la carga de trabajo.
* Evitar que pods espec칤ficos accedan a la API.
* Evitar la exposici칩n del ApiServer a Internet.
* Evitar el acceso no autorizado de RBAC.
* Puerto de ApiServer con firewall y lista blanca de direcciones IP.

### Reforzamiento del SecurityContext

Por defecto, se utilizar치 el usuario root cuando se inicie un Pod si no se especifica otro usuario. Puedes ejecutar tu aplicaci칩n dentro de un contexto m치s seguro utilizando una plantilla similar a la siguiente:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Pol칤ticas de red de Kubernetes

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### Fortalecimiento general

Deber칤as actualizar tu entorno de Kubernetes con la frecuencia necesaria para tener:

* Dependencias actualizadas.
* Parches de errores y seguridad.

[**Ciclos de lanzamiento**](https://kubernetes.io/docs/setup/release/version-skew-policy/): Cada 3 meses hay un nuevo lanzamiento menor -- 1.20.3 = 1(Mayor).20(Menor).3(parche)

**La mejor manera de actualizar un cl칰ster de Kubernetes es (desde** [**aqu칤**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Actualiza los componentes del nodo maestro siguiendo esta secuencia:
* etcd (todas las instancias).
* kube-apiserver (todos los hosts del plano de control).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, si lo usas.
* Actualiza los componentes del nodo trabajador como kube-proxy, kubelet.

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
