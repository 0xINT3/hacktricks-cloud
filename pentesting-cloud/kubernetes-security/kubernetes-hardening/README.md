# Fortalecimento do Kubernetes

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

## Ferramentas para analisar um cluster

### Kubescape

[**Kubescape**](https://github.com/armosec/kubescape) √© uma ferramenta de c√≥digo aberto do K8s que fornece uma vis√£o √∫nica do K8s em v√°rias nuvens, incluindo an√°lise de riscos, conformidade de seguran√ßa, visualizador de RBAC e verifica√ß√£o de vulnerabilidades de imagem. O Kubescape escaneia clusters K8s, arquivos YAML e gr√°ficos HELM, detectando configura√ß√µes incorretas de acordo com v√°rios frameworks (como o [NSA-CISA](https://www.armosec.io/blog/kubernetes-hardening-guidance-summary-by-armo), [MITRE ATT\&CK¬Æ](https://www.microsoft.com/security/blog/2021/03/23/secure-containerized-environments-with-updated-threat-matrix-for-kubernetes/)), vulnerabilidades de software e viola√ß√µes de RBAC (controle de acesso baseado em fun√ß√£o) nas primeiras etapas do pipeline CI/CD, calcula a pontua√ß√£o de risco instantaneamente e mostra as tend√™ncias de risco ao longo do tempo.
```bash
kubescape scan --verbose
```
### Kube-bench

A ferramenta [**kube-bench**](https://github.com/aquasecurity/kube-bench) √© uma ferramenta que verifica se o Kubernetes est√° implantado de forma segura, executando as verifica√ß√µes documentadas no [**CIS Kubernetes Benchmark**](https://www.cisecurity.org/benchmark/kubernetes/).\
Voc√™ pode escolher:

* executar o kube-bench de dentro de um cont√™iner (compartilhando o namespace PID com o host)
* executar um cont√™iner que instala o kube-bench no host e, em seguida, executar o kube-bench diretamente no host
* instalar os bin√°rios mais recentes na [p√°gina de lan√ßamentos](https://github.com/aquasecurity/kube-bench/releases),
* compil√°-lo a partir do c√≥digo-fonte.

### Kubeaudit

A ferramenta [**kubeaudit**](https://github.com/Shopify/kubeaudit) √© uma ferramenta de linha de comando e um pacote Go para **auditar clusters Kubernetes** em rela√ß√£o a v√°rias preocupa√ß√µes de seguran√ßa diferentes.

O kubeaudit pode detectar se est√° sendo executado dentro de um cont√™iner em um cluster. Se sim, ele tentar√° auditar todos os recursos do Kubernetes nesse cluster:
```
kubeaudit all
```
Esta ferramenta tamb√©m possui o argumento `autofix` para **corrigir automaticamente os problemas detectados.**

### **Kube-hunter**

A ferramenta [**kube-hunter**](https://github.com/aquasecurity/kube-hunter) busca por vulnerabilidades de seguran√ßa em clusters Kubernetes. A ferramenta foi desenvolvida para aumentar a conscientiza√ß√£o e visibilidade de problemas de seguran√ßa em ambientes Kubernetes.
```bash
kube-hunter --remote some.node.com
```
### **Kubei**

[**Kubei**](https://github.com/Erezf-p/kubei) √© uma ferramenta de varredura de vulnerabilidades e benchmark CIS Docker que permite aos usu√°rios obter uma avalia√ß√£o precisa e imediata do risco de seus clusters Kubernetes. O Kubei verifica todas as imagens que est√£o sendo usadas em um cluster Kubernetes, incluindo imagens de pods de aplicativos e pods de sistema.

## **Auditoria de C√≥digo IaC**

### **Popeye**

[**Popeye**](https://github.com/derailed/popeye) √© uma utilidade que verifica o cluster Kubernetes em tempo real e **relata poss√≠veis problemas com recursos e configura√ß√µes implantados**. Ele limpa seu cluster com base no que est√° implantado e n√£o no que est√° no disco. Ao verificar seu cluster, ele detecta configura√ß√µes incorretas e ajuda a garantir que as melhores pr√°ticas estejam em vigor, evitando assim dores de cabe√ßa futuras. Seu objetivo √© reduzir a sobrecarga cognitiva enfrentada ao operar um cluster Kubernetes no ambiente real. Al√©m disso, se o seu cluster usa um metric-server, ele relata poss√≠veis aloca√ß√µes excessivas ou insuficientes de recursos e tenta avis√°-lo caso o cluster fique sem capacidade.

### **Kicks**

[**KICS**](https://github.com/Checkmarx/kics) encontra **vulnerabilidades de seguran√ßa**, problemas de conformidade e configura√ß√µes incorretas de infraestrutura nas seguintes solu√ß√µes de **Infraestrutura como C√≥digo**: Terraform, Kubernetes, Docker, AWS CloudFormation, Ansible, Helm, Microsoft ARM e especifica√ß√µes OpenAPI 3.0.

### Checkov

[**Checkov**](https://github.com/bridgecrewio/checkov) √© uma ferramenta de an√°lise de c√≥digo est√°tico para infraestrutura como c√≥digo.

Ele verifica a infraestrutura em nuvem provisionada usando [Terraform](https://terraform.io), Terraform plan, [Cloudformation](https://aws.amazon.com/cloudformation/), [AWS SAM](https://aws.amazon.com/serverless/sam/), [Kubernetes](https://kubernetes.io), [Dockerfile](https://www.docker.com), [Serverless](https://www.serverless.com) ou [ARM Templates](https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/overview) e detecta configura√ß√µes incorretas de seguran√ßa e conformidade usando varredura baseada em gr√°ficos.

### Kube-score

[**kube-score**](https://github.com/zegl/kube-score) √© uma ferramenta que realiza an√°lise de c√≥digo est√°tico das defini√ß√µes de objetos Kubernetes.

Para instalar:

| Distribui√ß√£o                                        | Comando / Link                                                                          |
| --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| Bin√°rios pr√©-compilados para macOS, Linux e Windows | [GitHub releases](https://github.com/zegl/kube-score/releases)                          |
| Docker                                              | `docker pull zegl/kube-score` ([Docker Hub)](https://hub.docker.com/r/zegl/kube-score/) |
| Homebrew (macOS e Linux)                          | `brew install kube-score`                                                               |
| [Krew](https://krew.sigs.k8s.io/) (macOS e Linux) | `kubectl krew install score`                                                            |

## Dicas

### Monitoramento com Falco

{% content-ref url="monitoring-with-falco.md" %}
[monitoring-with-falco.md](monitoring-with-falco.md)
{% endcontent-ref %}

### Kubernetes PodSecurityContext e SecurityContext

Voc√™ pode configurar o **contexto de seguran√ßa dos Pods** (com _PodSecurityContext_) e dos **containers** que ser√£o executados (com _SecurityContext_). Para mais informa√ß√µes, leia:

{% content-ref url="kubernetes-securitycontext-s.md" %}
[kubernetes-securitycontext-s.md](kubernetes-securitycontext-s.md)
{% endcontent-ref %}

### Fortalecimento da API do Kubernetes

√â muito importante **proteger o acesso ao servidor de API do Kubernetes**, pois um ator malicioso com privil√©gios suficientes pode abusar dele e causar danos ao ambiente de v√°rias maneiras.\
√â importante garantir tanto o **acesso** (**listar** as origens para acessar o servidor de API e negar qualquer outra conex√£o) quanto a [**autentica√ß√£o**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-authentication-authorization/) (seguindo o princ√≠pio do **privil√©gio** **m√≠nimo**). E definitivamente **nunca** **permita** **solicita√ß√µes** **an√¥nimas**.

**Processo de solicita√ß√£o comum:**\
Usu√°rio ou Conta de Servi√ßo K8s -> Autentica√ß√£o -> Autoriza√ß√£o -> Controle de Admiss√£o.

**Dicas**:

* Feche as portas.
* Evite o acesso an√¥nimo.
* Restri√ß√£o de N√≥; Sem acesso de n√≥s espec√≠ficos √† API.
* [https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction](https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction)
* Basicamente, impede que os kubelets adicionem/removam/atualizem r√≥tulos com o prefixo node-restriction.kubernetes.io/. Esse prefixo de r√≥tulo √© reservado para administradores rotularem seus objetos Node para fins de isolamento de carga de trabalho, e os kubelets n√£o poder√£o modificar r√≥tulos com esse prefixo.
* E tamb√©m permite que os kubelets adicionem/removam/atualizem esses r√≥tulos e prefixos de r√≥tulos.
* Garanta com r√≥tulos o isolamento seguro da carga de trabalho.
* Evite que pods espec√≠ficos acessem a API.
* Evite a exposi√ß√£o do ApiServer √† internet.
* Evite acesso n√£o autorizado RBAC.
* Porta do ApiServer com firewall e lista de permiss√µes de IP.

### Fortalecimento do SecurityContext

Por padr√£o, o usu√°rio root ser√° usado quando um Pod for iniciado, se nenhum outro usu√°rio for especificado. Voc√™ pode executar seu aplicativo em um contexto mais seguro usando um modelo semelhante ao seguinte:
```yaml
apiVersion: v1
kind: Pod
metadata:
name: security-context-demo
spec:
securityContext:
runAsUser: 1000
runAsGroup: 3000
fsGroup: 2000
volumes:
- name: sec-ctx-vol
emptyDir: {}
containers:
- name: sec-ctx-demo
image: busybox
command: [ "sh", "-c", "sleep 1h" ]
securityContext:
runAsNonRoot: true
volumeMounts:
- name: sec-ctx-vol
mountPath: /data/demo
securityContext:
allowPrivilegeEscalation: true
```
* [https://kubernetes.io/docs/tasks/configure-pod-container/security-context/](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
* [https://kubernetes.io/docs/concepts/policy/pod-security-policy/](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)

### Pol√≠ticas de Rede do Kubernetes

{% content-ref url="kubernetes-networkpolicies.md" %}
[kubernetes-networkpolicies.md](kubernetes-networkpolicies.md)
{% endcontent-ref %}

### Refor√ßo Geral

Voc√™ deve atualizar seu ambiente Kubernetes com a frequ√™ncia necess√°ria para ter:

* Depend√™ncias atualizadas.
* Corre√ß√µes de bugs e seguran√ßa.

[**Ciclos de lan√ßamento**](https://kubernetes.io/docs/setup/release/version-skew-policy/): A cada 3 meses, h√° um novo lan√ßamento menor -- 1.20.3 = 1(Major).20(Minor).3(patch)

**A melhor maneira de atualizar um Cluster Kubernetes √© (a partir** [**daqui**](https://kubernetes.io/docs/tasks/administer-cluster/cluster-upgrade/)**):**

* Atualize os componentes do N√≥ Mestre seguindo esta sequ√™ncia:
* etcd (todas as inst√¢ncias).
* kube-apiserver (todos os hosts do plano de controle).
* kube-controller-manager.
* kube-scheduler.
* cloud controller manager, se voc√™ usar um.
* Atualize os componentes do N√≥ de Trabalho, como kube-proxy, kubelet.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
