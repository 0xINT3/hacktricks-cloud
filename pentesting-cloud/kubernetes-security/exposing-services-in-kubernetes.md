# 在Kubernetes中暴露服务

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

在Kubernetes中，有**不同的方法来暴露服务**，以便**内部**和**外部**端点都可以访问它们。这个Kubernetes的配置非常关键，因为管理员可能会给**攻击者访问他们不应该访问的服务的权限**。

### 自动枚举

在开始枚举K8s提供的将服务暴露给公众的方式之前，请注意，如果您可以列出命名空间、服务和入口点，您可以使用以下命令找到所有对公众开放的内容：
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP**服务是Kubernetes的**默认**服务。它为您的集群提供了一个其他应用程序可以访问的**集群内部服务**。没有**外部访问**。

但是，可以使用Kubernetes代理访问此服务：
```
kubectl proxy --port=8080
```
现在，您可以通过以下方式浏览Kubernetes API以访问服务：

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

例如，您可以使用以下URL：

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

来访问此服务：
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_这种方法要求您以**已认证的用户**身份运行`kubectl`。_

### NodePort

**NodePort在所有节点**（虚拟机）上打开一个特定的端口，任何发送到该端口的**流量**都会被**转发到服务**。通常这是一个非常糟糕的选项。

NodePort规范的示例：
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
如果您在yaml中**不指定**nodePort（它是将要打开的端口），则将使用**30000-32767范围内的端口**。

### LoadBalancer <a href="#0d96" id="0d96"></a>

使用**云提供商的负载均衡器**将服务公开给外部。在GKE上，这将启动一个[网络负载均衡器](https://cloud.google.com/compute/docs/load-balancing/network/)，该负载均衡器将为您提供一个单一的IP地址，将所有流量转发到您的服务。

您需要为每个公开的服务支付负载均衡器费用，这可能会很昂贵。

### ExternalName

ExternalName类型的服务将**将服务映射到DNS名称**，而不是典型的选择器，如`my-service`或`cassandra`。您可以使用`spec.externalName`参数指定这些服务。

例如，以下服务定义将`prod`命名空间中的`my-service`服务映射到`my.database.example.com`：
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
当查找主机`my-service.prod.svc.cluster.local`时，集群DNS服务返回一个值为`my.database.example.com`的`CNAME`记录。访问`my-service`的方式与其他服务相同，但关键区别在于**重定向发生在DNS层面**，而不是通过代理或转发。

### 外部IP <a href="#external-ips" id="external-ips"></a>

以**外部IP**（作为**目标IP**）进入集群的流量，将被**路由到其中一个服务端点**。`externalIPs`不由Kubernetes管理，而是由集群管理员负责。

在服务规范中，可以与任何`ServiceTypes`一起指定`externalIPs`。在下面的示例中，"`my-service`"可以通过"`80.11.12.10:80`"（`externalIP:port`）访问。
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### Ingress

与上述所有示例不同，**Ingress不是一种服务类型**。相反，它位于多个服务之前，充当“智能路由器”或集群的入口点。

您可以使用Ingress执行许多不同的操作，并且有**许多不同功能的Ingress控制器**。

默认的GKE Ingress控制器将为您创建一个[HTTP(S)负载均衡器](https://cloud.google.com/compute/docs/load-balancing/http/)。这将使您能够对后端服务进行基于路径和子域的路由。例如，您可以将foo.yourdomain.com的所有内容发送到foo服务，将yourdomain.com/bar/路径下的所有内容发送到bar服务。

在GKE上使用[L7 HTTP负载均衡器](https://cloud.google.com/compute/docs/load-balancing/http/)的Ingress对象的YAML可能如下所示：
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
### 参考资料

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
