# Kubernetesでのサービスの公開

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**PEASSの最新バージョンをダウンロードしたりHackTricksをPDFで入手**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

Kubernetesでは、**内部**エンドポイントと**外部**エンドポイントの両方がアクセスできるようにするために、**さまざまな方法でサービスを公開**することができます。このKubernetesの設定は非常に重要です。なぜなら、管理者が**攻撃者にアクセスすべきではないサービスへのアクセス権を与える**可能性があるからです。

### 自動列挙

公開されたサービスを見つけるために、K8sが提供する公開方法を列挙する前に、ネームスペース、サービス、イングレスをリストアップできれば、次のコマンドで公開されているすべてを見つけることができます：
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP**サービスは、Kubernetesの**デフォルト**サービスです。これにより、クラスタ内の他のアプリからアクセスできるクラスタ内の**サービス**が提供されます。**外部からのアクセスはできません**。

ただし、Kubernetesプロキシを使用してアクセスすることができます：
```
kubectl proxy --port=8080
```
今、Kubernetes APIを介してサービスにアクセスするために、次のスキームを使用できます：

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

例えば、次のURLを使用することができます：

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

このサービスにアクセスするために：
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_この方法では、`kubectl`を**認証済みユーザー**として実行する必要があります。_

### NodePort

**NodePortは、すべてのノード**（VM）で特定のポートを開き、このポートに送信される**トラフィックをサービスに転送**します。通常、これは非常に悪いオプションです。

NodePortの仕様の例：
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
もしyamlで**nodePort**を指定しない場合（これは開かれるポートです）、**30000から32767の範囲のポートが使用されます**。

### LoadBalancer <a href="#0d96" id="0d96"></a>

クラウドプロバイダのロードバランサを使用して、Serviceを外部に公開します。GKEでは、これにより[ネットワークロードバランサ](https://cloud.google.com/compute/docs/load-balancing/network/)が起動し、すべてのトラフィックをServiceに転送する単一のIPアドレスが提供されます。

ServiceごとにLoadBalancerを支払う必要があり、費用がかかる場合があります。

### ExternalName

ExternalNameタイプのServiceは、Serviceを通常のセレクタ（`my-service`や`cassandra`など）ではなく、DNS名にマップします。これらのServiceは、`spec.externalName`パラメータで指定します。

たとえば、次のService定義は、`prod`ネームスペースの`my-service` Serviceを`my.database.example.com`にマップします。
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
ホスト`my-service.prod.svc.cluster.local`を検索すると、クラスタDNSサービスは値が`my.database.example.com`である`CNAME`レコードを返します。`my-service`へのアクセスは他のサービスと同様に機能しますが、重要な違いは**リダイレクションがDNSレベルで発生する**ということです。プロキシやフォワーディングではなく、DNSレベルでリダイレクションが行われます。

### 外部IP <a href="#external-ips" id="external-ips"></a>

クラスタに入ってくるトラフィックは、**外部IP**（**宛先IP**）を使用して、Serviceポートにルーティングされ、Serviceのエンドポイントの1つに転送されます。`externalIPs`はKubernetesでは管理されず、クラスタ管理者の責任です。

Serviceの仕様では、`externalIPs`を`ServiceTypes`と共に指定することができます。以下の例では、"`my-service`"はクライアントが"`80.11.12.10:80`"（`externalIP:port`）でアクセスできます。
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### Ingress（イングレス）

上記の例とは異なり、**Ingressはサービスの一種ではありません**。代わりに、複数のサービスの前に配置され、クラスタへのエントリーポイントとして機能する「スマートルーター」として機能します。

Ingressではさまざまなことができ、**さまざまな機能を持つIngressコントローラーが存在します**。

デフォルトのGKE Ingressコントローラーは、[HTTP(S)ロードバランサー](https://cloud.google.com/compute/docs/load-balancing/http/)を起動します。これにより、パスベースおよびサブドメインベースのルーティングをバックエンドサービスに対して行うことができます。たとえば、foo.yourdomain.comのすべてをfooサービスに送信し、yourdomain.com/bar/パスのすべてをbarサービスに送信することができます。

GKE上のIngressオブジェクトのYAMLファイルは、[L7 HTTPロードバランサー](https://cloud.google.com/compute/docs/load-balancing/http/)を使用する場合、次のようになります：
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
### 参考文献

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れる
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
