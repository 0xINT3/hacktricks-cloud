# Exponiendo servicios en Kubernetes

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Existen **diferentes formas de exponer servicios** en Kubernetes para que tanto los puntos finales **internos** como los **externos** puedan acceder a ellos. Esta configuraci√≥n de Kubernetes es bastante cr√≠tica ya que el administrador podr√≠a dar acceso a **atacantes a servicios a los que no deber√≠an poder acceder**.

### Enumeraci√≥n autom√°tica

Antes de comenzar a enumerar las formas en que K8s ofrece para exponer servicios al p√∫blico, sepa que si puede listar los espacios de nombres, los servicios y los ingresos, puede encontrar todo lo expuesto al p√∫blico con:

```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
    echo "Namespace: $ns"
    kubectl get service -n "$ns"
    kubectl get ingress -n "$ns"
    echo "=============================================="
    echo ""
    echo ""
done | grep -v "ClusterIP"
# Elimine el √∫ltimo '| grep -v "ClusterIP"' para ver tambi√©n el tipo ClusterIP
```

### ClusterIP

Un servicio **ClusterIP** es el servicio **predeterminado** de Kubernetes. Le proporciona un **servicio interno** en su cl√∫ster al que otras aplicaciones dentro de su cl√∫ster pueden acceder. No hay **acceso externo**.

Sin embargo, esto se puede acceder utilizando el proxy de Kubernetes:

```
kubectl proxy --port=8080
```

Ahora, puede navegar a trav√©s de la API de Kubernetes para acceder a los servicios utilizando este esquema:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

Por ejemplo, podr√≠a usar la siguiente URL:

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

para acceder a este servicio:

```yaml
apiVersion: v1
kind: Service
metadata:  
  name: my-internal-service
spec:
  selector:    
    app: my-app
  type: ClusterIP
  ports:  
  - name: http
    port: 80
    targetPort: 80
    protocol: TCP
```

_Este m√©todo requiere que ejecute `kubectl` como un usuario **autenticado**._

### NodePort

**NodePort abre un puerto espec√≠fico en todos los nodos** (las VM), y cualquier **tr√°fico** que se env√≠e a este puerto se **reenv√≠a al servicio**. Esta es una opci√≥n realmente mala por lo general.

Un ejemplo de especificaci√≥n de NodePort:

```yaml
apiVersion: v1
kind: Service
metadata:  
  name: my-nodeport-service
spec:
  selector:    
    app: my-app
  type: NodePort
  ports:  
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30036
    protocol: TCP
```

Si **no especifica** el **nodePort** en el yaml (es el puerto que se abrir√°) se usar√° un puerto en el **rango 30000-32767**.

### LoadBalancer <a href="#0d96" id="0d96"></a>

Expone el servicio externamente **usando el balanceador de carga del proveedor de la nube**. En GKE, esto iniciar√° un [balanceador de carga de red](https://cloud.google.com/compute/docs/load-balancing/network/) que le dar√° una √∫nica direcci√≥n IP que reenviar√° todo el tr√°fico a su servicio.

Debe pagar un LoadBalancer por servicio expuesto, lo que puede resultar costoso.

### ExternalName

Los servicios de tipo ExternalName **mapean un servicio a un nombre DNS**, no a un selector t√≠pico como `my-service` o `cassandra`. Especifica estos servicios con el par√°metro `spec.externalName`.

Esta definici√≥n de servicio, por ejemplo, asigna el servicio `my-service` en el espacio de nombres `prod` a `my.database.example.com`:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
  namespace: prod
spec:
  type: ExternalName
  externalName: my.database.example.com
```

Al buscar el host `my-service.prod.svc.cluster.local`, el servicio DNS del cl√∫ster devuelve un registro `CNAME` con el valor `my.database.example.com`. Acceder a `my-service` funciona de la misma manera que otros servicios, pero con la diferencia crucial de que la **redirecci√≥n ocurre a nivel de DNS** en lugar de a trav√©s de la intermediaci√≥n o el reenv√≠o.

### IPs externas <a href="#external-ips" id="external-ips"></a>

El tr√°fico que ingresa al cl√∫ster con la **IP externa** (como **IP de destino**), en el puerto del servicio, se **enrutar√° a uno de los puntos finales del servicio**. `externalIPs` no son administrados por Kubernetes y son responsabilidad del administrador del cl√∫ster.

En la especificaci√≥n del servicio, se pueden especificar `externalIPs` junto con cualquiera de los `ServiceTypes`. En el siguiente ejemplo, "`my-service`" se puede acceder por clientes en "`80.11.12.10:80`" (`externalIP:port`)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: MyApp
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 9376
  externalIPs:
    - 80.11.12.10
```

### Ingress

A diferencia de todos los ejemplos anteriores, **Ingress NO es un tipo de servicio**. En cambio, se encuentra **en frente de m√∫ltiples servicios y act√∫a como un "enrutador inteligente"** o punto de entrada en su cl√∫ster.

Puede hacer muchas cosas diferentes con un Ingress, y hay **muchos tipos de controladores de Ingress que tienen diferentes capacidades**.

El controlador de ingreso predeterminado de GKE iniciar√° un [balanceador de carga HTTP(S)](https://cloud.google.com/compute/docs/load-balancing/http/) para usted. Esto le permitir√° hacer enrutamiento basado en ruta y subdominio a servicios de backend. Por ejemplo, puede enviar todo en foo.yourdomain.com al servicio foo, y todo bajo la ruta yourdomain.com/bar/ al servicio bar.

El YAML para un objeto Ingress en GKE con un [balanceador de carga HTTP L7](https://cloud.google.com/compute/docs/load-balancing/http/) podr√≠a verse as√≠:

```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: my-ingress
spec:
  backend:
    serviceName: