# Controle de Acesso Baseado em Fun√ß√£o (RBAC) do Kubernetes

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## Controle de Acesso Baseado em Fun√ß√£o (RBAC)

O Kubernetes possui um **m√≥dulo de autoriza√ß√£o chamado Controle de Acesso Baseado em Fun√ß√£o** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) que ajuda a definir permiss√µes de utiliza√ß√£o para o servidor de API.

O modelo de permiss√£o do RBAC √© composto por **tr√™s partes individuais**:

1. **Fun√ß√£o/ClusterRole ¬≠‚Äì** A permiss√£o real. Ele cont√©m _**regras**_ que representam um conjunto de permiss√µes. Cada regra cont√©m [recursos](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) e [verbos](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). O verbo √© a a√ß√£o que ser√° aplicada no recurso.
2. **Assunto (Usu√°rio, Grupo ou ServiceAccount) ‚Äì** O objeto que receber√° as permiss√µes.
3. **RoleBinding/ClusterRoleBinding ‚Äì** A conex√£o entre Fun√ß√£o/ClusterRole e o assunto.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

A diferen√ßa entre "**Fun√ß√µes**" e "**ClusterRoles**" √© apenas onde a fun√ß√£o ser√° aplicada - uma "**Fun√ß√£o**" conceder√° acesso a apenas **um** **namespace** **espec√≠fico**, enquanto um "**ClusterRole**" pode ser usado em **todos os namespaces** no cluster. Al√©m disso, **ClusterRoles** tamb√©m podem conceder acesso a:

* recursos de **escopo de cluster** (como n√≥s).
* endpoints de **n√£o recurso** (como /healthz).
* recursos com namespace (como Pods), **em todos os namespaces**.

A partir do **Kubernetes** 1.6, as pol√≠ticas **RBAC** s√£o **ativadas por padr√£o**. Mas para habilitar o RBAC, voc√™ pode usar algo como:

```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```

## Modelos

No modelo de uma **Fun√ß√£o** ou um **ClusterRole**, voc√™ precisar√° indicar o **nome da fun√ß√£o**, o **namespace** (em fun√ß√µes) e, em seguida, os **apiGroups**, **recursos** e **verbos** da fun√ß√£o:

* O **apiGroups** √© uma matriz que cont√©m os diferentes **namespaces da API** a que essa regra se aplica. Por exemplo, uma defini√ß√£o de Pod usa apiVersion: v1. _Ele pode ter valores como rbac.authorization.k8s.io ou \[\*]_.
* O **recursos** √© uma matriz que define **a quais recursos essa regra se aplica**. Voc√™ pode encontrar todos os recursos com: `kubectl api-resources --namespaced=true`
* O **verbos** √© uma matriz que cont√©m os **verbos permitidos**. O verbo no Kubernetes define o **tipo de a√ß√£o** que voc√™ precisa aplicar ao recurso. Por exemplo, o verbo list √© usado em cole√ß√µes enquanto "get" √© usado em um √∫nico recurso.

### Verbos de Regras

(Esta informa√ß√£o foi retirada daqui)

| Verbo HTTP | verbo de solicita√ß√£o                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (para recursos individuais), list (para cole√ß√µes, incluindo o conte√∫do completo do objeto), watch (para assistir a um recurso individual ou cole√ß√£o de recursos) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (para recursos individuais), deletecollection (para cole√ß√µes)                                                                                         |

O Kubernetes √†s vezes verifica a autoriza√ß√£o para permiss√µes adicionais usando verbos especializados. Por exemplo:

* [Pol√≠tica de Seguran√ßa de Pod](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
  * verbo `use` em recursos `podsecuritypolicies` no grupo de API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
  * verbos `bind` e `escalate` em recursos `roles` e `clusterroles` no grupo de API `rbac.authorization.k8s.io`.
* [Autentica√ß√£o](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
  * verbo `impersonate` em `usu√°rios`, `grupos` e `contas de servi√ßo` no grupo API principal e o `userextras` no grupo de API `authentication.k8s.io`.

{% hint style="warning" %}
Voc√™ pode encontrar **todos os verbos que cada recurso suporta** executando `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Exemplos

{% code title="Fun√ß√£o" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: defaultGreen
  name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml