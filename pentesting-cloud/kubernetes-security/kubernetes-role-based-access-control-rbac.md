# Control de acceso basado en roles (RBAC) de Kubernetes

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a **tu empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Control de acceso basado en roles (RBAC)

Kubernetes tiene un **m√≥dulo de autorizaci√≥n llamado Control de acceso basado en roles** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) que ayuda a establecer permisos de utilizaci√≥n para el servidor API.

El modelo de permisos de RBAC se construye a partir de **tres partes individuales**:

1. **Rol/ClusterRole ¬≠‚Äì** El permiso real. Contiene _**reglas**_ que representan un conjunto de permisos. Cada regla contiene [recursos](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) y [verbos](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). El verbo es la acci√≥n que se aplicar√° en el recurso.
2. **Sujeto (Usuario, Grupo o ServiceAccount) ‚Äì** El objeto que recibir√° los permisos.
3. **RoleBinding/ClusterRoleBinding ‚Äì** La conexi√≥n entre Rol/ClusterRole y el sujeto.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

La diferencia entre "**Roles**" y "**ClusterRoles**" es solo donde se aplicar√° el rol: un "**Rol**" otorgar√° acceso a solo **un** **namespace** **espec√≠fico**, mientras que un "**ClusterRole**" se puede usar en **todos los namespaces** del cl√∫ster. Adem√°s, **ClusterRoles** tambi√©n pueden otorgar acceso a:

* recursos de **√°mbito de cl√∫ster** (como nodos).
* puntos finales de **no recurso** (como /healthz).
* recursos de √°mbito de namespace (como Pods), **en todos los namespaces**.

A partir de **Kubernetes** 1.6, las pol√≠ticas de **RBAC** est√°n **habilitadas de forma predeterminada**. Pero para habilitar RBAC, puede usar algo como:

```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```

## Plantillas

En la plantilla de un **Rol** o un **ClusterRole**, deber√° indicar el **nombre del rol**, el **namespace** (en roles) y luego los **apiGroups**, **recursos** y **verbos** del rol:

* Los **apiGroups** son una matriz que contiene los diferentes **espacios de nombres de API** a los que se aplica esta regla. Por ejemplo, una definici√≥n de Pod usa apiVersion: v1. _Puede tener valores como rbac.authorization.k8s.io o \[\*]_.
* Los **recursos** son una matriz que define **a qu√© recursos se aplica esta regla**. Puede encontrar todos los recursos con: `kubectl api-resources --namespaced=true`
* Los **verbos** son una matriz que contiene los **verbos permitidos**. El verbo en Kubernetes define el **tipo de acci√≥n** que debe aplicar al recurso. Por ejemplo, el verbo de lista se utiliza contra colecciones mientras que "get" se utiliza contra un solo recurso.

### Verbos de reglas

(_Esta informaci√≥n fue tomada de_ [_**aqu√≠**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Verbo HTTP | Verbo de solicitud                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get (para recursos individuales), list (para colecciones, incluido el contenido completo del objeto), watch (para ver un recurso individual o una colecci√≥n de recursos) |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete (para recursos individuales), deletecollection (para colecciones)                                                                                         |

Kubernetes a veces verifica la autorizaci√≥n para permisos adicionales utilizando verbos especializados. Por ejemplo:

* [Pol√≠tica de seguridad de Pod](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
  * verbo `use` en recursos `podsecuritypolicies` en el grupo de API `policy`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
  * verbos `bind` y `escalate` en recursos `roles` y `clusterroles` en el grupo de API `rbac.authorization.k8s.io`.
* [Autenticaci√≥n](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
  * verbo `impersonate` en `users`, `groups` y `serviceaccounts` en el grupo API principal, y `userextras` en el grupo de API `authentication.k8s.io`.

{% hint style="warning" %}
Puede encontrar **todos los verbos que admite cada recurso** ejecutando `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Ejemplos

{% code title="Rol" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: defaultGreen
  name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  # "namespace" omitted since ClusterRoles are not namespaced
  name: secret-reader
rules