# Kubernetes ロールベースのアクセス制御（RBAC）

<details>

<summary><strong>HackTricks をサポートして特典を得る！</strong></summary>

* **HackTricks で会社を宣伝したい**場合や、**最新バージョンの PEASS を見たい**場合、または HackTricks を PDF でダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを見つけましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## ロールベースのアクセス制御（RBAC）

Kubernetes には、API サーバーに利用権限を設定するのに役立つ **ロールベースのアクセス制御（RBAC）** という **認可モジュール** があります。

RBAC の権限モデルは、**3 つの個別のパーツ** から構築されています：

1. **ロール/クラスターロール** - 実際の権限です。これには、一連の権限を表す **ルール** が含まれています。各ルールには、[リソース](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) と [動詞](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) が含まれています。動詞は、リソースに適用されるアクションです。
2. **サブジェクト（ユーザー、グループ、またはサービスアカウント）** - 権限を受け取るオブジェクトです。
3. **ロールバインディング/クラスターロールバインディング** - ロール/クラスターロールとサブジェクトの接続です。

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

「**ロール**」と「**クラスターロール**」の違いは、ロールが適用される場所だけです - 「**ロール**」は **1 つの特定のネームスペース** にのみアクセス権限を付与しますが、「**クラスターロール**」はクラスタ内の **すべてのネームスペース** で使用できます。さらに、**クラスターロール** は次のものにもアクセス権限を付与できます：

* **クラスタ全体の**リソース（ノードなど）。
* **非リソース**エンドポイント（/healthz など）。
* **ネームスペース内の**リソース（Pod など）、**すべてのネームスペース** を対象とします。

Kubernetes 1.6 以降、RBAC ポリシーはデフォルトで有効になっています。ただし、RBAC を有効にするには、次のような方法を使用できます：
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## テンプレート

**Role**または**ClusterRole**のテンプレートでは、**ロールの名前**、**名前空間**（ロールの場合）、そしてロールの**apiGroups**、**resources**、**verbs**を指定する必要があります。

* **apiGroups**は、このルールが適用される**API名前空間**を含む配列です。たとえば、Podの定義ではapiVersion: v1を使用します。_rbac.authorization.k8s.ioや\[\*]などの値を持つことができます_。
* **resources**は、このルールが適用される**リソース**を定義する配列です。すべてのリソースは`kubectl api-resources --namespaced=true`で確認できます。
* **verbs**は、**許可される動詞**を含む配列です。Kubernetesの動詞は、リソースに適用する必要のある**アクションのタイプ**を定義します。たとえば、list動詞はコレクションに対して使用され、"get"は単一のリソースに対して使用されます。

### ルールの動詞

(_この情報は_ [_**こちら**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) _から取得されました_)

| HTTP動詞 | リクエスト動詞                                                                                                                                                 |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get（個々のリソースに対して）、list（コレクションに対して、オブジェクトの内容を含む）、watch（個々のリソースまたはリソースのコレクションを監視するため） |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete（個々のリソースに対して）、deletecollection（コレクションに対して）                                                                                     |

Kubernetesは、特殊な動詞を使用して追加の権限の認可をチェックすることがあります。たとえば：

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* `policy` APIグループの`podsecuritypolicies`リソースで`use`動詞を使用します。
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* `rbac.authorization.k8s.io` APIグループの`roles`および`clusterroles`リソースで`bind`および`escalate`動詞を使用します。
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* コアAPIグループの`users`、`groups`、`serviceaccounts`および`authentication.k8s.io` APIグループの`userextras`で`impersonate`動詞を使用します。

{% hint style="warning" %}
`kubectl api-resources --sort-by name -o wide`を実行して、**各リソースがサポートするすべての動詞**を見つけることができます。
{% endhint %}

### 例

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

例えば、特定のユーザーが実行できるようにするために、**ClusterRole**を使用することができます。
```
kubectl get pods --all-namespaces
```
### **RoleBindingとClusterRoleBinding**

**RoleBindingは、ユーザーまたはユーザーセットに定義された権限を付与します**。それはサブジェクト（ユーザー、グループ、またはサービスアカウント）のリストと、付与される役割への参照を保持します。**RoleBindingは特定のネームスペース内で権限を付与**しますが、**ClusterRoleBindingはクラスタ全体でアクセスを付与**します。

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**権限は加算されます**ので、"list"と"delete"のシークレットを持つclusterRoleを持っている場合、それを"get"を持つRoleで追加することができます。したがって、常に役割と権限をテストし、**許可されているものを明示してください。なぜなら、デフォルトではすべてが拒否されるからです。**

## **RBACの列挙**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### 特権昇格のための役割/クラスターロールの悪用

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks**であなたの**会社を宣伝**したい場合や、**PEASSの最新バージョンを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
