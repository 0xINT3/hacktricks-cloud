# Kubernetes Rollenbasierte Zugriffskontrolle (RBAC)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

## Rollenbasierte Zugriffskontrolle (RBAC)

Kubernetes verf√ºgt √ºber ein **Autorisierungsmodul namens Rollenbasierte Zugriffskontrolle** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)), das dabei hilft, Nutzungsrechte f√ºr den API-Server festzulegen.

Das Berechtigungsmodell von RBAC setzt sich aus **drei einzelnen Teilen** zusammen:

1. **Rolle/ClusterRolle ‚Äì** Die tats√§chliche Berechtigung. Sie enth√§lt _**Regeln**_, die eine Reihe von Berechtigungen darstellen. Jede Regel enth√§lt [Ressourcen](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) und [Verben](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Das Verb ist die Aktion, die auf die Ressource angewendet wird.
2. **Subjekt (Benutzer, Gruppe oder ServiceAccount) ‚Äì** Das Objekt, das die Berechtigungen erhalten wird.
3. **RolleBinding/ClusterRolleBinding ‚Äì** Die Verbindung zwischen Rolle/ClusterRolle und dem Subjekt.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Der Unterschied zwischen "**Rollen**" und "**ClusterRollen**" liegt nur darin, wo die Rolle angewendet wird ‚Äì eine "**Rolle**" gew√§hrt Zugriff nur auf **einen bestimmten** **spezifischen** **Namespace**, w√§hrend eine "**ClusterRolle**" in **allen Namespaces** im Cluster verwendet werden kann. Dar√ºber hinaus k√∂nnen **ClusterRollen** auch Zugriff gew√§hren auf:

* **Cluster-weit** g√ºltige Ressourcen (wie Knoten).
* **Nicht-Ressourcen**-Endpunkte (wie /healthz).
* Namespaced-Ressourcen (wie Pods), **√ºber alle Namespaces hinweg**.

Ab **Kubernetes** 1.6 sind **RBAC**-Richtlinien standardm√§√üig **aktiviert**. Um RBAC zu aktivieren, k√∂nnen Sie etwas √Ñhnliches verwenden wie:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Vorlagen

In der Vorlage eines **Rolle** oder eines **ClusterRole** m√ºssen Sie den **Namen der Rolle**, den **Namespace** (in Rollen) und dann die **apiGroups**, **Ressourcen** und **Verben** der Rolle angeben:

* Die **apiGroups** ist ein Array, das die verschiedenen **API-Namensr√§ume** enth√§lt, auf die diese Regel zutrifft. Zum Beispiel verwendet eine Pod-Definition apiVersion: v1. _Es kann Werte wie rbac.authorization.k8s.io oder \[\*] haben_.
* Die **Ressourcen** ist ein Array, das definiert, **auf welche Ressourcen diese Regel zutrifft**. Sie k√∂nnen alle Ressourcen mit finden: `kubectl api-resources --namespaced=true`
* Die **Verben** ist ein Array, das die **erlaubten Verben** enth√§lt. Das Verb in Kubernetes definiert den **Typ der Aktion**, die auf die Ressource angewendet werden muss. Zum Beispiel wird das Verb "list" gegen Sammlungen verwendet, w√§hrend "get" gegen eine einzelne Ressource verwendet wird.

### Verbenregeln

(_Diese Informationen stammen aus_ [_**den Dokumenten**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| HTTP-Verb | Anforderungsverb                                                                                                                                             |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | erstellen                                                                                                                                                     |
| GET, HEAD | get (f√ºr einzelne Ressourcen), list (f√ºr Sammlungen, einschlie√ülich des vollst√§ndigen Objektinhalts), watch (zum Beobachten einer einzelnen Ressource oder einer Sammlung von Ressourcen) |
| PUT       | aktualisieren                                                                                                                                                 |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | l√∂schen (f√ºr einzelne Ressourcen), deletecollection (f√ºr Sammlungen)                                                                                         |

Manchmal √ºberpr√ºft Kubernetes die Autorisierung f√ºr zus√§tzliche Berechtigungen unter Verwendung spezialisierter Verben. Zum Beispiel:

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* `use` Verb auf `podsecuritypolicies` Ressourcen in der `policy` API-Gruppe.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* `bind` und `escalate` Verben auf `roles` und `clusterroles` Ressourcen in der `rbac.authorization.k8s.io` API-Gruppe.
* [Authentifizierung](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* `impersonate` Verb auf `Benutzer`, `Gruppen` und `Servicekonten` in der Kern-API-Gruppe und die `userextras` in der `authentication.k8s.io` API-Gruppe.

{% hint style="warning" %}
Sie k√∂nnen **alle Verben, die jede Ressource unterst√ºtzt**, finden, indem Sie `kubectl api-resources --sort-by name -o wide` ausf√ºhren
{% endhint %}

### Beispiele

{% code title="Rolle" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Zum Beispiel k√∂nnen Sie einen **ClusterRole** verwenden, um einem bestimmten Benutzer das Ausf√ºhren zu erm√∂glichen:
```
kubectl get pods --all-namespaces
```
### **RoleBinding und ClusterRoleBinding**

**[Aus den Dokumenten:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** Ein **RoleBinding gew√§hrt die in einer Rolle definierten Berechtigungen einem Benutzer oder einer Benutzergruppe**. Es enth√§lt eine Liste von Subjekten (Benutzer, Gruppen oder Servicekonten) und einen Verweis auf die gew√§hrte Rolle. Ein **RoleBinding** gew√§hrt Berechtigungen innerhalb eines bestimmten **Namespaces**, w√§hrend ein **ClusterRoleBinding** diesen Zugriff **clusterweit** gew√§hrt.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Berechtigungen sind additiv**, daher k√∂nnen Sie, wenn Sie einen ClusterRole mit "list" und "delete" Secrets haben, diesen mit einem Role mit "get" hinzuf√ºgen. Seien Sie also vorsichtig und testen Sie immer Ihre Rollen und Berechtigungen und **geben Sie an, was ERLAUBT ist, da standardm√§√üig alles VERWEIGERT wird.**

## **RBAC aufz√§hlen**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Missbrauch von Rollen/ClusterRoles f√ºr Privilege Escalation

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Heldenniveau mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
