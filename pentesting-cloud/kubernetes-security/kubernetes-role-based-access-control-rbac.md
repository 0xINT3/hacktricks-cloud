# Kubernetes基于角色的访问控制（RBAC）

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 基于角色的访问控制（RBAC）

Kubernetes拥有一个名为基于角色的访问控制（RBAC）的**授权模块**，它可以帮助设置对API服务器的使用权限。

RBAC的权限模型由**三个独立部分**构成：

1. **角色/集群角色（Role/ClusterRole）** - 实际的权限。它包含代表一组权限的**规则**。每个规则包含[资源](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types)和[动词](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)。动词是将应用于资源的操作。
2. **主体（用户、组或ServiceAccount）** - 将接收权限的对象。
3. **角色绑定/集群角色绑定（RoleBinding/ClusterRoleBinding）** - 角色/集群角色与主体之间的连接。

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

“**角色（Roles）**”和“**集群角色（ClusterRoles）**”之间的区别仅在于角色将应用的位置 - “**角色（Role）**”将仅授予对**一个特定命名空间**的访问权限，而“**集群角色（ClusterRole）**”可以在集群中的**所有命名空间**中使用。此外，**集群角色（ClusterRoles）**还可以授予对以下内容的访问权限：

* **集群范围**的资源（如节点）。
* **非资源**端点（如/healthz）。
* 命名空间资源（如Pods），跨所有命名空间。

从Kubernetes 1.6版本开始，默认情况下启用了RBAC策略。但是要启用RBAC，您可以使用类似以下的方法：
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## 模板

在**角色（Role）**或**集群角色（ClusterRole）**的模板中，您需要指定**角色的名称**、**命名空间**（在角色中），然后是角色的**apiGroups**、**resources**和**verbs**：

* **apiGroups**是一个包含此规则适用于的不同**API命名空间**的数组。例如，Pod定义使用apiVersion：v1。_它可以具有诸如rbac.authorization.k8s.io或\[\*\]的值_。
* **resources**是一个定义此规则适用于的**资源**的数组。您可以使用`kubectl api-resources --namespaced=true`找到所有资源。
* **verbs**是一个包含**允许的动词**的数组。在Kubernetes中，动词定义了您需要对资源应用的**操作类型**。例如，list动词用于集合，而"get"动词用于单个资源。

### 规则动词

（_此信息来自_ [_**此处**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb)）

| HTTP动词 | 请求动词                                                                                                                                                      |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | create                                                                                                                                                        |
| GET, HEAD | get（用于单个资源），list（用于集合，包括完整对象内容），watch（用于监视单个资源或资源集合） |
| PUT       | update                                                                                                                                                        |
| PATCH     | patch                                                                                                                                                         |
| DELETE    | delete（用于单个资源），deletecollection（用于集合）                                                                                         |

Kubernetes有时会使用专门的动词检查其他权限的授权。例如：

* [PodSecurityPolicy](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* 在`policy` API组中的`podsecuritypolicies`资源上使用`use`动词。
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* 在`rbac.authorization.k8s.io` API组中的`roles`和`clusterroles`资源上使用`bind`和`escalate`动词。
* [Authentication](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* 在核心API组中的`users`、`groups`和`serviceaccounts`上使用`impersonate`动词，并在`authentication.k8s.io` API组中的`userextras`上使用。

{% hint style="warning" %}
您可以使用`kubectl api-resources --sort-by name -o wide`命令找到**每个资源支持的所有动词**。
{% endhint %}

### 示例

{% code title="角色（Role）" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% code title="ClusterRole" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

例如，您可以使用**ClusterRole**来允许特定用户运行：
```
kubectl get pods --all-namespaces
```
### **RoleBinding和ClusterRoleBinding**

**RoleBinding**授予用户或一组用户在角色中定义的权限。它包含一个主体列表（用户、组或服务账户）和对被授予角色的引用。**RoleBinding**在特定的**命名空间**内授予权限，而**ClusterRoleBinding**在整个集群范围内授予访问权限。

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**权限是可叠加的**，因此如果您有一个具有“list”和“delete” secrets的clusterRole，您可以使用具有“get”的Role添加它。因此，请注意并始终测试您的角色和权限，并**明确指定允许的内容，因为默认情况下拒绝所有内容**。

## **枚举RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### 滥用角色/集群角色进行特权升级

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[滥用角色/集群角色进行特权升级](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
