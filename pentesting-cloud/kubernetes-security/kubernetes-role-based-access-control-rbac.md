# Udhibiti wa Upatikanaji kulingana na Majukumu (RBAC) wa Kubernetes

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Udhibiti wa Upatikanaji kulingana na Majukumu (RBAC)

Kubernetes ina **moduli ya idhini inayoitwa Udhibiti wa Upatikanaji kulingana na Majukumu** ([**RBAC**](https://kubernetes.io/docs/reference/access-authn-authz/rbac/)) ambayo husaidia kuweka ruhusa za matumizi kwa seva ya API.

Modeli ya ruhusa ya RBAC imejengwa kutoka kwa **sehemu tatu tofauti**:

1. **Jukumu/Jukumu la Kikundi ‚Äì** Ruhusa halisi. Ina _**mipangilio**_ inayowakilisha seti ya ruhusa. Kila maelekezo yanajumuisha [rasilimali](https://kubernetes.io/docs/reference/kubectl/overview/#resource-types) na [vitendo](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb). Kitendo ni hatua itakayotekelezwa kwenye rasilimali.
2. **Mada (Mtumiaji, Kikundi au Akaunti ya Huduma) ‚Äì** Kitu ambacho kitapokea ruhusa.
3. **Kufunga Jukumu/Jukumu la Kikundi ‚Äì** Uhusiano kati ya Jukumu/Jukumu la Kikundi na mada.

![](https://www.cyberark.com/wp-content/uploads/2018/12/rolebiding\_serviceaccount\_and\_role-1024x551.png)

Tofauti kati ya "**Jukumu**" na "**Jukumu la Kikundi**" ni mahali tu ambapo jukumu litatumika ‚Äì "Jukumu" litatoa upatikanaji kwa **eneo moja tu** **maalum**, wakati "Jukumu la Kikundi" linaweza kutumika katika **eneo zote** kwenye kikundi. Zaidi ya hayo, **Jukumu la Kikundi** pia linaweza kutoa upatikanaji kwa:

* rasilimali za **kikundi** (kama vile nodi).
* vituo vya **bila rasilimali** (kama vile /healthz).
* rasilimali za eneo (kama vile Pods), **katika maeneo yote**.

Kuanzia **Kubernetes** 1.6 na kuendelea, sera za **RBAC** zimekuwa **zimeamilishwa kwa chaguo-msingi**. Lakini ili kuwezesha RBAC unaweza kutumia kitu kama:
```
kube-apiserver --authorization-mode=Example,RBAC --other-options --more-options
```
## Mifano

Katika kiolezo cha **Role** au **ClusterRole** utahitaji kuonyesha **jina la jukumu**, **eneo** (katika majukumu) na kisha **apiGroups**, **rasilimali** na **maneno** ya jukumu:

* **apiGroups** ni safu inayojumuisha **nafasi tofauti za API** ambazo sheria hii inatumika. Kwa mfano, ufafanuzi wa Pod hutumia apiVersion: v1. _Inaweza kuwa na thamani kama rbac.authorization.k8s.io au \[\*]_.
* **resources** ni safu inayotaja **rasilimali zipi sheria hii inatumika**. Unaweza kupata rasilimali zote kwa: `kubectl api-resources --namespaced=true`
* **maneno** ni safu inayojumuisha **maneno yanayoruhusiwa**. Kitenzi katika Kubernetes hufafanua **aina ya hatua** unayohitaji kutumia kwa rasilimali. Kwa mfano, kitenzi cha orodha hutumiwa dhidi ya makusanyo wakati "pata" hutumiwa dhidi ya rasilimali moja.

### Maneno ya Sheria

(_Maelezo haya yalichukuliwa kutoka_ [_**nyaraka**_](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb))

| Kitenzi cha HTTP | kitenzi cha ombi                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | umba                                                                                                                                                        |
| GET, HEAD | pata (kwa rasilimali binafsi), orodha (kwa makusanyo, ikiwa ni pamoja na maudhui kamili ya kitu), angalia (kwa kufuatilia rasilimali binafsi au mkusanyiko wa rasilimali) |
| PUT       | sasisha                                                                                                                                                        |
| PATCH     | kipande                                                                                                                                                         |
| DELETE    | futa (kwa rasilimali binafsi), futa mkusanyo (kwa makusanyo)                                                                                         |

Kubernetes mara kwa mara huchunguza idhini kwa ruhusa za ziada kwa kutumia maneno maalum. Kwa mfano:

* [Sera ya Usalama wa Pod](https://kubernetes.io/docs/concepts/policy/pod-security-policy/)
* kitenzi cha `tumia` kwenye rasilimali za `podsecuritypolicies` katika kikundi cha API cha `sera`.
* [RBAC](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#privilege-escalation-prevention-and-bootstrapping)
* maneno ya `unganisha` na `kukuza` kwenye rasilimali za `roles` na `clusterroles` katika kikundi cha API cha `rbac.authorization.k8s.io`.
* [Uthibitishaji](https://kubernetes.io/docs/reference/access-authn-authz/authentication/)
* kitenzi cha `jifanya` kwenye `watumiaji`, `makundi`, na `akaunti za huduma` katika kikundi cha msingi cha API, na `userextras` katika kikundi cha API cha `uthibitishaji.k8s.io`.

{% hint style="warning" %}
Unaweza kupata **maneno yote ambayo kila rasilimali inasaidia** kwa kutekeleza `kubectl api-resources --sort-by name -o wide`
{% endhint %}

### Mifano

{% code title="Role" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
namespace: defaultGreen
name: pod-and-pod-logs-reader
rules:
- apiGroups: [""]
resources: ["pods", "pods/log"]
verbs: ["get", "list", "watch"]
```
{% endcode %}

{% code title="Jukumu la Kikundi cha Kikluster" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
# "namespace" omitted since ClusterRoles are not namespaced
name: secret-reader
rules:
- apiGroups: [""]
resources: ["secrets"]
verbs: ["get", "watch", "list"]
```
{% endcode %}

Kwa mfano, unaweza kutumia **ClusterRole** kuruhusu mtumiaji fulani kuendesha:
```
kubectl get pods --all-namespaces
```
### **RoleBinding na ClusterRoleBinding**

**[Kutoka kwa nyaraka:](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding)** **RoleBinding inatoa ruhusa zilizoelezwa katika jukumu kwa mtumiaji au kikundi cha watumiaji**. Inashikilia orodha ya wahusika (watumiaji, vikundi, au akaunti za huduma), na kumbukumbu ya jukumu linalopewa. **RoleBinding** inatoa ruhusa ndani ya **namespace** maalum wakati **ClusterRoleBinding** inatoa ufikiaji huo **kwa kiwango cha kikundi**.

{% code title="" %}
```yaml
piVersion: rbac.authorization.k8s.io/v1
# This role binding allows "jane" to read pods in the "default" namespace.
# You need to already have a Role named "pod-reader" in that namespace.
kind: RoleBinding
metadata:
name: read-pods
namespace: default
subjects:
# You can specify more than one "subject"
- kind: User
name: jane # "name" is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
# "roleRef" specifies the binding to a Role / ClusterRole
kind: Role #this must be Role or ClusterRole
name: pod-reader # this must match the name of the Role or ClusterRole you wish to bind to
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

{% code title="ClusterRoleBinding" %}
```yaml
apiVersion: rbac.authorization.k8s.io/v1
# This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.
kind: ClusterRoleBinding
metadata:
name: read-secrets-global
subjects:
- kind: Group
name: manager # Name is case sensitive
apiGroup: rbac.authorization.k8s.io
roleRef:
kind: ClusterRole
name: secret-reader
apiGroup: rbac.authorization.k8s.io
```
{% endcode %}

**Ruhusa zinaongezeka** kwa hivyo ikiwa una jukumu la kikundi na "orodha" na "futa" siri unaweza kuiongeza na Jukumu na "pata". Kwa hivyo kuwa mwangalifu na jaribu mara kwa mara majukumu na ruhusa zako na **taja ni NINI KURUHUSIWA, kwa sababu kila kitu ni KUKATALIWA kwa chaguo-msingi.**

## **Kutambua RBAC**
```bash
# Get current privileges
kubectl auth can-i --list
# use `--as=system:serviceaccount:<namespace>:<sa_name>` to impersonate a service account

# List Cluster Roles
kubectl get clusterroles
kubectl describe clusterroles

# List Cluster Roles Bindings
kubectl get clusterrolebindings
kubectl describe clusterrolebindings

# List Roles
kubectl get roles
kubectl describe roles

# List Roles Bindings
kubectl get rolebindings
kubectl describe rolebindings
```
### Matumizi ya Majukumu/ Majukumu ya Kikundi kwa Ajili ya Kuongeza Mamlaka

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
