# Uthibitisho na Idhini ya Kubelet

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **nifuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Uthibitisho wa Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[Kutoka kwa nyaraka:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Kwa chaguo-msingi, maombi kwa mwisho wa HTTPS wa kubelet ambayo hayakataliwi na njia zingine za uthibitisho zilizowekwa hutambuliwa kama maombi ya kujitegemea, na kupewa **jina la mtumiaji `system:anonymous`** na **kikundi cha `system:unauthenticated`**.

Njia **3** za uthibitisho ni:

* **Kujitegemea** (chaguo-msingi): Tumia kuweka parameta **`--anonymous-auth=true` au mazingira:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Hii ita**wezesha** kubectl **API bearer tokens** kama idhini (kitambulisho chochote halali kitakuwa halali). Ruhusu kwa:
* hakikisha kikundi cha API cha `authentication.k8s.io/v1beta1` kimezimishwa kwenye seva ya API
* anzisha kubelet na bendera za **`--authentication-token-webhook`** na **`--kubeconfig`** au tumia mipangilio ifuatayo:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Kubelet huita **API ya TokenReview** kwenye seva ya API iliyowekwa ili **kutambua habari ya mtumiaji** kutoka kwa tokeni za bearer
{% endhint %}

* **Vyeti vya mteja vya X509:** Kuruhusu kujithibitisha kupitia vyeti vya mteja vya X509
* angalia [nyaraka za uthibitishaji wa apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) kwa maelezo zaidi
* anza kubelet na bendera `--client-ca-file`, ukiweka faili ya CA kuthibitisha vyeti vya mteja. Au na config:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Uthibitishaji wa Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Ombi lolote ambalo limehakikiwa kwa mafanikio (ikiwa ni pamoja na ombi la kujitegemea) **linaidhinishwa**. **Hali ya idhini ya msingi** ni **`AlwaysAllow`**, ambayo **inaruhusu maombi yote**.

Hata hivyo, thamani nyingine inayowezekana ni **`webhook`** (ambayo ndio **utakayopata zaidi**). Hali hii ita **angalia ruhusa za mtumiaji aliyeidhinishwa** ili kuruhusu au kukataa kitendo.

{% hint style="warning" %}
Tafadhali kumbuka kwamba hata kama **uthibitishaji wa kujitegemea umewezeshwa** upatikanaji wa **kujitegemea** unaweza **kutokuwa na ruhusa yoyote** ya kufanya kitendo chochote.
{% endhint %}

Uthibitishaji kupitia webhook unaweza kusanidiwa kwa kutumia **param `--authorization-mode=Webhook`** au kupitia faili ya usanidi kama ifuatavyo:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Kubelet huita API ya **`SubjectAccessReview`** kwenye seva ya API iliyowekwa ili **kutambua** ikiwa kila ombi lime **idhinishwa.**

Kubelet inaidhinisha maombi ya API kwa kutumia njia ile ile ya [vipengele vya ombi](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) kama apiserver:

* **Kitendo**

| herufi ya HTTP | herufi ya ombi                                                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST      | kuunda                                                                                                                                                        |
| GET, HEAD | kupata (kwa rasilimali binafsi), orodha (kwa makusanyo, ikiwa ni pamoja na maudhui kamili ya kitu), angalia (kwa kufuatilia rasilimali binafsi au mkusanyiko wa rasilimali) |
| PUT       | kuboresha                                                                                                                                                        |
| PATCH     | kipande                                                                                                                                                         |
| DELETE    | kufuta (kwa rasilimali binafsi), futa mkusanyo (kwa makusanyo)                                                                                         |

* **Rasilimali** inayozungumza na api ya Kubelet ni **daima** **nodes** na **subrasilimali** inatambuliwa kutoka kwa njia ya ombi linaloingia:

| API ya Kubelet  | rasilimali | subrasilimali |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _zote nyingine_ | nodes    | proksi       |

Kwa mfano, ombi lifuatalo lilijaribu kupata habari za pods za kubelet bila idhini:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Tumepata **Katazwa**, hivyo ombi lime **pitisha ukaguzi wa Uthibitisho**. Vinginevyo, tungepata tu ujumbe wa `Hauruhusiwi`.
* Tunaweza kuona **jina la mtumiaji** (katika kesi hii kutoka kwa ishara)
* Angalia jinsi **rasilimali** ilivyokuwa **wakala** na **rasilimali ya ziada** **proxy** (ambayo ina maana na habari iliyotangulia)

## Marejeo

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **fuata** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
