# Autentica√ß√£o e Autoriza√ß√£o do Kubelet

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Autentica√ß√£o do Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[Da documenta√ß√£o:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Por padr√£o, solicita√ß√µes ao endpoint HTTPS do kubelet que n√£o s√£o rejeitadas por outros m√©todos de autentica√ß√£o configurados s√£o tratadas como solicita√ß√µes an√¥nimas e recebem um **nome de usu√°rio `system:anonymous`** e um **grupo `system:unauthenticated`**.

Os **3** m√©todos de autentica√ß√£o s√£o:

* **An√¥nimo** (padr√£o): Use definindo o par√¢metro **`--anonymous-auth=true` ou no arquivo de configura√ß√£o:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Isso ir√° **habilitar** os **tokens de portador da API kubectl** como autoriza√ß√£o (qualquer token v√°lido ser√° v√°lido). Permita com:
* certifique-se de que o grupo de API `authentication.k8s.io/v1beta1` est√° habilitado no servidor de API
* inicie o kubelet com as flags **`--authentication-token-webhook`** e **`--kubeconfig`** ou use a seguinte configura√ß√£o:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
O kubelet chama a **API `TokenReview`** no servidor API configurado para **determinar informa√ß√µes do usu√°rio** a partir de tokens de portador
{% endhint %}

* **Certificados de cliente X509:** Permitem autenticar via certificados de cliente X509
* consulte a [documenta√ß√£o de autentica√ß√£o do apiserver](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) para mais detalhes
* inicie o kubelet com a flag `--client-ca-file`, fornecendo um pacote CA para verificar os certificados de cliente. Ou com a configura√ß√£o:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Autoriza√ß√£o do Kubelet <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Qualquer solicita√ß√£o que seja autenticada com sucesso (incluindo uma solicita√ß√£o an√¥nima) **√© ent√£o autorizada**. O modo de autoriza√ß√£o **padr√£o** √© **`AlwaysAllow`**, que **permite todas as solicita√ß√µes**.

No entanto, o outro valor poss√≠vel √© **`webhook`** (que √© o que voc√™ **encontrar√° principalmente por a√≠**). Este modo ir√° **verificar as permiss√µes do usu√°rio autenticado** para permitir ou negar uma a√ß√£o.

{% hint style="warning" %}
Observe que mesmo que a **autentica√ß√£o an√¥nima esteja habilitada**, o **acesso an√¥nimo** pode **n√£o ter permiss√µes** para realizar qualquer a√ß√£o.
{% endhint %}

A autoriza√ß√£o via webhook pode ser configurada usando o **par√¢metro `--authorization-mode=Webhook`** ou via o arquivo de configura√ß√£o com:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
O kubelet chama a API **`SubjectAccessReview`** no servidor de API configurado para **determinar** se cada solicita√ß√£o √© **autorizada**.

O kubelet autoriza solicita√ß√µes de API usando a mesma abordagem de [atributos de solicita√ß√£o](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) que o apiserver:

* **A√ß√£o**

| Verbo HTTP | verbo de solicita√ß√£o                                                                                                                                         |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST       | create                                                                                                                                                        |
| GET, HEAD  | get (para recursos individuais), list (para cole√ß√µes, incluindo conte√∫do completo do objeto), watch (para observar um recurso individual ou cole√ß√£o de recursos) |
| PUT        | update                                                                                                                                                        |
| PATCH      | patch                                                                                                                                                         |
| DELETE     | delete (para recursos individuais), deletecollection (para cole√ß√µes)                                                                                         |

* O **recurso** que se comunica com a API do Kubelet √© **sempre** **nodes** e o **subrecurso** √© **determinado** a partir do caminho da solicita√ß√£o recebida:

| API do Kubelet | recurso | subrecurso |
| -------------- | ------- | ---------- |
| /stats/\*      | nodes   | stats      |
| /metrics/\*    | nodes   | metrics    |
| /logs/\*       | nodes   | log        |
| /spec/\*       | nodes   | spec       |
| _todos os outros_ | nodes | proxy      |

Por exemplo, a seguinte solicita√ß√£o tentou acessar as informa√ß√µes dos pods do kubelet sem permiss√£o:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Recebemos um **Proibido**, ent√£o a solicita√ß√£o **passou na verifica√ß√£o de Autentica√ß√£o**. Caso contr√°rio, ter√≠amos recebido apenas uma mensagem `N√£o autorizado`.
* Podemos ver o **nome de usu√°rio** (neste caso, do token)
* Verifique como o **recurso** era **nodes** e o **subrecurso** **proxy** (o que faz sentido com as informa√ß√µes anteriores)

## Refer√™ncias

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
