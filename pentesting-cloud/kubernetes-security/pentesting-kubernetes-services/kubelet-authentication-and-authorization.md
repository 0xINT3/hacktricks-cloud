# Kubelet Verifikasie & Magtiging

<details>

<summary><strong>Leer AWS hakwerk vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Kubelet Verifikasie <a href="#kubelet-authentication" id="kubelet-authentication"></a>

**[Van die dokumente af:](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)**

Standaard word versoek aan die kubelet se HTTPS-einde wat nie deur ander gekonfigureerde verifikasiemetodes verwerp word nie, beskou as anonieme versoek, en word 'n **gebruikersnaam van `system:anonymous`** en 'n **groep van `system:unauthenticated`** toegeken.

Die **3** verifikasie **metodes** is:

* **Anoniem** (verstek): Gebruik die instelling **`--anonymous-auth=true` of die konfigurasie:**
```json
"authentication": {
"anonymous": {
"enabled": true
},
```
* **Webhook**: Dit sal die kubectl **API-baardertokens** as outorisasie **aktiveer** (enige geldige token sal geldig wees). Sta dit toe met:
* verseker dat die `authentication.k8s.io/v1beta1` API-groep geaktiveer is in die API-bediener
* begin die kubelet met die **`--authentication-token-webhook`** en **`--kubeconfig`** vlae of gebruik die volgende instelling:
```json
"authentication": {
"webhook": {
"cacheTTL": "2m0s",
"enabled": true
},
```
{% hint style="info" %}
Die kubelet roep die **`TokenReview` API** aan op die gekonfigureerde API-bediener om **gebruikersinligting** van draer tokens te bepaal
{% endhint %}

* **X509-kli√´ntsertifikate:** Laat toe om te verifieer via X509-kli√´ntsertifikate
* sien die [apiserver-verifikasiedokumentasie](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#x509-client-certs) vir meer besonderhede
* begin die kubelet met die `--client-ca-file` vlag, deur 'n CA-bundel te voorsien om kli√´ntsertifikate mee te verifieer. Of met die konfigurasie:
```json
"authentication": {
"x509": {
"clientCAFile": "/etc/kubernetes/pki/ca.crt"
}
}
```
## Kubelet-gemagtiging <a href="#kubelet-authentication" id="kubelet-authentication"></a>

Enige versoek wat suksesvol ge√Ødentifiseer is (insluitend 'n anonieme versoek) **word daarna gemagtig**. Die **verstek** gemagtigingsmodus is **`AlwaysAllow`**, wat **alle versoek toelaat**.

Die ander moontlike waarde is egter **`webhook`** (wat jy meestal daar sal vind). Hierdie modus sal **die toestemmings van die ge√Ødentifiseerde gebruiker nagaan** om 'n aksie toe te laat of te weier.

{% hint style="warning" %}
Let daarop dat selfs as die **anonieme identifisering geaktiveer is**, die **anonieme toegang** moontlik **geen toestemmings** het om enige aksie uit te voer nie.
{% endhint %}

Die gemagtiging via webhook kan gekonfigureer word deur die **parameter `--authorization-mode=Webhook`** te gebruik of via die konfigurasie l√™er met:
```json
"authorization": {
"mode": "Webhook",
"webhook": {
"cacheAuthorizedTTL": "5m0s",
"cacheUnauthorizedTTL": "30s"
}
},
```
Die kubelet roep die **`SubjectAccessReview`** API aan op die gekonfigureerde API-bediener om **te bepaal** of elke versoek **geautoriseer** is.

Die kubelet autoriseer API-versoeke deur dieselfde [versoekatribute](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#review-your-request-attributes) benadering as die apiserver:

* **Aksie**

| HTTP werkwoord | versoek werkwoord                                                                                                                                             |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST           | skep                                                                                                                                                         |
| GET, HEAD      | kry (vir individuele hulpbronne), lys (vir versamelings, insluitend volledige objekinhoud), kyk (vir die kyk na 'n individuele hulpbron of versameling hulpbronne) |
| PUT            | opdateer                                                                                                                                                     |
| PATCH          | lap                                                                                                                                                          |
| DELETE         | verwyder (vir individuele hulpbronne), deletecollection (vir versamelings)                                                                                     |

* Die **hulpbron** wat met die Kubelet API praat is **altyd** **nodes** en die **subhulpbron** word **bepaal** vanaf die inkomende versoek se pad:

| Kubelet API  | hulpbron | subhulpbron |
| ------------ | -------- | ----------- |
| /stats/\*    | nodes    | stats       |
| /metrics/\*  | nodes    | metrics     |
| /logs/\*     | nodes    | log         |
| /spec/\*     | nodes    | spec        |
| _alle ander_ | nodes    | proxy       |

Byvoorbeeld, die volgende versoek het probeer om toegang tot die pod-inligting van die kubelet te verkry sonder toestemming:
```bash
curl -k --header "Authorization: Bearer ${TOKEN}" 'https://172.31.28.172:10250/pods'
Forbidden (user=system:node:ip-172-31-28-172.ec2.internal, verb=get, resource=nodes, subresource=proxy)
```
* Ons het 'n **Verbode** ontvang, so die versoek het die **Geverifieeringskontrole** geslaag. Indien nie, sou ons net 'n `Onbevoegd` boodskap gekry het.
* Ons kan die **gebruikersnaam** sien (in hierdie geval vanaf die token)
* Kontroleer hoe die **hulpbron** **nodes** was en die **subhulpbron** **proxy** (wat sin maak met die vorige inligting)

## Verwysings

* [https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/](https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/)

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslaan.

</details>
