# Pentesting Kubernetes Services

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Kubernetes utilise plusieurs **services r√©seau sp√©cifiques** que vous pourriez trouver **expos√©s √† Internet** ou sur un **r√©seau interne une fois que vous avez compromis un pod**.

## Trouver des pods expos√©s avec OSINT

Une m√©thode pourrait √™tre de rechercher `Identity LIKE "k8s.%.com"` sur [crt.sh](https://crt.sh) pour trouver des sous-domaines li√©s √† kubernetes. Une autre m√©thode pourrait √™tre de rechercher `"k8s.%.com"` sur github et de chercher des **fichiers YAML** contenant la cha√Æne.

## Comment Kubernetes expose les services

Il pourrait √™tre utile pour vous de comprendre comment Kubernetes peut **exposer des services publiquement** afin de les trouver :

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Trouver des pods expos√©s via le scan de ports

Les ports suivants pourraient √™tre ouverts dans un cluster Kubernetes :

| Port            | Processus      | Description                                                                      |
| --------------- | -------------- | -------------------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port de l'API Kubernetes                                                         |
| 2379/TCP        | etcd           |                                                                                  |
| 6666/TCP        | etcd           | etcd                                                                             |
| 4194/TCP        | cAdvisor       | M√©triques des conteneurs                                                         |
| 6443/TCP        | kube-apiserver | Port de l'API Kubernetes                                                         |
| 8443/TCP        | kube-apiserver | Port de l'API Minikube                                                           |
| 8080/TCP        | kube-apiserver | Port de l'API non s√©curis√©                                                       |
| 10250/TCP       | kubelet        | API HTTPS permettant un acc√®s complet                                            |
| 10255/TCP       | kubelet        | Port HTTP en lecture seule non authentifi√© : pods, pods en cours et √©tat du n≈ìud |
| 10256/TCP       | kube-proxy     | Serveur de v√©rification de sant√© de Kube Proxy                                   |
| 9099/TCP        | calico-felix   | Serveur de v√©rification de sant√© pour Calico                                     |
| 6782-4/TCP      | weave          | M√©triques et points de terminaison                                               |
| 30000-32767/TCP | NodePort       | Proxy vers les services                                                          |
| 44134/TCP       | Tiller         | Service Helm √† l'√©coute                                                          |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

C'est le **service API Kubernetes** avec lequel les administrateurs communiquent g√©n√©ralement en utilisant l'outil **`kubectl`**.

**Ports communs : 6443 et 443**, mais aussi 8443 dans minikube et 8080 en non s√©curis√©.

```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```

**Consultez la page suivante pour apprendre comment obtenir des donn√©es sensibles et effectuer des actions sensibles en communiquant avec ce service :**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### API Kubelet

Ce service **fonctionne dans chaque n≈ìud du cluster**. C'est le service qui va **contr√¥ler** les pods √† l'int√©rieur du **n≈ìud**. Il communique avec le **kube-apiserver**.

Si vous trouvez ce service expos√©, vous pourriez avoir d√©couvert une **ex√©cution de commande √† distance non authentifi√©e (RCE)**.

#### API Kubelet

```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```

Si la r√©ponse est `Unauthorized`, alors une authentification est requise.

Si vous pouvez lister les n≈ìuds, vous pouvez obtenir une liste des points de terminaison des kubelets avec :

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### kubelet (Lecture seule)

```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```

### API etcd

```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

```
helm --host tiller-deploy.kube-system:44134 version
```

Vous pourriez abuser de ce service pour √©lever les privil√®ges √† l'int√©rieur de Kubernetes :

### cAdvisor

Service utile pour collecter des m√©triques.

```
curl -k https://<IP Address>:4194
```

### NodePort

Lorsqu'un port est expos√© sur tous les n≈ìuds via un **NodePort**, le m√™me port est ouvert sur tous les n≈ìuds en proxifiant le trafic vers le **Service** d√©clar√©. Par d√©faut, ce port sera dans la **plage 30000-32767**. Ainsi, de nouveaux services non v√©rifi√©s pourraient √™tre accessibles via ces ports.

```
sudo nmap -sS -p 30000-32767 <IP>
```

## Configurations vuln√©rables

### Acc√®s anonyme √† Kube-apiserver

L'acc√®s anonyme aux points de terminaison de l'API **kube-apiserver n'est pas autoris√©**. Mais vous pourriez v√©rifier certains points de terminaison :

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **V√©rification de l'acc√®s anonyme √† ETCD**

ETCD stocke les secrets du cluster, les fichiers de configuration et d'autres **donn√©es sensibles**. Par **d√©faut**, l'acc√®s √† ETCD **ne peut pas** se faire **anonymement**, mais il est toujours bon de v√©rifier.

Si l'acc√®s anonyme √† ETCD est possible, vous devrez peut-√™tre **utiliser l'**[**outil etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md)\*\*. La commande suivante permet d'obtenir toutes les cl√©s stock√©es :

```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### **Ex√©cution de commande √† distance Kubelet**

La [**documentation Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explique que par **d√©faut l'acc√®s anonyme** au service est **autoris√© :**

> Permet les requ√™tes anonymes au serveur Kubelet. Les requ√™tes qui ne sont pas rejet√©es par une autre m√©thode d'authentification sont trait√©es comme anonymes. Les requ√™tes anonymes ont un nom d'utilisateur `system:anonymous`, et un nom de groupe `system:unauthenticated`

Pour mieux comprendre comment fonctionne **l'authentification et l'autorisation de l'API Kubelet**, consultez cette page :

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

L'**API du service Kubelet n'est pas document√©e**, mais le code source peut √™tre trouv√© ici et il est facile de trouver les points d'acc√®s expos√©s en **ex√©cutant :**

```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```

Tous sont int√©ressants.

Vous pouvez utiliser l'outil [**Kubeletctl**](https://github.com/cyberark/kubeletctl) pour interagir avec les Kubelets et leurs points de terminaison.

#### /pods

Ce point de terminaison liste les pods et leurs conteneurs :

```bash
kubeletctl pods
```

#### /exec

Ce point de terminaison permet d'ex√©cuter du code √† l'int√©rieur de n'importe quel conteneur tr√®s facilement :

```bash
kubeletctl exec [command]
```

{% hint style="info" %}
Pour √©viter cette attaque, le service _**kubelet**_ doit √™tre ex√©cut√© avec `--anonymous-auth false` et le service doit √™tre isol√© au niveau du r√©seau.
{% endhint %}

### **V√©rification de l'exposition des informations du Kubelet (Port en Lecture Seule)**

Lorsque le **port en lecture seule du kubelet** est expos√©, l'attaquant peut r√©cup√©rer des informations depuis l'API. Cela expose **des √©l√©ments de configuration du cluster, tels que les noms des pods, l'emplacement des fichiers internes et d'autres configurations**. Ces informations ne sont pas critiques, mais elles ne devraient tout de m√™me pas √™tre expos√©es sur Internet.

Par exemple, un attaquant √† distance peut exploiter cela en acc√©dant √† l'URL suivante : `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## R√©f√©rences

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
