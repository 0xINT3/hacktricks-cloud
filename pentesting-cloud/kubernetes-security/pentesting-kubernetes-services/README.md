# Pentesting Kubernetes Services

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

Kubernetes korzysta z kilku **konkretnych usług sieciowych**, które mogą być **odsłonięte w Internecie** lub w **sieci wewnętrznej po skompromitowaniu jednego poda**.

## Wyszukiwanie odsłoniętych podów za pomocą OSINT

Jednym ze sposobów może być wyszukiwanie `Identity LIKE "k8s.%.com"` w [crt.sh](https://crt.sh), aby znaleźć subdomeny związane z Kubernetes. Innym sposobem może być wyszukiwanie `"k8s.%.com"` w githubie i szukanie plików **YAML** zawierających ten ciąg.

## Sposób, w jaki Kubernetes odsłania usługi

Może być przydatne, aby zrozumieć, w jaki sposób Kubernetes może **publicznie odsłaniać usługi**, aby je znaleźć:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Wyszukiwanie odsłoniętych podów za pomocą skanowania portów

Następujące porty mogą być otwarte w klastrze Kubernetes:

| Port            | Proces         | Opis                                                                            |
| --------------- | -------------- | ------------------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Port API Kubernetes                                                             |
| 2379/TCP        | etcd           |                                                                                 |
| 6666/TCP        | etcd           | etcd                                                                            |
| 4194/TCP        | cAdvisor       | Metryki kontenerów                                                              |
| 6443/TCP        | kube-apiserver | Port API Kubernetes                                                             |
| 8443/TCP        | kube-apiserver | Port API Minikube                                                               |
| 8080/TCP        | kube-apiserver | Port API bez zabezpieczeń                                                       |
| 10250/TCP       | kubelet        | Port HTTPS, który umożliwia pełny dostęp w trybie pełnego dostępu               |
| 10255/TCP       | kubelet        | Nieuwierzytelniony port HTTP tylko do odczytu: pod, działające pod i stan węzła |
| 10256/TCP       | kube-proxy     | Serwer sprawdzania stanu Kube Proxy                                             |
| 9099/TCP        | calico-felix   | Serwer sprawdzania stanu dla Calico                                             |
| 6782-4/TCP      | weave          | Metryki i punkty końcowe                                                        |
| 30000-32767/TCP | NodePort       | Proxy do usług                                                                  |
| 44134/TCP       | Tiller         | Usługa Helm nasłuchująca                                                        |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

To jest usługa **API Kubernetes**, z którą administratorzy zazwyczaj rozmawiają za pomocą narzędzia **`kubectl`**.

**Wspólne porty: 6443 i 443**, ale także 8443 w minikube i 8080 jako niezabezpieczony.

```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```

**Sprawdź następującą stronę, aby dowiedzieć się, jak uzyskać poufne dane i wykonywać czynności związane z tym usługą:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

Ta usługa **działa na każdym węźle klastra**. Jest to usługa, która **kontroluje** pojemniki wewnątrz **węzła**. Komunikuje się z **kube-apiserver**.

Jeśli znajdziesz tę usługę wystawioną, możesz natrafić na **nieuwierzytelnioną RCE**.

#### Kubelet API

```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```

Jeśli odpowiedź to `Unauthorized`, oznacza to, że wymagane jest uwierzytelnienie.

Jeśli możesz wyświetlić listę węzłów, możesz uzyskać listę punktów końcowych kubeletów za pomocą:

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### kubelet (Tylko do odczytu)

Kubelet jest komponentem Kubelet API, który działa na każdym węźle klastra Kubernetes. Udostępnia on interfejs REST, który umożliwia odczyt informacji o węźle, takich jak metadane, statystyki i dzienniki. Można go wykorzystać do zdobywania informacji o węźle, takich jak wersja Kubelet, adres IP, status zdrowia i wiele innych.

```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```

### etcd API

API etcd jest kluczowym elementem w klastrze Kubernetes, ponieważ przechowuje i zarządza konfiguracją klastra. Jest to rozproszona baza danych, która przechowuje dane w postaci klucz-wartość. API etcd udostępnia zestaw operacji, które umożliwiają zarządzanie danymi przechowywanymi w etcd.

#### Podstawowe operacje API etcd

* `PUT`: Służy do dodawania lub aktualizowania wartości pod określonym kluczem.
* `GET`: Służy do pobierania wartości pod określonym kluczem.
* `DELETE`: Służy do usuwania wartości pod określonym kluczem.
* `WATCH`: Służy do monitorowania zmian w danym kluczu.

#### Wykorzystanie API etcd w celach pentestowych

Podczas testowania penetracyjnego klastra Kubernetes, warto zwrócić uwagę na API etcd, ponieważ może ono być podatne na różne ataki. Poniżej przedstawiamy kilka przykładów potencjalnych zagrożeń:

1. **Przechwytywanie danych**: Jeśli atakujący uzyska dostęp do API etcd, może przechwycić dane przechowywane w klastrze, w tym poufne informacje, takie jak hasła czy klucze prywatne.
2. **Modyfikacja danych**: Atakujący może zmieniać wartości przechowywane w etcd, co może prowadzić do dezinformacji lub zakłóceń w działaniu klastra.
3. **Usunięcie danych**: Atakujący może usunąć dane przechowywane w etcd, co może prowadzić do utraty ważnych informacji lub zakłóceń w działaniu klastra.

W celu zabezpieczenia klastra Kubernetes przed atakami na API etcd, należy podjąć odpowiednie środki ostrożności, takie jak:

* Skonfigurowanie uwierzytelniania i autoryzacji dla API etcd.
* Ustalenie zasad kontroli dostępu do API etcd.
* Monitorowanie i rejestrowanie działań w API etcd w celu wykrywania podejrzanych aktywności.

Pamiętaj, że testowanie penetracyjne klastra Kubernetes powinno być przeprowadzane tylko na własnym środowisku lub z odpowiednią zgodą.

```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

Tiller jest komponentem serwera, który działa na klastrze Kubernetes i jest odpowiedzialny za zarządzanie instalacją i konfiguracją aplikacji w Helm. Tiller jest podatny na ataki, ponieważ domyślnie jest skonfigurowany do działania z uprawnieniami klastra. To oznacza, że Tiller ma pełny dostęp do zasobów klastra i może wykonywać operacje na poziomie administratora.

Ataki na Tiller mogą prowadzić do naruszenia bezpieczeństwa klastra Kubernetes. Przykładowe ataki obejmują zdalne wykonanie kodu, eskalację uprawnień i wykradanie poufnych informacji.

Aby zabezpieczyć Tiller, zaleca się:

* Wyłączenie Tiller w klastrze produkcyjnym i korzystanie z alternatywnych metod instalacji i zarządzania aplikacjami w Helm.
* Ograniczenie uprawnień Tillera do minimalnego niezbędnego poziomu, aby uniknąć nadmiernych uprawnień.
* Używanie uwierzytelniania i autoryzacji na poziomie klastra, aby kontrolować dostęp do Tillera.
* Regularne aktualizowanie Tillera i innych komponentów klastra Kubernetes, aby uniknąć wykorzystania znanych podatności.

Pamiętaj, że Tiller jest tylko jednym z wielu potencjalnych wektorów ataku w klastrze Kubernetes. Ważne jest, aby przeprowadzić kompleksowe testy penetracyjne i monitorować bezpieczeństwo klastra, aby zapobiec ewentualnym naruszeniom.

```
helm --host tiller-deploy.kube-system:44134 version
```

Można wykorzystać ten serwis do eskalacji uprawnień wewnątrz Kubernetes:

### cAdvisor

Usługa przydatna do zbierania metryk.

```
curl -k https://<IP Address>:4194
```

### NodePort

Kiedy port jest wystawiony na wszystkich węzłach za pomocą **NodePort**, ten sam port jest otwarty na wszystkich węzłach, przekierowując ruch do zadeklarowanej **Usługi**. Domyślnie ten port będzie w zakresie **30000-32767**. Dlatego nowe niezweryfikowane usługi mogą być dostępne za pomocą tych portów.

```
sudo nmap -sS -p 30000-32767 <IP>
```

## Podatne błędy konfiguracji

### Dostęp anonimowy do kube-apiserver

Dostęp anonimowy do punktów końcowych API **kube-apiserver nie jest dozwolony**. Jednak można sprawdzić niektóre punkty końcowe:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### Sprawdzanie dostępu anonimowego do ETCD

ETCD przechowuje tajne dane klastra, pliki konfiguracyjne i inne **wrażliwe dane**. Domyślnie ETCD **nie może** być dostępny **anonimowo**, ale zawsze warto sprawdzić.

Jeśli ETCD może być dostępny anonimowo, może być konieczne **użycie narzędzia** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). Poniższe polecenie pobierze wszystkie przechowywane klucze:

```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### **Kubelet RCE**

[Dokumentacja **Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) wyjaśnia, że domyślnie dostęp do usługi jest **dozwolony dla anonimowych użytkowników**:

> Umożliwia anonimowe żądania do serwera Kubelet. Żądania, które nie zostaną odrzucone przez inny sposób uwierzytelniania, są traktowane jako anonimowe żądania. Anonimowe żądania mają nazwę użytkownika `system:anonymous` i nazwę grupy `system:unauthenticated`.

Aby lepiej zrozumieć, jak działa **uwierzytelnianie i autoryzacja API Kubelet**, sprawdź tę stronę:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

Usługa **Kubelet** nie jest **udokumentowana**, ale kod źródłowy można znaleźć tutaj, a znalezienie wystawionych punktów końcowych jest tak proste jak **uruchomienie**:

```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```

Wszystkie one brzmią interesująco.

Możesz użyć narzędzia [**Kubeletctl**](https://github.com/cyberark/kubeletctl), aby komunikować się z Kubeletami i ich punktami końcowymi.

#### /pods

Ten punkt końcowy wyświetla listę podów i ich kontenerów:

```bash
kubeletctl pods
```

#### /exec

Ten punkt końcowy umożliwia łatwe wykonywanie kodu wewnątrz dowolnego kontenera:

```bash
kubeletctl exec [command]
```

{% hint style="info" %}
Aby uniknąć tego ataku, usługa _**kubelet**_ powinna być uruchamiana z opcją `--anonymous-auth false`, a usługa powinna być segregowana na poziomie sieciowym.
{% endhint %}

### **Sprawdzanie wycieku informacji z portu tylko do odczytu Kubelet**

Gdy port tylko do odczytu **kubelet** jest wystawiony, możliwe jest pobranie informacji z interfejsu API przez nieuprawnione osoby. Wystawienie tego portu może prowadzić do ujawnienia różnych elementów **konfiguracji klastra**. Chociaż informacje, takie jak **nazwy podów, lokalizacje wewnętrznych plików i inne konfiguracje**, mogą nie być krytyczne, ich ujawnienie wciąż stanowi ryzyko dla bezpieczeństwa i powinno być unikane.

Przykładem wykorzystania tej podatności jest zdalny atakujący, który uzyskuje dostęp do określonego adresu URL. Przechodząc pod `http://<external-IP>:10255/pods`, atakujący może potencjalnie pozyskać wrażliwe informacje z kubelet:

![https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencje

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriów na GitHubie.**

</details>
