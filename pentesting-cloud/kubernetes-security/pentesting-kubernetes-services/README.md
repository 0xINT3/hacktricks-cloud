# Pentesting Kubernetes Services

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Kubernetes utiliza varios **servicios de red espec칤ficos** que podr칤as encontrar **expuestos a Internet** o en una **red interna una vez que hayas comprometido un pod**.

## Encontrando pods expuestos con OSINT

Una forma podr칤a ser buscar `Identity LIKE "k8s.%.com"` en [crt.sh](https://crt.sh) para encontrar subdominios relacionados con kubernetes. Otra forma podr칤a ser buscar `"k8s.%.com"` en github y buscar **archivos YAML** que contengan la cadena.

## C칩mo Kubernetes Expone Servicios

Podr칤a ser 칰til para ti entender c칩mo Kubernetes puede **exponer servicios p칰blicamente** para poder encontrarlos:

{% content-ref url="../exposing-services-in-kubernetes.md" %}
[exposing-services-in-kubernetes.md](../exposing-services-in-kubernetes.md)
{% endcontent-ref %}

## Encontrando pods expuestos mediante escaneo de puertos

Los siguientes puertos podr칤an estar abiertos en un cl칰ster de Kubernetes:

| Puerto          | Proceso        | Descripci칩n                                                                           |
| --------------- | -------------- | ------------------------------------------------------------------------------------- |
| 443/TCP         | kube-apiserver | Puerto de la API de Kubernetes                                                        |
| 2379/TCP        | etcd           |                                                                                       |
| 6666/TCP        | etcd           | etcd                                                                                  |
| 4194/TCP        | cAdvisor       | M칠tricas de contenedores                                                              |
| 6443/TCP        | kube-apiserver | Puerto de la API de Kubernetes                                                        |
| 8443/TCP        | kube-apiserver | Puerto de la API de Minikube                                                          |
| 8080/TCP        | kube-apiserver | Puerto de la API inseguro                                                             |
| 10250/TCP       | kubelet        | API HTTPS que permite acceso completo                                                 |
| 10255/TCP       | kubelet        | Puerto HTTP de solo lectura no autenticado: pods, pods en ejecuci칩n y estado del nodo |
| 10256/TCP       | kube-proxy     | Servidor de verificaci칩n de salud de Kube Proxy                                       |
| 9099/TCP        | calico-felix   | Servidor de verificaci칩n de salud para Calico                                         |
| 6782-4/TCP      | weave          | M칠tricas y endpoints                                                                  |
| 30000-32767/TCP | NodePort       | Proxy a los servicios                                                                 |
| 44134/TCP       | Tiller         | Servicio Helm escuchando                                                              |

### Nmap

{% code overflow="wrap" %}
```
```
{% endcode %}

```bash
nmap -n -T4 -p 443,2379,6666,4194,6443,8443,8080,10250,10255,10256,9099,6782-6784,30000-32767,44134 <pod_ipaddress>/16
```

### Kube-apiserver

Este es el **servicio API de Kubernetes** con el que los administradores suelen comunicarse utilizando la herramienta **`kubectl`**.

**Puertos comunes: 6443 y 443**, pero tambi칠n 8443 en minikube y 8080 como inseguro.

```
curl -k https://<IP Address>:(8|6)443/swaggerapi
curl -k https://<IP Address>:(8|6)443/healthz
curl -k https://<IP Address>:(8|6)443/api/v1
```

**Consulta la siguiente p치gina para aprender c칩mo obtener datos sensibles y realizar acciones sensibles al comunicarte con este servicio:**

{% content-ref url="../kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](../kubernetes-enumeration.md)
{% endcontent-ref %}

### API de Kubelet

Este servicio **se ejecuta en cada nodo del cl칰ster**. Es el servicio que **controlar치** los pods dentro del **nodo**. Se comunica con el **kube-apiserver**.

Si encuentras este servicio expuesto, podr칤as haber encontrado un **RCE no autenticado**.

#### API de Kubelet

```
curl -k https://<IP address>:10250/metrics
curl -k https://<IP address>:10250/pods
```

Si la respuesta es `Unauthorized`, entonces requiere autenticaci칩n.

Si puedes listar nodos, puedes obtener una lista de endpoints de kubelets con:

```bash
kubectl get nodes -o custom-columns='IP:.status.addresses[0].address,KUBELET_PORT:.status.daemonEndpoints.kubeletEndpoint.Port' | grep -v KUBELET_PORT | while IFS='' read -r node; do
ip=$(echo $node | awk '{print $1}')
port=$(echo $node | awk '{print $2}')
echo "curl -k --max-time 30 https://$ip:$port/pods"
echo "curl -k --max-time 30 https://$ip:2379/version" #Check  also for etcd
done
```

#### kubelet (Solo lectura)

```
curl -k https://<IP Address>:10255
http://<external-IP>:10255/pods
```

### API de etcd

```
curl -k https://<IP address>:2379
curl -k https://<IP address>:2379/version
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### Tiller

```
helm --host tiller-deploy.kube-system:44134 version
```

Puedes abusar de este servicio para escalar privilegios dentro de Kubernetes:

### cAdvisor

Servicio 칰til para recopilar m칠tricas.

```
curl -k https://<IP Address>:4194
```

### NodePort

Cuando un puerto se expone en todos los nodos a trav칠s de un **NodePort**, el mismo puerto se abre en todos los nodos, redirigiendo el tr치fico hacia el **Service** declarado. Por defecto, este puerto estar치 en el **rango 30000-32767**. Por lo tanto, los nuevos servicios no verificados podr칤an ser accesibles a trav칠s de esos puertos.

```
sudo nmap -sS -p 30000-32767 <IP>
```

## Configuraciones Vulnerables

### Acceso An칩nimo a Kube-apiserver

El acceso an칩nimo a los **endpoints de la API de kube-apiserver no est치 permitido**. Pero podr칤as verificar algunos endpoints:

![](https://www.cyberark.com/wp-content/uploads/2019/09/Kube-Pen-2-fig-5.png)

### **Verificaci칩n de Acceso An칩nimo a ETCD**

El ETCD almacena los secretos del cl칰ster, archivos de configuraci칩n y m치s **datos sensibles**. Por **defecto**, el ETCD **no** puede ser accedido **an칩nimamente**, pero siempre es bueno verificar.

Si se puede acceder al ETCD de forma an칩nima, puede ser necesario **usar la** [**herramienta etcdctl**](https://github.com/etcd-io/etcd/blob/master/etcdctl/READMEv2.md). El siguiente comando obtendr치 todas las claves almacenadas:

```
etcdctl --endpoints=http://<MASTER-IP>:2379 get / --prefix --keys-only
```

### **Kubelet RCE**

La [**documentaci칩n de Kubelet**](https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/) explica que por **defecto se permite el acceso an칩nimo** al servicio:

> Permite solicitudes an칩nimas al servidor de Kubelet. Las solicitudes que no son rechazadas por otro m칠todo de autenticaci칩n se tratan como solicitudes an칩nimas. Las solicitudes an칩nimas tienen un nombre de usuario de `system:anonymous` y un nombre de grupo de `system:unauthenticated`

Para entender mejor c칩mo funciona la **autenticaci칩n y autorizaci칩n de la API de Kubelet**, consulta esta p치gina:

{% content-ref url="kubelet-authentication-and-authorization.md" %}
[kubelet-authentication-and-authorization.md](kubelet-authentication-and-authorization.md)
{% endcontent-ref %}

La **API del servicio Kubelet no est치 documentada**, pero el c칩digo fuente se puede encontrar aqu칤 y descubrir los puntos finales expuestos es tan f치cil como **ejecutar**:

```bash
curl -s https://raw.githubusercontent.com/kubernetes/kubernetes/master/pkg/kubelet/server/server.go | grep 'Path("/'

Path("/pods").
Path("/run")
Path("/exec")
Path("/attach")
Path("/portForward")
Path("/containerLogs")
Path("/runningpods/").
```

Todos ellos suenan interesantes.

Puedes usar la herramienta [**Kubeletctl**](https://github.com/cyberark/kubeletctl) para interactuar con Kubelets y sus endpoints.

#### /pods

Este endpoint lista pods y sus contenedores:

```bash
kubeletctl pods
```

#### /exec

Este endpoint permite ejecutar c칩digo dentro de cualquier contenedor de manera muy sencilla:

```bash
kubeletctl exec [command]
```

{% hint style="info" %}
Para evitar este ataque, el servicio _**kubelet**_ debe ejecutarse con `--anonymous-auth false` y el servicio debe estar segregado a nivel de red.
{% endhint %}

### **Verificaci칩n de Exposici칩n de Informaci칩n de Kubelet (Puerto Solo Lectura)**

Cuando el **puerto de solo lectura de kubelet** est치 expuesto, el atacante puede recuperar informaci칩n de la API. Esto expone **elementos de configuraci칩n del cl칰ster, como nombres de pods, ubicaci칩n de archivos internos y otras configuraciones**. Esta no es informaci칩n cr칤tica, pero a칰n as칤 no deber칤a estar expuesta a internet.

Por ejemplo, un atacante remoto puede abusar de esto accediendo a la siguiente URL: `http://<external-IP>:10255/pods`

![](https://www.cyberark.com/wp-content/uploads/2019/09/KUbe-Pen-2-fig-6.png)

## Referencias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-2" %}

{% embed url="https://labs.f-secure.com/blog/attacking-kubernetes-through-kubelet" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
