# Enumera√ß√£o do Kubernetes

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## Tokens do Kubernetes

Se voc√™ tiver acesso comprometido a uma m√°quina, o usu√°rio pode ter acesso a alguma plataforma Kubernetes. O token geralmente est√° localizado em um arquivo apontado pela vari√°vel de ambiente **`KUBECONFIG`** ou **dentro de `~/.kube`**.

Nesta pasta, voc√™ pode encontrar arquivos de configura√ß√£o com **tokens e configura√ß√µes para se conectar ao servidor API**. Nesta pasta, voc√™ tamb√©m pode encontrar uma pasta de cache com informa√ß√µes previamente recuperadas.

Se voc√™ comprometeu um pod dentro de um ambiente Kubernetes, existem outros lugares onde pode encontrar tokens e informa√ß√µes sobre o ambiente K8 atual:

### Tokens de Conta de Servi√ßo

Antes de continuar, se voc√™ n√£o sabe o que √© um servi√ßo no Kubernetes, sugiro que **siga este link e leia pelo menos as informa√ß√µes sobre a arquitetura do Kubernetes**.

Retirado da [documenta√ß√£o](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) do Kubernetes:

_"Ao criar um pod, se voc√™ n√£o especificar uma conta de servi√ßo, ela ser√° automaticamente atribu√≠da √† conta de servi√ßo padr√£o no mesmo namespace."_

**ServiceAccount** √© um objeto gerenciado pelo Kubernetes e usado para fornecer uma identidade para processos que s√£o executados em um pod.\
Cada conta de servi√ßo tem um segredo relacionado a ela e esse segredo cont√©m um token de portador. Este √© um JSON Web Token (JWT), um m√©todo para representar reivindica√ß√µes com seguran√ßa entre duas partes.

Geralmente **um** dos diret√≥rios:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

cont√™m os arquivos:

* **ca.crt**: √© o certificado ca para verificar as comunica√ß√µes do Kubernetes
* **namespace**: indica o namespace atual
* **token**: cont√©m o **token de servi√ßo** do pod atual.

Agora que voc√™ tem o token, pode encontrar o servidor API dentro da vari√°vel de ambiente **`KUBECONFIG`**. Para mais informa√ß√µes, execute `(env | set) | grep -i "kuber|kube`**`"`**

O token da conta de servi√ßo est√° sendo assinado pela chave que reside no arquivo **sa.key** e validado por **sa.pub**.

Localiza√ß√£o padr√£o no **Kubernetes**:

* /etc/kubernetes/pki

Localiza√ß√£o padr√£o no **Minikube**:

* /var/lib/localkube/certs

### Pods Quentes

_Pods quentes s√£o_ pods que cont√™m um token de conta de servi√ßo privilegiado. Um token de conta de servi√ßo privilegiado √© um token que tem permiss√£o para executar tarefas privilegiadas, como listar segredos, criar pods, etc.

## RBAC

Se voc√™ n√£o sabe o que √© **RBAC**, **leia esta se√ß√£o**.

## CheatSheet de Enumera√ß√£o

Para enumerar um ambiente K8s, voc√™ precisa de algumas coisas:

* Um **token de autentica√ß√£o v√°lido**. Na se√ß√£o anterior, vimos onde procurar um token de usu√°rio e um token de conta de servi√ßo.
* O **endere√ßo (**_**https://host:port**_**) do Kubernetes API**. Isso geralmente pode ser encontrado nas vari√°veis de ambiente e/ou no arquivo de configura√ß√£o kube.
* **Opcional**: O **ca.crt para verificar o servidor API**. Isso pode ser encontrado nos mesmos lugares onde o token pode ser encontrado. Isso √© √∫til para verificar o certificado do servidor API, mas usando `--insecure-skip-tls-verify` com `kubectl` ou `-k` com `curl`, voc√™ n√£o precisar√° disso.

Com esses detalhes, voc√™ pode **enumerar o Kubernetes**. Se o **API** por algum motivo estiver **acess√≠vel** pela **Internet**, voc√™ pode simplesmente baixar essas informa√ß√µes e enumerar a plataforma do seu host.

No entanto, geralmente o **servidor API est√° dentro de uma rede interna**, portanto, voc√™ precisar√° **criar um t√∫nel** por meio da m√°quina comprometida para acess√°-lo de sua m√°quina, ou pode **fazer upload do** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) bin√°rio, ou use **`curl/wget/anything`** para executar solicita√ß√µes HTTP brutas para o servidor API.

### Diferen√ßas entre os verbos `list` e `get`

Com as permiss√µes de **`get`**, voc√™ pode acessar informa√ß√µes de ativos espec√≠ficos (_op√ß√£o `describe` em `kubectl`_) da API:

```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```

Se voc√™ tiver a permiss√£o **`list`**, poder√° executar solicita√ß√µes de API para listar um tipo de ativo (_op√ß√£o `get` em `kubectl`_):

```bash
#Em um namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#Em todos os namespaces
GET /apis/apps/v1/deployments
```

Se voc√™ tiver a permiss√£o **`watch`**, poder√° executar solicita√ß√µes de API para monitorar ativos:

```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```

Eles abrem uma conex√£o de streaming que retorna o manifesto completo de um Deployment sempre que ele muda (ou quando um novo √© criado).

{% hint style="danger" %}
Os seguintes comandos `kubectl` indicam apenas como listar os objetos. Se voc√™ quiser acessar os dados, precisar√° usar `describe` em vez de `get`
{% endhint %}

### Usando curl

De dentro de um pod, voc√™ pode usar v√°rias vari√°veis de ambiente:

```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# se kurl ainda tiver erro de certificado, use a op√ß√£o -k para resolv√™-lo.
```
### Obter recursos suportados

Com essas informa√ß√µes, voc√™ saber√° todos os servi√ßos que pode listar.

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Recursos espec√≠ficos de um namespace
k api-resources --namespaced=false #Recursos N√ÉO espec√≠ficos de um namespace
```
{% endtab %}
{% endtabs %}

### Obter privil√©gios atuais

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Obter privil√©gios em geral
k auth can-i --list -n custnamespace #Obter privil√©gios em custnamespace

#Obter permiss√µes de conta de servi√ßo
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
    -H $'Content-Type: application/json' \
    --data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
    "https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Outra maneira de verificar seus privil√©gios √© usando a ferramenta: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Voc√™ pode aprender mais sobre **Kubernetes RBAC** em:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Depois de saber quais privil√©gios** voc√™ tem, verifique a seguinte p√°gina para descobrir **se voc√™ pode abusar deles** para escalar privil√©gios:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obter outras fun√ß√µes

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obter namespaces

O Kubernetes suporta **m√∫ltiplos clusters virtuais** suportados pelo mesmo cluster f√≠sico. Esses clusters virtuais s√£o chamados de **namespaces**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### Obter segredos

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Se voc√™ pode ler segredos, pode usar as seguintes linhas para obter os privil√©gios relacionados a cada token:

```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```

### Obter contas de servi√ßo

Como discutido no in√≠cio desta p√°gina, **quando um pod √© executado, uma conta de servi√ßo geralmente √© atribu√≠da a ele**. Portanto, listar as contas de servi√ßo, suas permiss√µes e onde est√£o sendo executadas pode permitir que um usu√°rio aumente os privil√©gios.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Obter implanta√ß√µes

As implanta√ß√µes especificam os **componentes** que precisam ser **executados**.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obter pods

Os pods s√£o os **cont√™ineres** reais que ser√£o **executados**.

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obter servi√ßos

Os **servi√ßos** do Kubernetes s√£o usados para **expor um servi√ßo em uma porta e IP espec√≠ficos** (que atuar√° como balanceador de carga para os pods que est√£o realmente oferecendo o servi√ßo). Isso √© interessante para saber onde voc√™ pode encontrar outros servi√ßos para tentar atacar.

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obter n√≥s

Obtenha todos os **n√≥s configurados dentro do cluster**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obter DaemonSets

**DaeamonSets** permite garantir que um **pod espec√≠fico esteja em execu√ß√£o em todos os n√≥s** do cluster (ou nos selecionados). Se voc√™ excluir o DaemonSet, os pods gerenciados por ele tamb√©m ser√£o removidos.

{% tabs
## Refer√™ncias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>