# √ânum√©ration de Kubernetes

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts github.**

</details>

## Tokens Kubernetes

Si vous avez un acc√®s compromis √† une machine, l'utilisateur peut avoir acc√®s √† une plateforme Kubernetes. Le jeton est g√©n√©ralement situ√© dans un fichier point√© par la variable d'environnement **`KUBECONFIG`** ou **√† l'int√©rieur de `~/.kube`**.

Dans ce dossier, vous pouvez trouver des fichiers de configuration avec des **jetons et des configurations pour se connecter au serveur API**. Dans ce dossier, vous pouvez √©galement trouver un dossier de cache avec des informations pr√©c√©demment r√©cup√©r√©es.

Si vous avez compromis un pod √† l'int√©rieur d'un environnement Kubernetes, il existe d'autres endroits o√π vous pouvez trouver des jetons et des informations sur l'environnement K8 actuel :

### Jetons de compte de service

Avant de continuer, si vous ne savez pas ce qu'est un service dans Kubernetes, je vous sugg√®re de **suivre ce lien et de lire au moins les informations sur l'architecture de Kubernetes.**

Extrait de la [documentation](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) de Kubernetes :

_"Lorsque vous cr√©ez un pod, si vous ne sp√©cifiez pas de compte de service, il est automatiquement assign√© le compte de service par d√©faut dans le m√™me espace de noms."_

**ServiceAccount** est un objet g√©r√© par Kubernetes et utilis√© pour fournir une identit√© aux processus qui s'ex√©cutent dans un pod.\
Chaque compte de service a un secret qui lui est associ√© et ce secret contient un jeton porteur. Il s'agit d'un JSON Web Token (JWT), une m√©thode pour repr√©senter des revendications de mani√®re s√©curis√©e entre deux parties.

G√©n√©ralement, **un** des r√©pertoires suivants :

* `/run/secrets/kubernetes.io/serviceaccount`
* `/var/run/secrets/kubernetes.io/serviceaccount`
* `/secrets/kubernetes.io/serviceaccount`

contient les fichiers :

* **ca.crt** : C'est le certificat ca pour v√©rifier les communications de Kubernetes
* **namespace** : Il indique l'espace de noms actuel
* **token** : Il contient le **jeton de service** du pod actuel.

Maintenant que vous avez le jeton, vous pouvez trouver le serveur API √† l'int√©rieur de la variable d'environnement **`KUBECONFIG`**. Pour plus d'informations, ex√©cutez `(env | set) | grep -i "kuber|kube`**`"`**

Le jeton de compte de service est sign√© par la cl√© r√©sidant dans le fichier **sa.key** et valid√© par **sa.pub**.

Emplacement par d√©faut sur **Kubernetes** :

* /etc/kubernetes/pki

Emplacement par d√©faut sur **Minikube** :

* /var/lib/localkube/certs

### Pods chauds

_**Les pods chauds sont**_ des pods contenant un jeton de compte de service privil√©gi√©. Un jeton de compte de service privil√©gi√© est un jeton qui a la permission d'effectuer des t√¢ches privil√©gi√©es telles que la liste des secrets, la cr√©ation de pods, etc.

## RBAC

Si vous ne savez pas ce qu'est **RBAC**, **lisez cette section**.

## Feuille de triche d'√©num√©ration

Pour √©num√©rer un environnement K8s, vous avez besoin de ceci :

* Un **jeton d'authentification valide**. Dans la section pr√©c√©dente, nous avons vu o√π rechercher un jeton d'utilisateur et un jeton de compte de service.
* L'**adresse (**_**https://host:port**_**) de l'API Kubernetes**. Cela peut g√©n√©ralement √™tre trouv√© dans les variables d'environnement et/ou dans le fichier de configuration kube.
* **Facultatif** : Le **ca.crt pour v√©rifier le serveur API**. Cela peut √™tre trouv√© dans les m√™mes endroits o√π le jeton peut √™tre trouv√©. Cela est utile pour v√©rifier le certificat du serveur API, mais en utilisant `--insecure-skip-tls-verify` avec `kubectl` ou `-k` avec `curl`, vous n'aurez pas besoin de cela.

Avec ces d√©tails, vous pouvez **√©num√©rer Kubernetes**. Si l'**API** est accessible pour une raison quelconque via **Internet**, vous pouvez simplement t√©l√©charger ces informations et √©num√©rer la plateforme depuis votre h√¥te.

Cependant, g√©n√©ralement le **serveur API est √† l'int√©rieur d'un r√©seau interne**, vous devrez donc **cr√©er un tunnel** √† travers la machine compromise pour y acc√©der depuis votre machine, ou vous pouvez **t√©l√©charger le** [**kubectl**](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) binaire, ou utiliser **`curl/wget/anything`** pour effectuer des requ√™tes HTTP brutes vers le serveur API.

### Diff√©rences entre les verbes `list` et `get`

Avec les autorisations **`get`**, vous pouvez acc√©der aux informations d'actifs sp√©cifiques (_option `describe` dans `kubectl`_) de l'API :

```
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```

Si vous avez l'autorisation **`list`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour lister un type d'actif (_option `get` dans `kubectl`_) :

```bash
#Dans un espace de noms
GET /apis/apps/v1/namespaces/{namespace}/deployments
#Dans tous les espaces de noms
GET /apis/apps/v1/deployments
```

Si vous avez l'autorisation **`watch`**, vous √™tes autoris√© √† ex√©cuter des requ√™tes API pour surveiller les actifs :

```
GET /apis/apps/v1/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments?watch=true
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments/{name}  [D√âCONSEILL√â]
GET /apis/apps/v1/watch/namespaces/{namespace}/deployments  [D√âCONSEILL√â]
GET /apis/apps/v1/watch/deployments  [D√âCONSEILL√â]
```

Ils ouvrent une connexion de streaming qui vous renvoie la manifestation compl√®te d'un d√©ploiement chaque fois qu'il change (ou lorsqu'un nouveau est cr√©√©).

{% hint style="danger" %}
Les commandes `kubectl`
### Obtenir les ressources prises en charge

Avec ces informations, vous saurez tous les services que vous pouvez lister.

{% tabs %}
{% tab title="kubectl" %}
```bash
k api-resources --namespaced=true #Ressources sp√©cifiques √† un espace de noms
k api-resources --namespaced=false #Ressources NON sp√©cifiques √† un espace de noms
```
{% endtab %}
{% endtabs %}

### Obtenir les privil√®ges actuels

{% tabs %}
{% tab title="kubectl" %}
```bash
k auth can-i --list #Obtenir des privil√®ges en g√©n√©ral
k auth can-i --list -n custnamespace #Obtenir des privil√®ges dans l'espace de noms custnamespace

# Obtenir les autorisations du compte de service
k auth can-i --list --as=system:serviceaccount:<namespace>:<sa_name> -n <namespace>
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -i -s -k -X $'POST' \
    -H $'Content-Type: application/json' \
    --data-binary $'{\"kind\":\"SelfSubjectRulesReview\",\"apiVersion\":\"authorization.k8s.io/v1\",\"metadata\":{\"creationTimestamp\":null},\"spec\":{\"namespace\":\"default\"},\"status\":{\"resourceRules\":null,\"nonResourceRules\":null,\"incomplete\":false}}\x0a' \
    "https://$APISERVER/apis/authorization.k8s.io/v1/selfsubjectrulesreviews"
```
{% endtab %}
{% endtabs %}

Une autre fa√ßon de v√©rifier vos privil√®ges est d'utiliser l'outil: [**https://github.com/corneliusweig/rakkess**](https://github.com/corneliusweig/rakkess)****

Vous pouvez en savoir plus sur **Kubernetes RBAC** dans:

{% content-ref url="kubernetes-role-based-access-control-rbac.md" %}
[kubernetes-role-based-access-control-rbac.md](kubernetes-role-based-access-control-rbac.md)
{% endcontent-ref %}

**Une fois que vous savez quels privil√®ges** vous avez, consultez la page suivante pour savoir **si vous pouvez les exploiter** pour escalader les privil√®ges:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Obtenir d'autres r√¥les

{% tabs %}
{% tab title="kubectl" %}
```bash
k get roles
k get clusterroles
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/roles?limit=500"
kurl -k -v "https://$APISERVER/apis/authorization.k8s.io/v1/namespaces/eevee/clusterroles?limit=500"
```
{% endtab %}
{% endtabs %}

### Obtenir les espaces de noms

Kubernetes prend en charge **plusieurs clusters virtuels** sauvegard√©s par le m√™me cluster physique. Ces clusters virtuels sont appel√©s **espaces de noms**.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get namespaces
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/
```
{% endtab %}
{% endtabs %}

### Obtenir les secrets

{% tabs %}
{% tab title="kubectl" %}
```
k get secrets -o yaml
k get secrets -o yaml -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/secrets/

kurl -v https://$APISERVER/api/v1/namespaces/custnamespace/secrets/
```
{% endtab %}
{% endtabs %}

Si vous pouvez lire les secrets, vous pouvez utiliser les lignes suivantes pour obtenir les privil√®ges li√©s √† chaque jeton:

```bash
for token in `k describe secrets -n kube-system | grep "token:" | cut -d " " -f 7`; do echo $token; k --token $token auth can-i --list; echo; done
```

### Obtenir les comptes de service

Comme discut√© au d√©but de cette page, **lorsqu'un pod est ex√©cut√©, un compte de service lui est g√©n√©ralement attribu√©**. Par cons√©quent, la liste des comptes de service, de leurs autorisations et de leur emplacement d'ex√©cution peut permettre √† un utilisateur d'escalader les privil√®ges.

{% tabs %}
{% tab title="kubectl" %}
```bash
k get serviceaccounts
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -k -v https://$APISERVER/api/v1/namespaces/{namespace}/serviceaccounts
```
{% endtab %}
{% endtabs %}

### Obtenir les d√©ploiements

Les d√©ploiements sp√©cifient les **composants** qui doivent √™tre **ex√©cut√©s**.

{% tabs %}
{% tab title="kubectl" %}
```
.k get deployments
k get deployments -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/deployments/
```
{% endtab %}
{% endtabs %}

### Obtenir les pods

Les pods sont les **conteneurs** r√©els qui seront **ex√©cut√©s**.

{% tabs %}
{% tab title="kubectl" %}
```
k get pods
k get pods -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/<namespace>/pods/
```
{% endtab %}
{% endtabs %}

### Obtenir les services

Les **services** Kubernetes sont utilis√©s pour **exposer un service sur un port et une adresse IP sp√©cifiques** (qui agiront comme un √©quilibreur de charge vers les pods qui offrent r√©ellement le service). Cela est int√©ressant pour savoir o√π vous pouvez trouver d'autres services √† essayer d'attaquer.

{% tabs %}
{% tab title="kubectl" %}
```
k get services
k get services -n custnamespace
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$APISERVER/api/v1/namespaces/default/services/
```
{% endtab %}
{% endtabs %}

### Obtenir les n≈ìuds

Obtenez tous les **n≈ìuds configur√©s √† l'int√©rieur du cluster**.

{% tabs %}
{% tab title="kubectl" %}
```
k get nodes
```
{% endtab %}

{% tab title="API" %}
```bash
kurl -v https://$AP
## R√©f√©rences

{% embed url="https://www.cyberark.com/resources/threat-research-blog/kubernetes-pentest-methodology-part-3" %}

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>