# Ataques de Rede no Kubernetes

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Introdu√ß√£o

O Kubernetes, por padr√£o, **conecta** todos os **cont√™ineres em execu√ß√£o no mesmo n√≥** (mesmo que perten√ßam a diferentes namespaces) at√© a **camada 2** (ethernet). Isso permite que um cont√™iner malicioso execute um **ataque de ARP spoofing** aos cont√™ineres no mesmo n√≥ e capture seu tr√°fego.

No cen√°rio, ser√£o criadas 4 m√°quinas:

* ubuntu-pe: M√°quina privilegiada para escapar para o n√≥ e verificar m√©tricas (n√£o √© necess√°rio para o ataque)
* **ubuntu-attack**: Cont√™iner **malicioso** no namespace padr√£o
* **ubuntu-victim**: M√°quina **v√≠tima** no namespace kube-system
* **mysql**: M√°quina **v√≠tima** no namespace padr√£o

```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-pe
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-pe
    securityContext:
      allowPrivilegeEscalation: true
      privileged: true
      runAsUser: 0 
    volumeMounts:
    - mountPath: /host
      name: host-volume
  restartPolicy: Never 
  hostIPC: true 
  hostNetwork: true 
  hostPID: true 
  volumes:
  - name: host-volume
    hostPath:
      path: /
---
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-attack
  labels:
    app: ubuntu
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-attack
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-victim
  namespace: kube-system
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-victim
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: mysql
spec:
  containers:
  - image: mysql:5.6
    ports:
      - containerPort: 3306
    imagePullPolicy: IfNotPresent
    name: mysql
    env:
      - name: MYSQL_ROOT_PASSWORD
        value: mysql
  restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```

## Rede B√°sica do Kubernetes

Se voc√™ deseja mais detalhes sobre os t√≥picos de rede introduzidos aqui, consulte as refer√™ncias.

### ARP

Em geral, a **rede de pod para pod dentro do n√≥** est√° dispon√≠vel por meio de uma **ponte** que conecta todos os pods. Essa ponte √© chamada de "**cbr0**". (Alguns plugins de rede instalar√£o sua pr√≥pria ponte.) O **cbr0 tamb√©m pode lidar com a resolu√ß√£o ARP** (Protocolo de Resolu√ß√£o de Endere√ßo). Quando um pacote de entrada chega ao cbr0, ele pode resolver o endere√ßo MAC de destino usando ARP.

Isso implica que, por padr√£o, **cada pod em execu√ß√£o no mesmo n√≥** ser√° capaz de **comunicar-se** com qualquer outro pod no mesmo n√≥ (independentemente do namespace) no n√≠vel Ethernet (camada 2).

{%
# Na m√°quina Ubuntu
dig google.com
[...]
;; SE√á√ÉO DE RESPOSTA:
google.com.		1	IN	A	1.1.1.1
```

{% hint style="info" %}
Se voc√™ tentar criar seu pr√≥prio script de DNS spoofing, se voc√™ **apenas modificar a resposta DNS** isso **n√£o vai funcionar**, porque a **resposta** ter√° um **IP de origem** o endere√ßo IP do **pod malicioso** e **n√£o ser√° aceito**.\
Voc√™ precisa gerar um **novo pacote DNS** com o **IP de origem** do **DNS** onde a v√≠tima enviou a solicita√ß√£o DNS (que √© algo como 172.16.0.2, n√£o 10.96.0.10, esse √© o IP do servi√ßo DNS do K8s e n√£o o IP do servidor DNS, mais sobre isso na introdu√ß√£o).
{% endhint %}

## Capturando Tr√°fego

A ferramenta [**Mizu**](https://github.com/up9inc/mizu) √© um visualizador de tr√°fego de API simples, mas poderoso, para Kubernetes, permitindo que voc√™ **veja toda a comunica√ß√£o de API** entre microservices para ajudar na depura√ß√£o e solu√ß√£o de problemas de regress√µes.\
Ele instalar√° agentes nos pods selecionados e coletar√° suas informa√ß√µes de tr√°fego e mostrar√° em um servidor web. No entanto, voc√™ precisar√° de permiss√µes elevadas do K8s para isso (e n√£o √© muito furtivo).

## Refer√™ncias

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>