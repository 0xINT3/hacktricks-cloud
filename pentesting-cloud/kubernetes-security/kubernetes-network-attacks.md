# Attaques r√©seau Kubernetes

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Introduction

Kubernetes **connecte par d√©faut** tous les **conteneurs s'ex√©cutant sur le m√™me n≈ìud** (m√™me s'ils appartiennent √† des espaces de noms diff√©rents) jusqu'au **niveau 2** (Ethernet). Cela permet √† un conteneur malveillant d'effectuer une **attaque d'usurpation ARP** sur les conteneurs du m√™me n≈ìud et de capturer leur trafic.

Dans le sc√©nario, 4 machines vont √™tre cr√©√©es :

* ubuntu-pe : machine privil√©gi√©e pour s'√©chapper vers le n≈ìud et v√©rifier les m√©triques (pas n√©cessaire pour l'attaque)
* **ubuntu-attack** : conteneur **malveillant** dans l'espace de noms par d√©faut
* **ubuntu-victim** : machine **victime** dans l'espace de noms kube-system
* **mysql** : machine **victime** dans l'espace de noms par d√©faut

```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-pe
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-pe
    securityContext:
      allowPrivilegeEscalation: true
      privileged: true
      runAsUser: 0 
    volumeMounts:
    - mountPath: /host
      name: host-volume
  restartPolicy: Never 
  hostIPC: true 
  hostNetwork: true 
  hostPID: true 
  volumes:
  - name: host-volume
    hostPath:
      path: /
---
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-attack
  labels:
    app: ubuntu
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-attack
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-victim
  namespace: kube-system
spec:
  containers:
  - image: ubuntu
    command:
      - "sleep"
      - "360000" 
    imagePullPolicy: IfNotPresent
    name: ubuntu-victim
  restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
  name: mysql
spec:
  containers:
  - image: mysql:5.6
    ports:
      - containerPort: 3306
    imagePullPolicy: IfNotPresent
    name: mysql
    env:
      - name: MYSQL_ROOT_PASSWORD
        value: mysql
  restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```

## R√©seau de base Kubernetes

Si vous souhaitez plus de d√©tails sur les sujets de mise en r√©seau introduits ici, consultez les r√©f√©rences.

### ARP

En g√©n√©ral, la **mise en r√©seau pod-√†-pod √† l'int√©rieur du n≈ìud** est disponible via un **pont** qui connecte tous les pods. Ce pont est appel√© "**cbr0**". (Certains plugins r√©seau installeront leur propre pont.) Le **cbr0 peut √©galement g√©rer la r√©solution ARP** (Address Resolution Protocol). Lorsqu'un paquet entrant arrive √† cbr0, il peut r√©soudre l'adresse MAC de destination √† l'aide d'ARP.

Ce fait implique que, par d√©faut, **chaque pod s'ex√©cutant sur le m√™me n≈ìud** va √™tre en mesure de **communiquer** avec n'importe quel autre pod sur le m√™me n≈ìud (ind√©pendamment de l'espace de noms) au niveau Ethernet (couche 2).

{% hint style="warning" %}
Par cons√©quent, il
# Dans la machine Ubuntu
dig google.com
[...]
;; SECTION DE R√âPONSE:
google.com.		1	IN	A	1.1.1.1
```

{% hint style="info" %}
Si vous essayez de cr√©er votre propre script de d√©tournement de DNS, si vous **modifiez simplement la r√©ponse DNS**, cela ne va **pas fonctionner**, car la **r√©ponse** aura une **adresse IP source** l'adresse IP du **pod malveillant** et ne sera **pas accept√©e**.\
Vous devez g√©n√©rer un **nouveau paquet DNS** avec l'**adresse IP source** du **DNS** o√π la victime envoie la demande DNS (qui ressemble √† 172.16.0.2, pas 10.96.0.10, c'est l'adresse IP du service DNS K8s et non l'adresse IP du serveur DNS, plus d'informations √† ce sujet dans l'introduction).
{% endhint %}

## Capture de trafic

L'outil [**Mizu**](https://github.com/up9inc/mizu) est un visualiseur de trafic API simple mais puissant pour Kubernetes qui vous permet de **visualiser toutes les communications API** entre les microservices pour vous aider √† d√©boguer et √† r√©soudre les r√©gressions.\
Il installera des agents dans les pods s√©lectionn√©s, recueillera leurs informations de trafic et vous les montrera dans un serveur web. Cependant, vous aurez besoin de permissions K8s √©lev√©es pour cela (et ce n'est pas tr√®s discret).

## R√©f√©rences

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>