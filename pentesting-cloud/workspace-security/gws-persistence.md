# GWS - Persistencia

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

{% hint style="danger" %}
Todas las acciones mencionadas en esta sección que cambian la configuración generarán una **alerta de seguridad al correo electrónico e incluso una notificación push a cualquier móvil sincronizado** con la cuenta.
{% endhint %}

## **Persistencia en Gmail**

* Puedes crear **filtros para ocultar** notificaciones de seguridad de Google
* `from: (no-reply@accounts.google.com) "Security Alert"`
* Esto evitará que los correos electrónicos de seguridad lleguen al correo (pero no evitará las notificaciones push al móvil)

<details>

<summary>Pasos para crear un filtro de gmail</summary>

(Instrucciones de [**aquí**](https://support.google.com/mail/answer/6579))

1. Abre [Gmail](https://mail.google.com/).
2. En el cuadro de búsqueda en la parte superior, haz clic en Mostrar opciones de búsqueda ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) .
3. Introduce tus criterios de búsqueda. Si quieres comprobar que tu búsqueda es correcta, mira qué correos electrónicos aparecen haciendo clic en **Buscar**.&#x20;
4. En la parte inferior de la ventana de búsqueda, haz clic en **Crear filtro**.
5. Elige lo que te gustaría que hiciera el filtro.
6. Haz clic en **Crear filtro**.

Revisa tu filtro actual (para eliminarlos) en [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../.gitbook/assets/image (142).png" alt=""><figcaption></figcaption></figure>

* Crea **una dirección de reenvío para reenviar información sensible** (o todo) - Necesitas acceso manual.
* Crea una dirección de reenvío en [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
* La dirección receptora necesitará confirmar esto
* Luego, configura para reenviar todos los correos electrónicos manteniendo una copia (recuerda hacer clic en guardar cambios):

<figure><img src="../../.gitbook/assets/image (143).png" alt=""><figcaption></figcaption></figure>

También es posible crear filtros y reenviar solo correos electrónicos específicos a la otra dirección de correo electrónico.

## Contraseñas de aplicaciones

Si has logrado **comprometer una sesión de usuario de Google** y el usuario tenía **2FA**, puedes **generar** una [**contraseña de aplicación**](https://support.google.com/accounts/answer/185833?hl=en) (sigue el enlace para ver los pasos). Ten en cuenta que **Google ya no recomienda las contraseñas de aplicaciones y se revocan** cuando el usuario **cambia su contraseña de la cuenta de Google.**

**Incluso si tienes una sesión abierta necesitarás conocer la contraseña del usuario para crear una contraseña de aplicación.**

{% hint style="info" %}
Las contraseñas de aplicaciones **solo se pueden usar con cuentas que tienen la Verificación en 2 Pasos** activada.
{% endhint %}

## Cambiar 2-FA y similares

También es posible **desactivar 2-FA o inscribir un nuevo dispositivo** (o número de teléfono) en esta página [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**También es posible generar llaves de paso (añadir tu propio dispositivo), cambiar la contraseña, añadir números móviles para teléfonos de verificación y recuperación, cambiar el correo electrónico de recuperación y cambiar las preguntas de seguridad).**

{% hint style="danger" %}
Para **evitar que las notificaciones push de seguridad** lleguen al teléfono del usuario, podrías **cerrar la sesión de su smartphone** (aunque sería extraño) porque no puedes volver a iniciar sesión desde aquí.

También es posible **localizar el dispositivo.**
{% endhint %}

**Incluso si tienes una sesión abierta necesitarás conocer la contraseña del usuario para cambiar estos ajustes.**

## Persistencia a través de aplicaciones OAuth

Si has **comprometido la cuenta de un usuario,** simplemente puedes **aceptar** otorgar todos los permisos posibles a una **aplicación OAuth**. El único problema es que Workspace puede configurarse para **no permitir aplicaciones OAuth externas y/o internas sin revisar.**\
Es bastante común que las Organizaciones de Workspace no confíen por defecto en aplicaciones OAuth externas pero sí en las internas, así que si tienes **suficientes permisos para generar una nueva aplicación OAuth** dentro de la organización y las aplicaciones externas no están permitidas, genérala y **usa esa nueva aplicación OAuth interna para mantener la persistencia**.

Consulta la siguiente página para más información sobre aplicaciones OAuth:

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## Persistencia a través de la delegación

Simplemente puedes **delegar la cuenta** a una cuenta diferente controlada por el atacante (si se te permite hacer esto). En las **Organizaciones** de Workspace esta opción debe estar **activada**. Puede estar desactivada para todos, activada para algunos usuarios/grupos o para todos (generalmente solo está activada para algunos usuarios/grupos o completamente desactivada).

<details>

<summary>Si eres un administrador de Workspace revisa esto para activar la función</summary>

(Información [copiada de la documentación](https://support.google.com/a/answer/7223765))

Como administrador de tu organización (por ejemplo, tu trabajo o escuela), controlas si los usuarios pueden delegar acceso a su cuenta de Gmail. Puedes permitir que todos tengan la opción de delegar su cuenta. O, solo permitir que personas en ciertos departamentos configuren la delegación. Por ejemplo, puedes:

* Añadir un asistente administrativo como delegado en tu cuenta de Gmail para que puedan leer y enviar correos electrónicos en tu nombre.&#x20;
* Añadir un grupo, como tu departamento de ventas, en Grupos como delegado para dar acceso a todos a una cuenta de Gmail.

Los usuarios solo pueden delegar acceso a otro usuario en la misma organización, independientemente de su dominio o su unidad organizativa.

### Límites y restricciones de delegación&#x20;

* Opción **Permitir a los usuarios otorgar acceso a su buzón a un grupo de Google**: Para usar esta opción, debe estar habilitada para la OU de la cuenta delegada y para la OU de cada miembro del grupo. Los miembros del grupo que pertenecen a una OU sin esta opción habilitada no pueden acceder a la cuenta delegada.
* Con un uso típico, 40 usuarios delegados pueden acceder a una cuenta de Gmail al mismo tiempo. Un uso por encima del promedio por parte de uno o más delegados podría reducir este número.&#x20;
* Los procesos automatizados que acceden frecuentemente a Gmail también podrían reducir el número de delegados que pueden acceder a una cuenta al mismo tiempo. Estos procesos incluyen APIs o extensiones de navegador que acceden a Gmail con frecuencia.
* Una sola cuenta de Gmail admite hasta 1,000 delegados únicos. Un grupo en Grupos cuenta como un delegado hacia el límite.
* La delegación no aumenta los límites de una cuenta de Gmail. Las cuentas de Gmail con usuarios delegados tienen los límites y políticas estándar de una cuenta de Gmail. Para más detalles, visita [Límites y políticas de Gmail](https://support.google.com/a/topic/28609).

### Paso 1: Activar la delegación de Gmail para tus usuarios&#x20;

**Antes de comenzar:** Para aplicar la configuración a ciertos usuarios, coloca sus cuentas en una [unidad organizativa](https://support.google.com/a/topic/1227584).

1.  [Inicia sesión](https://admin.google.com/) en tu [Consola de administración de Google](https://support.google.com/a/answer/182076).

Inicia sesión con una _cuenta de administrador_, no con tu cuenta actual CarlosPolop@gmail.com
2. En la Consola de administración, ve a Menú ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Aplicaciones**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![y luego](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Configuración de usuario**.
3. Para aplicar la configuración a todos, deja seleccionada la unidad organizativa superior. De lo contrario, selecciona una unidad organizativa hija.
4. Haz clic en **Delegación de correo**.
5. Marca la casilla **Permitir a los usuarios delegar acceso a su buzón a otros usuarios en el dominio**.
6. (Opcional) Para permitir a los usuarios especificar qué información del remitente se incluye en los mensajes delegados enviados desde su cuenta, marca la casilla **Permitir a los usuarios personalizar esta configuración**.
7. Selecciona una opción para la información del remitente predeterminada que se incluye en los mensajes enviados por los delegados:&#x20;
* **Mostrar al propietario de la cuenta y al delegado que envió el correo electrónico**—Los mensajes incluyen las direcciones de correo electrónico del propietario de la cuenta de Gmail y del delegado.
* **Mostrar solo al propietario de la cuenta**—Los mensajes incluyen la dirección de correo electrónico solo del propietario de la cuenta de Gmail. La dirección de correo electrónico del delegado no se incluye.
8. (Opcional) Para permitir a los usuarios añadir un grupo en Grupos como delegado, marca la casilla **Permitir a los usuarios otorgar acceso a su buzón a un grupo de Google**.
9. Haz clic en **Guardar**. Si configuraste una unidad organizativa hija, podrías poder **Heredar** o **Sobrescribir** la configuración de una unidad organizativa padre.
10. (Opcional) Para activar la delegación de Gmail para otras unidades organizativas, repite los pasos del 3 al 9.

Los cambios pueden tardar hasta 24 horas pero normalmente ocurren más rápidamente. [Aprende más](https://support.google.com/a/answer/7514107)

### Paso 2: Haz que los usuarios configuren delegados para sus cuentas

Después de activar la delegación, tus usuarios van a su configuración de Gmail para asignar delegados. Los delegados pueden entonces leer, enviar y recibir mensajes en nombre del usuario. &#x20;

Para más detalles, dirige a los usuarios a [Delegar y colaborar en el correo electrónico](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>Desde un usuario regular, revisa aquí las instrucciones para intentar delegar tu acceso</summary>

(Info copiada [**de la documentación**](https://support.google.com/mail/answer/138350))

Puedes añadir hasta 10 delegados.

Si estás usando Gmail a través de tu trabajo, escuela u otra organización:

* Puedes añadir hasta 1000 delegados dentro de tu organización.
* Con un uso típico, 40 delegados pueden acceder a una cuenta de Gmail al mismo tiempo.&#x20;
* Si usas procesos automatizados, como APIs o extensiones de navegador, unos pocos delegados pueden acceder a una cuenta de Gmail al mismo tiempo.

1. En tu computadora, abre [Gmail](https://mail.google.com/). No puedes añadir delegados desde la aplicación de Gmail.
2. En la parte superior derecha, haz clic en Configuración ![Configuración](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![y luego](https://lh3.googleusercontent.com/3_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Ver todas las configuraciones**.
3. Haz clic en la pestaña **Cuentas e Importación** o **Cuentas**.
4. En la sección "Conceder acceso a tu cuenta", haz clic en **Añadir otra cuenta**. Si estás usando Gmail a través de tu trabajo o escuela, tu organización puede restringir la delegación de correo electrónico. Si no ves esta configuración, contacta a tu administrador.
* Si no ves Conceder acceso a tu cuenta, entonces está restringido.
5.  Introduce la dirección de correo electrónico de la persona que quieres añadir. Si estás usando Gmail a través de tu trabajo, escuela u otra organización, y tu administrador lo permite, puedes introducir la dirección de correo electrónico de un grupo. Este grupo debe tener el mismo dominio que tu organización. Los miembros externos del grupo se les niega el acceso de delegación. \
\
**Importante:** Si la cuenta que delegas es una cuenta nueva o la contraseña fue restablecida, el Administrador debe desactivar el requisito de cambiar la contraseña cuando inicies sesión por primera vez.

* [Aprende cómo un Administrador puede crear un usuario](https://support.google.com/a/answer/33310).
* [Aprende cómo un Administrador puede restablecer contraseñas](https://support.google.com/a/answer/33319).

6\. Haz clic en **Siguiente paso** ![y luego](https://lh3.googleusercontent.com/QbWcYKta5vh_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Enviar correo electrónico para conceder acceso**.

La persona que añadiste recibirá un correo electrónico pidiéndole que confirme. La invitación caduca después de una semana.

Si añadiste un grupo, todos los miembros del grupo se convertirán en delegados sin necesidad de confirmar.&#x20;

Nota: Puede tardar hasta 24 horas para que la delegación comience a tener efecto.

</details>

## Persistencia a través de la aplicación Android

Si tienes una **sesión dentro de la cuenta de Google de la víctima** puedes navegar a la **Play Store** y podrías ser capaz de **instalar malware** que ya hayas subido a la tienda directamente **al teléfono** para mantener la persistencia y acceder al teléfono de la víctima.

## **Persistencia a través de** App Scripts

Puedes crear **disparadores basados en tiempo** en App Scripts, así que si el App Script es aceptado por el usuario, se **activará** incluso **sin que el usuario lo acceda**. Para más información sobre cómo hacer esto revisa:

{% content-ref url="gws-google-platforms-phishing/gws-app-scripts.md" %}
[gws-app-scripts.md](g
