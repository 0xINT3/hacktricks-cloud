# GWS - Persistence

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

{% hint style="danger" %}
本节中提到的所有更改设置的操作都会生成**安全警报到电子邮件，甚至可能推送通知到与账户同步的任何移动设备**。
{% endhint %}

## **在Gmail中持久化**

* 您可以创建**过滤器来隐藏**Google的安全通知
* `from: (no-reply@accounts.google.com) "Security Alert"`
* 这将阻止安全电子邮件到达邮箱（但不会阻止推送通知到手机）

<details>

<summary>创建gmail过滤器的步骤</summary>

（来自[**这里的指南**](https://support.google.com/mail/answer/6579)）

1. 打开[Gmail](https://mail.google.com/)。
2. 在顶部的搜索框中，点击显示搜索选项 ![photos tune](https://lh3.googleusercontent.com/cD6YR\_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1\_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) 。
3. 输入您的搜索条件。如果您想检查您的搜索是否正确，请点击**搜索**查看显示的电子邮件。
4. 在搜索窗口的底部，点击**创建过滤器**。
5. 选择您希望过滤器执行的操作。
6. 点击**创建过滤器**。

在[https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)检查您当前的过滤器（以删除它们）

</details>

<figure><img src="../../.gitbook/assets/image (142).png" alt=""><figcaption></figcaption></figure>

* 创建**转发地址以转发敏感信息**（或全部信息） - 您需要手动访问。
* 在[https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)创建转发地址
* 接收地址需要确认此操作
* 然后，设置转发所有电子邮件同时保留副本（记得点击保存更改）：

<figure><img src="../../.gitbook/assets/image (143).png" alt=""><figcaption></figcaption></figure>

也可以创建过滤器并仅将特定电子邮件转发到另一个电子邮件地址。

## 应用密码

如果您成功**侵入了Google用户会话**，并且用户启用了**2FA**，您可以**生成**一个[**应用密码**](https://support.google.com/accounts/answer/185833?hl=en)（点击链接查看步骤）。请注意，**Google不再推荐使用应用密码，并且当用户**更改其Google账户密码时，应用密码会被撤销\*\*。

**即使您有一个开放的会话，您也需要知道用户的密码才能创建应用密码。**

{% hint style="info" %}
应用密码**只能与开启了两步验证的账户一起使用**。
{% endhint %}

## 更改2-FA及类似设置

您也可以在此页面[**https://myaccount.google.com/security**](https://myaccount.google.com/security)**关闭2-FA或注册新设备**（或电话号码）。\
**您还可以生成密钥（添加您自己的设备），更改密码，添加用于验证电话和恢复的移动号码，更改恢复电子邮件和更改安全问题）。**

{% hint style="danger" %}
为了**防止安全推送通知**到达用户的手机，您可以**注销他的智能手机**（尽管这会很奇怪），因为您无法从这里再次登录。

也可以**定位设备。**
{% endhint %}

**即使您有一个开放的会话，您也需要知道用户的密码才能更改这些设置。**

## 通过OAuth应用程序持久化

如果您**侵入了用户的账户**，您可以简单地**接受**授予一个**OAuth应用程序**所有可能的权限。唯一的问题是Workspace可以配置为**不允许未经审核的外部和/或内部OAuth应用程序。**\
Workspace组织通常不默认信任外部OAuth应用程序，但信任内部应用程序，所以如果您有**足够的权限在组织内生成一个新的OAuth应用程序**并且外部应用程序被禁止，生成它并**使用这个新的内部OAuth应用程序来维持持久性**。

查看以下页面以获取有关OAuth应用程序的更多信息：

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## 通过委托持久化

您可以简单地**将账户委托**给攻击者控制的另一个账户（如果您被允许这样做）。在Workspace**组织**中，这个选项必须被**启用**。它可以对所有人禁用，对某些用户/组启用或对所有人启用（通常只对某些用户/组启用或完全禁用）。

<details>

<summary>如果您是Workspace管理员，请检查此处以启用该功能</summary>

（信息[从文档中复制](https://support.google.com/a/answer/7223765)）

作为您的组织（例如，您的工作或学校）的管理员，您可以控制用户是否可以委托他们的Gmail账户访问权限。您可以让每个人都有委托账户的选项。或者，只让某些部门的人设置委托。例如，您可以：

* 在您的Gmail账户上添加行政助理作为委托人，以便他们可以代表您阅读和发送电子邮件。
* 在Groups中添加一个组，例如您的销售部门，作为委托人，以便每个人都可以访问一个Gmail账户。

无论他们的域或组织单位如何，用户只能将访问权限委托给同一组织中的另一个用户。

#### 委托限制和限制

* **允许用户将他们的邮箱访问权限授予Google组**选项：要使用此选项，它必须为委托账户的OU和每个组成员的OU启用。属于未启用此选项的OU的组成员不能访问委托账户。
* 在正常使用情况下，40个委托用户可以同时访问一个Gmail账户。一个或多个委托用户的高于平均水平的使用可能会减少这个数字。
* 经常访问Gmail的自动化流程也可能减少同时访问账户的委托用户数量。这些流程包括频繁访问Gmail的API或浏览器扩展。
* 单个Gmail账户支持多达1000个独特的委托人。Groups中的一个组计算为一个委托人，计入限制。
* 委托不会增加Gmail账户的限制。具有委托用户的Gmail账户具有标准的Gmail账户限制和政策。详情请访问[Gmail限制和政策](https://support.google.com/a/topic/28609)。

#### 第1步：为您的用户开启Gmail委托

\*\*开始之前：\*\*要为特定用户应用设置，请将他们的账户放在[组织单位](https://support.google.com/a/topic/1227584)中。

1. [登录](https://admin.google.com/)到您的[Google管理控制台](https://support.google.com/a/answer/182076)。

使用\_管理员账户\_登录，而不是您当前的账户CarlosPolop@gmail.com 2. 在管理控制台中，转到菜单 ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **应用程序**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![然后](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**用户设置**。 3. 要将设置应用于所有人，请保留选中顶部的组织单位。否则，请选择一个子[组织单位](https://support.google.com/a/topic/1227584)。 4. 点击**邮件委托**。 5. 勾选**允许用户将他们的邮箱访问权限委托给域中的其他用户**框。 6. （可选）要让用户指定在其账户发送的委托消息中包含的发件人信息，请勾选**允许用户自定义此设置**框。 7. 选择委托人发送的消息中默认包含的发件人信息选项：

* **显示账户所有者和发送电子邮件的委托人**—消息包括Gmail账户所有者和委托人的电子邮件地址。
* **仅显示账户所有者**—消息仅包括Gmail账户所有者的电子邮件地址。不包括委托人的电子邮件地址。

8. （可选）要让用户将Groups中的一个组添加为委托人，请勾选**允许用户将他们的邮箱访问权限授予Google组**框。
9. 点击**保存**。如果您配置了子组织单位，您可能能够**继承**或**覆盖**父组织单位的设置。
10. （可选）要为其他组织单位开启Gmail委托，请重复步骤3-9。

更改可能需要长达24小时才能生效，但通常会更快。[了解更多](https://support.google.com/a/answer/7514107)

#### 第2步：让用户为他们的账户设置委托人

开启委托后，您的用户可以转到他们的Gmail设置来指定委托人。然后，委托人可以代表用户阅读、发送和接收消息。

详情请指导用户访问[代理和协作电子邮件](https://support.google.com/a/users/answer/138350)。

</details>

<details>

<summary>作为普通用户，查看此处的说明尝试委托您的访问权限</summary>

（信息[**从文档中复制**](https://support.google.com/mail/answer/138350)）

您可以添加多达10个委托人。

如果您通过工作、学校或其他组织使用Gmail：

* 您可以在组织内添加多达1000个委托人。
* 在正常使用情况下，40个委托人可以同时访问一个Gmail账户。
* 如果您使用自动化流程，例如API或浏览器扩展，几个委托人可以同时访问一个Gmail账户。

1. 在您的电脑上，打开[Gmail](https://mail.google.com/)。您不能从Gmail应用中添加委托人。
2. 在右上角，点击设置 ![Settings](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR\_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![然后](https://lh3.googleusercontent.com/3\_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **查看所有设置**。
3. 点击**账户和导入**或**账户**标签。
4. 在“授予对您账户的访问权限”部分，点击**添加另一个账户**。如果您通过工作或学校使用Gmail，您的组织可能会限制电子邮件委托。如果您看不到此设置，请联系您的管理员。

* 如果您看不到授予对您账户的访问权限，那么它被限制了。

5. 输入您想要添加的人的电子邮件地址。如果您通过工作、学校或其他组织使用Gmail，并且您的管理员允许，您可以输入一个组的电子邮件地址。这个组必须与您的组织的域相同。组的外部成员被拒绝委托访问权限。\
   \
   \*\*重要提示：\*\*如果您委托的账户是新账户或密码已重置，管理员必须关闭首次登录时更改密码的要求。

* [了解管理员如何创建用户](https://support.google.com/a/answer/33310)。
* [了解管理员如何重置密码](https://support.google.com/a/answer/33319)。

6\. 点击**下一步** ![然后](https://lh3.googleusercontent.com/QbWcYKta5vh\_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **发送电子邮件以授予访问权限**。

您添加的人将收到一封电子邮件，要求他们确认。邀请在一周后过期。

如果您添加了一个组，所有组成员将成为委托人，无需确认。

</details>
