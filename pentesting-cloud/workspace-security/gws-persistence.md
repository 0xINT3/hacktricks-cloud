# GWS - Persistence

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

{% hint style="danger" %}
Todas as a√ß√µes mencionadas nesta se√ß√£o que alteram configura√ß√µes gerar√£o um **alerta de seguran√ßa para o e-mail e at√© uma notifica√ß√£o push para qualquer celular sincronizado** com a conta.
{% endhint %}

## **Persist√™ncia no Gmail**

* Voc√™ pode criar **filtros para ocultar** notifica√ß√µes de seguran√ßa do Google
* `from: (no-reply@accounts.google.com) "Security Alert"`
* Isso impedir√° que e-mails de seguran√ßa cheguem ao e-mail (mas n√£o impedir√° notifica√ß√µes push para o celular)

<details>

<summary>Passos para criar um filtro no gmail</summary>

(Instru√ß√µes de [**aqui**](https://support.google.com/mail/answer/6579))

1. Abra o [Gmail](https://mail.google.com/).
2. Na caixa de pesquisa no topo, clique em Mostrar op√ß√µes de pesquisa ![photos tune](https://lh3.googleusercontent.com/cD6YR\_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1\_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) .
3. Insira seus crit√©rios de pesquisa. Se voc√™ quiser verificar se sua pesquisa funcionou corretamente, veja quais e-mails aparecem clicando em **Pesquisar**.
4. Na parte inferior da janela de pesquisa, clique em **Criar filtro**.
5. Escolha o que voc√™ gostaria que o filtro fizesse.
6. Clique em **Criar filtro**.

Verifique seu filtro atual (para exclu√≠-los) em [https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)

</details>

<figure><img src="../../.gitbook/assets/image (142).png" alt=""><figcaption></figcaption></figure>

* Crie **endere√ßo de encaminhamento para encaminhar informa√ß√µes sens√≠veis** (ou tudo) - Voc√™ precisa de acesso manual.
* Crie um endere√ßo de encaminhamento em [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)
* O endere√ßo de recebimento precisar√° confirmar isso
* Em seguida, configure para encaminhar todos os e-mails mantendo uma c√≥pia (lembre-se de clicar em salvar altera√ß√µes):

<figure><img src="../../.gitbook/assets/image (143).png" alt=""><figcaption></figcaption></figure>

Tamb√©m √© poss√≠vel criar filtros e encaminhar apenas e-mails espec√≠ficos para o outro endere√ßo de e-mail.

## Senhas de aplicativos

Se voc√™ conseguiu **comprometer uma sess√£o de usu√°rio do Google** e o usu√°rio tinha **2FA**, voc√™ pode **gerar** uma [**senha de aplicativo**](https://support.google.com/accounts/answer/185833?hl=en) (siga o link para ver os passos). Note que **senhas de aplicativos n√£o s√£o mais recomendadas pelo Google e s√£o revogadas** quando o usu√°rio **altera sua senha da Conta Google.**

**Mesmo que voc√™ tenha uma sess√£o aberta, voc√™ precisar√° saber a senha do usu√°rio para criar uma senha de aplicativo.**

{% hint style="info" %}
Senhas de aplicativos s√≥ podem **ser usadas com contas que t√™m Verifica√ß√£o em 2 Etapas** ativada.
{% endhint %}

## Alterar 2-FA e similares

Tamb√©m √© poss√≠vel **desativar o 2-FA ou inscrever um novo dispositivo** (ou n√∫mero de telefone) nesta p√°gina [**https://myaccount.google.com/security**](https://myaccount.google.com/security)**.**\
**Tamb√©m √© poss√≠vel gerar passkeys (adicionar seu pr√≥prio dispositivo), alterar a senha, adicionar n√∫meros de celular para telefones de verifica√ß√£o e recupera√ß√£o, alterar o e-mail de recupera√ß√£o e alterar as perguntas de seguran√ßa).**

{% hint style="danger" %}
Para **impedir que notifica√ß√µes de seguran√ßa push** cheguem ao telefone do usu√°rio, voc√™ poderia **desconectar o smartphone dele** (embora isso seja estranho) porque voc√™ n√£o pode conect√°-lo novamente a partir daqui.

Tamb√©m √© poss√≠vel **localizar o dispositivo.**
{% endhint %}

**Mesmo que voc√™ tenha uma sess√£o aberta, voc√™ precisar√° saber a senha do usu√°rio para alterar essas configura√ß√µes.**

## Persist√™ncia via OAuth Apps

Se voc√™ **comprometeu a conta de um usu√°rio,** voc√™ pode simplesmente **aceitar** conceder todas as permiss√µes poss√≠veis a um **OAuth App**. O √∫nico problema √© que o Workspace pode ser configurado para **n√£o permitir OAuth Apps externos e/ou internos n√£o revisados.**\
√â bastante comum para as Organiza√ß√µes do Workspace n√£o confiar por padr√£o em OAuth Apps externos, mas confiar nos internos, ent√£o se voc√™ tem **permiss√µes suficientes para gerar um novo aplicativo OAuth** dentro da organiza√ß√£o e aplicativos externos s√£o proibidos, gere-o e **use esse novo OAuth App interno para manter a persist√™ncia**.

Confira a seguinte p√°gina para mais informa√ß√µes sobre OAuth Apps:

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## Persist√™ncia via delega√ß√£o

Voc√™ pode simplesmente **delegar a conta** para uma conta diferente controlada pelo atacante (se voc√™ tiver permiss√£o para fazer isso). Nas **Organiza√ß√µes** do Workspace, esta op√ß√£o deve ser **ativada**. Pode ser desativada para todos, ativada para alguns usu√°rios/grupos ou para todos (geralmente s√≥ √© ativada para alguns usu√°rios/grupos ou completamente desativada).

<details>

<summary>Se voc√™ √© um administrador do Workspace, verifique aqui para ativar o recurso</summary>

(Informa√ß√£o [copiada dos docs](https://support.google.com/a/answer/7223765))

Como administrador da sua organiza√ß√£o (por exemplo, seu trabalho ou escola), voc√™ controla se os usu√°rios podem delegar acesso √† sua conta do Gmail. Voc√™ pode permitir que todos tenham a op√ß√£o de delegar sua conta. Ou, permitir apenas que pessoas em certos departamentos configurem delega√ß√£o. Por exemplo, voc√™ pode:

* Adicionar um assistente administrativo como delegado na sua conta do Gmail para que eles possam ler e enviar e-mails em seu nome.
* Adicionar um grupo, como seu departamento de vendas, em Grupos como um delegado para dar acesso a todos a uma conta do Gmail.

Usu√°rios s√≥ podem delegar acesso a outro usu√°rio na mesma organiza√ß√£o, independentemente do seu dom√≠nio ou da sua unidade organizacional.

#### Limites e restri√ß√µes de delega√ß√£o

* Op√ß√£o **Permitir que usu√°rios concedam acesso √† sua caixa de correio a um grupo do Google**: Para usar esta op√ß√£o, ela deve estar ativada para a OU da conta delegada e para a OU de cada membro do grupo. Membros do grupo que pertencem a uma OU sem esta op√ß√£o ativada n√£o podem acessar a conta delegada.
* Com uso t√≠pico, 40 usu√°rios delegados podem acessar uma conta do Gmail ao mesmo tempo. Uso acima da m√©dia por um ou mais delegados pode reduzir este n√∫mero.
* Processos automatizados que acessam o Gmail com frequ√™ncia tamb√©m podem reduzir o n√∫mero de delegados que podem acessar uma conta ao mesmo tempo. Esses processos incluem APIs ou extens√µes de navegador que acessam o Gmail com frequ√™ncia.
* Uma √∫nica conta do Gmail suporta at√© 1.000 delegados √∫nicos. Um grupo em Grupos conta como um delegado para o limite.
* Delega√ß√£o n√£o aumenta os limites de uma conta do Gmail. Contas do Gmail com usu√°rios delegados t√™m os limites e pol√≠ticas padr√£o de uma conta do Gmail. Para detalhes, visite [Limites e pol√≠ticas do Gmail](https://support.google.com/a/topic/28609).

#### Passo 1: Ativar delega√ß√£o do Gmail para seus usu√°rios

**Antes de come√ßar:** Para aplicar a configura√ß√£o para certos usu√°rios, coloque suas contas em uma [unidade organizacional](https://support.google.com/a/topic/1227584).

1. [Fa√ßa login](https://admin.google.com/) no seu [Google Admin console](https://support.google.com/a/answer/182076).

Fa√ßa login usando uma _conta de administrador_, n√£o sua conta atual CarlosPolop@gmail.com 2. No Admin console, v√° para Menu ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![e depois](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **Apps**![e depois](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![e depois](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![e depois](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Configura√ß√µes do usu√°rio**. 3. Para aplicar a configura√ß√£o a todos, deixe a unidade organizacional superior selecionada. Caso contr√°rio, selecione uma unidade organizacional filha. 4. Clique em **Delega√ß√£o de e-mail**. 5. Marque a caixa **Permitir que usu√°rios deleguem acesso √† sua caixa de correio a outros usu√°rios no dom√≠nio**. 6. (Opcional) Para permitir que os usu√°rios especifiquem quais informa√ß√µes do remetente s√£o inclu√≠das em mensagens delegadas enviadas de sua conta, marque a caixa **Permitir que usu√°rios personalizem esta configura√ß√£o**. 7. Selecione uma op√ß√£o para as informa√ß√µes padr√£o do remetente que s√£o inclu√≠das em mensagens enviadas por delegados:

* **Mostrar o propriet√°rio da conta e o delegado que enviou o e-mail**‚ÄîMensagens incluem os endere√ßos de e-mail do propriet√°rio da conta do Gmail e do delegado.
* **Mostrar apenas o propriet√°rio da conta**‚ÄîMensagens incluem apenas o endere√ßo de e-mail do propriet√°rio da conta do Gmail. O endere√ßo de e-mail do delegado n√£o √© inclu√≠do.

8. (Opcional) Para permitir que os usu√°rios adicionem um grupo em Grupos como um delegado, marque a caixa **Permitir que usu√°rios concedam acesso √† sua caixa de correio a um grupo do Google**.
9. Clique em **Salvar**. Se voc√™ configurou uma unidade organizacional filha, voc√™ pode ser capaz de **Herdar** ou **Substituir** as configura√ß√µes de uma unidade organizacional pai.
10. (Opcional) Para ativar a delega√ß√£o do Gmail para outras unidades organizacionais, repita os passos 3‚Äì9.

As altera√ß√µes podem levar at√© 24 horas, mas normalmente acontecem mais rapidamente. [Saiba mais](https://support.google.com/a/answer/7514107)

#### Passo 2: Fazer com que os usu√°rios configurem delegados para suas contas

Depois de ativar a delega√ß√£o, seus usu√°rios v√£o para as configura√ß√µes do Gmail para atribuir delegados. Delegados podem ent√£o ler, enviar e receber mensagens em nome do usu√°rio.

Para detalhes, direcione os usu√°rios para [Delegar e colaborar em e-mails](https://support.google.com/a/users/answer/138350).

</details>

<details>

<summary>De um usu√°rio comum, verifique aqui as instru√ß√µes para tentar delegar seu acesso</summary>

(Info copiada [**dos docs**](https://support.google.com/mail/answer/138350))

Voc√™ pode adicionar at√© 10 delegados.

Se voc√™ est√° usando o Gmail atrav√©s do seu trabalho, escola ou outra organiza√ß√£o:

* Voc√™ pode adicionar at√© 1000 delegados dentro da sua organiza√ß√£o.
* Com uso t√≠pico, 40 delegados podem acessar uma conta do Gmail ao mesmo tempo.
* Se voc√™ usa processos automatizados, como APIs ou extens√µes de navegador, alguns delegados podem acessar uma conta do Gmail ao mesmo tempo.

1. No seu computador, abra o [Gmail](https://mail.google.com/). Voc√™ n√£o pode adicionar delegados pelo aplicativo do Gmail.
2. No canto superior direito, clique em Configura√ß√µes ![Configura√ß√µes](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR\_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![e depois](https://lh3.googleusercontent.com/3\_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **Ver todas as configura√ß√µes**.
3. Clique na aba **Contas e Importa√ß√£o** ou **Contas**.
4. Na se√ß√£o "Conceder acesso √† sua conta", clique em **Adicionar outra conta**. Se voc√™ est√° usando o Gmail atrav√©s do seu trabalho ou escola, sua organiza√ß√£o pode restringir a delega√ß√£o de e-mails. Se voc√™ n√£o vir essa configura√ß√£o, entre em contato com seu administrador.

* Se voc√™ n√£o ver Conceder acesso √† sua conta, ent√£o est√° restrito.

5. Insira o endere√ßo de e-mail da pessoa que voc√™ deseja adicionar. Se voc√™ est√° usando o Gmail atrav√©s do seu trabalho, escola ou outra organiza√ß√£o, e seu administrador permite, voc√™ pode inserir o endere√ßo de e-mail de um grupo. Este grupo deve ter o mesmo dom√≠nio que sua organiza√ß√£o. Membros externos do grupo s√£o negados acesso √† delega√ß√£o.\
   \
   **Importante:** Se a conta que voc√™ delegar for uma nova conta ou a senha foi redefinida, o Administrador deve desativar a exig√™ncia de alterar a senha quando voc√™ fizer o primeiro login.

* [Saiba como um Administrador pode criar um usu√°rio](https://support.google.com/a/answer/33310).
* [Saiba como um Administrador pode redefinir senhas](https://support.google.com/a/answer/33319).

6\. Clique em **Pr√≥ximo Passo** ![e depois](https://lh3.googleusercontent.com/QbWcYKta5vh\_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **Enviar e-mail para conceder acesso**.

A pessoa adicionada receber√° um e-mail pedindo para confirmar. O convite expira ap√≥s uma semana.

Se voc√™ adicionou um grupo, todos os membros do grupo se tornar√£o delegados sem precisar confirmar.

Nota: Pode levar at√© 24 horas para a delega√ß√£o come√ßar a ter efeito.

</details>

## Persist√™ncia via Android App

Se voc√™ tem uma **sess√£o dentro da conta do Google da v√≠tima**, voc√™ pode navegar at√© a **Play Store** e pode ser capaz de **instalar malware** que voc√™ j√° carregou na loja diretamente **no telefone** para manter a persist√™ncia e acessar o telefone da v√≠tima.

## **Persist√™ncia via** App Scripts

Voc√™ pode criar **gatilhos baseados em tempo** em App Scripts, ent√£o se o App Script for aceito pelo usu√°rio, ele ser√° **acionado** mesmo **sem o usu√°rio acess√°-lo**. Para mais informa√ß√µes sobre como fazer isso, confira:

\{% content-ref url="gws-google-platforms-phishing
