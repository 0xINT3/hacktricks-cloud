# GWS - 永続性

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を通じて、ゼロからヒーローまでのAWSハッキングを学びましょう</summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
- **ハッキングトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

{% hint style="danger" %}
このセクションで言及されているすべての設定変更アクションは、**セキュリティアラートをメールで生成し、アカウントに同期されたモバイルにプッシュ通知を送信**します。
{% endhint %}

## Gmailでの永続性

- Googleからのセキュリティ通知を非表示にするための**フィルターを作成**できます
- `from: (no-reply@accounts.google.com) "Security Alert"`
- これにより、セキュリティメールがメールに届かなくなります（ただし、モバイルへのプッシュ通知は防げません）

<details>

<summary>Gmailフィルターを作成する手順</summary>

（[こちら](https://support.google.com/mail/answer/6579)からの手順）

1. [Gmail](https://mail.google.com/)を開きます。
2. 上部の検索ボックスで、[表示オプションを表示] ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) をクリックします。
3. 検索条件を入力します。検索が正しく機能しているか確認するには、[検索]をクリックして表示されるメールを確認します。
4. 検索ウィンドウの下部で、[フィルターを作成]をクリックします。
5. フィルターの動作を選択します。
6. [フィルターを作成]をクリックします。

現在のフィルターを確認するには（削除するには）、[https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)をチェックしてください。

</details>

<figure><img src="../../.gitbook/assets/image (331).png" alt=""><figcaption></figcaption></figure>

- **機密情報を転送するための転送アドレスを作成**できます（またはすべて）- 手動アクセスが必要です。
- [https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)で転送アドレスを作成します
- 受信アドレスはこれを確認する必要があります
- 次に、すべてのメールを転送してコピーを保持するように設定します（変更を保存することを忘れないでください）：

<figure><img src="../../.gitbook/assets/image (332).png" alt=""><figcaption></figcaption></figure>

特定のメールのみを他のメールアドレスに転送するためにもフィルターを作成し、転送することが可能です。

## アプリパスワード

**Googleユーザーセッションを侵害**し、ユーザーが**2FA**を持っている場合、[**アプリパスワード**](https://support.google.com/accounts/answer/185833?hl=en)を生成できます（手順を確認するにはリンクを参照）。**AppパスワードはGoogleによって推奨されておらず、ユーザーがGoogleアカウントのパスワードを変更すると取り消されます。**

**オープンセッションがあっても、ユーザーのパスワードを知っている必要があります。**

{% hint style="info" %}
Appパスワードは、**2段階認証が有効になっているアカウントでのみ使用できます。**
{% endhint %}

## 2-FAおよび類似の変更

このページ[**https://myaccount.google.com/security**](https://myaccount.google.com/security)で**2-FAを無効にしたり、新しいデバイス**（または電話番号）を登録することも可能です。**デバイスを追加する、パスワードを変更する、携帯電話の検証電話番号を追加する、回復用の電話番号を変更する、回復メールを変更する、セキュリティの質問を変更する**こともできます。

{% hint style="danger" %}
ユーザーの電話に**セキュリティプッシュ通知が届かないようにする**には、ここから**ユーザーのスマートフォンからサインアウト**することができます（それは奇妙なことですが）。ここから再度サインインすることはできません。

**デバイスの場所を特定する**ことも可能です。
{% endhint %}

**オープンセッションがあっても、ユーザーのパスワードを知っている必要があります。**

## OAuthアプリを介した永続性

ユーザーアカウントを**侵害**した場合、すべての可能な権限を**OAuthアプリ**に付与するだけで済みます。唯一の問題は、Workspaceが**未承認の外部および/または内部OAuthアプリを許可しないように構成**されている可能性があることです。\
Workspace組織がデフォルトで外部OAuthアプリを信頼しないことはかなり一般的ですが、内部アプリには信頼を置いているため、組織内で新しいOAuthアプリを生成する権限がある場合、外部アプリが許可されていない場合は、新しい内部OAuthアプリを生成し、**その新しい内部OAuthアプリを使用して永続性を維持**できます。

OAuthアプリに関する詳細情報については、次のページを参照してください：

{% content-ref url="gws-google-platforms-phishing/" %}
[gws-google-platforms-phishing](gws-google-platforms-phishing/)
{% endcontent-ref %}

## 委任による永続性

攻撃者が制御する別のアカウントにアカウントを**委任**するだけで済みます（許可されている場合）。Workspaceの**組織**では、このオプションを**有効にする必要があります**。誰にでも無効にすることもできますし、一部のユーザー/グループに対して有効にすることもできます（通常は一部のユーザー/グループにのみ有効にされるか、完全に無効にされます）。

<details>

<summary>Workspace管理者の場合は、この機能を有効にするためにこれをチェックしてください</summary>

（[ドキュメントからコピー](https://support.google.com/a/answer/7223765)）

たとえば、組織（例：職場や学校）の管理者として、Gmailアカウントへのアクセスを委任できるかどうかを制御します。誰もがアカウントを委任できるようにすることもできます。または、特定の部門の人々だけに委任の設定を許可することもできます。たとえば、次のようなことができます：

- 管理アシスタントをGmailアカウントの代理人として追加して、彼らがあなたの代わりにメールを読み取り、送信できるようにします。
- グループ（たとえば、営業部門）を代理人として追加して、すべての人が1つのGmailアカウントにアクセスできるようにします。

ユーザーは、同じ組織内の他のユーザーにのみアクセスを委任できます。そのドメインまたは組織単位に関係なくです。

### 委任の制限と制約

- **Googleグループにメールボックスアクセスを許可する**オプション：このオプションを使用するには、委任されたアカウントのOUと各グループメンバーのOUで有効にする必要があります。このオプションが有効にされていないOUに属するグループメンバーは、委任されたアカウントにアクセスできません。
- 通常の使用では、40人の委任ユーザーが同時にGmailアカウントにアクセスできます。1人以上の委任者による上位の使用は、この数を減らす可能性があります。
- 頻繁にGmailにアクセスする自動化プロセスは、同時にアカウントにアクセスできる委任者の数を減らす可能性があります。これらのプロセスには、Gmailに頻繁にアクセスするAPIやブラウザ拡張機能が含まれます。
- 1つのGmailアカウントには、最大1,000人のユニークな委任者をサポートします。グループは、制限に対する1つの委任者として数えられます。
- 委任は、Gmailアカウントの制限を増やしません。委任されたユーザーのいるGmailアカウントは、標準のGmailアカウントの制限とポリシーを持っています。詳細については、[Gmailの制限とポリシー](https://support.google.com/a/topic/28609)をご覧ください。
### ステップ1: ユーザーのGmail委任を有効にする

**開始する前に:** 特定のユーザーに設定を適用するには、彼らのアカウントを[組織単位](https://support.google.com/a/topic/1227584)に配置します。

1. [サインイン](https://admin.google.com/)して[Google管理コンソール](https://support.google.com/a/answer/182076)にアクセスします。

管理者アカウントを使用してサインインし、現在のアカウントCarlosPolop@gmail.comを使用しないでください。
2. 管理コンソールで、メニューを選択します ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn) **アプリ**![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**ユーザー設定**。
3. 設定をすべてのユーザーに適用する場合は、トップの組織単位を選択したままにします。それ以外の場合は、子[組織単位](https://support.google.com/a/topic/1227584)を選択します。
4. **メール委任**をクリックします。
5. **ドメイン内の他のユーザーにメールボックスへのアクセスを委任できるようにする**ボックスをチェックします。
6. (オプション) ユーザーが自分のアカウントから送信された委任メッセージに含める送信者情報を指定できるようにするには、**この設定をカスタマイズすることを許可**ボックスをチェックします。
7. 代理人によって送信されたメッセージに含まれるデフォルトの送信者情報のオプションを選択します:&#x20;
* **アカウント所有者とメールボックスへのアクセスを委任されたユーザーを表示**—メッセージにはGmailアカウント所有者と代理人のメールアドレスが含まれます。
* **アカウント所有者のみを表示**—メッセージにはGmailアカウント所有者のメールアドレスのみが含まれます。代理人のメールアドレスは含まれません。
8. (オプション) ユーザーがグループを代理人として追加できるようにするには、**ユーザーがGoogleグループにメールボックスアクセスを許可**ボックスをチェックします。
9. **保存**をクリックします。子組織単位を構成した場合、親組織単位の設定を**継承**または**オーバーライド**することができる場合があります。
10. (オプション) 他の組織単位に対してGmail委任を有効にするには、ステップ3から9を繰り返します。

変更は最大24時間かかる場合がありますが、通常はより速く反映されます。[詳細はこちら](https://support.google.com/a/answer/7514107)

### ステップ2: ユーザーにアカウントの委任を設定させる

委任を有効にした後、ユーザーは自分のGmail設定に移動して代理人を割り当てることができます。 代理人はそのユーザーの代わりにメッセージを読み取ったり送信したり受信したりできます。&#x20;

詳細については、ユーザーに[メールの委任と共同作業](https://support.google.com/a/users/answer/138350)をご覧いただくか、以下の通りです。

<details>

<summary>通常のユーザーの場合、アクセスを委任しようとする手順をこちらで確認してください</summary>

(情報は[**ドキュメントからコピー**](https://support.google.com/mail/answer/138350))

最大10人の代理人を追加できます。

職場、学校、または他の組織を通じてGmailを使用している場合:

* 組織内で最大1000人の代理人を追加できます。
* 通常の使用では、40人の代理人が同時にGmailアカウントにアクセスできます。&#x20;
* APIやブラウザ拡張機能などの自動化プロセスを使用する場合、数人の代理人が同時にGmailアカウントにアクセスできます。

1. コンピューターで[Gmail](https://mail.google.com/)を開きます。 Gmailアプリからは代理人を追加できません。
2. 右上の設定をクリックします ![設定](https://lh3.googleusercontent.com/p3J-ZSPOLtuBBR\_ofWTFDfdgAYQgi8mR5c76ie8XQ2wjegk7-yyU5zdRVHKybQgUlQ=w36-h36) ![そして](https://lh3.googleusercontent.com/3\_l97rr0GvhSP2XV5OoCkV2ZDTIisAOczrSdzNCBxhIKWrjXjHucxNwocghoUa39gw=w36-h36) **すべての設定を表示**をクリックします。
3. **アカウントとインポート**または**アカウント**タブをクリックします。
4. "アカウントへのアクセスを許可"セクションで、**別のアカウントを追加**をクリックします。 職場や学校を通じてGmailを使用している場合、組織がメールの委任を制限している場合があります。 この設定が表示されない場合は、管理者に連絡してください。
* アカウントへのアクセスを許可が表示されない場合、制限されています。
5. 追加したい人物のメールアドレスを入力します。 職場、学校、または他の組織を通じてGmailを使用している場合、管理者が許可する場合は、グループのメールアドレスを入力できます。 このグループは組織と同じドメインを持っている必要があります。 グループの外部メンバーは委任アクセスが拒否されます。 \
\
**重要:** 委任するアカウントが新しいアカウントであるか、パスワードがリセットされた場合、最初にサインインする際に管理者はパスワード変更の要件を解除する必要があります。

* [管理者がユーザーを作成する方法](https://support.google.com/a/answer/33310)を学ぶ。
* [管理者がパスワードをリセットする方法](https://support.google.com/a/answer/33319)を学ぶ。

6. **次のステップ**をクリックします ![そして](https://lh3.googleusercontent.com/QbWcYKta5vh\_4-OgUeFmK-JOB0YgLLoGh69P478nE6mKdfpWQniiBabjF7FVoCVXI0g=h36) **アクセスを許可するためのメールを送信**。

追加した人物は、確認を求めるメールを受け取ります。 招待は1週間後に期限切れになります。

グループを追加した場合、すべてのグループメンバーは確認する必要なく代理人になります。&#x20;

注意: 委任が有効になるまで最大24時間かかる場合があります。

</details>

## Androidアプリを介した持続性

**被害者のGoogleアカウント内でセッションがある場合**、**Playストア**に移動して、すでにアップロードした**マルウェアを直接****電話にインストール**して、持続性を維持し、被害者の電話にアクセスできるかもしれません。

## **App Scripts**を介した持続性

App Scriptsで**時間ベースのトリガー**を作成できます。ユーザーがApp Scriptを受け入れると、ユーザーがそれにアクセスしなくても**トリガー**されます。 これについて詳しくは、以下を確認してください:

{% content-ref url="gws-google-platforms-phishing/gws-app-scripts.md" %}
[gws-app-scripts.md](gws-google-platforms-phishing/gws-app-scripts.md)
{% endcontent-ref %}

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>でゼロからヒーローまでAWSハッキングを学びましょう</summary>

HackTricksをサポートする他の方法:

* **HackTricksのPDFをダウンロード**したり、**HackTricksを広告**してもらいたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)コレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **ハッキングのテクニックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリにPRを提出してください。**

</details>
