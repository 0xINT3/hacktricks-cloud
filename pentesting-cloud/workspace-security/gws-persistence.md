# GWS - 永続性

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見する。これは独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

{% hint style="danger" %}
このセクションで言及されている設定を変更する行動は、**セキュリティアラートをメールに送信し、アカウントと同期しているモバイルにプッシュ通知を送信する**ことになります。
{% endhint %}

## **Gmailでの永続性**

* Googleからのセキュリティ通知を隠すために**フィルターを作成**することができます。
* `from: (no-reply@accounts.google.com) "Security Alert"`
* これにより、セキュリティメールがメールに届くのを防ぐことができます（ただし、モバイルへのプッシュ通知を防ぐことはできません）。

<details>

<summary>Gmailフィルターを作成する手順</summary>

（[**こちら**](https://support.google.com/mail/answer/6579)からの指示）

1. [Gmail](https://mail.google.com/)を開きます。
2. 上部の検索ボックスで、検索オプションを表示 ![photos tune](https://lh3.googleusercontent.com/cD6YR_YvqXqNKxrWn2NAWkV6tjJtg8vfvqijKT1_9zVCrl2sAx9jROKhLqiHo2ZDYTE=w36) をクリックします。
3. 検索条件を入力します。検索が正しく機能しているか確認するには、**検索**をクリックして表示されるメールを確認します。
4. 検索ウィンドウの下部で、**フィルターを作成**をクリックします。
5. フィルターで行いたい操作を選択します。
6. **フィルターを作成**をクリックします。

現在のフィルターを確認する（削除する）には、[https://mail.google.com/mail/u/0/#settings/filters](https://mail.google.com/mail/u/0/#settings/filters)をチェックしてください。

</details>

<figure><img src="../../.gitbook/assets/image (142).png" alt=""><figcaption></figcaption></figure>

* **転送アドレスを作成して機密情報**（またはすべての情報）を転送する - 手動でのアクセスが必要です。
* 転送アドレスを[https://mail.google.com/mail/u/2/#settings/fwdandpop](https://mail.google.com/mail/u/2/#settings/fwdandpop)で作成します。
* 受信アドレスはこれを確認する必要があります。
* その後、すべてのメールを転送しながらコピーを保持するように設定します（変更を保存するをクリックするのを忘れないでください）：

<figure><img src="../../.gitbook/assets/image (143).png" alt=""><figcaption></figcaption></figure>

特定のメールのみを他のメールアドレスに転送するためのフィルターを作成することも可能です。

## アプリパスワード

Googleユーザーセッションを**侵害した**場合、ユーザーが**2FA**を使用している場合、[**アプリパスワード**](https://support.google.com/accounts/answer/185833?hl=en)を**生成**することができます（手順を見るにはリンクをフォローしてください）。Googleは**アプリパスワードを推奨しなくなり**、ユーザーがGoogleアカウントのパスワードを**変更すると取り消されます**。

**セッションが開いていても、アプリパスワードを作成するにはユーザーのパスワードを知っている必要があります。**

{% hint style="info" %}
アプリパスワードは、2段階認証がオンになっているアカウントでのみ使用できます。
{% endhint %}

## 2-FAと類似の変更

2-FAを**オフにする**または新しいデバイス（または電話番号）をこのページ[**https://myaccount.google.com/security**](https://myaccount.google.com/security)で**登録する**ことも可能です。\
また、パスキーを生成（自分のデバイスを追加）、パスワードを変更、検証用の携帯電話と回復用のモバイル番号を追加、回復用のメールを変更、セキュリティ質問を変更することも可能です。

{% hint style="danger" %}
ユーザーのスマートフォンにセキュリティプッシュ通知が届かないようにするためには、スマートフォンから**サインアウトする**ことができます（ただし、それは奇妙になるでしょう）なぜなら、ここから再びサインインすることはできません。

デバイスの**位置を特定する**ことも可能です。
{% endhint %}

**セッションが開いていても、これらの設定を変更するにはユーザーのパスワードを知っている必要があります。**

## OAuthアプリを通じた永続性

ユーザーのアカウントを**侵害した**場合、OAuthアプリにすべての可能な権限を付与することを**承認**するだけでよいです。唯一の問題は、Workspaceが未レビューの外部および/または内部OAuthアプリを**許可しないように設定**されている可能性があることです。\
Workspace組織では、外部のOAuthアプリをデフォルトで信頼しないが、内部のものは信頼することが一般的です。そのため、組織内で新しいOAuthアプリケーションを生成する十分な権限を持っていて、外部アプリが許可されていない場合は、それを生成し、その新しい内部OAuthアプリを使用して永続性を維持します。

OAuthアプリに関する詳細情報は以下のページをチェックしてください：

{% content-ref url="gws-google-platforms-phishing.md" %}
[gws-google-platforms-phishing.md](gws-google-platforms-phishing.md)
{% endcontent-ref %}

## 委任による永続性

攻撃者が制御する別のアカウントにアカウントを**委任**するだけでよいです（これを行うことが許可されている場合）。Workspace**組織**では、このオプションが**有効**になっている必要があります。全員に対して無効にすることも、特定のユーザー/グループに対して有効にすることも、または全員に対して有効にすることもできます（通常は特定のユーザー/グループに対してのみ有効にされるか、完全に無効にされます）。

<details>

<summary>Workspace管理者の場合、この機能を有効にする方法を確認する</summary>

（[ドキュメントからの情報](https://support.google.com/a/answer/7223765)）

組織の管理者として（例えば、あなたの職場や学校で）、ユーザーが自分のGmailアカウントへのアクセスを委任できるかどうかを制御します。すべてのユーザーにアカウント委任のオプションを許可することも、特定の部門の人々にのみ設定を許可することもできます。例えば、以下のようにします：

* Gmailアカウントに管理アシスタントを委任として追加し、彼らにあなたに代わってメールを読んだり送信したりさせる。
* グループ（例えば、あなたの営業部門）をGroupsに委任として追加し、全員に1つのGmailアカウントへのアクセスを与える。

ユーザーは、ドメインまたは組織単位に関係なく、同じ組織内の別のユーザーにのみアクセスを委任できます。

### 委任の制限と制約

* **ユーザーに自分のメールボックスへのアクセスをGoogleグループに付与することを許可する**オプション：このオプションを使用するには、委任されたアカウントのOUと各グループメンバーのOUで有効にする必要があります。このオプションが有効になっていないOUに属するグループメンバーは、委任されたアカウントにアクセスできません。
* 通常の使用では、40人の委任ユーザーが同時にGmailアカウントにアクセスできます。委任者の1人以上が平均以上の使用をすると、この数が減る可能性があります。
* Gmailに頻繁にアクセスするAPIやブラウザ拡張機能などの自動化されたプロセスも、同時にアカウントにアクセスできる委任者の数を減らす可能性があります。
* 単一のGmailアカウントは最大1,000人のユニークな委任者をサポートします。Groupsのグループは、制限に対して1人の委任者としてカウントされます。
* 委任はGmailアカウントの制限を増やすものではありません。委任ユーザーを持つGmailアカウントは、標準のGmailアカウントの制限とポリシーを持っています。詳細については、[Gmailの制限とポリシー](https://support.google.com/a/topic/28609)を訪問してください。

### ステップ1: ユーザーのGmail委任をオンにする

**始める前に：** 特定のユーザーに設定を適用するには、彼らのアカウントを[組織単位](https://support.google.com/a/topic/1227584)に入れておきます。

1. [Google管理コンソール](https://admin.google.com/)に[サインイン](https://admin.google.com/)します。

CarlosPolop@gmail.comの現在のアカウントではなく、_管理者アカウント_を使用してサインインします
2. 管理コンソールで、メニュー ![](https://storage.googleapis.com/support-kms-prod/JxKYG9DqcsormHflJJ8Z8bHuyVI5YheC0lAp)![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)![](https://storage.googleapis.com/support-kms-prod/ocGtUSENh4QebLpvZcmLcNRZyaTBcolMRSyl) **アプリ**![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Google Workspace**![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**Gmail**![そして](https://storage.googleapis.com/support-kms-prod/Th2Tx0uwPMOhsMPn7nRXMUo3vs6J0pto2DTn)**ユーザー設定**に進みます。
3. 設定を全員に適用するには、最上位の組織単位を選択したままにします。それ以外の場合は、子[組織単位](https://support.google.com/a/topic/1227584)を選択します。
4. **メール委任**をクリックします。
5. **ユーザーに自分のメールボックスへのアクセスをドメイン内の他のユーザーに委任することを許可する**ボックスをチェックします。
6. （オプション）ユーザーが委任者が自分のアカウントから送信したメッセージに含まれる送信者情報を指定できるようにするには、**ユーザーにこの設定をカスタマイズすることを許可する**ボックスをチェックします。
7. 委任者によって送信されたメッセージに含まれるデフォルトの送信者情報のオプションを選択します：
* **メールの所有者とメールを送信した委任者を表示する**—メッセージにはGmailアカウントの所有者と委任者のメールアドレスが含まれます。
* **アカウントの所有者のみを表示する**—メッセージにはGmailアカウントの所有者のメールアドレスのみが含まれます。委任者のメールアドレ
