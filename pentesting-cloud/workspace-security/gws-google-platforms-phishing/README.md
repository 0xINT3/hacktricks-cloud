# GWS - Google Platforms Phishing

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦で私をフォローする：[**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- **ハッキングトリックを共有するには、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。**

</details>

## 一般的なフィッシング手法

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Google Groups フィッシング

見たところ、ワークスペースメンバーは[**グループを作成**](https://groups.google.com/all-groups) **してそこに人を招待できます**。その後、ユーザーに送信されるメールを変更して、**いくつかのリンクを追加**できます。**メールはGoogleアドレスから送信**されるため、**正規**に見え、人々はリンクをクリックするかもしれません。

また、**FROM**アドレスを**Googleグループのメールアドレス**として設定して、グループのメンバー全員にメールを送信することも可能です。次の画像のように、グループ**`google--support@googlegroups.com`**が作成され、グループのメンバー全員にメールが送信されました（同意なしに追加されたメンバー）。

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Google Chat フィッシング

**メールアドレスを持っている人とチャットを開始**するか、**トークの招待**を送信できるかもしれません。さらに、任意の名前（例：「Googleサポート」）の**スペースを作成**し、メンバーを**招待**することも可能です。彼らが承諾すれば、Googleサポートと話していると思うかもしれません。

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**ただし、私のテストでは招待されたメンバーは招待状を受け取っていませんでした。**
{% endhint %}

これが過去にどのように機能したかを確認できます：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Google Doc フィッシング

過去には、**見かけ上正当なドキュメント**を作成し、コメントで**@user@gmail.com**のようなメールを**言及**することが可能でした。Googleはそのメールアドレスにメールを送信して、そのドキュメントで言及されたことを通知しました。\
現在はこれは機能しませんが、被害者にドキュメントへのアクセス権を与えると、Googleはそのことを通知するメールを送信します。これは、誰かを言及するときに表示されるメッセージです：

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
被害者は、外部ドキュメントが共有されたことを示すメールが届かないようにする保護メカニズムを持っているかもしれません。
{% endhint %}

## Google Calendar フィッシング

攻撃対象の企業のメールアドレスを**いくつか追加**してカレンダーイベントを作成できます。このカレンダーイベントを現在時刻から**5分または15分後**にスケジュールします。イベントを正規に見せ、**コメントとタイトルを追加して、何かを読む必要があることを示します**（**フィッシングリンク**を含む）。

これは、ブラウザに表示される「人員削減」という会議タイトルのアラートです。よりフィッシングらしいタイトルを設定できます（さらに、メールに関連付けられた名前を変更することもできます）。

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

疑わしいと思われないようにするために：

- **受信者が招待された他の人を見ることができないように設定**
- **イベントに関する通知メールを送信しない**。そのため、人々は5分後の会議についての警告と、そのリンクを読む必要があることだけを見ることになります。
- APIを使用して、**人々がイベントを受け入れた**ことを**True**に設定し、**彼らの代わりにコメントを作成**することさえできるようです。

## App Scripts リダイレクトフィッシング

[https://script.google.com/](https://script.google.com/)でスクリプトを作成し、**誰でもアクセスできるWebアプリケーションとして公開**し、**`script.google.com`**の正規ドメインを使用することが可能です。\
次のようなコードを使用すると、攻撃者はこのページで任意のコンテンツを読み込み続けるスクリプトを作成できます：

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

たとえば、[https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) にアクセスすると、次のように表示されます：

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
コンテンツがiframe内で読み込まれるため、警告が表示されることに注意してください。
{% endhint %}

## App Scripts OAuth フィッシング

被害者のOAuthトークンにアクセスしようとするために、ドキュメントにアタッチされたApp Scriptsを作成することが可能です。詳細については、次を確認してください：

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## OAuth Apps フィッシング

前述のいずれかのテクニックを使用して、ユーザーに**Google OAuthアプリケーション**にアクセスさせることができます。ユーザーが**ソース**を**信頼**する場合、そのアプリケーションを**信頼**するかもしれません（たとえ高い権限が求められていても）。

{% hint style="info" %}
Googleは、アプリケーションが信頼されていないことを警告する醜いプロンプトを表示し、ワークスペース管理者はOAuthアプリケーションを受け入れることを防ぐことさえできます。
{% endhint %}

**Google**は、ユーザーを代表して複数の**Googleサービス**（Gmail、Drive、GCPなど）とやり取りできるアプリケーションを作成することを許可しています。\
**他のユーザーを代表して動作するアプリケーション**を作成する場合、開発者は**GCP内でOAuthアプリ**を作成し、ユーザーデータにアクセスするために必要なスコープ（権限）を指定する必要があります。\
**ユーザー**がその**アプリケーション**を**使用**したい場合、スコープで指定されたデータにアクセスする権限を**受け入れるように求められます**。

これは、非技術者を**フィッシング**して、重要な情報にアクセスする**アプリケーションを使用**させる非常に魅力的な方法です。ただし、組織アカウントでは、これを防ぐ方法があります。

### 未検証アプリプロンプト

前述のように、Googleは常にユーザーに**アプリケーションに与える権限を受け入れるように求めるプロンプト**を表示します。ただし、アプリケーションが**危険**と見なされる場合、Googleは**最初に**そのアプリケーションが**危険**であることを示す**プロンプト**を表示し、ユーザーにアプリに権限を与えることをより困難にします。

このプロンプトは、次のようなアプリで表示されます：

* プライベートデータにアクセスできるスコープを使用するアプリ（Gmail、Drive、GCP、BigQueryなど）
* 100人未満のユーザーを持つアプリ（100人以上の場合、未検証プロンプトを表示しないようにするためにレビュープロセスも必要）

### 興味深いスコープ

[**こちら**](https://developers.google.com/identity/protocols/oauth2/scopes) で、すべてのGoogle OAuthスコープのリストを見つけることができます。

* **cloud-platform**: **Google Cloud Platform**サービス全体でデータを表示および管理します。GCPでユーザーを偽装できます。
* **admin.directory.user.readonly**: 組織のGSuiteディレクトリを表示およびダウンロードします。すべてのユーザーの名前、電話番号、カレンダーURLを取得します。

### OAuthアプリを作成する

**OAuthクライアントIDを作成**を開始します

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) に移動し、同意画面を構成するをクリックします。
2. 次に、**ユーザータイプ**が**内部**（組織内の人のみ）か**外部**かを尋ねられます。必要に応じて選択します
* 内部は、組織のユーザーをすでに侵害しており、別のユーザーをフィッシングするためにこのアプリを作成している場合に興味があります。
3. アプリに**名前**、**サポートメール**（Googleグループのメールを設定して、より匿名性を高めることもできます）、**ロゴ**、**承認されたドメイン**、**更新用の別のメール**を指定します。
4. **OAuthスコープ**を**選択**します。
* このページは、非機密権限、機密権限、制限された権限に分かれています。新しい権限を追加するたびに、そのカテゴリに追加されます。要求された権限に応じて、異なるプロンプトがユーザーに表示され、これらの権限がどれだけ機密性が高いかを示します。
* **`admin.directory.user.readonly`** と **`cloud-platform`** は機密権限です。
5. **テストユーザーを追加します。** アプリのステータスがテスト中である限り、これらのユーザーだけがアプリにアクセスできるようになりますので、**フィッシングするメールアドレスを追加**することを忘れないでください。

次に、**以前に作成したOAuthクライアントID**を使用して、**Webアプリケーションの資格情報を取得**しましょう：

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) に戻り、今回は異なるオプションが表示されます。
2. **Webアプリケーションの資格情報を作成**するように選択します
3. 必要な**Javascript origins**と**リダイレクトURI**を設定します
* テスト用に **`http://localhost:8000/callback`** のようなものを両方に設定できます
4. アプリケーションの**資格情報**を取得します

最後に、**OAuthアプリケーションの資格情報を使用するWebアプリケーションを実行**しましょう。[https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example) に例があります。
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
**`http://localhost:8000`** に移動し、Google ログインボタンをクリックすると、次のようなメッセージが表示されます：

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

アプリケーションは簡単に使用できる **アクセスとリフレッシュトークン** を表示します。これらのトークンの使用方法について詳細は次を参照してください：

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### `glcoud` を使用する

Web コンソールの代わりに gcloud を使用して何かを行うことが可能です。詳細は次を確認してください：

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks で企業を宣伝したい** または **HackTricks を PDF でダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローする
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出して、あなたのハッキングトリックを共有する

</details>
