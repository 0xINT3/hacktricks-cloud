# GWS - Google平台网络钓鱼

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 通用网络钓鱼方法论

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Google Groups网络钓鱼

显然，默认情况下，workspace成员[**可以创建群组**](https://groups.google.com/all-groups) **并邀请人加入**。然后，您可以修改将发送给用户的电子邮件，**添加一些链接**。**电子邮件将来自Google地址**，因此看起来**合法**，人们可能会点击链接。

还可以将**发件人**地址设置为**Google群组电子邮件**，向群组内的用户**发送更多电子邮件**，如下图所示，创建了群组**`google--support@googlegroups.com`** 并向群组的所有成员（未经同意即被添加）**发送了电子邮件**

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

## Google Chat网络钓鱼

您可能能够仅凭电子邮件地址**开始与某人聊天**或发送**聊天邀请**。此外，可以**创建一个空间**，可以有任何名称（例如“Google支持”），并**邀请**成员加入。如果他们接受，他们可能会认为他们正在与Google支持交谈：

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**然而，在我的测试中，被邀请的成员甚至没有收到邀请。**
{% endhint %}

您可以在以下链接中查看过去的工作方式：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Google Doc网络钓鱼

过去可以创建一个**看似合法的文档**，然后在评论中**提及某些电子邮件（如@user@gmail.com）**。Google **会向该电子邮件地址发送电子邮件**，通知他们在文档中被提及。\
如今，这种方法不再有效，但如果您**授予受害者电子邮件访问文档的权限**，Google会发送电子邮件表明这一点。当您提及某人时，会出现以下消息：

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
受害者可能有保护机制，不允许指示与他们共享的外部文档的电子邮件到达他们的邮箱。
{% endhint %}

## Google Calendar网络钓鱼

您可以**创建日历事件**并添加尽可能多的您正在攻击的公司的电子邮件地址。将此日历事件安排在当前时间**5分钟或15分钟后**。使事件看起来合法，并**添加评论和标题，指示他们需要阅读某些内容**（带有**网络钓鱼链接**）。

以下是浏览器中出现的提醒，会议标题为“Firing People”，因此您可以设置更像网络钓鱼的标题（甚至更改与您电子邮件关联的名称）。

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

为了使其看起来不那么可疑：

* 设置为**接收者无法看到其他被邀请的人**
* **不要发送有关事件的电子邮件通知**。然后，人们只会看到他们关于5分钟内会议的警告，并且他们需要阅读那个链接。
* 显然，使用API可以将**人们**已**接受**事件设置为**True**，甚至可以代表他们**创建评论**。

## App Scripts重定向网络钓鱼

可以在[https://script.google.com/](https://script.google.com/)创建一个脚本，并**将其公开为所有人都可以访问的网络应用程序**，它将使用合法域名**`script.google.com`**。\
然后，攻击者可以使用以下代码使脚本在不停止访问域的情况下加载任意内容：

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

例如访问 [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) 你会看到：

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
请注意，由于内容是在 iframe 内加载的，会出现一个警告。
{% endhint %}

## App Scripts OAuth 钓鱼攻击

可以创建附加到文档的 App Scripts 来尝试获取受害者的 OAuth 令牌，更多信息请查看：

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## OAuth 应用程序钓鱼攻击

之前的任何技术都可能被用来让用户访问一个 **Google OAuth 应用程序**，该应用程序将向用户 **请求** 一些 **访问权限**。如果用户 **信任** 这个 **来源**，他们可能会 **信任** 这个 **应用程序**（即使它请求高权限）。

{% hint style="info" %}
请注意，Google 在多种情况下会展示一个不友好的提示，警告应用程序不受信任，并且 Workspace 管理员甚至可以阻止人们接受 OAuth 应用程序。
{% endhint %}

**Google** 允许创建可以代表用户与多个 **Google 服务** 交互的应用程序：Gmail、Drive、GCP 等。

当创建一个代表其他用户行动的应用程序时，开发者需要在 **GCP 内创建一个 OAuth 应用程序** 并指明应用程序需要访问用户数据的权限范围（scopes）。\
当一个 **用户** 想要 **使用** 那个 **应用程序** 时，他们将被 **提示** **接受** 应用程序将访问其在权限范围内指定的数据。

这是一个非常吸引人的方式来 **钓鱼** 非技术用户使用 **访问敏感信息的应用程序**，因为他们可能不理解后果。然而，在组织账户中，有方法可以防止这种情况发生。

### 未验证应用程序提示

如前所述，google 总是会向用户展示一个 **提示**，让他们接受他们代表自己给予应用程序的权限。然而，如果应用程序被认为是 **危险的**，google 会 **首先** 显示一个 **提示**，指出它是 **危险的** 并且 **使用户更难** 授予应用程序权限。

这个提示会出现在以下应用程序中：

* 使用任何可以访问私人数据的权限范围（Gmail、Drive、GCP、BigQuery...）
* 应用程序用户少于 100 个（应用程序 > 100 个用户也需要一个审核过程来停止显示未验证提示）

### 有趣的权限范围

[**这里**](https://developers.google.com/identity/protocols/oauth2/scopes) 你可以找到所有 Google OAuth 权限范围的列表。

* **cloud-platform**：查看和管理您在 **Google Cloud Platform** 服务中的数据。您可以冒充用户在 GCP 中。
* **admin.directory.user.readonly**：查看和下载您组织的 GSuite 目录。获取所有用户的姓名、电话、日历 URL。

### 创建一个 OAuth 应用程序

**开始创建一个 OAuth 客户端 ID**

1. 访问 [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) 并点击配置同意屏幕。
2. 然后，你将被询问 **用户类型** 是 **内部的**（仅限于你的组织内的人）还是 **外部的**。选择适合你需求的一个。
* 如果你已经攻破了组织中的一个用户，并且你正在创建这个应用程序来钓鱼另一个用户，内部可能会很有趣。
3. 给应用程序起一个 **名称**，一个 **支持电子邮件**（注意你可以设置一个 googlegroup 电子邮件来尝试更匿名一些），一个 **logo**，**授权域名** 和另一个 **更新用的电子邮件**。
4. **选择** **OAuth 权限范围**。
* 这个页面被分为非敏感权限、敏感权限和受限权限。每次你添加一个新的权限，它就会被添加到它的类别中。根据请求的权限不同，用户会看到不同的提示，指示这些权限的敏感程度。
* **`admin.directory.user.readonly`** 和 **`cloud-platform`** 都是敏感权限。
5. **添加测试用户。** 只要应用程序的状态是测试中，只有这些用户才能访问应用程序，所以确保 **添加你将要钓鱼的电子邮件**。

现在让我们获取 **用于 Web 应用程序的凭据**，使用 **之前创建的 OAuth 客户端 ID**：

1. 返回到 [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)，这次会出现一个不同的选项。
2. 选择为 Web 应用程序 **创建凭据**
3. 设置所需的 **Javascript 来源** 和 **重定向 URI**
* 你可以在两者中设置类似 **`http://localhost:8000/callback`** 用于测试
4. 获取你的应用程序 **凭据**

最后，让我们 **运行一个将使用 OAuth 应用程序凭据的 Web 应用程序**。你可以在 [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example) 找到一个示例。
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
访问 **`http://localhost:8000`** 并点击登录Google按钮，你会看到如下提示信息：

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

应用程序将显示**访问和刷新令牌**，这些令牌可以轻松使用。要了解**如何使用这些令牌，请查看**：

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### 使用 `glcoud`

可以使用gcloud代替网络控制台来执行操作，请查看：

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## 参考资料

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - 黑客攻击G Suite：暗黑Apps Script魔法的力量
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch和Beau Bullock - OK Google，我如何对GSuite进行红队测试？

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks中看到你的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享你的黑客技巧**。

</details>
