# GWS - Phishing em Plataformas Google

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Metodologia Gen√©rica de Phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing em Grupos Google

Aparentemente, por padr√£o, em workspace os membros [**podem criar grupos**](https://groups.google.com/all-groups) **e convidar pessoas para eles**. Voc√™ pode ent√£o modificar o email que ser√° enviado ao usu√°rio **adicionando alguns links**. O **email vir√° de um endere√ßo google**, ent√£o parecer√° **leg√≠timo** e as pessoas podem clicar no link.

Tamb√©m √© poss√≠vel definir o endere√ßo **DE** como o **email do grupo Google** para enviar **mais emails aos usu√°rios dentro do grupo**, como na imagem a seguir onde o grupo **`google--support@googlegroups.com`** foi criado e um **email foi enviado a todos os membros** do grupo (que foram adicionados sem qualquer consentimento)

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

## Phishing no Google Chat

Voc√™ pode ser capaz de **iniciar um chat** com uma pessoa apenas tendo o endere√ßo de email dela ou enviar um **convite para conversar**. Al√©m disso, √© poss√≠vel **criar um Espa√ßo** que pode ter qualquer nome (por exemplo, "Suporte Google") e **convidar** membros para ele. Se aceitarem, podem pensar que est√£o falando com o Suporte Google:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**No entanto, nos meus testes, os membros convidados nem mesmo receberam um convite.**
{% endhint %}

Voc√™ pode verificar como isso funcionou no passado em: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing no Google Docs

No passado era poss√≠vel criar um **documento aparentemente leg√≠timo** e no coment√°rio **mencionar algum email (como @user@gmail.com)**. O Google **enviava um email para esse endere√ßo de email** notificando que foram mencionados no documento.\
Atualmente, isso n√£o funciona, mas se voc√™ **der acesso ao documento ao email da v√≠tima**, o Google enviar√° um email indicando isso. Esta √© a mensagem que aparece quando voc√™ menciona algu√©m:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
As v√≠timas podem ter mecanismos de prote√ß√£o que impedem que emails indicando que um documento externo foi compartilhado com eles cheguem ao seu email.
{% endhint %}

## Phishing no Google Calendar

Voc√™ pode **criar um evento no calend√°rio** e adicionar quantos endere√ßos de email da empresa que voc√™ est√° atacando tiver. Agende este evento no calend√°rio para **5 ou 15 minutos** a partir do momento atual. Fa√ßa o evento parecer leg√≠timo e **coloque um coment√°rio e um t√≠tulo indicando que eles precisam ler algo** (com o **link de phishing**).

Este √© o alerta que aparecer√° no navegador com um t√≠tulo de reuni√£o "Demitindo Pessoas", ent√£o voc√™ poderia definir um t√≠tulo mais propenso ao phishing (e at√© mudar o nome associado ao seu email).

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Para parecer menos suspeito:

* Configure para que os **receptores n√£o possam ver as outras pessoas convidadas**
* **N√ÉO envie emails notificando sobre o evento**. Assim, as pessoas s√≥ ver√£o o aviso sobre uma reuni√£o em 5 minutos e que precisam ler aquele link.
* Aparentemente, usando a API voc√™ pode definir como **Verdadeiro** que as **pessoas** **aceitaram** o evento e at√© criar **coment√°rios em nome delas**.

## Phishing com Redirecionamento de App Scripts

√â poss√≠vel criar um script em [https://script.google.com/](https://script.google.com/) e **expor como uma aplica√ß√£o web acess√≠vel por todos** que usar√° o dom√≠nio leg√≠timo **`script.google.com`**.\
Ent√£o, com um c√≥digo como o seguinte, um atacante poderia fazer o script carregar conte√∫do arbitr√°rio nesta p√°gina sem parar de acessar o dom√≠nio:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Por exemplo, acessando [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) voc√™ ver√°:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Observe que um aviso aparecer√°, pois o conte√∫do √© carregado dentro de um iframe.
{% endhint %}

## App Scripts OAuth Phishing

√â poss√≠vel criar App Scripts anexados a documentos para tentar obter acesso ao token OAuth de uma v√≠tima, para mais informa√ß√µes verifique:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## OAuth Apps Phishing

Qualquer uma das t√©cnicas anteriores pode ser usada para fazer o usu√°rio acessar uma **aplica√ß√£o Google OAuth** que ir√° **solicitar** ao usu√°rio algum **acesso**. Se o usu√°rio **confiar** na **fonte**, ele pode **confiar** na **aplica√ß√£o** (mesmo que ela esteja pedindo permiss√µes de alto privil√©gio).

{% hint style="info" %}
Note que o Google apresenta um aviso desagrad√°vel alertando que a aplica√ß√£o n√£o √© confi√°vel em v√°rios casos e os administradores do Workspace podem at√© impedir que as pessoas aceitem aplica√ß√µes OAuth.
{% endhint %}

**Google** permite criar aplica√ß√µes que podem **interagir em nome dos usu√°rios** com v√°rios **servi√ßos Google**: Gmail, Drive, GCP...

Ao criar uma aplica√ß√£o para **agir em nome de outros usu√°rios**, o desenvolvedor precisa criar uma **aplica√ß√£o OAuth dentro do GCP** e indicar os escopos (permiss√µes) de que o aplicativo precisa para acessar os dados dos usu√°rios.\
Quando um **usu√°rio** deseja **usar** essa **aplica√ß√£o**, ele ser√° **solicitado** a **aceitar** que a aplica√ß√£o tenha acesso aos seus dados especificados nos escopos.

Esta √© uma maneira muito atraente de **phish** usu√°rios n√£o t√©cnicos para usar **aplica√ß√µes que acessam informa√ß√µes sens√≠veis** porque eles podem n√£o entender as consequ√™ncias. No entanto, em contas de organiza√ß√µes, existem maneiras de impedir que isso aconte√ßa.

### Aviso de Aplicativo N√£o Verificado

Como mencionado, o Google sempre apresentar√° um **aviso ao usu√°rio para aceitar** as permiss√µes que est√£o dando √† aplica√ß√£o em seu nome. No entanto, se a aplica√ß√£o for considerada **perigosa**, o Google mostrar√° **primeiro** um **aviso** indicando que √© **perigoso** e **tornando mais dif√≠cil** para o usu√°rio conceder as permiss√µes ao aplicativo.

Este aviso aparece em aplicativos que:

* Usam qualquer escopo que possa acessar dados privados (Gmail, Drive, GCP, BigQuery...)
* Aplicativos com menos de 100 usu√°rios (aplicativos > 100 tamb√©m precisam de um processo de revis√£o para parar de mostrar o aviso de n√£o verificado)

### Escopos Interessantes

[**Aqui**](https://developers.google.com/identity/protocols/oauth2/scopes) voc√™ pode encontrar uma lista de todos os escopos OAuth do Google.

* **cloud-platform**: Visualizar e gerenciar seus dados em servi√ßos do **Google Cloud Platform**. Voc√™ pode se passar pelo usu√°rio no GCP.
* **admin.directory.user.readonly**: Ver e baixar o diret√≥rio GSuite da sua organiza√ß√£o. Obter nomes, telefones, URLs de calend√°rio de todos os usu√°rios.

### Criar um Aplicativo OAuth

**Comece criando um ID de Cliente OAuth**

1. V√° para [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) e clique em configurar a tela de consentimento.
2. Depois, ser√° perguntado se o **tipo de usu√°rio** √© **interno** (apenas para pessoas na sua org) ou **externo**. Selecione o que atender √†s suas necessidades
* Interno pode ser interessante se voc√™ j√° comprometeu um usu√°rio da organiza√ß√£o e est√° criando este App para phish outro.
3. D√™ um **nome** para o aplicativo, um **email de suporte** (note que voc√™ pode definir um email de googlegroup para tentar se anonimizar um pouco mais), um **logo**, **dom√≠nios autorizados** e outro **email** para **atualiza√ß√µes**.
4. **Selecione** os **escopos OAuth**.
* Esta p√°gina √© dividida em permiss√µes n√£o sens√≠veis, permiss√µes sens√≠veis e permiss√µes restritas. Sempre que voc√™ adicionar uma nova permiss√£o, ela ser√° adicionada em sua categoria. Dependendo das permiss√µes solicitadas, diferentes avisos aparecer√£o para o usu√°rio indicando o qu√£o sens√≠veis essas permiss√µes s√£o.
* Tanto **`admin.directory.user.readonly`** quanto **`cloud-platform`** s√£o permiss√µes sens√≠veis.
5. **Adicione os usu√°rios de teste.** Enquanto o status do aplicativo for de teste, apenas esses usu√°rios poder√£o acessar o aplicativo, ent√£o certifique-se de **adicionar o email que voc√™ vai phishar**.

Agora vamos obter **credenciais para uma aplica√ß√£o web** usando o **ID de Cliente OAuth criado anteriormente**:

1. Volte para [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), uma op√ß√£o diferente aparecer√° desta vez.
2. Selecione para **criar credenciais para uma aplica√ß√£o Web**
3. Defina as **origens Javascript** necess√°rias e **URIs de redirecionamento**
* Voc√™ pode definir em ambos algo como **`http://localhost:8000/callback`** para testes
4. Obtenha as **credenciais** da sua aplica√ß√£o

Finalmente, vamos **executar uma aplica√ß√£o web que usar√° as credenciais da aplica√ß√£o OAuth**. Voc√™ pode encontrar um exemplo em [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Acesse **`http://localhost:8000`** e clique no bot√£o Login com Google, voc√™ receber√° uma mensagem como esta:

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

O aplicativo mostrar√° o **token de acesso e atualiza√ß√£o** que pode ser facilmente utilizado. Para mais informa√ß√µes sobre **como usar esses tokens verifique**:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Usando `glcoud`

√â poss√≠vel fazer algo usando gcloud em vez do console web, verifique:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: O Poder da Magia Obscura do Apps Script
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch e Beau Bullock - OK Google, Como Fa√ßo para Red Team GSuite?

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
