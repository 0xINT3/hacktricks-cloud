# GWS - Google Platforms Phishing

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## M√©thodologie de phishing g√©n√©rique

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing dans les groupes Google

Apparemment, par d√©faut, dans les membres de l'espace de travail [**peuvent cr√©er des groupes**](https://groups.google.com/all-groups) **et inviter des personnes √† les rejoindre**. Vous pouvez ensuite modifier l'e-mail qui sera envoy√© √† l'utilisateur **en ajoutant des liens**. L'e-mail proviendra d'une adresse google, il semblera donc **l√©gitime** et les gens pourraient cliquer sur le lien.

Il est √©galement possible de d√©finir l'adresse **FROM** comme l'**e-mail du groupe Google** pour envoyer **plus d'e-mails aux utilisateurs du groupe**, comme dans l'image suivante o√π le groupe **`google--support@googlegroups.com`** a √©t√© cr√©√© et un **e-mail a √©t√© envoy√© √† tous les membres** du groupe (qui ont √©t√© ajout√©s sans consentement).

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

## Phishing dans Google Chat

Vous pourriez √™tre en mesure de **d√©marrer une conversation** avec une personne en ayant simplement son adresse e-mail ou envoyer une **invitation pour discuter**. De plus, il est possible de **cr√©er un espace** qui peut avoir n'importe quel nom (par exemple "Support Google") et **inviter** des membres. S'ils acceptent, ils pourraient penser qu'ils discutent avec le support Google :

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Cependant, dans mes tests, les membres invit√©s n'ont m√™me pas re√ßu d'invitation.**
{% endhint %}

Vous pouvez v√©rifier comment cela fonctionnait dans le pass√© sur : [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing dans Google Docs

Dans le pass√©, il √©tait possible de cr√©er un **document apparemment l√©gitime** et de mentionner dans un commentaire un e-mail (comme @user@gmail.com). Google **envoyait un e-mail √† cette adresse e-mail** pour les informer qu'ils √©taient mentionn√©s dans le document.\
De nos jours, cela ne fonctionne pas, mais si vous **donnez √† la victime un acc√®s par e-mail au document**, Google enverra un e-mail l'indiquant. Voici le message qui appara√Æt lorsque vous mentionnez quelqu'un :

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Les victimes peuvent avoir un m√©canisme de protection qui ne permet pas aux e-mails indiquant qu'un document externe leur a √©t√© partag√© d'atteindre leur e-mail.
{% endhint %}

## Phishing dans Google Agenda

Vous pouvez **cr√©er un √©v√©nement dans le calendrier** et ajouter autant d'adresses e-mail de l'entreprise que vous attaquez que vous le souhaitez. Planifiez cet √©v√©nement dans **5 ou 15 minutes** √† partir de l'heure actuelle. Rendez l'√©v√©nement cr√©dible et **ajoutez un commentaire et un titre indiquant qu'ils doivent lire quelque chose** (avec le **lien de phishing**).

C'est l'alerte qui appara√Ætra dans le navigateur avec un titre de r√©union "Licenciement de personnes", vous pourriez donc d√©finir un titre plus orient√© phishing (et m√™me changer le nom associ√© √† votre e-mail).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

Pour que cela paraisse moins suspect :

* Configurez-le de sorte que les **destinataires ne puissent pas voir les autres personnes invit√©es**
* **NE PAS envoyer d'e-mails pour notifier de l'√©v√©nement**. Ainsi, les personnes ne verront que leur avertissement concernant une r√©union dans 5 minutes et qu'elles doivent lire ce lien.
* Apparemment, en utilisant l'API, vous pouvez d√©finir √† **True** que les **personnes** ont **accept√©** l'√©v√©nement et m√™me cr√©er des **commentaires en leur nom**.

## Phishing de redirection des scripts d'application

Il est possible de cr√©er un script sur [https://script.google.com/](https://script.google.com/) et de **l'exposer en tant qu'application web accessible par tout le monde** qui utilisera le domaine l√©gitime **`script.google.com`**.  \
Ensuite, avec un code comme le suivant, un attaquant pourrait faire en sorte que le script charge un contenu arbitraire sur cette page sans cesser d'acc√©der au domaine :

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Par exemple, en acc√©dant √† [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) vous verrez :

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Notez qu'un avertissement appara√Ætra car le contenu est charg√© √† l'int√©rieur d'un iframe.
{% endhint %}

## Phishing OAuth des Scripts d'Application

Il est possible de cr√©er des Scripts d'Application attach√©s √† des documents pour essayer d'obtenir l'acc√®s au jeton OAuth d'une victime, pour plus d'informations consultez :

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing des Applications OAuth

Toutes les techniques pr√©c√©dentes peuvent √™tre utilis√©es pour amener l'utilisateur √† acc√©der √† une **application OAuth Google** qui demandera √† l'utilisateur un **acc√®s**. Si l'utilisateur **fait confiance** √† la **source**, il pourrait **faire confiance** √† l'**application** (m√™me si elle demande des autorisations tr√®s √©lev√©es).

{% hint style="info" %}
Notez que Google pr√©sente une fen√™tre d'avertissement indiquant que l'application n'est pas digne de confiance dans plusieurs cas et les administrateurs Workspace peuvent m√™me emp√™cher les personnes d'accepter les applications OAuth.
{% endhint %}

**Google** permet de cr√©er des applications qui peuvent **interagir au nom des utilisateurs** avec plusieurs **services Google** : Gmail, Drive, GCP...

Lors de la cr√©ation d'une application pour **agir au nom d'autres utilisateurs**, le d√©veloppeur doit cr√©er une **application OAuth dans GCP** et indiquer les √©tendues (autorisations) dont l'application a besoin pour acc√©der aux donn√©es des utilisateurs.\
Lorsqu'un **utilisateur** souhaite **utiliser** cette **application**, il lui sera demand√© d'**accepter** que l'application ait acc√®s √† leurs donn√©es sp√©cifi√©es dans les √©tendues.

C'est une mani√®re tr√®s attrayante de **phisher** des utilisateurs non techniques pour qu'ils utilisent des **applications qui acc√®dent √† des informations sensibles** car ils pourraient ne pas comprendre les cons√©quences. Cependant, dans les comptes d'organisations, il existe des moyens d'emp√™cher cela de se produire.

### Fen√™tre d'avertissement pour les Applications non V√©rifi√©es

Comme mentionn√© pr√©c√©demment, Google pr√©sentera toujours une **fen√™tre d'avertissement √† l'utilisateur pour accepter** les autorisations qu'il donne √† l'application en son nom. Cependant, si l'application est consid√©r√©e comme **dangereuse**, Google affichera **d'abord** une **fen√™tre d'avertissement** indiquant qu'elle est **dangereuse** et **rendant plus difficile** pour l'utilisateur d'accorder les autorisations √† l'application.

Cette fen√™tre d'avertissement appara√Æt dans les applications qui :

* Utilisent une √©tendue qui peut acc√©der √† des donn√©es priv√©es (Gmail, Drive, GCP, BigQuery...)
* Applications avec moins de 100 utilisateurs (pour les applications > 100, un processus de r√©vision est √©galement n√©cessaire pour arr√™ter d'afficher la fen√™tre d'avertissement non v√©rifi√©e)

### √âtendues Int√©ressantes

[**Ici**](https://developers.google.com/identity/protocols/oauth2/scopes) vous pouvez trouver une liste de toutes les √©tendues OAuth Google.

* **cloud-platform** : Afficher et g√©rer vos donn√©es sur plusieurs services de la **plateforme Google Cloud**. Vous pouvez vous faire passer pour l'utilisateur dans GCP.
* **admin.directory.user.readonly** : Voir et t√©l√©charger l'annuaire GSuite de votre organisation. Obtenez les noms, les num√©ros de t√©l√©phone, les URL de calendrier de tous les utilisateurs.

### Cr√©er une Application OAuth

**Commencez par cr√©er un ID Client OAuth**

1. Allez sur [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) et cliquez sur configurer l'√©cran de consentement.
2. Ensuite, on vous demandera si le **type d'utilisateur** est **interne** (uniquement pour les personnes de votre organisation) ou **externe**. S√©lectionnez celui qui convient le mieux √† vos besoins
* L'interne peut √™tre int√©ressant si vous avez d√©j√† compromis un utilisateur de l'organisation et que vous cr√©ez cette application pour phisher un autre.
3. Donnez un **nom** √† l'application, un **e-mail de support** (notez que vous pouvez d√©finir un e-mail de groupe Google pour essayer de vous anonymiser un peu plus), un **logo**, des **domaines autoris√©s** et un autre **e-mail** pour les **mises √† jour**.
4. **S√©lectionnez** les **√©tendues OAuth**.
* Cette page est divis√©e en autorisations non sensibles, autorisations sensibles et autorisations restreintes. Chaque fois que vous ajoutez une nouvelle autorisation, elle est ajout√©e dans sa cat√©gorie. Selon les autorisations demand√©es, diff√©rents avertissements appara√Ætront √† l'utilisateur indiquant la sensibilit√© de ces autorisations.
* Les deux autorisations **`admin.directory.user.readonly`** et **`cloud-platform`** sont des autorisations sensibles.
5. **Ajoutez les utilisateurs de test.** Tant que le statut de l'application est en test, seuls ces utilisateurs pourront acc√©der √† l'application, alors assurez-vous d'**ajouter l'e-mail que vous allez phisher**.

Maintenant, obtenons **des identifiants pour une application web** en utilisant l'**ID Client OAuth pr√©c√©demment cr√©√©** :

1. Retournez sur [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), une option diff√©rente appara√Ætra cette fois.
2. S√©lectionnez de **cr√©er des identifiants pour une application Web**
3. D√©finissez les **origines Javascript** n√©cessaires et les **URI de redirection**
* Vous pouvez d√©finir dans les deux quelque chose comme **`http://localhost:8000/callback`** pour les tests
4. Obtenez vos **identifiants d'application**

Enfin, ex√©cutons une **application web qui utilisera les identifiants de l'application OAuth**. Vous pouvez trouver un exemple sur [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Allez sur **`http://localhost:8000`**, cliquez sur le bouton Login with Google, vous serez **invit√©** avec un message comme celui-ci :

<figure><img src="../../../.gitbook/assets/image (333).png" alt=""><figcaption></figcaption></figure>

L'application affichera les **jetons d'acc√®s et de rafra√Æchissement** qui peuvent √™tre facilement utilis√©s. Pour plus d'informations sur **comment utiliser ces jetons, consultez** :

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Utilisation de `gcloud`

Il est possible de faire quelque chose en utilisant gcloud au lieu de la console web, consultez :

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
