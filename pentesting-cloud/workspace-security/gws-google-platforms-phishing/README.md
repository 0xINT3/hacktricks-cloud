# GWS - Google 플랫폼 피싱

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)을 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 일반적인 피싱 방법론

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Google 그룹 피싱

기본적으로 Workspace 구성원은 [**그룹을 생성**](https://groups.google.com/all-groups)하고 **사람들을 초대**할 수 있습니다. 그런 다음 사용자에게 보내질 **이메일을 수정**하여 일부 링크를 추가할 수 있습니다. **이메일은 Google 주소에서** 올 것이므로 **진짜**로 보일 것이며 사람들은 링크를 클릭할 수도 있습니다.

또한 **FROM** 주소를 **Google 그룹 이메일**로 설정하여 그룹 내의 사용자에게 **더 많은 이메일을 보낼 수**도 있습니다. 다음 이미지에서는 그룹 **`google--support@googlegroups.com`**이 생성되고 그룹의 모든 구성원에게 **이메일이 전송**되었습니다(동의 없이 추가된 구성원).

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Google Chat 피싱

사람의 이메일 주소만 알고 있다면 **채팅을 시작**하거나 **대화 초대**를 보낼 수 있습니다. 또한 **"Google 지원"**과 같은 이름을 가진 **Space**를 **생성**하고 회원을 **초대**할 수도 있습니다. 그들이 수락하면 그들은 Google 지원과 대화 중이라고 생각할 수 있습니다.

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**하지만 제 테스트에서는 초대된 구성원은 심지어 초대장을 받지 못했습니다.**
{% endhint %}

이전에 이 작업이 어떻게 작동하는지 확인할 수 있습니다: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Google 문서 피싱

과거에는 **외관상 정당한 문서**를 생성하고 주석에서 **일부 이메일을 언급**할 수 있었습니다(예: @user@gmail.com). Google은 해당 이메일 주소로 이메일을 보내 문서에서 언급되었다는 것을 알렸습니다.\
하지만 현재는 이 방법이 작동하지 않지만 피해자에게 문서에 대한 이메일 액세스 권한을 부여하면 Google이 이메일을 보내 알려줍니다. 다음은 누군가를 언급할 때 나타나는 메시지입니다:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
피해자는 외부 문서가 공유되었다는 이메일이 도달하지 않도록 보호 메커니즘을 가질 수 있습니다.
{% endhint %}

## Google 캘린더 피싱

공격 대상인 회사의 이메일 주소를 **모두 추가**할 수 있는 캘린더 이벤트를 **생성**할 수 있습니다. 현재 시간으로부터 **5분 또는 15분** 후에 이 캘린더 이벤트를 예약하세요. 이벤트를 진짜처럼 보이게 만들고 **댓글과 제목에 읽어야 할 내용**을 나타내는 (피싱 링크와 함께) 코멘트를 추가하세요.

다음은 브라우저에 나타나는 "인사하기"라는 회의 제목과 함께 나타나는 경고입니다. 따라서 더 피싱과 같은 제목을 설정할 수 있습니다(심지어 이메일과 관련된 이름을 변경할 수도 있습니다).

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

더 의심스럽지 않게 보이도록 설정하세요:

* 수신자가 초대된 다른 사람들을 볼 수 없도록 설정하세요.
* **이벤트에 대한 이메일 알림을 보내지 마세요**. 그러면 사람들은 5분 후에 회의에 대한 경고와 해당 링크를 읽어야 한다는 경고만 볼 수 있습니다.
* API를 사용하여 **사람들이** 이벤트를 **수락**했음을 **True**로 설정하고 그들을 대신하여 **코멘트를 작성**할 수 있다고 합니다.

## 앱 스크립트 리디렉션 피싱

[https://script.google.com/](https://script.google.com/)에서 스크립트를 생성하고 **모든 사람이 액세스할 수 있는 웹 애플리케이션으로 노출**할 수 있습니다. 이 웹 애플리케이션은 **`script.google.com`**이라는 진정한 도메인을 사용할 것입니다.  \
다음과 같은 코드로 공격자는 이 스크립트가 도메인에 접근을 중단하지 않고 임의의 콘텐츠를 이 페이지에 로드하도록 할 수 있습니다:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

예를 들어 [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec)에 액세스하면 다음과 같이 표시됩니다:

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
내용이 iframe 내에서로드되므로 경고가 표시됩니다.
{% endhint %}

## 앱 스크립트 OAuth 피싱

문서에 연결된 앱 스크립트를 생성하여 피해자의 OAuth 토큰에 액세스하려고 할 수 있습니다. 자세한 내용은 다음을 확인하십시오:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## OAuth 앱 피싱

이전 기술 중 어느 것이든 사용자가 **Google OAuth 애플리케이션**에 액세스하도록 유도하여 사용자에게 일부 **액세스**를 요청할 수 있습니다. 사용자가 **소스**를 **신뢰**한다면 **애플리케이션**을 **신뢰**할 수 있습니다(특권이 있는 권한을 요청하더라도).

{% hint style="info" %}
Google은 여러 경우에 대해 애플리케이션이 신뢰할 수 없다는 경고를 표시하며 Workspace 관리자는 OAuth 애플리케이션 수락을 방지할 수도 있습니다.
{% endhint %}

**Google**은 여러 **Google 서비스**(Gmail, Drive, GCP 등)와 **사용자 대신 상호 작용**할 수 있는 애플리케이션을 생성할 수 있습니다.

**다른 사용자를 대신하여 작동**하는 애플리케이션을 생성할 때 개발자는 **GCP 내에서 OAuth 앱을 생성**하고 앱이 사용자 데이터에 액세스해야 하는 범위(권한)를 지정해야 합니다.\
**사용자**가 해당 **애플리케이션을 사용**하려고 할 때, 사용자는 범위에 지정된 데이터에 액세스할 수 있도록 **애플리케이션이 액세스할 것을 수락**하도록 **요청**됩니다.

이는 비기술적인 사용자를 **피싱**하여 **민감한 정보에 액세스하는 애플리케이션을 사용**하도록 유도하는 매우 유용한 방법입니다. 그러나 조직 계정에서는 이를 방지할 수 있는 방법이 있습니다.

### 확인되지 않은 앱 프롬프트

이미 언급한 대로, Google은 항상 사용자에게 애플리케이션이 그들을 대신하여 부여하는 권한을 수락할 것인지에 대한 **프롬프트를 표시**합니다. 그러나 애플리케이션이 **위험**으로 간주되는 경우, Google은 사용자가 앱에 권한을 부여하는 것을 **더 어렵게 만들기 위해** **먼저** 위험하다는 **프롬프트**를 표시합니다.

이 프롬프트는 다음과 같은 앱에서 나타납니다:

* 개인 데이터에 액세스할 수 있는 범위를 사용하는 경우(Gmail, Drive, GCP, BigQuery...)
* 100명 이하의 사용자를 가진 앱(100명 이상의 앱은 확인 프로세스도 필요하며 확인되지 않은 프롬프트를 표시하지 않도록 설정할 수 있음)

### 흥미로운 범위

[**여기**](https://developers.google.com/identity/protocols/oauth2/scopes)에서 Google OAuth 범위의 전체 목록을 찾을 수 있습니다.

* **cloud-platform**: **Google Cloud Platform** 서비스 전체에서 데이터를 보고 관리할 수 있습니다. GCP에서 사용자를 가장할 수 있습니다.
* **admin.directory.user.readonly**: 조직의 GSuite 디렉터리를 볼 수 있고 다운로드할 수 있습니다. 모든 사용자의 이름, 전화번호, 캘린더 URL을 얻을 수 있습니다.

### OAuth 앱 생성

**OAuth 클라이언트 ID를 생성**하기 시작합시다.

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)로 이동하고 동의 화면을 구성을 클릭합니다.
2. 그런 다음, **사용자 유형**이 **내부**(조직 내 사람 전용)인지 **외부**(조직 외부 사람 전용)인지 묻습니다. 필요에 맞는 것을 선택하십시오.
* 내부는 이미 조직의 사용자를 침해한 상태이고 다른 사용자를 피싱하기 위해이 앱을 생성하는 경우에 흥미로울 수 있습니다.
3. 앱에 **이름**, **지원 이메일**(자신을 익명화하기 위해 googlegroup 이메일을 설정할 수도 있음), **로고**, **인증된 도메인** 및 **업데이트**용 **다른 이메일**을 지정합니다.
4. **OAuth 범위**를 **선택**합니다.
* 이 페이지는 민감하지 않은 권한, 민감한 권한 및 제한된 권한으로 나뉩니다. 새 권한을 추가할 때마다 해당 범주에 추가됩니다. 요청된 권한에 따라 사용자에게 얼마나 민감한지를 나타내는 다른 프롬프트가 사용자에게 표시됩니다.
* **`admin.directory.user.readonly`** 및 **`cloud-platform`**은 민감한 권한입니다.
5. **테스트 사용자를 추가**합니다. 앱의 상태가 테스트인 동안에는 이러한 사용자만 앱에 액세스할 수 있으므로 **피싱할 이메일을 추가**하는지 확인하십시오.

이제 **이전에 생성한 OAuth 클라이언트 ID**를 사용하여 **웹 애플리케이션에 대한 자격 증명을 가져오는 것**을 해봅시다:

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)로 돌아가면 이번에는 다른 옵션이 나타납니다.
2. **웹 애플리케이션에 대한 자격 증명 생성**을 선택합니다.
3. 필요한 **Javascript 원본** 및 **리디렉션 URI**를 설정합니다.
* 테스트를 위해 **`http://localhost:8000/callback`**과 같은 것을 설정할 수 있습니다.
4. 애플리케이션 **자격 증명**을 가져옵니다.

마지막으로, **OAuth 애플리케이션 자격 증명을 사용하는 웹 애플리케이션을 실행**해 봅시다. [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example)에서 예제를 찾을 수 있습니다.
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
**`http://localhost:8000`**로 이동하여 Google로 로그인 버튼을 클릭하면 다음과 같은 메시지가 표시됩니다:

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

이 응용 프로그램은 쉽게 사용할 수 있는 **액세스 및 갱신 토큰**을 표시합니다. 이러한 토큰을 사용하는 방법에 대한 자세한 정보는 다음을 확인하십시오:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### `gcloud` 사용

웹 콘솔 대신 gcloud를 사용하여 작업을 수행할 수 있습니다. 다음을 확인하십시오:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## 참고 자료

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 PDF로 HackTricks를 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family)인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**을** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 자신의 해킹 기법을 공유하세요.

</details>
