# GWS - Google Platforms Phishing

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Generic Phishing Methodology

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Google Groups Phishing

デフォルトでは、Workspaceメンバーは[**グループを作成**](https://groups.google.com/all-groups)し、**人々を招待することができます**。その後、ユーザーに送信されるメールを変更し、**リンクを追加することができます**。**メールはGoogleのアドレスから送信される**ため、正当に見え、人々はリンクをクリックする可能性があります。

また、**FROM**アドレスを**Googleグループのメール**として設定し、グループ内のユーザーに**さらにメールを送信する**ことも可能です。以下の画像のように、**`google--support@googlegroups.com`**というグループが作成され、グループのメンバー全員（同意なしに追加された）に**メールが送信されました**。

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Google Chat Phishing

メールアドレスを知っているだけで、その人と**チャットを開始**するか、**トークへの招待**を送ることができるかもしれません。さらに、任意の名前（例えば「Googleサポート」）を持つ**スペースを作成**し、メンバーを招待することができます。彼らが受け入れた場合、Googleサポートと話していると思うかもしれません：

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**ただし、私のテストでは招待されたメンバーは招待を受け取っていませんでした。**
{% endhint %}

過去にこれがどのように機能していたかは、以下をチェックしてください: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Google Doc Phishing

過去には、**見た目が正当なドキュメント**を作成し、コメントで**メールアドレス（例：@user@gmail.com）をメンションする**ことが可能でした。Googleはそのメールアドレスにメールを送信し、ドキュメントでメンションされたことを通知しました。\
現在ではこれは機能しませんが、**被害者のメールにドキュメントへのアクセスを与える**と、Googleはそのようなメールを送信します。これは、誰かをメンションしたときに表示されるメッセージです：

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
被害者には、外部ドキュメントが共有されたことを示すメールがメールに届かないようにする保護メカニズムがあるかもしれません。
{% endhint %}

## Google Calendar Phishing

**カレンダーイベントを作成**し、攻撃している会社のできるだけ多くのメールアドレスを追加します。現在時刻から**5分または15分後**にこのカレンダーイベントをスケジュールします。イベントを正当に見せ、**何かを読む必要があることを示すコメントとタイトル**（**フィッシングリンク**を含む）を追加します。

これは、「Firing People」という会議タイトルでブラウザに表示されるアラートです。よりフィッシングのようなタイトルを設定し（メールに関連付けられた名前も変更することができます）。

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

怪しまれないようにするために：

* 受信者が他の招待された人を見ることができないように設定する
* イベントについてのメール通知を**送らない**。そうすると、人々は5分後の会議についての警告と、そのリンクを読む必要があることだけを見るでしょう。
* APIを使用すると、人々がイベントを**受け入れた**と**True**に設定し、さらに彼らに代わって**コメントを作成する**ことができるようです。

## App Scripts Redirect Phishing

[https://script.google.com/](https://script.google.com/)でスクリプトを作成し、**`script.google.com`**という正当なドメインを使用して、誰でもアクセスできるウェブアプリケーションとして公開することが可能です。\
以下のようなコードを使用すると、攻撃者はこのページに任意のコンテンツを読み込ませることができ、ドメインへのアクセスを停止せずに：

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

例えば、[https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec)にアクセスすると以下のように表示されます：

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
iframe内でコンテンツがロードされる際に警告が表示されることに注意してください。
{% endhint %}

## App Scripts OAuth フィッシング

ドキュメントに添付されたApp Scriptsを作成して、被害者のOAuthトークンのアクセスを試みることが可能です。詳細は以下を確認してください：

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## OAuth アプリ フィッシング

前述の技術を使用して、ユーザーに**Google OAuth アプリケーション**にアクセスさせ、ユーザーにいくつかの**アクセス**を**要求**することができます。ユーザーが**ソース**を**信頼**していれば、アプリケーション（たとえ高い権限を要求していても）を**信頼**する可能性があります。

{% hint style="info" %}
Googleは、アプリケーションが信頼されていないと警告する醜いプロンプトをいくつかのケースで表示し、Workspaceの管理者はOAuthアプリケーションを受け入れることを防ぐこともできることに注意してください。
{% endhint %}

**Google**は、開発者が**GCP**内で**OAuthアプリ**を作成し、アプリがユーザーデータにアクセスするために必要なスコープ（権限）を指定する必要がある、ユーザーに代わって**Googleサービス**（Gmail、Drive、GCPなど）と**対話**できるアプリケーションを作成することを許可しています。
ユーザーがその**アプリケーション**を**使用**したい場合、スコープで指定されたデータへのアクセスをアプリケーションに許可するよう**促されます**。

これは、非技術的なユーザーを**機密情報にアクセスするアプリケーション**の使用に誘導する非常に魅力的な方法ですが、彼らはその結果を理解していないかもしれません。ただし、組織アカウントでは、これを防ぐ方法があります。

### 未検証アプリプロンプト

言及されたように、googleは常にユーザーに代わってアプリケーションに与える権限を受け入れるよう**プロンプトを表示**します。しかし、アプリケーションが**危険**と見なされる場合、googleは最初に**危険**であることを示す**プロンプト**を表示し、ユーザーがアプリに権限を付与することをより**困難**にします。

このプロンプトは以下のアプリで表示されます：

* プライベートデータにアクセスできるスコープを使用するアプリ（Gmail、Drive、GCP、BigQueryなど）
* 100ユーザー未満のアプリ（100ユーザーを超えるアプリでは、未検証プロンプトの表示を停止するためにもレビュープロセスが必要です）

### 興味深いスコープ

[**こちら**](https://developers.google.com/identity/protocols/oauth2/scopes)で、すべてのGoogle OAuthスコープのリストを見ることができます。

* **cloud-platform**: **Google Cloud Platform**サービス全体でデータを表示および管理します。GCPでユーザーになりすますことができます。
* **admin.directory.user.readonly**: 組織のGSuiteディレクトリを表示およびダウンロードします。すべてのユーザーの名前、電話、カレンダーURLを取得します。

### OAuthアプリの作成

**OAuthクライアントIDの作成を開始します**

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)にアクセスし、同意画面の設定をクリックします。
2. 次に、**ユーザータイプ**が**内部**（組織内の人のみ）か**外部**かを尋ねられます。ニーズに合ったものを選択します
* すでに組織のユーザーを侵害しており、別のユーザーをフィッシングするためにこのアプリを作成している場合、内部が興味深いかもしれません。
3. アプリに**名前**を付け、**サポートメール**（googlegroupのメールを設定して自分を少し匿名化することができます）、**ロゴ**、**認可されたドメイン**、**更新のための別のメール**を設定します。
4. **OAuthスコープ**を**選択**します。
* このページは、非機密権限、機密権限、および制限された権限に分かれています。新しい許可を追加するたびに、それはそのカテゴリに追加されます。要求された許可に応じて、ユーザーにこれらの許可がどれほど機密であるかを示す異なるプロンプトが表示されます。
* **`admin.directory.user.readonly`** と **`cloud-platform`** は機密権限です。
5. **テストユーザーを追加します。** アプリのステータスがテスト中である限り、これらのユーザーのみがアプリにアクセスできるので、フィッシングするメールを**追加することを確認してください**。

次に、**以前に作成したOAuthクライアントIDを使用してWebアプリケーションの資格情報を取得しましょう**：

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)に戻ります。今回は異なるオプションが表示されます。
2. Webアプリケーションの資格情報を作成するために選択します
3. 必要な**Javascriptの起源**と**リダイレクトURI**を設定します
* テスト用に**`http://localhost:8000/callback`**のようなものを両方に設定できます
4. アプリケーションの**資格情報**を取得します

最後に、**OAuthアプリケーションの資格情報を使用するWebアプリケーションを実行しましょう**。例は[https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example)で見つけることができます。
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
**`http://localhost:8000`** にアクセスし、Googleでログインボタンをクリックすると、このようなメッセージが**表示されます**：

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

アプリケーションは、簡単に使用できる**アクセストークンとリフレッシュトークン**を表示します。これらのトークンの**使用方法については**、以下を確認してください：

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### `glcoud`を使用する

gcloudを使用してWebコンソールの代わりに操作を行うことが可能です。詳細は：

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - G Suiteのハッキング：ダークApps Scriptマジックの力
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, GSuiteのレッドチームはどうやって？

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
