# GWS - Phishing sulle piattaforme Google

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Metodologia generica di phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing su Google Groups

Apparentemente, per impostazione predefinita, nei membri di Workspace [**possono creare gruppi**](https://groups.google.com/all-groups) **e invitarvi persone**. √à quindi possibile modificare l'email che verr√† inviata all'utente **aggiungendo alcuni link**. L'email **proverr√† da un indirizzo Google**, quindi sembrer√† **legittima** e le persone potrebbero fare clic sul link.

√à anche possibile impostare l'indirizzo **FROM** come l'email del **gruppo Google** per inviare **altre email agli utenti all'interno del gruppo**, come nell'immagine seguente in cui √® stato creato il gruppo **`google--support@googlegroups.com`** ed √® stata inviata un'email a tutti i membri del gruppo (che sono stati aggiunti senza alcun consenso)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Phishing su Google Chat

Potresti essere in grado di **avviare una chat** con una persona avendo solo il suo indirizzo email o inviare un **invito a parlare**. Inoltre, √® possibile **creare uno Spazio** che pu√≤ avere qualsiasi nome (ad esempio "Supporto Google") e **invitare** membri ad esso. Se accettano, potrebbero pensare di stare parlando con il supporto di Google:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Nel mio test, tuttavia, i membri invitati non hanno nemmeno ricevuto un invito.**
{% endhint %}

Puoi vedere come funzionava in passato qui: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing su Google Doc

In passato era possibile creare un **documento apparentemente legittimo** e in un commento **menzionare qualche email (come @user@gmail.com)**. Google **invier√† un'email a quell'indirizzo email** notificando che sono stati menzionati nel documento.\
Oggi questo non funziona pi√π, ma se **dai all'email della vittima l'accesso al documento**, Google invier√† un'email a riguardo. Questo √® il messaggio che appare quando si menziona qualcuno:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Le vittime potrebbero avere un meccanismo di protezione che non consente alle email che indicano che un documento esterno √® stato condiviso con loro di raggiungere la loro email.
{% endhint %}

## Phishing su Google Calendar

Puoi **creare un evento del calendario** e aggiungere tanti indirizzi email dell'azienda che stai attaccando quanti ne hai. Pianifica questo evento del calendario tra **5 o 15 minuti** dall'ora corrente. Rendi l'evento legittimo e **aggiungi un commento e un titolo che indichi che devono leggere qualcosa** (con il **link di phishing**).

Questo √® l'avviso che apparir√† nel browser con un titolo di riunione "Licenziamento delle persone", quindi potresti impostare un titolo pi√π simile al phishing (e persino cambiare il nome associato alla tua email).

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Per renderlo meno sospetto:

* Imposta in modo che **i destinatari non possano vedere le altre persone invitate**
* **NON inviare email di notifica sull'evento**. In questo modo, le persone vedranno solo l'avviso di una riunione tra 5 minuti e che devono leggere quel link.
* Apparentemente, utilizzando l'API, √® possibile impostare su **True** che **le persone** hanno **accettato** l'evento e persino creare **commenti a loro nome**.

## Phishing di reindirizzamento di App Scripts

√à possibile creare uno script in [https://script.google.com/](https://script.google.com/) e **esporlo come un'applicazione web accessibile a tutti** che utilizzer√† il dominio legittimo **`script.google.com`**.  \
Quindi, con un codice come il seguente, un attaccante potrebbe far caricare alo script contenuti arbitrari in questa pagina senza smettere di accedere al dominio:

{% code overflow="wrap" %}
```javascript
function doGet() {
return HtmlService.createHtmlOutput('<meta http-equiv="refresh" content="0;url=https://cloud.hacktricks.xyz/pentesting-cloud/workspace-security/gws-google-platforms-phishing#app-scripts-redirect-phishing">')
.setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}
```
{% endcode %}

Ad esempio, accedendo a [https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec](https://script.google.com/macros/s/AKfycbwuLlzo0PUaT63G33MtE6TbGUNmTKXCK12o59RKC7WLkgBTyltaS3gYuH\_ZscKQTJDC/exec) vedrai:

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Nota che comparir√† un avviso poich√© il contenuto viene caricato all'interno di un iframe.
{% endhint %}

## Phishing di App Scripts OAuth

√à possibile creare App Scripts collegati a documenti per cercare di ottenere l'accesso al token OAuth di una vittima, per ulteriori informazioni consulta:

{% content-ref url="gws-app-scripts.md" %}
[gws-app-scripts.md](gws-app-scripts.md)
{% endcontent-ref %}

## Phishing di App OAuth

Qualsiasi delle tecniche precedenti potrebbe essere utilizzata per far s√¨ che l'utente acceda a un'applicazione **OAuth di Google** che richieder√† all'utente un **accesso**. Se l'utente **si fida** della **fonte**, potrebbe **fidarsi** dell'**applicazione** (anche se richiede autorizzazioni con privilegi elevati).

{% hint style="info" %}
Nota che Google presenta un prompt brutto che avverte che l'applicazione non √® attendibile in diversi casi e gli amministratori di Workspace possono persino impedire alle persone di accettare le applicazioni OAuth.
{% endhint %}

**Google** consente di creare applicazioni che possono **interagire per conto degli utenti** con diversi **servizi Google**: Gmail, Drive, GCP...

Quando si crea un'applicazione per **agire per conto di altri utenti**, lo sviluppatore deve creare un'app **OAuth all'interno di GCP** e indicare gli ambiti (autorizzazioni) di cui l'app ha bisogno per accedere ai dati degli utenti.\
Quando un **utente** desidera **utilizzare** quell'**applicazione**, gli verr√† **richiesto** di **accettare** che l'applicazione avr√† accesso ai loro dati specificati negli ambiti.

Questo √® un modo molto interessante per **phishing** utenti non tecnici affinch√© utilizzino **applicazioni che accedono a informazioni sensibili**, perch√© potrebbero non comprendere le conseguenze. Tuttavia, negli account delle organizzazioni, esistono modi per impedire che ci√≤ accada.

### Prompt per app non verificate

Come accennato in precedenza, Google presenter√† sempre un **prompt all'utente per accettare** le autorizzazioni che stanno concedendo all'applicazione per conto loro. Tuttavia, se l'applicazione viene considerata **pericolosa**, Google mostrer√† **prima** un **prompt** che indica che √® **pericolosa** e **rendendo pi√π difficile** per l'utente concedere le autorizzazioni all'app.

Questo prompt appare nelle app che:

* Utilizzano qualsiasi ambito che pu√≤ accedere a dati privati (Gmail, Drive, GCP, BigQuery...)
* App con meno di 100 utenti (per app > 100 √® necessario anche un processo di revisione per smettere di mostrare il prompt non verificato)

### Ambiti interessanti

[**Qui**](https://developers.google.com/identity/protocols/oauth2/scopes) puoi trovare un elenco di tutti gli ambiti OAuth di Google.

* **cloud-platform**: Visualizza e gestisci i tuoi dati su diversi servizi **Google Cloud Platform**. Puoi impersonare l'utente in GCP.
* **admin.directory.user.readonly**: Visualizza e scarica la directory GSuite della tua organizzazione. Ottieni nomi, numeri di telefono, URL del calendario di tutti gli utenti.

### Crea un'app OAuth

**Inizia creando un ID client OAuth**

1. Vai su [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) e fai clic su "configura lo schermo di consenso".
2. Successivamente, ti verr√† chiesto se il **tipo di utente** √® **interno** (solo per le persone della tua organizzazione) o **esterno**. Seleziona quello che meglio si adatta alle tue esigenze
* L'opzione interna potrebbe essere interessante se hai gi√† compromesso un utente dell'organizzazione e stai creando questa app per fare phishing a un altro utente.
3. Dai un **nome** all'app, un **indirizzo email di supporto** (nota che puoi impostare un indirizzo email di gruppo di Google per cercare di renderti un po' pi√π anonimo), un **logo**, **domini autorizzati** e un altro **indirizzo email** per **aggiornamenti**.
4. **Seleziona** gli **ambiti OAuth**.
* Questa pagina √® divisa in autorizzazioni non sensibili, autorizzazioni sensibili e autorizzazioni limitate. Ogni volta che aggiungi una nuova autorizzazione, viene aggiunta nella sua categoria. A seconda delle autorizzazioni richieste, verranno mostrati all'utente diversi prompt che indicano quanto sono sensibili queste autorizzazioni.
* Sia **`admin.directory.user.readonly`** che **`cloud-platform`** sono autorizzazioni sensibili.
5. **Aggiungi gli utenti di test.** Finch√© lo stato dell'app √® in fase di test, solo questi utenti potranno accedere all'app, quindi assicurati di **aggiungere l'email a cui farai phishing**.

Ora otteniamo **le credenziali per un'applicazione web** utilizzando l'**ID client OAuth creato in precedenza**:

1. Torna su [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), questa volta apparir√† un'opzione diversa.
2. Seleziona di **creare le credenziali per un'applicazione Web**
3. Imposta gli **origini Javascript** e gli **URI di reindirizzamento** necessari
* Puoi impostare in entrambi qualcosa come **`http://localhost:8000/callback`** per il testing
4. Ottieni le **credenziali** della tua applicazione

Infine, eseguiamo una **applicazione web che utilizzer√† le credenziali dell'app OAuth**. Puoi trovare un esempio su [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Vai a **`http://localhost:8000`**, clicca sul pulsante Accedi con Google e ti verr√† mostrato un messaggio simile a questo:

<figure><img src="../../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

L'applicazione mostrer√† l'**access token** e il **refresh token** che possono essere facilmente utilizzati. Per ulteriori informazioni su **come utilizzare questi token**, consulta:

{% content-ref url="../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Utilizzando `gcloud`

√à possibile fare qualcosa utilizzando gcloud invece della console web, controlla:

{% content-ref url="../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Riferimenti

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch e Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
