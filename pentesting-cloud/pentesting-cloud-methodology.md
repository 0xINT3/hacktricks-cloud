## Metodologia de Pentesting em Cloud

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## Metodologia B√°sica

Cada nuvem tem suas pr√≥prias peculiaridades, mas em geral h√° algumas **coisas comuns que um pentester deve verificar** ao testar um ambiente em nuvem:

* **Verifica√ß√µes de refer√™ncia**
  * Isso ajudar√° voc√™ a **entender o tamanho** do ambiente e os **servi√ßos usados**
  * Isso tamb√©m permitir√° que voc√™ encontre algumas **configura√ß√µes incorretas r√°pidas** , pois voc√™ pode realizar a maioria desses testes com **ferramentas automatizadas**
* **Enumera√ß√£o de servi√ßos**
  * Provavelmente, voc√™ n√£o encontrar√° muitas configura√ß√µes incorretas aqui se tiver realizado corretamente os testes de refer√™ncia, mas pode encontrar algumas que n√£o foram procuradas no teste de refer√™ncia.
  * Isso permitir√° que voc√™ saiba **exatamente o que est√° sendo usado** no ambiente em nuvem
  * Isso ajudar√° muito nos pr√≥ximos passos
* **Verifique os ativos expostos**
  * Isso pode ser feito durante a se√ß√£o anterior, voc√™ precisa **descobrir tudo o que est√° potencialmente exposto** √† Internet de alguma forma e como pode ser acessado.
    * Aqui estou considerando **infraestrutura exposta manualmente** como inst√¢ncias com p√°ginas da web ou outras portas expostas, e tamb√©m sobre outros **servi√ßos gerenciados em nuvem que podem ser configurados** para serem expostos (como bancos de dados ou buckets)
  * Em seguida, voc√™ deve verificar **se esse recurso pode ser exposto ou n√£o** (informa√ß√µes confidenciais? vulnerabilidades? configura√ß√µes incorretas no servi√ßo exposto?)
* **Verifique as permiss√µes**
  * Aqui voc√™ deve **descobrir todas as permiss√µes de cada fun√ß√£o / usu√°rio** dentro da nuvem e como elas s√£o usadas
    * Muitas contas **altamente privilegiadas** (controlam tudo)? Chaves geradas n√£o utilizadas? ... A maioria dessas verifica√ß√µes j√° deve ter sido feita nos testes de refer√™ncia
    * Se o cliente estiver usando OpenID ou SAML ou outra **federa√ß√£o**, voc√™ pode precisar pedir a eles mais **informa√ß√µes** sobre **como cada fun√ß√£o √© atribu√≠da** (n√£o √© o mesmo que a fun√ß√£o de administrador seja atribu√≠da a 1 usu√°rio ou a 100)
  * N√£o √© suficiente encontrar quais usu√°rios t√™m permiss√µes de **administrador** "\*:\*". Existem muitas **outras permiss√µes** que, dependendo dos servi√ßos usados, podem ser muito **sens√≠veis**.
    * Al√©m disso, existem **poss√≠veis caminhos de privesc** a seguir abusando de permiss√µes. Todas essas coisas devem ser levadas em considera√ß√£o e **o m√°ximo de caminhos de privesc poss√≠vel** deve ser relatado.
* **Verifique as integra√ß√µes**
  * √â altamente prov√°vel que **integra√ß√µes com outras nuvens ou SaaS** estejam sendo usadas dentro do ambiente em nuvem.
    * Para **integra√ß√µes da nuvem que voc√™ est√° auditando** com outra plataforma, voc√™ deve notificar **quem tem acesso a (ab)usar essa integra√ß√£o** e deve perguntar **qu√£o sens√≠vel** √© a a√ß√£o sendo realizada.\
      Por exemplo, quem pode escrever em um bucket da AWS de onde o GCP est√° obtendo dados (pergunte qu√£o sens√≠vel √© a a√ß√£o no GCP ao tratar esses dados).
    * Para **integra√ß√µes dentro da nuvem que voc√™ est√° auditando** de plataformas externas, voc√™ deve perguntar **quem tem acesso externo para (ab)usar essa integra√ß√£o** e verificar como esses dados est√£o sendo usados.\
      Por exemplo, se um servi√ßo estiver usando uma imagem Docker hospedada no GCR, voc√™ deve perguntar quem tem acesso para modific√°-la e quais informa√ß√µes e acesso sens√≠veis essa imagem obter√° quando executada dentro de uma nuvem AWS.

## Ferramentas Multi-Cloud

Existem v√°rias ferramentas que podem ser usadas para testar diferentes ambientes em nuvem. As etapas de instala√ß√£o e links ser√£o indicados nesta se√ß√£o.

### [PurplePanda](https://github.com/carlospolop/purplepanda)

Uma ferramenta para **identificar configura√ß√µes ruins e caminhos de privesc em nuvens e entre nuvens / SaaS.**

{% tabs %}
{% tab title="Instalar" %}
```bash
# Voc√™ precisa instalar e executar o neo4j tamb√©m
git clone https://github.com/carlospolop/PurplePanda
cd PurplePanda
python3 -m venv .
source bin/activate
python3 -m pip install -r requirements.txt
export PURPLEPANDA_NEO4J_URL="bolt://neo4j@localhost:7687"
export PURPLEPANDA_PWD="neo4j_pwd_4_purplepanda"
python3 main.py -h # Obter ajuda
```
{% endtab %}

{% tab title="GCP" %}
```bash
export GOOGLE_DISCOVERY=$(echo 'google:
- file_path: ""

- file_path: ""
  service_account_id: "some-sa-email@sidentifier.iam.gserviceaccount.com"' | base64)

python3 main.py -a -p google #Obter informa√ß√µes b√°sicas da conta para verificar se est√° configurada corretamente
python3 main.py -e -p google #Enumerar o ambiente
```
{% endtab %}
{% endtabs %}

### [CloudSploit](https://github.com/aquasecurity/cloudsploit)

AWS, Azure, Github
# Instalar plugin aws
steampipe plugin install aws

# Modificar a especifica√ß√£o indicando em "profile" o nome do perfil a ser usado
nano ~/.steampipe/config/aws.spc

# Obter algumas informa√ß√µes sobre como a conta AWS est√° sendo usada
git clone https://github.com/turbot/steampipe-mod-aws-insights.git
cd steampipe-mod-aws-insights
steampipe dashboard

# Obter os servi√ßos expostos √† internet
git clone https://github.com/turbot/steampipe-mod-aws-perimeter.git
cd steampipe-mod-aws-perimeter
steampipe dashboard

# Executar os benchmarks
git clone https://github.com/turbot/steampipe-mod-aws-compliance
cd steampipe-mod-aws-compliance
steampipe dashboard # Para ver os resultados no navegador
steampipe check all --export=/tmp/output4.json
```

Para verificar o c√≥digo Terraform AWS: [https://github.com/turbot/steampipe-mod-terraform-aws-compliance](https://github.com/turbot/steampipe-mod-terraform-aws-compliance)

Mais plugins AWS do Steampipe: [https://github.com/orgs/turbot/repositories?q=aws](https://github.com/orgs/turbot/repositories?q=aws)
{% endtab %}
{% endtabs %}

### [~~cs-suite~~](https://github.com/SecurityFTW/cs-suite)

AWS, GCP, Azure, DigitalOcean.\
Requer python2.7 e parece n√£o estar sendo mantido.

### Nessus

O Nessus possui uma varredura de _**Audit Cloud Infrastructure**_ que suporta: AWS, Azure, Office 365, Rackspace, Salesforce. Algumas configura√ß√µes extras no **Azure** s√£o necess√°rias para obter um **Client Id**.

### [**cloudlist**](https://github.com/projectdiscovery/cloudlist)

Cloudlist √© uma **ferramenta multi-cloud para obter Ativos** (Nomes de host, Endere√ßos IP) de Provedores de Nuvem.

{% tabs %}
{% tab title="Cloudlist" %}
```bash
cd /tmp
wget https://github.com/projectdiscovery/cloudlist/releases/latest/download/cloudlist_1.0.1_macOS_arm64.zip
unzip cloudlist_1.0.1_macOS_arm64.zip
chmod +x cloudlist
sudo mv cloudlist /usr/local/bin
```
{% endtab %}

{% tab title="Segunda aba" %}
```bash
## Para GCP, requer credenciais JSON da conta de servi√ßo
cloudlist -config </path/to/config>
```
{% endtab %}
{% endtabs %}

### [**cartography**](https://github.com/lyft/cartography)

Cartography √© uma ferramenta Python que consolida ativos de infraestrutura e os relacionamentos entre eles em uma visualiza√ß√£o de gr√°fico intuitiva alimentada por um banco de dados Neo4j.

{% tabs %}
{% tab title="Instalar" %}
```bash
# Instala√ß√£o
docker image pull ghcr.io/lyft/cartography
docker run --platform linux/amd64 ghcr.io/lyft/cartography cartography --help
## Instale um banco de dados Neo4j na vers√£o 3.5.*
```
{% endtab %}

{% tab title="GCP" %}
```bash
docker run --platform linux/amd64 \
     --volume "$HOME/.config/gcloud/application_default_credentials.json:/application_default_credentials.json" \
     -e GOOGLE_APPLICATION_CREDENTIALS="/application_default_credentials.json" \
     -e NEO4j_PASSWORD="s3cr3t" \
     ghcr.io/lyft/cartography  \
     --neo4j-uri bolt://host.docker.internal:7687 \
     --neo4j-password-env-var NEO4j_PASSWORD \
     --neo4j-user neo4j


# Ele verifica apenas alguns servi√ßos dentro do GCP (https://lyft.github.io/cartography/modules/gcp/index.html)
## Gerenciador de recursos em nuvem
## Computa√ß√£o
## DNS
## Armazenamento
## Google Kubernetes Engine
### Se voc√™ puder executar starbase ou purplepanda, obter√° mais informa√ß√µes
```
{% endtab %}
{% endtabs %}

### [**starbase**](https://github.com/JupiterOne/starbase)

Starbase coleta ativos e relacionamentos de servi√ßos e sistemas, incluindo infraestrutura em nuvem, aplicativos SaaS, controles de seguran√ßa e muito mais, em uma visualiza√ß√£o de gr√°fico intuitiva com suporte do banco de dados Neo4j.

{% tabs %}
{% tab title="Instalar" %}
```bash
# Voc√™ vai precisar da vers√£o 14 do Node, ent√£o instale o nvm seguindo https://tecadmin.net/install-nvm-macos-with-homebrew/
npm install --global yarn
nvm install 14
git clone https
### Office365

√â necess√°rio ter a fun√ß√£o de **Global Admin** ou pelo menos **Global Admin Reader** (mas note que o Global Admin Reader √© um pouco limitado). No entanto, essas limita√ß√µes aparecem em alguns m√≥dulos do PS e podem ser contornadas acessando os recursos via aplicativo da web.

## Outros Guias de Pentesting em Nuvem

* [**https://hackingthe.cloud**](https://hackingthe.cloud)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>