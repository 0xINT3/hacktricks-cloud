# Μεθοδολογία Ελέγχου Ασφάλειας Συστημάτων Στον Νέφος

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** 💬 [**στην ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) στο github.

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## Βασική Μεθοδολογία

Κάθε νέφος έχει τις δικές του ιδιαιτερότητες, αλλά γενικά υπάρχουν μερικά **κοινά πράγματα που ένας ελεγκτής ασφάλειας θα πρέπει να ελέγξει** κατά τη δοκιμή ενός νέφους:

* **Έλεγχοι αναφοράς**
* Αυτό θα σας βοηθήσει να **κατανοήσετε το μέγεθος** του περιβάλλοντος και τις **υπηρεσίες που χρησιμοποιούνται**
* Θα σας επιτρέψει επίσης να βρείτε μερικές **γρήγορες λανθασμένες ρυθμίσεις**, καθώς μπορείτε να εκτελέσετε τις περισσότερες από αυτές τις δοκιμές με **αυτοματοποιημένα εργαλεία**
* **Απαρίθμηση Υπηρεσιών**
* Πιθανότατα δεν θα βρείτε πολλές περισσότερες λανθασμένες ρυθμίσεις εδώ αν εκτελέσετε σωστά τους έλεγχους αναφοράς, αλλά μπορείτε να βρείτε κάποιες που δεν αναζητούνταν στον έλεγχο αναφοράς.
* Αυτό θα σας επιτρέψει να γνωρίζετε **τι χρησιμοποιείται ακριβώς** στο περιβάλλον του νέφους
* Αυτό θα βοηθήσει πολύ στα επόμενα βήματα
* **Έλεγχος αποκαλυμμένων πόρων**
* Αυτό μπορεί να γίνει κατά τη διάρκεια της προηγούμενης ενότητας, πρέπει να **ανακαλύψετε τα πάντα που είναι πιθανώς αποκαλυμμένα** στο Διαδίκτυο κάπως και πώς μπορεί να γίνει πρόσβαση σε αυτά.
* Εδώ αναφέρομαι σε **χειροκίνητα αποκαλυμμένες υποδομές** όπως περιπτώσεις με ιστοσελίδες ή άλλες θύρες που είναι αποκαλυμμένες, καθώς και σε άλλες **υπηρεσίες που διαχειρίζονται το νέφος που μπορούν να ρυθμιστούν** να είναι αποκαλυμμένες (όπως ΒΔ ή κάδοι)
* Στη συνέχεια, θα πρέπει να ελέγξετε **αν αυτός ο πόρος μπορεί να αποκαλυφθεί ή όχι** (εμπιστευτικές πληροφορίες; ευπάθειες; λανθασμένες ρυθμίσεις στην αποκαλυμμένη υπηρεσία;)
* **Έλεγχος Δικαιωμάτων**
* Εδώ θα πρέπει να **ανακαλύψετε όλα τα δικαιώματα κάθε ρόλου/χρήστη** μέσα στο νέφος και πώς χρησιμοποιούνται
* Πάρα πολλοί χρήστες με **υψηλά προνόμια** (έλεγχος τα πάντα); Δημιουργημένα κλειδιά που δεν χρησιμοποιούνται;... Οι περισσότεροι από αυτούς τους ελέγχους θα έπρεπε να έχουν γίνει ήδη κατά τη διάρκεια των ελέγχων αναφοράς
* Αν ο πελάτης χρησιμοποιεί OpenID ή SAML ή άλλη **συνομοσπονδία**, μπορεί να χρειαστεί να τους ζητήσετε περαιτέρω **πληροφορίες** για το **πώς γίνεται η ανάθεση κάθε ρόλου** (δεν είναι το ίδιο αν ο ρόλος του διαχειριστή ανατίθεται σε 1 χρήστη ή σε 100)
* Δεν είναι αρκετό να βρείτε ποιοι χρήστες έχουν δικαιώματα διαχειριστή με "\*:\*". Υπάρχουν πολλά **άλλα δικαιώματα** που, ανάλογα με τις χρησιμοποιούμενες υπηρεσίες, μπορεί να είναι πολύ **ευαίσθητα**.
* Επιπλέον, υπάρχουν **δυνητικοί τρόποι ανέλιξης προνομίων** που μπορούν να ακολουθηθούν κατά την κατάχρηση δικαιωμάτω
```bash
# You need to install and run neo4j also
git clone https://github.com/carlospolop/PurplePanda
cd PurplePanda
python3 -m venv .
source bin/activate
python3 -m pip install -r requirements.txt
export PURPLEPANDA_NEO4J_URL="bolt://neo4j@localhost:7687"
export PURPLEPANDA_PWD="neo4j_pwd_4_purplepanda"
python3 main.py -h # Get help
```
{% endtab %}

{% tab title="GCP" %}Μεθοδολογία Πεντεστινγκ Σύννεφου GCP

Η μεθοδολογία πεντεστινγκ στο GCP ακολουθεί τα εξής βήματα:

1. Συλλογή πληροφοριών: Αρχικά, συλλέγουμε πληροφορίες για τον στόχο μας, όπως διευθύνσεις IP, ονόματα χρηστών, δημόσια δεδομένα και πληροφορίες για τις υπηρεσίες που χρησιμοποιεί το GCP.

2. Ανάλυση ευπάθειας: Στο επόμενο βήμα, αναλύουμε τις ευπάθειες που μπορεί να υπάρχουν στο GCP, όπως αδύναμες συνθηκολογήσεις, ευπάθειες στον έλεγχο πρόσβασης και αδυναμίες στην ασφάλεια των δεδομένων.

3. Εκμετάλλευση ευπάθειας: Αφού εντοπίσουμε μια ευπάθεια, προχωρούμε στην εκμετάλλευσή της για να αποκτήσουμε πρόσβαση στο σύστημα ή τις υπηρεσίες του GCP.

4. Κατακρυφή: Στο επόμενο βήμα, προσπαθούμε να κατακρύψουμε την παρουσία μας και τις δραστηριότητές μας στο GCP, ώστε να μην ανιχνευθούμε από τους διαχειριστές του συστήματος.

5. Καταγραφή: Καταγράφουμε όλες τις ενέργειες που πραγματοποιούμε στο GCP, προκειμένου να έχουμε ένα ακριβές ιστορικό των δραστηριοτήτων μας.

6. Ανάκτηση: Το τελευταίο βήμα είναι η ανάκτηση του συστήματος στην αρχική του κατάσταση και η επαναφορά όλων των αλλαγών που πραγματοποιήθηκαν κατά τη διάρκεια του πεντεστινγκ.

Αυτή η μεθοδολογία πεντεστινγκ στο GCP μας βοηθά να εντοπίσουμε ευπάθειες και να βελτιώσουμε την ασφάλεια του συστήματος.
```bash
export GOOGLE_DISCOVERY=$(echo 'google:
- file_path: ""

- file_path: ""
service_account_id: "some-sa-email@sidentifier.iam.gserviceaccount.com"' | base64)

python3 main.py -a -p google #Get basic info of the account to check it's correctly configured
python3 main.py -e -p google #Enumerate the env
```
{% endtab %}
{% endtabs %}

### [Prowler](https://github.com/prowler-cloud/prowler)

Υποστηρίζει **AWS, GCP & Azure**. Ελέγξτε πώς να ρυθμίσετε κάθε πάροχο στο [https://docs.prowler.cloud/en/latest/#aws](https://docs.prowler.cloud/en/latest/#aws)
```bash
# Install
pip install prowler
prowler -v

# Run
prowler <provider>
# Example
prowler aws --profile custom-profile [-M csv json json-asff html]

# Get info about checks & services
prowler <provider> --list-checks
prowler <provider> --list-services
```
### [CloudSploit](https://github.com/aquasecurity/cloudsploit)

AWS, Azure, Github, Google, Oracle, Alibaba

{% tabs %}
{% tab title="Εγκατάσταση" %}
```bash
# Install
git clone https://github.com/aquasecurity/cloudsploit.git
cd cloudsploit
npm install
./index.js -h
## Docker instructions in github
```
{% endtab %}

{% tab title="GCP" %}
```bash
## You need to have creds for a service account and set them in config.js file
./index.js --cloud google --config </abs/path/to/config.js>
```
{% endtab %}
{% endtabs %}

### [ScoutSuite](https://github.com/nccgroup/ScoutSuite)

AWS, Azure, GCP, Alibaba Cloud, Oracle Cloud Infrastructure

{% tabs %}
{% tab title="Εγκατάσταση" %}
```bash
mkdir scout; cd scout
virtualenv -p python3 venv
source venv/bin/activate
pip install scoutsuite
scout --help
## Using Docker: https://github.com/nccgroup/ScoutSuite/wiki/Docker-Image
```
{% endtab %}

{% tab title="GCP" %}
```bash
scout gcp --report-dir /tmp/gcp --user-account --all-projects
## use "--service-account KEY_FILE" instead of "--user-account" to use a service account

SCOUT_FOLDER_REPORT="/tmp"
for pid in $(gcloud projects list --format="value(projectId)"); do
echo "================================================"
echo "Checking $pid"
mkdir "$SCOUT_FOLDER_REPORT/$pid"
scout gcp --report-dir "$SCOUT_FOLDER_REPORT/$pid" --no-browser --user-account --project-id "$pid"
done
```
{% endtab %}
{% endtabs %}

### [Steampipe](https://github.com/turbot)

{% tabs %}
{% tab title="Εγκατάσταση" %}
Κατεβάστε και εγκαταστήστε το Steampipe ([https://steampipe.io/downloads](https://steampipe.io/downloads)). Ή χρησιμοποιήστε το Brew:
```
brew tap turbot/tap
brew install steampipe
```
{% endtab %}

{% tab title="GCP" %}
```bash
# Install gcp plugin
steampipe plugin install gcp

# Use https://github.com/turbot/steampipe-mod-gcp-compliance.git
git clone https://github.com/turbot/steampipe-mod-gcp-compliance.git
cd steampipe-mod-gcp-compliance
# To run all the checks from the dashboard
steampipe dashboard
# To run all the checks from rhe cli
steampipe check all
```
<details>

<summary>Έλεγχος όλων των Έργων</summary>

Για να ελέγξετε όλα τα έργα, πρέπει να δημιουργήσετε το αρχείο `gcp.spc` που υποδεικνύει όλα τα έργα προς ελέγχο. Μπορείτε απλά να ακολουθήσετε τις οδηγίες από το παρακάτω σενάριο
```bash
FILEPATH="/tmp/gcp.spc"
rm -rf "$FILEPATH" 2>/dev/null

# Generate a json like object for each project
for pid in $(gcloud projects list --format="value(projectId)"); do
echo "connection \"gcp_$(echo -n $pid | tr "-" "_" )\" {
plugin  = \"gcp\"
project = \"$pid\"
}" >> "$FILEPATH"
done

# Generate the aggragator to call
echo 'connection "gcp_all" {
plugin      = "gcp"
type        = "aggregator"
connections = ["gcp_*"]
}' >> "$FILEPATH"

echo "Copy $FILEPATH in ~/.steampipe/config/gcp.spc if it was correctly generated"
```
</details>

Για να ελέγξετε **άλλες πληροφορίες GCP** (χρήσιμες για την απαρίθμηση των υπηρεσιών) χρησιμοποιήστε: [https://github.com/turbot/steampipe-mod-gcp-insights](https://github.com/turbot/steampipe-mod-gcp-insights)

Για να ελέγξετε τον κώδικα Terraform GCP: [https://github.com/turbot/steampipe-mod-terraform-gcp-compliance](https://github.com/turbot/steampipe-mod-terraform-gcp-compliance)

Περισσότερα πρόσθετα GCP του Steampipe: [https://github.com/turbot?q=gcp](https://github.com/turbot?q=gcp)
{% endtab %}

{% tab title="AWS" %}
```bash
# Install aws plugin
steampipe plugin install aws

# Modify the spec indicating in "profile" the profile name to use
nano ~/.steampipe/config/aws.spc

# Get some info on how the AWS account is being used
git clone https://github.com/turbot/steampipe-mod-aws-insights.git
cd steampipe-mod-aws-insights
steampipe dashboard

# Get the services exposed to the internet
git clone https://github.com/turbot/steampipe-mod-aws-perimeter.git
cd steampipe-mod-aws-perimeter
steampipe dashboard

# Run the benchmarks
git clone https://github.com/turbot/steampipe-mod-aws-compliance
cd steampipe-mod-aws-compliance
steampipe dashboard # To see results in browser
steampipe check all --export=/tmp/output4.json
```
Για να ελέγξετε τον κώδικα Terraform AWS: [https://github.com/turbot/steampipe-mod-terraform-aws-compliance](https://github.com/turbot/steampipe-mod-terraform-aws-compliance)

Περισσότερα πρόσθετα AWS του Steampipe: [https://github.com/orgs/turbot/repositories?q=aws](https://github.com/orgs/turbot/repositories?q=aws)
{% endtab %}
{% endtabs %}

### [~~cs-suite~~](https://github.com/SecurityFTW/cs-suite)

AWS, GCP, Azure, DigitalOcean.\
Απαιτείται python2.7 και φαίνεται να μην υποστηρίζεται πλέον.

### Nessus

Το Nessus έχει έναν έλεγχο _**Ελέγχου της Υποδομής του Νέφους**_ που υποστηρίζει: AWS, Azure, Office 365, Rackspace, Salesforce. Χρειάζονται μερικές επιπλέον ρυθμίσεις στο **Azure** για να λάβετε ένα **Αναγνωριστικό Πελάτη**.

### [**cloudlist**](https://github.com/projectdiscovery/cloudlist)

Το Cloudlist είναι ένα εργαλείο **πολλαπλών νεφών για την ανάκτηση Πόρων** (Ονομάτων Υπολογιστών, Διευθύνσεων IP) από Παρόχους Νέφους.
```bash
cd /tmp
wget https://github.com/projectdiscovery/cloudlist/releases/latest/download/cloudlist_1.0.1_macOS_arm64.zip
unzip cloudlist_1.0.1_macOS_arm64.zip
chmod +x cloudlist
sudo mv cloudlist /usr/local/bin
```
{% endtab %}

{% tab title="Δεύτερη καρτέλα" %}
```bash
## For GCP it requires service account JSON credentials
cloudlist -config </path/to/config>
```
{% endtab %}
{% endtabs %}

### [**cartography**](https://github.com/lyft/cartography)

Το Cartography είναι ένα εργαλείο Python που συγκεντρώνει τα υποδομήματα της υποδομής και τις σχέσεις μεταξύ τους σε μια ευανάγνωστη γραφική προβολή που τροφοδοτείται από μια βάση δεδομένων Neo4j.

{% tabs %}
{% tab title="Εγκατάσταση" %}
```bash
# Installation
docker image pull ghcr.io/lyft/cartography
docker run --platform linux/amd64 ghcr.io/lyft/cartography cartography --help
## Install a Neo4j DB version 3.5.*
```
{% endtab %}

{% tab title="GCP" %}
```bash
docker run --platform linux/amd64 \
--volume "$HOME/.config/gcloud/application_default_credentials.json:/application_default_credentials.json" \
-e GOOGLE_APPLICATION_CREDENTIALS="/application_default_credentials.json" \
-e NEO4j_PASSWORD="s3cr3t" \
ghcr.io/lyft/cartography  \
--neo4j-uri bolt://host.docker.internal:7687 \
--neo4j-password-env-var NEO4j_PASSWORD \
--neo4j-user neo4j


# It only checks for a few services inside GCP (https://lyft.github.io/cartography/modules/gcp/index.html)
## Cloud Resource Manager
## Compute
## DNS
## Storage
## Google Kubernetes Engine
### If you can run starbase or purplepanda you will get more info
```
{% endtab %}
{% endtabs %}

### [**starbase**](https://github.com/JupiterOne/starbase)

Το Starbase συλλέγει περιουσιακά στοιχεία και σχέσεις από υπηρεσίες και συστήματα, συμπεριλαμβανομένης της υποδομής στον νέφος, των εφαρμογών SaaS, των ελέγχων ασφαλείας και πολλών άλλων, σε μια ευανάγνωστη γραφική προβολή που υποστηρίζεται από τη βάση δεδομένων Neo4j.

{% tabs %}
{% tab title="Εγκατάσταση" %}
```bash
# You are going to need Node version 14, so install nvm following https://tecadmin.net/install-nvm-macos-with-homebrew/
npm install --global yarn
nvm install 14
git clone https://github.com/JupiterOne/starbase.git
cd starbase
nvm use 14
yarn install
yarn starbase --help
# Configure manually config.yaml depending on the env to analyze
yarn starbase setup
yarn starbase run

# Docker
git clone https://github.com/JupiterOne/starbase.git
cd starbase
cp config.yaml.example config.yaml
# Configure manually config.yaml depending on the env to analyze
docker build --no-cache -t starbase:latest .
docker-compose run starbase setup
docker-compose run starbase run
```
{% endtab %}

{% tab title="GCP" %}
```yaml
## Config for GCP
### Check out: https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md
### It requires service account credentials

integrations:
-
name: graph-google-cloud
instanceId: testInstanceId
directory: ./.integrations/graph-google-cloud
gitRemoteUrl: https://github.com/JupiterOne/graph-google-cloud.git
config:
SERVICE_ACCOUNT_KEY_FILE: '{Check https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md#service_account_key_file-string}'
PROJECT_ID: ""
FOLDER_ID: ""
ORGANIZATION_ID: ""
CONFIGURE_ORGANIZATION_PROJECTS: false

storage:
engine: neo4j
config:
username: neo4j
password: s3cr3t
uri: bolt://localhost:7687
#Consider using host.docker.internal if from docker
```
{% endtab %}
{% endtabs %}

### [**SkyArk**](https://github.com/cyberark/SkyArk)

Ανακαλύψτε τους πιο προνομιούχους χρήστες στο σαρώθηκε περιβάλλον AWS ή Azure, συμπεριλαμβανομένων των AWS Shadow Admins. Χρησιμοποιεί το powershell.
```powershell
Import-Module .\SkyArk.ps1 -force
Start-AzureStealth

# in the Cloud Console
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1')
Scan-AzureAdmins
```
### [Cloud Brute](https://github.com/0xsha/CloudBrute)

Ένα εργαλείο για την εύρεση της υποδομής, των αρχείων και των εφαρμογών μιας εταιρείας (στόχου) στους κορυφαίους παρόχους cloud (Amazon, Google, Microsoft, DigitalOcean, Alibaba, Vultr, Linode).

### [CloudFox](https://github.com/BishopFox/cloudfox)

* Το CloudFox είναι ένα εργαλείο για την εύρεση ευπαθών διαδρομών επίθεσης στην υποδομή cloud (αυτή τη στιγμή υποστηρίζονται μόνο AWS και Azure με την υποστήριξη του GCP στο μέλλον).
* Είναι ένα εργαλείο απαρίθμησης που προορίζεται να συμπληρώνει το χειροκίνητο pentesting.
* Δεν δημιουργεί ή τροποποιεί δεδομένα εντός του περιβάλλοντος cloud.

### Περισσότερες λίστες εργαλείων ασφάλειας cloud

* [https://github.com/RyanJarv/awesome-cloud-sec](https://github.com/RyanJarv/awesome-cloud-sec)

## Google

### GCP

{% content-ref url="gcp-security/" %}
[gcp-security](gcp-security/)
{% endcontent-ref %}

### Workspace

{% content-ref url="workspace-security/" %}
[workspace-security](workspace-security/)
{% endcontent-ref %}

## AWS

{% content-ref url="aws-security/" %}
[aws-security](aws-security/)
{% endcontent-ref %}

## Azure

{% content-ref url="azure-security/" %}
[azure-security](azure-security/)
{% endcontent-ref %}

### Attack Graph

[**Stormspotter** ](https://github.com/Azure/Stormspotter)δημιουργεί ένα "διάγραμμα επίθεσης" των πόρων σε μια συνδρομή Azure. Επιτρέπει σε κόκκινες ομάδες και pentesters να οπτικοποιήσουν την επιφάνεια επίθεσης και τις ευκαιρίες περιστροφής εντός ενός ενοικιαζόμενου, και ενισχύει τους υπερασπιστές σας για να προσανατολιστούν γρήγορα και να δώσουν προτεραιότητα στο έργο ανταπόκρισης σε περιστατικά.

### Office365

Χρειάζεστε **Global Admin** ή τουλάχιστον **Global Admin Reader** (αλλά σημειώστε ότι οι περιορισμοί αυτοί εμφανίζονται σε ορισμένα PS modules και μπορούν να παρακαμφθούν έχοντας πρόσβαση στα χαρακτηριστικά **μέσω της web εφαρμογής**.

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Εάν θέλετε να δείτε την εταιρεία σας να διαφημίζεται στο HackTricks ή να κατεβάσετε το HackTricks σε μορφή PDF, ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
