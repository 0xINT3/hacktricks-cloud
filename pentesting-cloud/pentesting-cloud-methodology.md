## Metodología de Pentesting en la Nube

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/CLOUD-logo-letters.svg" alt=""><figcaption></figcaption></figure>

## Metodología Básica

Cada nube tiene sus propias peculiaridades, pero en general hay algunas **cosas comunes que un pentester debería verificar** al probar un entorno en la nube:

* **Comprobaciones de referencia**
  * Esto te ayudará a **entender el tamaño** del entorno y los **servicios utilizados**
  * También te permitirá encontrar algunas **configuraciones incorrectas rápidas** ya que puedes realizar la mayoría de estas pruebas con **herramientas automatizadas**
* **Enumeración de servicios**
  * Probablemente no encontrarás muchas más configuraciones incorrectas aquí si realizaste correctamente las pruebas de referencia, pero podrías encontrar algunas que no se estaban buscando en la prueba de referencia.
  * Esto te permitirá saber **exactamente qué se está utilizando** en el entorno en la nube
  * Esto ayudará mucho en los siguientes pasos
* **Comprobar los activos expuestos**
  * Esto se puede hacer durante la sección anterior, necesitas **descubrir todo lo que está potencialmente expuesto** a Internet de alguna manera y cómo se puede acceder a él.
    * Aquí estoy tomando la **infraestructura expuesta manualmente** como instancias con páginas web u otros puertos expuestos, y también sobre otros **servicios administrados en la nube que se pueden configurar** para que sean expuestos (como bases de datos o buckets)
  * Luego debes comprobar **si ese recurso puede ser expuesto o no** (¿información confidencial? ¿vulnerabilidades? ¿configuraciones incorrectas en el servicio expuesto?)
* **Comprobar permisos**
  * Aquí debes **descubrir todos los permisos de cada rol/usuario** dentro de la nube y cómo se utilizan
    * ¿Demasiadas cuentas con **altos privilegios** (controlan todo)? ¿Claves generadas no utilizadas?... La mayoría de estas comprobaciones ya deberían haberse realizado en las pruebas de referencia
    * Si el cliente está utilizando OpenID o SAML u otra **federación**, es posible que debas pedirles más **información** sobre **cómo se asigna cada rol** (no es lo mismo que el rol de administrador se asigne a 1 usuario o a 100)
  * No es suficiente encontrar qué usuarios tienen permisos de **administrador** "\*:\*". Hay muchos **otros permisos** que dependiendo de los servicios utilizados pueden ser muy **sensibles**.
    * Además, hay **posibles formas de privesc** a seguir abusando de los permisos. Todas estas cosas deben tenerse en cuenta y se deben informar **tantas rutas de privesc como sea posible**.
* **Comprobar integraciones**
  * Es muy probable que se estén utilizando **integraciones con otras nubes o SaaS** dentro del entorno en la nube.
    * Para **integraciones de la nube que estás auditando** con otra plataforma, debes notificar **quién tiene acceso a (ab)usar esa integración** y debes preguntar **qué tan sensible** es la acción que se está realizando.\
      Por ejemplo, quién puede escribir en un bucket de AWS desde el que GCP está obteniendo datos (pregunta qué tan sensible es la acción en GCP al tratar esos datos).
    * Para **integraciones dentro de la nube que estás auditando** desde plataformas externas, debes preguntar **quién tiene acceso externo para (ab)usar esa integración** y comprobar cómo se está utilizando esa información.\
      Por ejemplo, si un servicio está utilizando una imagen de Docker alojada en GCR, debes preguntar quién tiene acceso para modificarla y qué información y acceso sensible obtendrá esa imagen cuando se ejecute dentro de una nube de AWS.

## Herramientas Multi-Nube

Existen varias herramientas que se pueden utilizar para probar diferentes entornos en la nube. Los pasos de instalación y los enlaces se indicarán en esta sección.

### [PurplePanda](https://github.com/carlospolop/purplepanda)

Una herramienta para **identificar malas configuraciones y rutas de privesc en nubes y entre nubes/SaaS.**

{% tabs %}
{% tab title="Instalar" %}
```bash
# You need to install and run neo4j also
git clone https://github.com/carlospolop/PurplePanda
cd PurplePanda
python3 -m venv .
source bin/activate
python3 -m pip install -r requirements.txt
export PURPLEPANDA_NEO4J_URL="bolt://neo4j@localhost:7687"
export PURPLEPANDA_PWD="neo4j_pwd_4_purplepanda"
python3 main.py -h # Get help
```
{% endtab %}

{% tab title="GCP" %}
## Metodología de pentesting en la nube de GCP

### 1. Recopilación de información

En esta fase, se recopila información sobre la infraestructura de la nube de GCP, como los nombres de los servidores, las direcciones IP, los nombres de dominio, los servicios en la nube utilizados, etc. Esto se puede hacer utilizando herramientas como `nmap`, `theHarvester`, `dnsenum`, `CloudMapper`, etc.

### 2. Análisis de vulnerabilidades

En esta fase, se analizan las vulnerabilidades en la infraestructura de la nube de GCP. Esto se puede hacer utilizando herramientas como `Nessus`, `OpenVAS`, `Nexpose`, etc.

### 3. Explotación

En esta fase, se explotan las vulnerabilidades encontradas en la fase anterior. Esto se puede hacer utilizando herramientas como `Metasploit`, `sqlmap`, `OWASP ZAP`, etc.

### 4. Escalada de privilegios

En esta fase, se intenta escalar los privilegios en la infraestructura de la nube de GCP. Esto se puede hacer utilizando técnicas como la inyección de comandos, la explotación de vulnerabilidades de escalada de privilegios, etc.

### 5. Mantenimiento del acceso

En esta fase, se mantiene el acceso a la infraestructura de la nube de GCP. Esto se puede hacer utilizando herramientas como `Netcat`, `Meterpreter`, `ssh`, etc.

### 6. Limpieza de huellas

En esta fase, se eliminan todas las huellas de la actividad del pentester en la infraestructura de la nube de GCP. Esto se puede hacer utilizando herramientas como `Shred`, `BleachBit`, `CCleaner`, etc.

### 7. Informe de pentesting

En esta fase, se crea un informe detallado de todo el proceso de pentesting en la infraestructura de la nube de GCP. El informe debe incluir todas las vulnerabilidades encontradas, las técnicas utilizadas para explotarlas, las recomendaciones para solucionarlas, etc.
{% endtab %}
```bash
export GOOGLE_DISCOVERY=$(echo 'google:
- file_path: ""

- file_path: ""
  service_account_id: "some-sa-email@sidentifier.iam.gserviceaccount.com"' | base64)

python3 main.py -a -p google #Get basic info of the account to check it's correctly configured
python3 main.py -e -p google #Enumerate the env
```
### [CloudSploit](https://github.com/aquasecurity/cloudsploit)

AWS, Azure, Github, Google, Oracle, Alibaba

{% tabs %}
{% tab title="Instalar" %}
```bash
# Install
git clone https://github.com/aquasecurity/cloudsploit.git
cd cloudsploit
npm install
./index.js -h
## Docker instructions in github
```
{% endtab %}

{% tab title="GCP" %}
## Metodología de pentesting en la nube de Google

### 1. Recopilación de información

En esta fase, se recopila información sobre la infraestructura de la nube de Google, como los nombres de dominio, las direcciones IP, los servicios en línea, etc. Se pueden utilizar herramientas como `nmap`, `theHarvester`, `dnsenum`, `dnsrecon`, `whois`, `nslookup`, `dig`, `host`, `traceroute`, `ping`, `netdiscover`, `netcat`, `curl`, `wget`, `nikto`, `dirb`, `gobuster`, `sqlmap`, `metasploit`, `shodan`, `censys`, `zoomeye`, `google dorks`, etc.

### 2. Análisis de vulnerabilidades

En esta fase, se analizan las vulnerabilidades de la infraestructura de la nube de Google, como las vulnerabilidades de la red, las vulnerabilidades del sistema operativo, las vulnerabilidades de las aplicaciones web, las vulnerabilidades de las bases de datos, etc. Se pueden utilizar herramientas como `nmap`, `OpenVAS`, `Nessus`, `Nikto`, `Arachni`, `Wapiti`, `sqlmap`, `Metasploit`, `Burp Suite`, `ZAP`, `sqlninja`, `sqlsus`, `BBQSQL`, `NoSQLMap`, `ExploitDB`, `CVE`, `CVSS`, `OWASP Top 10`, etc.

### 3. Explotación de vulnerabilidades

En esta fase, se explotan las vulnerabilidades de la infraestructura de la nube de Google, como la ejecución remota de código, la escalada de privilegios, la inyección de SQL, la inyección de comandos, la inclusión de archivos locales/remotos, la divulgación de información confidencial, etc. Se pueden utilizar herramientas como `Metasploit`, `sqlmap`, `Nmap`, `Netcat`, `Hydra`, `John the Ripper`, `Hashcat`, `ExploitDB`, `CVE`, `CVSS`, `OWASP Top 10`, etc.

### 4. Post-explotación

En esta fase, se realizan actividades posteriores a la explotación, como la escalada de privilegios, la persistencia, el movimiento lateral, la eliminación de huellas, la obtención de información confidencial, etc. Se pueden utilizar herramientas como `Metasploit`, `Empire`, `PowerSploit`, `Mimikatz`, `Responder`, `BloodHound`, `PowerView`, `PowerUp`, `SharpHound`, `Inveigh`, `CrackMapExec`, `Impacket`, `Pupy`, `BeEF`, `BetterCAP`, `Wireshark`, `tcpdump`, `sysinternals`, `ProcDump`, `ProcMon`, `RegShot`, `Volatility`, `DumpIt`, `Fibratus`, `GRR`, `Osquery`, `ELK Stack`, etc.

### 5. Informe de pentesting

En esta fase, se elabora un informe de pentesting que incluye los hallazgos, las recomendaciones, las pruebas realizadas, las herramientas utilizadas, las capturas de pantalla, los registros, etc. El informe debe ser claro, conciso y completo. Se pueden utilizar herramientas como `LaTeX`, `Markdown`, `Microsoft Word`, `Google Docs`, `OpenOffice`, `LibreOffice`, `GIMP`, `Inkscape`, `Krita`, `Draw.io`, `Lucidchart`, `Dia`, `Gliffy`, `PlantUML`, `Graphviz`, `Gephi`, `Maltego`, `Metasploit`, `Nessus`, `OpenVAS`, `Nmap`, `Burp Suite`, `ZAP`, `sqlmap`, `Arachni`, `Wapiti`, `Nikto`, `ExploitDB`, `CVE`, `CVSS`, `OWASP Top 10`, etc.
{% endtab %}
```bash
## You need to have creds for a service account and set them in config.js file
./index.js --cloud google --config </abs/path/to/config.js>
```
### [ScoutSuite](https://github.com/nccgroup/ScoutSuite)

AWS, Azure, GCP, Alibaba Cloud, Oracle Cloud Infrastructure

{% tabs %}
{% tab title="Instalar" %}
```bash
pip install scoutsuite
```
{% endtab %}

{% tab title="Uso" %}
```bash
scout <cloud_provider> <command> [options]
```

Ejemplo:
```bash
scout aws scan --regions us-east-1,us-west-2 --no-html
```
{% endtab %}
{% endtabs %}

ScoutSuite es una herramienta de auditoría de seguridad de la nube que permite a los usuarios evaluar la seguridad de sus entornos de nube. ScoutSuite es compatible con AWS, Azure, GCP, Alibaba Cloud y Oracle Cloud Infrastructure. La herramienta se puede instalar a través de pip y se puede utilizar para escanear y evaluar la seguridad de los recursos de la nube.
```bash
mkdir scout; cd scout
virtualenv -p python3 venv
source venv/bin/activate
pip install scoutsuite
scout --help
## Using Docker: https://github.com/nccgroup/ScoutSuite/wiki/Docker-Image
```
{% endtab %}

{% tab title="GCP" %}
## Metodología de pentesting en la nube de GCP

### 1. Recopilación de información

En esta fase, se recopila información sobre la infraestructura de la nube de GCP, como los nombres de los servidores, las direcciones IP, los nombres de dominio, los servicios en la nube utilizados, etc. Se pueden utilizar herramientas como `nmap`, `dnsenum`, `theHarvester`, `CloudMapper`, etc.

### 2. Análisis de vulnerabilidades

En esta fase, se analizan las vulnerabilidades de la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Nessus`, `OpenVAS`, `Nexpose`, `Qualys`, etc.

### 3. Explotación de vulnerabilidades

En esta fase, se explotan las vulnerabilidades encontradas en la fase anterior. Se pueden utilizar herramientas como `Metasploit`, `ExploitDB`, `BeEF`, `sqlmap`, etc.

### 4. Escalada de privilegios

En esta fase, se intenta escalar los privilegios en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `LinEnum`, `PowerUp`, `Windows-Exploit-Suggester`, etc.

### 5. Movimiento lateral

En esta fase, se intenta mover lateralmente a través de la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `BloodHound`, `Responder`, `Empire`, etc.

### 6. Mantenimiento del acceso

En esta fase, se intenta mantener el acceso a la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Netcat`, `Meterpreter`, `PowerShell`, etc.

### 7. Limpieza de huellas

En esta fase, se eliminan las huellas dejadas en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Shred`, `BleachBit`, `CCleaner`, etc.

### 8. Informe de pentesting

En esta fase, se crea un informe detallado de todo el proceso de pentesting en la nube de GCP. El informe debe incluir todas las vulnerabilidades encontradas, las herramientas utilizadas, las técnicas utilizadas, las recomendaciones para solucionar las vulnerabilidades, etc.
{% endtab %}
```bash
scout gcp --report-dir /tmp/gcp --user-account --all-projects
## use "--service-account KEY_FILE" instead of "--user-account" to use a service account

SCOUT_FOLDER_REPORT="/tmp"
for pid in $(gcloud projects list --format="value(projectId)"); do
    echo "================================================"
    echo "Checking $pid"
    mkdir "$SCOUT_FOLDER_REPORT/$pid"
    scout gcp --report-dir "$SCOUT_FOLDER_REPORT/$pid" --no-browser --user-account --project-id "$pid"
done
```
{% endtab %}
{% endtabs %}

### [Steampipe](https://github.com/turbot)

{% tabs %}
{% tab title="Instalar" %}
Descargue e instale Steampipe ([https://steampipe.io/downloads](https://steampipe.io/downloads)). O use Brew:
```
brew tap turbot/tap
brew install steampipe
```
{% endtab %}

{% tab title="GCP" %}
## Metodología de pentesting en la nube de GCP

### 1. Recopilación de información

En esta fase, se recopila información sobre la infraestructura de la nube de GCP, como los nombres de los servidores, las direcciones IP, los nombres de dominio, los servicios en la nube utilizados, etc. Se pueden utilizar herramientas como `nmap`, `dnsenum`, `theHarvester`, `CloudMapper`, etc.

### 2. Análisis de vulnerabilidades

En esta fase, se analizan las vulnerabilidades de la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Nessus`, `OpenVAS`, `Nexpose`, `Qualys`, etc.

### 3. Explotación de vulnerabilidades

En esta fase, se explotan las vulnerabilidades encontradas en la fase anterior. Se pueden utilizar herramientas como `Metasploit`, `ExploitDB`, `BeEF`, `sqlmap`, etc.

### 4. Escalada de privilegios

En esta fase, se intenta escalar los privilegios en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `LinEnum`, `PowerUp`, `Windows-Exploit-Suggester`, etc.

### 5. Movimiento lateral

En esta fase, se intenta mover lateralmente en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `BloodHound`, `Responder`, `Empire`, etc.

### 6. Mantenimiento del acceso

En esta fase, se intenta mantener el acceso a la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Netcat`, `Meterpreter`, `PowerShell`, etc.

### 7. Limpieza de huellas

En esta fase, se eliminan las huellas de la actividad del pentester en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Shred`, `BleachBit`, `CCleaner`, etc.
{% endtab %}
```bash
# Install gcp plugin
steampipe plugin install gcp

# Use https://github.com/turbot/steampipe-mod-gcp-compliance.git
git clone https://github.com/turbot/steampipe-mod-gcp-compliance.git
cd steampipe-mod-gcp-compliance
# To run all the checks from the dashboard
steampipe dashboard
# To run all the checks from rhe cli
steampipe check all
```
<details>

<summary>Revisar todos los proyectos</summary>

Para revisar todos los proyectos, es necesario generar el archivo `gcp.spc` indicando todos los proyectos a probar. Puedes seguir las indicaciones del siguiente script.
```bash
FILEPATH="/tmp/gcp.spc"
rm -rf "$FILEPATH" 2>/dev/null

# Generate a json like object for each project
for pid in $(gcloud projects list --format="value(projectId)"); do
echo "connection \"gcp_$(echo -n $pid | tr "-" "_" )\" {
    plugin  = \"gcp\"
    project = \"$pid\"
}" >> "$FILEPATH"
done

# Generate the aggragator to call
echo 'connection "gcp_all" {
  plugin      = "gcp" 
  type        = "aggregator"
  connections = ["gcp_*"]
}' >> "$FILEPATH"

echo "Copy $FILEPATH in ~/.steampipe/config/gcp.spc if it was correctly generated"
```
</details>

Para verificar **otras perspectivas de AWS** (útiles para enumerar servicios) use: [https://github.com/turbot/steampipe-mod-aws-insights](https://github.com/turbot/steampipe-mod-aws-insights)

Para verificar el código Terraform de AWS: [https://github.com/turbot/steampipe-mod-terraform-aws-compliance](https://github.com/turbot/steampipe-mod-terraform-aws-compliance)

Más plugins de AWS de Steampipe: [https://github.com/turbot?q=aws](https://github.com/turbot?q=aws)
{% endtab %}

{% tab title="Azure" %}
```bash
# Install aws plugin
steampipe plugin install aws

# Modify the spec indicating in "profile" the profile name to use
nano ~/.steampipe/config/aws.spc

# Get some info on how the AWS account is being used
git clone https://github.com/turbot/steampipe-mod-aws-insights.git
cd steampipe-mod-aws-insights
steampipe dashboard

# Get the services exposed to the internet
git clone https://github.com/turbot/steampipe-mod-aws-perimeter.git
cd steampipe-mod-aws-perimeter
steampipe dashboard

# Run the benchmarks
git clone https://github.com/turbot/steampipe-mod-aws-compliance
cd steampipe-mod-aws-compliance
steampipe dashboard # To see results in browser
steampipe check all --export=/tmp/output4.json
```
Para verificar el código de Terraform AWS: [https://github.com/turbot/steampipe-mod-terraform-aws-compliance](https://github.com/turbot/steampipe-mod-terraform-aws-compliance)

Más plugins de AWS de Steampipe: [https://github.com/orgs/turbot/repositories?q=aws](https://github.com/orgs/turbot/repositories?q=aws)
{% endtab %}
{% endtabs %}

### [~~cs-suite~~](https://github.com/SecurityFTW/cs-suite)

AWS, GCP, Azure, DigitalOcean.\
Requiere python2.7 y parece no estar mantenido.

### Nessus

Nessus tiene un escaneo de _**Infraestructura en la nube**_ que admite: AWS, Azure, Office 365, Rackspace, Salesforce. Se necesitan algunas configuraciones adicionales en **Azure** para obtener un **Id. de cliente**.

### [**cloudlist**](https://github.com/projectdiscovery/cloudlist)

Cloudlist es una **herramienta multi-nube para obtener activos** (nombres de host, direcciones IP) de proveedores de nube.
```bash
cd /tmp
wget https://github.com/projectdiscovery/cloudlist/releases/latest/download/cloudlist_1.0.1_macOS_arm64.zip
unzip cloudlist_1.0.1_macOS_arm64.zip
chmod +x cloudlist
sudo mv cloudlist /usr/local/bin
```
{% endtab %}

{% tab title="Metodología de Pentesting en la Nube" %}
# Metodología de Pentesting en la Nube

## Introducción

La metodología de pentesting en la nube se enfoca en evaluar la seguridad de los servicios en la nube y las aplicaciones que se ejecutan en ellas. La metodología se basa en las mejores prácticas de pentesting y se adapta a los desafíos únicos que presenta la nube.

## Fase de Recopilación de Información

En esta fase, se recopila información sobre el objetivo de la prueba de penetración. Esto incluye información sobre la infraestructura de la nube, los servicios en la nube y las aplicaciones que se ejecutan en ellas. La información se puede recopilar utilizando técnicas de OSINT, como la búsqueda en motores de búsqueda y la exploración de redes sociales.

## Fase de Análisis de Vulnerabilidades

En esta fase, se analizan las vulnerabilidades en la infraestructura de la nube, los servicios en la nube y las aplicaciones que se ejecutan en ellas. Esto se puede hacer utilizando herramientas de escaneo de vulnerabilidades y pruebas manuales.

## Fase de Explotación

En esta fase, se intenta explotar las vulnerabilidades identificadas en la fase anterior. Esto se puede hacer utilizando herramientas de explotación automatizadas y pruebas manuales.

## Fase de Post-Explotación

En esta fase, se intenta mantener el acceso a la infraestructura de la nube y las aplicaciones que se ejecutan en ellas. Esto se puede hacer utilizando técnicas de persistencia y escalada de privilegios.

## Fase de Informe

En esta fase, se documentan los hallazgos de la prueba de penetración y se presentan al cliente. El informe debe incluir una descripción detallada de las vulnerabilidades identificadas, su impacto potencial y recomendaciones para remediarlas.

## Conclusión

La metodología de pentesting en la nube es esencial para garantizar la seguridad de los servicios en la nube y las aplicaciones que se ejecutan en ellas. Al seguir esta metodología, los profesionales de seguridad pueden identificar y remediar las vulnerabilidades antes de que sean explotadas por los atacantes.
```bash
## For GCP it requires service account JSON credentials
cloudlist -config </path/to/config>
```
### [**cartografía**](https://github.com/lyft/cartography)

Cartografía es una herramienta de Python que consolida los activos de infraestructura y las relaciones entre ellos en una vista de gráfico intuitiva impulsada por una base de datos de Neo4j.

{% tabs %}
{% tab title="Instalar" %}
```bash
# Installation
docker image pull ghcr.io/lyft/cartography
docker run --platform linux/amd64 ghcr.io/lyft/cartography cartography --help
## Install a Neo4j DB version 3.5.*
```
{% endtab %}

{% tab title="GCP" %}
## Metodología de pentesting en la nube de Google

### 1. Recopilación de información

En esta fase, se recopila información sobre la infraestructura de la nube de Google, como los nombres de dominio, las direcciones IP, los servicios en línea, etc. Se pueden utilizar herramientas como `nmap`, `theHarvester`, `dnsenum`, `dnsrecon`, `whois`, `nslookup`, `dig`, `host`, `traceroute`, `netdiscover`, `netcat`, `nikto`, `wpscan`, `sqlmap`, `metasploit`, `shodan`, `censys`, `Google dorks`, etc.

### 2. Análisis de vulnerabilidades

En esta fase, se analizan las vulnerabilidades de la infraestructura de la nube de Google. Se pueden utilizar herramientas como `OpenVAS`, `Nessus`, `Nexpose`, `Qualys`, `Retina`, `Burp Suite`, `ZAP`, `sqlmap`, `metasploit`, etc.

### 3. Explotación de vulnerabilidades

En esta fase, se explotan las vulnerabilidades encontradas en la fase anterior. Se pueden utilizar herramientas como `Metasploit`, `sqlmap`, `Nmap`, `Netcat`, `Hydra`, `John the Ripper`, `Aircrack-ng`, `BeEF`, `Social Engineering Toolkit (SET)`, etc.

### 4. Escalada de privilegios

En esta fase, se intenta obtener privilegios más altos en la infraestructura de la nube de Google. Se pueden utilizar herramientas como `Metasploit`, `Nmap`, `Netcat`, `Hydra`, `John the Ripper`, `Aircrack-ng`, `BeEF`, `Social Engineering Toolkit (SET)`, etc.

### 5. Movimiento lateral

En esta fase, se intenta moverse lateralmente en la infraestructura de la nube de Google. Se pueden utilizar herramientas como `Metasploit`, `Nmap`, `Netcat`, `Hydra`, `John the Ripper`, `Aircrack-ng`, `BeEF`, `Social Engineering Toolkit (SET)`, etc.

### 6. Mantenimiento del acceso

En esta fase, se intenta mantener el acceso a la infraestructura de la nube de Google. Se pueden utilizar herramientas como `Netcat`, `Nmap`, `Metasploit`, `ssh`, `ncat`, `socat`, `screen`, `tmux`, `VNC`, `RDP`, `TeamViewer`, `AnyDesk`, `LogMeIn`, etc.

### 7. Cobertura de huellas

En esta fase, se cubren las huellas del ataque en la infraestructura de la nube de Google. Se pueden utilizar herramientas como `Metasploit`, `Nmap`, `Netcat`, `Hydra`, `John the Ripper`, `Aircrack-ng`, `BeEF`, `Social Engineering Toolkit (SET)`, etc.

### 8. Informe de pentesting

En esta fase, se elabora un informe de pentesting que incluye los resultados de las fases anteriores, las recomendaciones de seguridad y las pruebas realizadas. El informe debe ser claro, conciso y completo.
```bash
docker run --platform linux/amd64 \
     --volume "$HOME/.config/gcloud/application_default_credentials.json:/application_default_credentials.json" \
     -e GOOGLE_APPLICATION_CREDENTIALS="/application_default_credentials.json" \
     -e NEO4j_PASSWORD="s3cr3t" \
     ghcr.io/lyft/cartography  \
     --neo4j-uri bolt://host.docker.internal:7687 \
     --neo4j-password-env-var NEO4j_PASSWORD \
     --neo4j-user neo4j


# It only checks for a few services inside GCP (https://lyft.github.io/cartography/modules/gcp/index.html)
## Cloud Resource Manager
## Compute
## DNS
## Storage
## Google Kubernetes Engine
### If you can run starbase or purplepanda you will get more info
```
### Instalación

Para instalar Starbase, primero debemos clonar el repositorio de GitHub:

```bash
git clone https://github.com/JupiterOne/starbase.git
```

Luego, debemos instalar las dependencias de Python:

```bash
pip install -r requirements.txt
```

Finalmente, podemos ejecutar Starbase:

```bash
python starbase.py
```
```bash
# You are going to need Node version 14, so install nvm following https://tecadmin.net/install-nvm-macos-with-homebrew/
npm install --global yarn
nvm install 14
git clone https://github.com/JupiterOne/starbase.git
cd starbase
nvm use 14
yarn install
yarn starbase --help
# Configure manually config.yaml depending on the env to analyze
yarn starbase setup
yarn starbase run

# Docker
git clone https://github.com/JupiterOne/starbase.git
cd starbase
cp config.yaml.example config.yaml
# Configure manually config.yaml depending on the env to analyze
docker build --no-cache -t starbase:latest .
docker-compose run starbase setup
docker-compose run starbase run
```
{% endtab %}

{% tab title="GCP" %}
## Metodología de pentesting en la nube de GCP

### 1. Recopilación de información

En esta fase, se recopila información sobre la infraestructura de la nube de GCP, como los nombres de los servidores, las direcciones IP, los nombres de dominio, los servicios en la nube utilizados, etc. Se pueden utilizar herramientas como `nmap`, `dnsenum`, `theHarvester`, `CloudMapper`, etc.

### 2. Análisis de vulnerabilidades

En esta fase, se analizan las vulnerabilidades de la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Nessus`, `OpenVAS`, `Nexpose`, `Qualys`, etc.

### 3. Explotación de vulnerabilidades

En esta fase, se explotan las vulnerabilidades encontradas en la fase anterior. Se pueden utilizar herramientas como `Metasploit`, `ExploitDB`, `BeEF`, `sqlmap`, etc.

### 4. Escalada de privilegios

En esta fase, se intenta escalar los privilegios en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `LinEnum`, `PowerUp`, `Windows-Exploit-Suggester`, etc.

### 5. Movimiento lateral

En esta fase, se intenta mover lateralmente en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `BloodHound`, `Responder`, `Empire`, etc.

### 6. Mantenimiento del acceso

En esta fase, se intenta mantener el acceso a la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Netcat`, `Meterpreter`, `PowerShell`, etc.

### 7. Limpieza de huellas

En esta fase, se eliminan las huellas de la actividad del pentester en la infraestructura de la nube de GCP. Se pueden utilizar herramientas como `Shred`, `BleachBit`, `CCleaner`, etc.
{% endtab %}
```yaml
## Config for GCP
### Check out: https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md
### It requires service account credentials
 
integrations:
  -
    name: graph-google-cloud
    instanceId: testInstanceId
    directory: ./.integrations/graph-google-cloud
    gitRemoteUrl: https://github.com/JupiterOne/graph-google-cloud.git
    config:
      SERVICE_ACCOUNT_KEY_FILE: '{Check https://github.com/JupiterOne/graph-google-cloud/blob/main/docs/development.md#service_account_key_file-string}'
      PROJECT_ID: ""
      FOLDER_ID: ""
      ORGANIZATION_ID: ""
      CONFIGURE_ORGANIZATION_PROJECTS: false

storage:
  engine: neo4j
  config: 
    username: neo4j
    password: s3cr3t
    uri: bolt://localhost:7687
    #Consider using host.docker.internal if from docker
```
### [**SkyArk**](https://github.com/cyberark/SkyArk)

Descubre los usuarios más privilegiados en el entorno de AWS o Azure escaneado, incluyendo los administradores sombra de AWS. Utiliza powershell.
```powershell
Import-Module .\SkyArk.ps1 -force
Start-AzureStealth

# in the Cloud Console
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/cyberark/SkyArk/master/AzureStealth/AzureStealth.ps1')  
Scan-AzureAdmins  
```
### [Cloud Brute](https://github.com/0xsha/CloudBrute)

Una herramienta para encontrar la infraestructura, archivos y aplicaciones de una empresa (objetivo) en los principales proveedores de nube (Amazon, Google, Microsoft, DigitalOcean, Alibaba, Vultr, Linode).

### [CloudFox](https://github.com/BishopFox/cloudfox)

* CloudFox es una herramienta para encontrar rutas de ataque explotables en la infraestructura de la nube (actualmente solo se admiten AWS y Azure con GCP próximamente).
* Es una herramienta de enumeración que pretende complementar la pentesting manual.
* No crea ni modifica ningún dato dentro del entorno de la nube.

### Más listas de herramientas de seguridad en la nube

* [https://github.com/RyanJarv/awesome-cloud-sec](https://github.com/RyanJarv/awesome-cloud-sec)

## Google

### GCP

{% content-ref url="gcp-security/" %}
[gcp-security](gcp-security/)
{% endcontent-ref %}

### Workspace

{% content-ref url="workspace-security.md" %}
[workspace-security.md](workspace-security.md)
{% endcontent-ref %}

## AWS

{% content-ref url="aws-security/" %}
[aws-security](aws-security/)
{% endcontent-ref %}

## Azure

Acceda al portal aquí: [http://portal.azure.com/](http://portal.azure.com)\
Para comenzar las pruebas, debe tener acceso con un usuario con **permisos de lector sobre la suscripción** y **rol de lector global en AzureAD**. Si incluso en ese caso **no puede acceder al contenido de las cuentas de almacenamiento**, puede solucionarlo con el **rol de contribuyente de la cuenta de almacenamiento**.

Se recomienda **instalar azure-cli** en una máquina virtual **linux** y **windows** (para poder ejecutar scripts de powershell y python): [https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest)\
Luego, ejecute `az login` para iniciar sesión. Tenga en cuenta que la **información de la cuenta** y el **token** se **guardarán** en _\<HOME>/.azure_ (tanto en Windows como en Linux).

Recuerde que si se está utilizando el **nivel de precios de Security Centre Standard** y **no** el nivel **gratuito**, puede **generar** un **informe de escaneo de cumplimiento CIS** desde el portal de Azure. Vaya a _Política y cumplimiento -> Cumplimiento normativo_ (o intente acceder a [https://portal.azure.com/#blade/Microsoft\_Azure\_Security/SecurityMenuBlade/22](https://portal.azure.com/#blade/Microsoft\_Azure\_Security/SecurityMenuBlade/22)).\
\_\_Si la empresa no está pagando por una cuenta estándar, es posible que deba revisar el **CIS Microsoft Azure Foundations Benchmark** "a mano" (puede obtener ayuda utilizando las siguientes herramientas). Descárguelo desde [**aquí**](https://www.newnettechnologies.com/cis-benchmark.html?keyword=\&gclid=Cj0KCQjwyPbzBRDsARIsAFh15JYSireQtX57C6XF8cfZU3JVjswtaLFJndC3Hv45YraKpLVDgLqEY6IaAhsZEALw\_wcB#microsoft-azure).

### Ejecutar escáneres

Ejecute los escáneres para buscar **vulnerabilidades** y **comparar** las medidas de seguridad implementadas con **CIS**.
```bash
pip install scout
scout azure --cli --report-dir <output_dir>

#Fix azureaudit.py before launching cs.py
#Adding "j_res = {}" on line 1074
python cs.py -env azure

#Azucar is an Azure security scanner for PowerShell (https://github.com/nccgroup/azucar)
#Run it from its folder
.\Azucar.ps1 -AuthMode Interactive -ForceAuth -ExportTo EXCEL

#Azure-CIS-Scanner,CIS scanner for Azure (https://github.com/kbroughton/azure_cis_scanner)
pip3 install azure-cis-scanner #Install
azscan #Run, login before with `az login`
```
### Grafo de Ataque

[**Stormspotter**](https://github.com/Azure/Stormspotter) crea un "grafo de ataque" de los recursos en una suscripción de Azure. Permite a los equipos rojos y a los pentesters visualizar la superficie de ataque y las oportunidades de pivote dentro de un inquilino, y potencia a sus defensores para orientar y priorizar rápidamente el trabajo de respuesta a incidentes.

### Más comprobaciones

* Comprobar un **alto número de administradores globales** (se recomiendan entre 2 y 4). Acceda a: [https://portal.azure.com/#blade/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/Overview](https://portal.azure.com/#blade/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/Overview)
* Los administradores globales deben tener MFA activado. Vaya a Usuarios y haga clic en el botón de Autenticación Multifactor.
* La cuenta de administrador dedicada no debe tener buzones de correo (sólo pueden tener buzones de correo si tienen Office 365).
* El AD local no debe sincronizarse con Azure AD si no es necesario ([https://portal.azure.com/#blade/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/AzureADConnect](https://portal.azure.com/#blade/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/AzureADConnect)). Y si se sincroniza, se debe habilitar Password Hash Sync para la fiabilidad. En este caso está deshabilitado:
* Los **Administradores Globales** no deben sincronizarse desde un AD local. Compruebe si los correos electrónicos de los Administradores Globales utilizan el dominio **onmicrosoft.com**. Si no es así, compruebe la fuente del usuario, la fuente debe ser Azure Active Directory, si proviene de Windows Server AD, entonces informe de ello.
* Se recomienda el **nivel estándar** en lugar del nivel gratuito (ver el nivel que se está utilizando en _Precios y Configuración_ o en [https://portal.azure.com/#blade/Microsoft\_Azure\_Security/SecurityMenuBlade/24](https://portal.azure.com/#blade/Microsoft\_Azure\_Security/SecurityMenuBlade/24))
*   **Escaneos periódicos de servidores SQL**:

    _Seleccione el servidor SQL_ --> _Asegúrese de que 'Seguridad avanzada de datos' está configurada en 'Activado'_ --> _En 'Configuración de evaluación de vulnerabilidades', configure 'Escaneos periódicos recurrentes' en 'Activado', y configure una cuenta de almacenamiento para almacenar los resultados del escaneo de evaluación de vulnerabilidades_ --> _Haga clic en Guardar_
* **Falta de restricciones de servicios de aplicaciones**: Busque "Servicios de aplicaciones" en Azure ([https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Web%2Fsites](https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Web%2Fsites)) y compruebe si alguien los está utilizando. En ese caso, compruebe cada aplicación buscando "Restricciones de acceso" y si no hay reglas, informe de ello. El acceso al servicio de aplicaciones debe estar restringido según las necesidades.

### Office365

Necesita un **Administrador Global** o al menos un **Lector de Administrador Global** (pero tenga en cuenta que las limitaciones aparecen en algunos módulos de PS y se pueden pasar por alto accediendo a las funciones **a través de la aplicación web**).

## Otras Guías de Pentesting en la Nube

* [**https://hackingthe.cloud**](https://hackingthe.cloud)

<details>

<summary><strong>¡Apoye a HackTricks y obtenga beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulte los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únase al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígame** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparta sus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
