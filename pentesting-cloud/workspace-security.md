# ワークスペースのペントテスト

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricks** の最新バージョンにアクセスしたい場合や **PEASS をダウンロードしたい場合**、または **会社を HackTricks で宣伝したい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**Telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローする。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## ワークスペースのフィッシング

### 一般的なフィッシングの方法論

### Google グループのフィッシング

ワークスペースのメンバーはおそらくデフォルトで[**グループを作成**](https://groups.google.com/all-groups)し、**人々を招待**することができます。その後、ユーザーに送信されるメールを修正して、いくつかのリンクを追加することができます。**メールは Google のアドレスから送信**されるため、**信頼性があり**、人々はリンクをクリックするかもしれません。

### ハングアウトのフィッシング

相手のメールアドレスを持っているだけで直接話すことができるか、話すための招待状を送ることができるかもしれません。いずれの場合でも、メールアカウントを「Google Security」と名付け、Google のロゴを追加することができます。人々はそれが Google との会話であると思うかもしれません：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

**同じ技術**は **Google Chat** でも使用できます。

### Google ドキュメントのフィッシング

**見かけ上正当なドキュメント**を作成し、コメントで**いくつかのメールアドレス（+user@gmail.com のような）**を言及します。Google はそのメールアドレスにメールを送信し、ドキュメントで言及されたことを通知します。そのドキュメントにリンクを**配置**して、そのリンクにアクセスさせようとすることができます。

### Google カレンダーのフィッシング

**カレンダーイベントを作成**し、攻撃対象の会社のメールアドレスを持っているだけ追加します。現在の時刻から**5分または15分**後にこのカレンダーイベントをスケジュールします。イベントを正当に見せ、**何かを読む必要がある**というコメントを追加します（**フィッシングリンク**を含む）。\
より怪しまれないようにするためには：

* **受信者が招待された他の人を見ることができないように**設定します。
* イベントに関するメールを**送信しないでください**。その後、人々は5分後に会議の警告とそのリンクを読む必要があるという警告しか見ません。
* API を使用すると、イベントを**受け入れた**という設定を**True**にすることができ、さらに**コメントを代理で作成**することもできます。

### OAuth フィッシング

前述のいずれの技術でも、ユーザーがアクセスするようになる**Google OAuth アプリケーション**にアクセスさせることができます。このアプリケーションは、ユーザーにいくつかのアクセスを要求します。ユーザーが**ソース**を**信頼**している場合、**アプリケーション**を**信頼**するかもしれません（特権のあるアクセスを要求していても）。

Google はいくつかの場合において、アプリケーションが信頼されていないことを警告する見栄えの悪いプロンプトを表示します。また、ワークスペースの管理者は OAuth アプリケーションの受け入れを防ぐこともできます。OAuth のセクションで詳しく説明します。

## パスワードスプレー

見つけたすべてのメールアドレスでパスワードをテストするために、[**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing) のようなツールを使用することができます。このツールは AWS Lambda を使用して IP アドレスを変更します。

## OAuth アプリ

**Google** では、**Google サービス**（Gmail、Drive、GCP など）との相互作用が可能なアプリケーションを作成できます。

他のユーザーの代わりに**動作するアプリケーション**を作成する場合、開発者は**GCP 内の OAuth アプリ**を作成し、アプリがユーザーデータにアクセスするために必要なスコープ（権限）を指定する必要があります。\
**ユーザー**が**そのアプリケーション**を**使用**したい場合、スコープで指定されたデータにアクセスするアプリケーションを**許可**するように**求められます**。

これは、非技術的なユーザーを**フィッシング**して、**機密情報にアクセスするアプリケーション**を使用させる非常に魅力的な方法です。ただし、組織のアカウントでは、これを防ぐ方法があります。

### 未確認のアプリのプロンプト

前述のように、Google はユーザーに対して、アプリケーションがユーザーの代わりに持つ権限を受け入れるかどうかのプロンプトを常に表示します。ただし、アプリケーションが**危険**と見なされる場合、Google は**最初に**アプリが**危険**であることを示す**プロンプト**を表示し、ユーザーがアプリに権限を与えることをより困難にします。

このプロンプトは、次のようなアプリで表示されます。

* プライベートデータにアクセスできるスコープを使用するアプリ（Gmail、Drive、GCP、BigQuery...）
* ユーザーが 100 人未満のアプリ（100 人以上のアプリでは、未確認のプロンプトを表示しないためにレビュープロセスも必要）

### 興味深いスコープ

[**ここ**](https://developers.google.com/identity/protocols/oauth2/scopes) で、すべての Google OAuth スコープのリストを見つけることができます。

* **cloud-platform**: **Google Cloud Platform** サービス全体でデータを表示および管理します。GCP でユーザーの代わりになることができます。
* **directory.readonly**: 組織の GSuite ディレクトリを表示およびダウンロードします。すべてのユーザーの名前、電話番号、カレンダーの URL を取得します。

## アプリスクリプト

開発者は App Scripts を作成し、それを単独のプロジェクトとして設定するか、Google ドキュメント/シート/スライド
### コピーされていないドキュメントのプロンプトバイパス

ドキュメントを共有するためのリンクを作成すると、次のようなリンクが作成されます：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
代わりに、アクセスする代わりに、**"/edit"**の代わりに**"/copy"**を末尾に変更すると、Googleはドキュメントのコピーを生成するかどうかを尋ねます。

{% hint style="warning" %}
もし、**App Scriptを含むドキュメント**の**コピー**を作成した場合、**App Scriptもコピーされます**。そのため、コピーされたスプレッドシートを開くと、**通常のOAuthプロンプト**が表示され、**未検証のプロンプトがバイパスされます**。なぜなら、**ユーザーはコピーされたファイルのApp Scriptの作者になるからです**。
{% endhint %}

この方法は、Workspaceの管理者制限もバイパスできます。

ただし、次の方法で防止することができます：

### 共有されたドキュメントの未検証のプロンプトバイパス

さらに、**編集アクセス**を持つドキュメントが他のユーザーから**共有**されている場合、そのドキュメント内で**App Scriptを生成**することができ、ドキュメントの**作成者がApp Scriptの所有者**になります。

{% hint style="warning" %}
これは、**ドキュメントの作成者が、それにアクセス権を持つユーザーが作成したApp Scriptの作成者として表示される**ことを意味します。

これはまた、App Scriptがドキュメントの作成者のWorkspace環境によって信頼されることを意味します。
{% endhint %}

{% hint style="danger" %}
これはまた、**App Scriptが既に存在**し、人々が**アクセスを許可**している場合、ドキュメントの**Editor**権限を持つ任意のユーザーがそれを**変更してアクセスを悪用**することを意味します。\
これを悪用するには、人々がApp Scriptをトリガーする必要があります。また、**スクリプトをウェブアプリとして公開**するという便利なトリックもあります。App Scriptへのアクセスを許可した**人々**がウェブページにアクセスすると、彼らはApp Scriptを**トリガー**します（これは`<img>`タグを使用しても機能します）。
{% endhint %}

## ポストエクスプロイテーション

### Google Groupsの特権昇格

デフォルトでは、Workspaceの**グループ**は組織の任意のメンバーによって**自由にアクセス**できます。\
Workspaceでは、グループに権限（GCPの権限も含む）を付与することもできるため、グループに参加でき、追加の権限を持つ場合、攻撃者は特権昇格のためにこのパスを**悪用**することができます。

組織内の誰でも参加できるグループに参加するためには、コンソールへのアクセス権が必要です。グループの情報は[**https://groups.google.com/all-groups**](https://groups.google.com/all-groups)で確認できます。

### GWSからGCPへのピボット

* **Google Groupsの特権昇格**を悪用することで、GCPへの特権アクセスを持つグループに特権昇格することができるかもしれません。
* **OAuthアプリケーション**を悪用することで、ユーザーをなりすまし、そのユーザーの代わりにGCPにアクセスすることができるかもしれません。

### GCPからGWSへのピボット

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### グループメール情報へのアクセス

Googleユーザーセッションを**侵害**できた場合、[**https://groups.google.com/all-groups**](https://groups.google.com/all-groups)から、ユーザーが所属しているメールグループに送信されたメールの履歴を確認し、**資格情報**や他の**機密データ**を見つけることができるかもしれません。

### Takeout - アカウントに関するGoogleのすべての情報をダウンロード

被害者のGoogleアカウント内の**セッション**がある場合、[**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)から、そのアカウントに関するGoogleが保存しているすべての情報をダウンロードすることができます。

### Vault - ユーザーのすべてのWorkspaceデータをダウンロード

組織が**Google Vaultを有効**にしている場合、[**https://vault.google.com**](https://vault.google.com/u/1/)にアクセスして、すべての情報を**ダウンロード**することができるかもしれません。

### 連絡先のダウンロード

[**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC)から、ユーザーの**連絡先**をすべてダウンロードすることができます。

### Cloudsearch

[**https://cloudsearch.google.com/**](https://cloudsearch.google.com)では、ユーザーがアクセス権を持つ**すべてのWorkspaceコンテンツ**（メール、ドライブ、サイトなど）を検索することができます。機密情報を**迅速に見つける**のに最適です。

### Currents

[**https://currents.google.com/**](https://currents.google.com)では、Googleの**チャット**にアクセスできるため、そこに機密情報があるかもしれません。

### Google Driveのマイニング

ドキュメントを**共有**するときに、個々の**人**ごとにアクセスできるようにするか、**リンクを生成**して**会社全体**（または特定の**グループ**）と共有することができます。

ドキュメントを共有する際、詳細設定でこのファイルの検索を許可することもできます（デフォルトでは無効になっています）。ただし、ユーザーがドキュメントを表示すると、検索可能になることに注意することが重要です。

簡単のため、ほとんどの人はドキュメントに個々のアクセス権を追加する代わりに、リンクを生成して共有するでしょう。

すべてのドキュメントを見つけるための提案された方法：

* 内部チャット、フォーラムなどで検索する
* 既知のドキュメントを**スパイダー**し、他のドキュメントへの参照を検索します。これは、[**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)を使用したApp Script内で行うことができます。

### **Keep Notes**

[**https://keep.google.com/**](https://keep.google.com)では、ユーザーのメモにアクセスできます。ここには、**機密情報**が保存されている可能性があります。

### Googleアカウント内での持続性

Googleユーザーセッションを**侵害**でき、ユーザーが**2FA**を使用している場合、[**アプリパスワード**](https://support.google.com/accounts/answer/185833?hl=en)を生成し、2FAのバックアップコードを**再生成**することで、ユーザーがパスワードを変更してもそのアカウントにアクセスできるようになります。コードを**再生成**する代わりに、自分自身の認証アプリを2FAに登録することもできます。

### OAuthアプリを介した持続性

ユーザーアカウントを**侵害**した場合、**OAuthアプリ**にすべての可能な
### 持続性のある委任

攻撃者が制御する別のアカウントにアカウントを**委任する**ことができます。

### Androidアプリによる持続性

被害者のGoogleアカウント内で**セッションがある場合**、**Playストア**に移動し、すでにアップロードしたマルウェアを**直接電話にインストール**して持続性を維持し、被害者の電話にアクセスすることができます。

### Gmailによる持続性

* Googleからのセキュリティ通知を**隠すためのフィルタ**を作成できます。
* from: (no-reply@accounts.google.com) "Security Alert"
* パスワードリセットのメールを非表示にする
* 機密情報（またはすべて）を転送するための**転送先アドレスを作成**する - 手動でアクセスする必要があります。
* 例えば、単語「password」を含むメールを転送するための転送先アドレスを作成する
* 攻撃者が制御する**回復用のメール/電話を追加**する

### App Scriptsによる持続性

App Scriptsで**時間ベースのトリガ**を作成することができます。ユーザーがApp Scriptを受け入れた場合、ユーザーがアクセスしなくても**トリガが発生**します。

ドキュメントでは、`ScriptApp.newTrigger("function")`を使用するには、`script.scriptapp`の**スコープ**が必要ですが、他のスコープを宣言している限り、**おそらく必要ありません**。

### Workspaceの管理

[**https://admin.google.com**/](https://admin.google.com)では、十分な権限があれば、組織全体のWorkspaceの設定を変更することができる場合があります。

また、[**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)で、すべてのユーザーの請求書を検索してメールを見つけることもできます。

## アカウントの侵害からの回復

* すべてのセッションからログアウトする
* ユーザーパスワードを変更する
* 新しい2FAバックアップコードを生成する
* Appパスワードを削除する
* OAuthアプリを削除する
* 2FAデバイスを削除する
* メール転送先を削除する
* メールフィルタを削除する
* 回復用のメール/電話を削除する
* 悪意のあるAndroidアプリを削除する
* 悪意のあるアカウントの委任を削除する

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
