# Workspaceのセキュリティ

<details>

<summary><strong>HackTricksをサポートして特典を得る！</strong></summary>

* **HackTricksの最新バージョンを入手したい**、または**PEASSをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## Workspaceフィッシング

### 一般的なフィッシング手法

### Googleグループフィッシング

おそらく、デフォルトではワークスペースのメンバーは[**グループを作成**](https://groups.google.com/all-groups) **し、人々を招待することができます**。その後、ユーザーに送信されるメールを**いくつかのリンクを追加して**変更できます。**メールはGoogleのアドレスから送信される**ため、**正規**に見え、人々はリンクをクリックするかもしれません。

### ハングアウトフィッシング

相手のメールアドレスを持っている場合は、直接その人と話すことも、話すための招待状を送ることもできるかもしれません。いずれの場合でも、メールアカウントを「Google Security」と名付け、Googleのロゴを追加することができます。人々はそれがGoogleとの会話であると思うかもしれません：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

**同じ手法**は**Google Chat**でも使用できます。

### Googleドキュメントフィッシング

**見かけ上正当なドキュメント**を作成し、コメントで**いくつかのメール（+user@gmail.comのような）**を言及します。Googleは、そのメールアドレスに通知メールを送信します。そのドキュメントに**リンクを入れる**ことで、その人にアクセスさせようとすることができます。

### Googleカレンダーフィッシング

**カレンダーイベントを作成**し、攻撃対象の会社のメールアドレスを持っているだけ追加します。現在の時刻から**5分または15分**後にこのカレンダーイベントをスケジュールします。イベントを正規に見えるようにし、**何かを読む必要がある**というコメントを追加します（**フィッシングリンク**を含む）。\
より怪しまれないようにするためには：

* **受信者が招待された他の人を見ることができないように**設定します。
* **イベントに関するメールを送信しないでください**。その後、人々は5分後の会議についての警告と、そのリンクを読む必要があるという警告しか見ません。
* APIを使用すると、イベントを**受け入れた**と設定したり、**コメントを代理で作成**したりすることができるようです。

### OAuthフィッシング

前述のいずれの手法でも、ユーザーが**Google OAuthアプリケーション**にアクセスするようにすることができます。このアプリケーションは、ユーザーにいくつかの**アクセス**を要求します。ユーザーが**ソース**を**信頼**している場合、**アプリケーション**（特権の高いアクセスを要求していても）を**信頼**するかもしれません。

Googleは、いくつかの場合において、アプリケーションが信頼されていないことを警告する見栄えの悪いプロンプトを表示します。また、Workspaceの管理者はOAuthアプリケーションの受け入れを防ぐこともできます。詳細はOAuthセクションを参照してください。

## パスワードスプレー

見つけたすべてのメールアドレスでパスワードをテストするために、[**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing)のようなツールを使用することができます。このツールはAWS Lambdaを使用してIPアドレスを変更します。

## OAuthアプリ

**Google**では、**Googleのサービス**（Gmail、Drive、GCPなど）と**ユーザーの代わりに対話する**アプリケーションを作成することができます。\
**他のユーザーの代わりに動作する**アプリケーションを作成する場合、開発者は**GCP内のOAuthアプリ**を作成し、アプリがユーザーデータにアクセスするために必要なスコープ（権限）を指定する必要があります。\
**ユーザー**が**そのアプリケーション**を**使用**したい場合、スコープで指定されたデータにアクセスするアプリケーションにアクセスすることを**承認**するように**求められます**。

これは、非技術的なユーザーを**フィッシング**して、**機密情報にアクセスするアプリケーション**を使用させる非常に魅力的な方法です。ただし、組織のアカウントでは、これを防ぐ方法があります。

### 未確認のアプリのプロンプト

前述のように、Googleはユーザーに対して、アプリケーションがユーザーの代わりに持つ権限を受け入れるかどうかのプロンプトを常に表示します。ただし、アプリケーションが**危険**と見なされる場合、Googleは**最初に**アプリが**危険**であることを示す**プロンプト**を表示し、ユーザーがアプリに権限を与えることをより困難にします。

このプロンプトは、次のようなアプリで表示されます。

* プライベートデータにアクセスできるスコープを使用するアプリ（Gmail、Drive、GCP、BigQueryなど）
* ユーザーが100人未満のアプリ（100人以上のアプリは、未確認のプロンプトを表示しないためにレビュープロセスも必要）

### おもしろいスコープ

[**ここ**](https://developers.google.com/identity/protocols/oauth2/scopes)で、すべてのGoogle OAuthスコープのリストを見つけることができます。

* **cloud-platform**：**Google Cloud Platform**サービス全体でデータを表示および管理します。GCPでユーザーのなりすましができます。
* **directory.readonly**：組織のGSuiteディレクトリを表示およびダウンロードします。すべてのユーザーの名前、電話番号、カレンダーURLを取得します。

## App Scripts

開発者はApp Scriptsを作成し、それをGoogleドキュメント/シート/スライド/フォームにバインドするか、スタンドアロンプロジェクトとして設定することができます。App Scriptsは、編集者権限を持つユーザーがドキュメントにアクセスしたときにトリガーされるコードです（OAuthプロンプトを受け入れた後）
### コピーされていないドキュメントのプロンプトバイパス

ドキュメントを共有するためのリンクを作成すると、次のようなリンクが作成されます：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
代わりに、アクセスする代わりに、**"/edit"**の代わりに**"/copy"**を末尾に変更すると、Googleはドキュメントのコピーを生成するかどうかを尋ねます。

{% hint style="warning" %}
**App Scriptを含む**ドキュメントの**コピー**を作成した場合、**App Scriptもコピーされます**。したがって、コピーされたスプレッドシートを開くと、**通常のOAuthプロンプト**が表示され、**未検証のプロンプトがバイパス**されます。なぜなら、**ユーザーはコピーされたファイルのApp Scriptの作者になる**からです。
{% endhint %}

この方法は、Workspace管理者の制限もバイパスできます。

ただし、次の方法で防止できます：

### 共有ドキュメントの未検証のプロンプトバイパス

さらに、誰かが**編集アクセス**であなたと共有したドキュメント内で**App Scriptを生成**することができ、ドキュメントの**OWNER（作成者）がApp Scriptの所有者**になります。

{% hint style="warning" %}
これは、**ドキュメントの作成者が、それに編集アクセスを持つ人が作成したApp Scriptの作成者として表示される**ことを意味します。

これはまた、App Scriptがドキュメントの作成者のWorkspace環境によって信頼されることを意味します。
{% endhint %}

{% hint style="danger" %}
これはまた、**App Scriptが既に存在**し、人々が**アクセスを許可**した場合、ドキュメントの**Editor**権限を持つ人はそれを**変更してアクセスを悪用**することができます。\
これを悪用するには、人々がApp Scriptをトリガーする必要があります。また、**スクリプトをWebアプリとして公開**するという便利なトリックもあります。App Scriptへのアクセスを許可した**人々**がWebページにアクセスすると、App Scriptが**トリガー**されます（これは`<img>`タグを使用しても機能します）。
{% endhint %}

## ポストエクスプロイテーション

### Google Groupsの特権昇格

デフォルトでは、Workspaceでは**グループ**は組織の任意のメンバーによって**自由にアクセス**できます。\
Workspaceではまた、グループに権限（GCPの権限も含む）を**付与することができる**ため、グループに参加でき、追加の権限を持つ場合、攻撃者は特権をエスカレートするためにこのパスを**悪用**することができます。

組織内の誰でも参加できるグループに参加するためには、コンソールへのアクセス権が必要です。[**https://groups.google.com/all-groups**](https://groups.google.com/all-groups)でグループの情報を確認してください。

### GCPへの特権昇格の概要

* **Google Groupsの特権昇格**を悪用することで、特権を持つグループにエスカレートすることができるかもしれません。
* **OAuthアプリケーション**を悪用することで、ユーザーをなりすまし、彼らの代わりにGCPにアクセスすることができるかもしれません。

### グループメール情報へのアクセス

Googleユーザーセッションを**侵害**できた場合、[**https://groups.google.com/all-groups**](https://groups.google.com/all-groups)から、ユーザーが所属しているメールグループに送信されたメールの履歴を確認し、**資格情報**や他の**機密データ**を見つけることができるかもしれません。

### Takeout - アカウントに関するGoogleのすべての情報をダウンロード

被害者のGoogleアカウント内の**セッション**がある場合、[**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)から、Googleがそのアカウントに保存しているすべての情報をダウンロードすることができます。

### Vault - ユーザーのすべてのWorkspaceデータをダウンロード

組織が**Google Vaultを有効にしている**場合、[**https://vault.google.com**](https://vault.google.com/u/1/)にアクセスして、すべての情報を**ダウンロード**することができるかもしれません。

### 連絡先のダウンロード

[**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC)から、ユーザーの**連絡先**をすべてダウンロードすることができます。

### Cloudsearch

[**https://cloudsearch.google.com/**](https://cloudsearch.google.com)では、ユーザーがアクセス権を持つ**すべてのWorkspaceコンテンツ**（メール、ドライブ、サイトなど）を検索することができます。機密情報を**迅速に見つける**のに最適です。

### Currents

[**https://currents.google.com/**](https://currents.google.com)では、Googleの**チャット**にアクセスできるため、そこに機密情報があるかもしれません。

### Google Driveの採掘

ドキュメントを**共有**するときに、個々の**人**ごとにアクセスできるようにするか、**リンクを生成**して**会社全体**（または特定の**グループ**）と共有することができます。

ドキュメントを共有する際に、詳細設定でこのファイルの検索を許可することもできます（デフォルトでは無効になっています）。ただし、ユーザーがドキュメントを表示すると、検索可能になることに注意することが重要です。

簡単のために、ほとんどの人はドキュメントに個別にアクセスできる人々を追加する代わりに、リンクを生成して共有するでしょう。

すべてのドキュメントを見つけるための提案された方法：

* 内部チャット、フォーラムなどで検索する
* 既知のドキュメントを**スパイダー**し、他のドキュメントへの参照を検索します。これは、[**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)を使用したApp Script内で行うことができます。

### **Keep Notes**

[**https://keep.google.com/**](https://keep.google.com)から、ユーザーのメモにアクセスできます。ここには**機密情報**が保存されている可能性があります。

### Googleアカウント内での持続性

Googleユーザーセッションを**侵害**でき、ユーザーが**2FA**を使用している場合、[**アプリパスワード**](https://support.google.com/accounts/answer/185833?hl=en)を生成し、2FAのバックアップコードを**再生成**することで、ユーザーがパスワードを変更しても、そのアカウントにアクセスできるようになります。コードを**再生成**する代わりに、2FAに独自の認証アプリを登録することもできます。

### OAuthアプリを介した持続性

ユーザーアカウントを**侵害**した場合、**OAuthアプリ**にすべての可能な権限を**付与**するだけで済みます。唯一の問題は、Workspaceが**未承認の外部および/または内部のOAuthアプリを許可しない**ように構成されている可能性があることです。\
外部のOAuthアプリにはデフォルトで信頼しないことが一般的ですが、内部のOAuthアプリには信頼する場合が多いため、組織内で新しいOAuthアプリを生成する権限が**十分に
### 持続性のための委任

攻撃者が制御する別のアカウントにアカウントを**委任する**ことができます。

### Androidアプリによる持続性

被害者のGoogleアカウント内で**セッションがある場合**、**Playストア**に移動し、すでにアップロードしたマルウェアを**直接電話にインストール**して持続性を維持し、被害者の電話にアクセスすることができます。

### Gmailによる持続性

* Googleからのセキュリティ通知を**隠すためのフィルタ**を作成できます。
* from: (no-reply@accounts.google.com) "Security Alert"
* パスワードリセットのメールを非表示にする
* 機密情報（またはすべて）を転送するための**転送先アドレスを作成**する - 手動でアクセスする必要があります。
* 例えば、単語「password」を含むメールを転送するための転送先アドレスを作成する
* 攻撃者が制御する**回復用のメール/電話を追加**する

### App Scriptsによる持続性

App Scriptsで**時間ベースのトリガ**を作成することができます。ユーザーがApp Scriptを受け入れた場合、ユーザーがアクセスしなくても**トリガが発生**します。

ドキュメントでは、`ScriptApp.newTrigger("funcion")`を使用するには、`script.scriptapp`の**スコープ**が必要ですが、他のスコープを宣言している限り、**おそらくそれは必要ありません**。

### Workspaceの管理

[**https://admin.google.com**/](https://admin.google.com)では、十分な権限があれば、組織全体のWorkspaceの設定を変更することができる場合があります。

また、[**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)で、すべてのユーザーの請求書を検索してメールを見つけることもできます。

## アカウントの侵害からの回復

* すべてのセッションからログアウトする
* ユーザーパスワードを変更する
* 新しい2FAバックアップコードを生成する
* Appパスワードを削除する
* OAuthアプリを削除する
* 2FAデバイスを削除する
* メール転送先を削除する
* メールフィルタを削除する
* 回復用のメール/電話を削除する
* 悪意のあるAndroidアプリを削除する
* 悪意のあるアカウントの委任を削除する

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
