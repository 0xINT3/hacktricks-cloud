# Pentesting de l'espace de travail

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Phishing de l'espace de travail

### M√©thodologie de phishing g√©n√©rique

### Phishing Google Groups

Apparemment, par d√©faut dans les membres de l'espace de travail [**peuvent cr√©er des groupes**](https://groups.google.com/all-groups) **et inviter des personnes √† les rejoindre**. Vous pouvez ensuite modifier l'e-mail qui sera envoy√© √† l'utilisateur **en ajoutant des liens**. L'e-mail **proviendra d'une adresse Google**, il semblera donc **l√©gitime** et les gens pourraient cliquer sur le lien.

### Phishing Hangout

Vous pourriez √™tre en mesure de parler directement √† une personne en ayant simplement son adresse e-mail ou d'envoyer une invitation pour discuter. Dans les deux cas, vous pouvez modifier un compte e-mail en le nommant peut-√™tre "Google Security" et en ajoutant des logos Google, et les gens penseront qu'ils parlent √† Google : [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **m√™me technique** peut √™tre utilis√©e avec **Google Chat**.

### Phishing Google Doc

Vous pouvez cr√©er un **document apparemment l√©gitime** et dans un commentaire **mentionner un e-mail (comme +user@gmail.com)**. Google **enverra un e-mail √† cette adresse e-mail** pour notifier qu'elle a √©t√© mentionn√©e dans le document. Vous pouvez **mettre un lien dans ce document** pour essayer de faire en sorte que la personne y acc√®de.

### Phishing Google Calendar

Vous pouvez **cr√©er un √©v√©nement de calendrier** et ajouter autant d'adresses e-mail de l'entreprise que vous attaquez que vous en avez. Planifiez cet √©v√©nement de calendrier dans **5 ou 15 minutes** √† partir de l'heure actuelle. Rendez l'√©v√©nement cr√©dible et **mettez un commentaire indiquant qu'ils doivent lire quelque chose** (avec le **lien de phishing**).\
Pour que cela paraisse moins suspect :

* Configurez-le de sorte que **les destinataires ne puissent pas voir les autres personnes invit√©es**
* **NE PAS envoyer d'e-mails** pour notifier de l'√©v√©nement. Ainsi, les personnes ne verront que leur avertissement concernant une r√©union dans 5 minutes et qu'elles doivent lire ce lien.
* Apparemment, en utilisant l'API, vous pouvez d√©finir √† **True** que les **personnes** ont **accept√©** l'√©v√©nement et m√™me cr√©er des **commentaires en leur nom**.

### Phishing OAuth

Toutes les techniques pr√©c√©dentes peuvent √™tre utilis√©es pour amener l'utilisateur √† acc√©der √† une **application Google OAuth** qui demandera √† l'utilisateur certaines **autorisations d'acc√®s**. Si l'utilisateur **fait confiance** √† la **source**, il pourrait **faire confiance** √† l'**application** (m√™me si elle demande des autorisations √† haut niveau de privil√®ges).

Notez que Google pr√©sente une fen√™tre d'avertissement peu attrayante indiquant que l'application n'est pas approuv√©e dans plusieurs cas et que les administrateurs de l'espace de travail peuvent m√™me emp√™cher les personnes d'accepter les applications OAuth. Plus d'informations √† ce sujet dans la section OAuth.

## Password Spraying

Pour tester les mots de passe avec tous les e-mails que vous avez trouv√©s (ou que vous avez g√©n√©r√©s en fonction d'un mod√®le de nom d'e-mail que vous auriez d√©couvert), vous pouvez utiliser un outil comme [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing) qui utilisera des lambdas AWS pour changer d'adresse IP.

## Applications OAuth

**Google** permet de cr√©er des applications qui peuvent **interagir au nom des utilisateurs** avec plusieurs **services Google** : Gmail, Drive, GCP...

Lors de la cr√©ation d'une application pour **agir au nom d'autres utilisateurs**, le d√©veloppeur doit cr√©er une **application OAuth dans GCP** et indiquer les √©tendues (autorisations) dont l'application a besoin pour acc√©der aux donn√©es des utilisateurs.\
Lorsqu'un **utilisateur** souhaite **utiliser** cette **application**, il lui sera **demand√©** d'**accepter** que l'application ait acc√®s √† ses donn√©es sp√©cifi√©es dans les √©tendues.

C'est une fa√ßon tr√®s int√©ressante de **phisher** les utilisateurs non techniques pour qu'ils utilisent des **applications qui acc√®dent √† des informations sensibles**, car ils pourraient ne pas comprendre les cons√©quences. Cependant, dans les comptes d'organisations, il existe des moyens d'emp√™cher cela.

### Fen√™tre d'application non v√©rifi√©e

Comme mentionn√© pr√©c√©demment, Google pr√©sentera toujours une **fen√™tre d'avertissement √† l'utilisateur pour accepter** les autorisations qu'il accorde √† l'application en son nom. Cependant, si l'application est consid√©r√©e comme **dangereuse**, Google affichera **d'abord** une **fen√™tre d'avertissement** indiquant qu'elle est **dangereuse** et **rendant plus difficile** pour l'utilisateur d'accorder les autorisations √† l'application.

Cette fen√™tre d'avertissement appara√Æt dans les applications qui :

* Utilisent une √©tendue qui peut acc√©der √† des donn√©es priv√©es (Gmail, Drive, GCP, BigQuery...)
* Applications avec moins de 100 utilisateurs (les applications > 100 n√©cessitent √©galement un processus d'examen pour cesser d'afficher la fen√™tre d'application non v√©rifi√©e)

### √âtendues int√©ressantes

[**Ici**](https://developers.google.com/identity/protocols/oauth2/scopes), vous pouvez trouver une liste de toutes les √©tendues OAuth Google.

* **cloud-platform** : Affichez et g√©rez vos donn√©es sur les services de la **plateforme Google Cloud**. Vous pouvez vous faire passer pour l'utilisateur dans GCP.
* **directory.readonly** : Consultez et t√©l√©chargez l'annuaire GSuite de votre organisation. Obtenez les noms, les num√©ros de t√©l√©phone, les URL de calendrier de tous les utilisateurs.

## Scripts d'application

Les d√©veloppeurs peuvent cr√©er des scripts d'application et les d√©finir comme projet autonome ou les lier √† Google Docs/Sheets/Slides/Forms. Les scripts d'application sont du code qui sera d√©clench√© lorsqu'un utilisateur disposant de l'autorisation d'√©diteur acc√®de au document (et apr√®s avoir accept√© la fen√™tre d'autorisation OAuth)

Cependant, m√™me si l'application n'est pas v√©rifi√©e, il existe quelques moyens de ne pas afficher cette fen√™tre :

* Si l'√©diteur de l'application se trouve dans le m√™me espace de travail que l'utilisateur y acc√©dant
* Si le script se trouve dans un lecteur de l'utilisateur
### Contournement de la demande de v√©rification de copie de document non v√©rifi√©e

Lorsque vous cr√©ez un lien pour partager un document, un lien similaire √† celui-ci est cr√©√© : `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si vous **modifiez** la fin **"/edit"** par **"/copy"**, au lieu d'y acc√©der, Google vous demandera si vous souhaitez **g√©n√©rer une copie du document**.

{% hint style="warning" %}
Si quelqu'un cr√©e une **copie** de ce **document** qui **contient le script d'application**, il copiera √©galement le **script d'application**. Par cons√©quent, lorsque cette personne **ouvre** la **copie de la feuille de calcul**, la **demande d'autorisation OAuth r√©guli√®re** appara√Ætra, **contournant ainsi la demande de v√©rification non v√©rifi√©e**, car **l'utilisateur est maintenant l'auteur du script d'application du fichier copi√©**.
{% endhint %}

Cette m√©thode permet √©galement de contourner les restrictions de l'administrateur de Workspace :

Mais cela peut √™tre √©vit√© avec :

### Contournement de la demande de v√©rification non v√©rifi√©e pour les documents partag√©s

De plus, si quelqu'un vous a **partag√©** un document avec un **acc√®s en tant qu'√©diteur**, vous pouvez g√©n√©rer des **scripts d'application √† l'int√©rieur du document** et le **propri√©taire (cr√©ateur) du document sera le propri√©taire du script d'application**.

{% hint style="warning" %}
Cela signifie que le **cr√©ateur du document appara√Ætra comme cr√©ateur de tout script d'application** cr√©√© par toute personne ayant un acc√®s en tant qu'√©diteur √† l'int√©rieur de celui-ci.

Cela signifie √©galement que le **script d'application sera approuv√© par l'environnement Workspace** du cr√©ateur du document.
{% endhint %}

{% hint style="danger" %}
Cela signifie √©galement que si un **script d'application existait d√©j√†** et que des personnes ont **accord√© l'acc√®s**, toute personne ayant une permission d'**√©diteur** sur le document peut le **modifier et abuser de cet acc√®s**.\
Pour exploiter cela, vous avez √©galement besoin que des personnes d√©clenchent le script d'application. Et une astuce int√©ressante consiste √† **publier le script en tant qu'application Web**. Lorsque les **personnes** qui ont d√©j√† accord√© **l'acc√®s** au script d'application acc√®dent √† la page Web, elles d√©clenchent le **script d'application** (cela fonctionne √©galement avec les balises `<img>`).
{% endhint %}

## Post-exploitation

### Privil√®ge d'√©l√©vation des groupes Google

Par d√©faut, dans Workspace, un **groupe** peut √™tre **librement accessible** par n'importe quel membre de l'organisation.\
Workspace permet √©galement d'**accorder des autorisations aux groupes** (m√™me des autorisations GCP), donc si les groupes peuvent √™tre rejoints et qu'ils ont des autorisations suppl√©mentaires, un attaquant peut **exploiter cette voie pour √©lever ses privil√®ges**.

Vous avez potentiellement besoin d'acc√©der √† la console pour rejoindre des groupes qui autorisent leur adh√©sion par n'importe qui dans l'organisation. V√©rifiez les informations sur les groupes dans [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Pivotement de GWS vers GCP

* En abusant du **privil√®ge d'√©l√©vation des groupes Google**, vous pourriez √™tre en mesure de passer √† un groupe avec un certain type d'acc√®s privil√©gi√© √† GCP.
* En abusant des **applications OAuth**, vous pourriez √™tre en mesure de vous faire passer pour des utilisateurs et d'acc√©der √† GCP en leur nom.

### Pivotement de GCP vers GWS

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### Acc√®s aux informations de messagerie des groupes

Si vous avez r√©ussi √† **compromettre une session utilisateur Google**, √† partir de [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups), vous pouvez voir l'historique des courriers envoy√©s aux groupes de messagerie dont l'utilisateur est membre, et vous pourriez trouver des **informations d'identification** ou d'autres **donn√©es sensibles**.

### Takeout - T√©l√©charger tout ce que Google sait sur un compte

Si vous avez une **session √† l'int√©rieur du compte Google de la victime**, vous pouvez t√©l√©charger tout ce que Google enregistre √† propos de ce compte depuis [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - T√©l√©charger toutes les donn√©es Workspace des utilisateurs

Si une organisation a activ√© **Google Vault**, vous pourriez √™tre en mesure d'acc√©der √† [**https://vault.google.com**](https://vault.google.com/u/1/) et de **t√©l√©charger** toutes les **informations**.

### T√©l√©chargement des contacts

Depuis [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC), vous pouvez t√©l√©charger tous les **contacts** de l'utilisateur.

### Cloudsearch

Dans [**https://cloudsearch.google.com/**](https://cloudsearch.google.com), vous pouvez simplement rechercher **tout le contenu Workspace** (e-mails, Drive, sites...) auquel un utilisateur a acc√®s. Id√©al pour **trouver rapidement des informations sensibles**.

### Currents

Dans [**https://currents.google.com/**](https://currents.google.com), vous pouvez acc√©der √† un **Chat Google**, vous pourriez donc y trouver des informations sensibles.

### Exploration de Google Drive

Lorsque vous **partagez** un document, vous pouvez **sp√©cifier** les **personnes** qui peuvent y acc√©der une par une, le **partager** avec toute votre **entreprise** (**ou** avec certains **groupes**) en **g√©n√©rant un lien**.

Lorsque vous partagez un document, dans les param√®tres avanc√©s, vous pouvez √©galement **autoriser les personnes √† rechercher** ce fichier (par **d√©faut**, cela est **d√©sactiv√©**). Cependant, il est important de noter que d√®s qu'un utilisateur consulte un document, il peut le rechercher.

Pour simplifier les choses, la plupart des gens g√©n√©reront et partageront un lien au lieu d'ajouter les personnes qui peuvent acc√©der au document une par une.

Voici quelques m√©thodes propos√©es pour trouver tous les documents :

* Recherchez dans le chat interne, les forums...
* **Parcourez** les **documents** connus en recherchant des **r√©f√©rences** vers d'autres documents. Vous pouvez le faire avec un script d'application avec [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser).

### **Keep Notes**

Dans [**https://keep.google.com/**](https://keep.google.com), vous pouvez acc√©der aux notes de l'utilisateur, des **informations sensibles** peuvent y √™tre enregistr√©es.

### Persistence √† l'int√©rieur d'un compte Google

Si vous avez r√©ussi √† **compromettre une session utilisateur Google** et que l'utilisateur avait **l'authentification √† deux facteurs (2FA)**, vous pouvez **g√©n√©rer** un [**mot de passe d'application**](https://support.google.com/accounts/answer/185833?hl=en) et **r√©g√©n√©rer les codes de sauvegarde 2FA** pour savoir que m√™me si l'utilisateur change le mot de passe, vous **pourrez acc√©der √† son compte**. Une autre option, **au lieu** de **r√©g√©n√©rer** les codes, consiste √† **enregistrer votre propre application d'authentification** dans le 2FA.

### Persistence via les applications OAuth

Si vous avez **compromis le compte d'un utilisateur**, vous pouvez simplement **accepter** d'accorder toutes les autorisations possibles √† une **application OAuth**. Le seul probl√®me est que Workspace peut √™tre configur√© pour **interdire les applications OAuth externes et/ou internes non examin√©es**.\
Il est assez courant de ne pas faire confiance par d√©faut aux applications OAuth externes, mais de faire confiance aux applications internes. Donc, si vous avez **suffisamment d'autorisations pour g√©n√©rer une nouvelle application OAuth** au sein de l'organisation et que les applications externes sont interdites, g√©n√©rez-la et **utilisez cette nouvelle application OAuth interne pour maintenir la persistance**.
### Persistence via d√©l√©gation

Vous pouvez simplement **d√©l√©guer le compte** √† un autre compte contr√¥l√© par l'attaquant.

### Persistence via une application Android

Si vous avez une **session √† l'int√©rieur du compte Google de la victime**, vous pouvez acc√©der √† **Play Store** et **installer un logiciel malveillant** que vous avez d√©j√† t√©l√©charg√© directement **sur le t√©l√©phone** pour maintenir la persistance et acc√©der au t√©l√©phone de la victime.

### **Persistence via Gmail**

* Vous pouvez cr√©er des **filtres pour masquer** les notifications de s√©curit√© de Google
* from: (no-reply@accounts.google.com) "Alerte de s√©curit√©"
* Masquer les e-mails de r√©initialisation de mot de passe
* Cr√©er une **adresse de redirection pour transf√©rer des informations sensibles** (ou tout) - Vous avez besoin d'un acc√®s manuel.
* Cr√©er une adresse de redirection pour envoyer des e-mails contenant le mot "password" par exemple
* Ajouter une **adresse e-mail/de t√©l√©phone de r√©cup√©ration sous le contr√¥le de l'attaquant**

### **Persistence via** App Scripts

Vous pouvez cr√©er des **d√©clencheurs bas√©s sur le temps** dans App Scripts, donc si le script d'application est accept√© par l'utilisateur, il sera **d√©clench√©** m√™me **sans que l'utilisateur y acc√®de**.

La documentation mentionne que pour utiliser `ScriptApp.newTrigger("funcion")`, vous avez besoin de la **port√©e** `script.scriptapp`, mais **apparemment cela n'est pas n√©cessaire** tant que vous avez d√©clar√© une autre port√©e.

### **Administrer Workspace**

Dans [**https://admin.google.com**/](https://admin.google.com), vous pourriez √™tre en mesure de modifier les param√®tres de Workspace de toute l'organisation si vous avez suffisamment de permissions.

Vous pouvez √©galement trouver des e-mails en recherchant dans toutes les factures de l'utilisateur dans [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## R√©cup√©ration d'un compte compromis

* D√©connectez-vous de toutes les sessions
* Changez le mot de passe de l'utilisateur
* G√©n√©rez de nouveaux codes de sauvegarde 2FA
* Supprimez les mots de passe d'application
* Supprimez les applications OAuth
* Supprimez les appareils 2FA
* Supprimez les redirections d'e-mails
* Supprimez les filtres d'e-mails
* Supprimez les adresses e-mail/t√©l√©phones de r√©cup√©ration
* Supprimez les applications Android malveillantes
* Supprimez les d√©l√©gations de compte malveillantes

## R√©f√©rences

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
