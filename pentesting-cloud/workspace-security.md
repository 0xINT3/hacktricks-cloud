# Seguridad de Workspace

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing de Workspace

### Metodología de Phishing Genérica

### Phishing de Grupos de Google

Aparentemente, por defecto en los miembros de Workspace [**pueden crear grupos**](https://groups.google.com/all-groups) **e invitar a personas a ellos**. Luego puedes modificar el correo electrónico que se enviará al usuario **añadiendo algunos enlaces**. El **correo electrónico vendrá de una dirección de Google**, por lo que parecerá **legítimo** y la gente podría hacer clic en el enlace.

### Phishing de Hangouts

Es posible que puedas hablar directamente con una persona solo teniendo su dirección de correo electrónico o enviar una invitación para hablar. De cualquier manera, puedes modificar una cuenta de correo electrónico tal vez nombrándola "Seguridad de Google" y agregando algunos logotipos de Google, y la gente pensará que está hablando con Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **misma técnica** se puede usar con **Google Chat**.

### Phishing de Documentos de Google

Puedes crear un **documento aparentemente legítimo** y en un comentario **mencionar algún correo electrónico (como +usuario@gmail.com)**. Google **enviará un correo electrónico a esa dirección de correo electrónico** notificando que fueron mencionados en el documento. Puedes **poner un enlace en ese documento** para intentar hacer que la persona lo acceda.

### Phishing de Calendario de Google

Puedes **crear un evento de calendario** y agregar tantas direcciones de correo electrónico de la empresa que estás atacando como tengas. Programa este evento de calendario en **5 o 15 minutos** a partir del momento actual. Haz que el evento parezca legítimo y **pon un comentario indicando que necesitan leer algo** (con el **enlace de phishing**).\
Para que parezca menos sospechoso:

* Configúralo para que **los destinatarios no puedan ver a las demás personas invitadas**
* **NO envíes correos electrónicos notificando sobre el evento**. Entonces, las personas solo verán su advertencia sobre una reunión en 5 minutos y que necesitan leer ese enlace.
* Aparentemente, utilizando la API, puedes establecer que **las personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

### Phishing de OAuth

Cualquiera de las técnicas anteriores puede ser utilizada para hacer que el usuario acceda a una **aplicación de Google OAuth** que solicitará al usuario algún **acceso**. Si el usuario **confía** en la **fuente**, podría **confiar** en la **aplicación** (incluso si está solicitando permisos de alta privilegiados).

Tenga en cuenta que Google presenta una ventana emergente fea que advierte que la aplicación no es de confianza en varios casos y los administradores de Workspace incluso pueden evitar que las personas acepten aplicaciones de OAuth. Más sobre esto en la sección de OAuth.

## Password Spraying

Para probar contraseñas con todos los correos electrónicos que encontraste (o que has generado en función de un patrón de nombre de correo electrónico que puedas haber descubierto), puedes usar una herramienta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing), que utilizará AWS lambdas para cambiar la dirección IP.

## Aplicaciones de OAuth

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Al crear una aplicación para **actuar en nombre de otros usuarios**, el desarrollador debe crear una **aplicación OAuth dentro de GCP** e indicar los ámbitos (permisos) que la aplicación necesita para acceder a los datos de los usuarios.\
Cuando un **usuario** quiere **usar** esa **aplicación**, se le **pedirá** que **acepte** que la aplicación tendrá acceso a sus datos especificados en los ámbitos.

Esta es una forma muy jugosa de **phishing** a usuarios no técnicos para que usen **aplicaciones que acceden a información sensible** porque podrían no entender las consecuencias. Sin embargo, en las cuentas de las organizaciones, hay formas de evitar que esto suceda.

### Ventana emergente de aplicación no verificada

Como se mencionó, Google siempre presentará una **ventana emergente al usuario para aceptar** los permisos que están dando a la aplicación en su nombre. Sin embargo, si se considera que la aplicación es **peligrosa**, Google mostrará **primero** una **ventana emergente** indicando que es **peligrosa** y **haciendo más difícil** que el usuario otorgue los permisos a la aplicación.

Esta ventana emergente aparece en aplicaciones que:

* Usan cualquier ámbito que pueda acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (para aplicaciones > 100 también se necesita un proceso de revisión para dejar de mostrar la ventana emergente no verificada)

### Ámbitos interesantes

[**Aquí**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los ámbitos de Google OAuth.

* **cloud-platform**: Ver y administrar tus datos en los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **directory.readonly**: Ver y descargar el directorio de GSuite de tu organización. Obtén nombres, teléfonos, URL de calendario de todos los usuarios.

## Scripts de aplicaciones

Los desarrolladores pueden crear Scripts de aplicaciones y configurarlos como un proyecto independiente o vincularlos a Google Docs/Sheets/Slides/Forms. Los Scripts de aplicaciones son código que se activará cuando un usuario con permiso de editor acceda al documento (y después de aceptar la ventana emergente de OAuth)

Sin embargo, incluso si la aplicación no está verificada, hay un par de formas de no mostrar esa ventana emergente:

* Si el editor de la aplicación está en el mismo Workspace que el usuario que la está utilizando
* Si el script está en una unidad del usuario

### Bypass de ventana emergente no verificada de copia de documento

Cuando creas un enlace para compartir un documento, se crea un enlace similar a este: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si **cambias** el final **"/edit"** por **"/copy"**, en lugar de acceder, Google te preguntará si quieres **generar una copia del documento.**

{% hint style="warning" %}
Si alguien crea una **copia** de ese **documento** que **contenía el Script de aplicación**, también estará **copiando el Script de aplicación**, por lo que cuando **abra** la **hoja de cálculo copiada**, aparecerá la **ventana emergente de OAuth regular** **bypassing la ventana emergente no verificada**, porque **el usuario es ahora el autor del Script de aplicación del archivo copiado**.
{% endhint %}

Este método también podrá evitar la restricción del administrador de Workspace:

Pero se puede prevenir con:
### Bypass de la verificación de documentos compartidos

Además, si alguien te comparte un documento con acceso de editor, puedes generar Scripts de aplicaciones dentro del documento y el propietario (creador) del documento será el propietario del Script de la aplicación.

{% hint style="warning" %}
Esto significa que el creador del documento aparecerá como creador de cualquier Script de la aplicación que cualquier persona con acceso de editor cree dentro de él.

Esto también significa que el Script de la aplicación será confiable por el entorno de Workspace del creador del documento.
{% endhint %}

{% hint style="danger" %}
Esto también significa que si ya existía un Script de la aplicación y las personas han otorgado acceso, cualquier persona con permiso de editor en el documento puede modificarlo y abusar de ese acceso. Para abusar de esto, también necesitas que las personas activen el Script de la aplicación. Y un truco ingenioso es publicar el script como una aplicación web. Cuando las personas que ya han otorgado acceso al Script de la aplicación acceden a la página web, activarán el Script de la aplicación (esto también funciona usando etiquetas `<img>`).
{% endhint %}

## Post-Explotación

### Google Groups Privesc

Por defecto en Workspace, un grupo puede ser accedido libremente por cualquier miembro de la organización. Workspace también permite otorgar permisos a grupos (incluso permisos de GCP), por lo que si los grupos pueden unirse y tienen permisos adicionales, un atacante puede abusar de ese camino para escalar privilegios.

Potencialmente necesitas acceso a la consola para unirte a grupos que permiten unirse a cualquier persona en la organización. Verifica la información de los grupos en [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Privesc a GCP Resumen

* Abusando del privesc de grupos de Google, podrías ser capaz de escalar a un grupo con algún tipo de acceso privilegiado a GCP.
* Abusando de las aplicaciones OAuth, podrías ser capaz de suplantar a los usuarios y acceder a GCP en su nombre.

### Acceso a la información de los grupos de correo

Si lograste comprometer una sesión de usuario de Google, desde [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) puedes ver el historial de correos enviados a los grupos de correo de los que el usuario es miembro, y podrías encontrar credenciales u otros datos sensibles.

### Takeout - Descarga todo lo que Google sabe sobre una cuenta

Si tienes una sesión dentro de la cuenta de Google de la víctima, puedes descargar todo lo que Google guarda sobre esa cuenta desde [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - Descarga todos los datos de Workspace de los usuarios

Si una organización tiene habilitado Google Vault, podrías ser capaz de acceder a [**https://vault.google.com**](https://vault.google.com/u/1/) y descargar toda la información.

### Descarga de contactos

Desde [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) puedes descargar todos los contactos del usuario.

### Cloudsearch

En [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) puedes buscar a través de todo el contenido de Workspace (correo electrónico, drive, sitios...) al que un usuario tiene acceso. Ideal para encontrar rápidamente información sensible.

### Currents

En [**https://currents.google.com/**](https://currents.google.com) puedes acceder a un chat de Google, por lo que podrías encontrar información sensible allí.

### Minería de Google Drive

Cuando compartes un documento, puedes especificar las personas que pueden acceder a él una por una, compartirlo con toda tu empresa (o con algunos grupos específicos) generando un enlace.

Al compartir un documento, en la configuración avanzada también puedes permitir que las personas busquen este archivo (por defecto esto está desactivado). Sin embargo, es importante tener en cuenta que una vez que los usuarios ven un documento, pueden buscarlo.

Por simplicidad, la mayoría de las personas generarán y compartirán un enlace en lugar de agregar a las personas que pueden acceder al documento una por una.

Algunas formas propuestas de encontrar todos los documentos:

* Buscar en el chat interno, foros...
* Spider de documentos conocidos buscando referencias a otros documentos. Puedes hacer esto dentro de un Script de aplicación con [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

En [**https://keep.google.com/**](https://keep.google.com) puedes acceder a las notas del usuario, información sensible podría estar guardada aquí.

### Persistencia dentro de una cuenta de Google

Si lograste comprometer una sesión de usuario de Google y el usuario tenía 2FA, puedes generar una [**contraseña de aplicación**](https://support.google.com/accounts/answer/185833?hl=en) y regenerar los códigos de respaldo de 2FA para saber que incluso si el usuario cambia la contraseña, podrás acceder a su cuenta. Otra opción en lugar de regenerar los códigos es inscribir tu propia aplicación de autenticador en el 2FA.

### Persistencia a través de aplicaciones OAuth

Si has comprometido la cuenta de un usuario, simplemente puedes aceptar otorgar todos los permisos posibles a una aplicación OAuth. El único problema es que Workspace puede configurarse para no permitir aplicaciones OAuth externas y/o internas no revisadas. Es bastante común no confiar por defecto en las aplicaciones OAuth externas pero confiar en las internas, por lo que si tienes suficientes permisos para generar una nueva aplicación OAuth dentro de la organización y las aplicaciones externas están deshabilitadas, genérala y usa esa nueva aplicación OAuth interna para mantener la persistencia.

### Persistencia a través de la delegación

Simplemente puedes delegar la cuenta a una cuenta diferente controlada por el atacante.

### Persistencia a través de la aplicación Android

Si tienes una sesión dentro de la cuenta de Google de la víctima, puedes navegar hasta la Play Store e instalar malware que ya has cargado directamente en el teléfono para mantener la persistencia y acceder al teléfono de la víctima.

### **Persistencia a través de Gmail**

* Puedes crear filtros para ocultar las notificaciones de seguridad de Google
  * from: (no-reply@accounts.google.com) "Security Alert"
  * Ocultar correos electrónicos de restablecimiento de contraseña
* Crear una dirección de reenvío para reenviar información sensible (o todo) - Necesitas acceso manual.
  * Crea una dirección de reenvío para enviar correos electrónicos que contengan la palabra "contraseña", por ejemplo.
* Agregar correo electrónico/teléfono de recuperación bajo el control del atacante

### **Persistencia a través de Scripts de aplicaciones**

Puedes crear disparadores basados en el tiempo en Scripts de aplicaciones, por lo que si el usuario acepta el Script de la aplicación, se activará incluso sin que el usuario lo acceda.

Los documentos mencionan que para usar `ScriptApp.newTrigger("funcion")` necesitas el alcance `script.scriptapp`, pero aparentemente eso no es necesario siempre y cuando hayas declarado algún otro alcance.

### **Administrar Workspace**

En [**https://admin.google.com**/](https://admin.google.com), podrías ser capaz de modificar la configuración de Workspace de toda la organización si tienes suficientes permisos.

También puedes encontrar correos electrónicos buscando en todas las facturas de los usuarios en [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recuperación de cuenta comprometida

* Cerrar sesión en todas las sesiones
* Cambiar la contraseña del usuario
* Generar nuevos códigos de respaldo de 2FA
* Eliminar contraseñas de aplicaciones
* Eliminar aplicaciones OAuth
* Eliminar dispositivos 2FA
* Eliminar reenviadores de correo electrónico
* Eliminar filtros de correo electrónico
* Eliminar correo electrónico/teléfonos de recuperación
* Eliminar aplicaciones Android maliciosas
* Eliminar delegaciones de cuentas maliciosas
## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: El poder de la magia oscura de Apps Script
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch y Beau Bullock - OK Google, ¿Cómo hago Red Team en GSuite?

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>