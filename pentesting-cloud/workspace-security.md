# Pentesting de Workspace

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Phishing de Workspace

### Metodologia Gen√©rica de Phishing

### Phishing do Google Groups

Aparentemente, por padr√£o, os membros do workspace [**podem criar grupos**](https://groups.google.com/all-groups) **e convidar pessoas para eles**. Voc√™ pode ent√£o modificar o e-mail que ser√° enviado ao usu√°rio **adicionando alguns links**. O **e-mail vir√° de um endere√ßo do Google**, ent√£o parecer√° **leg√≠timo** e as pessoas podem clicar no link.

### Phishing do Hangout

Voc√™ pode ser capaz de falar diretamente com uma pessoa apenas tendo o endere√ßo de e-mail dela ou enviar um convite para conversar. De qualquer forma, voc√™ pode modificar uma conta de e-mail, talvez nomeando-a "Google Security" e adicionando alguns logotipos do Google, e as pessoas pensar√£o que est√£o conversando com o Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

Apenas a **mesma t√©cnica** pode ser usada com o **Google Chat**.

### Phishing do Google Doc

Voc√™ pode criar um **documento aparentemente leg√≠timo** e, em um coment√°rio, **mencionar algum e-mail (como +user@gmail.com)**. O Google ir√° **enviar um e-mail para esse endere√ßo de e-mail** notificando que eles foram mencionados no documento. Voc√™ pode **colocar um link nesse documento** para tentar fazer a pessoa acess√°-lo.

### Phishing do Google Calendar

Voc√™ pode **criar um evento de calend√°rio** e adicionar quantos endere√ßos de e-mail da empresa que voc√™ est√° atacando tiver. Agende este evento de calend√°rio em **5 ou 15 minutos** a partir do hor√°rio atual. Fa√ßa o evento parecer leg√≠timo e **coloque um coment√°rio indicando que eles precisam ler algo** (com o **link de phishing**).\
Para parecer menos suspeito:

* Configure para que **os destinat√°rios n√£o possam ver as outras pessoas convidadas**
* **N√ÉO envie e-mails notificando sobre o evento**. Ent√£o, as pessoas s√≥ ver√£o o aviso sobre uma reuni√£o em 5 minutos e que precisam ler aquele link.
* Aparentemente, usando a API, voc√™ pode definir como **True** que as **pessoas** aceitaram o evento e at√© criar **coment√°rios em nome delas**.

### Phishing do OAuth

Qualquer uma das t√©cnicas anteriores pode ser usada para fazer o usu√°rio acessar um **aplicativo OAuth do Google** que ir√° **solicitar** ao usu√°rio algum **acesso**. Se o usu√°rio **confiar** na **fonte**, ele pode **confiar** no **aplicativo** (mesmo que esteja solicitando permiss√µes de alto privil√©gio).

Observe que o Google apresenta um prompt feio avisando que o aplicativo n√£o √© confi√°vel em v√°rios casos e os administradores do Workspace podem at√© impedir que as pessoas aceitem aplicativos OAuth. Mais sobre isso na se√ß√£o OAuth.

## Password Spraying

Para testar senhas com todos os e-mails que voc√™ encontrou (ou gerou com base em um padr√£o de nome de e-mail que voc√™ pode ter descoberto), voc√™ pode usar uma ferramenta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing), que usar√° lambdas da AWS para alterar o endere√ßo IP.

## Aplicativos OAuth

O **Google** permite criar aplicativos que podem **interagir em nome dos usu√°rios** com v√°rios **servi√ßos do Google**: Gmail, Drive, GCP...

Ao criar um aplicativo para **agir em nome de outros usu√°rios**, o desenvolvedor precisa criar um **aplicativo OAuth dentro do GCP** e indicar os escopos (permiss√µes) que o aplicativo precisa para acessar os dados dos usu√°rios.\
Quando um **usu√°rio** deseja **usar** esse **aplicativo**, ele ser√° **solicitado** a **aceitar** que o aplicativo ter√° acesso aos seus dados especificados nos escopos.

Esta √© uma maneira muito interessante de **phishing** usu√°rios n√£o t√©cnicos para usar **aplicativos que acessam informa√ß√µes sens√≠veis**, porque eles podem n√£o entender as consequ√™ncias. No entanto, em contas de organiza√ß√µes, existem maneiras de evitar que isso aconte√ßa.

### Prompt de Aplicativo N√£o Verificado

Como mencionado, o Google sempre apresentar√° um **prompt ao usu√°rio para aceitar** as permiss√µes que est√£o dando ao aplicativo em seu nome. No entanto, se o aplicativo for considerado **perigoso**, o Google mostrar√° **primeiro** um **prompt** indicando que √© **perigoso** e **tornando mais dif√≠cil** para o usu√°rio conceder as permiss√µes ao aplicativo.

Esse prompt aparece em aplicativos que:

* Usam qualquer escopo que possa acessar dados privados (Gmail, Drive, GCP, BigQuery...)
* Aplicativos com menos de 100 usu√°rios (aplicativos > 100, um processo de revis√£o tamb√©m √© necess√°rio para deixar de mostrar o prompt n√£o verificado)

### Escopos Interessantes

[Aqui](https://developers.google.com/identity/protocols/oauth2/scopes) voc√™ pode encontrar uma lista de todos os escopos do Google OAuth.

* **cloud-platform**: Visualize e gerencie seus dados em v√°rios servi√ßos da **Google Cloud Platform**. Voc√™ pode se passar pelo usu√°rio no GCP.
* **directory.readonly**: Veja e fa√ßa download do diret√≥rio GSuite da sua organiza√ß√£o. Obtenha nomes, telefones, URLs de calend√°rio de todos os usu√°rios.

## Scripts de Aplicativos

Os desenvolvedores podem criar Scripts de Aplicativos e configur√°-los como um projeto independente ou vincul√°-los ao Google Docs/Sheets/Slides/Forms. Os Scripts de Aplicativos s√£o c√≥digos que ser√£o acionados quando um usu√°rio com permiss√£o de editor acessar o documento (e ap√≥s aceitar o prompt OAuth)

No entanto, mesmo que o aplicativo n√£o seja verificado, existem algumas maneiras de n√£o mostrar esse prompt:

* Se o editor do aplicativo estiver no mesmo Workspace que o usu√°rio que est√° acessando-o
* Se o script estiver em uma unidade do usu√°rio
### Bypass de Confirma√ß√£o de C√≥pia de Documento N√£o Verificado

Quando voc√™ cria um link para compartilhar um documento, um link semelhante a este √© criado: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Se voc√™ **alterar** o final **"/edit"** para **"/copy"**, em vez de acess√°-lo, o Google ir√° perguntar se voc√™ deseja **gerar uma c√≥pia do documento**.

{% hint style="warning" %}
Se algu√©m criar uma **c√≥pia** desse **documento** que **contenha o App Script**, ele tamb√©m estar√° **copiando o App Script**, portanto, quando ele **abrir** a **planilha copiada**, a **solicita√ß√£o regular de OAuth** aparecer√°, **burlando a solicita√ß√£o n√£o verificada**, porque **o usu√°rio agora √© o autor do App Script do arquivo copiado**.
{% endhint %}

Este m√©todo tamb√©m pode burlar a restri√ß√£o do administrador do Workspace:

Mas pode ser prevenido com:

### Bypass de Confirma√ß√£o de Documento Compartilhado N√£o Verificado

Al√©m disso, se algu√©m **compartilhar** com voc√™ um documento com **acesso de edi√ß√£o**, voc√™ pode gerar **App Scripts dentro do documento** e o **PROPRIET√ÅRIO (criador) do documento ser√° o propriet√°rio do App Script**.

{% hint style="warning" %}
Isso significa que o **criador do documento aparecer√° como criador de qualquer App Script** que qualquer pessoa com acesso de edi√ß√£o criar dentro dele.

Isso tamb√©m significa que o **App Script ser√° confi√°vel pelo ambiente do Workspace** do criador do documento.
{% endhint %}

{% hint style="danger" %}
Isso tamb√©m significa que, se um **App Script j√° existir** e as pessoas tiverem **concedido acesso**, qualquer pessoa com permiss√£o de **Editor** no documento pode **modific√°-lo e abusar desse acesso**.\
Para abusar disso, voc√™ tamb√©m precisa que as pessoas acionem o App Script. E uma dica interessante √© **publicar o script como um aplicativo da web**. Quando as **pessoas** que j√° concederam **acesso** ao App Script acessarem a p√°gina da web, elas ir√£o **acionar o App Script** (isso tamb√©m funciona usando tags `<img>`).
{% endhint %}

## P√≥s-Explora√ß√£o

### Privil√©gios de Grupo do Google

Por padr√£o, em um workspace, um **grupo** pode ser **acessado livremente** por qualquer membro da organiza√ß√£o.\
O Workspace tamb√©m permite **conceder permiss√µes a grupos** (at√© mesmo permiss√µes do GCP), portanto, se os grupos puderem ser ingressados e tiverem permiss√µes extras, um invasor pode **abusar desse caminho para elevar privil√©gios**.

Potencialmente, voc√™ precisa de acesso ao console para ingressar em grupos que permitem que qualquer pessoa na organiza√ß√£o os ingresse. Verifique as informa√ß√µes dos grupos em [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Pivoteamento do GWS para o GCP

* Ao abusar do **pivoteamento de privil√©gios de grupos do Google**, voc√™ pode conseguir elevar para um grupo com algum tipo de acesso privilegiado ao GCP.
* Ao abusar das **aplica√ß√µes OAuth**, voc√™ pode se passar por usu√°rios e acessar o GCP em nome deles.

### Pivoteamento do GCP para o GWS

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### Acesso √†s Informa√ß√µes de E-mail dos Grupos

Se voc√™ conseguir **comprometer uma sess√£o de usu√°rio do Google**, a partir de [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups), voc√™ pode ver o hist√≥rico de e-mails enviados para os grupos de e-mail dos quais o usu√°rio √© membro e pode encontrar **credenciais** ou outros **dados sens√≠veis**.

### Takeout - Baixar Tudo o que o Google Sabe sobre uma Conta

Se voc√™ tiver uma **sess√£o dentro da conta do Google da v√≠tima**, poder√° baixar tudo o que o Google sabe sobre essa conta em [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - Baixar todos os dados do Workspace dos usu√°rios

Se uma organiza√ß√£o tiver o **Google Vault ativado**, voc√™ poder√° acessar [**https://vault.google.com**](https://vault.google.com/u/1/) e **baixar** todas as **informa√ß√µes**.

### Download de Contatos

Em [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC), voc√™ pode baixar todos os **contatos** do usu√°rio.

### Cloudsearch

Em [**https://cloudsearch.google.com/**](https://cloudsearch.google.com), voc√™ pode pesquisar **todo o conte√∫do do Workspace** (e-mail, drive, sites...) ao qual um usu√°rio tem acesso. Ideal para **encontrar rapidamente informa√ß√µes sens√≠veis**.

### Currents

Em [**https://currents.google.com/**](https://currents.google.com), voc√™ pode acessar um **Chat do Google**, ent√£o pode encontrar informa√ß√µes sens√≠veis l√°.

### Minera√ß√£o do Google Drive

Ao **compartilhar** um documento, voc√™ pode **especificar** as **pessoas** que podem acess√°-lo uma por uma, **compartilh√°-lo** com toda a **empresa** (**ou** com alguns **grupos** espec√≠ficos) gerando um link.

Ao compartilhar um documento, nas configura√ß√µes avan√ßadas, voc√™ tamb√©m pode **permitir que as pessoas pesquisem** por esse arquivo (por **padr√£o**, isso est√° **desativado**). No entanto, √© importante observar que, uma vez que os usu√°rios visualizam um documento, eles podem pesquis√°-lo.

Por uma quest√£o de simplicidade, a maioria das pessoas gera e compartilha um link em vez de adicionar as pessoas que podem acessar o documento uma por uma.

Algumas maneiras propostas de encontrar todos os documentos:

* Pesquisar em chats internos, f√≥runs...
* **Spider** documentos conhecidos procurando **refer√™ncias** a outros documentos. Voc√™ pode fazer isso dentro de um App Script com o [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

Em [**https://keep.google.com/**](https://keep.google.com), voc√™ pode acessar as anota√ß√µes do usu√°rio, informa√ß√µes **sens√≠veis** podem estar salvas aqui.

### Persist√™ncia dentro de uma conta do Google

Se voc√™ conseguir **comprometer uma sess√£o de usu√°rio do Google** e o usu√°rio tiver **2FA**, voc√™ pode **gerar** uma [**senha de aplicativo**](https://support.google.com/accounts/answer/185833?hl=en) e **regenerar os c√≥digos de backup do 2FA** para saber que, mesmo se o usu√°rio alterar a senha, voc√™ **ainda poder√° acessar a conta dele**. Outra op√ß√£o, **em vez** de **regenerar** os c√≥digos, √© **inscrever seu pr√≥prio aplicativo autenticador** no 2FA.

### Persist√™ncia por meio de Aplicativos OAuth

Se voc√™ **comprometer a conta de um usu√°rio**, voc√™ pode simplesmente **aceitar** conceder todas as permiss√µes poss√≠veis a um **Aplicativo OAuth**. O √∫nico problema √© que o Workspace pode ser configurado para **n√£o permitir aplicativos OAuth externos e/ou internos n√£o revisados**.\
√â bastante comum n√£o confiar por padr√£o em aplicativos OAuth externos, mas confiar nos internos, ent√£o, se voc√™ tiver **permiss√µes suficientes para gerar um novo aplicativo OAuth** dentro da organiza√ß√£o e os aplicativos externos estiverem desativados, gere-o e **use esse novo aplicativo OAuth interno para manter a persist√™ncia**.
### Persist√™ncia via delega√ß√£o

Voc√™ pode simplesmente **delegar a conta** para uma conta diferente controlada pelo atacante.

### Persist√™ncia via aplicativo Android

Se voc√™ tiver uma **sess√£o dentro da conta do Google da v√≠tima**, voc√™ pode navegar at√© a **Play Store** e **instalar malware** que voc√™ j√° enviou diretamente **para o telefone** para manter a persist√™ncia e acessar o telefone da v√≠tima.

### **Persist√™ncia via Gmail**

* Voc√™ pode criar **filtros para ocultar** notifica√ß√µes de seguran√ßa do Google
* from: (no-reply@accounts.google.com) "Alerta de seguran√ßa"
* Ocultar e-mails de redefini√ß√£o de senha
* Criar um **endere√ßo de encaminhamento para encaminhar informa√ß√µes sens√≠veis** (ou tudo) - Voc√™ precisa de acesso manual.
* Criar um endere√ßo de encaminhamento para enviar e-mails que contenham a palavra "senha", por exemplo
* Adicionar **e-mail/recupera√ß√£o de telefone sob controle do atacante**

### **Persist√™ncia via** App Scripts

Voc√™ pode criar **gatilhos baseados em tempo** no App Scripts, ent√£o se o App Script for aceito pelo usu√°rio, ele ser√° **acionado** mesmo **sem o usu√°rio acess√°-lo**.

A documenta√ß√£o menciona que para usar `ScriptApp.newTrigger("funcion")` voc√™ precisa do **escopo** `script.scriptapp`, mas **aparentemente isso n√£o √© necess√°rio** desde que voc√™ tenha declarado algum outro escopo.

### **Administrar Workspace**

Em [**https://admin.google.com**/](https://admin.google.com), voc√™ pode ser capaz de modificar as configura√ß√µes do Workspace de toda a organiza√ß√£o se tiver permiss√µes suficientes.

Voc√™ tamb√©m pode encontrar e-mails pesquisando todas as faturas do usu√°rio em [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recupera√ß√£o de Conta Comprometida

* Sair de todas as sess√µes
* Alterar a senha do usu√°rio
* Gerar novos c√≥digos de backup de autentica√ß√£o de dois fatores (2FA)
* Remover senhas de aplicativos
* Remover aplicativos OAuth
* Remover dispositivos de autentica√ß√£o de dois fatores (2FA)
* Remover encaminhadores de e-mail
* Remover filtros de e-mail
* Remover e-mail/recupera√ß√£o de telefone
* Remover aplicativos Android maliciosos
* Remover delega√ß√µes de conta maliciosas

## Refer√™ncias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: O Poder da M√°gica do Dark Apps Script
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch e Beau Bullock - OK Google, Como Fa√ßo para Red Team GSuite?

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
