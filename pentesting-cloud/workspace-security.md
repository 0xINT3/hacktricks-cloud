# Pentesting de Workspace

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén [**productos oficiales de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Phishing en Workspace

### Metodología de Phishing Genérico

### Phishing en Google Groups

Aparentemente, de forma predeterminada en los miembros de Workspace [**pueden crear grupos**](https://groups.google.com/all-groups) **e invitar a personas a ellos**. Luego puedes modificar el correo electrónico que se enviará al usuario **agregando algunos enlaces**. El **correo electrónico vendrá de una dirección de Google**, por lo que parecerá **legítimo** y es posible que las personas hagan clic en el enlace.

### Phishing en Hangouts

Es posible que puedas hablar directamente con una persona solo teniendo su dirección de correo electrónico o enviar una invitación para hablar. De cualquier manera, puedes modificar una cuenta de correo electrónico, tal vez nombrándola "Seguridad de Google" y agregando algunos logotipos de Google, y las personas pensarán que están hablando con Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **misma técnica** se puede utilizar con **Google Chat**.

### Phishing en Google Docs

Puedes crear un **documento aparentemente legítimo** y en un comentario **mencionar algún correo electrónico (como +usuario@gmail.com)**. Google **enviará un correo electrónico a esa dirección de correo electrónico** notificando que fueron mencionados en el documento. Puedes **poner un enlace en ese documento** para intentar hacer que la persona acceda a él.

### Phishing en Google Calendar

Puedes **crear un evento de calendario** y agregar tantas direcciones de correo electrónico de la empresa que estás atacando como tengas. Programa este evento de calendario en **5 o 15 minutos** a partir del momento actual. Haz que el evento parezca legítimo y **pon un comentario indicando que necesitan leer algo** (con el **enlace de phishing**).\
Para que parezca menos sospechoso:

* Configúralo para que **los destinatarios no puedan ver a las demás personas invitadas**
* **NO envíes correos electrónicos notificando sobre el evento**. Entonces, las personas solo verán su advertencia sobre una reunión en 5 minutos y que necesitan leer ese enlace.
* Aparentemente, utilizando la API, puedes establecer en **Verdadero** que **las personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

### Phishing de OAuth

Cualquiera de las técnicas anteriores se puede utilizar para hacer que el usuario acceda a una **aplicación de OAuth de Google** que solicitará al usuario algún **acceso**. Si el usuario **confía** en la **fuente**, es posible que **confíe** en la **aplicación** (incluso si está solicitando permisos de alto nivel).

Ten en cuenta que Google presenta un mensaje de advertencia poco atractivo que indica que la aplicación no es de confianza en varios casos y los administradores de Workspace incluso pueden evitar que las personas acepten aplicaciones de OAuth. Más información sobre esto en la sección de OAuth.

## Password Spraying

Para probar contraseñas con todos los correos electrónicos que encontraste (o que has generado en función de un patrón de nombre de correo electrónico que hayas descubierto), puedes usar una herramienta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing), que utilizará AWS lambdas para cambiar la dirección IP.

## Aplicaciones de OAuth

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Cuando se crea una aplicación para **actuar en nombre de otros usuarios**, el desarrollador debe crear una **aplicación de OAuth dentro de GCP** e indicar los alcances (permisos) que la aplicación necesita para acceder a los datos de los usuarios.\
Cuando un **usuario** quiere **usar** esa **aplicación**, se le pedirá que **acepte** que la aplicación tendrá acceso a sus datos especificados en los alcances.

Esta es una forma muy interesante de **phishing** a usuarios no técnicos para que utilicen **aplicaciones que acceden a información sensible**, porque es posible que no comprendan las consecuencias. Sin embargo, en las cuentas de las organizaciones, hay formas de evitar que esto suceda.

### Mensaje de aplicación no verificada

Como se mencionó, Google siempre presentará un **mensaje al usuario para que acepte** los permisos que está otorgando a la aplicación en su nombre. Sin embargo, si la aplicación se considera **peligrosa**, Google mostrará **primero** un **mensaje** que indica que es **peligrosa** y **dificulta más** que el usuario otorgue los permisos a la aplicación.

Este mensaje aparece en aplicaciones que:

* Utilizan cualquier alcance que pueda acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (las aplicaciones > 100 también requieren un proceso de revisión para dejar de mostrar el mensaje de no verificada)

### Alcances interesantes

[**Aquí**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los alcances de OAuth de Google.

* **cloud-platform**: Ver y administrar tus datos en los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **directory.readonly**: Ver y descargar el directorio de GSuite de tu organización. Obtén nombres, teléfonos, URL de calendario de todos los usuarios.

## Scripts de Aplicaciones

Los desarrolladores pueden crear Scripts de Aplicaciones y configurarlos como un proyecto independiente o vincularlos a Google Docs/Sheets/Slides/Forms. Los Scripts de Aplicaciones son código que se activará cuando un usuario con permisos de editor acceda al documento (y después de aceptar el mensaje de OAuth)

Sin embargo, incluso si la aplicación no está verificada, hay un par de formas de no mostrar ese mensaje:

* Si el editor de la aplicación está en el mismo Workspace que el usuario que accede a ella
* Si el script está en una unidad del usuario
### Bypass de la solicitud de copia de documento no verificado

Cuando creas un enlace para compartir un documento, se crea un enlace similar a este: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si **cambias** el final **"/edit"** por **"/copy"**, en lugar de acceder a él, Google te preguntará si quieres **generar una copia del documento**.

{% hint style="warning" %}
Si alguien crea una **copia** de ese **documento** que **contiene el App Script**, también estará **copiando el App Script**, por lo tanto, cuando **abre** la **hoja de cálculo copiada**, aparecerá la **solicitud regular de OAuth**, **burlando la solicitud no verificada**, porque **el usuario ahora es el autor del App Script del archivo copiado**.
{% endhint %}

Este método también puede eludir la restricción del administrador de Workspace:

Pero se puede prevenir con:

### Bypass de la solicitud no verificada de documento compartido

Además, si alguien te **comparte** un documento con **acceso de editor**, puedes generar **App Scripts dentro del documento** y el **PROPIETARIO (creador) del documento será el propietario del App Script**.

{% hint style="warning" %}
Esto significa que el **creador del documento aparecerá como creador de cualquier App Script** que cualquier persona con acceso de editor cree dentro de él.

Esto también significa que el **App Script será confiable para el entorno de Workspace** del creador del documento.
{% endhint %}

{% hint style="danger" %}
Esto también significa que si ya existía un **App Script** y las personas han **concedido acceso**, cualquier persona con permiso de **Editor** en el documento puede **modificarlo y abusar de ese acceso**.\
Para abusar de esto, también necesitas que las personas activen el App Script. Y un truco interesante es **publicar el script como una aplicación web**. Cuando las **personas** que ya han **concedido acceso** al App Script accedan a la página web, **activarán el App Script** (esto también funciona usando etiquetas `<img>`).
{% endhint %}

## Post-Explotación

### Google Groups Privesc

De forma predeterminada, en Workspace un **grupo** puede ser **accedido libremente** por cualquier miembro de la organización.\
Workspace también permite **conceder permisos a grupos** (incluso permisos de GCP), por lo que si los grupos pueden unirse y tienen permisos adicionales, un atacante puede **abusar de esa ruta para escalar privilegios**.

Potencialmente necesitas acceso a la consola para unirte a grupos que permitan unirse a cualquier persona en la organización. Verifica la información de los grupos en [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Pivoteo de GWS a GCP

* Abusando de la **escalada de privilegios de grupos de Google**, es posible escalar a un grupo con algún tipo de acceso privilegiado a GCP.
* Abusando de las **aplicaciones OAuth**, es posible suplantar a los usuarios y acceder a GCP en su nombre.

### Pivoteo de GCP a GWS

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### Acceso a información de correo de grupos

Si logras **comprometer una sesión de usuario de Google**, desde [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) puedes ver el historial de correos enviados a los grupos de correo de los que el usuario es miembro, y podrías encontrar **credenciales** u otros **datos sensibles**.

### Takeout: Descargar todo lo que Google sabe sobre una cuenta

Si tienes una **sesión dentro de la cuenta de Google de la víctima**, puedes descargar todo lo que Google guarda sobre esa cuenta desde [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault: Descargar todos los datos de Workspace de los usuarios

Si una organización tiene **Google Vault habilitado**, es posible acceder a [**https://vault.google.com**](https://vault.google.com/u/1/) y **descargar** toda la **información**.

### Descarga de contactos

Desde [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) puedes descargar todos los **contactos** del usuario.

### Cloudsearch

En [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) puedes buscar **a través de todo el contenido de Workspace** (correo electrónico, Drive, sitios...) al que un usuario tiene acceso. Ideal para **encontrar rápidamente información sensible**.

### Currents

En [**https://currents.google.com/**](https://currents.google.com) puedes acceder a un **Chat de Google**, por lo que podrías encontrar información sensible allí.

### Minería de Google Drive

Cuando **compartes** un documento, puedes **especificar** las **personas** que pueden acceder a él una por una, **compartirlo** con toda tu **empresa** (**o** con algunos **grupos** específicos) generando un enlace.

Al compartir un documento, en la configuración avanzada también puedes **permitir que las personas busquen** este archivo (por **defecto**, esto está **desactivado**). Sin embargo, es importante tener en cuenta que una vez que los usuarios ven un documento, pueden buscarlo.

Por simplicidad, la mayoría de las personas generarán y compartirán un enlace en lugar de agregar a las personas que pueden acceder al documento una por una.

Algunas formas propuestas de encontrar todos los documentos:

* Buscar en el chat interno, foros...
* **Rastrear** documentos conocidos buscando **referencias** a otros documentos. Puedes hacer esto dentro de un App Script con [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

En [**https://keep.google.com/**](https://keep.google.com) puedes acceder a las notas del usuario, aquí podría haber **información sensible** guardada.

### Persistencia dentro de una cuenta de Google

Si logras **comprometer una sesión de usuario de Google** y el usuario tiene **2FA**, puedes **generar** una [**contraseña de aplicación**](https://support.google.com/accounts/answer/185833?hl=en) y **regenerar los códigos de respaldo de 2FA** para asegurarte de que incluso si el usuario cambia la contraseña, **podrás acceder a su cuenta**. Otra opción, **en lugar** de **regenerar** los códigos, es **inscribir tu propia aplicación de autenticación** en el 2FA.

### Persistencia a través de aplicaciones OAuth

Si has **comprometido la cuenta de un usuario**, simplemente puedes **aceptar** otorgar todos los permisos posibles a una **aplicación OAuth**. El único problema es que Workspace puede estar configurado para **no permitir aplicaciones OAuth externas y/o internas no revisadas**.\
Es bastante común no confiar por defecto en las aplicaciones OAuth externas pero confiar en las internas, por lo que si tienes **suficientes permisos para generar una nueva aplicación OAuth** dentro de la organización y las aplicaciones externas están deshabilitadas, genera una y **utiliza esa nueva aplicación OAuth interna para mantener la persistencia**.
### Persistencia mediante delegación

Simplemente puedes **delegar la cuenta** a una cuenta diferente controlada por el atacante.

### Persistencia mediante la aplicación de Android

Si tienes una **sesión dentro de la cuenta de Google de la víctima**, puedes navegar hasta la **Play Store** e **instalar malware** que ya has subido directamente **al teléfono** para mantener la persistencia y acceder al teléfono de la víctima.

### **Persistencia mediante Gmail**

* Puedes crear **filtros para ocultar** las notificaciones de seguridad de Google.
* from: (no-reply@accounts.google.com) "Alerta de seguridad"
* Ocultar correos electrónicos de restablecimiento de contraseña.
* Crear una **dirección de reenvío para enviar información sensible** (o todo) - Necesitas acceso manual.
* Crear una dirección de reenvío para enviar correos electrónicos que contengan la palabra "contraseña", por ejemplo.
* Agregar una dirección de correo electrónico/teléfono de recuperación bajo el control del atacante.

### **Persistencia mediante App Scripts**

Puedes crear **disparadores basados en el tiempo** en App Scripts, por lo que si el App Script es aceptado por el usuario, se **activará** incluso **sin que el usuario lo acceda**.

La documentación menciona que para usar `ScriptApp.newTrigger("funcion")` necesitas el **alcance** `script.scriptapp`, pero **aparentemente eso no es necesario** siempre y cuando hayas declarado algún otro alcance.

### **Administrar Workspace**

En [**https://admin.google.com**/](https://admin.google.com), es posible que puedas modificar la configuración de Workspace de toda la organización si tienes suficientes permisos.

También puedes encontrar correos electrónicos buscando en todas las facturas de los usuarios en [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recuperación de una cuenta comprometida

* Cerrar sesión en todas las sesiones.
* Cambiar la contraseña del usuario.
* Generar nuevos códigos de respaldo de 2FA.
* Eliminar contraseñas de aplicaciones.
* Eliminar aplicaciones de OAuth.
* Eliminar dispositivos de 2FA.
* Eliminar reenviadores de correo electrónico.
* Eliminar filtros de correos electrónicos.
* Eliminar direcciones de correo electrónico/teléfonos de recuperación.
* Eliminar aplicaciones de Android maliciosas.
* Eliminar delegaciones de cuentas maliciosas.

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
