# Workspace渗透测试

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## Workspace钓鱼

### 通用钓鱼方法论

### Google Groups钓鱼

显然，默认情况下，Workspace成员[**可以创建群组**](https://groups.google.com/all-groups) **并邀请人加入**。然后，您可以修改将发送给用户的电子邮件，**添加一些链接**。该电子邮件将来自Google地址，因此看起来**合法**，人们可能会点击链接。

### Hangout钓鱼

您可以直接与拥有某人的电子邮件地址的人交谈，或者发送一个邀请进行交谈。无论哪种方式，您都可以修改一个电子邮件帐户，可能将其命名为“Google Security”，并添加一些Google标志，人们会认为他们正在与Google交谈：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

**相同的技术**也可以用于**Google Chat**。

### Google Doc钓鱼

您可以创建一个**看起来合法的文档**，然后在评论中**提及某个电子邮件（例如+user@gmail.com）**。Google将向该电子邮件地址发送一封电子邮件，通知他们在文档中被提及。您可以在该文档中**放置一个链接**，以尝试让人们访问它。

### Google Calendar钓鱼

您可以**创建一个日历事件**，并添加尽可能多的公司电子邮件地址。将此日历事件安排在**当前时间的5或15分钟**后。使事件看起来合法，并**添加一条注释指示他们需要阅读某些内容**（带有**钓鱼链接**）。\
为了使其看起来不那么可疑：

* 设置为**接收者无法看到其他受邀人**
* **不要发送有关事件的电子邮件通知**。然后，人们只会看到关于5分钟内的会议的警告，并且他们需要阅读该链接。
* 显然，使用API可以设置为**True**，即**人们已接受**该事件，甚至可以代表他们**创建评论**。

### OAuth钓鱼

可以使用上述任何技术使用户访问一个**Google OAuth应用程序**，该应用程序将要求用户提供一些**访问权限**。如果用户**信任**该**来源**，他可能会**信任**该**应用程序**（即使它要求高权限的权限）。

请注意，Google会在多种情况下显示一个丑陋的提示，警告该应用程序不受信任，并且Workspace管理员甚至可以阻止人们接受OAuth应用程序。有关此内容的更多信息，请参阅OAuth部分。

## 密码喷洒

为了使用您找到的所有电子邮件测试密码（或者根据您可能发现的电子邮件名称模式生成的电子邮件），您可以使用像[**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing)这样的工具，它将使用AWS lambdas更改IP地址。

## OAuth应用程序

**Google**允许创建可以代表用户与多个**Google服务**进行交互的应用程序：Gmail、Drive、GCP...

在创建一个**代表其他用户操作**的应用程序时，开发人员需要在GCP中创建一个**OAuth应用程序**，并指定应用程序需要访问用户数据的范围（权限）。\
当**用户**想要**使用**该**应用程序**时，他们将被**提示**接受该应用程序将访问在范围中指定的其数据的权限。

这是一种非常有吸引力的方式，可以诱使非技术用户使用**访问敏感信息的应用程序**，因为他们可能不理解后果。但是，在组织帐户中，有办法防止这种情况发生。

### 未验证应用程序提示

如前所述，Google始终会向用户呈现一个**提示**，要求他们接受他们代表应用程序授予的权限。但是，如果应用程序被认为是**危险的**，Google将首先显示一个**提示**，指示它是**危险的**，并**增加了用户授予权限的难度**。

此提示出现在以下应用程序中：

* 使用任何可以访问私人数据的范围（Gmail、Drive、GCP、BigQuery...）
* 少于100个用户的应用程序（对于超过100个用户的应用程序，还需要进行审核以停止显示未验证的提示）

### 有趣的范围

[**在这里**](https://developers.google.com/identity/protocols/oauth2/scopes)您可以找到所有Google OAuth范围的列表。

* **cloud-platform**：在**Google Cloud Platform**服务中查看和管理您的数据。您可以冒充GCP中的用户。
* **directory.readonly**：查看和下载您的组织的GSuite目录。获取所有用户的姓名、电话、日历URL。

## App Scripts

开发人员可以创建App Scripts，并将其设置为独立项目或绑定到Google Docs/Sheets/Slides/Forms。App Scripts是当具有编辑权限的用户访问文档时触发的代码（在接受OAuth提示后）。

但是，即使应用程序未经验证，也有几种方法可以不显示该提示：

* 如果应用程序的发布者与访问它的用户位于同一个Workspace中
* 如果脚本位于用户的驱动器中
### 复制文档未验证提示绕过

当您创建一个共享文档的链接时，会创建一个类似于这样的链接：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
如果您将结尾的 **"/edit"** 改为 **"/copy"**，而不是访问该链接，谷歌会询问您是否要 **生成该文档的副本**。

{% hint style="warning" %}
如果有人创建了一个包含 **应用脚本** 的 **文档副本**，他也将 **复制应用脚本**，因此当他 **打开** 复制的 **电子表格** 时，将出现 **常规 OAuth 提示**，绕过了未验证的提示，因为 **用户现在是复制文件的应用脚本的作者**。
{% endhint %}

这种方法也可以绕过 Workspace 管理员限制：

但可以通过以下方式防止：

### 共享文档未验证提示绕过

此外，如果有人与您共享了具有 **编辑访问权限** 的文档，您可以在文档中生成 **应用脚本**，而文档的 **所有者（创建者）将成为应用脚本的所有者**。

{% hint style="warning" %}
这意味着，文档的 **创建者将被视为任何具有编辑访问权限的人在其中创建的任何应用脚本的创建者**。

这也意味着，应用脚本将受到文档创建者的 Workspace 环境的信任。
{% endhint %}

{% hint style="danger" %}
这也意味着，如果已经存在一个 **应用脚本** 并且人们已经 **授予访问权限**，那么任何具有 **编辑权限** 的人都可以 **修改它并滥用该访问权限**。\
要滥用此功能，您还需要让人们触发应用脚本。一个巧妙的技巧是将脚本 **发布为 Web 应用**。当已经授予应用脚本访问权限的人访问网页时，他们将 **触发应用脚本**（这也适用于使用 `<img>` 标签）。
{% endhint %}

## 渗透后

### Google Groups 特权提升

在 Workspace 中，默认情况下，**组** 可以被组织中的任何成员自由访问。\
Workspace 还允许为组授予权限（甚至是 GCP 权限），因此如果组可以加入并且它们具有额外的权限，攻击者可以 **滥用该路径来提升特权**。

您可能需要访问控制台以加入允许任何人加入组织的组。在 [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) 中检查组信息。

### 从 GWS 到 GCP 的枢轴

* 通过滥用 **Google Groups 特权提升**，您可能能够升级到具有某种特权访问 GCP 的组
* 通过滥用 **OAuth 应用程序**，您可能能够冒充用户并代表他们访问 GCP

### 从 GCP 到 GWS 的枢轴

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### 访问组邮件信息

如果您成功入侵了一个谷歌用户的会话，您可以从 [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) 查看发送到用户所属邮件组的邮件历史记录，并可能找到 **凭据** 或其他 **敏感数据**。

### Takeout - 下载关于账户的所有谷歌数据

如果您在受害者的谷歌账户中有一个会话，您可以从 [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none) 下载谷歌保存的关于该账户的所有数据。

### Vault - 下载用户的所有 Workspace 数据

如果一个组织启用了 **Google Vault**，您可能能够访问 [**https://vault.google.com**](https://vault.google.com/u/1/) 并下载所有信息。

### 下载联系人

从 [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) 您可以下载用户的所有 **联系人**。

### Cloudsearch

在 [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) 中，您可以搜索用户可以访问的所有 Workspace 内容（电子邮件、驱动器、站点...）。非常适合快速查找敏感信息。

### Currents

在 [**https://currents.google.com/**](https://currents.google.com) 中，您可以访问 Google **Chat**，因此您可能会在其中找到敏感信息。

### Google Drive 挖掘

在共享文档时，您可以逐个指定可以访问该文档的 **人员**，也可以通过 **生成链接** 将其与您的 **整个公司**（或某些特定的 **组）** 共享。

在共享文档时，在高级设置中，您还可以 **允许人们搜索** 此文件（默认情况下，此功能是 **禁用的**）。但是，重要的是要注意，一旦用户查看了文档，他们就可以通过搜索找到它。

为了简单起见，大多数人会生成并共享链接，而不是逐个添加可以访问文档的人员。

一些提议的查找所有文档的方法：

* 在内部聊天、论坛中搜索...
* **蜘蛛**已知的文档，搜索对其他文档的引用。您可以使用 [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser) 中的 App Script 来执行此操作。

### **Keep 笔记**

在 [**https://keep.google.com/**](https://keep.google.com) 中，您可以访问用户的笔记，其中可能保存有 **敏感信息**。

### 在谷歌账户中保持持久性

如果您成功入侵了一个谷歌用户的会话，并且该用户启用了 **2FA**，您可以 **生成**一个 [**应用密码**](https://support.google.com/accounts/answer/185833?hl=en) 并 **重新生成 2FA 备份代码**，以确保即使用户更改密码，您仍然能够访问他们的账户。另一种选择是 **注册您自己的身份验证器** 应用程序来代替重新生成代码。

### 通过 OAuth 应用程序保持持久性

如果您已经 **入侵了用户的账户**，您可以选择 **接受** 授予一个 **OAuth 应用程序** 所有可能的权限。唯一的问题是，Workspace 可以配置为 **禁止未经审核的外部和/或内部 OAuth 应用程序**。\
通常情况下，默认情况下不信任外部 OAuth 应用程序，但信任内部应用程序，因此如果您具有足够的权限在组织内生成一个新的 OAuth 应用程序，并且外部应用程序被禁止，则生成该应用程序并使用该新的内部 OAuth 应用程序来保持持久性。
### 持久性通过委派

您可以将帐户**委派给攻击者控制的不同帐户**。

### 持久性通过Android应用

如果您在受害者的Google帐户中有一个**会话**，您可以浏览到**Play商店**并**安装恶意软件**，您已经直接**上传到手机**以保持持久性并访问受害者的手机。

### **持久性通过Gmail**

* 您可以创建**过滤器来隐藏**来自Google的安全通知
* from: (no-reply@accounts.google.com) "Security Alert"
* 隐藏密码重置电子邮件
* 创建**转发地址以转发敏感信息**（或全部）- 您需要手动访问。
* 创建一个转发地址，以发送包含单词"password"的电子邮件，例如
* 添加在攻击者控制下的**恢复电子邮件/电话**

### **持久性通过**应用脚本

您可以在应用脚本中创建**基于时间的触发器**，因此，如果用户接受了应用脚本，即使**用户没有访问它**，它也将被**触发**。

文档中提到，要使用`ScriptApp.newTrigger("funcion")`，您需要**范围**`script.scriptapp`，但是**显然这不是必需的**，只要您声明了其他一些范围。

### **管理Workspace**

在[**https://admin.google.com**/](https://admin.google.com)中，如果您拥有足够的权限，您可能能够修改整个组织的Workspace设置。

您还可以通过在[**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)中搜索所有用户的发票来查找电子邮件。

## 帐户被入侵的恢复

* 注销所有会话
* 更改用户密码
* 生成新的2FA备份代码
* 删除应用程序密码
* 删除OAuth应用程序
* 删除2FA设备
* 删除电子邮件转发器
* 删除电子邮件过滤器
* 删除恢复电子邮件/电话
* 删除有问题的Android应用
* 删除有问题的帐户委派

## 参考资料

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
