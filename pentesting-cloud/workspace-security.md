# S√©curit√© de l'espace de travail

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Phishing de l'espace de travail

### M√©thodologie de phishing g√©n√©rique

### Phishing de Google Groups

Apparemment, par d√©faut dans les membres de l'espace de travail, [**peuvent cr√©er des groupes**](https://groups.google.com/all-groups) **et inviter des personnes √† les rejoindre**. Vous pouvez ensuite modifier l'e-mail qui sera envoy√© √† l'utilisateur **en ajoutant des liens**. L'**e-mail proviendra d'une adresse Google**, il aura donc l'air **l√©gitime** et les gens pourraient cliquer sur le lien.

### Phishing de Hangout

Vous pourriez √™tre en mesure de parler directement √† une personne en ayant simplement son adresse e-mail ou d'envoyer une invitation pour parler. Dans les deux cas, vous pouvez modifier un compte de messagerie en le nommant peut-√™tre "Google Security" et en ajoutant quelques logos Google, et les gens penseront qu'ils parlent √† Google : [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **m√™me technique** peut √™tre utilis√©e avec **Google Chat**.

### Phishing de Google Doc

Vous pouvez cr√©er un **document apparemment l√©gitime** et dans un commentaire **mentionner un e-mail (comme +user@gmail.com)**. Google **enverra un e-mail √† cette adresse e-mail** pour informer que l'utilisateur a √©t√© mentionn√© dans le document. Vous pouvez **mettre un lien dans ce document** pour essayer de faire acc√©der la personne.

### Phishing de Google Calendar

Vous pouvez **cr√©er un √©v√©nement de calendrier** et ajouter autant d'adresses e-mail de l'entreprise que vous avez. Planifiez cet √©v√©nement de calendrier dans **5 ou 15 minutes** √† partir de l'heure actuelle. Rendez l'√©v√©nement l√©gitime et **mettez un commentaire indiquant qu'ils doivent lire quelque chose** (avec le **lien de phishing**).\
Pour que cela paraisse moins suspect :

* Configurez-le de sorte que **les destinataires ne puissent pas voir les autres personnes invit√©es**
* Ne **pas envoyer d'e-mails** pour notifier de l'√©v√©nement. Les gens ne verront alors que leur avertissement concernant une r√©union dans 5 minutes et qu'ils doivent lire ce lien.
* Apparemment, en utilisant l'API, vous pouvez d√©finir sur **True** que les **personnes** ont **accept√©** l'√©v√©nement et m√™me cr√©er des **commentaires en leur nom**.

### Phishing OAuth

Toute technique pr√©c√©dente peut √™tre utilis√©e pour amener l'utilisateur √† acc√©der √† une **application Google OAuth** qui demandera √† l'utilisateur un **acc√®s**. Si l'utilisateur **fait confiance** √† la **source**, il pourrait **faire confiance** √† l'**application** (m√™me si elle demande des autorisations √† haut niveau).

Notez que Google pr√©sente une fen√™tre d'alerte laide avertissant que l'application n'est pas fiable dans plusieurs cas et que les administrateurs de l'espace de travail peuvent m√™me emp√™cher les personnes d'accepter les applications OAuth. Plus d'informations dans la section OAuth.

## Password Spraying

Afin de tester les mots de passe avec tous les e-mails que vous avez trouv√©s (ou que vous avez g√©n√©r√©s en fonction d'un mod√®le de nom d'e-mail que vous avez peut-√™tre d√©couvert), vous pouvez utiliser un outil comme [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing) qui utilisera des lambdas AWS pour changer d'adresse IP.

## Applications OAuth

**Google** permet de cr√©er des applications qui peuvent **interagir au nom des utilisateurs** avec plusieurs **services Google** : Gmail, Drive, GCP...

Lors de la cr√©ation d'une application pour **agir au nom d'autres utilisateurs**, le d√©veloppeur doit cr√©er une **application OAuth dans GCP** et indiquer les √©tendues (autorisations) dont l'application a besoin pour acc√©der aux donn√©es des utilisateurs.\
Lorsqu'un **utilisateur** veut **utiliser** cette **application**, il sera **invit√©** √† **accepter** que l'application aura acc√®s √† ses donn√©es sp√©cifi√©es dans les √©tendues.

C'est une fa√ßon tr√®s int√©ressante de **phisher** les utilisateurs non techniques pour qu'ils utilisent des **applications qui acc√®dent √† des informations sensibles** car ils pourraient ne pas comprendre les cons√©quences. Cependant, dans les comptes des organisations, il existe des moyens d'emp√™cher cela de se produire.

### Fen√™tre d'alerte d'application non v√©rifi√©e

Comme mentionn√© pr√©c√©demment, Google pr√©sentera toujours une **fen√™tre d'alerte √† l'utilisateur pour accepter** les autorisations qu'il donne √† l'application en son nom. Cependant, si l'application est consid√©r√©e comme **dangereuse**, Google affichera **d'abord** une **fen√™tre d'alerte indiquant qu'elle est dangereuse** et **rendant plus difficile** pour l'utilisateur d'accorder les autorisations √† l'application.

Cette fen√™tre d'alerte appara√Æt dans les applications qui :

* Utilisent une √©tendue qui peut acc√©der √† des donn√©es priv√©es (Gmail, Drive, GCP, BigQuery...)
* Applications avec moins de 100 utilisateurs (les applications > 100 n√©cessitent √©galement un processus d'examen pour arr√™ter l'affichage de la fen√™tre d'alerte non v√©rifi√©e)

### √âtendues int√©ressantes

[**Ici**](https://developers.google.com/identity/protocols/oauth2/scopes) vous pouvez trouver une liste de toutes les √©tendues Google OAuth.

* **cloud-platform** : Afficher et g√©rer vos donn√©es sur plusieurs services de la **plateforme Google Cloud**. Vous pouvez vous faire passer pour l'utilisateur dans GCP.
* **directory.readonly** : Voir et t√©l√©charger l'annuaire GSuite de votre organisation. Obtenez les noms, les num√©ros de t√©l√©phone, les URL de calendrier de tous les utilisateurs.

## Scripts d'application

Les d√©veloppeurs peuvent cr√©er des scripts d'application et les d√©finir comme projet autonome ou les lier √† Google Docs/Sheets/Slides/Forms. Les scripts d'application sont du code qui sera d√©clench√© lorsqu'un utilisateur avec une autorisation d'√©diteur acc√®de au document (et apr√®s avoir accept√© la fen√™tre d'alerte OAuth)

Cependant, m√™me si l'application n'est pas v√©rifi√©e, il existe quelques moyens de ne pas afficher cette fen√™tre d'alerte :

* Si l'√©diteur de l'application est dans le m√™me espace de travail que l'utilisateur qui y acc√®de
* Si le script est dans un lecteur de l'utilisateur

### Contournement de la fen√™tre d'alerte non v√©rifi√©e de la copie de document

Lorsque vous cr√©ez un lien pour partager un document, un lien similaire √† celui-ci est cr√©√© : `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si vous **changez** la fin **"/edit"** en **"/copy"**, au lieu d'y acc√©der, Google vous demandera si vous voulez **g√©n√©rer une copie du document.**

{% hint style="warning" %}
Si quelqu'un cr√©e une **copie** de ce **document** qui **contenait le script d'application
## Post-Exploitation

### Google Groups Privesc

Par d√©faut dans Workspace, un **groupe** peut √™tre **librement accessible** par n'importe quel membre de l'organisation.\
Workspace permet √©galement d'**accorder des autorisations aux groupes** (m√™me des autorisations GCP), donc si des groupes peuvent √™tre rejoints et qu'ils ont des autorisations suppl√©mentaires, un attaquant peut **abuser de ce chemin pour escalader les privil√®ges**.

Vous avez potentiellement besoin d'acc√©der √† la console pour rejoindre des groupes qui permettent √† n'importe qui dans l'organisation de les rejoindre. V√©rifiez les informations des groupes dans [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Privesc to GCP Summary

* En abusant de la **privesc des groupes Google**, vous pourriez √™tre en mesure d'escalader vers un groupe avec un certain type d'acc√®s privil√©gi√© √† GCP
* En abusant des **applications OAuth**, vous pourriez √™tre en mesure d'usurper l'identit√© des utilisateurs et d'acc√©der √† GCP en leur nom

### Acc√©der aux informations de messagerie des groupes

Si vous avez r√©ussi √† **compromettre une session utilisateur Google**, √† partir de [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups), vous pouvez voir l'historique des courriels envoy√©s aux groupes de messagerie dont l'utilisateur est membre, et vous pourriez trouver des **informations d'identification** ou d'autres **donn√©es sensibles**.

### Takeout - T√©l√©charger tout ce que Google sait sur un compte

Si vous avez une **session √† l'int√©rieur du compte Google de la victime**, vous pouvez t√©l√©charger tout ce que Google enregistre √† propos de ce compte depuis [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - T√©l√©charger toutes les donn√©es Workspace des utilisateurs

Si une organisation a activ√© **Google Vault**, vous pourriez √™tre en mesure d'acc√©der √† [**https://vault.google.com**](https://vault.google.com/u/1/) et de **t√©l√©charger** toutes les **informations**.

### T√©l√©chargement de contacts

Depuis [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC), vous pouvez t√©l√©charger tous les **contacts** de l'utilisateur.

### Cloudsearch

Dans [**https://cloudsearch.google.com/**](https://cloudsearch.google.com), vous pouvez simplement rechercher **dans tout le contenu Workspace** (e-mail, drive, sites...) auquel un utilisateur a acc√®s. Id√©al pour **trouver rapidement des informations sensibles**.

### Currents

Dans [**https://currents.google.com/**](https://currents.google.com), vous pouvez acc√©der √† un **chat Google**, vous pourriez donc trouver des informations sensibles ici.

### Exploration de Google Drive

Lorsque vous **partagez** un document, vous pouvez **sp√©cifier** les **personnes** qui peuvent y acc√©der une par une, le **partager** avec toute votre entreprise (**ou** avec certains groupes sp√©cifiques) en **g√©n√©rant un lien**.

Lorsque vous partagez un document, dans les param√®tres avanc√©s, vous pouvez √©galement **autoriser les personnes √† rechercher** ce fichier (par **d√©faut**, cela est **d√©sactiv√©**). Cependant, il est important de noter que d√®s que les utilisateurs consultent un document, ils peuvent le rechercher.

Pour simplifier, la plupart des gens g√©n√®rent et partagent un lien au lieu d'ajouter les personnes qui peuvent acc√©der au document une par une.

Voici quelques fa√ßons propos√©es pour trouver tous les documents :

* Recherchez dans le chat interne, les forums...
* **Spider** les **documents** connus en recherchant des **r√©f√©rences** √† d'autres documents. Vous pouvez le faire dans un script d'application avec [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Prendre des notes**

Dans [**https://keep.google.com/**](https://keep.google.com), vous pouvez acc√©der aux notes de l'utilisateur, des **informations sensibles** peuvent √™tre enregistr√©es ici.

### Persistance √† l'int√©rieur d'un compte Google

Si vous avez r√©ussi √† **compromettre une session utilisateur Google** et que l'utilisateur avait **2FA**, vous pouvez **g√©n√©rer** un [**mot de passe d'application**](https://support.google.com/accounts/answer/185833?hl=en) et **r√©g√©n√©rer les codes de sauvegarde 2FA** pour savoir que m√™me si l'utilisateur change le mot de passe, vous **pourrez acc√©der √† son compte**. Une autre option **au lieu** de **r√©g√©n√©rer** les codes est de **vous inscrire √† votre propre application d'authentification** dans le 2FA.

### Persistance via les applications OAuth

Si vous avez **compromis le compte d'un utilisateur**, vous pouvez simplement **accepter** d'accorder toutes les autorisations possibles √† une **application OAuth**. Le seul probl√®me est que Workspace peut √™tre configur√© pour **interdire les applications OAuth externes et/ou internes non examin√©es.**\
Il est assez courant de ne pas faire confiance par d√©faut aux applications OAuth externes mais de faire confiance aux applications internes, donc si vous avez **suffisamment d'autorisations pour g√©n√©rer une nouvelle application OAuth** √† l'int√©rieur de l'organisation et que les applications externes sont interdites, g√©n√©rez-la et **utilisez cette nouvelle application OAuth interne pour maintenir la persistance**.

### Persistance via d√©l√©gation

Vous pouvez simplement **d√©l√©guer le compte** √† un compte diff√©rent contr√¥l√© par l'attaquant.

### Persistance via une application Android

Si vous avez une **session √† l'int√©rieur du compte Google de la victime**, vous pouvez naviguer vers le **Play Store** et **installer un logiciel malveillant** que vous avez d√©j√† t√©l√©charg√© directement **sur le t√©l√©phone** pour maintenir la persistance et acc√©der au t√©l√©phone de la victime.

### **Persistance via Gmail**

* Vous pouvez cr√©er des **filtres pour masquer** les notifications de s√©curit√© de Google
  * from: (no-reply@accounts.google.com) "Security Alert"
  * Masquer les e-mails de r√©initialisation de mot de passe
* Cr√©er une **adresse de transfert pour transf√©rer des informations sensibles** (ou tout) - Vous avez besoin d'un acc√®s manuel.
  * Cr√©ez une adresse de transfert pour envoyer des e-mails contenant le mot "mot de passe", par exemple
* Ajouter une **adresse de r√©cup√©ration/t√©l√©phone sous le contr√¥le des attaquants**

### **Persistance via les scripts d'application**

Vous pouvez cr√©er des **d√©clencheurs bas√©s sur le temps** dans les scripts d'application, donc si le script d'application est accept√© par l'utilisateur, il sera **d√©clench√©** m√™me **sans que l'utilisateur y acc√®de**.

Les documents mentionnent que pour utiliser `ScriptApp.newTrigger("funcion")`, vous avez besoin de la **port√©e** `script.scriptapp`, mais **apparemment cela n'est pas n√©cessaire** tant que vous avez d√©clar√© une autre port√©e.

### **Administrer Workspace**

Dans [**https://admin.google.com**/](https://admin.google.com), vous pourriez √™tre en mesure de modifier les param√®tres Workspace de toute l'organisation si vous avez suffisamment d'autorisations.

Vous pouvez √©galement trouver des e-mails en recherchant dans toutes les factures de l'utilisateur dans [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## R√©cup√©ration d'un compte compromis

* D√©connectez toutes les sessions
* Changer le mot de passe de l'utilisateur
* G√©n√©rer de nouveaux codes de sauvegarde 2FA
* Supprimer les mots de passe d'application
* Supprimer les applications OAuth
* Supprimer les appareils 2FA
* Supprimer les transferts d'e-mails
* Supprimer les filtres d'e-mails
* Supprimer les adresses de r√©cup√©ration/t√©l√©phones
* Supprimer les mauvaises applications Android
* Supprimer les d√©l√©gations de compte malveillantes

## R√©f√©rences

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop