# Seguran√ßa do Workspace

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Phishing do Workspace

### Metodologia de Phishing Gen√©rico

### Phishing do Google Groups

Aparentemente, por padr√£o, os membros do workspace [**podem criar grupos**](https://groups.google.com/all-groups) **e convidar pessoas para eles**. Voc√™ pode ent√£o modificar o e-mail que ser√° enviado ao usu√°rio **adicionando alguns links**. O **e-mail vir√° de um endere√ßo do Google**, ent√£o parecer√° **leg√≠timo** e as pessoas podem clicar no link.

### Phishing do Hangout

Voc√™ pode ser capaz de falar diretamente com uma pessoa apenas tendo o endere√ßo de e-mail dela ou enviar um convite para conversar. De qualquer forma, voc√™ pode modificar uma conta de e-mail talvez nomeando-a "Google Security" e adicionando alguns logotipos do Google, e as pessoas pensar√£o que est√£o falando com o Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

Apenas a **mesma t√©cnica** pode ser usada com o **Google Chat**.

### Phishing do Google Doc

Voc√™ pode criar um **documento aparentemente leg√≠timo** e, em um coment√°rio, **mencionar algum e-mail (como +user@gmail.com)**. O Google ir√° **enviar um e-mail para esse endere√ßo de e-mail** notificando que eles foram mencionados no documento. Voc√™ pode **colocar um link nesse documento** para tentar fazer a pessoa acess√°-lo.

### Phishing do Google Calendar

Voc√™ pode **criar um evento de calend√°rio** e adicionar quantos endere√ßos de e-mail da empresa voc√™ tiver. Agende este evento de calend√°rio em **5 ou 15 minutos** a partir do momento atual. Fa√ßa o evento parecer leg√≠timo e **coloque um coment√°rio indicando que eles precisam ler algo** (com o **link de phishing**).\
Para parecer menos suspeito:

* Configure para que **os destinat√°rios n√£o possam ver as outras pessoas convidadas**
* **N√ÉO envie e-mails notificando sobre o evento**. Ent√£o, as pessoas s√≥ ver√£o o aviso sobre uma reuni√£o em 5 minutos e que precisam ler aquele link.
* Aparentemente, usando a API, voc√™ pode definir como **Verdadeiro** que **as pessoas** aceitaram o evento e at√© criar **coment√°rios em nome delas**.

### Phishing do OAuth

Qualquer uma das t√©cnicas anteriores pode ser usada para fazer o usu√°rio acessar um **aplicativo Google OAuth** que ir√° **solicitar** ao usu√°rio algum **acesso**. Se o usu√°rio **confiar** na **fonte**, ele pode **confiar** no **aplicativo** (mesmo que esteja pedindo permiss√µes de alto privil√©gio).

Observe que o Google apresenta um prompt feio avisando que o aplicativo n√£o √© confi√°vel em v√°rios casos e os administradores do Workspace podem at√© impedir que as pessoas aceitem aplicativos OAuth. Mais sobre isso na se√ß√£o OAuth.

## Password Spraying

Para testar senhas com todos os e-mails que voc√™ encontrou (ou gerou com base em um padr√£o de nome de e-mail que voc√™ pode ter descoberto), voc√™ pode usar uma ferramenta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing), que usar√° lambdas da AWS para alterar o endere√ßo IP.

## Aplicativos OAuth

**Google** permite criar aplicativos que podem **interagir em nome de usu√°rios** com v√°rios **servi√ßos do Google**: Gmail, Drive, GCP...

Ao criar um aplicativo para **agir em nome de outros usu√°rios**, o desenvolvedor precisa criar um **aplicativo OAuth dentro do GCP** e indicar os escopos (permiss√µes) que o aplicativo precisa para acessar os dados dos usu√°rios.\
Quando um **usu√°rio** quer **usar** esse **aplicativo**, ele ser√° **solicitado** a **aceitar** que o aplicativo ter√° acesso aos seus dados especificados nos escopos.

Esta √© uma maneira muito interessante de **phishing** usu√°rios n√£o t√©cnicos para usar **aplicativos que acessam informa√ß√µes confidenciais** porque eles podem n√£o entender as consequ√™ncias. No entanto, em contas de organiza√ß√µes, h√° maneiras de impedir que isso aconte√ßa.

### Prompt de aplicativo n√£o verificado

Como mencionado, o Google sempre apresentar√° um **prompt ao usu√°rio para aceitar** as permiss√µes que est√£o dando ao aplicativo em seu nome. No entanto, se o aplicativo for considerado **perigoso**, o Google mostrar√° **primeiro** um **prompt** indicando que √© **perigoso** e **tornando mais dif√≠cil** para o usu√°rio conceder as permiss√µes ao aplicativo.

Este prompt aparece em aplicativos que:

* Use qualquer escopo que possa acessar dados privados (Gmail, Drive, GCP, BigQuery...)
* Aplicativos com menos de 100 usu√°rios (aplicativos > 100, um processo de revis√£o tamb√©m √© necess√°rio para parar de mostrar o prompt n√£o verificado)

### Escopos interessantes

[**Aqui**](https://developers.google.com/identity/protocols/oauth2/scopes) voc√™ pode encontrar uma lista de todos os escopos do Google OAuth.

* **cloud-platform**: Visualize e gerencie seus dados em v√°rios servi√ßos da **Google Cloud Platform**. Voc√™ pode se passar pelo usu√°rio no GCP.
* **directory.readonly**: Veja e baixe o diret√≥rio GSuite da sua organiza√ß√£o. Obtenha nomes, telefones, URLs de calend√°rio de todos os usu√°rios.

## Scripts de aplicativos

Os desenvolvedores podem criar Scripts de aplicativos e definir como um projeto independente ou vincul√°-los ao Google Docs/Sheets/Slides/Forms. Scripts de aplicativos s√£o c√≥digos que ser√£o acionados quando um usu√°rio com permiss√£o de editor acessar o documento (e ap√≥s aceitar o prompt OAuth)

No entanto, mesmo que o aplicativo n√£o seja verificado, h√° algumas maneiras de n√£o mostrar esse prompt:

* Se o editor do aplicativo estiver no mesmo Workspace que o usu√°rio que o acessa
* Se o script estiver em uma unidade do usu√°rio

### Bypass do prompt n√£o verificado de c√≥pia de documento

Quando voc√™ cria um link para compartilhar um documento, um link semelhante a este √© criado: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Se voc√™ **alterar** o final **"/edit"** para **"/copy"**, em vez de acess√°-lo, o Google perguntar√° se voc√™ deseja **gerar uma c√≥pia do documento.**

{% hint style="warning" %}
Se algu√©m criar uma **c√≥pia** desse **documento** que **continha o Script de aplicativo**, ele tamb√©m estar√° **copiando o Script de aplicativo**, portanto, quando ele **abrir** a **planilha copiada**, o **prompt OAuth regular** aparecer√° **burlando o prompt n√£o verificado**, porque **o usu√°rio agora √© o autor do Script de aplicativo do arquivo copiado**.
{% endhint %}

Este m√©todo tamb√©m ser√° capaz de burlar a restri√ß√£o do administrador do Workspace:

Mas pode ser evitado com:

### Bypass do prompt n√£o verificado de documento compartilhado

Al√©m disso, se algu√©m **compartilhou** com voc√™ um documento com **acesso de editor**, voc√™ pode gerar **Scripts de aplicativos dentro do documento** e o
## P√≥s-Explora√ß√£o

### Privil√©gios Elevados em Grupos do Google

Por padr√£o, em Workspace um **grupo** pode ser **acessado livremente** por qualquer membro da organiza√ß√£o.\
Workspace tamb√©m permite **conceder permiss√£o a grupos** (at√© mesmo permiss√µes do GCP), ent√£o se grupos podem ser unidos e eles t√™m permiss√µes extras, um atacante pode **abusar desse caminho para elevar privil√©gios**.

Voc√™ potencialmente precisa de acesso ao console para se juntar a grupos que permitem serem unidos por qualquer pessoa na organiza√ß√£o. Verifique as informa√ß√µes dos grupos em [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Resumo de Privil√©gios Elevados para GCP

* Abusando do **privil√©gio elevado em grupos do Google**, voc√™ pode ser capaz de elevar para um grupo com algum tipo de acesso privilegiado ao GCP.
* Abusando de **aplicativos OAuth**, voc√™ pode ser capaz de se passar por usu√°rios e acessar o GCP em nome deles.

### Acesso √†s Informa√ß√µes de E-mail dos Grupos

Se voc√™ conseguiu **comprometer uma sess√£o de usu√°rio do Google**, a partir de [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) voc√™ pode ver o hist√≥rico de e-mails enviados para os grupos de e-mail dos quais o usu√°rio √© membro, e voc√™ pode encontrar **credenciais** ou outros **dados sens√≠veis**.

### Takeout - Baixe tudo o que o Google sabe sobre uma conta

Se voc√™ tem uma **sess√£o dentro da conta do Google da v√≠tima**, voc√™ pode baixar tudo o que o Google salva sobre essa conta em [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - Baixe todos os dados do Workspace dos usu√°rios

Se uma organiza√ß√£o tem o **Google Vault habilitado**, voc√™ pode ser capaz de acessar [**https://vault.google.com**](https://vault.google.com/u/1/) e **baixar** todas as **informa√ß√µes**.

### Download de Contatos

De [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) voc√™ pode baixar todos os **contatos** do usu√°rio.

### Cloudsearch

Em [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) voc√™ pode pesquisar **todo o conte√∫do do Workspace** (e-mail, drive, sites...) a que um usu√°rio tem acesso. Ideal para **encontrar rapidamente informa√ß√µes sens√≠veis**.

### Currents

Em [**https://currents.google.com/**](https://currents.google.com) voc√™ pode acessar um **Chat** do Google, ent√£o voc√™ pode encontrar informa√ß√µes sens√≠veis l√°.

### Minera√ß√£o do Google Drive

Ao **compartilhar** um documento, voc√™ pode **especificar** as **pessoas** que podem acess√°-lo uma por uma, **compartilh√°-lo** com toda a sua empresa (**ou** com alguns grupos espec√≠ficos) **gerando um link**.

Ao compartilhar um documento, nas configura√ß√µes avan√ßadas voc√™ tamb√©m pode **permitir que as pessoas pesquisem** por este arquivo (por **padr√£o** isso √© **desativado**). No entanto, √© importante notar que uma vez que os usu√°rios visualizam um documento, ele se torna pesquis√°vel por eles.

Por quest√£o de simplicidade, a maioria das pessoas ir√° gerar e compartilhar um link em vez de adicionar as pessoas que podem acessar o documento uma por uma.

Algumas maneiras propostas de encontrar todos os documentos:

* Pesquise no chat interno, f√≥runs...
* **Spider** documentos conhecidos procurando **refer√™ncias** a outros documentos. Voc√™ pode fazer isso dentro de um App Script com [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

Em [**https://keep.google.com/**](https://keep.google.com) voc√™ pode acessar as notas do usu√°rio, **informa√ß√µes sens√≠veis** podem ser salvas aqui.

### Persist√™ncia dentro de uma conta do Google

Se voc√™ conseguiu **comprometer uma sess√£o de usu√°rio do Google** e o usu√°rio tinha **2FA**, voc√™ pode **gerar** uma [**senha de aplicativo**](https://support.google.com/accounts/answer/185833?hl=en) e **regenerar os c√≥digos de backup do 2FA** para saber que mesmo se o usu√°rio mudar a senha, voc√™ **ser√° capaz de acessar a conta deles**. Outra op√ß√£o **em vez** de **regenerar** os c√≥digos √© **inscrever seu pr√≥prio aplicativo autenticador** no 2FA.

### Persist√™ncia via Aplicativos OAuth

Se voc√™ **comprometeu a conta de um usu√°rio**, voc√™ pode simplesmente **aceitar** conceder todas as permiss√µes poss√≠veis a um **Aplicativo OAuth**. O √∫nico problema √© que o Workspace pode ser configurado para **n√£o permitir aplicativos OAuth externos e/ou internos n√£o revisados.**\
√â bastante comum n√£o confiar por padr√£o em aplicativos OAuth externos, mas confiar em aplicativos internos, ent√£o se voc√™ tiver **permiss√µes suficientes para gerar um novo aplicativo OAuth** dentro da organiza√ß√£o e aplicativos externos forem proibidos, gere-o e **use esse novo aplicativo OAuth interno para manter a persist√™ncia**.

### Persist√™ncia via Delega√ß√£o

Voc√™ pode simplesmente **delegar a conta** para uma conta diferente controlada pelo atacante.

### Persist√™ncia via Aplicativo Android

Se voc√™ tem uma **sess√£o dentro da conta do Google da v√≠tima**, voc√™ pode navegar at√© a **Play Store** e **instalar malware** que voc√™ j√° enviou diretamente **para o telefone** para manter a persist√™ncia e acessar o telefone da v√≠tima.

### **Persist√™ncia via Gmail**

* Voc√™ pode criar **filtros para ocultar** notifica√ß√µes de seguran√ßa do Google
  * de: (no-reply@accounts.google.com) "Alerta de Seguran√ßa"
  * Ocultar e-mails de redefini√ß√£o de senha
* Crie um **endere√ßo de encaminhamento para encaminhar informa√ß√µes sens√≠veis** (ou tudo) - Voc√™ precisa de acesso manual.
  * Crie um endere√ßo de encaminhamento para enviar e-mails que contenham a palavra "senha", por exemplo
* Adicione **e-mail/telefone de recupera√ß√£o sob controle do atacante**

### **Persist√™ncia via Scripts de Aplicativos**

Voc√™ pode criar **disparadores baseados em tempo** em Scripts de Aplicativos, ent√£o se o Script de Aplicativo for aceito pelo usu√°rio, ele ser√° **disparado** mesmo **sem o usu√°rio acess√°-lo**.

Os documentos mencionam que para usar `ScriptApp.newTrigger("funcion")` voc√™ precisa do **escopo** `script.scriptapp`, mas **aparentemente isso n√£o √© necess√°rio** desde que voc√™ tenha declarado algum outro escopo.

### **Administrar Workspace**

Em [**https://admin.google.com**/](https://admin.google.com), voc√™ pode ser capaz de modificar as configura√ß√µes do Workspace de toda a organiza√ß√£o se tiver permiss√µes suficientes.

Voc√™ tamb√©m pode encontrar e-mails pesquisando em todas as faturas do usu√°rio em [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recupera√ß√£o de Conta Comprometida

* Fa√ßa logout de todas as sess√µes
* Altere a senha do usu√°rio
* Gere novos c√≥digos de backup do 2FA
* Remova senhas de aplicativos
* Remova aplicativos OAuth
* Remova dispositivos 2FA
* Remova encaminhadores de e-mail
* Remova filtros de e-mail
* Remova e-mails de recupera√ß√£o/telefones
* Remova aplicativos Android maliciosos
* Remova delega√ß√µes de conta maliciosas

## Refer√™ncias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7