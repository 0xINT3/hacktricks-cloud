# AWS - Abusando das Extens√µes do Lambda

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Extens√µes do Lambda

As extens√µes do Lambda aprimoram as fun√ß√µes integrando-se a v√°rias **ferramentas de monitoramento, observabilidade, seguran√ßa e governan√ßa**. Essas extens√µes, adicionadas via [.zip archives usando camadas do Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) ou inclu√≠das em [implanta√ß√µes de imagens de cont√™iner](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), operam em dois modos: **interno** e **externo**.

* As **extens√µes internas** se fundem com o processo de tempo de execu√ß√£o, manipulando seu in√≠cio usando **vari√°veis de ambiente espec√≠ficas do idioma** e **scripts de inv√≥lucro**. Essa personaliza√ß√£o se aplica a uma variedade de tempos de execu√ß√£o, incluindo **Java Correto 8 e 11, Node.js 10 e 12 e .NET Core 3.1**.
* As **extens√µes externas** s√£o executadas como processos separados, mantendo o alinhamento operacional com o ciclo de vida da fun√ß√£o Lambda. Elas s√£o compat√≠veis com v√°rios tempos de execu√ß√£o como **Node.js 10 e 12, Python 3.7 e 3.8, Ruby 2.5 e 2.7, Java Corretto 8 e 11, .NET Core 3.1** e **tempos de execu√ß√£o personalizados**.

Para obter mais informa√ß√µes sobre [**como as extens√µes do lambda funcionam, consulte a documenta√ß√£o**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### Extens√£o Externa para Persist√™ncia, Roubo de Requisi√ß√µes e Modifica√ß√£o de Requisi√ß√µes

Este √© um resumo da t√©cnica proposta neste post: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Foi descoberto que o kernel Linux padr√£o no ambiente de tempo de execu√ß√£o do Lambda √© compilado com as chamadas de sistema ‚Äú**process\_vm\_readv**‚Äù e ‚Äú**process\_vm\_writev**‚Äù. E todos os processos s√£o executados com o mesmo ID de usu√°rio, mesmo o novo processo criado para a extens√£o externa. **Isso significa que uma extens√£o externa tem acesso total de leitura e grava√ß√£o √† mem√≥ria heap do Rapid, por design.**

Al√©m disso, enquanto as extens√µes do Lambda t√™m a capacidade de **se inscrever em eventos de invoca√ß√£o**, a AWS n√£o revela os dados brutos para essas extens√µes. Isso garante que as **extens√µes n√£o possam acessar informa√ß√µes sens√≠veis** transmitidas por meio da solicita√ß√£o HTTP.

O processo Init (Rapid) monitora todas as solicita√ß√µes de API em [http://127.0.0.1:9001](http://127.0.0.1:9001/) enquanto as extens√µes do Lambda s√£o inicializadas e executadas antes da execu√ß√£o de qualquer c√≥digo de tempo de execu√ß√£o, mas ap√≥s o Rapid.

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

A vari√°vel **`AWS_LAMBDA_RUNTIME_API`** indica o **endere√ßo IP** e o **n√∫mero da porta** da API do Rapid para **processos de tempo de execu√ß√£o filho** e extens√µes adicionais.

{% hint style="warning" %}
Ao alterar a vari√°vel de ambiente **`AWS_LAMBDA_RUNTIME_API`** para uma **`porta`** √† qual temos acesso, √© poss√≠vel interceptar todas as a√ß√µes dentro do tempo de execu√ß√£o do Lambda (**homem-no-meio**). Isso √© poss√≠vel porque a extens√£o √© executada com os mesmos privil√©gios que o Rapid Init, e o kernel do sistema permite a **modifica√ß√£o da mem√≥ria do processo**, possibilitando a altera√ß√£o do n√∫mero da porta.
{% endhint %}

Como as **extens√µes s√£o executadas antes de qualquer c√≥digo de tempo de execu√ß√£o**, modificar a vari√°vel de ambiente influenciar√° o processo de tempo de execu√ß√£o (por exemplo, Python, Java, Node, Ruby) ao iniciar. Al√©m disso, **extens√µes carregadas depois** da nossa, que dependem dessa vari√°vel, tamb√©m passar√£o por nossa extens√£o. Essa configura√ß√£o poderia permitir que malware contorne completamente as medidas de seguran√ßa ou extens√µes de registro diretamente dentro do ambiente de tempo de execu√ß√£o.

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

A ferramenta [**lambda-spy**](https://github.com/clearvector/lambda-spy) foi criada para realizar essa **escrita na mem√≥ria** e **roubar informa√ß√µes sens√≠veis** das solicita√ß√µes do lambda, de outras **solicita√ß√µes de extens√µes** e at√© **modific√°-las**.

## Refer√™ncias

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
