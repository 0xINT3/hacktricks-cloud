# AWS - Lambda Extensions 남용

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)로부터 AWS 해킹을 제로부터 전문가까지 배우세요</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나** **HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [Discord 그룹](https://discord.gg/hRep4RUj7f)** 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **해킹 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소로 PR을 제출하세요.

</details>

## Lambda Extensions

Lambda 확장은 다양한 **모니터링, 관측, 보안 및 거버넌스 도구**와 통합하여 함수를 향상시킵니다. 이러한 확장은 Lambda 레이어를 사용하여 [.zip 아카이브를 추가](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)하거나 [컨테이너 이미지 배포](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)에 포함되며 **내부** 및 **외부** 두 가지 모드로 작동합니다.

* **내부 확장**은 **언어별 환경 변수** 및 **래퍼 스크립트**를 사용하여 런타임 프로세스와 병합되어 시작을 조작합니다. 이러한 사용자 정의는 **Java Correto 8 및 11, Node.js 10 및 12, .NET Core 3.1**을 포함한 다양한 런타임에 적용됩니다.
* **외부 확장**은 별도의 프로세스로 실행되어 Lambda 함수의 라이프사이클과 작동을 유지합니다. **Node.js 10 및 12, Python 3.7 및 3.8, Ruby 2.5 및 2.7, Java Corretto 8 및 11, .NET Core 3.1** 및 **사용자 정의 런타임**과 호환됩니다.

자세한 내용은 [**람다 확장이 작동하는 방법을 확인하려면 문서를 확인하세요**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html).

### 지속성, 요청 도용 및 요청 수정을 위한 외부 확장

이것은 이 게시물에서 제안된 기술의 요약입니다: [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

Lambda 런타임 환경의 기본 Linux 커널이 “**process\_vm\_readv**” 및 “**process\_vm\_writev**” 시스템 호출로 컴파일되어 있음이 발견되었습니다. 그리고 모든 프로세스는 동일한 사용자 ID로 실행되며, 외부 확장을 위해 생성된 새 프로세스도 마찬가지입니다. **즉, 외부 확장은 설계상 Rapid의 힙 메모리에 대한 완전한 읽기 및 쓰기 액세스 권한을 갖습니다.**

또한, Lambda 확장은 **호출 이벤트를 구독**할 수 있지만 AWS는 이러한 확장에 원시 데이터를 공개하지 않습니다. 이는 **확장이 HTTP 요청을 통해 전송된 민감한 정보에 액세스할 수 없도록** 보장합니다.

Init (Rapid) 프로세스는 Lambda 확장이 초기화되고 실행되기 전에 모든 API 요청을 [http://127.0.0.1:9001](http://127.0.0.1:9001/)에서 모니터링합니다. 그러나 Lambda 확장은 런타임 코드 실행 전에 Rapid 이후에 초기화되고 실행됩니다.

<figure><img src="../../../../.gitbook/assets/image (90).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

변수 **`AWS_LAMBDA_RUNTIME_API`**는 **자식 런타임 프로세스** 및 추가 확장에게 Rapid API의 **IP 주소** 및 **포트 번호**를 나타냅니다.

{% hint style="warning" %}
**`AWS_LAMBDA_RUNTIME_API`** 환경 변수를 액세스할 수 있는 **`포트`**로 변경함으로써 Lambda 런타임 내의 모든 작업을 가로채는 것이 가능합니다 (**중간자 공격**). 이는 확장이 Rapid Init과 동일한 권한으로 실행되며 시스템 커널이 **프로세스 메모리 수정**을 허용하기 때문에 포트 번호를 변경할 수 있습니다.
{% endhint %}

**확장은 모든 런타임 코드보다 먼저 실행**되므로 환경 변수를 수정하면 런타임 프로세스 (예: Python, Java, Node, Ruby)에 영향을 미칩니다. 또한, 이 변수에 의존하는 **우리 확장 이후에 로드된 확장**은 또한 우리 확장을 통해 경로를 설정할 것입니다. 이 설정은 악성 코드가 런타임 환경 내에서 직접 보안 조치 또는 로깅 확장을 완전히 우회할 수 있도록 할 수 있습니다.

<figure><img src="../../../../.gitbook/assets/image (3) (4).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

[**lambda-spy**](https://github.com/clearvector/lambda-spy) 도구는 해당 **메모리 쓰기**를 수행하고 Lambda 요청, 다른 **확장 요청** 및 심지어 **수정**에서 민감한 정보를 **도용**하는 데 사용되었습니다.

## 참고 자료

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)로부터 AWS 해킹을 제로부터 전문가까지 배우세요</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나** **HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [Discord 그룹](https://discord.gg/hRep4RUj7f)** 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **해킹 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소로 PR을 제출하세요.

</details>
