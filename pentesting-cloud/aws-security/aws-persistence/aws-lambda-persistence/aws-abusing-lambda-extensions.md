# AWS - 滥用Lambda扩展

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Lambda扩展

Lambda扩展通过与各种**监控、可观察性、安全性和治理工具**集成，增强函数。这些扩展通过使用Lambda层的[.zip存档](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)添加或包含在[容器镜像部署](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)中，以**内部**和**外部**两种模式运行。

* **内部扩展**与运行时进程合并，使用**特定于语言的环境变量**和**包装脚本**操纵其启动。此定制适用于一系列运行时，包括**Java Correto 8和11、Node.js 10和12以及.NET Core 3.1**。
* **外部扩展**作为独立进程运行，保持与Lambda函数生命周期的操作对齐。它们与各种运行时兼容，如**Node.js 10和12、Python 3.7和3.8、Ruby 2.5和2.7、Java Corretto 8和11、.NET Core 3.1**以及**自定义运行时**。

有关[**Lambda扩展工作原理的更多信息，请查看文档**](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html)。

### 用于持久性、窃取请求和修改请求的外部扩展

这是对本文中提出的技术的摘要：[https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

发现Lambda运行时环境中的默认Linux内核编译时使用了“**process\_vm\_readv**”和“**process\_vm\_writev**”系统调用。并且所有进程都以相同的用户ID运行，即使是为外部扩展创建的新进程。**这意味着外部扩展通过设计具有对Rapid堆内存的完全读写访问权限。**

此外，虽然Lambda扩展具有**订阅调用事件**的能力，但AWS不会将原始数据透露给这些扩展。这确保**扩展无法访问**通过HTTP请求传输的敏感信息。

Init（Rapid）进程在[http://127.0.0.1:9001](http://127.0.0.1:9001/)监视所有API请求，而Lambda扩展在任何运行时代码执行之前初始化并运行，但在Rapid之后。

<figure><img src="../../../../.gitbook/assets/image (254).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.default.png</a></p></figcaption></figure>

变量**`AWS_LAMBDA_RUNTIME_API`**指示**子运行时进程**和其他扩展Rapid API的**IP**地址和**端口**号。

{% hint style="warning" %}
通过将**`AWS_LAMBDA_RUNTIME_API`**环境变量更改为我们可以访问的**`端口`**，可以拦截Lambda运行时中的所有操作（中间人攻击）。这是可能的，因为扩展以与Rapid Init相同的权限运行，并且系统内核允许**修改进程内存**，从而修改端口号。
{% endhint %}

因为**扩展在任何运行时代码之前运行**，修改环境变量将影响运行时进程（例如Python、Java、Node、Ruby）的启动。此外，**在我们之后加载的扩展**，依赖于此变量，也将通过我们的扩展路由。这种设置可以使恶意软件完全绕过安全措施或直接在运行时环境中绕过日志扩展。

<figure><img src="../../../../.gitbook/assets/image (267).png" alt=""><figcaption><p><a href="https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png">https://www.clearvector.com/blog/content/images/size/w1000/2022/11/2022110801.rapid.mitm.png</a></p></figcaption></figure>

工具[**lambda-spy**](https://github.com/clearvector/lambda-spy)被创建用于执行**内存写入**，从Lambda请求、其他**扩展请求**甚至**修改它们**中窃取敏感信息。

## 参考资料

* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)
* [https://www.clearvector.com/blog/lambda-spy/](https://www.clearvector.com/blog/lambda-spy/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
