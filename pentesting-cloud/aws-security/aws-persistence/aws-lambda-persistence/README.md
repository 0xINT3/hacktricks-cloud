# AWS - Persistencia en Lambda

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Lambda

Para más información revisa:

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Persistencia en Capas de Lambda

Es posible **introducir/backdoor en una capa para ejecutar código arbitrario** cuando se ejecuta la lambda de manera sigilosa:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Persistencia en Extensiones de Lambda

Abusando de las Capas de Lambda también es posible abusar de las extensiones y persistir en la lambda, además de robar y modificar solicitudes.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### A través de políticas de recursos

Es posible otorgar acceso a diferentes acciones de lambda (como invocar o actualizar código) a cuentas externas:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

### Versiones, Alias y Pesos

Una Lambda puede tener **diferentes versiones** (con código diferente en cada versión).\
Luego, puedes crear **diferentes alias con diferentes versiones** de la lambda y asignar diferentes pesos a cada uno.\
De esta manera, un atacante podría crear una **versión 1 con backdoor** y una **versión 2 solo con el código legítimo** y **ejecutar solo la versión 1 en el 1%** de las solicitudes para permanecer oculto.

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### Backdoor en Versión + API Gateway

1. Copia el código original de la Lambda
2. **Crea una nueva versión con backdoor** en el código original (o solo con código malicioso). Publica y **despliega esa versión** en $LATEST
3. Llama al API Gateway relacionado con la lambda para ejecutar el código
4. **Crea una nueva versión con el código original**, Publica y despliega esa **versión** en $LATEST.
5. Esto ocultará el código con backdoor en una versión anterior
6. Ve al API Gateway y **crea un nuevo método POST** (o elige cualquier otro método) que ejecutará la versión con backdoor de la lambda: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
7. Nota el final :1 del arn **indicando la versión de la función** (la versión 1 será la que tiene el backdoor en este escenario).
8. Selecciona el método POST creado y en Acciones selecciona **`Deploy API`**
9. Ahora, cuando **llames a la función vía POST tu Backdoor** será invocado

### Actuador de Cron/Evento

El hecho de que puedas hacer que **las funciones lambda se ejecuten cuando algo sucede o cuando pasa cierto tiempo** hace que lambda sea una forma agradable y común de obtener persistencia y evitar detección.\
Aquí tienes algunas ideas para hacer tu **presencia en AWS más sigilosa creando lambdas**.

* Cada vez que se crea un nuevo usuario, lambda genera una nueva clave de usuario y la envía al atacante.
* Cada vez que se crea un nuevo rol, lambda otorga permisos de asumir rol a usuarios comprometidos.
* Cada vez que se generan nuevos registros de CloudTrail, bórralos o altéralos.

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
