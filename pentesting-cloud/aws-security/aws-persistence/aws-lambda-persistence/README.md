# AWS - Lambda Persistence

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 **@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>

## Lambda

詳細については、次を確認してください：

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistence

Lambdaが実行されるときに**任意のコードを実行するためのレイヤーを導入/バックドアを設置**することが可能です。

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension Persistence

Lambda Layersを悪用することで、拡張機能を悪用してLambdaに侵入し、リクエストを盗み取り、変更することが可能です。

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### リソースポリシーを介して

外部アカウントに異なるLambdaアクション（呼び出しやコードの更新など）へのアクセス権限を付与することが可能です。

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### バージョン、エイリアス、ウェイト

Lambdaには**異なるバージョン**（それぞれ異なるコードを持つ）を持たせることができます。\
その後、Lambdaの**異なるバージョンに異なるエイリアス**を作成し、それぞれに異なるウェイトを設定できます。\
これにより、攻撃者は**バックドア付きのバージョン1**と**正規のコードのみのバージョン2**を作成し、リクエストの**1%でバージョン1を実行**してステルス性を維持することができます。

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### バージョンバックドア + API Gateway

1. Lambdaの元のコードをコピーする
2. 元のコードを**バックドアを仕込んだ新しいバージョンを作成**する（または悪意のあるコードのみを含む）。そのバージョンを$LATESTに**公開およびデプロイする**
3. Lambdaに関連するAPIゲートウェイを呼び出してコードを実行する
4. 元のコードで**新しいバージョンを作成**し、その**バージョン**を$LATESTに公開およびデプロイする
5. これにより、前のバージョンにバックドアコードが隠されます
6. API Gatewayに移動し、**新しいPOSTメソッド**（または他の任意のメソッドを選択）を作成して、バックドア付きのLambdaのバージョンを実行する：`arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
7. arnの最後の:1に注意して、**関数のバージョンを示す**（このシナリオではバージョン1がバックドア付きのものになります）
8. 作成したPOSTメソッドを選択し、アクションで**`APIをデプロイ`**を選択します
9. これで、**POSTを介して関数を呼び出すと、バックドア**が呼び出されます

### Cron/Eventアクチュエータ

**何かが起こったときや時間が経過したときに**Lambda関数を実行できることは、Lambdaを使用して持続性を得て検出を回避する一般的な方法です。\
ここでは、Lambdaを作成して**AWS内での存在をよりステルスにするアイデア**をいくつか紹介します。

* 新しいユーザーが作成されるたびに、Lambdaは新しいユーザーキーを生成して攻撃者に送信します。
* 新しいロールが作成されるたびに、Lambdaは侵害されたユーザーにassume role権限を付与します。
* 新しいcloudtrailログが生成されるたびに、それらを削除/変更します

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 **@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
