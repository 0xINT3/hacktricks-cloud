# AWS - Lambda 지속성

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## Lambda

자세한 정보는 다음을 확인하세요:

{% content-ref url="../../../aws-security/aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../../aws-security/aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer 지속성

람다가 은밀하게 실행될 때 **레이어를 도입/백도어**하여 임의의 코드를 실행할 수 있습니다:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda Extension 지속성

Lambda 레이어를 남용하여 람다에 대한 확장 기능을 남용하고 요청을 도용하고 수정할 수도 있습니다.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### 리소스 정책을 통한 지속성

외부 계정에 대해 람다 작업(호출 또는 코드 업데이트 등)에 대한 액세스 권한을 부여할 수 있습니다:

<figure><img src="../../../../.gitbook/assets/image (2) (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

### 버전, 별칭 및 가중치

람다는 **다른 버전**(각 버전마다 다른 코드)을 가질 수 있습니다.\
그런 다음 람다의 **다른 버전과 함께 다른 별칭**을 생성하고 각각에 다른 가중치를 설정할 수 있습니다.\
이렇게 하면 공격자는 **백도어가 있는 버전 1**과 **합법적인 코드만 있는 버전 2**를 생성하고 요청의 **1%에서만 버전 1을 실행**하여 은밀하게 유지할 수 있습니다.

<figure><img src="../../../../.gitbook/assets/image (2) (2).png" alt=""><figcaption></figcaption></figure>

### 버전 백도어 + API Gateway

1. 람다의 원본 코드를 복사합니다.
2. 원본 코드를 백도어링하는 **새로운 버전을 생성**합니다(또는 악성 코드만 포함). 이 버전을 $LATEST에 **게시 및 배포**합니다.
1. 람다와 관련된 API 게이트웨이를 호출하여 코드를 실행합니다.
3. 원본 코드로 **새로운 버전을 생성**합니다. 이 버전을 $LATEST에 **게시 및 배포**합니다.
1. 이렇게 하면 백도어 코드가 이전 버전에 숨겨집니다.
4. API Gateway로 이동하여 **새로운 POST 메서드**를 생성합니다(또는 다른 메서드를 선택). 이 메서드는 백도어 버전의 람다를 실행합니다: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. arn의 마지막 :1은 함수의 버전을 나타냅니다(이 시나리오에서 버전 1은 백도어 버전입니다).
5. 생성된 POST 메서드를 선택하고 Actions에서 **`API 배포`**를 선택합니다.
6. 이제 **POST를 통해 함수를 호출**하면 백도어가 호출됩니다.

### Cron/Event 실행기

람다 함수를 **무언가가 발생하거나 일정 시간이 경과할 때 실행**할 수 있다는 사실은 람다를 통해 지속성을 얻고 감지를 피하는 일반적인 방법입니다.\
여기에는 람다를 사용하여 AWS에서 **보다 은밀하게 존재**하는 몇 가지 아이디어가 있습니다.

* 새로운 사용자가 생성될 때마다 람다는 새로운 사용자 키를 생성하고 공격자에게 전송합니다.
* 새로운 역할이 생성될 때마다 람다는 손상된 사용자에게 역할 가정 권한을 부여합니다.
* 새로운 클라우드트레일 로그가 생성될 때마다 삭제/변경합니다.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
