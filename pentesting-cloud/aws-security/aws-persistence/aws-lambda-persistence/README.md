# AWS - Lambda Persistenz

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandising**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys einreichen.

</details>

## Lambda

F√ºr weitere Informationen siehe:

{% content-ref url="../../aws-services/aws-lambda-enum.md" %}
[aws-lambda-enum.md](../../aws-services/aws-lambda-enum.md)
{% endcontent-ref %}

### Lambda Layer Persistenz

Es ist m√∂glich, **eine Schicht einzuf√ºhren/backdooren, um beliebigen Code auszuf√ºhren**, wenn die Lambda auf eine heimliche Weise ausgef√ºhrt wird:

{% content-ref url="aws-lambda-layers-persistence.md" %}
[aws-lambda-layers-persistence.md](aws-lambda-layers-persistence.md)
{% endcontent-ref %}

### Lambda-Erweiterungspersistenz

Durch den Missbrauch von Lambda-Schichten ist es auch m√∂glich, Erweiterungen zu missbrauchen und in der Lambda zu persistieren, aber auch Anfragen zu stehlen und zu modifizieren.

{% content-ref url="aws-abusing-lambda-extensions.md" %}
[aws-abusing-lambda-extensions.md](aws-abusing-lambda-extensions.md)
{% endcontent-ref %}

### √úber Ressourcenrichtlinien

Es ist m√∂glich, externen Konten Zugriff auf verschiedene Lambda-Aktionen (wie Aufruf oder Aktualisierung des Codes) zu gew√§hren:

<figure><img src="../../../../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

### Versionen, Aliase & Gewichte

Eine Lambda kann **verschiedene Versionen** haben (mit jeweils unterschiedlichem Code).\
Dann k√∂nnen Sie **verschiedene Aliase mit verschiedenen Versionen** der Lambda erstellen und jedem Alias unterschiedliche Gewichte zuweisen.\
Auf diese Weise k√∂nnte ein Angreifer eine **backdoored Version 1** und eine **Version 2 nur mit dem legitimen Code** erstellen und **nur die Version 1 bei 1%** der Anfragen ausf√ºhren, um unentdeckt zu bleiben.

<figure><img src="../../../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

### Version Backdoor + API Gateway

1. Kopieren Sie den Originalcode der Lambda
2. **Erstellen Sie eine neue Version, die den Originalcode backdoort** (oder nur mit b√∂sartigem Code). Ver√∂ffentlichen und **bereitstellen Sie diese Version** auf $LATEST
1. Rufen Sie das mit der Lambda verbundene API-Gateway auf, um den Code auszuf√ºhren
3. **Erstellen Sie eine neue Version mit dem Originalcode**, ver√∂ffentlichen und bereitstellen Sie diese **Version** auf $LATEST.
1. Dadurch wird der backdoorte Code in einer fr√ºheren Version versteckt
4. Gehen Sie zum API-Gateway und **erstellen Sie eine neue POST-Methode** (oder w√§hlen Sie eine andere Methode), die die backdoorte Version der Lambda ausf√ºhrt: `arn:aws:lambda:us-east-1:<acc_id>:function:<func_name>:1`
1. Beachten Sie das abschlie√üende :1 der arn, das **die Version der Funktion angibt** (Version 1 wird in diesem Szenario die backdoorte sein).
5. W√§hlen Sie die erstellte POST-Methode aus und w√§hlen Sie unter Aktionen **`API bereitstellen`**
6. Wenn Sie jetzt die Funktion √ºber POST aufrufen, wird Ihr Backdoor **aufgerufen**

### Cron/Event-Aktor

Die Tatsache, dass Sie **Lambda-Funktionen ausf√ºhren k√∂nnen, wenn etwas passiert oder wenn einige Zeit vergeht**, macht Lambda zu einer sch√∂nen und h√§ufigen M√∂glichkeit, Persistenz zu erlangen und eine Entdeckung zu vermeiden.\
Hier sind einige Ideen, um Ihre **Pr√§senz in AWS durch Erstellen von Lambdas** stealthiger zu gestalten.

* Jedes Mal, wenn ein neuer Benutzer erstellt wird, generiert Lambda einen neuen Benutzerschl√ºssel und sendet ihn an den Angreifer.
* Jedes Mal, wenn eine neue Rolle erstellt wird, gibt Lambda angenommene Rollenberechtigungen an kompromittierte Benutzer.
* Jedes Mal, wenn neue CloudTrail-Protokolle generiert werden, l√∂schen/√§ndern Sie sie

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandising**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys einreichen.

</details>
