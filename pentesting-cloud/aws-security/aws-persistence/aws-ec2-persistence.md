# AWS - EC2 Persistence

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する。
- **HackTricks**（https://github.com/carlospolop/hacktricks）および**HackTricks Cloud**（https://github.com/carlospolop/hacktricks-cloud）のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## EC2

詳細については、以下をチェックしてください：

{% content-ref url="../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### セキュリティグループ接続トラッキングの永続化

**EC2インスタンスが侵害された**ことがわかった場合、防御者はおそらくそのマシンの**ネットワークを分離**しようとします。これは明示的な**Deny NACL**（ただし、NACLはサブネット全体に影響を与えます）または**どのようなインバウンドまたはアウトバウンド**トラフィックも許可しないように**セキュリティグループを変更**することで行うことができます。

攻撃者がそのマシンから発信された**リバースシェルを持っていた場合**、セキュリティグループが変更されてもインバウンドまたはアウトバウンドトラフィックを許可しないようになっても、**[セキュリティグループ接続トラッキング](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**により**接続は切断されません**。

### EC2ライフサイクルマネージャー

このサービスは、**AMIとスナップショットの作成をスケジュール**し、さらに**他のアカウントと共有**することができます。\
攻撃者は、**すべてのイメージまたはすべてのボリュームのAMIまたはスナップショットの生成**を**毎週**行い、**自分のアカウントと共有**することができます。

### スケジュールされたインスタンス

インスタンスを毎日、毎週、または月次に実行することができます。攻撃者は、高い特権または興味深いアクセスが可能なマシンを実行することができます。

### スポットフリートリクエスト

スポットインスタンスは通常のインスタンスよりも**安価**です。攻撃者は、**5年間の小さなスポットフリートリクエスト**を起動し、**自動IP**割り当てと**スポットインスタンスの開始時に攻撃者に送信する**IPアドレスと**高特権IAMロール**を持つ**ユーザーデータ**を設定することができます。

### バックドアインスタンス

攻撃者はインスタンスにアクセスしてバックドアを設置することができます：

- 例えば、従来の**rootkit**を使用する
- 新しい**パブリックSSHキー**を追加する（[EC2特権昇格オプション](../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)を確認してください）
- **ユーザーデータ**にバックドアを設置する

### **バックドア起動構成**

- 使用されたAMIにバックドアを設置する
- ユーザーデータにバックドアを設置する
- キーペアにバックドアを設置する

### VPN

VPNを作成して、攻撃者が直接VPCに接続できるようにします。

### VPCピアリング

被害者VPCと攻撃者VPCの間にピアリング接続を作成して、攻撃者が被害者VPCにアクセスできるようにします。

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する。
- **HackTricks**（https://github.com/carlospolop/hacktricks）および**HackTricks Cloud**（https://github.com/carlospolop/hacktricks-cloud）のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>
