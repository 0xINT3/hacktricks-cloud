# AWS - EC2持久性

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## EC2

有关更多信息，请查看：

{% content-ref url="../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### 安全组连接跟踪持久性

如果防御者发现**EC2实例被入侵**，他可能会尝试**隔离**该机器的**网络**。他可以通过显式**拒绝NACL**（但NACL会影响整个子网），或**更改安全组**以不允许**任何入站或出站**流量来实现这一点。

如果攻击者从该机器发起了**反向shell**，即使SG被修改为不允许入站或出站流量，由于[**安全组连接跟踪**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**，连接也不会被终止**。

### EC2生命周期管理器

此服务允许**调度**创建AMI和快照，甚至**与其他帐户共享**它们。\
攻击者可以配置**每周**生成所有镜像或所有卷的AMI或快照，并**与他的帐户共享**。

### 定时实例

可以安排每天、每周甚至每月运行实例。攻击者可以运行一个具有高权限或有趣访问权限的机器。

### Spot Fleet请求

Spot实例比常规实例**更便宜**。攻击者可以启动一个**为期5年的小型Spot Fleet请求**（例如），具有**自动IP**分配和一个**用户数据**，当Spot实例启动时发送给攻击者**IP地址**和**高特权IAM角色**。

### 后门实例

攻击者可以访问实例并在其中设置后门：

* 例如使用传统的**rootkit**
* 添加一个新的**公共SSH密钥**（查看[EC2权限提升选项](../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)）
* 在**用户数据**中设置后门

### **后门启动配置**

* 后门使用的AMI
* 后门用户数据
* 后门密钥对

### VPN

创建VPN，使攻击者能够直接通过它连接到VPC。

### VPC Peering

在受害者VPC和攻击者VPC之间创建对等连接，这样他就能访问受害者VPC。 

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
