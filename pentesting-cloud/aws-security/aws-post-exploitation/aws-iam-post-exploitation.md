# AWS - IAM Na-Afloop Uitbuiting

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## IAM

Vir meer inligting oor IAM-toegang:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## Verwarde Plaasvervangerprobleem

As jy **'n eksterne rekening (A)** toelaat om 'n **rol** in jou rekening te benader, sal jy waarskynlik **0 sigbaarheid** h√™ oor **wie presies daardie eksterne rekening kan benader**. Dit is 'n probleem, want as 'n ander eksterne rekening (B) die eksterne rekening (A) kan benader, is dit moontlik dat **B ook jou rekening kan benader**.

Daarom, wanneer jy 'n eksterne rekening toelaat om 'n rol in jou rekening te benader, is dit moontlik om 'n `ExternalId` te spesifiseer. Dit is 'n "geheime" string wat die eksterne rekening (A) **moet spesifiseer** om die rol in jou organisasie **aan te neem**. Aangesien die **eksterne rekening B nie hierdie string sal ken nie**, selfs al het hy toegang tot A, **sal hy nie jou rol kan benader nie**.

<figure><img src="../../../.gitbook/assets/image (95).png" alt=""><figcaption></figcaption></figure>

Let egter daarop dat hierdie `ExternalId` "geheim" **nie 'n geheim is nie**, enigiemand wat die IAM aanneemrolbeleid kan lees, sal dit kan sien. Maar solank die eksterne rekening A dit weet, maar die eksterne rekening **B dit nie weet nie**, **voorkom dit dat B A misbruik om jou rol te benader**.

Voorbeeld:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
Vir 'n aanvaller om 'n verwarde adjunk te benut, sal hy op een of ander manier moet vind of die hoofde van die huidige rekening rolle in ander rekeninge kan naboots.
{% endhint %}

### Onverwagte Vertroue

#### Wildcard as hoofdpersoon
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
Hierdie beleid **laat alle AWS** toe om die rol aan te neem.

#### Diens as hoofsubjek
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
Hierdie beleid **laat enige rekening** toe om hul apigateway te konfigureer om hierdie Lambda te roep.

#### S3 as hoofsubjek
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
Indien 'n S3-emmer as 'n hoofakteur gegee word, omdat S3-emmers nie 'n Rekening-ID het nie, as jy jou emmer verwyder en die aanvaller dit in hul eie rekening skep, kan hulle dit misbruik.

#### Nie ondersteun nie
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
'n Algemene manier om Verwarde Adjunkprobleme te vermy is die gebruik van 'n voorwaarde met `AWS:SourceArn` om die oorsprong ARN te kontroleer. Nietemin, **sommige dienste mag dit nie ondersteun nie** (soos CloudTrail volgens sommige bronne).

## Verwysings

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
