# AWS - IAMポストエクスプロイテーション

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じて、ゼロからヒーローまでAWSハッキングを学びましょう</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)で**フォロー**する
- **ハッキングトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## IAM

IAMアクセスの詳細については：

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## 混乱した副官問題

外部アカウント（A）があなたのアカウント内の**ロール**にアクセスを許可すると、**その外部アカウントが正確にアクセスできるかどうか**について**0の可視性**がある可能性があります。これは問題です、なぜなら別の外部アカウント（B）が外部アカウント（A）にアクセスできる場合、**Bもあなたのアカウントにアクセスできる可能性がある**からです。

したがって、外部アカウントがあなたのアカウント内のロールにアクセスできるようにする場合、`ExternalId`を指定することが可能です。これは、外部アカウント（A）が**組織内のロールを仮定するために指定する必要がある**「秘密」の文字列です。**外部アカウントBがこの文字列を知らない**限り、Aにアクセス権があっても、**あなたのロールにアクセスできなくなります**。

<figure><img src="../../../.gitbook/assets/image (95).png" alt=""><figcaption></figcaption></figure>

ただし、この`ExternalId`「秘密」は**秘密ではない**ことに注意してください。IAMアサムロールポリシーを読むことができる人であれば、それを見ることができます。ただし、外部アカウントAがそれを知っている限り、外部アカウント**Bがそれを知らない**限り、**BがAを悪用してあなたのロールにアクセスするのを防ぎます**。

例：
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
攻撃者が混乱した代理人を悪用するためには、現在のアカウントの主体が他のアカウントの役割をなりすますことができるかどうかを見つける必要があります。
{% endhint %}

### 予期しない信頼

#### プリンシパルとしてのワイルドカード
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
このポリシーは、**すべてのAWS**がそのロールを前提とすることを許可します。

#### サービスを主体として
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
このポリシーは、**どのアカウントでも**、そのLambdaを呼び出すために自分のapigatewayを構成できるようにします。

#### プリンシパルとしてのS3
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
#### サポートされていません
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
一般的な混乱した代理人問題を回避する方法は、`AWS:SourceArn`との条件を使用して元のARNをチェックすることです。ただし、**一部のサービスはそれをサポートしていない場合があります**（一部の情報源によると、CloudTrailなど）。

## 参考

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使用して、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
