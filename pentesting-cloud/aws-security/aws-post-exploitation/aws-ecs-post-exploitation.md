# AWS - ECS P√≥s-Explora√ß√£o

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## ECS

Para mais informa√ß√µes, confira:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Pap√©is IAM do Host

No ECS, um **papel IAM pode ser atribu√≠do √† tarefa** executada dentro do cont√™iner. **Se** a tarefa for executada dentro de uma inst√¢ncia **EC2**, a **inst√¢ncia EC2** ter√° **outro papel IAM** associado a ela.\
Isso significa que, se voc√™ conseguir **comprometer** uma inst√¢ncia ECS, voc√™ pode potencialmente **obter o papel IAM associado ao ECR e √† inst√¢ncia EC2**. Para mais informa√ß√µes sobre como obter essas credenciais, confira:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
Observe que se a inst√¢ncia EC2 estiver aplicando IMDSv2, [**de acordo com a documenta√ß√£o**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), a **resposta do pedido PUT** ter√° um **limite de salto de 1**, tornando imposs√≠vel acessar os metadados da EC2 de um cont√™iner dentro da inst√¢ncia EC2.
{% endhint %}

### Privesc para o n√≥ para roubar credenciais e segredos de outros cont√™ineres

Al√©m disso, a EC2 usa docker para executar tarefas do ECS, ent√£o se voc√™ conseguir escapar para o n√≥ ou **acessar o socket do docker**, voc√™ pode **verificar** quais **outros cont√™ineres** est√£o sendo executados, e at√© mesmo **entrar dentro deles** e **roubar seus pap√©is IAM** associados.

#### Fazendo cont√™ineres rodarem no host atual

Ademais, o **papel da inst√¢ncia EC2** geralmente ter√° permiss√µes suficientes para **atualizar o estado da inst√¢ncia do cont√™iner** das inst√¢ncias EC2 usadas como n√≥s dentro do cluster. Um atacante poderia modificar o **estado de uma inst√¢ncia para DRAINING**, ent√£o o ECS **remover√° todas as tarefas dela** e as que estiverem sendo executadas como **REPLICA** ser√£o **executadas em uma inst√¢ncia diferente,** potencialmente dentro da **inst√¢ncia do atacante** para que ele possa **roubar seus pap√©is IAM** e informa√ß√µes sens√≠veis de dentro do cont√™iner.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
A mesma t√©cnica pode ser realizada **desregistrando a inst√¢ncia EC2 do cluster**. Isso √© potencialmente menos discreto, mas **for√ßar√° as tarefas a serem executadas em outras inst√¢ncias:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
Uma t√©cnica final para for√ßar a re-execu√ß√£o de tarefas √© indicando ao ECS que a **tarefa ou container foi interrompido**. Existem 3 APIs potenciais para fazer isso:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Roubar informa√ß√µes sens√≠veis de cont√™ineres ECR

A inst√¢ncia EC2 provavelmente tamb√©m ter√° a permiss√£o `ecr:GetAuthorizationToken` permitindo que ela **baixe imagens** (voc√™ poderia procurar por informa√ß√µes sens√≠veis nelas).

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
