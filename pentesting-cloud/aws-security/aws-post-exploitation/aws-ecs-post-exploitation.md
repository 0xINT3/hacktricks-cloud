# AWS - ECS рдкреЛрд╕реНрдЯ рдЕрдзрд┐рдХрд╛рд░реАрдХрд░рдг

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## ECS

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### рд╣реЛрд╕реНрдЯ IAM рднреВрдорд┐рдХрд╛рдПрдБ

ECS рдореЗрдВ рдПрдХ **IAM рднреВрдорд┐рдХрд╛ рдХрд╛рд░реНрдп** рдХреЗ рдЕрдВрджрд░ рдЪрд▓ рд░рд╣реЗ рдХрдВрдЯреЗрдирд░ рдХреЛ рд╕реМрдВрдкреА рдЬрд╛ рд╕рдХрддреА рд╣реИред **рдпрджрд┐** рдХрд╛рд░реНрдп рдХреЛ **EC2** рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕** рдХреЗ рд╕рд╛рде рдПрдХ **рдЕрдиреНрдп IAM** рднреВрдорд┐рдХрд╛ рдЬреБрдбрд╝реА рд╣реЛрдЧреАред\
рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк рдПрдХ ECS рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ **рдЕрдкрдиреЗ рдХрдмреНрдЬреЗ рдореЗрдВ рдХрд░рдиреЗ** рдореЗрдВ рд╕рдлрд▓ рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рд╕рдВрднрд╡рддрдГ **ECR рдФрд░ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╕реЗ рдЬреБрдбрд╝реА IAM рднреВрдорд┐рдХрд╛ рдкреНрд░рд╛рдкреНрдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ IMDSv2 рдХреЛ рдкреНрд░рдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ, [**рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), **PUT рдЕрдиреБрд░реЛрдз рдХрд╛ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХрд╛ **рд╣реЙрдк рд╕реАрдорд╛ 1 рд╣реЛрдЧрд╛**, рдЬрд┐рд╕рд╕реЗ EC2 рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдХрд░рдирд╛ рдЕрд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред
{% endhint %}

### рдиреЛрдб рдкрд░ Privesc рдХрд░рдХреЗ рдЕрдиреНрдп рдХрдВрдЯреЗрдирд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдФрд░ рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдЪреБрд░рд╛ рд▓реЗрдВ

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, EC2 рдХрдВрдЯреЗрдирд░ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдбреЙрдХрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЖрдк рдиреЛрдб рдкрд░ рдЫреВрдЯ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реЗ **рдЕрдиреНрдп рдХрдВрдЯреЗрдирд░** рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ, рдФрд░ рдЙрдирдореЗрдВ рд╕реЗ **рдЕрдВрджрд░ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдЙрдирдХреА рдЬреБрдбрд╝реА **IAM рднреВрдорд┐рдХрд╛рдПрдБ** рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВред

#### рдореМрдЬреВрджрд╛ рд╣реЛрд╕реНрдЯ рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдирд╛

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рднреВрдорд┐рдХрд╛** рдореЗрдВ рдЖрдорддреМрд░ рдкрд░ рдкрд░реНрдпрд╛рдкреНрдд **рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрддреА рд╣реИрдВ** рдХрд┐ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдиреЛрдбреНрд╕ рдХреА рдХрдВрдЯреЗрдирд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╕реНрдерд┐рддрд┐ рдХреЛ **рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ**ред рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХрд┐рд╕реА рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ **DRAINING** рдореЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдлрд┐рд░ ECS рдЙрд╕реЗ **рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛** рдФрд░ **REPLICA** рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ **рдПрдХ рдЕрд▓рдЧ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛**, рд╕рдВрднрд╡рддрдГ рд╣рдорд▓рд╛рд╡рд░ рдХреА рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░, рддрд╛рдХрд┐ рд╡рд╣ рдЙрдирдХреА рдЬреБрдбрд╝реА **IAM рднреВрдорд┐рдХрд╛рдПрдБ** рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдЪреБрд░рд╛ рд╕рдХреЗред
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
рдпрд╣реА рддрдХрдиреАрдХ **рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдЕрдирд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рдХреЗ** рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред рдпрд╣ рд╢рд╛рдпрдж рдХрдо рдЫрд┐рдкрд╛рдиреЗ рд╡рд╛рд▓реА рд╣реЛ рд╕рдХрддреА рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ **рдЯрд╛рд╕реНрдХ рдХреЛ рдЕрдиреНрдп рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░реЗрдЧреА:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
рдЯрд╛рд╕реНрдХ рдпрд╛ рдХрдВрдЯреЗрдирд░ рдХреЛ рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдВрддрд┐рдо рддрдХрдиреАрдХ рд╣реИ ECS рдХреЛ рд╕реВрдЪрд┐рдд рдХрд░рдирд╛ рдХрд┐ **рдЯрд╛рд╕реНрдХ рдпрд╛ рдХрдВрдЯреЗрдирд░ рдмрдВрдж рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛**ред рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 3 рдкреЛрдЯреЗрдВрд╢рд┐рдпрд▓ API рд╣реИрдВ:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ECR рдХрдВрдЯреЗрдирд░ рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдЪреБрд░рд╛рдПрдВ

EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдкрд╛рд╕ рд╕рдВрднрд╛рд╡рддрдГ `ecr:GetAuthorizationToken` рдЕрдиреБрдорддрд┐ рднреА рд╣реЛрдЧреА, рдЬрд┐рд╕рд╕реЗ рдпрд╣ **рдЫрд╡рд┐рдпрд╛рдБ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддрд╛ рд╣реИ** (рдЖрдк рдЙрдирдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдкрдХреЛ **PEASS рдХреА рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдирд╛ рд╣реИ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рд╣реИ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХрд╛ рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
