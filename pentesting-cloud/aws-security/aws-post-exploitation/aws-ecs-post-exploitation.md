# AWS - ECSポストエクスプロイテーション

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* 自分のハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## ECS

詳細については、次を参照してください：

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### ホストIAMロール

ECSでは、コンテナ内で実行されるタスクに**IAMロールを割り当てる**ことができます。タスクが**EC2**インスタンス内で実行される場合、**EC2インスタンス**には別のIAMロールが割り当てられます。\
つまり、ECSインスタンスを**侵害**することができれば、ECRおよびEC2インスタンスに関連付けられたIAMロールを**取得**することができます。これらの資格情報を取得する方法の詳細については、次を参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
EC2インスタンスがIMDSv2を強制している場合、[**ドキュメントによると**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)、**PUTリクエストの応答**は**ホップ制限が1**になります。そのため、EC2インスタンス内のコンテナからEC2メタデータにアクセスすることは不可能です。
{% endhint %}

### ノードへの特権昇格と他のコンテナの資格情報およびシークレットの盗難

さらに、EC2はECsタスクを実行するためにDockerを使用しています。そのため、ノードに脱出したり、**Dockerソケットにアクセス**したりすることで、実行されている**他のコンテナ**を**確認**し、それらに**アクセス**して**関連付けられたIAMロール**を**盗む**ことができます。

#### 現在のホストでコンテナを実行する

さらに、**EC2インスタンスのロール**には通常、クラスタ内のノードとして使用されるEC2インスタンスのコンテナインスタンスの状態を**更新するための十分な権限**があります。攻撃者はインスタンスの状態を**DRAINING**に変更することができます。すると、ECSはそれから**すべてのタスクを削除**し、**REPLICA**として実行されているタスクは**別のインスタンス**で実行されるようになります。これにより、攻撃者は**自身のインスタンス**内で実行されているタスクからIAMロールと潜在的に機密情報を**盗む**ことができます。
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
同じ技術は、**クラスタからEC2インスタンスを登録解除する**ことでも実行できます。これは潜伏性が低いかもしれませんが、これによりタスクは他のインスタンスで実行されるように**強制されます**。
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
最後のテクニックは、ECSに対して**タスクまたはコンテナが停止した**ことを示すことで、タスクの再実行を強制する方法です。これを行うためには、3つの潜在的なAPIがあります。
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ECRコンテナから機密情報を盗む

EC2インスタンスはおそらく`ecr:GetAuthorizationToken`の権限も持っているため、**イメージをダウンロード**することができます（それらに機密情報が含まれている可能性があります）。

<details>

<summary><strong>HackTricksをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を入手する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>
