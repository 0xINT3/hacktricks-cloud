# AWS - P√≥s-Explora√ß√£o do ECS

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## ECS

Para mais informa√ß√µes, verifique:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Fun√ß√µes IAM do Host

No ECS, uma **fun√ß√£o IAM pode ser atribu√≠da √† tarefa** em execu√ß√£o dentro do cont√™iner. **Se** a tarefa for executada dentro de uma **inst√¢ncia EC2**, a **inst√¢ncia EC2** ter√° **outra fun√ß√£o IAM** anexada a ela.\
Isso significa que se voc√™ conseguir **comprometer** uma inst√¢ncia ECS, poder√° potencialmente **obter a fun√ß√£o IAM associada ao ECR e √† inst√¢ncia EC2**. Para obter mais informa√ß√µes sobre como obter essas credenciais, verifique:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
Observe que se a inst√¢ncia EC2 estiver aplicando o IMDSv2, [**conforme a documenta√ß√£o**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), a **resposta da solicita√ß√£o PUT** ter√° um **limite de salto de 1**, tornando imposs√≠vel acessar os metadados EC2 de um cont√™iner dentro da inst√¢ncia EC2.
{% endhint %}

### Privesc para o n√≥ para roubar credenciais e segredos de outros cont√™ineres

Al√©m disso, o EC2 usa o Docker para executar tarefas do ECS, portanto, se voc√™ puder escapar para o n√≥ ou **acessar o socket do Docker**, poder√° **verificar** quais **outros cont√™ineres** est√£o sendo executados e at√© mesmo **entrar neles** e **roubar suas fun√ß√µes IAM** anexadas.

#### Fazendo cont√™ineres serem executados no host atual

Al√©m disso, a **fun√ß√£o da inst√¢ncia EC2** geralmente ter√° permiss√µes suficientes para **atualizar o estado da inst√¢ncia do cont√™iner** das inst√¢ncias EC2 sendo usadas como n√≥s dentro do cluster. Um atacante poderia modificar o **estado de uma inst√¢ncia para DRAINING**, ent√£o o ECS ir√° **remover todas as tarefas dela** e as que est√£o sendo executadas como **REPLICA** ser√£o **executadas em uma inst√¢ncia diferente**, potencialmente dentro da **inst√¢ncia do atacante**, para que ele possa **roubar suas fun√ß√µes IAM** e informa√ß√µes sens√≠veis potenciais de dentro do cont√™iner.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
A mesma t√©cnica pode ser feita **desregistrando a inst√¢ncia EC2 do cluster**. Isso √© potencialmente menos sigiloso, mas ir√° **for√ßar as tarefas a serem executadas em outras inst√¢ncias:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
Uma t√©cnica final para for√ßar a reexecu√ß√£o de tarefas √© indicar ao ECS que a **tarefa ou cont√™iner foi interrompido**. Existem 3 APIs potenciais para fazer isso:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Roubar informa√ß√µes sens√≠veis dos containers do ECR

A inst√¢ncia EC2 provavelmente tamb√©m ter√° a permiss√£o `ecr:GetAuthorizationToken`, permitindo que ela **baixe imagens** (voc√™ pode procurar informa√ß√µes sens√≠veis nelas).

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
