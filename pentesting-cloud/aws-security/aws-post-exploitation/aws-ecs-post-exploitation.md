# AWS - ECS Na-Aanval N√° Uitbuiting

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## ECS

Vir meer inligting, kyk:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Gasheer IAM-rolle

In ECS kan 'n **IAM-rol toegewys word aan die taak** wat binne die houer uitgevoer word. **As** die taak binne 'n **EC2**-instansie uitgevoer word, sal die **EC2-instansie** 'n **ander IAM-rol** daaraan geheg h√™.\
Dit beteken dat as jy 'n ECS-instansie kan **kompromitteer**, kan jy moontlik die IAM-rol verkry wat aan die ECR en die EC2-instansie gekoppel is. Vir meer inligting oor hoe om daardie geloofsbriewe te verkry, kyk:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
Let daarop dat as die EC2-instansie IMDSv2 afdwing, [**volgens die dokumentasie**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), sal die **antwoord van die PUT-versoek** 'n **hoplimiet van 1** h√™, wat dit onmoontlik maak om die EC2-metadata vanuit 'n houer binne die EC2-instansie te bereik.
{% endhint %}

### Privesc na node om ander houer se geloofsbriewe en geheime te steel

Maar bo en behalwe dit, gebruik EC2 docker om ECs-take uit te voer, so as jy kan ontsnap na die node of die **docker-socket kan bereik**, kan jy **nagaan** watter **ander houers** uitgevoer word, en selfs **daarin ingaan** en **hul IAM-rolle** wat daaraan geheg is, steel.

#### Laat houers op huidige gasheer uitvoer

Verder sal die **EC2-instansierol** gewoonlik genoeg **toestemmings** h√™ om die **toestand van die houerinstansie** van die EC2-instansies wat as nodes binne die groep gebruik word, te **opdateer**. 'n Aanvaller kan die **toestand van 'n instansie verander na DRAINING**, dan sal ECS **alle take daarvan verwyder** en diegene wat as **REPLICA** uitgevoer word, sal in 'n ander instansie uitgevoer word, moontlik binne die **aanvaller se instansie**, sodat hy hul IAM-rolle en potensi√´le sensitiewe inligting van binne die houer kan steel.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
Dieselfde tegniek kan uitgevoer word deur die EC2-instantie van die groep af te meld. Dit is potensieel minder heimlik, maar dit sal die take dwing om op ander instansies uitgevoer te word:
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
'n Laaste tegniek om die heruitvoering van take af te dwing, is deur aan te dui dat die taak of houer gestop is. Daar is 3 potensi√´le API's om dit te doen:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### Steel sensitiewe inligting vanuit ECR-houers

Die EC2-instantie het waarskynlik ook die toestemming `ecr:GetAuthorizationToken` wat dit toelaat om **afbeeldings af te laai** (jy kan soek vir sensitiewe inligting daarin).

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
