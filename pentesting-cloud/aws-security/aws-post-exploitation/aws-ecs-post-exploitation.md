# AWS - ECS 포스트 익스플로이트

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## ECS

자세한 정보는 다음을 확인하세요:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### 호스트 IAM 역할

ECS에서는 컨테이너 내에서 실행되는 작업에 **IAM 역할을 할당**할 수 있습니다. 작업이 **EC2** 인스턴스 내에서 실행되는 경우, **EC2 인스턴스**에는 **다른 IAM** 역할이 연결됩니다.\
따라서 ECS 인스턴스를 **침해**하면 ECR 및 EC2 인스턴스에 연결된 IAM 역할을 **얻을 수 있습니다**. 해당 자격 증명을 얻는 방법에 대한 자세한 정보는 다음을 확인하세요:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
EC2 인스턴스가 IMDSv2를 강제로 적용하는 경우, [**문서에 따르면**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), **PUT 요청의 응답**은 **1개의 홉 한계**를 가지므로 EC2 인스턴스 내의 컨테이너에서 EC2 메타데이터에 액세스할 수 없습니다.
{% endhint %}

### 노드로의 권한 상승 및 다른 컨테이너 자격 증명 및 비밀 획득

뿐만 아니라 EC2는 ECs 작업을 실행하기 위해 도커를 사용하므로, 노드로 탈출하거나 **도커 소켓에 액세스**할 수 있다면, 실행 중인 **다른 컨테이너**를 **확인**하고 그 안에 들어가서 **연결된 IAM 역할**을 **획득**할 수 있습니다.

#### 현재 호스트에서 컨테이너 실행하기

또한, **EC2 인스턴스 역할**은 일반적으로 클러스터 내의 노드로 사용되는 EC2 인스턴스의 컨테이너 인스턴스 상태를 **업데이트할 충분한 권한**을 가지고 있습니다. 공격자는 인스턴스의 상태를 DRAINING으로 수정할 수 있으며, 그러면 ECS가 해당 인스턴스에서 **모든 작업을 제거**하고 **REPLICA**로 실행되는 작업은 **다른 인스턴스에서 실행**될 수 있습니다. 이는 공격자가 컨테이너 내부에서 IAM 역할 및 잠재적으로 민감한 정보를 **획득**할 수 있도록 합니다.
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
같은 기술은 클러스터에서 EC2 인스턴스를 **등록 해제**함으로써 수행할 수 있습니다. 이는 잠재적으로 덜 은밀하지만 작업이 다른 인스턴스에서 실행되도록 **강제**합니다:
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
**작업 또는 컨테이너가 중지되었다고** ECS에 알리는 최종 기술은 작업을 다시 실행하도록 강제하는 것입니다. 이를 위해 사용할 수 있는 3가지 잠재적인 API가 있습니다:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ECR 컨테이너에서 민감한 정보 도용하기

EC2 인스턴스는 아마도 `ecr:GetAuthorizationToken` 권한을 가지고 있어서 **이미지를 다운로드**할 수 있습니다 (이미지에서 민감한 정보를 찾을 수 있습니다).

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
