# AWS - P√≥s-Explora√ß√£o do ECS

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## ECS

Para mais informa√ß√µes, consulte:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Fun√ß√µes IAM do Host

No ECS, uma **fun√ß√£o IAM pode ser atribu√≠da √† tarefa** em execu√ß√£o dentro do cont√™iner. **Se** a tarefa for executada dentro de uma **inst√¢ncia EC2**, a **inst√¢ncia EC2** ter√° **outra fun√ß√£o IAM** anexada a ela.\
O que significa que, se voc√™ conseguir **comprometer** uma inst√¢ncia ECS, poder√° potencialmente **obter a fun√ß√£o IAM associada ao ECR e √† inst√¢ncia EC2**. Para obter mais informa√ß√µes sobre como obter essas credenciais, consulte:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Privesc para o n√≥ para roubar credenciais e segredos de outros cont√™ineres

Al√©m disso, o EC2 usa o docker para executar tarefas do ECS, portanto, se voc√™ puder escapar para o n√≥ ou **acessar o socket do docker**, poder√° **verificar** quais **outros cont√™ineres** est√£o sendo executados e at√© **entrar neles** e **roubar suas fun√ß√µes IAM** anexadas.

#### Fazendo cont√™ineres serem executados no host atual

Al√©m disso, a **fun√ß√£o da inst√¢ncia EC2** geralmente ter√° permiss√µes suficientes para **atualizar o estado da inst√¢ncia do cont√™iner** das inst√¢ncias EC2 sendo usadas como n√≥s dentro do cluster. Um invasor poderia modificar o **estado de uma inst√¢ncia para DRAINING**, ent√£o o ECS ir√° **remover todas as tarefas dela** e as que est√£o sendo executadas como **REPLICA** ser√£o **executadas em uma inst√¢ncia diferente**, potencialmente dentro da **inst√¢ncia do invasor** para que ele possa **roubar suas fun√ß√µes IAM** e informa√ß√µes potencialmente sens√≠veis de dentro do cont√™iner.

```bash
aws ecs update-container-instances-state \
    --cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```

A mesma t√©cnica pode ser feita **cancelando o registro da inst√¢ncia EC2 do cluster**. Isso √© potencialmente menos furtivo, mas ir√° **for√ßar as tarefas a serem executadas em outras inst√¢ncias:**

```bash
aws ecs deregister-container-instance \
    --cluster <cluster> --container-instance <container-instance-id> --force
```

Uma t√©cnica final para for√ßar a reexecu√ß√£o de tarefas √© indicando ao ECS que a **tarefa ou cont√™iner foi interrompido**. Existem 3 APIs potenciais para fazer isso:

```bash
# Precisa de: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
    --status STOPPED --reason "anything" --containers [...]

# Precisa de: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Precisa de: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```

### Roubar informa√ß√µes confidenciais dos cont√™ineres ECR

A inst√¢ncia EC2 provavelmente tamb√©m ter√° a permiss√£o `ecr:GetAuthorizationToken` permitindo que ela **baixe imagens** (voc√™ pode procurar informa√ß√µes confidenciais nelas).

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>