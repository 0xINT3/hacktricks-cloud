# AWS - ECS рдкреЛрд╕реНрдЯ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВ.

</details>

## ECS

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Host IAM Roles

ECS рдореЗрдВ рдПрдХ **IAM рд░реЛрд▓ рдХреЛ рдЯрд╛рд╕реНрдХ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** рдЬреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИред **рдпрджрд┐** рдЯрд╛рд╕реНрдХ **EC2** рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕** рдХреЗ рдкрд╛рд╕ **рдПрдХ рдФрд░ IAM** рд░реЛрд▓ рд╣реЛрдЧрд╛ рдЬреЛ рдЙрд╕рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реЛрддрд╛ рд╣реИред\
рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк ECS рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ **рдХрдореНрдкреНрд░реЛрдорд╛рдЗрдЬ** рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк ECR рдФрд░ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╕реЗ рдЬреБрдбрд╝реЗ IAM рд░реЛрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ IMDSv2 рдХреЛ рд▓рд╛рдЧреВ рдХрд░ рд░рд╣рд╛ рд╣реИ, [**рдбреЙрдХреНрд╕ рдХреЗ рдЕрдиреБрд╕рд╛рд░**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html), PUT рдЕрдиреБрд░реЛрдз рдХрд╛ **рдкреНрд░рддрд┐рд╕рд╛рдж** рдореЗрдВ **рд╣реЙрдк рд▓рд┐рдорд┐рдЯ 1** рд╣реЛрдЧреА, рдЬрд┐рд╕рд╕реЗ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░ рдХреЗ рдХрдВрдЯреЗрдирд░ рд╕реЗ EC2 рдореЗрдЯрд╛рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪрдирд╛ рдЕрд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред
{% endhint %}

### Privesc to node to steal other containers creds & secrets

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, EC2 рдбреЙрдХрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ ECs рдЯрд╛рд╕реНрдХреНрд╕ рдЪрд▓рд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЖрдк рдиреЛрдб рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ** рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реЗ **рдЕрдиреНрдп рдХрдВрдЯреЗрдирд░реНрд╕** рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ, рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЙрдирдХреЗ рдЕрдВрджрд░ рдЬрд╛рдХрд░ рдЙрдирдХреЗ IAM рд░реЛрд▓реНрд╕ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВред

#### Making containers run in current host

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд░реЛрд▓** рдЖрдорддреМрд░ рдкрд░ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рдиреЛрдбреНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдХреЗ **рдХрдВрдЯреЗрдирд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╕реНрдЯреЗрдЯ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреА рдкрд░реНрдпрд╛рдкреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдВ** рд░рдЦрддрд╛ рд╣реИред рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА **рд╕реНрдерд┐рддрд┐ рдХреЛ DRAINING рдореЗрдВ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ**, рдлрд┐рд░ ECS рдЙрд╕рд╕реЗ рд╕рднреА рдЯрд╛рд╕реНрдХреНрд╕ рдХреЛ **рд╣рдЯрд╛ рджреЗрдЧрд╛** рдФрд░ рдЬреЛ **REPLICA** рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рд╣реИрдВ рд╡реЗ **рдПрдХ рдЕрд▓рдЧ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рдЪрд▓рд╛рдП рдЬрд╛рдПрдВрдЧреЗ**, рд╕рдВрднрд╡рддрдГ **рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░** рддрд╛рдХрд┐ рд╡рд╣ рдЙрдирдХреЗ IAM рд░реЛрд▓реНрд╕ рдЪреБрд░рд╛ рд╕рдХреЗ рдФрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗред
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
рдпрд╣реА рддрдХрдиреАрдХ **рдХреНрд▓рд╕реНрдЯрд░ рд╕реЗ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдбреАрд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рдХреЗ** рднреА рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред рдпрд╣ рд╕рдВрднрд╡рддрдГ рдХрдо рдЧреБрдкреНрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдпрд╣ **рдЕрдиреНрдп рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрдЬ рдореЗрдВ рдЯрд╛рд╕реНрдХреНрд╕ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░реЗрдЧрд╛:**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
рдЕрдВрддрд┐рдо рддрдХрдиреАрдХ рдЬреЛ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдкреБрди: рдирд┐рд╖реНрдкрд╛рджрди рдХреЛ рдордЬрдмреВрд░ рдХрд░рддреА рд╣реИ, рд╡рд╣ рд╣реИ ECS рдХреЛ рд╕рдВрдХреЗрдд рджреЗрдирд╛ рдХрд┐ **рдХрд╛рд░реНрдп рдпрд╛ рдХрдВрдЯреЗрдирд░ рд░реЛрдХ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛**ред рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП 3 рд╕рдВрднрд╛рд╡рд┐рдд APIs рд╣реИрдВ:
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ECR рдХрдВрдЯреЗрдирд░реЛрдВ рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдЪреБрд░рд╛рдПрдВ

EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдкрд╛рд╕ рд╕рдВрднрд╡рддрдГ `ecr:GetAuthorizationToken` рдЕрдиреБрдорддрд┐ рднреА рд╣реЛрдЧреА рдЬреЛ рдЗрд╕реЗ **рдЗрдореЗрдЬреЗрд╕ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ (рдЖрдк рдЙрдирдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**ред
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
