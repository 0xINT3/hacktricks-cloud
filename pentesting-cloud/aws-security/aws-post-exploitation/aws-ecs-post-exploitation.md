# AWS - ECS Post Exploitation

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## ECS

詳細については以下をチェックしてください:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### Host IAM Roles

ECSでは、コンテナ内で実行されている**タスクにIAMロールを割り当てることができます**。タスクが**EC2**インスタンス内で実行されている場合、**EC2インスタンス**には**別のIAM**ロールが添付されています。\
つまり、ECSインスタンスを**侵害**することができれば、ECRとEC2インスタンスに関連付けられたIAMロールを**取得する可能性があります**。これらの資格情報を取得する方法についての詳細は以下をチェックしてください:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

{% hint style="danger" %}
IMDSv2を強制しているEC2インスタンスの場合、[**ドキュメントによると**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-metadata-v2-how-it-works.html)、**PUTリクエストのレスポンス**には**ホップリミットが1**になるため、EC2インスタンス内のコンテナからEC2メタデータにアクセスすることは不可能です。
{% endhint %}

### ノードへのPrivescで他のコンテナのcreds & secretsを盗む

さらに、EC2はECsタスクを実行するためにdockerを使用しているため、ノードにエスケープするか**dockerソケットにアクセス**することができれば、実行されている**他のコンテナ**を**チェック**し、それらの中に**入り込んで**、添付されている**IAMロールを盗む**ことができます。

#### 現在のホストでコンテナを実行する

さらに、**EC2インスタンスロール**は通常、クラスタ内のノードとして使用されているEC2インスタンスの**コンテナインスタンス状態を更新する**のに十分な**権限**を持っています。攻撃者はインスタンスの**状態をDRAININGに変更**することができ、その後ECSはそのインスタンスから**すべてのタスクを削除し**、**REPLICA**として実行されているタスクは**別のインスタンスで実行されます**。これにより、攻撃者は**自分のインスタンス内で**それらを実行し、**IAMロールを盗む**ことができ、コンテナ内の機密情報を盗む可能性があります。
```bash
aws ecs update-container-instances-state \
--cluster <cluster> --status DRAINING --container-instances <container-instance-id>
```
同じテクニックは、**クラスターからEC2インスタンスを登録解除する**ことによっても実行できます。これは潜在的に目立つ可能性がありますが、**タスクが他のインスタンスで実行されるように強制します：**
```bash
aws ecs deregister-container-instance \
--cluster <cluster> --container-instance <container-instance-id> --force
```
最終的なタスクの再実行を強制する手法は、ECSに**タスクまたはコンテナが停止した**ことを示すことです。これを行うための3つの潜在的なAPIがあります：
```bash
# Needs: ecs:SubmitTaskStateChange
aws ecs submit-task-state-change --cluster <value> \
--status STOPPED --reason "anything" --containers [...]

# Needs: ecs:SubmitContainerStateChange
aws ecs submit-container-state-change ...

# Needs: ecs:SubmitAttachmentStateChanges
aws ecs submit-attachment-state-changes ...
```
### ECRコンテナから機密情報を盗む

EC2インスタンスには、おそらく `ecr:GetAuthorizationToken` の権限があり、**イメージをダウンロード**することができます（それらの中に機密情報があるかもしれません）。

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または **HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加する、または **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
