# AWS - EFS Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを見たい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## EFS

### 基本情報

Amazon Elastic File System（EFS）は、AWSによって完全に**管理され、スケーラブルで弾力性のあるネットワークファイルシステム**です。EFSを使用すると、**複数のEC2インスタンスや他のAWSサービスで共有されるファイルシステム**を作成および構成できます。EFSは自動的にスケーリングされ、低遅延アクセスを提供し、高スループットのワークロードをサポートし、データの耐久性を確保し、AWSのセキュリティ機能と統合されています。

**デフォルトでは**、マウントするEFSフォルダは**`/`**ですが、**異なる名前**を持つ場合もあります。

### ネットワークアクセス

EFSはVPC内で作成され、**デフォルトではすべてのVPCサブネットからアクセス可能**です。ただし、EFSにはセキュリティグループがあります。EFSをマウントするためにEC2（または他のAWSサービス）にアクセスを許可するには、EFSセキュリティグループでEC2セキュリティグループからの**入力NFS（2049ポート）ルールを許可する必要があります**。

これを行わないと、NFSサービスに**接続できません**。

これについての詳細情報は、次を参照してください：[https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### 列挙
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20
```
### EFSのマウント

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAMアクセス

**デフォルトでは**、EFSへの**ネットワークアクセスを持つ誰でも**、ルートユーザーとして**マウント、読み書きが可能**です。ただし、ファイルシステムポリシーによっては、**特定の権限を持つ主体のみがアクセスできるように制限**されている場合もあります。\
たとえば、このファイルシステムポリシーでは、**IAMの権限がない場合はマウントすらできません**。
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
または、これにより**匿名アクセスが防止**されます：

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

IAM で保護されたファイルシステムをマウントするには、マウントコマンドで "efs" タイプを使用する必要があることに注意してください：
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### アクセスポイント

**アクセスポイント**は、共有データセットへのアプリケーションアクセスを管理しやすくするための、**EFSファイルシステムへのアプリケーション固有のエントリーポイント**です。

アクセスポイントを作成すると、アクセスポイントを通じて作成されるファイルとディレクトリの**所有者とPOSIXパーミッションを指定**することができます。また、アクセスポイントのために**カスタムルートディレクトリを定義**することもできます。既存のディレクトリを指定するか、所望のパーミッションで新しいディレクトリを作成することができます。これにより、共有ファイルデータをアプリケーションまたはユーザーごとに**個別にアクセス制御**することができ、共有ファイルデータの管理とセキュリティが容易になります。

**アクセスポイントからファイルシステムをマウントするには、次のような方法があります:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
アクセスポイントをマウントしようとしても、ネットワーク経由でNFSサービスにアクセスできる必要があります。また、EFSにファイルシステムポリシーがある場合は、マウントするために十分なIAM権限が必要です。
{% endhint %}

アクセスポイントは、次の目的で使用できます：

* **権限管理の簡素化**：各アクセスポイントに対してPOSIXユーザーとグループを定義することで、基礎となるファイルシステムの権限を変更せずに、異なるアプリケーションやユーザーのアクセス権を簡単に管理できます。
* **ルートディレクトリの強制**：アクセスポイントは、EFSファイルシステム内の特定のディレクトリへのアクセスを制限できます。これにより、各アプリケーションやユーザーが指定されたフォルダ内で操作することが保証されます。これにより、データの誤った公開や変更が防止されます。
* **ファイルシステムへの簡単なアクセス**：アクセスポイントは、AWS Lambda関数やAWS Fargateタスクに関連付けることができ、サーバーレスおよびコンテナ化されたアプリケーションのファイルシステムアクセスを簡素化します。

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
