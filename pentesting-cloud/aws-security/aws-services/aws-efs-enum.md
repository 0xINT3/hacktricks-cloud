# AWS - EFS Enum

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## EFS

### Podstawowe informacje

Amazon Elastic File System (EFS) jest prezentowany jako **w pełni zarządzany, skalowalny i elastyczny system plików sieciowych** przez AWS. Usługa ułatwia tworzenie i konfigurację **systemów plików**, które mogą być jednocześnie dostępne przez wiele instancji EC2 i inne usługi AWS. Główne cechy EFS obejmują automatyczną skalowalność bez konieczności ingerencji manualnej, zapewnienie dostępu o niskim opóźnieniu, obsługę obciążeń o wysokiej przepustowości, gwarancję trwałości danych oraz bezproblemową integrację z różnymi mechanizmami bezpieczeństwa AWS.

Domyślnie folder EFS do zamontowania będzie **`/`**, ale może mieć **inną nazwę**.

### Dostęp sieciowy

EFS jest tworzony w VPC i domyślnie jest **dostępny we wszystkich podsieciach VPC**. Jednak EFS będzie miał Grupę zabezpieczeń. Aby **umożliwić dostęp do montowania EFS dla EC2** (lub innej usługi AWS), należy **zezwolić w grupie zabezpieczeń EFS na przychodzące reguły NFS** (port 2049) **z grupy zabezpieczeń EC2**.

Bez tego **nie będziesz mógł skontaktować się z usługą NFS**.

Aby uzyskać więcej informacji na temat tego, jak to zrobić, sprawdź: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Wyliczanie
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Może się zdarzyć, że punkt montowania EFS znajduje się w tej samej VPC, ale w innej podsieci. Jeśli chcesz mieć pewność, że znajdziesz wszystkie **punkty EFS, lepiej jest przeskanować maskę sieci `/16`**.
{% endhint %}

### Zamontuj EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Dostęp IAM

Domyślnie każdy, kto ma dostęp sieciowy do EFS, będzie mógł go zamontować, odczytywać i zapisywać, nawet jako użytkownik root. Jednak mogą być zastosowane polityki systemu plików, które pozwalają tylko określonym podmiotom na dostęp do niego.\
Na przykład, ta polityka systemu plików nie pozwoli nawet na zamontowanie systemu plików, jeśli nie masz uprawnienia IAM:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
Lub to **uniemożliwi dostęp anonimowy**:

<figure><img src="../../../.gitbook/assets/image (3) (6).png" alt=""><figcaption></figcaption></figure>

Należy zauważyć, że do zamontowania systemów plików chronionych przez IAM MUSISZ użyć typu "efs" w poleceniu montowania:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Punkty dostępu

**Punkty dostępu** to **specyficzne dla aplikacji punkty wejścia do systemu plików EFS**, które ułatwiają zarządzanie dostępem aplikacji do współdzielonych zbiorów danych.

Tworząc punkt dostępu, możesz **określić właściciela i uprawnienia POSIX** dla plików i katalogów tworzonych za pośrednictwem punktu dostępu. Możesz również **zdefiniować niestandardowy katalog główny** dla punktu dostępu, albo poprzez określenie istniejącego katalogu, albo poprzez utworzenie nowego z pożądanymi uprawnieniami. Pozwala to na **kontrolowanie dostępu do systemu plików EFS na poziomie aplikacji lub użytkownika**, ułatwiając zarządzanie i zabezpieczanie współdzielonych danych plików.

**Możesz zamontować system plików z punktu dostępu za pomocą czegoś takiego jak:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Zauważ, że nawet próbując zamontować punkt dostępu, nadal musisz być w stanie **skontaktować się z usługą NFS za pośrednictwem sieci**, a jeśli EFS ma **politykę systemu plików**, potrzebujesz **wystarczających uprawnień IAM**, aby go zamontować.
{% endhint %}

Punkty dostępu mogą być używane w celu:

* **Uproszczenia zarządzania uprawnieniami**: Definiując użytkownika i grupę POSIX dla każdego punktu dostępu, można łatwo zarządzać uprawnieniami dostępu dla różnych aplikacji lub użytkowników, bez konieczności modyfikowania uprawnień podstawowego systemu plików.
* **Wymuszenia katalogu głównego**: Punkty dostępu mogą ograniczać dostęp do określonego katalogu w systemie plików EFS, zapewniając, że każda aplikacja lub użytkownik działa w swoim wyznaczonym folderze. Pomaga to zapobiegać przypadkowemu ujawnieniu lub modyfikacji danych.
* **Ułatwienia dostępu do systemu plików**: Punkty dostępu mogą być powiązane z funkcją AWS Lambda lub zadaniem AWS Fargate, ułatwiając dostęp do systemu plików dla aplikacji bezserwerowych i kontenerowych.

## Przywileje

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Po wykorzystaniu

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Trwałość

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
