# AWS - Enumeraci√≥n de EFS

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## EFS

### Informaci√≥n b√°sica

Amazon Elastic File System (EFS) es un sistema de archivos de red completamente **administrado, escalable y el√°stico** por AWS. Permite crear y configurar **sistemas de archivos compartidos en m√∫ltiples** instancias EC2 y otros servicios de AWS. EFS se escala autom√°ticamente, proporciona acceso de baja latencia, admite cargas de trabajo de alto rendimiento, garantiza la durabilidad de los datos e integra funciones de seguridad de AWS.

Por **defecto**, la carpeta EFS para montar ser√° **`/`** pero podr√≠a tener un **nombre diferente**.

### Acceso de red

Un EFS se crea en una VPC y ser√≠a **accesible por defecto en todas las subredes de la VPC**. Sin embargo, el EFS tendr√° un Grupo de seguridad. Para **dar acceso a un EC2** (u otro servicio de AWS) para montar el EFS, es necesario **permitir en el grupo de seguridad de EFS una regla NFS de entrada** (puerto 2049) **desde el grupo de seguridad de EC2**.

Sin esto, **no podr√°s contactar el servicio NFS**.

Para obtener m√°s informaci√≥n sobre c√≥mo hacer esto, consulta: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumeraci√≥n

```bash
# Obtener sistemas de archivos y pol√≠ticas de acceso (si las hay)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Obtener subredes y direcciones IP donde se puede encontrar el sistema de archivos
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>

# Obtener otros puntos de acceso
aws efs describe-access-points

# Obtener configuraciones de replicaci√≥n
aws efs describe-replication-configurations

# Buscar NFS en redes EC2
nmap -Pn -p 2049 --open 10.10.10.0/24
```

### Montar EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Montaje encontrado
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Montaje con tipo efs
## Necesitas tener instalado el paquete amazon-efs-utils
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Acceso IAM

Por **defecto**, cualquier persona con **acceso de red al EFS** podr√° montarlo, **leerlo y escribirlo incluso como usuario root**. Sin embargo, podr√≠an estar en su lugar pol√≠ticas de sistema de archivos que **solo permiten a los principales con permisos espec√≠ficos** acceder a √©l.\
Por ejemplo, esta pol√≠tica de sistema de archivos **no permitir√° ni siquiera montar** el sistema de archivos si no tienes el permiso IAM:

```json
{
    "Version": "2012-10-17",
    "Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
    "Statement": [
        {
            "Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "",
            "Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
            "Condition": {
                "Bool": {
                    "elasticfilesystem:AccessedViaMountTarget": "true"
                }
            }
        }
    ]
}
```

Ten en cuenta que para montar sistemas de archivos protegidos por IAM DEBES usar el tipo "efs" en el comando de montaje:

```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# Para usar un perfil diferente de ~/.aws/credentials
# Puedes usar: -o tls,iam,awsprofile=namedprofile
```

### Puntos de acceso

Los **puntos de acceso** son puntos de entrada **espec√≠ficos de la aplicaci√≥n** en un sistema de archivos EFS que facilitan la gesti√≥n del acceso de la aplicaci√≥n a conjuntos de datos compartidos.

Cuando creas un punto de acceso, puedes **especificar el propietario y los permisos POSIX** para los archivos y directorios creados a trav√©s del punto de acceso. Tambi√©n puedes **definir un directorio ra√≠z personalizado** para el punto de acceso, ya sea especificando un directorio existente o creando uno nuevo con los permisos deseados. Esto te permite **controlar el acceso a tu sistema de archivos EFS en funci√≥n de la aplicaci√≥n o el usuario**, lo que facilita la gesti√≥n y seguridad de tus datos de archivo compartidos.

**Puedes montar el sistema de archivos desde un punto de acceso con algo como:**

```bash
# Usa IAM si necesitas usar permisos de iam
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
    <file-system-id/EFS DNS> /efs/
```

{% hint style="warning" %}
Ten en cuenta que incluso al intentar montar un punto de acceso, a√∫n necesitas poder **contactar el servicio NFS a trav√©s de la red**, y si el EFS tiene una pol√≠tica de sistema de archivos, necesitas **suficientes permisos IAM** para montarlo.
{% endhint %}

Los puntos de acceso se pueden utilizar para los siguientes fines:

* **Simplificar la gesti√≥n de permisos**: Al definir un usuario y grupo POSIX para cada punto de acceso, puedes gestionar f√°cilmente los permisos de acceso para diferentes aplicaciones o usuarios sin modificar los permisos del sistema de archivos subyacente.
* **Imponer un directorio ra√≠z**: Los puntos de acceso pueden restringir el acceso a un directorio espec√≠fico dentro del sistema de archivos EFS, asegurando que cada aplicaci√≥n o usuario opere dentro de su carpeta designada. Esto ayuda a evitar la exposici√≥n o modificaci√≥n accidental de datos.
* **Acceso m√°s f√°cil al sistema de archivos**: Los puntos de acceso se pueden asociar con una funci√≥n de AWS Lambda o una tarea de AWS Fargate, simplificando el acceso al sistema de archivos para aplicaciones sin servidor y contenerizadas.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Explotaci√≥n

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>¬°Apoya a HackTricks y obt