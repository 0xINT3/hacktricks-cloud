# AWS - EFS Enum

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>

## EFS

### Grundlegende Informationen

Amazon Elastic File System (EFS) wird von AWS als ein **vollst√§ndig verwaltetes, skalierbares und elastisches Netzwerkdateisystem** pr√§sentiert. Der Dienst erleichtert die Erstellung und Konfiguration von **Dateisystemen**, die gleichzeitig von mehreren EC2-Instanzen und anderen AWS-Diensten zugegriffen werden k√∂nnen. Die wichtigsten Merkmale von EFS sind die F√§higkeit zur automatischen Skalierung ohne manuellen Eingriff, Bereitstellung von Zugriff mit geringer Latenz, Unterst√ºtzung von Workloads mit hoher Durchsatzrate, Gew√§hrleistung der Datenbest√§ndigkeit und nahtlose Integration mit verschiedenen AWS-Sicherheitsmechanismen.

Standardm√§√üig wird der EFS-Ordner, der gemountet werden soll, **`/`** sein, aber er k√∂nnte einen **anderen Namen** haben.

### Netzwerkzugriff

Ein EFS wird in einem VPC erstellt und w√§re standardm√§√üig in allen VPC-Teilnetzen **zug√§nglich**. Allerdings wird das EFS √ºber eine Sicherheitsgruppe verf√ºgen. Um einem EC2 (oder einem anderen AWS-Dienst) den Zugriff auf das EFS zu erm√∂glichen, muss in der EFS-Sicherheitsgruppe eine eingehende NFS (Port 2049) **Regel aus der EC2-Sicherheitsgruppe erlaubt** werden.

Ohne dies **k√∂nnen Sie den NFS-Dienst nicht kontaktieren**.

F√ºr weitere Informationen dar√ºber, wie dies zu tun ist, siehe: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumeration
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
Es k√∂nnte sein, dass der EFS-Mount-Punkt sich innerhalb derselben VPC, aber in einem anderen Subnetz befindet. Wenn Sie sicherstellen m√∂chten, dass Sie alle **EFS-Punkte finden, w√§re es besser, das `/16`-Netzwerk zu scannen**.
{% endhint %}

### EFS mounten

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAM-Zugriff

Standardm√§√üig kann jeder mit Netzwerkzugriff auf das EFS es mounten, lesen und beschreiben, selbst als Root-Benutzer. Es k√∂nnten jedoch Dateisystemrichtlinien vorhanden sein, die nur Prinzipale mit spezifischen Berechtigungen darauf zugreifen lassen. 
Beispielsweise erlaubt diese Dateisystemrichtlinie nicht einmal das Mounten des Dateisystems, wenn Sie nicht die IAM-Berechtigung haben:
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
Oder dies wird **anonymen Zugriff verhindern**:

<figure><img src="../../../.gitbook/assets/image (3) (6).png" alt=""><figcaption></figcaption></figure>

Beachten Sie, dass Sie zum Einh√§ngen von Dateisystemen, die durch IAM gesch√ºtzt sind, den Typ "efs" im Einh√§ngebefehl VERWENDEN M√úSSEN:
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### Zugriffspunkte

**Zugriffspunkte** sind **anwendungsspezifische Einstiegspunkte **in ein EFS-Dateisystem, die es erleichtern, den Anwendungszugriff auf freigegebene Datens√§tze zu verwalten.

Beim Erstellen eines Zugriffspunkts k√∂nnen Sie **den Besitzer und die POSIX-Berechtigungen** f√ºr die √ºber den Zugriffspunkt erstellten Dateien und Verzeichnisse angeben. Sie k√∂nnen auch **ein benutzerdefiniertes Stammverzeichnis** f√ºr den Zugriffspunkt definieren, entweder durch Angabe eines vorhandenen Verzeichnisses oder durch Erstellen eines neuen mit den gew√ºnschten Berechtigungen. Dies erm√∂glicht es Ihnen, **den Zugriff auf Ihr EFS-Dateisystem auf Anwendungs- oder Benutzerbasis zu steuern**, was die Verwaltung und Sicherung Ihrer freigegebenen Dateidaten erleichtert.

**Sie k√∂nnen das Dateisystem von einem Zugriffspunkt aus einbinden, indem Sie beispielsweise Folgendes verwenden:**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
Beachten Sie, dass Sie auch beim Versuch, einen Zugriffspunkt zu mounten, in der Lage sein m√ºssen, **den NFS-Dienst √ºber das Netzwerk zu kontaktieren**, und wenn das EFS eine Dateisystem-**Richtlinie** hat, ben√∂tigen Sie **ausreichende IAM-Berechtigungen**, um es zu mounten.
{% endhint %}

Zugriffspunkte k√∂nnen f√ºr folgende Zwecke verwendet werden:

* **Vereinfachung der Berechtigungsverwaltung**: Durch die Definition eines POSIX-Benutzers und einer Gruppe f√ºr jeden Zugriffspunkt k√∂nnen Sie den Zugriff f√ºr verschiedene Anwendungen oder Benutzer einfach verwalten, ohne die Berechtigungen des zugrunde liegenden Dateisystems zu √§ndern.
* **Festlegen eines Stammverzeichnisses**: Zugriffspunkte k√∂nnen den Zugriff auf ein bestimmtes Verzeichnis innerhalb des EFS-Dateisystems beschr√§nken, um sicherzustellen, dass jede Anwendung oder jeder Benutzer innerhalb seines zugewiesenen Ordners arbeitet. Dies hilft, versehentliche Datenexposition oder -√§nderung zu verhindern.
* **Einfacherer Dateisystemzugriff**: Zugriffspunkte k√∂nnen mit einer AWS Lambda-Funktion oder einer AWS Fargate-Aufgabe verkn√ºpft werden, um den Dateisystemzugriff f√ºr serverlose und containerisierte Anwendungen zu vereinfachen.

## Privilege Escalation

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post-Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistenz

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Heldenniveau mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
