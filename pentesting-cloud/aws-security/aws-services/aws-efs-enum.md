# AWS - EFS Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## EFS

### 基本情報

Amazon Elastic File System (EFS)は、AWSによる完全に**管理された、スケーラブルで弾力的なネットワークファイルシステム**です。これにより、複数のEC2インスタンスや他のAWSサービス間で共有される**ファイルシステムの作成と設定**が可能になります。EFSは自動的にスケールし、低遅延アクセスを提供し、高スループットのワークロードをサポートし、データの耐久性を保証し、AWSのセキュリティ機能と統合します。

**デフォルト**では、マウントするEFSフォルダは**`/`**になりますが、**異なる名前**を持つことがあります。

### ネットワークアクセス

EFSはVPC内に作成され、**デフォルトではVPCのすべてのサブネットワークでアクセス可能**です。しかし、EFSにはセキュリティグループがあります。EFSをマウントするためにEC2（または他のAWSサービス）に**アクセスを許可する**ためには、EFSセキュリティグループでEC2セキュリティグループからの**インバウンドNFS**（2049ポート）**ルールを許可する**必要があります。

これがないと、**NFSサービスに接触することはできません**。

これについての詳細はこちらをチェックしてください: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### 列挙
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
EFS マウントポイントが同じ VPC 内にあるが、異なるサブネットにある可能性があります。すべての **EFS ポイントを確実に見つけるためには、`/16` ネットマスクをスキャンする方が良いでしょう**。
{% endhint %}

### EFS をマウントする

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAM アクセス

**デフォルト**では、**EFS へのネットワークアクセス**を持つ誰でも、**ルートユーザーとしても**マウント、**読み書きが可能**です。しかし、特定の権限を持つプリンシパルのみがアクセスを許可されるファイルシステムポリシーが設定されている可能性があります。\
例えば、このファイルシステムポリシーは、**IAM 権限がないと**ファイルシステムを**マウントさえできない**ようにします：
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
以下は、匿名アクセスを**防ぐ**ためのものです：

<figure><img src="../../../.gitbook/assets/image (3) (6).png" alt=""><figcaption></figcaption></figure>

IAMで保護されたファイルシステムをマウントするには、マウントコマンドで"type efs"を使用する必要があります。
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### アクセスポイント

**アクセスポイント**は、共有データセットへのアプリケーションアクセスを管理しやすくするための、**EFSファイルシステムへのアプリケーション固有のエントリポイント**です。

アクセスポイントを作成する際、アクセスポイントを通じて作成されるファイルやディレクトリの所有者とPOSIX権限を**指定することができます**。また、既存のディレクトリを指定するか、望ましい権限で新しいディレクトリを作成することにより、アクセスポイントのカスタムルートディレクトリを**定義することもできます**。これにより、**アプリケーションごとやユーザーごとにEFSファイルシステムへのアクセスを制御することができ**、共有ファイルデータの管理とセキュリティを容易にします。

**アクセスポイントからファイルシステムをマウントするには、以下のような方法があります：**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
アクセスポイントをマウントしようとしても、**ネットワーク経由でNFSサービスに接触できる必要があり**、EFSに**ポリシー**がある場合は、それをマウントするために**十分なIAM権限**が必要です。
{% endhint %}

アクセスポイントは以下の目的で使用できます：

* **権限管理の簡素化**：各アクセスポイントにPOSIXユーザーとグループを定義することで、基盤となるファイルシステムの権限を変更することなく、異なるアプリケーションやユーザーのアクセス権限を簡単に管理できます。
* **ルートディレクトリの強制**：アクセスポイントは、EFSファイルシステム内の特定のディレクトリへのアクセスを制限することができ、各アプリケーションやユーザーが指定されたフォルダ内で操作することを保証します。これにより、データの偶発的な露出や変更を防ぐことができます。
* **ファイルシステムへのアクセスが容易**：アクセスポイントはAWS Lambda関数やAWS Fargateタスクに関連付けることができ、サーバーレスおよびコンテナ化されたアプリケーションのファイルシステムへのアクセスを簡素化します。

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**のGitHubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
