# AWS - EFS Enum

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**してください。
* **ハッキングトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **githubリポジトリに提出してください。**

</details>

## EFS

### 基本情報

Amazon Elastic File System（EFS）は、AWSによる完全に**管理され、スケーラブルで弾力性のあるネットワークファイルシステム**です。複数のEC2インスタンスや他のAWSサービスで**共有されるファイルシステムを作成および構成**することができます。EFSは自動的にスケーリングされ、低遅延アクセスを提供し、高スループットのワークロードをサポートし、データの耐久性を確保し、AWSのセキュリティ機能と統合されています。

**デフォルト**では、マウントするEFSフォルダは**`/`**になりますが、**異なる名前**になる可能性があります。

### ネットワークアクセス

EFSはVPC内で作成され、**デフォルトですべてのVPCサブネットからアクセス可能**です。ただし、EFSにはセキュリティグループがあります。EFSをマウントするためにEC2（または他のAWSサービス）にアクセス権を与えるには、EFSセキュリティグループで、EC2セキュリティグループからの**NFS（2049ポート）のインバウンドルールを許可する**必要があります。

これを行わないと、**NFSサービスに接続できません**。

これについて詳細を知りたい場合は、次を確認してください：[https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### 列挙
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
EFSのマウントポイントが同じVPC内にあるが異なるサブネットにある可能性があります。すべてのEFSポイントを見つけるためには、`/16`ネットマスクをスキャンすることがより良いでしょう。
{% endhint %}

### EFSのマウント

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### IAM Access

**デフォルト**では、EFSへの**ネットワークアクセスを持つ誰でも**、**ルートユーザーとして**マウント、**読み取り、書き込み**ができます。ただし、ファイルシステムポリシーにより、**特定の権限を持つプリンシパルのみがアクセスできるようになる**場合があります。\
たとえば、このファイルシステムポリシーは、**IAM権限を持っていない場合には**、ファイルシステムを**マウントできない**ようにします。
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
また、これにより**匿名アクセスが防止**されます：

<figure><img src="../../../.gitbook/assets/image (3) (6).png" alt=""><figcaption></figcaption></figure>

IAM で保護されたファイルシステムをマウントするには、マウントコマンドでタイプ "efs" を使用する必要があることに注意してください：
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### アクセスポイント

**アクセスポイント**は、共有データセットへのアプリケーションアクセスを管理しやすくする、**EFSファイルシステムへのアプリケーション固有のエントリーポイント**です。

アクセスポイントを作成すると、**ファイルやディレクトリの所有者やPOSIX権限**を指定できます。また、アクセスポイントを通じて作成されるファイルやディレクトリのために、**カスタムルートディレクトリを定義**することもできます。既存のディレクトリを指定するか、所望の権限で新しいディレクトリを作成することで、**EFSファイルシステムへのアクセスをアプリケーションやユーザーごとに制御**できます。これにより、共有ファイルデータの管理とセキュリティが容易になります。

**アクセスポイントからファイルシステムをマウントすることができます。**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
アクセスポイントをマウントしようとしても、**ネットワーク経由でNFSサービスにアクセスできる必要があり**、EFSにファイルシステムの**ポリシー**がある場合は、それをマウントするために**十分なIAM権限**が必要です。
{% endhint %}

アクセスポイントは以下の目的で使用できます：

- **権限管理の簡素化**：各アクセスポイントに対してPOSIXユーザーとグループを定義することで、基礎となるファイルシステムの権限を変更せずに、異なるアプリケーションやユーザーのアクセス権限を簡単に管理できます。
- **ルートディレクトリの強制**：アクセスポイントは、EFSファイルシステム内の特定のディレクトリへのアクセスを制限でき、各アプリケーションやユーザーが指定されたフォルダ内で操作することを保証します。これにより、データの誤表示や変更を防ぐのに役立ちます。
- **ファイルシステムへの簡単なアクセス**：アクセスポイントは、AWS Lambda関数やAWS Fargateタスクに関連付けることができ、サーバーレスおよびコンテナ化されたアプリケーションのファイルシステムアクセスを簡素化します。

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>を使って、ゼロからヒーローまでAWSハッキングを学びましょう！</summary>

HackTricksをサポートする他の方法：

- **HackTricksの広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れる
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
- **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>
