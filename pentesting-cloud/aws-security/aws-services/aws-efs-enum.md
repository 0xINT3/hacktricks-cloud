# AWS - EFS 枚举

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## EFS

### 基本信息

Amazon Elastic File System (EFS) 是AWS提供的一个完全**托管的、可扩展的、弹性的网络文件系统**。它允许创建和配置**跨多个** EC2实例和其他AWS服务共享的**文件系统**。EFS自动扩展，提供低延迟访问，支持高吞吐量工作负载，确保数据持久性，并与AWS安全功能集成。

**默认情况下**，要挂载的EFS文件夹将是**`/`**，但它可能有一个**不同的名称**。

### 网络访问

EFS是在VPC中创建的，并且**默认情况下在所有VPC子网中可访问**。然而，EFS将有一个安全组。为了**允许EC2**（或任何其他AWS服务）挂载EFS，需要在EFS安全组中**允许来自EC2安全组的入站NFS**（2049端口）**规则**。

如果没有这个，您**将无法联系NFS服务**。

有关如何执行此操作的更多信息，请查看：[https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### 枚举
```bash
# Get filesystems and access policies (if any)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Get subnetworks and IP addresses where you can find the file system
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>
aws ec2 describe-security-groups --group-ids <sg_id>

# Get other access points
aws efs describe-access-points

# Get replication configurations
aws efs describe-replication-configurations

# Search for NFS in EC2 networks
sudo nmap -T4 -Pn -p 2049 --open 10.10.10.0/20 # or /16 to be sure
```
{% hint style="danger" %}
可能EFS挂载点位于同一个VPC中，但在不同的子网内。如果你想确保找到所有**EFS点，最好扫描`/16`子网掩码**。
{% endhint %}

### 挂载EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Mount found
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Mount with efs type
## You need to have installed the package amazon-efs-utils
sudo yum install amazon-efs-utils # If centos
sudo apt-get install amazon-efs-utils # If ubuntu
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
### IAM 访问权限

**默认情况下**，任何拥有**EFS 网络访问权限**的人都能够挂载、**以 root 用户身份读写**。然而，可能会有文件系统策略，**只允许拥有特定权限的主体**访问它。\
例如，如果你**没有 IAM 权限**，这个文件系统策略甚至**不允许挂载**文件系统：
```json
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
"Statement": [
{
"Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "",
"Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
或者这将**阻止匿名访问**：

<figure><img src="../../../.gitbook/assets/image (3) (6).png" alt=""><figcaption></figcaption></figure>

请注意，要挂载受IAM保护的文件系统，您必须在挂载命令中使用类型 "efs"：
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# To use a different pforile from ~/.aws/credentials
# You can use: -o tls,iam,awsprofile=namedprofile
```
### 访问点

**访问点**是指向**EFS文件系统**的**应用程序**特定入口点，它简化了管理应用程序对共享数据集的访问。

创建访问点时，您可以**指定通过访问点创建的文件和目录的所有者和POSIX权限**。您还可以**定义访问点的自定义根目录**，可以通过指定现有目录或创建具有所需权限的新目录来实现。这允许您**根据应用程序或用户来控制对EFS文件系统的访问**，从而更容易地管理和保护您的共享文件数据。

**您可以通过类似以下方式从访问点挂载文件系统：**
```bash
# Use IAM if you need to use iam permissions
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
<file-system-id/EFS DNS> /efs/
```
{% hint style="warning" %}
请注意，即使尝试挂载访问点，您仍然需要能够**通过网络联系NFS服务**，如果EFS有文件系统**策略**，您需要**足够的IAM权限**来挂载它。
{% endhint %}

访问点可用于以下目的：

* **简化权限管理**：通过为每个访问点定义POSIX用户和组，您可以轻松管理不同应用程序或用户的访问权限，无需修改底层文件系统的权限。
* **强制根目录**：访问点可以限制对EFS文件系统中特定目录的访问，确保每个应用程序或用户仅在其指定文件夹内操作。这有助于防止意外数据泄露或修改。
* **更容易的文件系统访问**：访问点可以与AWS Lambda函数或AWS Fargate任务关联，简化了无服务器和容器化应用程序的文件系统访问。

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws-efs-privesc.md](../aws-privilege-escalation/aws-efs-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-efs-post-exploitation.md" %}
[aws-efs-post-exploitation.md](../aws-post-exploitation/aws-efs-post-exploitation.md)
{% endcontent-ref %}

## Persistence

{% content-ref url="../aws-persistence/aws-efs-persistence.md" %}
[aws-efs-persistence.md](../aws-persistence/aws-efs-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
