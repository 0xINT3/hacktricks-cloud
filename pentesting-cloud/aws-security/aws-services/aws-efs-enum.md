# AWS - Enumera√ß√£o do EFS

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## EFS

### Informa√ß√µes b√°sicas

O Amazon Elastic File System (EFS) √© um sistema de arquivos de rede totalmente **gerenciado, escal√°vel e el√°stico** pela AWS. Ele permite criar e configurar **sistemas de arquivos compartilhados em v√°rias** inst√¢ncias EC2 e outros servi√ßos da AWS. O EFS dimensiona automaticamente, fornece acesso de baixa lat√™ncia, suporta cargas de trabalho de alto rendimento, garante a durabilidade dos dados e integra-se aos recursos de seguran√ßa da AWS.

Por **padr√£o**, a pasta EFS a ser montada ser√° **`/`**, mas ela pode ter um **nome diferente**.

### Acesso √† rede

Um EFS √© criado em uma VPC e seria **acess√≠vel por padr√£o em todas as sub-redes da VPC**. No entanto, o EFS ter√° um Grupo de Seguran√ßa. Para **dar acesso a uma EC2** (ou qualquer outro servi√ßo da AWS) para montar o EFS, √© necess√°rio **permitir no grupo de seguran√ßa do EFS uma regra NFS de entrada** (porta 2049) **do grupo de seguran√ßa da EC2**.

Sem isso, voc√™ **n√£o poder√° entrar em contato com o servi√ßo NFS**.

Para obter mais informa√ß√µes sobre como fazer isso, consulte: [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### Enumera√ß√£o

```bash
# Obter sistemas de arquivos e pol√≠ticas de acesso (se houver)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Obter sub-redes e endere√ßos IP onde voc√™ pode encontrar o sistema de arquivos
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>

# Obter outros pontos de acesso
aws efs describe-access-points

# Obter configura√ß√µes de replica√ß√£o
aws efs describe-replication-configurations

# Procurar NFS em redes EC2
nmap -Pn -p 2049 --open 10.10.10.0/24
```

### Montar EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Montagem encontrada
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Montagem com tipo efs
## Voc√™ precisa ter instalado o pacote amazon-efs-utils
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Acesso IAM

Por **padr√£o**, qualquer pessoa com **acesso √† rede ao EFS** poder√° mont√°-lo, **ler e grav√°-lo, mesmo como usu√°rio root**. No entanto, as pol√≠ticas do sistema de arquivos podem estar em vigor, **permitindo apenas que os princ√≠pios com permiss√µes espec√≠ficas** acessem.\
Por exemplo, esta pol√≠tica do sistema de arquivos **n√£o permitir√° nem mesmo montar** o sistema de arquivos se voc√™ **n√£o tiver a permiss√£o IAM**:

```json
{
    "Version": "2012-10-17",
    "Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
    "Statement": [
        {
            "Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "",
            "Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
            "Condition": {
                "Bool": {
                    "elasticfilesystem:AccessedViaMountTarget": "true"
                }
            }
        }
    ]
}
```

Observe que para montar sistemas de arquivos protegidos pelo IAM, voc√™ DEVE usar o tipo "efs" no comando de montagem:

```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# Para usar um perfil diferente de ~/.aws/credentials
# Voc√™ pode usar: -o tls,iam,awsprofile=namedprofile
```

### Pontos de acesso

**Pontos de acesso** s√£o pontos de entrada **espec√≠ficos de aplicativos** em um sistema de arquivos EFS que tornam mais f√°cil gerenciar o acesso do aplicativo a conjuntos de dados compartilhados.

Ao criar um ponto de acesso, voc√™ pode **especificar o propriet√°rio e as permiss√µes POSIX** para os arquivos e diret√≥rios criados por meio do ponto de acesso. Voc√™ tamb√©m pode **definir um diret√≥rio raiz personalizado** para o ponto de acesso, seja especificando um diret√≥rio existente ou criando um novo com as permiss√µes desejadas. Isso permite que voc√™ **controle o acesso ao seu sistema de arquivos EFS em uma base de aplicativo ou usu√°rio**, tornando mais f√°cil gerenciar e proteger seus dados de arquivo compartilhados.

**Voc√™ pode montar o sistema de arquivos a partir de um ponto de acesso com algo como:**

```bash
# Use IAM se precisar usar permiss√µes iam
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
    <file-system-id/EFS DNS> /efs/
```

{% hint style="warning" %}
Observe que mesmo tentando montar um ponto de acesso, voc√™ ainda precisa ser capaz de **entrar em contato com o servi√ßo NFS via rede**, e se o EFS tiver uma pol√≠tica de sistema de arquivos, voc√™ precisar√° de **permiss√µes IAM suficientes** para mont√°-lo.
{% endhint %}

Os pontos de acesso podem ser usados para os seguintes fins:

* **Simplificar o gerenciamento de permiss√µes**: definindo um usu√°rio e grupo POSIX para cada ponto de acesso, voc√™ pode gerenciar facilmente as permiss√µes de acesso para diferentes aplicativos ou usu√°rios sem modificar as permiss√µes do sistema de arquivos subjacente.
* **Aplicar um diret√≥rio raiz**: os pontos de acesso podem restringir o acesso a um diret√≥rio espec√≠fico dentro do sistema de arquivos EFS, garantindo que cada aplicativo ou usu√°rio opere dentro de sua pasta designada. Isso ajuda a evitar a exposi√ß√£o ou modifica√ß√£o acidental de dados.
* **Acesso mais f√°cil ao sistema de arquivos**: os pontos de acesso podem ser associados a uma fun√ß√£o AWS Lambda ou a uma tarefa AWS Fargate, simplificando o acesso ao sistema de arquivos para aplicativos sem servidor e containerizados.

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-efs-privesc.md" %}
[aws