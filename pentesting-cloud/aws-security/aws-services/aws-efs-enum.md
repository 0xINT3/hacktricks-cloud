# AWS - EFS Enum

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## EFS

### Informations de base

Amazon Elastic File System (EFS) est un syst√®me de fichiers r√©seau enti√®rement **g√©r√©, √©volutif et √©lastique** par AWS. Il permet de cr√©er et de configurer des **syst√®mes de fichiers partag√©s entre plusieurs** instances EC2 et autres services AWS. EFS s'adapte automatiquement, offre un acc√®s √† faible latence, prend en charge les charges de travail √† d√©bit √©lev√©, garantit la durabilit√© des donn√©es et s'int√®gre aux fonctionnalit√©s de s√©curit√© AWS.

Par **d√©faut**, le dossier EFS √† monter sera **`/`** mais il pourrait avoir un **nom diff√©rent**.

### Acc√®s r√©seau

Un EFS est cr√©√© dans un VPC et serait **par d√©faut accessible dans tous les sous-r√©seaux VPC**. Cependant, l'EFS aura un groupe de s√©curit√©. Pour **donner acc√®s √† un EC2** (ou tout autre service AWS) pour monter l'EFS, il est n√©cessaire de **permettre dans le groupe de s√©curit√© EFS une r√®gle NFS entrante** (port 2049) **√† partir du groupe de s√©curit√© EC2**.

Sans cela, vous **ne pourrez pas contacter le service NFS**.

Pour plus d'informations sur la fa√ßon de faire cela, consultez : [https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount](https://stackoverflow.com/questions/38632222/aws-efs-connection-timeout-at-mount)

### √ânum√©ration

```bash
# Obtenir les syst√®mes de fichiers et les politiques d'acc√®s (le cas √©ch√©ant)
aws efs describe-file-systems
aws efs describe-file-system-policy --file-system-id <id>

# Obtenir les sous-r√©seaux et les adresses IP o√π vous pouvez trouver le syst√®me de fichiers
aws efs describe-mount-targets --file-system-id <id>
aws efs describe-mount-target-security-groups --mount-target-id <id>

# Obtenir d'autres points d'acc√®s
aws efs describe-access-points

# Obtenir les configurations de r√©plication
aws efs describe-replication-configurations

# Recherchez NFS dans les r√©seaux EC2
nmap -Pn -p 2049 --open 10.10.10.0/24
```

### Monter EFS

{% code overflow="wrap" %}
```bash
sudo mkdir /efs

## Montage trouv√©
sudo apt install nfs-common
sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport <IP>:/ /efs

## Montage avec le type efs
## Vous devez avoir install√© le package amazon-efs-utils
sudo mount -t efs <file-system-id/EFS DNS name>:/ /efs/
```
{% endcode %}

### Acc√®s IAM

Par **d√©faut**, toute personne ayant **acc√®s r√©seau √† l'EFS** pourra le monter, **le lire et l'√©crire m√™me en tant qu'utilisateur root**. Cependant, des politiques de syst√®me de fichiers pourraient √™tre en place **ne permettant qu'aux principaux ayant des autorisations sp√©cifiques** d'y acc√©der.\
Par exemple, cette politique de syst√®me de fichiers **n'autorisera m√™me pas le montage** du syst√®me de fichiers si vous **n'avez pas la permission IAM** :

```json
{
    "Version": "2012-10-17",
    "Id": "efs-policy-wizard-2ca2ba76-5d83-40be-8557-8f6c19eaa797",
    "Statement": [
        {
            "Sid": "efs-statement-e7f4b04c-ad75-4a7f-a316-4e5d12f0dbf5",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "",
            "Resource": "arn:aws:elasticfilesystem:us-east-1:318142138553:file-system/fs-0ab66ad201b58a018",
            "Condition": {
                "Bool": {
                    "elasticfilesystem:AccessedViaMountTarget": "true"
                }
            }
        }
    ]
}
```

Notez que pour monter des syst√®mes de fichiers prot√©g√©s par IAM, vous DEVEZ utiliser le type "efs" dans la commande de montage :

```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
# Pour utiliser un profil diff√©rent de ~/.aws/credentials
# Vous pouvez utiliser : -o tls,iam,awsprofile=namedprofile
```

### Points d'acc√®s

Les **points d'acc√®s** sont des points d'entr√©e **sp√©cifiques √† une application** dans un syst√®me de fichiers EFS qui facilitent la gestion de l'acc√®s des applications aux ensembles de donn√©es partag√©s.

Lorsque vous cr√©ez un point d'acc√®s, vous pouvez **sp√©cifier le propri√©taire et les autorisations POSIX** pour les fichiers et r√©pertoires cr√©√©s via le point d'acc√®s. Vous pouvez √©galement **d√©finir un r√©pertoire racine personnalis√©** pour le point d'acc√®s, soit en sp√©cifiant un r√©pertoire existant, soit en en cr√©ant un nouveau avec les autorisations souhait√©es. Cela vous permet de **contr√¥ler l'acc√®s √† votre syst√®me de fichiers EFS sur une base d'application ou d'utilisateur**, ce qui facilite la gestion et la s√©curisation de vos donn√©es de fichiers partag√©s.

**Vous pouvez monter le syst√®me de fichiers √† partir d'un point d'acc√®s avec quelque chose comme :**

```bash
# Utilisez IAM si vous devez utiliser des autorisations iam
sudo mount -t efs -o tls,[iam],accesspoint=<access-point-id> \
    <file-system-id/EFS DNS> /efs/
```

{% hint style="warning" %}
Notez que m√™me en essayant de monter un point d'acc√®s, vous devez toujours √™tre en mesure de **contacter le service NFS via le r√©seau**, et si l'EFS a une politique de syst√®me de fichiers, vous avez besoin de **suffisamment d'autorisations IAM** pour le monter.
{% endhint %}

Les points d'acc√®s peuvent √™tre utilis√©s √† des fins suivantes :

* **Simplifier la gestion des autorisations** : En d√©finissant un utilisateur et un groupe POSIX pour chaque point d'acc√®s, vous pouvez facilement g√©rer les autorisations d'acc√®s pour diff√©rentes applications ou utilisateurs sans modifier les autorisations du syst√®me de fichiers sous-jacent.
* **Appliquer un r√©pertoire racine** : Les points d'acc√®s peuvent restreindre l'acc√®s √† un r√©pertoire sp√©cifique dans le syst√®me de fichiers EFS, en veillant √† ce que chaque application ou utilisateur fonctionne dans son dossier d√©sign√©. Cela aide √† pr√©venir l'exposition ou la modification accidentelle des donn√©es.
* **Acc√®s plus facile au syst√®me de fichiers** : Les points d