# AWS - STS Enum

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## STS

**AWS Security Token Service (STS)** は主に**一時的で権限が限定された認証情報**を発行するために設計されています。これらの認証情報は、**AWS Identity and Access Management (IAM)** ユーザーや認証されたユーザー（フェデレーテッドユーザー）に対して要求することができます。

STSの目的が**アイデンティティのなりすましのための認証情報を発行すること**であるため、このサービスは**権限の昇格と持続性の維持**に非常に価値がありますが、選択肢が広くはありません。

### Assume Role Impersonation

AWS STSが提供する[AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html)アクションは、あるプリンシパルが別のプリンシパルの認証情報を取得し、事実上なりすますことを許可するため、非常に重要です。呼び出されると、指定されたARNに対応するアクセスキーID、シークレットキー、およびセッショントークンを応答します。

ペネトレーションテスターやレッドチームのメンバーにとって、このテクニックは権限の昇格に不可欠です（[**こちら**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)で詳しく説明されています）。ただし、このテクニックはかなり目立つため、攻撃者を驚かせることはないかもしれません。

#### Assume Role Logic

同じアカウント内でロールを引き受ける場合、**特定のロールARNを明示的に許可しているロールを引き受ける**ような場合は次のようになります：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
役割 **`priv-role`** は、この場合、その役割を引き受けるために**特に許可される必要はありません**（その許可で十分です）。

しかし、ある役割がアカウントにそれを引き受けることを許可している場合、以下のようになります：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
役割を引き受けようとする場合、その役割を引き受けるためには**特定の`sts:AssumeRole`権限**が必要です。

**異なるアカウントから役割を引き受けようとする場合**、引き受けられる役割はそれを許可している必要があります（役割の**ARN**または**外部アカウント**を指定していることを示す）、そして、他の役割を引き受けようとする役割は**必ず**引き受ける権限を**持っていなければなりません**（この場合、引き受けられる役割がARNを指定していても、これはオプションではありません）。

### 列挙
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### 権限昇格

以下のページでは、**STSの権限を悪用して権限を昇格させる方法**について確認できます：

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### 攻撃後の活動

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### 持続性

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## 参考文献

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加するか**、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
