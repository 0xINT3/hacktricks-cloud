# AWS - STS Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## STS

AWSは、AWS **Security Token Service (AWS STS)** をウェブサービスとして提供しており、AWS Identity and Access Management (IAM) ユーザーまたは認証されたユーザー（フェデレーテッドユーザー）のために、一時的な制限付き特権 **資格情報** を要求することができます。

STSサービスの性質上、**アイデンティティをなりすますための資格情報** を提供するため、このサービスはオプションが多くないにもかかわらず、特権のエスカレーションや持続性の獲得に非常に役立ちます。

### Assume Role Impersonation

AWS STSの[AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRole.html)アクションは、プリンシパルが他のプリンシパルの資格情報を要求してなりすますことを可能にします。呼び出すと、指定されたARNに対してアクセスキーID、シークレットキー、およびセッショントークンを返します。

ペネトレーションテスターやレッドチームのメンバーとして、このテクニックは特権のエスカレーションに役立ちます（[**こちら**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)で説明されています）。ただし、これは最も明白な特権のエスカレーションのテクニックであるため、攻撃者を驚かせることはありません。

#### Assume Role Logic

同じアカウント内でロールを仮定するためには、**仮定するロールが特定のロールARNを許可している**場合、次のようにします：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
この場合のロール **`priv-role`** は、その許可があれば、そのロールを特に許可する必要はありません。

ただし、ロールがアカウントに対してアサームすることを許可している場合、以下のようになります。
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
アサムする役割は、それをアサムするためにその役割に対して特定の`sts:AssumeRole`権限が必要です。

異なるアカウントから役割をアサムしようとする場合、アサムされる役割はそれを許可する必要があります（役割のARNまたは外部アカウントを示す）し、アサムしようとする役割はそれをアサムするための権限を持っている必要があります（この場合、アサムされる役割がARNを指定している場合でも、これはオプションではありません）。

### 列挙
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### Privesc

以下のページでは、**STSの権限を悪用して特権をエスカレーションする方法**を確認することができます：

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## References

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
