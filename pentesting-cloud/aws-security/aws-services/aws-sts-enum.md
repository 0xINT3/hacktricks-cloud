# AWS - STS枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## STS

AWS提供AWS **Security Token Service (AWS STS)** 作为一个Web服务，使您能够为AWS Identity and Access Management (IAM) 用户或您认证的用户（联合用户）**请求**临时的、有限的**凭证**。

由于STS服务的性质是**提供凭证以模拟身份**，即使选项不多，该服务也非常有用于**升级权限和获取持久性**。

### 扮演角色

AWS STS的[AssumeRole](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html)操作允许一个主体请求另一个主体的凭证以模拟他。调用它时，它会返回指定ARN的访问密钥ID、秘密密钥和会话令牌。

作为渗透测试人员或红队人员，这种技术对于特权升级很有用（如[**此处**](../aws-privilege-escalation/aws-sts-privesc.md#sts-assumerole)所述），但这是最明显的特权升级技术，所以不会让攻击者感到意外。

#### 扮演角色逻辑

为了在同一个账户中扮演一个角色，如果**要扮演的角色允许特定的角色ARN**，就像在下面的例子中：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:role/priv-role"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
在这种情况下，角色**`priv-role`**不需要被特别允许扮演该角色（只要有这个允许就足够了）。

然而，如果一个角色允许一个账户扮演它，就像这样：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<acc_id>:root"
},
"Action": "sts:AssumeRole",
"Condition": {}
}
]
}
```
尝试扮演的角色需要对该角色具有特定的`sts:AssumeRole`权限来进行扮演。

如果您尝试从不同的账户扮演一个角色，那么被扮演的角色必须允许此操作（指定角色的ARN或外部账户），而尝试扮演其他角色的角色必须具有扮演该角色的权限（即使被扮演的角色指定了ARN，在这种情况下，这是必需的）。

### 枚举
```bash
# Get basic info of the creds
aws sts get-caller-identity
aws sts get-access-key-info --access-key-id <AccessKeyID>

# Get CLI a session token with current creds
## Using CLI creds
## You cannot get session creds using session creds
aws sts get-session-token
## MFA
aws sts get-session-token --serial-number <arn_device> --token-code <otp_code>
```
### 提权

在下面的页面中，您可以查看如何滥用STS权限以提升特权：

{% content-ref url="../aws-privilege-escalation/aws-sts-privesc.md" %}
[aws-sts-privesc.md](../aws-privilege-escalation/aws-sts-privesc.md)
{% endcontent-ref %}

### 漏洞利用后期阶段

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-sts-post-exploitation.md" %}
[aws-sts-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-sts-post-exploitation.md)
{% endcontent-ref %}

### 持久化

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## 参考资料

* [https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/?utm\_source=pocket\_mylist)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的动态 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
