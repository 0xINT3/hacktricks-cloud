# AWS - Directory Services / Enumerazione di WorkDocs

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Directory Services

Il servizio di directory AWS per Microsoft Active Directory √® un servizio gestito che facilita la **configurazione, l'operativit√† e la scalabilit√† di una directory** nel cloud AWS. √à basato su **Microsoft Active Directory** e si integra strettamente con altri servizi AWS, semplificando la gestione dei carichi di lavoro consapevoli della directory e delle risorse AWS. Con AWS Managed Microsoft AD, √® possibile **utilizzare gli utenti, i gruppi e le policy esistenti** di Active Directory per gestire l'accesso alle risorse AWS. Ci√≤ pu√≤ contribuire a semplificare la gestione delle identit√† e ridurre la necessit√† di soluzioni di identit√† aggiuntive. AWS Managed Microsoft AD fornisce anche backup automatici e funzionalit√† di ripristino di emergenza, contribuendo a garantire la disponibilit√† e la durabilit√† della directory. In generale, AWS Directory Service for Microsoft Active Directory pu√≤ aiutarti a risparmiare tempo e risorse fornendo un servizio di Active Directory gestito, altamente disponibile e scalabile nel cloud AWS.

### Opzioni

Directory Services consente di creare 5 tipi di directory:

* **AWS Managed Microsoft AD**: che eseguir√† un nuovo **Microsoft AD in AWS**. Sar√† possibile impostare la password dell'amministratore e accedere ai DC in una VPC.
* **Simple AD**: che sar√† un server **Linux-Samba** compatibile con Active Directory. Sar√† possibile impostare la password dell'amministratore e accedere ai DC in una VPC.
* **AD Connector**: un proxy per **reindirizzare le richieste di directory al tuo esistente Microsoft Active Directory** senza memorizzare alcuna informazione nel cloud. Sar√† in ascolto in una **VPC** e sar√† necessario fornire **credenziali per accedere all'AD esistente**.
* **Amazon Cognito User Pools**: √® lo stesso di Cognito User Pools.
* **Cloud Directory**: √® il pi√π **semplice**. Una directory **serverless** in cui si indica lo **schema** da utilizzare e si viene **fatturati in base all'utilizzo**.

I servizi di directory AWS consentono di **sincronizzare** con il proprio **Microsoft AD on-premises** esistente, **eseguire il proprio** in AWS o sincronizzarsi con **altri tipi di directory**.

### Laboratorio

Qui puoi trovare un bel tutorial per creare il tuo Microsoft AD in AWS: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### Enumerazione
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Accesso

Nota che se la **descrizione** della directory contiene un **dominio** nel campo **`AccessUrl`**, √® perch√© un **utente** probabilmente pu√≤ **accedere** a alcuni **servizi AWS** con le sue **credenziali AD**:

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Amazon Management Console)
* `<name>.awsapps.com/start` (IAM Identity Center)

### Escalation dei privilegi

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistenza

### Utilizzando un utente AD

Un **utente AD** pu√≤ essere dato **accesso alla console di gestione AWS** tramite un ruolo da assumere. Il **nome utente predefinito √® Admin** ed √® possibile **cambiare la sua password** dalla console AWS.

Pertanto, √® possibile **cambiare la password di Admin**, **creare un nuovo utente** o **cambiare la password** di un utente e concedere a quell'utente un ruolo per mantenere l'accesso.\
√à anche possibile **aggiungere un utente a un gruppo all'interno di AD** e **dare a quel gruppo AD accesso a un ruolo** (per rendere questa persistenza pi√π stealth).

### Condivisione AD (da vittima ad attaccante)

√à possibile condividere un ambiente AD da una vittima a un attaccante. In questo modo, l'attaccante sar√† in grado di continuare ad accedere all'ambiente AD.\
Tuttavia, ci√≤ implica la condivisione dell'AD gestito e la creazione di una connessione di VPC peering.

Puoi trovare una guida qui: [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Condivisione AD (da attaccante a vittima)~~

Non sembra possibile concedere l'accesso AWS agli utenti provenienti da un ambiente AD diverso a un account AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs √® un servizio di **archiviazione e condivisione di file basato su cloud**. Fa parte della suite di servizi di cloud computing di AWS ed √® progettato per fornire una soluzione sicura e scalabile per le organizzazioni per archiviare, condividere e collaborare su file e documenti.

AWS WorkDocs fornisce un'interfaccia basata sul web per gli utenti per caricare, accedere e gestire i propri file e documenti. Offre anche funzionalit√† come il controllo delle versioni, la collaborazione in tempo reale e l'integrazione con altri servizi AWS e strumenti di terze parti.

### Enumerazione

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
{% endcode %}

### Privesc

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
