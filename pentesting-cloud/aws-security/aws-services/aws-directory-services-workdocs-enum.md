# AWS - Services d'annuaire / √ânum√©ration WorkDocs

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Services d'annuaire

AWS Directory Service pour Microsoft Active Directory est un service g√©r√© qui facilite la **mise en place, l'exploitation et la mise √† l'√©chelle d'un annuaire** dans le Cloud AWS. Il est construit sur le v√©ritable **Microsoft Active Directory** et s'int√®gre √©troitement avec d'autres services AWS, ce qui facilite la gestion de vos charges de travail conscientes de l'annuaire et des ressources AWS. Avec AWS Managed Microsoft AD, vous pouvez **utiliser vos utilisateurs, groupes et politiques Active Directory existants** pour g√©rer l'acc√®s √† vos ressources AWS. Cela peut aider √† simplifier votre gestion des identit√©s et r√©duire le besoin de solutions d'identit√© suppl√©mentaires. AWS Managed Microsoft AD fournit √©galement des sauvegardes automatiques et des capacit√©s de r√©cup√©ration apr√®s sinistre, aidant √† assurer la disponibilit√© et la durabilit√© de votre annuaire. Dans l'ensemble, AWS Directory Service pour Microsoft Active Directory peut vous aider √† √©conomiser du temps et des ressources en fournissant un service Active Directory g√©r√©, hautement disponible et √©volutif dans le Cloud AWS.

### Options

Les Services d'annuaire permettent de cr√©er 5 types d'annuaires :

* **AWS Managed Microsoft AD** : Qui ex√©cutera un nouveau **Microsoft AD dans AWS**. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **Simple AD** : Qui sera un serveur compatible Active Directory **Linux-Samba**. Vous pourrez d√©finir le mot de passe administrateur et acc√©der aux DC dans un VPC.
* **AD Connector** : Un proxy pour **rediriger les demandes d'annuaire vers votre Microsoft Active Directory existant** sans mettre en cache aucune information dans le cloud. Il sera √† l'√©coute dans un **VPC** et vous devrez fournir des **identifiants pour acc√©der √† l'AD existant**.
* **Amazon Cognito User Pools** : C'est la m√™me chose que Cognito User Pools.
* **Cloud Directory** : C'est le plus **simple**. Un annuaire **sans serveur** o√π vous indiquez le **sch√©ma** √† utiliser et √™tes **factur√© selon l'utilisation**.

Les services d'annuaire AWS permettent de **synchroniser** avec votre Microsoft AD **sur site** existant, **d'ex√©cuter le v√¥tre** dans AWS ou de se synchroniser avec **d'autres types d'annuaires**.

### Lab

Ici, vous pouvez trouver un bon tutoriel pour cr√©er votre propre Microsoft AD dans AWS : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/ms\_ad\_tutorial\_test\_lab\_base.html)

### √ânum√©ration
```bash
# Get directories and DCs
aws ds describe-directories
aws ds describe-domain-controllers --directory-id <id>
# Get directory settings
aws ds describe-trusts
aws ds describe-ldaps-settings --directory-id <id>
aws ds describe-shared-directories --owner-directory-id <id>
aws ds get-directory-limits
aws ds list-certificates --directory-id <id>
aws ds describe-certificate --directory-id <id> --certificate-id <id>
```
### Connexion

Notez que si la **description** du r√©pertoire contenait un **domaine** dans le champ **`AccessUrl`**, c'est parce qu'un **utilisateur** peut probablement se **connecter** avec ses **identifiants AD** √† certains **services AWS :**

* `<name>.awsapps.com/connect` (Amazon Connect)
* `<name>.awsapps.com/workdocs` (Amazon WorkDocs)
* `<name>.awsapps.com/workmail` (Amazon WorkMail)
* `<name>.awsapps.com/console` (Console de gestion Amazon)
* `<name>.awsapps.com/start` (IAM Identity Center)

### √âl√©vation de privil√®ges

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md" %}
[aws-directory-services-privesc.md](../../aws-security/aws-privilege-escalation/aws-directory-services-privesc.md)
{% endcontent-ref %}

## Persistance

### Utilisation d'un utilisateur AD

Un **utilisateur AD** peut se voir accorder **l'acc√®s √† la console de gestion AWS** via un R√¥le √† assumer. Le **nom d'utilisateur par d√©faut est Admin** et il est possible de **changer son mot de passe** depuis la console AWS.

Par cons√©quent, il est possible de **changer le mot de passe d'Admin**, **cr√©er un nouvel utilisateur** ou **changer le mot de passe** d'un utilisateur et lui accorder un R√¥le pour maintenir l'acc√®s.\
Il est √©galement possible **d'ajouter un utilisateur √† un groupe dans AD** et **donner √† ce groupe AD l'acc√®s √† un R√¥le** (pour rendre cette persistance plus discr√®te).

### Partage AD (de la victime √† l'attaquant)

Il est possible de partager un environnement AD d'une victime √† un attaquant. Ainsi, l'attaquant pourra continuer √† acc√©der √† l'env. AD.\
Cependant, cela implique de partager l'AD g√©r√© et aussi de cr√©er une connexion de peering VPC.

Vous pouvez trouver un guide ici : [https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html](https://docs.aws.amazon.com/directoryservice/latest/admin-guide/step1\_setup\_networking.html)

### ~~Partage AD (de l'attaquant √† la victime)~~

Il ne semble pas possible d'accorder l'acc√®s AWS √† des utilisateurs provenant d'un env. AD diff√©rent √† un compte AWS.

## WorkDocs

Amazon Web Services (AWS) WorkDocs est un service de **stockage et de partage de fichiers bas√© sur le cloud**. Il fait partie de la suite de services de cloud computing d'AWS et est con√ßu pour fournir une solution s√©curis√©e et √©volutive pour les organisations afin de stocker, partager et collaborer sur des fichiers et des documents.

AWS WorkDocs offre une interface web permettant aux utilisateurs de t√©l√©charger, acc√©der et g√©rer leurs fichiers et documents. Il propose √©galement des fonctionnalit√©s telles que le contr√¥le de version, la collaboration en temps r√©el et l'int√©gration avec d'autres services AWS et outils tiers.

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# Get AD users (Admin not included)
aws workdocs describe-users --organization-id <directory-id>
# Get AD groups (containing "a")
aws workdocs describe-groups --organization-id d-9067a0285c --search-query a

# Create user (created inside the AD)
aws workdocs create-user --username testingasd --given-name testingasd --surname testingasd --password <password> --email-address name@directory.domain --organization-id <directory-id>

# Get what each user has created
aws workdocs describe-activities --user-id "S-1-5-21-377..."

# Get what was created in the directory
aws workdocs describe-activities --organization-id <directory-id>

# Get folder content
aws workdocs describe-folder-contents --folder-id <fold-id>

# Get file (a url to access with the content will be retreived)
aws workdocs get-document --document-id <doc-id>

# Get resource permissions if any
aws workdocs describe-resource-permissions --resource-id <value>

# Add permission so anyway can see the file
aws workdocs add-resource-permissions --resource-id <id> --principals Id=anonymous,Type=ANONYMOUS,Role=VIEWER
## This will give an id, the file will be acesible in: https://<name>.awsapps.com/workdocs/index.html#/share/document/<id>
```
```markdown
{% endcode %}

### √âl√©vation de privil√®ges

{% content-ref url="../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md" %}
[aws-workdocs-privesc.md](../../aws-security/aws-privilege-escalation/aws-workdocs-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
