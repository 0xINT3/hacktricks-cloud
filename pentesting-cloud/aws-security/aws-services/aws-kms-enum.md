# AWS - KMS Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## KMS - キーマネジメントサービス

AWS Key Management Service (AWS KMS)は、ユーザーが**カスタマーマスターキー** (CMKs) を**作成および管理するプロセスを簡素化する**管理サービスとして提供されています。これらのCMKは、ユーザーデータの暗号化に不可欠です。AWS KMSの特筆すべき機能は、CMKが主に**ハードウェアセキュリティモジュール** (HSMs) によって保護されていることです。これにより、暗号化キーの保護が強化されます。

KMSは**対称暗号方式**を使用します。これは、**休止状態の情報を暗号化するために使用されます**（例えば、S3内）。**転送中の情報を暗号化する**必要がある場合は、**TLS**のようなものを使用する必要があります。

KMSは**リージョン固有のサービス**です。

**Amazonの管理者はあなたのキーにアクセスできません**。彼らはあなたのキーを回復することができず、あなたのキーの暗号化を手伝うこともできません。AWSは単にオペレーティングシステムとその下にあるアプリケーションを管理するだけで、私たちが暗号化キーを管理し、それらのキーがどのように使用されるかを管理するのは私たちの責任です。

**カスタマーマスターキー** (CMK): 4KBまでのデータを暗号化できます。通常、DEK（データ暗号化キー）を作成、暗号化、および復号化するために使用されます。その後、DEKはデータを暗号化するために使用されます。

カスタマーマスターキー (CMK) は、AWS KMS内のマスターキーの論理的表現です。マスターキーの識別子やその他のメタデータに加えて、その作成日、説明、キーの状態など、**CMKにはデータを暗号化および復号化するために使用されるキーマテリアルが含まれています**。CMKを作成するとき、デフォルトではAWS KMSがそのCMKのキーマテリアルを生成します。ただし、キーマテリアルなしでCMKを作成し、その後自分のキーマテリアルをCMKにインポートすることを選択することもできます。

マスターキーには2種類あります：

* **AWS管理CMK：他のサービスがデータを暗号化するために使用されます**。それは、そのサービスがリージョンで作成したときに使用されます。最初にそのサービスで暗号化を実装するときに作成されます。3年ごとにローテーションされ、変更することはできません。
* **顧客管理CMK**：柔軟性、ローテーション、設定可能なアクセスおよびキーポリシー。キーの有効化と無効化。

**エンベロープ暗号化**は、Key Management Service (KMS)の文脈で：**データキーでデータを暗号化し、その後マスターキーでデータキーを暗号化する**二層階層システム。

### キーポリシー

これは**KMS内のキーを使用およびアクセスできる人を定義します**。

**デフォルトでは：**

*   KMSキーの所有者である**AWSアカウントにKMSキーへの完全アクセス権を与えます**。

他のAWSリソースポリシーとは異なり、AWS **KMSキーポリシーは自動的にアカウントまたはそのユーザーに権限を与えません**。アカウント管理者に権限を与えるためには、この権限を提供する**明示的なステートメントを含むキーポリシーが必要です**。

* アカウント(`"AWS": "arn:aws:iam::111122223333:root"`)にIAM権限を与えないと機能しません。
*   キーポリシーに加えて、IAMポリシーを使用してKMSキーへのアクセスを許可することができます。

**この権限がないと、キーへのアクセスを許可するIAMポリシーは効果がありません**が、キーへのアクセスを拒否するIAMポリシーは引き続き有効です。
* アカウント管理者にアクセス制御権限を与えることで、アカウントのルートユーザー（削除できない）を含む、キーが管理不能になるリスクを**軽減します**。

**デフォルトポリシー**の例：
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
**アカウントが許可されている場合**（`"arn:aws:iam::111122223333:root"`）、アカウントの**プリンシパル**はKMSキーを使用するためにIAM権限が**まだ必要です**。しかし、例えばロールの**ARN**が**Key Policy**で**特に許可されている**場合、そのロールはIAM権限を**必要としません**。
{% endhint %}

<details>

<summary>ポリシーの詳細</summary>

ポリシーの属性:

* JSONベースのドキュメント
* リソース --> 影響を受けるリソース（"\*"も可）
* アクション --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... （権限）
* 効果 --> 許可/拒否
* プリンシパル --> 影響を受けるarn
* 条件（オプション） --> 権限を与える条件

グラント:

* 他のAWSプリンシパルにあなたの権限を委任することを許可します。AWS KMS APIを使用して作成する必要があります。CMK識別子、グラント受領者プリンシパル、必要な操作レベル（Decrypt, Encrypt, GenerateDataKey...）を指定できます。
* グラントが作成されると、GrantTokenとGratIDが発行されます。

**アクセス**:

* **キーポリシー**経由 -- これが存在する場合、IAMポリシーに優先します。
* **IAMポリシー**経由
* **グラント**経由

</details>

### キー管理者

デフォルトのキー管理者:

* KMSの管理にはアクセスできますが、データの暗号化または復号化はできません。
* キー管理者リストに追加できるのはIAMユーザーとロールのみです（グループは不可）。
* 外部CMKを使用する場合、キー管理者はキーマテリアルのインポート権限を持ちます。

### CMKのローテーション

* 同じキーが長く使用されるほど、そのキーで暗号化されたデータが増え、キーが侵害された場合、リスクにさらされるデータの範囲が広がります。さらに、キーがアクティブである期間が長いほど、侵害される可能性が高まります。
* **KMSは顧客のキーを365日ごとにローテーションします**（または、いつでも手動でプロセスを実行できます）し、**AWSが管理するキーは3年ごと**にローテーションされ、この時間は変更できません。
* **古いキーは保持され**、ローテーション前に暗号化されたデータの復号化に使用されます。
* 侵害が発生した場合、キーのローテーションでは脅威を取り除くことはできませんが、**新しいデータは新しいキーで暗号化されます**。
* **CMK**が**無効**または**削除保留**の状態にある場合、CMKが再有効化されるか削除がキャンセルされるまで、KMSはキーローテーションを**実行しません**。

#### 手動ローテーション

* **新しいCMKを作成する必要があります**。その後、新しいCMK-IDが作成されるため、**アプリケーションを更新して**新しいCMK-IDを**参照する**必要があります。
* このプロセスを簡単にするために、キーIDを参照するために**エイリアスを使用**し、エイリアスが参照するキーを更新するだけです。
* 古いファイルを復号化するために**古いキーを保持する**必要があります。

オンプレミスのキーインフラストラクチャからキーをインポートすることができます。

### その他の関連するKMS情報

KMSの価格は、月ごとにすべてのサービスから受け取った暗号化/復号化リクエストの数に基づいています。

KMSはCloudTrailとの完全な監査およびコンプライアンス**統合を持っています**。ここでKMSに対して行われたすべての変更を監査できます。

KMSポリシーでは、以下のことができます:

* 誰がデータキーを作成できるか、どのサービスがこれらのキーを使用できるかを制限する
* システムが暗号化のみ、復号化のみ、または両方にアクセスすることを制限する
* システムがリージョンを越えてキーにアクセスすることを可能にするかどうかを定義する（ただし、KMSをホストしているリージョンで障害が発生すると、他のリージョンのシステムの可用性に影響を与えるため、推奨されません）。

リージョンを越えてキーを同期または移動/コピーすることはできません。リージョンを越えたアクセスを許可するルールのみを定義できます。

### 列挙
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### 権限昇格

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### 攻撃後の活動

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### 持続性

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## 参考文献

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
