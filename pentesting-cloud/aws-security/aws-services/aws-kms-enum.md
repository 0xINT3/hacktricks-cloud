# AWS - KMS Enum

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## KMS - Sleutelbestuursdiens

AWS Key Management Service (AWS KMS) word aangebied as 'n bestuurde diens wat die proses vir gebruikers vereenvoudig om **klantmeestersleutels te skep en te bestuur** (CMKs). Hierdie CMK's is integraal in die versleuteling van gebruikersdata. 'n Noemenswaardige kenmerk van AWS KMS is dat CMK's hoofsaaklik **beveilig word deur hardeware-sekuriteitsmodules** (HSM's), wat die beskerming van die versleutelingssleutels verbeter.

KMS maak gebruik van **simmetriese kriptografie**. Dit word gebruik om inligting as rus te **versleutel** (byvoorbeeld binne 'n S3). As jy inligting **tydens oordrag wil versleutel**, moet jy iets soos **TLS** gebruik.

KMS is 'n **diens wat spesifiek is vir 'n streek**.

**Administrateurs by Amazon het nie toegang tot jou sleutels nie**. Hulle kan jou sleutels nie herstel nie en hulle help jou nie met die versleuteling van jou sleutels nie. AWS administreer eenvoudig die bedryfstelsel en die onderliggende toepassing, en dit is aan ons om ons versleutelingssleutels te administreer en te administreer hoe daardie sleutels gebruik word.

**Klantmeestersleutels** (CMK): Kan data versleutel tot 'n grootte van 4KB. Dit word tipies gebruik om die DEK's (Data Encryption Keys) te skep, te versleutel en te ontsleutel. Die DEK's word dan gebruik om die data te versleutel.

'n Klantmeestersleutel (CMK) is 'n logiese voorstelling van 'n meestersleutel in AWS KMS. Naas die identifiseerders en ander metadata van die meestersleutel, insluitend sy skeppingsdatum, beskrywing en sleutelstatus, bevat 'n **CMK die sleutelmateriaal wat gebruik word om data te versleutel en te ontsleutel**. Wanneer jy 'n CMK skep, genereer AWS KMS standaard die sleutelmateriaal vir daardie CMK. Jy kan egter kies om 'n CMK sonder sleutelmateriaal te skep en dan jou eie sleutelmateriaal in daardie CMK in te voer.

Daar is 2 tipes meestersleutels:

* **AWS-bestuurde CMK's: Gebruik deur ander dienste om data te versleutel**. Dit word gebruik deur die diens wat dit in 'n streek geskep het. Dit word elke 3 jaar geroteer en dit is nie moontlik om dit te verander nie.
* **Klantbestuurde CMK's**: Buigsaamheid, rotasie, konfigureerbare toegang en sleutelbeleid. Aktiveer en deaktiveer sleutels.

**Envelopversleuteling** in die konteks van Key Management Service (KMS): 'n Twee-vlak-hierargiestelsel om data met 'n data-sleutel te **versleutel en dan die data-sleutel met 'n meestersleutel te versleutel**.

### Sleutelbeleide

Hierdie definieer **wie 'n sleutel in KMS kan gebruik en toegang daartoe kan verkry**.

Standaard:

* Dit gee die **AWS-rekening wat die KMS-sleutel besit, volle toegang** tot die KMS-sleutel.

In teenstelling met ander AWS-bronbeleide, gee 'n AWS **KMS-sleutelbeleid nie outomaties toestemming aan die rekening of enige van sy gebruikers** nie. Om toestemming aan rekeningadministrateurs te gee, moet die **sleutelbeleid 'n eksplisiete verklaring** insluit wat hierdie toestemming verskaf, soos hierdie een.

* Sonder die toestemming (`"AWS": "arn:aws:iam::111122223333:root"`) sal IAM-permissies nie werk nie.
* Dit **stel die rekening in staat om IAM-beleide** te gebruik om toegang tot die KMS-sleutel toe te laat, bo die sleutelbeleid.

**Sonder hierdie toestemming is IAM-beleide wat toegang tot die sleutel toelaat, ondoeltreffend**, alhoewel IAM-beleide wat toegang tot die sleutel ontken, steeds doeltreffend is.

* Dit **verminder die risiko dat die sleutel onbestuurbaar word** deur toegangsbeheer aan die rekeningadministrateurs te gee, insluitend die rekening se hoofgebruiker wat nie uitgevee kan word nie.

Voorbeeld van **standaardbeleid**:

```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```

{% hint style="warning" %}
As die rekening toegelaat is (`"arn:aws:iam::111122223333:root"`), sal 'n hoofsaak van die rekening steeds IAM-toestemmings benodig om die KMS-sleutel te gebruik. As die ARN van 'n rol byvoorbeeld spesifiek toegelaat word in die Sleutelbeleid, benodig daardie rol nie IAM-toestemmings nie.
{% endhint %}

<details>

<summary>Beleidsbesonderhede</summary>

Eienskappe van 'n beleid:

* JSON-gebaseerde dokument
* Hulpbron --> Be√Ønvloede hulpbronne (kan "\*" wees)
* Aksie --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (toestemmings)
* Effek --> Toelaat/Weier
* Hoofsaak --> arn wat geaffekteer word
* Voorwaardes (opsioneel) --> Voorwaarde om die toestemmings te gee

Toekennings:

* Toelaat om jou toestemmings aan 'n ander AWS-hoofsaak binne jou AWS-rekening te delegeer. Jy moet hulle skep met behulp van die AWS KMS API's. Dit kan die CMK-identifiseerder, die begunstigde hoofsaak en die vereiste vlak van bedrywighede (Decrypt, Encrypt, GenerateDataKey...) aandui.
* Nadat die toekenning geskep is, word 'n GrantToken en 'n GratID uitgereik.

Toegang:

* Via **sleutelbeleid** -- As dit bestaan, het dit **voorrang** bo die IAM-beleid
* Via **IAM-beleid**
* Via **toekennings**

</details>

### Sleuteladministrateurs

Standaard sleuteladministrateur:

* Het toegang om KMS te bestuur, maar nie om data te enkripteer of dekripteer nie
* Slegs IAM-gebruikers en rolle kan by die lys Sleuteladministrateurs gevoeg word (nie groepe nie)
* As 'n eksterne CMK gebruik word, het Sleuteladministrateurs die toestemming om sleutelmateriaal in te voer

### Rotasie van CMK's

* Hoe langer dieselfde sleutel op sy plek bly, hoe meer data word daarmee enkripteer, en as daardie sleutel oortree word, hoe wyer die area van data wat in gevaar is. Daarbenewens neem die waarskynlikheid dat dit oortree word toe hoe langer die sleutel aktief is.
* **KMS roteer kli√´ntsleutels elke 365 dae** (of jy kan die proses handmatig uitvoer wanneer jy wil) en **sleutels wat deur AWS bestuur word elke 3 jaar**, en hierdie tyd kan nie verander word nie.
* **Ouer sleutels word behou** om data te dekripteer wat voor die rotasie enkripteer is.
* In 'n inbraak sal die rotasie van die sleutel die bedreiging nie verwyder nie, aangesien dit moontlik sal wees om alle data wat met die gekompromitteerde sleutel enkripteer is, te dekripteer. Die **nuwe data sal egter met die nuwe sleutel enkripteer word**.
* As die **CMK** in 'n toestand van **uitgeskakel** of **afwagting van uitwissing** is, sal KMS **nie 'n sleutelrotasie uitvoer** nie totdat die CMK weer geaktiveer word of die uitwissing gekanselleer word.

#### Handmatige rotasie

* 'n **Nuwe CMK moet geskep word**, dan word 'n nuwe CMK-ID geskep, sodat jy enige **toepassing moet opdateer** om na die nuwe CMK-ID te verwys.
* Om hierdie proses makliker te maak, kan jy **aliases gebruik om na 'n sleutel-ID te verwys** en dan net die sleutel opdateer waarna die alias verwys.
* Jy moet **ou sleutels behou om ou l√™ers te dekripteer** wat daarmee enkripteer is.

Jy kan sleutels van jou plaaslike sleutelinfrastruktuur invoer.

### Ander relevante KMS-inligting

KMS word geprys per aantal enkripteer-/dekripteerversoeke wat van alle dienste per maand ontvang word.

KMS het volledige oudit- en nakomingsintegrasie **met CloudTrail**; hier kan jy alle veranderinge wat op KMS uitgevoer is, oudit.

Met KMS-beleid kan jy die volgende doen:

* Beperk wie data-sleutels kan skep en watter dienste toegang het om hierdie sleutels te gebruik
* Beperk stelselstoegang om slegs te enkripteer, slegs te dekripteer of beide
* Definieer om stelsels toegang te gee tot sleutels oor streke (hoewel dit nie aanbeveel word nie, aangesien 'n fout in die streek wat KMS huisves, die beskikbaarheid van stelsels in ander streke sal be√Ønvloed).

Jy kan nie sleutels sinchroniseer of verskuif/kopieer oor streke nie; jy kan slegs re√´ls definieer om toegang oor streke toe te laat.

### Enumerasie

```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```

### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Volharding

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Verwysings

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy in HackTricks wil adverteer** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
