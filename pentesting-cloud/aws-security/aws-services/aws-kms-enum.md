# AWS - KMS Enum

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks in PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

## KMS - Schl√ºsselverwaltungsdienst

Der AWS Key Management Service (AWS KMS) wird als verwalteter Dienst pr√§sentiert, der es Benutzern erleichtert, **Kunden-Hauptschl√ºssel (CMKs) zu erstellen und zu verwalten**. Diese CMKs sind integral f√ºr die Verschl√ºsselung von Benutzerdaten. Ein bemerkenswertes Merkmal von AWS KMS ist, dass CMKs haupts√§chlich **durch Hardware-Sicherheitsmodule (HSMs) gesch√ºtzt** sind, was den Schutz der Verschl√ºsselungsschl√ºssel erh√∂ht.

KMS verwendet **symmetrische Verschl√ºsselung**. Diese wird verwendet, um Informationen **im Ruhezustand zu verschl√ºsseln** (zum Beispiel, innerhalb eines S3). Wenn Sie Informationen **im Transit verschl√ºsseln m√ºssen**, m√ºssen Sie etwas wie **TLS** verwenden.

KMS ist ein **regionsbezogener Dienst**.

**Administratoren bei Amazon haben keinen Zugriff auf Ihre Schl√ºssel**. Sie k√∂nnen Ihre Schl√ºssel nicht wiederherstellen und sie helfen Ihnen nicht bei der Verschl√ºsselung Ihrer Schl√ºssel. AWS verwaltet lediglich das Betriebssystem und die zugrunde liegende Anwendung, es liegt an uns, unsere Verschl√ºsselungsschl√ºssel zu verwalten und zu bestimmen, wie diese Schl√ºssel verwendet werden.

**Kunden-Hauptschl√ºssel** (CMK): K√∂nnen Daten bis zu einer Gr√∂√üe von 4 KB verschl√ºsseln. Sie werden in der Regel verwendet, um die DEKs (Data Encryption Keys) zu erstellen, zu verschl√ºsseln und zu entschl√ºsseln. Anschlie√üend werden die DEKs verwendet, um die Daten zu verschl√ºsseln.

Ein Kunden-Hauptschl√ºssel (CMK) ist eine logische Darstellung eines Hauptschl√ºssels in AWS KMS. Neben den Identifikatoren des Hauptschl√ºssels und anderen Metadaten, einschlie√ülich seines Erstellungsdatums, der Beschreibung und des Schl√ºsselzustands, enth√§lt ein **CMK das Schl√ºsselmaterial, das zur Verschl√ºsselung und Entschl√ºsselung von Daten verwendet wird**. Wenn Sie einen CMK erstellen, generiert AWS KMS standardm√§√üig das Schl√ºsselmaterial f√ºr diesen CMK. Sie k√∂nnen jedoch w√§hlen, einen CMK ohne Schl√ºsselmaterial zu erstellen und dann Ihr eigenes Schl√ºsselmaterial in diesen CMK zu importieren.

Es gibt 2 Arten von Hauptschl√ºsseln:

* **Von AWS verwaltete CMKs: Werden von anderen Diensten zur Verschl√ºsselung von Daten verwendet**. Sie werden vom Dienst erstellt, der sie in einer Region erstellt hat. Sie werden alle 3 Jahre rotiert und es ist nicht m√∂glich, sie zu √§ndern.
* **Kundenverwaltete CMKs**: Flexibilit√§t, Rotation, konfigurierbarer Zugriff und Schl√ºsselrichtlinie. Aktivieren und deaktivieren von Schl√ºsseln.

**Umschlagverschl√ºsselung** im Kontext des Key Management Service (KMS): Zweistufiges Hierarchiesystem, um **Daten mit Datenkey zu verschl√ºsseln und dann Datenkey mit Hauptschl√ºssel zu verschl√ºsseln**.

### Schl√ºsselrichtlinien

Diese definieren, **wer einen Schl√ºssel in KMS verwenden und darauf zugreifen kann**.

Standardm√§√üig:

* Es gibt dem **AWS-Konto, dem der KMS-Schl√ºssel geh√∂rt, uneingeschr√§nkten Zugriff** auf den KMS-Schl√ºssel.

Anders als bei anderen AWS-Richtlinien f√ºr Ressourcen gibt eine AWS **KMS-Schl√ºsselrichtlinie nicht automatisch Berechtigungen f√ºr das Konto oder seine Benutzer**. Um Kontoadministratoren Berechtigungen zu erteilen, muss die **Schl√ºsselrichtlinie eine explizite Aussage** enthalten, die diese Berechtigung erteilt, wie diese hier.

* Ohne die Erlaubnis des Kontos (`"AWS": "arn:aws:iam::111122223333:root"`) funktionieren IAM-Berechtigungen nicht.
* Es **erm√∂glicht dem Konto, IAM-Richtlinien zu verwenden**, um den Zugriff auf den KMS-Schl√ºssel zu erlauben, zus√§tzlich zur Schl√ºsselrichtlinie.

**Ohne diese Berechtigung sind IAM-Richtlinien, die den Zugriff auf den Schl√ºssel erlauben, unwirksam**, obwohl IAM-Richtlinien, die den Zugriff auf den Schl√ºssel verweigern, weiterhin wirksam sind.

* Es **verringert das Risiko, dass der Schl√ºssel unverwaltbar wird**, indem es den Kontoadministratoren Zugriffskontrollberechtigungen erteilt, einschlie√ülich des Kontowurzelbenutzers, der nicht gel√∂scht werden kann.

**Beispiel f√ºr Standardrichtlinie**:

```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```

{% hint style="warning" %}
Wenn das **Konto zugelassen ist** (`"arn:aws:iam::111122223333:root"`), wird ein **Hauptbenutzer** aus dem Konto immer noch IAM-Berechtigungen ben√∂tigen, um den KMS-Schl√ºssel zu verwenden. Wenn jedoch die **ARN** einer Rolle beispielsweise in der **Schl√ºsselpolitik ausdr√ºcklich zugelassen ist**, ben√∂tigt diese Rolle **keine IAM-Berechtigungen**.
{% endhint %}

<details>

<summary>Richtliniendetails</summary>

Eigenschaften einer Richtlinie:

* Dokument basierend auf JSON
* Ressource --> Betroffene Ressourcen (kann "\*" sein)
* Aktion --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (Berechtigungen)
* Effekt --> Erlauben/Verweigern
* Hauptbenutzer --> betroffene ARN
* Bedingungen (optional) --> Bedingung zur Erteilung der Berechtigungen

Zuweisungen:

* Erlauben, Ihre Berechtigungen an einen anderen AWS-Hauptbenutzer innerhalb Ihres AWS-Kontos zu delegieren. Sie m√ºssen sie mit den AWS KMS-APIs erstellen. Es kann der CMK-Identifier, der beg√ºnstigte Hauptbenutzer und das erforderliche Betriebsniveau (Entschl√ºsseln, Verschl√ºsseln, Generieren von Datenkeys...) angegeben werden.
* Nachdem die Zuweisung erstellt wurde, werden ein GrantToken und eine GrantID ausgestellt.

**Zugriff**:

* √úber **Schl√ºsselpolitik** -- Wenn diese existiert, hat diese **Vorrang** vor der IAM-Richtlinie
* √úber **IAM-Richtlinie**
* √úber **Zuweisungen**

</details>

### Schl√ºsseladministratoren

Schl√ºsseladministrator standardm√§√üig:

* Haben Zugriff auf das Verwalten von KMS, jedoch nicht auf das Verschl√ºsseln oder Entschl√ºsseln von Daten
* Nur IAM-Benutzer und -Rollen k√∂nnen der Liste der Schl√ºsseladministratoren hinzugef√ºgt werden (nicht Gruppen)
* Wenn ein externer CMK verwendet wird, haben Schl√ºsseladministratoren die Berechtigung, Schl√ºsselmaterial zu importieren

### Rotation von CMKs

* Je l√§nger derselbe Schl√ºssel an Ort und Stelle bleibt, desto mehr Daten werden mit diesem Schl√ºssel verschl√ºsselt, und wenn dieser Schl√ºssel kompromittiert wird, desto gr√∂√üer ist der Bereich der gef√§hrdeten Daten. Zus√§tzlich dazu steigt mit der Dauer, in der der Schl√ºssel aktiv ist, die Wahrscheinlichkeit, dass er kompromittiert wird.
* **KMS rotiert Kundenschl√ºssel alle 365 Tage** (oder Sie k√∂nnen den Prozess manuell durchf√ºhren, wann immer Sie m√∂chten) und **von AWS verwaltete Schl√ºssel alle 3 Jahre** und diese Zeit kann nicht ge√§ndert werden.
* **√Ñltere Schl√ºssel werden beibehalten**, um Daten zu entschl√ºsseln, die vor der Rotation verschl√ºsselt wurden.
* Bei einem Bruch wird das Drehen des Schl√ºssels die Bedrohung nicht beseitigen, da es m√∂glich sein wird, alle Daten zu entschl√ºsseln, die mit dem kompromittierten Schl√ºssel verschl√ºsselt wurden. Jedoch werden die **neuen Daten mit dem neuen Schl√ºssel verschl√ºsselt**.
* Wenn der **CMK** im Zustand **deaktiviert** oder **ausstehende** **L√∂schung** ist, wird KMS **keine Schl√ºsselrotation durchf√ºhren**, bis der CMK wieder aktiviert ist oder die L√∂schung abgebrochen wird.

#### Manuelle Rotation

* Ein **neuer CMK muss erstellt werden**, dann wird eine neue CMK-ID erstellt, sodass Sie alle **Anwendungen aktualisieren m√ºssen**, um auf die neue CMK-ID zu verweisen.
* Um diesen Prozess zu vereinfachen, k√∂nnen Sie **Aliasnamen verwenden, um auf eine Schl√ºssel-ID zu verweisen**, und dann einfach den Schl√ºssel aktualisieren, auf den der Alias verweist.
* Sie m√ºssen **alte Schl√ºssel behalten, um alte Dateien zu entschl√ºsseln**, die damit verschl√ºsselt wurden.

Sie k√∂nnen Schl√ºssel aus Ihrer lokalen Schl√ºsselinfrastruktur importieren.

### Weitere relevante KMS-Informationen

KMS wird pro Anzahl der Verschl√ºsselungs-/Entschl√ºsselungsanforderungen abgerechnet, die von allen Diensten pro Monat empfangen werden.

KMS verf√ºgt √ºber eine vollst√§ndige Audit- und Compliance-**Integration mit CloudTrail**; hier k√∂nnen Sie alle √Ñnderungen √ºberwachen, die an KMS vorgenommen wurden.

Mit der KMS-Richtlinie k√∂nnen Sie folgendes tun:

* Begrenzen, wer Datenkeys erstellen kann und welche Dienste Zugriff haben, um diese Schl√ºssel zu verwenden
* Begrenzen Sie den Systemzugriff auf nur Verschl√ºsseln, nur Entschl√ºsseln oder beides
* Definieren, um Systemen den Zugriff auf Schl√ºssel in verschiedenen Regionen zu erm√∂glichen (obwohl es nicht empfohlen wird, da ein Ausfall in der Region, die KMS hostet, die Verf√ºgbarkeit von Systemen in anderen Regionen beeintr√§chtigen wird).

Sie k√∂nnen Schl√ºssel nicht zwischen Regionen synchronisieren oder verschieben/kopieren; Sie k√∂nnen nur Regeln definieren, um den Zugriff zwischen Regionen zu erm√∂glichen.

### Enumeration

```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```

### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks in PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
