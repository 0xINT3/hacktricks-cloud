# AWS - KMS枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## KMS - 密钥管理服务

AWS密钥管理服务（AWS KMS）是一项托管服务，可帮助您轻松地**创建和控制客户主密钥**（CMK），即用于加密数据的加密密钥。AWS KMS CMK受到**硬件安全模块**（HSM）的保护。

KMS使用**对称加密**。这用于**加密信息的存储**（例如，在S3内部）。如果您需要**加密传输中的信息**，则需要使用类似**TLS**的东西。\
KMS是一个**特定于区域的服务**。

**亚马逊的管理员无法访问您的密钥**。他们无法恢复您的密钥，也无法帮助您加密密钥。AWS仅管理操作系统和底层应用程序，我们需要管理自己的加密密钥以及管理如何使用这些密钥。

**客户主密钥**（CMK）：可以加密最多4KB大小的数据。它们通常用于创建、加密和解密DEK（数据加密密钥）。然后使用DEK来加密数据。

客户主密钥（CMK）是AWS KMS中主密钥的逻辑表示。除了主密钥的标识符和其他元数据（包括创建日期、描述和密钥状态）之外，**CMK还包含用于加密和解密数据的密钥材料**。当您创建CMK时，默认情况下，AWS KMS会为该CMK生成密钥材料。但是，您可以选择创建一个没有密钥材料的CMK，然后将自己的密钥材料导入到该CMK中。

有两种类型的主密钥：

* **AWS托管的CMK：由其他服务用于加密数据**。它由在该区域创建它的服务使用。它们是在首次在该服务中实施加密时创建的。每3年轮换一次，无法更改。
* **客户管理的CMK**：灵活性、轮换、可配置的访问和密钥策略。启用和禁用密钥。

在密钥管理服务（KMS）的上下文中，**信封加密**是一种使用数据密钥加密数据，然后使用主密钥加密数据密钥的两层层次结构系统。

### 密钥策略

这些定义了在KMS中**谁可以使用和访问密钥**。

**默认情况下：**

* 它为**拥有KMS密钥的AWS账户提供完全访问权限**。

与其他AWS资源策略不同，AWS **KMS密钥策略不会自动授予账户或其任何用户权限**。要授予账户管理员权限，**密钥策略必须包含一个明确的声明**，提供此权限，如下所示。

* 如果不允许账户（`"AWS": "arn:aws:iam::111122223333:root"`），IAM权限将无法工作。
* 它**允许账户使用IAM策略**来允许访问KMS密钥，除了密钥策略。

**没有此权限，允许访问密钥的IAM策略将无效**，尽管拒绝访问密钥的IAM策略仍然有效。
* 它通过将访问控制权限授予账户管理员（包括无法删除的账户根用户）**降低了密钥变得无法管理的风险**。

**默认策略**示例：
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
如果**账户被允许**(`"arn:aws:iam::111122223333:root"`)，账户中的**主体仍然需要IAM权限**来使用KMS密钥。然而，如果在**密钥策略**中**明确允许**了角色的ARN，那么该角色**不需要IAM权限**。
{% endhint %}

<details>

<summary>策略详情</summary>

策略的属性：

* 基于JSON的文档
* 资源 --> 受影响的资源（可以是"\*"）
* 操作 --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ...（权限）
* 效果 --> 允许/拒绝
* 主体 --> 受影响的arn
* 条件（可选） --> 给予权限的条件

授权：

* 允许将权限委派给AWS账户内的另一个AWS主体。您需要使用AWS KMS API来创建它们。可以指定CMK标识符、受让人主体和所需的操作级别（Decrypt、Encrypt、GenerateDataKey...）
* 授权创建后，会发出GrantToken和GratID

**访问**：

* 通过**密钥策略** -- 如果存在，它将**优先于**IAM策略
* 通过**IAM策略**
* 通过**授权**

</details>

### 密钥管理员

默认情况下的密钥管理员：

* 具有管理KMS的访问权限，但无法加密或解密数据
* 只能将IAM用户和角色添加到密钥管理员列表中（不能添加组）
* 如果使用外部CMK，则密钥管理员具有导入密钥材料的权限

### CMK的轮换

* 同一个密钥在原地保留的时间越长，使用该密钥加密的数据就越多，如果该密钥被破坏，那么数据的影响范围就越广。此外，密钥活动的时间越长，被破坏的可能性就越大。
* **KMS每365天轮换客户密钥**（或者您可以随时手动执行该过程），而**由AWS管理的密钥每3年轮换**，这个时间是无法更改的。
* **旧密钥被保留**以解密在轮换之前加密的数据
* 在密钥被破坏的情况下，轮换密钥不会消除威胁，因为仍然可以解密使用被破坏密钥加密的所有数据。然而，**新数据将使用新密钥加密**。
* 如果**CMK**处于**禁用**或**待删除**状态，KMS将**不会执行密钥轮换**，直到CMK重新启用或取消删除。

#### 手动轮换

* 需要创建一个**新的CMK**，然后创建一个新的CMK-ID，因此您需要**更新**任何**应用程序**以**引用**新的CMK-ID。
* 为了更容易进行此过程，您可以**使用别名来引用密钥ID**，然后只需更新别名所引用的密钥。
* 您需要**保留旧密钥以解密使用旧密钥加密的旧文件**。

您可以从本地密钥基础设施导入密钥。

### 其他相关的KMS信息

KMS的定价是根据每月从所有服务接收到的加密/解密请求的数量。

KMS与CloudTrail完全集成，具有完整的审计和合规性功能；您可以在其中审计对KMS执行的所有更改。

使用KMS策略，您可以执行以下操作：

* 限制谁可以创建数据密钥以及哪些服务可以访问这些密钥
* 限制系统访问仅限加密、解密或两者
* 定义启用系统跨区域访问密钥（尽管不建议这样做，因为托管KMS的区域发生故障将影响其他区域中的系统的可用性）。

您无法同步或移动/复制密钥跨区域；您只能定义规则以允许跨区域访问。

### 枚举
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms describe-custom-key-stores
```
### 提权

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### 漏洞利用后

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### 持久化

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## 参考资料

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
