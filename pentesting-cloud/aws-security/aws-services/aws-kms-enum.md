# AWS - Enumera√ß√£o do KMS

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

## KMS - Servi√ßo de Gerenciamento de Chaves

O AWS Key Management Service (AWS KMS) √© um servi√ßo gerenciado que facilita a **cria√ß√£o e controle de chaves mestras do cliente** (CMKs), as chaves de criptografia usadas para criptografar seus dados. Os CMKs do AWS KMS s√£o **protegidos por m√≥dulos de seguran√ßa de hardware** (HSMs).

O KMS usa **criptografia sim√©trica**. Isso √© usado para **criptografar informa√ß√µes em repouso** (por exemplo, dentro de um S3). Se voc√™ precisa **criptografar informa√ß√µes em tr√¢nsito**, √© necess√°rio usar algo como **TLS**.\
O KMS √© um servi√ßo **espec√≠fico da regi√£o**.

**Os administradores da Amazon n√£o t√™m acesso √†s suas chaves**. Eles n√£o podem recuperar suas chaves e n√£o ajudam na criptografia de suas chaves. A AWS simplesmente administra o sistema operacional e o aplicativo subjacente, e cabe a n√≥s administrar nossas chaves de criptografia e como essas chaves s√£o usadas.

**Chaves Mestras do Cliente** (CMK): Podem criptografar dados de at√© 4KB de tamanho. Geralmente s√£o usadas para criar, criptografar e descriptografar as DEKs (Data Encryption Keys). Em seguida, as DEKs s√£o usadas para criptografar os dados.

Uma chave mestra do cliente (CMK) √© uma representa√ß√£o l√≥gica de uma chave mestra no AWS KMS. Al√©m dos identificadores da chave mestra e outros metadados, incluindo sua data de cria√ß√£o, descri√ß√£o e estado da chave, um **CMK cont√©m o material da chave que √© usado para criptografar e descriptografar dados**. Ao criar um CMK, por padr√£o, o AWS KMS gera o material da chave para esse CMK. No entanto, voc√™ pode optar por criar um CMK sem material da chave e, em seguida, importar seu pr√≥prio material da chave para esse CMK.

Existem 2 tipos de chaves mestras:

* **CMKs gerenciadas pela AWS: Usadas por outros servi√ßos para criptografar dados**. S√£o usadas pelo servi√ßo que as criou em uma regi√£o. Elas s√£o criadas na primeira vez que a criptografia √© implementada nesse servi√ßo. Rotacionam a cada 3 anos e n√£o √© poss√≠vel alter√°-las.
* **CMKs gerenciadas pelo cliente**: Flexibilidade, rota√ß√£o, acesso configur√°vel e pol√≠tica de chave. Habilita e desabilita chaves.

**Criptografia de Envelope** no contexto do Key Management Service (KMS): Sistema de hierarquia de dois n√≠veis para **criptografar dados com uma chave de dados e, em seguida, criptografar a chave de dados com a chave mestra**.

### Pol√≠ticas de Chave

Elas definem **quem pode usar e acessar uma chave no KMS**.

Por **padr√£o**:

*   Ela d√° √† **conta da AWS que possui a chave do KMS acesso total** √† chave do KMS.

Ao contr√°rio de outras pol√≠ticas de recursos da AWS, uma **pol√≠tica de chave do KMS n√£o concede automaticamente permiss√£o √† conta ou a qualquer um de seus usu√°rios**. Para conceder permiss√£o aos administradores da conta, a **pol√≠tica de chave deve incluir uma declara√ß√£o expl√≠cita** que forne√ßa essa permiss√£o, como esta.

* Sem permitir a conta (`"AWS": "arn:aws:iam::111122223333:root"`) as permiss√µes do IAM n√£o funcionar√£o.
*   Ela **permite que a conta use pol√≠ticas do IAM** para permitir acesso √† chave do KMS, al√©m da pol√≠tica de chave.

**Sem essa permiss√£o, as pol√≠ticas do IAM que permitem acesso √† chave s√£o ineficazes**, embora as pol√≠ticas do IAM que negam acesso √† chave ainda sejam eficazes.
* Ela **reduz o risco de a chave se tornar inadministr√°vel** ao conceder permiss√£o de controle de acesso aos administradores da conta, incluindo o usu√°rio raiz da conta, que n√£o pode ser exclu√≠do.

Exemplo de **pol√≠tica padr√£o**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Se a **conta estiver permitida** (`"arn:aws:iam::111122223333:root"`), um **principal** da conta ainda precisar√° de permiss√µes do IAM para usar a chave KMS. No entanto, se o **ARN** de uma fun√ß√£o, por exemplo, for **especificamente permitido** na **Pol√≠tica de Chave**, essa fun√ß√£o **n√£o precisar√° de permiss√µes do IAM**.
{% endhint %}

<details>

<summary>Detalhes da Pol√≠tica</summary>

Propriedades de uma pol√≠tica:

* Documento baseado em JSON
* Recurso --> Recursos afetados (pode ser "\*")
* A√ß√£o --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permiss√µes)
* Efeito --> Permitir/Negar
* Principal --> arn afetado
* Condi√ß√µes (opcional) --> Condi√ß√£o para conceder as permiss√µes

Concess√µes:

* Permitem delegar suas permiss√µes a outro principal da AWS dentro da sua conta da AWS. Voc√™ precisa cri√°-las usando as APIs do AWS KMS. Pode ser indicado o identificador do CMK, o principal do benefici√°rio e o n√≠vel de opera√ß√£o necess√°rio (Decrypt, Encrypt, GenerateDataKey...)
* Ap√≥s a concess√£o ser criada, um GrantToken e um GrantID s√£o emitidos

**Acesso**:

* Atrav√©s da **pol√≠tica de chave** -- Se existir, isso tem **preced√™ncia** sobre a pol√≠tica do IAM
* Atrav√©s da **pol√≠tica do IAM**
* Atrav√©s de **concess√µes**

</details>

### Administradores de Chave

Administrador de chave por padr√£o:

* Tem acesso para gerenciar o KMS, mas n√£o para criptografar ou descriptografar dados
* Apenas usu√°rios e fun√ß√µes do IAM podem ser adicionados √† lista de Administradores de Chave (n√£o grupos)
* Se um CMK externo for usado, os Administradores de Chave t√™m permiss√£o para importar material de chave

### Rota√ß√£o de CMKs

* Quanto mais tempo a mesma chave permanecer no lugar, mais dados ser√£o criptografados com essa chave, e se essa chave for comprometida, maior ser√° a √°rea de risco dos dados. Al√©m disso, quanto mais tempo a chave estiver ativa, maior a probabilidade de ela ser comprometida.
* O **KMS roda as chaves do cliente a cada 365 dias** (ou voc√™ pode realizar o processo manualmente quando quiser) e as **chaves gerenciadas pela AWS a cada 3 anos** e esse tempo n√£o pode ser alterado.
* **Chaves mais antigas s√£o mantidas** para descriptografar dados que foram criptografados antes da rota√ß√£o
* Em caso de viola√ß√£o, a rota√ß√£o da chave n√£o remover√° a amea√ßa, pois ser√° poss√≠vel descriptografar todos os dados criptografados com a chave comprometida. No entanto, os **novos dados ser√£o criptografados com a nova chave**.
* Se o **CMK** estiver no estado de **desabilitado** ou **pendente de exclus√£o**, o KMS **n√£o realizar√° uma rota√ß√£o da chave** at√© que o CMK seja reabilitado ou a exclus√£o seja cancelada.

#### Rota√ß√£o manual

* Uma **nova CMK precisa ser criada**, ent√£o, um novo CMK-ID √© criado, ent√£o voc√™ precisar√° **atualizar** qualquer **aplicativo** para **referenciar** o novo CMK-ID.
* Para facilitar esse processo, voc√™ pode **usar aliases para se referir a um ID de chave** e, em seguida, atualizar a chave para a qual o alias est√° se referindo.
* Voc√™ precisa **manter as chaves antigas para descriptografar arquivos antigos** criptografados com ela.

Voc√™ pode importar chaves de sua infraestrutura de chave local.

### Outras informa√ß√µes relevantes sobre o KMS

O KMS √© cobrado por n√∫mero de solicita√ß√µes de criptografia/descriptografia recebidas de todos os servi√ßos por m√™s.

O KMS possui integra√ß√£o completa de auditoria e conformidade com o CloudTrail; √© onde voc√™ pode auditar todas as altera√ß√µes realizadas no KMS.

Com a pol√≠tica do KMS, voc√™ pode fazer o seguinte:

* Limitar quem pode criar chaves de dados e quais servi√ßos t√™m acesso para usar essas chaves
* Limitar o acesso dos sistemas apenas para criptografar, descriptografar ou ambos
* Definir para permitir que os sistemas acessem chaves em v√°rias regi√µes (embora n√£o seja recomendado, pois uma falha na regi√£o que hospeda o KMS afetar√° a disponibilidade dos sistemas em outras regi√µes).

Voc√™ n√£o pode sincronizar ou mover/copiar chaves entre regi√µes; voc√™ s√≥ pode definir regras para permitir acesso entre regi√µes.

### Enumera√ß√£o
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
