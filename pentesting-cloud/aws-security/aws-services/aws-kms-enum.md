# AWS - KMS Enum

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS - Key Management Service

O AWS Key Management Service (AWS KMS) √© um servi√ßo gerenciado que facilita para voc√™ **criar e controlar chaves mestras do cliente** (CMKs), as chaves de criptografia usadas para criptografar seus dados. As CMKs do AWS KMS s√£o geralmente **protegidas por m√≥dulos de seguran√ßa de hardware** (HSMs).

O KMS utiliza **criptografia sim√©trica**. Isso √© usado para **criptografar informa√ß√µes em repouso** (por exemplo, dentro de um S3). Se voc√™ precisa **criptografar informa√ß√µes em tr√¢nsito**, voc√™ precisa usar algo como **TLS**.\
O KMS √© um **servi√ßo espec√≠fico de regi√£o**.

**Administradores na Amazon n√£o t√™m acesso √†s suas chaves**. Eles n√£o podem recuperar suas chaves e n√£o ajudam na criptografia das suas chaves. A AWS simplesmente administra o sistema operacional e a aplica√ß√£o subjacente, cabe a n√≥s administrar nossas chaves de criptografia e como essas chaves s√£o usadas.

**Chaves Mestras do Cliente** (CMK): Podem criptografar dados de at√© 4KB de tamanho. S√£o tipicamente usadas para criar, criptografar e descriptografar as DEKs (Chaves de Criptografia de Dados). Ent√£o as DEKs s√£o usadas para criptografar os dados.

Uma chave mestra do cliente (CMK) √© uma representa√ß√£o l√≥gica de uma chave mestra no AWS KMS. Al√©m dos identificadores da chave mestra e outras metadados, incluindo sua data de cria√ß√£o, descri√ß√£o e estado da chave, uma **CMK cont√©m o material da chave usado para criptografar e descriptografar dados**. Quando voc√™ cria uma CMK, por padr√£o, o AWS KMS gera o material da chave para essa CMK. No entanto, voc√™ pode optar por criar uma CMK sem material da chave e depois importar seu pr√≥prio material da chave para essa CMK.

Existem 2 tipos de chaves mestras:

* **CMKs gerenciadas pela AWS: Usadas por outros servi√ßos para criptografar dados**. √â usada pelo servi√ßo que a criou em uma regi√£o. S√£o criadas na primeira vez que voc√™ implementa a criptografia naquele servi√ßo. Rotacionam a cada 3 anos e n√£o √© poss√≠vel alter√°-las.
* **CMKs gerenciadas pelo cliente**: Flexibilidade, rota√ß√£o, acesso configur√°vel e pol√≠tica de chave. Ativar e desativar chaves.

**Criptografia de Envelope** no contexto do Key Management Service (KMS): Sistema de hierarquia de dois n√≠veis para **criptografar dados com chave de dados e depois criptografar a chave de dados com a chave mestra**.

### Pol√≠ticas de Chave

Elas definem **quem pode usar e acessar uma chave no KMS**.

Por **padr√£o:**

*   Concede ao **conta AWS que possui a chave KMS acesso total** √† chave KMS.

Ao contr√°rio de outras pol√≠ticas de recursos da AWS, uma **pol√≠tica de chave KMS n√£o concede automaticamente permiss√£o √† conta ou a qualquer um de seus usu√°rios**. Para conceder permiss√£o aos administradores da conta, a **pol√≠tica de chave deve incluir uma declara√ß√£o expl√≠cita** que forne√ßa essa permiss√£o, como esta.

* Sem permitir a conta (`"AWS": "arn:aws:iam::111122223333:root"`) as permiss√µes do IAM n√£o funcionar√£o.
*   Permite que a conta use pol√≠ticas do IAM para permitir acesso √† chave KMS, al√©m da pol√≠tica de chave.

**Sem essa permiss√£o, pol√≠ticas do IAM que permitem acesso √† chave s√£o ineficazes**, embora pol√≠ticas do IAM que negam acesso √† chave ainda sejam eficazes.
* Reduz o risco da chave se tornar inadministr√°vel ao dar permiss√£o de controle de acesso aos administradores da conta, incluindo o usu√°rio raiz da conta, que n√£o pode ser exclu√≠do.

Exemplo de **pol√≠tica padr√£o**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Se a **conta for permitida** (`"arn:aws:iam::111122223333:root"`), um **principal** da conta **ainda precisar√° de permiss√µes IAM** para usar a chave KMS. No entanto, se o **ARN** de uma fun√ß√£o, por exemplo, for **especificamente permitido** na **Pol√≠tica de Chave**, essa fun√ß√£o **n√£o precisar√° de permiss√µes IAM**.
{% endhint %}

<details>

<summary>Detalhes da Pol√≠tica</summary>

Propriedades de uma pol√≠tica:

* Documento baseado em JSON
* Recurso --> Recursos afetados (pode ser "\*")
* A√ß√£o --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permiss√µes)
* Efeito --> Permitir/Negar
* Principal --> arn afetado
* Condi√ß√µes (opcional) --> Condi√ß√£o para conceder as permiss√µes

Concess√µes:

* Permitem delegar suas permiss√µes a outro principal da AWS dentro da sua conta AWS. Voc√™ precisa cri√°-las usando as APIs da AWS KMS. Pode ser indicado o identificador CMK, o principal benefici√°rio e o n√≠vel necess√°rio de opera√ß√£o (Decrypt, Encrypt, GenerateDataKey...)
* Ap√≥s a concess√£o ser criada, um GrantToken e um GrantID s√£o emitidos

**Acesso**:

* Via **pol√≠tica de chave** -- Se esta existir, tem **preced√™ncia** sobre a pol√≠tica IAM
* Via **pol√≠tica IAM**
* Via **concess√µes**

</details>

### Administradores de Chave

Administrador de chave por padr√£o:

* Tem acesso para gerenciar KMS, mas n√£o para criptografar ou descriptografar dados
* Apenas usu√°rios e fun√ß√µes IAM podem ser adicionados √† lista de Administradores de Chave (n√£o grupos)
* Se CMK externo for usado, os Administradores de Chave t√™m permiss√£o para importar material de chave

### Rota√ß√£o de CMKs

* Quanto mais tempo a mesma chave permanecer no lugar, mais dados ser√£o criptografados com essa chave, e se essa chave for comprometida, ent√£o maior ser√° a √°rea de impacto dos dados em risco. Al√©m disso, quanto mais tempo a chave estiver ativa, maior a probabilidade de ela ser comprometida.
* **KMS roda as chaves dos clientes a cada 365 dias** (ou voc√™ pode realizar o processo manualmente quando quiser) e **chaves gerenciadas pela AWS a cada 3 anos** e esse tempo n√£o pode ser alterado.
* **Chaves antigas s√£o mantidas** para descriptografar dados que foram criptografados antes da rota√ß√£o
* Em uma quebra, rotacionar a chave n√£o remover√° a amea√ßa, pois ser√° poss√≠vel descriptografar todos os dados criptografados com a chave comprometida. No entanto, os **novos dados ser√£o criptografados com a nova chave**.
* Se o **CMK** estiver em estado de **desativado** ou **pendente de** **dele√ß√£o**, o KMS **n√£o realizar√° uma rota√ß√£o de chave** at√© que o CMK seja reativado ou a dele√ß√£o seja cancelada.

#### Rota√ß√£o manual

* Um **novo CMK precisa ser criado**, ent√£o, um novo CMK-ID √© criado, ent√£o voc√™ precisar√° **atualizar** qualquer **aplicativo** para **referenciar** o novo CMK-ID.
* Para tornar esse processo mais f√°cil, voc√™ pode **usar aliases para se referir a um key-id** e depois apenas atualizar a chave √† qual o alias est√° se referindo.
* Voc√™ precisa **manter as chaves antigas para descriptografar arquivos antigos** criptografados com ela.

Voc√™ pode importar chaves da sua infraestrutura de chaves local.

### Outras informa√ß√µes relevantes sobre KMS

KMS tem pre√ßo por n√∫mero de solicita√ß√µes de criptografia/descriptografia recebidas de todos os servi√ßos por m√™s.

KMS tem **integra√ß√£o completa de auditoria e conformidade com o CloudTrail**; √© aqui que voc√™ pode auditar todas as altera√ß√µes realizadas no KMS.

Com a pol√≠tica KMS, voc√™ pode fazer o seguinte:

* Limitar quem pode criar chaves de dados e quais servi√ßos t√™m acesso para usar essas chaves
* Limitar o acesso dos sistemas para criptografar apenas, descriptografar apenas ou ambos
* Definir para permitir que sistemas acessem chaves entre regi√µes (embora n√£o seja recomendado, pois uma falha na regi√£o que hospeda o KMS afetar√° a disponibilidade dos sistemas em outras regi√µes).

Voc√™ n√£o pode sincronizar ou mover/copiar chaves entre regi√µes; voc√™ s√≥ pode definir regras para permitir acesso entre regi√µes.

### Enumera√ß√£o
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Escalonamento de Privil√©gios

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
