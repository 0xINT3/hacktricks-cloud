## AWS - KMS Enum

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) est un service g√©r√© qui facilite la **cr√©ation et le contr√¥le des cl√©s ma√Ætresses clients** (CMK), les cl√©s de chiffrement utilis√©es pour chiffrer vos donn√©es. Les CMK AWS KMS sont **prot√©g√©es par des modules de s√©curit√© mat√©rielle** (HSM).

KMS utilise la **cryptographie sym√©trique**. Cela est utilis√© pour **chiffrer les informations en repos** (par exemple, √† l'int√©rieur d'un S3). Si vous devez **chiffrer des informations en transit**, vous devez utiliser quelque chose comme **TLS**.\
KMS est un **service sp√©cifique √† une r√©gion**.

**Les administrateurs d'Amazon n'ont pas acc√®s √† vos cl√©s**. Ils ne peuvent pas r√©cup√©rer vos cl√©s et ils ne vous aident pas √† chiffrer vos cl√©s. AWS administre simplement le syst√®me d'exploitation et l'application sous-jacente, il nous appartient d'administrer nos cl√©s de chiffrement et d'administrer la fa√ßon dont ces cl√©s sont utilis√©es.

**Cl√©s ma√Ætresses clients** (CMK) : peuvent chiffrer des donn√©es jusqu'√† 4 Ko. Elles sont g√©n√©ralement utilis√©es pour cr√©er, chiffrer et d√©chiffrer les DEK (Data Encryption Keys). Ensuite, les DEK sont utilis√©s pour chiffrer les donn√©es.

Une cl√© ma√Ætresse client (CMK) est une repr√©sentation logique d'une cl√© ma√Ætresse dans AWS KMS. En plus des identificateurs de cl√© ma√Ætresse et d'autres m√©tadonn√©es, y compris sa date de cr√©ation, sa description et son √©tat de cl√©, un **CMK contient le mat√©riel de cl√© qui est utilis√© pour chiffrer et d√©chiffrer les donn√©es**. Lorsque vous cr√©ez un CMK, par d√©faut, AWS KMS g√©n√®re le mat√©riel de cl√© pour ce CMK. Cependant, vous pouvez choisir de cr√©er un CMK sans mat√©riel de cl√©, puis importer votre propre mat√©riel de cl√© dans ce CMK.

Il existe 2 types de cl√©s ma√Ætresses :

* **CMK g√©r√©es par AWS : utilis√©es par d'autres services pour chiffrer des donn√©es**. Elle est utilis√©e par le service qui l'a cr√©√©e dans une r√©gion. Elles sont cr√©√©es la premi√®re fois que vous impl√©mentez le chiffrement dans ce service. Elles sont renouvel√©es tous les 3 ans et il n'est pas possible de les changer.
* **CMK g√©r√©es par le client** : flexibilit√©, rotation, acc√®s configurable et politique de cl√©. Activation et d√©sactivation des cl√©s.

**Chiffrement d'enveloppe** dans le contexte du service de gestion de cl√©s (KMS) : syst√®me √† deux niveaux pour **chiffrer les donn√©es avec une cl√© de donn√©es, puis chiffrer la cl√© de donn√©es avec la cl√© ma√Ætresse**.

### Politiques de cl√©

Celles-ci d√©finissent **qui peut utiliser et acc√©der √† une cl√© dans KMS**.

Par **d√©faut** :

*   Elle donne √† **l'AWS account qui poss√®de la cl√© KMS un acc√®s complet** √† la cl√© KMS.

    Contrairement aux autres politiques de ressources AWS, une **politique de cl√© KMS ne donne pas automatiquement la permission au compte ou √† l'un de ses utilisateurs**. Pour donner la permission aux administrateurs de compte, la **politique de cl√© doit inclure une d√©claration explicite** qui fournit cette permission, comme celle-ci.

    * Sans autoriser le compte (`"AWS": "arn:aws:iam::111122223333:root"`) les autorisations IAM ne fonctionneront pas.
*   Elle **permet au compte d'utiliser les politiques IAM** pour autoriser l'acc√®s √† la cl√© KMS, en plus de la politique de cl√©.

    **Sans cette autorisation, les politiques IAM qui autorisent l'acc√®s √† la cl√© sont inefficaces**, bien que les politiques IAM qui refusent l'acc√®s √† la cl√© soient toujours efficaces.
* Elle **r√©duit le risque que la cl√© devienne ing√©rable** en donnant aux administrateurs de compte, y compris √† l'utilisateur racine du compte, un contr√¥le d'acc√®s qui ne peut pas √™tre supprim√©.

Exemple de **politique par d√©faut** :

```json
{
  "Sid": "Enable IAM policies",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::111122223333:root"
   },
  "Action": "kms:*",
  "Resource": "*"
}
```

{% hint style="warning" %}
Si le **compte est autoris√©** (`"arn:aws:iam::111122223333:root"`) un **principal** du compte **aura toujours besoin de permissions IAM** pour utiliser la cl√© KMS. Cependant, si l'**ARN** d'un r√¥le par exemple est **sp√©cifiquement autoris√©** dans la **politique de cl√©**, ce r√¥le **n'a pas besoin de permissions IAM**.
{% endhint %}

<details>

<summary>D√©tails de la politique</summary>

Propri√©t√©s d'une politique :

* Document bas√© sur JSON
* Ressource --> Ressources affect√©es (peut √™tre "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permissions)
* Effect --> Allow/Deny
* Principal --> arn affect√©
* Conditions (optionnel) --> Condition pour donner les permissions

Subventions :

* Autoriser la d√©l√©gation de vos autorisations √† un autre principal AWS au sein de votre compte AWS. Vous devez les cr√©er en utilisant les API AWS KMS. Il est possible d'indiquer l'identifiant CMK, le principal b√©n√©ficiaire et le niveau d'op√©ration requis (Decrypt, Encrypt, GenerateDataKey...)
* Apr√®s la cr√©ation de la subvention, un GrantToken et un GratID sont √©mis

**Acc√®s** :

* Via la **politique de cl√©** -- Si elle existe, elle prend **pr√©c√©dence** sur la politique IAM
* Via la **politique IAM**
* Via les **subventions**

</details>

### Administrateurs de cl√©

Administrateur de cl√© par d√©faut :

* Ont acc√®s √† la gestion de KMS mais pas au chiffrement ou au d√©chiffrement des donn√©es
* Seuls les utilisateurs et les r√¥les IAM peuvent √™tre ajout√©s √† la liste des administrateurs de cl√© (pas les groupes)
* Si une CMK externe est utilis√©e, les administrateurs de cl√© ont la permission d'importer du mat√©riel de cl√©

### Rotation des CMK

* Plus la m√™me cl√© est laiss√©e en place longtemps, plus de donn√©es sont chiffr√©es avec cette cl√©, et si cette cl√© est compromise, plus grande est la zone de blast des donn√©es √† risque. En plus de cela, plus la cl√© est active, plus la probabilit√© qu'elle soit compromise augmente.
* **KMS fait tourner les cl√©s clients tous les 365 jours** (ou vous pouvez effectuer le processus manuellement quand vous le souhaitez) et **les cl√©s g√©r√©es par AWS tous les 3 ans** et cette fois-ci, il n'est pas possible de les changer.
* **Les anciennes cl√©s sont conserv√©es** pour d√©chiffrer les donn√©es qui ont √©t√© chiffr√©es avant la rotation
* En cas de rupture, la rotation de la cl√© ne supprimera pas la menace car il sera possible de d√©chiffrer toutes les donn√©es chiffr√©es avec la cl√© compromise. Cependant, les **nouvelles donn√©es seront chiffr√©es avec la nouvelle cl√©**.
* Si la **CMK** est dans un √©tat de **d√©sactivation** ou de **suppression en attente**, KMS ne **fera pas tourner la cl√©** jusqu'√† ce que la CMK soit r√©activ√©e ou que la suppression soit annul√©e.

#### Rotation manuelle

* Une **nouvelle CMK doit
### Autres informations pertinentes sur KMS

KMS est factur√© en fonction du nombre de demandes de chiffrement/d√©chiffrement re√ßues de tous les services par mois.

KMS dispose d'une int√©gration compl√®te d'audit et de conformit√© avec CloudTrail ; c'est l√† que vous pouvez auditer toutes les modifications effectu√©es sur KMS.

Avec la politique KMS, vous pouvez faire ce qui suit :

* Limiter qui peut cr√©er des cl√©s de donn√©es et quels services ont acc√®s √† l'utilisation de ces cl√©s
* Limiter l'acc√®s des syst√®mes au chiffrement uniquement, au d√©chiffrement uniquement ou aux deux
* D√©finir pour permettre aux syst√®mes d'acc√©der aux cl√©s dans toutes les r√©gions (bien que cela ne soit pas recommand√© car une d√©faillance dans la r√©gion h√©bergeant KMS affectera la disponibilit√© des syst√®mes dans d'autres r√©gions).

Vous ne pouvez pas synchroniser ou d√©placer/copier des cl√©s entre les r√©gions ; vous pouvez seulement d√©finir des r√®gles pour permettre l'acc√®s entre les r√©gions.

### √ânum√©ration

```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms describe-custom-key-stores
```

### Privil√®ge d'escalade

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post-exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos.**

</details>