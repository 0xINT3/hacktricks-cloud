# AWS - KMS Enum

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## KMS - Upravljanje ključevima

AWS Key Management Service (AWS KMS) je predstavljen kao upravljana usluga, pojednostavljujući proces korisnicima da **kreiraju i upravljaju glavnim ključevima korisnika** (CMK). Ovi CMK-ovi su integralni deo enkripcije korisničkih podataka. Značajna karakteristika AWS KMS-a je da su CMK-ovi uglavnom **zaštićeni hardverskim sigurnosnim modulima** (HSM), što poboljšava zaštitu ključeva za enkripciju.

KMS koristi **simetričnu kriptografiju**. Ovo se koristi za **enkripciju informacija u mirovanju** (na primer, unutar S3). Ako želite **enkriptovati informacije u tranzitu**, morate koristiti nešto poput **TLS**.

KMS je **usluga specifična za region**.

**Administratori u Amazonu nemaju pristup vašim ključevima**. Oni ne mogu povratiti vaše ključeve i ne pomažu vam pri enkripciji vaših ključeva. AWS jednostavno upravlja operativnim sistemom i osnovnom aplikacijom, a na nama je da upravljamo našim ključevima za enkripciju i načinom na koji se ti ključevi koriste.

**Glavni ključevi korisnika** (CMK): Mogu enkriptovati podatke do veličine od 4KB. Obično se koriste za kreiranje, enkripciju i dekripciju DEK-ova (Data Encryption Keys). Zatim se DEK-ovi koriste za enkripciju podataka.

Glavni ključ korisnika (CMK) je logički prikaz glavnog ključa u AWS KMS-u. Pored identifikatora glavnog ključa i drugih metapodataka, uključujući datum kreiranja, opis i stanje ključa, **CMK sadrži materijal ključa koji se koristi za enkripciju i dekripciju podataka**. Kada kreirate CMK, prema podrazumevanim podešavanjima, AWS KMS generiše materijal ključa za taj CMK. Međutim, možete izabrati da kreirate CMK bez materijala ključa i zatim uvezete sopstveni materijal ključa u taj CMK.

Postoje 2 vrste glavnih ključeva:

* **AWS upravljani CMK-ovi: Koriste se od strane drugih usluga za enkripciju podataka**. Koristi ih usluga koja je kreirala CMK u regionu. Oni se kreiraju prvi put kada implementirate enkripciju u toj usluzi. Rotiraju se svake 3 godine i nije moguće ih promeniti.
* **Korisnički upravljani CMK-ovi**: Fleksibilnost, rotacija, konfigurabilan pristup i politika ključa. Omogućava uključivanje i isključivanje ključeva.

**Envelopna enkripcija** u kontekstu Key Management Service (KMS): Sistem hijerarhije sa dva nivoa za **enkripciju podataka sa ključem podataka, a zatim enkripciju ključa podataka sa glavnim ključem**.

### Politike ključa

One definišu **ko može koristiti i pristupiti ključu u KMS-u**.

Po **podrazumevanim podešavanjima**:

*   Daje **AWS nalogu koji je vlasnik KMS ključa pun pristup** KMS ključu.

Za razliku od drugih AWS politika resursa, AWS **KMS politika ključa ne daje automatski dozvolu nalogu ili bilo kojem od njegovih korisnika**. Da bi se dala dozvola administratorima naloga, **polisa ključa mora sadržati eksplicitnu izjavu** koja pruža ovu dozvolu, kao što je ova.

* Bez dozvole za nalog (`"AWS": "arn:aws:iam::111122223333:root"`) IAM dozvole neće raditi.
*   Dozvoljava nalogu da koristi IAM politike za dozvolu pristupa KMS ključu, pored politike ključa.

**Bez ove dozvole, IAM politike koje dozvoljavaju pristup ključu su neefikasne**, iako IAM politike koje zabranjuju pristup ključu i dalje su efikasne.
* Smanjuje rizik od ključa koji postaje neupravljivim davanjem dozvole za kontrolu pristupa administratorima naloga, uključujući korisnika glavnog naloga koji se ne može izbrisati.

**Primer podrazumevane politike**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Ako je **nalog dozvoljen** (`"arn:aws:iam::111122223333:root"`), **princip** iz naloga će i dalje trebati IAM dozvole da bi koristio KMS ključ. Međutim, ako je **ARN** uloge, na primer, **posebno dozvoljen** u **Key Policy**, ta uloga **neće trebati IAM dozvole**.
{% endhint %}

<details>

<summary>Detalji politike</summary>

Svojstva politike:

* Dokument zasnovan na JSON-u
* Resurs --> Pogođeni resursi (može biti "\*")
* Akcija --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (dozvole)
* Efekat --> Dozvoli/Odbij
* Princip --> pogođeni arn
* Uslovi (opciono) --> Uslov za dodeljivanje dozvola

Dodeljivanje:

* Omogućava delegiranje dozvola drugom AWS principu unutar vašeg AWS naloga. Morate ih kreirati koristeći AWS KMS API-je. Može se navesti identifikator CMK-a, princip kojem se dodeljuju dozvole i potrebni nivo operacije (Decrypt, Encrypt, GenerateDataKey...)
* Nakon što je dodela kreirana, izdaju se GrantToken i GrantID

**Pristup**:

* Putem **Key Policy**-ja -- Ako postoji, ovo ima **prednost** nad IAM politikom
* Putem **IAM politike**
* Putem **dodeljivanja**

</details>

### Administratori ključeva

Administrator ključeva po podrazumevanju:

* Imaju pristup upravljanju KMS-om, ali nemaju pristup šifrovanju ili dešifrovanju podataka
* Samo IAM korisnici i uloge mogu biti dodati na listu Administratora ključeva (ne grupe)
* Ako se koristi spoljni CMK, Administratori ključeva imaju dozvolu za uvoz materijala ključa

### Rotacija CMK-ova

* Što duže isti ključ ostaje na mestu, više podataka je šifrovano tim ključem, i ako taj ključ bude kompromitovan, veći je rizik za podatke. Pored toga, što je ključ duže aktivan, veća je verovatnoća da će biti kompromitovan.
* **KMS rotira korisničke ključeve svakih 365 dana** (ili možete ručno izvršiti proces kad god želite) i **ključevi koje upravlja AWS rotiraju svake 3 godine** i to vreme se ne može promeniti.
* **Stari ključevi se zadržavaju** kako bi se dešifrovali podaci koji su šifrovani pre rotacije
* U slučaju kompromitovanja, rotacija ključa neće ukloniti pretnju jer će biti moguće dešifrovati sve podatke koji su šifrovani kompromitovanim ključem. Međutim, **novi podaci će biti šifrovani novim ključem**.
* Ako je **CMK** u stanju **onemogućen** ili **na čekanju za brisanje**, KMS neće izvršiti rotaciju ključa sve dok CMK ne bude ponovo omogućen ili brisanje otkazano.

#### Ručna rotacija

* Potrebno je **kreirati novi CMK**, zatim se kreira novi CMK-ID, tako da će biti potrebno **ažurirati** svaku **aplikaciju** da **referiše** na novi CMK-ID.
* Da biste olakšali ovaj proces, možete **koristiti alias-e za referenciranje ključa** i zatim samo ažurirati ključ na koji se alias odnosi.
* Morate **zadržati stare ključeve da biste dešifrovali stare datoteke** koje su šifrovane njima.

Možete uvesti ključeve iz vaše infrastrukture ključeva na lokaciji.

### Ostale relevantne informacije o KMS-u

KMS se naplaćuje po broju zahteva za šifrovanje/dešifrovanje primljenih od svih usluga mesečno.

KMS ima potpunu integraciju za reviziju i usklađenost sa CloudTrail-om; tu možete pratiti sve promene koje su izvršene na KMS-u.

Pomoću KMS politike možete uraditi sledeće:

* Ograničiti ko može kreirati ključeve podataka i koje usluge imaju pristup korišćenju tih ključeva
* Ograničiti pristup sistemima samo za šifrovanje, samo za dešifrovanje ili za oboje
* Definisati da omogućite sistemima pristup ključevima preko regiona (iako se ne preporučuje jer kvar u regionu koji hostuje KMS će uticati na dostupnost sistema u drugim regionima).

Ne možete sinhronizovati ili premestiti/kopirati ključeve između regiona; možete samo definisati pravila za dozvolu pristupa između regiona.

### Enumeracija
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Reference

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
