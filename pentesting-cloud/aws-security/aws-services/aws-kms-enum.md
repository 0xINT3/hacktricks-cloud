# AWS - KMS Enum

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) jest prezentowany jako usługa zarządzana, upraszczająca proces **tworzenia i zarządzania kluczami głównymi klienta** (CMK). Te CMK są integralne w szyfrowaniu danych użytkownika. Istotną cechą AWS KMS jest to, że CMK są głównie **zabezpieczane przez moduły sprzętowe do zabezpieczania** (HSM), co zwiększa ochronę kluczy szyfrowania.

KMS używa **szyfrowania symetrycznego**. Jest to używane do **szyfrowania informacji w spoczynku** (na przykład wewnątrz S3). Jeśli chcesz **szyfrować informacje w transporcie**, musisz użyć czegoś takiego jak **TLS**.

KMS to **usługa specyficzna dla regionu**.

**Administratorzy w Amazonie nie mają dostępu do Twoich kluczy**. Nie mogą odzyskać Twoich kluczy i nie pomagają Ci w szyfrowaniu Twoich kluczy. AWS po prostu administruje systemem operacyjnym i podstawową aplikacją, to my sami administrujemy naszymi kluczami szyfrowania i administrujemy tym, jak te klucze są używane.

**Klucze główne klienta** (CMK): Mogą szyfrować dane o wielkości do 4 KB. Zazwyczaj są używane do tworzenia, szyfrowania i deszyfrowania DEK (Data Encryption Keys). Następnie DEK są używane do szyfrowania danych.

Klucz główny klienta (CMK) to logiczne przedstawienie klucza głównego w AWS KMS. Oprócz identyfikatorów klucza głównego i innych metadanych, takich jak data utworzenia, opis i stan klucza, **CMK zawiera materiał klucza, który jest używany do szyfrowania i deszyfrowania danych**. Tworząc CMK, domyślnie AWS KMS generuje materiał klucza dla tego CMK. Jednak możesz wybrać utworzenie CMK bez materiału klucza, a następnie zaimportować własny materiał klucza do tego CMK.

Istnieją 2 rodzaje kluczy głównych:

* **Zarządzane przez AWS CMK: Używane przez inne usługi do szyfrowania danych**. Jest używany przez usługę, która go utworzyła w regionie. Są one tworzone przy pierwszym wdrożeniu szyfrowania w tej usłudze. Rotują co 3 lata i nie można ich zmienić.
* **Klucze główne klienta**: Elastyczność, rotacja, konfigurowalny dostęp i polityka klucza. Włączanie i wyłączanie kluczy.

**Szyfrowanie kopertowe** w kontekście Key Management Service (KMS): Dwupoziomowy system hierarchii do **szyfrowania danych kluczem danych, a następnie szyfrowania klucza danych kluczem głównym**.

### Polityki kluczy

Określają, **kto może używać i uzyskiwać dostęp do klucza w KMS**.

Domyślnie:

*   Daje **kontu AWS, które jest właścicielem klucza KMS, pełny dostęp** do klucza KMS.

W przeciwieństwie do innych polityk zasobów AWS, polityka klucza AWS **KMS nie daje automatycznie uprawnień do konta ani żadnego z jego użytkowników**. Aby dać uprawnienia administratorom konta, **polityka klucza musi zawierać jawną deklarację**, która zapewnia te uprawnienia, tak jak ta.

* Bez zezwolenia konta (`"AWS": "arn:aws:iam::111122223333:root"`) uprawnienia IAM nie będą działać.
*   Pozwala kontu na korzystanie z polityk IAM, aby umożliwić dostęp do klucza KMS, oprócz polityki klucza.

**Bez tego uprawnienia, polityki IAM, które pozwalają na dostęp do klucza, są nieskuteczne**, chociaż polityki IAM, które odmawiają dostępu do klucza, nadal są skuteczne.
* Zmniejsza ryzyko, że klucz stanie się niezarządzalny, udzielając uprawnień do kontroli dostępu administratorom konta, w tym użytkownikowi głównemu konta, który nie może zostać usunięty.

Przykład **domyślnej polityki**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Jeśli **konto jest dozwolone** (`"arn:aws:iam::111122223333:root"`), **podmiot** z konta **nadal będzie potrzebować uprawnień IAM** do użycia klucza KMS. Jednak, jeśli **ARN** roli na przykład jest **specjalnie dozwolony** w **Polityce Klucza**, ta rola **nie będzie potrzebować uprawnień IAM**.
{% endhint %}

<details>

<summary>Szczegóły polityki</summary>

Właściwości polityki:

* Dokument oparty na JSON
* Zasób --> Dotknięte zasoby (może być "\*")
* Akcja --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (uprawnienia)
* Efekt --> Allow/Deny
* Podmiot --> dotknięty arn
* Warunki (opcjonalne) --> Warunek, aby nadać uprawnienia

Uprawnienia:

* Pozwala na delegowanie uprawnień do innego podmiotu AWS w ramach Twojego konta AWS. Musisz je tworzyć za pomocą interfejsów API AWS KMS. Można wskazać identyfikator CMK, podmiot uprawniony i wymagany poziom operacji (Decrypt, Encrypt, GenerateDataKey...)
* Po utworzeniu upoważnienia wydawane są GrantToken i GratID

**Dostęp**:

* Za pomocą **polityki klucza** -- Jeśli istnieje, to ma **prymat** nad polityką IAM
* Za pomocą **polityki IAM**
* Za pomocą **uprawnień**

</details>

### Administratorzy kluczy

Domyślnie administratorzy kluczy:

* Mają dostęp do zarządzania KMS, ale nie do szyfrowania ani deszyfrowania danych
* Do listy Administratorów kluczy można dodać tylko użytkowników i role IAM (nie grupy)
* Jeśli używany jest zewnętrzny CMK, Administratorzy kluczy mają uprawnienie do importowania materiału klucza

### Rotacja CMKs

* Im dłużej ten sam klucz pozostaje na swoim miejscu, tym więcej danych jest szyfrowanych tym kluczem, a jeśli ten klucz zostanie naruszony, to szerszy obszar danych jest zagrożony. Oprócz tego, im dłużej klucz jest aktywny, tym większe jest prawdopodobieństwo jego naruszenia.
* **KMS obraca klucze klienta co 365 dni** (lub można wykonać proces ręcznie, kiedykolwiek chcesz) i **klucze zarządzane przez AWS co 3 lata** i tego czasu nie można zmienić.
* **Starsze klucze są przechowywane**, aby odszyfrować dane, które były szyfrowane przed rotacją
* W przypadku naruszenia, obrót klucza nie usunie zagrożenia, ponieważ będzie możliwe odszyfrowanie wszystkich danych zaszyfrowanych kluczem, który został naruszony. Jednak **nowe dane będą szyfrowane nowym kluczem**.
* Jeśli **CMK** jest w stanie **wyłączonym** lub **oczekującym** **usunięcia**, KMS **nie będzie wykonywać rotacji klucza**, dopóki CMK nie zostanie ponownie włączony lub usunięcie nie zostanie anulowane.

#### Ręczna rotacja

* Należy utworzyć **nowy CMK**, a następnie utworzyć nowy identyfikator CMK, więc trzeba **zaktualizować** dowolną **aplikację**, aby **odwoływała się** do nowego identyfikatora CMK.
* Aby ułatwić ten proces, można **użyć aliasów do odwoływania się do identyfikatora klucza** i następnie zaktualizować klucz, do którego odwołuje się alias.
* Należy **zachować stare klucze, aby odszyfrować stare pliki**, które zostały zaszyfrowane za ich pomocą.

Można importować klucze z infrastruktury kluczy lokalnych.

### Inne istotne informacje o KMS

KMS jest wyceniany na podstawie liczby żądań szyfrowania/deszyfrowania otrzymanych od wszystkich usług miesięcznie.

KMS ma pełną integrację z audytem i zgodnością **CloudTrail**; tutaj można przeglądać wszystkie zmiany wykonane w KMS.

Z polityką KMS można zrobić następujące rzeczy:

* Ograniczyć, kto może tworzyć klucze danych i które usługi mają dostęp do tych kluczy
* Ograniczyć dostęp systemów do tylko szyfrowania, tylko deszyfrowania lub obu
* Zdefiniować, aby umożliwić systemom dostęp do kluczy w różnych regionach (choć nie jest to zalecane, ponieważ awaria w regionie hostującym KMS wpłynie na dostępność systemów w innych regionach).

Nie można synchronizować ani przenosić/kopiować kluczy między regionami; można tylko zdefiniować zasady, które umożliwiają dostęp między regionami.

### Wyliczenie
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
