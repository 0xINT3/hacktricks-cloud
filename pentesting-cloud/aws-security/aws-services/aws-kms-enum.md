# AWS - Enumeraci칩n de KMS

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS - Servicio de gesti칩n de claves

AWS Key Management Service (AWS KMS) es un servicio administrado que facilita la **creaci칩n y el control de claves maestras de clientes** (CMK), las claves de cifrado utilizadas para cifrar sus datos. Las CMK de AWS KMS est치n **protegidas por m칩dulos de seguridad de hardware** (HSM).

KMS utiliza **criptograf칤a sim칠trica**. Esto se utiliza para **cifrar informaci칩n en reposo** (por ejemplo, dentro de un S3). Si necesita **cifrar informaci칩n en tr치nsito**, debe usar algo como **TLS**.\
KMS es un servicio **espec칤fico de la regi칩n**.

**Los administradores de Amazon no tienen acceso a tus claves**. No pueden recuperar tus claves y no te ayudan con el cifrado de tus claves. AWS simplemente administra el sistema operativo y la aplicaci칩n subyacente, y depende de nosotros administrar nuestras claves de cifrado y administrar c칩mo se utilizan esas claves.

**Claves maestras de clientes** (CMK): Pueden cifrar datos de hasta 4KB de tama침o. Se utilizan t칤picamente para crear, cifrar y descifrar las DEK (Data Encryption Keys). Luego, las DEK se utilizan para cifrar los datos.

Una clave maestra de cliente (CMK) es una representaci칩n l칩gica de una clave maestra en AWS KMS. Adem치s de los identificadores de la clave maestra y otros metadatos, incluida su fecha de creaci칩n, descripci칩n y estado de la clave, una **CMK contiene el material de la clave que se utiliza para cifrar y descifrar datos**. Cuando creas una CMK, por defecto, AWS KMS genera el material de la clave para esa CMK. Sin embargo, puedes elegir crear una CMK sin material de clave y luego importar tu propio material de clave en esa CMK.

Hay 2 tipos de claves maestras:

* **CMK administradas por AWS: Utilizadas por otros servicios para cifrar datos**. Es utilizada por el servicio que la cre칩 en una regi칩n. Se crean la primera vez que se implementa el cifrado en ese servicio. Se rotan cada 3 a침os y no es posible cambiarlas.
* **CMK administradas por el cliente**: Flexibilidad, rotaci칩n, acceso configurable y pol칤tica de claves. Habilita y deshabilita claves.

**Cifrado de sobre**: En el contexto del Servicio de gesti칩n de claves (KMS), es un sistema de jerarqu칤a de dos niveles para **cifrar datos con una clave de datos y luego cifrar la clave de datos con una clave maestra**.

### Pol칤ticas de claves

Estas definen **qui칠n puede usar y acceder a una clave en KMS**.

Por **defecto:**

*   Da al **cuenta de AWS que posee la clave KMS acceso completo** a la clave KMS.

    A diferencia de otras pol칤ticas de recursos de AWS, una **pol칤tica de clave KMS no otorga autom치ticamente permiso a la cuenta o a ninguno de sus usuarios**. Para otorgar permiso a los administradores de la cuenta, la **pol칤tica de clave debe incluir una declaraci칩n expl칤cita** que proporcione este permiso, como esta.

    * Sin permitir la cuenta (`"AWS": "arn:aws:iam::111122223333:root"`) los permisos de IAM no funcionar치n.
*   **Permite que la cuenta use pol칤ticas de IAM** para permitir el acceso a la clave KMS, adem치s de la pol칤tica de clave.

    **Sin este permiso, las pol칤ticas de IAM que permiten el acceso a la clave son ineficaces**, aunque las pol칤ticas de IAM que niegan el acceso a la clave siguen siendo efectivas.
* Reduce el riesgo de que la clave se vuelva inmanejable al dar permiso de control de acceso a los administradores de la cuenta, incluido el usuario ra칤z de la cuenta, que no se puede eliminar.

Ejemplo de **pol칤tica predeterminada**:

```json
{
  "Sid": "Enable IAM policies",
  "Effect": "Allow",
  "Principal": {
    "AWS": "arn:aws:iam::111122223333:root"
   },
  "Action": "kms:*",
  "Resource": "*"
}
```

{% hint style="warning" %}
Si se permite la **cuenta** (`"arn:aws:iam::111122223333:root"`) un **principal** de la cuenta **todav칤a necesitar치 permisos de IAM** para usar la clave KMS. Sin embargo, si el **ARN** de un rol, por ejemplo, est치 **espec칤ficamente permitido** en la **Pol칤tica de Clave**, ese rol **no necesita permisos de IAM**.
{% endhint %}

<details>

<summary>Detalles de la pol칤tica</summary>

Propiedades de una pol칤tica:

* Documento basado en JSON
* Recurso --> Recursos afectados (puede ser "\*")
* Acci칩n --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permisos)
* Efecto --> Permitir/Denegar
* Principal --> arn afectado
* Condiciones (opcional) --> Condici칩n para dar los permisos

Concesiones:

* Permiten delegar tus permisos a otro principal de AWS dentro de tu cuenta de AWS. Debes crearlos utilizando las APIs de AWS KMS. Se puede indicar el identificador de CMK, el principal del concesionario y el nivel de operaci칩n requerido (Decrypt, Encrypt, GenerateDataKey...)
* Despu칠s de que se crea la concesi칩n, se emiten un token de concesi칩n y un ID de concesi칩n.

**Acceso**:

* A trav칠s de la **pol칤tica de clave** -- Si existe, esto tiene **precedencia** sobre la pol칤tica de IAM
* A trav칠s de la **pol칤tica de IAM**
* A trav칠s de **concesiones**

</details>

### Administradores de claves

El administrador de claves por defecto:

* Tiene acceso para administrar KMS pero no para cifrar o descifrar datos
* Solo los usuarios y roles de IAM pueden agregarse a la lista de administradores de claves (no los grupos)
* Si se utiliza una CMK externa, los administradores de claves tienen permiso para importar material de clave

### Rotaci칩n de CMKs

* Cuanto m치s tiempo se deja la misma clave en su lugar, m치s datos se cifran con esa clave, y si esa clave se ve comprometida, entonces m치s amplia es el 치rea de explosi칩n de datos en riesgo. Adem치s de esto, cuanto m치s tiempo est칠 activa la clave, aumenta la probabilidad de que sea vulnerada.
* **KMS rota las claves de cliente cada 365 d칤as** (o puedes realizar el proceso manualmente cuando quieras) y **las claves administradas por AWS cada 3 a침os** y este tiempo no se puede cambiar.
* **Las claves antiguas se conservan** para descifrar datos que se cifraron antes de la rotaci칩n.
* En caso de una brecha, la rotaci칩n de la clave no eliminar치 la amenaza, ya que ser치 posible descifrar todos los datos cifrados con la clave comprometida. Sin embargo, los **nuevos datos se cifrar치n con la nueva clave**.
* Si la **CMK** est치 en estado de **deshabilitada** o **pendiente de eliminaci칩n**, KMS **no realizar치 una rotaci칩n de clave** hasta que la CMK se vuelva a habilitar o se cancele la eliminaci칩n.
#### Rotaci칩n manual

* Se necesita **crear una nueva CMK**, luego se crea un nuevo CMK-ID, por lo que deber치 **actualizar** cualquier **aplicaci칩n** para **referenciar** el nuevo CMK-ID.
* Para hacer este proceso m치s f치cil, puede **usar alias para referirse a un key-id** y luego simplemente actualizar la clave a la que se est치 refiriendo el alias.
* Necesita **mantener las claves antiguas para descifrar los archivos antiguos** cifrados con ella.

Puede importar claves de su infraestructura de claves local.

### Otra informaci칩n relevante de KMS

KMS tiene un precio por n칰mero de solicitudes de cifrado/descifrado recibidas de todos los servicios por mes.

KMS tiene una integraci칩n completa de auditor칤a y cumplimiento con CloudTrail; aqu칤 es donde puede auditar todos los cambios realizados en KMS.

Con la pol칤tica de KMS, puede hacer lo siguiente:

* Limitar qui칠n puede crear claves de datos y qu칠 servicios tienen acceso para usar estas claves.
* Limitar el acceso del sistema para cifrar solo, descifrar solo o ambos.
* Definir para permitir que los sistemas accedan a las claves en todas las regiones (aunque no se recomienda, ya que una falla en la regi칩n que aloja KMS afectar치 la disponibilidad de los sistemas en otras regiones).

No puede sincronizar o mover/copiar claves entre regiones; solo puede definir reglas para permitir el acceso entre regiones.

### Enumeraci칩n

```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms describe-custom-key-stores
```

### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Explotaci칩n

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulte los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **칔nase al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤game** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparta sus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>