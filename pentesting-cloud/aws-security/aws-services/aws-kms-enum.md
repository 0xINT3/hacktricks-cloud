# AWS - KMS Enum

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)\*\* 上关注我们\*\*。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## KMS - 密钥管理服务

AWS 密钥管理服务（AWS KMS）被提供为一项托管服务，简化了用户**创建和管理客户主密钥**（CMKs）的过程。这些 CMKs 在用户数据加密中起着重要作用。AWS KMS 的一个显著特点是，CMKs 主要由**硬件安全模块**（HSMs）保护，增强了加密密钥的安全性。

KMS 使用**对称加密**。这用于**加密信息的静态存储**（例如，在 S3 中）。如果需要**加密传输中的信息**，则需要使用类似**TLS**的东西。

KMS 是一个**特定区域的服务**。

**亚马逊的管理员无法访问您的密钥**。他们无法恢复您的密钥，也不会帮助您加密您的密钥。AWS 只是管理操作系统和底层应用程序，我们需要管理我们的加密密钥以及管理这些密钥的使用。

**客户主密钥**（CMK）：可加密最多 4KB 大小的数据。它们通常用于创建、加密和解密 DEKs（数据加密密钥）。然后使用 DEKs 加密数据。

客户主密钥（CMK）是 AWS KMS 中主密钥的逻辑表示。除了主密钥的标识符和其他元数据（包括创建日期、描述和密钥状态）外，**CMK 包含用于加密和解密数据的密钥材料**。当您创建 CMK 时，默认情况下，AWS KMS 会为该 CMK 生成密钥材料。但是，您可以选择创建没有密钥材料的 CMK，然后将自己的密钥材料导入该 CMK。

有两种类型的主密钥：

* **由其他服务用于加密数据的 AWS 托管 CMKs**。它由在该区域创建它的服务使用。它们是在第一次在该服务中实施加密时创建的。每 3 年轮换一次，不可能更改它。
* **客户管理 CMKs**：灵活性、轮换、可配置的访问和密钥策略。启用和禁用密钥。

在密钥管理服务（KMS）的上下文中，**信封加密**是指使用数据密钥加密数据，然后使用主密钥加密数据密钥的两层层次结构系统。

### 密钥策略

这些定义了在 KMS 中**谁可以使用和访问密钥**。

**默认情况下：**

* 它为**拥有 KMS 密钥的 AWS 帐户提供完全访问权限**。

与其他 AWS 资源策略不同，AWS **KMS 密钥策略不会自动授予帐户或其任何用户权限**。要授予帐户管理员权限，**密钥策略必须包含一个明确的声明**，提供此权限，就像这样。

* 如果不允许帐户（`"AWS": "arn:aws:iam::111122223333:root"`），IAM 权限将无效。
* 它**允许帐户使用 IAM 策略**来允许访问 KMS 密钥，除了密钥策略。

**没有此权限，允许访问密钥的 IAM 策略将无效**，尽管拒绝访问密钥的 IAM 策略仍然有效。

* 它通过将访问控制权限授予帐户管理员，包括无法删除的帐户根用户，**降低了密钥变得难以管理的风险**。

**默认策略**示例：

```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```

{% hint style="warning" %}
如果**账户被允许**(`"arn:aws:iam::111122223333:root"`)来自该账户的**主体仍需要IAM权限**来使用KMS密钥。但是，如果在**密钥策略**中**明确允许**了角色的ARN，那么该角色**不需要IAM权限**。
{% endhint %}

<details>

<summary>策略详情</summary>

策略的属性：

* 基于JSON的文档
* 资源 --> 受影响的资源（可以是"\*"）
* 操作 --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ...（权限）
* 效果 --> 允许/拒绝
* 主体 --> 受影响的arn
* 条件（可选） --> 给予权限的条件

授权：

* 允许将您的权限委托给AWS账户内的另一个AWS主体。您需要使用AWS KMS API创建它们。可以指定CMK标识符、受让方主体和所需的操作级别（解密、加密、生成数据密钥...）
* 授权创建后，将发放GrantToken和GratID

**访问**：

* 通过**密钥策略** -- 如果存在，则**优先于**IAM策略
* 通过**IAM策略**
* 通过**授权**

</details>

### 密钥管理员

默认情况下的密钥管理员：

* 可以访问管理KMS，但无法加密或解密数据
* 只能将IAM用户和角色添加到密钥管理员列表（不能添加组）
* 如果使用外部CMK，则密钥管理员具有导入密钥材料的权限

### CMK的轮换

* 同一个密钥保留的时间越长，使用该密钥加密的数据就越多，如果该密钥被破坏，那么数据波及范围就越广。此外，密钥保留的时间越长，被破坏的可能性就越大。
* **KMS每365天轮换客户密钥**（或者您可以随时手动执行该过程），而由AWS管理的密钥每3年轮换一次，这个时间无法更改。
* **旧密钥会保留**以解密在轮换之前加密的数据
* 在发生破坏时，轮换密钥不会消除威胁，因为可以解密使用受损密钥加密的所有数据。但是，**新数据将使用新密钥加密**。
* 如果**CMK**处于**禁用**或**待删除**状态，KMS将**不执行密钥轮换**，直到CMK重新启用或取消删除。

#### 手动轮换

* 需要创建一个**新CMK**，然后创建一个新的CMK-ID，因此您需要**更新**任何**应用程序**以**引用**新的CMK-ID。
* 为了更轻松地进行此过程，您可以**使用别名引用密钥ID**，然后只需更新别名引用的密钥。
* 您需要**保留旧密钥**以解密使用旧密钥加密的旧文件。

您可以从您的本地密钥基础设施导入密钥。

### 其他相关的KMS信息

KMS的定价是根据每月从所有服务接收的加密/解密请求次数计算的。

KMS与CloudTrail完全审计和合规**集成**；这是您可以审计在KMS上执行的所有更改的地方。

使用KMS策略，您可以执行以下操作：

* 限制谁可以创建数据密钥以及哪些服务可以访问这些密钥
* 限制系统访问仅加密、仅解密或两者兼有
* 定义启用系统跨区域访问密钥（尽管不建议，因为托管KMS的区域发生故障将影响其他区域系统的可用性）。

您无法同步或移动/复制密钥跨区域；您只能定义规则以允许跨区域访问。

### 枚举

```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```

### 提权

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### 后渗透

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### 持久化

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## 参考资料

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**上关注**我们。
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
