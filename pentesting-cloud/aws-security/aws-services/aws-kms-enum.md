# AWS - Enumerazione di KMS

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>

## KMS - Key Management Service

Il servizio di gestione delle chiavi (KMS) di AWS viene presentato come un servizio gestito, semplificando il processo per gli utenti di **creare e gestire le chiavi principali dei clienti** (CMK). Queste CMK sono fondamentali per la crittografia dei dati dell'utente. Una caratteristica notevole di AWS KMS √® che le CMK sono prevalentemente **protette da moduli di sicurezza hardware** (HSM), migliorando la protezione delle chiavi di crittografia.

KMS utilizza la **crittografia simmetrica**. Questa viene utilizzata per **crittografare le informazioni a riposo** (ad esempio, all'interno di un S3). Se √® necessario **crittografare le informazioni in transito**, √® necessario utilizzare qualcosa come **TLS**.

KMS √® un servizio **specifico della regione**.

**Gli amministratori di Amazon non hanno accesso alle tue chiavi**. Non possono recuperare le tue chiavi e non ti aiutano con la crittografia delle tue chiavi. AWS si limita ad amministrare il sistema operativo e l'applicazione sottostante, spetta a noi amministrare le nostre chiavi di crittografia e stabilire come vengono utilizzate.

**Chiavi principali dei clienti** (CMK): Possono crittografare dati fino a 4 KB di dimensione. Vengono tipicamente utilizzate per creare, crittografare e decrittografare le DEK (Data Encryption Keys). Successivamente, le DEK vengono utilizzate per crittografare i dati.

Una chiave principale dei clienti (CMK) √® una rappresentazione logica di una chiave principale in AWS KMS. Oltre agli identificatori della chiave principale e ad altri metadati, tra cui la data di creazione, la descrizione e lo stato della chiave, una **CMK contiene il materiale della chiave utilizzato per crittografare e decrittografare i dati**. Quando si crea una CMK, per impostazione predefinita, AWS KMS genera il materiale della chiave per quella CMK. Tuttavia, √® possibile scegliere di creare una CMK senza materiale della chiave e quindi importare il proprio materiale della chiave in quella CMK.

Ci sono 2 tipi di chiavi principali:

* **CMK gestite da AWS: Utilizzate da altri servizi per crittografare i dati**. Viene utilizzata dal servizio che l'ha creata in una determinata regione. Vengono create la prima volta che si implementa la crittografia in quel servizio. Ruotano ogni 3 anni e non √® possibile cambiarle.
* **CMK gestite dal cliente**: Flessibilit√†, rotazione, accesso configurabile e criteri di chiave. Abilita e disabilita le chiavi.

**Crittografia dell'involucro** nel contesto del servizio di gestione delle chiavi (KMS): Sistema a due livelli gerarchici per **crittografare i dati con una chiave dati e quindi crittografare la chiave dati con una chiave principale**.

### Criteri di chiave

Questi definiscono **chi pu√≤ utilizzare e accedere a una chiave in KMS**.

Per **impostazione predefinita**:

*   Concede all'**account AWS che possiede la chiave KMS pieno accesso** alla chiave KMS.

A differenza di altre politiche delle risorse AWS, una **politica delle chiavi KMS non concede automaticamente il permesso all'account o a uno dei suoi utenti**. Per concedere il permesso agli amministratori dell'account, la **politica delle chiavi deve includere una dichiarazione esplicita** che fornisce questo permesso, come questa.

* Senza consentire all'account (`"AWS": "arn:aws:iam::111122223333:root"`) le autorizzazioni IAM non funzioneranno.
*   Consente all'account di utilizzare le **politiche IAM** per consentire l'accesso alla chiave KMS, oltre alla politica delle chiavi.

**Senza questa autorizzazione, le politiche IAM che consentono l'accesso alla chiave non sono efficaci**, anche se le politiche IAM che negano l'accesso alla chiave sono comunque efficaci.
* Riduce il rischio che la chiave diventi incontrollabile, concedendo il permesso di controllo degli accessi agli amministratori dell'account, inclusi l'utente root dell'account, che non pu√≤ essere eliminato.

Esempio di **politica predefinita**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Se l'**account √® autorizzato** (`"arn:aws:iam::111122223333:root"`) un **principal** dell'account **avr√† comunque bisogno di autorizzazioni IAM** per utilizzare la chiave KMS. Tuttavia, se l'**ARN** di un ruolo ad esempio √® **specificamente autorizzato** nella **Key Policy**, quel ruolo **non ha bisogno di autorizzazioni IAM**.
{% endhint %}

<details>

<summary>Dettagli della Policy</summary>

Propriet√† di una policy:

* Documento basato su JSON
* Resource --> Risorse interessate (pu√≤ essere "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (autorizzazioni)
* Effect --> Allow/Deny
* Principal --> arn interessato
* Conditions (opzionale) --> Condizioni per concedere le autorizzazioni

Grants:

* Consente di delegare le proprie autorizzazioni a un altro principal AWS all'interno del proprio account AWS. √à necessario crearli utilizzando le API AWS KMS. √à possibile indicare l'identificatore CMK, il principal del beneficiario e il livello di operazione richiesto (Decrypt, Encrypt, GenerateDataKey...)
* Dopo la creazione del grant, viene emesso un GrantToken e un GratID

**Accesso**:

* Tramite **key policy** -- Se esiste, questa ha **precedenza** sulla policy IAM
* Tramite **policy IAM**
* Tramite **grants**

</details>

### Amministratori delle chiavi

Amministratore delle chiavi di default:

* Hanno accesso alla gestione di KMS ma non possono crittografare o decrittografare dati
* Solo gli utenti e i ruoli IAM possono essere aggiunti alla lista degli Amministratori delle chiavi (non i gruppi)
* Se viene utilizzato un CMK esterno, gli Amministratori delle chiavi hanno il permesso di importare il materiale della chiave

### Rotazione delle CMK

* Pi√π a lungo la stessa chiave viene lasciata in posizione, pi√π dati vengono crittografati con quella chiave e se quella chiave viene violata, pi√π ampia √® l'area di diffusione dei dati a rischio. Inoltre, pi√π a lungo la chiave √® attiva, maggiore √® la probabilit√† che venga violata.
* **KMS ruota le chiavi dei clienti ogni 365 giorni** (o √® possibile eseguire il processo manualmente quando si desidera) e **le chiavi gestite da AWS ogni 3 anni** e questo tempo non pu√≤ essere modificato.
* **Le chiavi pi√π vecchie vengono conservate** per decrittografare i dati che sono stati crittografati prima della rotazione
* In caso di violazione, la rotazione della chiave non rimuover√† la minaccia in quanto sar√† possibile decrittografare tutti i dati crittografati con la chiave compromessa. Tuttavia, i **nuovi dati verranno crittografati con la nuova chiave**.
* Se la **CMK** √® nello stato di **disabilitata** o **cancellazione in sospeso**, KMS **non eseguir√† una rotazione della chiave** fino a quando la CMK non viene riabilitata o la cancellazione viene annullata.

#### Rotazione manuale

* √à necessario creare una **nuova CMK**, quindi viene creata una nuova CMK-ID, quindi sar√† necessario **aggiornare** qualsiasi **applicazione** per **fare riferimento** alla nuova CMK-ID.
* Per semplificare questo processo √® possibile **utilizzare alias per fare riferimento a un key-id** e quindi aggiornare solo la chiave a cui l'alias fa riferimento.
* √à necessario **conservare le vecchie chiavi per decrittografare i vecchi file** crittografati con esse.

√à possibile importare chiavi dalla propria infrastruttura di chiavi in locale.

### Altre informazioni rilevanti su KMS

KMS ha un costo in base al numero di richieste di crittografia/decrittografia ricevute da tutti i servizi al mese.

KMS ha una completa integrazione di audit e conformit√† con CloudTrail; qui √® possibile verificare tutte le modifiche effettuate su KMS.

Con la policy di KMS √® possibile fare quanto segue:

* Limitare chi pu√≤ creare chiavi dati e quali servizi hanno accesso per utilizzare queste chiavi
* Limitare l'accesso dei sistemi solo alla crittografia, solo alla decrittografia o a entrambe
* Definire per abilitare i sistemi ad accedere alle chiavi tra le regioni (anche se non √® consigliato in quanto un guasto nella regione che ospita KMS influir√† sulla disponibilit√† dei sistemi nelle altre regioni).

Non √® possibile sincronizzare o spostare/copiare chiavi tra le regioni; √® possibile solo definire regole per consentire l'accesso tra le regioni.

### Enumerazione
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
