# AWS - KMS Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい**場合や、**PEASS の最新バージョンにアクセスしたい**場合、または HackTricks を PDF でダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけてください。独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションです
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしてください。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) は、データを暗号化するために使用される暗号化キーである **カスタマーマスターキー** (CMK) を簡単に作成および制御できるようにするマネージドサービスです。AWS KMS CMK は、**ハードウェアセキュリティモジュール** (HSM) によって保護されています。

KMS は **対称暗号** を使用しています。これは、情報を暗号化するために使用されます（たとえば、S3 内部）。情報を転送中に暗号化する必要がある場合は、**TLS** のようなものを使用する必要があります。\
KMS は **リージョン固有のサービス** です。

**Amazon の管理者はキーにアクセスできません**。彼らはキーを回復することはできず、キーの暗号化をサポートすることもありません。AWS は単にオペレーティングシステムと基礎となるアプリケーションを管理し、暗号化キーとそれらのキーの使用方法を管理するのは私たちの責任です。

**カスタマーマスターキー** (CMK): サイズが最大 4KB のデータを暗号化できます。通常、カスタマーマスターキーは、データ暗号化キー（DEK）の作成、暗号化、復号化に使用されます。その後、DEK はデータの暗号化に使用されます。

カスタマーマスターキー (CMK) は、AWS KMS におけるマスターキーの論理的な表現です。マスターキーの識別子やその他のメタデータ（作成日、説明、キーステートなど）に加えて、**CMK にはデータの暗号化および復号化に使用されるキーマテリアルが含まれています**。CMK を作成すると、デフォルトで AWS KMS がその CMK のキーマテリアルを生成します。ただし、キーマテリアルを持たない CMK を作成し、その CMK に独自のキーマテリアルをインポートすることもできます。

マスターキーには2つのタイプがあります:

* **AWS 管理型 CMK: 他のサービスがデータを暗号化するために使用**します。それはそのサービスがそのリージョンで作成したものです。3年ごとにローテーションされ、変更することはできません。
* **カスタマーマネージャー CMK**: 柔軟性、ローテーション、設定可能なアクセスとキーポリシー。キーの有効化と無効化が可能です。

Key Management Service (KMS) の **Envelope Encryption**: データキーでデータを暗号化し、その後、マスターキーでデータキーを暗号化する、2段階の階層システムです。

### キーポリシー

これらは、KMS でキーを使用およびアクセスできるユーザーを定義します。

**デフォルトでは:**

* KMS キーを所有する **AWS アカウントに完全なアクセス権限** を与えます。

他の AWS リソースポリシーとは異なり、AWS **KMS キーポリシーは、アカウントまたはそのユーザーに自動的に許可を与えることはありません**。アカウント管理者に許可を与えるには、このような明示的なステートメントを含むキーポリシーが必要です。

* アカウント(`"AWS": "arn:aws:iam::111122223333:root"`) に許可を与えない限り、IAM の権限は機能しません。
*   キーポリシーに加えて、IAM ポリシーを使用して KMS キーへのアクセスを許可することができます。

**この許可がない場合、キーへのアクセスを許可する IAM ポリシーは無効**ですが、キーへのアクセスを拒否する IAM ポリシーは有効です。
* アカウント管理者、アカウントのルートユーザーなど、アカウント管理者にアクセス制御権限を与えることで、キーが管理できなくなるリスクを軽減します。

**デフォルトのポリシー** の例:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
アカウントが許可されている場合 (`"arn:aws:iam::111122223333:root"`)、アカウントのプリンシパルはKMSキーを使用するためにIAMの権限が必要です。ただし、例えばロールのARNがキーポリシーで明示的に許可されている場合、そのロールにはIAMの権限は必要ありません。
{% endhint %}

<details>

<summary>ポリシーの詳細</summary>

ポリシーのプロパティ:

* JSONベースのドキュメント
* リソース --> 影響を受けるリソース（"\*"にすることも可能）
* アクション --> kms:Encrypt、kms:Decrypt、kms:CreateGrant ...（権限）
* エフェクト --> Allow/Deny
* プリンシパル --> 影響を受けるARN
* 条件（オプション） --> 権限を与えるための条件

グラント:

* AWSアカウント内の別のAWSプリンシパルに権限を委任することができます。AWS KMSのAPIを使用して作成する必要があります。CMKの識別子、委任されるプリンシパル、必要な操作レベル（Decrypt、Encrypt、GenerateDataKey...）を指定できます。
* グラントが作成されると、GrantTokenとGratIDが発行されます。

**アクセス**:

* **キーポリシー**を介して -- これが存在する場合、IAMポリシーより優先されます
* **IAMポリシー**を介して
* **グラント**を介して

</details>

### キー管理者

デフォルトでキー管理者は次のような権限を持ちます:

* KMSを管理する権限はありますが、データの暗号化や復号化の権限はありません
* キー管理者リストにはIAMユーザーやロールのみを追加できます（グループは不可）
* 外部CMKが使用されている場合、キー管理者はキー素材のインポート権限を持ちます

### CMKのローテーション

* 同じキーがそのまま残されるほど、そのキーで暗号化されるデータが増え、そのキーが侵害された場合、データの被害範囲も広がります。さらに、キーがアクティブなままであるほど、侵害される可能性も高まります。
* **KMSは顧客キーを365日ごとにローテーション**します（または必要に応じて手動で実行できます）、AWSが管理するキーは3年ごとにローテーションされ、この時間は変更できません。
* 古いキーは、ローテーション前に暗号化されたデータを復号化するために保持されます。
* キーが侵害された場合、キーのローテーションは脅威を取り除きません。ただし、**新しいデータは新しいキーで暗号化されます**。
* **CMK**が**無効**または**削除保留**の状態である場合、CMKが再度有効になるか削除がキャンセルされるまで、KMSは**キーローテーションを実行しません**。

#### 手動ローテーション

* **新しいCMKを作成する必要があります**。その後、新しいCMK-IDが作成されるため、**アプリケーション**を**新しいCMK-ID**を参照するように**更新する必要があります**。
* このプロセスを簡単にするために、**エイリアスを使用してキーIDを参照**し、エイリアスが参照しているキーを更新するだけです。
* 古いファイルで暗号化された古いファイルを復号化するために、**古いキーを保持する必要があります**。

オンプレミスのキーインフラストラクチャからキーをインポートすることもできます。

### その他の関連するKMS情報

KMSは、月ごとにすべてのサービスから受け取った暗号化/復号化リクエストの数に基づいて価格が設定されます。

KMSは、CloudTrailとの完全な監査およびコンプライアンスの統合を持っています。ここで、KMSで実行されたすべての変更を監査することができます。

KMSポリシーでは、次のことができます:

* データキーを作成できるユーザーとこれらのキーを使用できるサービスを制限する
* システムのアクセスを暗号化のみ、復号化のみ、または両方に制限する
* システムがリージョン間でキーにアクセスできるようにする（ただし、KMSをホストしているリージョンの障害が他のリージョンのシステムの可用性に影響を与える可能性があるため、推奨されていません）。

キーをリージョン間で同期したり移動/コピーしたりすることはできません。リージョン間でアクセスを許可するためのルールのみを定義できます。

### 列挙
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
