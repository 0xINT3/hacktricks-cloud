# AWS - KMS 枚举

<details>

<summary><strong>从零到英雄学习AWS黑客技术，参加</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## KMS - 密钥管理服务

AWS 密钥管理服务 (AWS KMS) 是一个托管服务，它使您能够轻松**创建和控制客户主密钥**（CMKs），这些加密密钥用于加密您的数据。AWS KMS CMKs 由**硬件安全模块**（HSMs）保护。

KMS 使用**对称加密**。这用于**加密静态信息**（例如，在S3内部）。如果您需要**加密传输中的信息**，您需要使用类似**TLS**的东西。\
KMS 是一个**特定于区域的服务**。

**亚马逊的管理员无法访问您的密钥**。他们不能恢复您的密钥，也不会帮助您加密您的密钥。AWS只是管理操作系统和底层应用程序，我们负责管理我们的加密密钥以及管理这些密钥的使用方式。

**客户主密钥**（CMK）：可以加密最大4KB大小的数据。它们通常用于创建、加密和解密DEKs（数据加密密钥）。然后使用DEKs来加密数据。

客户主密钥（CMK）是AWS KMS中主密钥的逻辑表示。除了主密钥的标识符和其他元数据，包括其创建日期、描述和密钥状态，**CMK包含用于加密和解密数据的密钥材料**。当您创建CMK时，默认情况下，AWS KMS会为该CMK生成密钥材料。然而，您可以选择创建一个没有密钥材料的CMK，然后将您自己的密钥材料导入该CMK。

有两种类型的主密钥：

* **AWS管理的CMKs：由其他服务用来加密数据**。它由在一个区域中创建它的服务使用。它们在您第一次在该服务中实施加密时创建。每3年轮换一次，无法更改。
* **客户管理的CMKs**：灵活性、轮换、可配置的访问和密钥策略。启用和禁用密钥。

**信封加密**在密钥管理服务（KMS）的上下文中：两层层次系统，**用数据密钥加密数据，然后用主密钥加密数据密钥**。

### 密钥策略

这定义了**谁可以在KMS中使用和访问密钥**。

**默认情况下：**

*   它为**拥有KMS密钥的AWS账户提供对KMS密钥的完全访问权限**。

与其他AWS资源策略不同，AWS **KMS密钥策略不会自动授权给账户或其任何用户**。要授权给账户管理员，**密钥策略必须包括一个明确的声明**来提供这种权限，如下所示。

* 如果不允许账户（`"AWS": "arn:aws:iam::111122223333:root"`）IAM权限将不起作用。
*   它**允许账户使用IAM策略**来允许访问KMS密钥，除了密钥策略。

**没有这个权限，允许访问密钥的IAM策略是无效的**，尽管拒绝访问密钥的IAM策略仍然有效。
* 它通过给予账户管理员访问控制权限，包括无法删除的账户根用户，**降低了密钥变得不可管理的风险**。

**默认策略**示例：
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
如果**账户被允许**（`"arn:aws:iam::111122223333:root"`），账户中的**主体**仍然需要IAM权限来使用KMS密钥。然而，如果角色的**ARN**例如在**密钥策略**中**特别允许**，那么该角色**不需要IAM权限**。
{% endhint %}

<details>

<summary>策略详情</summary>

策略的属性：

* 基于JSON的文档
* 资源 --> 受影响的资源（可以是"\*"）
* 操作 --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ...（权限）
* 效果 --> 允许/拒绝
* 主体 --> 受影响的arn
* 条件（可选） --> 给予权限的条件

授权：

* 允许将您的权限委托给您AWS账户内的另一个AWS主体。您需要使用AWS KMS API来创建它们。可以指定CMK标识符、授权主体和所需的操作级别（Decrypt, Encrypt, GenerateDataKey...）
* 授权创建后，将发放GrantToken和GratID

**访问**：

* 通过**密钥策略** -- 如果存在，这将**优先**于IAM策略
* 通过**IAM策略**
* 通过**授权**

</details>

### 密钥管理员

默认的密钥管理员：

* 有权限管理KMS，但没有加密或解密数据的权限
* 只有IAM用户和角色可以被添加到密钥管理员列表（不包括组）
* 如果使用外部CMK，密钥管理员有权限导入密钥材料

### CMKs的轮换

* 同一个密钥放置的时间越长，用该密钥加密的数据就越多，如果该密钥被泄露，那么数据的风险范围就越广。此外，密钥活跃的时间越长，被泄露的可能性就越大。
* **KMS每365天轮换一次客户密钥**（或者您可以随时手动执行此过程），并且**AWS管理的密钥每3年轮换一次**，这个时间不能改变。
* **保留旧密钥**以解密在轮换之前加密的数据
* 在安全事件中，轮换密钥不会消除威胁，因为有可能用被泄露的密钥解密所有数据。然而，**新数据将使用新密钥加密**。
* 如果**CMK**处于**禁用**或**待删除**状态，KMS将**不执行密钥轮换**，直到CMK重新启用或取消删除。

#### 手动轮换

* 需要**创建一个新的CMK**，然后，创建一个新的CMK-ID，因此您需要**更新**任何**应用程序**以**引用**新的CMK-ID。
* 为了简化这个过程，您可以**使用别名来引用一个密钥ID**，然后只更新别名所指向的密钥。
* 您需要**保留旧密钥以解密用它加密的旧文件**。

您可以从您的本地密钥基础设施导入密钥。

### 其他相关KMS信息

KMS的定价是根据每月从所有服务收到的加密/解密请求的数量。

KMS具有与CloudTrail的完整审计和合规性**集成**；这是您可以审计在KMS上执行的所有更改的地方。

使用KMS策略，您可以执行以下操作：

* 限制谁可以创建数据密钥以及哪些服务可以使用这些密钥
* 限制系统仅访问加密、解密或两者
* 定义启用系统跨区域访问密钥的规则（尽管不推荐，因为托管KMS的区域出现故障将影响其他区域系统的可用性）。

您不能跨区域同步或移动/复制密钥；您只能定义规则以允许跨区域访问。

### 枚举
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### 权限提升

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### 后期利用

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### 持久性

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## 参考资料

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧。

</details>
