# AWS - √ânum√©ration KMS

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS - Service de Gestion des Cl√©s

AWS Key Management Service (AWS KMS) est un service g√©r√© qui facilite la **cr√©ation et le contr√¥le des cl√©s ma√Ætresses clients** (CMKs), les cl√©s de chiffrement utilis√©es pour chiffrer vos donn√©es. Les CMKs d'AWS KMS sont g√©n√©ralement **prot√©g√©es par des modules de s√©curit√© mat√©riels** (HSMs).

KMS utilise la **cryptographie sym√©trique**. Cela est utilis√© pour **chiffrer les informations au repos** (par exemple, √† l'int√©rieur d'un S3). Si vous avez besoin de **chiffrer des informations en transit**, vous devez utiliser quelque chose comme **TLS**.\
KMS est un **service sp√©cifique √† une r√©gion**.

**Les administrateurs chez Amazon n'ont pas acc√®s √† vos cl√©s**. Ils ne peuvent pas r√©cup√©rer vos cl√©s et ils ne vous aident pas avec le chiffrement de vos cl√©s. AWS administre simplement le syst√®me d'exploitation et l'application sous-jacente, il nous appartient de g√©rer nos cl√©s de chiffrement et de contr√¥ler comment ces cl√©s sont utilis√©es.

**Cl√©s Ma√Ætresses Clients** (CMK) : Peuvent chiffrer des donn√©es jusqu'√† 4KB de taille. Elles sont typiquement utilis√©es pour cr√©er, chiffrer et d√©chiffrer les DEKs (Data Encryption Keys). Ensuite, les DEKs sont utilis√©es pour chiffrer les donn√©es.

Une cl√© ma√Ætresse client (CMK) est une repr√©sentation logique d'une cl√© ma√Ætresse dans AWS KMS. En plus des identifiants de la cl√© ma√Ætresse et d'autres m√©tadonn√©es, y compris sa date de cr√©ation, sa description et son √©tat, une **CMK contient le mat√©riel de cl√© utilis√© pour chiffrer et d√©chiffrer les donn√©es**. Lorsque vous cr√©ez une CMK, par d√©faut, AWS KMS g√©n√®re le mat√©riel de cl√© pour cette CMK. Cependant, vous pouvez choisir de cr√©er une CMK sans mat√©riel de cl√©, puis importer votre propre mat√©riel de cl√© dans cette CMK.

Il existe 2 types de cl√©s ma√Ætresses :

* **CMKs g√©r√©es par AWS : Utilis√©es par d'autres services pour chiffrer les donn√©es**. Elles sont utilis√©es par le service qui les a cr√©√©es dans une r√©gion. Elles sont cr√©√©es la premi√®re fois que vous mettez en ≈ìuvre le chiffrement dans ce service. Rotation tous les 3 ans et il n'est pas possible de la modifier.
* **CMKs g√©r√©es par le client** : Flexibilit√©, rotation, acc√®s configurable et politique de cl√©. Activer et d√©sactiver les cl√©s.

**Chiffrement Enveloppe** dans le contexte du Service de Gestion des Cl√©s (KMS) : Syst√®me hi√©rarchique √† deux niveaux pour **chiffrer les donn√©es avec une cl√© de donn√©es, puis chiffrer la cl√© de donn√©es avec une cl√© ma√Ætresse**.

### Politiques de Cl√©s

Celles-ci d√©finissent **qui peut utiliser et acc√©der √† une cl√© dans KMS**.

Par **d√©faut :**

*   Elle donne √† **compte AWS qui poss√®de la cl√© KMS un acc√®s complet** √† la cl√© KMS.

Contrairement aux autres politiques de ressources AWS, une **politique de cl√© KMS ne donne pas automatiquement la permission au compte ou √† ses utilisateurs**. Pour donner la permission aux administrateurs du compte, la **politique de cl√© doit inclure une d√©claration explicite** qui fournit cette permission, comme celle-ci.

* Sans autoriser le compte (`"AWS": "arn:aws:iam::111122223333:root"`) les permissions IAM ne fonctionneront pas.
*   Elle **permet au compte d'utiliser les politiques IAM** pour autoriser l'acc√®s √† la cl√© KMS, en plus de la politique de cl√©.

**Sans cette permission, les politiques IAM qui autorisent l'acc√®s √† la cl√© sont inefficaces**, bien que les politiques IAM qui refusent l'acc√®s √† la cl√© soient toujours efficaces.
* Elle **r√©duit le risque que la cl√© devienne ing√©rable** en donnant la permission de contr√¥le d'acc√®s aux administrateurs du compte, y compris l'utilisateur racine du compte, qui ne peut pas √™tre supprim√©.

Exemple de **politique par d√©faut** :
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Si le **compte est autoris√©** (`"arn:aws:iam::111122223333:root"`), un **principal** du compte **aura toujours besoin des permissions IAM** pour utiliser la cl√© KMS. Cependant, si l'**ARN** d'un r√¥le par exemple est **sp√©cifiquement autoris√©** dans la **politique de cl√©**, ce r√¥le **n'aura pas besoin de permissions IAM**.
{% endhint %}

<details>

<summary>D√©tails de la politique</summary>

Propri√©t√©s d'une politique :

* Document bas√© sur JSON
* Ressource --> Ressources affect√©es (peut √™tre "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permissions)
* Effet --> Autoriser/Refuser
* Principal --> arn affect√©
* Conditions (optionnel) --> Condition pour donner les permissions

Subventions :

* Permet de d√©l√©guer vos permissions √† un autre principal AWS au sein de votre compte AWS. Vous devez les cr√©er en utilisant les API AWS KMS. Il est possible d'indiquer l'identifiant CMK, le principal b√©n√©ficiaire et le niveau requis d'op√©ration (Decrypt, Encrypt, GenerateDataKey...)
* Apr√®s la cr√©ation de la subvention, un GrantToken et un GrantID sont √©mis

**Acc√®s** :

* Via **politique de cl√©** -- Si elle existe, elle prend **pr√©c√©dence** sur la politique IAM
* Via **politique IAM**
* Via **subventions**

</details>

### Administrateurs de cl√©s

Administrateur de cl√© par d√©faut :

* Ont acc√®s √† la gestion de KMS mais pas au chiffrement ou d√©chiffrement des donn√©es
* Seuls les utilisateurs et r√¥les IAM peuvent √™tre ajout√©s √† la liste des administrateurs de cl√©s (pas les groupes)
* Si un CMK externe est utilis√©, les administrateurs de cl√©s ont la permission d'importer du mat√©riel de cl√©

### Rotation des CMKs

* Plus une cl√© est laiss√©e en place longtemps, plus de donn√©es sont chiffr√©es avec cette cl√©, et si cette cl√© est compromise, alors plus large est la zone d'impact des donn√©es √† risque. De plus, plus la cl√© est active longtemps, plus la probabilit√© qu'elle soit compromise augmente.
* **KMS fait tourner les cl√©s des clients tous les 365 jours** (ou vous pouvez effectuer le processus manuellement quand vous le souhaitez) et **les cl√©s g√©r√©es par AWS tous les 3 ans** et ce d√©lai ne peut pas √™tre chang√©.
* **Les anciennes cl√©s sont conserv√©es** pour d√©chiffrer les donn√©es qui ont √©t√© chiffr√©es avant la rotation
* En cas de br√®che, faire tourner la cl√© n'√©liminera pas la menace car il sera possible de d√©chiffrer toutes les donn√©es chiffr√©es avec la cl√© compromise. Cependant, **les nouvelles donn√©es seront chiffr√©es avec la nouvelle cl√©**.
* Si le **CMK** est dans un √©tat **d√©sactiv√©** ou en **attente de suppression**, KMS **ne proc√©dera pas √† une rotation de cl√©** jusqu'√† ce que le CMK soit r√©activ√© ou que la suppression soit annul√©e.

#### Rotation manuelle

* Un **nouveau CMK doit √™tre cr√©√©**, puis, un nouveau CMK-ID est cr√©√©, donc vous devrez **mettre √† jour** toute **application** pour **r√©f√©rencer** le nouveau CMK-ID.
* Pour faciliter ce processus, vous pouvez **utiliser des alias pour r√©f√©rer √† un key-id** et ensuite juste mettre √† jour la cl√© √† laquelle l'alias fait r√©f√©rence.
* Vous devez **conserver les anciennes cl√©s pour d√©chiffrer les vieux fichiers** chiffr√©s avec elles.

Vous pouvez importer des cl√©s de votre infrastructure de cl√©s sur site.

### Autres informations pertinentes sur KMS

KMS est tarif√© par nombre de demandes de chiffrement/d√©chiffrement re√ßues de tous les services par mois.

KMS a une int√©gration compl√®te d'audit et de conformit√© avec **CloudTrail** ; c'est l√† que vous pouvez auditer tous les changements effectu√©s sur KMS.

Avec la politique KMS, vous pouvez faire ce qui suit :

* Limiter qui peut cr√©er des cl√©s de donn√©es et quels services ont acc√®s √† utiliser ces cl√©s
* Limiter l'acc√®s des syst√®mes uniquement au chiffrement, uniquement au d√©chiffrement ou aux deux
* D√©finir pour permettre aux syst√®mes d'acc√©der aux cl√©s √† travers les r√©gions (bien que cela ne soit pas recommand√© car une d√©faillance dans la r√©gion h√©bergeant KMS affectera la disponibilit√© des syst√®mes dans d'autres r√©gions).

Vous ne pouvez pas synchroniser ou d√©placer/copier des cl√©s √† travers les r√©gions ; vous pouvez seulement d√©finir des r√®gles pour permettre l'acc√®s √† travers les r√©gions.

### √ânum√©ration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### √âl√©vation de privil√®ges

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post-exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
