# AWS - KMS Enum

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## KMS - Service de gestion des cl√©s

Le service de gestion des cl√©s AWS (AWS KMS) est pr√©sent√© comme un service g√©r√©, simplifiant le processus pour les utilisateurs de **cr√©er et g√©rer des cl√©s principales clients** (CMK). Ces CMK sont essentiels dans le chiffrement des donn√©es utilisateur. Une caract√©ristique notable d'AWS KMS est que les CMK sont principalement **s√©curis√©es par des modules mat√©riels de s√©curit√©** (HSM), renfor√ßant la protection des cl√©s de chiffrement.

KMS utilise la **cryptographie sym√©trique**. Cela est utilis√© pour **chiffrer des informations au repos** (par exemple, √† l'int√©rieur d'un S3). Si vous devez **chiffrer des informations en transit**, vous devez utiliser quelque chose comme **TLS**.

KMS est un **service sp√©cifique √† une r√©gion**.

**Les administrateurs d'Amazon n'ont pas acc√®s √† vos cl√©s**. Ils ne peuvent pas r√©cup√©rer vos cl√©s et ils ne vous aident pas √† chiffrer vos cl√©s. AWS administre simplement le syst√®me d'exploitation et l'application sous-jacente, il nous appartient d'administrer nos cl√©s de chiffrement et de g√©rer la mani√®re dont ces cl√©s sont utilis√©es.

**Cl√©s principales clients** (CMK) : Peuvent chiffrer des donn√©es jusqu'√† 4 Ko. Elles sont g√©n√©ralement utilis√©es pour cr√©er, chiffrer et d√©chiffrer les DEK (cl√©s de chiffrement de donn√©es). Ensuite, les DEK sont utilis√©es pour chiffrer les donn√©es.

Une cl√© principale client (CMK) est une repr√©sentation logique d'une cl√© principale dans AWS KMS. En plus des identifiants de la cl√© principale et d'autres m√©tadonn√©es, y compris sa date de cr√©ation, sa description et son √©tat de cl√©, une **CMK contient le mat√©riel de cl√© utilis√© pour chiffrer et d√©chiffrer des donn√©es**. Lorsque vous cr√©ez une CMK, par d√©faut, AWS KMS g√©n√®re le mat√©riel de cl√© pour cette CMK. Cependant, vous pouvez choisir de cr√©er une CMK sans mat√©riel de cl√©, puis importer votre propre mat√©riel de cl√© dans cette CMK.

Il existe 2 types de cl√©s principales :

* **CMK g√©r√©es par AWS : Utilis√©es par d'autres services pour chiffrer des donn√©es**. Elles sont utilis√©es par le service qui les a cr√©√©es dans une r√©gion. Elles sont cr√©√©es la premi√®re fois que vous mettez en ≈ìuvre le chiffrement dans ce service. Elles sont renouvel√©es tous les 3 ans et il n'est pas possible de les modifier.
* **CMK g√©r√©es par le client** : Flexibilit√©, rotation, acc√®s configurable et politique de cl√©. Activer et d√©sactiver les cl√©s.

**Chiffrement d'enveloppe** dans le contexte du Service de gestion des cl√©s (KMS) : Syst√®me hi√©rarchique √† deux niveaux pour **chiffrer des donn√©es avec une cl√© de donn√©es puis chiffrer la cl√© de donn√©es avec une cl√© principale**.

### Politiques de cl√©

Ces politiques d√©finissent **qui peut utiliser et acc√©der √† une cl√© dans KMS**.

Par **d√©faut** :

* Il donne √† **l'AWS account propri√©taire de la cl√© KMS un acc√®s complet** √† la cl√© KMS.

Contrairement aux autres politiques de ressources AWS, une **politique de cl√© KMS ne donne pas automatiquement la permission au compte ou √† l'un de ses utilisateurs**. Pour donner la permission aux administrateurs du compte, la **politique de cl√© doit inclure une d√©claration explicite** qui fournit cette permission, comme celle-ci.

* Sans autoriser le compte (`"AWS": "arn:aws:iam::111122223333:root"`), les autorisations IAM ne fonctionneront pas.
* Il **autorise le compte √† utiliser des politiques IAM** pour permettre l'acc√®s √† la cl√© KMS, en plus de la politique de cl√©.

**Sans cette permission, les politiques IAM qui autorisent l'acc√®s √† la cl√© sont inefficaces**, bien que les politiques IAM qui refusent l'acc√®s √† la cl√© restent efficaces.

* Il **r√©duit le risque que la cl√© devienne ing√©rable** en donnant la permission de contr√¥le d'acc√®s aux administrateurs du compte, y compris l'utilisateur racine du compte, qui ne peut pas √™tre supprim√©.

Exemple de **politique par d√©faut** :

```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```

{% hint style="warning" %}
Si le **compte est autoris√©** (`"arn:aws:iam::111122223333:root"`) un **principal** du compte aura toujours besoin des autorisations IAM pour utiliser la cl√© KMS. Cependant, si l'**ARN** d'un r√¥le par exemple est **sp√©cifiquement autoris√©** dans la **Politique de cl√©**, ce r√¥le **n'aura pas besoin des autorisations IAM**.
{% endhint %}

<details>

<summary>D√©tails de la politique</summary>

Propri√©t√©s d'une politique :

* Document bas√© sur JSON
* Ressource --> Ressources affect√©es (peut √™tre "\*")
* Action --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (autorisations)
* Effet --> Autoriser/Refuser
* Principal --> arn affect√©
* Conditions (optionnel) --> Condition pour accorder les autorisations

D√©l√©gations :

* Autoriser √† d√©l√©guer vos autorisations √† un autre principal AWS au sein de votre compte AWS. Vous devez les cr√©er en utilisant les APIs AWS KMS. Il est possible d'indiquer l'identifiant CMK, le principal b√©n√©ficiaire et le niveau d'op√©ration requis (Decrypt, Encrypt, GenerateDataKey...)
* Apr√®s la cr√©ation de la d√©l√©gation, un jeton de d√©l√©gation et un ID de d√©l√©gation sont √©mis

**Acc√®s** :

* Via la **politique de cl√©** -- Si elle existe, elle a **priorit√©** sur la politique IAM
* Via la **politique IAM**
* Via les **d√©l√©gations**

</details>

### Administrateurs de cl√©s

Administrateur de cl√©s par d√©faut :

* Ont acc√®s pour g√©rer KMS mais pas pour chiffrer ou d√©chiffrer des donn√©es
* Seuls les utilisateurs et r√¥les IAM peuvent √™tre ajout√©s √† la liste des administrateurs de cl√©s (pas les groupes)
* Si une CMK externe est utilis√©e, les administrateurs de cl√©s ont la permission d'importer du mat√©riel de cl√©

### Rotation des CMKs

* Plus la m√™me cl√© reste en place longtemps, plus de donn√©es sont chiffr√©es avec cette cl√©, et si cette cl√© est compromise, plus la zone de donn√©es √† risque est large. De plus, plus la cl√© est active longtemps, plus la probabilit√© qu'elle soit compromise augmente.
* **KMS fait tourner les cl√©s clients tous les 365 jours** (ou vous pouvez effectuer le processus manuellement quand vous le souhaitez) et **les cl√©s g√©r√©es par AWS tous les 3 ans** et ce d√©lai ne peut pas √™tre modifi√©.
* **Les anciennes cl√©s sont conserv√©es** pour d√©chiffrer les donn√©es qui ont √©t√© chiffr√©es avant la rotation
* En cas de compromission, faire tourner la cl√© ne supprimera pas la menace car il sera possible de d√©chiffrer toutes les donn√©es chiffr√©es avec la cl√© compromise. Cependant, les **nouvelles donn√©es seront chiffr√©es avec la nouvelle cl√©**.
* Si la **CMK** est dans un √©tat de **d√©sactiv√©** ou de **suppression en attente**, KMS ne **fera pas tourner une cl√©** jusqu'√† ce que la CMK soit r√©activ√©e ou que la suppression soit annul√©e.

#### Rotation manuelle

* Une **nouvelle CMK doit √™tre cr√©√©e**, ensuite, un nouvel identifiant de CMK est cr√©√©, donc vous devrez **mettre √† jour** toute **application** pour **r√©f√©rencer** le nouvel identifiant de CMK.
* Pour rendre ce processus plus facile, vous pouvez **utiliser des alias pour faire r√©f√©rence √† un identifiant de cl√©** et ensuite simplement mettre √† jour la cl√© √† laquelle l'alias fait r√©f√©rence.
* Vous devez **conserver les anciennes cl√©s pour d√©chiffrer les anciens fichiers** chiffr√©s avec elles.

Vous pouvez importer des cl√©s depuis votre infrastructure de cl√©s sur site.

### Autres informations pertinentes sur KMS

KMS est tarif√© par le nombre de demandes de chiffrement/d√©chiffrement re√ßues de tous les services par mois.

KMS a une int√©gration compl√®te d'audit et de conformit√© avec CloudTrail ; c'est l√† que vous pouvez auditer toutes les modifications effectu√©es sur KMS.

Avec la politique KMS, vous pouvez faire ce qui suit :

* Limiter qui peut cr√©er des cl√©s de donn√©es et quels services ont acc√®s pour utiliser ces cl√©s
* Limiter l'acc√®s des syst√®mes √† chiffrer uniquement, d√©chiffrer uniquement ou les deux
* D√©finir pour permettre aux syst√®mes d'acc√©der aux cl√©s √† travers les r√©gions (bien que ce ne soit pas recommand√© car une panne dans la r√©gion h√©bergeant KMS affectera la disponibilit√© des syst√®mes dans d'autres r√©gions).

Vous ne pouvez pas synchroniser ou d√©placer/copier des cl√©s entre les r√©gions ; vous pouvez seulement d√©finir des r√®gles pour permettre l'acc√®s entre les r√©gions.

### √ânum√©ration

```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```

### √âl√©vation de privil√®ges

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post-exploitation

{% content-ref url="../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
