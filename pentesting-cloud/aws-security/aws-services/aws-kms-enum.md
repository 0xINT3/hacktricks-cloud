# AWS - KMS Enum

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) se presenta como un servicio gestionado, simplificando el proceso para que los usuarios **creen y administren las claves maestras de clientes** (CMKs). Estas CMKs son fundamentales en la encriptaci칩n de datos de los usuarios. Una caracter칤stica notable de AWS KMS es que las CMKs est치n predominantemente **protegidas por m칩dulos de seguridad de hardware** (HSMs), mejorando la protecci칩n de las claves de encriptaci칩n.

KMS utiliza **criptograf칤a sim칠trica**. Se utiliza para **encriptar informaci칩n en reposo** (por ejemplo, dentro de un S3). Si necesitas **encriptar informaci칩n en tr치nsito** debes usar algo como **TLS**.

KMS es un **servicio espec칤fico de regi칩n**.

**Los administradores de Amazon no tienen acceso a tus claves**. No pueden recuperar tus claves y no te ayudan con la encriptaci칩n de tus claves. AWS simplemente administra el sistema operativo y la aplicaci칩n subyacente, depende de nosotros administrar nuestras claves de encriptaci칩n y c칩mo se utilizan estas claves.

**Claves Maestras de Cliente** (CMK): Pueden encriptar datos de hasta 4KB de tama침o. Se utilizan t칤picamente para crear, encriptar y desencriptar las DEKs (Claves de Encriptaci칩n de Datos). Luego, las DEKs se utilizan para encriptar los datos.

Una clave maestra de cliente (CMK) es una representaci칩n l칩gica de una clave maestra en AWS KMS. Adem치s de los identificadores de la clave maestra y otros metadatos, incluyendo su fecha de creaci칩n, descripci칩n y estado de la clave, una **CMK contiene el material de la clave que se utiliza para encriptar y desencriptar datos**. Cuando creas una CMK, por defecto, AWS KMS genera el material de la clave para esa CMK. Sin embargo, puedes optar por crear una CMK sin material de clave y luego importar tu propio material de clave en esa CMK.

Hay 2 tipos de claves maestras:

* **CMKs gestionadas por AWS: Utilizadas por otros servicios para encriptar datos**. Es utilizada por el servicio que la cre칩 en una regi칩n. Se crean la primera vez que implementas la encriptaci칩n en ese servicio. Rotan cada 3 a침os y no es posible cambiarlas.
* **CMKs gestionadas por el cliente**: Flexibilidad, rotaci칩n, acceso configurable y pol칤tica de clave. Habilitar y deshabilitar claves.

**Encriptaci칩n de Sobre** en el contexto del Key Management Service (KMS): Sistema jer치rquico de dos niveles para **encriptar datos con clave de datos y luego encriptar la clave de datos con la clave maestra**.

### Pol칤ticas de Clave

Estas definen **qui칠n puede usar y acceder a una clave en KMS**.

Por **defecto:**

*   Otorga al **cuenta de AWS que posee la clave KMS acceso completo** a la clave KMS.

A diferencia de otras pol칤ticas de recursos de AWS, una **pol칤tica de clave KMS no otorga autom치ticamente permiso a la cuenta o a cualquiera de sus usuarios**. Para dar permiso a los administradores de la cuenta, la **pol칤tica de clave debe incluir una declaraci칩n expl칤cita** que proporcione este permiso, como esta.

* Sin permitir a la cuenta (`"AWS": "arn:aws:iam::111122223333:root"`) los permisos de IAM no funcionar치n.
*   Permite a la cuenta usar pol칤ticas de IAM para permitir el acceso a la clave KMS, adem치s de la pol칤tica de clave.

**Sin este permiso, las pol칤ticas de IAM que permiten el acceso a la clave son ineficaces**, aunque las pol칤ticas de IAM que niegan el acceso a la clave siguen siendo efectivas.
* Reduce el riesgo de que la clave se vuelva ingobernable al otorgar permiso de control de acceso a los administradores de la cuenta, incluido el usuario ra칤z de la cuenta, que no se puede eliminar.

Ejemplo de **pol칤tica por defecto**:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
Si la **cuenta est치 permitida** (`"arn:aws:iam::111122223333:root"`), un **principal** de la cuenta **a칰n necesitar치 permisos IAM** para usar la clave KMS. Sin embargo, si el **ARN** de un rol, por ejemplo, est치 **espec칤ficamente permitido** en la **Pol칤tica de la Clave**, ese rol **no necesita permisos IAM**.
{% endhint %}

<details>

<summary>Detalles de la Pol칤tica</summary>

Propiedades de una pol칤tica:

* Documento basado en JSON
* Recurso --> Recursos afectados (puede ser "\*")
* Acci칩n --> kms:Encrypt, kms:Decrypt, kms:CreateGrant ... (permisos)
* Efecto --> Permitir/Negar
* Principal --> arn afectado
* Condiciones (opcional) --> Condici칩n para otorgar los permisos

Concesiones:

* Permiten delegar tus permisos a otro principal de AWS dentro de tu cuenta de AWS. Necesitas crearlas usando las APIs de AWS KMS. Se puede indicar el identificador de CMK, el principal beneficiario y el nivel requerido de operaci칩n (Decrypt, Encrypt, GenerateDataKey...)
* Despu칠s de que se crea la concesi칩n, se emiten un GrantToken y un GrantID

**Acceso**:

* A trav칠s de la **pol칤tica de la clave** -- Si esta existe, tiene **precedencia** sobre la pol칤tica IAM
* A trav칠s de la **pol칤tica IAM**
* A trav칠s de **concesiones**

</details>

### Administradores de Claves

Administrador de claves por defecto:

* Tienen acceso para gestionar KMS pero no para cifrar o descifrar datos
* Solo usuarios y roles IAM pueden ser a침adidos a la lista de Administradores de Claves (no grupos)
* Si se usa un CMK externo, los Administradores de Claves tienen permiso para importar material de clave

### Rotaci칩n de CMKs

* Cuanto m치s tiempo se deja la misma clave en su lugar, m치s datos se cifran con esa clave, y si esa clave se ve comprometida, entonces mayor es el 치rea de impacto de los datos en riesgo. Adem치s de esto, cuanto m치s tiempo est칠 activa la clave, mayor es la probabilidad de que se vea comprometida.
* **KMS rota las claves de los clientes cada 365 d칤as** (o puedes realizar el proceso manualmente cuando quieras) y **las claves gestionadas por AWS cada 3 a침os** y este tiempo no se puede cambiar.
* **Se retienen las claves antiguas** para descifrar datos que fueron cifrados antes de la rotaci칩n
* En una violaci칩n, rotar la clave no eliminar치 la amenaza ya que ser치 posible descifrar todos los datos cifrados con la clave comprometida. Sin embargo, **los nuevos datos se cifrar치n con la nueva clave**.
* Si el **CMK** est치 en estado de **deshabilitado** o **pendiente de eliminaci칩n**, KMS **no realizar치 una rotaci칩n de clave** hasta que el CMK est칠 habilitado nuevamente o se cancele la eliminaci칩n.

#### Rotaci칩n manual

* Se necesita **crear un nuevo CMK**, luego, se crea un nuevo CMK-ID, por lo que necesitar치s **actualizar** cualquier **aplicaci칩n** para **referenciar** el nuevo CMK-ID.
* Para hacer este proceso m치s f치cil puedes **usar alias para referirte a un key-id** y luego solo actualizar la clave a la que el alias est치 refiriendo.
* Necesitas **mantener las claves antiguas para descifrar archivos viejos** cifrados con ellas.

Puedes importar claves de tu infraestructura de claves local.

### Otra informaci칩n relevante de KMS

KMS tiene un precio por n칰mero de solicitudes de cifrado/descifrado recibidas de todos los servicios por mes.

KMS tiene completa **integraci칩n de auditor칤a y cumplimiento con CloudTrail**; aqu칤 es donde puedes auditar todos los cambios realizados en KMS.

Con la pol칤tica de KMS puedes hacer lo siguiente:

* Limitar qui칠n puede crear claves de datos y qu칠 servicios tienen acceso para usar estas claves
* Limitar el acceso de sistemas solo para cifrar, solo para descifrar o ambos
* Definir para permitir que los sistemas accedan a claves a trav칠s de regiones (aunque no se recomienda ya que una falla en la regi칩n que aloja KMS afectar치 la disponibilidad de sistemas en otras regiones).

No puedes sincronizar o mover/copiar claves a trav칠s de regiones; solo puedes definir reglas para permitir acceso a trav칠s de regiones.

### Enumeraci칩n
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Escalaci칩n de Privilegios

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Explotaci칩n

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Aprende hacking de AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
