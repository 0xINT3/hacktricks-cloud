# AWS - Lambda Enum

<details>

<summary><strong>Supportez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Lambda

Amazon Web Services (AWS) Lambda est un service de calcul qui vous permet d'**ex√©cuter du code sans provisionner ni g√©rer de serveurs**. Lambda **g√®re automatiquement les ressources n√©cessaires** pour ex√©cuter votre code et fournit des fonctionnalit√©s de disponibilit√© √©lev√©e, de mise √† l'√©chelle et de s√©curit√©. Avec Lambda, **vous ne payez que le temps de calcul que vous consommez**, et il n'y a pas de co√ªts initiaux ni d'engagements √† long terme.

Pour appeler une lambda, il est possible de l'appeler aussi **fr√©quemment que vous le souhaitez** (avec Cloudwatch), **exposer** un **point de terminaison URL** et l'appeler, l'appeler via **API Gateway** ou m√™me en fonction d'**√©v√©nements** tels que des **modifications** des donn√©es dans un **bucket S3** ou des mises √† jour d'une **table DynamoDB**.

Le **code** d'une lambda est stock√© dans **`/var/task`**.

### Poids des alias Lambda

Une Lambda peut avoir **plusieurs versions**.\
Et elle peut avoir **plus d'une** version expos√©e via des **alias**. Les **poids** de **chacune** des **versions** expos√©es √† l'int√©rieur d'un alias d√©cideront **quel alias re√ßoit l'invocation** (cela peut √™tre 90%-10% par exemple).\
Si le code de **l'un** des alias est **vuln√©rable**, vous pouvez envoyer des **requ√™tes jusqu'√† ce que la version vuln√©rable** re√ßoive l'exploit.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Politiques de ressources Lambda

Les politiques de ressources Lambda permettent de **donner acc√®s √† d'autres services/comptes pour invoquer** la lambda par exemple.\
Par exemple, voici la politique permettant √† **n'importe qui d'acc√©der √† une lambda expos√©e via une URL** :

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Ou ceci pour permettre √† une API Gateway de l'invoquer :

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Proxies de base de donn√©es Lambda

Lorsqu'il y a des **centaines** de **demandes lambda simultan√©es**, si chacune d'entre elles doit **se connecter et fermer une connexion √† une base de donn√©es**, cela ne fonctionnera tout simplement pas (les lambdas sont sans √©tat, elles ne peuvent pas maintenir des connexions ouvertes).\
Dans ce cas, si vos **fonctions Lambda interagissent avec RDS Proxy** au lieu de votre instance de base de donn√©es, cela g√®re le pool de connexions n√©cessaire pour mettre √† l'√©chelle de nombreuses connexions simultan√©es cr√©√©es par des fonctions Lambda concurrentes. Cela permet √† vos applications Lambda de **r√©utiliser les connexions existantes**, plut√¥t que de cr√©er de nouvelles connexions pour chaque invocation de fonction.

### Syst√®mes de fichiers EFS Lambda

Pour pr√©server et m√™me partager des donn√©es, **les Lambdas peuvent acc√©der √† EFS et les monter**, de sorte que Lambda pourra lire et √©crire √† partir de celui-ci.

### Couches Lambda

Une _couche_ Lambda est une archive de fichier .zip qui **peut contenir du code suppl√©mentaire** ou d'autres contenus. Une couche peut contenir des biblioth√®ques, un [runtime personnalis√©](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), des donn√©es ou des fichiers de configuration.

Il est possible d'inclure jusqu'√† **cinq couches par fonction**. Lorsque vous incluez une couche dans une fonction, les **contenus sont extraits dans le r√©pertoire `/opt`** de l'environnement d'ex√©cution.

Par **d√©faut**, les **couches** que vous cr√©ez sont **priv√©es** pour votre compte AWS. Vous pouvez choisir de **partager** une couche avec d'autres comptes ou de la **rendre publique**. Si vos fonctions consomment une couche publi√©e par un compte diff√©rent, vos fonctions peuvent **continuer √† utiliser la version de la couche apr√®s sa suppression, ou apr√®s la r√©vocation de votre autorisation d'acc√®s √† la couche**. Cependant, vous ne pouvez pas cr√©er une nouvelle fonction ou mettre √† jour des fonctions en utilisant une version de couche supprim√©e.

Les fonctions d√©ploy√©es en tant qu'image de conteneur n'utilisent pas de couches. Au lieu de cela, vous emballez votre runtime pr√©f√©r√©, les biblioth√®ques et autres d√©pendances dans l'image de conteneur lors de la construction de l'image.

### Extensions Lambda

Les extensions Lambda vous permettent d'augmenter vos fonctions. Par exemple, vous pouvez utiliser des extensions pour int√©grer vos fonctions √† vos outils de surveillance, d'observabilit√©, de s√©curit√© et de gouvernance pr√©f√©r√©s. Vous ajoutez des extensions aux fonctions d'archives .zip en utilisant des [couches Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), ou les incluez dans l'image pour les [fonctions d√©ploy√©es en tant qu'images de conteneur](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* Les **extensions internes** s'ex√©cutent en tant que **partie** du **processus d'ex√©cution**, **dans le processus** avec votre code. Elles vous permettent de modifier le **d√©marrage du processus d'ex√©cution** √† l'aide de variables d'environnement sp√©cifiques au langage et de scripts d'enveloppe. Les extensions internes permettent des cas d'utilisation tels que l'instrumentation automatique du code.
* Les **extensions externes** vous permettent d'**ex√©cuter des processus distincts** du runtime, mais toujours dans le **m√™me environnement d'ex√©cution** que la fonction Lambda. Les extensions externes peuvent **d√©marrer avant le processus d'ex√©cution** et peuvent **continuer apr√®s l'arr√™t du runtime**. Les extensions externes permettent des cas d'utilisation tels que la r√©cup√©ration de secrets avant l'invocation, ou l'envoi de t√©l√©m√©trie vers une destination personnalis√©e en dehors de l'invocation de la fonction. Ces extensions s'ex√©cutent en tant que processus compagnons des fonctions Lambda.
### √ânum√©ration

During the enumeration phase, the goal is to gather as much information as possible about the AWS Lambda service and its configurations. This information will help in identifying potential vulnerabilities and weaknesses that can be exploited during the penetration testing process.

#### Enumerating AWS Lambda Functions

To enumerate AWS Lambda functions, the following techniques can be used:

1. **AWS Management Console**: The AWS Management Console provides a graphical interface to view and manage Lambda functions. It allows you to list all the functions in your account and view their configurations.

2. **AWS CLI**: The AWS Command Line Interface (CLI) can be used to interact with AWS services, including Lambda. The `list-functions` command can be used to list all the Lambda functions in your account.

3. **AWS SDKs**: AWS Software Development Kits (SDKs) provide programming interfaces to interact with AWS services. SDKs are available for various programming languages, such as Python, Java, and Node.js. Using the SDKs, you can programmatically list Lambda functions and retrieve their configurations.

4. **AWS Lambda API**: The AWS Lambda API allows direct interaction with the Lambda service. The `ListFunctions` API call can be used to list all the Lambda functions in your account.

#### Enumerating Lambda Function Configurations

Once the Lambda functions have been enumerated, the next step is to gather information about their configurations. This includes:

1. **Function Name**: The name of the Lambda function.

2. **Runtime**: The programming language or runtime environment used by the function.

3. **Handler**: The entry point for the function.

4. **Memory**: The amount of memory allocated to the function.

5. **Timeout**: The maximum execution time for the function.

6. **Environment Variables**: Any environment variables set for the function.

7. **Permissions**: The IAM roles and policies associated with the function.

8. **Triggers**: The event sources that trigger the function.

By gathering this information, you can gain a better understanding of how the Lambda functions are configured and identify any potential security issues or misconfigurations that may exist.

#### Enumerating Lambda Function Dependencies

In addition to gathering information about the Lambda functions and their configurations, it is also important to identify any dependencies that the functions may have. This includes:

1. **AWS Services**: Lambda functions can interact with other AWS services, such as S3, DynamoDB, or RDS. Identifying these dependencies can help in understanding the overall architecture and potential attack surface.

2. **External APIs**: Lambda functions may make calls to external APIs or services. Identifying these dependencies can help in understanding the data flow and potential security risks.

By enumerating the dependencies of the Lambda functions, you can gain a better understanding of the overall system and identify potential security vulnerabilities or data leakage risks.
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY" --query 'Code.Location' --profile uploadcreds
wget -O lambda-function.zip url-from-previous-query

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Appeler une fonction lambda

#### Manuellement
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Via URL expos√©e

If an AWS Lambda function is accessible via a public URL, it can be enumerated by an attacker. The attacker can use various techniques to gather information about the function and its configuration.

Si une fonction AWS Lambda est accessible via une URL publique, elle peut √™tre √©num√©r√©e par un attaquant. L'attaquant peut utiliser diff√©rentes techniques pour collecter des informations sur la fonction et sa configuration.

One technique is to send HTTP requests to the function's URL with different parameters and observe the responses. This can help identify the function's behavior and potential vulnerabilities.

Une technique consiste √† envoyer des requ√™tes HTTP √† l'URL de la fonction avec diff√©rents param√®tres et √† observer les r√©ponses. Cela peut aider √† identifier le comportement de la fonction et les vuln√©rabilit√©s potentielles.

Another technique is to analyze the function's source code, if it is available. This can provide insights into the logic and potential security flaws in the code.

Une autre technique consiste √† analyser le code source de la fonction, s'il est disponible. Cela peut fournir des informations sur la logique et les √©ventuelles failles de s√©curit√© dans le code.

Additionally, an attacker can try to access sensitive information stored in environment variables or configuration files used by the Lambda function.

De plus, un attaquant peut essayer d'acc√©der √† des informations sensibles stock√©es dans des variables d'environnement ou des fichiers de configuration utilis√©s par la fonction Lambda.

It is important to ensure that AWS Lambda functions are not exposed to the public unless necessary, and that proper security measures are in place to protect them.

Il est important de s'assurer que les fonctions AWS Lambda ne sont pas expos√©es au public sauf si cela est n√©cessaire, et de mettre en place les mesures de s√©curit√© appropri√©es pour les prot√©ger.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Appeler une fonction Lambda via une URL

Maintenant, il est temps de d√©couvrir les √©ventuelles fonctions Lambda √† ex√©cuter :
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

Une fonction lambda appel√©e "Level6" est disponible. Voyons comment l'appeler :
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
Maintenant que vous connaissez le nom et l'ID, vous pouvez obtenir le nom :
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

Et enfin, appelez la fonction en acc√©dant (remarquez que l'ID, le nom et le nom de la fonction apparaissent dans l'URL) : [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Autres d√©clencheurs

Il existe de nombreuses autres sources qui peuvent d√©clencher une fonction lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Privil√®ge d'escalade

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations Lambda pour escalader les privil√®ges** :

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Acc√®s non authentifi√©

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post-exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Persistance

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## R√©f√©rences

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
