# AWS - Enumeración de Lambda

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Lambda

Amazon Web Services (AWS) Lambda es un servicio de cómputo que le permite **ejecutar código sin aprovisionar ni administrar servidores**. Lambda **administra automáticamente los recursos necesarios** para ejecutar su código y proporciona funciones de alta disponibilidad, escalabilidad y seguridad. Con Lambda, **solo paga por el tiempo de cómputo que consume**, y no hay costos iniciales ni compromisos a largo plazo.

Para llamar a una lambda es posible llamarla **tan frecuentemente como se desee** (con Cloudwatch), **exponer** un punto final de **URL** y llamarla, llamarla a través de **API Gateway** o incluso basado en **eventos** como **cambios** en los datos en un cubo **S3** o actualizaciones a una tabla **DynamoDB**.

El **código** de una lambda se almacena en **`/var/task`**.

### Pesos de Alias de Lambda

Una Lambda puede tener **varias versiones**.\
Y puede tener **más de 1** versión expuesta a través de **alias**. Los **pesos** de **cada** una de las **versiones** expuestas dentro de un alias decidirán **qué alias recibe la invocación** (puede ser 90%-10% por ejemplo).\
Si el código de **uno** de los alias es **vulnerable** se pueden enviar **solicitudes hasta que la versión vulnerable** reciba el exploit.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Políticas de Recursos

Las políticas de recursos de Lambda permiten **dar acceso a otros servicios/cuentas para invocar** la lambda por ejemplo.\
Por ejemplo, esta es la política para permitir que **cualquiera acceda a una lambda expuesta a través de una URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

O esto para permitir que un API Gateway lo invoque:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Proxies de Base de Datos de Lambda

Cuando hay **cientos** de **solicitudes lambda concurrentes**, si cada una de ellas necesita **conectar y cerrar una conexión a una base de datos**, simplemente no funcionará (las lambdas son sin estado, no pueden mantener conexiones abiertas).\
Entonces, si sus **funciones Lambda interactúan con RDS Proxy en lugar** de su instancia de base de datos. Maneja la agrupación de conexiones necesaria para escalar muchas conexiones simultáneas creadas por funciones Lambda concurrentes. Esto permite que sus aplicaciones Lambda reutilicen conexiones existentes, en lugar de crear nuevas conexiones para cada invocación de función.

### Sistemas de archivos EFS de Lambda

Para preservar e incluso compartir datos, **las Lambdas pueden acceder a EFS y montarlos**, por lo que Lambda podrá leer y escribir desde él.

### Capas de Lambda

Una _capa_ de Lambda es un archivo .zip que **puede contener código adicional** u otro contenido. Una capa puede contener bibliotecas, un [tiempo de ejecución personalizado](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), datos o archivos de configuración.

Es posible incluir hasta **cinco capas por función**. Cuando incluye una capa en una función, los **contenidos se extraen al directorio `/opt`** en el entorno de ejecución.

Por **defecto**, las **capas** que creas son **privadas** para tu cuenta de AWS. Puede elegir **compartir** una capa con otras cuentas o **hacer** la capa **pública**. Si sus funciones consumen una capa que publicó una cuenta diferente, sus funciones pueden **seguir usando la versión de la capa después de que se haya eliminado, o después de que se haya revocado su permiso para acceder a la capa**. Sin embargo, no puede crear una nueva función o actualizar funciones utilizando una versión de capa eliminada.

Las funciones implementadas como una imagen de contenedor no usan capas. En su lugar, empaqueta su tiempo de ejecución preferido, bibliotecas y otras dependencias en la imagen del contenedor cuando construye la imagen.

### Extensiones de Lambda

Las extensiones de Lambda le permiten aumentar sus funciones. Por ejemplo, puede usar extensiones para integrar sus funciones con sus herramientas de monitoreo, observabilidad, seguridad y gobierno preferidas. Agrega extensiones a los archivos .zip de las funciones usando [capas de Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), o inclúyelos en la imagen para [funciones implementadas como imágenes de contenedor](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* Las **extensiones internas** se ejecutan como **parte** del proceso de **tiempo de ejecución**, **en proceso** con su código. Le permiten modificar el **inicio del proceso de tiempo de ejecución** utilizando variables de entorno específicas del lenguaje y scripts de envoltura. Las extensiones internas permiten casos de uso como la instrumentación automática de código.
* Las **extensiones externas** le permiten **ejecutar procesos separados** del tiempo de ejecución pero aún dentro del **mismo entorno de ejecución** que la función Lambda. Las extensiones externas pueden **iniciarse antes del proceso de tiempo de ejecución** y pueden **continuar después de que el tiempo de ejecución** se apague. Las extensiones externas permiten casos de uso como la obtención de secretos antes de la invocación o el envío de telemetría a un destino personalizado fuera de la invocación de la función. Estas extensiones se ejecutan como procesos complementarios a las funciones Lambda.

### Enumeración

```bash
aws lambda get-account-settings
#### Llamar a una función Lambda a través de una URL

Ahora es el momento de encontrar posibles funciones lambda para ejecutar:

```
aws --region us-west-2 --profile level6 lambda list-functions
```

![](<../../../.gitbook/assets/image (21).png>)

Hay una función lambda llamada "Level6" disponible. Averigüemos cómo llamarla:

```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```

![](<../../../.gitbook/assets/image (69).png>)

Ahora que conoces el nombre y el ID, puedes obtener el nombre:

```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```

![](<../../../.gitbook/assets/image (20).png>)

Y finalmente llama a la función accediendo (nota que el ID, el nombre y el nombre de la función aparecen en la URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Otros disparadores

Hay muchas otras fuentes que pueden activar una lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Privesc

En la siguiente página puedes comprobar cómo **abusar de los permisos de Lambda para escalar privilegios**:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Acceso no autenticado

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post Explotación

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>