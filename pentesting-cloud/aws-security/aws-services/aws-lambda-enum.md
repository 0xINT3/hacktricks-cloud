# AWS - Lambda 枚举

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧**。

</details>

## Lambda

Amazon Web Services (AWS) Lambda 是一种计算服务，允许您在不需要预配或管理服务器的情况下运行代码。Lambda **自动管理运行代码所需的资源**，并提供高可用性、扩展性和安全性功能。使用 Lambda，您只需支付您消耗的计算时间，没有预付费用或长期承诺。

要调用 Lambda，可以使用 Cloudwatch 频繁调用它，公开一个 URL 端点并调用它，通过 API Gateway 调用它，甚至基于事件（例如对 S3 存储桶中的数据进行更改或对 DynamoDB 表进行更新）调用它。

Lambda 的代码存储在 `/var/task` 中。

### Lambda 别名权重

Lambda 可以有**多个版本**。\
它可以通过**别名**公开**多个版本**。在别名中公开的每个版本的**权重**将决定**哪个别名接收调用**（例如可以是 90%-10%）。\
如果**一个别名的代码存在漏洞**，您可以发送请求，直到漏洞版本接收到攻击。

![](<../../../.gitbook/assets/image (16) (1).png>)

### 资源策略

Lambda 资源策略允许**其他服务/帐户调用**该 Lambda。\
例如，以下是允许**任何人通过 URL 访问 Lambda** 的策略：

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

或者允许 API Gateway 调用它的策略：

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda 数据库代理

当有**数百个并发 Lambda 请求**时，如果每个请求都需要**连接和关闭数据库连接**，这是行不通的（Lambda 是无状态的，无法保持连接打开）。\
因此，如果您的 Lambda 函数与 RDS 代理而不是数据库实例进行交互。它处理了由并发 Lambda 函数创建的许多同时连接所需的连接池。这使得 Lambda 应用程序能够**重用现有连接**，而不是为每个函数调用创建新连接。

### Lambda EFS 文件系统

为了保留甚至共享数据，**Lambda 可以访问 EFS 并挂载它们**，因此 Lambda 将能够从中读取和写入。

### Lambda 层

Lambda _层_是一个 .zip 文件归档，**可以包含附加代码**或其他内容。层可以包含库、[自定义运行时](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)、数据或配置文件。

每个函数可以包含多达**五个层**。当您在函数中包含一个层时，**内容将被提取到执行环境中的 `/opt`** 目录中。

默认情况下，您创建的层对您的 AWS 帐户是**私有的**。您可以选择与其他帐户**共享**层，或将层**公开**。如果您的函数使用了其他帐户发布的层，即使在删除层版本或撤销访问层的权限后，您的函数也可以**继续使用该层版本**。但是，您无法创建新函数或使用已删除的层版本更新函数。

作为容器映像部署的函数不使用层。相反，您在构建映像时将首选的运行时、库和其他依赖项打包到容器映像中。

### Lambda 扩展

Lambda 扩展使您能够增强函数功能。例如，您可以使用扩展将函数与首选的监视、可观察性、安全性和治理工具集成。您可以使用[Lambda 层](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)将扩展添加到 .zip 归档函数中，或者在[作为容器映像部署的函数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)中将它们包含在映像中。

* **内部扩展**作为**运行时**进程的**一部分**运行，与您的代码**内部**运行。它们允许您使用特定于语言的环境变量和包装脚本修改运行时进程的启动。内部扩展支持自动注入代码等用例。
* **外部扩展**允许您在与 Lambda 函数**相同的执行环境**中**运行独立进程**。外部扩展可以在运行时进程之前启动，并且可以在运行时关闭后继续运行。外部扩展支持在调用之前获取密钥或将遥测发送到函数调用之外的自定义目标等用例。这些扩展作为 Lambda 函数的伴随进程运行。
### 枚举

Enumeration is the process of gathering information about a target system or network. It involves identifying and cataloging various resources, services, and configurations that are accessible or exposed. Enumeration is an essential step in the penetration testing process as it helps in understanding the target system's architecture and potential vulnerabilities.

枚举是收集有关目标系统或网络的信息的过程。它涉及识别和编目可访问或公开的各种资源、服务和配置。枚举是渗透测试过程中的一个重要步骤，它有助于了解目标系统的架构和潜在漏洞。

During enumeration, a penetration tester uses various techniques and tools to gather information. This can include scanning for open ports, identifying running services, enumerating user accounts, and discovering network shares. The goal is to gather as much information as possible to aid in the subsequent stages of the penetration testing process.

在枚举过程中，渗透测试人员使用各种技术和工具来收集信息。这可以包括扫描开放端口、识别运行的服务、枚举用户账户和发现网络共享。目标是尽可能收集更多的信息，以帮助后续的渗透测试过程。

Enumeration can be performed manually or automated using specialized tools. Manual enumeration involves using command-line tools and scripts to gather information, while automated enumeration utilizes tools that automate the process, such as network scanners and vulnerability scanners.

枚举可以手动执行，也可以使用专门的工具自动化。手动枚举涉及使用命令行工具和脚本来收集信息，而自动枚举利用自动化工具，如网络扫描器和漏洞扫描器，来完成这个过程。

It is important to note that enumeration should be performed with caution and within the legal boundaries of the engagement. Unauthorized enumeration can be considered as an attack and may lead to legal consequences.

需要注意的是，枚举应该谨慎进行，并在合法的范围内进行。未经授权的枚举可能被视为攻击，并可能导致法律后果。
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### 调用 Lambda

#### 手动方式
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### 通过暴露的URL

If an AWS Lambda function is accessible via a public URL, it can be enumerated by an attacker. The attacker can use various techniques to discover information about the function, such as its name, version, and configuration.

如果一个AWS Lambda函数可以通过公共URL访问，攻击者可以通过枚举来获取信息。攻击者可以使用各种技术来发现函数的名称、版本和配置等信息。

One technique is to use a tool like `awscli` to list all the Lambda functions in the AWS account. The attacker can then try to access each function's URL to see if it is publicly accessible.

其中一种技术是使用`awscli`等工具列出AWS账户中的所有Lambda函数。然后，攻击者可以尝试访问每个函数的URL，以查看是否可以公开访问。

Another technique is to use a tool like `curl` to send HTTP requests to the function's URL with different parameters and observe the responses. This can help the attacker discover any sensitive information that the function may leak in its responses.

另一种技术是使用`curl`等工具向函数的URL发送带有不同参数的HTTP请求，并观察响应。这可以帮助攻击者发现函数在响应中可能泄露的任何敏感信息。

It is important to ensure that AWS Lambda functions are not exposed to the public unless necessary. Access controls should be properly configured to restrict access to authorized users or resources.

确保AWS Lambda函数不会公开暴露，除非有必要。应该正确配置访问控制，以限制对授权用户或资源的访问。
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### 通过URL调用Lambda函数

现在是时候找出可能执行的Lambda函数了：
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

有一个名为"Level6"的Lambda函数可用。让我们找出如何调用它：
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
现在，你已经知道了名称和ID，你可以获取名称：
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

最后调用函数访问（注意URL中的ID、名称和函数名称）：[https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### 其他触发器

还有很多其他可以触发Lambda的来源

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### 提权

在下一页中，您可以查看如何滥用Lambda权限以提升特权：

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### 未经身份验证的访问

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### 后渗透

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### 持久性

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## 参考资料

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
