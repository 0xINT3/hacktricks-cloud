# AWS - Lambda Enum

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Lambda

Amazon Web Services (AWS) Lambda jest opisany jako **usługa obliczeniowa**, która umożliwia wykonywanie kodu bez konieczności dostarczania lub zarządzania serwerem. Charakteryzuje się zdolnością do **automatycznego zarządzania przydziałem zasobów** potrzebnych do wykonania kodu, zapewniając funkcje takie jak wysoka dostępność, skalowalność i bezpieczeństwo. Istotnym aspektem Lambdy jest jej model cenowy, w którym **opłaty są pobierane wyłącznie za wykorzystany czas obliczeniowy**, eliminując konieczność początkowych inwestycji lub długoterminowych zobowiązań.

Aby wywołać lambdę, można ją wywoływać **tak często, jak chcesz** (za pomocą Cloudwatch), **udostępnić** punkt **końcowy URL** i wywołać go, wywołać go za pomocą **API Gateway** lub nawet na podstawie **zdarzeń**, takich jak **zmiany** w danych w **wiadrze S3** lub aktualizacje tabeli **DynamoDB**.

**Kod** lambdy jest przechowywany w **`/var/task`**.

### Wagi aliasów Lambdy

Lambda może mieć **kilka wersji**.\
I może mieć **więcej niż 1** wersję udostępnioną za pomocą **aliasów**. **Wagi** każdej z **wersji** udostępnionych wewnątrz aliasu decydują, **który alias otrzymuje wywołanie** (może to być na przykład 90%-10%).\
Jeśli kod **jednego** z aliasów jest **podatny**, można wysyłać **żądania, aż podatna** wersja otrzyma wykorzystanie.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Polityki zasobów Lambdy

Polityki zasobów Lambdy pozwalają na **udzielenie dostępu innym usługom/kontom do wywoływania** lambdy, na przykład.\
Na przykład, oto polityka, która umożliwia **dostęp każdemu do lambdy udostępnionej za pomocą URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Lub to, aby umożliwić wywołanie go przez bramkę API:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Proksy bazy danych Lambdy

Gdy występuje **setki równoczesnych żądań lambdy**, jeśli każde z nich musi **nawiązać i zamknąć połączenie do bazy danych**, to po prostu nie zadziała (lambdy są bezstanowe, nie mogą utrzymywać otwartych połączeń).\
W takim przypadku, jeśli twoje **funkcje Lambdy współpracują z RDS Proxy**, zamiast z instancją bazy danych. Zarządza on pulą połączeń niezbędnych do skalowania wielu jednoczesnych połączeń tworzonych przez równoczesne funkcje Lambdy. Pozwala to aplikacjom Lambdy **ponownie używać istniejących połączeń**, zamiast tworzyć nowe połączenia dla każdego wywołania funkcji.

### Systemy plików EFS Lambdy

Aby zachować i nawet udostępniać dane, **Lambdy mogą uzyskiwać dostęp do EFS i montować je**, dzięki czemu Lambda będzie mogła z niego czytać i do niego zapisywać.

### Warstwy Lambdy

Warstwa Lambdy to plik archiwum .zip, który **może zawierać dodatkowy kod** lub inne treści. Warstwa może zawierać biblioteki, [niestandardowy runtime](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), dane lub pliki konfiguracyjne.

Można dołączyć do **pięciu warstw na funkcję**. Gdy dołączasz warstwę do funkcji, **zawartość jest wypakowywana do katalogu `/opt`** w środowisku wykonawczym.

Domyślnie **warstwy**, które tworzysz, są **prywatne** dla twojego konta AWS. Możesz wybrać, czy **udostępniać** warstwę innym kontom czy **publicznie**. Jeśli twoje funkcje korzystają z warstwy opublikowanej przez inne konto, twoje funkcje mogą **nadal korzystać z wersji warstwy po jej usunięciu lub po wycofaniu uprawnienia do dostępu do warstwy**. Nie można jednak tworzyć nowej funkcji ani aktualizować funkcji za pomocą usuniętej wersji warstwy.

Funkcje wdrażane jako obraz kontenera nie korzystają z warstw. Zamiast tego pakujesz preferowany runtime, biblioteki i inne zależności do obrazu kontenera podczas budowania obrazu.

### Rozszerzenia Lambdy

Rozszerzenia Lambdy wzbogacają funkcje poprzez integrację z różnymi narzędziami do **monitorowania, obserwacji, zabezpieczeń i zarządzania**. Te rozszerzenia, dodawane za pomocą [.zip archiwów przy użyciu warstw Lambdy](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) lub dołączane w [wdrażaniu obrazów kontenerowych](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), działają w dwóch trybach: **wewnętrznym** i **zewnętrznym**.

* **Wewnętrzne rozszerzenia** łączą się z procesem uruchamiania, manipulując jego uruchamianiem za pomocą **zmiennych środowiskowych specyficznych dla języka** i **skryptów opakowujących**. Ta dostosowanie dotyczy różnych runtime'ów, w tym **Java Correto 8 i 11, Node.js 10 i 12 oraz .NET Core 3.1**.

* **Zewnętrzne rozszerzenia** działają jako osobne procesy, utrzymując zgodność z cyklem życia funkcji Lambdy. Są one kompatybilne z różnymi runtime'ami, takimi jak **Node.js 10 i 12, Python 3.7 i 3.8, Ruby 2.5 i 2.7, Java Corretto 8 i 11,
### Wyliczanie

#### Wyliczanie funkcji AWS Lambda

Aby rozpocząć proces wyliczania funkcji AWS Lambda, możemy skorzystać z różnych technik i narzędzi. Poniżej przedstawiam kilka przykładów:

##### 1. Wykorzystanie AWS Management Console

Możemy zalogować się do konsoli AWS Management Console i przejść do sekcji AWS Lambda. Tam będziemy mieli dostęp do listy wszystkich funkcji Lambda w naszym koncie.

##### 2. Wykorzystanie AWS CLI

Możemy użyć AWS CLI, aby wylistować wszystkie funkcje Lambda w naszym koncie. Możemy użyć polecenia `aws lambda list-functions` w terminalu, aby uzyskać listę funkcji.

##### 3. Wykorzystanie SDK AWS

Możemy napisać skrypt przy użyciu SDK AWS, który wylistuje wszystkie funkcje Lambda w naszym koncie. Możemy skorzystać z dostępnych SDK w różnych językach programowania, takich jak Python, Java, Node.js itp.

##### 4. Wykorzystanie narzędzi inwigilacyjnych

Istnieją również narzędzia inwigilacyjne, takie jak AWS Recon, które mogą pomóc w wyliczaniu funkcji AWS Lambda. Te narzędzia automatyzują proces wyliczania i dostarczają dodatkowych informacji, takich jak wersje funkcji, polityki dostępu itp.

Po wyliczeniu funkcji AWS Lambda, możemy przejść do kolejnych etapów testowania penetracyjnego, takich jak analiza podatności, testowanie zabezpieczeń itp.
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
#### Wywołaj funkcję lambda

##### Ręcznie

```bash
aws lambda invoke --function-name <function_name> --payload <payload> <output_file>
```

##### Przykład

```bash
aws lambda invoke --function-name my-function --payload file://input.json output.txt
```

#### Automatycznie

```bash
aws lambda invoke --function-name <function_name> --payload <payload> --cli-binary-format raw-in-base64-out <output_file>
```

##### Przykład

```bash
aws lambda invoke --function-name my-function --payload fileb://input.bin --cli-binary-format raw-in-base64-out output.txt
```

#### Zdalne wywołanie funkcji lambda

```bash
aws lambda invoke --function-name <function_name> --payload <payload> --cli-binary-format raw-in-base64-out --invocation-type Event --region <region> --endpoint-url <endpoint_url>
```

##### Przykład

```bash
aws lambda invoke --function-name my-function --payload fileb://input.bin --cli-binary-format raw-in-base64-out --invocation-type Event --region us-west-2 --endpoint-url https://lambda.us-west-2.amazonaws.com output.txt
```

#### Wywołanie funkcji lambda z wykorzystaniem AWS CLI v2

```bash
aws lambda invoke --function-name <function_name> --payload <payload> --cli-binary-format raw-in-base64-out --cli-read-timeout 0 <output_file>
```

##### Przykład

```bash
aws lambda invoke --function-name my-function --payload fileb://input.bin --cli-binary-format raw-in-base64-out --cli-read-timeout 0 output.txt
```
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Przez odkryty URL

Jeśli funkcja AWS Lambda jest publicznie dostępna i ma odkryty URL, istnieje możliwość, że można ją wykorzystać do uzyskania dostępu do wrażliwych danych lub wykonania nieautoryzowanych operacji. Aby to zrobić, należy przeprowadzić następujące kroki:

1. Zidentyfikuj funkcję AWS Lambda, która ma publicznie dostępny URL.
2. Sprawdź, czy funkcja akceptuje dane wejściowe z zewnątrz.
3. Wykorzystaj funkcję, aby uzyskać dostęp do wrażliwych danych lub wykonać nieautoryzowane operacje.

Ten scenariusz jest szczególnie niebezpieczny, ponieważ funkcje AWS Lambda są często używane do przetwarzania danych wrażliwych. Dlatego ważne jest, aby upewnić się, że funkcje są odpowiednio zabezpieczone i nie mają publicznie dostępnego URL.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Wywołaj funkcję Lambda za pomocą adresu URL

Nadszedł czas, aby dowiedzieć się, jakie funkcje Lambda można wywołać:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

Dostępna jest funkcja lambda o nazwie "Level6". Sprawdźmy, jak ją wywołać:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
Teraz, gdy znasz nazwę i identyfikator, możesz uzyskać nazwę:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

I na koniec wywołaj funkcję, uzyskując dostęp (zauważ, że ID, Nazwa i nazwa funkcji pojawiają się w adresie URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Inne wyzwalacze

Istnieje wiele innych źródeł, które mogą wywołać funkcję lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Przywileje

Na następnej stronie możesz sprawdzić, jak **wykorzystać uprawnienia Lambda do eskalacji uprawnień**:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Nieuwierzytelniony dostęp

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Trwałość

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Odwołania

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
