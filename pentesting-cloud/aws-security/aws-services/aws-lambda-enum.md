# AWS - Enumeración de Lambda

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Lambda

Amazon Web Services (AWS) Lambda es un servicio de cómputo que te permite **ejecutar código sin aprovisionar ni administrar servidores**. Lambda **administra automáticamente los recursos necesarios** para ejecutar tu código y proporciona funciones de alta disponibilidad, escalabilidad y seguridad. Con Lambda, **solo pagas por el tiempo de cómputo que consumes**, y no hay costos iniciales ni compromisos a largo plazo.

Para llamar a una lambda, es posible llamarla tan **frecuentemente como desees** (con Cloudwatch), **exponer** un **punto de conexión de URL** y llamarla, llamarla a través de **API Gateway** o incluso basado en **eventos** como **cambios** en los datos de un cubo **S3** o actualizaciones en una tabla **DynamoDB**.

El **código** de una lambda se almacena en **`/var/task`**.

### Pesos de Alias de Lambda

Una Lambda puede tener **varias versiones**.\
Y puede tener **más de 1** versión expuesta a través de **alias**. Los **pesos** de **cada una** de las **versiones** expuestas dentro de un alias decidirán **qué alias recibe la invocación** (puede ser 90%-10% por ejemplo).\
Si el código de **uno** de los alias es **vulnerable**, puedes enviar **solicitudes hasta que la versión vulnerable** reciba el exploit.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Políticas de Recursos de Lambda

Las políticas de recursos de Lambda permiten **dar acceso a otros servicios/cuentas para invocar** la lambda, por ejemplo.\
Por ejemplo, esta es la política para permitir que **cualquiera acceda a una lambda expuesta a través de una URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

O esto para permitir que un API Gateway lo invoque:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Proxies de Base de Datos de Lambda

Cuando hay **cientos** de **solicitudes concurrentes de lambda**, si cada una de ellas necesita **conectarse y cerrar una conexión a una base de datos**, simplemente no funcionará (las lambdas no tienen estado, no pueden mantener conexiones abiertas).\
Entonces, si tus **funciones Lambda interactúan con RDS Proxy en lugar** de tu instancia de base de datos, se encarga del agrupamiento de conexiones necesario para escalar muchas conexiones simultáneas creadas por funciones Lambda concurrentes. Esto permite que tus aplicaciones Lambda **reutilicen conexiones existentes**, en lugar de crear nuevas conexiones para cada invocación de función.

### Sistemas de Archivos EFS de Lambda

Para preservar e incluso compartir datos, **las Lambdas pueden acceder a EFS y montarlos**, de modo que Lambda pueda leer y escribir en ellos.

### Capas de Lambda

Una _capa_ de Lambda es un archivo .zip que **puede contener código adicional** u otro contenido. Una capa puede contener bibliotecas, un [tiempo de ejecución personalizado](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), datos o archivos de configuración.

Es posible incluir hasta **cinco capas por función**. Cuando incluyes una capa en una función, los **contenidos se extraen al directorio `/opt`** en el entorno de ejecución.

Por **defecto**, las **capas** que creas son **privadas** para tu cuenta de AWS. Puedes elegir **compartir** una capa con otras cuentas o **hacer** la capa **pública**. Si tus funciones consumen una capa que publicó una cuenta diferente, tus funciones pueden **seguir utilizando la versión de la capa después de que se haya eliminado, o después de que se haya revocado tu permiso para acceder a la capa**. Sin embargo, no puedes crear una nueva función ni actualizar funciones utilizando una versión de capa eliminada.

Las funciones implementadas como una imagen de contenedor no utilizan capas. En su lugar, empaquetas tu tiempo de ejecución preferido, bibliotecas y otras dependencias en la imagen del contenedor cuando construyes la imagen.

### Extensiones de Lambda

Las extensiones de Lambda te permiten mejorar tus funciones. Por ejemplo, puedes usar extensiones para integrar tus funciones con tus herramientas de monitoreo, observabilidad, seguridad y gobierno preferidas. Puedes agregar extensiones a funciones de archivos .zip utilizando [capas de Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), o incluirlas en la imagen para [funciones implementadas como imágenes de contenedor](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* Las **extensiones internas** se ejecutan como **parte** del **proceso de tiempo de ejecución**, **en el proceso** con tu código. Te permiten modificar el **inicio del proceso de tiempo de ejecución** utilizando variables de entorno específicas del lenguaje y scripts de envoltura. Las extensiones internas permiten casos de uso como la instrumentación automática de código.
* Las **extensiones externas** te permiten **ejecutar procesos separados** del tiempo de ejecución pero aún dentro del **mismo entorno de ejecución** que la función Lambda. Las extensiones externas pueden **iniciarse antes del proceso de tiempo de ejecución** y pueden **continuar después de que el tiempo de ejecución** se apague. Las extensiones externas permiten casos de uso como obtener secretos antes de la invocación o enviar telemetría a un destino personalizado fuera de la invocación de la función. Estas extensiones se ejecutan como procesos complementarios a las funciones Lambda.
### Enumeración

---

#### AWS Lambda

AWS Lambda es un servicio de computación sin servidor que permite ejecutar código sin aprovisionar ni administrar servidores. Es una excelente opción para ejecutar código en respuesta a eventos, como cambios en los datos almacenados en Amazon S3, actualizaciones en una tabla de base de datos de Amazon DynamoDB o solicitudes HTTP enviadas a través de Amazon API Gateway.

Durante una evaluación de seguridad en la nube, es importante realizar una enumeración exhaustiva de los servicios de AWS Lambda para identificar posibles vulnerabilidades y puntos débiles en la configuración.

---

#### Enumerating AWS Lambda Functions

La enumeración de las funciones de AWS Lambda es un paso crucial en el proceso de evaluación de seguridad. Aquí hay algunas técnicas que se pueden utilizar para enumerar las funciones de AWS Lambda:

##### 1. Enumeración manual

La enumeración manual implica buscar manualmente las funciones de AWS Lambda en la consola de administración de AWS o utilizando la CLI de AWS. Esto puede ser útil para obtener una visión general rápida de las funciones existentes.

##### 2. Enumeración de la API de AWS

La API de AWS proporciona métodos para enumerar las funciones de AWS Lambda. Estos métodos se pueden utilizar para automatizar la enumeración y obtener información detallada sobre cada función, como su nombre, ARN, tiempo de ejecución, tamaño de memoria y configuración de permisos.

##### 3. Enumeración de la consola de administración de AWS

La consola de administración de AWS proporciona una interfaz gráfica para enumerar y administrar las funciones de AWS Lambda. Puede ser útil explorar la consola de administración para descubrir funciones ocultas o configuraciones incorrectas.

##### 4. Enumeración de la CLI de AWS

La CLI de AWS ofrece comandos específicos para enumerar las funciones de AWS Lambda. Estos comandos se pueden utilizar para automatizar la enumeración y obtener información detallada sobre cada función.

---

#### Enumerating AWS Lambda Event Sources

Además de enumerar las funciones de AWS Lambda, también es importante enumerar las fuentes de eventos que desencadenan la ejecución de estas funciones. Aquí hay algunas técnicas que se pueden utilizar para enumerar las fuentes de eventos de AWS Lambda:

##### 1. Enumeración manual

Al igual que con la enumeración de las funciones de AWS Lambda, la enumeración manual puede ser útil para obtener una visión general rápida de las fuentes de eventos existentes. Esto implica buscar manualmente en la consola de administración de AWS o utilizando la CLI de AWS.

##### 2. Enumeración de la API de AWS

La API de AWS proporciona métodos para enumerar las fuentes de eventos de AWS Lambda. Estos métodos se pueden utilizar para automatizar la enumeración y obtener información detallada sobre cada fuente de eventos, como su tipo, configuración y estado.

##### 3. Enumeración de la consola de administración de AWS

La consola de administración de AWS también proporciona una interfaz gráfica para enumerar y administrar las fuentes de eventos de AWS Lambda. Explorar la consola de administración puede revelar fuentes de eventos ocultas o configuraciones incorrectas.

##### 4. Enumeración de la CLI de AWS

Al igual que con la enumeración de las funciones de AWS Lambda, la CLI de AWS ofrece comandos específicos para enumerar las fuentes de eventos de AWS Lambda. Estos comandos se pueden utilizar para automatizar la enumeración y obtener información detallada sobre cada fuente de eventos.
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY" --query 'Code.Location' --profile uploadcreds
wget -O lambda-function.zip url-from-previous-query

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Invocar una lambda

#### Manual
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### A través de URL expuesta

Cuando se realiza una enumeración de AWS Lambda, una técnica común es buscar URL expuestas que puedan revelar información sensible. Esto se debe a que las funciones de Lambda se pueden invocar a través de una URL única generada por AWS.

Para realizar esta enumeración, se pueden utilizar herramientas como `curl` o `wget` para enviar solicitudes HTTP GET a diferentes rutas de URL. Algunas rutas comunes a probar incluyen `/function-name`, `/function-name/index.handler` y `/function-name/index.js`.

Si se encuentra una URL expuesta, se puede obtener información valiosa, como el código fuente de la función Lambda, los parámetros de configuración y cualquier dato sensible que pueda estar presente en la función.

Es importante tener en cuenta que esta técnica solo funciona si la función Lambda se ha configurado para ser accesible a través de una URL pública. Por lo tanto, es recomendable revisar la configuración de seguridad de la función Lambda y asegurarse de que no se haya expuesto accidentalmente.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Llamar a una función Lambda a través de una URL

Ahora es el momento de descubrir las posibles funciones Lambda para ejecutar:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

Una función lambda llamada "Level6" está disponible. Vamos a averiguar cómo llamarla:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

Ahora que conoces el nombre y el ID, puedes obtener el Nombre:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

Y finalmente llama a la función accediendo (nota que el ID, Nombre y nombre de la función aparecen en la URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Otros Disparadores

Hay muchas otras fuentes que pueden activar una lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Escalada de Privilegios

En la siguiente página puedes verificar cómo **abusar de los permisos de Lambda para escalar privilegios**:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Acceso No Autenticado

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post Explotación

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Persistencia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Referencias

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
