# AWS - Enumerazione di Lambda

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>

## Lambda

Amazon Web Services (AWS) Lambda √® descritto come un **servizio di calcolo** che consente l'esecuzione del codice senza la necessit√† di fornire o gestire un server. Si caratterizza per la sua capacit√† di **gestire automaticamente l'allocazione delle risorse** necessarie per l'esecuzione del codice, garantendo funzionalit√† come l'alta disponibilit√†, la scalabilit√† e la sicurezza. Un aspetto significativo di Lambda √® il suo modello di pricing, in cui **i costi si basano esclusivamente sul tempo di calcolo utilizzato**, eliminando la necessit√† di investimenti iniziali o obblighi a lungo termine.

Per chiamare una lambda √® possibile chiamarla **frequentemente come si desidera** (con Cloudwatch), **esporre** un **endpoint URL** e chiamarla, chiamarla tramite **API Gateway** o anche in base a **eventi** come **modifiche** ai dati in un bucket **S3** o aggiornamenti di una tabella **DynamoDB**.

Il **codice** di una lambda √® memorizzato in **`/var/task`**.

### Pesi degli Alias di Lambda

Una Lambda pu√≤ avere **diverse versioni**.\
E pu√≤ avere **pi√π di 1** versione esposta tramite **alias**. I **pesi** di **ciascuna** delle **versioni** esposte all'interno di un alias decideranno **quale alias ricever√† l'invocazione** (pu√≤ essere ad esempio 90%-10%).\
Se il codice di **uno** degli alias √® **vulnerabile**, √® possibile inviare **richieste fino a quando la versione vulnerabile** riceve l'exploit.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Politiche delle risorse di Lambda

Le politiche delle risorse di Lambda consentono di **concedere l'accesso ad altri servizi/account per invocare** la lambda, ad esempio.\
Ad esempio, questa √® la politica per consentire a **chiunque di accedere a una lambda esposta tramite URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

O questa per consentire a un API Gateway di invocarla:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Proxy del database di Lambda

Quando ci sono **centinaia** di **richieste lambda simultanee**, se ognuna di esse deve **connettersi e chiudere una connessione a un database**, semplicemente non funzioner√† (le lambda sono stateless, non possono mantenere connessioni aperte).\
Quindi, se le tue **funzioni Lambda interagiscono con RDS Proxy invece** della tua istanza di database, gestisce il pooling delle connessioni necessario per scalare molte connessioni simultanee create da funzioni Lambda concorrenti. Ci√≤ consente alle tue applicazioni Lambda di **riutilizzare le connessioni esistenti**, anzich√© creare nuove connessioni per ogni invocazione di funzione.

### Filesystem EFS di Lambda

Per preservare e persino condividere dati, **le Lambda possono accedere a EFS e montarli**, in modo che Lambda possa leggere e scrivere da esso.

### Strati di Lambda

Uno _strato_ di Lambda √® un file .zip che **pu√≤ contenere codice aggiuntivo** o altro contenuto. Uno strato pu√≤ contenere librerie, un [runtime personalizzato](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), dati o file di configurazione.

√à possibile includere fino a **cinque strati per funzione**. Quando si include uno strato in una funzione, i **contenuti vengono estratti nella directory `/opt`** nell'ambiente di esecuzione.

Per **default**, gli **strati** che crei sono **privati** per il tuo account AWS. Puoi scegliere di **condividere** uno strato con altri account o di **rendere** lo strato **pubblico**. Se le tue funzioni consumano uno strato che un account diverso ha pubblicato, le tue funzioni possono **continuare a utilizzare la versione dello strato dopo che √® stata eliminata o dopo che il tuo permesso di accedere allo strato √® stato revocato**. Tuttavia, non puoi creare una nuova funzione o aggiornare funzioni utilizzando una versione di strato eliminata.

Le funzioni distribuite come immagine del contenitore non utilizzano gli strati. Invece, si imballa il runtime preferito, le librerie e le altre dipendenze nell'immagine del contenitore durante la creazione dell'immagine.

### Estensioni di Lambda

Le estensioni di Lambda migliorano le funzioni integrandosi con vari **strumenti di monitoraggio, osservabilit√†, sicurezza e governance**. Queste estensioni, aggiunte tramite [.zip archives usando gli strati di Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) o incluse in [deployments di immagini del contenitore](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), operano in due modalit√†: **interna** ed **esterna**.

* Le **estensioni interne** si fondono con il processo di runtime, manipolando il suo avvio utilizzando **variabili d'ambiente specifiche del linguaggio** e **script wrapper**. Questa personalizzazione si applica a una serie di runtime, tra cui **Java Correto 8 e 11, Node.js 10 e 12 e .NET Core 3.1**.

* Le **estensioni esterne** vengono eseguite come processi separati, mantenendo l'allineamento operativo con il ciclo di vita della funzione Lambda. Sono compatibili con vari runtime come **Node.js 10 e 12, Python 3.7 e 3.8, Ruby 2.5 e 2.7, Java Corretto 8 e 11, .NET Core 3.1** e **runtime personalizzati**.
### Enumerazione

#### AWS Lambda

AWS Lambda √® un servizio di calcolo serverless offerto da Amazon Web Services (AWS). Per effettuare una corretta enumerazione di AWS Lambda, √® possibile utilizzare diverse tecniche:

##### 1. Enumerazione delle funzioni Lambda

Per ottenere un elenco delle funzioni Lambda presenti in un account AWS, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS. √à anche possibile utilizzare strumenti di terze parti come AWS CLI o SDK per ottenere informazioni sulle funzioni Lambda.

##### 2. Enumerazione delle autorizzazioni

Le autorizzazioni delle funzioni Lambda determinano chi pu√≤ invocare le funzioni e quali risorse possono essere accedute. Per enumerare le autorizzazioni di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 3. Enumerazione delle variabili di ambiente

Le variabili di ambiente possono contenere informazioni sensibili come chiavi API o password. Per enumerare le variabili di ambiente di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 4. Enumerazione delle versioni e degli alias

AWS Lambda supporta la creazione di versioni e alias per le funzioni Lambda. Queste versioni e alias possono contenere codice o configurazioni diverse. Per enumerare le versioni e gli alias di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 5. Enumerazione delle metriche di monitoraggio

AWS Lambda offre diverse metriche di monitoraggio che forniscono informazioni sulle prestazioni delle funzioni Lambda. Per enumerare le metriche di monitoraggio di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 6. Enumerazione delle risorse correlate

Le funzioni Lambda possono essere associate ad altre risorse AWS come code SQS, bucket S3 o tabelle DynamoDB. Per enumerare le risorse correlate a una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 7. Enumerazione delle policy di sicurezza

Le funzioni Lambda possono avere policy di sicurezza associate che definiscono i permessi di accesso alle risorse AWS. Per enumerare le policy di sicurezza di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 8. Enumerazione delle configurazioni di rete

Le funzioni Lambda possono essere configurate per accedere a risorse di rete come VPC, subnet o gruppi di sicurezza. Per enumerare le configurazioni di rete di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 9. Enumerazione delle impostazioni di timeout e memoria

Le funzioni Lambda hanno impostazioni di timeout e memoria che determinano il tempo massimo di esecuzione e la quantit√† di memoria disponibile. Per enumerare le impostazioni di timeout e memoria di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 10. Enumerazione delle registrazioni di log

AWS Lambda registra automaticamente i log delle funzioni Lambda. Per enumerare le registrazioni di log di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 11. Enumerazione delle autorizzazioni IAM

Le funzioni Lambda possono richiedere autorizzazioni IAM per accedere ad altre risorse AWS. Per enumerare le autorizzazioni IAM di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 12. Enumerazione delle dipendenze

Le funzioni Lambda possono avere dipendenze esterne come librerie o pacchetti. Per enumerare le dipendenze di una funzione Lambda, √® possibile esaminare il codice sorgente o utilizzare strumenti di analisi statica.

##### 13. Enumerazione delle configurazioni di sicurezza

Le funzioni Lambda possono avere configurazioni di sicurezza come ruoli IAM o politiche di sicurezza. Per enumerare le configurazioni di sicurezza di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 14. Enumerazione delle configurazioni di gestione degli errori

Le funzioni Lambda possono essere configurate per gestire gli errori in modo specifico. Per enumerare le configurazioni di gestione degli errori di una funzione Lambda, √® possibile esaminare il codice sorgente o utilizzare strumenti di analisi statica.

##### 15. Enumerazione delle configurazioni di versionamento

Le funzioni Lambda possono essere configurate per il versionamento del codice. Per enumerare le configurazioni di versionamento di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 16. Enumerazione delle configurazioni di monitoraggio

Le funzioni Lambda possono essere configurate per il monitoraggio delle prestazioni. Per enumerare le configurazioni di monitoraggio di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 17. Enumerazione delle configurazioni di notifica

Le funzioni Lambda possono essere configurate per inviare notifiche in caso di errori o eventi specifici. Per enumerare le configurazioni di notifica di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 18. Enumerazione delle configurazioni di scalabilit√†

Le funzioni Lambda possono essere configurate per scalare automaticamente in base al carico di lavoro. Per enumerare le configurazioni di scalabilit√† di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 19. Enumerazione delle configurazioni di autoripristino

Le funzioni Lambda possono essere configurate per il ripristino automatico in caso di errori. Per enumerare le configurazioni di autoripristino di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.

##### 20. Enumerazione delle configurazioni di crittografia

Le funzioni Lambda possono essere configurate per la crittografia dei dati in transito o a riposo. Per enumerare le configurazioni di crittografia di una funzione Lambda, √® possibile utilizzare l'API di AWS Lambda o la console di gestione AWS.
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Richiamare una lambda

#### Manuale
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Attraverso URL esposti

Leakage of sensitive information can occur when AWS Lambda functions are accessed through exposed URLs. These URLs can be discovered through various means, such as code repositories, logs, or even by guessing common naming conventions.

To enumerate AWS Lambda functions through exposed URLs, you can use tools like `awscli` or `curl`. By sending HTTP requests to the discovered URLs, you can gather information about the functions, such as their names, ARNs (Amazon Resource Names), and other details.

Here is an example of how to enumerate AWS Lambda functions using `awscli`:

```plaintext
$ aws lambda list-functions --region <region>
```

Replace `<region>` with the appropriate AWS region.

By enumerating AWS Lambda functions through exposed URLs, you can gain valuable information that can be used for further exploitation or security assessment purposes.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Chiamare la funzione Lambda tramite URL

Ora √® il momento di scoprire le possibili funzioni Lambda da eseguire:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

√à disponibile una funzione lambda chiamata "Level6". Scopriamo come chiamarla:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
Ora che conosci il nome e l'ID, puoi ottenere il Nome:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

E infine chiama la funzione accedendo (nota che l'ID, il nome e il nome della funzione appaiono nell'URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Altri Trigger

Ci sono molte altre fonti che possono attivare una lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Privesc

Nella pagina seguente puoi verificare come **abusare delle autorizzazioni Lambda per ottenere privilegi elevati**:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Accesso non autenticato

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Persistenza

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Riferimenti

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos.**

</details>
