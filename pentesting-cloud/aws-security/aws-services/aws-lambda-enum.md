# AWS - Lambda Enum

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
* **ハッキングトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>

## Lambda

Amazon Web Services（AWS）Lambdaは、サーバーのプロビジョニングや管理の必要性なしにコードの実行を可能にする**コンピュートサービス**として説明されています。コードの実行に必要な**リソース割り当てを自動的に処理**し、高可用性、スケーラビリティ、セキュリティなどの機能を確保する能力で特徴付けられています。Lambdaの価格モデルの重要な側面は、**利用されるコンピュート時間に基づいて料金が請求**される点であり、初期投資や長期的な義務の必要性がなくなります。

Lambdaを呼び出すには、**Cloudwatch**を使用して**必要なだけ頻繁に呼び出す**ことができます。**URL**エンドポイントを**公開**して呼び出したり、**API Gateway**を介して呼び出したり、**S3**バケット内のデータの変更や**DynamoDB**テーブルの更新などの**イベント**に基づいて呼び出すこともできます。

Lambdaの**コード**は**`/var/task`**に保存されています。

### Lambdaエイリアスの重み

Lambdaには**複数のバージョン**が存在します。\
そして、**エイリアス**を介して**公開される複数のバージョン**を持つことができます。エイリアス内で公開される**各バージョンの重み**が、**どのエイリアスが呼び出しを受け取るかを決定**します（たとえば、90%-10%の場合があります）。\
**エイリアスの1つのコードが脆弱**である場合、脆弱なバージョンが攻撃を受けるまで**リクエストを送信**することができます。

![](<../../../.gitbook/assets/image (16) (1).png>)

### リソースポリシー

Lambdaリソースポリシーを使用すると、他のサービス/アカウントがLambdaを呼び出すためのアクセス権を与えることができます。\
たとえば、これは**URLを介して公開されたLambdaにアクセス権を与える**ポリシーです：

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

または、API Gatewayがそれを呼び出すことを許可するためのポリシー：

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambdaデータベースプロキシ

**数百の同時Lambdaリクエスト**がある場合、それぞれが**データベースに接続して接続を閉じる必要がある**と、それはうまくいかない（Lambdaはステートレスであり、接続を維持できません）。\
そのため、**Lambda関数がデータベースインスタンスの代わりにRDS Proxyとやり取り**する場合、同時に作成された多数の接続をスケーリングするために必要な接続プーリングを処理します。これにより、Lambdaアプリケーションは**既存の接続を再利用**でき、各関数呼び出しのたびに新しい接続を作成する必要がありません。

### Lambda EFSファイルシステム

データを保存したり共有したりするために、**LambdaはEFSにアクセスしてマウント**することができ、Lambdaはそこから読み取りや書き込みができます。

### Lambdaレイヤー

Lambdaの**レイヤー**は、追加のコードやその他のコンテンツを含む**.zipファイルアーカイブ**です。レイヤーにはライブラリ、[カスタムランタイム](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)、データ、または構成ファイルを含めることができます。

1つの関数に**最大5つのレイヤー**を含めることができます。レイヤーを関数に含めると、**内容が実行環境の`/opt`ディレクトリに展開**されます。

**デフォルト**では、作成した**レイヤー**はAWSアカウントに**プライベート**です。他のアカウントとレイヤーを**共有**するか、レイヤーを**公開**するかを選択できます。別のアカウントが公開したレイヤーを関数が消費する場合、関数は**削除された後もレイヤーバージョンを使用し続けることができます**。ただし、削除されたレイヤーバージョンを使用して新しい関数を作成したり、関数を更新したりすることはできません。

コンテナイメージとして展開された関数は、レイヤーを使用しません。代わりに、イメージをビルドする際に好みのランタイム、ライブラリ、およびその他の依存関係をコンテナイメージにパッケージ化します。

### Lambda拡張機能

Lambda拡張機能は、さまざまな**監視、可観測性、セキュリティ、ガバナンスツール**と統合することで、関数を強化します。これらの拡張機能は、Lambdaレイヤーを使用して[.zipアーカイブを追加](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)したり、[コンテナイメージ展開](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)に含めたりすることで追加され、**内部**および**外部**の2つのモードで動作します。

* **内部拡張機能**は、**言語固有の環境変数**と**ラッパースクリプト**を使用して、ランタイムプロセスと統合し、その起動を操作します。このカスタマイズは、**Java Correto 8および11、Node.js 10および12、.NET Core 3.1**などのランタイムに適用されます。

* **外部拡張機能**は、別のプロセスとして実行され、Lambda関数のライフサイクルと操作が整合されます。これらは、**Node.js 10および12、Python 3.7および3.8、Ruby 2.5および2.7、Java Corretto 8および11、.NET Core 3.1**、および**カスタムランタイム**などのさまざまなランタイムと互換性があります。

### 列挙
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### ラムダを呼び出す

#### 手動
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### 公開されたURLを介して
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### URLを介してLambda関数を呼び出す

これから実行可能なLambda関数を見つける時が来ました。
```
aws --region us-west-2 --profile level6 lambda list-functions
```
以下は、AWS Lambda関数「Level6」が利用可能です。どのように呼び出すかを見つけてみましょう：
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

これで、名前とIDがわかったので、名前を取得できます：
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

そして最後に、関数にアクセスして関数を呼び出します（URLにID、名前、関数名が表示されていることに注意してください）: [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### その他のトリガー

Lambdaをトリガーするための他のソースがたくさんあります

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### 特権昇格

次のページでは、**Lambda権限を悪用して特権を昇格する方法**を確認できます:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### 攻撃後の処理

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### 永続性

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## 参考文献

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手してください
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見つけてください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)を**フォロー**してください。
* **HackTricks**および**HackTricks Cloud**のgithubリポジトリにPRを提出して、自分のハッキングトリックを共有してください。

</details>
