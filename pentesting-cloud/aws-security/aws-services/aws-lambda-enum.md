# AWS - Lambda枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向**[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>

## Lambda

Amazon Web Services (AWS) Lambda是一种计算服务，允许您在不需要预配或管理服务器的情况下运行代码。Lambda会自动管理运行代码所需的资源，并提供高可用性、扩展性和安全性功能。使用Lambda，您只需支付实际消耗的计算时间，没有预付费用或长期承诺。

要调用Lambda，可以使用Cloudwatch调用它的频率，公开URL端点并调用它，通过API Gateway调用它，甚至基于S3存储桶中的数据更改或DynamoDB表的更新等事件调用它。

Lambda的代码存储在`/var/task`中。

### Lambda别名权重

Lambda可以有多个版本。\
它可以通过别名公开多个版本。每个别名公开的版本的权重将决定哪个别名接收调用（例如可以是90%-10%）。\
如果其中一个别名的代码存在漏洞，您可以发送请求，直到漏洞版本接收到攻击。

![](<../../../.gitbook/assets/image (16) (1).png>)

### 资源策略

Lambda资源策略允许其他服务/帐户调用Lambda。\
例如，以下是允许任何人通过URL访问Lambda的策略：

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

或者允许API Gateway调用它的策略：

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda数据库代理

当有数百个并发的Lambda请求时，如果每个请求都需要连接和关闭数据库连接，这是行不通的（Lambda是无状态的，无法保持连接打开）。\
因此，如果您的Lambda函数与RDS代理而不是数据库实例进行交互，则可以处理由并发Lambda函数创建的许多同时连接所需的连接池。这使得您的Lambda应用程序可以重用现有连接，而不是为每个函数调用创建新连接。

### Lambda EFS文件系统

为了保留甚至共享数据，Lambda可以访问EFS并挂载它们，因此Lambda将能够从中读取和写入。

### Lambda层

Lambda层是一个.zip文件归档，**可以包含附加代码**或其他内容。层可以包含库、[自定义运行时](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)、数据或配置文件。

每个函数可以包含最多**五个层**。当您在函数中包含一个层时，**内容将被提取到执行环境中的`/opt`目录**中。

默认情况下，您创建的层对您的AWS帐户是私有的。您可以选择与其他帐户共享层，或将层设为公共。如果您的函数使用了其他帐户发布的层版本，即使在删除该层版本或撤销访问该层的权限后，您的函数也可以继续使用该层版本。但是，您无法创建新函数或使用已删除的层版本更新函数。

作为容器映像部署的函数不使用层。相反，您在构建映像时将首选的运行时、库和其他依赖项打包到容器映像中。

### Lambda扩展

Lambda扩展使您能够增强函数功能。例如，您可以使用扩展将函数与首选的监视、可观察性、安全性和治理工具集成。您可以使用[Lambda层](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)将扩展添加到.zip归档函数中，或者在[作为容器映像部署的函数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)中将它们包含在映像中。

* **内部扩展**作为**运行时**进程的**一部分**运行，与您的代码**内部**运行。它们允许您使用特定于语言的环境变量和包装脚本修改运行时进程的启动。内部扩展可实现自动化代码的仪表化等用例。
* **外部扩展**允许您在与Lambda函数相同的执行环境中**运行单独的进程**。外部扩展可以在运行时进程之前启动，并且可以在运行时关闭之后继续运行。外部扩展可实现在调用之前获取密钥或将遥测发送到函数调用之外的自定义目标等用例。这些扩展作为Lambda函数的伴随进程运行。
### 枚举

Enumeration is the process of gathering information about a target system or service. In the context of AWS Lambda, enumeration involves identifying and gathering information about the Lambda functions, their configurations, and associated resources.

枚举是收集有关目标系统或服务的信息的过程。在AWS Lambda的上下文中，枚举涉及识别和收集有关Lambda函数、其配置和相关资源的信息。

#### Enumerating Lambda Functions

#### 枚举Lambda函数

To enumerate Lambda functions, you can use the AWS CLI or SDKs, or you can leverage third-party tools like `aws-shell` or `awsume`. The following are some techniques you can use to enumerate Lambda functions:

要枚举Lambda函数，可以使用AWS CLI或SDK，也可以利用第三方工具如`aws-shell`或`awsume`。以下是一些用于枚举Lambda函数的技术：

- **AWS CLI**: Use the `aws lambda list-functions` command to list all Lambda functions in the AWS account.

- **AWS CLI**：使用`aws lambda list-functions`命令列出AWS账户中的所有Lambda函数。

- **SDKs**: Use the appropriate SDK for your programming language to interact with the AWS Lambda API and retrieve information about Lambda functions.

- **SDKs**：使用适合您编程语言的SDK与AWS Lambda API进行交互，并检索有关Lambda函数的信息。

- **Third-party tools**: Tools like `aws-shell` or `awsume` provide interactive shells with auto-completion and other features that can simplify the enumeration process.

- **第三方工具**：像`aws-shell`或`awsume`这样的工具提供了带有自动补全和其他功能的交互式shell，可以简化枚举过程。

#### Enumerating Function Configurations

#### 枚举函数配置

Once you have identified the Lambda functions, you can enumerate their configurations to gather more information. Some techniques to enumerate function configurations include:

一旦确定了Lambda函数，可以枚举它们的配置以收集更多信息。一些枚举函数配置的技术包括：

- **AWS CLI**: Use the `aws lambda get-function-configuration` command to retrieve the configuration of a specific Lambda function.

- **AWS CLI**：使用`aws lambda get-function-configuration`命令检索特定Lambda函数的配置。

- **SDKs**: Use the appropriate SDK for your programming language to interact with the AWS Lambda API and retrieve the configuration of Lambda functions.

- **SDKs**：使用适合您编程语言的SDK与AWS Lambda API进行交互，并检索Lambda函数的配置。

- **Third-party tools**: Some third-party tools provide functionality to enumerate and display the configurations of Lambda functions.

- **第三方工具**：一些第三方工具提供了枚举和显示Lambda函数配置的功能。

#### Enumerating Associated Resources

#### 枚举关联资源

Lambda functions can be associated with various AWS resources, such as S3 buckets, DynamoDB tables, or API Gateway endpoints. Enumerating these associated resources can provide valuable information about the function's dependencies and potential attack vectors. Some techniques to enumerate associated resources include:

Lambda函数可以与各种AWS资源关联，如S3存储桶、DynamoDB表或API Gateway端点。枚举这些关联资源可以提供有关函数的依赖关系和潜在攻击向量的有价值信息。一些枚举关联资源的技术包括：

- **AWS CLI**: Use the appropriate AWS CLI commands to list and retrieve information about associated resources. For example, use `aws lambda list-event-source-mappings` to list the event source mappings for a Lambda function.

- **AWS CLI**：使用适当的AWS CLI命令列出和检索有关关联资源的信息。例如，使用`aws lambda list-event-source-mappings`列出Lambda函数的事件源映射。

- **SDKs**: Use the appropriate SDK for your programming language to interact with the AWS Lambda API and retrieve information about associated resources.

- **SDKs**：使用适合您编程语言的SDK与AWS Lambda API进行交互，并检索有关关联资源的信息。

- **Third-party tools**: Some third-party tools provide functionality to enumerate and display the associated resources of Lambda functions.

- **第三方工具**：一些第三方工具提供了枚举和显示Lambda函数关联资源的功能。
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "LAMBDA-NAME-HERE-FROM-PREVIOUS-QUERY" --query 'Code.Location' --profile uploadcreds
wget -O lambda-function.zip url-from-previous-query

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### 调用 Lambda

#### 手动方式
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### 通过暴露的URL

If you find an exposed URL of an AWS Lambda function, you can use it to enumerate information about the function and potentially exploit it. Here are some techniques you can use:

- **Function Name Enumeration**: By appending "/2015-03-31/functions" to the exposed URL, you can retrieve a list of all the Lambda functions in the account.

- **Function Configuration Enumeration**: By appending "/2015-03-31/functions/{function_name}/configuration" to the exposed URL, you can retrieve the configuration details of a specific Lambda function.

- **Function Code Enumeration**: By appending "/2015-03-31/functions/{function_name}/code" to the exposed URL, you can retrieve the code of a specific Lambda function.

- **Function Environment Variables Enumeration**: By appending "/2015-03-31/functions/{function_name}/environment" to the exposed URL, you can retrieve the environment variables of a specific Lambda function.

- **Function Permissions Enumeration**: By appending "/2015-03-31/functions/{function_name}/policy" to the exposed URL, you can retrieve the permissions policy of a specific Lambda function.

- **Function Event Source Mappings Enumeration**: By appending "/2015-03-31/functions/{function_name}/event-source-mappings" to the exposed URL, you can retrieve the event source mappings of a specific Lambda function.

- **Function Versions Enumeration**: By appending "/2015-03-31/functions/{function_name}/versions" to the exposed URL, you can retrieve the versions of a specific Lambda function.

- **Function Aliases Enumeration**: By appending "/2015-03-31/functions/{function_name}/aliases" to the exposed URL, you can retrieve the aliases of a specific Lambda function.

- **Function Tags Enumeration**: By appending "/2015-03-31/tags/{resource_arn}" to the exposed URL, you can retrieve the tags associated with a specific Lambda function.

Remember to always obtain proper authorization before performing any enumeration or exploitation activities.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### 通过URL调用Lambda函数

现在是时候找出可能执行的Lambda函数了：
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

有一个名为"Level6"的lambda函数可用。让我们找出如何调用它：
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
现在，你已经知道了名称和ID，你可以获取名称：
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

最后调用函数访问（注意URL中的ID、名称和函数名称）：[https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### 其他触发器

还有很多其他可以触发Lambda的来源

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### 提权

在下一页中，您可以查看如何滥用Lambda权限以提升特权：

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### 未经身份验证的访问

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### 后渗透

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### 持久性

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## 参考资料

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向**[**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
