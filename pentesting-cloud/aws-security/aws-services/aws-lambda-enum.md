# AWS - Lambda Enum

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Lambda

Amazon Web Services (AWS) Lambda word beskryf as 'n **berekeningsdiens** wat die uitvoering van kode moontlik maak sonder die noodsaaklikheid van bedienervoorsiening of -bestuur. Dit word gekenmerk deur sy vermo√´ om **hulpbrontoewysing outomaties te hanteer** wat nodig is vir kode-uitvoering, en verseker funksies soos ho√´ beskikbaarheid, skaalbaarheid en veiligheid. 'n Belangrike aspek van Lambda is sy prysmodel, waar **heffings slegs gebaseer word op die gebruikte berekeningstyd**, wat die behoefte aan aanvanklike beleggings of langtermynverpligtinge uitskakel.

Om 'n lambda te roep, is dit moontlik om dit so **gereeld as wat jy wil** te roep (met Cloudwatch), 'n **URL**-eindpunt bloot te stel en dit te roep, dit te roep via **API Gateway**, of selfs gebaseer op **gebeurtenisse** soos veranderinge in data in 'n **S3**-emmer of opdaterings aan 'n **DynamoDB**-tabel.

Die **kode** van 'n lambda word gestoor in **`/var/task`**.

### Lambda Aliasse Gewigte

'n Lambda kan **verskeie weergawes** h√™.\
En dit kan **meer as 1** weergawe blootgestel via **aliasse** h√™. Die **gewigte** van **elkeen** van die **weergawes** wat binne 'n alias blootgestel word, sal besluit **watter alias die aanroeping ontvang** (dit kan byvoorbeeld 90%-10% wees).\
As die kode van **een** van die aliasse **kwesbaar** is, kan jy **versoeke stuur totdat die kwesbare** weergawe die uitbuiting ontvang.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Hulpbronbeleide

Lambda-hulpbronbeleide maak dit moontlik om **toegang te gee aan ander dienste/rekeninge om die lambda aan te roep** byvoorbeeld.\
Byvoorbeeld, hierdie is die beleid om **enigiemand toegang te gee tot 'n lambda wat via 'n URL blootgestel word**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Of dit om 'n API Gateway toe te laat om dit aan te roep:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Databasisproksi

Wanneer daar **honderde** **gelyktydige lambda-versoeke** is, as elkeen van hulle 'n **verbinding met 'n databasis moet maak en sluit**, gaan dit net nie werk nie (lambdas is staatloos, kan nie verbindings oop hou nie).\
Dan, as jou **Lambda-funksies met RDS Proxy in plaas daarvan kommunikeer** met jou databasisinstansie. Dit hanteer die verbindingspooling wat nodig is vir die skaalbaarheid van baie gelyktydige verbindings wat deur gelyktydige Lambda-funksies geskep word. Dit maak dit moontlik vir jou Lambda-toepassings om **bestaande verbindings te hergebruik**, eerder as om nuwe verbindings vir elke funksie-aanroeping te skep.

### Lambda EFS-l√™ersisteme

Om data te behou en selfs te deel, **kan Lambdas toegang verkry tot EFS en dit koppel**, sodat Lambda dit kan lees en daarin kan skryf.

### Lambda-l√™ers

'n Lambda-_laag_ is 'n .zip-l√™erargief wat **bykomende kode** of ander inhoud kan bevat. 'n Laag kan biblioteke, 'n [aangepaste uitvoeringstyd](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), data of konfigurasie-l√™ers bevat.

Dit is moontlik om tot **vyf l√™ers per funksie** in te sluit. Wanneer jy 'n laag in 'n funksie insluit, word die **inhoud onttrek na die `/opt`**-gids in die uitvoeringsomgewing.

Standaard is die l√™ers wat jy skep **privaat** vir jou AWS-rekening. Jy kan kies om 'n laag met ander rekeninge te **deel** of die laag **openbaar** te maak. As jou funksies 'n laag verbruik wat deur 'n ander rekening gepubliseer is, kan jou funksies **voortgaan om die laagweergawe te gebruik nadat dit uitgevee is, of nadat jou toestemming om die laag te gebruik, herroep is**. Jy kan egter nie 'n nuwe funksie skep of funksies bywerk met 'n uitgevee laagweergawe nie.

Funksies wat as 'n houerbeeld ge√Ømplementeer is, gebruik nie l√™ers nie. In plaas daarvan pak jy jou voorkeur-uitvoeringstyd, biblioteke en ander afhanklikhede in die houerbeeld in wanneer jy die beeld bou.

### Lambda-uitbreidings

Lambda-uitbreidings verbeter funksies deur te integreer met verskillende **monitering-, waarneembaarheids-, sekuriteits- en bestuurstoerusting**. Hierdie uitbreidings, wat bygevoeg word via [.zip-argiewe deur Lambda-l√™ers te gebruik](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) of ingesluit in [houerbeeldimplementasies](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/), werk in twee modusse: **interne** en **eksterne**.

* **Interne uitbreidings** versmelt met die uitvoeringsproses, deur sy aanvang te manipuleer met behulp van **taalspesifieke omgewingsveranderlikes** en **omhulselkripte**. Hierdie aanpassing geld vir 'n verskeidenheid uitvoeringstye, insluitend **Java Correto 8 en 11, Node.js 10 en 12, en .NET Core 3.1**.

* **Eksterne uitbreidings** loop as afsonderlike prosesse, en handhaaf werkingsooreenstemming met die lewensiklus van die Lambda-funksie. Hulle is versoenbaar met verskeie uitvoeringstye soos **Node.js 10 en 12, Python 3.7 en 3.8, Ruby 2.5 en 2.7, Java Corretto 8 en 11, .NET Core 3.1**, en **aangepaste uitvoeringstye**.
### Opstel

Enumeration is 'n belangrike stap in die pentesting-proses, omdat dit jou in staat stel om inligting oor die teikenomgewing te versamel. In hierdie gedeelte sal ons kyk na die verskillende maniere waarop jy AWS Lambda kan opstel.

#### 1. AWS CLI

Om AWS Lambda-funksies op te stel met die AWS CLI, kan jy die volgende opdrag gebruik:

```plaintext
aws lambda create-function --function-name my-function --runtime python3.8 --role arn:aws:iam::123456789012:role/lambda-role --handler my-function.handler --zip-file fileb://my-function.zip
```

Hier is 'n kort verduideliking van die opdrag se vlags:

- `--function-name`: Die naam van die funksie wat jy wil opstel.
- `--runtime`: Die programmeertaal wat gebruik word vir die funksie (byvoorbeeld python3.8).
- `--role`: Die ARN van die rol wat aan die funksie toegewys word.
- `--handler`: Die naam van die hanteringsfunksie wat die funksie sal aanroep.
- `--zip-file`: Die pad na die zip-l√™er wat die funksie bevat.

#### 2. AWS Management Console

Om 'n AWS Lambda-funksie op te stel met die AWS-bestuurskonsol, volg hierdie stappe:

1. Teken in op die AWS-bestuurskonsol.
2. Navigeer na die Lambda-diens.
3. Klik op "Funksies" in die navigasiepaneel aan die linkerkant.
4. Klik op "Funksie skep" om 'n nuwe funksie te skep.
5. Voltooi die vereiste inligting, soos funksienaam, programmeertaal, hanteringsfunksie en rol.
6. Klik op "Skep funksie" om die funksie op te stel.

#### 3. AWS SDK's

AWS bied SDK's vir verskillende programmeertaalplatforms, soos Python, Java, .NET, en meer. Jy kan die relevante SDK gebruik om 'n AWS Lambda-funksie op te stel. Hier is 'n voorbeeld van hoe jy dit met die Python SDK kan doen:

```python
import boto3

client = boto3.client('lambda')

response = client.create_function(
    FunctionName='my-function',
    Runtime='python3.8',
    Role='arn:aws:iam::123456789012:role/lambda-role',
    Handler='my-function.handler',
    Code={
        'ZipFile': open('my-function.zip', 'rb').read()
    }
)
```

Hier is 'n kort verduideliking van die parameters:

- `FunctionName`: Die naam van die funksie wat jy wil opstel.
- `Runtime`: Die programmeertaal wat gebruik word vir die funksie (byvoorbeeld python3.8).
- `Role`: Die ARN van die rol wat aan die funksie toegewys word.
- `Handler`: Die naam van die hanteringsfunksie wat die funksie sal aanroep.
- `Code`: Die inhoud van die zip-l√™er wat die funksie bevat.

Dit is die basiese metodes om AWS Lambda-funksies op te stel. Onthou om die nodige toestemmings en beveiligingsmaatre√´ls te implementeer om jou funksies te beskerm teen aanvalle.
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Roep 'n lambda aan

#### Handleiding
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Deur blootgestelde URL

As jy 'n blootgestelde URL vir 'n AWS Lambda-funksie vind, kan jy probeer om toegang tot die funksie te verkry. Jy kan dit doen deur die URL te besoek en te kyk of jy enige sensitiewe inligting of funksionaliteit kan blootstel. Dit kan insluit:

- Die funksie se bronkode
- Gevoelige inligting soos API-sleutels of toegangstokens
- Toegang tot ander AWS-bronne wat deur die funksie gebruik word

Dit is belangrik om te onthou dat jy slegs toegang tot die funksie moet probeer verkry as jy die regte toestemming het om dit te doen.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Roep Lambda-funksie aan via URL

Nou is dit tyd om moontlike lambda-funksies te vind om uit te voer:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

'n Lambda-funksie genaamd "Level6" is beskikbaar. Kom ons vind uit hoe om dit te roep:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

Nou dat jy die naam en die ID weet, kan jy die Naam kry:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

En roep uiteindelik die funksie aan deur toegang te verkry (let daarop dat die ID, Naam en funksie-naam in die URL verskyn): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Ander Triggers

Daar is baie ander bronne wat 'n lambda kan trigger

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Privesc

Op die volgende bladsy kan jy sien hoe om Lambda-permissies te misbruik om voorregte te verhoog:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Ongeagte Toegang

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Volharding

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Verwysings

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As u u **maatskappy in HackTricks wil adverteer** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel u haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
