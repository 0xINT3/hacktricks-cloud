# AWS - Lambda 枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## Lambda

Amazon Web Services (AWS) Lambda 被描述为一种**计算服务**，它能够在无需服务器配置或管理的情况下执行代码。它的特点是能够**自动处理执行代码所需的资源分配**，确保高可用性、可扩展性和安全性。Lambda的一个重要方面是其定价模型，其中**费用仅基于使用的计算时间**，无需初始投资或长期承诺。

要调用lambda，可以通过Cloudwatch**频繁地调用**，**暴露**一个**URL**端点并调用它，通过**API Gateway**调用它，甚至可以基于**事件**调用，例如**S3**存储桶中数据的**变化**或**DynamoDB**表的更新。

Lambda的**代码**存储在**`/var/task`**中。

### Lambda 别名权重

一个Lambda可以有**多个版本**。\
并且可以通过**别名**暴露**多于1个**版本。在别名中暴露的**每个**版本的**权重**将决定**哪个别名接收调用**（例如可以是90%-10%）。\
如果**其中一个**别名的代码是**易受攻击的**，你可以发送**请求直到易受攻击的**版本接收到漏洞利用。

![](<../../../.gitbook/assets/image (16) (1).png>)

### 资源策略

Lambda资源策略允许**给其他服务/账户访问权限以调用**lambda。\
例如，这是允许**任何人访问通过URL暴露的lambda**的策略：

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

或者这个允许API Gateway调用它：

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda 数据库代理

当有**数百个**并发的lambda请求时，如果每个请求都需要**连接和关闭数据库连接**，这是行不通的（lambdas是无状态的，不能保持连接打开）。\
那么，如果你的**Lambda函数与RDS代理交互**而不是你的数据库实例。它处理了由并发Lambda函数创建的许多同时连接所需的连接池。这允许您的Lambda应用程序**重用现有连接**，而不是为每次函数调用创建新连接。

### Lambda EFS 文件系统

为了保存甚至共享数据，**Lambdas可以访问EFS并挂载它们**，所以Lambda将能够从中读取和写入。

### Lambda 层

Lambda _层_ 是一个.zip文件存档，**可以包含额外的代码**或其他内容。层可以包含库、[自定义运行时](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)、数据或配置文件。

每个函数最多可以包含**五个层**。当你在函数中包含一个层时，**内容会被提取到执行环境中的`/opt`目录**。

默认情况下，你创建的**层**对你的AWS账户是**私有的**。你可以选择**共享**一个层给其他账户，或者**使**层**公开**。如果你的函数使用了不同账户发布的层，即使该层版本已被删除，或者你访问该层的权限被撤销，你的函数也可以**继续使用该层版本**。然而，你不能使用已删除的层版本创建新函数或更新函数。

作为容器映像部署的函数不使用层。相反，当你构建映像时，你会将首选的运行时、库和其他依赖项打包到容器映像中。

### Lambda 扩展

Lambda扩展通过与各种**监控、可观察性、安全和治理工具**集成来增强函数。这些扩展可以通过使用Lambda层的[.zip存档](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)添加，或包含在[容器映像部署](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)中，以两种模式运行：**内部**和**外部**。

* **内部扩展**与运行时进程合并，使用**特定于语言的环境变量**和**包装脚本**操纵其启动。这种自定义适用于包括**Java Correto 8和11, Node.js 10和12, 和 .NET Core 3.1**在内的多种运行时。

* **外部扩展**作为单独的进程运行，与Lambda函数的生命周期保持操作一致。它们与各种运行时兼容，如**Node.js 10和12, Python 3.7和3.8, Ruby 2.5和2.7, Java Corretto 8和11, .NET Core 3.1**，以及**自定义运行时**。

### 枚举
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### 调用 Lambda

#### 手动
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### 通过暴露的URL
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### 通过 URL 调用 Lambda 函数

现在是时候找出可能执行的 lambda 函数了：
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

一个名为 "Level6" 的 lambda 函数可用。让我们找出如何调用它：
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

现在，您知道了名称和ID，您可以获取名称：
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
```markdown
![](<../../../.gitbook/assets/image (20).png>)

最后调用函数访问（注意 ID、Name 和 function-name 出现在 URL 中）：[https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### 其他触发器

还有很多其他来源可以触发 lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### 权限提升

在接下来的页面中，您可以检查如何**滥用 Lambda 权限来提升权限**：

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### 未经认证的访问

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### 后期利用

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### 持久性

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## 参考资料

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零到英雄学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF** 版本，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
```
