# AWS - Lambda Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**する。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Lambda

AWS Lambdaは、**サーバーのプロビジョニングや管理をせずにコードを実行**できるコンピューティングサービスです。Lambdaは、コードの実行に必要なリソースを**自動的に管理**し、高可用性、スケーリング、セキュリティ機能を提供します。Lambdaでは、**消費したコンピュート時間のみ**に対して支払い、前払い費用や長期契約はありません。

Lambdaを呼び出すには、**Cloudwatch**を使って**好きなだけ頻繁に**呼び出す、**URL**エンドポイントを公開して呼び出す、**API Gateway**を介して呼び出す、または**S3**バケットのデータの**変更**や**DynamoDB**テーブルの更新などの**イベント**に基づいて呼び出すことができます。

Lambdaの**コード**は**`/var/task`**に保存されます。

### Lambda Aliases Weights

Lambdaには**複数のバージョン**があります。\
そして、**1つ以上の**バージョンを**エイリアス**を介して公開することができます。エイリアス内で公開されている**各**バージョンの**ウェイト**が、**どのエイリアスが呼び出しを受けるか**を決定します（例えば90%-10%など）。\
もしエイリアスの**いずれかの**コードが**脆弱**であれば、脆弱なバージョンがエクスプロイトを受けるまで**リクエストを送り続ける**ことができます。

![](<../../../.gitbook/assets/image (16) (1).png>)

### Resource Policies

Lambdaリソースポリシーにより、他のサービス/アカウントがLambdaを呼び出すための**アクセスを許可**することができます。\
例えば、これは**URL経由で公開されたLambdaに誰でもアクセスできるようにする**ポリシーです：

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

または、API Gatewayが呼び出すことを許可するこれです：

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda Database Proxies

**同時に数百のLambdaリクエスト**がある場合、それぞれがデータベースに**接続して切断する必要がある**と、うまくいきません（Lambdaはステートレスで、接続を開いたままにすることはできません）。\
そのため、**Lambda関数がRDS Proxyと対話する**場合、データベースインスタンスではなく、同時に多くの接続をスケーリングするために必要な接続プーリングを処理します。これにより、Lambdaアプリケーションは**既存の接続を再利用**できるようになり、関数の呼び出しごとに新しい接続を作成する必要がなくなります。

### Lambda EFS Filesystems

データを保存し、共有するために、**LambdaはEFSにアクセスしてマウント**することができます。そのため、Lambdaはそれを読み書きすることができます。

### Lambda Layers

Lambda _レイヤー_ は、追加のコードやその他のコンテンツを含むことができる.zipファイルアーカイブです。レイヤーには、ライブラリ、[カスタムランタイム](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)、データ、または設定ファイルが含まれることがあります。

関数ごとに**最大5つのレイヤー**を含めることができます。関数にレイヤーを含めると、**内容は実行環境の`/opt`ディレクトリに展開**されます。

**デフォルトでは**、あなたが作成した**レイヤーはあなたのAWSアカウントにプライベート**です。他のアカウントとレイヤーを**共有する**か、レイヤーを**公開する**ことを選択できます。異なるアカウントが公開したレイヤーをあなたの関数が使用している場合、そのレイヤーバージョンが削除された後、またはレイヤーへのアクセス許可が取り消された後でも、あなたの関数はそのレイヤーバージョンを**引き続き使用することができます**。ただし、削除されたレイヤーバージョンを使用して新しい関数を作成したり、関数を更新したりすることはできません。

コンテナイメージとしてデプロイされた関数はレイヤーを使用しません。代わりに、イメージをビルドするときに、好みのランタイム、ライブラリ、その他の依存関係をコンテナイメージにパッケージします。

### Lambda Extensions

Lambda拡張機能を使用すると、関数を拡張できます。例えば、拡張機能を使用して、関数をお好みの監視、可視性、セキュリティ、ガバナンスツールと統合することができます。拡張機能は、[Lambdaレイヤー](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html)を使用して.zipアーカイブ関数に追加するか、[コンテナイメージとしてデプロイされた関数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)のイメージに含めます。

* **内部拡張機能**は、ランタイムプロセスの**一部**として、コードと**同じプロセス内**で実行されます。これにより、言語固有の環境変数やラッパースクリプトを使用してランタイムプロセスの**起動を変更**することができます。内部拡張機能は、コードの自動計測などのユースケースを可能にします。
* **外部拡張機能**は、ランタイムとは別のプロセスを実行することを可能にしますが、Lambda関数と**同じ実行環境内**で実行されます。外部拡張機能は、ランタイムプロセスが**開始される前**に開始することができ、ランタイムが**シャットダウンした後も続行**することができます。これらの拡張機能は、Lambda関数のコンパニオンプロセスとして実行されます。
### 列挙
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### ラムダを起動する

#### 手動
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### 露出したURLを通じて
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### URL経由でLambda関数を呼び出す

実行可能なLambda関数を見つける時が来ました：
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

"Level6" という名前のlambda関数が利用可能です。それをどのように呼び出すか見つけましょう：
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

名前とIDがわかったので、次はNameを取得できます：
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
```markdown
![](<../../../.gitbook/assets/image (20).png>)

そして最後に、関数にアクセスして呼び出します（ID、名前、関数名がURLに表示されることに注意してください）： [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### その他のトリガー

Lambdaをトリガーする他の多くのソースがあります

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### 権限昇格

次のページでは、**Lambdaの権限を悪用して権限を昇格させる方法**を確認できます：

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### 攻撃後の活動

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### 持続性

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## 参考文献

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加するか、**[**telegramグループ**](https://t.me/peass)、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
```
