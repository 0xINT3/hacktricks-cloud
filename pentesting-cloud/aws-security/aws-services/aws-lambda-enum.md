# AWS - Lambda Enum

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)\*\* 上关注\*\*我们。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## Lambda

亚马逊网络服务（AWS）Lambda 被描述为一种**计算服务**，它使代码能够在无需服务器提供或管理的情况下执行。它以**自动处理代码执行所需的资源分配**为特点，确保具有高可用性、可伸缩性和安全性等功能。Lambda 的一个重要方面是其定价模型，其中**费用仅基于使用的计算时间**，消除了对初始投资或长期义务的需求。

要调用一个 Lambda，可以通过 **Cloudwatch** 频繁调用它，**公开**一个 **URL** 端点并调用它，通过 **API Gateway** 调用它，甚至基于 **事件**（如对 **S3** 存储桶中数据的更改或对 **DynamoDB** 表的更新）调用它。

Lambda 的代码存储在 **`/var/task`** 中。

### Lambda 别名权重

一个 Lambda 可以有**多个版本**。\
它可以通过**别名**公开**多个**版本。在别名中公开的**每个版本**的**权重**将决定**哪个别名接收调用**（例如可以是 90%-10%）。\
如果**一个**别名的代码**存在漏洞**，您可以发送**请求直到有漏洞的**版本接收到利用。

![](<../../../.gitbook/assets/image (16) (1).png>)

### 资源策略

Lambda 资源策略允许**授予其他服务/帐户调用** Lambda 的权限。\
例如，这是允许**任何人访问通过 URL 公开的 Lambda** 的策略：

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

或者允许 API Gateway 调用它的策略：

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda 数据库代理

当有**数百个并发 Lambda 请求**时，如果每个请求都需要**连接和关闭到数据库的连接**，这根本行不通（Lambda 是无状态的，无法保持连接开放）。\
因此，如果您的**Lambda 函数与 RDS 代理交互**而不是与数据库实例交互。它处理了由并发 Lambda 函数创建的许多同时连接所需的连接池。这允许您的 Lambda 应用程序**重用现有连接**，而不是为每个函数调用创建新连接。

### Lambda EFS 文件系统

为了保留甚至共享数据，**Lambda 可以访问 EFS 并挂载它们**，因此 Lambda 将能够从中读取和写入。

### Lambda 层

Lambda 的 _layer_ 是一个 .zip 文件存档，**可以包含附加代码**或其他内容。一个层可以包含库、[自定义运行时](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)、数据或配置文件。

每个函数最多可以包含**五个层**。当您在函数中包含一个层时，**内容会被提取到执行环境中的 `/opt` 目录**中。

**默认情况下**，您创建的**层**对您的 AWS 帐户是**私有**的。您可以选择与其他帐户**共享**一个层，或者将该层**公开**。如果您的函数使用了另一个帐户发布的层，您的函数可以在**删除该层版本后继续使用该层版本，或者在您的访问权限被撤销后继续使用该层**。但是，您不能使用已删除的层版本创建新函数或更新函数。

作为容器映像部署的函数不使用层。相反，在构建映像时，您将首选的运行时、库和其他依赖项打包到容器映像中。

### Lambda 扩展

Lambda 扩展通过与各种**监控、可观察性、安全性和治理工具**集成来增强函数。这些扩展通过 [.zip 存档使用 Lambda 层](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) 添加，或包含在[容器映像部署](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)中，以**内部**和**外部**两种模式运行。

* **内部扩展**与运行时进程合并，使用**特定于语言的环境变量**和**包装脚本**操纵其启动。这种定制适用于一系列运行时，包括**Java Correto 8 和 11、Node.js 10 和 12，以及 .NET Core 3.1**。
* **外部扩展**作为独立进程运行，保持与 Lambda 函数生命周期的操作对齐。它们与各种运行时兼容，如**Node.js 10 和 12、Python 3.7 和 3.8、Ruby 2.5 和 2.7、Java Corretto 8 和 11、.NET Core 3.1**，以及**自定义运行时**。

### 枚举

```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```

### 调用lambda

#### 手动

```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```

#### 通过暴露的URL

```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```

#### 通过URL调用Lambda函数

现在是时候找出可能要执行的Lambda函数了：

```
aws --region us-west-2 --profile level6 lambda list-functions
```

一个名为"Level6"的lambda函数可用。让我们找出如何调用它：

```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```

现在，您已经知道名称和ID，您可以获取名称：

```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```

![](<../../../.gitbook/assets/image (20).png>)

最后调用函数访问（注意URL中的ID、名称和函数名称）：[https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### 其他触发器

有许多其他来源可以触发 Lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### 提权

在以下页面中，您可以查看如何**滥用 Lambda 权限以提升特权**：

{% content-ref url="../aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### 未经身份验证的访问

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### 后渗透

{% content-ref url="../aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### 持久性

{% content-ref url="../aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## 参考资料

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)
* [https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/](https://aws.amazon.com/blogs/compute/building-extensions-for-aws-lambda-in-preview/)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)系列
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)\*\* 上关注我们\*\*。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
