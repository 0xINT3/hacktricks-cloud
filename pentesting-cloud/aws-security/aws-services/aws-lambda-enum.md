# AWS - Enumera√ß√£o do Lambda

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

## Lambda

O Amazon Web Services (AWS) Lambda √© um servi√ßo de computa√ß√£o que permite **executar c√≥digo sem provisionar ou gerenciar servidores**. O Lambda **gerencia automaticamente os recursos necess√°rios** para executar seu c√≥digo e fornece recursos de alta disponibilidade, dimensionamento e seguran√ßa. Com o Lambda, **voc√™ paga apenas pelo tempo de computa√ß√£o que consome**, e n√£o h√° custos iniciais ou compromissos de longo prazo.

Para chamar um lambda, √© poss√≠vel cham√°-lo **com a frequ√™ncia que desejar** (com o Cloudwatch), **expor** um **endpoint de URL** e cham√°-lo, cham√°-lo via **API Gateway** ou at√© mesmo com base em **eventos** como **altera√ß√µes** nos dados em um bucket **S3** ou atualiza√ß√µes em uma tabela **DynamoDB**.

O **c√≥digo** de um lambda √© armazenado em **`/var/task`**.

### Pesos de Aliases do Lambda

Um Lambda pode ter **v√°rias vers√µes**.\
E pode ter **mais de 1** vers√£o exposta por meio de **aliases**. Os **pesos** de **cada uma** das **vers√µes** expostas dentro de um alias decidir√£o **qual alias receber√° a invoca√ß√£o** (pode ser 90%-10%, por exemplo).\
Se o c√≥digo de **um** dos aliases for **vulner√°vel**, voc√™ pode enviar **solicita√ß√µes at√© que a vers√£o vulner√°vel** receba o exploit.

![](<../../../.gitbook/assets/image (16) (1).png>)

### Pol√≠ticas de Recursos do Lambda

As pol√≠ticas de recursos do Lambda permitem **dar acesso a outros servi√ßos/contas para invocar** o lambda, por exemplo.\
Por exemplo, esta √© a pol√≠tica para permitir que **qualquer pessoa acesse um lambda exposto via URL**:

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

Ou isso para permitir que um API Gateway o invoque:

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Proxies de Banco de Dados do Lambda

Quando h√° **centenas** de **solicita√ß√µes lambda simult√¢neas**, se cada uma delas precisar **conectar e fechar uma conex√£o com um banco de dados**, simplesmente n√£o funcionar√° (os lambdas s√£o sem estado, n√£o podem manter conex√µes abertas).\
Nesse caso, se suas **fun√ß√µes Lambda interagem com o RDS Proxy** em vez de sua inst√¢ncia de banco de dados, ele lida com o pool de conex√µes necess√°rio para dimensionar muitas conex√µes simult√¢neas criadas por fun√ß√µes Lambda concorrentes. Isso permite que suas aplica√ß√µes Lambda **reutilizem conex√µes existentes**, em vez de criar novas conex√µes para cada invoca√ß√£o da fun√ß√£o.

### Sistemas de Arquivos EFS do Lambda

Para preservar e at√© mesmo compartilhar dados, **os Lambdas podem acessar o EFS e mont√°-los**, para que o Lambda possa ler e gravar nele.

### Camadas do Lambda

Uma _camada_ do Lambda √© um arquivo .zip que **pode conter c√≥digo adicional** ou outro conte√∫do. Uma camada pode conter bibliotecas, um [runtime personalizado](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), dados ou arquivos de configura√ß√£o.

√â poss√≠vel incluir at√© **cinco camadas por fun√ß√£o**. Quando voc√™ inclui uma camada em uma fun√ß√£o, o **conte√∫do √© extra√≠do para o diret√≥rio `/opt`** no ambiente de execu√ß√£o.

Por **padr√£o**, as **camadas** que voc√™ cria s√£o **privadas** para sua conta da AWS. Voc√™ pode optar por **compartilhar** uma camada com outras contas ou **tornar** a camada **p√∫blica**. Se suas fun√ß√µes consomem uma camada que uma conta diferente publicou, suas fun√ß√µes podem **continuar a usar a vers√£o da camada depois que ela for exclu√≠da ou depois que sua permiss√£o de acesso √† camada for revogada**. No entanto, voc√™ n√£o pode criar uma nova fun√ß√£o ou atualizar fun√ß√µes usando uma vers√£o de camada exclu√≠da.

Fun√ß√µes implantadas como uma imagem de cont√™iner n√£o usam camadas. Em vez disso, voc√™ empacota seu runtime preferido, bibliotecas e outras depend√™ncias na imagem do cont√™iner quando cria a imagem.

### Extens√µes do Lambda

As extens√µes do Lambda permitem que voc√™ aprimore suas fun√ß√µes. Por exemplo, voc√™ pode usar extens√µes para integrar suas fun√ß√µes com suas ferramentas de monitoramento, observabilidade, seguran√ßa e governan√ßa preferidas. Voc√™ adiciona extens√µes a fun√ß√µes de arquivos .zip usando [camadas do Lambda](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html), ou as inclui na imagem para [fun√ß√µes implantadas como imagens de cont√™iner](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/).

* As **extens√µes internas** s√£o executadas como **parte** do **processo de tempo de execu√ß√£o**, **no processo** com seu c√≥digo. Elas permitem que voc√™ modifique a **inicializa√ß√£o do processo de tempo de execu√ß√£o** usando vari√°veis de ambiente espec√≠ficas do idioma e scripts de wrapper. As extens√µes internas permitem casos de uso como instrumenta√ß√£o autom√°tica de c√≥digo.
* As **extens√µes externas** permitem que voc√™ **execute processos separados** do tempo de execu√ß√£o, mas ainda dentro do **mesmo ambiente de execu√ß√£o** da fun√ß√£o Lambda. As extens√µes externas podem **iniciar antes do processo de tempo de execu√ß√£o** e podem **continuar ap√≥s o encerramento do tempo de execu√ß√£o**. As extens√µes externas permitem casos de uso como buscar segredos antes da invoca√ß√£o ou enviar telemetria para um destino personalizado fora da invoca√ß√£o da fun√ß√£o. Essas extens√µes s√£o executadas como processos auxiliares das fun√ß√µes Lambda.
### Enumera√ß√£o

A enumera√ß√£o √© uma etapa crucial no processo de teste de penetra√ß√£o, pois permite identificar informa√ß√µes importantes sobre o alvo. Nesta se√ß√£o, discutiremos t√©cnicas de enumera√ß√£o espec√≠ficas para o servi√ßo AWS Lambda.

#### Enumera√ß√£o de Fun√ß√µes Lambda

A enumera√ß√£o de fun√ß√µes Lambda envolve a coleta de informa√ß√µes sobre as fun√ß√µes Lambda dispon√≠veis no ambiente alvo. Isso pode ser feito de v√°rias maneiras, incluindo:

- **Enumera√ß√£o manual**: Nesse m√©todo, o testador de penetra√ß√£o examina manualmente o console da AWS ou usa a CLI da AWS para listar as fun√ß√µes Lambda dispon√≠veis.

- **Enumera√ß√£o automatizada**: Nesse m√©todo, ferramentas automatizadas, como o AWS CLI, podem ser usadas para listar as fun√ß√µes Lambda dispon√≠veis.

#### Enumera√ß√£o de Permiss√µes

A enumera√ß√£o de permiss√µes envolve a identifica√ß√£o das permiss√µes associadas a uma fun√ß√£o Lambda espec√≠fica. Isso pode ser feito por meio de t√©cnicas como:

- **An√°lise de pol√≠ticas de fun√ß√£o**: Nessa t√©cnica, o testador de penetra√ß√£o analisa as pol√≠ticas de fun√ß√£o associadas a uma fun√ß√£o Lambda para identificar as permiss√µes concedidas.

- **Verifica√ß√£o de permiss√µes de fun√ß√£o**: Nessa t√©cnica, o testador de penetra√ß√£o verifica se a fun√ß√£o Lambda tem permiss√µes para acessar recursos espec√≠ficos, como buckets S3 ou tabelas do DynamoDB.

#### Enumera√ß√£o de Vari√°veis de Ambiente

A enumera√ß√£o de vari√°veis de ambiente envolve a identifica√ß√£o das vari√°veis de ambiente definidas para uma fun√ß√£o Lambda espec√≠fica. Isso pode revelar informa√ß√µes sens√≠veis, como chaves de API ou credenciais de banco de dados. As t√©cnicas comuns de enumera√ß√£o de vari√°veis de ambiente incluem:

- **Enumera√ß√£o manual**: Nesse m√©todo, o testador de penetra√ß√£o examina manualmente o c√≥digo-fonte da fun√ß√£o Lambda em busca de vari√°veis de ambiente.

- **Enumera√ß√£o automatizada**: Nesse m√©todo, ferramentas automatizadas, como o AWS CLI, podem ser usadas para listar as vari√°veis de ambiente definidas para uma fun√ß√£o Lambda.

#### Enumera√ß√£o de Logs

A enumera√ß√£o de logs envolve a identifica√ß√£o dos logs gerados por uma fun√ß√£o Lambda. Isso pode ser √∫til para entender o comportamento da fun√ß√£o e identificar poss√≠veis problemas de seguran√ßa. As t√©cnicas comuns de enumera√ß√£o de logs incluem:

- **Acesso direto aos logs**: Nessa t√©cnica, o testador de penetra√ß√£o acessa diretamente os logs gerados pela fun√ß√£o Lambda por meio do console da AWS ou da CLI da AWS.

- **Enumera√ß√£o automatizada**: Nessa t√©cnica, ferramentas automatizadas, como o AWS CLI, podem ser usadas para listar os logs gerados por uma fun√ß√£o Lambda.

#### Enumera√ß√£o de Vers√µes e Aliases

A enumera√ß√£o de vers√µes e aliases envolve a identifica√ß√£o das vers√µes e aliases associados a uma fun√ß√£o Lambda. Isso pode ser √∫til para entender como as altera√ß√µes de c√≥digo s√£o gerenciadas e implantadas. As t√©cnicas comuns de enumera√ß√£o de vers√µes e aliases incluem:

- **Enumera√ß√£o manual**: Nesse m√©todo, o testador de penetra√ß√£o examina manualmente o console da AWS ou usa a CLI da AWS para listar as vers√µes e aliases associados a uma fun√ß√£o Lambda.

- **Enumera√ß√£o automatizada**: Nesse m√©todo, ferramentas automatizadas, como o AWS CLI, podem ser usadas para listar as vers√µes e aliases associados a uma fun√ß√£o Lambda.
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### Invocar uma lambda

#### Manual
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### Atrav√©s de URL exposta

If an AWS Lambda function is publicly accessible via an exposed URL, it can be a potential security risk. Attackers can discover and exploit these exposed functions to gain unauthorized access to sensitive data or execute malicious code.

Se uma fun√ß√£o do AWS Lambda estiver publicamente acess√≠vel atrav√©s de uma URL exposta, isso pode representar um risco de seguran√ßa. Atacantes podem descobrir e explorar essas fun√ß√µes expostas para obter acesso n√£o autorizado a dados sens√≠veis ou executar c√≥digo malicioso.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### Chamar fun√ß√£o Lambda via URL

Agora √© hora de descobrir poss√≠veis fun√ß√µes lambda para executar:
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

Uma fun√ß√£o lambda chamada "Level6" est√° dispon√≠vel. Vamos descobrir como cham√°-la:
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
Agora que voc√™ sabe o nome e o ID, voc√™ pode obter o Nome:
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

E finalmente chame a fun√ß√£o acessando (observe que o ID, Nome e nome da fun√ß√£o aparecem na URL): [https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### Outros Gatilhos

Existem muitas outras fontes que podem acionar uma fun√ß√£o lambda

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### Privesc

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes do Lambda para escalar privil√©gios**:

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### Acesso n√£o autenticado

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### P√≥s-Explora√ß√£o

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### Persist√™ncia

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## Refer√™ncias

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
