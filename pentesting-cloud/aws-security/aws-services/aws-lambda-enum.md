# AWS - Lambda Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks** で **あなたの会社を宣伝**したい場合や、**PEASSの最新バージョンを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションを見つけましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**Telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしましょう。
* **HackTricks** と **HackTricks Cloud** の **GitHubリポジトリ** に **PRを提出**して、あなたのハッキングトリックを共有しましょう。

</details>

## Lambda

Amazon Web Services (AWS) Lambda は、**サーバーのプロビジョニングや管理なしでコードを実行**することができるコンピュートサービスです。Lambda は、コードの実行に必要なリソースを自動的に管理し、高可用性、スケーリング、セキュリティ機能を提供します。Lambda を使用すると、**消費したコンピュート時間のみを支払い**、前払い費用や長期の契約はありません。

Lambda を呼び出す方法は、**Cloudwatch** を使用して頻繁に呼び出すことができますし、**URL** エンドポイントを公開して呼び出すこともできます。また、**API Gateway** を介して呼び出すこともできますし、**S3** バケットのデータの変更や **DynamoDB** テーブルの更新などの **イベント** に基づいて呼び出すこともできます。

Lambda のコードは **`/var/task`** に保存されます。

### Lambda エイリアスの重み

Lambda には **複数のバージョン** を持つことができます。そして、**エイリアス** を介して **1つ以上のバージョン** を公開することができます。エイリアス内で公開された各バージョンの **重み** によって、**どのエイリアスが呼び出しを受けるかが決まります**（例えば、90% - 10% の割合である場合など）。もし、**エイリアスのうちの1つが脆弱性を持っている**場合、脆弱なバージョンが攻撃を受けるまでリクエストを送信することができます。

![](<../../../.gitbook/assets/image (16) (1).png>)

### リソースポリシー

Lambda リソースポリシーを使用すると、他のサービス/アカウントが Lambda を呼び出すことができるようにすることができます。例えば、次のようなポリシーを使用して、**URL** を介して公開された Lambda に **誰でもアクセスできるようにする**ことができます。

<figure><img src="https://lh4.googleusercontent.com/4PNFKBdzr3nMrPqeKkTslgwWDKxkXMdQ1SNdv7NPHykj3GX8wODrQyXOFbjk4fxHfZ8pDm5ijWgk2Vq2EGXiPRT3TQfZf1fHycvdEKBuDxJDYos1CJeMHXSeg86ZB-Ol7CNtten6xkVFQj6AhDUEWNQJrQ=s2048" alt=""><figcaption></figcaption></figure>

また、次のようなポリシーを使用して、API Gateway から呼び出すこともできます。

<figure><img src="https://lh3.googleusercontent.com/Su0JlR0wBqb-99Z4N_2-_kMlX0Xzx2n_GpZuOPW5IeXR3FYbm8OHFDM3Ora1BpXiSjHpDVUlq4yEyXwaI3nBuze6DJ-wRf2ATsCuWbq0wuBCd34E9uIpqwheE6Cc_PopviI_93O_j2ZKXc1-AJtsBoLVUw=s2048" alt=""><figcaption></figcaption></figure>

### Lambda データベースプロキシ

**数百もの同時 Lambda リクエスト**がある場合、それぞれのリクエストがデータベースに接続して接続を閉じる必要があると、うまくいかないことがあります（Lambda はステートレスであり、接続を維持することはできません）。そのため、Lambda 関数がデータベースインスタンスの代わりに RDS Proxy とやり取りする場合、Lambda 関数によって作成される多数の同時接続のスケーリングに必要な接続プーリングを処理します。これにより、Lambda アプリケーションは既存の接続を再利用することができます。新しい接続を毎回作成するのではなく。

### Lambda EFS ファイルシステム

データを保存し、共有するために、**Lambda は EFS にアクセスしてマウント**することができます。そのため、Lambda はそれから読み書きすることができます。

### Lambda レイヤー

Lambda レイヤーは、追加のコードやその他のコンテンツを含む .zip ファイルアーカイブです。レイヤーには、ライブラリ、[カスタムランタイム](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html)、データ、または設定ファイルを含めることができます。

1つの関数には最大で **5つのレイヤー** を含めることができます。レイヤーを関数に含めると、実行環境の `/opt` ディレクトリにコンテンツが展開されます。

デフォルトでは、作成したレイヤーは AWS アカウントに対して **プライベート** です。レイヤーを他のアカウントと共有するか、レイヤーを **パブリック** にするかを選択することができます。別のアカウントが公開したレイヤーを使用する場合、レイヤーバージョンが削除された後や、レイヤーへのアクセス許可が取り消された後でも、関数はレイヤーバージョンを引き続き使用することができます。ただし、削除されたレイヤーバージョンやアクセス許可が取り消されたレイヤーを使用して新しい関数を作成したり、関数を更新することはできません。

コンテナイメージとしてデプロイされた関数は、レイヤーを使用しません。代わりに、イメージをビルドする際に、好みのランタイム、ライブラリ、およびその他の依存関係をコンテナイメージにパッケージ化します。

### Lambda 拡張機能

Lambda 拡張機能を使用すると、関数を拡張することができます。たとえば、拡張機能を使用して、関数をモニタリング、観測、セキュリティ、ガバナンスツールに統合することができます。Lambda レイヤーを使用して .zip アーカイブ関数に拡張機能を追加したり、[コンテナイメージとしてデプロイされた関数](https://aws.amazon.com/blogs/compute/working-with-lambda-layers-and-extensions-in-container-images/)に含めたりすることができます。

*
### 列挙

Enumeration is the process of gathering information about a target system or network. It involves identifying and cataloging various resources, services, and configurations that are accessible or exposed. Enumeration is an essential step in the pentesting process as it helps in identifying potential vulnerabilities and attack vectors.

列挙は、対象のシステムやネットワークに関する情報を収集するプロセスです。アクセス可能または公開されているさまざまなリソース、サービス、および設定を特定し、カタログ化することを含みます。列挙は、潜在的な脆弱性や攻撃ベクトルを特定するために、ペンテストプロセスにおいて重要なステップです。
```bash
aws lambda get-account-settings

# List functions and get extra config info
aws lambda list-functions
aws lambda get-function --function-name <function_name>
aws lambda get-function-configuration --function-name <function_name>
aws lambda list-function-event-invoke-configs --function-name <function_name>
## Check for creds in env vars
aws lambda list-functions | jq '.Functions[].Environment'
## Download & check the source code
aws lambda get-function --function-name "<func_name>" --query 'Code.Location'
wget -O lambda-function.zip <url-from-previous-query>

# Get Lambda URL (if any)
aws lambda list-function-url-configs --function-name <function_name>
aws lambda get-function-url-config --function-name <function_name>

# Get who has permissions to invoke the Lambda
aws lambda get-policy --function-name <function_name>

# Versions and Aliases
aws lambda list-versions-by-function --function-name <func_name>
aws lambda list-aliases --function-name <func_name>

# List layers
aws lambda list-layers
aws lambda list-layer-versions --layer-name <name>
aws lambda get-layer-version --layer-name <name> --version-number <ver>
aws lambda get-layer-version-by-arn --arn <name> #Get external ARNs

# List other metadata
aws lambda list-event-source-mappings
aws lambda list-code-signing-configs
aws lambda list-functions-by-code-signing-config --code-signing-config-arn <arn>
```
### ラムダを呼び出す

#### 手動
```bash
# Invoke function
aws lambda invoke --function-name FUNCTION_NAME /tmp/out
## Some functions will expect parameters, they will access them with something like:
## target_policys = event['policy_names']
## user_name = event['user_name']
aws lambda invoke --function-name <name> --cli-binary-format raw-in-base64-out --payload '{"policy_names": ["AdministratorAccess], "user_name": "sdf"}' out.txt
```
#### 公開されたURLを介して

If an AWS Lambda function is exposed through a URL, it can be accessed by anyone who knows the URL. This can lead to unauthorized access and potential security risks. To identify if a Lambda function is exposed, you can perform the following steps:

1. Enumerate AWS Lambda functions using the AWS CLI or AWS Management Console.
2. Check if the Lambda function has an associated API Gateway or Application Load Balancer (ALB) endpoint.
3. Test the URL to see if it is accessible without any authentication or authorization.
4. If the Lambda function is accessible, it may be necessary to review the function's permissions and access controls to ensure proper security measures are in place.

By identifying and securing any exposed URLs, you can mitigate the risk of unauthorized access to your AWS Lambda functions.
```bash
aws lambda list-function-url-configs --function-name <function_name> #Get lambda URL
aws lambda get-function-url-config   --function-name <function_name> #Get lambda URL
```
#### URLを介してLambda関数を呼び出す

今度は実行可能なLambda関数を見つける時です。
```
aws --region us-west-2 --profile level6 lambda list-functions
```
![](<../../../.gitbook/assets/image (21) (1).png>)

"Level6"という名前のLambda関数が利用可能です。それを呼び出す方法を見つけましょう。
```bash
aws --region us-west-2 --profile level6 lambda get-policy --function-name Level6
```
![](<../../../.gitbook/assets/image (69).png>)

今、名前とIDを知っているので、名前を取得できます：
```bash
aws --profile level6 --region us-west-2 apigateway get-stages --rest-api-id "s33ppypa75"
```
![](<../../../.gitbook/assets/image (20).png>)

そして、関数を呼び出してください（URLにID、名前、関数名が表示されることに注意してください）：[https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6](https://s33ppypa75.execute-api.us-west-2.amazonaws.com/Prod/level6)

`URL:`**`https://<rest-api-id>.execute-api.<region>.amazonaws.com/<stageName>/<funcName>`**

#### その他のトリガー

Lambdaをトリガーするための他のソースがたくさんあります

<figure><img src="../../../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

### 特権昇格

次のページでは、Lambdaの権限を悪用して特権を昇格させる方法を確認できます：

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md" %}
[aws-lambda-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-lambda-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md" %}
[aws-lambda-unauthenticated-access.md](../aws-unauthenticated-enum-access/aws-lambda-unauthenticated-access.md)
{% endcontent-ref %}

### 攻撃後の利用

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/" %}
[aws-lambda-post-exploitation](../../aws-pentesting/aws-post-exploitation/aws-lambda-post-exploitation/)
{% endcontent-ref %}

### 永続化

{% content-ref url="../../aws-pentesting/aws-persistence/aws-lambda-persistence/" %}
[aws-lambda-persistence](../../aws-pentesting/aws-persistence/aws-lambda-persistence/)
{% endcontent-ref %}

## 参考文献

* [https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer](https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-concepts.html#gettingstarted-concepts-layer)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
