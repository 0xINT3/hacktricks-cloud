# Cognito User Pools

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬** [**Discordグループ**](https://discord.gg/hRep4RUj7f)**または**[**telegramグループ**](https://t.me/peass)**に参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)で**フォロー**する
* **ハッキングトリックを共有するには、**[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## 基本情報

ユーザープールはAmazon Cognitoのユーザーディレクトリです。ユーザープールを使用すると、ユーザーはAmazon Cognitoを介してWebアプリやモバイルアプリに**サインイン**したり、**サードパーティ**のIDプロバイダを介して**フェデレーション**したりできます。ユーザーが直接サインインするか、サードパーティを介してサインインするかに関係なく、ユーザープールのすべてのメンバーには、SDKを介してアクセスできるディレクトリプロファイルがあります。

ユーザープールは以下を提供します：

* サインアップおよびサインインサービス
* ユーザーのサインインのための組み込み可能なカスタマイズ可能なWeb UI
* Facebook、Google、Amazonログイン、Appleサインイン、およびSAMLおよびOIDC IDプロバイダを介したソーシャルサインイン、およびユーザープールからのユーザーディレクトリ管理とユーザープロファイル
* マルチファクタ認証（MFA）、侵害された資格情報のチェック、アカウント乗っ取り保護、電話およびメールの確認などのセキュリティ機能
* AWS Lambdaトリガーを介したカスタマイズされたワークフローとユーザーマイグレーション

アプリケーションの**ソースコード**には通常、**ユーザープールID**と**クライアントアプリケーションID**（そして**アプリケーションシークレット**？）も含まれており、これらはCognitoユーザープールに**ログイン**するために必要です。

### 潜在的な攻撃

* **登録**: ユーザーはデフォルトで自分自身を登録できるため、自分自身のユーザーを作成できます。
* **ユーザー列挙**: 登録機能を使用して既に存在するユーザー名を見つけることができます。この情報はブルートフォース攻撃に役立ちます。
* **ログインブルートフォース**: [**認証**](cognito-user-pools.md#authentication)セクションには、ユーザーが**ログイン**するための**方法**がすべて記載されています。これらをブルートフォースして**有効な資格情報を見つける**ことができます。

### ペンテストツール

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)は、AWSの脆弱性フレームワークで、アカウント内のすべてのCognitoアセットの列挙を自動化し、弱い構成、アクセス制御に使用されるユーザー属性などをフラグ付けし、MFAサポートを含むユーザー作成と、変更可能なカスタム属性に基づく特権昇格、使用可能なアイデンティティプール資格情報、IDトークン内の仮定可能なロールなどを自動化します。

モジュールの機能の説明については、[ブログ記事](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)の第2部を参照してください。インストール手順については、メインの[Pacu](https://github.com/RhinoSecurityLabs/pacu)ページを参照してください。

#### 使用法

指定されたアイデンティティプールとユーザープールクライアントに対してユーザー作成とすべての特権昇格ベクトルを試行するためのcognito\_\_attackのサンプル使用法:

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

以下は、現在のAWSアカウントで表示されるすべてのユーザープール、ユーザープールクライアント、アイデンティティプール、ユーザーなどを収集するためのcognito\_\_enumのサンプル使用方法です：

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner)は、Cognitoに対するさまざまな攻撃を実装したPythonのCLIツールであり、望ましくないアカウントの作成やアカウントオラクルを含んでいます。

#### インストール

```bash
$ pip install cognito-scanner
```

#### 使用法

```bash
$ cognito-scanner --help
```

詳細については、https://github.com/padok-team/cognito-scanner を参照してください。

## 登録

ユーザープールは、**デフォルト**で**新しいユーザーを登録**することができます。

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### 誰でも登録できる場合

ユーザーに関する**詳細情報を提供する必要がある**というエラーが表示される可能性があります。

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

必要な詳細は、次のようなJSONで提供できます：

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

あなたはこの機能を使用して、既存のユーザーを列挙することもできます。これは、その名前で既に存在するユーザーがいる場合のエラーメッセージです：

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
前のコマンドで**カスタム属性が "custom:" で始まる**ことに注目してください。\
また、登録時には**ユーザーの新しいカスタム属性を作成することはできない**ことを知っておいてください。**デフォルト属性**（必須でなくても）と**指定されたカスタム属性**にのみ値を設定できます。
{% endhint %}

または、クライアントIDが存在するかどうかをテストするだけです。クライアントIDが存在しない場合のエラーは次のとおりです：

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### もし管理者だけがユーザーを登録できる場合

このエラーが見つかり、ユーザーを登録したり列挙したりすることができなくなります：

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### 登録の検証

Cognitoでは、**新しいユーザーを電子メールまたは電話番号で検証**することができます。したがって、通常、ユーザーを作成する際には、少なくともユーザー名とパスワード、**電子メールと/または電話番号**が必要になります。**コントロールできる**ものを1つ設定して、**新しく作成したユーザーアカウント**の検証コードを受け取るようにしてください。

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
同じメールアドレスや電話番号を使用できるように見える場合でも、作成したユーザーを検証する必要があるときには、Cognitoは同じ情報を使用することについて文句を言い、アカウントの検証を許可しません。
{% endhint %}

### 特権昇格 / 属性の更新

デフォルトでは、ユーザーは次のような方法で属性の値を変更できます：

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### カスタム属性の権限昇格

{% hint style="danger" %}
デフォルトでは**isAdmin**などの**カスタム属性**が使用されている場合があります。自分自身の属性の値を変更できるため、値を変更することで**権限を昇格**することができるかもしれません！
{% endhint %}

#### メール/ユーザー名の変更による権限昇格

ユーザーの**メールアドレスと電話番号を変更**できますが、アカウントが検証済みのままでも、これらの属性は**未検証の状態に設定**されます（再度検証する必要があります）。

{% hint style="warning" %}
メールアドレスや電話番号が検証されるまで、**メールアドレスや電話番号でログインすることはできません**が、**ユーザー名でログインすることはできます**。\
メールアドレスが変更されて検証されていない場合でも、IDトークン内の\*\*`email`\*\* **フィールド**に表示され、**`email_verified`** フィールドは**false**になりますが、アプリが**それを確認していない場合、他のユーザーになりすます**ことができます。

さらに、**`name`** フィールドには単純に**名前属性を変更するだけで何でも入力**できます。アプリが\*\*`email`\*\*（または他の属性）ではなく、**そのフィールドを確認している場合、他のユーザーになりすます**ことができるかもしれません。
{% endhint %}

とにかく、たとえば新しいメールアドレスに自分のメールアドレスを変更した場合でも、そのメールアドレスで受信したコードでメールアドレスを**確認**できます：

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

\*\*`email`**の代わりに**`phone_number`\*\*を使用して、**新しい電話番号**を変更/確認します。

{% hint style="info" %}
管理者は、**ユーザーが選択したユーザー名でログイン**するオプションを有効にすることもできます。既に使用されている**任意のユーザー名またはpreferred\_username**にこの値を変更できないことに注意してください。これにより、異なるユーザーをなりすますことができます。
{% endhint %}

### パスワードの回復/変更

**ユーザー名**（または電子メールまたは電話番号が受け入れられます）を知っているだけで、パスワードを回復することが可能で、コードがそこに送信されます。

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
サーバーの応答は常に肯定的であり、ユーザー名が存在するかのようになります。この方法を使用してユーザーを列挙することはできません。
{% endhint %}

コードを使用してパスワードを変更できます：

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

パスワードを変更するには、**以前のパスワードを知っている必要があります**：

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## 認証

ユーザープールは、それに対して**異なる認証方法**をサポートしています。**ユーザー名とパスワード**を持っている場合、**ログインするためにサポートされている異なる方法**もあります。\
さらに、ユーザーがプールで認証されると、**3種類のトークン**が与えられます: **IDトークン**、**アクセストークン**、および**リフレッシュトークン**。

* [**IDトークン**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): 認証されたユーザーの**アイデンティティに関するクレーム**（`name`、`email`、`phone_number`など）が含まれています。IDトークンは、ユーザーを**リソースサーバーやサーバーアプリケーションに認証する**ためにも使用できます。外部アプリケーションで使用する場合は、IDトークンの**署名を検証**する必要があります。
* IDトークンは、ユーザーの属性値を**含むトークン**です。カスタム属性も含まれます。
* [**アクセストークン**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): 認証されたユーザーに関するクレーム、**ユーザーのグループのリスト、およびスコープのリスト**が含まれています。アクセストークンの目的は、ユーザープール内のユーザーのコンテキストで**API操作を承認**することです。たとえば、アクセストークンを使用して、ユーザーにユーザー属性の追加、変更、削除の**アクセス権を付与**できます。
* [**リフレッシュトークン**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): リフレッシュトークンを使用すると、**リフレッシュトークンが無効になるまで**ユーザーのために新しいIDトークンとアクセストークンを取得できます。**デフォルトでは**、リフレッシュトークンは、アプリケーションユーザーがユーザープールにサインインしてから**30日後に期限切れ**になります。ユーザープール用のアプリケーションを作成するときに、アプリケーションのリフレッシュトークンの有効期限を**60分から10年の間の任意の値**に設定できます。

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

これはサーバーサイドの認証フローです:

* サーバーサイドアプリは\*\*`AdminInitiateAuth` API操作\*\*（`InitiateAuth`の代わりに）を呼び出します。この操作には、\*\*`cognito-idp:AdminInitiateAuth`**と**`cognito-idp:AdminRespondToAuthChallenge`\*\*を含む権限を持つAWS資格情報が必要です。この操作は必要な認証パラメータを返します。
* サーバーサイドアプリが**認証パラメータを取得した後**、**`AdminRespondToAuthChallenge` API操作**を呼び出します。`AdminRespondToAuthChallenge` API操作は、AWS資格情報を提供するときのみ成功します。

この**方法はデフォルトで有効ではありません**。

**ログイン**するには、以下が必要です:

* ユーザープールID
* クライアントID
* ユーザー名
* パスワード
* クライアントシークレット（アプリがシークレットを使用するように構成されている場合のみ）

{% hint style="info" %}
この方法で**ログインできるようにするには**、そのアプリケーションが`ALLOW_ADMIN_USER_PASSWORD_AUTH`でログインを許可する必要があります。\
さらに、この操作を実行するには、\*\*`cognito-idp:AdminInitiateAuth`**および**`cognito-idp:AdminRespondToAuthChallenge`\*\*の権限を持つ資格情報が必要です。
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>ログインするためのコード</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### USER\_PASSWORD\_AUTH

この方法は、別のシンプルで**伝統的なユーザー＆パスワード認証**フローです。**伝統的な**認証方法を**Cognitoに移行**し、その後**無効にして**代わりに**ALLOW\_USER\_SRP\_AUTH**方法を使用することが推奨されています（パスワードをネットワーク経由で送信しないため）。\
この**方法はデフォルトで有効になっていません**。

コード内の**前の認証方法**との主な**違い**は、**ユーザープールIDを知る必要がない**ことと、**Cognitoユーザープールで追加の権限が必要ない**ことです。

**ログイン**するには、以下が必要です：

- クライアントID
- ユーザー名
- パスワード
- クライアントシークレット（アプリがシークレットを使用するように構成されている場合のみ）

<div data-gb-custom-block data-tag="hint" data-style='info'>

この方法で**ログインできるようにするには**、そのアプリケーションがALLOW\_USER\_PASSWORD\_AUTHでログインを許可する必要があります。

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

この**メソッドは常に有効**です（無効にすることはできません）が、有効なリフレッシュトークンが必要です。

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
