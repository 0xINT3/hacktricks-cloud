# Pools d'utilisateurs Cognito

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

Un pool d'utilisateurs est un annuaire d'utilisateurs dans Amazon Cognito. Avec un pool d'utilisateurs, vos utilisateurs peuvent **se connecter √† votre application Web ou mobile** via Amazon Cognito, **ou f√©d√©rer** via un fournisseur d'identit√© tiers (IdP). Que vos utilisateurs se connectent directement ou via un tiers, tous les membres du pool d'utilisateurs ont un profil de r√©pertoire que vous pouvez acc√©der via un SDK.

Les pools d'utilisateurs fournissent :

* Des services d'inscription et de connexion.
* Une interface utilisateur Web int√©gr√©e et personnalisable pour connecter les utilisateurs.
* Connexion sociale avec Facebook, Google, Login with Amazon et Sign in with Apple, et via des fournisseurs d'identit√© SAML et OIDC de votre pool d'utilisateurs.
* Gestion de l'annuaire des utilisateurs et des profils d'utilisateurs.
* Des fonctionnalit√©s de s√©curit√© telles que l'authentification multi-facteurs (MFA), les v√©rifications des informations d'identification compromises, la protection contre la prise de contr√¥le de compte et la v√©rification par t√©l√©phone et par e-mail.
* Des flux de travail personnalis√©s et une migration d'utilisateurs via des d√©clencheurs AWS Lambda.

Le **code source** des applications contiendra g√©n√©ralement √©galement l'**ID du pool d'utilisateurs** et l'**ID de l'application cliente**, (et parfois le **secret de l'application** ?) qui sont n√©cessaires pour qu'un **utilisateur se connecte** √† un pool d'utilisateurs Cognito.

### Attaques potentielles

* **Inscription** : Par d√©faut, un utilisateur peut s'inscrire lui-m√™me, il pourrait donc cr√©er un utilisateur pour lui-m√™me.
* **√ânum√©ration des utilisateurs** : La fonctionnalit√© d'inscription peut √™tre utilis√©e pour trouver des noms d'utilisateur qui existent d√©j√†. Cette information peut √™tre utile pour l'attaque de force brute.
* **Force brute de connexion** : Dans la section [**Authentification**](cognito-user-pools.md#authentication), vous avez toutes les **m√©thodes** qu'un utilisateur doit **utiliser pour se connecter**, vous pouvez essayer de les forcer pour **trouver des informations d'identification valides**.

## Inscription

Les pools d'utilisateurs permettent par **d√©faut** de **s'inscrire de nouveaux utilisateurs**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
    --username <username> --password <password> \
    --region <region> --no-sign-request
```

#### Si tout le monde peut s'inscrire

Vous pourriez trouver une erreur vous indiquant que vous devez **fournir plus de d√©tails** sur l'utilisateur :

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Vous pouvez fournir les d√©tails n√©cessaires avec un JSON tel que :

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Vous pouvez √©galement utiliser cette fonctionnalit√© pour **√©num√©rer les utilisateurs existants**. Voici le message d'erreur lorsqu'un utilisateur existe d√©j√† avec ce nom :

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Notez dans la commande pr√©c√©dente comment les **attributs personnalis√©s commencent par "custom:"**.\
Sachez √©galement que lors de l'inscription, vous **ne pouvez pas cr√©er de nouveaux attributs personnalis√©s pour l'utilisateur**. Vous ne pouvez donner de la valeur qu'aux **attributs par d√©faut** (m√™me s'ils ne sont pas obligatoires) et aux **attributs personnalis√©s sp√©cifi√©s**.
{% endhint %}

Ou simplement pour tester si un ID de client existe. Voici l'erreur si l'ID de client n'existe pas :

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Si seul l'administrateur peut inscrire des utilisateurs

Vous trouverez cette erreur et vous ne pourrez pas inscrire ou √©num√©rer des utilisateurs :

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### V√©rification de l'inscription

Cognito permet de **v√©rifier un nouvel utilisateur en v√©rifiant son e-mail ou son num√©ro de t√©l√©phone**. Par cons√©quent, lors de la cr√©ation d'un utilisateur, vous devrez g√©n√©ralement fournir au moins le nom d'utilisateur et le mot de passe et l'**adresse e-mail et/ou le num√©ro de t√©l√©phone**. Il suffit de d√©finir un **que vous contr√¥lez** pour recevoir le code de v√©rification de votre **nouveau compte utilisateur** comme ceci :

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
    --username aasdasd2 --confirmation-code <conf_code> \
    --no-sign-request --region us-east-1
```

{% hint style="warning" %}
M√™me si **il semble que vous pouvez utiliser le m√™me e-mail** et le m√™me num√©ro de t√©l√©phone, lorsque vous devez v√©rifier l'utilisateur cr√©√©, Cognito se plaindra d'utiliser les m√™mes informations et **ne vous permettra pas de v√©rifier le compte**.
{% endhint %}

### √âl√©vation de privil√®ges / Mise √† jour des attributs

Par d√©faut, un utilisateur peut **modifier la valeur de ses attributs** avec quelque chose comme :

```bash
aws cognito-idp update-user-attributes \
    --region us-east-1 --no-sign-request \
    --user-attributes Name=address,Value=street \
    --access-token <access token>
```

#### √âl√©vation de privil√®ges d'attribut personnalis√©

{% hint style="danger" %}
Vous pourriez trouver des **attributs personnalis√©s** utilis√©s (comme `isAdmin`), par d√©faut, vous pouvez **changer les valeurs de vos propres attributs** et vous pourriez √™tre en mesure d'**√©lever les privil√®ges** en changeant la valeur vous-m√™me !
{% endhint %}

#### √âl√©vation de privil√®ges de modification d'e-mail/nom d'utilisateur

Vous pouvez utiliser ceci pour **modifier l'e-mail et le num√©ro de t√©l√©phone** d'un utilisateur, mais alors, m√™me si le compte reste v√©rifi√©, ces attributs sont **d√©finis en statut non v√©rifi√©** (vous devez les v√©rifier √† nouveau).

{% hint style="warning" %}
## Authentification

Un pool d'utilisateurs prend en charge **diff√©rentes m√©thodes d'authentification**. Si vous avez un **nom d'utilisateur et un mot de passe**, il existe √©galement **diff√©rentes m√©thodes** prises en charge pour se connecter.\
De plus, lorsqu'un utilisateur est authentifi√© dans le pool, **3 types de jetons sont donn√©s** : le **jeton ID**, le **jeton d'acc√®s** et le **jeton de rafra√Æchissement**.

* [**Jeton ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html) : Il contient des informations sur **l'identit√© de l'utilisateur authentifi√©**, telles que `nom`, `e-mail` et `num√©ro de t√©l√©phone`. Le jeton ID peut √©galement √™tre utilis√© pour **authentifier les utilisateurs aupr√®s de vos serveurs de ressources ou de vos applications serveurs**. Vous devez **v√©rifier** la **signature** du jeton ID avant de pouvoir faire confiance √† toutes les revendications √† l'int√©rieur du jeton ID si vous l'utilisez dans des applications externes.
  * Le jeton ID est le jeton qui **contient les valeurs des attributs de l'utilisateur**, m√™me les attributs personnalis√©s.
* [**Jeton d'acc√®s**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html) : Il contient des informations sur l'utilisateur authentifi√©, une liste des **groupes de l'utilisateur et une liste des √©tendues**. Le but du jeton d'acc√®s est d'**autoriser les op√©rations API** dans le contexte de l'utilisateur dans le pool d'utilisateurs. Par exemple, vous pouvez utiliser le jeton d'acc√®s pour **accorder √† votre utilisateur l'acc√®s** pour ajouter, modifier ou supprimer des attributs d'utilisateur.
* [**Jeton de rafra√Æchissement**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html) : Avec les jetons de rafra√Æchissement, vous pouvez **obtenir de nouveaux jetons ID et d'acc√®s** pour l'utilisateur jusqu'√† ce que le **jeton de rafra√Æchissement soit invalide**. Par **d√©faut**, le jeton de rafra√Æchissement **expire 30 jours apr√®s** que l'utilisateur de votre application se soit connect√© √† votre pool d'utilisateurs. Lorsque vous cr√©ez une application pour votre pool d'utilisateurs, vous pouvez d√©finir l'expiration du jeton de rafra√Æchissement de l'application sur **n'importe quelle valeur entre 60 minutes et 10 ans**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Il s'agit du flux d'authentification c√¥t√© serveur :

* L'application c√¥t√© serveur appelle l'op√©ration API **`AdminInitiateAuth`** (au lieu de `InitiateAuth`). Cette op√©ration n√©cessite des informations d'identification AWS avec des autorisations qui incluent **`cognito-idp:AdminInitiateAuth`** et **`cognito-idp:AdminRespondToAuthChallenge`**. L'op√©ration renvoie les param√®tres d'authentification requis.
* Apr√®s que l'application c√¥t√© serveur ait les **param√®tres d'authentification**, elle appelle l'op√©ration API **`AdminRespondToAuthChallenge`**. L'op√©ration `AdminRespondToAuthChallenge` API ne r√©ussit que lorsque vous fournissez des informations d'identification AWS.

Cette **m√©thode n'est PAS activ√©e** par d√©faut.

Pour **se connecter**, vous devez conna√Ætre :

* l'ID du pool d'utilisateurs
* l'ID du client
* le nom d'utilisateur
* le mot de passe
* le secret client (uniquement si l'application est configur√©e pour utiliser un secret)

{% hint style="info" %}
Afin de pouvoir **se connecter avec cette m√©thode**, l'application doit permettre de se connecter avec `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
De plus, pour effectuer cette action, vous avez besoin d'informations d'identification avec les autorisations **`cognito-idp:AdminInitiateAuth`** et **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
    --client-id <client-id> \
    --auth-flow ADMIN_USER_PASSWORD_AUTH \
    --region <region> \
    --auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
    --user-pool-id "<pool-id>"

# V√©rifiez le code Python pour apprendre √† g√©n√©rer le hsecret_hash
```

<details>

<summary>Code pour se connecter</summary>

```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
    key = bytes(client_secret, 'utf-8')
    message = bytes(f'{username}{client_id}', 'utf-8')
    return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# Si l'application cliente n'est pas configur√©e pour utiliser un secret
## supprimez simplement la ligne d√©finissant SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
    try:
        return boto_client.admin_initiate_auth(
            UserPoolId=user_pool_id,
            ClientId=client_id,
            AuthFlow='ADMIN_USER_PASSWORD_AUTH',
            AuthParameters={
                'USERNAME': username_or_alias,
                'PASSWORD': password,
                'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
            }
        )
    except botocore.exceptions.ClientError as e:
        return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```

</details>

### USER\_PASSWORD\_AUTH

Cette m√©thode est un autre flux d'authentification simple et **traditionnel nom d'utilisateur & mot de passe**. Il est recommand√© de **migrer une m√©thode d'authentification traditionnelle** vers Cognito, puis de **la d√©sactiver** et d'utiliser ensuite la m√©thode **ALLOW\_USER\_SRP\_AUTH** √† la place (car elle ne transmet jamais le mot de passe sur le r√©seau).\
Cette **m√©thode n'est PAS activ√©e** par d√©faut.

La principale **diff√©rence** avec la **m√©thode d'authentification pr√©c√©dente** dans le code est que vous **n'avez pas besoin de conna√Ætre l'ID du pool d'utilisateurs** et que vous **n'avez pas besoin de permissions
## R√¥les IAM des groupes de pool d'utilisateurs

Il est possible d'ajouter des **utilisateurs √† des groupes de pool d'utilisateurs** qui sont li√©s √† un **r√¥le IAM**.\
De plus, les **utilisateurs** peuvent √™tre assign√©s √† **plus d'un groupe avec des r√¥les IAM diff√©rents** attach√©s.

Notez que m√™me si un groupe est √† l'int√©rieur d'un groupe avec un r√¥le IAM attach√©, pour pouvoir acc√©der aux informations d'identification IAM de ce groupe, il est n√©cessaire que le **pool d'utilisateurs soit approuv√© par un pool d'identit√©s** (et conna√Ætre les d√©tails de ce pool d'identit√©s).

Une autre condition pour obtenir le **r√¥le IAM indiqu√© dans l'IdToken** lorsqu'un utilisateur est authentifi√© dans le pool d'utilisateurs (`aws cognito-idp initiate-auth...`) est que le **fournisseur d'authentification d'identit√©** doit indiquer que le **r√¥le doit √™tre s√©lectionn√© √† partir du jeton.**

<figure><img src="../../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Les **r√¥les** auxquels un utilisateur a acc√®s sont **dans l'`IdToken`**, et un utilisateur peut **s√©lectionner le r√¥le pour lequel il souhaite obtenir des informations d'identification** avec le **`--custom-role-arn`** de `aws cognito-identity get-credentials-for-identity`.\
Cependant, si l'**option par d√©faut** est celle **configur√©e** (`use default role`), et que vous essayez d'acc√©der √† un r√¥le √† partir de l'IdToken, vous obtiendrez une **erreur** (c'est pourquoi la configuration pr√©c√©dente est n√©cessaire) :

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Notez que le r√¥le assign√© √† un **groupe de pool d'utilisateurs** doit √™tre **accessible par le fournisseur d'identit√©** qui **approuve le pool d'utilisateurs** (car les **informations d'identification de session du r√¥le IAM vont √™tre obtenues √† partir de celui-ci**).
{% endhint %}

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "cognito-identity.amazonaws.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "authenticated"
                }
            }
        }
    ]
}js
```

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ **le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>