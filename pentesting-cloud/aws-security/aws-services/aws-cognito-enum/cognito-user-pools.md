# Cognito User Pools

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informazioni di base

Un pool di utenti √® una directory utenti in Amazon Cognito. Con un pool di utenti, i tuoi utenti possono **accedere alla tua app web o mobile** tramite Amazon Cognito, **o federarsi** attraverso un **provider di identit√† di terze parti** (IdP). Che i tuoi utenti accedano direttamente o tramite un terzo, tutti i membri del pool di utenti hanno un profilo di directory a cui puoi accedere tramite un SDK.

I pool di utenti forniscono:

* Servizi di registrazione e accesso.
* Un'interfaccia utente web integrata e personalizzabile per l'accesso degli utenti.
* Accesso tramite social network come Facebook, Google, Login with Amazon e Sign in with Apple, e tramite provider di identit√† SAML e OIDC dal tuo pool di utenti.
* Gestione della directory utenti e dei profili utente.
* Funzionalit√† di sicurezza come l'autenticazione multifattore (MFA), controlli per le credenziali compromesse, protezione dal furto di account e verifica tramite telefono ed email.
* Flussi di lavoro personalizzati e migrazione degli utenti tramite trigger AWS Lambda.

Il **codice sorgente** delle applicazioni di solito contiene anche l'**ID del pool di utenti** e l'**ID dell'applicazione client**, (e talvolta il **segreto dell'applicazione**?) che sono necessari per il **login di un utente** in un pool di utenti Cognito.

### Potenziali attacchi

* **Registrazione**: Di default un utente pu√≤ registrarsi da solo, quindi potrebbe creare un utente per se stesso.
* **Enumerazione utenti**: La funzionalit√† di registrazione pu√≤ essere utilizzata per trovare nomi utente che esistono gi√†. Queste informazioni possono essere utili per l'attacco di forza bruta.
* **Forza bruta di accesso**: Nella sezione [**Autenticazione**](cognito-user-pools.md#authentication) hai tutti i **metodi** che un utente deve utilizzare per **accedere**, potresti provare a forzarli per **trovare credenziali valide**.

### Strumenti per il pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), il framework di sfruttamento di AWS, include ora i moduli "cognito\_\_enum" e "cognito\_\_attack" che automatizzano l'enumerazione di tutti gli asset Cognito in un account e segnalano configurazioni deboli, attributi utente utilizzati per il controllo degli accessi, ecc., e automatizzano anche la creazione di utenti (incluso il supporto MFA) e l'escalation dei privilegi basata su attributi personalizzabili modificabili, credenziali di pool di identit√† utilizzabili, ruoli assumibili nei token di identit√†, ecc.

Per una descrizione delle funzioni dei moduli, consulta la parte 2 del [post del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Per le istruzioni di installazione, consulta la pagina principale di [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Utilizzo

Esempio di utilizzo di cognito\_\_attack per tentare la creazione di utenti e tutti i vettori di escalation dei privilegi su un determinato pool di identit√† e client del pool di utenti:

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

Esempio di utilizzo di cognito\_\_enum per raccogliere tutti i pool di utenti, i client dei pool di utenti, i pool di identit√†, gli utenti, ecc. visibili nell'account AWS corrente:

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) √® un tool CLI in python che implementa diversi attacchi su Cognito, inclusa la creazione indesiderata di account e l'account oracle.

#### Installazione

```bash
$ pip install cognito-scanner
```

#### Utilizzo

#### Enumerate User Pools

#### Enumerazione dei Pool di Utenti

To enumerate user pools, you can use the `aws cognito-idp list-user-pools` command. This command will list all the user pools in the specified AWS account.

Per enumerare i pool di utenti, √® possibile utilizzare il comando `aws cognito-idp list-user-pools`. Questo comando elencher√† tutti i pool di utenti nell'account AWS specificato.

```plaintext
aws cognito-idp list-user-pools --max-results <max_results> --region <region>
```

Replace `<max_results>` with the maximum number of results you want to retrieve (default is 60) and `<region>` with the AWS region where the user pools are located.

Sostituisci `<max_results>` con il numero massimo di risultati che desideri recuperare (il valore predefinito √® 60) e `<region>` con la regione AWS in cui si trovano i pool di utenti.

#### Enumerate Users in a User Pool

#### Enumerazione degli Utenti in un Pool di Utenti

To enumerate the users in a specific user pool, you can use the `aws cognito-idp list-users` command. This command will list all the users in the specified user pool.

Per enumerare gli utenti in un pool di utenti specifico, √® possibile utilizzare il comando `aws cognito-idp list-users`. Questo comando elencher√† tutti gli utenti nel pool di utenti specificato.

```plaintext
aws cognito-idp list-users --user-pool-id <user_pool_id> --region <region>
```

Replace `<user_pool_id>` with the ID of the user pool you want to enumerate and `<region>` with the AWS region where the user pool is located.

Sostituisci `<user_pool_id>` con l'ID del pool di utenti che desideri enumerare e `<region>` con la regione AWS in cui si trova il pool di utenti.

#### Enumerate User Attributes

#### Enumerazione degli Attributi degli Utenti

To enumerate the attributes of a specific user in a user pool, you can use the `aws cognito-idp admin-get-user` command. This command will retrieve the user's attributes.

Per enumerare gli attributi di un utente specifico in un pool di utenti, √® possibile utilizzare il comando `aws cognito-idp admin-get-user`. Questo comando recuperer√† gli attributi dell'utente.

```plaintext
aws cognito-idp admin-get-user --user-pool-id <user_pool_id> --username <username> --region <region>
```

Replace `<user_pool_id>` with the ID of the user pool, `<username>` with the username of the user, and `<region>` with the AWS region where the user pool is located.

Sostituisci `<user_pool_id>` con l'ID del pool di utenti, `<username>` con il nome utente dell'utente e `<region>` con la regione AWS in cui si trova il pool di utenti.

```bash
$ cognito-scanner --help
```

Per ulteriori informazioni, visita https://github.com/padok-team/cognito-scanner

## Registrazione

Per impostazione predefinita, User Pools consente di registrare nuovi utenti.

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### Se chiunque pu√≤ registrarsi

Potresti trovare un errore che ti indica che devi **fornire ulteriori dettagli** sull'utente:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Puoi fornire i dettagli necessari con un JSON come:

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Puoi utilizzare questa funzionalit√† anche per **enumerare gli utenti esistenti**. Questo √® il messaggio di errore quando esiste gi√† un utente con quel nome:

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Nota nel comando precedente come gli **attributi personalizzati iniziano con "custom:"**.\
Sappi anche che durante la registrazione **non puoi creare nuovi attributi personalizzati** per l'utente. Puoi solo assegnare un valore agli **attributi predefiniti** (anche se non sono obbligatori) e agli **attributi personalizzati specificati**.
{% endhint %}

Oppure puoi semplicemente testare se esiste un client id. Questo √® l'errore se il client-id non esiste:

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Se solo l'amministratore pu√≤ registrare gli utenti

Riscontrerai questo errore e non sarai in grado di registrare o enumerare gli utenti:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### Verifica della registrazione

Cognito consente di **verificare un nuovo utente verificando la sua email o il suo numero di telefono**. Pertanto, quando si crea un utente, di solito sar√† richiesto almeno il nome utente e la password e l'**email e/o il numero di telefono**. Basta impostare uno **che controlli** in modo da poter ricevere il codice per **verificare il tuo** account utente appena creato come segue:

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
Anche se sembra che tu possa utilizzare la stessa email e lo stesso numero di telefono, quando devi verificare l'utente creato, Cognito si lamenter√† dell'utilizzo delle stesse informazioni e non ti permetter√† di verificare l'account.
{% endhint %}

### Escalatione dei privilegi / Aggiornamento degli attributi

Di default, un utente pu√≤ **modificare il valore dei suoi attributi** con qualcosa del genere:

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### Privesc dell'attributo personalizzato

{% hint style="danger" %}
Potresti trovare **attributi personalizzati** in uso (come ad esempio `isAdmin`), poich√© di default puoi **cambiare i valori dei tuoi attributi**, potresti essere in grado di **aumentare i privilegi** cambiando il valore tu stesso!
{% endhint %}

#### Privesc della modifica dell'email/nome utente

Puoi utilizzare questo per **modificare l'email e il numero di telefono** di un utente, ma poi, anche se l'account rimane verificato, quegli attributi sono **impostati come non verificati** (devi verificare nuovamente).

{% hint style="warning" %}
**Non sarai in grado di effettuare il login con l'email o il numero di telefono** fino a quando non li verifichi, ma sarai **in grado di effettuare il login con il nome utente**.\
Nota che anche se l'email √® stata modificata e non verificata, apparir√† nel token ID nel campo **`email`** e il campo **`email_verified`** sar√† **falso**, ma se l'app **non controlla** quel campo per qualche motivo **invece dell'email** (o di qualsiasi altro attributo), potresti impersonare altri utenti.

Inoltre, nota che puoi inserire qualsiasi cosa nel campo **`name`** semplicemente modificando l'**attributo del nome**. Se un'app sta **controllando** quel campo per qualche motivo **invece dell'email** (o di qualsiasi altro attributo), potresti essere in grado di **impersonare altri utenti**.
{% endhint %}

Comunque, se per qualche motivo hai cambiato la tua email ad esempio con una nuova a cui puoi accedere, puoi **confermare l'email con il codice che hai ricevuto in quell'indirizzo email**:

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

Usa **`phone_number`** invece di **`email`** per cambiare/verificare un **nuovo numero di telefono**.

{% hint style="info" %}
L'amministratore potrebbe anche abilitare l'opzione per **effettuare l'accesso con un nome utente preferito dall'utente**. Nota che non sarai in grado di cambiare questo valore in **qualsiasi nome utente o preferred\_username gi√† in uso** per impersonare un utente diverso.
{% endhint %}

### Recupero/Cambio Password

√à possibile recuperare una password conoscendo solo il nome utente (o l'email o il numero di telefono sono accettati) e avendo accesso ad esso poich√© verr√† inviato un codice l√¨:

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
La risposta del server sar√† sempre positiva, come se l'username esistesse. Non √® possibile utilizzare questo metodo per enumerare gli utenti.
{% endhint %}

Con il codice puoi cambiare la password con:

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

Per cambiare la password √® necessario **conoscere la password precedente**:

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## Autenticazione

Un pool di utenti supporta **diversi metodi di autenticazione**. Se hai un **nome utente e una password**, ci sono anche **diversi metodi** supportati per effettuare il login.\
Inoltre, quando un utente viene autenticato nel pool, vengono forniti **3 tipi di token**: il **token ID**, il **token di accesso** e il **token di aggiornamento**.

* [**Token ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Contiene informazioni sull'**identit√† dell'utente autenticato**, come `nome`, `email` e `numero di telefono`. Il token ID pu√≤ anche essere utilizzato per **autenticare gli utenti ai tuoi server di risorse o alle applicazioni server**. Devi **verificare** la **firma** del token ID prima di poter fidarti di qualsiasi informazione contenuta al suo interno se lo usi in applicazioni esterne.
* Il token ID √® il token che **contiene i valori degli attributi dell'utente**, anche quelli personalizzati.
* [**Token di accesso**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Contiene informazioni sull'utente autenticato, un elenco dei **gruppi dell'utente e un elenco di ambiti**. Lo scopo del token di accesso √® **autorizzare le operazioni API** nel contesto dell'utente nel pool di utenti. Ad esempio, puoi utilizzare il token di accesso per **concedere all'utente l'accesso** per aggiungere, modificare o eliminare attributi dell'utente.
* [**Token di aggiornamento**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Con i token di aggiornamento puoi **ottenere nuovi token ID e token di accesso** per l'utente fino a quando il **token di aggiornamento non √® pi√π valido**. Per impostazione predefinita, il token di aggiornamento **scade 30 giorni dopo** che l'utente dell'applicazione accede al pool di utenti. Quando crei un'applicazione per il tuo pool di utenti, puoi impostare la scadenza del token di aggiornamento dell'applicazione su **qualsiasi valore compreso tra 60 minuti e 10 anni**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Questo √® il flusso di autenticazione lato server:

* L'applicazione lato server chiama l'operazione API **`AdminInitiateAuth`** (anzich√© `InitiateAuth`). Questa operazione richiede credenziali AWS con autorizzazioni che includono **`cognito-idp:AdminInitiateAuth`** e **`cognito-idp:AdminRespondToAuthChallenge`**. L'operazione restituisce i parametri di autenticazione richiesti.
* Dopo che l'applicazione lato server ha i **parametri di autenticazione**, chiama l'operazione API **`AdminRespondToAuthChallenge`**. L'operazione API `AdminRespondToAuthChallenge` ha successo solo quando vengono fornite le credenziali AWS.

Questo **metodo NON √® abilitato** per impostazione predefinita.

Per effettuare il **login** √® necessario conoscere:

* l'ID del pool di utenti
* l'ID del client
* il nome utente
* la password
* il segreto del client (solo se l'applicazione √® configurata per utilizzare un segreto)

{% hint style="info" %}
Per poter effettuare il **login con questo metodo**, l'applicazione deve consentire il login con `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Inoltre, per eseguire questa azione, sono necessarie credenziali con le autorizzazioni **`cognito-idp:AdminInitiateAuth`** e **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>Codice per l'accesso</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### USER\_PASSWORD\_AUTH

Questo metodo √® un altro semplice flusso di autenticazione **utente e password tradizionale**. Si consiglia di **migrare un metodo di autenticazione tradizionale** a Cognito e **consigliato** di **disabilitarlo** e **usare** invece il metodo **ALLOW\_USER\_SRP\_AUTH** (poich√© quest'ultimo non invia mai la password sulla rete).\
Questo metodo **NON √® abilitato** per impostazione predefinita.

La principale **differenza** con il **metodo di autenticazione precedente** nel codice √® che **non √® necessario conoscere l'ID del pool utenti** e **non sono necessari permessi aggiuntivi** nel pool utenti di Cognito.

Per **effettuare il login** √® necessario conoscere:

* l'ID del client
* il nome utente
* la password
* il segreto del client (solo se l'app √® configurata per utilizzare un segreto)

<div data-gb-custom-block data-tag="hint" data-style='info'>

Per poter **effettuare il login con questo metodo**, l'applicazione deve consentire il login con ALLOW\_USER\_PASSWORD\_AUTH.

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Questo **metodo sar√† sempre valido** (non pu√≤ essere disabilitato) ma √® necessario avere un refresh token valido.

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
