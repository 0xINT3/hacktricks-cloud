# Cognito User Pools

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Pools ya mtumiaji ni saraka ya mtumiaji katika Amazon Cognito. Kwa pool ya mtumiaji, watumiaji wako wanaweza **kuingia kwenye programu yako ya wavuti au simu** kupitia Amazon Cognito, **au kufederate** kupitia mtoa huduma wa **tatu** (IdP). Iwe watumiaji wako wanajiunga moja kwa moja au kupitia mtu wa tatu, wanachama wote wa pool ya mtumiaji wana wasifu wa saraka ambao unaweza kufikia kupitia SDK.

Pools za mtumiaji hutoa:

* Huduma za usajili na kuingia.
* UI ya wavuti iliyojengwa, inayoweza kubadilishwa kuingiza watumiaji.
* Kuingia kijamii na Facebook, Google, Ingia na Amazon, na Ingia na Apple, na kupitia watoa huduma wa kitambulisho wa SAML na OIDC kutoka kwa pool ya mtumiaji.
* Usimamizi wa saraka ya mtumiaji na maelezo ya mtumiaji.
* Vipengele vya usalama kama vile uthibitishaji wa hatua nyingi (MFA), ukaguzi wa vitambulisho vilivyoingiliwa, ulinzi dhidi ya kuchukua akaunti, na uthibitisho wa simu na barua pepe.
* Mifumo iliyobinafsishwa na uhamiaji wa mtumiaji kupitia kichocheo cha AWS Lambda.

**Msimbo wa chanzo** wa programu mara nyingi utaambatisha **kitambulisho cha pool ya mtumiaji** na **kitambulisho cha programu ya mteja**, (na mara nyingine **siri ya programu**?) ambayo inahitajika kwa **mtumiaji kuingia** kwenye Pool ya Mtumiaji ya Cognito.

### Mashambulizi Yanayowezekana

* **Usajili**: Kwa chaguo-msingi mtumiaji anaweza kujisajili mwenyewe, hivyo anaweza kuunda mtumiaji kwa ajili yake mwenyewe.
* **Uchambuzi wa Mtumiaji**: Kazi ya usajili inaweza kutumika kwa kutafuta majina ya watumiaji ambayo tayari yapo. Taarifa hii inaweza kuwa muhimu kwa shambulio la nguvu ya kutisha.
* **Kutisha kuingia**: Katika sehemu ya [**Uthibitishaji**](cognito-user-pools.md#uthibitishaji) una njia zote ambazo mtumiaji anapaswa **kuingia**, unaweza kujaribu kuzitisha kwa **kupata vitambulisho halali**.

### Zana za udukuzi

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), mfumo wa udukuzi wa AWS, sasa una moduli za "cognito\_\_enum" na "cognito\_\_attack" ambazo zinautomatisha uchambuzi wa mali zote za Cognito kwenye akaunti na kuashiria miundo dhaifu, sifa za mtumiaji zinazotumiwa kwa kudhibiti upatikanaji, n.k., na pia kiotomatiki uundaji wa mtumiaji (ikiwa ni pamoja na usaidizi wa MFA) na upandishaji wa mamlaka kulingana na sifa za kawaida zinazoweza kubadilishwa, vitambulisho vya kitambulisho vinavyoweza kutumika, majukumu yanayoweza kufikiwa katika alama za kitambulisho, n.k.

Kwa maelezo ya kazi za moduli angalia sehemu ya 2 ya [chapisho la blogi](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Kwa maelekezo ya usakinishaji angalia ukurasa wa kuu wa [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Matumizi

Matumizi ya kawaida ya cognito\_\_attack kujaribu uundaji wa mtumiaji na vekta zote za upandishaji wa mamlaka dhidi ya kitambulisho kilichopewa na mteja wa pool ya mtumiaji:

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

Mfano wa matumizi ya cognito\_\_enum kukusanya mabwawa yote ya watumiaji, wateja wa bwawa la watumiaji, mabwawa ya utambulisho, watumiaji, n.k. yanayoonekana kwenye akaunti ya AWS ya sasa:

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ni chombo cha CLI kilichoandikwa kwa lugha ya python ambacho kinatekeleza mashambulizi tofauti kwenye Cognito ikiwa ni pamoja na uundaji usiohitajika wa akaunti na akaunti ya oracle.

#### Usanidi

```bash
$ pip install cognito-scanner
```

#### Matumizi

```bash
$ cognito-scanner --help
```

Kwa maelezo zaidi angalia https://github.com/padok-team/cognito-scanner

## Usajili

User Pools inaruhusu kwa **default** ku **sajili watumiaji wapya**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### Ikiwa yeyote anaweza kusajili

Unaweza kukutana na kosa linalokuonyesha kwamba unahitaji **kutoa maelezo zaidi** kuhusu mtumiaji:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Unaweza kutoa maelezo yanayohitajika kwa JSON kama:

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Unaweza kutumia hii kazi pia kwa **kutambua watumiaji waliopo.** Hii ni ujumbe wa kosa unapokuwepo tayari mtumiaji na jina hilo:

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Tambua katika amri iliyotangulia jinsi **vipengele vya desturi vinavyoanza na "desturi:"**.\
Pia tambua kwamba unapojiandikisha **hauwezi kuunda vipengele vipya vya desturi kwa mtumiaji**. Unaweza tu kutoa thamani kwa **vipengele vya msingi** (hata kama sio lazima) na **vipengele vya desturi vilivyotajwa**.
{% endhint %}

Au jaribu tu kuthibitisha ikiwa kitambulisho cha mteja kipo. Hii ni makosa ikiwa kitambulisho cha mteja hakipo:

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Ikiwa ni admin pekee anaweza kujiandikisha watumiaji

Utakutana na kosa hili na hutaweza kujiandikisha au kuchunguza watumiaji:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### Kudhibitisha Usajili

Cognito inaruhusu **kudhibitisha mtumiaji mpya kwa kudhibitisha barua pepe au namba ya simu**. Kwa hivyo, unapounda mtumiaji kawaida utahitajika angalau jina la mtumiaji na nywila na **barua pepe na/au namba ya simu**. Weka moja **unayoidhibiti** ili upokee nambari ya **kudhibitisha** mtumiaji **aliyesajiliwa** kama hivi:

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
Hata kama **inaonekana unaweza kutumia barua pepe** na nambari ya simu ile ile, unapohitaji kuthibitisha mtumiaji aliyeumbwa, Cognito italalamika kuhusu kutumia habari ile ile na **haitakuruhusu kuthibitisha akaunti**.
{% endhint %}

### Kupandisha Mamlaka / Kubadilisha Sifa

Kwa chaguo-msingi mtumiaji anaweza **kurekebisha thamani ya sifa zake** kwa kitu kama:

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### Kupandisha hadhi ya sifa ya desturi

{% hint style="danger" %}
Unaweza kukuta **sifa za desturi** zikitumiwa (kama vile `isAdmin`), kwa chaguo-msingi unaweza **kubadilisha thamani za sifa zako mwenyewe** na huenda ukaweza **kupandisha hadhi** kwa kubadilisha thamani mwenyewe!
{% endhint %}

#### Kupandisha hadhi ya ubadilishaji wa Barua pepe/jina la mtumiaji

Unaweza kutumia hii kwa **kubadilisha barua pepe na nambari ya simu** ya mtumiaji, lakini, hata kama akaunti inabaki kama imehakikiwa, sifa hizo zitakuwa **zimewekwa katika hali isiyo hakikiwa** (unahitaji kuzihakiki tena).

{% hint style="warning" %}
Hutaweza **kuingia kwa kutumia barua pepe au nambari ya simu** hadi uzihakiki, lakini utaweza **kuingia kwa kutumia jina la mtumiaji**.\
Tambua kwamba hata kama barua pepe ilibadilishwa na haijahakikiwa itaonekana katika Kitambulisho cha ID ndani ya **`barua pepe`** **eneo** na eneo la **`barua_pepe_imethibitishwa`** litakuwa **uwongo**, lakini ikiwa programu **haichunguzi hilo unaweza kujifanya kuwa mtumiaji mwingine**.

Zaidi ya hayo, tambua kwamba unaweza kuweka chochote ndani ya eneo la **`jina`** kwa kubadilisha tu **sifa ya jina**. Ikiwa programu ina **kuangalia** **eneo hilo** kwa sababu fulani **badala ya `barua pepe`** (au sifa nyingine yoyote) unaweza **kujifanya kuwa mtumiaji mwingine**.
{% endhint %}

Kwa njia yoyote, ikiwa kwa sababu fulani ulibadilisha barua pepe yako kwa mfano kuwa mpya unaweza **kuthibitisha barua pepe kwa nambari uliyopokea kwenye anwani hiyo ya barua pepe**:

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

Tumia **`phone_number`** badala ya **`email`** kubadilisha/thibitisha **namba mpya ya simu**.

{% hint style="info" %}
Msimamizi pia anaweza kuwezesha chaguo la **kuingia kwa kutumia jina la mtumiaji linalopendelewa**. Tafadhali kumbuka huwezi kubadilisha thamani hii kuwa **jina lolote au preferred\_username ambalo tayari linatumika** kujifanya kuwa mtumiaji tofauti.
{% endhint %}

### Kurejesha/Kubadilisha Nenosiri

Inawezekana kurejesha nenosiri kwa kujua tu **jina la mtumiaji** (au barua pepe au simu inakubalika) na kuwa na ufikiaji kwake kwani nambari itatumwa hapo:

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
Jibu la seva litakuwa chanya daima, kama vile jina la mtumiaji lilikuwepo. Huwezi kutumia njia hii kuchunguza watumiaji
{% endhint %}

Kwa kutumia kanuni unaweza kubadilisha nenosiri na:

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

Ili kubadilisha nenosiri unahitaji **kujua nenosiri la awali**:

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## Uthibitisho

Kidole cha watumiaji kinaweza **kuthibitishwa kwa njia tofauti**. Ikiwa una **jina la mtumiaji na nywila** kuna pia **njia tofauti** zinazoungwa mkono kuingia.\
Zaidi ya hayo, wakati mtumiaji anathibitishwa kwenye Kidole **aina 3 za vivuli hupewa**: **Kitambulisho cha ID**, **kitambulisho cha Upatikanaji** na **kitambulisho cha Kufufua**.

* [**Kitambulisho cha ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Kina madai kuhusu **utambulisho wa mtumiaji aliye thibitishwa,** kama vile `jina`, `barua pepe`, na `namba ya simu`. Kitambulisho cha ID pia kinaweza kutumika ku **kuthibitisha watumiaji kwenye seva zako za rasilimali au programu za seva**. Lazima **uthibitishe** **sahihi** ya kitambulisho cha ID kabla ya kuamini madai yoyote ndani ya kitambulisho cha ID ikiwa unakitumia kwenye programu za nje.
* Kitambulisho cha ID ni kitambulisho kinachojumuisha thamani za sifa za mtumiaji, hata zile za desturi.
* [**Kitambulisho cha Upatikanaji**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Kina madai kuhusu mtumiaji aliye thibitishwa, orodha ya **makundi ya mtumiaji, na orodha ya mizania**. Lengo la kitambulisho cha upatikanaji ni **kuidhinisha shughuli za API** katika muktadha wa mtumiaji kwenye kidole cha mtumiaji. Kwa mfano, unaweza kutumia kitambulisho cha upatikanaji ku **kuidhinisha mtumiaji wako kupata** kuongeza, kubadilisha, au kufuta sifa za mtumiaji.
* [**Kitambulisho cha Kufufua**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Kwa vivuli vya kufufua unaweza **kupata Kitambulisho cha ID na Vitambulisho vya Upatikanaji vipya** kwa mtumiaji hadi **kitambulisho cha kufufua kitakapokuwa batili**. Kwa **chaguo-msingi**, kitambulisho cha kufufua **hufikia ukomo wa siku 30 baada ya** mtumiaji wa programu yako kuingia kwenye kidole chako cha mtumiaji. Unapotengeneza programu kwa kidole chako cha mtumiaji, unaweza kuweka ukomo wa kufutwa kwa kitambulisho cha kufufua cha programu kwa **thamani yoyote kati ya dakika 60 na miaka 10**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Hii ni mchakato wa uthibitisho wa upande wa seva:

* Programu ya upande wa seva inaita **`AdminInitiateAuth` API operation** (badala ya `InitiateAuth`). Operesheni hii inahitaji sifa za AWS zenye ruhusa zinazojumuisha **`cognito-idp:AdminInitiateAuth`** na **`cognito-idp:AdminRespondToAuthChallenge`**. Operesheni inarudisha vigezo vya uthibitisho vinavyohitajika.
* Baada ya programu ya upande wa seva kupata **vigezo vya uthibitisho**, inaita **`AdminRespondToAuthChallenge` API operation**. Operesheni ya API ya `AdminRespondToAuthChallenge` inafanikiwa tu unapotoa sifa za AWS.

Hii **njia haijaamilishwa** kwa chaguo-msingi.

Ili **kuingia** unahitaji kujua:

* kitambulisho cha kidole cha mtumiaji
* kitambulisho cha mteja
* jina la mtumiaji
* nywila
* siri ya mteja (ikiwa programu imeboreshwa kutumia siri)

{% hint style="info" %}
Ili **kuweza kuingia kwa njia hii** programu hiyo inapaswa kuruhusu kuingia na `RUHUSU_ADMIN_USER_PASSWORD_AUTH`.\
Zaidi ya hayo, kufanya kitendo hiki unahitaji sifa zenye ruhusa za\*\*`cognito-idp:AdminInitiateAuth`\*\*na **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>Msimbo wa Kuingia</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### USER\_PASSWORD\_AUTH

Hii njia ni nyingine rahisi na **ya jadi ya uthibitishaji wa mtumiaji na nywila**. **Inapendekezwa** kuhamisha njia ya **uthibitishaji ya jadi** **kwenda Cognito** na **kupendekezwa** kisha **kuidisable** na **kutumia** njia ya **ALLOW\_USER\_SRP\_AUTH** badala yake (kwani haitumi nywila kupitia mtandao).\
Hii **njia HAIAKTIVI** kwa chaguo-msingi.

To **kuingia** unahitaji kujua:

* kitambulisho cha mteja
* jina la mtumiaji
* nywila
* siri ya mteja (ikiwa programu imeboreshwa kutumia siri)

<div data-gb-custom-block data-tag="hint" data-style='info'>

Ili **kuweza kuingia kwa njia hii**, programu hiyo lazima iruhusu kuingia na ALLOW\_USER\_PASSWORD\_AUTH.

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### KITHIBITISHO\_LA\_KUHAKIKISHA\_TENAI & KITHIBITISHO\_LA\_KUHAKIKISHA\_TENAI

Hii **njia itakuwa halali daima** (haiwezi kulemazwa) lakini unahitaji kuwa na kithibitisho cha kuhakikisha tena kilicho halali.

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
