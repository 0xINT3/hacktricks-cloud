# Cognito User Pools

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Basiese Inligting

'n Gebruikerspoel is 'n gebruikersgids in Amazon Cognito. Met 'n gebruikerspoel kan jou gebruikers **aanmeld by jou web- of mobiele app** deur middel van Amazon Cognito, **of federasie** deur 'n **derde party** identiteitsverskaffer (IdP). Of jou gebruikers direk aanmeld of deur 'n derde party, het alle lede van die gebruikerspoel 'n gidsprofiel wat jy kan ontsluit deur middel van 'n SDK.

Gebruikerspoele bied:

* Aanmeld- en intekeningsdienste.
* 'n Ingeboude, aanpasbare web-gebruikerskoppelvlak om gebruikers aan te meld.
* Sosiale aanmelding met Facebook, Google, Login with Amazon, en Sign in with Apple, en deur SAML en OIDC identiteitsverskaffers van jou gebruikerspoel.
* Gebruikersgidsbestuur en gebruikersprofiels.
* Sekuriteitsfunksies soos multifaktor-aanmelding (MFA), kontrole vir gekompromitteerde legitimasie, rekeningsoornamebeskerming, en telefoon- en e-posverifikasie.
* Aangepaste werkstrome en gebruikersmigrasie deur middel van AWS Lambda-triggers.

**Bronkode** van toepassings sal gewoonlik ook die **gebruikerspoel-ID** en die **kli√´nttoepassings-ID** bevat (en soms die **toepassingsgeheim**?), wat nodig is vir 'n **gebruiker om aan te meld** by 'n Cognito-gebruikerspoel.

### Potensi√´le aanvalle

* **Registrasie**: Standaard kan 'n gebruiker homself registreer, sodat hy 'n gebruiker vir homself kan skep.
* **Gebruikersopname**: Die registrasiefunksionaliteit kan gebruik word om gebruikersname te vind wat reeds bestaan. Hierdie inligting kan nuttig wees vir die brute-force-aanval.
* **Aanmelding brute force**: In die [**Verifikasie**](cognito-user-pools.md#authentication) afdeling het jy al die **metodes** wat 'n gebruiker moet **aanmeld**, jy kan probeer om hulle met brute force te **geldig legitimasie te vind**.

### Gereedskap vir pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), die AWS-uitbuitingsraamwerk, sluit nou die "cognito\_\_enum" en "cognito\_\_attack" modules in wat outomatiese opname van alle Cognito-bates in 'n rekening en swak konfigurasies, gebruikerskenmerke wat vir toegangsbeheer gebruik word, ens., en ook outomatiese gebruikerskepping (insluitend MFA-ondersteuning) en voorregverhoging gebaseer op wysigbare aangepaste kenmerke, bruikbare identiteitspoellegitimasie, aanneembare rolle in id-token, ens.

Vir 'n beskrywing van die modules se funksies, sien deel 2 van die [blogpos](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Vir installasie-instruksies, sien die hoof [Pacu](https://github.com/RhinoSecurityLabs/pacu) bladsy.

#### Gebruik

Voorbeeld cognito\_\_attack-gebruik om gebruikerskepping en alle voorregverhogingsvektore teen 'n gegewe identiteitspoel en gebruikerspoelkli√´nt te probeer:

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

Voorbeeld cognito\_\_enum gebruik om alle gebruikerspools, gebruikerspoolclients, identiteitspools, gebruikers, ens. te verzamelen wat sigbaar is in die huidige AWS-rekening:

```plaintext
cognito__enum
```

Dit sal alle relevante inligting oor gebruikerspools, gebruikerspoolclients, identiteitspools en gebruikers in die huidige AWS-rekening versamel en vertoon.

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) is 'n CLI-werktuig in Python wat verskillende aanvalle op Cognito implementeer, insluitend ongewenste rekening-skepping en rekening-orakel.

#### Installasie

```bash
$ pip install cognito-scanner
```

#### Gebruik

```bash
$ cognito-scanner --help
```

Vir meer inligting, besoek https://github.com/padok-team/cognito-scanner

## Registrasie

Gebruikerspoele laat **standaard** toe om **nuwe gebruikers te registreer**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### As enige iemand kan registreer

Jy mag 'n fout vind wat aandui dat jy meer besonderhede van die gebruiker moet verskaf:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Jy kan die nodige besonderhede verskaf met 'n JSON soos:

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Jy kan hierdie funksionaliteit ook gebruik om **bestaande gebruikers op te som.** Hierdie is die foutboodskap wanneer 'n gebruiker reeds met daardie naam bestaan:

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Merk op in die vorige bevel hoe die **aangepaste eienskappe begin met "custom:"**.\
Weet ook dat wanneer jy registreer, jy **nie nuwe aangepaste eienskappe vir die gebruiker kan skep nie**. Jy kan slegs waarde gee aan **verpligte verstek eienskappe** en **gespesifiseerde aangepaste eienskappe**.
{% endhint %}

Of net om te toets of 'n kli√´nt-ID bestaan. Dit is die fout as die kli√´nt-ID nie bestaan nie:

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### As slegs die admin gebruikers kan registreer

Jy sal hierdie fout kry en jy sal nie in staat wees om gebruikers te registreer of op te som nie:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### Verifying Registrasie

Cognito maak dit moontlik om 'n nuwe gebruiker te **verifieer deur sy e-pos of telefoonnommer te verifieer**. Daarom, wanneer jy 'n gebruiker skep, sal jy gewoonlik ten minste die gebruikersnaam en wagwoord en die **e-pos en/of telefoonnommer** moet verskaf. Stel net een **wat jy beheer** sodat jy die kode sal ontvang om jou nuutgeskepte gebruikersrekening te **verifieer** soos hierdie:

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
Selfs al lyk dit asof jy dieselfde e-pos en telefoonnommer kan gebruik, sal Cognito kla oor die gebruik van dieselfde inligting en **jou nie toelaat om die rekening te verifieer nie**.
{% endhint %}

### Voorregverhoging / Opdatering van Eienskappe

Standaard kan 'n gebruiker die waarde van sy eienskappe **verander** met iets soos:

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### Aangepaste attribuut privilege-escalatie

{% hint style="danger" %}
Jy mag **aangepaste eienskappe** vind wat gebruik word (soos `isAdmin`), aangesien jy standaard die waardes van jou eie eienskappe kan verander, kan jy dalk **privileges verhoog** deur die waarde self te verander!
{% endhint %}

#### E-pos/gebruikersnaam wysiging privilege-escalatie

Jy kan dit gebruik om die **e-pos en telefoonnommer** van 'n gebruiker te wysig, maar dan, selfs al bly die rekening geverifieer, is daardie eienskappe in 'n **ongeverifieerde status** (jy moet hulle weer verifieer).

{% hint style="warning" %}
Jy **sal nie kan aanmeld met e-pos of telefoonnommer** totdat jy hulle verifieer nie, maar jy sal **kan aanmeld met die gebruikersnaam**.\
Let daarop dat selfs as die e-pos gewysig is en nie geverifieer is nie, sal dit in die ID-token binne die **`e-pos`**-veld verskyn en die veld **`e-pos_geverifieer`** sal **vals** wees, maar as die app **nie daarna kyk nie, kan jy ander gebruikers voorstel**.

Verder, let daarop dat jy enigiets binne die **`naam`**-veld kan plaas deur die **naam-eienskap** te wysig. As 'n app **daarna kyk** vir 'n of ander rede **in plaas van die `e-pos`** (of enige ander eienskap), kan jy dalk **ander gebruikers voorstel**.
{% endhint %}

In elk geval, as jy byvoorbeeld jou e-pos om een of ander rede verander het na 'n nuwe een, kan jy die e-pos **bevestig met die kode wat jy in daardie e-posadres ontvang het**:

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

Gebruik **`phone_number`** in plaas van **`email`** om 'n **nuwe telefoonnommer** te verander/verifieer.

{% hint style="info" %}
Die administrateur kan ook die opsie aktiveer om **in te teken met 'n gebruikersvoorkeur-gebruikersnaam**. Let daarop dat jy nie hierdie waarde kan verander na **enige gebruikersnaam of voorkeur\_gebruikersnaam wat reeds gebruik word** om 'n ander gebruiker na te boots nie.
{% endhint %}

### Herstel/Verander Wagwoord

Dit is moontlik om 'n wagwoord te herstel deur net die gebruikersnaam te **weet** (of e-pos of telefoon word aanvaar) en toegang daartoe te h√™, aangesien 'n kode daarheen gestuur sal word:

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
Die reaksie van die bediener sal altyd positief wees, soos of die gebruikersnaam bestaan. Jy kan hierdie metode nie gebruik om gebruikers op te som nie.
{% endhint %}

Met die kode kan jy die wagwoord verander met:

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

Om die wagwoord te verander, moet jy **die vorige wagwoord weet**:

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## Verifikasie

'n Gebruikerspoel ondersteun **verskillende maniere om te verifieer**. As jy 'n **gebruikersnaam en wagwoord** het, is daar ook **verskillende metodes** om in te teken.\
Verder, wanneer 'n gebruiker ge√Ødentifiseer is in die Poel, word **3 tipes tokens gegee**: Die **ID-token**, die **Toegangstoken** en die **Vernuwings-token**.

* [**ID-token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Dit bevat bewerings oor die **identiteit van die ge√Ødentifiseerde gebruiker**, soos `naam`, `e-pos` en `telefoonnommer`. Die ID-token kan ook gebruik word om gebruikers te **verifieer by jou hulpbronbedieners of bedienertoepassings**. Jy moet die **handtekening** van die ID-token **verifieer** voordat jy enige bewerings binne die ID-token kan vertrou as jy dit in eksterne toepassings gebruik.
* Die ID-token is die token wat die waardes van die gebruiker se eienskappe bevat, selfs die aangepaste waardes.
* [**Toegangstoken**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Dit bevat bewerings oor die ge√Ødentifiseerde gebruiker, 'n lys van die **gebruiker se groepe en 'n lys van omvang**. Die doel van die toegangstoken is om API-operasies te **magtig** in die konteks van die gebruiker in die gebruikerspoel. Byvoorbeeld, jy kan die toegangstoken gebruik om die gebruiker toegang te **gee** om gebruikerseienskappe by te voeg, te verander of te verwyder.
* [**Vernuwings-token**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Met vernuwings-tokens kan jy nuwe ID-tokens en Toegangstokens kry vir die gebruiker totdat die **vernuwingstoken ongeldig is**. Standaard verval die vernuwings-token **30 dae nadat** jou toepassingsgebruiker by jou gebruikerspoel aanteken. Wanneer jy 'n toepassing vir jou gebruikerspoel skep, kan jy die vernuwings-token se vervalstydperk vir die toepassing instel op **enige waarde tussen 60 minute en 10 jaar**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Dit is die bedienerkant-verifikasievloei:

* Die bedienerkant-toep roep die **`AdminInitiateAuth` API-operasie** (in plaas van `InitiateAuth`) aan. Hierdie operasie vereis AWS-legitimasie met toestemmings wat **`cognito-idp:AdminInitiateAuth`** en **`cognito-idp:AdminRespondToAuthChallenge`** insluit. Die operasie gee die vereiste verifikasieparameters terug.
* Nadat die bedienerkant-toep die **verifikasieparameters** het, roep dit die **`AdminRespondToAuthChallenge` API-operasie** aan. Die `AdminRespondToAuthChallenge` API-operasie slaag slegs as jy AWS-legitimasie voorsien.

Hierdie **metode is NIE standaard geaktiveer** nie.

Om in te teken, moet jy weet:

* gebruikerspoel-ID
* kli√´nt-ID
* gebruikersnaam
* wagwoord
* kli√´nt-geheim (slegs as die toepassing gekonfigureer is om 'n geheim te gebruik)

{% hint style="info" %}
Om **met hierdie metode te kan in te teken**, moet die toepassing toelaat dat jy met `ALLOW_ADMIN_USER_PASSWORD_AUTH` kan in teken.\
Verder, om hierdie aksie uit te voer, het jy legitimasie met die toestemmings **`cognito-idp:AdminInitiateAuth`** en **`cognito-idp:AdminRespondToAuthChallenge`** nodig.
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>Kode om in te teken</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### GEBRUIKER_WAGWOORD_AUTH

Hierdie metode is 'n eenvoudige en tradisionele gebruiker- en wagwoord-verifikasievloei. Dit word aanbeveel om 'n tradisionele verifikasiemetode na Cognito te migreer en dit dan uit te skakel en in plaas daarvan die ALLOW_USER_SRP_AUTH-metode te gebruik (omdat dit nooit die wagwoord oor die netwerk stuur). Hierdie metode is NIE standaard geaktiveer nie.

Die belangrikste verskil met die vorige verifikasiemetode in die kode is dat jy nie die gebruikerspoel-ID hoef te weet nie en dat jy nie ekstra toestemmings in die Cognito-gebruikerspoel nodig het nie.

Om aan te meld, moet jy weet:

* kli√´nt-ID
* gebruikersnaam
* wagwoord
* kli√´ntgeheim (slegs as die toepassing gekonfigureer is om 'n geheim te gebruik)

<div data-gb-custom-block data-tag="hint" data-style='info'>

Om met hierdie metode te kan aanmeld, moet die toepassing toelaat dat daar aangemeld word met ALLOW_USER_PASSWORD_AUTH.

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Hierdie **metode sal altyd geldig wees** (dit kan nie uitgeskakel word nie), maar jy moet 'n geldige verfrissingsleutel h√™.

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
