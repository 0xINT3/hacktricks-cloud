# Pools de Usu√°rios do Cognito

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## Informa√ß√µes B√°sicas

Um pool de usu√°rios √© um diret√≥rio de usu√°rios no Amazon Cognito. Com um pool de usu√°rios, seus usu√°rios podem **fazer login em seu aplicativo da web ou m√≥vel** por meio do Amazon Cognito, **ou federar** por meio de um provedor de identidade (IdP) **terceirizado**. Se seus usu√°rios fizerem login diretamente ou por meio de um terceiro, todos os membros do pool de usu√°rios t√™m um perfil de diret√≥rio ao qual voc√™ pode acessar por meio de um SDK.

Os pools de usu√°rios fornecem:

* Servi√ßos de registro e login.
* Uma IU da web integrada e personaliz√°vel para fazer login de usu√°rios.
* Login social com Facebook, Google, Login com Amazon e Login com Apple, e por meio de provedores de identidade SAML e OIDC do seu pool de usu√°rios.
* Gerenciamento de diret√≥rio de usu√°rios e perfis de usu√°rio.
* Recursos de seguran√ßa, como autentica√ß√£o multifator (MFA), verifica√ß√µes de credenciais comprometidas, prote√ß√£o contra invas√£o de conta e verifica√ß√£o de telefone e e-mail.
* Fluxos de trabalho personalizados e migra√ß√£o de usu√°rios por meio de acionadores do AWS Lambda.

O **c√≥digo-fonte** das aplica√ß√µes geralmente tamb√©m cont√©m o **ID do pool de usu√°rios** e o **ID do aplicativo cliente** (e √†s vezes o **segredo do aplicativo**?), que s√£o necess√°rios para um **usu√°rio fazer login** em um Pool de Usu√°rios do Cognito.

### Poss√≠veis ataques

* **Registro**: Por padr√£o, um usu√°rio pode se registrar, portanto, ele pode criar um usu√°rio para si mesmo.
* **Enumera√ß√£o de usu√°rios**: A funcionalidade de registro pode ser usada para encontrar nomes de usu√°rio que j√° existem. Essas informa√ß√µes podem ser √∫teis para o ataque de for√ßa bruta.
* **For√ßa bruta de login**: Na se√ß√£o [**Autentica√ß√£o**](cognito-user-pools.md#authentication), voc√™ tem todos os **m√©todos** que um usu√°rio tem para **fazer login**, voc√™ pode tentar for√ßa bruta para **encontrar credenciais v√°lidas**.

## Registro

Os Pools de Usu√°rios permitem **por padr√£o** **registrar novos usu√°rios**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
    --username <username> --password <password> \
    --region <region> --no-sign-request
```

#### Se qualquer pessoa pode se registrar

Voc√™ pode encontrar um erro indicando que voc√™ precisa **fornecer mais detalhes** sobre o usu√°rio:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Voc√™ pode fornecer os detalhes necess√°rios com um JSON como este:

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Voc√™ tamb√©m pode usar essa funcionalidade para **enumerar usu√°rios existentes**. Esta √© a mensagem de erro quando um usu√°rio j√° existe com esse nome:

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Observe no comando anterior como os **atributos personalizados come√ßam com "custom:"**.\
Tamb√©m saiba que, ao se registrar, voc√™ **n√£o pode criar novos atributos personalizados para o usu√°rio**. Voc√™ s√≥ pode dar valor aos **atributos padr√£o** (mesmo que n√£o sejam obrigat√≥rios) e aos **atributos personalizados especificados**.
{% endhint %}

Ou apenas para testar se um ID de cliente existe. Este √© o erro se o ID do cliente n√£o existir:

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Se apenas o administrador pode registrar usu√°rios

Voc√™ encontrar√° este erro e n√£o poder√° registrar ou enumerar usu√°rios:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### Verificando o Registro

O Cognito permite **verificar um novo usu√°rio verificando seu e-mail ou n√∫mero de telefone**. Portanto, ao criar um usu√°rio, geralmente voc√™ precisar√° pelo menos do nome de usu√°rio e senha e do **e-mail e/ou n√∫mero de telefone**. Basta definir um **que voc√™ controla** para que voc√™ receba o c√≥digo para **verificar sua** nova conta de usu√°rio **criada** assim:

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
    --username aasdasd2 --confirmation-code <conf_code> \
    --no-sign-request --region us-east-1
```

{% hint style="warning" %}
Mesmo que **pare√ßa que voc√™ pode usar o mesmo e-mail** e n√∫mero de telefone, quando voc√™ precisa verificar o usu√°rio criado, o Cognito reclamar√° sobre o uso das mesmas informa√ß√µes e **n√£o permitir√° que voc√™ verifique a conta**.
{% endhint %}

### Escalada de Privil√©gios / Atualiza√ß√£o de Atributos

Por padr√£o, um usu√°rio pode **modificar o valor de seus atributos** com algo como:

```bash
aws cognito-idp update-user-attributes \
    --region us-east-1 --no-sign-request \
    --user-attributes Name=address,Value=street \
    --access-token <access token>
```

#### Escalada de privil√©gios de atributo personalizado

{% hint style="danger" %}
Voc√™ pode encontrar **atributos personalizados** sendo usados (como `isAdmin`), por padr√£o, voc√™ pode **alterar os valores de seus pr√≥prios atributos**, voc√™ pode ser capaz de **escalar privil√©gios** alterando o valor voc√™ mesmo!
{% endhint %}

#### Escalada de privil√©gios de modifica√ß√£o de e-mail/nome de usu√°rio

Voc√™ pode usar isso para **modificar o e-mail e o n√∫mero de telefone** de um usu√°rio, mas ent√£o, mesmo que a conta permane√ßa verificada, esses atributos s√£o **definidos em status n√£o verificado** (voc√™ precisa verific√°-los novamente).

{% hint style="warning" %}
Voc√™ **n√£o poder√° fazer login com e-mail ou n√∫mero de telefone** at√© que os verifique, mas voc√™ ser√° **capaz de fazer login com o nome de usu√°rio**.\
Observe que, mesmo que o e-mail tenha sido modificado e n√£o verificado, ele aparecer√° no Token de ID dentro do campo **`email`** e o campo **`email_verified`** ser√° **falso**, mas se o aplicativo **n
## Autentica√ß√£o

Um pool de usu√°rios suporta **diferentes maneiras de autentica√ß√£o**. Se voc√™ tiver um **nome de usu√°rio e senha**, tamb√©m h√° **diferentes m√©todos** suportados para fazer login.\
Al√©m disso, quando um usu√°rio √© autenticado no Pool, **3 tipos de tokens s√£o fornecidos**: o **Token de ID**, o **Token de Acesso** e o **Token de Atualiza√ß√£o**.

* [**Token de ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Ele cont√©m informa√ß√µes sobre a **identidade do usu√°rio autenticado**, como `nome`, `email` e `phone_number`. O token de ID tamb√©m pode ser usado para **autenticar usu√°rios em seus servidores de recursos ou aplicativos de servidor**. Voc√™ deve **verificar** a **assinatura** do token de ID antes de confiar em qualquer informa√ß√£o dentro do token de ID se voc√™ us√°-lo em aplicativos externos.
  * O Token de ID √© o token que **cont√©m os valores dos atributos do usu√°rio**, inclusive os personalizados.
* [**Token de Acesso**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Ele cont√©m informa√ß√µes sobre o usu√°rio autenticado, uma lista dos **grupos do usu√°rio e uma lista de escopos**. O objetivo do token de acesso √© **autorizar opera√ß√µes de API** no contexto do usu√°rio no pool de usu√°rios. Por exemplo, voc√™ pode usar o token de acesso para **conceder acesso ao usu√°rio** para adicionar, alterar ou excluir atributos do usu√°rio.
* [**Token de Atualiza√ß√£o**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Com tokens de atualiza√ß√£o, voc√™ pode **obter novos Tokens de ID e Tokens de Acesso** para o usu√°rio at√© que o **token de atualiza√ß√£o expire**. Por **padr√£o**, o token de atualiza√ß√£o **expira 30 dias depois** que o usu√°rio do aplicativo se inscreve no pool de usu√°rios. Quando voc√™ cria um aplicativo para o seu pool de usu√°rios, pode definir a expira√ß√£o do token de atualiza√ß√£o do aplicativo para **qualquer valor entre 60 minutos e 10 anos**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Este √© o fluxo de autentica√ß√£o do lado do servidor:

* O aplicativo do lado do servidor chama a opera√ß√£o de API **`AdminInitiateAuth`** (em vez de `InitiateAuth`). Essa opera√ß√£o requer credenciais da AWS com permiss√µes que incluem **`cognito-idp:AdminInitiateAuth`** e **`cognito-idp:AdminRespondToAuthChallenge`**. A opera√ß√£o retorna os par√¢metros de autentica√ß√£o necess√°rios.
* Depois que o aplicativo do lado do servidor tem os **par√¢metros de autentica√ß√£o**, ele chama a opera√ß√£o de API **`AdminRespondToAuthChallenge`**. A opera√ß√£o `AdminRespondToAuthChallenge` s√≥ tem sucesso quando voc√™ fornece credenciais da AWS.

Este **m√©todo N√ÉO est√° habilitado** por padr√£o.

Para **fazer login**, voc√™ **precisa saber**:

* ID do pool de usu√°rios
* ID do cliente
* nome de usu√°rio
* senha
* segredo do cliente (somente se o aplicativo estiver configurado para usar um segredo)

{% hint style="info" %}
Para ser **capaz de fazer login com este m√©todo**, o aplicativo deve permitir o login com `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Al√©m disso, para executar esta a√ß√£o, voc√™ precisa de credenciais com as permiss√µes **`cognito-idp:AdminInitiateAuth`** e **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
    --client-id <client-id> \
    --auth-flow ADMIN_USER_PASSWORD_AUTH \
    --region <region> \
    --auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
    --user-pool-id "<pool-id>"

# Verifique o c√≥digo Python para saber como gerar o hsecret_hash
```

<details>

<summary>C√≥digo para fazer login</summary>

```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
    key = bytes(client_secret, 'utf-8')
    message = bytes(f'{username}{client_id}', 'utf-8')
    return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# Se o aplicativo do cliente n√£o estiver configurado para usar um segredo
## basta excluir a linha que define o SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
    try:
        return boto_client.admin_initiate_auth(
            UserPoolId=user_pool_id,
            ClientId=client_id,
            AuthFlow='ADMIN_USER_PASSWORD_AUTH',
            AuthParameters={
                'USERNAME': username_or_alias,
                'PASSWORD': password,
                'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
            }
        )
    except botocore.exceptions.ClientError as e:
        return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```

</details>

### USER\_PASSWORD\_AUTH

Este m√©todo √© outro fluxo de autentica√ß√£o simples de **usu√°rio e senha tradicional**. √â recomendado **migrar um m√©todo de autentica√ß√£o tradicional** para o Cognito e **recomendado** desativ√°-lo e **usar** o m√©todo **ALLOW\_USER\_SRP\_AUTH** em vez disso (j√° que este nunca envia a senha pela rede).\
Este **m√©todo N√ÉO est√° habilitado** por padr√£o.

A principal **diferen√ßa** com o **m√©todo de autentica√ß√£o anterior** dentro do c√≥digo √© que voc√™ **n√£o precisa saber o ID do pool de usu√°rios** e que voc√™ **n√£o precisa de permiss√µes extras** no Pool de Usu√°rios do Cognito.

Para **fazer login**, voc√™ **precisa saber**:

* ID do cliente
* nome de usu√°rio
* senha
* segredo do cliente (somente se o aplicativo estiver configurado para usar um segredo)

{% hint style="info" %}
Para ser **capaz de fazer login com este m√©todo**, o aplicativo deve permitir o login com ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
    --auth-flow USER_PASSWORD_AUTH --region <region> \
    --auth-parameters '
## Grupos de Usu√°rios do Pool de Usu√°rios e Fun√ß√µes IAM

√â poss√≠vel adicionar **usu√°rios a grupos do Pool de Usu√°rios** que est√£o relacionados a uma **fun√ß√£o IAM**.\
Al√©m disso, **usu√°rios** podem ser atribu√≠dos a **mais de 1 grupo com diferentes fun√ß√µes IAM** anexadas.

Observe que, mesmo que um grupo esteja dentro de um grupo com uma fun√ß√£o IAM anexada, para poder acessar as credenciais IAM desse grupo, √© necess√°rio que o **Pool de Usu√°rios seja confi√°vel por um Pool de Identidade** (e conhe√ßa os detalhes desse Pool de Identidade).

Outro requisito para obter a **fun√ß√£o IAM indicada no IdToken** quando um usu√°rio √© autenticado no Pool de Usu√°rios (`aws cognito-idp initiate-auth...`) √© que o **provedor de autentica√ß√£o do provedor de identidade** precisa indicar que a **fun√ß√£o deve ser selecionada a partir do token.**

<figure><img src="../../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

As **fun√ß√µes** √†s quais um usu√°rio tem acesso est√£o **dentro do `IdToken`**, e um usu√°rio pode **selecionar qual fun√ß√£o ele gostaria de obter credenciais** com o **`--custom-role-arn`** de `aws cognito-identity get-credentials-for-identity`.\
No entanto, se a **op√ß√£o padr√£o** for a que est√° **configurada** (`use default role`), e voc√™ tentar acessar uma fun√ß√£o do IdToken, voc√™ receber√° um **erro** (√© por isso que a configura√ß√£o anterior √© necess√°ria):

{% code overflow="wrap" %}
```
Ocorreu um erro (InvalidParameterException) ao chamar a opera√ß√£o GetCredentialsForIdentity: Somente provedores SAML e provedores com RoleMappings suportam ARN de fun√ß√£o personalizada.
```
{% endcode %}

{% hint style="warning" %}
Observe que a fun√ß√£o atribu√≠da a um **Grupo do Pool de Usu√°rios** precisa ser **acess√≠vel pelo Provedor de Identidade** que **confia no Pool de Usu√°rios** (j√° que as **credenciais da sess√£o da fun√ß√£o IAM ser√£o obtidas a partir dele**).
{% endhint %}

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "cognito-identity.amazonaws.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "authenticated"
                }
            }
        }
    ]
}js
```

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>