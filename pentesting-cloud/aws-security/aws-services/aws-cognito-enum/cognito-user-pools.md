# Cognito User Pools

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

Pula użytkowników to katalog użytkowników w Amazon Cognito. Dzięki puli użytkowników, Twoi użytkownicy mogą **logować się do Twojej aplikacji internetowej lub mobilnej** za pośrednictwem Amazon Cognito, **lub federować** za pośrednictwem **zewnętrznego** dostawcy tożsamości (IdP). Bez względu na to, czy Twoi użytkownicy logują się bezpośrednio czy za pośrednictwem strony trzeciej, wszyscy członkowie puli użytkowników mają profil katalogowy, do którego można uzyskać dostęp za pomocą SDK.

Pule użytkowników zapewniają:

* Usługi rejestracji i logowania.
* Wbudowany, dostosowywalny interfejs użytkownika do logowania użytkowników.
* Logowanie za pomocą Facebooka, Google, Logowania z Amazon, Logowania z Apple, a także za pomocą dostawców tożsamości SAML i OIDC z Twojej puli użytkowników.
* Zarządzanie katalogiem użytkowników i profilami użytkowników.
* Funkcje zabezpieczeń, takie jak uwierzytelnianie wieloskładnikowe (MFA), sprawdzanie skompromitowanych poświadczeń, ochrona przed przejęciem konta oraz weryfikacja telefonu i e-maila.
* Dostosowane procesy i migracja użytkowników za pomocą wyzwalaczy AWS Lambda.

**Kod źródłowy** aplikacji zwykle zawiera również **identyfikator puli użytkowników** i **identyfikator aplikacji klienckiej**, (a czasami **tajemnicę aplikacji**?), które są potrzebne do **zalogowania się użytkownika** do puli użytkowników Cognito.

### Potencjalne ataki

* **Rejestracja**: Domyślnie użytkownik może się zarejestrować, więc może utworzyć użytkownika dla siebie.
* **Wyliczanie użytkowników**: Funkcjonalność rejestracji może być wykorzystana do znalezienia nazw użytkowników, które już istnieją. Te informacje mogą być przydatne do ataku brute-force.
* **Atak brute-force na logowanie**: W sekcji [**Uwierzytelnianie**](cognito-user-pools.md#authentication) znajdują się wszystkie **metody**, które użytkownik musi **użyć do logowania**, można spróbować przeprowadzić atak brute-force, aby **znaleźć prawidłowe poświadczenia**.

### Narzędzia do pentestowania

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), framework eksploatacji AWS, teraz zawiera moduły "cognito\_\_enum" i "cognito\_\_attack", które automatyzują wyliczanie wszystkich zasobów Cognito w koncie, wykrywanie słabych konfiguracji, atrybutów użytkownika używanych do kontroli dostępu itp., a także automatyzują tworzenie użytkowników (w tym obsługę MFA) i eskalację uprawnień na podstawie modyfikowalnych niestandardowych atrybutów, użytecznych poświadczeń puli tożsamości, roli do przyjęcia w tokenach identyfikacyjnych itp.

Opis funkcji modułów znajduje się w części 2 [postu na blogu](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Instrukcje instalacji znajdują się na głównej stronie [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Użycie

Przykładowe użycie cognito\_\_attack do próby utworzenia użytkownika i wszystkich wektorów eskalacji uprawnień w stosunku do określonej puli tożsamości i klienta puli użytkowników:

```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```

Poniżej przedstawiono przykład użycia cognito\_\_enum do zebrania wszystkich pul użytkowników, klientów pul użytkowników, pul tożsamości, użytkowników itp., widocznych w bieżącym koncie AWS:

```plaintext
cognito__enum
```

Ten polecenie wyświetli wszystkie dostępne informacje o pulach użytkowników, klientach pul użytkowników, pulach tożsamości i użytkownikach w bieżącym koncie AWS.

```bash
Pacu (new:test) > run cognito__enum
```

* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) to narzędzie wiersza poleceń napisane w języku Python, które implementuje różne ataki na Cognito, w tym niechciane tworzenie kont i atak typu oracle na konta.

#### Instalacja

```bash
$ pip install cognito-scanner
```

#### Użycie

```plaintext
cognito-user-pools.py [-h] [--region REGION] [--userpool USERPOOL]
                      [--username USERNAME] [--email EMAIL]
                      [--phone PHONE] [--output OUTPUT]

Opcje:
  -h, --help           Wyświetl tę wiadomość pomocy i wyjdź
  --region REGION      Region usługi AWS Cognito (domyślnie: us-east-1)
  --userpool USERPOOL  Identyfikator puli użytkowników Cognito
  --username USERNAME  Nazwa użytkownika do sprawdzenia
  --email EMAIL        Adres e-mail do sprawdzenia
  --phone PHONE        Numer telefonu do sprawdzenia
  --output OUTPUT      Plik wyjściowy, w którym zostaną zapisane wyniki
```

#### Przykłady użycia:

```plaintext
# Sprawdź, czy istnieje użytkownik o nazwie "admin" w puli użytkowników Cognito
cognito-user-pools.py --userpool us-east-1_abcd1234 --username admin

# Sprawdź, czy istnieje użytkownik o adresie e-mail "test@example.com" w puli użytkowników Cognito
cognito-user-pools.py --userpool us-east-1_abcd1234 --email test@example.com

# Sprawdź, czy istnieje użytkownik o numerze telefonu "+1234567890" w puli użytkowników Cognito
cognito-user-pools.py --userpool us-east-1_abcd1234 --phone +1234567890

# Zapisz wyniki do pliku "wyniki.txt"
cognito-user-pools.py --userpool us-east-1_abcd1234 --username admin --output wyniki.txt
```

#### Opis

Ten skrypt umożliwia sprawdzenie istnienia użytkownika w puli użytkowników Cognito usługi AWS Cognito. Można sprawdzić istnienie użytkownika na podstawie nazwy użytkownika, adresu e-mail lub numeru telefonu. Skrypt zwraca informację, czy użytkownik istnieje w puli użytkowników Cognito. Opcjonalnie można zapisywać wyniki do pliku wyjściowego.

```bash
$ cognito-scanner --help
```

Aby uzyskać więcej informacji, sprawdź https://github.com/padok-team/cognito-scanner

## Rejestracja

Pule użytkowników domyślnie umożliwiają **rejestrację nowych użytkowników**.

```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```

#### Jeśli każdy może się zarejestrować

Możesz napotkać błąd wskazujący, że musisz **podać więcej szczegółów** dotyczących użytkownika:

```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```

Możesz dostarczyć potrzebne szczegóły za pomocą JSON, na przykład:

```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```

Możesz również użyć tej funkcji do **wyliczenia istniejących użytkowników**. Oto komunikat o błędzie, który pojawia się, gdy użytkownik o takiej nazwie już istnieje:

```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```

{% hint style="info" %}
Zauważ, że w poprzedniej komendzie **atrybuty niestandardowe zaczynają się od "custom:"**.\
Warto również wiedzieć, że podczas rejestracji **nie można tworzyć nowych atrybutów niestandardowych** dla użytkownika. Można jedynie przypisać wartość do **atrybutów domyślnych** (nawet jeśli nie są one wymagane) oraz **określonych atrybutów niestandardowych**.
{% endhint %}

Lub po prostu przetestuj, czy istnieje identyfikator klienta. Oto błąd, który zostanie wyświetlony, jeśli identyfikator klienta nie istnieje:

```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```

#### Jeśli tylko administrator może rejestrować użytkowników

Napotkasz ten błąd i nie będziesz w stanie zarejestrować ani wyliczyć użytkowników:

```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```

### Weryfikacja rejestracji

Cognito umożliwia **weryfikację nowego użytkownika poprzez weryfikację jego adresu e-mail lub numeru telefonu**. Dlatego, tworząc użytkownika, zazwyczaj będziesz musiał podać co najmniej nazwę użytkownika, hasło oraz **adres e-mail i/lub numer telefonu**. Ustaw jedno **pod swoją kontrolą**, aby otrzymać kod do **weryfikacji** nowo utworzonego **konta użytkownika** w ten sposób:

```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```

{% hint style="warning" %}
Nawet jeśli wydaje się, że możesz użyć tego samego adresu e-mail i numeru telefonu, kiedy musisz zweryfikować utworzonego użytkownika, Cognito zgłosi problem z używaniem tych samych informacji i nie pozwoli na zweryfikowanie konta.
{% endhint %}

### Eskalacja uprawnień / Aktualizowanie atrybutów

Domyślnie użytkownik może **zmieniać wartość swoich atrybutów** za pomocą czegoś takiego jak:

```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```

#### Przywileje podwyższania uprawnień dla niestandardowych atrybutów

{% hint style="danger" %}
Możesz znaleźć używane **niestandardowe atrybuty** (takie jak `isAdmin`). Domyślnie możesz **zmieniać wartości swoich własnych atrybutów**, co może umożliwić ci **podwyższenie uprawnień**, zmieniając wartość samodzielnie!
{% endhint %}

#### Przywileje modyfikacji adresu e-mail/nazwy użytkownika

Możesz użyć tego do **modyfikacji adresu e-mail i numeru telefonu** użytkownika, ale nawet jeśli konto pozostaje zweryfikowane, te atrybuty są **ustawione w stanie niezweryfikowanym** (musisz je zweryfikować ponownie).

{% hint style="warning" %}
Nie będziesz **mógł się zalogować za pomocą adresu e-mail lub numeru telefonu**, dopóki ich nie zweryfikujesz, ale będziesz **mógł się zalogować za pomocą nazwy użytkownika**.\
Zauważ, że nawet jeśli adres e-mail został zmieniony i nie został zweryfikowany, pojawi się on w Tokenie ID w polu **`email`**, a pole **`email_verified`** będzie **false**, ale jeśli aplikacja **nie sprawdza tego**, możesz podszywać się pod innych użytkowników.

Ponadto, zauważ, że możesz umieścić cokolwiek w polu **`name`**, po prostu modyfikując **atrybut nazwy**. Jeśli aplikacja **sprawdza** to pole z jakiegoś powodu **zamiast `email`** (lub jakiegokolwiek innego atrybutu), możesz podszywać się pod innych użytkowników.
{% endhint %}

W każdym razie, jeśli z jakiegoś powodu zmieniłeś swój adres e-mail na przykład na nowy, możesz **potwierdzić adres e-mail za pomocą otrzymanego w nim kodu**:

```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```

Użyj **`phone_number`** zamiast **`email`** do zmiany/weryfikacji **nowego numeru telefonu**.

{% hint style="info" %}
Administrator może również włączyć opcję **logowania za pomocą preferowanego przez użytkownika nazwy użytkownika**. Należy pamiętać, że nie będzie można zmienić tej wartości na **żadną nazwę użytkownika lub preferowaną nazwę użytkownika, która jest już używana**, aby podszywać się pod innego użytkownika.
{% endhint %}

### Odzyskiwanie/Zmiana hasła

Możliwe jest odzyskanie hasła, znając tylko **nazwę użytkownika** (lub akceptowany jest również email lub numer telefonu) i mając do niego dostęp, ponieważ zostanie tam wysłany kod:

```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```

{% hint style="info" %}
Odpowiedź serwera zawsze będzie pozytywna, tak jakby nazwa użytkownika istniała. Nie można użyć tej metody do wyliczania użytkowników.
{% endhint %}

Za pomocą kodu możesz zmienić hasło na:

```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```

Aby zmienić hasło, musisz **znać poprzednie hasło**:

```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```

## Uwierzytelnianie

Pula użytkowników obsługuje **różne sposoby uwierzytelniania**. Jeśli masz **nazwę użytkownika i hasło**, istnieją również **różne metody** obsługiwane do logowania.\
Ponadto, gdy użytkownik jest uwierzytelniony w puli, **przyznawane są 3 rodzaje tokenów**: **Token ID**, **Token dostępu** i **Token odświeżania**.

* [**Token ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Zawiera informacje o **tożsamości uwierzytelnionego użytkownika**, takie jak `imię`, `adres e-mail` i `numer telefonu`. Token ID można również użyć do **uwierzytelniania użytkowników w serwerach zasobów lub aplikacjach serwerowych**. Musisz **zweryfikować** **podpis** Tokenu ID, zanim będziesz mógł ufać jakimkolwiek informacjom wewnątrz Tokenu ID, jeśli używasz go w zewnętrznych aplikacjach.
* Token ID to token, który **zawiera wartości atrybutów użytkownika**, nawet niestandardowe.
* [**Token dostępu**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Zawiera informacje o uwierzytelnionym użytkowniku, listę **grup użytkownika** i listę **zakresów**. Celem tokenu dostępu jest **autoryzacja operacji API** w kontekście użytkownika w puli użytkowników. Na przykład, możesz użyć tokenu dostępu do **udzielenia użytkownikowi dostępu** do dodawania, zmiany lub usuwania atrybutów użytkownika.
* [**Token odświeżania**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Dzięki tokenom odświeżania możesz **uzyskać nowe Tokeny ID i Tokeny dostępu** dla użytkownika, dopóki **token odświeżania jest ważny**. Domyślnie token odświeżania **wygasa 30 dni po** zalogowaniu się użytkownika aplikacji do puli użytkowników. Podczas tworzenia aplikacji dla puli użytkowników można ustawić wygaśnięcie tokenu odświeżania aplikacji na **dowolną wartość między 60 minutami a 10 latami**.

### ADMIN\_NO\_SRP\_AUTH & ADMIN\_USER\_PASSWORD\_AUTH

Jest to strumień uwierzytelniania po stronie serwera:

* Aplikacja po stronie serwera wywołuje operację API **`AdminInitiateAuth`** (zamiast `InitiateAuth`). Ta operacja wymaga poświadczeń AWS z uprawnieniami, które obejmują **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**. Operacja zwraca wymagane parametry uwierzytelniania.
* Po uzyskaniu aplikacja po stronie serwera **parametrów uwierzytelniania**, wywołuje operację API **`AdminRespondToAuthChallenge`**. Operacja API `AdminRespondToAuthChallenge` jest udana tylko wtedy, gdy dostarczysz poświadczenia AWS.

Ta **metoda NIE jest domyślnie włączona**.

Aby **zalogować się**, musisz znać:

* identyfikator puli użytkowników
* identyfikator klienta
* nazwę użytkownika
* hasło
* tajny klucz klienta (tylko jeśli aplikacja jest skonfigurowana do użycia klucza tajnego)

{% hint style="info" %}
Aby **móc zalogować się tą metodą**, aplikacja musi umożliwiać logowanie za pomocą `ALLOW_ADMIN_USER_PASSWORD_AUTH`.\
Ponadto, do wykonania tej akcji potrzebujesz poświadczeń z uprawnieniami **`cognito-idp:AdminInitiateAuth`** i **`cognito-idp:AdminRespondToAuthChallenge`**.
{% endhint %}

```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```

<details>

<summary>Kod do logowania</summary>

\`\`\`python import boto3 import botocore import hmac import hashlib import base64

client\_id = "" user\_pool\_id = "" client\_secret = "" username = "" password = ""

boto\_client = boto3.client('cognito-idp', region\_name='us-east-1')

def get\_secret\_hash(username, client\_id, client\_secret): key = bytes(client\_secret, 'utf-8') message = bytes(f'{username}{client\_id}', 'utf-8') return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

## If the Client App isn't configured to use a secret

### just delete the line setting the SECRET\_HASH

def login\_user(username\_or\_alias, password, client\_id, client\_secret, user\_pool\_id): try: return boto\_client.admin\_initiate\_auth( UserPoolId=user\_pool\_id, ClientId=client\_id, AuthFlow='ADMIN\_USER\_PASSWORD\_AUTH', AuthParameters={ 'USERNAME': username\_or\_alias, 'PASSWORD': password, 'SECRET\_HASH': get\_secret\_hash(username\_or\_alias, client\_id, client\_secret) } ) except botocore.exceptions.ClientError as e: return e.response

print(login\_user(username, password, client\_id, client\_secret, user\_pool\_id))

````
</details>

### USER\_PASSWORD\_AUTH

Ta metoda to kolejny prosty i **tradycyjny sposób uwierzytelniania użytkownika i hasła**. Zaleca się **migrację tradycyjnej** metody uwierzytelniania **do Cognito** i **zaleca się** następnie jej **wyłączenie** i **zamiast tego** korzystanie z metody **ALLOW\_USER\_SRP\_AUTH** (ponieważ ta nigdy nie wysyła hasła przez sieć).\
Ta metoda **nie jest domyślnie włączona**.

Główna **różnica** w kodzie w porównaniu do **poprzedniej metody uwierzytelniania** polega na tym, że **nie musisz znać identyfikatora puli użytkowników** i **nie potrzebujesz dodatkowych uprawnień** w puli użytkowników Cognito.

Aby się **zalogować**, musisz znać:

* identyfikator klienta
* nazwę użytkownika
* hasło
* tajny klucz klienta (tylko jeśli aplikacja jest skonfigurowana do korzystania z klucza tajnego)

<div data-gb-custom-block data-tag="hint" data-style='info'>

Aby **móc zalogować się tą metodą**, aplikacja musi umożliwiać logowanie za pomocą ALLOW\_USER\_PASSWORD\_AUTH.

</div>

```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
````

#### REFRESH\_TOKEN\_AUTH & REFRESH\_TOKEN

Ta **metoda zawsze będzie ważna** (nie można jej wyłączyć), ale musisz mieć ważny token odświeżania.

```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```

</details>
