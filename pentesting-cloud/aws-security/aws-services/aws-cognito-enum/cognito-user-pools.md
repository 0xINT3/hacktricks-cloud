# Pools za Watumiaji wa Cognito

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Pools ya mtumiaji ni saraka ya mtumiaji katika Amazon Cognito. Kwa pool ya mtumiaji, watumiaji wako wanaweza **kuingia kwenye programu yako ya wavuti au simu** kupitia Amazon Cognito, **au kufederate** kupitia mtoa huduma wa **kitambulisho cha tatu** (IdP). Iwe watumiaji wako wanajiunga moja kwa moja au kupitia mtu wa tatu, wanachama wote wa pool ya mtumiaji wana wasifu wa saraka ambao unaweza kufikia kupitia SDK.

Pools za mtumiaji hutoa:

* Huduma za usajili na kuingia.
* UI ya wavuti iliyojengwa, inayoweza kubadilishwa kuingiza watumiaji.
* Kuingia kijamii na Facebook, Google, Ingia na Amazon, na Ingia na Apple, na kupitia watoa huduma wa kitambulisho wa SAML na OIDC kutoka kwa pool ya mtumiaji.
* Usimamizi wa saraka ya mtumiaji na maelezo ya mtumiaji.
* Vipengele vya usalama kama uthibitishaji wa hatua nyingi (MFA), ukaguzi wa vitambulisho vilivyoharibiwa, ulinzi dhidi ya kuchukua akaunti, na uthibitisho wa simu na barua pepe.
* Mifumo iliyobinafsishwa na uhamiaji wa mtumiaji kupitia AWS Lambda triggers.

**Msimbo wa chanzo** wa programu mara nyingi utaambatisha **kitambulisho cha pool ya mtumiaji** na **kitambulisho cha programu ya mteja**, (na mara nyingine **siri ya programu**?) ambayo inahitajika kwa **mtumiaji kuingia** kwenye Pool ya Mtumiaji ya Cognito.

### Mashambulizi Yanayowezekana

* **Usajili**: Kwa chaguo-msingi mtumiaji anaweza kujisajili mwenyewe, hivyo anaweza kuunda mtumiaji kwa ajili yake mwenyewe.
* **Uchambuzi wa Mtumiaji**: Kazi ya usajili inaweza kutumika kufunua majina ya watumiaji ambayo tayari yapo. Taarifa hii inaweza kuwa muhimu kwa shambulio la nguvu ya kutisha.
* **Shambulio la Nguvu ya Kuingia**: Katika sehemu ya [**Uthibitishaji**](cognito-user-pools.md#uthibitishaji) una njia zote ambazo mtumiaji anapaswa **kuingia**, unaweza kujaribu kuzitisha kwa kutafuta vitambulisho halali.

### Zana za Pentesting

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), mfumo wa udukuzi wa AWS, sasa una moduli za "cognito\_\_enum" na "cognito\_\_attack" ambazo zinautomatisha uchambuzi wa mali zote za Cognito kwenye akaunti na kuashiria miundo dhaifu, sifa za mtumiaji zinazotumiwa kwa udhibiti wa ufikiaji, n.k., na pia kiotomatiki uundaji wa mtumiaji (ikiwa ni pamoja na msaada wa MFA) na upandishaji wa mamlaka kulingana na sifa za kubadilika za desturi, vitambulisho vya kitambulisho vinavyoweza kutumika, majukumu yanayoweza kufikiwa katika alama za kitambulisho, n.k.

Kwa maelezo ya kazi za moduli angalia sehemu ya 2 ya [chapisho la blogi](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Kwa maelekezo ya usakinishaji angalia ukurasa wa kuu wa [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Matumizi

Matumizi ya mashambulizi ya cognito\_\_attack kujaribu uundaji wa mtumiaji na vekta zote za upandishaji wa mamlaka dhidi ya kitambulisho kilichotolewa na mteja wa pool ya mtumiaji:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Mfano wa matumizi ya cognito\_\_enum kukusanya mabwawa yote ya watumiaji, wateja wa bwawa la watumiaji, mabwawa ya utambulisho, watumiaji, n.k. yanayoonekana kwenye akaunti ya AWS ya sasa:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) ni chombo cha CLI kilichoandikwa kwa lugha ya python ambacho kinatekeleza mashambulizi tofauti kwenye Cognito ikiwa ni pamoja na uundaji usiohitajika wa akaunti na akaunti ya oracle.

#### Usanidi
```bash
$ pip install cognito-scanner
```
#### Matumizi
```bash
$ cognito-scanner --help
```
Kwa maelezo zaidi tembelea https://github.com/padok-team/cognito-scanner

## Usajili

User Pools inaruhusu kwa **chaguo-msingi** ku **sajili watumiaji wapya**.
```bash
aws cognito-idp sign-up --client-id <client-id> \
--username <username> --password <password> \
--region <region> --no-sign-request
```
#### Ikiwa yeyote anaweza kusajili

Unaweza kukutana na kosa linalokuonyesha kwamba unahitaji **kutoa maelezo zaidi** kuhusu mtumiaji:
```
An error occurred (InvalidParameterException) when calling the SignUp operation: Attributes did not conform to the schema: address: The attribute is required
```
Unaweza kutoa maelezo yanayohitajika kwa kutumia JSON kama:
```json
--user-attributes '[{"Name": "email", "Value": "carlospolop@gmail.com"}, {"Name":"gender", "Value": "M"}, {"Name": "address", "Value": "street"}, {"Name": "custom:custom_name", "Value":"supername&\"*$"}]'
```
Unaweza kutumia hii kazi pia kwa **kutambua watumiaji waliopo.** Hii ni ujumbe wa kosa unapobaini kuwa mtumiaji tayari yupo na jina hilo:
```
An error occurred (UsernameExistsException) when calling the SignUp operation: User already exists
```
{% hint style="info" %}
Tafadhali kumbuka katika amri iliyotangulia jinsi **vipengele vya desturi vinavyoanza na "desturi:"**.\
Pia tambua kwamba unapojiandikisha huwezi **kuunda vipengele vipya vya desturi kwa mtumiaji**. Unaweza tu kutoa thamani kwa **vipengele vya msingi** (hata kama sio lazima) na **vipengele vya desturi vilivyotajwa**.
{% endhint %}

Au jaribu tu kuona kama kitambulisho cha mteja kipo. Hii ni makosa ikiwa kitambulisho cha mteja hakipo:
```
An error occurred (ResourceNotFoundException) when calling the SignUp operation: User pool client 3ig612gjm56p1ljls1prq2miut does not exist.
```
#### Ikiwa ni admin pekee anaweza kujiandikisha watumiaji

Utakutana na kosa hili na hutaweza kujiandikisha au kuhesabu watumiaji:
```
An error occurred (NotAuthorizedException) when calling the SignUp operation: SignUp is not permitted for this user pool
```
### Kudhibitisha Usajili

Cognito inaruhusu **kudhibitisha mtumiaji mpya kwa kudhibitisha barua pepe au namba ya simu**. Kwa hivyo, unapounda mtumiaji kawaida utahitajika angalau jina la mtumiaji na nywila na **barua pepe na/au namba ya simu**. Weka moja **unayoidhibiti** ili upokee nambari ya **kudhibitisha** mtumiaji wako **mzuri** uliounda akaunti kama hii:
```bash
aws cognito-idp confirm-sign-up --client-id <cliet_id> \
--username aasdasd2 --confirmation-code <conf_code> \
--no-sign-request --region us-east-1
```
{% hint style="warning" %}
Hata kama **inaonekana unaweza kutumia barua pepe** na nambari ya simu ile ile, unapohitaji kuthibitisha mtumiaji aliyeumbwa, Cognito italalamika kuhusu kutumia habari ile ile na **haitakuruhusu kuthibitisha akaunti**.
{% endhint %}

### Kupandisha Mamlaka / Kubadilisha Sifa

Kwa chaguo-msingi mtumiaji anaweza **kurekebisha thamani ya sifa zake** kwa kitu kama:
```bash
aws cognito-idp update-user-attributes \
--region us-east-1 --no-sign-request \
--user-attributes Name=address,Value=street \
--access-token <access token>
```
#### Kupandisha hadhi ya siri ya sifa ya desturi

{% hint style="danger" %}
Unaweza kukuta **sifa za desturi** zikitumiwa (kama vile `isAdmin`), kwa chaguo-msingi unaweza **kubadilisha thamani za sifa zako mwenyewe** na huenda ukaweza **kupandisha hadhi** kwa kubadilisha thamani mwenyewe!
{% endhint %}

#### Kupandisha hadhi ya mabadiliko ya barua pepe/jina la mtumiaji

Unaweza kutumia hii kwa **kubadilisha barua pepe na nambari ya simu** ya mtumiaji, lakini, hata kama akaunti inabaki kama imehakikiwa, sifa hizo zitakuwa **zimewekwa katika hali isiyo hakikiwa** (utahitaji kuzihakiki tena).

{% hint style="warning" %}
Hutaweza **kuingia kwa kutumia barua pepe au nambari ya simu** hadi uzihakiki, lakini utaweza **kuingia kwa kutumia jina la mtumiaji**.\
Tambua kwamba hata kama barua pepe ilibadilishwa na haijahakikiwa, itaonekana katika Kitambulisho cha ID ndani ya **`barua pepe`** na sifa ya **`barua pepe_imethibitishwa`** itakuwa **uwongo**, lakini kama programu **haikagua hilo unaweza kujifanya kuwa mtumiaji mwingine**.

Zaidi ya hayo, tambua kwamba unaweza kuweka chochote ndani ya uga wa **`jina`** kwa kubadilisha **sifa ya jina**. Ikiwa programu ina **inakagua** uga huo kwa sababu fulani **badala ya `barua pepe`** (au sifa nyingine yoyote) unaweza kujifanya kuwa **mtumiaji mwingine**.
{% endhint %}

Kwa vyovyote vile, ikiwa kwa sababu fulani ulibadilisha barua pepe yako kwa mfano kuwa mpya unaweza **kuthibitisha barua pepe kwa nambari uliyopokea kwenye anwani hiyo ya barua pepe**:
```bash
aws cognito-idp verify-user-attribute \
--access-token <access_token> \
--attribute-name email --code <code> \
--region <region> --no-sign-request
```
Tumia **`phone_number`** badala ya **`email`** kubadilisha/kuthibitisha **namba mpya ya simu**.

{% hint style="info" %}
Msimamizi pia anaweza kuwezesha chaguo la **kuingia kwa kutumia jina la mtumiaji linalopendelewa**. Tafadhali kumbuka huwezi kubadilisha thamani hii kuwa **jina lolote au preferred\_username tayari linalotumiwa** kujifanya kuwa mtumiaji tofauti.
{% endhint %}

### Kurejesha/Kubadilisha Nenosiri

Inawezekana kurejesha nenosiri kwa kujua tu **jina la mtumiaji** (au barua pepe au simu inakubalika) na kuwa na ufikiaji wake kwani nambari itatumwa hapo:
```bash
aws cognito-idp forgot-password \
--client-id <client_id> \
--username <username/email/phone> --region <region>
```
{% hint style="info" %}
Jibu la seva litakuwa chanya daima, kama vile jina la mtumiaji lilikuwepo. Huwezi kutumia njia hii kuchanganua watumiaji
{% endhint %}

Kwa nambari unaweza kubadilisha nenosiri na:
```bash
aws cognito-idp confirm-forgot-password \
--client-id <client_id> \
--username <username> \
--confirmation-code <conf_code> \
--password <pwd> --region <region>
```
Ili kubadilisha nenosiri unahitaji **kujua nenosiri la awali**:
```bash
aws cognito-idp change-password \
--previous-password <value> \
--proposed-password <value> \
--access-token <value>
```
## Uthibitisho

Kidole cha watumiaji kinaweza kusaidia **njia tofauti za uthibitisho**. Ikiwa una **jina la mtumiaji na nywila** kuna pia **njia tofauti** zinazoungwa mkono za kuingia. Zaidi ya hayo, wakati mtumiaji anathibitishwa kwenye Kidole **aina 3 za vitufe hupewa**: **Kitufe cha ID**, **kitufe cha Upatikanaji** na **kitufe cha Kufufua**.

* [**Kitufe cha ID**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-id-token.html): Ina madai kuhusu **utambulisho wa mtumiaji aliyethibitishwa**, kama vile `jina`, `barua pepe`, na `namba ya simu`. Kitufe cha ID pia kinaweza kutumika ku **kuhakiki watumiaji kwenye seva zako za rasilimali au programu za seva**. Lazima **uhakiki** **sahihi** wa kitufe cha ID kabla ya kuamini madai yoyote ndani ya kitufe cha ID ikiwa unakitumia kwenye programu za nje.
* Kitufe cha ID ndicho kitufe kinach **kujumuisha thamani za sifa za mtumiaji**, hata zile za desturi.
* [**Kitufe cha Upatikanaji**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-access-token.html): Kina madai kuhusu mtumiaji aliye thibitishwa, orodha ya **makundi ya mtumiaji, na orodha ya mizizi**. Lengo la kitufe cha upatikanaji ni **kuhalalisha shughuli za API** katika muktadha wa mtumiaji kwenye kidole cha mtumiaji. Kwa mfano, unaweza kutumia kitufe cha upatikanaji ku **kuidhinisha shughuli za API** za kuongeza, kubadilisha, au kufuta sifa za mtumiaji.
* [**Kitufe cha Kufufua**](https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-the-refresh-token.html): Kwa vitufe vya kufufua unaweza **kupata vitufe vipya vya ID na Upatikanaji** kwa mtumiaji hadi **kitufe cha kufufua kikawa batili**. Kwa **chaguo-msingi**, kitufe cha kufufua **hufikia ukomo baada ya siku 30** tangu mtumiaji wa programu yako ajiandikishe kwenye kidole cha mtumiaji. Unapounda programu kwa kidole chako cha mtumiaji, unaweza kuweka ukomo wa kufutwa kwa kitufe cha kufufua cha programu yako hadi **thamani yoyote kati ya dakika 60 na miaka 10**.

### ADMIN\_NO\_SRP\_UTHIBITISHO & ADMIN\_USER\_PASSWORD\_UTHIBITISHO

Hii ni mchakato wa uthibitisho wa upande wa seva:

* Programu ya upande wa seva inaita **`AdminInitiateAuth` API operation** (badala ya `InitiateAuth`). Operesheni hii inahitaji sifa za AWS zenye ruhusa zinazojumuisha **`cognito-idp:AdminInitiateAuth`** na **`cognito-idp:AdminRespondToAuthChallenge`**. Operesheni inarudisha vigezo vya uthibitisho vinavyohitajika.
* Baada ya programu ya upande wa seva kupata **vigezo vya uthibitisho**, inaita **`AdminRespondToAuthChallenge` API operation**. Operesheni ya API ya `AdminRespondToAuthChallenge` inafanikiwa tu unapotoa sifa za AWS.

Hii **njia HAIJAWEZESHWA** kwa chaguo-msingi.

Ili **kuingia** unahitaji kujua:

* kitambulisho cha kidole cha mtumiaji
* kitambulisho cha mteja
* jina la mtumiaji
* nywila
* siri ya mteja (ikiwa programu imeboreshwa kutumia siri)

{% hint style="info" %}
Ili **kuweza kuingia kwa njia hii** programu hiyo inapaswa kuruhusu kuingia na `RUHUSU_ADMIN_USER_PASSWORD_AUTH`. Zaidi ya hayo, kutekeleza hatua hii unahitaji sifa zenye ruhusa za\*\*`cognito-idp:AdminInitiateAuth`\*\*na **`cognito-idp:AdminRespondToAuthChallenge`**
{% endhint %}
```python
aws cognito-idp admin-initiate-auth \
--client-id <client-id> \
--auth-flow ADMIN_USER_PASSWORD_AUTH \
--region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'
--user-pool-id "<pool-id>"

# Check the python code to learn how to generate the hsecret_hash
```
<details>

<summary>Msimbo wa Kuingia</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.admin_initiate_auth(
UserPoolId=user_pool_id,
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_PASSWORD\_AUTH

Hii njia ni nyingine rahisi na **ya jadi ya uthibitishaji wa mtumiaji na nywila**. Inapendekezwa **kuhamisha njia ya jadi** ya uthibitishaji **kwenda Cognito** na **kupendekezwa** kisha **kuidisable** na **kutumia** njia ya **ALLOW\_USER\_SRP\_AUTH** badala yake (kwani haitumi nywila kupitia mtandao).\
Hii **njia HAIAKTIVI** kwa chaguo-msingi.

To **kuingia** unahitaji kujua:

* kitambulisho cha mteja
* jina la mtumiaji
* nywila
* siri ya mteja (ikiwa programu imeundwa kutumia siri)

{% hint style="info" %}
Ili **kuweza kuingia kwa njia hii**, programu lazima iruhusu kuingia na ALLOW\_USER\_PASSWORD\_AUTH.
{% endhint %}
```python
aws cognito-idp initiate-auth  --client-id <client-id> \
--auth-flow USER_PASSWORD_AUTH --region <region> \
--auth-parameters 'USERNAME=<username>,PASSWORD=<password>,SECRET_HASH=<hash_if_needed>'

# Check the python code to learn how to generate the secret_hash
```
<details>

<summary>Msimbo wa Python wa Kuingia</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64


client_id = "<client-id>"
user_pool_id = "<user-pool-id>"
client_secret = "<client-secret>"
username = "<username>"
password = "<pwd>"

boto_client = boto3.client('cognito-idp', region_name='us-east-1')

def get_secret_hash(username, client_id, client_secret):
key = bytes(client_secret, 'utf-8')
message = bytes(f'{username}{client_id}', 'utf-8')
return base64.b64encode(hmac.new(key, message, digestmod=hashlib.sha256).digest()).decode()

# If the Client App isn't configured to use a secret
## just delete the line setting the SECRET_HASH
def login_user(username_or_alias, password, client_id, client_secret, user_pool_id):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='ADMIN_USER_PASSWORD_AUTH',
AuthParameters={
'USERNAME': username_or_alias,
'PASSWORD': password,
'SECRET_HASH': get_secret_hash(username_or_alias, client_id, client_secret)
}
)
except botocore.exceptions.ClientError as e:
return e.response

print(login_user(username, password, client_id, client_secret, user_pool_id))
```
</details>

### USER\_SRP\_AUTH

Hii ni hali inayofanana na ile ya awali lakini **badala ya kutuma nenosiri** kupitia mtandao kuingia, **uthibitisho wa changamoto unatekelezwa** (hivyo hakuna nenosiri linalosafiri hata likiwa limefichwa kupitia mtandao).\
Hii **njia imeanzishwa** kwa chaguo-msingi.

Kuingia unahitaji kujua:

* kitambulisho cha dimbwi la watumiaji
* kitambulisho cha mteja
* jina la mtumiaji
* nenosiri
* siri ya mteja (ikiwa programu imeboreshwa kutumia siri)
```python
from warrant.aws_srp import AWSSRP
import os

USERNAME='xxx'
PASSWORD='yyy'
POOL_ID='us-east-1_zzzzz'
CLIENT_ID = '12xxxxxxxxxxxxxxxxxxxxxxx'
CLIENT_SECRET = 'secreeeeet'
os.environ["AWS_DEFAULT_REGION"] = "<region>"

aws = AWSSRP(username=USERNAME, password=PASSWORD, pool_id=POOL_ID,
client_id=CLIENT_ID, client_secret=CLIENT_SECRET)
tokens = aws.authenticate_user()
id_token = tokens['AuthenticationResult']['IdToken']
refresh_token = tokens['AuthenticationResult']['RefreshToken']
access_token = tokens['AuthenticationResult']['AccessToken']
token_type = tokens['AuthenticationResult']['TokenType']
```
</details>

### KITHIBITISHO\_LA\_KUHAKIKISHA\_TENAI\_& KITHIBITISHO\_CHA\_KUHAKIKISHA\_TENAI

**Mbinu hii itakuwa halali daima** (haiwezi kulemazwa) lakini unahitaji kuwa na kithibitisho cha kuhakikisha tena kilicho halali.
```bash
aws cognito-idp initiate-auth \
--client-id 3ig6h5gjm56p1ljls1prq2miut \
--auth-flow REFRESH_TOKEN_AUTH \
--region us-east-1 \
--auth-parameters 'REFRESH_TOKEN=<token>'
```
<details>

<summary>Msimbo wa kusasisha</summary>
```python
import boto3
import botocore
import hmac
import hashlib
import base64

client_id = "<client-id>"
token = '<token>'

boto_client = boto3.client('cognito-idp', region_name='<region>')

def refresh(client_id, refresh_token):
try:
return boto_client.initiate_auth(
ClientId=client_id,
AuthFlow='REFRESH_TOKEN_AUTH',
AuthParameters={
'REFRESH_TOKEN': refresh_token
}
)
except botocore.exceptions.ClientError as e:
return e.response


print(refresh(client_id, token))
```
</details>

### CUSTOM\_AUTH

Katika kesi hii **uthibitisho** utafanywa kupitia **utekelezaji wa kazi ya lambda**.

## Usalama wa ziada

### Usalama wa juu

Kwa chaguo-msingi imelemazwa, lakini ikiruhusiwa, Cognito inaweza kuwa na uwezo wa **kugundua utekaji wa akaunti**. Ili kupunguza uwezekano unapaswa kuingia kutoka kwenye **mtandao ndani ya mji huo huo, ukitumia kivinjari kimoja** (na IP ikiwezekana)**.**

### **MFA Kumbuka kifaa**

Ikiwa mtumiaji anaingia kutoka kwenye kifaa kile kile, MFA inaweza kudukuliwa, hivyo jaribu kuingia kutoka kwenye kivinjari kile kile na metadata ile ile (IP?) kujaribu kudukua ulinzi wa MFA.

## Majukumu ya IAM ya Vikundi vya Kidakika vya Watumiaji

Inawezekana kuongeza **watumiaji kwenye vikundi vya Kidakika vya Watumiaji** vinavyohusiana na **majukumu ya IAM** moja kwa moja.\
Zaidi ya hayo, **watumiaji** wanaweza kupewa **zaidi ya kikundi kimoja chenye majukumu tofauti ya IAM** yanayohusishwa.

Tambua kwamba hata kama kikundi kimoja kipo ndani ya kikundi chenye jukumu la IAM lililopewa, ili kuweza kupata **vitambulisho vya IAM vya kikundi hicho** ni lazima kwamba **Kidakika cha Watumiaji kinaaminiwa na Kidakika cha Kitambulisho** (na kujua maelezo ya Kidakika hicho).

Mahitaji mengine ya kupata **jukumu la IAM lililoelezwa katika IdToken** wakati mtumiaji anathibitishwa kwenye Kidakika cha Watumiaji (`aws cognito-idp initiate-auth...`) ni kwamba **mtoa uthibitishaji wa Mtoa Huduma** anahitaji kuonyesha kwamba **jukumu linapaswa kuchaguliwa kutoka kwa token.**

<figure><img src="../../../../.gitbook/assets/image (250).png" alt=""><figcaption></figcaption></figure>

**Majukumu** ambayo mtumiaji ana ufikiaji yanapatikana **ndani ya `IdToken`**, na mtumiaji anaweza **kuchagua ni jukumu gani anataka vitambulisho vya** kwa kutumia **`--custom-role-arn`** kutoka `aws cognito-identity get-credentials-for-identity`.\
Hata hivyo, ikiwa **chaguo la msingi** ndilo **lililowekwa** (`tumia jukumu la msingi`), na ukijaribu kupata jukumu kutoka kwa IdToken, utapata **kosa** (ndiyo maana usanidi uliopita unahitajika):

{% code overflow="wrap" %}
```
An error occurred (InvalidParameterException) when calling the GetCredentialsForIdentity operation: Only SAML providers and providers with RoleMappings support custom role ARN.
```
{% endcode %}

{% hint style="warning" %}
Tafadhali kumbuka kuwa jukumu lililopewa **Kikundi cha Kidakuzi cha Watumiaji** linahitaji kuwa **linaweza kufikiwa na Mtoaji wa Kitambulisho** ambaye **anamtumaini Kidakuzi cha Watumiaji** (kwani **vyeti vya kikao vya jukumu la IAM vitapatikana kutoka kwake**).
{% endhint %}
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "cognito-identity.amazonaws.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"cognito-identity.amazonaws.com:aud": "us-east-1:2361092e-9db6-a876-1027-10387c9de439"
},
"ForAnyValue:StringLike": {
"cognito-identity.amazonaws.com:amr": "authenticated"
}
}
}
]
}js
```
<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
