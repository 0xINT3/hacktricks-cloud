# AWS - Enumeración de Cognito

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Cognito

Cognito proporciona **autenticación, autorización y gestión de usuarios** para tus aplicaciones web y móviles. Tus usuarios pueden iniciar sesión directamente con un **nombre de usuario y contraseña**, o a través de un **tercero** como Facebook, Amazon, Google o Apple.

Los dos componentes principales de Amazon Cognito son los **grupos de usuarios** y los **grupos de identidades**. Los **grupos de usuarios** son directorios de usuarios que proporcionan **opciones de registro e inicio de sesión para los usuarios de tu aplicación**. Los **grupos de identidades** te permiten **conceder a tus usuarios acceso a otros servicios de AWS**.

### **Grupos de usuarios**

Para aprender qué es un **Grupo de usuarios de Cognito**, consulta:

{% content-ref url="cognito-user-pools.md" %}
[cognito-user-pools.md](cognito-user-pools.md)
{% endcontent-ref %}

### **Grupos de identidades**

Para aprender qué es un **Grupo de identidades de Cognito**, consulta:

{% content-ref url="cognito-identity-pools.md" %}
[cognito-identity-pools.md](cognito-identity-pools.md)
{% endcontent-ref %}

### Módulos de Pacu para pentesting y enumeración

[Pacu](https://github.com/RhinoSecurityLabs/pacu), el framework de explotación de AWS, ahora incluye los módulos "cognito__enum" y "cognito__attack" que automatizan la enumeración de todos los activos de Cognito en una cuenta y detectan configuraciones débiles, atributos de usuario utilizados para el control de acceso, etc., y también automatizan la creación de usuarios (incluido el soporte de MFA) y la escalada de privilegios basada en atributos personalizados modificables, credenciales de grupo de identidades utilizables, roles asumibles en tokens de identidad, etc.

Para obtener una descripción de las funciones de los módulos, consulta la parte 2 de la [publicación del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para obtener instrucciones de instalación, consulta la página principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

### Uso

Uso de muestra de cognito__attack para intentar la creación de usuarios y todos los vectores de escalada de privilegios contra un grupo de identidades y un cliente de grupo de usuarios específicos:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Uso de muestra de cognito__enum para recopilar todas las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad, usuarios, etc. visibles en la cuenta actual de AWS:

```bash
$ python3 cognito__enum.py --access-key <AWS_ACCESS_KEY> --secret-key <AWS_SECRET_KEY> --region <AWS_REGION>
```

Este script utiliza las credenciales de acceso y clave secreta de AWS proporcionadas para enumerar y recopilar información sobre las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad y usuarios asociados a la cuenta de AWS especificada. Asegúrese de reemplazar `<AWS_ACCESS_KEY>`, `<AWS_SECRET_KEY>` y `<AWS_REGION>` con los valores correspondientes.

Una vez que se ejecute el script, se mostrará una lista detallada de las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad y usuarios encontrados en la cuenta de AWS especificada. Esta información puede ser útil para evaluar la seguridad y configuración de los servicios de Cognito en la cuenta de AWS.
```bash
Pacu (new:test) > run cognito__enum
```
## Herramienta para pentesting

[Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta de línea de comandos en Python que implementa diferentes ataques en Cognito, incluyendo enumeración de cuentas y escalada de privilegios.

### Instalación
```bash
$ pip install cognito-scanner
```
### Uso

```bash
python3 aws_cognito_enum.py --usernames usernames.txt --pool-id <pool_id> --client-id <client_id> --region <region>
```

### Descripción

Esta herramienta enumera los nombres de usuario válidos en un grupo de usuarios de Amazon Cognito. Utiliza la API de Amazon Cognito para realizar la enumeración.

### Argumentos

- `--usernames`: Archivo que contiene una lista de nombres de usuario para probar.
- `--pool-id`: ID del grupo de usuarios de Amazon Cognito.
- `--client-id`: ID del cliente de Amazon Cognito.
- `--region`: Región de Amazon Cognito.

### Ejemplo

```bash
python3 aws_cognito_enum.py --usernames usernames.txt --pool-id us-west-2_ABC123 --client-id 1234567890abcdef1234567890abcdef --region us-west-2
```

### Notas

- Asegúrese de tener las credenciales adecuadas para acceder a la API de Amazon Cognito.
- Esta herramienta solo enumera los nombres de usuario válidos en un grupo de usuarios de Amazon Cognito. No realiza ninguna acción adicional.
```bash
$ cognito-scanner --help
```
Para obtener más información, visita https://github.com/padok-team/cognito-scanner

## Enumeración

{% code overflow="wrap" %}
```bash
# List Identity Pools
aws cognito-identity list-identity-pools --max-results 60
aws cognito-identity describe-identity-pool --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
aws cognito-identity list-identities --identity-pool-id <ident-pool-id> --max-results 60
aws cognito-identity get-identity-pool-roles --identity-pool-id <ident-pool-id>

# Identities Datasets
## Get dataset of identity id (inside identity pool)
aws cognito-sync list-datasets --identity-pool-id <ident-pool-id> --identity-id <ident-id>
## Get info of the dataset
aws cognito-sync describe-dataset --identity-pool-id <value> --identity-id <value> --dataset-name <value>
## Get dataset records
aws cognito-sync list-records --identity-pool-id <value> --identity-id <value> --dataset-name <value>

# User Pools
## Get pools
aws cognito-idp list-user-pools --max-results 60

## Get users
aws cognito-idp list-users --user-pool-id <user-pool-id>

## Get groups
aws cognito-idp list-groups --user-pool-id <user-pool-id>

## Get users in a group
aws cognito-idp list-users-in-group --user-pool-id <user-pool-id> --group-name <group-name>

## List App IDs of a user pool
aws cognito-idp list-user-pool-clients --user-pool-id <user-pool-id>

## List configured identity providers for a user pool
aws cognito-idp list-identity-providers --user-pool-id <user-poo

## List user import jobs
aws cognito-idp list-user-import-jobs --user-pool-id <user-pool-id> --max-results 60

## Get MFA config of a user pool
aws cognito-idp get-user-pool-mfa-config --user-pool-id <user-pool-id>

## Get risk configuration
aws cognito-idp describe-risk-configuration --user-pool-id <user-pool-id>
```
{% endcode %}

### Enumeración de Identity Pools sin autenticación

Simplemente **conocer el ID del Identity Pool**, podrías ser capaz de **obtener las credenciales del rol asociado a los usuarios sin autenticación** (si existe alguno). [**Mira cómo aquí**](cognito-identity-pools.md#accessing-iam-roles).

### Enumeración de User Pools sin autenticación

Incluso si **no conoces un nombre de usuario válido** dentro de Cognito, podrías ser capaz de **enumerar** nombres de usuario válidos, **probar** las **contraseñas** o incluso **registrar un nuevo usuario** simplemente **conociendo el ID del cliente de la aplicación** (que generalmente se encuentra en el código fuente). [**Mira cómo aquí**](cognito-user-pools.md#registration)**.**

## Escalada de privilegios

{% content-ref url="../../aws-privilege-escalation/aws-cognito-privesc.md" %}
[aws-cognito-privesc.md](../../aws-privilege-escalation/aws-cognito-privesc.md)
{% endcontent-ref %}

## Acceso sin autenticación

{% content-ref url="../../aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum.md" %}
[aws-cognito-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum.md)
{% endcontent-ref %}

## Persistencia

{% content-ref url="../../../aws-pentesting/aws-persistence/aws-cognito-persistence.md" %}
[aws-cognito-persistence.md](../../../aws-pentesting/aws-persistence/aws-cognito-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
