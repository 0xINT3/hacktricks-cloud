# AWS - Redshift Enum

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Amazon Redshift

Redshift ni huduma iliyosimamiwa kabisa ambayo inaweza kupanuka hadi zaidi ya petabyte moja kwa ukubwa, ambayo hutumiwa kama **ghala la data kwa suluhisho kubwa za data**. Kwa kutumia vikundi vya Redshift, unaweza kufanya uchambuzi dhidi ya seti yako ya data kwa kutumia zana za uchambuzi za haraka zinazotegemea SQL na programu za ujasusi wa biashara ili kupata uelewa mkubwa wa maono ya biashara yako.

**Redshift inatoa encryption wakati wa kupumzika kwa kutumia ierarkia ya fungu la maneno la encryption lenye safu nne kwa kutumia KMS au CloudHSM kusimamia fungu la juu la funguo**. **Wakati encryption inapowashwa kwa kikundi chako, haiwezi kuzimwa na kinyume chake**. Unapokuwa na kikundi kisichofungwa, hakiwezi kuwa encrypted.

Encryption kwa kikundi chako inaweza kutokea wakati wa uumbaji wake, na mara ilipo encrypted, data, metadata, na snapshots yoyote pia ni encrypted. Viwango vya ierarkia ya funguo la encryption ni kama ifuatavyo, **kiwango cha kwanza ni funguo la msingi, kiwango cha pili ni funguo la encryption la kikundi, CEK, kiwango cha tatu, funguo la encryption la database, DEK, na hatimaye kiwango cha nne, funguo la data encryption yenyewe**.

### KMS

Wakati wa uumbaji wa kikundi chako, unaweza kuchagua **funguo la KMS la chaguo-msingi** kwa Redshift au kuchagua **CMK yako mwenyewe**, ambayo inakupa uwezo zaidi juu ya udhibiti wa funguo, hasa kutoka mtazamo wa ukaguzi.

Funguo la KMS la chaguo-msingi kwa Redshift huundwa moja kwa moja na Redshift mara ya kwanza chaguo la funguo linapochaguliwa na kutumika, na inasimamiwa kabisa na AWS.

Kisha funguo hili la KMS linachifratishwa na funguo la msingi la CMK, kiwango cha kwanza. Funguo hili la data la KMS lililochifratishwa kisha hutumiwa kama funguo la encryption la kikundi, CEK, kiwango cha pili. CEK hii kisha hutumwa na KMS kwa Redshift ambapo inahifadhiwa kando na kikundi. Redshift kisha hutoa CEK hii iliyochifratishwa kwa kikundi kupitia kituo salama ambapo inahifadhiwa kwenye kumbukumbu.

Redshift kisha inaomba KMS kuchifratisha CEK, kiwango cha pili. CEK hii iliyochifratishwa kisha pia inahifadhiwa kwenye kumbukumbu. Redshift kisha hujenga funguo la encryption la database la random, DEK, kiwango cha tatu, na kulipakia kwenye kumbukumbu ya kikundi. CEK iliyochifratishwa kwenye kumbukumbu kisha inachifratisha DEK, ambayo pia inahifadhiwa kwenye kumbukumbu.

DEK hii iliyochifratishwa kisha hutumwa kupitia kituo salama na kuhifadhiwa kwenye Redshift kando na kikundi. Kote CEK na DEK sasa zimehifadhiwa kwenye kumbukumbu ya kikundi kwa hali ya kichifratishwa na kichifratishwa. DEK iliyochifratishwa kisha hutumiwa kuchifratisha funguo za data, kiwango cha nne, ambazo zinazalishwa kwa nasibu na Redshift kwa kila bloki ya data katika database.

Unaweza kutumia Mshauri Mteule wa AWS kufuatilia usanidi wa vikapu vyako vya Amazon S3 na kuhakikisha kuwa ufuatiliaji wa kikapu umewashwa, ambao unaweza kuwa na manufaa kwa kufanya ukaguzi wa usalama na kufuatilia mifumo ya matumizi katika S3.

### CloudHSM

<details>

<summary>Kutumia Redshift na CloudHSM</summary>

Unapofanya kazi na CloudHSM kufanya encryption yako, kwanza lazima uweke uhusiano wa kuaminika kati ya mteja wako wa HSM na Redshift wakati unatumia vyeti vya mteja na seva.

Uhusiano huu unahitajika kutoa mawasiliano salama, kuruhusu funguo za encryption kutumwa kati ya mteja wako wa HSM na vikundi vyako vya Redshift. Kwa kutumia jozi ya funguo ya faragha na ya umma iliyozalishwa kwa nasibu, Redshift huunda cheti cha mteja cha umma, ambacho kimechifratishwa na kuhifadhiwa na Redshift. Hiki lazima kipakuliwe na kusajiliwa kwa mteja wako wa HSM, na kuhusishwa na sehemu sahihi ya HSM.

Kisha lazima uweke Redshift na maelezo yafuatayo ya mteja wako wa HSM: anwani ya IP ya HSM, jina la sehemu ya HSM, nenosiri la sehemu ya HSM, na cheti cha seva cha HSM cha umma, ambacho kimechifratishwa na CloudHSM kwa kutumia funguo la msingi la ndani. Mara habari hii imetolewa, Redshift itathibitisha na kuhakikisha kuwa inaweza kuunganisha na kufikia sehemu ya maendeleo.

Ikiwa sera zako za usalama za ndani au udhibiti wa utawala unadai kwamba lazima utumie mzunguko wa funguo, basi hii inawezekana na Redshift ikikuruhusu kuzungusha funguo za encryption kwa vikundi vilivyofungwa, hata hivyo, lazima uwe na ufahamu kwamba wakati wa mchakato wa mzunguko wa funguo, itafanya kikundi kuwa haipatikani kwa kipindi kifupi sana, hivyo ni bora kuzungusha funguo wakati unahitaji tu, au ikiwa unahisi kwamba zinaweza kuwa zimevujishwa.

Wakati wa mzunguko, Redshift itazungusha CEK kwa kikundi chako na kwa nakala rudufu za kikundi hicho. Itazungusha DEK kwa kikundi lakini haiwezekani kuzungusha DEK kwa picha za nakala rudufu zilizohifadhiwa kwenye S3 ambazo zimechifratishwa kwa kutumia DEK. Itaweka kikundi katika hali ya 'kuzungusha funguo' hadi mchakato utakapokamilika wakati hali itarudi kuwa 'ipatikane'.

</details>

### Urambazaji

```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Uthabiti

Vitendo vifuatavyo vinaruhusu kutoa ufikiaji kwa akaunti zingine za AWS kwa kikundi:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
