# AWS - Redshift Enum

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Amazon Redshift

Redshift to w pełni zarządzana usługa, która może skalować się do ponad petabajta i jest używana jako **magazyn danych dla rozwiązań big data**. Korzystając z klastrów Redshift, można wykonywać analizy na zbiorach danych za pomocą szybkich narzędzi zapytań opartych na SQL i aplikacji do inteligencji biznesowej, aby uzyskać większe zrozumienie wizji dla swojego biznesu.

**Redshift oferuje szyfrowanie w spoczynku za pomocą czteropoziomowej hierarchii kluczy szyfrowania, korzystając z KMS lub CloudHSM do zarządzania najwyższym poziomem kluczy**. **Po włączeniu szyfrowania dla klastra nie można go wyłączyć, a vice versa**. Kiedy masz niezaszyfrowany klaster, nie można go zaszyfrować.

Szyfrowanie dla klastra może odbywać się tylko podczas jego tworzenia, a po zaszyfrowaniu dane, metadane i wszelkie migawki są również szyfrowane. Poziomy hierarchii kluczy szyfrowania są następujące: **poziom pierwszy to klucz główny, poziom drugi to klucz szyfrowania klastra (CEK), poziom trzeci to klucz szyfrowania bazy danych (DEK), a na koniec poziom czwarty to same klucze szyfrowania danych**.

### KMS

Podczas tworzenia klastra można wybrać albo **domyślny klucz KMS** dla Redshift, albo wybrać **własny CMK**, co daje większą elastyczność w kontroli klucza, zwłaszcza z perspektywy audytu.

Domyślny klucz KMS dla Redshift jest automatycznie tworzony przez Redshift przy pierwszym wybraniu opcji klucza i jest w pełni zarządzany przez AWS.

Ten klucz KMS jest następnie zaszyfrowany kluczem głównym CMK, poziom pierwszy. Ten zaszyfrowany klucz danych KMS jest następnie używany jako klucz szyfrowania klastra, CEK, poziom drugi. Ten CEK jest następnie wysyłany przez KMS do Redshift, gdzie jest przechowywany oddzielnie od klastra. Redshift następnie wysyła ten zaszyfrowany CEK do klastra przez bezpieczny kanał, gdzie jest przechowywany w pamięci.

Redshift następnie żąda od KMS odszyfrowania CEK, poziom drugi. Ten odszyfrowany CEK jest również przechowywany w pamięci. Redshift następnie tworzy losowy klucz szyfrowania bazy danych, DEK, poziom trzeci, i wczytuje go do pamięci klastra. Odszyfrowany CEK w pamięci następnie szyfruje DEK, który również jest przechowywany w pamięci.

Ten zaszyfrowany DEK jest następnie wysyłany przez bezpieczny kanał i przechowywany w Redshift oddzielnie od klastra. Zarówno CEK, jak i DEK są teraz przechowywane w pamięci klastra zarówno w zaszyfrowanej, jak i odszyfrowanej formie. Odszyfrowany DEK jest następnie używany do szyfrowania kluczy danych, poziom czwarty, które są losowo generowane przez Redshift dla każdego bloku danych w bazie danych.

Możesz użyć AWS Trusted Advisor do monitorowania konfiguracji swoich kubełków Amazon S3 i upewnienia się, że logowanie kubełka jest włączone, co może być przydatne do przeprowadzania audytów bezpieczeństwa i śledzenia wzorców użytkowania w S3.

### CloudHSM

<details>

<summary>Korzystanie z Redshift z CloudHSM</summary>

Pracując z CloudHSM w celu wykonania szyfrowania, najpierw musisz skonfigurować zaufane połączenie między klientem HSM a Redshift, korzystając z certyfikatów klienta i serwera.

To połączenie jest wymagane do zapewnienia bezpiecznej komunikacji, umożliwiającej wysyłanie kluczy szyfrowania między klientem HSM a klastrami Redshift. Korzystając z losowo generowanej pary kluczy prywatnego i publicznego, Redshift tworzy publiczny certyfikat klienta, który jest szyfrowany i przechowywany przez Redshift. Musi być on pobrany i zarejestrowany w kliencie HSM, a następnie przypisany do odpowiedniej partycji HSM.

Następnie musisz skonfigurować Redshift z następującymi danymi dotyczącymi klienta HSM: adres IP HSM, nazwę partycji HSM, hasło partycji HSM i publiczny certyfikat serwera HSM, który jest szyfrowany przez CloudHSM za pomocą wewnętrznego klucza głównego. Po dostarczeniu tych informacji Redshift potwierdzi i zweryfikuje, czy może nawiązać połączenie i uzyskać dostęp do partycji deweloperskiej.

Jeśli twoje wewnętrzne polityki bezpieczeństwa lub kontrole zarządzania wymagają rotacji kluczy, jest to możliwe w Redshift, umożliwiając rotację kluczy szyfrowania dla zaszyfrowanych klastrów. Należy jednak pamiętać, że podczas procesu rotacji kluczy, klaster staje się niedostępny przez bardzo krótki okres czasu, dlatego najlepiej rotować klucze tylko wtedy, gdy jest to konieczne, lub jeśli podejrzewasz, że mogły zostać skompromitowane.

Podczas rotacji Redshift będzie rotować CEK dla klastra i dla wszystkich kopii zapasowych tego klastra. Rotuje DEK dla klastra, ale niemożliwe jest rotowanie DEK dla migawek przechowywanych w S3, które zostały zaszyfrowane za pomocą DEK. Klastr zostanie ustawiony w stanie "rotating keys" do momentu zakończenia procesu, a następnie status wróci do "available".

</details>

### Wyliczanie

```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Trwałość

Następujące działania umożliwiają udzielenie dostępu do klastra innym kontom AWS:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
