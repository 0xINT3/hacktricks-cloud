# AWS - Redshift Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를** **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## Amazon Redshift

Redshift는 **빅 데이터 솔루션을 위한 데이터 웨어하우스**로 사용되는 **페타바이트 이상으로 확장 가능한 완전히 관리되는 서비스**입니다. Redshift 클러스터를 사용하여 빠른 SQL 기반 쿼리 도구와 비즈니스 인텔리전스 애플리케이션을 사용하여 데이터셋에 대한 분석을 실행하고 비즈니스의 비전을 더 잘 이해할 수 있습니다.

**Redshift는 KMS 또는 CloudHSM을 사용하여 네 단계의 암호화 키 계층을 사용하여 데이터를 안전하게 저장**합니다. **클러스터에 대한 암호화가 활성화되면 비활성화할 수 없으며 그 반대도 마찬가지입니다**. 암호화되지 않은 클러스터는 암호화할 수 없습니다.

클러스터의 암호화는 생성 중에만 가능하며, 암호화된 경우 데이터, 메타데이터 및 스냅샷도 암호화됩니다. 암호화 키의 계층 수준은 다음과 같습니다. **티어 1은 마스터 키, 티어 2는 클러스터 암호화 키(CEK), 티어 3은 데이터베이스 암호화 키(DEK)이고, 마지막으로 티어 4는 데이터 암호화 키 자체입니다**.

### KMS

클러스터 생성 중에 Redshift의 **기본 KMS 키**를 선택하거나 **자체 CMK**를 선택할 수 있습니다. 자체 CMK를 선택하면 키의 제어에 대한 감사 관점에서 더 많은 유연성을 제공합니다.

Redshift의 기본 KMS 키는 Redshift가 키 옵션을 선택하고 사용하는 첫 번째 시간에 자동으로 생성되며, AWS가 완전히 관리합니다.

이 KMS 키는 그 다음에 CMK 마스터 키(티어 1)로 암호화됩니다. 이 암호화된 KMS 데이터 키는 클러스터 암호화 키(CEK, 티어 2)로 사용됩니다. 이 CEK는 KMS에 의해 Redshift로 전송되어 클러스터와 별도로 저장됩니다. 그런 다음 Redshift는 이 암호화된 CEK를 안전한 채널을 통해 클러스터로 전송하여 메모리에 저장합니다.

Redshift는 그런 다음 KMS에게 CEK(티어 2)를 복호화하도록 요청합니다. 이 복호화된 CEK도 메모리에 저장됩니다. 그런 다음 Redshift는 무작위로 생성된 데이터베이스 암호화 키(DEK, 티어 3)를 생성하고 클러스터의 메모리에로드합니다. 메모리에 저장된 복호화된 CEK는 메모리에 저장된 DEK를 암호화하고 이를 메모리에 저장합니다.

이 암호화된 DEK는 안전한 채널을 통해 전송되어 클러스터와 별도로 Redshift에 저장됩니다. CEK와 DEK는 이제 클러스터의 메모리에 암호화 및 복호화된 형태로 모두 저장됩니다. 복호화된 DEK는 데이터베이스의 각 데이터 블록에 대해 Redshift가 무작위로 생성한 데이터 키(티어 4)를 암호화하는 데 사용됩니다.

Amazon S3 버킷의 구성을 모니터링하고 버킷 로깅이 활성화되어 있는지 확인하기 위해 AWS Trusted Advisor를 사용할 수 있으며, 이는 보안 감사 및 사용 패턴 추적에 유용할 수 있습니다.

### CloudHSM

<details>

<summary>CloudHSM을 사용하여 Redshift 사용</summary>

암호화를 수행하기 위해 CloudHSM을 사용할 때, 먼저 HSM 클라이언트와 Redshift 간에 신뢰할 수 있는 연결을 설정해야 합니다. 이 연결은 암호화 키를 HSM 클라이언트와 Redshift 클러스터 간에 전송할 수 있도록 안전한 통신을 제공하기 위해 필요합니다.

Redshift는 무작위로 생성된 개인 및 공개 키 쌍을 사용하여 공개 클라이언트 인증서를 생성하고 이를 암호화하여 Redshift에 저장합니다. 이 인증서를 다운로드하고 HSM 클라이언트에 등록하고 올바른 HSM 파티션에 할당해야 합니다.

그런 다음 Redshift를 다음과 같은 HSM 클라이언트의 세부 정보로 구성해야 합니다. HSM IP 주소, HSM 파티션 이름, HSM 파티션 비밀번호 및 CloudHSM이 내부 마스터 키를 사용하여 암호화한 공개 HSM 서버 인증서입니다. 이 정보를 제공하면 Redshift가 개발 파티션에 연결하고 액세스할 수 있는지 확인 및 검증합니다.

내부 보안 정책이나 거버넌스 컨트롤에서 키 회전을 적용해야 한다는 경우, 암호화된 클러스터의 암호화 키를 회전할 수 있습니다. 그러나 키 회전 프로세스 중에 클러스터를 매우 짧은 시간 동안 사용할 수 없게 만들기 때문에 필요할 때만 키를 회전하거나 유출되었을 수 있다고 생각되는 경우에만 회전하는 것이 좋습니다.

회전 중에 Redshift는 클러스터의 CEK와 해당 클러스터의 백업을 회전합니다. 클러스터의 DEK도 회전하지만 DEK를 사용하여 암호화된 S3에 저장된 스냅샷의 DEK를 회전할 수는 없습니다. 클러스터는 '키 회전' 상태로 전환되며 프로세스가 완료되면 상태가 '사용 가능'로 변경됩니다.

</details>

### 열거

```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

다음 작업은 클러스터에 다른 AWS 계정에 대한 액세스 권한을 부여하는 데 사용됩니다:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* 회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family)인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
