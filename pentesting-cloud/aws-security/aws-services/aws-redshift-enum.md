# AWS - Enumerazione di Redshift

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Amazon Redshift

Redshift √® un servizio completamente gestito che pu√≤ scalare fino a oltre un petabyte di dimensione, utilizzato come **data warehouse per soluzioni big data**. Utilizzando cluster Redshift, √® possibile eseguire analisi sui tuoi set di dati utilizzando strumenti di query veloci basati su SQL e applicazioni di business intelligence per ottenere una maggiore comprensione della visione per la tua attivit√†.

**Redshift offre la crittografia a riposo utilizzando una gerarchia a quattro livelli di chiavi di crittografia utilizzando KMS o CloudHSM per gestire il livello superiore delle chiavi**. **Quando la crittografia √® abilitata per il tuo cluster, non pu√≤ essere disabilitata e viceversa**. Quando hai un cluster non crittografato, non pu√≤ essere crittografato.

La crittografia per il tuo cluster pu√≤ avvenire solo durante la sua creazione e, una volta crittografato, i dati, i metadati e gli snapshot sono anche crittografati. I livelli di gerarchia delle chiavi di crittografia sono i seguenti, **il livello uno √® la chiave principale, il livello due √® la chiave di crittografia del cluster, il CEK, il livello tre, la chiave di crittografia del database, il DEK, e infine il livello quattro, le chiavi di crittografia dei dati stessi**.

### KMS

Durante la creazione del tuo cluster, puoi selezionare la **chiave KMS predefinita** per Redshift o selezionare la **tua CMK**, che ti offre maggiore flessibilit√† sul controllo della chiave, specificamente da un punto di vista verificabile.

La chiave KMS predefinita per Redshift viene creata automaticamente da Redshift la prima volta che viene selezionata e utilizzata l'opzione della chiave ed √® completamente gestita da AWS.

Questa chiave KMS viene quindi crittografata con la chiave principale CMK, livello uno. Questa chiave di dati KMS crittografata viene quindi utilizzata come chiave di crittografia del cluster, il CEK, livello due. Questo CEK viene quindi inviato da KMS a Redshift dove viene memorizzato separatamente dal cluster. Redshift invia quindi questo CEK crittografato al cluster su un canale sicuro dove viene memorizzato in memoria.

Redshift quindi richiede a KMS di decrittografare il CEK, livello due. Questo CEK decrittografato viene quindi anch'esso memorizzato in memoria. Redshift quindi crea una chiave di crittografia del database casuale, il DEK, livello tre, e la carica nella memoria del cluster. Il CEK decrittografato in memoria crittografa il DEK, che viene anch'esso memorizzato in memoria.

Questo DEK crittografato viene quindi inviato su un canale sicuro e memorizzato in Redshift separatamente dal cluster. Sia il CEK che il DEK sono ora memorizzati in memoria del cluster sia in forma crittografata che decrittografata. Il DEK decrittografato viene quindi utilizzato per crittografare le chiavi di dati, livello quattro, che vengono generate casualmente da Redshift per ciascun blocco di dati nel database.

Puoi utilizzare AWS Trusted Advisor per monitorare la configurazione dei tuoi bucket Amazon S3 e assicurarti che il logging del bucket sia abilitato, il che pu√≤ essere utile per eseguire audit di sicurezza e tracciare i modelli di utilizzo in S3.

### CloudHSM

<details>

<summary>Utilizzo di Redshift con CloudHSM</summary>

Quando si lavora con CloudHSM per eseguire la crittografia, innanzitutto √® necessario configurare una connessione attendibile tra il client HSM e Redshift utilizzando certificati client e server.

Questa connessione √® necessaria per fornire comunicazioni sicure, consentendo alle chiavi di crittografia di essere inviate tra il client HSM e i cluster Redshift. Utilizzando una coppia di chiavi privata e pubblica generata casualmente, Redshift crea un certificato client pubblico, che viene crittografato e memorizzato da Redshift. Questo deve essere scaricato e registrato al client HSM e assegnato alla partizione HSM corretta.

√à quindi necessario configurare Redshift con i seguenti dettagli del client HSM: l'indirizzo IP HSM, il nome della partizione HSM, la password della partizione HSM e il certificato server HSM pubblico, che viene crittografato da CloudHSM utilizzando una chiave principale interna. Una volta fornite queste informazioni, Redshift confermer√† e verificher√† che possa connettersi e accedere alla partizione di sviluppo.

Se le politiche di sicurezza interne o i controlli di governance impongono di applicare la rotazione delle chiavi, allora √® possibile con Redshift consentendo di ruotare le chiavi di crittografia per i cluster crittografati, tuttavia, √® necessario essere consapevoli che durante il processo di rotazione delle chiavi, render√† un cluster non disponibile per un periodo molto breve, quindi √® meglio ruotare le chiavi solo quando √® necessario, o se si ritiene che possano essere compromesse.

Durante la rotazione, Redshift ruoter√† il CEK per il tuo cluster e per qualsiasi backup di quel cluster. Ruoter√† un DEK per il cluster ma non √® possibile ruotare un DEK per gli snapshot memorizzati in S3 che sono stati crittografati utilizzando il DEK. Metter√† il cluster in uno stato di 'rotazione delle chiavi' fino a quando il processo non sar√† completato, momento in cui lo stato torner√† a 'disponibile'.

</details>

### Enumerazione
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistenza

Le seguenti azioni consentono di concedere l'accesso ad altri account AWS al cluster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
