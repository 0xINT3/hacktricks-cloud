# AWS - 悪意のあるVPCミラー

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

VPCトラフィックミラーリングは、VPC内のEC2インスタンスの受信および送信トラフィックを**インスタンス自体に何もインストールする必要なく複製**します。この複製されたトラフィックは、通常、ネットワーク侵入検知システム（IDS）などに送信され、分析および監視のために使用されます。

クラウドでの一般的なネットワーク検査の難しさにより、ペンテスターはElastic Load Balancerのアクセスログのような他の簡単な手段に頼ることがあります。これらのログは何かしらの情報を提供しますが、完全なネットワークトラフィック検査と比較すると非常に限定的です。

### クレデンシャルが侵害されたAWSクレデンシャルを使用して悪意のあるミラーを展開する

重要なことは、**VPCトラフィックミラーリング**は、[**AWS Nitroシステム**](https://aws.amazon.com/ec2/nitro/)で動作する**EC2**インスタンスタイプのみをサポートしており、**VPCミラーターゲットはミラーされるホストと同じVPC内**にある必要があるということです。

次の数節では、malmirrorの動作方法、行うこと、および抽出されたデータの分析方法について説明します。スクリプト自体は、[こちらのGitHubで見つけることができます](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/)。

#### malmirrorの動作方法

malmirrorは、次のリソースをアカウントに展開します：

* トラフィックをミラーリングするためのEC2インスタンス
* そのEC2インスタンスのためのEC2セキュリティグループ
* 作成されたEC2インスタンスを指すVPCミラーターゲット
* すべてのトラフィックをミラーリングするように構成されたVPCミラーフィルタ
* アカウント内の各サポートされているEC2インスタンスに対するVPCミラーセッション

![](<../../../../.gitbook/assets/image (72).png>)

すべてが展開された後、**トラフィックは作成されたEC2インスタンスにミラーリングされ始めます**。EC2インスタンスは、受信したすべてのミラーネットワークトラフィックをPCAP形式で受信し、ログに記録します。ローカルに保存されたデータが約**100MBに達すると、自動的に選択したS3バケット（おそらく自分自身のAWSアカウント内）にそのデータを**外部へ転送し、システムからローカルファイルを削除します。これにより、インスタンスの容量不足を防ぎ、ミラーリングされたトラフィックを自動的に外部へ転送することができます。100MBの制限は任意のものであり、トラフィックがより多く流れるネットワークでは非常に小さすぎる場合があります。トラフィックはこの方法で外部へ転送されるのは、トラフィックをクロスアカウントでミラーリングする簡単な方法が見つからなかったためであり、データが環境から外部へ出ることを確実にするために信頼性のある方法と思われます。

トラフィックがS3バケットに外部へ転送される間、分析のためにローカルにダウンロードすることができます。これを行うための簡単な方法は、[AWS CLIが提供するS3の「Sync」コマンド](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html)を使用して、前回バケットと同期した時点から欠落しているデータのみをダウンロードすることです。

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
