# AWS - 悪意のあるVPCミラー

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

VPCトラフィックミラーリングは、VPC内のEC2インスタンスの**受信および送信トラフィックを複製**し、インスタンス自体に何もインストールする必要がありません。この複製されたトラフィックは通常、分析と監視のためにネットワーク侵入検知システム（IDS）などに送信されます。

クラウドでの一般的なネットワーク検査の難しさから、ペネトレーションテスターはElastic Load Balancerのアクセスログのレビューなど、他のより簡単な手段に頼っています。これらのログは何かを提供しますが、完全なネットワークトラフィック検査と比較すると非常に限定的です。

### 侵害されたAWSクレデンシャルで悪意のあるミラーをデプロイする

**VPCトラフィックミラーリング**は、[**AWS Nitroシステム**](https://aws.amazon.com/ec2/nitro/)によって動作する**EC2**インスタンスタイプでのみ**サポートされている**こと、および**VPCミラーターゲットは、ミラーリングされているホストと同じVPC内にある必要がある**ことに注意が必要です。

次の数セクションでは、malmirrorの動作、それが何をするのか、および流出したデータの分析方法について説明します。スクリプト自体は[こちらのGitHubで見つけることができます](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/)。

#### malmirrorの動作方法

malmirrorは以下のリソースをアカウントにデプロイします:

* トラフィックをミラーリングするためのEC2インスタンス
* そのEC2インスタンス用のEC2セキュリティグループ
* 作成されたEC2インスタンスを指すVPCミラーターゲット
* すべてのトラフィックをミラーリングするように設定されたVPCミラーフィルター
* アカウント内の各サポートされているEC2インスタンスに対するVPCミラーセッション

![](<../../../../.gitbook/assets/image (72).png>)

すべてがデプロイされた後、**トラフィックは作成されたEC2インスタンスにミラーリングを開始します**。EC2インスタンスは、受信したミラーリングされたネットワークトラフィックをPCAP形式でリスニングおよびログ記録を開始します。インスタンス上のローカルデータが約**100MBになると**、自動的に**選択したS3バケットにそのデータを流出させ**（おそらく**自分のAWSアカウント内**）、システムから**ローカルファイルを削除します**。これにより、インスタンスがスペース不足になるのを防ぎ、ミラーリングされたトラフィックを自動的に流出させることができます。100MBの制限は任意のものであり、それを通じてより多くのトラフィックが流れるネットワークでは、はるかに小さすぎる可能性があります。トラフィックはこの方法で流出されます。なぜなら、アカウント間でトラフィックをミラーリングする簡単な方法が見つからず、データが環境から確実に出るようにする信頼できる方法のように思えたからです。

トラフィックがS3バケットに流出している間、ローカルにダウンロードして分析することができます。これを行う簡単な方法は、[AWS CLIによって提供されるS3「Sync」コマンド](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html)を使用することで、バケットと最後に同期したときから欠けているデータのみをダウンロードします。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
