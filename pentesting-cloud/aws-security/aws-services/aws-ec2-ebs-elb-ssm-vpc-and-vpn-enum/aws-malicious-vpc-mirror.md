# AWS - 恶意 VPC 镜像

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直至成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

VPC 流量镜像**复制 VPC 内 EC2 实例的进出站流量**，无需在实例本身上安装任何东西。这个复制的流量通常会被发送到类似网络入侵检测系统 (IDS) 进行分析和监控。

由于在云中进行一般网络检查的难度，渗透测试人员转而使用其他更简单的方法，例如审查弹性负载均衡器访问日志。这些日志提供了一些信息，但与完整的网络流量检查相比，它非常有限。

### 使用被泄露的 AWS 凭证部署恶意镜像

需要注意的是，**VPC 流量镜像**只**支持**由 [**AWS Nitro 系统**](https://aws.amazon.com/ec2/nitro/) 提供动力的 **EC2** 实例类型，并且 **VPC 镜像目标必须与被镜像的任何主机位于同一个 VPC** 内。

在接下来的几个部分中，我们将介绍 malmirror 的工作原理、它的功能以及如何分析被泄露的数据。脚本本身可以在[我们的 GitHub 这里找到](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/)。

#### malmirror 的工作原理

malmirror 会将以下资源部署到一个账户中：

* 一个用于镜像流量的 EC2 实例
* 该 EC2 实例的 EC2 安全组
* 指向创建的 EC2 实例的 VPC 镜像目标
* 配置为镜像所有流量的 VPC 镜像过滤器
* 账户中每个支持的 EC2 实例的 VPC 镜像会话

![](<../../../../.gitbook/assets/image (72).png>)

部署完成后，**流量将开始镜像到创建的 EC2 实例**。EC2 实例将开始监听并记录它接收到的所有镜像网络流量，格式为 PCAP。在实例上本地存储了大约 **100MB 的数据** 后，它将自动**将该数据泄露到您选择的 S3 存储桶**中（可能在您**自己的 AWS 账户**中），并**从系统中删除本地文件**。这样可以防止实例空间耗尽，并允许我们以自动化的方式泄露镜像流量。请注意，100MB 的限制是任意的，对于流量更大的一些网络来说，可能远远不够。之所以这样泄露流量，是因为似乎没有简单的方法可以跨账户镜像流量，这似乎是确保数据能够离开环境的可靠方法。

当流量被泄露到您的 S3 存储桶时，您可以将其下载到本地进行分析。一个简单的方法是使用 AWS CLI 提供的 [S3 “Sync” 命令](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html)，这样您只下载自上次与存储桶同步以来缺失的数据。

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直至成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
