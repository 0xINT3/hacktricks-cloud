# AWS - 恶意的VPC镜像

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

VPC流量镜像**在VPC内部复制EC2实例的入站和出站流量**，无需在实例本身上安装任何东西。这个复制的流量通常会被发送到类似网络入侵检测系统（IDS）的设备上进行分析和监控。

由于在云中进行一般网络检查的困难，渗透测试人员已经转向其他更简单的方法，比如查看弹性负载均衡器的访问日志。这些日志可以提供一些信息，但与完整的网络流量检查相比非常有限。

### 使用被入侵的AWS凭证部署恶意镜像

需要注意的是，**VPC流量镜像**仅受到由[**AWS Nitro系统**](https://aws.amazon.com/ec2/nitro/)提供支持的**EC2实例类型**的支持，并且**VPC镜像目标必须位于与被镜像的主机相同的VPC**中。

在接下来的几个部分中，我们将介绍malmirror的工作原理、它的功能以及如何分析被泄露的数据。脚本本身可以在我们的GitHub上找到，[点击这里](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/)。

#### malmirror的工作原理

malmirror在一个账户中部署以下资源：

* 一个用于镜像流量的EC2实例
* 该EC2实例的EC2安全组
* 一个指向创建的EC2实例的VPC镜像目标
* 配置为镜像所有流量的VPC镜像过滤器
* 每个受支持的EC2实例在账户中都有一个VPC镜像会话

![](<../../../../.gitbook/assets/image (72).png>)

部署完成后，**流量将开始镜像到创建的EC2实例**。EC2实例将开始监听并记录所有接收到的镜像网络流量，以PCAP格式存储在本地。在实例上存储了大约**100MB的数据**后，它将自动将这些数据**导出到您选择的S3存储桶**（可能是您**自己的AWS账户**中），并从系统中**删除本地文件**。这样可以防止实例空间不足，并允许我们以自动化的方式导出镜像流量。需要注意的是，100MB的限制是任意的，对于一些流量较大的网络来说可能太小了。流量通过这种方式导出，是因为似乎没有一种简单的方法可以跨账户进行流量镜像，这种方式似乎是确保数据离开环境的可靠方式。

当流量被导出到您的S3存储桶时，您可以将其下载到本地进行分析。一种简单的方法是使用AWS CLI提供的[S3“Sync”命令](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html)，这样您只需下载与上次与存储桶同步时缺失的数据。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
