# AWS - Miroir VPC Malveillant

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Le miroir de trafic VPC **duplique le trafic entrant et sortant pour les instances EC2 au sein d'un VPC** sans avoir besoin d'installer quoi que ce soit sur les instances elles-m√™mes. Ce trafic dupliqu√© serait g√©n√©ralement envoy√© √† quelque chose comme un syst√®me de d√©tection d'intrusion r√©seau (IDS) pour analyse et surveillance.

Avec la difficult√© d'inspection g√©n√©rale du r√©seau dans le cloud, les pentesters ont recours √† d'autres moyens plus simples, tels que l'examen des journaux d'acc√®s Elastic Load Balancer. Ces journaux vous donnent _quelque chose_, mais c'est tr√®s limit√© par rapport √† une inspection compl√®te du trafic r√©seau.

### D√©ploiement d'un Miroir Malveillant avec des Identifiants AWS Compromis

Il est important de noter que le **Miroir de Trafic VPC** est uniquement **pris en charge** par les types d'instances **EC2** aliment√©es par le [**syst√®me AWS Nitro**](https://aws.amazon.com/ec2/nitro/) et que la **cible du miroir VPC doit √™tre dans le m√™me VPC** que les h√¥tes qui sont miroit√©s.

Dans les prochaines sections, nous verrons comment fonctionne malmirror, ce qu'il fait et comment analyser les donn√©es exfiltr√©es. Le script lui-m√™me peut √™tre [trouv√© sur notre GitHub ici](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### Fonctionnement de malmirror

malmirror d√©ploie les ressources suivantes dans un compte :

* Une instance EC2 pour miroiter le trafic
* Un groupe de s√©curit√© EC2 pour cette instance EC2
* Une Cible de Miroir VPC, pointant vers l'instance EC2 cr√©√©e
* Un Filtre de Miroir VPC configur√© pour miroiter tout le trafic
* Une Session de Miroir VPC pour chaque instance EC2 prise en charge dans le compte

![](<../../../../.gitbook/assets/image (72).png>)

Une fois tout d√©ploy√©, **le trafic commencera √† √™tre miroit√© vers l'instance EC2 qui a √©t√© cr√©√©e**. L'instance EC2 commencera √† √©couter et √† enregistrer tout le trafic r√©seau miroit√© qu'elle re√ßoit au format PCAP. Apr√®s environ **100 Mo de donn√©es stock√©es localement sur l'instance**, elle exfiltrera automatiquement ces donn√©es dans un seau S3 de votre choix (probablement dans **votre propre compte AWS**) et **supprimera le fichier local** du syst√®me. Cela emp√™che l'instance de manquer d'espace et nous permet d'exfiltrer le trafic miroit√© de mani√®re automatis√©e. Notez que la limite de 100 Mo est arbitraire et peut √™tre bien trop petite pour certains r√©seaux o√π il y a une plus grande quantit√© de trafic. Le trafic est exfiltr√© de cette mani√®re car il ne semblait pas y avoir de moyen facile de miroiter le trafic entre comptes et cela semblait √™tre un moyen fiable de s'assurer que les donn√©es sortent de l'environnement.

Alors que le trafic est exfiltr√© vers votre seau S3, vous pouvez le t√©l√©charger localement pour analyse. Une mani√®re simple de faire cela serait avec la [commande ‚ÄúSync‚Äù S3 offerte par l'AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html) afin que vous ne t√©l√©chargiez que les donn√©es qui vous manquent depuis la derni√®re fois que vous avez synchronis√© avec le seau.

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
