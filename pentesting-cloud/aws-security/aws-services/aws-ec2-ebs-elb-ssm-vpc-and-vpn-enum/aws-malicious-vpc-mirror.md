# AWS - Espelho Malicioso de VPC

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Para mais detalhes sobre esta t√©cnica, consulte o post original em** [**https://rhinosecuritylabs.com/aws/abusing-vpc-traffic-mirroring-in-aws**](https://rhinosecuritylabs.com/aws/abusing-vpc-traffic-mirroring-in-aws)

O espelhamento de tr√°fego VPC **duplica o tr√°fego de entrada e sa√≠da para inst√¢ncias EC2 dentro de um VPC** sem a necessidade de instalar nada nas pr√≥prias inst√¢ncias. Esse tr√°fego duplicado normalmente seria enviado para algo como um sistema de detec√ß√£o de intrus√£o de rede (IDS) para an√°lise e monitoramento.

Com a dificuldade de inspe√ß√£o geral de rede na nuvem, pentesters recorreram a outros meios mais simples, como revisar os logs de acesso do Elastic Load Balancer. Esses logs fornecem _algo_, mas √© muito limitado quando comparado √† inspe√ß√£o completa do tr√°fego de rede.

### Implementando um Espelho Malicioso com Credenciais AWS Comprometidas

√â importante notar que o **Espelhamento de Tr√°fego VPC** √© apenas **suportado** por tipos de inst√¢ncia **EC2** que s√£o alimentados pelo [**sistema AWS Nitro**](https://aws.amazon.com/ec2/nitro/) e que o **alvo do espelho VPC deve estar dentro do mesmo VPC** que qualquer host que esteja sendo espelhado.

Nas pr√≥ximas se√ß√µes, abordaremos como o malmirror funciona, o que ele faz e como analisar os dados exfiltrados. O script em si pode ser [encontrado em nosso GitHub aqui](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### Como o malmirror Funciona

malmirror implanta os seguintes recursos em uma conta:

* Uma inst√¢ncia EC2 para espelhar o tr√°fego
* Um grupo de seguran√ßa EC2 para essa inst√¢ncia EC2
* Um Alvo de Espelho VPC, apontando para a inst√¢ncia EC2 criada
* Um Filtro de Espelho VPC que √© configurado para espelhar todo o tr√°fego
* Uma Sess√£o de Espelho VPC para cada inst√¢ncia EC2 suportada na conta

![](<../../../../.gitbook/assets/image (72).png>)

Depois que tudo estiver implantado, **o tr√°fego come√ßar√° a ser espelhado para a inst√¢ncia EC2 que foi criada**. A inst√¢ncia EC2 come√ßar√° a ouvir e registrar todo o tr√°fego de rede espelhado que recebe no formato PCAP. Ap√≥s cerca de **100MB de dados armazenados localmente na inst√¢ncia**, ela automaticamente **exfiltrar√° esses dados para um bucket S3** de sua escolha (provavelmente na **sua pr√≥pria conta AWS**) e **deletar√° o arquivo local** do sistema. Isso impede que a inst√¢ncia fique sem espa√ßo e nos permite exfiltrar o tr√°fego espelhado de forma automatizada. Note que o limite de 100MB √© arbitr√°rio e pode ser muito pequeno para algumas redes onde h√° uma maior quantidade de tr√°fego passando por ela. O tr√°fego √© exfiltrado dessa maneira porque n√£o parecia haver uma maneira f√°cil de espelhar o tr√°fego entre contas e isso parecia uma maneira confi√°vel de garantir que os dados sa√≠ssem do ambiente.

√Ä medida que o tr√°fego √© exfiltrado para o seu bucket S3, voc√™ pode baix√°-lo localmente para an√°lise. Uma maneira simples de fazer isso seria com o [comando ‚ÄúSync‚Äù do S3 oferecido pelo AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html) para que voc√™ baixe apenas os dados que est√° faltando desde a √∫ltima vez que sincronizou com o bucket.

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
