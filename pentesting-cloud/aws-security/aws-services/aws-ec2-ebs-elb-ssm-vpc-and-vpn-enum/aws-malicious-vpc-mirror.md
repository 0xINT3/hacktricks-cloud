# AWS - Espejo malicioso de VPC

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

El espejo de tr√°fico de VPC **duplica el tr√°fico de entrada y salida para las instancias EC2 dentro de una VPC** sin necesidad de instalar nada en las propias instancias. Este tr√°fico duplicado se enviar√≠a com√∫nmente a algo como un sistema de detecci√≥n de intrusiones en la red (IDS) para su an√°lisis y monitoreo.

Con la dificultad de la inspecci√≥n general de la red en la nube, los pentesters han recurrido a otros medios m√°s simples, como revisar los registros de acceso del balanceador de carga el√°stico. Esos registros te dan _algo_, pero es muy limitado en comparaci√≥n con la inspecci√≥n completa del tr√°fico de red.

### Despliegue de un espejo malicioso con credenciales de AWS comprometidas

Es importante tener en cuenta que el **Espejo de tr√°fico de VPC** solo es **compatible** con los tipos de instancia **EC2** que est√°n alimentados por el [**sistema AWS Nitro**](https://aws.amazon.com/ec2/nitro/) y que el **objetivo del espejo de VPC debe estar dentro de la misma VPC** que cualquier host que se est√© reflejando.

En las pr√≥ximas secciones, cubriremos c√≥mo funciona malmirror, qu√© hace y c√≥mo analizar los datos exfiltrados. El script en s√≠ se puede [encontrar en nuestro GitHub aqu√≠](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### C√≥mo funciona malmirror

malmirror despliega los siguientes recursos en una cuenta:

* Una instancia EC2 para reflejar el tr√°fico a
* Un grupo de seguridad EC2 para esa instancia EC2
* Un objetivo de espejo de VPC, apuntando a la instancia EC2 creada
* Un filtro de espejo de VPC que est√° configurado para reflejar todo el tr√°fico
* Una sesi√≥n de espejo de VPC para cada instancia EC2 compatible en la cuenta

![](<../../../../.gitbook/assets/image (72).png>)

Despu√©s de que se despliega todo, **el tr√°fico comenzar√° a reflejarse en la instancia EC2 que se cre√≥**. La instancia EC2 comenzar√° a escuchar y registrar todo el tr√°fico de red reflejado que recibe en formato PCAP. Despu√©s de aproximadamente **100 MB de datos almacenados localmente en la instancia**, autom√°ticamente **exfiltrar√° esos datos en un bucket de S3** de su elecci√≥n (probablemente en su **propia cuenta de AWS**) y **borrar√° el archivo local** del sistema. Esto evita que la instancia se quede sin espacio y nos permite exfiltrar el tr√°fico reflejado de manera automatizada. Tenga en cuenta que el l√≠mite de 100 MB es arbitrario y puede ser demasiado peque√±o para algunas redes donde hay una mayor cantidad de tr√°fico fluyendo a trav√©s de ella. El tr√°fico se exfiltra de esta manera porque no parec√≠a haber una manera f√°cil de reflejar el tr√°fico entre cuentas y esto parec√≠a una forma confiable de asegurar que los datos salgan del entorno.

A medida que el tr√°fico se est√° exfiltrando a su bucket de S3, puede descargarlo localmente para su an√°lisis. Una forma sencilla de hacerlo ser√≠a con el [comando de "Sincronizaci√≥n" de S3 ofrecido por AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html) para que solo descargue los datos que faltan desde la √∫ltima vez que se sincroniz√≥ con el bucket. 

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>