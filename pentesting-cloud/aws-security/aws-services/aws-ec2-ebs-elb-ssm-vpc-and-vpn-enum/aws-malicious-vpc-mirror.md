# AWS - Espelho Malicioso de VPC

<details>

<summary><strong>Apoie o HackTricks e obtenha benefícios!</strong></summary>

* Se você deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **última versão do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa coleção exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** 💬 [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas técnicas de hacking enviando PRs para os repositórios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

O espelhamento de tráfego VPC **duplica o tráfego de entrada e saída para instâncias EC2 dentro de uma VPC** sem a necessidade de instalar nada nas próprias instâncias. Esse tráfego duplicado seria comumente enviado para algo como um sistema de detecção de intrusão de rede (IDS) para análise e monitoramento.

Com a dificuldade de inspeção geral de rede na nuvem, os pentesters recorreram a outros meios mais simples, como revisar os logs de acesso do Elastic Load Balancer. Esses logs fornecem _algo_, mas são muito limitados quando comparados à inspeção completa do tráfego de rede.

### Implantação de um Espelho Malicioso com Credenciais AWS Comprometidas

É importante observar que o **Espelhamento de Tráfego VPC** é suportado apenas por tipos de instância **EC2** que são alimentados pelo [**sistema AWS Nitro**](https://aws.amazon.com/ec2/nitro/) e que o **alvo do espelho VPC deve estar na mesma VPC** que qualquer host que esteja sendo espelhado.

Nas próximas seções, abordaremos como o malmirror funciona, o que ele faz e como analisar os dados exfiltrados. O script em si pode ser [encontrado em nosso GitHub aqui](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### Como o malmirror funciona

O malmirror implanta os seguintes recursos em uma conta:

* Uma instância EC2 para espelhar o tráfego
* Um grupo de segurança EC2 para essa instância EC2
* Um alvo de espelho VPC, apontando para a instância EC2 criada
* Um filtro de espelho VPC que está configurado para espelhar todo o tráfego
* Uma sessão de espelho VPC para cada instância EC2 suportada na conta

![](<../../../../.gitbook/assets/image (72).png>)

Depois que tudo é implantado, **o tráfego começará a ser espelhado para a instância EC2 que foi criada**. A instância EC2 começará a ouvir e registrar todo o tráfego de rede espelhado que recebe no formato PCAP. Após cerca de **100 MB de dados armazenados localmente na instância**, ele automaticamente **exfiltrará esses dados para um bucket S3** de sua escolha (provavelmente em sua **própria conta AWS**) e **excluirá o arquivo local** do sistema. Isso impede que a instância fique sem espaço e nos permite exfiltrar o tráfego espelhado de forma automatizada. Observe que o limite de 100 MB é arbitrário e pode ser muito pequeno para algumas redes onde há uma maior quantidade de tráfego fluindo por ela. O tráfego é exfiltrado dessa maneira porque não parecia haver uma maneira fácil de espelhar o tráfego entre contas e isso parecia uma maneira confiável de garantir que os dados saiam do ambiente.

À medida que o tráfego está sendo exfiltrado para o seu bucket S3, você pode baixá-lo localmente para análise. Uma maneira simples de fazer isso seria com o [comando S3 "Sync" oferecido pelo AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html) para que você baixe apenas os dados que está faltando desde a última vez que sincronizou com o bucket. 

<details>

<summary><strong>Apoie o HackTricks e obtenha benefícios!</strong></summary>

* Se você deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **última versão do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa coleção exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** 💬 [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas técnicas de hacking enviando PRs para os repositórios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>