# AWS - Espejo Malicioso de VPC

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Para m√°s detalles sobre esta t√©cnica, consulta el post original de** [**https://rhinosecuritylabs.com/aws/abusing-vpc-traffic-mirroring-in-aws**](https://rhinosecuritylabs.com/aws/abusing-vpc-traffic-mirroring-in-aws)

El espejo de tr√°fico de VPC **duplica el tr√°fico entrante y saliente de las instancias EC2 dentro de un VPC** sin necesidad de instalar nada en las propias instancias. Este tr√°fico duplicado com√∫nmente se env√≠a a algo como un sistema de detecci√≥n de intrusiones de red (IDS) para an√°lisis y monitoreo.

Con la dificultad de la inspecci√≥n general de la red en la nube, los pentesters han recurrido a otros medios m√°s simples, como revisar los registros de acceso del Elastic Load Balancer. Esos registros te dan _algo_, pero es muy limitado en comparaci√≥n con la inspecci√≥n completa del tr√°fico de red.

### Desplegando un Espejo Malicioso con Credenciales AWS Comprometidas

Es importante notar que el **Espejo de Tr√°fico de VPC** solo es **compatible** con tipos de instancias **EC2** que est√°n impulsadas por el [**sistema AWS Nitro**](https://aws.amazon.com/ec2/nitro/) y que el **objetivo del espejo de VPC debe estar dentro del mismo VPC** que cualquier host que est√© siendo espejado.

En las siguientes secciones, cubriremos c√≥mo funciona malmirror, qu√© hace y c√≥mo analizar los datos exfiltrados. El script en s√≠ puede ser [encontrado en nuestro GitHub aqu√≠](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### C√≥mo Funciona malmirror

malmirror despliega los siguientes recursos en una cuenta:

* Una instancia EC2 para espejar el tr√°fico
* Un grupo de seguridad EC2 para esa instancia EC2
* Un Objetivo de Espejo de VPC, apuntando a la instancia EC2 creada
* Un Filtro de Espejo de VPC que est√° configurado para espejar todo el tr√°fico
* Una Sesi√≥n de Espejo de VPC para cada instancia EC2 compatible en la cuenta

![](<../../../../.gitbook/assets/image (72).png>)

Despu√©s de que todo est√° desplegado, **el tr√°fico comenzar√° a ser espejado a la instancia EC2 que fue creada**. La instancia EC2 comenzar√° a escuchar y registrar todo el tr√°fico de red espejado que recibe en formato PCAP. Despu√©s de aproximadamente **100MB de datos almacenados localmente en la instancia**, autom√°ticamente **exfiltrar√° esos datos a un bucket de S3** de tu elecci√≥n (probablemente en tu **propia cuenta de AWS**) y **eliminar√° el archivo local** del sistema. Esto evita que la instancia se quede sin espacio y nos permite exfiltrar el tr√°fico espejado de manera automatizada. Ten en cuenta que el l√≠mite de 100MB es arbitrario y puede ser demasiado peque√±o para algunas redes donde hay una mayor cantidad de tr√°fico fluyendo a trav√©s de ella. El tr√°fico se exfiltra de esta manera porque no parec√≠a haber una forma f√°cil de espejar el tr√°fico entre cuentas y esto parec√≠a una manera confiable de asegurar que los datos salgan del entorno.

A medida que el tr√°fico se est√° exfiltrando a tu bucket de S3, puedes descargarlo localmente para an√°lisis. Una forma sencilla de hacer esto ser√≠a con el [comando ‚ÄúSync‚Äù de S3 ofrecido por el AWS CLI](https://docs.aws.amazon.com/cli/latest/reference/s3/sync.html) para que solo descargues los datos que te faltan desde la √∫ltima vez que sincronizaste con el bucket.

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
