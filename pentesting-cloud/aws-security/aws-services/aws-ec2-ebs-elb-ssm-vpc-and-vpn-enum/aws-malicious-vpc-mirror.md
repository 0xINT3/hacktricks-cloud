# AWS - Miroir VPC Malveillant

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts GitHub.**

</details>

Le miroir de trafic VPC **duplique le trafic entrant et sortant pour les instances EC2 dans un VPC** sans avoir besoin d'installer quoi que ce soit sur les instances elles-m√™mes. Ce trafic dupliqu√© serait g√©n√©ralement envoy√© √† quelque chose comme un syst√®me de d√©tection d'intrusion r√©seau (IDS) pour l'analyse et la surveillance.

Avec la difficult√© de l'inspection g√©n√©rale du r√©seau dans le cloud, les testeurs de p√©n√©tration ont recours √† d'autres moyens plus simples, tels que l'examen des journaux d'acc√®s de l'√©quilibreur de charge √©lastique. Ces journaux vous donnent _quelque chose_, mais c'est tr√®s limit√© par rapport √† l'inspection compl√®te du trafic r√©seau.

### D√©ploiement d'un miroir malveillant avec des informations d'identification AWS compromises

Il est important de noter que le **miroir de trafic VPC** est uniquement **pris en charge** par les types d'instances **EC2** aliment√©s par le [**syst√®me AWS Nitro**](https://aws.amazon.com/ec2/nitro/) et que la **cible de miroir VPC doit √™tre dans le m√™me VPC** que les h√¥tes qui sont miroit√©s.

Dans les prochaines sections, nous verrons comment malmirror fonctionne, ce qu'il fait et comment analyser les donn√©es exfiltr√©es. Le script lui-m√™me peut √™tre [trouv√© sur notre GitHub ici](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/malmirror/).

#### Comment fonctionne malmirror

malmirror d√©ploie les ressources suivantes dans un compte :

* Une instance EC2 pour miroiter le trafic vers
* Un groupe de s√©curit√© EC2 pour cette instance EC2
* Une cible de miroir VPC, pointant vers l'instance EC2 cr√©√©e
* Un filtre de miroir VPC qui est configur√© pour miroiter tout le trafic
* Une session de miroir VPC pour chaque instance EC2 prise en charge dans le compte

![](<../../../../.gitbook/assets/image (72).png>)

Une fois que tout est d√©ploy√©, **le trafic commencera √† se refl√©ter sur l'instance EC2 qui a √©t√© cr√©√©e**. L'instance EC2 commencera √† √©couter et √† enregistrer tout le trafic r√©seau miroit√© qu'elle re√ßoit au format PCAP. Apr√®s environ **100 Mo de donn√©es stock√©es localement sur l'instance**, elle exfiltrera automatiquement ces donn√©es dans un bucket S3 de votre choix (probablement dans votre **propre compte AWS**) et **supprimera le fichier local** du syst√®me. Cela emp√™che l'instance de manquer d'espace et nous permet d'exfiltrer le trafic miroit√© de mani√®re automatis√©e. Notez que la limite de 100 Mo est arbitraire et peut √™tre beaucoup trop petite pour certains r√©seaux o√π il y a une plus grande quantit√© de trafic qui y circule. Le trafic est exfiltr√© de cette mani√®re car il ne semblait pas y avoir de moyen facile de miroiter le trafic entre les comptes et cela semblait √™tre un moyen fiable de garantir que les donn√©es sortent de l'environnement.

Pendant que le trafic est exfiltr√© vers votre bucket S3, vous pouvez le t√©l√©charger localement pour l'analyser. Une fa√ßon simple de le faire serait avec la commande S3 "Sync" offerte par AWS CLI afin que vous ne t√©l√©chargiez que les donn√©es qui vous manquent depuis la derni√®re fois que vous avez synchronis√© avec le bucket.