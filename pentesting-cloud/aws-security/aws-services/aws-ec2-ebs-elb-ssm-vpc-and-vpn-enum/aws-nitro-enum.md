# AWS - Nitro Enum

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

AWS Nitro je skup **inovativnih tehnologija** koje čine osnovnu platformu za AWS EC2 instance. Predstavljen od strane Amazona radi **unapređenja sigurnosti, performansi i pouzdanosti**, Nitro koristi prilagođene **hardverske komponente i lagani hipervizor**. On apstrahuje veći deo tradicionalne virtualizacije na posvećeni hardver i softver, **minimizirajući površinu napada** i poboljšavajući efikasnost resursa. Prebacivanjem virtualizacijskih funkcija, Nitro omogućava EC2 instancama da pruže **performanse skoro identične fizičkom serveru**, čineći ga posebno korisnim za aplikacije koje zahtevaju mnogo resursa. Dodatno, Nitro Security Chip posebno obezbeđuje **sigurnost hardvera i firmware-a**, dodatno učvršćujući njegovu robustnu arhitekturu.

### Nitro Enclaves

**AWS Nitro Enclaves** pruža sigurno, **izolovano računarsko okruženje unutar Amazon EC2 instanci**, posebno dizajnirano za obradu visoko osetljivih podataka. Koristeći AWS Nitro System, ove enklave obezbeđuju robustnu **izolaciju i sigurnost**, idealnu za **obradu poverljivih informacija** poput ličnih identifikacionih podataka ili finansijskih zapisa. One sadrže minimalisticko okruženje, značajno smanjujući rizik od izloženosti podataka. Dodatno, Nitro Enclaves podržavaju kriptografsku atestaciju, omogućavajući korisnicima da provere da li se izvršava samo ovlašćeni kod, što je ključno za održavanje stroge usaglašenosti i standarda zaštite podataka.

{% hint style="danger" %}
Slike Nitro Enclave-a se **pokreću iznutra EC2 instanci** i ne možete videti iz AWS veb konzole da li EC2 instanca pokreće slike u Nitro Enclave-u ili ne.
{% endhint %}

## Instalacija Nitro Enclave CLI

Pratite sve instrukcije [**iz dokumentacije**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Međutim, ovo su najvažnije:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Slike Nitro Enclave

Slike koje možete pokrenuti u Nitro Enclave-u zasnovane su na docker slikama, tako da možete kreirati svoje slike Nitro Enclave-a iz docker slika kao što su:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Kao što možete videti, slike Nitro Enclave koriste ekstenziju **`eif`** (Enclave Image File).

Izlaz će izgledati slično:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Pokreni sliku

Prema [**dokumentaciji**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), da biste pokrenuli sliku enklave, potrebno je dodeliti joj memoriju **barem 4 puta veću od veličine `eif` datoteke**. Moguće je konfigurisati podrazumevane resurse koje treba dodeliti u datoteci.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Uvek zapamtite da treba da **rezervišete neke resurse za roditeljsku EC2** instancu takođe!
{% endhint %}

Nakon što saznate resurse koje treba dodeliti slici, čak i nakon što ste izmenili konfiguracioni fajl, moguće je pokrenuti sliku enklave sa:
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
### Nabrojavanje Enklava

Ako kompromitujete EC2 domaćina, moguće je dobiti listu pokrenutih slika enklava pomoću:
```bash
nitro-cli describe-enclaves
```
Nije moguće dobiti shell unutar pokrenute slike enklave jer je to glavna svrha enklave, međutim, ako koristite parametar `--debug-mode`, moguće je dobiti stdout sa:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Prekini ograde

Ako napadač kompromituje EC2 instancu, podrazumevano neće moći da dobije pristup unutar nje, ali će moći da je **prekine** sa:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

Jedini način komuniciranja sa **enklavom** koja pokreće sliku je korišćenjem **vsocks**.

**Virtualni Socket (vsock)** je porodični socket u Linuxu specijalno dizajniran za olakšavanje **komunikacije** između virtuelnih mašina (**VMs**) i njihovih **hipervizora**, ili između samih VM-ova. Vsock omogućava efikasnu, **dvosmernu komunikaciju** bez oslanjanja na mrežni skup domaćina. Ovo omogućava VM-ovima da komuniciraju čak i bez konfiguracija mreže, **koristeći 32-bitni Context ID (CID) i brojeve portova** za identifikaciju i upravljanje konekcijama. vsock API podržava i tok i datagram tipove soketa, slično TCP-u i UDP-u, pružajući svestran alat za aplikacije na nivou korisnika u virtuelnim okruženjima.

{% hint style="success" %}
Stoga, adresa vsock-a izgleda ovako: `<CID>:<Port>`
{% endhint %}

Da biste pronašli **CIDs** enklava koje pokreću slike, možete jednostavno izvršiti sledeću komandu i dobiti **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Imajte na umu da sa domaćina ne postoji način da se zna da li CID izlaže bilo koji port! Osim ako se koristi neki **vsock skener porta kao** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Ovde pronađite nekoliko primera:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Jednostavan Python Listener</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</detalji>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Klijent

Primeri:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Jednostavan Python klijent</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</detalji>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Alat vsock-proxy omogućava da se posrednik vsock-a postavi sa drugom adresom, na primer:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Ovo će proslediti **lokalni port 8001 u vsock** ka `ip-ranges.amazonaws.com:443` i datoteka **`your-vsock-proxy.yaml`** može imati ovaj sadržaj koji omogućava pristup `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Moguće je videti vsock adrese (**`<CID>:<Port>`**) koje koristi EC2 domaćin sa (obratite pažnju na `3:8001`, 3 je CID, a 8001 je port):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
## Attestacija i KMS Nitro Enklave

Nitro Enklave SDK omogućava enklavi da zatraži **kriptografski potpisani dokument o attestaciji** od Nitro **Hypervizora**, koji uključuje **jedinstvene merenja** specifične za tu enklavu. Ova merenja, koja uključuju **heševe i registre konfiguracije platforme (PCRs)**, koriste se tokom procesa attestacije kako bi se **dokazao identitet enklave** i **izgradio poverenje sa spoljnim uslugama**. Dokument o attestaciji obično sadrži vrednosti poput PCR0, PCR1 i PCR2, s kojima ste se već susreli prilikom izgradnje i čuvanja enklave EIF.

Iz [**dokumenata**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), ovo su vrednosti PCR-a:

<table><thead><tr><th width="97">PCR</th><th width="221">Heš od ...</th><th>Opis</th></tr></thead><tbody><tr><td>PCR0</td><td>Enklava slika fajla</td><td>Kontinualno merenje sadržaja slike fajla, bez podataka o sekciji.</td></tr><tr><td>PCR1</td><td>Linux kernel i bootstrap</td><td>Kontinualno merenje kernela i podataka o boot ramfs-u.</td></tr><tr><td>PCR2</td><td>Aplikacija</td><td>Kontinualno, u redosledu merenje korisničkih aplikacija, bez boot ramfs-a.</td></tr><tr><td>PCR3</td><td>IAM uloga dodeljena roditeljskoj instanci</td><td>Kontinualno merenje IAM uloge dodeljene roditeljskoj instanci. Osigurava da proces attestacije uspe samo kada roditeljska instanca ima odgovarajuću IAM ulogu.</td></tr><tr><td>PCR4</td><td>ID instance roditeljske instance</td><td>Kontinualno merenje ID-a roditeljske instance. Osigurava da proces attestacije uspe samo kada roditeljska instanca ima određeni ID instance.</td></tr><tr><td>PCR8</td><td>Sertifikat potpisa slike enklave</td><td>Merenje sertifikata potpisa navedenog za sliku fajla enklave. Osigurava da proces attestacije uspe samo kada je enklava pokrenuta sa slikom fajla enklave potpisane određenim sertifikatom.</td></tr></tbody></table>

Možete integrisati **kriptografsku attestaciju** u svoje aplikacije i iskoristiti preizgrađene integracije sa uslugama poput **AWS KMS**. AWS KMS može **validirati enklavne attestacije** i nudi ključeve uslova zasnovane na attestaciji (`kms:RecipientAttestation:ImageSha384` i `kms:RecipientAttestation:PCR`) u svojim ključnim politikama. Ove politike osiguravaju da AWS KMS dozvoljava operacije korišćenjem KMS ključa **samo ako je dokument o attestaciji enklave validan** i ispunjava **navedene uslove**.

{% hint style="success" %}
Napomena da Enklave u debug (--debug) režimu generišu dokumente o attestaciji sa PCR-ima koji se sastoje od nula (`000000000000000000000000000000000000000000000000`). Stoga, KMS politike koje proveravaju ove vrednosti će neuspeti.
{% endhint %}

### PCR Bypass

Sa perspektive napadača, primetite da neki PCR-i omogućavaju modifikaciju nekih delova ili cele slike enklave i i dalje bi bili validni (na primer, PCR4 proverava samo ID roditeljske instance tako da pokretanje bilo koje slike enklave u toj EC2 će omogućiti ispunjenje ovog potencijalnog PCR zahteva).

Stoga, napadač koji kompromituje EC2 instancu može biti u mogućnosti da pokrene druge slike enklave kako bi zaobišao ove zaštite.

Istraživanje o tome kako modifikovati/napraviti nove slike kako bi se zaobišle svake zaštite (posebno one koje nisu očigledne) je još uvek TODO.

## Reference

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Svi delovi Nitro tutorijala od AWS-a: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)
