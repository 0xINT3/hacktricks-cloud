# AWS - Nitro Enum

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

AWS Nitro是一套**创新技术**，构成了AWS EC2实例的基础平台。由亚马逊引入，旨在**增强安全性、性能和可靠性**，Nitro利用自定义**硬件组件和轻量级hypervisor**。它将许多传统虚拟化功能抽象到专用硬件和软件中，**最小化攻击面**并提高资源效率。通过卸载虚拟化功能，Nitro允许EC2实例提供**接近裸金属性能**，特别适用于资源密集型应用程序。此外，Nitro安全芯片专门确保**硬件和固件的安全性**，进一步巩固了其强大的架构。

### Nitro Enclaves

**AWS Nitro Enclaves**提供了一个安全的、**隔离的计算环境，位于Amazon EC2实例内部**，专为处理高度敏感数据而设计。利用AWS Nitro系统，这些飞地确保了强大的**隔离和安全性**，非常适合处理诸如PII或财务记录等**机密信息**。它们具有极简环境，显著降低了数据暴露的风险。此外，Nitro Enclaves支持加密认证，允许用户验证只有经授权的代码在运行，这对于保持严格的合规性和数据保护标准至关重要。

{% hint style="danger" %}
Nitro Enclave镜像是**从EC2实例内部运行**的，您无法从AWS Web控制台看到EC2实例是否在Nitro Enclave中运行镜像。
{% endhint %}

## Nitro Enclave CLI安装

按照[**文档中的所有说明**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)。然而，以下是最重要的指令：
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave镜像

您可以在Nitro Enclave中运行的镜像基于docker镜像，因此您可以从docker镜像创建您的Nitro Enclave镜像，例如：
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
正如您所看到的，Nitro Enclave 图像使用扩展名 **`eif`**（Enclave Image File）。

输出将类似于：
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### 运行镜像

根据[**文档**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)，为了运行一个enclave镜像，您需要为其分配**至少是`eif`文件大小的4倍内存**。可以在文件中配置要分配给它的默认资源。
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
始终记住，您还需要为父EC2实例**保留一些资源**！
{% endhint %}

在了解要为映像提供的资源并修改配置文件后，可以运行一个enclave映像：
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
### 枚举隔离区

如果您入侵了一个 EC2 主机，可以通过以下方式获取正在运行的隔离区镜像列表：
```bash
nitro-cli describe-enclaves
```
这是因为隔离的主要目的，所以**无法在运行中的隔离镜像内获取 shell**，但是，如果您使用了参数 **`--debug-mode`**，则可以通过以下方式获取其 **stdout**：
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### 终止飞地

如果攻击者入侵了一个 EC2 实例，默认情况下他将无法在其中获取 shell，但他可以使用以下命令**终止它们**：
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

与运行镜像的**enclave**通信的唯一方式是使用**vsocks**。

**虚拟套接字（vsock）**是Linux中的一种套接字系列，专门设计用于促进虚拟机（**VMs**）与它们的**hypervisors**之间，或者VMs之间的**通信**。Vsock实现了高效的**双向通信**，而无需依赖主机的网络堆栈。这使得VMs可以在没有网络配置的情况下进行通信，**使用32位上下文ID（CID）和端口号**来标识和管理连接。vsock API支持流和数据报套接字类型，类似于TCP和UDP，为虚拟环境中的用户级应用程序提供了多功能工具。

{% hint style="success" %}
因此，vsock地址看起来像这样：`<CID>:<Port>`
{% endhint %}

要查找运行镜像的enclave的**CIDs**，您只需执行以下命令并获取**`EnclaveCID`**：

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
请注意，从主机上无法知道CID是否暴露任何端口！除非使用一些**vsock端口扫描工具，比如**[**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner)。
{% endhint %}

### Vsock服务器/监听器

这里有一些示例：

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>简单的Python监听器</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock 客户端

示例：

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>简单的 Python 客户端</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock 代理

工具 vsock-proxy 允许代理一个 vsock 代理到另一个地址，例如：
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
这将把**vsock中的本地端口8001**转发到`ip-ranges.amazonaws.com:443`，而文件**`your-vsock-proxy.yaml`**可能包含以下内容，允许访问`ip-ranges.amazonaws.com:443`：
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
可以使用以下命令查看 EC2 主机使用的 vsock 地址（**`<CID>:<Port>`**）（请注意 `3:8001`，3 是 CID，8001 是端口）：

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Attestation & KMS

Nitro Enclaves SDK 允许一个 enclave 从 Nitro Hypervisor 请求一个**加密签名的证明文件**，其中包含特定于该 enclave 的**唯一测量值**。这些测量值包括**哈希和平台配置寄存器 (PCRs)**，在证明过程中用于**证明 enclave 的身份**并与外部服务**建立信任**。证明文件通常包含像 PCR0、PCR1 和 PCR2 这样的值，在构建和保存 enclave EIF 时你已经遇到过。

从[**文档**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves)中，这些是 PCR 值：

<table><thead><tr><th width="97">PCR</th><th width="221">哈希值...</th><th>描述</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave image file</td><td>对图像文件内容的连续测量，不包括部分数据。</td></tr><tr><td>PCR1</td><td>Linux 内核和引导程序</td><td>对内核和引导 ramfs 数据的连续测量。</td></tr><tr><td>PCR2</td><td>应用程序</td><td>对用户应用程序的连续、有序测量，不包括引导 ramfs。</td></tr><tr><td>PCR3</td><td>分配给父实例的 IAM 角色</td><td>对分配给父实例的 IAM 角色的连续测量。确保只有当父实例具有正确的 IAM 角色时，证明过程才会成功。</td></tr><tr><td>PCR4</td><td>父实例的实例 ID</td><td>对父实例的 ID 的连续测量。确保只有当父实例具有特定实例 ID 时，证明过程才会成功。</td></tr><tr><td>PCR8</td><td>Enclave image file 签名证书</td><td>对为 enclave 图像文件指定的签名证书的测量。确保只有当 enclave 是从由特定证书签名的 enclave 图像文件引导时，证明过程才会成功。</td></tr></tbody></table>

您可以将**加密证明**集成到您的应用程序中，并利用与**AWS KMS**等服务的预构建集成。AWS KMS 可以**验证 enclave 的证明**，并在其密钥策略中提供基于证明的条件键 (`kms:RecipientAttestation:ImageSha384` 和 `kms:RecipientAttestation:PCR`)。这些策略确保 AWS KMS 仅在 enclave 的证明文件有效且符合**指定条件**时才允许使用 KMS 密钥执行操作。

{% hint style="success" %}
请注意，调试模式下的 Enclaves 生成的证明文件中的 PCR 值由零 (`000000000000000000000000000000000000000000000000`) 组成。因此，检查这些值的 KMS 策略将失败。
{% endhint %}

### PCR 绕过

从攻击者的角度来看，注意到一些 PCR 可能允许修改一些部分或全部 enclave 图像并仍然有效（例如，PCR4 只检查父实例的 ID，因此在该 EC2 中运行任何 enclave 图像将允许满足这个潜在的 PCR 要求）。

因此，入侵了 EC2 实例的攻击者可能能够运行其他 enclave 图像以绕过这些保护措施。

如何修改/创建新图像以绕过每个保护措施（特别是那些不太明显的保护措施）的研究仍在进行中。

## 参考资料

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWS 的 Nitro 教程的所有部分：[https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
