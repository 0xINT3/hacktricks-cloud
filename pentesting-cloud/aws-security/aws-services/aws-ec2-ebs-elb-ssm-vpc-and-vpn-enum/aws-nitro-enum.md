# AWS - Enumeraci칩n de Nitro

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipo Rojo de HackTricks en AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n B치sica

AWS Nitro es un conjunto de **tecnolog칤as innovadoras** que forman la plataforma subyacente para las instancias de AWS EC2. Introducido por Amazon para **mejorar la seguridad, el rendimiento y la confiabilidad**, Nitro aprovecha componentes de **hardware personalizados y un hipervisor ligero**. Abstrae gran parte de la funcionalidad de virtualizaci칩n tradicional a hardware y software dedicados, **minimizando la superficie de ataque** y mejorando la eficiencia de recursos. Al descargar funciones de virtualizaci칩n, Nitro permite a las instancias de EC2 ofrecer un rendimiento **casi bare-metal**, lo que lo hace particularmente beneficioso para aplicaciones intensivas en recursos. Adem치s, el Chip de Seguridad Nitro garantiza espec칤ficamente la **seguridad del hardware y firmware**, fortaleciendo a칰n m치s su arquitectura robusta.

### Enclaves Nitro

**AWS Nitro Enclaves** proporciona un entorno de c치lculo seguro e **aislado dentro de las instancias de Amazon EC2**, dise침ado espec칤ficamente para procesar datos altamente sensibles. Aprovechando el Sistema AWS Nitro, estos enclaves garantizan un **aislamiento y seguridad robustos**, ideales para **manejar informaci칩n confidencial** como PII o registros financieros. Cuentan con un entorno minimalista, reduciendo significativamente el riesgo de exposici칩n de datos. Adem치s, los Enclaves Nitro admiten la atestaci칩n criptogr치fica, lo que permite a los usuarios verificar que solo se est치 ejecutando c칩digo autorizado, crucial para mantener estrictos est치ndares de cumplimiento y protecci칩n de datos.

{% hint style="danger" %}
Las im치genes de Enclave Nitro se **ejecutan desde dentro de las instancias de EC2** y no se puede ver desde la consola web de AWS si una instancia de EC2 est치 ejecutando im치genes en Enclave Nitro o no.
{% endhint %}

## Instalaci칩n de CLI de Enclave Nitro

Sigue todas las instrucciones [**de la documentaci칩n**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Sin embargo, estas son las m치s importantes:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Im치genes de Nitro Enclave

Las im치genes que puedes ejecutar en Nitro Enclave est치n basadas en im치genes de docker, por lo que puedes crear tus propias im치genes de Nitro Enclave a partir de im치genes de docker como:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Como puedes ver, las im치genes de Nitro Enclave utilizan la extensi칩n **`eif`** (Enclave Image File).

La salida se ver치 similar a:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Ejecutar una imagen

Seg칰n [**la documentaci칩n**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), para ejecutar una imagen de enclave necesitas asignarle memoria de **al menos 4 veces el tama침o del archivo `eif`**. Es posible configurar los recursos predeterminados para asignarle en el archivo.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
춰Siempre recuerda que necesitas **reservar algunos recursos para la instancia EC2** principal tambi칠n!
{% endhint %}

Despu칠s de conocer los recursos para asignar a una imagen e incluso haber modificado el archivo de configuraci칩n, es posible ejecutar una imagen de enclave con:
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumerar Enclaves

Si comprometes un host de EC2, es posible obtener una lista de im치genes de enclaves en ejecuci칩n con:
```bash
nitro-cli describe-enclaves
```
No es posible obtener una shell dentro de una imagen de enclave en ejecuci칩n porque ese es el prop칩sito principal del enclave, sin embargo, si usaste el par치metro `--debug-mode`, es posible obtener su stdout con:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Terminar Enclaves

Si un atacante compromete una instancia de EC2, por defecto no podr치 obtener una shell dentro de ellas, pero podr치 **terminarlas** con:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

La 칰nica forma de comunicarse con una imagen en ejecuci칩n de **enclave** es usando **vsocks**.

**Socket Virtual (vsock)** es una familia de sockets en Linux dise침ada espec칤ficamente para facilitar la **comunicaci칩n** entre m치quinas virtuales (**VMs**) y sus **hipervisores**, o entre las propias VMs. Vsock permite una **comunicaci칩n bidireccional** eficiente sin depender de la pila de red del host. Esto hace posible que las VMs se comuniquen incluso sin configuraciones de red, **utilizando un ID de Contexto (CID) de 32 bits y n칰meros de puerto** para identificar y gestionar conexiones. La API de vsock admite tanto tipos de sockets de flujo como de datagramas, similares a TCP y UDP, proporcionando una herramienta vers치til para aplicaciones a nivel de usuario en entornos virtuales.

{% hint style="success" %}
Por lo tanto, una direcci칩n vsock se ve as칤: `<CID>:<Puerto>`
{% endhint %}

Para encontrar los **CIDs** de las im치genes en ejecuci칩n del enclave, simplemente puedes ejecutar el siguiente comando y obtener el **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "ejemplo-canal-seguro",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
춰Ten en cuenta que desde el host no hay forma de saber si un CID est치 exponiendo alg칰n puerto! A menos que uses alg칰n **esc치ner de puertos vsock como** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Servidor/Listener Vsock

Aqu칤 tienes un par de ejemplos:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Listener Simple en Python</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Cliente Vsock

Ejemplos:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Cliente Python Simple</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</detalles>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Proxy Vsock

La herramienta vsock-proxy permite hacer un proxy de un proxy vsock con otra direcci칩n, por ejemplo:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Esto reenviar치 el **puerto local 8001 en vsock** a `ip-ranges.amazonaws.com:443` y el archivo **`your-vsock-proxy.yaml`** podr칤a tener este contenido que permite acceder a `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Es posible ver las direcciones vsock (**`<CID>:<Puerto>`**) utilizadas por el host de EC2 con (nota el `3:8001`, donde 3 es el CID y 8001 es el puerto):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Attestation y KMS de Nitro Enclave

El SDK de Nitro Enclaves permite que una enclave solicite un **documento de certificaci칩n firmado criptogr치ficamente** al **Hipervisor** de Nitro, que incluye **mediciones 칰nicas** espec칤ficas de esa enclave. Estas mediciones, que incluyen **hashes y registros de configuraci칩n de plataforma (PCRs)**, se utilizan durante el proceso de certificaci칩n para **demostrar la identidad de la enclave** y **construir confianza con servicios externos**. El documento de certificaci칩n t칤picamente contiene valores como PCR0, PCR1 y PCR2, con los que te has encontrado antes al construir y guardar un EIF de enclave.

Desde la [**documentaci칩n**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), estos son los valores de PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash de ...</th><th>Descripci칩n</th></tr></thead><tbody><tr><td>PCR0</td><td>Archivo de imagen de enclave</td><td>Una medida contigua del contenido del archivo de imagen, sin los datos de la secci칩n.</td></tr><tr><td>PCR1</td><td>N칰cleo de Linux y arranque</td><td>Una medici칩n contigua del n칰cleo y los datos de arranque de ramfs.</td></tr><tr><td>PCR2</td><td>Aplicaci칩n</td><td>Una medici칩n contigua y en orden de las aplicaciones de usuario, sin el ramfs de arranque.</td></tr><tr><td>PCR3</td><td>Rol IAM asignado a la instancia principal</td><td>Una medici칩n contigua del rol IAM asignado a la instancia principal. Asegura que el proceso de certificaci칩n tenga 칠xito solo cuando la instancia principal tiene el rol IAM correcto.</td></tr><tr><td>PCR4</td><td>ID de instancia de la instancia principal</td><td>Una medici칩n contigua del ID de la instancia principal. Asegura que el proceso de certificaci칩n tenga 칠xito solo cuando la instancia principal tiene un ID de instancia espec칤fico.</td></tr><tr><td>PCR8</td><td>Certificado de firma de archivo de imagen de enclave</td><td>Una medida del certificado de firma especificado para el archivo de imagen de enclave. Asegura que el proceso de certificaci칩n tenga 칠xito solo cuando el enclave se haya iniciado desde un archivo de imagen de enclave firmado por un certificado espec칤fico.</td></tr></tbody></table>

Puedes integrar la **certificaci칩n criptogr치fica** en tus aplicaciones y aprovechar integraciones preconstruidas con servicios como **AWS KMS**. AWS KMS puede **validar certificaciones de enclave** y ofrece claves de condici칩n basadas en certificaciones (`kms:RecipientAttestation:ImageSha384` y `kms:RecipientAttestation:PCR`) en sus pol칤ticas de clave. Estas pol칤ticas aseguran que AWS KMS permita operaciones utilizando la clave de KMS **solo si el documento de certificaci칩n de la enclave es v치lido** y cumple con las **condiciones especificadas**.

{% hint style="success" %}
Ten en cuenta que las Enclaves en modo de depuraci칩n (--debug) generan documentos de certificaci칩n con PCRs que est치n compuestos por ceros (`000000000000000000000000000000000000000000000000`). Por lo tanto, las pol칤ticas de KMS que verifiquen estos valores fallar치n.
{% endhint %}

### Bypass de PCR

Desde la perspectiva de un atacante, se debe tener en cuenta que algunos PCRs permitir칤an modificar algunas partes o toda la imagen de enclave y seguir칤an siendo v치lidos (por ejemplo, PCR4 solo verifica el ID de la instancia principal, por lo que ejecutar cualquier imagen de enclave en esa EC2 permitir치 cumplir con este posible requisito de PCR).

Por lo tanto, un atacante que comprometa la instancia EC2 podr칤a ser capaz de ejecutar otras im치genes de enclave para evitar estas protecciones.

La investigaci칩n sobre c칩mo modificar/crear nuevas im치genes para evitar cada protecci칩n (especialmente las que no son tan obvias) a칰n est치 PENDIENTE.

## Referencias

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Todas las partes del tutorial de Nitro de AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
