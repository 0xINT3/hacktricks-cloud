# AWS - Nitro Enum

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Basiese Inligting

AWS Nitro is 'n stel van **innoverende tegnologie√´** wat die onderliggende platform vorm vir AWS EC2-instanies. Deur Amazon bekendgestel om **sekuriteit, prestasie, en betroubaarheid te verbeter**, maak Nitro gebruik van aangepaste **hardewarekomponente en 'n ligte hipervisor**. Dit abstraheer groot dele van die tradisionele virtualiseringsfunksionaliteit na toegewyde hardeware en sagteware, **minimeer die aanvalsoppervlak** en verbeter hulpbron doeltreffendheid. Deur virtualiseringsfunksies af te laai, maak Nitro dit moontlik vir EC2-instanies om **naby aan bare-metal prestasie** te lewer, wat dit veral voordelig maak vir hulpbron-intensiewe toepassings. Daarbenewens verseker die Nitro Security Chip spesifiek die **sekuriteit van die hardeware en firmware**, wat sy robuuste argitektuur verder versterk.

### Nitro Enclaves

**AWS Nitro Enclaves** bied 'n veilige, **ge√Øsoleerde rekenomgewing binne Amazon EC2-instanies**, spesifiek ontwerp vir die verwerking van hoogs sensitiewe data. Deur die AWS Nitro-stelsel te benut, verseker hierdie enklaves robuuste **isolering en sekuriteit**, ideaal vir **die hanteer van vertroulike inligting** soos PII of finansi√´le rekords. Hulle bied 'n minimalistiese omgewing, wat die risiko van data- blootstelling aansienlik verminder. Daarbenewens ondersteun Nitro Enclaves kriptografiese attestasie, wat gebruikers in staat stel om te verifieer dat slegs gemagtigde kode loop, wat noodsaaklik is vir die handhawing van streng nakomings- en data beskermingsstandaarde.

{% hint style="danger" %}
Nitro Enclave-beelde word **van binne EC2-instanies uitgevoer** en jy kan nie vanaf die AWS-webkonsolide sien of 'n EC2-instanie beelde in Nitro Enclave uitvoer nie.
{% endhint %}

## Nitro Enclave CLI-installering

Volg al die instruksies [**van die dokumentasie**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Nietemin, hierdie is die belangrikste:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Afsonderingsbeeld

Die beelde wat jy in Nitro Afsondering kan hardloop, is gebaseer op docker-beelde, sodat jy jou Nitro Afsonderingsbeelde van docker-beelde kan skep soos:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Soos u kan sien, gebruik die Nitro Enclave-beelde die uitbreiding **`eif`** (Enclave Image File).

Die uitset sal soortgelyk lyk aan:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Voer 'n Afbeelding Uit

Volgens [**die dokumentasie**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), om 'n enklave-afbeelding uit te voer, moet jy dit toewys met geheue van **ten minste 4 keer die grootte van die `eif`-l√™er**. Dit is moontlik om die verstekbronne te konfigureer wat daaraan gegee moet word in die l√™er.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Onthou altyd dat jy ook **'n paar hulpbronne vir die ouer EC2**-instansie moet bespreek!
{% endhint %}

Nadat jy die hulpbronne ken wat aan 'n beeld gegee moet word en selfs die konfigurasie l√™er gewysig het, is dit moontlik om 'n afgeslote beeld uit te voer met:
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enumereer Enklaves

Indien jy 'n EC2-gashost kompromitteer, is dit moontlik om 'n lys van lopende enklawe-afbeeldings te verkry met:
```bash
nitro-cli describe-enclaves
```
Dit is **nie moontlik om 'n skaal binne 'n lopende omheiningbeeld te kry** nie omdat dit die hoofdoel van die omheining is, maar as jy die parameter **`--debug-mode`** gebruik, is dit moontlik om die **stdout** daarvan te kry met:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Be√´indig Insluitings

Indien 'n aanvaller 'n EC2-instantie kompromitteer, sal hy standaard nie 'n skaal binne-in hulle kan kry nie, maar hy sal hulle wel kan **be√´indig** met:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

Die enigste manier om met 'n **enclave** wat 'n beeld hardloop te kommunikeer, is deur **vsocks** te gebruik.

**Virtuele Soket (vsock)** is 'n soketfamilie in Linux wat spesifiek ontwerp is om **kommunikasie** tussen virtuele masjiene (**VM's**) en hul **hipervisors**, of tussen VM's **self** te fasiliteer. Vsock maak effektiewe, **tweerigting kommunikasie** moontlik sonder om op die gasheer se netwerkstapel te steun. Dit maak dit moontlik vir VM's om te kommunikeer selfs sonder netwerkkonfigurasies, **deur 'n 32-bis Context ID (CID) en poortnommers** te gebruik om verbindinge te identifiseer en te bestuur. Die vsock API ondersteun beide stroom- en datagram-sokettipes, soortgelyk aan TCP en UDP, wat 'n veelsydige instrument vir gebruikersvlaktoepassings in virtuele omgewings bied.

{% hint style="success" %}
Daarom lyk 'n vsock-adres soos dit: `<CID>:<Poort>`
{% endhint %}

Om die **CID's** van die enclave wat beelde hardloop te vind, kan jy net die volgende opdrag uitvoer en die **`EnclaveCID`** kry:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Let daarop dat daar vanaf die gasheer geen manier is om te weet of 'n CID enige poort blootstel nie! Tensy jy 'n **vsock-poortskandeerder soos** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) gebruik.
{% endhint %}

### Vsock-bediener/luisteraar

Vind hier 'n paar voorbeelde:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Eenvoudige Python Luisteraar</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock Kli√´nt

Voorbeelde:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Eenvoudige Python Kli√´nt</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proksi

Die gereedskap vsock-proxy maak dit moontlik om 'n vsock proksi met 'n ander adres te proksi, byvoorbeeld:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Dit sal die **plaaslike poort 8001 in vsock** na `ip-ranges.amazonaws.com:443` deurstuur en die l√™er **`jou-vsock-proxy.yaml`** mag hierdie inhoud h√™ wat toegang tot `ip-ranges.amazonaws.com:443` moontlik maak:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Dit is moontlik om die vsock-adresse (**`<CID>:<Port>`**) wat deur die EC2-gashere gebruik word, te sien met (merk op die `3:8001`, 3 is die CID en 8001 die poort):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Attestasie & KMS

Die Nitro Enclaves SDK maak dit moontlik vir 'n enklawe om 'n **kriptografies ondertekende attestasiedokument** van die Nitro **Hypervisor** aan te vra, wat **unieke metings** spesifiek vir daardie enklawe insluit. Hierdie metings, wat **hasse en platformkonfigurasie-registers (PCRs)** insluit, word tydens die attestasieproses gebruik om die enklawe se identiteit te **bewys** en **vertroue op te bou met eksterne dienste**. Die attestasiedokument bevat tipies waardes soos PCR0, PCR1, en PCR2, wat jy al voorheen te√´gekom het toe jy 'n enklawe EIF gebou en gestoor het.

Vanuit die [**dokumente**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), is hierdie die PCR-waardes:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash van ...</th><th>Beskrywing</th></tr></thead><tbody><tr><td>PCR0</td><td>Enklawe-beeldl√™er</td><td'N Aaneenlopende meting van die inhoud van die beeldl√™er, sonder die afdelingsdata.</td></tr><tr><td>PCR1</td><td>Linux-kernel en opstart</td><td'N Aaneenlopende meting van die kernel en opstart ramfs-data.</td></tr><tr><td>PCR2</td><td>Aansoek</td><td'N Aaneenlopende, in-orde meting van die gebruikersaansoeke, sonder die opstart ramfs.</td></tr><tr><td>PCR3</td><td>IAM rol toegewys aan die ouer instansie</td><td'N Aaneenlopende meting van die IAM rol wat aan die ouer instansie toegewys is. Verseker dat die attestasieproses slegs suksesvol is wanneer die ouer instansie die korrekte IAM rol het.</td></tr><tr><td>PCR4</td><td>Instansie-ID van die ouer instansie</td><td'N Aaneenlopende meting van die ID van die ouer instansie. Verseker dat die attestasieproses slegs suksesvol is wanneer die ouer instansie 'n spesifieke instansie-ID het.</td></tr><tr><td>PCR8</td><td>Enklawe-beeldl√™er-ondertekeningsertifikaat</td><td'N Meting van die ondertekeningsertifikaat wat gespesifiseer is vir die enklawe-beeldl√™er. Verseker dat die attestasieproses slegs suksesvol is wanneer die enklawe van 'n enklawe-beeldl√™er geboek is wat deur 'n spesifieke sertifikaat onderteken is.</td></tr></tbody></table>

Jy kan **kriptografiese attestasie** in jou aansoeke integreer en voorafgeboude integrasies met dienste soos **AWS KMS** benut. AWS KMS kan **enklawe-attestasies valideer** en bied attestasie-gebaseerde toestandsleutels (`kms:RecipientAttestation:ImageSha384` en `kms:RecipientAttestation:PCR`) in sy sleutelbeleide. Hierdie beleide verseker dat AWS KMS operasies met die KMS-sleutel toelaat **slegs as die enklawe se attestasiedokument geldig is** en aan die **spesifieke voorwaardes voldoen**.

{% hint style="success" %}
Let daarop dat Enklawes in debug (--debug) modus attestasiedokumente genereer met PCRs wat uit nulle (`000000000000000000000000000000000000000000000000`) bestaan. Daarom sal KMS-beleide wat hierdie waardes nagaan, misluk.
{% endhint %}

### PCR Oorslaan

Vanuit 'n aanvaller se perspektief, let daarop dat sommige PCRs dit moontlik sou maak om sommige dele of al die enklawe-beeld te wysig en steeds geldig te wees (byvoorbeeld PCR4 kyk net na die ID van die ouer instansie, dus sal enige enklawe-beeld wat in daardie EC2 hardloop, toelaat om aan hierdie potensi√´le PCR-vereiste te voldoen).

Daarom kan 'n aanvaller wat die EC2-instansie kompromitteer, moontlik ander enklawe-beelde hardloop om hierdie beskermings te omseil.

Die navorsing oor hoe om elke beskerming te wysig/skep om die beskerming te omseil (veral die nie so voor die hand liggende) is nog te doen.

## Verwysings

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Al die dele van die Nitro-handleiding van AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
