# AWS - Nitro Enum

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい場合** は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) または [**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** をフォローする。**
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する。

</details>

## 基本情報

AWS Nitro は、AWS EC2 インスタンスの基盤となる **革新的なテクノロジーのスイート** です。Amazon によって導入され、**セキュリティ、パフォーマンス、信頼性を向上** させるために、Nitro はカスタム **ハードウェアコンポーネントと軽量ハイパーバイザー** を活用しています。Nitro は従来の仮想化機能の多くを専用ハードウェアとソフトウェアに抽象化し、**攻撃面を最小限に抑え、リソース効率を向上** させます。仮想化機能をオフロードすることで、Nitro は EC2 インスタンスが **ベアメタルに近いパフォーマンス** を提供できるようにし、リソース集約型アプリケーションに特に有益です。さらに、Nitro セキュリティチップは、**ハードウェアとファームウェアのセキュリティ** を確保し、その堅牢なアーキテクチャをさらに強化しています。

### Nitro Enclaves

**AWS Nitro Enclaves** は、Amazon EC2 インスタンス内で **高度に機密性の高いデータを処理するために特別に設計された**、安全な **隔離されたコンピュート環境** を提供します。AWS Nitro システムを活用することで、これらのエンクレーブは堅牢な **隔離とセキュリティ** を確保し、PII や財務記録などの **機密情報の取り扱い** に最適です。エンクレーブは、データ露出のリスクを大幅に減らすために、最小限の環境を備えています。さらに、Nitro Enclaves は暗号化アテステーションをサポートし、認証されたコードのみが実行されていることをユーザーが検証できるようにしており、厳格なコンプライアンスとデータ保護基準を維持するために重要です。

{% hint style="danger" %}
Nitro Enclave イメージは **EC2 インスタンス内部から実行** され、AWS ウェブコンソールから EC2 インスタンスが Nitro Enclave でイメージを実行しているかどうかを確認することはできません。
{% endhint %}

## Nitro Enclave CLI のインストール

[**ドキュメントから**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) すべての手順に従ってください。ただし、以下が最も重要です:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave イメージ

Nitro Enclave で実行できるイメージは、Docker イメージをベースにしています。したがって、次のような Docker イメージから Nitro Enclave イメージを作成できます:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Nitro Enclaveのイメージは、拡張子**`eif`**（Enclave Image File）を使用しています。

出力は次のようになります：
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### イメージの実行

[**ドキュメント**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave)によると、エンクレーブイメージを実行するには、そのメモリに **`eif` ファイルのサイズの少なくとも4倍** を割り当てる必要があります。ファイル内でそれに与えるデフォルトリソースを構成することが可能です。
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
親EC2インスタンスにも**一部のリソースを予約する必要がある**ことを常に覚えておいてください！
{% endhint %}

リソースを画像に与えることを知った後、構成ファイルを変更した場合、次のようにエンクレーブ画像を実行できます：

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### エンクレーブの列挙

EC2ホストを侵害した場合、実行中のエンクレーブイメージのリストを取得することが可能です:
```bash
nitro-cli describe-enclaves
```
それは**enclave**内の実行中のイメージ内でシェルを取得することはできません。それがenclaveの主な目的ですが、ただし、パラメータ**`--debug-mode`**を使用すると、それの**stdout**を取得することが可能です：
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### エンクレーブの終了

攻撃者がEC2インスタンスを侵害した場合、デフォルトではそれらの内部にシェルを取得することはできませんが、次のコマンドでそれらを**終了**することができます：
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock（Vソックス）

**エンクレーブ**実行イメージと通信する唯一の方法は、**vsocks**を使用することです。

**仮想ソケット（vsock）**は、Linuxのソケットファミリーであり、仮想マシン（**VM**）とそれらの**ハイパーバイザー**、またはVM同士の**通信**を容易にするために特別に設計されています。 Vsockは、ホストのネットワーキングスタックに依存せずに、効率的で**双方向の通信**を可能にします。これにより、VMはネットワーク構成なしでも通信できるようになります。**32ビットのコンテキストID（CID）とポート番号**を使用して接続を識別および管理します。 vsock APIは、TCPとUDPに類似したストリームおよびデータグラムソケットタイプの両方をサポートし、仮想環境のユーザーレベルアプリケーションに対する多目的なツールを提供します。

{% hint style="success" %}
したがって、vsockアドレスは次のようになります：`<CID>:<Port>`
{% endhint %}

**エンクレーブ**実行イメージの**CID**を見つけるには、次のコマンドを実行して**`EnclaveCID`**を取得できます：

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
ホストからは、CIDがどのポートを公開しているかを知る方法はありません！**[https://github.com/carlospolop/Vsock-scanner](https://github.com/carlospolop/Vsock-scanner)**のような**vsockポートスキャナー**を使用しない限り。
{% endhint %}

### Vsockサーバー/リスナー

ここにいくつかの例があります：

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>シンプルなPythonリスナー</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>  

<details>  

### AWS Nitro Enum  

#### EC2 Nitro Instances  

Nitro instances are a new hypervisor for EC2 instances that enables better performance and security. Nitro instances use Nitro cards to offload tasks from the main CPU, improving overall performance.  

#### Nitro API Endpoints  

- `nitro-enclave` - Used for launching EC2 instances with Nitro Enclaves.  
- `nitro-security` - Used for managing Nitro Security Groups.  
- `nitro-smartnic` - Used for managing Nitro SmartNICs.  

#### Nitro Security Groups  

Nitro Security Groups are used to control traffic to and from Nitro-based instances. They act as a firewall controlling inbound and outbound traffic.  

#### Nitro SmartNIC  

Nitro SmartNICs are network interface cards that offload network processing from the main CPU. They improve network performance and reduce the load on the main CPU.  

#### Nitro Enclaves  

Nitro Enclaves are isolated environments for sensitive data processing. They provide a secure environment for processing confidential data within an EC2 instance.  

</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock クライアント

例:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>シンプルな Python クライアント</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

ツールvsock-proxyを使用すると、別のアドレスでvsockプロキシをプロキシ化できます。例：
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
これにより、**vsock内のローカルポート8001**が`ip-ranges.amazonaws.com:443`に転送され、ファイル**`your-vsock-proxy.yaml`**には、`ip-ranges.amazonaws.com:443`にアクセスできるようにするための次の内容が含まれている可能性があります：
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
以下は、EC2ホストで使用されているvsockアドレス（**`<CID>:<Port>`**）を確認することができます（`3:8001`に注意してください。3はCIDであり、8001はポートです）：

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Nitro Enclave Atestation & KMS

Nitro Enclaves SDKを使用すると、エンクレーブはNitro Hypervisorから**暗号化された署名付きアテステーションドキュメント**をリクエストできます。このドキュメントには、そのエンクレーブに固有の**一意の測定値**が含まれます。これらの測定値には、**ハッシュやプラットフォーム構成レジスタ（PCRs）**が含まれ、アテステーションプロセス中に使用され、**エンクレーブのアイデンティティを証明**し、**外部サービスとの信頼関係を構築**します。アテステーションドキュメントには通常、PCR0、PCR1、PCR2などの値が含まれます。これらは、エンクレーブEIFを構築および保存する際に以前に遭遇したものです。

[**ドキュメント**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves)によると、以下がPCRの値です：

<table><thead><tr><th width="97">PCR</th><th width="221">...のハッシュ</th><th>説明</th></tr></thead><tbody><tr><td>PCR0</td><td>エンクレーブイメージファイル</td><td>セクションデータを除いたイメージファイルの内容の連続した測定。</td></tr><tr><td>PCR1</td><td>Linuxカーネルとブートストラップ</td><td>カーネルとブートramfsデータの連続した測定。</td></tr><tr><td>PCR2</td><td>アプリケーション</td><td>ブートramfsを除いたユーザーアプリケーションの連続した順序測定。</td></tr><tr><td>PCR3</td><td>親インスタンスに割り当てられたIAMロール</td><td>親インスタンスに割り当てられたIAMロールの連続した測定。アテステーションプロセスが正常に完了するのは、親インスタンスが正しいIAMロールを持っている場合のみです。</td></tr><tr><td>PCR4</td><td>親インスタンスのインスタンスID</td><td>親インスタンスのIDの連続した測定。アテステーションプロセスが正常に完了するのは、親インスタンスが特定のインスタンスIDを持っている場合のみです。</td></tr><tr><td>PCR8</td><td>エンクレーブイメージファイルの署名証明書</td><td>エンクレーブイメージファイルに指定された署名証明書の測定。アテステーションプロセスが正常に完了するのは、特定の証明書で署名されたエンクレーブイメージファイルから起動された場合のみです。</td></tr></tbody></table>

**暗号化アテステーション**をアプリケーションに統合し、**AWS KMS**などのサービスとの事前構築された統合を活用できます。AWS KMSは**エンクレーブのアテステーションを検証**し、キーポリシーでアテステーションベースの条件キー（`kms:RecipientAttestation:ImageSha384`および`kms:RecipientAttestation:PCR`）を提供します。これらのポリシーにより、AWS KMSは**エンクレーブのアテステーションドキュメントが有効であり、指定された条件を満たす場合にのみKMSキーを使用することを許可**します。

{% hint style="success" %}
デバッグモード（--debug）のEnclavesは、ゼロ（`000000000000000000000000000000000000000000000000`）で構成されたPCRを持つアテステーションドキュメントを生成します。したがって、これらの値をチェックするKMSポリシーは失敗します。
{% endhint %}

### PCRバイパス

攻撃者の視点から、一部のPCRを変更しても、エンクレーブイメージの一部またはすべてを変更しても有効である可能性があることに注意してください（たとえば、PCR4は親インスタンスのIDをチェックするだけなので、そのEC2で任意のエンクレーブイメージを実行すると、このPCR要件を満たすことができます）。

したがって、EC2インスタンスを侵害した攻撃者は、これらの保護をバイパスするために他のエンクレーブイメージを実行できる可能性があります。

各保護をバイパスするための画像の変更/作成方法に関する研究（特に明らかでないもの）は、まだTODOです。

## 参考文献

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWSのNitroチュートリアルのすべての部分：[https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>で**ゼロからヒーローまでAWSハッキングを学ぶ**</summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
