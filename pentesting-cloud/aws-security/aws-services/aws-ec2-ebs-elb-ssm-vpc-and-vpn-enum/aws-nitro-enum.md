# AWS - Απαρίθμηση Nitro

<details>

<summary><strong>Μάθετε χάκερ AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκερ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>

## Βασικές Πληροφορίες

Το AWS Nitro είναι μια σουίτα από **καινοτόμες τεχνολογίες** που αποτελούν τη βασική πλατφόρμα για τις περιπτώσεις AWS EC2. Εισήχθη από την Amazon για να **ενισχύσει την ασφάλεια, την απόδοση και την αξιοπιστία**, το Nitro εκμεταλλεύεται προσαρμοσμένα **υλικά εξαρτήματα και ένα ελαφρύ υποσύστημα**. Αφαιρεί μεγάλο μέρος της παραδοσιακής λειτουργικότητας εικονικοποίησης σε αφιερωμένο υλικό και λογισμικό, **ελαχιστοποιώντας την επιφάνεια επίθεσης** και βελτιώνοντας την αποδοτικότητα των πόρων. Με την απομάκρυνση των λειτουργιών εικονικοποίησης, το Nitro επιτρέπει στις περιπτώσεις EC2 να παρέχουν **απόδοση κοντά στο μεταλλικό επίπεδο**, κάτι που είναι ιδιαίτερα ωφέλιμο για εφαρμογές με μεγάλες απαιτήσεις πόρων. Επιπλέον, το Nitro Security Chip εξασφαλίζει ειδικά την **ασφάλεια του υλικού και του firmware**, ενισχύοντας περαιτέρω τη στιβαρή του αρχιτεκτονική.

### Nitro Enclaves

Το **AWS Nitro Enclaves** παρέχει ένα ασφαλές, **απομονωμένο περιβάλλον υπολογισμού εντός των περιπτώσεων Amazon EC2**, σχεδιασμένο ειδικά για την επεξεργασία υψηλά ευαίσθητων δεδομένων. Χρησιμοποιώντας το Σύστημα AWS Nitro, αυτά τα enclaves εξασφαλίζουν αξιόπιστη **απομόνωση και ασφάλεια**, ιδανική για την **χειρισμό εμπιστευτικών πληροφοριών** όπως τα PII ή τα οικονομικά αρχεία. Διαθέτουν ένα περιβάλλον ελάχιστων δυνατοτήτων, μειώνοντας σημαντικά τον κίνδυνο εκθέσεως δεδομένων. Επιπλέον, τα Nitro Enclaves υποστηρίζουν κρυπτογραφική επαλήθευση, επιτρέποντας στους χρήστες να επαληθεύουν ότι τρέχει μόνο εξουσιοδοτημένος κώδικας, κάτι που είναι κρίσιμο για τη διατήρηση αυστηρών προτύπων συμμόρφωσης και προστασίας δεδομένων.

{% hint style="danger" %}
Οι εικόνες Nitro Enclave **τρέχουν από μέσα σε περιπτώσεις EC2** και δεν μπορείτε να δείτε από την ιστοσελίδα του AWS αν μια περίπτωση EC2 τρέχει εικόνες σε Nitro Enclave ή όχι.
{% endhint %}

## Εγκατάσταση Εντολικού Nitro Enclave

Ακολουθήστε όλες τις οδηγίες [**από την τεκμηρίωση**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Ωστόσο, αυτές είναι οι πιο σημαντικές:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Εικόνες Nitro Enclave

Οι εικόνες που μπορείτε να εκτελέσετε στο Nitro Enclave βασίζονται σε εικόνες docker, έτσι μπορείτε να δημιουργήσετε τις δικές σας εικόνες Nitro Enclave από εικόνες docker όπως:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Όπως μπορείτε να δείτε, οι εικόνες Nitro Enclave χρησιμοποιούν την επέκταση **`eif`** (Enclave Image File).

Η έξοδος θα μοιάζει με:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Εκτέλεση μιας Εικόνας

Σύμφωνα με [**την τεκμηρίωση**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), για να εκτελέσετε μια εικόνα enclave πρέπει να της ανατεθεί μνήμη τουλάχιστον **4 φορές το μέγεθος του αρχείου `eif`**. Είναι δυνατόν να διαμορφώσετε τους προεπιλεγμένους πόρους που θα της δώσετε στο αρχείο.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Να θυμάστε πάντα ότι πρέπει να **κρατήσετε κάποιους πόρους για τη γονική EC2** περίπτωση!
{% endhint %}

Αφού γνωρίζετε τους πόρους που πρέπει να δώσετε σε μια εικόνα και έχετε ακόμα τροποποιήσει το αρχείο ρυθμίσεων, είναι δυνατόν να εκτελέσετε μια εικόνα περιοχής με:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Απαριθμήστε Οχυρώματα

Εάν διαρρεύσετε έναν οικοδεσπότη EC2, είναι δυνατόν να λάβετε μια λίστα με τις εικόνες οχυρώματος που τρέχουν με:
```bash
nitro-cli describe-enclaves
```
Δεν είναι δυνατόν να λάβετε ένα κέλυφος μέσα σε μια εικόνα περιοχής επειδή αυτός είναι ο κύριος σκοπός της περιοχής, ωστόσο, εάν χρησιμοποιήσετε την παράμετρο **`--debug-mode`**, είναι δυνατόν να λάβετε το **stdout** του με:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Τερματισμός Περιβαλλοντικών Ζωνών

Εάν ένας εισβολέας καταφέρει να διαρρήξει ένα παράδειγμα EC2, προεπιλεγμένα δεν θα μπορέσει να λάβει ένα κέλυφος μέσα σε αυτά, αλλά θα μπορεί να **τερματίσει** τα:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

Ο μοναδικός τρόπος επικοινωνίας με ένα **enclave** που εκτελεί εικόνα είναι μέσω **vsocks**.

Το **Virtual Socket (vsock)** είναι μια οικογένεια sockets στο Linux σχεδιασμένη ειδικά για να διευκολύνει τη **επικοινωνία** μεταξύ εικονικών μηχανών (**VMs**) και των **υπερεκτελεστών** τους, ή μεταξύ των ίδιων των VMs. Το vsock επιτρέπει αποδοτική, **διπλής κατεύθυνσης επικοινωνία** χωρίς να βασίζεται στη στοίβα δικτύου του υπολογιστή φιλοξενίας. Αυτό καθιστά δυνατή την επικοινωνία των VMs ακόμα και χωρίς ρυθμίσεις δικτύου, **χρησιμοποιώντας ένα 32-bit Context ID (CID) και αριθμούς θύρας** για την αναγνώριση και διαχείριση συνδέσεων. Το API του vsock υποστηρίζει τόσο sockets ροής όσο και datagram, παρόμοια με TCP και UDP, παρέχοντας ένα ευέλικτο εργαλείο για εφαρμογές σε επίπεδο χρήστη σε εικονικά περιβάλλοντα.

{% hint style="success" %}
Επομένως, μια διεύθυνση vsock φαίνεται έτσι: `<CID>:<Θύρα>`
{% endhint %}

Για να βρείτε τα **CIDs** των εικόνων που εκτελούν το enclave, μπορείτε απλά να εκτελέσετε την παρακάτω εντολή και να πάρετε το **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Σημειώστε ότι από τον υπολογιστή φιλοξενίας δεν υπάρχει τρόπος να γνωρίζετε αν ένα CID εκθέτει κάποια θύρα! Εκτός αν χρησιμοποιήσετε κάποιο **σαρωτή θυρών vsock όπως** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Vsock Server/Listener

Βρείτε εδώ μερικά παραδείγματα:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Απλός Ακροατής σε Python</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Πελάτης Vsock

Παραδείγματα:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Απλός Πελάτης σε Python</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Προξενήτρα

Το εργαλείο vsock-proxy επιτρέπει την προώθηση ενός vsock προξενητή προς μια άλλη διεύθυνση, για παράδειγμα:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Αυτό θα προωθήσει τη **τοπική θύρα 8001 στο vsock** προς το `ip-ranges.amazonaws.com:443` και το αρχείο **`your-vsock-proxy.yaml`** μπορεί να περιέχει αυτό το περιεχόμενο επιτρέποντας την πρόσβαση στο `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Είναι δυνατόν να δείτε τις διευθύνσεις vsock (**`<CID>:<Port>`**) που χρησιμοποιούνται από τον φιλοξενητή EC2 με (σημειώστε το `3:8001`, όπου το 3 είναι το CID και το 8001 η θύρα):
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Επαλήθευση Nitro Enclave & KMS

Το SDK των Nitro Enclaves επιτρέπει σε ένα enclave να ζητήσει ένα **κρυπτογραφημένο υπογεγραμμένο έγγραφο επαλήθευσης** από το **Hypervisor** των Nitro, το οποίο περιλαμβάνει **μοναδικές μετρήσεις** που είναι συγκεκριμένες σε αυτό το enclave. Αυτές οι μετρήσεις, οι οποίες περιλαμβάνουν **hashes και registers ρυθμίσεων πλατφόρμας (PCRs)**, χρησιμοποιούνται κατά τη διαδικασία επαλήθευσης για να **αποδείξουν την ταυτότητα του enclave** και να **κτίσουν εμπιστοσύνη με εξωτερικές υπηρεσίες**. Το έγγραφο επαλήθευσης περιλαμβάνει τυπικά τιμές όπως PCR0, PCR1 και PCR2, τις οποίες έχετε συναντήσει προηγουμένως κατά τη δημιουργία και αποθήκευση ενός enclave EIF.

Από τα [**έγγραφα**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), αυτές είναι οι τιμές των PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash του...</th><th>Περιγραφή</th></tr></thead><tbody><tr><td>PCR0</td><td>Αρχείο εικόνας enclave</td><td>Μια συνεχής μέτρηση του περιεχομένου του αρχείου εικόνας, χωρίς τα δεδομένα τμήματος.</td></tr><tr><td>PCR1</td><td>Πυρήνας Linux και εκκίνηση</td><td>Μια συνεχής μέτρηση του πυρήνα και των δεδομένων εκκίνησης ramfs.</td></tr><tr><td>PCR2</td><td>Εφαρμογή</td><td>Μια συνεχής, με σειρά μέτρηση των εφαρμογών χρήστη, χωρίς τα δεδομένα εκκίνησης ramfs.</td></tr><tr><td>PCR3</td><td>Ρόλος IAM που έχει ανατεθεί στη γονική έκδοση</td><td>Μια συνεχής μέτρηση του ρόλου IAM που έχει ανατεθεί στη γονική έκδοση. Βεβαιώνει ότι η διαδικασία επαλήθευσης επιτυγχάνεται μόνο όταν η γονική έκδοση έχει τον σωστό ρόλο IAM.</td></tr><tr><td>PCR4</td><td>Ταυτότητα της γονικής έκδοσης</td><td>Μια συνεχής μέτρηση της ταυτότητας της γονικής έκδοσης. Βεβαιώνει ότι η διαδικασία επαλήθευσης επιτυγχάνεται μόνο όταν η γονική έκδοση έχει μια συγκεκριμένη ταυτότητα έκδοσης.</td></tr><tr><td>PCR8</td><td>Πιστοποιητικό υπογραφής αρχείου εικόνας enclave</td><td>Μια μέτρηση του πιστοποιητικού υπογραφής που καθορίζεται για το αρχείο εικόνας enclave. Βεβαιώνει ότι η διαδικασία επαλήθευσης επιτυγχάνεται μόνο όταν το enclave ξεκίνησε από ένα αρχείο εικόνας enclave που υπογράφτηκε από ένα συγκεκριμένο πιστοποιητικό.</td></tr></tbody></table>

Μπορείτε να ενσωματώσετε την **κρυπτογραφική επαλήθευση** στις εφαρμογές σας και να εκμεταλλευτείτε προεγκατεστημένες ενσωματώσεις με υπηρεσίες όπως το **AWS KMS**. Το AWS KMS μπορεί να **επαληθεύει τις επαληθεύσεις των enclave** και προσφέρει συνθήκες βάσει επαλήθευσης (`kms:RecipientAttestation:ImageSha384` και `kms:RecipientAttestation:PCR`) στις πολιτικές των κλειδιών του. Αυτές οι πολιτικές εξασφαλίζουν ότι το AWS KMS επιτρέπει λειτουργίες χρησιμοποιώντας το KMS key **μόνο εάν το έγγραφο επαλήθευσης του enclave είναι έγκυρο** και πληροί τις **συγκεκριμένες συνθήκες**.

{% hint style="success" %}
Σημειώστε ότι τα Enclaves σε λειτουργία αποσφαλμάτωσης (--debug) δημιουργούν έγγραφα επαλήθευσης με PCRs που αποτελούνται από μηδενικά (`000000000000000000000000000000000000000000000000`). Επομένως, οι πολιτικές του KMS που ελέγχουν αυτές τις τιμές θα αποτύχουν.
{% endhint %}

### Παράκαμψη PCR

Από την οπτική γωνία ενός επιτιθέμενου, παρατηρείτε ότι μερικά PCRs θα επιτρέπουν την τροποποίηση ορισμένων τμημάτων ή όλης της εικόνας του enclave και θα παραμένουν έγκυρα (για παράδειγμα το PCR4 ελέγχει μόνο το ID της γονικής έκδοσης, οπότε η εκτέλεση οποιασδήποτε εικόνας enclave σε αυτό το EC2 θα επιτρέψει την εκπλήρωση αυτής της πιθανής απαίτησης PCR).

Επομένως, ένας επιτιθέμενος που απειλεί την έκδοση EC2 μπορεί να εκτελέσει άλλες εικόνες enclave προκειμένου να παρακάμψει αυτές τις προστασίες.

Η έρευνα για το πώς να τροποποιήσετε/δημιουργήσετε νέες εικόνες για να παρακάμψετε κάθε προστασία (ειδικά τις μη τόσο προφανείς) είναι ακόμα σε εξέλιξη.

## Αναφορές

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Όλα τα μέρη του εγχειριδίου Nitro από το AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
