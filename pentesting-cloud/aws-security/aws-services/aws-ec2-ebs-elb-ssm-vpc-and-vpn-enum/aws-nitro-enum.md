# AWS - Nitro Enum

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

AWS Nitro ni seti ya **teknolojia za ubunifu** ambazo hufanya jukwaa la msingi kwa ajili ya visa vya AWS EC2. Iliyotolewa na Amazon ili **kuimarisha usalama, utendaji, na uaminifu**, Nitro inatumia vipengele vya **vifaa maalum na hypervisor nyepesi**. Inaficha sehemu kubwa ya utendaji wa kawaida wa uvirtualization kwa vifaa na programu maalum, **kupunguza eneo la shambulio** na kuboresha ufanisi wa rasilimali. Kwa kuchukua majukumu ya uvirtualization, Nitro inaruhusu visa vya EC2 kutoa **utendaji karibu sawa na chuma cha msingi**, ikifanya iwe hasa faida kwa maombi yanayohitaji rasilimali nyingi. Aidha, Chip ya Usalama ya Nitro inahakikisha **usalama wa vifaa na firmware**, ikithibitisha muundo wake imara zaidi.

### Mabweni ya Nitro

**AWS Nitro Enclaves** hutoa mazingira salama, **yaliyotengwa ndani ya visa vya Amazon EC2**, yaliyoundwa kwa usindikaji wa data nyeti sana. Kwa kutumia Mfumo wa AWS Nitro, mabweni haya hutoa **utengamano na usalama imara**, yanayofaa kwa **kusimamia habari za siri** kama PII au rekodi za kifedha. Yanajumuisha mazingira ya minimalist, kupunguza hatari kubwa ya kufichua data. Aidha, Mabweni ya Nitro hutoa uthibitisho wa kriptografia, kuruhusu watumiaji kuhakiki kuwa kanuni iliyoruhusiwa pekee ndiyo inayotumika, muhimu kwa kudumisha viwango vya utekelezaji kali na ulinzi wa data.

{% hint style="hatari" %}
Picha za Mabweni ya Nitro zinaendeshwa **kutoka ndani ya visa vya EC2** na huwezi kuona kutoka kwenye konsoli ya wavuti ya AWS ikiwa visa vya EC2 vinakimbia picha katika Mabweni ya Nitro au la.
{% endhint %}

## Usanidi wa CLI wa Mabweni ya Nitro

Fuata maagizo yote [**kutoka kwenye hati ya maelezo**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave). Hata hivyo, haya ndiyo muhimu zaidi:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Picha za Ngome ya Nitro

Picha ambazo unaweza kuendesha kwenye Ngome ya Nitro zinategemea picha za docker, hivyo unaweza kuunda picha zako za Ngome ya Nitro kutoka kwenye picha za docker kama:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Kama unavyoona picha za Nitro Enclave hutumia kifaa cha **`eif`** (Faili ya Picha ya Enclave).

Matokeo yatafanana na:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Tekeleza Picha

Kulingana na [**hati ya maelezo**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave), ili kuendesha picha ya enklei unahitaji kuiwekea kumbukumbu ya **angalau mara 4 ya ukubwa wa faili ya `eif`**. Inawezekana kusanidi rasilimali za msingi za kumpa katika faili hiyo.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Kumbuka daima kwamba unahitaji **kuhifadhi baadhi ya rasilimali kwa ajili ya kifaa cha mzazi cha EC2** pia!
{% endhint %}

Baada ya kujua rasilimali za kutoa kwa picha na hata kubadilisha faili ya usanidi, ni rahisi kuendesha picha ya ngome na:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
### Kagua Enclaves

Ikiwa umefanikiwa kudukua mwenyeji wa EC2 inawezekana kupata orodha ya picha za enclaves zinazoendeshwa kwa:
```bash
nitro-cli describe-enclaves
```
Haiwezekani **kupata ganda** ndani ya picha ya enklevu inayoendeshwa kwa sababu hiyo ndiyo lengo kuu la enklevu, hata hivyo, ikiwa ulitumia parameter **`--debug-mode`**, inawezekana kupata **stdout** yake kwa:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Kukomesha Enclaves

Ikiwa mshambuliaji atahatarisha kifaa cha EC2 kwa chaguo-msingi hataweza kupata kifaa cha kuingilia, lakini ataweza **kukomesha** kifaa hicho kwa:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

Njia pekee ya kuwasiliana na **enclave** inayotumia picha ni kutumia **vsocks**.

**Virtual Socket (vsock)** ni familia ya soketi katika Linux iliyoundwa kwa kusudi maalum la kurahisisha **mawasiliano** kati ya mashine za kawaida (**VMs**) na **hypervisors** yao, au kati ya VMs **wao wenyewe**. Vsock inawezesha **mawasiliano ya pande zote** bila kutegemea safu ya mtandao ya mwenyeji. Hii inawezesha VMs kuwasiliana hata bila mipangilio ya mtandao, **kwa kutumia Kitambulisho cha Muktadha cha biti 32 (CID) na nambari za bandari** kutambua na kusimamia uhusiano. API ya vsock inasaidia aina za soketi za mtiririko na datagramu, kama TCP na UDP, hivyo kuwa chombo cha kipekee kwa matumizi ya programu katika mazingira ya vitengo vya kielelezo.

{% hint style="success" %}
Hivyo, anwani ya vsock inaonekana kama hii: `<CID>:<Port>`
{% endhint %}

Ili kupata **CIDs** za picha zinazoendesha eneo la kujificha unaweza tu kutekeleza cmd ifuatayo na kupata **`EnclaveCID`**:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "mfano wa kituo salama",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "INAKIMBIZA",
"Flags": "HADHI YA KUJARIBU",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
Tambua kwamba kutoka kwa mwenyeji hakuna njia ya kujua ikiwa CID inafunua bandari yoyote! Isipokuwa kwa kutumia baadhi ya **skana ya bandari ya vsock kama** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner).
{% endhint %}

### Mfumo/Msikilizaji wa Vsock

Pata hapa mifano michache:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Mpiga-sauti Rahisi wa Python</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</details>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Mteja wa Vsock

Mifano:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Mteja Rahisi wa Python</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</details>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Chombo cha vsock-proxy kuruhusu kuweka wakala wa vsock na anwani nyingine, kwa mfano:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Hii itapeleka **bandari ya ndani 8001 katika vsock** kwenda `ip-ranges.amazonaws.com:443` na faili **`your-vsock-proxy.yaml`** inaweza kuwa na yaliyomo haya kuruhusu kupata `ip-ranges.amazonaws.com:443`:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
Niwezekana kuona anwani za vsock (**`<CID>:<Port>`**) zinazotumiwa na mwenyeji wa EC2 na (zingatia `3:8001`, 3 ni CID na 8001 ni bandari):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
{% endcode %}

## Ukaguzi wa Nitro Enclave & KMS

SDK ya Nitro Enclaves inaruhusu enklavi kuomba **hati iliyosainiwa kwa njia ya kriptografia** kutoka kwa **Hypervisor** ya Nitro, ambayo inajumuisha **vipimo vya kipekee** vinavyohusiana na enklavi hiyo. Vipimo hivi, ambavyo ni pamoja na **hashes na mamlaka za usanidi wa jukwaa (PCRs)**, hutumiwa wakati wa mchakato wa ukaguzi wa kuthibitisha **utambulisho wa enklavi** na **kujenga imani na huduma za nje**. Hati ya ukaguzi kawaida ina thamani kama PCR0, PCR1, na PCR2, ambazo umekutana nazo hapo awali unapojenga na kuhifadhi hati ya enklavi.

Kutoka kwenye [**nyaraka**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves), hizi ni thamani za PCR:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash ya ...</th><th>Maelezo</th></tr></thead><tbody><tr><td>PCR0</td><td>Picha ya enklavi</td><td>Kipimo cha mfululizo wa yaliyomo kwenye faili ya picha, bila data ya sehemu.</td></tr><tr><td>PCR1</td><td>Kernel ya Linux na bootstrap</td><td>Kipimo cha mfululizo wa kernel na data ya boot ramfs.</td></tr><tr><td>PCR2</td><td>Maombi</td><td>Kipimo cha mfululizo, kwa mpangilio, wa maombi ya mtumiaji, bila boot ramfs.</td></tr><tr><td>PCR3</td><td>Ujuzi wa IAM uliotengwa kwa kifaa cha mzazi</td><td>Kipimo cha mfululizo wa ujuzi wa IAM uliotengwa kwa kifaa cha mzazi. Huhakikisha kuwa mchakato wa ukaguzi unafanikiwa tu wakati kifaa cha mzazi kina ujuzi wa IAM sahihi.</td></tr><tr><td>PCR4</td><td>ID ya kifaa cha mzazi</td><td>Kipimo cha mfululizo wa kitambulisho cha kifaa cha mzazi. Huhakikisha kuwa mchakato wa ukaguzi unafanikiwa tu wakati kifaa cha mzazi kina kitambulisho cha kifaa maalum.</td></tr><tr><td>PCR8</td><td>Hati ya kusaini faili ya picha ya enklavi</td><td>Kipimo cha hati ya kusaini iliyotajwa kwa faili ya picha ya enklavi. Huhakikisha kuwa mchakato wa ukaguzi unafanikiwa tu wakati enklavi ilizinduliwa kutoka kwa faili ya picha ya enklavi iliyosainiwa na hati maalum.</td></tr></tbody></table>

Unaweza kuunganisha **ukaguzi wa kriptografia** kwenye programu zako na kutumia ushirikiano uliojengwa mapema na huduma kama **AWS KMS**. AWS KMS inaweza **kuthibitisha ukaguzi wa enklavi** na inatoa funguo za hali ya ukaguzi-msingi (`kms:RecipientAttestation:ImageSha384` na `kms:RecipientAttestation:PCR`) katika sera zake za funguo. Sera hizi huhakikisha kuwa AWS KMS inaruhusu operesheni zikitumia funguo za KMS **tu ikiwa hati ya ukaguzi wa enklavi ni sahihi** na inakidhi **masharti yaliyowekwa**.

{% hint style="success" %}
Tambua kuwa Enclaves katika hali ya kurekebisha (--debug) huzalisha hati za ukaguzi na PCRs ambazo zinaundwa na sifuri (`000000000000000000000000000000000000000000000000`). Kwa hivyo, sera za KMS zinazochunguza thamani hizi zitashindwa.
{% endhint %}

### Kupuuza PCR

Kutoka mtazamo wa mshambuliaji, kumbuka kuwa baadhi ya PCRs zingeweza kuruhusu kuhariri sehemu fulani au picha nzima ya enklavi na bado iwe sahihi (kwa mfano PCR4 tu huchunguza kitambulisho cha kifaa cha mzazi hivyo kuendesha faili yoyote ya enklavi katika EC2 hiyo kutaruhusu kutimiza mahitaji ya PCR yanayowezekana).

Hivyo, mshambuliaji anayeshambulia kifaa cha EC2 anaweza kuweza kuendesha picha zingine za enklavi ili kupuuza ulinzi huu.

Utafiti juu ya jinsi ya kuhariri/kujenga picha mpya za kupuuza kila ulinzi (hasa zile zisizo dhahiri) bado ni TODO.

## Marejeo

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* Sehemu zote za mafunzo ya Nitro kutoka AWS: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)
