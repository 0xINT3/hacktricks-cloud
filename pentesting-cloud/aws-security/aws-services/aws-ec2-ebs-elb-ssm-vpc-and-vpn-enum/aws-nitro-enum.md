# AWS - Nitro Enum

<details>

<summary><strong>AWS hacklemeyi sıfırdan ileri seviyeye öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong> ile!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na göz atın (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**]'yi (https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**]'i (https://opensea.io/collection/the-peass-family) içeren koleksiyonumuzu
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking püf noktalarınızı paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Temel Bilgiler

AWS Nitro, AWS EC2 örneklerinin temel platformunu oluşturan **yenilikçi teknolojiler** kümesidir. Amazon tarafından tanıtılan Nitro, özel **donanım bileşenleri ve hafif bir hipervizör** kullanan, güvenliği, performansı ve güvenilirliği artırmayı amaçlayan bir platformdur. Geleneksel sanallaştırma işlevlerinin büyük bir kısmını ayrılmış donanım ve yazılıma soyutlar, **saldırı yüzeyini en aza indirger** ve kaynak verimliliğini artırır. Sanallaştırma işlevlerini dışa aktararak, Nitro, EC2 örneklerinin **neredeyse bare-metal performansı sunmasına** olanak tanır, bu da kaynak yoğun uygulamalar için özellikle faydalıdır. Ayrıca, Nitro Güvenlik Çipi özellikle **donanım ve firmware güvenliğini** sağlar, sağlam mimarisini daha da pekiştirir.

### Nitro Enklavlar

**AWS Nitro Enklavları**, Amazon EC2 örnekleri içinde **izole bir hesaplama ortamı** sağlar ve özellikle son derece hassas verilerin işlenmesi için tasarlanmıştır. AWS Nitro Sistemi'nden yararlanan bu enklavlar, sağlam **izolasyon ve güvenlik** sağlar, PII veya finansal kayıtlar gibi **gizli bilgilerin işlenmesi** için idealdir. Minimalist bir ortam sunarlar, veri maruziyetinin riskini önemli ölçüde azaltır. Ayrıca, Nitro Enklavlar, yalnızca yetkili kodların çalıştırıldığını doğrulamaya olanak tanıyan kriptografik belgeleme desteği sağlar, bu da sıkı uyumluluk ve veri koruma standartlarının korunması için hayati önem taşır.

{% hint style="danger" %}
Nitro Enklav görüntüleri **EC2 örneklerinin içinden çalıştırılır** ve bir EC2 örneğinin Nitro Enklav'da görüntüler çalıştırıp çalıştırmadığını AWS web konsolundan göremezsiniz.
{% endhint %}

## Nitro Enklav CLI kurulumu

Tüm talimatları [**belgelerden**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) takip edin. Bunlar ise en önemlileridir:
```bash
# Install tools
sudo amazon-linux-extras install aws-nitro-enclaves-cli -y
sudo yum install aws-nitro-enclaves-cli-devel -y

# Config perms
sudo usermod -aG ne $USER
sudo usermod -aG docker $USER

# Check installation
nitro-cli --version

# Start and enable the Nitro Enclaves allocator service.
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service
```
## Nitro Enclave Görüntüleri

Nitro Enclave'de çalıştırabileceğiniz görüntüler, docker görüntülerine dayanmaktadır, bu nedenle Nitro Enclave görüntülerinizi şu şekilde docker görüntülerinden oluşturabilirsiniz:
```bash
# You need to have the docker image accesible in your running local registry
# Or indicate the full docker image URL to access the image
nitro-cli build-enclave --docker-uri <docker-img>:<tag> --output-file nitro-img.eif
```
Nitro Enclave görüntülerinin uzantısı **`eif`** (Enclave Image File) olarak kullanılır.

Çıktı aşağıdaki gibi görünecektir:
```
Using the locally available Docker image...
Enclave Image successfully created.
{
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
```
### Bir Görüntüyü Çalıştır

[**Belgelendirmeye**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli#run-connect-and-terminate-the-enclave) göre, bir kalesi görüntüsünü çalıştırmak için ona **`eif` dosyasının en az 4 katı büyüklüğünde bellek atamalısınız**. Ona verilecek varsayılan kaynakları yapılandırmak mümkündür dosyada.
```shell
/etc/nitro_enclaves/allocator.yaml
```
{% hint style="danger" %}
Her zaman **ana EC2 örneği için bazı kaynakları ayırmanız gerektiğini** unutmayın!
{% endhint %}

Bir görüntüye verilecek kaynakları bildikten sonra ve hatta yapılandırma dosyasını değiştirdikten sonra, bir kapan alanı görüntüsünü şu şekilde çalıştırmak mümkündür:

{% code overflow="wrap" %}
```shell
# Restart the service so the new default values apply
sudo systemctl start nitro-enclaves-allocator.service && sudo systemctl enable nitro-enclaves-allocator.service

# Indicate the CPUs and memory to give
nitro-cli run-enclave --cpu-count 2 --memory 3072 --eif-path hello.eif --debug-mode --enclave-cid 16
```
{% endcode %}

### Enklavları Sırala

Bir EC2 ana bilgisayarını ele geçirdiyseniz çalışan enklav görüntülerinin bir listesini almak mümkündür:
```bash
nitro-cli describe-enclaves
```
Bu, çalışan bir kalesine görüntüsü içinde bir kabuk almanın mümkün olmadığı **çünkü bu kalelerin ana amacıdır**, ancak **`--debug-mode`** parametresini kullandıysanız, bununla ilgili **stdout**'u almak mümkündür:
```shell
ENCLAVE_ID=$(nitro-cli describe-enclaves | jq -r ".[0].EnclaveID")
nitro-cli console --enclave-id ${ENCLAVE_ID}
```
### Enklavaları Sonlandır

Bir saldırgan bir EC2 örneğini ele geçirse bile varsayılan olarak içlerine kabuk alamayacak, ancak onları şu şekilde **sonlandırabilecektir**:
```shell
nitro-cli terminate-enclave --enclave-id ${ENCLAVE_ID}
```
## Vsock

**Koruma alanı** çalışan görüntüyle iletişim kurmanın tek yolu **vsocks** kullanmaktır.

**Sanal Soket (vsock)**, Linux'ta özellikle sanal makineler (**VM'ler**) ile **hipervizörleri** veya VM'ler arasındaki **iletişimi** kolaylaştırmak için tasarlanmış bir soket ailesidir. Vsock, ana bilgisayarın ağ yığınına güvenmeden verimli, **iki yönlü iletişimi** sağlar. Bu, VM'lerin ağ yapılandırmaları olmadan bile iletişim kurmasını sağlar, **32 bitlik Bağlam Kimliği (CID) ve bağlantıları tanımlamak ve yönetmek için port numaralarını** kullanır. Vsock API, sanal ortamlardaki kullanıcı düzeyi uygulamalar için çok yönlü bir araç sağlayarak TCP ve UDP'ye benzer şekilde hem akış hem de veri gram soket türlerini destekler.

{% hint style="success" %}
Bu nedenle, bir vsock adresi şu şekilde görünür: `<CID>:<Port>`
{% endhint %}

**Koruma alanı** çalışan görüntülerin **CID'lerini** bulmak için aşağıdaki komutu çalıştırabilir ve **`EnclaveCID`**'yi alabilirsiniz:

<pre class="language-bash"><code class="lang-bash">nitro-cli describe-enclaves

[
{
"EnclaveName": "secure-channel-example",
"EnclaveID": "i-0bc274f83ade02a62-enc18ef3d09c886748",
"ProcessID": 10131,
<strong>    "EnclaveCID": 16,
</strong>    "NumberOfCPUs": 2,
"CPUIDs": [
1,
3
],
"MemoryMiB": 1024,
"State": "RUNNING",
"Flags": "DEBUG_MODE",
"Measurements": {
"HashAlgorithm": "Sha384 { ... }",
"PCR0": "e199261541a944a93129a52a8909d29435dd89e31299b59c371158fc9ab3017d9c450b0a580a487e330b4ac691943284",
"PCR1": "bcdf05fefccaa8e55bf2c8d6dee9e79bbff31e34bf28a99aa19e6b29c37ee80b214a414b7607236edf26fcb78654e63f",
"PCR2": "2e1fca1dbb84622ec141557dfa971b4f8ea2127031b264136a20278c43d1bba6c75fea286cd4de9f00450b6a8db0e6d3"
}
}
]
</code></pre>

{% hint style="warning" %}
**Not:** Ana bilgisayardan bir CID'in herhangi bir portu açıklayıp açıklamadığını bilmek için herhangi bir yol yoktur! **Vsock tarama aracı gibi** [**https://github.com/carlospolop/Vsock-scanner**](https://github.com/carlospolop/Vsock-scanner) kullanılmadıkça.
{% endhint %}

### Vsock Sunucusu/Dinleyici

İşte birkaç örnek:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/server.py)

<details>

<summary>Basit Python Dinleyici</summary>
```python
#!/usr/bin/env python3

# From
https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.bind((CID, PORT))
s.listen()
(conn, (remote_cid, remote_port)) = s.accept()

print(f"Connection opened by cid={remote_cid} port={remote_port}")

while True:
buf = conn.recv(64)
if not buf:
break

print(f"Received bytes: {buf}")
```
</detaylar>
```bash
# Using socat
socat VSOCK-LISTEN:<port>,fork EXEC:"echo Hello from server!"
```
### Vsock İstemcisi

Örnekler:

* [https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py](https://github.com/aws-samples/aws-nitro-enclaves-workshop/blob/main/resources/code/my-first-enclave/secure-local-channel/client.py)

<details>

<summary>Basit Python İstemcisi</summary>
```python
#!/usr/bin/env python3

#From https://medium.com/@F.DL/understanding-vsock-684016cf0eb0

import socket

CID = socket.VMADDR_CID_HOST
PORT = 9999

s = socket.socket(socket.AF_VSOCK, socket.SOCK_STREAM)
s.connect((CID, PORT))
s.sendall(b"Hello, world!")
s.close()
```
</detaylar>
```bash
# Using socat
echo "Hello, vsock!" | socat - VSOCK-CONNECT:3:5000
```
### Vsock Proxy

Vsock-proxy aracı, başka bir adresle vsock proxy'sini proxy yapmayı sağlar, örneğin:
```bash
vsock-proxy 8001 ip-ranges.amazonaws.com 443 --config your-vsock-proxy.yaml
```
Bu, **vsock'taki yerel port 8001'i** `ip-ranges.amazonaws.com:443`'e yönlendirecektir ve **`your-vsock-proxy.yaml`** dosyasının şu içeriğe sahip olabileceğini gösterir, böylece `ip-ranges.amazonaws.com:443`'e erişim sağlanabilir:
```yaml
allowlist:
- {address: ip-ranges.amazonaws.com, port: 443}
```
EC2 ana bilgisayarı tarafından kullanılan vsock adreslerini (**`<CID>:<Port>`**) görmek mümkündür (not: `3:8001`, 3 CID'yi ve 8001 portu temsil eder):

{% code overflow="wrap" %}
```bash
sudo ss -l -p -n | grep v_str
v_str LISTEN 0      0                                                                              3:8001                   *:*     users:(("vsock-proxy",pid=9458,fd=3))
```
## Nitro Enclave Attestasyonu ve KMS

Nitro Enclaves SDK, bir enclave'in Nitro **Hypervisor**'dan **kriptografik olarak imzalanmış bir belge talep etmesine** olanak tanır. Bu belge, o enclave'e özgü **benzersiz ölçümleri** içeren **hash'ler ve platform yapılandırma kayıtlarını (PCRs)** içerir. Bu ölçümler, enclave'in kimliğini **kanıtlamak** ve **harici hizmetlerle güven inşa etmek** için kullanılır. Attestasyon belgesi genellikle PCR0, PCR1 ve PCR2 gibi değerler içerir, daha önce bir enclave EIF oluştururken ve kaydederken karşılaştığınız değerler.

[**Belgelerden**](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-3-cryptographic-attestation#a-unique-feature-on-nitro-enclaves) şu PCR değerleri bulunmaktadır:

<table><thead><tr><th width="97">PCR</th><th width="221">Hash'ı ...</th><th>Açıklama</th></tr></thead><tbody><tr><td>PCR0</td><td>Enclave imaj dosyası</td><td>Bölüm verileri olmadan imaj dosyasının içeriğinin sürekli bir ölçüsü.</td></tr><tr><td>PCR1</td><td>Linux çekirdeği ve başlangıç</td><td>Çekirdek ve başlangıç ramfs verilerinin sürekli bir ölçüsü.</td></tr><tr><td>PCR2</td><td>Uygulama</td><td>Kullanıcı uygulamalarının başlangıç ramfs olmadan sürekli ve sıralı bir ölçüsü.</td></tr><tr><td>PCR3</td><td>Üst öğe örneğine atanan IAM rolü</td><td>Üst öğe örneğine atanan IAM rolünün sürekli bir ölçüsü. Attestasyon sürecinin yalnızca üst öğe örneğinin doğru IAM rolüne sahip olduğunda başarılı olmasını sağlar.</td></tr><tr><td>PCR4</td><td>Üst öğe örneğinin kimliği</td><td>Üst öğe örneğinin kimliğinin sürekli bir ölçüsü. Attestasyon sürecinin yalnızca belirli bir örnek kimliğine sahip üst öğe örneğinde başarılı olmasını sağlar.</td></tr><tr><td>PCR8</td><td>Enclave imaj dosyası imzalama sertifikası</td><td>Enclave imaj dosyası için belirtilen imzalama sertifikasının bir ölçüsü. Attestasyon sürecinin yalnızca belirli bir sertifika ile imzalanan bir enclave imaj dosyasından başlatıldığında başarılı olmasını sağlar.</td></tr></tbody></table>

Uygulamalarınıza **kriptografik attestasyonu** entegre edebilir ve **AWS KMS** gibi hizmetlerle önceden oluşturulmuş entegrasyonlardan faydalanabilirsiniz. AWS KMS, **enclave attestasyonlarını doğrulayabilir** ve ana politikalarında attestasyon tabanlı koşul anahtarları (`kms:RecipientAttestation:ImageSha384` ve `kms:RecipientAttestation:PCR`) sunar. Bu politikalar, AWS KMS'nin, KMS anahtarını kullanarak işlemlere izin vermesini yalnızca **enclave'in attestasyon belgesinin geçerli** ve **belirtilen koşulları karşılayan durumlarda** sağlar.

{% hint style="success" %}
Not olarak, Debug (--debug) modundaki Enclaveler, sıfırlardan oluşan PCR'larla (`000000000000000000000000000000000000000000000000`) attestasyon belgeleri oluşturur. Bu nedenle, bu değerleri kontrol eden KMS politikaları başarısız olacaktır.
{% endhint %}

### PCR Atlatma

Saldırganın bakış açısından, bazı PCR'ların bazı bölümleri veya tüm enclave imajını değiştirmesine izin vereceğini fark edin (örneğin PCR4, yalnızca üst öğe örneğinin kimliğini kontrol eder, bu nedenle bu potansiyel PCR gereksinimini karşılamak için o EC2'de herhangi bir enclave imajını çalıştırmak mümkün olacaktır).

Bu nedenle, EC2 örneğini ele geçiren bir saldırgan, bu korumaları atlamak için başka enclave imajlarını çalıştırabilir.

Her korumayı atlamak için yeni imajlar oluşturmayı/değiştirmeyi araştırmak (özellikle açık olmayanları) hala YAPILACAKLAR listesindedir.

## Referanslar

* [https://medium.com/@F.DL/understanding-vsock-684016cf0eb0](https://medium.com/@F.DL/understanding-vsock-684016cf0eb0)
* AWS'den Nitro öğreticisinin tüm bölümleri: [https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli](https://catalog.us-east-1.prod.workshops.aws/event/dashboard/en-US/workshop/1-my-first-enclave/1-1-nitro-enclaves-cli)
