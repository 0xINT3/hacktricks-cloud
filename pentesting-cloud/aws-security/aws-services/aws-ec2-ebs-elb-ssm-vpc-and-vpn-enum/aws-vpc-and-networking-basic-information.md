# Informations de base sur AWS - VPC et R√©seau

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## R√©seau AWS en un coup d'≈ìil

Un **VPC** contient un **CIDR r√©seau** comme 10.0.0.0/16 (avec sa **table de routage** et son **ACL r√©seau**).

Ce r√©seau VPC est divis√© en **sous-r√©seaux**, donc un **sous-r√©seau** est directement **li√©** au **VPC**, √† la **table de routage** et √† l'**ACL r√©seau**.

Ensuite, les **Interfaces r√©seau** attach√©es aux services (comme les instances EC2) sont **connect√©es** aux **sous-r√©seaux** avec des **groupes de s√©curit√©**.

Par cons√©quent, un **groupe de s√©curit√©** limitera les ports expos√©s des **interfaces r√©seau l'utilisant**, **ind√©pendamment du sous-r√©seau**. Et une **ACL r√©seau** limitera les ports expos√©s √† **tout le r√©seau**.

De plus, pour **acc√©der √† Internet**, il y a quelques configurations int√©ressantes √† v√©rifier :

* Un **sous-r√©seau** peut **attribuer automatiquement des adresses IPv4 publiques**
* Une **instance** cr√©√©e dans le r√©seau qui **attribue automatiquement des adresses IPv4 peut en obtenir une**
* Une **passerelle Internet** doit √™tre **attach√©e** au **VPC**
* Vous pourriez √©galement utiliser des **passerelles Internet √† sens unique**
* Vous pourriez √©galement avoir une **passerelle NAT** dans un **sous-r√©seau priv√©** pour pouvoir **se connecter √† des services externes** √† partir de ce sous-r√©seau priv√©, mais il est **impossible de les atteindre depuis l'ext√©rieur**.
* La passerelle NAT peut √™tre **publique** (acc√®s √† Internet) ou **priv√©e** (acc√®s √† d'autres VPC)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) vous permet de **lancer des ressources AWS dans un r√©seau virtuel** que vous avez d√©fini. Ce r√©seau virtuel aura plusieurs sous-r√©seaux, des passerelles Internet pour acc√©der √† Internet, des ACL, des groupes de s√©curit√©, des adresses IP...

### Sous-r√©seaux

Les sous-r√©seaux aident √† renforcer un plus haut niveau de s√©curit√©. Le **regroupement logique de ressources similaires** vous aide √©galement √† maintenir une **facilit√© de gestion** sur l'ensemble de votre infrastructure.

* Les CIDR valides vont d'un masque de sous-r√©seau /16 √† un masque de sous-r√©seau /28.
* Un sous-r√©seau ne peut pas √™tre dans diff√©rentes zones de disponibilit√© en m√™me temps.
* **AWS r√©serve les trois premi√®res adresses IP h√¥tes** de chaque sous-r√©seau **pour une utilisation interne AWS** : la premi√®re adresse IP h√¥te utilis√©e est pour le routeur VPC. La deuxi√®me adresse est r√©serv√©e pour le DNS AWS et la troisi√®me adresse est r√©serv√©e pour une utilisation future.
* On appelle **sous-r√©seaux publics** ceux qui ont un **acc√®s direct √† Internet, tandis que les sous-r√©seaux priv√©s n'en ont pas.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tables de routage

Les tables de routage d√©terminent le routage du trafic pour un sous-r√©seau dans un VPC. Elles d√©terminent quel trafic r√©seau est envoy√© vers Internet ou vers une connexion VPN. Vous trouverez g√©n√©ralement l'acc√®s √† :

* VPC local
* NAT
* Passerelles Internet / Passerelles Internet √† sens unique (n√©cessaires pour donner √† un VPC l'acc√®s √† Internet).
* Pour rendre un sous-r√©seau public, vous devez **cr√©er** et **attacher** une **passerelle Internet** √† votre VPC.
* Points de terminaison VPC (pour acc√©der √† S3 depuis des r√©seaux priv√©s)

Dans les images suivantes, vous pouvez v√©rifier les diff√©rences entre un r√©seau public par d√©faut et un r√©seau priv√© :

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL

**Listes de contr√¥le d'acc√®s r√©seau (ACL)** : Les ACL r√©seau sont des r√®gles de pare-feu qui contr√¥lent le trafic r√©seau entrant et sortant d'un sous-r√©seau. Elles peuvent √™tre utilis√©es pour autoriser ou refuser le trafic vers des adresses IP ou plages sp√©cifiques.

* Il est plus fr√©quent d'autoriser/refuser l'acc√®s en utilisant des groupes de s√©curit√©, mais c'est la seule fa√ßon de couper compl√®tement les shells invers√©s √©tablis. Une r√®gle modifi√©e dans un groupe de s√©curit√© ne stoppe pas les connexions d√©j√† √©tablies.
* Cependant, cela s'applique √† l'ensemble du sous-r√©seau, soyez prudent lorsque vous interdisez des choses car des fonctionnalit√©s n√©cessaires pourraient √™tre perturb√©es.
### Groupes de s√©curit√©

Les groupes de s√©curit√© sont un **pare-feu virtuel** qui contr√¥le le **trafic r√©seau entrant et sortant des instances** dans un VPC. Relation 1 SG √† M instances (g√©n√©ralement 1 √† 1).\
Cela est g√©n√©ralement utilis√© pour ouvrir des ports dangereux dans les instances, tels que le port 22 par exemple:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Adresses IP Elastiques

Une _adresse IP √©lastique_ est une **adresse IPv4 statique** con√ßue pour le cloud computing dynamique. Une adresse IP √©lastique est allou√©e √† votre compte AWS et vous appartient jusqu'√† ce que vous la lib√©riez. En utilisant une adresse IP √©lastique, vous pouvez masquer la d√©faillance d'une instance ou d'un logiciel en remappant rapidement l'adresse vers une autre instance de votre compte.

### Connexion entre sous-r√©seaux

Par d√©faut, tous les sous-r√©seaux ont **l'attribution automatique d'adresses IP publiques d√©sactiv√©e** mais elle peut √™tre activ√©e.

**Une route locale dans une table de routage permet la communication entre les sous-r√©seaux du VPC.**

Si vous **connectez un sous-r√©seau √† un autre sous-r√©seau, vous ne pouvez pas acc√©der aux sous-r√©seaux connect√©s** √† l'autre sous-r√©seau, vous devez cr√©er une connexion directe avec eux. **Cela s'applique √©galement aux passerelles Internet**. Vous ne pouvez pas passer par une connexion de sous-r√©seau pour acc√©der √† Internet, vous devez attribuer la passerelle Internet √† votre sous-r√©seau.

### Interconnexion de VPC

L'interconnexion de VPC vous permet de **connecter deux ou plusieurs VPC ensemble**, en utilisant IPV4 ou IPV6, comme s'ils faisaient partie du m√™me r√©seau.

Une fois que la connectivit√© entre les pairs est √©tablie, **les ressources dans un VPC peuvent acc√©der aux ressources dans l'autre**. La connectivit√© entre les VPC est mise en ≈ìuvre √† travers l'infrastructure r√©seau AWS existante, et elle est donc hautement disponible sans goulot d'√©tranglement de bande passante. Comme **les connexions entre pairs fonctionnent comme s'ils faisaient partie du m√™me r√©seau**, il y a des restrictions en ce qui concerne les plages de blocs CIDR qui peuvent √™tre utilis√©es.\
Si vous avez des plages CIDR **qui se chevauchent ou sont en double** pour vos VPC, alors **vous ne pourrez pas interconnecter les VPC** ensemble.\
Chaque VPC AWS **ne communiquera qu'avec son pair**. Par exemple, si vous avez une connexion de pairage entre VPC 1 et VPC 2, et une autre connexion entre VPC 2 et VPC 3 comme indiqu√©, alors VPC 1 et 2 pourraient communiquer directement, tout comme VPC 2 et VPC 3, cependant, VPC 1 et VPC 3 ne pourraient pas. **Vous ne pouvez pas router √† travers un VPC pour acc√©der √† un autre.**

### **Journaux de flux VPC**

Au sein de votre VPC, vous pourriez potentiellement avoir des centaines, voire des milliers de ressources communiquant entre diff√©rents sous-r√©seaux publics et priv√©s et √©galement entre diff√©rents VPC via des connexions de pairage de VPC. **Les journaux de flux VPC vous permettent de capturer les informations sur le trafic IP qui circule entre les interfaces r√©seau de vos ressources au sein de votre VPC**.

Contrairement aux journaux d'acc√®s S3 et aux journaux d'acc√®s CloudFront, les **donn√©es de journal g√©n√©r√©es par les journaux de flux VPC ne sont pas stock√©es dans S3. Au lieu de cela, les donn√©es de journal captur√©es sont envoy√©es aux journaux CloudWatch**.

Limitations :

* Si vous utilisez une connexion de pairage de VPC, vous ne pourrez voir que les journaux de flux des VPC appair√©s qui se trouvent dans le m√™me compte.
* Si vous ex√©cutez toujours des ressources dans l'environnement EC2-Classic, vous ne pourrez malheureusement pas r√©cup√©rer d'informations √† partir de leurs interfaces.
* Une fois qu'un journal de flux VPC a √©t√© cr√©√©, il ne peut pas √™tre modifi√©. Pour modifier la configuration du journal de flux VPC, vous devez le supprimer et ensuite en recr√©er un nouveau.
* Le trafic suivant n'est pas surveill√© et captur√© par les journaux. Le trafic DHCP √† l'int√©rieur du VPC, le trafic des instances destin√© au serveur DNS Amazon.
* Tout trafic destin√© √† l'adresse IP du routeur par d√©faut du VPC et le trafic vers et depuis les adresses suivantes, 169.254.169.254 qui est utilis√© pour collecter les m√©tadonn√©es de l'instance, et 169.254.169.123 qui est utilis√© pour le service de synchronisation de l'heure Amazon.
* Trafic relatif √† une licence d'activation Windows Amazon √† partir d'une instance Windows
* Trafic entre une interface de r√©partiteur de charge r√©seau et une interface de r√©seau de point de terminaison

Pour chaque interface r√©seau qui publie des donn√©es dans le groupe de journaux CloudWatch, une autre flux de journal est utilis√©. Et dans chacun de ces flux, il y aura les donn√©es d'√©v√©nements de journal de flux qui montrent le contenu des entr√©es de journal. Chacun de ces **journaux capture des donn√©es pendant une fen√™tre d'environ 10 √† 15 minutes**.

## VPN

### Composants de base du VPN AWS

1. **Passerelle client** :
* Une passerelle client est une ressource que vous cr√©ez dans AWS pour repr√©senter votre c√¥t√© d'une connexion VPN.
* C'est essentiellement un appareil physique ou une application logicielle de votre c√¥t√© de la connexion VPN de site √† site.
* Vous fournissez des informations de routage et l'adresse IP publique de votre appareil r√©seau (tel qu'un routeur ou un pare-feu) √† AWS pour cr√©er une passerelle client.
* Elle sert de point de r√©f√©rence pour la configuration de la connexion VPN et n'entra√Æne pas de frais suppl√©mentaires.
2. **Passerelle priv√©e virtuelle** :
* Une passerelle priv√©e virtuelle (VPG) est le concentrateur VPN du c√¥t√© Amazon de la connexion VPN de site √† site.
* Elle est attach√©e √† votre VPC et sert de cible pour votre connexion VPN.
* La VPG est le point de terminaison c√¥t√© AWS pour la connexion VPN.
* Elle g√®re la communication s√©curis√©e entre votre VPC et votre r√©seau sur site.
3. **Connexion VPN de site √† site** :
* Une connexion VPN de site √† site connecte votre r√©seau sur site √† un VPC via un tunnel VPN IPsec s√©curis√©.
* Ce type de connexion n√©cessite une passerelle client et une passerelle priv√©e virtuelle.
* Elle est utilis√©e pour une communication s√©curis√©e, stable et coh√©rente entre votre centre de donn√©es ou r√©seau et votre environnement AWS.
* G√©n√©ralement utilis√©e pour des connexions r√©guli√®res et √† long terme, elle est factur√©e en fonction de la quantit√© de donn√©es transf√©r√©es sur la connexion.
4. **Point de terminaison VPN client** :
* Un point de terminaison VPN client est une ressource que vous cr√©ez dans AWS pour permettre et g√©rer des sessions VPN client.
* Il est utilis√© pour permettre √† des appareils individuels (comme des ordinateurs portables, des smartphones, etc.) de se connecter de mani√®re s√©curis√©e aux ressources AWS ou √† votre r√©seau sur site.
* Contrairement au VPN de site √† site, il est con√ßu pour des clients individuels plut√¥t que pour connecter des r√©seaux entiers.
* Avec le VPN client, chaque appareil client utilise un logiciel client VPN pour √©tablir une connexion s√©curis√©e.

### VPN de site √† site

**Connectez votre r√©seau sur site √† votre VPC.**

* **Connexion VPN** : Une connexion s√©curis√©e entre votre √©quipement sur site et vos VPC.
*   **Tunnel VPN** : Un lien chiffr√© par lequel les donn√©es peuvent passer du r√©seau client vers ou depuis AWS.

Chaque connexion VPN comprend deux tunnels VPN que vous pouvez utiliser simultan√©ment pour une haute disponibilit√©.
* **Passerelle client** : Une ressource AWS qui fournit des informations √† AWS sur votre appareil de passerelle client.
* **Appareil de passerelle client** : Un appareil physique ou une application logicielle de votre c√¥t√© de la connexion VPN de site √† site.
* **Passerelle priv√©e virtuelle** : Le concentrateur VPN du c√¥t√© Amazon de la connexion VPN de site √† site. Vous utilisez une passerelle priv√©e virtuelle ou un transit gateway comme passerelle pour le c√¥t√© Amazon de la connexion VPN de site √† site.
* **Transit Gateway** : Un concentrateur de transit qui peut √™tre utilis√© pour interconnecter vos VPC et r√©seaux sur site. Vous utilisez un transit gateway ou une passerelle priv√©e virtuelle comme passerelle pour le c√¥t√© Amazon de la connexion VPN de site √† site.
#### Limitations

* Le trafic IPv6 n'est pas pris en charge pour les connexions VPN sur une passerelle priv√©e virtuelle.
* Une connexion VPN AWS ne prend pas en charge la d√©couverte du MTU du chemin.

De plus, prenez en consid√©ration les √©l√©ments suivants lorsque vous utilisez un VPN de site √† site.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Connectez-vous de votre machine √† votre VPC**

#### Concepts

* **Point de terminaison Client VPN :** La ressource que vous cr√©ez et configurez pour activer et g√©rer les sessions VPN client. C'est la ressource o√π toutes les sessions VPN client sont termin√©es.
* **R√©seau cible :** Un r√©seau cible est le r√©seau que vous associez √† un point de terminaison Client VPN. **Un sous-r√©seau d'un VPC est un r√©seau cible**. L'association d'un sous-r√©seau √† un point de terminaison Client VPN vous permet d'√©tablir des sessions VPN. Vous pouvez associer plusieurs sous-r√©seaux √† un point de terminaison Client VPN pour une haute disponibilit√©. Tous les sous-r√©seaux doivent √™tre du m√™me VPC. Chaque sous-r√©seau doit appartenir √† une zone de disponibilit√© diff√©rente.
* **Route :** Chaque point de terminaison Client VPN a une table de routage qui d√©crit les routes de r√©seau de destination disponibles. Chaque route dans la table de routage sp√©cifie le chemin pour le trafic vers des ressources ou des r√©seaux sp√©cifiques.
* **R√®gles d'autorisation :** Une r√®gle d'autorisation **restreint les utilisateurs qui peuvent acc√©der √† un r√©seau**. Pour un r√©seau sp√©cifi√©, vous configurez le groupe Active Directory ou le fournisseur d'identit√© (IdP) autoris√© √† acc√©der. Seuls les utilisateurs appartenant √† ce groupe peuvent acc√©der au r√©seau sp√©cifi√©. **Par d√©faut, il n'y a pas de r√®gles d'autorisation** et vous devez configurer des r√®gles d'autorisation pour permettre aux utilisateurs d'acc√©der aux ressources et r√©seaux.
* **Client :** L'utilisateur final se connectant au point de terminaison Client VPN pour √©tablir une session VPN. Les utilisateurs finaux doivent t√©l√©charger un client OpenVPN et utiliser le fichier de configuration du Client VPN que vous avez cr√©√© pour √©tablir une session VPN.
* **Plage CIDR client :** Une plage d'adresses IP √† partir de laquelle attribuer des adresses IP client. Chaque connexion au point de terminaison Client VPN se voit attribuer une adresse IP unique de la plage CIDR client. Vous choisissez la plage CIDR client, par exemple, `10.2.0.0/16`.
* **Ports Client VPN :** AWS Client VPN prend en charge les ports 443 et 1194 pour TCP et UDP. Par d√©faut, le port est 443.
* **Interfaces r√©seau Client VPN :** Lorsque vous associez un sous-r√©seau √† votre point de terminaison Client VPN, nous cr√©ons des interfaces r√©seau Client VPN dans ce sous-r√©seau. **Le trafic envoy√© au VPC √† partir du point de terminaison Client VPN est envoy√© via une interface r√©seau Client VPN**. La translation d'adresse r√©seau source (SNAT) est ensuite appliqu√©e, o√π l'adresse IP source de la plage CIDR client est traduite en l'adresse IP de l'interface r√©seau Client VPN.
* **Journalisation des connexions :** Vous pouvez activer la journalisation des connexions pour votre point de terminaison Client VPN afin de journaliser les √©v√©nements de connexion. Vous pouvez utiliser ces informations pour effectuer des analyses forensiques, analyser comment votre point de terminaison Client VPN est utilis√© ou r√©soudre des probl√®mes de connexion.
* **Portail en libre-service :** Vous pouvez activer un portail en libre-service pour votre point de terminaison Client VPN. Les clients peuvent se connecter au portail web √† l'aide de leurs identifiants et t√©l√©charger la derni√®re version du fichier de configuration du point de terminaison Client VPN, ou la derni√®re version du client fourni par AWS.

#### Limitations

* Les plages CIDR client ne peuvent pas se chevaucher avec le CIDR local du VPC dans lequel se trouve le sous-r√©seau associ√©, ou avec des routes ajout√©es manuellement √† la table de routage du point de terminaison Client VPN.
* Les plages CIDR client doivent avoir une taille de bloc d'au moins /22 et ne doivent **pas √™tre sup√©rieures √† /12**.
* **Une partie des adresses** de la plage CIDR client est utilis√©e pour **prendre en charge le mod√®le de disponibilit√©** du point de terminaison Client VPN, et ne peut pas √™tre attribu√©e aux clients. Par cons√©quent, nous vous recommandons de **attribuer un bloc CIDR contenant le double du nombre d'adresses IP n√©cessaires** pour permettre le nombre maximal de connexions simultan√©es que vous pr√©voyez de prendre en charge sur le point de terminaison Client VPN.
* La **plage CIDR client ne peut pas √™tre modifi√©e** apr√®s la cr√©ation du point de terminaison Client VPN.
* Les **sous-r√©seaux** associ√©s √† un point de terminaison Client VPN **doivent √™tre dans le m√™me VPC**.
* Vous **ne pouvez pas associer plusieurs sous-r√©seaux de la m√™me zone de disponibilit√© √† un point de terminaison Client VPN**.
* Un point de terminaison Client VPN **ne prend pas en charge les associations de sous-r√©seaux dans un VPC en d√©dicace**.
* Le Client VPN prend en charge le trafic **IPv4** uniquement.
* Le Client VPN n'est **pas conforme** aux **normes FIPS** (Federal Information Processing Standards).
*   Si l'authentification multi-facteurs (MFA) est d√©sactiv√©e pour votre Active Directory, un mot de passe utilisateur ne peut pas √™tre dans le format suivant.

```
SCRV1:<cha√Æne_encod√©e_en_base64>:<cha√Æne_encod√©e_en_base64>
```
* Le portail en libre-service n'est **pas disponible pour les clients qui s'authentifient en utilisant l'authentification mutuelle**.
