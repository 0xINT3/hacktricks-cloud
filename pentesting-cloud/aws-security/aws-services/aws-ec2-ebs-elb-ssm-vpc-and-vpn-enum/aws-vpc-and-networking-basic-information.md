# AWS - VPC & Netwerk Basiese Inligting

<details>

<summary><strong>Leer AWS hakwerk vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou haktruuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## AWS Netwerke in 'n Neutedop

'n **VPC** bevat 'n **netwerk CIDR** soos 10.0.0.0/16 (met sy **roetetabel** en **netwerk ACL**).

Hierdie VPC-netwerk is verdeel in **subnetwerke**, dus is 'n **subnetwerk** direk **verwant** aan die **VPC**, **roetetabel** en **netwerk ACL**.

Dan is **Netwerkinterfaces** wat aan dienste geheg is (soos EC2-instanies) **verbind** met die **subnetwerke** met **sekuriteitsgroepe**.

Daarom sal 'n **sekuriteitsgroep** die blootgestelde poorte van die netwerk **interfaces wat dit gebruik**, **beperk, onafhanklik van die subnetwerk**. En 'n **netwerk ACL** sal die blootgestelde poorte **beperk** tot die **hele netwerk**.

Verder, om **toegang tot die internet te verkry**, is daar 'n paar interessante konfigurasies om te kontroleer:

* 'n **Subnetwerk** kan **outomaties openbare IPv4-adresse toewys**
* 'n **instansie** wat in die netwerk geskep is wat **IPv4-adresse outomaties toewys, kan een kry**
* 'n **Internetkoppelvlak** moet aan die **VPC** **geheg** word
* Jy kan ook **Uitgaande-internetkoppelvlakke** gebruik
* Jy kan ook 'n **NAT-koppelvlak** h√™ in 'n **privaat subnet** sodat dit moontlik is om vanaf daardie privaat subnet **na eksterne dienste te koppel**, maar dit is **nie moontlik om hulle van buiteaf te bereik** nie.
* Die NAT-koppelvlak kan **openbaar** (toegang tot die internet) of **privaat** (toegang tot ander VPC's) wees

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) stel jou in staat om **AWS-hulpbronne in 'n virtuele netwerk te begin** wat jy gedefinieer het. Hierdie virtuele netwerk sal verskeie subnetwerke, Internetkoppelvlakke om toegang tot die internet te verkry, ACL's, Sekuriteitsgroepe, IP's h√™...

### Subnetwerke

Subnetwerke help om 'n ho√´r vlak van sekuriteit af te dwing. **Logiese groepering van soortgelyke hulpbronne** help jou ook om 'n **gemak van bestuur** regoor jou infrastruktuur te handhaaf.

* Geldige CIDR is vanaf 'n /16 netmasker tot 'n /28 netmasker.
* 'n Subnet kan nie terselfdertyd in verskillende beskikbaarheidsone wees nie.
* **AWS behou die eerste drie gas IP-adresse** van elke subnet **vir** **interne AWS-gebruik**: die eerste gasadres wat gebruik word, is vir die VPC-roeteerder. Die tweede adres is gereserveer vir AWS DNS en die derde adres is gereserveer vir toekomstige gebruik.
* Dit word **openbare subnetwerke** genoem wat **direkte toegang tot die internet het, terwyl private subnetwerke dit nie het nie.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Roetetabelle

Roetetabelle bepaal die verkeersroete vir 'n subnet binne 'n VPC. Hulle bepaal watter netwerkverkeer na die internet of na 'n VPN-verbinding gestuur word. Jy sal gewoonlik toegang vind tot die volgende:

* Plaaslike VPC
* NAT
* Internetkoppelvlakke / Uitgaande-internetkoppelvlakke (nodig om 'n VPC toegang tot die internet te gee).
* Om 'n subnet openbaar te maak, moet jy 'n **Internetkoppelvlak** aan jou VPC **skep** en **geheg** word.
* VPC-eindpunte (om S3 vanaf privaat netwerke te bereik)

In die volgende afbeeldings kan jy die verskille in 'n standaard openbare netwerk en 'n private een sien:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL's

**Netwerktoegangsbeheerlyste (ACL's)**: Netwerk ACL's is firewall-re√´ls wat inkomende en uitgaande netwerkverkeer na 'n subnet beheer. Dit kan gebruik word om verkeer na spesifieke IP-adresse of reekse toe te laat of te ontken.

* Dit is mees algemeen om toegang toe te laat/te ontken deur sekuriteitsgroepe te gebruik, maar dit is slegs 'n manier om gevestigde omgekeerde skulpe heeltemal te sny. 'n Gewysigde re√´l in 'n sekuriteitsgroep stop nie reeds gevestigde verbindings nie
* Dit geld egter vir die hele subnetwerk, wees versigtig wanneer jy dinge verbied, omdat nodige funksionaliteit versteur kan word
### Sekuriteitsgroepe

Sekuriteitsgroepe is 'n virtuele **firewall** wat inkomende en uitgaande netwerk **verkeer na instansies** in 'n VPC beheer. Verhouding 1 SG tot M instansies (gewoonlik 1 tot 1).\
Gewoonlik word dit gebruik om gevaarlike poorte in instansies oop te maak, soos poort 22 byvoorbeeld:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastiese IP-adresse

'n _Elastiese IP-adres_ is 'n **statiese IPv4-adres** wat ontwerp is vir dinamiese wolkrekenaars. 'n Elastiese IP-adres word toegewys aan jou AWS-rekening, en is joune totdat jy dit vrylaat. Deur 'n Elastiese IP-adres te gebruik, kan jy die mislukking van 'n instansie of sagteware maskeer deur die adres vinnig na 'n ander instansie in jou rekening te herkaart.

### Verbinding tussen subnetwerke

Standaard het alle subnetwerke die **outomatiese toekenning van openbare IP-adresse uitgeschakel** maar dit kan aangeskakel word.

**'n Plaaslike roete binne 'n roetetabel maak kommunikasie tussen VPC-subnetwerke moontlik.**

As jy 'n **subnet met 'n ander subnet verbind, kan jy nie toegang tot die subnette wat met die ander subnet verbind is nie**, jy moet direk met hulle 'n verbinding skep. **Dit geld ook vir internethekke**. Jy kan nie deur 'n subnetverbinding gaan om toegang tot die internet te verkry nie, jy moet die internethek aan jou subnet toeken.

### VPC-koppeling

VPC-koppeling maak dit moontlik om **twee of meer VPC's aan mekaar te koppel**, deur IPV4 of IPV6 te gebruik, asof hulle deel van dieselfde netwerk was.

Sodra die koppelvlak tot stand gebring is, kan **hulpbronne in een VPC toegang tot hulpbronne in die ander** verkry. Die koppeling tussen die VPC's word ge√Ømplementeer deur die bestaande AWS-netwerkinfrastruktuur, en dit is dus hoogs beskikbaar sonder bandwydteknelpunte. Aangesien **gekoppelde koppeling asof hulle deel van dieselfde netwerk was**, is daar beperkings wanneer dit kom by jou CIDR-blokreeks wat gebruik kan word.\
As jy **oorvleuelende of duplikaat CIDR**-reeks vir jou VPC het, sal jy **nie die VPC's kan koppel nie**.\
Elke AWS VPC sal **slegs met sy eweknie kommunikeer**. Byvoorbeeld, as jy 'n koppelvlakverbinding tussen VPC 1 en VPC 2 het, en 'n ander verbinding tussen VPC 2 en VPC 3 soos getoon, kan VPC 1 en 2 direk met mekaar kommunikeer, so ook VPC 2 en VPC 3, maar VPC 1 en VPC 3 nie. **Jy kan nie deur een VPC roete om by 'n ander te kom nie.**

### **VPC-vloeilogte**

Binne jou VPC kan jy moontlik honderde of selfs duisende hulpbronne h√™ wat kommunikeer tussen verskillende subnetwerke, beide openbare en private, en ook tussen verskillende VPC's deur VPC-koppelingsverbindinge. **VPC-vloeilogte stel jou in staat om IP-verkeersinligting wat vloei tussen die netwerkinterfaces van jou hulpbronne binne jou VPC vas te vang**.

In teenstelling met S3-toegangslogte en CloudFront-toegangslogte, word die **logdata wat deur VPC-vloeilogte gegenereer word, nie in S3 gestoor nie. In plaas daarvan word die vasgevangde logdata na CloudWatch-logte gestuur**.

Beperkings:

* As jy 'n VPC-gekoppelde verbinding het, sal jy slegs vloei-logte van gekoppelde VPC's binne dieselfde rekening kan sien.
* As jy steeds hulpbronne in die EC2-Classic-omgewing hardloop, kan jy ongelukkig nie inligting van hul koppelvlakke terugkry nie.
* Sodra 'n VPC-vloeilog geskep is, kan dit nie verander word nie. Om die VPC-vloeilogkonfigurasie te verander, moet jy dit uitvee en dan 'n nuwe een skep.
* Die volgende verkeer word nie gemonitor en vasgevang deur die logte nie. DHCP-verkeer binne die VPC, verkeer van instansies wat bestem is vir die Amazon DNS-bediener.
* Enige verkeer wat bestem is vir die IP-adres van die VPC-standaardroeteerder en verkeer na en van die volgende adresse, 169.254.169.254 wat gebruik word vir die insameling van instansiemetagegewe, en 169.254.169.123 wat gebruik word vir die Amazon Time Sync-diens.
* Verkeer wat verband hou met 'n Amazon Windows-aktiveringslisensie van 'n Windows-instansie
* Verkeer tussen 'n netwerklaaibalansierderkoppelvlak en 'n eindpunt-netwerkkoppelvlak

Vir elke netwerkinterface wat data na die CloudWatch-loggroep publiseer, sal dit 'n ander logstroom gebruik. En binne elkeen van hierdie strome sal daar die vloeiloggebeurtenisdata wees wat die inhoud van die loginskrywings toon. Elkeen van hierdie **logte vang data op gedurende 'n venster van ongeveer 10 tot 15 minute**.

## VPN

### Basiese AWS VPN-komponente

1. **Kli√´nthek**:
* 'n Kli√´nthek is 'n hulpbron wat jy in AWS skep om jou kant van 'n VPN-verbinding te verteenwoordig.
* Dit is essensieel 'n fisiese toestel of sagtewaretoepassing aan jou kant van die Site-to-Site VPN-verbinding.
* Jy voorsien roetine-inligting en die openbare IP-adres van jou netwerktoestel (soos 'n router of 'n vuurwal) aan AWS om 'n Kli√´nthek te skep.
* Dit dien as 'n verwysingspunt vir die opstel van die VPN-verbinding en dra nie addisionele kostes nie.
2. **Virtuele Privaathek**:
* 'n Virtuele Privaathek (VPG) is die VPN-konsentraator aan die Amazon-kant van die Site-to-Site VPN-verbinding.
* Dit is aan jou VPC geheg en dien as die teiken vir jou VPN-verbinding.
* VPG is die AWS-kant-eindpunt vir die VPN-verbinding.
* Dit hanteer die veilige kommunikasie tussen jou VPC en jou plaaslike netwerk.
3. **Site-to-Site VPN-verbinding**:
* 'n Site-to-Site VPN-verbinding koppel jou plaaslike netwerk aan 'n VPC deur 'n veilige, IPsec VPN-tunnel.
* Hierdie tipe verbinding vereis 'n Kli√´nthek en 'n Virtuele Privaathek.
* Dit word gebruik vir veilige, stabiele en konstante kommunikasie tussen jou data-sentrum of netwerk en jou AWS-omgewing.
* Gewoonlik gebruik vir gereelde, langtermynverbindinge en word gefaktureer op grond van die hoeveelheid data wat oor die verbinding oorgedra word.
4. **Kli√´nt-VPN-eindpunt**:
* 'n Kli√´nt-VPN-eindpunt is 'n hulpbron wat jy in AWS skep om kli√´nt-VPN-sessies moontlik te maak en te bestuur.
* Dit word gebruik om individuele toestelle (soos draagbare rekenaars, slimfone, ens.) toe te laat om veilig met AWS-hulpbronne of jou plaaslike netwerk te verbind.
* Dit verskil van Site-to-Site VPN daarin dat dit ontwerp is vir individuele kli√´nte eerder as om hele netwerke te koppel.
* Met Kli√´nt-VPN gebruik elke kli√´nttoestel 'n VPN-kli√´nt sagteware om 'n veilige verbinding tot stand te bring.

### Site-to-Site VPN

**Koppel jou plaaslike netwerk met jou VPC.**

* **VPN-verbinding**: 'n veilige verbinding tussen jou plaaslike toerusting en jou VPC's.
*   **VPN-tunnel**: 'n versleutelde skakel waar data van die kli√´ntnetwerk na of van AWS kan beweeg.

Elke VPN-verbinding sluit twee VPN-tunnels in wat jy gelyktydig kan gebruik vir ho√´ beskikbaarheid.
* **Kli√´nthek**: 'n AWS-hulpbron wat inligting aan AWS verskaf oor jou kli√´nthektoestel.
* **Kli√´nthektoestel**: 'n fisiese toestel of sagtewaretoepassing aan jou kant van die Site-to-Site VPN-verbinding.
* **Virtuele privaathek**: Die VPN-konsentraator aan die Amazon-kant van die Site-to-Site VPN-verbinding. Jy gebruik 'n virtuele privaathek of 'n transitotheek as die hek vir die Amazon-kant van die Site-to-Site VPN-verbinding.
* **Transitotheek**: 'n transitotheek wat gebruik kan word om jou VPC's en plaaslike netwerke met mekaar te verbind. Jy gebruik 'n transitotheek of virtuele privaathek as die hek vir die Amazon-kant van die Site-to-Site VPN-verbinding.
#### Beperkings

* IPv6-verkeer word nie ondersteun vir VPN-verbindinge op 'n virtuele privaat gateway nie.
* 'n AWS VPN-verbinding ondersteun nie Path MTU Discovery nie.

Daarbenewens moet die volgende in ag geneem word wanneer jy Site-to-Site VPN gebruik.

* Wanneer jy jou VPC's aan 'n gemeenskaplike on-premises netwerk koppel, beveel ons aan dat jy nie-oorvleuelende CIDR-blokkies vir jou netwerke gebruik.

### Kli√´nt VPN <a href="#what-is-components" id="what-is-components"></a>

**Verbind vanaf jou rekenaar na jou VPC**

#### Konsepte

* **Kli√´nt VPN-eindpunt:** Die hulpbron wat jy skep en konfigureer om kli√´nt VPN-sessies moontlik te maak en te bestuur. Dit is die hulpbron waar al die kli√´nt VPN-sessies bee√Øndig word.
* **Teiken netwerk:** 'n Teiken netwerk is die netwerk wat jy assosieer met 'n Kli√´nt VPN-eindpunt. **'n Subnet van 'n VPC is 'n teiken netwerk**. Om 'n subnet met 'n Kli√´nt VPN-eindpunt te assosieer, maak dit dit moontlik om VPN-sessies te vestig. Jy kan verskeie subnets met 'n Kli√´nt VPN-eindpunt assosieer vir ho√´ beskikbaarheid. Alle subnets moet van dieselfde VPC wees. Elke subnet moet aan 'n ander Beskikbaarheidsonderneming behoort.
* **Roete:** Elke Kli√´nt VPN-eindpunt het 'n roetetabel wat die beskikbare bestemmingsnetwerke beskryf. Elke roete in die roetetabel spesifiseer die pad vir verkeer na spesifieke bronne of netwerke.
* **Outoriseringsre√´ls:** 'n Outoriseringsre√´l **beperk die gebruikers wat toegang kan verkry tot 'n netwerk**. Vir 'n gespesifiseerde netwerk, konfigureer jy die Active Directory of identiteitsverskaffer (IdP) groep wat toegang kry. Slegs gebruikers wat aan hierdie groep behoort, kan toegang verkry tot die gespesifiseerde netwerk. **Standaard is daar geen outoriseringsre√´ls nie** en jy moet outoriseringsre√´ls konfigureer om gebruikers in staat te stel om hulpbronne en netwerke te benader.
* **Kli√´nt:** Die eindgebruiker wat koppel na die Kli√´nt VPN-eindpunt om 'n VPN-sessie te vestig. Eindgebruikers moet 'n OpenVPN-kli√´nt aflaai en die Kli√´nt VPN-konfigurasie-l√™er wat jy geskep het, gebruik om 'n VPN-sessie te vestig.
* **Kli√´nt CIDR-reeks:** 'n IP-adresreeks waaruit kli√´nt IP-adresse toegewys word. Elke verbinding na die Kli√´nt VPN-eindpunt word 'n unieke IP-adres toegewys uit die kli√´nt CIDR-reeks. Jy kies die kli√´nt CIDR-reeks, byvoorbeeld, `10.2.0.0/16`.
* **Kli√´nt VPN-poorte:** AWS Kli√´nt VPN ondersteun poorte 443 en 1194 vir beide TCP en UDP. Die verstekpoort is poort 443.
* **Kli√´nt VPN-netwerkinterfaces:** Wanneer jy 'n subnet assosieer met jou Kli√´nt VPN-eindpunt, skep ons Kli√´nt VPN-netwerkinterfaces in daardie subnet. **Verkeer wat vanaf die Kli√´nt VPN-eindpunt na die VPC gestuur word, word deur 'n Kli√´nt VPN-netwerkinterface gestuur**. Bronnetwerkadresvertaling (SNAT) word dan toegepas, waar die bron-IP-adres van die kli√´nt CIDR-reeks vertaal word na die IP-adres van die Kli√´nt VPN-netwerkinterface.
* **Verbindingslogging:** Jy kan verbindingslogging aktiveer vir jou Kli√´nt VPN-eindpunt om verbindingsgebeure te log. Jy kan hierdie inligting gebruik om forensies uit te voer, te analiseer hoe jou Kli√´nt VPN-eindpunt gebruik word, of verbindingsprobleme te ontleed.
* **Selfbedieningsportaal:** Jy kan 'n selfbedieningsportaal aktiveer vir jou Kli√´nt VPN-eindpunt. Kli√´nte kan inlog op die webgebaseerde portaal met hul geloofsbriewe en die nuutste weergawe van die Kli√´nt VPN-eindpunt konfigurasie-l√™er aflaai, of die nuutste weergawe van die deur AWS voorsiene kli√´nt.

#### Beperkings

* **Kli√´nt CIDR-reeks kan nie oorvleuel met die plaaslike CIDR** van die VPC waarin die geassosieerde subnet gele√´ is, of enige roetes wat handmatig by die Kli√´nt VPN-eindpunt se roetetabel gevoeg is nie.
* Kli√´nt CIDR-reekse moet 'n blokgrootte van ten minste /22 h√™ en mag **nie groter as /12 wees nie**.
* 'n **Gedeelte van die adresse** in die kli√´nt CIDR-reeks word gebruik om die beskikbaarheidsmodel van die Kli√´nt VPN-eindpunt te ondersteun, en kan nie aan kli√´nte toegewys word nie. Daarom beveel ons aan dat jy 'n CIDR-blok toewys wat dubbel die aantal IP-adresse bevat wat benodig word om die maksimum aantal gelyktydige verbindings wat jy beplan om op die Kli√´nt VPN-eindpunt te ondersteun, te aktiveer.
* Die **kli√´nt CIDR-reeks kan nie verander word** nadat jy die Kli√´nt VPN-eindpunt geskep het nie.
* Die **subnets** wat geassosieer is met 'n Kli√´nt VPN-eindpunt **moet in dieselfde VPC wees**.
* Jy **kan nie verskeie subnets van dieselfde Beskikbaarheidsonderneming met 'n Kli√´nt VPN-eindpunt assosieer** nie.
* 'n Kli√´nt VPN-eindpunt **ondersteun nie subnet-assosiasies in 'n toegewyde tenancy VPC** nie.
* Kli√´nt VPN ondersteun slegs **IPv4**-verkeer.
* Kli√´nt VPN is **nie** Federal Information Processing Standards (**FIPS**) **kompatibel** nie.
*   As multi-faktor outentifikasie (MFA) gedeaktiveer is vir jou Active Directory, kan 'n gebruikerswagwoord nie in die volgende formaat wees nie.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Die selfbedieningsportaal is **nie beskikbaar vir kli√´nte wat outentifiseer met wederkerige outentifikasie** nie.
