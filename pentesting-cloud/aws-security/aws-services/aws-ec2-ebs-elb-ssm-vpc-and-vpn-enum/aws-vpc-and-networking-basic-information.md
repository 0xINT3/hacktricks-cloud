# Informaci칩n B치sica de AWS - VPC y Networking

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Networking en AWS en Resumen

Un **VPC** contiene un **CIDR de red** como 10.0.0.0/16 (con su **tabla de enrutamiento** y **ACL de red**).

Esta red de VPC se divide en **subredes**, por lo que una **subred** est치 directamente **relacionada** con el **VPC**, la **tabla de enrutamiento** y la **ACL de red**.

Luego, las **Interfaces de red** adjuntas a los servicios (como instancias EC2) est치n **conectadas** a las **subredes** con **grupo(s) de seguridad**.

Por lo tanto, un **grupo de seguridad** limitar치 los puertos expuestos de las **interfaces de red que lo utilizan**, **independientemente de la subred**. Y una **ACL de red** **limitar치** los puertos expuestos a toda la **red**.

Adem치s, para **acceder a Internet**, hay algunas configuraciones interesantes para verificar:

* Una **subred** puede **asignar autom치ticamente direcciones IPv4 p칰blicas**
* Una **instancia** creada en la red que **asigna autom치ticamente direcciones IPv4 puede obtener una**
* Se necesita un **gateway a Internet** para estar **adjunto** al **VPC**
* Tambi칠n se pueden utilizar **gateways de salida solo para Internet**
* Tambi칠n se puede tener un **gateway NAT** en una **subred privada** para poder **conectarse a servicios externos** desde esa subred privada, pero **no es posible alcanzarlos desde el exterior**.
* El gateway NAT puede ser **p칰blico** (acceso a Internet) o **privado** (acceso a otros VPC)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) te permite **lanzar recursos de AWS en una red virtual** que has definido. Esta red virtual tendr치 varias subredes, Gateways a Internet para acceder a Internet, ACLs, Grupos de seguridad, IPs...

### Subredes

Las subredes ayudan a hacer cumplir un mayor nivel de seguridad. La **agrupaci칩n l칩gica de recursos similares** tambi칠n te ayuda a mantener una **facilidad de gesti칩n** en toda tu infraestructura.

* Los CIDR v치lidos van desde una m치scara de red /16 hasta una m치scara de red /28.
* Una subred no puede estar en diferentes zonas de disponibilidad al mismo tiempo.
* **AWS reserva las tres primeras direcciones IP de host** de cada subred **para uso interno de AWS**: la primera direcci칩n de host utilizada es para el enrutador de VPC. La segunda direcci칩n se reserva para DNS de AWS y la tercera direcci칩n se reserva para uso futuro.
* Se llaman **subredes p칰blicas** a aquellas que tienen **acceso directo a Internet, mientras que las subredes privadas no lo tienen.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tablas de Enrutamiento

Las tablas de enrutamiento determinan el enrutamiento de tr치fico para una subred dentro de un VPC. Determinan qu칠 tr치fico de red se env칤a a Internet o a una conexi칩n VPN. Por lo general, encontrar치s acceso a:

* VPC local
* NAT
* Gateways a Internet / Gateways de salida solo para Internet (necesarios para dar acceso a Internet a un VPC).
* Para hacer p칰blica una subred, necesitas **crear** y **adjuntar** un **gateway a Internet** a tu VPC.
* Puntos de conexi칩n de VPC (para acceder a S3 desde redes privadas)

En las siguientes im치genes puedes verificar las diferencias en una red p칰blica predeterminada y una privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listas de Control de Acceso de Red (ACLs)**: Las ACL de red son reglas de firewall que controlan el tr치fico de red entrante y saliente a una subred. Se pueden utilizar para permitir o denegar tr치fico a direcciones IP o rangos espec칤ficos.

* Es m치s frecuente permitir/denegar acceso usando grupos de seguridad, pero esta es la 칰nica forma de cortar por completo las conexiones inversas establecidas. Una regla modificada en un grupo de seguridad no detiene las conexiones ya establecidas.
* Sin embargo, esto se aplica a toda la subred, as칤 que ten cuidado al prohibir cosas porque la funcionalidad necesaria podr칤a verse afectada.
### Grupos de Seguridad

Los grupos de seguridad son un **firewall virtual** que controla el tr치fico de red **entrante y saliente a las instancias** en una VPC. Relaci칩n de 1 SG a M instancias (generalmente de 1 a 1).\
Normalmente se utiliza para abrir puertos peligrosos en las instancias, como el puerto 22 por ejemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Direcciones IP El치sticas

Una _direcci칩n IP el치stica_ es una **direcci칩n IPv4 est치tica** dise침ada para la inform치tica en la nube din치mica. Una direcci칩n IP el치stica se asigna a tu cuenta de AWS y es tuya hasta que la liberes. Al utilizar una direcci칩n IP el치stica, puedes enmascarar la falla de una instancia o software al remapear r치pidamente la direcci칩n a otra instancia en tu cuenta.

### Conexi칩n entre subredes

Por defecto, todas las subredes tienen la **asignaci칩n autom치tica de direcciones IP p칰blicas desactivada** pero se puede activar.

**Una ruta local dentro de una tabla de rutas permite la comunicaci칩n entre las subredes de la VPC**.

Si est치s **conectando una subred con una subred diferente no puedes acceder a las subredes conectadas** con la otra subred, necesitas crear una conexi칩n con ellas directamente. **Esto tambi칠n se aplica a las pasarelas de internet**. No puedes pasar a trav칠s de una conexi칩n de subred para acceder a internet, necesitas asignar la pasarela de internet a tu subred.

### Emparejamiento de VPC

El emparejamiento de VPC te permite **conectar dos o m치s VPC juntas**, utilizando IPV4 o IPV6, como si fueran parte de la misma red.

Una vez que se establece la conectividad entre pares, **los recursos en una VPC pueden acceder a los recursos en la otra**. La conectividad entre las VPC se implementa a trav칠s de la infraestructura de red existente de AWS, por lo que es altamente disponible sin cuellos de botella de ancho de banda. Como **las conexiones emparejadas operan como si fueran parte de la misma red**, existen restricciones en cuanto a los rangos de bloques CIDR que se pueden utilizar.\
Si tienes **rangos CIDR superpuestos o duplicados** para tus VPC, entonces **no podr치s emparejar las VPC**.\
Cada VPC de AWS **solo se comunicar치 con su par**. Por ejemplo, si tienes una conexi칩n de emparejamiento entre VPC 1 y VPC 2, y otra conexi칩n entre VPC 2 y VPC 3 como se muestra, entonces VPC 1 y 2 podr칤an comunicarse directamente, al igual que VPC 2 y VPC 3, sin embargo, VPC 1 y VPC 3 no podr칤an. **No puedes enrutar a trav칠s de una VPC para llegar a otra**.

### **Registros de Flujo de VPC**

Dentro de tu VPC, podr칤as tener cientos o incluso miles de recursos que se comunican entre diferentes subredes, tanto p칰blicas como privadas, y tambi칠n entre diferentes VPC a trav칠s de conexiones de emparejamiento de VPC. **Los registros de flujo de VPC te permiten capturar informaci칩n de tr치fico IP que fluye entre las interfaces de red de tus recursos dentro de tu VPC**.

A diferencia de los registros de acceso de S3 y los registros de acceso de CloudFront, **los datos de registro generados por los registros de flujo de VPC no se almacenan en S3. En su lugar, los datos de registro capturados se env칤an a CloudWatch logs**.

Limitaciones:

* Si est치s ejecutando una conexi칩n emparejada de VPC, solo podr치s ver los registros de flujo de las VPC emparejadas que est칠n dentro de la misma cuenta.
* Si todav칤a est치s ejecutando recursos dentro del entorno EC2-Classic, lamentablemente no podr치s recuperar informaci칩n de sus interfaces.
* Una vez que se haya creado un Registro de Flujo de VPC, no se puede modificar. Para modificar la configuraci칩n del Registro de Flujo de VPC, debes eliminarlo y luego crear uno nuevo.
* El siguiente tr치fico no es monitoreado ni capturado por los registros. Tr치fico DHCP dentro de la VPC, tr치fico desde las instancias destinado al Servidor DNS de Amazon.
* Cualquier tr치fico destinado a la direcci칩n IP del enrutador predeterminado de la VPC y tr치fico desde y hacia las siguientes direcciones, 169.254.169.254 que se utiliza para recopilar metadatos de instancia, y 169.254.169.123 que se utiliza para el Servicio de Sincronizaci칩n de Tiempo de Amazon.
* Tr치fico relacionado con una licencia de activaci칩n de Windows de Amazon desde una instancia de Windows.
* Tr치fico entre una interfaz de equilibrador de carga de red y una interfaz de red de punto final.

Para cada interfaz de red que publique datos en el grupo de registros de CloudWatch, se utilizar치 un flujo de registro diferente. Y dentro de cada uno de estos flujos, habr치 datos de eventos de flujo de registro que muestran el contenido de las entradas de registro. Cada uno de estos **registros captura datos durante una ventana de aproximadamente 10 a 15 minutos**.

## VPN

### Componentes B치sicos de VPN de AWS

1. **Puerta de enlace del cliente**:
* Una Puerta de enlace del cliente es un recurso que creas en AWS para representar tu lado de una conexi칩n VPN.
* Es esencialmente un dispositivo f칤sico o aplicaci칩n de software en tu lado de la conexi칩n VPN de sitio a sitio.
* Proporcionas informaci칩n de enrutamiento y la direcci칩n IP p칰blica de tu dispositivo de red (como un enrutador o un firewall) a AWS para crear una Puerta de enlace del cliente.
* Sirve como punto de referencia para configurar la conexi칩n VPN y no incurre en cargos adicionales.
2. **Puerta de enlace privada virtual**:
* Una Puerta de enlace privada virtual (VPG) es el concentrador VPN en el lado de Amazon de la conexi칩n VPN de sitio a sitio.
* Est치 adjunta a tu VPC y sirve como el objetivo para tu conexi칩n VPN.
* VPG es el punto final del lado de AWS para la conexi칩n VPN.
* Maneja la comunicaci칩n segura entre tu VPC y tu red local.
3. **Conexi칩n VPN de sitio a sitio**:
* Una conexi칩n VPN de sitio a sitio conecta tu red local a una VPC a trav칠s de un t칰nel VPN IPsec seguro.
* Este tipo de conexi칩n requiere una Puerta de enlace del cliente y una Puerta de enlace privada virtual.
* Se utiliza para una comunicaci칩n segura, estable y consistente entre tu centro de datos o red y tu entorno de AWS.
* Se utiliza t칤picamente para conexiones regulares y a largo plazo y se factura en funci칩n de la cantidad de datos transferidos a trav칠s de la conexi칩n.
4. **Punto de conexi칩n VPN de cliente**:
* Un punto de conexi칩n VPN de cliente es un recurso que creas en AWS para habilitar y gestionar sesiones VPN de cliente.
* Se utiliza para permitir que dispositivos individuales (como computadoras port치tiles, tel칠fonos inteligentes, etc.) se conecten de forma segura a los recursos de AWS o a tu red local.
* A diferencia de la VPN de sitio a sitio, est치 dise침ada para clientes individuales en lugar de conectar redes enteras.
* Con la VPN de cliente, cada dispositivo cliente utiliza un software cliente VPN para establecer una conexi칩n segura.

### VPN de Sitio a Sitio

**Conecta tu red local con tu VPC.**

* **Conexi칩n VPN**: Una conexi칩n segura entre tu equipo local y tus VPC.
*   **T칰nel VPN**: Un enlace cifrado por donde los datos pueden pasar desde la red del cliente hacia o desde AWS.

Cada conexi칩n VPN incluye dos t칰neles VPN que puedes usar simult치neamente para alta disponibilidad.
* **Puerta de enlace del cliente**: Un recurso de AWS que proporciona informaci칩n a AWS sobre tu dispositivo de puerta de enlace del cliente.
* **Dispositivo de puerta de enlace del cliente**: Un dispositivo f칤sico o aplicaci칩n de software en tu lado de la conexi칩n VPN de sitio a sitio.
* **Puerta de enlace privada virtual**: El concentrador VPN en el lado de Amazon de la conexi칩n VPN de sitio a sitio. Utilizas una puerta de enlace privada virtual o un gateway de tr치nsito como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de sitio a sitio.
* **Gateway de tr치nsito**: Un concentrador de tr치nsito que se puede utilizar para interconectar tus VPC y redes locales. Utilizas un gateway de tr치nsito o una puerta de enlace privada virtual como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de sitio a sitio.
#### Limitaciones

* El tr치fico IPv6 no es compatible para las conexiones VPN en una puerta de enlace privada virtual.
* Una conexi칩n VPN de AWS no admite el descubrimiento de MTU de ruta.

Adem치s, tenga en cuenta lo siguiente al utilizar VPN de sitio a sitio.

### VPN de cliente <a href="#what-is-components" id="what-is-components"></a>

**Con칠ctese desde su m치quina a su VPC**

#### Conceptos

* **Punto de conexi칩n de VPN de cliente:** El recurso que crea y configura para habilitar y gestionar sesiones de VPN de cliente. Es el recurso donde se terminan todas las sesiones de VPN de cliente.
* **Red de destino:** Una red de destino es la red que se asocia con un punto de conexi칩n de VPN de cliente. **Una subred de una VPC es una red de destino**. Asociar una subred con un punto de conexi칩n de VPN de cliente le permite establecer sesiones VPN. Puede asociar varias subredes con un punto de conexi칩n de VPN de cliente para alta disponibilidad. Todas las subredes deben ser de la misma VPC. Cada subred debe pertenecer a una zona de disponibilidad diferente.
* **Ruta**: Cada punto de conexi칩n de VPN de cliente tiene una tabla de rutas que describe las rutas de red de destino disponibles. Cada ruta en la tabla de rutas especifica el camino para el tr치fico hacia recursos o redes espec칤ficas.
* **Reglas de autorizaci칩n:** Una regla de autorizaci칩n **restringe a los usuarios que pueden acceder a una red**. Para una red especificada, configura el grupo de Active Directory o proveedor de identidad (IdP) que tiene acceso permitido. Solo los usuarios que pertenecen a este grupo pueden acceder a la red especificada. **De forma predeterminada, no hay reglas de autorizaci칩n** y debe configurar reglas de autorizaci칩n para permitir que los usuarios accedan a recursos y redes.
* **Cliente:** El usuario final que se conecta al punto de conexi칩n de VPN de cliente para establecer una sesi칩n de VPN. Los usuarios finales deben descargar un cliente OpenVPN y usar el archivo de configuraci칩n de VPN de cliente que cre칩 para establecer una sesi칩n de VPN.
* **Rango CIDR de cliente:** Un rango de direcciones IP desde el cual asignar direcciones IP de cliente. A cada conexi칩n al punto de conexi칩n de VPN de cliente se le asigna una direcci칩n IP 칰nica del rango CIDR de cliente. Usted elige el rango CIDR de cliente, por ejemplo, `10.2.0.0/16`.
* **Puertos de VPN de cliente:** AWS Client VPN admite los puertos 443 y 1194 tanto para TCP como para UDP. El predeterminado es el puerto 443.
* **Interfaces de red de VPN de cliente:** Cuando asocia una subred con su punto de conexi칩n de VPN de cliente, creamos interfaces de red de VPN de cliente en esa subred. **El tr치fico que se env칤a a la VPC desde el punto de conexi칩n de VPN de cliente se env칤a a trav칠s de una interfaz de red de VPN de cliente**. Luego se aplica la traducci칩n de direcciones de red de origen (SNAT), donde la direcci칩n IP de origen del rango CIDR de cliente se traduce a la direcci칩n IP de la interfaz de red de VPN de cliente.
* **Registro de conexiones:** Puede habilitar el registro de conexiones para su punto de conexi칩n de VPN de cliente para registrar eventos de conexi칩n. Puede utilizar esta informaci칩n para realizar an치lisis forenses, analizar c칩mo se est치 utilizando su punto de conexi칩n de VPN de cliente o solucionar problemas de conexi칩n.
* **Portal de autoservicio:** Puede habilitar un portal de autoservicio para su punto de conexi칩n de VPN de cliente. Los clientes pueden iniciar sesi칩n en el portal basado en web utilizando sus credenciales y descargar la 칰ltima versi칩n del archivo de configuraci칩n del punto de conexi칩n de VPN de cliente, o la 칰ltima versi칩n del cliente proporcionado por AWS.

#### Limitaciones

* **Los rangos CIDR de cliente no pueden superponerse con el CIDR local** de la VPC en la que se encuentra la subred asociada, o con cualquier ruta agregada manualmente a la tabla de rutas del punto de conexi칩n de VPN de cliente.
* Los rangos CIDR de cliente deben tener un tama침o de bloque de al menos /22 y no deben ser mayores que /12.
* **Una parte de las direcciones** en el rango CIDR de cliente se utilizan para **soportar el modelo de disponibilidad** del punto de conexi칩n de VPN de cliente, y no pueden asignarse a los clientes. Por lo tanto, recomendamos que **asigne un bloque CIDR que contenga el doble de direcciones IP que se requieren** para habilitar el n칰mero m치ximo de conexiones simult치neas que planea admitir en el punto de conexi칩n de VPN de cliente.
* El **rango CIDR de cliente no se puede cambiar** despu칠s de crear el punto de conexi칩n de VPN de cliente.
* Las **subredes** asociadas con un punto de conexi칩n de VPN de cliente **deben estar en la misma VPC**.
* **No puede asociar m칰ltiples subredes de la misma Zona de Disponibilidad con un punto de conexi칩n de VPN de cliente**.
* Un punto de conexi칩n de VPN de cliente **no admite asociaciones de subred en una VPC de tenencia dedicada**.
* VPN de cliente admite solo tr치fico **IPv4**.
* VPN de cliente no es compatible con el est치ndar Federal de Procesamiento de Informaci칩n (**FIPS**).
*   Si la autenticaci칩n de m칰ltiples factores (MFA) est치 deshabilitada para su Active Directory, la contrase침a de usuario no puede estar en el siguiente formato.

```
SCRV1:<cadena_codificada_en_base64>:<cadena_codificada_en_base64>
```
* El portal de autoservicio **no est치 disponible para clientes que se autentican mediante autenticaci칩n mutua**.
