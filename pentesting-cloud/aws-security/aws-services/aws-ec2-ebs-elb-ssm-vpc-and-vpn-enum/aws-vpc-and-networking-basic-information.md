# AWS - Informa√ß√µes B√°sicas sobre VPC e Networking

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Networking na AWS em Poucas Palavras

Um **VPC** cont√©m um **CIDR de rede** como 10.0.0.0/16 (com sua **tabela de roteamento** e **ACL de rede**).

Esta rede VPC √© dividida em **sub-redes**, ent√£o uma **sub-rede** est√° diretamente **relacionada** com o **VPC**, **tabela de roteamento** e **ACL de rede**.

Em seguida, as **Interfaces de Rede** anexadas a servi√ßos (como inst√¢ncias EC2) est√£o **conectadas** √†s **sub-redes** com **grupo(s) de seguran√ßa**.

Portanto, um **grupo de seguran√ßa** limitar√° as portas expostas das **interfaces de rede que o utilizam**, **independentemente da sub-rede**. E uma **ACL de rede** ir√° **limitar** as portas expostas para **toda a rede**.

Al√©m disso, para **acessar a Internet**, existem algumas configura√ß√µes interessantes para verificar:

* Uma **sub-rede** pode **atribuir automaticamente endere√ßos IPv4 p√∫blicos**
* Uma **inst√¢ncia** criada na rede que **atribui automaticamente endere√ßos IPv4 pode obter um**
* Um **gateway de Internet** precisa ser **anexado** ao **VPC**
* Voc√™ tamb√©m pode usar **gateways de Internet somente de sa√≠da**
* Voc√™ tamb√©m pode ter um **gateway NAT** em uma **sub-rede privada** para ser poss√≠vel **conectar-se a servi√ßos externos** a partir dessa sub-rede privada, mas **n√£o √© poss√≠vel alcan√ß√°-los de fora**.
* O gateway NAT pode ser **p√∫blico** (acesso √† internet) ou **privado** (acesso a outros VPCs)

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

A **Amazon Virtual Private Cloud** (Amazon VPC) permite que voc√™ **inicie recursos da AWS em uma rede virtual** que voc√™ definiu. Esta rede virtual ter√° v√°rias sub-redes, Gateways de Internet para acessar a Internet, ACLs, grupos de seguran√ßa, IPs...

### Sub-redes

As sub-redes ajudam a impor um maior n√≠vel de seguran√ßa. **Agrupamento l√≥gico de recursos semelhantes** tamb√©m ajuda a manter uma **facilidade de gerenciamento** em toda a sua infraestrutura.

* Os CIDRs v√°lidos v√£o de uma m√°scara de rede /16 a uma m√°scara de rede /28.
* Uma sub-rede n√£o pode estar em diferentes zonas de disponibilidade ao mesmo tempo.
* **A AWS reserva os tr√™s primeiros endere√ßos IP de host** de cada sub-rede **para uso interno da AWS**: o primeiro endere√ßo de host usado √© para o roteador VPC. O segundo endere√ßo √© reservado para o DNS da AWS e o terceiro endere√ßo √© reservado para uso futuro.
* S√£o chamadas **sub-redes p√∫blicas** aquelas que t√™m **acesso direto √† Internet, enquanto as sub-redes privadas n√£o t√™m.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabelas de Roteamento

As tabelas de roteamento determinam o roteamento de tr√°fego para uma sub-rede dentro de um VPC. Elas determinam qual tr√°fego de rede √© encaminhado para a Internet ou para uma conex√£o VPN. Voc√™ geralmente encontrar√° acesso ao:

* VPC Local
* NAT
* Gateways de Internet / Gateways de Internet somente de sa√≠da (necess√°rios para dar acesso a um VPC √† Internet).
* Para tornar uma sub-rede p√∫blica, voc√™ precisa **criar** e **anexar** um **gateway de Internet** ao seu VPC.
* Pontos de extremidade do VPC (para acessar o S3 de redes privadas)

Nas imagens a seguir, voc√™ pode verificar as diferen√ßas em uma rede p√∫blica padr√£o e em uma privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listas de Controle de Acesso de Rede (ACLs)**: As ACLs de rede s√£o regras de firewall que controlam o tr√°fego de entrada e sa√≠da para uma sub-rede. Elas podem ser usadas para permitir ou negar tr√°fego para endere√ßos IP ou intervalos espec√≠ficos.

* √â mais frequente permitir/negar acesso usando grupos de seguran√ßa, mas esta √© a √∫nica maneira de cortar completamente shells reversos estabelecidos. Uma regra modificada em um grupo de seguran√ßa n√£o interrompe conex√µes j√° estabelecidas
* No entanto, isso se aplica a toda a sub-rede, tenha cuidado ao proibir coisas, pois a funcionalidade necess√°ria pode ser perturbada
### Grupos de Seguran√ßa

Os grupos de seguran√ßa s√£o um **firewall virtual** que controla o tr√°fego de rede **de entrada e sa√≠da para inst√¢ncias** em uma VPC. Rela√ß√£o 1 SG para M inst√¢ncias (geralmente 1 para 1).\
Normalmente, isso √© usado para abrir portas perigosas em inst√¢ncias, como a porta 22, por exemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Endere√ßos IP El√°sticos

Um _endere√ßo IP el√°stico_ √© um **endere√ßo IPv4 est√°tico** projetado para computa√ß√£o em nuvem din√¢mica. Um endere√ßo IP el√°stico √© alocado para sua conta AWS e √© seu at√© que voc√™ o libere. Ao usar um endere√ßo IP el√°stico, voc√™ pode mascarar a falha de uma inst√¢ncia ou software remapeando rapidamente o endere√ßo para outra inst√¢ncia em sua conta.

### Conex√£o entre sub-redes

Por padr√£o, todas as sub-redes t√™m o **atributo de endere√ßos IP p√∫blicos automaticamente desativado**, mas pode ser ativado.

**Uma rota local dentro de uma tabela de rotas permite a comunica√ß√£o entre sub-redes da VPC.**

Se voc√™ est√° **conectando uma sub-rede com uma sub-rede diferente, voc√™ n√£o pode acessar as sub-redes conectadas** com a outra sub-rede, voc√™ precisa criar uma conex√£o com elas diretamente. **Isso tamb√©m se aplica aos gateways de internet**. Voc√™ n√£o pode passar por uma conex√£o de sub-rede para acessar a internet, voc√™ precisa atribuir o gateway de internet √† sua sub-rede.

### VPC Peering

O VPC peering permite que voc√™ **conecte duas ou mais VPCs juntas**, usando IPV4 ou IPV6, como se fossem parte da mesma rede.

Uma vez que a conectividade entre pares √© estabelecida, **os recursos em uma VPC podem acessar recursos na outra**. A conectividade entre as VPCs √© implementada atrav√©s da infraestrutura de rede existente da AWS, sendo altamente dispon√≠vel e sem gargalos de largura de banda. Como **as conex√µes entre pares operam como se fossem parte da mesma rede**, existem restri√ß√µes quando se trata das faixas de blocos CIDR que podem ser usadas.\
Se voc√™ tiver **faixas CIDR sobrepostas ou duplicadas** para suas VPCs, ent√£o **voc√™ n√£o poder√° conectar as VPCs** juntas.\
Cada VPC da AWS **s√≥ se comunicar√° com seu par**. Por exemplo, se voc√™ tiver uma conex√£o de pares entre a VPC 1 e a VPC 2, e outra conex√£o entre a VPC 2 e a VPC 3, como mostrado, ent√£o a VPC 1 e 2 poderiam se comunicar diretamente, assim como a VPC 2 e VPC 3, no entanto, a VPC 1 e VPC 3 n√£o poderiam. **Voc√™ n√£o pode rotear por uma VPC para chegar a outra.**

### **Logs de Fluxo da VPC**

Dentro da sua VPC, voc√™ pode potencialmente ter centenas ou at√© milhares de recursos comunicando entre diferentes sub-redes, tanto p√∫blicas quanto privadas, e tamb√©m entre diferentes VPCs atrav√©s de conex√µes de VPC peering. **Os Logs de Fluxo da VPC permitem que voc√™ capture informa√ß√µes de tr√°fego IP que flui entre as interfaces de rede de seus recursos dentro de sua VPC**.

Ao contr√°rio dos logs de acesso do S3 e dos logs de acesso do CloudFront, os **dados de log gerados pelos Logs de Fluxo da VPC n√£o s√£o armazenados no S3. Em vez disso, os dados de log capturados s√£o enviados para os logs do CloudWatch**.

Limita√ß√µes:

* Se voc√™ estiver executando uma conex√£o de VPC peering, ent√£o s√≥ poder√° ver os logs de fluxo das VPCs em pares que est√£o dentro da mesma conta.
* Se voc√™ ainda estiver executando recursos dentro do ambiente EC2-Classic, infelizmente n√£o poder√° recuperar informa√ß√µes de suas interfaces.
* Uma vez que um Log de Fluxo da VPC foi criado, ele n√£o pode ser alterado. Para alterar a configura√ß√£o do Log de Fluxo da VPC, voc√™ precisa exclu√≠-lo e depois recriar um novo.
* O seguinte tr√°fego n√£o √© monitorado e capturado pelos logs. Tr√°fego DHCP dentro da VPC, tr√°fego de inst√¢ncias destinado ao Servidor DNS da Amazon.
* Qualquer tr√°fego destinado ao endere√ßo IP do roteador padr√£o da VPC e tr√°fego de e para os seguintes endere√ßos, 169.254.169.254 que √© usado para coletar metadados da inst√¢ncia, e 169.254.169.123 que √© usado para o Servi√ßo de Sincroniza√ß√£o de Tempo da Amazon.
* Tr√°fego relacionado a uma licen√ßa de ativa√ß√£o do Windows da Amazon de uma inst√¢ncia do Windows
* Tr√°fego entre uma interface de balanceador de carga de rede e uma interface de rede de ponto final

Para cada interface de rede que publica dados no grupo de logs do CloudWatch, ser√° usada uma transmiss√£o de log diferente. E dentro de cada uma dessas transmiss√µes, haver√° os dados de evento do log de fluxo que mostram o conte√∫do das entradas de log. Cada um desses **logs captura dados durante uma janela de aproximadamente 10 a 15 minutos**.

## VPN

### Componentes B√°sicos da VPN da AWS

1. **Gateway do Cliente**:
* Um Gateway do Cliente √© um recurso que voc√™ cria na AWS para representar o seu lado de uma conex√£o VPN.
* √â essencialmente um dispositivo f√≠sico ou aplicativo de software em seu lado da conex√£o VPN de Site a Site.
* Voc√™ fornece informa√ß√µes de roteamento e o endere√ßo IP p√∫blico do seu dispositivo de rede (como um roteador ou firewall) para a AWS criar um Gateway do Cliente.
* Ele serve como um ponto de refer√™ncia para configurar a conex√£o VPN e n√£o incorre em custos adicionais.
2. **Gateway Privado Virtual**:
* Um Gateway Privado Virtual (VPG) √© o concentrador VPN no lado da Amazon da conex√£o VPN de Site a Site.
* Ele est√° anexado √† sua VPC e serve como o alvo para sua conex√£o VPN.
* O VPG √© o endpoint do lado da AWS para a conex√£o VPN.
* Ele lida com a comunica√ß√£o segura entre sua VPC e sua rede local.
3. **Conex√£o VPN de Site a Site**:
* Uma conex√£o VPN de Site a Site conecta sua rede local a uma VPC por meio de um t√∫nel VPN IPsec seguro.
* Esse tipo de conex√£o requer um Gateway do Cliente e um Gateway Privado Virtual.
* √â usado para comunica√ß√£o segura, est√°vel e consistente entre seu data center ou rede e seu ambiente AWS.
* Geralmente usado para conex√µes regulares e de longo prazo e √© faturado com base na quantidade de dados transferidos pela conex√£o.
4. **Ponto de Acesso VPN do Cliente**:
* Um ponto de acesso VPN do cliente √© um recurso que voc√™ cria na AWS para permitir e gerenciar sess√µes VPN do cliente.
* √â usado para permitir que dispositivos individuais (como laptops, smartphones, etc.) se conectem de forma segura a recursos da AWS ou √† sua rede local.
* Difere da VPN de Site a Site, pois √© projetado para clientes individuais em vez de conectar redes inteiras.
* Com o VPN do Cliente, cada dispositivo cliente usa um software cliente VPN para estabelecer uma conex√£o segura.

### VPN de Site a Site

**Conecte sua rede local com sua VPC.**

* **Conex√£o VPN**: Uma conex√£o segura entre seu equipamento local e suas VPCs.
*   **T√∫nel VPN**: Um link criptografado onde os dados podem passar da rede do cliente para ou da AWS.

Cada conex√£o VPN inclui dois t√∫neis VPN que voc√™ pode usar simultaneamente para alta disponibilidade.
* **Gateway do cliente**: Um recurso da AWS que fornece informa√ß√µes √† AWS sobre o dispositivo do seu gateway do cliente.
* **Dispositivo do gateway do cliente**: Um dispositivo f√≠sico ou aplicativo de software em seu lado da conex√£o VPN de Site a Site.
* **Gateway privado virtual**: O concentrador VPN no lado da Amazon da conex√£o VPN de Site a Site. Voc√™ usa um gateway privado virtual ou um gateway de tr√¢nsito como o gateway para o lado da Amazon da conex√£o VPN de Site a Site.
* **Gateway de tr√¢nsito**: Um hub de tr√¢nsito que pode ser usado para interconectar suas VPCs e redes locais. Voc√™ usa um gateway de tr√¢nsito ou um gateway privado virtual como o gateway para o lado da Amazon da conex√£o VPN de Site a Site.
#### Limita√ß√µes

* O tr√°fego IPv6 n√£o √© suportado para conex√µes VPN em um gateway privado virtual.
* Uma conex√£o VPN da AWS n√£o suporta a Descoberta de MTU de Caminho.

Al√©m disso, leve em considera√ß√£o o seguinte ao usar VPN de Site a Site.

### VPN do Cliente <a href="#what-is-components" id="what-is-components"></a>

**Conecte-se da sua m√°quina ao seu VPC**

#### Conceitos

* **Endpoint VPN do Cliente:** O recurso que voc√™ cria e configura para habilitar e gerenciar sess√µes de VPN do cliente. √â o recurso onde todas as sess√µes de VPN do cliente s√£o encerradas.
* **Rede de destino:** Uma rede de destino √© a rede que voc√™ associa a um Endpoint VPN do Cliente. **Uma sub-rede de um VPC √© uma rede de destino**. Associar uma sub-rede a um Endpoint VPN do Cliente permite estabelecer sess√µes VPN. Voc√™ pode associar v√°rias sub-redes a um Endpoint VPN do Cliente para alta disponibilidade. Todas as sub-redes devem ser do mesmo VPC. Cada sub-rede deve pertencer a uma Zona de Disponibilidade diferente.
* **Rota:** Cada Endpoint VPN do Cliente tem uma tabela de roteamento que descreve as rotas de rede de destino dispon√≠veis. Cada rota na tabela de roteamento especifica o caminho para o tr√°fego para recursos ou redes espec√≠ficas.
* **Regras de autoriza√ß√£o:** Uma regra de autoriza√ß√£o **restringe os usu√°rios que podem acessar uma rede**. Para uma rede espec√≠fica, voc√™ configura o grupo do Active Directory ou provedor de identidade (IdP) que tem permiss√£o de acesso. Apenas usu√°rios pertencentes a esse grupo podem acessar a rede especificada. **Por padr√£o, n√£o existem regras de autoriza√ß√£o** e voc√™ deve configurar regras de autoriza√ß√£o para permitir que os usu√°rios acessem recursos e redes.
* **Cliente:** O usu√°rio final que se conecta ao Endpoint VPN do Cliente para estabelecer uma sess√£o de VPN. Os usu√°rios finais precisam baixar um cliente OpenVPN e usar o arquivo de configura√ß√£o do Endpoint VPN do Cliente que voc√™ criou para estabelecer uma sess√£o de VPN.
* **Intervalo de CIDR do Cliente:** Um intervalo de endere√ßos IP dos quais atribuir endere√ßos IP de cliente. Cada conex√£o ao Endpoint VPN do Cliente √© atribu√≠da um endere√ßo IP √∫nico do intervalo de CIDR do cliente. Voc√™ escolhe o intervalo de CIDR do cliente, por exemplo, `10.2.0.0/16`.
* **Portas do Cliente VPN:** O Cliente VPN da AWS suporta as portas 443 e 1194 para TCP e UDP. O padr√£o √© a porta 443.
* **Interfaces de rede do Cliente VPN:** Quando voc√™ associa uma sub-rede ao seu Endpoint VPN do Cliente, criamos interfaces de rede do Cliente VPN naquela sub-rede. **O tr√°fego enviado para o VPC a partir do Endpoint VPN do Cliente √© enviado por meio de uma interface de rede do Cliente VPN**. Em seguida, √© aplicada a tradu√ß√£o de endere√ßo de origem da rede (SNAT), onde o endere√ßo IP de origem do intervalo de CIDR do cliente √© traduzido para o endere√ßo IP da interface de rede do Cliente VPN.
* **Registro de conex√£o:** Voc√™ pode habilitar o registro de conex√£o para o seu Endpoint VPN do Cliente para registrar eventos de conex√£o. Voc√™ pode usar essas informa√ß√µes para executar an√°lises forenses, analisar como seu Endpoint VPN do Cliente est√° sendo usado ou depurar problemas de conex√£o.
* **Portal de autoatendimento:** Voc√™ pode habilitar um portal de autoatendimento para o seu Endpoint VPN do Cliente. Os clientes podem fazer login no portal baseado na web usando suas credenciais e baixar a vers√£o mais recente do arquivo de configura√ß√£o do Endpoint VPN do Cliente, ou a vers√£o mais recente do cliente fornecido pela AWS.

#### Limita√ß√µes

* **Os intervalos de CIDR do Cliente n√£o podem se sobrepor com o CIDR local** do VPC no qual a sub-rede associada est√° localizada, ou quaisquer rotas adicionadas manualmente √† tabela de roteamento do Endpoint VPN do Cliente.
* Os intervalos de CIDR do Cliente devem ter um tamanho de bloco de pelo menos **/22** e n√£o devem ser maiores que **/12**.
* **Uma parte dos endere√ßos** no intervalo de CIDR do cliente √© usada para **suportar o modelo de disponibilidade** do Endpoint VPN do Cliente e n√£o pode ser atribu√≠da aos clientes. Portanto, recomendamos que voc√™ **atribua um bloco CIDR que contenha o dobro do n√∫mero de endere√ßos IP necess√°rios** para habilitar o n√∫mero m√°ximo de conex√µes simult√¢neas que voc√™ planeja suportar no Endpoint VPN do Cliente.
* O **intervalo de CIDR do cliente n√£o pode ser alterado** ap√≥s a cria√ß√£o do Endpoint VPN do Cliente.
* As **sub-redes** associadas a um Endpoint VPN do Cliente **devem estar no mesmo VPC**.
* Voc√™ **n√£o pode associar v√°rias sub-redes da mesma Zona de Disponibilidade a um Endpoint VPN do Cliente**.
* Um Endpoint VPN do Cliente **n√£o suporta associa√ß√µes de sub-redes em um VPC de loca√ß√£o dedicada**.
* O Cliente VPN suporta apenas tr√°fego **IPv4**.
* O Cliente VPN n√£o √© compat√≠vel com o padr√£o Federal de Processamento de Informa√ß√µes (**FIPS**).
*   Se a autentica√ß√£o de v√°rios fatores (MFA) estiver desativada para o seu Active Directory, a senha do usu√°rio n√£o pode estar no seguinte formato.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* O portal de autoatendimento **n√£o est√° dispon√≠vel para clientes que se autenticam usando autentica√ß√£o m√∫tua**.
