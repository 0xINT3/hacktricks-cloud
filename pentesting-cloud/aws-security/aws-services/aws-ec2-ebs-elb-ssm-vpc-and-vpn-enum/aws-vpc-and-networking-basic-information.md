# AWS - VPC & 网络基本信息

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## AWS网络简介

**VPC** 包含类似 10.0.0.0/16 的 **网络CIDR**（具有其 **路由表** 和 **网络ACL**）。

这个 VPC 网络被划分为 **子网**，因此 **子网** 与 **VPC**、**路由表** 和 **网络ACL** 直接相关。

然后，附加到服务（如EC2实例）的 **网络接口** 与 **子网** 使用的 **安全组** 相连接。

因此，**安全组** 将限制 **使用它的网络接口** 的暴露端口，**与子网无关**。而 **网络ACL** 将限制对 **整个网络** 的暴露端口。

此外，为了 **访问互联网**，有一些有趣的配置需要检查：

* **子网** 可以 **自动分配公共IPv4地址**
* 在网络中创建的 **实例** 可以获得一个 **自动分配的IPv4地址**
* 需要将 **Internet网关** 附加到 **VPC**
* 您还可以使用 **仅出口互联网网关**
* 您还可以在 **私有子网** 中拥有一个 **NAT网关**，以便从该私有子网 **连接到外部服务**，但 **无法从外部访问它们**。
* NAT网关可以是 **公共的**（访问互联网）或 **私有的**（访问其他VPC）

![](<../../../../.gitbook/assets/image (274).png>)

## VPC

Amazon **虚拟私有云**（Amazon VPC）使您能够将AWS资源启动到您定义的虚拟网络中。这个虚拟网络将有多个子网、用于访问互联网的Internet网关、ACL、安全组、IP等...

### 子网

子网有助于实施更高级别的安全性。**类似资源的逻辑分组** 还帮助您在基础架构中保持**管理的便捷性**。

* 有效的CIDR范围从/16掩码到/28掩码。
* 一个子网不能同时位于不同的可用区。
* **AWS保留每个子网的前三个主机IP地址** 用于 **AWS内部使用**：第一个主机地址用于VPC路由器。第二个地址保留给AWS DNS，第三个地址保留供将来使用。
* **直接访问互联网的子网称为公共子网，而私有子网则不是。**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### 路由表

路由表确定VPC内子网的流量路由。它们确定将哪些网络流量转发到互联网或VPN连接。通常会访问以下内容：

* 本地VPC
* NAT
* 互联网网关/仅出口互联网网关（为VPC提供访问互联网所需）
* 要使子网公开，您需要 **创建** 并 **附加** 一个 **Internet网关** 到您的VPC。
* VPC端点（用于从私有网络访问S3）

在以下图片中，您可以查看默认公共网络和私有网络之间的区别：

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**网络访问控制列表（ACLs）**：网络ACL是控制子网内传入和传出网络流量的防火墙规则。它们可用于允许或拒绝对特定IP地址或范围的流量。

* 使用安全组允许/拒绝访问是最常见的方式，但这只是完全切断已建立的反向shell的一种方法。在安全组中修改规则不会停止已建立的连接
* 但是，这适用于整个子网，禁止某些内容时要小心，因为可能会干扰所需的功能
### 安全组

安全组是一个虚拟**防火墙**，用于控制VPC中实例的入站和出站网络**流量**。通常情况下，一个安全组对应多个实例（通常是1对1）。

通常用于打开实例中的危险端口，比如端口22：

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### 弹性 IP 地址

弹性 IP 地址是专为动态云计算设计的**静态 IPv4 地址**。弹性 IP 地址分配给您的 AWS 帐户，直到您释放它为止。通过使用弹性 IP 地址，您可以通过将地址快速重新映射到您帐户中的另一个实例来掩盖实例或软件的故障。

### 子网之间的连接

默认情况下，所有子网都**关闭了自动分配公共 IP 地址**，但可以打开。

**路由表中的本地路由**可以实现 VPC 子网之间的通信。

如果您**连接一个子网到另一个子网，您无法访问**与另一个子网连接的子网，您需要直接与它们创建连接。**这也适用于互联网网关**。您不能通过子网连接访问互联网，您需要将互联网网关分配给您的子网。

### VPC 对等连接

VPC 对等连接允许您使用 IPV4 或 IPV6 **将两个或多个 VPC 连接在一起**，就好像它们是同一网络的一部分一样。

一旦建立了对等连接，**一个 VPC 中的资源可以访问另一个 VPC 中的资源**。VPC 之间的连接是通过现有的 AWS 网络基础设施实现的，因此具有高可用性且没有带宽瓶颈。由于**对等连接操作就像它们是同一网络的一部分**，因此在使用 CIDR 块范围时存在限制。

如果您的 VPC 具有**重叠或重复的 CIDR** 范围，则**无法对等连接这些 VPC**。每个 AWS VPC **只能与其对等**。例如，如果在 VPC 1 和 VPC 2 之间建立了对等连接，并且在 VPC 2 和 VPC 3 之间建立了另一个连接，那么 VPC 1 和 2 可以直接通信，VPC 2 和 3 也可以，但是 VPC 1 和 3 不能。**您不能通过一个 VPC 路由到另一个 VPC**。

### **VPC 流日志**

在您的 VPC 中，您可能有数百甚至数千个资源之间在不同子网之间（公共和私有）以及通过 VPC 对等连接之间进行通信。**VPC 流日志允许您捕获在您的 VPC 中的资源的网络接口之间流动的 IP 流量信息**。

与 S3 访问日志和 CloudFront 访问日志不同，**VPC 流日志生成的日志数据不存储在 S3 中。捕获的日志数据发送到 CloudWatch 日志**。

限制：

* 如果您正在运行 VPC 对等连接，则只能查看同一帐户中的对等 VPC 的流日志。
* 如果您仍在 EC2-Classic 环境中运行资源，则很遗憾，您无法从其接口中检索信息。
* 一旦创建了 VPC 流日志，就无法更改。要更改 VPC 流日志配置，您需要删除它，然后重新创建一个新的。
* 以下流量不受日志监视和捕获。VPC 内的 DHCP 流量，发送到亚马逊 DNS 服务器的实例流量。
* 发送到 VPC 默认路由器 IP 地址的流量以及与以下地址之间的流量，169.254.169.254 用于收集实例元数据，169.254.169.123 用于亚马逊时间同步服务。
* 来自 Windows 实例的 Amazon Windows 激活许可流量
* 网络负载均衡器接口与端点网络接口之间的流量

对于每个发布数据到 CloudWatch 日志组的网络接口，将使用不同的日志流。在每个流中，将显示显示日志条目内容的流日志事件数据。每个**日志在大约 10 到 15 分钟的时间窗口内捕获数据**。

## VPN

### 基本 AWS VPN 组件

1. **客户网关**：
* 客户网关是您在 AWS 中创建的资源，用于代表 VPN 连接的您一侧。
* 它本质上是 Site-to-Site VPN 连接一侧的物理设备或软件应用程序。
* 您提供路由信息和您网络设备（如路由器或防火墙）的公共 IP 地址给 AWS 以创建客户网关。
* 它用作设置 VPN 连接的参考点，不会产生额外费用。
2. **虚拟专用网关**：
* 虚拟专用网关（VPG）是 Site-to-Site VPN 连接 Amazon 一侧的 VPN 集中器。
* 它附加到您的 VPC，并用作 VPN 连接的目标。
* VPG 是 VPN 连接的 AWS 侧端点。
* 它处理您的 VPC 和您本地网络之间的安全通信。
3. **站点到站点 VPN 连接**：
* 站点到站点 VPN 连接通过安全的 IPsec VPN 隧道将您的本地网络连接到 VPC。
* 这种类型的连接需要客户网关和虚拟专用网关。
* 用于在数据中心或网络与 AWS 环境之间进行安全、稳定和一致的通信。
* 通常用于常规、长期连接，并根据连接传输的数据量计费。
4. **客户 VPN 端点**：
* 客户 VPN 端点是您在 AWS 中创建的资源，用于启用和管理客户 VPN 会话。
* 用于允许个别设备（如笔记本电脑、智能手机等）安全连接到 AWS 资源或您的本地网络。
* 与站点到站点 VPN 不同，它设计用于个别客户而不是连接整个网络。
* 使用客户 VPN，每个客户设备使用 VPN 客户端软件建立安全连接。

### 站点到站点 VPN

**将您的本地网络与您的 VPC 连接起来。**

* **VPN 连接**：您的本地设备与您的 VPC 之间的安全连接。
* **VPN 隧道**：数据可以在客户网络和 AWS 之间传递的加密链接。

每个 VPN 连接包括两个 VPN 隧道，您可以同时使用这两个隧道以实现高可用性。
* **客户网关**：向 AWS 提供关于您客户网关设备的信息的 AWS 资源。
* **客户网关设备**：Site-to-Site VPN 连接一侧的物理设备或软件应用程序。
* **虚拟专用网关**：Site-to-Site VPN 连接 Amazon 一侧的 VPN 集中器。您可以使用虚拟专用网关或中转网关作为 Site-to-Site VPN 连接 Amazon 一侧的网关。
* **中转网关**：可用于互连您的 VPC 和本地网络的中转中心。您可以使用中转网关或虚拟专用网关作为 Site-to-Site VPN 连接 Amazon 一侧的网关。
#### 限制

* VPN连接的IPv6流量不受虚拟私有网关支持。
* AWS VPN连接不支持路径MTU发现。

此外，在使用站点到站点VPN时，请考虑以下内容。

### 客户端VPN <a href="#what-is-components" id="what-is-components"></a>

**从您的计算机连接到您的VPC**

#### 概念

* **客户端VPN端点：**您创建和配置的资源，用于启用和管理客户端VPN会话。这是所有客户端VPN会话终止的资源。
* **目标网络：**目标网络是您与客户端VPN端点关联的网络。**来自VPC的子网是目标网络**。将子网与客户端VPN端点关联可让您建立VPN会话。您可以将多个子网与客户端VPN端点关联以实现高可用性。所有子网必须来自同一VPC。每个子网必须属于不同的可用区。
* **路由：**每个客户端VPN端点都有一个描述可用目标网络路由的路由表。路由表中的每条路由指定了特定资源或网络的流量路径。
* **授权规则：**授权规则**限制可以访问网络的用户**。对于指定的网络，您配置允许访问的Active Directory或身份提供者（IdP）组。只有属于此组的用户才能访问指定网络。**默认情况下，没有授权规则**，您必须配置授权规则以使用户能够访问资源和网络。
* **客户端：**连接到客户端VPN端点以建立VPN会话的最终用户。最终用户需要下载一个OpenVPN客户端，并使用您创建的客户端VPN配置文件来建立VPN会话。
* **客户端CIDR范围：**用于分配客户端IP地址的IP地址范围。连接到客户端VPN端点的每个连接都从客户端CIDR范围分配一个唯一的IP地址。您可以选择客户端CIDR范围，例如`10.2.0.0/16`。
* **客户端VPN端口：**AWS客户端VPN支持端口443和1194，支持TCP和UDP。默认端口为443。
* **客户端VPN网络接口：**当您将子网与客户端VPN端点关联时，我们会在该子网中创建客户端VPN网络接口。**从客户端VPN端点发送到VPC的流量将通过客户端VPN网络接口发送**。然后应用源网络地址转换（SNAT），其中来自客户端CIDR范围的源IP地址将转换为客户端VPN网络接口的IP地址。
* **连接日志记录：**您可以为客户端VPN端点启用连接日志记录以记录连接事件。您可以使用此信息来进行取证、分析客户端VPN端点的使用情况，或调试连接问题。
* **自助服务门户：**您可以为客户端VPN端点启用自助服务门户。客户可以使用他们的凭据登录到基于Web的门户，并下载客户端VPN端点配置文件的最新版本，或AWS提供的客户端的最新版本。

#### 限制

* **客户端CIDR范围不能与关联子网所在的VPC的本地CIDR重叠**，也不能与手动添加到客户端VPN端点路由表的任何路由重叠。
* 客户端CIDR范围的块大小必须至少为**/22**，且**不能大于/12**。
* 客户端CIDR范围中的**一部分地址**用于支持客户端VPN端点的可用性模型，并且不能分配给客户端。因此，我们建议您**分配一个包含所需IP地址数量两倍的CIDR块**，以启用您计划在客户端VPN端点上支持的最大并发连接数。
* **客户端CIDR范围创建后无法更改**。
* 与客户端VPN端点关联的**子网必须位于同一VPC**中。
* **不能将同一可用区中的多个子网与客户端VPN端点关联**。
* 客户端VPN端点**不支持专用租户VPC中的子网关联**。
* 客户端VPN仅支持**IPv4**流量。
* 客户端VPN**不符合**联邦信息处理标准（**FIPS**）。
* 如果为您的Active Directory禁用了多因素身份验证（MFA），用户密码不能采用以下格式。

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* 自助服务门户**不适用于使用相互身份验证进行身份验证的客户端**。
