# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## VPC & R√©seau

Apprenez ce qu'est un VPC et ses composants dans :

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 est utilis√© pour lancer des **serveurs virtuels**. Il permet la configuration de la **s√©curit√©** et du **r√©seau** et la gestion du **stockage**. La flexibilit√© d'Amazon EC2 est √©vidente dans sa capacit√© √† mettre √† l'√©chelle les ressources √† la fois vers le haut et vers le bas, s'adaptant efficacement aux changements de besoins variables ou aux pics de popularit√©. Cette fonctionnalit√© r√©duit la n√©cessit√© de pr√©visions de trafic pr√©cises.

Choses int√©ressantes √† √©num√©rer dans EC2 :

* Machines virtuelles
* Cl√©s SSH
* Donn√©es utilisateur
* EC2/AMIs/Snapshots existants
* R√©seau
* R√©seaux
* Sous-r√©seaux
* Adresses IP publiques
* Ports ouverts
* Connexions int√©gr√©es avec d'autres r√©seaux en dehors d'AWS

### Profils d'instance

L'utilisation de **r√¥les** pour accorder des autorisations aux applications s'ex√©cutant sur des **instances EC2** n√©cessite une configuration suppl√©mentaire. Une application s'ex√©cutant sur une instance EC2 est abstraite d'AWS par le syst√®me d'exploitation virtualis√©. En raison de cette s√©paration suppl√©mentaire, vous avez besoin d'une √©tape suppl√©mentaire pour attribuer un r√¥le AWS et ses autorisations associ√©es √† une instance EC2 et les rendre disponibles pour ses applications.

Cette √©tape suppl√©mentaire est la **cr√©ation d'un** [_**profil d'instance**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) attach√© √† l'instance. Le **profil d'instance contient le r√¥le et** peut fournir les informations d'identification temporaires du r√¥le √† une application s'ex√©cutant sur l'instance. Ces informations d'identification temporaires peuvent ensuite √™tre utilis√©es dans les appels API de l'application pour acc√©der aux ressources et limiter l'acc√®s uniquement aux ressources sp√©cifi√©es par le r√¥le. Notez que **un seul r√¥le peut √™tre attribu√© √† une instance EC2** √† la fois, et toutes les applications sur l'instance partagent le m√™me r√¥le et les m√™mes autorisations.

### Point de terminaison de m√©tadonn√©es

Les m√©tadonn√©es AWS EC2 sont des informations sur une instance Amazon Elastic Compute Cloud (EC2) disponibles pour l'instance en cours d'ex√©cution. Ces m√©tadonn√©es sont utilis√©es pour fournir des informations sur l'instance, telles que son ID d'instance, la zone de disponibilit√© dans laquelle elle s'ex√©cute, le r√¥le IAM associ√© √† l'instance et le nom d'h√¥te de l'instance.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### √ânum√©ration
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Acc√®s non authentifi√©

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### √âl√©vation de privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations EC2 pour escalader les privil√®ges** :

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Les **instantan√©s EBS** (Elastic Block Store) d'Amazon sont essentiellement des **sauvegardes statiques** des volumes AWS EBS. En d'autres termes, ce sont des **copies** des **disques** attach√©s √† une **instance EC2** √† un moment pr√©cis. Les instantan√©s EBS peuvent √™tre copi√©s entre r√©gions et comptes, voire t√©l√©charg√©s et ex√©cut√©s localement.

Les instantan√©s peuvent contenir des **informations sensibles** telles que du **code source ou des cl√©s API**, il est donc recommand√© de les v√©rifier si vous en avez l'occasion.

### Diff√©rence entre AMI et EBS

Une **AMI** est utilis√©e pour **lancer une instance EC2**, tandis qu'un **instantan√© EC2** est utilis√© pour **sauvegarder et r√©cup√©rer des donn√©es stock√©es sur un volume EBS**. Bien qu'un instantan√© EC2 puisse √™tre utilis√© pour cr√©er une nouvelle AMI, ce n'est pas la m√™me chose qu'une AMI, et il ne contient pas d'informations sur le syst√®me d'exploitation, le serveur d'applications ou d'autres logiciels n√©cessaires pour ex√©cuter une application.

### √âl√©vation de privil√®ges

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations EBS pour escalader les privil√®ges** :

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** permet de g√©rer √† distance des flottes d'instances EC2 pour faciliter leur administration. Chacune de ces instances doit ex√©cuter le **service SSM Agent car c'est lui qui recevra les actions et les ex√©cutera** √† partir de l'API AWS.

**SSM Agent** permet √† Systems Manager de mettre √† jour, g√©rer et configurer ces ressources. L'agent **traite les demandes du service Systems Manager dans le Cloud AWS**, puis les ex√©cute comme sp√©cifi√© dans la demande.

Le **SSM Agent est** [**pr√©install√© dans certaines AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) ou vous devez [**l'installer manuellement**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) sur les instances. De plus, le r√¥le IAM utilis√© √† l'int√©rieur de l'instance doit avoir la politique **AmazonEC2RoleforSSM** attach√©e pour pouvoir communiquer.

### √ânum√©ration
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Vous pouvez v√©rifier dans une instance EC2 si Systems Manager est en cours d'ex√©cution en ex√©cutant :
```bash
ps aux | grep amazon-ssm
```
### Privesc

Sur la page suivante, vous pouvez v√©rifier comment **abuser des autorisations SSM pour escalader les privil√®ges**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) est un **service d'√©quilibrage de charge pour les d√©ploiements Amazon Web Services** (AWS). ELB distribue automatiquement **le trafic d'application entrant** et ajuste les ressources pour r√©pondre aux demandes de trafic.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Mod√®les de lancement & Groupes de mise √† l'√©chelle automatique

### √ânum√©ration

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro



## VPN

Un VPN permet de connecter votre **r√©seau sur site (VPN site √† site)** ou les **ordinateurs portables des employ√©s (VPN client)** avec un **VPC AWS** afin que les services puissent √™tre accessibles sans avoir besoin de les exposer √† Internet.

#### Composants de base d'un VPN AWS

1. **Passerelle client**:
* Une passerelle client est une ressource que vous cr√©ez dans AWS pour repr√©senter votre c√¥t√© d'une connexion VPN.
* Il s'agit essentiellement d'un appareil physique ou d'une application logicielle de votre c√¥t√© de la connexion VPN site √† site.
* Vous fournissez des informations de routage et l'adresse IP publique de votre appareil r√©seau (tel qu'un routeur ou un pare-feu) √† AWS pour cr√©er une passerelle client.
* Elle sert de point de r√©f√©rence pour la configuration de la connexion VPN et n'entra√Æne pas de frais suppl√©mentaires.
2. **Passerelle priv√©e virtuelle**:
* Une passerelle priv√©e virtuelle (VPG) est le concentrateur VPN du c√¥t√© Amazon de la connexion VPN site √† site.
* Elle est attach√©e √† votre VPC et sert de cible pour votre connexion VPN.
* La VPG est le point de terminaison c√¥t√© AWS pour la connexion VPN.
* Elle g√®re la communication s√©curis√©e entre votre VPC et votre r√©seau sur site.
3. **Connexion VPN site √† site**:
* Une connexion VPN site √† site connecte votre r√©seau sur site √† un VPC via un tunnel VPN IPsec s√©curis√©.
* Ce type de connexion n√©cessite une passerelle client et une passerelle priv√©e virtuelle.
* Elle est utilis√©e pour une communication s√©curis√©e, stable et coh√©rente entre votre centre de donn√©es ou r√©seau et votre environnement AWS.
* G√©n√©ralement utilis√©e pour des connexions r√©guli√®res et √† long terme, elle est factur√©e en fonction de la quantit√© de donn√©es transf√©r√©es sur la connexion.
4. **Point de terminaison VPN client**:
* Un point de terminaison VPN client est une ressource que vous cr√©ez dans AWS pour activer et g√©rer des sessions VPN client.
* Il est utilis√© pour permettre √† des appareils individuels (comme des ordinateurs portables, des smartphones, etc.) de se connecter de mani√®re s√©curis√©e aux ressources AWS ou √† votre r√©seau sur site.
* Il diff√®re du VPN site √† site en ce qu'il est con√ßu pour des clients individuels plut√¥t que pour connecter des r√©seaux entiers.
* Avec le VPN client, chaque appareil client utilise un logiciel client VPN pour √©tablir une connexion s√©curis√©e.

Vous pouvez [**trouver plus d'informations sur les avantages et les composants des VPN AWS ici**](aws-vpc-and-networking-basic-information.md#vpn).

### √ânum√©ration
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### √ânum√©ration Locale

**Credentials Temporaires Locales**

Lorsque le client VPN AWS est utilis√© pour se connecter √† un VPN, l'utilisateur se connectera g√©n√©ralement √† AWS pour acc√©der au VPN. Ensuite, certaines **informations d'identification AWS sont cr√©√©es et stock√©es** localement pour √©tablir la connexion VPN. Ces informations d'identification sont **stock√©es dans** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` et contiennent une **Cl√© d'Acc√®s**, une **Cl√© Secr√®te** et un **Jeton**.

Les informations d'identification appartiennent √† l'utilisateur `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: rechercher davantage sur les autorisations de ces informations d'identification).

**Fichiers de configuration opvn**

Si une **connexion VPN a √©t√© √©tablie**, vous devriez rechercher des fichiers de configuration **`.opvn`** dans le syst√®me. De plus, un endroit o√π vous pourriez trouver les **configurations** est dans **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post Exploitation**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
