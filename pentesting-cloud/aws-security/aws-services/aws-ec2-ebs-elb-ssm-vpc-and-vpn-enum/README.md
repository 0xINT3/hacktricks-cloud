# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## VPC ve Ağ

VPC'nin ne olduğunu ve bileşenlerini öğrenin:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2, **sanal sunucuların başlatılması** için kullanılır. **Güvenlik** ve **ağ yapılandırması**nın yanı sıra **depolama**nın yönetimine olanak tanır. Amazon EC2'nin esnekliği, kaynakları yukarı ve aşağı doğru ölçeklendirebilme yeteneğiyle açıkça ortaya çıkar ve böylece değişen gereksinim değişikliklerine veya popülerlik artışlarına etkili bir şekilde uyum sağlar. Bu özellik, kesin trafik tahminlerine olan gereksinimi azaltır.

EC2'de sorgulanacak ilginç şeyler:

* Sanal Makinler
* SSH Anahtarları
* Kullanıcı Verileri
* Mevcut EC2'ler/AMI'ler/Snapshot'lar
* Ağ
* Ağlar
* Alt Ağlar
* Genel IP'ler
* Açık portlar
* AWS dışındaki diğer ağlarla entegre bağlantılar

### Örnek Profiller

**EC2 örneklerinde çalışan uygulamalara izin vermek için roller** kullanmak, biraz ek yapılandırma gerektirir. EC2 örneğinde çalışan bir uygulama, sanallaştırılmış işletim sistemi tarafından AWS'den soyutlanır. Bu ek ayrım nedeniyle, bir EC2 örneğine bir AWS rolü ve ilişkili izinlerini atamak ve bunları uygulamalarına kullanılabilir hale getirmek için ek bir adım gereklidir.

Bu ek adım, örneğe bağlı olan bir [_**örnek profili**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html)'nin oluşturulmasıdır. **Örnek profili, rolü içerir** ve rolün geçici kimlik bilgilerini örnekte çalışan bir uygulamaya sağlayabilir. Bu geçici kimlik bilgileri, uygulamanın API çağrılarında kaynaklara erişmek ve rolün belirttiği yalnızca bu kaynaklara erişimi sınırlamak için kullanılabilir. Unutmayın ki **bir EC2 örneğine yalnızca bir rol atanabilir** ve örnekteki tüm uygulamalar aynı rolü ve izinleri paylaşır.

### Meta Veri Uç Noktası

AWS EC2 meta verileri, çalışma zamanında bir Amazon Elastic Compute Cloud (EC2) örneğine sağlanan bilgilerdir. Bu meta veriler, örnekle ilgili bilgileri sağlamak için kullanılır, örneğin örnek kimliği, çalıştığı kullanılabilir bölge, örneğe ilişkili IAM rolü ve örneğin ana bilgisayar adı gibi.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Sorgulama
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Kimlik Doğrulama Gerektirmeyen Erişim

Aşağıdaki sayfada, **EC2 izinlerini kötüye kullanarak ayrıcalıkları yükseltmek** için nasıl yapılacağını kontrol edebilirsiniz:

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Ayrıcalık Yükseltme

Aşağıdaki sayfada, **EBS izinlerini kötüye kullanarak ayrıcalıkları yükseltmek** için nasıl yapılacağını kontrol edebilirsiniz:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Saldırı Sonrası

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshotları**, temel olarak AWS EBS birimlerine bağlı olan disklerin belirli bir zamandaki **kopyaları** olan statik **yedeklemelerdir**. EBS snapshotları, bölgeler ve hesaplar arasında kopyalanabilir veya indirilerek yerel olarak çalıştırılabilir.

Snapshotlar, **kaynak kodu veya API anahtarları gibi hassas bilgileri** içerebilir, bu nedenle şansınız varsa kontrol etmeniz önerilir.

### AMI ve EBS Arasındaki Fark

Bir **AMI**, bir EC2 örneğini başlatmak için kullanılırken, bir EC2 **Snapshot**, bir EBS biriminde depolanan verileri yedeklemek ve kurtarmak için kullanılır. Bir EC2 Snapshot, yeni bir AMI oluşturmak için kullanılabilir, ancak bir AMI ile aynı şey değildir ve işletim sistemi, uygulama sunucusu veya bir uygulamayı çalıştırmak için gereken diğer yazılımlar hakkında bilgi içermez.

### Ayrıcalık Yükseltme

Aşağıdaki sayfada, **EBS izinlerini kötüye kullanarak ayrıcalıkları yükseltmek** için nasıl yapılacağını kontrol edebilirsiniz:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)**, EC2 örneklerinin uzaktan yönetilmesine olanak sağlar ve yönetimlerini çok daha kolay hale getirir. Bu örneklerin her biri, eylemleri alacak ve bunları AWS API'sinden gerçekleştirecek olan **SSM Agent hizmetini çalıştırmalıdır**.

**SSM Agent**, Sistem Yöneticisinin bu kaynakları güncellemesini, yönetmesini ve yapılandırmasını sağlar. Ajan, AWS Bulutunda Sistem Yöneticisi hizmetinden gelen istekleri işler ve ardından istekte belirtildiği gibi çalıştırır.

**SSM Agent**, bazı AMI'lerde [**önceden yüklenmiş olarak gelir**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) veya örneklerde [**manuel olarak yüklenmesi gerekir**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html). Ayrıca, örnek içinde kullanılan IAM Rolünün iletişim kurabilmesi için **AmazonEC2RoleforSSM** politikasının eklenmiş olması gerekir.

### Numaralandırma
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Bir EC2 örneğinde Sistem Yöneticisi'nin çalışıp çalışmadığını kontrol etmek için sadece aşağıdaki komutu çalıştırabilirsiniz:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Aşağıdaki sayfada, **ayrıcalıkları yükseltmek için SSM izinlerini kötüye kullanma** yöntemlerini kontrol edebilirsiniz:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

SSM mesajı ele geçirme gibi teknikler, SSM son işleme sayfasında bulunabilir:

{% content-ref url="broken-reference" %}
[Bozuk bağlantı](broken-reference)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB), Amazon Web Services (AWS) dağıtımları için bir **yük dengeleme hizmetidir**. ELB otomatik olarak **gelen uygulama trafiğini dağıtır** ve kaynakları trafiğin taleplerini karşılamak için ölçeklendirir.

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Başlatma Şablonları ve Otomatik Ölçeklendirme Grupları

### Saptama

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

Bir VPN, **on-premise ağınızı (site-to-site VPN)** veya **çalışan dizüstü bilgisayarları (Client VPN)** bir **AWS VPC** ile bağlantı kurmanıza olanak tanır, böylece hizmetlere internete maruz kalmadan erişilebilir.

### Temel AWS VPN Bileşenleri

1. **Müşteri Ağ Geçidi**:
* Bir Müşteri Ağ Geçidi, bir VPN bağlantısının tarafınızı temsil etmek için AWS'de oluşturduğunuz bir kaynaktır.
* Temelde, Site-to-Site VPN bağlantısının tarafınızda bulunan bir fiziksel cihaz veya yazılım uygulamasıdır.
* Yönlendirme bilgilerini ve ağ cihazınızın (router veya güvenlik duvarı gibi) genel IP adresini AWS'ye sağlayarak bir Müşteri Ağ Geçidi oluşturursunuz.
* VPN bağlantısını kurmak için bir referans noktası olarak hizmet verir ve ek ücretlendirme yapmaz.
2. **Sanal Özel Ağ Geçidi**:
* Sanal Özel Ağ Geçidi (VPG), Site-to-Site VPN bağlantısının Amazon tarafındaki VPN konsantratörüdür.
* VPC'nize bağlıdır ve VPN bağlantınızın hedefi olarak hizmet verir.
* VPG, VPN bağlantısı için AWS tarafı uç noktasıdır.
* VPC'niz ile on-premise ağınız arasındaki güvenli iletişimi yönetir.
3. **Site-to-Site VPN Bağlantısı**:
* Site-to-Site VPN bağlantısı, güvenli, IPsec VPN tüneli aracılığıyla on-premise ağınızı bir VPC'ye bağlar.
* Bu tür bir bağlantı için bir Müşteri Ağ Geçidi ve bir Sanal Özel Ağ Geçidi gereklidir.
* Veri merkeziniz veya ağınız ile AWS ortamınız arasında güvenli, istikrarlı ve tutarlı iletişim için kullanılır.
* Genellikle düzenli, uzun vadeli bağlantılar için kullanılır ve bağlantı üzerinden aktarılan veri miktarına göre faturalandırılır.
4. **Client VPN Uç Noktası**:
* Bir Client VPN uç noktası, AWS'de müşteri VPN oturumlarını etkinleştirmek ve yönetmek için oluşturduğunuz bir kaynaktır.
* Bireysel cihazların (dizüstü bilgisayarlar, akıllı telefonlar vb.) AWS kaynaklarına veya on-premise ağınıza güvenli bir şekilde bağlanmasına izin vermek için kullanılır.
* Site-to-Site VPN'den farklı olarak, tüm ağları bağlamak yerine bireysel istemcilere yönelik olarak tasarlanmıştır.
* Client VPN ile her istemci cihazı, güvenli bir bağlantı kurmak için bir VPN istemci yazılımı kullanır.

[**AWS VPN'lerinin faydaları ve bileşenleri hakkında daha fazla bilgiye buradan ulaşabilirsiniz**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn).&#x20;

Post E

### Enumerasyon
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Yerel Saptama

#### Yerel Geçici Kimlik Bilgileri

AWS VPN İstemcisi bir VPN'ye bağlanmak için kullanıldığında, kullanıcı genellikle VPN'ye erişim sağlamak için AWS'ye giriş yapar. Ardından, VPN bağlantısını kurmak için yerel olarak saklanan bazı AWS kimlik bilgileri oluşturulur ve depolanır. Bu kimlik bilgileri, `$HOME/.config/AWSVPNClient/TemporaryCredentials/<bölge>/temporary-credentials.txt` içinde depolanır ve bir **Erişim Anahtarı**, bir **Gizli Anahtar** ve bir **Token** içerir.

Kimlik bilgileri, kullanıcıya aittir: `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: Bu kimlik bilgilerinin izinleri hakkında daha fazla araştırma yapın).

#### opvn yapılandırma dosyaları

Eğer bir **VPN bağlantısı kurulduysa**, sistemde **`.opvn`** yapılandırma dosyalarını aramalısınız. Ayrıca, **yapılandırmaları** bulabileceğiniz bir yer, **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`** dizinidir.

### **Saldırı Sonrası**

{% content-ref url="../../aws-saldırı-sonrası/aws-vpn-saldırı-sonrası.md" %}
[aws-vpn-saldırı-sonrası.md](../../aws-saldırı-sonrası/aws-vpn-saldırı-sonrası.md)
{% endcontent-ref %}

# Referanslar
* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ile sıfırdan kahraman olmak için AWS hackleme öğrenin</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github depolarına **PR göndererek paylaşın**.

</details>
