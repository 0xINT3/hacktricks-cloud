# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## VPC 및 네트워킹

VPC가 무엇인지 및 그 구성 요소에 대해 알아보세요:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2는 **가상 서버**를 시작하는 데 사용됩니다. 이를 통해 **보안** 및 **네트워킹** 구성 및 **스토리지** 관리가 가능합니다. Amazon EC2의 유연성은 자원을 상향 및 하향으로 확장하여 다양한 요구 사항 변경이나 인기 폭증에 효과적으로 대응할 수 있다는 점에서 나타납니다. 이 기능은 정확한 트래픽 예측의 필요성을 줄입니다.

EC2에서 열거할 수 있는 흥미로운 사항:

* 가상 머신
* SSH 키
* 사용자 데이터
* 기존 EC2/AMI/스냅샷
* 네트워킹
* 네트워크
* 서브넷
* 공용 IP
* 열린 포트
* AWS 외부의 다른 네트워크와의 통합 연결

### 인스턴스 프로필

**EC2 인스턴스**에서 실행되는 응용 프로그램에 권한을 부여하기 위해 **역할**을 사용하려면 약간의 추가 구성이 필요합니다. EC2 인스턴스에서 실행되는 응용 프로그램은 가상화된 운영 체제에 의해 AWS에서 추상화됩니다. 이 추가 분리로 인해 EC2 인스턴스에 AWS 역할과 해당 권한을 할당하고 응용 프로그램에서 사용할 수 있도록 하려면 추가 단계가 필요합니다.

이 추가 단계는 인스턴스에 연결된 [_**인스턴스 프로필**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html)을 생성하는 것입니다. **인스턴스 프로필에는 역할이 포함**되어 있으며 인스턴스에서 실행되는 응용 프로그램에 역할의 일시적인 자격 증명을 제공할 수 있습니다. 이러한 일시적인 자격 증명은 응용 프로그램의 API 호출에서 리소스에 액세스하고 역할이 지정한 리소스에만 액세스할 수 있도록 제한하는 데 사용될 수 있습니다. 한 번에 **하나의 역할만 EC2 인스턴스에 할당**할 수 있으며 인스턴스의 모든 응용 프로그램은 동일한 역할과 권한을 공유합니다.

### 메타데이터 엔드포인트

AWS EC2 메타데이터는 Amazon Elastic Compute Cloud (EC2) 인스턴스에게 런타임에서 사용 가능한 정보입니다. 이 메타데이터는 인스턴스에 대한 정보를 제공하기 위해 사용됩니다. 예를 들어 인스턴스 ID, 실행 중인 가용 영역, 인스턴스와 관련된 IAM 역할 및 인스턴스의 호스트 이름과 같은 정보가 포함됩니다.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### 열거
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### 인증되지 않은 액세스

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### 권한 상승

다음 페이지에서는 **EC2 권한을 악용하여 권한을 상승**하는 방법을 확인할 수 있습니다:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### 사후 침투

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS**(Elastic Block Store) **스냅샷**은 기본적으로 AWS EBS 볼륨의 정적 **백업**입니다. 다시 말해, 특정 시점에서 EC2 인스턴스에 연결된 **디스크**의 **복사본**입니다. EBS 스냅샷은 지역 및 계정 간에 복사되거나 다운로드하여 로컬에서 실행할 수 있습니다.

스냅샷에는 **소스 코드 또는 API 키와 같은 중요한 정보**가 포함될 수 있으므로 가능한 경우 확인하는 것이 좋습니다.

### AMI 및 EBS의 차이

**AMI**는 **EC2 인스턴스를 시작**하는 데 사용되며, EC2 **스냅샷**은 EBS 볼륨에 저장된 데이터를 **백업하고 복구**하는 데 사용됩니다. EC2 스냅샷을 사용하여 새 AMI를 생성할 수 있지만, AMI와는 다른 것이며, 운영 체제, 응용 프로그램 서버 또는 애플리케이션을 실행하는 데 필요한 기타 소프트웨어에 대한 정보를 포함하지 않습니다.

### 권한 상승

다음 페이지에서는 **EBS 권한을 악용하여 권한을 상승**하는 방법을 확인할 수 있습니다:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)**은 EC2 인스턴스의 그룹을 원격으로 관리하여 관리 작업을 훨씬 쉽게 만들 수 있습니다. 이러한 인스턴스 각각은 **SSM 에이전트 서비스를 실행**해야 하며, 이 서비스가 AWS API에서 작업을 수신하고 실행합니다.

**SSM 에이전트**는 시스템 관리자가 이러한 리소스를 업데이트, 관리 및 구성할 수 있도록합니다. 에이전트는 AWS 클라우드의 Systems Manager 서비스에서 요청을 처리한 다음 요청에 지정된대로 실행합니다.

**SSM 에이전트**는 [**일부 AMI에 미리 설치**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html)되어 있거나 [**수동으로 설치**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html)해야 합니다. 또한 인스턴스 내에서 사용되는 IAM 역할은 통신할 수 있도록 정책 **AmazonEC2RoleforSSM**이 첨부되어야 합니다.

### 열거
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
EC2 인스턴스에서 Systems Manager가 실행 중인지 확인하려면 다음을 실행하면 됩니다:
```bash
ps aux | grep amazon-ssm
```
### 권한 상승

다음 페이지에서는 **SSM 권한을 남용하여 권한을 상승시키는 방법**을 확인할 수 있습니다:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### 사후 침투

SSM 메시지 가로채기와 같은 기술은 SSM 사후 침투 페이지에서 찾을 수 있습니다:

{% content-ref url="broken-reference" %}
[Broken link](broken-reference)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB)은 Amazon Web Services (AWS) 배포를 위한 **로드 밸런싱 서비스**입니다. ELB는 자동으로 **들어오는 애플리케이션 트래픽을 분산**하고 트래픽 요구에 맞게 리소스를 확장합니다.

### 열거
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Launch Templates & Autoscaling Groups

### 열거

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPN은 **온프레미스 네트워크 (사이트 간 VPN)** 또는 **작업자 노트북 (클라이언트 VPN)**를 **AWS VPC**와 연결하여 서비스에 인터넷을 노출시키지 않고 액세스할 수 있게 합니다.

### 기본 AWS VPN 구성 요소

1. **고객 게이트웨이**:
* 고객 게이트웨이는 VPN 연결의 당신의 측면을 나타내기 위해 AWS에서 생성하는 리소스입니다.
* 이는 사실상 사이트 간 VPN 연결의 당신의 측면에 있는 물리적 장치 또는 소프트웨어 응용 프로그램입니다.
* 라우팅 정보와 네트워크 장치 (라우터 또는 방화벽과 같은)의 공용 IP 주소를 AWS에 제공하여 고객 게이트웨이를 생성합니다.
* VPN 연결 설정을 위한 참조 지점으로 작동하며 추가 비용이 발생하지 않습니다.
2. **가상 프라이빗 게이트웨이**:
* 가상 프라이빗 게이트웨이 (VPG)는 사이트 간 VPN 연결의 Amazon 측면에있는 VPN 집중기입니다.
* VPG는 VPC에 연결되어 VPN 연결의 대상으로 작동합니다.
* VPG는 VPN 연결의 AWS 측 엔드 포인트입니다.
* VPC와 온프레미스 네트워크 간의 안전한 통신을 처리합니다.
3. **사이트 간 VPN 연결**:
* 사이트 간 VPN 연결은 안전한 IPsec VPN 터널을 통해 온프레미스 네트워크를 VPC에 연결합니다.
* 이 유형의 연결에는 고객 게이트웨이와 가상 프라이빗 게이트웨이가 필요합니다.
* 데이터 센터 또는 네트워크와 AWS 환경 간의 안전하고 안정적이며 일관된 통신에 사용됩니다.
* 일반적으로 정기적이고 장기적인 연결에 사용되며 연결을 통해 전송된 데이터 양에 따라 청구됩니다.
4. **클라이언트 VPN 엔드포인트**:
* 클라이언트 VPN 엔드포인트는 클라이언트 VPN 세션을 활성화하고 관리하기 위해 AWS에서 생성하는 리소스입니다.
* 이는 개별 장치 (노트북, 스마트폰 등)가 AWS 리소스 또는 온프레미스 네트워크에 안전하게 연결되도록하는 데 사용됩니다.
* 사이트 간 VPN과 달리 개별 클라이언트를 연결하는 것이 아니라 개별 클라이언트를 위해 설계되었습니다.
* 클라이언트 VPN에서 각 클라이언트 장치는 VPN 클라이언트 소프트웨어를 사용하여 안전한 연결을 설정합니다.

[**AWS VPN의 혜택과 구성 요소에 대한 자세한 정보를 여기에서 찾을 수 있습니다**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn).&#x20;

게시물 E

### 열거
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### 로컬 열거

#### 로컬 임시 자격 증명

AWS VPN 클라이언트를 사용하여 VPN에 연결할 때 사용자는 일반적으로 VPN에 액세스하기 위해 AWS에 로그인합니다. 그런 다음 VPN 연결을 설정하기 위해 일부 AWS 자격 증명이 로컬에 생성되고 저장됩니다. 이 자격 증명은 `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt`에 저장되며 **AccessKey**, **SecretKey** 및 **Token**이 포함되어 있습니다.

이 자격 증명은 사용자 `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials`에 속합니다 (TODO: 이 자격 증명의 권한에 대해 자세히 조사하십시오).

#### opvn 구성 파일

VPN 연결이 설정된 경우 시스템에서 **`.opvn`** 구성 파일을 검색해야 합니다. 또한 구성 파일을 찾을 수 있는 한 곳은 **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**입니다.

### **포스트 익스플로잇**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

# 참고 자료
* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 PDF로 HackTricks를 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
