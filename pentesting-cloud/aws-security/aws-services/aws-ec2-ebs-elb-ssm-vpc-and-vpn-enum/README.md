# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## VPC i Networking

Dowiedz się, czym jest VPC i o jego składnikach w:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 jest wykorzystywany do uruchamiania **wirtualnych serwerów**. Umożliwia konfigurację **bezpieczeństwa** i **sieci** oraz zarządzanie **przechowywaniem danych**. Elastyczność Amazon EC2 jest widoczna w jego zdolności do skalowania zasobów zarówno w górę, jak i w dół, dostosowując się do zmieniających się wymagań lub wzrostu popularności. Ta funkcja zmniejsza konieczność dokładnego przewidywania ruchu.

Interesujące rzeczy do wyliczenia w EC2:

* Maszyny wirtualne
* Klucze SSH
* Dane użytkownika
* Istniejące EC2/AMI/Snapshoty
* Sieciowanie
* Sieci
* Podsieci
* Publiczne adresy IP
* Otwarte porty
* Zintegrowane połączenia z innymi sieciami poza AWS

### Profile instancji

Aby przyznać uprawnienia aplikacjom uruchamianym na instancjach EC2 za pomocą **ról**, wymagana jest dodatkowa konfiguracja. Aplikacja uruchamiana na instancji EC2 jest abstrahowana od AWS przez zvirtualizowany system operacyjny. Ze względu na to dodatkowe oddzielenie, konieczne jest wykonanie dodatkowego kroku w celu przypisania roli AWS i powiązanych uprawnień do instancji EC2 i udostępnienia ich aplikacjom.

Dodatkowym krokiem jest **utworzenie** [_**profilu instancji**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) przypisanego do instancji. **Profil instancji zawiera rolę** i może udostępnić tymczasowe poświadczenia roli aplikacji uruchamianej na instancji. Te tymczasowe poświadczenia mogą być następnie używane w wywołaniach interfejsu API aplikacji do dostępu do zasobów i ograniczenia dostępu tylko do tych zasobów, które określa rola. Należy zauważyć, że **tylko jedna rola może być przypisana do instancji EC2** w danym czasie, a wszystkie aplikacje na instancji dzielą tę samą rolę i uprawnienia.

### Punkt końcowy metadanych

Metadane AWS EC2 to informacje o instancji Amazon Elastic Compute Cloud (EC2), które są dostępne dla instancji w czasie wykonywania. Metadane te służą do udostępniania informacji o instancji, takich jak jej identyfikator instancji, strefa dostępności, w której jest uruchomiona, rola IAM przypisana do instancji i nazwa hosta instancji.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Wyliczanie
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Nieuwierzytelniony dostęp

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Podwyższanie uprawnień

Na następnej stronie możesz sprawdzić, jak **wykorzystać uprawnienia EC2 do podwyższenia uprawnień**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Po eksploatacji

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** to po prostu statyczne **kopie zapasowe** woluminów AWS EBS. Innymi słowy, są to **kopie** dysków podłączonych do instancji **EC2** w określonym momencie. Snapshoty EBS mogą być kopiowane między regionami i kontami, a nawet pobierane i uruchamiane lokalnie.

Snapshoty mogą zawierać **wrażliwe informacje**, takie jak **kod źródłowy lub klucze API**, dlatego jeśli masz taką możliwość, zaleca się ich sprawdzenie.

### Różnica między AMI a EBS

**AMI** służy do **uruchamiania instancji EC2**, podczas gdy **Snapshot EC2** służy do **tworzenia kopii zapasowych i odzyskiwania danych przechowywanych na woluminie EBS**. Chociaż Snapshot EC2 można użyć do utworzenia nowego AMI, nie jest to to samo co AMI i nie zawiera informacji o systemie operacyjnym, serwerze aplikacji ani innym oprogramowaniu wymaganym do uruchomienia aplikacji.

### Podwyższanie uprawnień

Na następnej stronie możesz sprawdzić, jak **wykorzystać uprawnienia EBS do podwyższenia uprawnień**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** umożliwia zdalne zarządzanie instancjami EC2, co ułatwia ich administrację. Każda z tych instancji musi uruchamiać usługę **SSM Agent, ponieważ to ona otrzymuje i wykonuje działania** z API AWS.

**SSM Agent** umożliwia System Managerowi aktualizowanie, zarządzanie i konfigurowanie tych zasobów. Agent **przetwarza żądania z usługi System Manager w chmurze AWS**, a następnie wykonuje je zgodnie z żądaniem.

**SSM Agent jest**[ **preinstalowany w niektórych AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) lub musisz [**zainstalować go ręcznie**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) na instancjach. Również rola IAM używana wewnątrz instancji musi mieć dołączoną politykę **AmazonEC2RoleforSSM**, aby umożliwić komunikację.

### Wyliczanie
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Możesz sprawdzić, czy na instancji EC2 działa Systems Manager, wykonując polecenie:
```bash
ps aux | grep amazon-ssm
```
### Podwyższanie uprawnień

Na następnej stronie możesz sprawdzić, jak **wykorzystać uprawnienia SSM do podwyższenia uprawnień**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Po eksploatacji

Techniki takie jak przechwytywanie wiadomości SSM można znaleźć na stronie po eksploatacji SSM:

{% content-ref url="broken-reference" %}
[Uszkodzony link](broken-reference)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) to usługa **balansowania obciążenia dla wdrożeń Amazon Web Services** (AWS). ELB automatycznie **rozdziela przychodzący ruch aplikacji** i skaluje zasoby, aby sprostać wymaganiom ruchu.

### Wyliczanie
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Szablony uruchamiania i grupy skalowania automatycznego

### Wyliczanie

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPN umożliwia połączenie twojej **sieci lokalnej (VPN typu site-to-site)** lub **laptopów pracowników (VPN klienta)** z **AWS VPC**, dzięki czemu usługi mogą być dostępne bez konieczności ich wystawiania na zewnątrz internetu.

### Podstawowe komponenty AWS VPN

1. **Brama klienta**:
* Brama klienta to zasób, który tworzysz w AWS, aby reprezentować twoją stronę połączenia VPN.
* Jest to fizyczne urządzenie lub aplikacja oprogramowania po twojej stronie połączenia VPN typu site-to-site.
* Podajesz informacje o routingu oraz publiczny adres IP urządzenia sieciowego (takiego jak router lub zapora sieciowa) do AWS, aby utworzyć bramę klienta.
* Służy jako punkt odniesienia do konfiguracji połączenia VPN i nie generuje dodatkowych opłat.
2. **Wirtualna brama prywatna**:
* Wirtualna brama prywatna (VPG) to koncentrator VPN po stronie Amazon w połączeniu VPN typu site-to-site.
* Jest ona dołączona do twojego VPC i służy jako cel dla twojego połączenia VPN.
* VPG to punkt końcowy po stronie AWS dla połączenia VPN.
* Obsługuje bezpieczną komunikację między twoim VPC a twoją siecią lokalną.
3. **Połączenie VPN typu site-to-site**:
* Połączenie VPN typu site-to-site łączy twoją sieć lokalną z VPC za pośrednictwem bezpiecznego tunelu VPN IPsec.
* Ten rodzaj połączenia wymaga Bramy klienta i Wirtualnej bramy prywatnej.
* Służy do bezpiecznej, stabilnej i spójnej komunikacji między twoim centrum danych lub siecią a środowiskiem AWS.
* Zazwyczaj używane do regularnych, długoterminowych połączeń i rozliczane na podstawie ilości przesyłanych danych przez połączenie.
4. **Punkt końcowy VPN klienta**:
* Punkt końcowy VPN klienta to zasób, który tworzysz w AWS, aby umożliwić i zarządzać sesjami VPN klienta.
* Służy do umożliwienia indywidualnym urządzeniom (takim jak laptopy, smartfony itp.) bezpiecznego połączenia z zasobami AWS lub twoją siecią lokalną.
* Różni się od VPN typu site-to-site tym, że jest przeznaczony dla indywidualnych klientów, a nie do łączenia całych sieci.
* W przypadku VPN klienta każde urządzenie klienta używa oprogramowania klienta VPN do nawiązania bezpiecznego połączenia.

Możesz [**znaleźć więcej informacji na temat korzyści i komponentów AWS VPN tutaj**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn).&#x20;

Post E

### Wyliczanie
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Lokalne wyliczenie

#### Lokalne tymczasowe poświadczenia

Kiedy klient AWS VPN jest używany do połączenia z VPN, użytkownik zazwyczaj **loguje się do AWS**, aby uzyskać dostęp do VPN. Następnie, lokalnie tworzone są i przechowywane **poświadczenia AWS** w celu nawiązania połączenia VPN. Te poświadczenia są **przechowywane w** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` i zawierają **AccessKey**, **SecretKey** i **Token**.

Poświadczenia należą do użytkownika `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: dowiedz się więcej o uprawnieniach tych poświadczeń).

#### Pliki konfiguracyjne opvn

Jeśli **połączenie VPN zostało nawiązane**, należy wyszukać pliki konfiguracyjne **`.opvn`** w systemie. Ponadto, jednym miejscem, gdzie można znaleźć **konfiguracje**, jest **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**.

### **Eksploatacja po zakończeniu**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

# Odwołania
* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
