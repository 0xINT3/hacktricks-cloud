# AWS - EC2、EBS、ELB、SSM、VPC＆VPN Enum

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい場合は**、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れる
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
- **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## VPC＆ネットワーキング

VPCとそのコンポーネントについて学びましょう：

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2は**仮想サーバー**を起動するために使用されます。**セキュリティ**と**ネットワーキング**の構成、**ストレージ**の管理が可能です。Amazon EC2の柔軟性は、リソースを上下にスケーリングして、異なる要件の変更や人気の急増に効果的に適応する能力に現れています。この機能により、正確なトラフィック予測の必要性が薄れます。

EC2で列挙する興味深い点：

- 仮想マシン
- SSHキー
- ユーザーデータ
- 既存のEC2/AMI/スナップショット
- ネットワーキング
- ネットワーク
- サブネット
- パブリックIP
- 開いているポート
- AWS外部の他のネットワークとの統合接続

### インスタンスプロファイル

**EC2インスタンス**で実行されるアプリケーションに権限を付与するために**ロール**を使用するには、少しの追加構成が必要です。EC2インスタンスで実行されるアプリケーションは、仮想化されたオペレーティングシステムによってAWSから抽象化されています。この追加の分離のため、AWSロールとその関連する権限をEC2インスタンスに割り当て、そのアプリケーションで利用可能にするために、追加の手順が必要です。

この追加の手順は、インスタンスに添付された[_**インスタンスプロファイル**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html)の作成です。**インスタンスプロファイルにはロールが含まれ**、そのロールの一時的な資格情報をインスタンスで実行されるアプリケーションに提供できます。それらの一時的な資格情報は、その後、アプリケーションのAPI呼び出しで使用され、ロールが指定するリソースにのみアクセスし、そのリソースにのみアクセスを制限できます。**EC2インスタンスには1つのロールのみが割り当てられ**、インスタンス上のすべてのアプリケーションが同じロールと権限を共有します。

### メタデータエンドポイント

AWS EC2メタデータは、実行時にインスタンスで利用可能なAmazon Elastic Compute Cloud（EC2）インスタンスに関する情報です。このメタデータは、インスタンスに関する情報を提供するために使用されます。例えば、インスタンスID、実行中の可用性ゾーン、インスタンスに関連付けられたIAMロール、インスタンスのホスト名などが含まれます。

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### 列挙
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### 未認証アクセス

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### 特権昇格

次のページでは、**EC2権限を悪用して特権を昇格する方法**を確認できます：

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### 攻撃後の活動

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS**（Elastic Block Store）**スナップショット**は基本的にAWS EBSボリュームの**静的バックアップ**です。つまり、特定の時点でEC2インスタンスに接続された**ディスク**の**コピー**です。EBSスナップショットはリージョン間やアカウント間でコピーしたり、ダウンロードしてローカルで実行したりすることができます。

スナップショットには**ソースコードやAPIキーなどの機密情報**が含まれる場合がありますので、機会があればチェックすることをお勧めします。

### AMIとEBSの違い

**AMI**は**EC2インスタンスを起動**するために使用され、EC2 **スナップショット**はEBSボリュームに保存されているデータを**バックアップおよび復元**するために使用されます。EC2スナップショットを使用して新しいAMIを作成することができますが、AMIとは異なり、オペレーティングシステム、アプリケーションサーバー、またはアプリケーションを実行するために必要な他のソフトウェアに関する情報は含まれません。

### 特権昇格

次のページでは、**EBS権限を悪用して特権を昇格する方法**を確認できます：

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)**は、EC2インスタンスのフリートをリモートで管理し、その管理を容易にすることができます。これらのインスタンスのそれぞれは、**SSMエージェントサービスを実行する必要があります。このサービスは、AWS APIからアクションを取得し、実行します**。

**SSMエージェント**により、Systems Managerはこれらのリソースを更新、管理、構成することが可能になります。エージェントは、AWSクラウド内のSystems Managerサービスからのリクエストを処理し、リクエストで指定されたとおりに実行します。

**SSMエージェントは**[ **一部のAMIに事前インストールされています**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html)が、インスタンスに[**手動でインストールする必要があります**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html)。また、インスタンス内で使用されるIAMロールには、通信を行うために**AmazonEC2RoleforSSM**ポリシーがアタッチされている必要があります。

### 列挙
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
EC2インスタンスでSystems Managerが実行されているかどうかを確認するには、次のコマンドを実行するだけです:
```bash
ps aux | grep amazon-ssm
```
### 特権昇格

次のページでは、SSM権限を悪用して特権を昇格させる方法を確認できます：

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### 永続性



## ELB

**Elastic Load Balancing**（ELB）は、Amazon Web Services（AWS）デプロイメント向けの**負荷分散サービス**です。ELBは自動的に**着信アプリケーショントラフィックを分散**し、トラフィック要求に応じてリソースをスケーリングします。

### 列挙
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## ランチテンプレート＆オートスケーリンググループ

### 列挙

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPNを使用すると、**オンプレミスネットワーク（サイト間VPN）**または**従業員のノートパソコン（クライアントVPN）**を**AWS VPC**に接続し、サービスにインターネットを公開する必要なくアクセスできます。

#### 基本的なAWS VPNコンポーネント

1. **カスタマーゲートウェイ**:
* カスタマーゲートウェイは、VPN接続のあなたの側を表すためにAWSで作成するリソースです。
* 本質的には、サイト間VPN接続のあなたの側にある物理デバイスまたはソフトウェアアプリケーションです。
* ルーティング情報とネットワークデバイス（ルーターやファイアウォールなど）のパブリックIPアドレスをAWSに提供して、カスタマーゲートウェイを作成します。
* VPN接続の設定の参照点として機能し、追加料金は発生しません。
2. **仮想プライベートゲートウェイ**:
* 仮想プライベートゲートウェイ（VPG）は、サイト間VPN接続のAmazon側にあるVPNコンセントレータです。
* VPGはVPCにアタッチされ、VPN接続のターゲットとして機能します。
* VPGはVPN接続のAWS側エンドポイントです。
* VPCとオンプレミスネットワーク間の安全な通信を処理します。
3. **サイト間VPN接続**:
* サイト間VPN接続は、安全なIPsec VPNトンネルを介してオンプレミスネットワークをVPCに接続します。
* このタイプの接続には、カスタマーゲートウェイと仮想プライベートゲートウェイが必要です。
* データセンターやネットワークとAWS環境間の安全で安定した一貫した通信に使用されます。
* 通常、定期的で長期的な接続に使用され、接続経由で転送されるデータ量に基づいて請求されます。
4. **クライアントVPNエンドポイント**:
* クライアントVPNエンドポイントは、クライアントVPNセッションを有効にし管理するためにAWSで作成するリソースです。
* 個々のデバイス（ノートパソコン、スマートフォンなど）がAWSリソースやオンプレミスネットワークに安全に接続できるように使用されます。
* サイト間VPNとは異なり、個々のクライアント向けに設計されており、ネットワーク全体を接続するのではなく、個々のクライアントデバイスに使用されます。
* クライアントVPNでは、各クライアントデバイスがVPNクライアントソフトウェアを使用して安全な接続を確立します。

AWS VPNの利点とコンポーネントに関する詳細情報は[**こちらで見つけることができます**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn)。

### 列挙
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### ローカル列挙

**ローカル一時クレデンシャル**

AWS VPNクライアントを使用してVPNに接続すると、ユーザーは通常、VPNにアクセスするためにAWSに**ログイン**します。その後、VPN接続を確立するために、いくつかの**AWSクレデンシャルが作成され、ローカルに保存**されます。これらのクレデンシャルは`$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt`に**保存され**、**AccessKey**、**SecretKey**、**Token**が含まれています。

これらのクレデンシャルはユーザー`arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials`に属しています（TODO: これらのクレデンシャルの権限についてさらに調査）。

**opvn構成ファイル**

VPN接続が確立された場合、システム内で**`.opvn`**構成ファイルを検索する必要があります。さらに、**構成**を見つけることができる場所の1つは**`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**です。

#### **ポストエクスプロイテーション**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## 参考文献

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
