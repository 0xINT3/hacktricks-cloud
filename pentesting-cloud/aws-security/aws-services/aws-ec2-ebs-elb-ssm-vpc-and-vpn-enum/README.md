# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## VPC & Redes

Aprende qu칠 es un VPC y sobre sus componentes en:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 se utiliza para iniciar **servidores virtuales**. Permite la configuraci칩n de **seguridad** y **redes** y la gesti칩n de **almacenamiento**. La flexibilidad de Amazon EC2 es evidente en su capacidad para escalar recursos tanto hacia arriba como hacia abajo, adapt치ndose efectivamente a cambios en los requisitos o picos de popularidad. Esta caracter칤stica reduce la necesidad de predicciones precisas de tr치fico.

Cosas interesantes para enumerar en EC2:

* M치quinas Virtuales
* Claves SSH
* Datos de Usuario
* EC2s/AMIs/Snapshots existentes
* Redes
* Subredes
* IPs P칰blicas
* Puertos abiertos
* Conexiones integradas con otras redes fuera de AWS

### Perfiles de Instancia

Usar **roles** para otorgar permisos a aplicaciones que se ejecutan en **instancias EC2** requiere una configuraci칩n adicional. Una aplicaci칩n que se ejecuta en una instancia EC2 est치 abstra칤da de AWS por el sistema operativo virtualizado. Debido a esta separaci칩n adicional, necesitas un paso adicional para asignar un rol de AWS y sus permisos asociados a una instancia EC2 y hacerlos disponibles para sus aplicaciones.

Este paso adicional es la **creaci칩n de un** [_**perfil de instancia**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html) adjunto a la instancia. El **perfil de instancia contiene el rol y** puede proporcionar las credenciales temporales del rol a una aplicaci칩n que se ejecuta en la instancia. Esas credenciales temporales pueden usarse en las llamadas a la API de la aplicaci칩n para acceder a recursos y limitar el acceso solo a aquellos recursos que el rol especifica. Ten en cuenta que **solo se puede asignar un rol a una instancia EC2** a la vez, y todas las aplicaciones en la instancia comparten el mismo rol y permisos.

### Punto de Enlace de Metadatos

Los metadatos de AWS EC2 son informaci칩n sobre una instancia de Amazon Elastic Compute Cloud (EC2) que est치 disponible para la instancia en tiempo de ejecuci칩n. Estos metadatos se utilizan para proporcionar informaci칩n sobre la instancia, como su ID de instancia, la zona de disponibilidad en la que se est치 ejecutando, el rol de IAM asociado con la instancia y el nombre de host de la instancia.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumeraci칩n
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Acceso no autenticado

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Escalada de Privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de EC2 para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Explotaci칩n

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Las **instant치neas de EBS** (Elastic Block Store) de Amazon son b치sicamente **copias de seguridad est치ticas** de los vol칰menes de EBS de AWS. En otras palabras, son **copias** de los **discos** adjuntos a una instancia de **EC2** en un momento espec칤fico. Las instant치neas de EBS se pueden copiar entre regiones y cuentas, o incluso descargar y ejecutar localmente.

Las instant치neas pueden contener **informaci칩n sensible** como **c칩digo fuente o claves API**, por lo tanto, si tienes la oportunidad, se recomienda revisarlas.

### Diferencia entre AMI y EBS

Un **AMI** se utiliza para **lanzar una instancia de EC2**, mientras que una **Instant치nea de EC2** se utiliza para **hacer copias de seguridad y recuperar datos almacenados en un volumen de EBS**. Aunque una Instant치nea de EC2 se puede utilizar para crear un nuevo AMI, no es lo mismo que un AMI, y no incluye informaci칩n sobre el sistema operativo, el servidor de aplicaciones u otro software necesario para ejecutar una aplicaci칩n.

### Escalada de Privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de EBS para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** permite gestionar de forma remota flotas de instancias EC2 para facilitar su administraci칩n. Cada una de estas instancias necesita estar ejecutando el **servicio Agente SSM, ya que ser치 el que reciba las acciones y las ejecute** desde la API de AWS.

El **Agente SSM** hace posible que Systems Manager actualice, gestione y configure estos recursos. El agente **procesa las solicitudes del servicio Systems Manager en la nube de AWS**, y luego las ejecuta seg칰n lo especificado en la solicitud.

El **Agente SSM viene**[ **preinstalado en algunas AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) o necesitas [**instalarlo manualmente**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) en las instancias. Adem치s, el Rol IAM utilizado dentro de la instancia necesita tener adjunta la pol칤tica **AmazonEC2RoleforSSM** para poder comunicarse.

### Enumeraci칩n
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Puedes verificar en una instancia EC2 si Systems Manager est치 ejecut치ndose simplemente ejecutando:
```bash
ps aux | grep amazon-ssm
```
### Escalaci칩n de Privilegios

En la siguiente p치gina puedes verificar c칩mo **abusar de los permisos de SSM para escalar privilegios**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Post-Explotaci칩n

T칠cnicas como la intercepci칩n de mensajes de SSM se pueden encontrar en la p치gina de post-explotaci칩n de SSM:

{% content-ref url="broken-reference" %}
[Enlace roto](broken-reference)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) es un **servicio de balanceo de carga para despliegues de Amazon Web Services** (AWS). ELB distribuye autom치ticamente **el tr치fico entrante de aplicaciones** y escala recursos para satisfacer la demanda de tr치fico.

### Enumeraci칩n
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Plantillas de lanzamiento y Grupos de Autoescalado

### Enumeraci칩n

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

Una VPN permite conectar su **red local (VPN de sitio a sitio)** o los **port치tiles de los trabajadores (VPN de cliente)** con un **VPC de AWS** para que los servicios se puedan acceder sin necesidad de exponerlos a Internet.

### Componentes b치sicos de VPN de AWS

1. **Customer Gateway** (Puerta de enlace del cliente):
* Una Customer Gateway es un recurso que crea en AWS para representar su lado de una conexi칩n VPN.
* Es esencialmente un dispositivo f칤sico o una aplicaci칩n de software en su lado de la conexi칩n VPN de sitio a sitio.
* Proporciona informaci칩n de enrutamiento y la direcci칩n IP p칰blica de su dispositivo de red (como un enrutador o un firewall) a AWS para crear una Customer Gateway.
* Sirve como punto de referencia para configurar la conexi칩n VPN y no genera cargos adicionales.
2. **Virtual Private Gateway** (Puerta de enlace privada virtual):
* Una Virtual Private Gateway (VPG) es el concentrador VPN del lado de Amazon de la conexi칩n VPN de sitio a sitio.
* Se adjunta a su VPC y sirve como objetivo para su conexi칩n VPN.
* VPG es el punto final del lado de AWS para la conexi칩n VPN.
* Maneja la comunicaci칩n segura entre su VPC y su red local.
3. **Site-to-Site VPN Connection** (Conexi칩n VPN de sitio a sitio):
* Una conexi칩n VPN de sitio a sitio conecta su red local a un VPC a trav칠s de un t칰nel VPN IPsec seguro.
* Este tipo de conexi칩n requiere una Customer Gateway y una Virtual Private Gateway.
* Se utiliza para comunicaci칩n segura, estable y consistente entre su centro de datos o red y su entorno de AWS.
* T칤picamente utilizada para conexiones regulares y a largo plazo y se factura en base a la cantidad de datos transferidos a trav칠s de la conexi칩n.
4. **Client VPN Endpoint** (Punto final de VPN de cliente):
* Un Client VPN Endpoint es un recurso que crea en AWS para habilitar y gestionar sesiones de VPN de cliente.
* Se utiliza para permitir que dispositivos individuales (como port치tiles, smartphones, etc.) se conecten de manera segura a recursos de AWS o a su red local.
* Se diferencia de la VPN de sitio a sitio en que est치 dise침ado para clientes individuales en lugar de conectar redes enteras.
* Con Client VPN, cada dispositivo cliente utiliza un software de cliente VPN para establecer una conexi칩n segura.

Puede [**encontrar m치s informaci칩n sobre los beneficios y componentes de las VPN de AWS aqu칤**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn).&#x20;

Post E

### Enumeraci칩n
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Enumeraci칩n Local

#### Credenciales Temporales Locales

Cuando se utiliza el Cliente VPN de AWS para conectarse a una VPN, el usuario normalmente **inicia sesi칩n en AWS** para obtener acceso a la VPN. Luego, se crean y **almacenan algunas credenciales de AWS localmente** para establecer la conexi칩n VPN. Estas credenciales se **almacenan en** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` y contienen un **AccessKey**, un **SecretKey** y un **Token**.

Las credenciales pertenecen al usuario `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: investigar m치s sobre los permisos de estas credenciales).

#### archivos de configuraci칩n opvn

Si se **estableci칩 una conexi칩n VPN**, debes buscar archivos de configuraci칩n **`.opvn`** en el sistema. Adem치s, un lugar donde podr칤as encontrar las **configuraciones** es en **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

### **Post Explotaci칩n**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

# Referencias
* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
