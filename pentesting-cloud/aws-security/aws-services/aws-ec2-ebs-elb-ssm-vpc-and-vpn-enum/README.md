# AWS - EC2, EBS, ELB, SSM, VPC & VPN 枚举

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** 上关注我们**。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## VPC & 网络

了解 VPC 是什么以及其组件在：

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 用于启动**虚拟服务器**。它允许配置**安全性**和**网络**，以及管理**存储**。Amazon EC2 的灵活性体现在其能够向上和向下扩展资源，有效地适应不断变化的需求或流行度激增。这个特性减少了对精确流量预测的必要性。

在 EC2 中枚举的有趣内容：

* 虚拟机
* SSH 密钥
* 用户数据
* 现有的 EC2/AMI/快照
* 网络
* 网络
* 子网
* 公共 IP
* 开放端口
* 与 AWS 外部其他网络的集成连接

### 实例配置文件

使用**角色**为在**EC2 实例**上运行的应用程序授予权限需要一些额外配置。在 EC2 实例上运行的应用程序被虚拟化操作系统抽象出来，因此您需要额外的步骤来为 EC2 实例分配 AWS 角色及其关联的权限，并使其对应用程序可用。

这个额外步骤是附加到实例的**[_实例配置文件_**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html)，实例配置文件包含角色，并可向在实例上运行的应用程序提供角色的临时凭证。然后，这些临时凭证可以在应用程序的 API 调用中使用，以访问资源并限制访问仅限于角色指定的资源。请注意，**一个 EC2 实例只能分配一个角色**，实例上的所有应用程序共享相同的角色和权限。

### 元数据端点

AWS EC2 元数据是 EC2 实例在运行时可用的有关 Amazon Elastic Compute Cloud（EC2）实例的信息。此元数据用于提供有关实例的信息，例如实例 ID、其运行的可用区域、与实例关联的 IAM 角色以及实例的主机名。

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### 枚举
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### 未经身份验证的访问

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### 提权

在以下页面中，您可以查看如何**滥用 EC2 权限以提升特权**：

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### 漏洞利用后

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

亚马逊 **EBS**（弹性块存储）**快照**基本上是 AWS EBS 卷的静态**备份**。换句话说，它们是在特定时间点复制到 EC2 实例的**磁盘**的**副本**。EBS 快照可以跨区域和帐户进行复制，甚至可以下载并在本地运行。

快照可能包含**敏感信息**，如**源代码或 API 密钥**，因此，如果有机会，建议进行检查。

### AMI 与 EBS 的区别

**AMI** 用于**启动 EC2 实例**，而 EC2 **快照**用于**备份和恢复存储在 EBS 卷上的数据**。虽然 EC2 快照可用于创建新的 AMI，但它不同于 AMI，并且不包括有关操作系统、应用服务器或运行应用程序所需的其他软件的信息。

### 提权

在以下页面中，您可以查看如何**滥用 EBS 权限以提升特权**：

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** 允许远程管理 EC2 实例的浮动，使其管理变得更加容易。这些实例中的每个都需要运行**SSM Agent 服务，因为该服务将从 AWS API 获取操作并执行这些操作**。

**SSM Agent** 使 Systems Manager 能够更新、管理和配置这些资源。该代理**处理来自 AWS 云中 Systems Manager 服务的请求**，然后按请求中指定的方式运行它们。

**SSM Agent**[ **预安装在某些 AMI 中**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html)，或者您需要[**手动安装它们**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html)在实例上。此外，实例内部使用的 IAM 角色需要附加策略**AmazonEC2RoleforSSM**才能进行通信。

### 枚举
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
您可以通过执行以下命令在EC2实例中检查是否正在运行Systems Manager：
```bash
ps aux | grep amazon-ssm
```
### 提权

在以下页面中，您可以查看如何**滥用 SSM 权限来提升特权**：

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### 后渗透

类似 SSM 消息拦截等技术可以在 SSM 后渗透页面中找到：

{% content-ref url="broken-reference/" %}
[broken-reference](broken-reference/)
{% endcontent-ref %}

## ELB

**弹性负载均衡**（ELB）是亚马逊网络服务（AWS）部署的**负载均衡服务**。ELB 自动**分发传入的应用程序流量**并扩展资源以满足流量需求。

### 枚举
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## 启动模板和自动扩展组

### 枚举

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPN允许连接您的**本地网络（站点到站点VPN）**或**工作人员笔记本电脑（客户端VPN）**与**AWS VPC**，以便访问服务而无需将其暴露在互联网上。

#### 基本的AWS VPN组件

1. **客户网关**：
* 客户网关是您在AWS中创建的资源，用于代表VPN连接的您的一侧。
* 它本质上是站点到站点VPN连接一侧的物理设备或软件应用程序。
* 您提供路由信息和您网络设备（如路由器或防火墙）的公共IP地址给AWS以创建客户网关。
* 它用作设置VPN连接的参考点，不会产生额外费用。
2. **虚拟专用网关**：
* 虚拟专用网关（VPG）是站点到站点VPN连接Amazon一侧的VPN集中器。
* 它附加到您的VPC，并用作VPN连接的目标。
* VPG是VPN连接的AWS端点。
* 它处理您的VPC与您本地网络之间的安全通信。
3. **站点到站点VPN连接**：
* 站点到站点VPN连接通过安全的IPsec VPN隧道将您的本地网络连接到VPC。
* 这种连接需要客户网关和虚拟专用网关。
* 它用于您的数据中心或网络与您的AWS环境之间的安全、稳定和一致的通信。
* 通常用于常规、长期连接，并根据连接传输的数据量计费。
4. **客户端VPN端点**：
* 客户端VPN端点是您在AWS中创建的资源，用于启用和管理客户端VPN会话。
* 用于允许个别设备（如笔记本电脑、智能手机等）安全连接到AWS资源或您的本地网络。
* 与站点到站点VPN不同，它设计用于个别客户端而不是连接整个网络。
* 使用客户端VPN，每个客户端设备使用VPN客户端软件建立安全连接。

您可以[**在此处找到有关AWS VPN的好处和组件的更多信息**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn)。

### 枚举
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### 本地枚举

**本地临时凭证**

当使用AWS VPN客户端连接到VPN时，用户通常会**登录AWS**以获取VPN访问权限。然后，一些**AWS凭证会被创建并存储**在本地以建立VPN连接。这些凭证被**存储在** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` 中，包含一个**访问密钥**，一个**秘密密钥**和一个**令牌**。

这些凭证属于用户 `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials`（TODO：进一步研究这些凭证的权限）。

**opvn配置文件**

如果**建立了VPN连接**，您应该在系统中搜索**`.opvn`**配置文件。此外，您可能会在**`$HOME/.config/AWSVPNClient/OpenVpnConfigs`** 中找到这些**配置**。

#### **后渗透**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## 参考

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**上关注**我们。
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
