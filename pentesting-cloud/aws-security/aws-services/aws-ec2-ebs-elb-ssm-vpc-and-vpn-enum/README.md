# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## VPC & Mtandao

Jifunze ni nini VPC na viungo vyake katika:

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 hutumiwa kuanzisha **seva za kawaida**. Inaruhusu usanidi wa **usalama** na **mtandao** na usimamizi wa **uhifadhi**. Upana wa Amazon EC2 unadhihirika katika uwezo wake wa kupanua rasilimali juu chini, kuzoea kwa ufanisi mabadiliko ya mahitaji au kuongezeka kwa umaarufu. Kipengele hiki hupunguza hitaji la utabiri sahihi wa trafiki.

Vitu vya kuvutia vya kuhesabu katika EC2:

* Mashine za Kawaida
* Funguo za SSH
* Data ya Mtumiaji
* EC2s/AMIs/Snapshots Zilizopo
* Mtandao
* Mitandao
* Mitandao ya Pembezoni
* Anwani za IP za Umma
* Bandari Zilizofunguliwa
* Mawasiliano yaliyointegrishwa na mitandao mingine nje ya AWS

### Profaili za Kifaa

Kutumia **majukumu** kutoa ruhusa kwa programu zinazoendesha kwenye **vifaa vya EC2** inahitaji usanidi kidogo zaidi. Programu inayoendesha kwenye kifaa cha EC2 imefichwa kutoka AWS na mfumo wa uendeshaji uliovirtualiwa. Kwa sababu ya utengano huu ziada, unahitaji hatua ya ziada ya kumtambulisha jukumu la AWS na ruhusa zake zinazohusiana kwa kifaa cha EC2 na kuzifanya zipatikane kwa programu zake.

Hatua hii ya ziada ni **ujenzi wa** [_**profil ya kifaa**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) iliyowekwa kwenye kifaa. **Profaili ya kifaa ina jukumu na** inaweza kutoa vibali vya muda vya jukumu kwa programu inayoendesha kwenye kifaa. Vibali hivyo vya muda basi vinaweza kutumika katika wito wa API wa programu kufikia rasilimali na kudhibiti upatikanaji wa rasilimali hizo tu ambazo jukumu linabainisha. Kumbuka kwamba **jukumu moja tu linaweza kumtambulishwa kwa kifaa cha EC2** kwa wakati mmoja, na programu zote kwenye kifaa hushiriki jukumu na vibali sawa.

### Mwisho wa Metadata

Metadata ya AWS EC2 ni habari kuhusu kifaa cha Amazon Elastic Compute Cloud (EC2) inayopatikana kwa kifaa wakati wa muda wa uendeshaji. Metadata hii hutumiwa kutoa habari kuhusu kifaa, kama vile kitambulisho cha kifaa, eneo la upatikanaji linapofanya kazi, jukumu la IAM linalohusishwa na kifaa, na jina la mwenyeji wa kifaa.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Uhesabuaji
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Upatikanaji usiothibitishwa

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Kwenye ukurasa ufuatao unaweza kuangalia jinsi ya **kutumia ruhusa za EC2 kuboresha mamlaka**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Baada ya Uvamizi

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS** (Elastic Block Store) **snapshots** ni msingi wa **nakala rudufu** za kiasi cha AWS EBS. Kwa maneno mengine, ni **nakala** za **diski** zilizounganishwa na Kifaa cha **EC2** kwa wakati maalum. Picha za EBS zinaweza kunakiliwa kati ya mikoa na akaunti, au hata kupakuliwa na kukimbia kwa kienyeji.

Picha za EBS zinaweza kuwa na **habari nyeti** kama **mikodisho ya chanzo au funguo za API**, hivyo, ikiwa una nafasi, ni vyema kuichunguza.

### Tofauti kati ya AMI & EBS

**AMI** hutumiwa kuzindua kifaa cha EC2, wakati **Picha ya EC2** hutumiwa kufanya **nakala rudufu na kupona data iliyohifadhiwa kwenye kiasi cha EBS**. Ingawa Picha ya EC2 inaweza kutumika kuunda AMI mpya, sio kitu sawa na AMI, na haitoi habari kuhusu mfumo wa uendeshaji, seva ya programu, au programu nyingine inayohitajika kufanya kazi.

### Privesc

Kwenye ukurasa ufuatao unaweza kuangalia jinsi ya **kutumia ruhusa za EBS kuboresha mamlaka**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** inaruhusu kusimamia kwa mbali float za vifaa vya EC2 ili kufanya utawala wao kuwa rahisi zaidi. Kila moja ya vifaa hivi inahitaji kuendesha huduma ya **SSM Agent kwa sababu huduma hiyo ndiyo itakayopokea vitendo na kuyatekeleza** kutoka kwa API ya AWS.

**SSM Agent** inawezesha Systems Manager kusasisha, kusimamia, na kusanidi rasilimali hizi. Wakala **hutekeleza maombi kutoka kwa huduma ya Systems Manager katika AWS Cloud**, na kisha kuyatekeleza kama ilivyoelekezwa katika ombi.

**SSM Agent inakuja**[ **imefungwa kabla kwenye baadhi ya AMIs**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) au unahitaji [**kuiweka kwa mikono**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) kwenye vifaa. Pia, Jukumu la IAM linalotumiwa ndani ya kifaa kinahitaji sera ya **AmazonEC2RoleforSSM** ili kuweza kuwasiliana. 

### Uchambuzi
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Unaweza kuangalia kwenye kifaa cha EC2 ikiwa Systems Manager inaendeshwa kwa kutekeleza:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Kwenye ukurasa ufuatao unaweza kuangalia jinsi ya **kutumia ruhusa za SSM kuinua mamlaka**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Uthabiti



## ELB

**Elastic Load Balancing** (ELB) ni huduma ya **usawa wa mzigo kwa Amazon Web Services** (AWS) inayosambaza moja kwa moja **trafiki ya maombi inayoingia** na kuzidisha rasilimali kukidhi mahitaji ya trafiki.
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Templeti za Kuzindua & Vikundi vya Kupanuka

### Uchambuzi

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## VPN

VPN inaruhusu kuunganisha **mtandao wako wa ndani (site-to-site VPN)** au **kompyuta za wafanyakazi (Client VPN)** na **AWS VPC** ili huduma ziweze kupatikana bila kuwa zifichua kwa mtandao.

#### Vipengele Msingi vya VPN vya AWS

1. **Geti la Mteja**:
* Geti la Mteja ni rasilimali unayounda katika AWS kuwakilisha upande wako wa uhusiano wa VPN.
* Kimsingi ni kifaa halisi au programu ya programu upande wako wa uhusiano wa Site-to-Site VPN.
* Unatoa maelekezo ya upelekaji na anwani ya IP ya umma ya kifaa chako cha mtandao (kama router au firewall) kwa AWS kuunda Geti la Mteja.
* Inatumika kama alama ya kumbukumbu ya kuweka uhusiano wa VPN na haina gharama za ziada.
2. **Geti la Kibinafsi cha Virtual**:
* Geti la Kibinafsi cha Virtual (VPG) ni kikusanyaji wa VPN upande wa Amazon wa uhusiano wa Site-to-Site VPN.
* Imeunganishwa na VPC yako na inatumika kama lengo la uhusiano wako wa VPN.
* VPG ni mwisho wa upande wa AWS kwa uhusiano wa VPN.
* Inashughulikia mawasiliano salama kati ya VPC yako na mtandao wako wa ndani.
3. **Uhusiano wa VPN wa Site-to-Site**:
* Uhusiano wa VPN wa Site-to-Site unakuunganisha mtandao wako wa ndani na VPC kupitia handaki salama la VPN la IPsec.
* Aina hii ya uhusiano inahitaji Geti la Mteja na Geti la Kibinafsi cha Virtual.
* Inatumika kwa mawasiliano salama, thabiti, na thabiti kati ya kituo chako cha data au mtandao na mazingira yako ya AWS.
* Kawaida hutumiwa kwa mawasiliano ya kawaida, ya muda mrefu na inalipwa kulingana na kiasi cha data kinachohamishwa kupitia uhusiano huo.
4. **Mwisho wa VPN wa Mteja**:
* Mwisho wa VPN wa Mteja ni rasilimali unayounda katika AWS kuwezesha na kusimamia vikao vya VPN vya mteja.
* Inatumika kuruhusu vifaa binafsi (kama kompyuta ndogo, simu za mkononi, n.k.) kuunganisha kwa usalama na rasilimali za AWS au mtandao wako wa ndani.
* Inatofautiana na VPN ya Site-to-Site kwa kuwa imeundwa kwa wateja binafsi badala ya kuunganisha mitandao nzima.
* Kwa Mwisho wa VPN wa Mteja, kila kifaa cha mteja hutumia programu ya mteja wa VPN kuweka uhusiano salama.

Unaweza [**kupata habari zaidi kuhusu faida na vipengele vya VPN za AWS hapa**](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md#vpn).

### Uorodheshaji
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Uchambuzi wa Kienyeji

**Mandaraka ya Muda ya Mitambo**

Wakati Mteja wa AWS VPN unapotumika kuunganisha kwenye VPN, mtumiaji kawaida **ataingia kwenye AWS** kupata ufikiaji wa VPN. Kisha, **baadhi ya vibali vya AWS hujengwa na kuhifadhiwa** kienyeji ili kuanzisha uhusiano wa VPN. Vibali hivi **huhifadhiwa katika** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<eneo>/temporary-credentials.txt` na ina **AccessKey**, **SecretKey** na **Token**.

Vibali hivi ni vya mtumiaji `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: tafiti zaidi kuhusu ruhusa za vibali hivi).

**Faili za mazingira za opvn**

Ikiwa **uunganisho wa VPN ulianzishwa** unapaswa kutafuta faili za mazingira za **`.opvn`** kwenye mfumo. Zaidi ya hayo, mahali moja ambapo unaweza kupata **mipangilio** ni katika **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Baada ya Uvamizi**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Marejeo

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
