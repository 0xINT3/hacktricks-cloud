# AWS - EC2、EBS、ELB、SSM、VPC＆VPN Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**PEASSの最新バージョンをダウンロードしたり、PDFでHackTricksをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## VPC＆ネットワーキング

VPCとそのコンポーネントについて学ぶ：

{% content-ref url="../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](../../../aws-pentesting/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2を使用して、**仮想サーバー**を起動し、**セキュリティ**と**ネットワーキング**を設定し、**ストレージ**を管理できます。 Amazon EC2を使用すると、要件の変更や人気の急増に対応するためにスケールを拡大または縮小できるため、トラフィックの予測が必要なくなります。

EC2で列挙する興味深いこと：

* 仮想マシン
* SSHキー
* ユーザーデータ
* 既存のEC2/ AMI /スナップショット
* ネットワーキング
* ネットワーク
* サブネット
* パブリックIP
* オープンポート
* AWS外部の他のネットワークとの統合接続

### インスタンスプロファイル

**EC2インスタンス**で実行されるアプリケーションに権限を付与するために**ロール**を使用するには、少しの追加設定が必要です。 EC2インスタンス上で実行されるアプリケーションは、仮想化されたオペレーティングシステムによってAWSから抽象化されます。 この追加の分離のため、AWSの役割と関連する権限をEC2インスタンスに割り当て、それらをインスタンス上で実行されるアプリケーションで利用できるようにするために、追加のステップが必要です。

この追加のステップは、インスタンスにアタッチされた[_**インスタンスプロファイル**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html)の作成です。 **インスタンスプロファイルには役割が含まれ、インスタンス上で実行されるアプリケーションに役割の一時的な資格情報を提供できます。** それらの一時的な資格情報は、アプリケーションのAPI呼び出しでリソースにアクセスし、役割が指定するリソースのみにアクセスを制限するために使用できます。 1つのEC2インスタンスには**1つの役割のみが割り当てられ**、インスタンス上のすべてのアプリケーションが同じ役割と権限を共有します。

### メタデータエンドポイント

AWS EC2メタデータは、Amazon Elastic Compute Cloud（EC2）インスタンスにランタイムで利用可能な情報です。 このメタデータは、インスタンスに関する情報（インスタンスID、実行中の可用性ゾーン、インスタンスに関連付けられたIAMロール、インスタンスのホスト名など）を提供するために使用されます。

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### 列挙
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Privesc

以下のページでは、**EC2の権限を悪用して特権をエスカレーションする方法**を確認することができます：

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### 認証されていないアクセス

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### ポストエクスプロイテーション

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../../aws-pentesting/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Amazon **EBS**（Elastic Block Store）**スナップショット**は、基本的にはAWS EBSボリュームの静的な**バックアップ**です。つまり、特定の時点でEC2インスタンスに接続された**ディスク**の**コピー**です。EBSスナップショットは、リージョンやアカウント間でコピーしたり、ダウンロードしてローカルで実行したりすることができます。

スナップショットには、**ソースコードやAPIキーなどの機密情報**が含まれる場合がありますので、チェックすることをお勧めします。

### AMIとEBSの違い

**AMI**はEC2インスタンスを起動するために使用され、EC2**スナップショット**はEBSボリュームに保存されているデータの**バックアップと復元**に使用されます。EC2スナップショットを使用して新しいAMIを作成することはできますが、AMIとは異なり、オペレーティングシステム、アプリケーションサーバー、アプリケーションを実行するために必要なその他のソフトウェアに関する情報は含まれていません。

### Privesc

以下のページでは、**EBSの権限を悪用して特権をエスカレーションする方法**を確認することができます：

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)**は、EC2インスタンスのフリートをリモートで管理し、管理を容易にすることができます。これらのインスタンスのそれぞれは、**SSMエージェントサービスを実行する必要があります。このサービスはアクションを受け取り、AWS APIから実行します**。

**SSMエージェント**によって、システムマネージャーはこれらのリソースを更新、管理、設定することができます。エージェントは、AWSクラウド内のシステムマネージャーサービスからのリクエストを処理し、リクエストで指定されたとおりに実行します。

**SSMエージェントは**[**一部のAMIに事前インストールされています**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html)が、インスタンスには[**手動でインストールする必要があります**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html)。また、インスタンス内で使用されるIAMロールには、通信するためにポリシー**AmazonEC2RoleforSSM**がアタッチされている必要があります。

### 列挙
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
EC2インスタンスでSystems Managerが実行されているかどうかを確認するには、次のコマンドを実行します：
```bash
ps aux | grep amazon-ssm
```
### Privesc

以下のページでは、**SSMの権限を悪用して特権をエスカレーションする方法**を確認することができます：

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

### Post-Exploitation

SSMメッセージの傍受などのテクニックは、SSMのポストエクスプロイテーションページにあります：

{% content-ref url="aws-ssm-post-exploitation.md" %}
[aws-ssm-post-exploitation.md](aws-ssm-post-exploitation.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing**（ELB）は、Amazon Web Services（AWS）の展開における**負荷分散サービス**です。ELBは自動的に**アプリケーションのトラフィックを分散**し、トラフィックの需要に応じてリソースをスケーリングします。

<figure><img src="https://lh6.googleusercontent.com/cRBL0xfhe4VRn6PU0Bs_NPx937HqgdYxYNkRAh0WmQFfVZfyYg6X1rhpJwmVIQXIEeepQcUoJipsdH-qmacm8Dw49H539e2ygb2A5hQWGjMh_SAEHOfhygtTLINR2h5l6p4NiiMMO7g0LTZiFpdBB9IeEA=s2048" alt=""><figcaption></figcaption></figure>

### Enumeration
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## ランチテンプレート＆オートスケーリンググループ

### 列挙

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **会社をハックトリックで宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
