# AWS - EC2, EBS, ELB, SSM, VPC & VPN Enum

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team di HackTricks AWS)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## VPC & Networking

Scopri cos'√® un VPC e i suoi componenti in:

{% content-ref url="aws-vpc-and-networking-basic-information.md" %}
[aws-vpc-and-networking-basic-information.md](aws-vpc-and-networking-basic-information.md)
{% endcontent-ref %}

## EC2

Amazon EC2 √® utilizzato per avviare **server virtuali**. Consente la configurazione di **sicurezza** e **rete** e la gestione dello **storage**. La flessibilit√† di Amazon EC2 √® evidente nella sua capacit√† di scalare le risorse sia verso l'alto che verso il basso, adattandosi efficacemente ai cambiamenti dei requisiti o agli aumenti di popolarit√†. Questa caratteristica riduce la necessit√† di previsioni di traffico precise.

Cose interessanti da enumerare in EC2:

* Macchine virtuali
* Chiavi SSH
* Dati utente
* EC2/AMI/Snapshot esistenti
* Rete
* Reti
* Sottoreti
* IP pubblici
* Porte aperte
* Connessioni integrate con altre reti al di fuori di AWS

### Profili delle istanze

L'utilizzo di **ruoli** per concedere autorizzazioni alle applicazioni che girano sulle **istanze EC2** richiede una piccola configurazione aggiuntiva. Un'applicazione in esecuzione su un'istanza EC2 √® astratta da AWS dal sistema operativo virtualizzato. A causa di questa separazione aggiuntiva, √® necessario un passaggio aggiuntivo per assegnare un ruolo AWS e le relative autorizzazioni a un'istanza EC2 e renderle disponibili alle sue applicazioni.

Questo passaggio aggiuntivo √® la **creazione di un** [_**profilo dell'istanza**_](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_use\_switch-role-ec2\_instance-profiles.html) allegato all'istanza. Il **profilo dell'istanza contiene il ruolo e** pu√≤ fornire le credenziali temporanee del ruolo a un'applicazione che gira sull'istanza. Queste credenziali temporanee possono quindi essere utilizzate nelle chiamate API dell'applicazione per accedere alle risorse e limitare l'accesso solo alle risorse specificate dal ruolo. Nota che **solo un ruolo pu√≤ essere assegnato a un'istanza EC2** alla volta, e tutte le applicazioni sull'istanza condividono lo stesso ruolo e le stesse autorizzazioni.

### Endpoint dei metadati

I metadati di AWS EC2 sono informazioni su un'istanza Amazon Elastic Compute Cloud (EC2) disponibili all'istanza durante l'esecuzione. Questi metadati vengono utilizzati per fornire informazioni sull'istanza, come l'ID dell'istanza, la zona di disponibilit√† in cui √® in esecuzione, il ruolo IAM associato all'istanza e l'hostname dell'istanza.

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Enumerazione
```bash
# Get EC2 instances
aws ec2 describe-instances
aws ec2 describe-instance-status #Get status from running instances

# Get user data from each ec2 instance
for instanceid in $(aws ec2 describe-instances --profile <profile> --region us-west-2 | grep -Eo '"i-[a-zA-Z0-9]+' | tr -d '"'); do
echo "Instance ID: $instanceid"
aws ec2 describe-instance-attribute --profile <profile> --region us-west-2 --instance-id "$instanceid" --attribute userData | jq ".UserData.Value" | tr -d '"' | base64 -d
echo ""
echo "-------------------"
done

# Instance profiles
aws iam list-instance-profiles
aws iam list-instance-profiles-for-role --role-name <name>

# Get tags
aws ec2 describe-tags

# Get volumes
aws ec2 describe-volume-status
aws ec2 describe-volumes

# Get snapshots
aws ec2 describe-snapshots --owner-ids self

# Scheduled instances
aws ec2 describe-scheduled-instances

# Get custom images
aws ec2 describe-images --owners self

# Get Elastic IPs
aws ec2 describe-addresses

# Get current output
aws ec2 get-console-output --instance-id [id]

# Get VPN customer gateways
aws ec2 describe-customer-gateways
aws ec2 describe-vpn-gateways
aws ec2 describe-vpn-connections

# List conversion tasks to upload/download VMs
aws ec2 describe-conversion-tasks
aws ec2 describe-import-image-tasks

# Get Bundle Tasks
aws ec2 describe-bundle-tasks

# Get Classic Instances
aws ec2 describe-classic-link-instances

# Get Dedicated Hosts
aws ec2 describe-hosts

# Get SSH Key Pairs
aws ec2 describe-key-pairs

# Get Internet Gateways
aws ec2 describe-internet-gateways

# Get NAT Gateways
aws ec2 describe-nat-gateways

# Get subnetworks
aws ec2 describe-subnets

# Get FW rules
aws ec2 describe-network-acls

# Get security groups
aws ec2 describe-security-groups

# Get interfaces
aws ec2 describe-network-interfaces

# Get routes table
aws ec2 describe-route-tables

# Get VPCs
aws ec2 describe-vpcs
aws ec2 describe-vpc-peering-connections
```
### Accesso non autenticato

{% content-ref url="../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md" %}
[aws-ec2-unauthenticated-enum.md](../../aws-unauthenticated-enum-access/aws-ec2-unauthenticated-enum.md)
{% endcontent-ref %}

### Privesc

Nella seguente pagina puoi verificare come **abusare dei permessi EC2 per elevare i privilegi**:

{% content-ref url="../../aws-privilege-escalation/aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](../../aws-privilege-escalation/aws-ec2-privesc.md)
{% endcontent-ref %}

### Post-Esploitation

{% content-ref url="../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/" %}
[aws-ec2-ebs-ssm-and-vpc-post-exploitation](../../aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/)
{% endcontent-ref %}

## EBS

Gli **snapshot di Amazon EBS** (Elastic Block Store) sono essenzialmente **backup statici** dei volumi AWS EBS. In altre parole, sono **copia** dei **dischi** collegati a un'**istanza EC2** in un momento specifico. Gli snapshot di EBS possono essere copiati tra regioni e account, o addirittura scaricati ed eseguiti localmente.

Gli snapshot possono contenere **informazioni sensibili** come **codice sorgente o chiavi API**, pertanto, se ne hai la possibilit√†, √® consigliabile controllarli.

### Differenza tra AMI ed EBS

Un **AMI** viene utilizzato per **avviare un'istanza EC2**, mentre uno **Snapshot EC2** viene utilizzato per **eseguire il backup e ripristinare i dati memorizzati su un volume EBS**. Sebbene uno Snapshot EC2 possa essere utilizzato per creare un nuovo AMI, non √® la stessa cosa di un AMI e non include informazioni sul sistema operativo, server dell'applicazione o altri software necessari per eseguire un'applicazione.

### Privesc

Nella seguente pagina puoi verificare come **abusare dei permessi EBS per elevare i privilegi**:

{% content-ref url="../../aws-privilege-escalation/aws-ebs-privesc.md" %}
[aws-ebs-privesc.md](../../aws-privilege-escalation/aws-ebs-privesc.md)
{% endcontent-ref %}

## SSM

**Amazon Simple Systems Manager (SSM)** consente di gestire remotamente gruppi di istanze EC2 per semplificarne l'amministrazione. Ciascuna di queste istanze deve eseguire il servizio **SSM Agent in quanto sar√† quello a ricevere le azioni e a eseguirle** dall'API AWS.

**SSM Agent** consente a Systems Manager di aggiornare, gestire e configurare queste risorse. L'agente **elabora le richieste dal servizio Systems Manager nel Cloud AWS**, e quindi le esegue come specificato nella richiesta.

Lo **SSM Agent viene** [**preinstallato in alcune AMI**](https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html) oppure √® necessario [**installarlo manualmente**](https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html) sulle istanze. Inoltre, il ruolo IAM utilizzato all'interno dell'istanza deve avere la policy **AmazonEC2RoleforSSM** allegata per poter comunicare.

### Enumerazione
```bash
aws ssm describe-instance-information
aws ssm describe-parameters
aws ssm describe-sessions --state [Active|History]
aws ssm describe-instance-patches --instance-id <id>
aws ssm describe-instance-patch-states --instance-ids <id>
aws ssm describe-instance-associations-status --instance-id <id>
```
Puoi verificare in un'istanza EC2 se Systems Manager √® in esecuzione semplicemente eseguendo:
```bash
ps aux | grep amazon-ssm
```
### Privesc

Nella seguente pagina puoi controllare come **abusare delle autorizzazioni SSM per elevare i privilegi**:

{% content-ref url="../../aws-privilege-escalation/aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](../../aws-privilege-escalation/aws-ssm-privesc.md)
{% endcontent-ref %}

## ELB

**Elastic Load Balancing** (ELB) √® un **servizio di bilanciamento del carico per le distribuzioni Amazon Web Services** (AWS). ELB distribuisce automaticamente **il traffico delle applicazioni in arrivo** e ridimensiona le risorse per soddisfare le esigenze del traffico.

### Enumerazione
```bash
# List internet-facing ELBs
aws elb describe-load-balancers
aws elb describe-load-balancers | jq '.LoadBalancerDescriptions[]| select( .Scheme | contains("internet-facing"))|.DNSName'

# DONT FORGET TO CHECK VERSION 2
aws elbv2 describe-load-balancers
aws elbv2 describe-load-balancers | jq '.LoadBalancers[].DNSName'
aws elbv2 describe-listeners --load-balancer-arn <load_balancer_arn>
```
## Modelli di Lancio & Gruppi di Autoscaling

### Enumerazione

{% code overflow="wrap" %}
```bash
# Launch templates
aws ec2 describe-launch-templates
aws ec2 describe-launch-templates --launch-template-id <launch_template_id>
## Get details, like user data
aws ec2 describe-launch-template-versions --launch-template-id <launch_template_id>

# Autoscaling
aws autoscaling describe-auto-scaling-groups
aws autoscaling describe-auto-scaling-instances
aws autoscaling describe-launch-configurations
aws autoscaling describe-load-balancer-target-groups
aws autoscaling describe-load-balancers
```
{% endcode %}

## Nitro



## VPN

Un VPN consente di connettere la **rete in loco (VPN sito-sito)** o i **laptop dei lavoratori (VPN client)** con un **AWS VPC** in modo che i servizi possano essere accessibili senza la necessit√† di esporli su Internet.

#### Componenti di base di un VPN AWS

1. **Gateway del cliente**:
* Un Gateway del cliente √® una risorsa che crei in AWS per rappresentare il tuo lato di una connessione VPN.
* √à essenzialmente un dispositivo fisico o un'applicazione software sul tuo lato della connessione VPN sito-sito.
* Fornisci informazioni di routing e l'indirizzo IP pubblico del tuo dispositivo di rete (come un router o un firewall) ad AWS per creare un Gateway del cliente.
* Serve come punto di riferimento per configurare la connessione VPN e non comporta costi aggiuntivi.
2. **Gateway privato virtuale**:
* Un Gateway privato virtuale (VPG) √® il concentratore VPN sul lato Amazon della connessione VPN sito-sito.
* √à collegato al tuo VPC e funge da destinazione per la tua connessione VPN.
* Il VPG √® il punto terminale lato AWS per la connessione VPN.
* Gestisce la comunicazione sicura tra il tuo VPC e la tua rete in loco.
3. **Connessione VPN sito-sito**:
* Una connessione VPN sito-sito collega la tua rete in loco a un VPC tramite un tunnel VPN IPsec sicuro.
* Questo tipo di connessione richiede un Gateway del cliente e un Gateway privato virtuale.
* √à utilizzato per una comunicazione sicura, stabile e coerente tra il tuo data center o rete e il tuo ambiente AWS.
* Tipicamente utilizzato per connessioni regolari a lungo termine e viene tariffato in base alla quantit√† di dati trasferiti sulla connessione.
4. **Endpoint VPN client**:
* Un endpoint VPN client √® una risorsa che crei in AWS per abilitare e gestire sessioni VPN client.
* √à utilizzato per consentire a dispositivi individuali (come laptop, smartphone, ecc.) di connettersi in modo sicuro alle risorse AWS o alla tua rete in loco.
* Si differenzia dalla VPN sito-sito in quanto √® progettato per clienti individuali anzich√© per connettere intere reti.
* Con il VPN client, ogni dispositivo client utilizza un software client VPN per stabilire una connessione sicura.

Puoi [**trovare ulteriori informazioni sui vantaggi e sui componenti dei VPN AWS qui**](aws-vpc-and-networking-basic-information.md#vpn).

### Enumerazione
```bash
# VPN endpoints
## Check used subnetwork, authentication, SGs, connected...
aws ec2 describe-client-vpn-endpoints

## Get AWS network info related to the vpn endpoint
aws ec2 describe-client-vpn-target-networks --client-vpn-endpoint-id <id>

## Get AWS subnet & ip range the VPN iconnected to
aws ec2 describe-client-vpn-routes --client-vpn-endpoint-id <id>

## Check authorization rules
aws ec2 describe-client-vpn-authorization-rules --client-vpn-endpoint-id <id>

## Get current connections to the VPN endpoint
aws ec2 describe-client-vpn-connections --client-vpn-endpoint-id <id>

# Get VPN gateways and check with which VPC each is connected
aws ec2 describe-vpn-gateways

# Get VPN site-to-site connections
aws ec2 describe-vpn-connections
```
### Enumerazione Locale

**Credenziali Temporanee Locali**

Quando il client VPN AWS viene utilizzato per connettersi a una VPN, l'utente di solito effettuer√† il **login in AWS** per ottenere l'accesso alla VPN. Successivamente, alcune **credenziali AWS vengono create e memorizzate** localmente per stabilire la connessione VPN. Queste credenziali sono **memorizzate in** `$HOME/.config/AWSVPNClient/TemporaryCredentials/<region>/temporary-credentials.txt` e contengono una **AccessKey**, una **SecretKey** e un **Token**.

Le credenziali appartengono all'utente `arn:aws:sts::<acc-id>:assumed-role/aws-vpn-client-metrics-analytics-access-role/CognitoIdentityCredentials` (TODO: approfondire le autorizzazioni di queste credenziali).

**File di configurazione opvn**

Se √® stata **stabilita una connessione VPN**, √® necessario cercare i file di configurazione **`.opvn`** nel sistema. Inoltre, un luogo in cui potresti trovare le **configurazioni** √® in **`$HOME/.config/AWSVPNClient/OpenVpnConfigs`**

#### **Post Esploitation**

{% content-ref url="../../aws-post-exploitation/aws-vpn-post-exploitation.md" %}
[aws-vpn-post-exploitation.md](../../aws-post-exploitation/aws-vpn-post-exploitation.md)
{% endcontent-ref %}

## Riferimenti

* [https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html](https://docs.aws.amazon.com/batch/latest/userguide/getting-started-ec2.html)

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
