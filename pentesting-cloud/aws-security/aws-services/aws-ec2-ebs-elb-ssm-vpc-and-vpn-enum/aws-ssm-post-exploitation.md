# AWS - Post-Explotación de SSM

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## MitM SSM

### MitM Mensajes SSM enviados a una instancia EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Con **acceso a las credenciales IAM de una instancia EC2**, se pueden interceptar los mensajes de EC2 y las sesiones de SSM debido al manejo de autenticación de SSM.

El [**Agente SSM**](https://github.com/aws/amazon-ssm-agent) llama continuamente a **`ec2messages:GetMessages`**, manteniendo la **conexión abierta** durante **20 segundos**. Si se envía un mensaje, como a través de [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), se recibe a través de esta conexión abierta.

Un **atacante** puede interceptar los mensajes de EC2 llamando a **`ec2messages:GetMessages`** con más frecuencia. Este [**ejemplo de concepto**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) lo demuestra escuchando los mensajes de envío de comandos. El atacante también puede **enviar cualquier respuesta** que desee a los mensajes.

El atacante también podría **enviar cualquier respuesta** que desee a los mensajes.

### MitM Mensajes de Sesión SSM

Esto es más complejo, involucrando múltiples conexiones WebSocket y un protocolo binario único. Cuando el **Agente SSM se inicia**, crea una **conexión WebSocket** a AWS. Cuando un usuario inicia una sesión de SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), el **canal de control inicia un canal de datos** para la comunicación entre el usuario y la instancia EC2.

El código fuente del Agente SSM, disponible [aquí](https://github.com/aws/amazon-ssm-agent), se puede utilizar para crear los mensajes en el formato binario, como [este](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Interceptar las sesiones de SSM es más confiable que los mensajes de EC2** ya que los **canales de control son de larga duración** y AWS solo se comunica con el **más nuevo**. Este [ejemplo de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) muestra cómo crear un canal de control e interactuar con la sesión.

Desde una perspectiva de abuso, **interceptar las sesiones de SSM es más confiable que los mensajes de EC2**. La razón de esto es que los **canales de control son de larga duración**, y al igual que con los mensajes de EC2, AWS solo se comunica con el **más nuevo**. Como resultado, podemos crear nuestro propio canal de control y escuchar las sesiones entrantes. Usando el código fuente del Agente SSM, podemos crear los mensajes en el formato binario (si miras el [ejemplo de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), notarás que literalmente he traducido el código de Go a Python) e interactuar con la sesión.

También es posible robar comandos (**información sensible**) y proporcionar la salida de los atacantes.

## Referencias

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si deseas ver a tu **empresa anunciada en HackTricks** o si deseas acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>