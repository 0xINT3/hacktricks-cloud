# AWS - Post-Exploitation SSM

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## MitM SSM

### MitM des messages SSM envoy√©s √† une instance EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Avec **l'acc√®s aux informations d'identification IAM d'une instance EC2**, vous pouvez intercepter les messages EC2 et les sessions SSM en raison de la gestion de l'authentification de SSM.

L'agent [**SSM**](https://github.com/aws/amazon-ssm-agent) appelle continuellement **`ec2messages:GetMessages`**, maintenant la **connexion ouverte** pendant **20 secondes**. Si un message est envoy√©, tel que via [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), il est re√ßu via cette connexion ouverte.

Un **attaquant** peut intercepter les messages EC2 en appelant **`ec2messages:GetMessages`** plus fr√©quemment. Cette [**preuve de concept**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) le d√©montre en √©coutant les messages de commande envoy√©s. L'attaquant peut √©galement **envoyer n'importe quelle r√©ponse** qu'il souhaite aux messages.

L'attaquant pourrait √©galement **envoyer n'importe quelle r√©ponse** qu'il souhaite aux messages.

### MitM des messages de session SSM

Ceci est plus complexe, impliquant plusieurs connexions WebSocket et un protocole binaire unique. Lorsque l'**agent SSM d√©marre**, il **cr√©e** une **connexion WebSocket** vers AWS. Lorsqu'un utilisateur d√©marre une session SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), le **canal de contr√¥le initie un canal de donn√©es** pour la communication utilisateur-instance EC2.

Le code source de l'agent SSM, disponible [ici](https://github.com/aws/amazon-ssm-agent), peut √™tre utilis√© pour cr√©er les messages au format binaire, comme [cela](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**L'interception des sessions SSM est plus fiable que les messages EC2** car les **canaux de contr√¥le sont de longue dur√©e** et AWS ne communique qu'avec le **plus r√©cent**. Cette [preuve de concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) montre comment cr√©er un canal de contr√¥le et interagir avec la session.

Du point de vue de l'abus, **l'interception des sessions SSM est plus fiable que les messages EC2**. La raison en est que les **canaux de contr√¥le sont de longue dur√©e**, et tout comme avec les messages EC2, AWS ne communiquera qu'avec le **plus r√©cent**. Par cons√©quent, nous pouvons cr√©er notre propre canal de contr√¥le et √©couter les sessions entrantes. En utilisant le code source de l'agent SSM, nous pouvons cr√©er les messages au format binaire (si vous regardez la [preuve de concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), vous remarquerez que j'ai litt√©ralement traduit le code Go en Python), et interagir avec la session.

Il est √©galement possible de voler des commandes (**informations sensibles**) et de fournir la sortie des attaquants.

## R√©f√©rences

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>