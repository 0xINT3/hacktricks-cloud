# AWS - P√≥s-Explora√ß√£o do SSM

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## MitM SSM

### Interceptando Mensagens SSM enviadas para uma Inst√¢ncia EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Com **acesso √†s credenciais IAM de uma inst√¢ncia EC2**, voc√™ pode interceptar mensagens EC2 e sess√µes SSM devido ao tratamento de autentica√ß√£o do SSM.

O [**Agente SSM**](https://github.com/aws/amazon-ssm-agent) chama continuamente **`ec2messages:GetMessages`**, mantendo a **conex√£o aberta** por **20 segundos**. Se uma mensagem for enviada, como via [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), ela √© recebida por meio dessa conex√£o aberta.

Um **atacante** pode interceptar mensagens EC2 chamando **`ec2messages:GetMessages`** com mais frequ√™ncia. Este [**prova de conceito**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) demonstra isso ouvindo as mensagens de envio de comando. O atacante tamb√©m pode **enviar qualquer resposta** que desejar para as mensagens.

O atacante tamb√©m pode **enviar qualquer resposta** que desejar para as mensagens.

### Interceptando Mensagens de Sess√£o SSM

Isso √© mais complexo, envolvendo v√°rias conex√µes WebSocket e um protocolo bin√°rio exclusivo. Quando o **Agente SSM √© iniciado**, ele **cria** uma **conex√£o WebSocket** com a AWS. Quando um usu√°rio inicia uma sess√£o SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), o **canal de controle inicia um canal de dados** para comunica√ß√£o entre o usu√°rio e a inst√¢ncia EC2.

O c√≥digo-fonte do Agente SSM, dispon√≠vel [aqui](https://github.com/aws/amazon-ssm-agent), pode ser usado para criar as mensagens no formato bin√°rio, como [este](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Interceptar Sess√µes SSM √© mais confi√°vel do que mensagens EC2** porque os **canais de controle s√£o de longa dura√ß√£o** e a AWS se comunica apenas com o **mais novo**. Este [prova de conceito](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) mostra como criar um canal de controle e interagir com a sess√£o.

Do ponto de vista do abuso, **interceptar Sess√µes SSM √© mais confi√°vel do que mensagens EC2**. A raz√£o para isso √© que os **canais de controle s√£o de longa dura√ß√£o**, e assim como com as mensagens EC2, a AWS s√≥ se comunica com o **mais novo**. Como resultado, podemos criar nosso pr√≥prio canal de controle e ouvir as sess√µes recebidas. Usando o c√≥digo-fonte do Agente SSM, podemos criar as mensagens no formato bin√°rio (se voc√™ olhar para o [prova de conceito](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), voc√™ notar√° que eu literalmente traduzi o Go para Python) e interagir com a sess√£o.

Tamb√©m √© poss√≠vel roubar comandos (**informa√ß√µes sens√≠veis**) e fornecer a sa√≠da do atacante.

## Refer√™ncias

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>